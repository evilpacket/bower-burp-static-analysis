{
    "url": "http://localhost:9999/photonstorm/phaser-examples/examples/wip/book/phaser.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statements:<ul><li>url = window.location.href;</li><li>var hash = url.split('#');</li><li>url = hash[0] + separator + key + '=' + value;</li><li>output = url;</li><li>window.location.href = output;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/photonstorm/phaser-examples/examples/wip/book/phaser.js",
                "path": "/photonstorm/phaser-examples/examples/wip/book/phaser.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9waG90b25zdG9ybS9waGFzZXItZXhhbXBsZXMvZXhhbXBsZXMvd2lwL2Jvb2svcGhhc2VyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTEwMjc2Mg0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogRnJpLCAwNyBOb3YgMjAxNCAyMTo1Mjo0MCBHTVQNCkxhc3QtTW9kaWZpZWQ6IEZyaSwgMDcgTm92IDIwMTQgMjE6NTI6MzIgR01UDQoNCiFmdW5jdGlvbihyb290LCBmYWN0b3J5KSB7CiAgaWYgKHR5cGVvZiBkZWZpbmUgPT09ICJmdW5jdGlvbiIgJiYgZGVmaW5lLmFtZCkgewogICAgZGVmaW5lKGZhY3RvcnkpOwogIH0gZWxzZSBpZiAodHlwZW9mIGV4cG9ydHMgPT09ICJvYmplY3QiKSB7CiAgICAgIG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0gZWxzZSB7CiAgICByb290LlBoYXNlciA9IGZhY3RvcnkoKTsKICB9Cn0odGhpcywgZnVuY3Rpb24oKSB7Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBvdmVydmlldwoqCiogUGhhc2VyIC0gaHR0cDovL3d3dy5waGFzZXIuaW8KKgoqIHYxLjEuMyAtIEJ1aWx0IGF0OiBUaHUgTm92IDIxIDIwMTMgMDU6Mjk6NDYKKgoqIEJ5IFJpY2hhcmQgRGF2ZXkgaHR0cDovL3d3dy5waG90b25zdG9ybS5jb20gQHBob3RvbnN0b3JtCioKKiBBIGZlYXR1cmUtcGFja2VkIDJEIEhUTUw1IGdhbWUgZnJhbWV3b3JrIGJvcm4gZnJvbSB0aGUgc21vdWxkZXJpbmcgcGl0cyBvZiBGbGl4ZWwgYW5kCiogY29uc3RydWN0ZWQgdmlhIHBsZW50eSBvZiBibG9vZCwgc3dlYXQsIHRlYXJzIGFuZCBjb2ZmZWUgYnkgUmljaGFyZCBEYXZleSAoQHBob3RvbnN0b3JtKS4KKgoqIFBoYXNlciB1c2VzIFBpeGkuanMgZm9yIHJlbmRlcmluZywgY3JlYXRlZCBieSBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzLgoqCiogRm9sbG93IFBoYXNlciBkZXZlbG9wbWVudCBwcm9ncmVzcyBhdCBodHRwOi8vd3d3LnBob3RvbnN0b3JtLmNvbQoqCiogTWFueSB0aGFua3MgdG8gQWRhbSBTYWx0c21hbiAoQEFEQU1BVE9NSUMpIGZvciByZWxlYXNpbmcgRmxpeGVsLCBmcm9tIGJvdGggd2hpY2ggUGhhc2VyCiogYW5kIG15IGxvdmUgb2YgZ2FtZSBkZXZlbG9wbWVudCBvcmlnaW5hdGUuCioKKiAiSWYgeW91IHdhbnQgeW91ciBjaGlsZHJlbiB0byBiZSBpbnRlbGxpZ2VudCwgIHJlYWQgdGhlbSBmYWlyeSB0YWxlcy4iCiogIklmIHlvdSB3YW50IHRoZW0gdG8gYmUgbW9yZSBpbnRlbGxpZ2VudCwgcmVhZCB0aGVtIG1vcmUgZmFpcnkgdGFsZXMuIgoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtLSBBbGJlcnQgRWluc3RlaW4KKi8KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQG1vZHVsZSBQSVhJCiAqLwp2YXIgUElYSSA9IFBJWEkgfHwge307CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAbmFtZXNwYWNlIFBoYXNlcgoqLwp2YXIgUGhhc2VyID0gUGhhc2VyIHx8IHsKCglWRVJTSU9OOiAnMS4xLjMnLAoJREVWX1ZFUlNJT046ICcxLjEuMycsCglHQU1FUzogW10sCglBVVRPOiAwLAoJQ0FOVkFTOiAxLAoJV0VCR0w6IDIsCgoJU1BSSVRFOiAwLAoJQlVUVE9OOiAxLAoJQlVMTEVUOiAyLAoJR1JBUEhJQ1M6IDMsCglURVhUOiA0LAoJVElMRVNQUklURTogNSwKCUJJVE1BUFRFWFQ6IDYsCglHUk9VUDogNywKCVJFTkRFUlRFWFRVUkU6IDgsCglUSUxFTUFQOiA5LAoJVElMRU1BUExBWUVSOiAxMCwKCUVNSVRURVI6IDExLAoJUE9MWUdPTjogMTIsCglCSVRNQVBEQVRBOiAxMywKCUNBTlZBU19GSUxURVI6IDE0LAoJV0VCR0xfRklMVEVSOiAxNSwKCglOT05FOiAwLAoJTEVGVDogMSwKCVJJR0hUOiAyLAoJVVA6IDMsCglET1dOOiA0CgogfTsKClBJWEkuSW50ZXJhY3Rpb25NYW5hZ2VyID0gZnVuY3Rpb24gKGR1bW15KSB7CgkvLwlXZSBkb24ndCBuZWVkIHRoaXMgaW4gUGl4aSwgc28gd2UndmUgcmVtb3ZlZCBpdCB0byBzYXZlIHNwYWNlCgkvLwlob3dldmVyIHRoZSBTdGFnZSBvYmplY3QgZXhwZWN0cyBhIHJlZmVyZW5jZSB0byBpdCwgc28gaGVyZSBpcyBhIGR1bW15IGVudHJ5Lgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5VdGlscwoqIEBzdGF0aWMKKi8KUGhhc2VyLlV0aWxzID0gewoJCgkvKioKCSogQSBzdGFuZGFyZCBGaXNoZXItWWF0ZXMgQXJyYXkgc2h1ZmZsZSBpbXBsZW1lbnRhdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuVXRpbHMuc2h1ZmZsZQoJKiBAcGFyYW0ge2FycmF5fSBhcnJheSAtIFRoZSBhcnJheSB0byBzaHVmZmxlLgoJKiBAcmV0dXJuIHthcnJheX0gVGhlIHNodWZmbGVkIGFycmF5LgoJKi8KCXNodWZmbGU6IGZ1bmN0aW9uIChhcnJheSkgewoKCSAgICBmb3IgKHZhciBpID0gYXJyYXkubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSkKCSAgICB7CgkgICAgICAgIHZhciBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkgKyAxKSk7CgkgICAgICAgIHZhciB0ZW1wID0gYXJyYXlbaV07CgkgICAgICAgIGFycmF5W2ldID0gYXJyYXlbal07CgkgICAgICAgIGFycmF5W2pdID0gdGVtcDsKCSAgICB9CgoJICAgIHJldHVybiBhcnJheTsKCSAgICAKCX0sCgoJLyoqCgkqIEphdmFzY3JpcHQgc3RyaW5nIHBhZCBodHRwOi8vd3d3LndlYnRvb2xraXQuaW5mby8uCgkqIHBhZCA9IHRoZSBzdHJpbmcgdG8gcGFkIGl0IG91dCB3aXRoIChkZWZhdWx0cyB0byBhIHNwYWNlKQoJKiBkaXIgPSAxIChsZWZ0KSwgMiAocmlnaHQpLCAzIChib3RoKQoJKiBAbWV0aG9kIFBoYXNlci5VdGlscy5wYWQKCSogQHBhcmFtIHtzdHJpbmd9IHN0ciAtIFRoZSB0YXJnZXQgc3RyaW5nLiAKCSogQHBhcmFtIHtudW1iZXJ9IGxlbiAtIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge251bWJlcn0gcGFkIC0gdGhlIHN0cmluZyB0byBwYWQgaXQgb3V0IHdpdGggKGRlZmF1bHRzIHRvIGEgc3BhY2UpLgoJKiBAcGFyYW0ge251bWJlcn0gW2Rpcj0zXSB0aGUgZGlyZWN0aW9uIGRpciA9IDEgKGxlZnQpLCAyIChyaWdodCksIDMgKGJvdGgpLgoJKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBwYWRkZWQgc3RyaW5nCgkqLwoJcGFkOiBmdW5jdGlvbiAoc3RyLCBsZW4sIHBhZCwgZGlyKSB7CgoJICAgIGlmICh0eXBlb2YobGVuKSA9PSAidW5kZWZpbmVkIikgeyB2YXIgbGVuID0gMDsgfQoJICAgIGlmICh0eXBlb2YocGFkKSA9PSAidW5kZWZpbmVkIikgeyB2YXIgcGFkID0gJyAnOyB9CgkgICAgaWYgKHR5cGVvZihkaXIpID09ICJ1bmRlZmluZWQiKSB7IHZhciBkaXIgPSAzOyB9CgoJICAgIGlmIChsZW4gKyAxID49IHN0ci5sZW5ndGgpCgkgICAgewoJICAgICAgICBzd2l0Y2ggKGRpcikKCSAgICAgICAgewoJICAgICAgICAgICAgY2FzZSAxOgoJICAgICAgICAgICAgICAgIHN0ciA9IEFycmF5KGxlbiArIDEgLSBzdHIubGVuZ3RoKS5qb2luKHBhZCkgKyBzdHI7CgkJICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgY2FzZSAzOgoJICAgICAgICAgICAgICAgIHZhciByaWdodCA9IE1hdGguY2VpbCgocGFkbGVuID0gbGVuIC0gc3RyLmxlbmd0aCkgLyAyKTsKCSAgICAgICAgICAgICAgICB2YXIgbGVmdCA9IHBhZGxlbiAtIHJpZ2h0OwoJICAgICAgICAgICAgICAgIHN0ciA9IEFycmF5KGxlZnQrMSkuam9pbihwYWQpICsgc3RyICsgQXJyYXkocmlnaHQrMSkuam9pbihwYWQpOwoJCSAgICAgICAgICAgIGJyZWFrOwoKCSAgICAgICAgICAgIGRlZmF1bHQ6CgkgICAgICAgICAgICAgICAgc3RyID0gc3RyICsgQXJyYXkobGVuICsgMSAtIHN0ci5sZW5ndGgpLmpvaW4ocGFkKTsKCQkgICAgICAgICAgICBicmVhazsKCSAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIHN0cjsKCgl9LAoKICAgIC8qKgogICAgKiBUaGlzIGlzIGEgc2xpZ2h0bHkgbW9kaWZpZWQgdmVyc2lvbiBvZiBqUXVlcnkuaXNQbGFpbk9iamVjdC4gQSBwbGFpbiBvYmplY3QgaXMgYW4gb2JqZWN0IHdob3NlIGludGVybmFsIGNsYXNzIHByb3BlcnR5IGlzIFtvYmplY3QgT2JqZWN0XS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuaXNQbGFpbk9iamVjdAogICAgKiBAcGFyYW0ge29iamVjdH0gb2JqIC0gVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgKiBAcmV0dXJuIHtib29sZWFufSAtIHRydWUgaWYgdGhlIG9iamVjdCBpcyBwbGFpbiwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KCWlzUGxhaW5PYmplY3Q6IGZ1bmN0aW9uIChvYmopIHsKCgkJLy8gTm90IHBsYWluIG9iamVjdHM6CgkJLy8gLSBBbnkgb2JqZWN0IG9yIHZhbHVlIHdob3NlIGludGVybmFsIFtbQ2xhc3NdXSBwcm9wZXJ0eSBpcyBub3QgIltvYmplY3QgT2JqZWN0XSIKCQkvLyAtIERPTSBub2RlcwoJCS8vIC0gd2luZG93CgkJaWYgKHR5cGVvZihvYmopICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgb2JqID09PSBvYmoud2luZG93KQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gU3VwcG9ydDogRmlyZWZveCA8MjAKCQkvLyBUaGUgdHJ5L2NhdGNoIHN1cHByZXNzZXMgZXhjZXB0aW9ucyB0aHJvd24gd2hlbiBhdHRlbXB0aW5nIHRvIGFjY2VzcwoJCS8vIHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IG9mIGNlcnRhaW4gaG9zdCBvYmplY3RzLCBpZS4gfHdpbmRvdy5sb2NhdGlvbnwKCQkvLyBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD04MTQ2MjIKCQl0cnkgewoJCQlpZiAob2JqLmNvbnN0cnVjdG9yICYmICFoYXNPd24uY2FsbChvYmouY29uc3RydWN0b3IucHJvdG90eXBlLCAiaXNQcm90b3R5cGVPZiIpKQoJCQl7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9IGNhdGNoIChlKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIElmIHRoZSBmdW5jdGlvbiBoYXNuJ3QgcmV0dXJuZWQgYWxyZWFkeSwgd2UncmUgY29uZmlkZW50IHRoYXQKCQkvLyB8b2JqfCBpcyBhIHBsYWluIG9iamVjdCwgY3JlYXRlZCBieSB7fSBvciBjb25zdHJ1Y3RlZCB3aXRoIG5ldyBPYmplY3QKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoKCS8vCWRlZXAsIHRhcmdldCwgb2JqZWN0cyB0byBjb3B5IHRvIHRoZSB0YXJnZXQgb2JqZWN0CgkvLwlUaGlzIGlzIGEgc2xpZ2h0bHkgbW9kaWZpZWQgdmVyc2lvbiBvZiB7QGxpbmsgaHR0cDovL2FwaS5qcXVlcnkuY29tL2pRdWVyeS5leHRlbmQvfGpRdWVyeS5leHRlbmR9CgkvLwlkZWVwIChib29sZWFuKQoJLy8JdGFyZ2V0IChvYmplY3QgdG8gYWRkIHRvKQoJLy8Jb2JqZWN0cyAuLi4gKG9iamVjdHMgdG8gcmVjdXJzZSBhbmQgY29weSBmcm9tKQoKICAgIC8qKgogICAgKiBUaGlzIGlzIGEgc2xpZ2h0bHkgbW9kaWZpZWQgdmVyc2lvbiBvZiBodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LmV4dGVuZC8KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuZXh0ZW5kCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZGVlcCAtIFBlcmZvcm0gYSBkZWVwIGNvcHk/CiAgICAqIEBwYXJhbSB7b2JqZWN0fSB0YXJnZXQgLSBUaGUgdGFyZ2V0IG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBleHRlbmRlZCBvYmplY3QuCiAgICAqLwoJZXh0ZW5kOiBmdW5jdGlvbiAoKSB7CgoJCXZhciBvcHRpb25zLCBuYW1lLCBzcmMsIGNvcHksIGNvcHlJc0FycmF5LCBjbG9uZSwKCQkJdGFyZ2V0ID0gYXJndW1lbnRzWzBdIHx8IHt9LAoJCQlpID0gMSwKCQkJbGVuZ3RoID0gYXJndW1lbnRzLmxlbmd0aCwKCQkJZGVlcCA9IGZhbHNlOwoKCQkvLyBIYW5kbGUgYSBkZWVwIGNvcHkgc2l0dWF0aW9uCgkJaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJib29sZWFuIikKCQl7CgkJCWRlZXAgPSB0YXJnZXQ7CgkJCXRhcmdldCA9IGFyZ3VtZW50c1sxXSB8fCB7fTsKCQkJLy8gc2tpcCB0aGUgYm9vbGVhbiBhbmQgdGhlIHRhcmdldAoJCQlpID0gMjsKCQl9CgoJCS8vIGV4dGVuZCBQaGFzZXIgaWYgb25seSBvbmUgYXJndW1lbnQgaXMgcGFzc2VkCgkJaWYgKGxlbmd0aCA9PT0gaSkKCQl7CgkJCXRhcmdldCA9IHRoaXM7CgkJCS0taTsKCQl9CgoJCWZvciAoIDsgaSA8IGxlbmd0aDsgaSsrICkKCQl7CgkJCS8vIE9ubHkgZGVhbCB3aXRoIG5vbi1udWxsL3VuZGVmaW5lZCB2YWx1ZXMKCQkJaWYgKChvcHRpb25zID0gYXJndW1lbnRzW2ldKSAhPSBudWxsKQoJCQl7CgkJCQkvLyBFeHRlbmQgdGhlIGJhc2Ugb2JqZWN0CgkJCQlmb3IgKG5hbWUgaW4gb3B0aW9ucykKCQkJCXsKCQkJCQlzcmMgPSB0YXJnZXRbbmFtZV07CgkJCQkJY29weSA9IG9wdGlvbnNbbmFtZV07CgoJCQkJCS8vIFByZXZlbnQgbmV2ZXItZW5kaW5nIGxvb3AKCQkJCQlpZiAodGFyZ2V0ID09PSBjb3B5KQoJCQkJCXsKCQkJCQkJY29udGludWU7CgkJCQkJfQoKCQkJCQkvLyBSZWN1cnNlIGlmIHdlJ3JlIG1lcmdpbmcgcGxhaW4gb2JqZWN0cyBvciBhcnJheXMKCQkJCQlpZiAoZGVlcCAmJiBjb3B5ICYmIChQaGFzZXIuVXRpbHMuaXNQbGFpbk9iamVjdChjb3B5KSB8fCAoY29weUlzQXJyYXkgPSBBcnJheS5pc0FycmF5KGNvcHkpKSkpCgkJCQkJewoJCQkJCQlpZiAoY29weUlzQXJyYXkpCgkJCQkJCXsKCQkJCQkJCWNvcHlJc0FycmF5ID0gZmFsc2U7CgkJCQkJCQljbG9uZSA9IHNyYyAmJiBBcnJheS5pc0FycmF5KHNyYykgPyBzcmMgOiBbXTsKCQkJCQkJfQoJCQkJCQllbHNlCgkJCQkJCXsKCQkJCQkJCWNsb25lID0gc3JjICYmIFBoYXNlci5VdGlscy5pc1BsYWluT2JqZWN0KHNyYykgPyBzcmMgOiB7fTsKCQkJCQkJfQoKCQkJCQkJLy8gTmV2ZXIgbW92ZSBvcmlnaW5hbCBvYmplY3RzLCBjbG9uZSB0aGVtCgkJCQkJCXRhcmdldFtuYW1lXSA9IFBoYXNlci5VdGlscy5leHRlbmQoZGVlcCwgY2xvbmUsIGNvcHkpOwoKCQkJCQkvLyBEb24ndCBicmluZyBpbiB1bmRlZmluZWQgdmFsdWVzCgkJCQkJfQoJCQkJCWVsc2UgaWYgKGNvcHkgIT09IHVuZGVmaW5lZCkKCQkJCQl7CgkJCQkJCXRhcmdldFtuYW1lXSA9IGNvcHk7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBSZXR1cm4gdGhlIG1vZGlmaWVkIG9iamVjdAoJCXJldHVybiB0YXJnZXQ7Cgl9Cgp9OwoKLy8JR2xvYmFsIGZ1bmN0aW9ucyB0aGF0IFBJWEkgbmVlZHMKCihmdW5jdGlvbigpIHsKICAgIHZhciBjb25zb2xlRGlzYWJsZWQgPSBmYWxzZTsKICAgIGlmIChjb25zb2xlRGlzYWJsZWQpIHsKICAgICAgICB3aW5kb3cuY29uc29sZSA9IHVuZGVmaW5lZDsKICAgIH0KICAgIGlmICh3aW5kb3cuY29uc29sZSA9PSB1bmRlZmluZWQpIHsKICAgICAgICB3aW5kb3cuY29uc29sZSA9IHsKICAgICAgICAgICAgZGVidWc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGluZm86IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICB3YXJuOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgbG9nOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGRlYnVnID0gKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5kZWJ1ZyhhcmdzKTsKICAgIH0pOwogICAgaW5mbyA9IChmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUuaW5mbyhhcmdzKTsKICAgIH0pOwogICAgd2FybiA9IChmdW5jdGlvbihhcmdzKSB7CiAgICAgICAgd2luZG93LmNvbnNvbGUud2FybihhcmdzKTsKICAgIH0pOwogICAgbG9nID0gKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5sb2coYXJncyk7CiAgICB9KTsKfSkoKTsKCi8qKgoqIENvbnZlcnRzIGEgaGV4IGNvbG9yIG51bWJlciB0byBhbiBbUiwgRywgQl0gYXJyYXkKKgoqIEBwYXJhbSB7bnVtYmVyfSBoZXggCiogQHJldHVybiB7YXJyYXl9CiovCmZ1bmN0aW9uIEhFWHRvUkdCKGhleCkgewoJcmV0dXJuIFsoaGV4ID4+IDE2ICYgMHhGRikgLyAyNTUsICggaGV4ID4+IDggJiAweEZGKSAvIDI1NSwgKGhleCAmIDB4RkYpLyAyNTVdOwp9CgovKioKKiBBIHBvbHlmaWxsIGZvciBGdW5jdGlvbi5wcm90b3R5cGUuYmluZAoqLwppZiAodHlwZW9mIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kICE9ICdmdW5jdGlvbicpIHsKICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IChmdW5jdGlvbiAoKSB7CiAgICB2YXIgc2xpY2UgPSBBcnJheS5wcm90b3R5cGUuc2xpY2U7CiAgICByZXR1cm4gZnVuY3Rpb24gKHRoaXNBcmcpIHsKICAgICAgdmFyIHRhcmdldCA9IHRoaXMsIGJvdW5kQXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKIAogICAgICBpZiAodHlwZW9mIHRhcmdldCAhPSAnZnVuY3Rpb24nKSB0aHJvdyBuZXcgVHlwZUVycm9yKCk7CiAKICAgICAgZnVuY3Rpb24gYm91bmQoKSB7Cgl2YXIgYXJncyA9IGJvdW5kQXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKTsKCXRhcmdldC5hcHBseSh0aGlzIGluc3RhbmNlb2YgYm91bmQgPyB0aGlzIDogdGhpc0FyZywgYXJncyk7CiAgICAgIH0KIAogICAgICBib3VuZC5wcm90b3R5cGUgPSAoZnVuY3Rpb24gRihwcm90bykgewogICAgICAgICAgcHJvdG8gJiYgKEYucHJvdG90eXBlID0gcHJvdG8pOwogICAgICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIEYpKSByZXR1cm4gbmV3IEY7ICAgICAgICAgIAoJfSkodGFyZ2V0LnByb3RvdHlwZSk7CiAKICAgICAgcmV0dXJuIGJvdW5kOwogICAgfTsKICB9KSgpOwp9CgoKCgovKgogKiBBIGxpZ2h0ZXIgdmVyc2lvbiBvZiB0aGUgcmFkIGdsLW1hdHJpeCBjcmVhdGVkIGJ5IEJyYW5kb24gSm9uZXMsIENvbGluIE1hY0tlbnppZSBJVgogKiB5b3UgYm90aCByb2NrIQogKi8KCmZ1bmN0aW9uIGRldGVybWluZU1hdHJpeEFycmF5VHlwZSgpIHsKICAgIFBJWEkuTWF0cml4ID0gKHR5cGVvZiBGbG9hdDMyQXJyYXkgIT09ICd1bmRlZmluZWQnKSA/IEZsb2F0MzJBcnJheSA6IEFycmF5OwogICAgcmV0dXJuIFBJWEkuTWF0cml4Owp9CgpkZXRlcm1pbmVNYXRyaXhBcnJheVR5cGUoKTsKClBJWEkubWF0MyA9IHt9OwoKUElYSS5tYXQzLmNyZWF0ZSA9IGZ1bmN0aW9uKCkKewoJdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCg5KTsKCgltYXRyaXhbMF0gPSAxOwoJbWF0cml4WzFdID0gMDsKCW1hdHJpeFsyXSA9IDA7CgltYXRyaXhbM10gPSAwOwoJbWF0cml4WzRdID0gMTsKCW1hdHJpeFs1XSA9IDA7CgltYXRyaXhbNl0gPSAwOwoJbWF0cml4WzddID0gMDsKCW1hdHJpeFs4XSA9IDE7CgoJcmV0dXJuIG1hdHJpeDsKfQoKClBJWEkubWF0My5pZGVudGl0eSA9IGZ1bmN0aW9uKG1hdHJpeCkKewoJbWF0cml4WzBdID0gMTsKCW1hdHJpeFsxXSA9IDA7CgltYXRyaXhbMl0gPSAwOwoJbWF0cml4WzNdID0gMDsKCW1hdHJpeFs0XSA9IDE7CgltYXRyaXhbNV0gPSAwOwoJbWF0cml4WzZdID0gMDsKCW1hdHJpeFs3XSA9IDA7CgltYXRyaXhbOF0gPSAxOwoKCXJldHVybiBtYXRyaXg7Cn0KCgpQSVhJLm1hdDQgPSB7fTsKClBJWEkubWF0NC5jcmVhdGUgPSBmdW5jdGlvbigpCnsKCXZhciBtYXRyaXggPSBuZXcgUElYSS5NYXRyaXgoMTYpOwoKCW1hdHJpeFswXSA9IDE7CgltYXRyaXhbMV0gPSAwOwoJbWF0cml4WzJdID0gMDsKCW1hdHJpeFszXSA9IDA7CgltYXRyaXhbNF0gPSAwOwoJbWF0cml4WzVdID0gMTsKCW1hdHJpeFs2XSA9IDA7CgltYXRyaXhbN10gPSAwOwoJbWF0cml4WzhdID0gMDsKCW1hdHJpeFs5XSA9IDA7CgltYXRyaXhbMTBdID0gMTsKCW1hdHJpeFsxMV0gPSAwOwoJbWF0cml4WzEyXSA9IDA7CgltYXRyaXhbMTNdID0gMDsKCW1hdHJpeFsxNF0gPSAwOwoJbWF0cml4WzE1XSA9IDE7CgoJcmV0dXJuIG1hdHJpeDsKfQoKUElYSS5tYXQzLm11bHRpcGx5ID0gZnVuY3Rpb24gKG1hdCwgbWF0MiwgZGVzdCkKewoJaWYgKCFkZXN0KSB7IGRlc3QgPSBtYXQ7IH0KCgkvLyBDYWNoZSB0aGUgbWF0cml4IHZhbHVlcyAobWFrZXMgZm9yIGh1Z2Ugc3BlZWQgaW5jcmVhc2VzISkKCXZhciBhMDAgPSBtYXRbMF0sIGEwMSA9IG1hdFsxXSwgYTAyID0gbWF0WzJdLAoJICAgIGExMCA9IG1hdFszXSwgYTExID0gbWF0WzRdLCBhMTIgPSBtYXRbNV0sCgkgICAgYTIwID0gbWF0WzZdLCBhMjEgPSBtYXRbN10sIGEyMiA9IG1hdFs4XSwKCgkgICAgYjAwID0gbWF0MlswXSwgYjAxID0gbWF0MlsxXSwgYjAyID0gbWF0MlsyXSwKCSAgICBiMTAgPSBtYXQyWzNdLCBiMTEgPSBtYXQyWzRdLCBiMTIgPSBtYXQyWzVdLAoJICAgIGIyMCA9IG1hdDJbNl0sIGIyMSA9IG1hdDJbN10sIGIyMiA9IG1hdDJbOF07CgoJZGVzdFswXSA9IGIwMCAqIGEwMCArIGIwMSAqIGExMCArIGIwMiAqIGEyMDsKCWRlc3RbMV0gPSBiMDAgKiBhMDEgKyBiMDEgKiBhMTEgKyBiMDIgKiBhMjE7CglkZXN0WzJdID0gYjAwICogYTAyICsgYjAxICogYTEyICsgYjAyICogYTIyOwoKCWRlc3RbM10gPSBiMTAgKiBhMDAgKyBiMTEgKiBhMTAgKyBiMTIgKiBhMjA7CglkZXN0WzRdID0gYjEwICogYTAxICsgYjExICogYTExICsgYjEyICogYTIxOwoJZGVzdFs1XSA9IGIxMCAqIGEwMiArIGIxMSAqIGExMiArIGIxMiAqIGEyMjsKCglkZXN0WzZdID0gYjIwICogYTAwICsgYjIxICogYTEwICsgYjIyICogYTIwOwoJZGVzdFs3XSA9IGIyMCAqIGEwMSArIGIyMSAqIGExMSArIGIyMiAqIGEyMTsKCWRlc3RbOF0gPSBiMjAgKiBhMDIgKyBiMjEgKiBhMTIgKyBiMjIgKiBhMjI7CgoJcmV0dXJuIGRlc3Q7Cn0KClBJWEkubWF0My5jbG9uZSA9IGZ1bmN0aW9uKG1hdCkKewoJdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCg5KTsKCgltYXRyaXhbMF0gPSBtYXRbMF07CgltYXRyaXhbMV0gPSBtYXRbMV07CgltYXRyaXhbMl0gPSBtYXRbMl07CgltYXRyaXhbM10gPSBtYXRbM107CgltYXRyaXhbNF0gPSBtYXRbNF07CgltYXRyaXhbNV0gPSBtYXRbNV07CgltYXRyaXhbNl0gPSBtYXRbNl07CgltYXRyaXhbN10gPSBtYXRbN107CgltYXRyaXhbOF0gPSBtYXRbOF07CgoJcmV0dXJuIG1hdHJpeDsKfQoKUElYSS5tYXQzLnRyYW5zcG9zZSA9IGZ1bmN0aW9uIChtYXQsIGRlc3QpCnsKIAkvLyBJZiB3ZSBhcmUgdHJhbnNwb3Npbmcgb3Vyc2VsdmVzIHdlIGNhbiBza2lwIGEgZmV3IHN0ZXBzIGJ1dCBoYXZlIHRvIGNhY2hlIHNvbWUgdmFsdWVzCiAgICBpZiAoIWRlc3QgfHwgbWF0ID09PSBkZXN0KSB7CiAgICAgICAgdmFyIGEwMSA9IG1hdFsxXSwgYTAyID0gbWF0WzJdLAogICAgICAgICAgICBhMTIgPSBtYXRbNV07CgogICAgICAgIG1hdFsxXSA9IG1hdFszXTsKICAgICAgICBtYXRbMl0gPSBtYXRbNl07CiAgICAgICAgbWF0WzNdID0gYTAxOwogICAgICAgIG1hdFs1XSA9IG1hdFs3XTsKICAgICAgICBtYXRbNl0gPSBhMDI7CiAgICAgICAgbWF0WzddID0gYTEyOwogICAgICAgIHJldHVybiBtYXQ7CiAgICB9CgogICAgZGVzdFswXSA9IG1hdFswXTsKICAgIGRlc3RbMV0gPSBtYXRbM107CiAgICBkZXN0WzJdID0gbWF0WzZdOwogICAgZGVzdFszXSA9IG1hdFsxXTsKICAgIGRlc3RbNF0gPSBtYXRbNF07CiAgICBkZXN0WzVdID0gbWF0WzddOwogICAgZGVzdFs2XSA9IG1hdFsyXTsKICAgIGRlc3RbN10gPSBtYXRbNV07CiAgICBkZXN0WzhdID0gbWF0WzhdOwogICAgcmV0dXJuIGRlc3Q7Cn0KClBJWEkubWF0My50b01hdDQgPSBmdW5jdGlvbiAobWF0LCBkZXN0KQp7CglpZiAoIWRlc3QpIHsgZGVzdCA9IFBJWEkubWF0NC5jcmVhdGUoKTsgfQoKCWRlc3RbMTVdID0gMTsKCWRlc3RbMTRdID0gMDsKCWRlc3RbMTNdID0gMDsKCWRlc3RbMTJdID0gMDsKCglkZXN0WzExXSA9IDA7CglkZXN0WzEwXSA9IG1hdFs4XTsKCWRlc3RbOV0gPSBtYXRbN107CglkZXN0WzhdID0gbWF0WzZdOwoKCWRlc3RbN10gPSAwOwoJZGVzdFs2XSA9IG1hdFs1XTsKCWRlc3RbNV0gPSBtYXRbNF07CglkZXN0WzRdID0gbWF0WzNdOwoKCWRlc3RbM10gPSAwOwoJZGVzdFsyXSA9IG1hdFsyXTsKCWRlc3RbMV0gPSBtYXRbMV07CglkZXN0WzBdID0gbWF0WzBdOwoKCXJldHVybiBkZXN0Owp9CgoKLy8vLy8KCgpQSVhJLm1hdDQuY3JlYXRlID0gZnVuY3Rpb24oKQp7Cgl2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDE2KTsKCgltYXRyaXhbMF0gPSAxOwoJbWF0cml4WzFdID0gMDsKCW1hdHJpeFsyXSA9IDA7CgltYXRyaXhbM10gPSAwOwoJbWF0cml4WzRdID0gMDsKCW1hdHJpeFs1XSA9IDE7CgltYXRyaXhbNl0gPSAwOwoJbWF0cml4WzddID0gMDsKCW1hdHJpeFs4XSA9IDA7CgltYXRyaXhbOV0gPSAwOwoJbWF0cml4WzEwXSA9IDE7CgltYXRyaXhbMTFdID0gMDsKCW1hdHJpeFsxMl0gPSAwOwoJbWF0cml4WzEzXSA9IDA7CgltYXRyaXhbMTRdID0gMDsKCW1hdHJpeFsxNV0gPSAxOwoKCXJldHVybiBtYXRyaXg7Cn0KClBJWEkubWF0NC50cmFuc3Bvc2UgPSBmdW5jdGlvbiAobWF0LCBkZXN0KQp7CgkvLyBJZiB3ZSBhcmUgdHJhbnNwb3Npbmcgb3Vyc2VsdmVzIHdlIGNhbiBza2lwIGEgZmV3IHN0ZXBzIGJ1dCBoYXZlIHRvIGNhY2hlIHNvbWUgdmFsdWVzCglpZiAoIWRlc3QgfHwgbWF0ID09PSBkZXN0KQoJewoJICAgIHZhciBhMDEgPSBtYXRbMV0sIGEwMiA9IG1hdFsyXSwgYTAzID0gbWF0WzNdLAoJICAgICAgICBhMTIgPSBtYXRbNl0sIGExMyA9IG1hdFs3XSwKCSAgICAgICAgYTIzID0gbWF0WzExXTsKCgkgICAgbWF0WzFdID0gbWF0WzRdOwoJICAgIG1hdFsyXSA9IG1hdFs4XTsKCSAgICBtYXRbM10gPSBtYXRbMTJdOwoJICAgIG1hdFs0XSA9IGEwMTsKCSAgICBtYXRbNl0gPSBtYXRbOV07CgkgICAgbWF0WzddID0gbWF0WzEzXTsKCSAgICBtYXRbOF0gPSBhMDI7CgkgICAgbWF0WzldID0gYTEyOwoJICAgIG1hdFsxMV0gPSBtYXRbMTRdOwoJICAgIG1hdFsxMl0gPSBhMDM7CgkgICAgbWF0WzEzXSA9IGExMzsKCSAgICBtYXRbMTRdID0gYTIzOwoJICAgIHJldHVybiBtYXQ7Cgl9CgoJZGVzdFswXSA9IG1hdFswXTsKCWRlc3RbMV0gPSBtYXRbNF07CglkZXN0WzJdID0gbWF0WzhdOwoJZGVzdFszXSA9IG1hdFsxMl07CglkZXN0WzRdID0gbWF0WzFdOwoJZGVzdFs1XSA9IG1hdFs1XTsKCWRlc3RbNl0gPSBtYXRbOV07CglkZXN0WzddID0gbWF0WzEzXTsKCWRlc3RbOF0gPSBtYXRbMl07CglkZXN0WzldID0gbWF0WzZdOwoJZGVzdFsxMF0gPSBtYXRbMTBdOwoJZGVzdFsxMV0gPSBtYXRbMTRdOwoJZGVzdFsxMl0gPSBtYXRbM107CglkZXN0WzEzXSA9IG1hdFs3XTsKCWRlc3RbMTRdID0gbWF0WzExXTsKCWRlc3RbMTVdID0gbWF0WzE1XTsKCXJldHVybiBkZXN0Owp9CgpQSVhJLm1hdDQubXVsdGlwbHkgPSBmdW5jdGlvbiAobWF0LCBtYXQyLCBkZXN0KQp7CglpZiAoIWRlc3QpIHsgZGVzdCA9IG1hdDsgfQoKCS8vIENhY2hlIHRoZSBtYXRyaXggdmFsdWVzIChtYWtlcyBmb3IgaHVnZSBzcGVlZCBpbmNyZWFzZXMhKQoJdmFyIGEwMCA9IG1hdFsgMF0sIGEwMSA9IG1hdFsgMV0sIGEwMiA9IG1hdFsgMl0sIGEwMyA9IG1hdFszXTsKCXZhciBhMTAgPSBtYXRbIDRdLCBhMTEgPSBtYXRbIDVdLCBhMTIgPSBtYXRbIDZdLCBhMTMgPSBtYXRbN107Cgl2YXIgYTIwID0gbWF0WyA4XSwgYTIxID0gbWF0WyA5XSwgYTIyID0gbWF0WzEwXSwgYTIzID0gbWF0WzExXTsKCXZhciBhMzAgPSBtYXRbMTJdLCBhMzEgPSBtYXRbMTNdLCBhMzIgPSBtYXRbMTRdLCBhMzMgPSBtYXRbMTVdOwoKCS8vIENhY2hlIG9ubHkgdGhlIGN1cnJlbnQgbGluZSBvZiB0aGUgc2Vjb25kIG1hdHJpeAogICAgdmFyIGIwICA9IG1hdDJbMF0sIGIxID0gbWF0MlsxXSwgYjIgPSBtYXQyWzJdLCBiMyA9IG1hdDJbM107CiAgICBkZXN0WzBdID0gYjAqYTAwICsgYjEqYTEwICsgYjIqYTIwICsgYjMqYTMwOwogICAgZGVzdFsxXSA9IGIwKmEwMSArIGIxKmExMSArIGIyKmEyMSArIGIzKmEzMTsKICAgIGRlc3RbMl0gPSBiMCphMDIgKyBiMSphMTIgKyBiMiphMjIgKyBiMyphMzI7CiAgICBkZXN0WzNdID0gYjAqYTAzICsgYjEqYTEzICsgYjIqYTIzICsgYjMqYTMzOwoKICAgIGIwID0gbWF0Mls0XTsKICAgIGIxID0gbWF0Mls1XTsKICAgIGIyID0gbWF0Mls2XTsKICAgIGIzID0gbWF0Mls3XTsKICAgIGRlc3RbNF0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzVdID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFs2XSA9IGIwKmEwMiArIGIxKmExMiArIGIyKmEyMiArIGIzKmEzMjsKICAgIGRlc3RbN10gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgYjAgPSBtYXQyWzhdOwogICAgYjEgPSBtYXQyWzldOwogICAgYjIgPSBtYXQyWzEwXTsKICAgIGIzID0gbWF0MlsxMV07CiAgICBkZXN0WzhdID0gYjAqYTAwICsgYjEqYTEwICsgYjIqYTIwICsgYjMqYTMwOwogICAgZGVzdFs5XSA9IGIwKmEwMSArIGIxKmExMSArIGIyKmEyMSArIGIzKmEzMTsKICAgIGRlc3RbMTBdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFsxMV0gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgYjAgPSBtYXQyWzEyXTsKICAgIGIxID0gbWF0MlsxM107CiAgICBiMiA9IG1hdDJbMTRdOwogICAgYjMgPSBtYXQyWzE1XTsKICAgIGRlc3RbMTJdID0gYjAqYTAwICsgYjEqYTEwICsgYjIqYTIwICsgYjMqYTMwOwogICAgZGVzdFsxM10gPSBiMCphMDEgKyBiMSphMTEgKyBiMiphMjEgKyBiMyphMzE7CiAgICBkZXN0WzE0XSA9IGIwKmEwMiArIGIxKmExMiArIGIyKmEyMiArIGIzKmEzMjsKICAgIGRlc3RbMTVdID0gYjAqYTAzICsgYjEqYTEzICsgYjIqYTIzICsgYjMqYTMzOwoKICAgIHJldHVybiBkZXN0Owp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIFRoZSBQb2ludCBvYmplY3QgcmVwcmVzZW50cyBhIGxvY2F0aW9uIGluIGEgdHdvLWRpbWVuc2lvbmFsIGNvb3JkaW5hdGUgc3lzdGVtLCB3aGVyZSB4IHJlcHJlc2VudHMgdGhlIGhvcml6b250YWwgYXhpcyBhbmQgeSByZXByZXNlbnRzIHRoZSB2ZXJ0aWNhbCBheGlzLgogKgogKiBAY2xhc3MgUG9pbnQKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IHBvc2l0aW9uIG9mIHRoZSBwb2ludAogKiBAcGFyYW0geSB7TnVtYmVyfSBwb3NpdGlvbiBvZiB0aGUgcG9pbnQKICovClBJWEkuUG9pbnQgPSBmdW5jdGlvbih4LCB5KQp7CgkvKioKCSAqIEBwcm9wZXJ0eSB4CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqLwoJdGhpcy54ID0geCB8fCAwOwoKCS8qKgoJICogQHByb3BlcnR5IHkKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgMAoJICovCgl0aGlzLnkgPSB5IHx8IDA7Cn0KCi8qKgogKiBDcmVhdGVzIGEgY2xvbmUgb2YgdGhpcyBwb2ludAogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1BvaW50fSBhIGNvcHkgb2YgdGhlIHBvaW50CiAqLwpQSVhJLlBvaW50LnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewoJcmV0dXJuIG5ldyBQSVhJLlBvaW50KHRoaXMueCwgdGhpcy55KTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5Qb2ludC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlBvaW50OwoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vCiAqLwoKLyoqCiAqIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGlzIGFuIGFyZWEgZGVmaW5lZCBieSBpdHMgcG9zaXRpb24sIGFzIGluZGljYXRlZCBieSBpdHMgdG9wLWxlZnQgY29ybmVyIHBvaW50ICh4LCB5KSBhbmQgYnkgaXRzIHdpZHRoIGFuZCBpdHMgaGVpZ2h0LgogKgogKiBAY2xhc3MgUmVjdGFuZ2xlCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgdXBwZXItbGVmdCBjb3JuZXIgb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgdXBwZXItbGVmdCBjb3JuZXIgb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gVGhlIG92ZXJhbGwgd2lkdGggb2YgdGhpcyByZWN0YW5nbGUKICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSBUaGUgb3ZlcmFsbCBoZWlnaHQgb2YgdGhpcyByZWN0YW5nbGUKICovClBJWEkuUmVjdGFuZ2xlID0gZnVuY3Rpb24oeCwgeSwgd2lkdGgsIGhlaWdodCkKewoJLyoqCgkgKiBAcHJvcGVydHkgeAoJICogQHR5cGUgTnVtYmVyCgkgKiBAZGVmYXVsdCAwCgkgKi8KCXRoaXMueCA9IHggfHwgMDsKCgkvKioKCSAqIEBwcm9wZXJ0eSB5CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqLwoJdGhpcy55ID0geSB8fCAwOwoKCS8qKgoJICogQHByb3BlcnR5IHdpZHRoCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqLwoJdGhpcy53aWR0aCA9IHdpZHRoIHx8IDA7CgoJLyoqCgkgKiBAcHJvcGVydHkgaGVpZ2h0CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqLwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgMDsKfQoKLyoqCiAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGlzIFJlY3RhbmdsZQogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1JlY3RhbmdsZX0gYSBjb3B5IG9mIHRoZSByZWN0YW5nbGUKICovClBJWEkuUmVjdGFuZ2xlLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewoJcmV0dXJuIG5ldyBQSVhJLlJlY3RhbmdsZSh0aGlzLngsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwp9CgovKioKICogQ2hlY2tzIGlmIHRoZSB4LCBhbmQgeSBjb29yZHMgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhpcyBSZWN0YW5nbGUKICoKICogQG1ldGhvZCBjb250YWlucwogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcmV0dXJuIHtCb29sZWFufSBpZiB0aGUgeC95IGNvb3JkcyBhcmUgd2l0aGluIHRoaXMgUmVjdGFuZ2xlCiAqLwpQSVhJLlJlY3RhbmdsZS5wcm90b3R5cGUuY29udGFpbnMgPSBmdW5jdGlvbih4LCB5KQp7CiAgICBpZih0aGlzLndpZHRoIDw9IDAgfHwgdGhpcy5oZWlnaHQgPD0gMCkKICAgICAgICByZXR1cm4gZmFsc2U7CgoJdmFyIHgxID0gdGhpcy54OwoJaWYoeCA+PSB4MSAmJiB4IDw9IHgxICsgdGhpcy53aWR0aCkKCXsKCQl2YXIgeTEgPSB0aGlzLnk7CgoJCWlmKHkgPj0geTEgJiYgeSA8PSB5MSArIHRoaXMuaGVpZ2h0KQoJCXsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCXJldHVybiBmYWxzZTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5SZWN0YW5nbGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SZWN0YW5nbGU7CgoKLyoqCiAqIEBhdXRob3IgQWRyaWVuIEJyYXVsdCA8YWRyaWVuLmJyYXVsdEBnbWFpbC5jb20+CiAqLwoKLyoqCiAqIEBjbGFzcyBQb2x5Z29uCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gcG9pbnRzKiB7QXJyYXk8UG9pbnQ+fEFycmF5PE51bWJlcj58UG9pbnQuLi58TnVtYmVyLi4ufSBUaGlzIGNhbiBiZSBhbiBhcnJheSBvZiBQb2ludHMgdGhhdCBmb3JtIHRoZSBwb2x5Z29uLAogKiAgICAgIGEgZmxhdCBhcnJheSBvZiBudW1iZXJzIHRoYXQgd2lsbCBiZSBpbnRlcnByZXRlZCBhcyBbeCx5LCB4LHksIC4uLl0sIG9yIHRoZSBhcmd1bWVudHMgcGFzc2VkIGNhbiBiZQogKiAgICAgIGFsbCB0aGUgcG9pbnRzIG9mIHRoZSBwb2x5Z29uIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24obmV3IFBJWEkuUG9pbnQoKSwgbmV3IFBJWEkuUG9pbnQoKSwgLi4uKWAsIG9yIHRoZQogKiAgICAgIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGZsYXQgeCx5IHZhbHVlcyBlLmcuIGBuZXcgUElYSS5Qb2x5Z29uKHgseSwgeCx5LCB4LHksIC4uLilgIHdoZXJlIGB4YCBhbmQgYHlgIGFyZQogKiAgICAgIE51bWJlcnMuCiAqLwpQSVhJLlBvbHlnb24gPSBmdW5jdGlvbihwb2ludHMpCnsKICAgIC8vaWYgcG9pbnRzIGlzbid0IGFuIGFycmF5LCB1c2UgYXJndW1lbnRzIGFzIHRoZSBhcnJheQogICAgaWYoIShwb2ludHMgaW5zdGFuY2VvZiBBcnJheSkpCiAgICAgICAgcG9pbnRzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCiAgICAvL2lmIHRoaXMgaXMgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMsIGNvbnZlcnQgaXQgdG8gcG9pbnRzCiAgICBpZih0eXBlb2YgcG9pbnRzWzBdID09PSAnbnVtYmVyJykgewogICAgICAgIHZhciBwID0gW107CiAgICAgICAgZm9yKHZhciBpID0gMCwgaWwgPSBwb2ludHMubGVuZ3RoOyBpIDwgaWw7IGkrPTIpIHsKICAgICAgICAgICAgcC5wdXNoKAogICAgICAgICAgICAgICAgbmV3IFBJWEkuUG9pbnQocG9pbnRzW2ldLCBwb2ludHNbaSArIDFdKQogICAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgcG9pbnRzID0gcDsKICAgIH0KCgl0aGlzLnBvaW50cyA9IHBvaW50czsKfQoKLyoqCiAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGlzIHBvbHlnb24KICoKICogQG1ldGhvZCBjbG9uZQogKiBAcmV0dXJuIHtQb2x5Z29ufSBhIGNvcHkgb2YgdGhlIHBvbHlnb24KICovClBJWEkuUG9seWdvbi5wcm90b3R5cGUuY2xvbmUgPSBmdW5jdGlvbigpCnsKCXZhciBwb2ludHMgPSBbXTsKCWZvciAodmFyIGk9MDsgaTx0aGlzLnBvaW50cy5sZW5ndGg7IGkrKykgewoJCXBvaW50cy5wdXNoKHRoaXMucG9pbnRzW2ldLmNsb25lKCkpOwoJfQoKCXJldHVybiBuZXcgUElYSS5Qb2x5Z29uKHBvaW50cyk7Cn0KCi8qKgogKiBDaGVja3MgaWYgdGhlIHgsIGFuZCB5IGNvb3JkcyBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGlzIHBvbHlnb24KICoKICogQG1ldGhvZCBjb250YWlucwogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgcG9pbnQgdG8gdGVzdAogKiBAcmV0dXJuIHtCb29sZWFufSBpZiB0aGUgeC95IGNvb3JkcyBhcmUgd2l0aGluIHRoaXMgcG9seWdvbgogKi8KUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIHZhciBpbnNpZGUgPSBmYWxzZTsKCiAgICAvLyB1c2Ugc29tZSByYXljYXN0aW5nIHRvIHRlc3QgaGl0cwogICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3N1YnN0YWNrL3BvaW50LWluLXBvbHlnb24vYmxvYi9tYXN0ZXIvaW5kZXguanMKICAgIGZvcih2YXIgaSA9IDAsIGogPSB0aGlzLnBvaW50cy5sZW5ndGggLSAxOyBpIDwgdGhpcy5wb2ludHMubGVuZ3RoOyBqID0gaSsrKSB7CiAgICAgICAgdmFyIHhpID0gdGhpcy5wb2ludHNbaV0ueCwgeWkgPSB0aGlzLnBvaW50c1tpXS55LAogICAgICAgICAgICB4aiA9IHRoaXMucG9pbnRzW2pdLngsIHlqID0gdGhpcy5wb2ludHNbal0ueSwKICAgICAgICAgICAgaW50ZXJzZWN0ID0gKCh5aSA+IHkpICE9ICh5aiA+IHkpKSAmJiAoeCA8ICh4aiAtIHhpKSAqICh5IC0geWkpIC8gKHlqIC0geWkpICsgeGkpOwoKICAgICAgICBpZihpbnRlcnNlY3QpIGluc2lkZSA9ICFpbnNpZGU7CiAgICB9CgogICAgcmV0dXJuIGluc2lkZTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUG9seWdvbjsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogVGhlIGJhc2UgY2xhc3MgZm9yIGFsbCBvYmplY3RzIHRoYXQgYXJlIHJlbmRlcmVkIG9uIHRoZSBzY3JlZW4uCiAqCiAqIEBjbGFzcyBEaXNwbGF5T2JqZWN0CiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5EaXNwbGF5T2JqZWN0ID0gZnVuY3Rpb24oKQp7Cgl0aGlzLmxhc3QgPSB0aGlzOwoJdGhpcy5maXJzdCA9IHRoaXM7CgkvKioKCSAqIFRoZSBjb29yZGluYXRlIG9mIHRoZSBvYmplY3QgcmVsYXRpdmUgdG8gdGhlIGxvY2FsIGNvb3JkaW5hdGVzIG9mIHRoZSBwYXJlbnQuCgkgKgoJICogQHByb3BlcnR5IHBvc2l0aW9uCgkgKiBAdHlwZSBQb2ludAoJICovCgl0aGlzLnBvc2l0aW9uID0gbmV3IFBJWEkuUG9pbnQoKTsKCgkvKioKCSAqIFRoZSBzY2FsZSBmYWN0b3Igb2YgdGhlIG9iamVjdC4KCSAqCgkgKiBAcHJvcGVydHkgc2NhbGUKCSAqIEB0eXBlIFBvaW50CgkgKi8KCXRoaXMuc2NhbGUgPSBuZXcgUElYSS5Qb2ludCgxLDEpOy8ve3g6MSwgeToxfTsKCgkvKioKCSAqIFRoZSBwaXZvdCBwb2ludCBvZiB0aGUgZGlzcGxheU9iamVjdCB0aGF0IGl0IHJvdGF0ZXMgYXJvdW5kCgkgKgoJICogQHByb3BlcnR5IHBpdm90CgkgKiBAdHlwZSBQb2ludAoJICovCgl0aGlzLnBpdm90ID0gbmV3IFBJWEkuUG9pbnQoMCwwKTsKCgkvKioKCSAqIFRoZSByb3RhdGlvbiBvZiB0aGUgb2JqZWN0IGluIHJhZGlhbnMuCgkgKgoJICogQHByb3BlcnR5IHJvdGF0aW9uCgkgKiBAdHlwZSBOdW1iZXIKCSAqLwoJdGhpcy5yb3RhdGlvbiA9IDA7CgoJLyoqCgkgKiBUaGUgb3BhY2l0eSBvZiB0aGUgb2JqZWN0LgoJICoKCSAqIEBwcm9wZXJ0eSBhbHBoYQoJICogQHR5cGUgTnVtYmVyCgkgKi8JCgl0aGlzLmFscGhhID0gMTsKCgkvKioKCSAqIFRoZSB2aXNpYmlsaXR5IG9mIHRoZSBvYmplY3QuCgkgKgoJICogQHByb3BlcnR5IHZpc2libGUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqLwkKCXRoaXMudmlzaWJsZSA9IHRydWU7CgoJLyoqCgkgKiBUaGlzIGlzIHRoZSBkZWZpbmVkIGFyZWEgdGhhdCB3aWxsIHBpY2sgdXAgbW91c2UgLyB0b3VjaCBldmVudHMuIEl0IGlzIG51bGwgYnkgZGVmYXVsdC4KCSAqIFNldHRpbmcgaXQgaXMgYSBuZWF0IHdheSBvZiBvcHRpbWlzaW5nIHRoZSBoaXRUZXN0IGZ1bmN0aW9uIHRoYXQgdGhlIGludGVyYWN0aW9uTWFuYWdlciB3aWxsIHVzZSAoYXMgaXQgd2lsbCBub3QgbmVlZCB0byBoaXQgdGVzdCBhbGwgdGhlIGNoaWxkcmVuKQoJICoKCSAqIEBwcm9wZXJ0eSBoaXRBcmVhCgkgKiBAdHlwZSBSZWN0YW5nbGV8Q2lyY2xlfEVsbGlwc2V8UG9seWdvbgoJICovCQoJdGhpcy5oaXRBcmVhID0gbnVsbDsKCgkvKioKCSAqIFRoaXMgaXMgdXNlZCB0byBpbmRpY2F0ZSBpZiB0aGUgZGlzcGxheU9iamVjdCBzaG91bGQgZGlzcGxheSBhIG1vdXNlIGhhbmQgY3Vyc29yIG9uIHJvbGxvdmVyCgkgKgoJICogQHByb3BlcnR5IGJ1dHRvbk1vZGUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqLwoJdGhpcy5idXR0b25Nb2RlID0gZmFsc2U7CgoJLyoqCgkgKiBDYW4gdGhpcyBvYmplY3QgYmUgcmVuZGVyZWQKCSAqCgkgKiBAcHJvcGVydHkgcmVuZGVyYWJsZQoJICogQHR5cGUgQm9vbGVhbgoJICovCgl0aGlzLnJlbmRlcmFibGUgPSBmYWxzZTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIFRoZSBkaXNwbGF5IG9iamVjdCBjb250YWluZXIgdGhhdCBjb250YWlucyB0aGlzIGRpc3BsYXkgb2JqZWN0LgoJICoKCSAqIEBwcm9wZXJ0eSBwYXJlbnQKCSAqIEB0eXBlIERpc3BsYXlPYmplY3RDb250YWluZXIKCSAqIEByZWFkT25seQoJICovCQoJdGhpcy5wYXJlbnQgPSBudWxsOwoKCS8qKgoJICogW3JlYWQtb25seV0gVGhlIHN0YWdlIHRoZSBkaXNwbGF5IG9iamVjdCBpcyBjb25uZWN0ZWQgdG8sIG9yIHVuZGVmaW5lZCBpZiBpdCBpcyBub3QgY29ubmVjdGVkIHRvIHRoZSBzdGFnZS4KCSAqCgkgKiBAcHJvcGVydHkgc3RhZ2UKCSAqIEB0eXBlIFN0YWdlCgkgKiBAcmVhZE9ubHkKCSAqLwkKCXRoaXMuc3RhZ2UgPSBudWxsOwoKCS8qKgoJICogW3JlYWQtb25seV0gVGhlIG11bHRpcGxpZWQgYWxwaGEgb2YgdGhlIGRpc3BsYXlvYmplY3QKCSAqCgkgKiBAcHJvcGVydHkgd29ybGRBbHBoYQoJICogQHR5cGUgTnVtYmVyCgkgKiBAcmVhZE9ubHkKCSAqLwoJdGhpcy53b3JsZEFscGhhID0gMTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIFdoZXRoZXIgb3Igbm90IHRoZSBvYmplY3QgaXMgaW50ZXJhY3RpdmUsIGRvIG5vdCB0b2dnbGUgZGlyZWN0bHkhIHVzZSB0aGUgYGludGVyYWN0aXZlYCBwcm9wZXJ0eQoJICoKCSAqIEBwcm9wZXJ0eSBfaW50ZXJhY3RpdmUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEByZWFkT25seQoJICogQHByaXZhdGUKCSAqLwoJdGhpcy5faW50ZXJhY3RpdmUgPSBmYWxzZTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIEN1cnJlbnQgdHJhbnNmb3JtIG9mIHRoZSBvYmplY3QgYmFzZWQgb24gd29ybGQgKHBhcmVudCkgZmFjdG9ycwoJICoKCSAqIEBwcm9wZXJ0eSB3b3JsZFRyYW5zZm9ybQoJICogQHR5cGUgTWF0MwoJICogQHJlYWRPbmx5CgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpLy9tYXQzLmlkZW50aXR5KCk7CgoJLyoqCgkgKiBbcmVhZC1vbmx5XSBDdXJyZW50IHRyYW5zZm9ybSBvZiB0aGUgb2JqZWN0IGxvY2FsbHkKCSAqCgkgKiBAcHJvcGVydHkgbG9jYWxUcmFuc2Zvcm0KCSAqIEB0eXBlIE1hdDMKCSAqIEByZWFkT25seQoJICogQHByaXZhdGUKCSAqLwoJdGhpcy5sb2NhbFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKS8vbWF0My5pZGVudGl0eSgpOwoKCS8qKgoJICogW05ZSV0gVW5rb3duCgkgKgoJICogQHByb3BlcnR5IGNvbG9yCgkgKiBAdHlwZSBBcnJheTw+CgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLmNvbG9yID0gW107CgoJLyoqCgkgKiBbTllJXSBIb2xkcyB3aGV0aGVyIG9yIG5vdCB0aGlzIG9iamVjdCBpcyBkeW5hbWljLCBmb3IgcmVuZGVyaW5nIG9wdGltaXphdGlvbgoJICoKCSAqIEBwcm9wZXJ0eSBkeW5hbWljCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLmR5bmFtaWMgPSB0cnVlOwoKCS8vIGNoYWNoIHRoYXQgcHVwcHkhCgl0aGlzLl9zciA9IDA7Cgl0aGlzLl9jciA9IDE7CgoKCXRoaXMuZmlsdGVyQXJlYSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMSwxKTsKCQoJLyoKCSAqIE1PVVNFIENhbGxiYWNrcwoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyBjbGlja3Mgb24gdGhlIGRpc3BsYXlPYmplY3Qgd2l0aCB0aGVpciBtb3VzZQoJICogQG1ldGhvZCBjbGljawoJICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIGNsaWNrcyB0aGUgbW91c2UgZG93biBvdmVyIHRoZSBzcHJpdGUKCSAqIEBtZXRob2QgbW91c2Vkb3duCgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgcmVsZWFzZXMgdGhlIG1vdXNlIHRoYXQgd2FzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKCSAqIGZvciB0aGlzIGNhbGxiYWNrIHRvIGJlIGZpcmVkIHRoZSBtb3VzZSBtdXN0IGhhdmUgYmVlbiBwcmVzc2VkIGRvd24gb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogQG1ldGhvZCBtb3VzZXVwCgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgcmVsZWFzZXMgdGhlIG1vdXNlIHRoYXQgd2FzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QgYnV0IGlzIG5vIGxvbmdlciBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBmb3IgdGhpcyBjYWxsYmFjayB0byBiZSBmaXJlZCwgVGhlIHRvdWNoIG11c3QgaGF2ZSBzdGFydGVkIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKCSAqIEBtZXRob2QgbW91c2V1cG91dHNpZGUKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlcnMgbW91c2Ugcm9sbHMgb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogQG1ldGhvZCBtb3VzZW92ZXIKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlcnMgbW91c2UgbGVhdmVzIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBAbWV0aG9kIG1vdXNlb3V0CgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KCgoJLyoKCSAqIFRPVUNIIENhbGxiYWNrcwoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyB0YXBzIG9uIHRoZSBzcHJpdGUgd2l0aCB0aGVpciBmaW5nZXIKCSAqIGJhc2ljYWxseSBhIHRvdWNoIHZlcnNpb24gb2YgY2xpY2sKCSAqIEBtZXRob2QgdGFwCgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgdG91Y2gncyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBAbWV0aG9kIHRvdWNoc3RhcnQKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyBhIHRvdWNoIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKCSAqIEBtZXRob2QgdG91Y2hlbmQKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgdG91Y2ggdGhhdCB3YXMgb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogZm9yIHRoaXMgY2FsbGJhY2sgdG8gYmUgZmlyZWQsIFRoZSB0b3VjaCBtdXN0IGhhdmUgc3RhcnRlZCBvdmVyIHRoZSBzcHJpdGUKCSAqIEBtZXRob2QgdG91Y2hlbmRvdXRzaWRlCgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KfQoKLy8gY29uc3RydWN0b3IKUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuRGlzcGxheU9iamVjdDsKCi8qKgogKiBbRGVwcmVjYXRlZF0gSW5kaWNhdGVzIGlmIHRoZSBzcHJpdGUgd2lsbCBoYXZlIHRvdWNoIGFuZCBtb3VzZSBpbnRlcmFjdGl2aXR5LiBJdCBpcyBmYWxzZSBieSBkZWZhdWx0CiAqIEluc3RlYWQgb2YgdXNpbmcgdGhpcyBmdW5jdGlvbiB5b3UgY2FuIG5vdyBzaW1wbHkgc2V0IHRoZSBpbnRlcmFjdGl2ZSBwcm9wZXJ0eSB0byB0cnVlIG9yIGZhbHNlCiAqCiAqIEBtZXRob2Qgc2V0SW50ZXJhY3RpdmUKICogQHBhcmFtIGludGVyYWN0aXZlIHtCb29sZWFufQogKiBAZGVwcmVjYXRlZCBTaW1wbHkgc2V0IHRoZSBgaW50ZXJhY3RpdmVgIHByb3BlcnR5IGRpcmVjdGx5CiAqLwpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLnNldEludGVyYWN0aXZlID0gZnVuY3Rpb24oaW50ZXJhY3RpdmUpCnsKCXRoaXMuaW50ZXJhY3RpdmUgPSBpbnRlcmFjdGl2ZTsKfQoKLyoqCiAqIEluZGljYXRlcyBpZiB0aGUgc3ByaXRlIHdpbGwgaGF2ZSB0b3VjaCBhbmQgbW91c2UgaW50ZXJhY3Rpdml0eS4gSXQgaXMgZmFsc2UgYnkgZGVmYXVsdAogKgogKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKICogQHR5cGUgQm9vbGVhbgogKiBAZGVmYXVsdCBmYWxzZQogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUsICdpbnRlcmFjdGl2ZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ludGVyYWN0aXZlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLl9pbnRlcmFjdGl2ZSA9IHZhbHVlOwogICAgCQogICAgCS8vIFRPRE8gbW9yZSB0byBiZSBkb25lIGhlcmUuLgoJCS8vIG5lZWQgdG8gc29ydCBvdXQgYSByZS1jcmF3bCEKCQlpZih0aGlzLnN0YWdlKXRoaXMuc3RhZ2UuZGlydHkgPSB0cnVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIGEgbWFzayBmb3IgdGhlIGRpc3BsYXlPYmplY3QuIEEgbWFzayBpcyBhbiBvYmplY3QgdGhhdCBsaW1pdHMgdGhlIHZpc2liaWxpdHkgb2YgYW4gb2JqZWN0IHRvIHRoZSBzaGFwZSBvZiB0aGUgbWFzayBhcHBsaWVkIHRvIGl0LgogKiBJbiBQSVhJIGEgcmVndWxhciBtYXNrIG11c3QgYmUgYSBQSVhJLkdncmFwaGljcyBvYmplY3QuIFRoaXMgYWxsb3dzIGZvciBtdWNoIGZhc3RlciBtYXNraW5nIGluIGNhbnZhcyBhcyBpdCB1dGlsaXNlcyBzaGFwZSBjbGlwcGluZy4KICogVG8gcmVtb3ZlIGEgbWFzaywgc2V0IHRoaXMgcHJvcGVydHkgdG8gbnVsbC4KICoKICogQHByb3BlcnR5IG1hc2sKICogQHR5cGUgR3JhcGhpY3MKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLCAnbWFzaycsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX21hc2s7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCQogICAgCQogICAgICAgIGlmKHZhbHVlKQogICAgICAgIHsKICAgICAgICAJaWYodGhpcy5fbWFzaykKCSAgICAJewoJICAgIAkJdmFsdWUuc3RhcnQgPSB0aGlzLl9tYXNrLnN0YXJ0OwoJICAgIAkJdmFsdWUuZW5kID0gdGhpcy5fbWFzay5lbmQ7CgkgICAgCX0KICAgIAkJZWxzZQogICAgCQl7CgkJICAgICAgICB0aGlzLmFkZEZpbHRlcih2YWx1ZSk7CgkJICAgICAgICB2YWx1ZS5yZW5kZXJhYmxlID0gZmFsc2U7CiAgICAJCX0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAJIHRoaXMucmVtb3ZlRmlsdGVyKHRoaXMuX21hc2spOwoJCQkgdGhpcy5fbWFzay5yZW5kZXJhYmxlID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5fbWFzayA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIHRoZSBmaWx0ZXJzIGZvciB0aGUgZGlzcGxheU9iamVjdC4gCiAqICogSU1QT1JUQU5UOiBUaGlzIGlzIGEgd2ViR0wgb25seSBmZWF0dXJlIGFuZCB3aWxsIGJlIGlnbm9yZWQgYnkgdGhlIGNhbnZhcyByZW5kZXJlci4KICogVG8gcmVtb3ZlIGZpbHRlcnMgc2ltcGx5IHNldCB0aGlzIHByb3BlcnR5IHRvICdudWxsJwogKiBAcHJvcGVydHkgZmlsdGVycwogKiBAdHlwZSBBcnJheSBBbiBhcnJheSBvZiBmaWx0ZXJzCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZSwgJ2ZpbHRlcnMnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9maWx0ZXJzOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAkKICAgICAgICBpZih2YWx1ZSkKICAgICAgICB7CiAgICAgICAgCWlmKHRoaXMuX2ZpbHRlcnMpdGhpcy5yZW1vdmVGaWx0ZXIodGhpcy5fZmlsdGVycyk7CgkgICAgICAgIHRoaXMuYWRkRmlsdGVyKHZhbHVlKTsKCgkJICAgIC8vIG5vdyBwdXQgYWxsIHRoZSBwYXNzZXMgaW4gb25lIHBsYWNlLi4KCSAgICAgICAgdmFyIHBhc3NlcyA9IFtdOwoJICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHZhbHVlLmxlbmd0aDsgaSsrKSAKCSAgICAgICAgewoJICAgICAgICAJdmFyIGZpbHRlclBhc3NlcyA9IHZhbHVlW2ldLnBhc3NlczsKCSAgICAgICAgCWZvciAodmFyIGogPSAwOyBqIDwgZmlsdGVyUGFzc2VzLmxlbmd0aDsgaisrKSAKCSAgICAgICAgCXsKCSAgICAgICAgCQlwYXNzZXMucHVzaChmaWx0ZXJQYXNzZXNbal0pOwoJICAgICAgICAJfTsKCSAgICAgICAgfTsKCgkgICAgICAgIHZhbHVlLnN0YXJ0LmZpbHRlclBhc3NlcyA9IHBhc3NlczsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAJaWYodGhpcy5fZmlsdGVycyl0aGlzLnJlbW92ZUZpbHRlcih0aGlzLl9maWx0ZXJzKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5fZmlsdGVycyA9IHZhbHVlOwoKICAgICAgIAoKICAgICAgICAKICAgIH0KfSk7CgovKgogKiBBZGRzIGEgZmlsdGVyIHRvIHRoaXMgZGlzcGxheU9iamVjdAogKgogKiBAbWV0aG9kIGFkZEZpbHRlcgogKiBAcGFyYW0gbWFzayB7R3JhcGhpY3N9IHRoZSBncmFwaGljcyBvYmplY3QgdG8gdXNlIGFzIGEgZmlsdGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLmFkZEZpbHRlciA9IGZ1bmN0aW9uKGRhdGEpCnsKCgkvLyBpbnNlcnQgYSBmaWx0ZXIgYmxvY2suLgoJLy8gVE9ETyBPbmplY3QgcG9vbCB0aGVhc2UgYmFkIGJveXMuLgoJdmFyIHN0YXJ0ID0gbmV3IFBJWEkuRmlsdGVyQmxvY2soKTsKCXZhciBlbmQgPSBuZXcgUElYSS5GaWx0ZXJCbG9jaygpOwoJCglkYXRhLnN0YXJ0ID0gc3RhcnQ7CglkYXRhLmVuZCA9IGVuZDsKCQoJc3RhcnQuZGF0YSA9IGRhdGE7CgllbmQuZGF0YSA9IGRhdGE7CgkKCXN0YXJ0LmZpcnN0ID0gc3RhcnQubGFzdCA9ICB0aGlzOwoJZW5kLmZpcnN0ID0gZW5kLmxhc3QgPSB0aGlzOwoJCglzdGFydC5vcGVuID0gdHJ1ZTsKCQoJc3RhcnQudGFyZ2V0ID0gdGhpczsKCQoJLyoKCSAqIGluc2VydCBzdGFydAoJICovCgkKCXZhciBjaGlsZEZpcnN0ID0gc3RhcnQKCXZhciBjaGlsZExhc3QgPSBzdGFydAoJdmFyIG5leHRPYmplY3Q7Cgl2YXIgcHJldmlvdXNPYmplY3Q7CgkJCglwcmV2aW91c09iamVjdCA9IHRoaXMuZmlyc3QuX2lQcmV2OwoJCglpZihwcmV2aW91c09iamVjdCkKCXsKCQluZXh0T2JqZWN0ID0gcHJldmlvdXNPYmplY3QuX2lOZXh0OwoJCWNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CgkJcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gY2hpbGRGaXJzdDsJCQoJfQoJZWxzZQoJewoJCW5leHRPYmplY3QgPSB0aGlzOwoJfQkKCQoJaWYobmV4dE9iamVjdCkKCXsKCQluZXh0T2JqZWN0Ll9pUHJldiA9IGNoaWxkTGFzdDsKCQljaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKCX0KCQoJCgkvLyBub3cgaW5zZXJ0IHRoZSBlbmQgZmlsdGVyIGJsb2NrLi4KCQoJLyoKCSAqIGluc2VydCBlbmQgZmlsdGVyCgkgKi8KCXZhciBjaGlsZEZpcnN0ID0gZW5kCgl2YXIgY2hpbGRMYXN0ID0gZW5kCgl2YXIgbmV4dE9iamVjdCA9IG51bGw7Cgl2YXIgcHJldmlvdXNPYmplY3QgPSBudWxsOwoJCQoJcHJldmlvdXNPYmplY3QgPSB0aGlzLmxhc3Q7CgluZXh0T2JqZWN0ID0gcHJldmlvdXNPYmplY3QuX2lOZXh0OwoJCglpZihuZXh0T2JqZWN0KQoJewoJCW5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwoJCWNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwoJfQoJCgljaGlsZEZpcnN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwoJcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gY2hpbGRGaXJzdDsJCgkKCXZhciB1cGRhdGVMYXN0ID0gdGhpczsKCQoJdmFyIHByZXZMYXN0ID0gdGhpcy5sYXN0OwoJd2hpbGUodXBkYXRlTGFzdCkKCXsKCQlpZih1cGRhdGVMYXN0Lmxhc3QgPT0gcHJldkxhc3QpCgkJewoJCQl1cGRhdGVMYXN0Lmxhc3QgPSBlbmQ7CgkJfQoJCXVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKCX0KCQoJdGhpcy5maXJzdCA9IHN0YXJ0OwoJCgkvLyBpZiB3ZWJHTC4uLgoJaWYodGhpcy5fX3JlbmRlckdyb3VwKQoJewoJCXRoaXMuX19yZW5kZXJHcm91cC5hZGRGaWx0ZXJCbG9ja3Moc3RhcnQsIGVuZCk7Cgl9CgkKfQoKLyoKICogUmVtb3ZlcyB0aGUgZmlsdGVyIHRvIHRoaXMgZGlzcGxheU9iamVjdAogKgogKiBAbWV0aG9kIHJlbW92ZUZpbHRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS5yZW1vdmVGaWx0ZXIgPSBmdW5jdGlvbihkYXRhKQp7CgkvL2lmKCF0aGlzLmZpbHRlcilyZXR1cm47CgkvL3RoaXMuZmlsdGVyID0gZmFsc2U7Cgljb25zb2xlLmxvZygiWVVPSU8iKQoJLy8gbW9kaWZ5IHRoZSBsaXN0Li4KCXZhciBzdGFydEJsb2NrID0gZGF0YS5zdGFydDsKCQoJCgl2YXIgbmV4dE9iamVjdCA9IHN0YXJ0QmxvY2suX2lOZXh0OwoJdmFyIHByZXZpb3VzT2JqZWN0ID0gc3RhcnRCbG9jay5faVByZXY7CgkJCglpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CglpZihwcmV2aW91c09iamVjdClwcmV2aW91c09iamVjdC5faU5leHQgPSBuZXh0T2JqZWN0OwkJCgkKCXRoaXMuZmlyc3QgPSBzdGFydEJsb2NrLl9pTmV4dDsKCQoJLy8gcmVtb3ZlIHRoZSBlbmQgZmlsdGVyCgl2YXIgbGFzdEJsb2NrID0gZGF0YS5lbmQ7CgkKCXZhciBuZXh0T2JqZWN0ID0gbGFzdEJsb2NrLl9pTmV4dDsKCXZhciBwcmV2aW91c09iamVjdCA9IGxhc3RCbG9jay5faVByZXY7CgkJCglpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CglwcmV2aW91c09iamVjdC5faU5leHQgPSBuZXh0T2JqZWN0OwkJCgkKCS8vIHRoaXMgaXMgYWx3YXlzIHRydWUgdG9vIQoJdmFyIHRlbXBMYXN0ID0gIGxhc3RCbG9jay5faVByZXY7CQoJLy8gbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhcmVudHMgbGFzdCBpcyB1cGRhdGVkIHRvbwoJdmFyIHVwZGF0ZUxhc3QgPSB0aGlzOwoJd2hpbGUodXBkYXRlTGFzdC5sYXN0ID09IGxhc3RCbG9jaykKCXsKCQl1cGRhdGVMYXN0Lmxhc3QgPSB0ZW1wTGFzdDsKCQl1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CgkJaWYoIXVwZGF0ZUxhc3QpYnJlYWs7Cgl9CgkKCS8vIGlmIHdlYkdMLi4uCglpZih0aGlzLl9fcmVuZGVyR3JvdXApCgl7CgkJdGhpcy5fX3JlbmRlckdyb3VwLnJlbW92ZUZpbHRlckJsb2NrcyhzdGFydEJsb2NrLCBsYXN0QmxvY2spOwoJfQp9CgovKgogKiBVcGRhdGVzIHRoZSBvYmplY3QgdHJhbnNmb3JtIGZvciByZW5kZXJpbmcKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CgkvLyBUT0RPIE9QVElNSVpFIFRISVMhISB3aXRoIGRpcnR5CglpZih0aGlzLnJvdGF0aW9uICE9PSB0aGlzLnJvdGF0aW9uQ2FjaGUpCgl7CgkJdGhpcy5yb3RhdGlvbkNhY2hlID0gdGhpcy5yb3RhdGlvbjsKCQl0aGlzLl9zciA9ICBNYXRoLnNpbih0aGlzLnJvdGF0aW9uKTsKCQl0aGlzLl9jciA9ICBNYXRoLmNvcyh0aGlzLnJvdGF0aW9uKTsKCX0JCgkKCXZhciBsb2NhbFRyYW5zZm9ybSA9IHRoaXMubG9jYWxUcmFuc2Zvcm07Cgl2YXIgcGFyZW50VHJhbnNmb3JtID0gdGhpcy5wYXJlbnQud29ybGRUcmFuc2Zvcm07Cgl2YXIgd29ybGRUcmFuc2Zvcm0gPSB0aGlzLndvcmxkVHJhbnNmb3JtOwoJLy9jb25zb2xlLmxvZyhsb2NhbFRyYW5zZm9ybSkKCWxvY2FsVHJhbnNmb3JtWzBdID0gdGhpcy5fY3IgKiB0aGlzLnNjYWxlLng7Cglsb2NhbFRyYW5zZm9ybVsxXSA9IC10aGlzLl9zciAqIHRoaXMuc2NhbGUueQoJbG9jYWxUcmFuc2Zvcm1bM10gPSB0aGlzLl9zciAqIHRoaXMuc2NhbGUueDsKCWxvY2FsVHJhbnNmb3JtWzRdID0gdGhpcy5fY3IgKiB0aGlzLnNjYWxlLnk7CgkKCS8vIFRPRE8gLS0+IGRvIHdlIGV2ZW4gbmVlZCBhIGxvY2FsIG1hdHJpeD8/PwoJCgl2YXIgcHggPSB0aGlzLnBpdm90Lng7Cgl2YXIgcHkgPSB0aGlzLnBpdm90Lnk7CiAgIAkKICAgIC8vIENhY2hlIHRoZSBtYXRyaXggdmFsdWVzIChtYWtlcyBmb3IgaHVnZSBzcGVlZCBpbmNyZWFzZXMhKQogICAgdmFyIGEwMCA9IGxvY2FsVHJhbnNmb3JtWzBdLCBhMDEgPSBsb2NhbFRyYW5zZm9ybVsxXSwgYTAyID0gdGhpcy5wb3NpdGlvbi54IC0gbG9jYWxUcmFuc2Zvcm1bMF0gKiBweCAtIHB5ICogbG9jYWxUcmFuc2Zvcm1bMV0sCiAgICAgICAgYTEwID0gbG9jYWxUcmFuc2Zvcm1bM10sIGExMSA9IGxvY2FsVHJhbnNmb3JtWzRdLCBhMTIgPSB0aGlzLnBvc2l0aW9uLnkgLSBsb2NhbFRyYW5zZm9ybVs0XSAqIHB5IC0gcHggKiBsb2NhbFRyYW5zZm9ybVszXSwKCiAgICAgICAgYjAwID0gcGFyZW50VHJhbnNmb3JtWzBdLCBiMDEgPSBwYXJlbnRUcmFuc2Zvcm1bMV0sIGIwMiA9IHBhcmVudFRyYW5zZm9ybVsyXSwKICAgICAgICBiMTAgPSBwYXJlbnRUcmFuc2Zvcm1bM10sIGIxMSA9IHBhcmVudFRyYW5zZm9ybVs0XSwgYjEyID0gcGFyZW50VHJhbnNmb3JtWzVdOwoKCWxvY2FsVHJhbnNmb3JtWzJdID0gYTAyCglsb2NhbFRyYW5zZm9ybVs1XSA9IGExMgoJCiAgICB3b3JsZFRyYW5zZm9ybVswXSA9IGIwMCAqIGEwMCArIGIwMSAqIGExMDsKICAgIHdvcmxkVHJhbnNmb3JtWzFdID0gYjAwICogYTAxICsgYjAxICogYTExOwogICAgd29ybGRUcmFuc2Zvcm1bMl0gPSBiMDAgKiBhMDIgKyBiMDEgKiBhMTIgKyBiMDI7CgogICAgd29ybGRUcmFuc2Zvcm1bM10gPSBiMTAgKiBhMDAgKyBiMTEgKiBhMTA7CiAgICB3b3JsZFRyYW5zZm9ybVs0XSA9IGIxMCAqIGEwMSArIGIxMSAqIGExMTsKICAgIHdvcmxkVHJhbnNmb3JtWzVdID0gYjEwICogYTAyICsgYjExICogYTEyICsgYjEyOwoKCS8vIGJlY2F1c2Ugd2UgYXJlIHVzaW5nIGFmZmluZSB0cmFuc2Zvcm1hdGlvbiwgd2UgY2FuIG9wdGltaXNlIHRoZSBtYXRyaXggY29uY2F0ZW5hdGlvbiBwcm9jZXNzLi4gd29vbyEKCS8vIG1hdDMubXVsdGlwbHkodGhpcy5sb2NhbFRyYW5zZm9ybSwgdGhpcy5wYXJlbnQud29ybGRUcmFuc2Zvcm0sIHRoaXMud29ybGRUcmFuc2Zvcm0pOwoJdGhpcy53b3JsZEFscGhhID0gdGhpcy5hbHBoYSAqIHRoaXMucGFyZW50LndvcmxkQWxwaGE7CgkKCXRoaXMudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7Cgp9CgpQSVhJLnZpc2libGVDb3VudCA9IDA7Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIEEgRGlzcGxheU9iamVjdENvbnRhaW5lciByZXByZXNlbnRzIGEgY29sbGVjdGlvbiBvZiBkaXNwbGF5IG9iamVjdHMuCiAqIEl0IGlzIHRoZSBiYXNlIGNsYXNzIG9mIGFsbCBkaXNwbGF5IG9iamVjdHMgdGhhdCBhY3QgYXMgYSBjb250YWluZXIgZm9yIG90aGVyIG9iamVjdHMuCiAqCiAqIEBjbGFzcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIAogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0CiAqIEBjb25zdHJ1Y3RvcgogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkRpc3BsYXlPYmplY3QuY2FsbCggdGhpcyApOwoJCgkvKioKCSAqIFtyZWFkLW9ubHldIFRoZSBvZiBjaGlsZHJlbiBvZiB0aGlzIGNvbnRhaW5lci4KCSAqCgkgKiBAcHJvcGVydHkgY2hpbGRyZW4KCSAqIEB0eXBlIEFycmF5PERpc3BsYXlPYmplY3Q+CgkgKiBAcmVhZE9ubHkKCSAqLwkKCXRoaXMuY2hpbGRyZW4gPSBbXTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUgKTsKUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lcjsKCi8qKgogKiBBZGRzIGEgY2hpbGQgdG8gdGhlIGNvbnRhaW5lci4KICoKICogQG1ldGhvZCBhZGRDaGlsZAogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9IFRoZSBEaXNwbGF5T2JqZWN0IHRvIGFkZCB0byB0aGUgY29udGFpbmVyCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmFkZENoaWxkID0gZnVuY3Rpb24oY2hpbGQpCnsKCWlmKGNoaWxkLnBhcmVudCAhPSB1bmRlZmluZWQpCgl7CgkJCgkJLy8vLyBDT1VMRCBCRSBUSElTPz8/CgkJY2hpbGQucGFyZW50LnJlbW92ZUNoaWxkKGNoaWxkKTsKCS8vCXJldHVybjsKCX0KCgljaGlsZC5wYXJlbnQgPSB0aGlzOwoJCgl0aGlzLmNoaWxkcmVuLnB1c2goY2hpbGQpOwkKCQoJLy8gdXBkYXRlIHRoZSBzdGFnZSByZWZmZXJlbmNlLi4KCQoJaWYodGhpcy5zdGFnZSkKCXsKCQl2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKCQlkbwoJCXsKCQkJaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CgkJCXRtcENoaWxkLnN0YWdlID0gdGhpcy5zdGFnZTsKCQkJdG1wQ2hpbGQgPSB0bXBDaGlsZC5faU5leHQ7CgkJfQkKCQl3aGlsZSh0bXBDaGlsZCkKCX0KCQoJLy8gTElOS0VEIExJU1QgLy8KCQoJLy8gbW9kaWZ5IHRoZSBsaXN0Li4KCXZhciBjaGlsZEZpcnN0ID0gY2hpbGQuZmlyc3QKCXZhciBjaGlsZExhc3QgPSBjaGlsZC5sYXN0OwoJdmFyIG5leHRPYmplY3Q7Cgl2YXIgcHJldmlvdXNPYmplY3Q7CgkKCS8vIHRoaXMgY291bGQgYmUgd3JvbmcgaWYgdGhlcmUgaXMgYSBmaWx0ZXI/PwoJaWYodGhpcy5fZmlsdGVycyB8fCB0aGlzLl9tYXNrKQoJewoJCXByZXZpb3VzT2JqZWN0ID0gIHRoaXMubGFzdC5faVByZXY7Cgl9CgllbHNlCgl7CgkJcHJldmlvdXNPYmplY3QgPSB0aGlzLmxhc3Q7Cgl9CgoJbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKCQoJLy8gYWx3YXlzIHRydWUgaW4gdGhpcyBjYXNlCgkvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCgl2YXIgdXBkYXRlTGFzdCA9IHRoaXM7Cgl2YXIgcHJldkxhc3QgPSBwcmV2aW91c09iamVjdDsKCQoJd2hpbGUodXBkYXRlTGFzdCkKCXsKCQlpZih1cGRhdGVMYXN0Lmxhc3QgPT0gcHJldkxhc3QpCgkJewoJCQl1cGRhdGVMYXN0Lmxhc3QgPSBjaGlsZC5sYXN0OwoJCX0KCQl1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7Cgl9CgkKCWlmKG5leHRPYmplY3QpCgl7CgkJbmV4dE9iamVjdC5faVByZXYgPSBjaGlsZExhc3Q7CgkJY2hpbGRMYXN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7Cgl9CgkKCWNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CglwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwkJCgoJLy8gbmVlZCB0byByZW1vdmUgYW55IHJlbmRlciBncm91cHMuLgoJaWYodGhpcy5fX3JlbmRlckdyb3VwKQoJewoJCS8vIGJlaW5nIHVzZWQgYnkgYSByZW5kZXJUZXh0dXJlLi4gaWYgaXQgZXhpc3RzIHRoZW4gaXQgbXVzdCBiZSBmcm9tIGEgcmVuZGVyIHRleHR1cmU7CgkJaWYoY2hpbGQuX19yZW5kZXJHcm91cCljaGlsZC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CgkJLy8gYWRkIHRoZW0gdG8gdGhlIG5ldyByZW5kZXIgZ3JvdXAuLgoJCXRoaXMuX19yZW5kZXJHcm91cC5hZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwoJfQoJCn0KCi8qKgogKiBBZGRzIGEgY2hpbGQgdG8gdGhlIGNvbnRhaW5lciBhdCBhIHNwZWNpZmllZCBpbmRleC4gSWYgdGhlIGluZGV4IGlzIG91dCBvZiBib3VuZHMgYW4gZXJyb3Igd2lsbCBiZSB0aHJvd24KICoKICogQG1ldGhvZCBhZGRDaGlsZEF0CiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0gVGhlIGNoaWxkIHRvIGFkZAogKiBAcGFyYW0gaW5kZXgge051bWJlcn0gVGhlIGluZGV4IHRvIHBsYWNlIHRoZSBjaGlsZCBpbgogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5hZGRDaGlsZEF0ID0gZnVuY3Rpb24oY2hpbGQsIGluZGV4KQp7CglpZihpbmRleCA+PSAwICYmIGluZGV4IDw9IHRoaXMuY2hpbGRyZW4ubGVuZ3RoKQoJewoJCWlmKGNoaWxkLnBhcmVudCAhPSB1bmRlZmluZWQpCgkJewoJCQljaGlsZC5wYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpOwoJCX0KCQljaGlsZC5wYXJlbnQgPSB0aGlzOwoJCQoJCWlmKHRoaXMuc3RhZ2UpCgkJewoJCQl2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKCQkJZG8KCQkJewoJCQkJaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CgkJCQl0bXBDaGlsZC5zdGFnZSA9IHRoaXMuc3RhZ2U7CgkJCQl0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKCQkJfQoJCQl3aGlsZSh0bXBDaGlsZCkKCQl9CgkJCgkJLy8gbW9kaWZ5IHRoZSBsaXN0Li4KCQl2YXIgY2hpbGRGaXJzdCA9IGNoaWxkLmZpcnN0OwoJCXZhciBjaGlsZExhc3QgPSBjaGlsZC5sYXN0OwoJCXZhciBuZXh0T2JqZWN0OwoJCXZhciBwcmV2aW91c09iamVjdDsKCQkKCQlpZihpbmRleCA9PSB0aGlzLmNoaWxkcmVuLmxlbmd0aCkKCQl7CgkJCXByZXZpb3VzT2JqZWN0ID0gIHRoaXMubGFzdDsKCQkJdmFyIHVwZGF0ZUxhc3QgPSB0aGlzOwoJCQl2YXIgcHJldkxhc3QgPSB0aGlzLmxhc3Q7CgkJCXdoaWxlKHVwZGF0ZUxhc3QpCgkJCXsKCQkJCWlmKHVwZGF0ZUxhc3QubGFzdCA9PSBwcmV2TGFzdCkKCQkJCXsKCQkJCQl1cGRhdGVMYXN0Lmxhc3QgPSBjaGlsZC5sYXN0OwoJCQkJfQoJCQkJdXBkYXRlTGFzdCA9IHVwZGF0ZUxhc3QucGFyZW50OwoJCQl9CgkJfQoJCWVsc2UgaWYoaW5kZXggPT0gMCkKCQl7CgkJCXByZXZpb3VzT2JqZWN0ID0gdGhpczsKCQl9CgkJZWxzZQoJCXsKCQkJcHJldmlvdXNPYmplY3QgPSB0aGlzLmNoaWxkcmVuW2luZGV4LTFdLmxhc3Q7CgkJfQoJCQoJCW5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CgkJCgkJLy8gYWx3YXlzIHRydWUgaW4gdGhpcyBjYXNlCgkJaWYobmV4dE9iamVjdCkKCQl7CgkJCW5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwoJCQljaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKCQl9CgkJCgkJY2hpbGRGaXJzdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKCQlwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwkJCgoJCXRoaXMuY2hpbGRyZW4uc3BsaWNlKGluZGV4LCAwLCBjaGlsZCk7CgkJLy8gbmVlZCB0byByZW1vdmUgYW55IHJlbmRlciBncm91cHMuLgoJCWlmKHRoaXMuX19yZW5kZXJHcm91cCkKCQl7CgkJCS8vIGJlaW5nIHVzZWQgYnkgYSByZW5kZXJUZXh0dXJlLi4gaWYgaXQgZXhpc3RzIHRoZW4gaXQgbXVzdCBiZSBmcm9tIGEgcmVuZGVyIHRleHR1cmU7CgkJCWlmKGNoaWxkLl9fcmVuZGVyR3JvdXApY2hpbGQuX19yZW5kZXJHcm91cC5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwoJCQkvLyBhZGQgdGhlbSB0byB0aGUgbmV3IHJlbmRlciBncm91cC4uCgkJCXRoaXMuX19yZW5kZXJHcm91cC5hZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwoJCX0KCQkKCX0KCWVsc2UKCXsKCQl0aHJvdyBuZXcgRXJyb3IoY2hpbGQgKyAiIFRoZSBpbmRleCAiKyBpbmRleCArIiBzdXBwbGllZCBpcyBvdXQgb2YgYm91bmRzICIgKyB0aGlzLmNoaWxkcmVuLmxlbmd0aCk7Cgl9Cn0KCi8qKgogKiBbTllJXSBTd2FwcyB0aGUgZGVwdGggb2YgMiBkaXNwbGF5T2JqZWN0cwogKgogKiBAbWV0aG9kIHN3YXBDaGlsZHJlbgogKiBAcGFyYW0gY2hpbGQge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBjaGlsZDIge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnN3YXBDaGlsZHJlbiA9IGZ1bmN0aW9uKGNoaWxkLCBjaGlsZDIpCnsKCS8qCgkgKiB0aGlzIGZ1bnRpb24gbmVlZHMgdG8gYmUgcmVjb2RlZC4uIAoJICogY2FuIGJlIGRvbmUgYSBsb3QgZmFzdGVyLi4KCSAqLwoJcmV0dXJuOwoJCgkvLyBuZWVkIHRvIGZpeCB0aGlzIGZ1bmN0aW9uIDovCgkvKgoJLy8gVE9ETyBJIGFscmVhZHkga25vdyB0aGlzPz8KCXZhciBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZiggY2hpbGQgKTsKCXZhciBpbmRleDIgPSB0aGlzLmNoaWxkcmVuLmluZGV4T2YoIGNoaWxkMiApOwoJCglpZiAoIGluZGV4ICE9PSAtMSAmJiBpbmRleDIgIT09IC0xICkgCgl7CgkJLy8gY29vbAoJCQoJCS8qCgkJaWYodGhpcy5zdGFnZSkKCQl7CgkJCS8vIHRoaXMgaXMgdG8gc2F0aXNmeSB0aGUgd2ViR0wgYmF0Y2hpbmcuLgoJCQkvLyBUT0RPIHN1cmUgdGhlcmUgaXMgYSBuaWNlciB3YXkgdG8gYWNoaWV2ZSB0aGlzIQoJCQl0aGlzLnN0YWdlLl9fcmVtb3ZlQ2hpbGQoY2hpbGQpOwoJCQl0aGlzLnN0YWdlLl9fcmVtb3ZlQ2hpbGQoY2hpbGQyKTsKCQkJCgkJCXRoaXMuc3RhZ2UuX19hZGRDaGlsZChjaGlsZCk7CgkJCXRoaXMuc3RhZ2UuX19hZGRDaGlsZChjaGlsZDIpOwoJCX0KCQkKCQkvLyBzd2FwIHRoZSBwb3NpdGlvbnMuLgoJCXRoaXMuY2hpbGRyZW5baW5kZXhdID0gY2hpbGQyOwoJCXRoaXMuY2hpbGRyZW5baW5kZXgyXSA9IGNoaWxkOwoJCQoJfQoJZWxzZQoJewoJCXRocm93IG5ldyBFcnJvcihjaGlsZCArICIgQm90aCB0aGUgc3VwcGxpZWQgRGlzcGxheU9iamVjdHMgbXVzdCBiZSBhIGNoaWxkIG9mIHRoZSBjYWxsZXIgIiArIHRoaXMpOwoJfSovCn0KCi8qKgogKiBSZXR1cm5zIHRoZSBDaGlsZCBhdCB0aGUgc3BlY2lmaWVkIGluZGV4CiAqCiAqIEBtZXRob2QgZ2V0Q2hpbGRBdAogKiBAcGFyYW0gaW5kZXgge051bWJlcn0gVGhlIGluZGV4IHRvIGdldCB0aGUgY2hpbGQgZnJvbQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS5nZXRDaGlsZEF0ID0gZnVuY3Rpb24oaW5kZXgpCnsKCWlmKGluZGV4ID49IDAgJiYgaW5kZXggPCB0aGlzLmNoaWxkcmVuLmxlbmd0aCkKCXsKCQlyZXR1cm4gdGhpcy5jaGlsZHJlbltpbmRleF07Cgl9CgllbHNlCgl7CgkJdGhyb3cgbmV3IEVycm9yKGNoaWxkICsgIiBCb3RoIHRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0cyBtdXN0IGJlIGEgY2hpbGQgb2YgdGhlIGNhbGxlciAiICsgdGhpcyk7Cgl9Cn0KCi8qKgogKiBSZW1vdmVzIGEgY2hpbGQgZnJvbSB0aGUgY29udGFpbmVyLgogKgogKiBAbWV0aG9kIHJlbW92ZUNoaWxkCiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0gVGhlIERpc3BsYXlPYmplY3QgdG8gcmVtb3ZlCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnJlbW92ZUNoaWxkID0gZnVuY3Rpb24oY2hpbGQpCnsKCXZhciBpbmRleCA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZiggY2hpbGQgKTsKCWlmICggaW5kZXggIT09IC0xICkgCgl7CgkJLy8gdW5saW5rIC8vCgkJLy8gbW9kaWZ5IHRoZSBsaXN0Li4KCQl2YXIgY2hpbGRGaXJzdCA9IGNoaWxkLmZpcnN0OwoJCXZhciBjaGlsZExhc3QgPSBjaGlsZC5sYXN0OwoJCQoJCXZhciBuZXh0T2JqZWN0ID0gY2hpbGRMYXN0Ll9pTmV4dDsKCQl2YXIgcHJldmlvdXNPYmplY3QgPSBjaGlsZEZpcnN0Ll9pUHJldjsKCQkJCgkJaWYobmV4dE9iamVjdCluZXh0T2JqZWN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwoJCXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CQkKCQkKCQlpZih0aGlzLmxhc3QgPT0gY2hpbGRMYXN0KQoJCXsKCQkJdmFyIHRlbXBMYXN0ID0gIGNoaWxkRmlyc3QuX2lQcmV2OwkKCQkJLy8gbmVlZCB0byBtYWtlIHN1cmUgdGhlIHBhcmVudHMgbGFzdCBpcyB1cGRhdGVkIHRvbwoJCQl2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CgkJCXdoaWxlKHVwZGF0ZUxhc3QubGFzdCA9PSBjaGlsZExhc3QubGFzdCkKCQkJewoJCQkJdXBkYXRlTGFzdC5sYXN0ID0gdGVtcExhc3Q7CgkJCQl1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CgkJCQlpZighdXBkYXRlTGFzdClicmVhazsKCQkJfQoJCX0KCQkKCQljaGlsZExhc3QuX2lOZXh0ID0gbnVsbDsKCQljaGlsZEZpcnN0Ll9pUHJldiA9IG51bGw7CgkJIAoJCS8vIHVwZGF0ZSB0aGUgc3RhZ2UgcmVmZXJlbmNlLi4KCQlpZih0aGlzLnN0YWdlKQoJCXsKCQkJdmFyIHRtcENoaWxkID0gY2hpbGQ7CgkJCWRvCgkJCXsKCQkJCWlmKHRtcENoaWxkLmludGVyYWN0aXZlKXRoaXMuc3RhZ2UuZGlydHkgPSB0cnVlOwoJCQkJdG1wQ2hpbGQuc3RhZ2UgPSBudWxsOwoJCQkJdG1wQ2hpbGQgPSB0bXBDaGlsZC5faU5leHQ7CgkJCX0JCgkJCXdoaWxlKHRtcENoaWxkKQoJCX0KCQoJCS8vIHdlYkdMIHRyaW0KCQlpZihjaGlsZC5fX3JlbmRlckdyb3VwKQoJCXsKCQkJY2hpbGQuX19yZW5kZXJHcm91cC5yZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4oY2hpbGQpOwoJCX0KCQkKCQljaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CgkJdGhpcy5jaGlsZHJlbi5zcGxpY2UoIGluZGV4LCAxICk7Cgl9CgllbHNlCgl7CgkJdGhyb3cgbmV3IEVycm9yKGNoaWxkICsgIiBUaGUgc3VwcGxpZWQgRGlzcGxheU9iamVjdCBtdXN0IGJlIGEgY2hpbGQgb2YgdGhlIGNhbGxlciAiICsgdGhpcyk7Cgl9Cn0KCi8qCiAqIFVwZGF0ZXMgdGhlIGNvbnRhaW5lcidzIGNoaWxkcmVuJ3MgdHJhbnNmb3JtIGZvciByZW5kZXJpbmcKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CglpZighdGhpcy52aXNpYmxlKXJldHVybjsKCQoJUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0uY2FsbCggdGhpcyApOwoJCglmb3IodmFyIGk9MCxqPXRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKCXsKCQl0aGlzLmNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KfQovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5ibGVuZE1vZGVzID0ge307ClBJWEkuYmxlbmRNb2Rlcy5OT1JNQUwgPSAwOwpQSVhJLmJsZW5kTW9kZXMuU0NSRUVOID0gMTsKCgovKioKICogVGhlIFNQcml0ZSBvYmplY3QgaXMgdGhlIGJhc2UgZm9yIGFsbCB0ZXh0dXJlZCBvYmplY3RzIHRoYXQgYXJlIHJlbmRlcmVkIHRvIHRoZSBzY3JlZW4KICoKICogQGNsYXNzIFNwcml0ZQogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIHRleHR1cmUgZm9yIHRoaXMgc3ByaXRlCiAqIEB0eXBlIFN0cmluZwogKi8KUElYSS5TcHJpdGUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKCS8qKgoJICogVGhlIGFuY2hvciBzZXRzIHRoZSBvcmlnaW4gcG9pbnQgb2YgdGhlIHRleHR1cmUuCgkgKiBUaGUgZGVmYXVsdCBpcyAwLDAgdGhpcyBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIHRoZSB0b3AgbGVmdCAKCSAqIFNldHRpbmcgdGhhbiBhbmNob3IgdG8gMC41LDAuNSBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIGNlbnRlcmVkCgkgKiBTZXR0aW5nIHRoZSBhbmNob3IgdG8gMSwxIHdvdWxkIG1lYW4gdGhlIHRleHR1cmVzIG9yaWdpbiBwb2ludHMgd2lsbCBiZSB0aGUgYm90dG9tIHJpZ2h0CgkgKgogICAgICogQHByb3BlcnR5IGFuY2hvcgogICAgICogQHR5cGUgUG9pbnQKICAgICAqLwoJdGhpcy5hbmNob3IgPSBuZXcgUElYSS5Qb2ludCgpOwoKCS8qKgoJICogVGhlIHRleHR1cmUgdGhhdCB0aGUgc3ByaXRlIGlzIHVzaW5nCgkgKgoJICogQHByb3BlcnR5IHRleHR1cmUKCSAqIEB0eXBlIFRleHR1cmUKCSAqLwoJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCgkvKioKCSAqIFRoZSBibGVuZCBtb2RlIG9mIHNwcml0ZS4KCSAqIGN1cnJlbnRseSBzdXBwb3J0cyBQSVhJLmJsZW5kTW9kZXMuTk9STUFMIGFuZCBQSVhJLmJsZW5kTW9kZXMuU0NSRUVOCgkgKgoJICogQHByb3BlcnR5IGJsZW5kTW9kZQoJICogQHR5cGUgTnVtYmVyCgkgKi8KCXRoaXMuYmxlbmRNb2RlID0gUElYSS5ibGVuZE1vZGVzLk5PUk1BTDsKCgkvKioKCSAqIFRoZSB3aWR0aCBvZiB0aGUgc3ByaXRlICh0aGlzIGlzIGluaXRpYWxseSBzZXQgYnkgdGhlIHRleHR1cmUpCgkgKgoJICogQHByb3BlcnR5IF93aWR0aAoJICogQHR5cGUgTnVtYmVyCgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLl93aWR0aCA9IDA7CgoJLyoqCgkgKiBUaGUgaGVpZ2h0IG9mIHRoZSBzcHJpdGUgKHRoaXMgaXMgaW5pdGlhbGx5IHNldCBieSB0aGUgdGV4dHVyZSkKCSAqCgkgKiBAcHJvcGVydHkgX2hlaWdodAoJICogQHR5cGUgTnVtYmVyCgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLl9oZWlnaHQgPSAwOwoKCWlmKHRleHR1cmUuYmFzZVRleHR1cmUuaGFzTG9hZGVkKQoJewoJCXRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwoJfQoJZWxzZQoJewoJCXRoaXMub25UZXh0dXJlVXBkYXRlQmluZCA9IHRoaXMub25UZXh0dXJlVXBkYXRlLmJpbmQodGhpcyk7CgkJdGhpcy50ZXh0dXJlLmFkZEV2ZW50TGlzdGVuZXIoICd1cGRhdGUnLCB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgKTsKCX0KCgl0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlNwcml0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuU3ByaXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuU3ByaXRlOwoKLyoqCiAqIFRoZSB3aWR0aCBvZiB0aGUgc3ByaXRlLCBzZXR0aW5nIHRoaXMgd2lsbCBhY3R1YWxseSBtb2RpZnkgdGhlIHNjYWxlIHRvIGFjaGVpdmUgdGhlIHZhbHVlIHNldAogKgogKiBAcHJvcGVydHkgd2lkdGgKICogQHR5cGUgTnVtYmVyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5TcHJpdGUucHJvdG90eXBlLCAnd2lkdGgnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjYWxlLnggKiB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGg7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuc2NhbGUueCA9IHZhbHVlIC8gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoCiAgICAgICAgdGhpcy5fd2lkdGggPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogVGhlIGhlaWdodCBvZiB0aGUgc3ByaXRlLCBzZXR0aW5nIHRoaXMgd2lsbCBhY3R1YWxseSBtb2RpZnkgdGhlIHNjYWxlIHRvIGFjaGVpdmUgdGhlIHZhbHVlIHNldAogKgogKiBAcHJvcGVydHkgaGVpZ2h0CiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuU3ByaXRlLnByb3RvdHlwZSwgJ2hlaWdodCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICB0aGlzLnNjYWxlLnkgKiB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0OwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLnNjYWxlLnkgPSB2YWx1ZSAvIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQKICAgICAgICB0aGlzLl9oZWlnaHQgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogU2V0cyB0aGUgdGV4dHVyZSBvZiB0aGUgc3ByaXRlCiAqCiAqIEBtZXRob2Qgc2V0VGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIFBJWEkgdGV4dHVyZSB0aGF0IGlzIGRpc3BsYXllZCBieSB0aGUgc3ByaXRlCiAqLwpQSVhJLlNwcml0ZS5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKCS8vIHN0b3AgY3VycmVudCB0ZXh0dXJlOwoJaWYodGhpcy50ZXh0dXJlLmJhc2VUZXh0dXJlICE9IHRleHR1cmUuYmFzZVRleHR1cmUpCgl7CgkJdGhpcy50ZXh0dXJlQ2hhbmdlID0gdHJ1ZTsJCgkJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCQkKCQlpZih0aGlzLl9fcmVuZGVyR3JvdXApCgkJewoJCQl0aGlzLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZSh0aGlzKTsKCQl9Cgl9CgllbHNlCgl7CgkJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCX0KCQoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KCi8qKgogKiBXaGVuIHRoZSB0ZXh0dXJlIGlzIHVwZGF0ZWQsIHRoaXMgZXZlbnQgd2lsbCBmaXJlIHRvIHVwZGF0ZSB0aGUgc2NhbGUgYW5kIGZyYW1lCiAqCiAqIEBtZXRob2Qgb25UZXh0dXJlVXBkYXRlCiAqIEBwYXJhbSBldmVudAogKiBAcHJpdmF0ZQogKi8KUElYSS5TcHJpdGUucHJvdG90eXBlLm9uVGV4dHVyZVVwZGF0ZSA9IGZ1bmN0aW9uKGV2ZW50KQp7CgkvL3RoaXMudGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAndXBkYXRlJywgdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kICk7CgkKCS8vIHNvIGlmIF93aWR0aCBpcyAwIHRoZW4gd2lkdGggd2FzIG5vdCBzZXQuLgoJaWYodGhpcy5fd2lkdGgpdGhpcy5zY2FsZS54ID0gdGhpcy5fd2lkdGggLyB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGg7CglpZih0aGlzLl9oZWlnaHQpdGhpcy5zY2FsZS55ID0gdGhpcy5faGVpZ2h0IC8gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCQoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KCi8vIHNvbWUgaGVscGVyIGZ1bmN0aW9ucy4uCgovKioKICogCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IGNyZWF0ZXMgYSBzcHJpdGUgdGhhdCB3aWxsIGNvbnRhaW4gYSB0ZXh0dXJlIGZyb20gdGhlIFRleHR1cmVDYWNoZSBiYXNlZCBvbiB0aGUgZnJhbWVJZAogKiBUaGUgZnJhbWUgaWRzIGFyZSBjcmVhdGVkIHdoZW4gYSBUZXh0dXJlIHBhY2tlciBmaWxlIGhhcyBiZWVuIGxvYWRlZAogKgogKiBAbWV0aG9kIGZyb21GcmFtZQogKiBAc3RhdGljCiAqIEBwYXJhbSBmcmFtZUlkIHtTdHJpbmd9IFRoZSBmcmFtZSBJZCBvZiB0aGUgdGV4dHVyZSBpbiB0aGUgY2FjaGUKICogQHJldHVybiB7U3ByaXRlfSBBIG5ldyBTcHJpdGUgdXNpbmcgYSB0ZXh0dXJlIGZyb20gdGhlIHRleHR1cmUgY2FjaGUgbWF0Y2hpbmcgdGhlIGZyYW1lSWQKICovClBJWEkuU3ByaXRlLmZyb21GcmFtZSA9IGZ1bmN0aW9uKGZyYW1lSWQpCnsKCXZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbZnJhbWVJZF07CglpZighdGV4dHVyZSl0aHJvdyBuZXcgRXJyb3IoIlRoZSBmcmFtZUlkICciKyBmcmFtZUlkICsiJyBkb2VzIG5vdCBleGlzdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSIgKyB0aGlzKTsKCXJldHVybiBuZXcgUElYSS5TcHJpdGUodGV4dHVyZSk7Cn0KCi8qKgogKiAKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIHNwcml0ZSB0aGF0IHdpbGwgY29udGFpbiBhIHRleHR1cmUgYmFzZWQgb24gYW4gaW1hZ2UgdXJsCiAqIElmIHRoZSBpbWFnZSBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSBsb2FkZWQKICoKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHN0YXRpYwogKiBAcGFyYW0gaW1hZ2VJZCB7U3RyaW5nfSBUaGUgaW1hZ2UgdXJsIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4ge1Nwcml0ZX0gQSBuZXcgU3ByaXRlIHVzaW5nIGEgdGV4dHVyZSBmcm9tIHRoZSB0ZXh0dXJlIGNhY2hlIG1hdGNoaW5nIHRoZSBpbWFnZSBpZAogKi8KUElYSS5TcHJpdGUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VJZCkKewoJdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmUuZnJvbUltYWdlKGltYWdlSWQpOwoJcmV0dXJuIG5ldyBQSVhJLlNwcml0ZSh0ZXh0dXJlKTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIFN0YWdlIHJlcHJlc2VudHMgdGhlIHJvb3Qgb2YgdGhlIGRpc3BsYXkgdHJlZS4gRXZlcnl0aGluZyBjb25uZWN0ZWQgdG8gdGhlIHN0YWdlIGlzIHJlbmRlcmVkCiAqCiAqIEBjbGFzcyBTdGFnZQogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gYmFja2dyb3VuZENvbG9yIHtOdW1iZXJ9IHRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZSwgZWFzaWVzdCB3YXkgdG8gcGFzcyB0aGlzIGluIGlzIGluIGhleCBmb3JtYXQKICoJCWxpa2U6IDB4RkZGRkZGIGZvciB3aGl0ZQogKi8KUElYSS5TdGFnZSA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikKewoJUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIEN1cnJlbnQgdHJhbnNmb3JtIG9mIHRoZSBvYmplY3QgYmFzZWQgb24gd29ybGQgKHBhcmVudCkgZmFjdG9ycwoJICoKCSAqIEBwcm9wZXJ0eSB3b3JsZFRyYW5zZm9ybQoJICogQHR5cGUgTWF0MwoJICogQHJlYWRPbmx5CgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOwoKCS8qKgoJICogV2hldGhlciBvciBub3QgdGhlIHN0YWdlIGlzIGludGVyYWN0aXZlCgkgKgoJICogQHByb3BlcnR5IGludGVyYWN0aXZlCgkgKiBAdHlwZSBCb29sZWFuCgkgKi8KCXRoaXMuaW50ZXJhY3RpdmUgPSB0cnVlOwoKCS8qKgoJICogVGhlIGludGVyYWN0aW9uIG1hbmFnZSBmb3IgdGhpcyBzdGFnZSwgbWFuYWdlcyBhbGwgaW50ZXJhY3RpdmUgYWN0aXZpdHkgb24gdGhlIHN0YWdlCgkgKgoJICogQHByb3BlcnR5IGludGVyYWN0aXZlCgkgKiBAdHlwZSBJbnRlcmFjdGlvbk1hbmFnZXIKCSAqLwoJdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIgPSBuZXcgUElYSS5JbnRlcmFjdGlvbk1hbmFnZXIodGhpcyk7CgoJLyoqCgkgKiBXaGV0aGVyIHRoZSBzdGFnZSBpcyBkaXJ0eSBhbmQgbmVlZHMgdG8gaGF2ZSBpbnRlcmFjdGlvbnMgdXBkYXRlZAoJICoKCSAqIEBwcm9wZXJ0eSBkaXJ0eQoJICogQHR5cGUgQm9vbGVhbgoJICogQHByaXZhdGUKCSAqLwoJdGhpcy5kaXJ0eSA9IHRydWU7CgoJdGhpcy5fX2NoaWxkcmVuQWRkZWQgPSBbXTsKCXRoaXMuX19jaGlsZHJlblJlbW92ZWQgPSBbXTsKCgkvL3RoZSBzdGFnZSBpcyBpdCdzIG93biBzdGFnZQoJdGhpcy5zdGFnZSA9IHRoaXM7CgoJLy9vcHRpbWl6ZSBoaXQgZGV0ZWN0aW9uIGEgYml0Cgl0aGlzLnN0YWdlLmhpdEFyZWEgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLDEwMDAwMCwgMTAwMDAwKTsKCgl0aGlzLnNldEJhY2tncm91bmRDb2xvcihiYWNrZ3JvdW5kQ29sb3IpOwoJdGhpcy53b3JsZFZpc2libGUgPSB0cnVlOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlN0YWdlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5TdGFnZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlN0YWdlOwoKLyoqCiAqIFNldHMgYW5vdGhlciBET00gZWxlbWVudCB3aGljaCBjYW4gcmVjZWl2ZSBtb3VzZS90b3VjaCBpbnRlcmFjdGlvbnMgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBDYW52YXMgZWxlbWVudC4KICogVGhpcyBpcyB1c2VmdWwgZm9yIHdoZW4geW91IGhhdmUgb3RoZXIgRE9NIGVsZW1lbnRzIG9udG9wIG9mIHRoZSBDYW52YXMgZWxlbWVudC4KICoKICogQG1ldGhvZCBzZXRJbnRlcmFjdGlvbkRlbGVnYXRlCiAqIEBwYXJhbSBkb21FbGVtZW50IHtET01FbGVtZW50fSBUaGlzIG5ldyBkb21FbGVtZW50IHdoaWNoIHdpbGwgcmVjZWl2ZSBtb3VzZS90b3VjaCBldmVudHMKICovClBJWEkuU3RhZ2UucHJvdG90eXBlLnNldEludGVyYWN0aW9uRGVsZWdhdGUgPSBmdW5jdGlvbihkb21FbGVtZW50KQp7Cgl0aGlzLmludGVyYWN0aW9uTWFuYWdlci5zZXRUYXJnZXREb21FbGVtZW50KCBkb21FbGVtZW50ICk7Cn0KCi8qCiAqIFVwZGF0ZXMgdGhlIG9iamVjdCB0cmFuc2Zvcm0gZm9yIHJlbmRlcmluZwogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5TdGFnZS5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7Cgl0aGlzLndvcmxkQWxwaGEgPSAxOwkJCgl0aGlzLnZjb3VudCA9IFBJWEkudmlzaWJsZUNvdW50OwoJCglmb3IodmFyIGk9MCxqPXRoaXMuY2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKCXsKCQl0aGlzLmNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KCQoJaWYodGhpcy5kaXJ0eSkKCXsKCQl0aGlzLmRpcnR5ID0gZmFsc2U7CgkJLy8gdXBkYXRlIGludGVyYWN0aXZlIQoJCXRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLmRpcnR5ID0gdHJ1ZTsKCX0KCQoJCglpZih0aGlzLmludGVyYWN0aXZlKXRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLnVwZGF0ZSgpOwp9CgovKioKICogU2V0cyB0aGUgYmFja2dyb3VuZCBjb2xvciBmb3IgdGhlIHN0YWdlCiAqCiAqIEBtZXRob2Qgc2V0QmFja2dyb3VuZENvbG9yCiAqIEBwYXJhbSBiYWNrZ3JvdW5kQ29sb3Ige051bWJlcn0gdGhlIGNvbG9yIG9mIHRoZSBiYWNrZ3JvdW5kLCBlYXNpZXN0IHdheSB0byBwYXNzIHRoaXMgaW4gaXMgaW4gaGV4IGZvcm1hdAogKgkJbGlrZTogMHhGRkZGRkYgZm9yIHdoaXRlCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS5zZXRCYWNrZ3JvdW5kQ29sb3IgPSBmdW5jdGlvbihiYWNrZ3JvdW5kQ29sb3IpCnsKCXRoaXMuYmFja2dyb3VuZENvbG9yID0gYmFja2dyb3VuZENvbG9yIHx8IDB4MDAwMDAwOwoJdGhpcy5iYWNrZ3JvdW5kQ29sb3JTcGxpdCA9IEhFWHRvUkdCKHRoaXMuYmFja2dyb3VuZENvbG9yKTsKCXZhciBoZXggPSB0aGlzLmJhY2tncm91bmRDb2xvci50b1N0cmluZygxNik7CgloZXggPSAiMDAwMDAwIi5zdWJzdHIoMCwgNiAtIGhleC5sZW5ndGgpICsgaGV4OwoJdGhpcy5iYWNrZ3JvdW5kQ29sb3JTdHJpbmcgPSAiIyIgKyBoZXg7Cn0KCi8qKgogKiBUaGlzIHdpbGwgcmV0dXJuIHRoZSBwb2ludCBjb250YWluaW5nIGdsb2JhbCBjb29yZHMgb2YgdGhlIG1vdXNlLgogKgogKiBAbWV0aG9kIGdldE1vdXNlUG9zaXRpb24KICogQHJldHVybiB7UG9pbnR9IFRoZSBwb2ludCBjb250YWluaW5nIHRoZSBjb29yZHMgb2YgdGhlIGdsb2JhbCBJbnRlcmFjdGlvbkRhdGEgcG9zaXRpb24uCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS5nZXRNb3VzZVBvc2l0aW9uID0gZnVuY3Rpb24oKQp7CglyZXR1cm4gdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIubW91c2UuZ2xvYmFsOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBUaGlzIG9iamVjdCBpcyBvbmUgdGhhdCB3aWxsIGFsbG93IHlvdSB0byBzcGVjaWZ5IGN1c3RvbSByZW5kZXJpbmcgZnVuY3Rpb25zIGJhc2VkIG9uIHJlbmRlciB0eXBlCiAqCiAqIEBjbGFzcyBDdXN0b21SZW5kZXJhYmxlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3QKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkN1c3RvbVJlbmRlcmFibGUgPSBmdW5jdGlvbigpCnsKCVBJWEkuRGlzcGxheU9iamVjdC5jYWxsKCB0aGlzICk7CgkKCXRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlICk7ClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkN1c3RvbVJlbmRlcmFibGU7CgovKioKICogSWYgdGhpcyBvYmplY3QgaXMgYmVpbmcgcmVuZGVyZWQgYnkgYSBDYW52YXNSZW5kZXJlciBpdCB3aWxsIGNhbGwgdGhpcyBjYWxsYmFjawogKgogKiBAbWV0aG9kIHJlbmRlckNhbnZhcwogKiBAcGFyYW0gcmVuZGVyZXIge0NhbnZhc1JlbmRlcmVyfSBUaGUgcmVuZGVyZXIgaW5zdGFuY2UKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24ocmVuZGVyZXIpCnsKCS8vIG92ZXJyaWRlIQp9CgovKioKICogSWYgdGhpcyBvYmplY3QgaXMgYmVpbmcgcmVuZGVyZWQgYnkgYSBXZWJHTFJlbmRlcmVyIGl0IHdpbGwgY2FsbCB0aGlzIGNhbGxiYWNrIHRvIGluaXRpYWxpemUKICoKICogQG1ldGhvZCBpbml0V2ViR0wKICogQHBhcmFtIHJlbmRlcmVyIHtXZWJHTFJlbmRlcmVyfSBUaGUgcmVuZGVyZXIgaW5zdGFuY2UKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUuaW5pdFdlYkdMID0gZnVuY3Rpb24ocmVuZGVyZXIpCnsKCS8vIG92ZXJyaWRlIQp9CgovKioKICogSWYgdGhpcyBvYmplY3QgaXMgYmVpbmcgcmVuZGVyZWQgYnkgYSBXZWJHTFJlbmRlcmVyIGl0IHdpbGwgY2FsbCB0aGlzIGNhbGxiYWNrCiAqCiAqIEBtZXRob2QgcmVuZGVyV2ViR0wKICogQHBhcmFtIHJlbmRlcmVyIHtXZWJHTFJlbmRlcmVyfSBUaGUgcmVuZGVyZXIgaW5zdGFuY2UKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZS5wcm90b3R5cGUucmVuZGVyV2ViR0wgPSBmdW5jdGlvbihyZW5kZXJHcm91cCwgcHJvamVjdGlvbk1hdHJpeCkKewoJLy8gbm90IHN1cmUgaWYgYm90aCBuZWVkZWQ/IGJ1dCB5YSBoYXZlIGZvciBub3chCgkvLyBvdmVycmlkZSEKfQoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vCiAqLwoKUElYSS5TdHJpcCA9IGZ1bmN0aW9uKHRleHR1cmUsIHdpZHRoLCBoZWlnaHQpCnsKCVBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7Cgl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoJdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwoKCXRyeQoJewoJCXRoaXMudXZzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMSwKCQkJCTEsIDEsCgkJCQkxLCAwLCAwLDFdKTsKCgkJdGhpcy52ZXJ0aWNpZXMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAwLAoJCQkJCQkgIDAsMCwKCQkJCQkJICAwLDAsIDAsCgkJCQkJCSAgMCwgMF0pOwoKCQl0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkoWzEsIDEsIDEsIDFdKTsKCgkJdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KFswLCAxLCAyLCAzXSk7Cgl9CgljYXRjaChlcnJvcikKCXsKCQl0aGlzLnV2cyA9IFswLCAxLAoJCQkJMSwgMSwKCQkJCTEsIDAsIDAsMV07CgoJCXRoaXMudmVydGljaWVzID0gWzAsIDAsCgkJCQkJCSAgMCwwLAoJCQkJCQkgIDAsMCwgMCwKCQkJCQkJICAwLCAwXTsKCgkJdGhpcy5jb2xvcnMgPSBbMSwgMSwgMSwgMV07CgoJCXRoaXMuaW5kaWNlcyA9IFswLCAxLCAyLCAzXTsKCX0KCgoJLyoKCXRoaXMudXZzID0gbmV3IEZsb2F0MzJBcnJheSgpCgl0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkoKQoJdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KCkKCXRoaXMuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSgpCiovCgl0aGlzLndpZHRoID0gd2lkdGg7Cgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkvLyBsb2FkIHRoZSB0ZXh0dXJlIQoJaWYodGV4dHVyZS5iYXNlVGV4dHVyZS5oYXNMb2FkZWQpCgl7CgkJdGhpcy53aWR0aCAgID0gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwoJCXRoaXMuaGVpZ2h0ICA9IHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgkJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cgl9CgllbHNlCgl7CgkJdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kID0gdGhpcy5vblRleHR1cmVVcGRhdGUuYmluZCh0aGlzKTsKCQl0aGlzLnRleHR1cmUuYWRkRXZlbnRMaXN0ZW5lciggJ3VwZGF0ZScsIHRoaXMub25UZXh0dXJlVXBkYXRlQmluZCApOwoJfQoKCXRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuU3RyaXAucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLlN0cmlwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuU3RyaXA7CgpQSVhJLlN0cmlwLnByb3RvdHlwZS5zZXRUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewoJLy9UT0RPIFNFVCBUSEUgVEVYVFVSRVMKCS8vVE9ETyBWSVNJQklMSVRZCgoJLy8gc3RvcCBjdXJyZW50IHRleHR1cmUKCXRoaXMudGV4dHVyZSA9IHRleHR1cmU7Cgl0aGlzLndpZHRoICAgPSB0ZXh0dXJlLmZyYW1lLndpZHRoOwoJdGhpcy5oZWlnaHQgID0gdGV4dHVyZS5mcmFtZS5oZWlnaHQ7Cgl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfQoKUElYSS5TdHJpcC5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oZXZlbnQpCnsKCXRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9Ci8vIHNvbWUgaGVscGVyIGZ1bmN0aW9ucy4uCgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgoKUElYSS5Sb3BlID0gZnVuY3Rpb24odGV4dHVyZSwgcG9pbnRzKQp7CglQSVhJLlN0cmlwLmNhbGwoIHRoaXMsIHRleHR1cmUgKTsKCXRoaXMucG9pbnRzID0gcG9pbnRzOwoKCXRyeQoJewoJCXRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheSggcG9pbnRzLmxlbmd0aCAqIDQpOwoJCXRoaXMudXZzID0gbmV3IEZsb2F0MzJBcnJheSggcG9pbnRzLmxlbmd0aCAqIDQpOwoJCXRoaXMuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheSggIHBvaW50cy5sZW5ndGggKiAyKTsKCQl0aGlzLmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoIHBvaW50cy5sZW5ndGggKiAyKTsKCX0KCWNhdGNoKGVycm9yKQoJewoJCXRoaXMudmVydGljaWVzID0gdmVydGljaWVzCgoJCXRoaXMudXZzID0gdXZzCgkJdGhpcy5jb2xvcnMgPSBjb2xvcnMKCQl0aGlzLmluZGljZXMgPSBpbmRpY2VzCgl9CgoJdGhpcy5yZWZyZXNoKCk7Cn0KCgovLyBjb25zdHJ1Y3RvcgpQSVhJLlJvcGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5TdHJpcC5wcm90b3R5cGUgKTsKUElYSS5Sb3BlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUm9wZTsKClBJWEkuUm9wZS5wcm90b3R5cGUucmVmcmVzaCA9IGZ1bmN0aW9uKCkKewoJdmFyIHBvaW50cyA9IHRoaXMucG9pbnRzOwoJaWYocG9pbnRzLmxlbmd0aCA8IDEpcmV0dXJuOwoKCXZhciB1dnMgPSB0aGlzLnV2cwoJdmFyIGluZGljZXMgPSB0aGlzLmluZGljZXM7Cgl2YXIgY29sb3JzID0gdGhpcy5jb2xvcnM7CgoJdmFyIGxhc3RQb2ludCA9IHBvaW50c1swXTsKCXZhciBuZXh0UG9pbnQ7Cgl2YXIgcGVycCA9IHt4OjAsIHk6MH07Cgl2YXIgcG9pbnQgPSBwb2ludHNbMF07CgoJdGhpcy5jb3VudC09MC4yOwoKCgl1dnNbMF0gPSAwCgl1dnNbMV0gPSAxCgl1dnNbMl0gPSAwCgl1dnNbM10gPSAxCgoJY29sb3JzWzBdID0gMTsKCWNvbG9yc1sxXSA9IDE7CgoJaW5kaWNlc1swXSA9IDA7CglpbmRpY2VzWzFdID0gMTsKCgl2YXIgdG90YWwgPSBwb2ludHMubGVuZ3RoOwoKCWZvciAodmFyIGkgPSAgMTsgaSA8IHRvdGFsOyBpKyspCgl7CgoJCXZhciBwb2ludCA9IHBvaW50c1tpXTsKCQl2YXIgaW5kZXggPSBpICogNDsKCQkvLyB0aW1lIHRvIGRvIHNvbWUgc21hcnQgZHJhd2luZyEKCQl2YXIgYW1vdW50ID0gaS8odG90YWwtMSkKCgkJaWYoaSUyKQoJCXsKCQkJdXZzW2luZGV4XSA9IGFtb3VudDsKCQkJdXZzW2luZGV4KzFdID0gMDsKCgkJCXV2c1tpbmRleCsyXSA9IGFtb3VudAoJCQl1dnNbaW5kZXgrM10gPSAxCgoJCX0KCQllbHNlCgkJewoJCQl1dnNbaW5kZXhdID0gYW1vdW50CgkJCXV2c1tpbmRleCsxXSA9IDAKCgkJCXV2c1tpbmRleCsyXSA9IGFtb3VudAoJCQl1dnNbaW5kZXgrM10gPSAxCgkJfQoKCQlpbmRleCA9IGkgKiAyOwoJCWNvbG9yc1tpbmRleF0gPSAxOwoJCWNvbG9yc1tpbmRleCsxXSA9IDE7CgoJCWluZGV4ID0gaSAqIDI7CgkJaW5kaWNlc1tpbmRleF0gPSBpbmRleDsKCQlpbmRpY2VzW2luZGV4ICsgMV0gPSBpbmRleCArIDE7CgoJCWxhc3RQb2ludCA9IHBvaW50OwoJfQp9CgpQSVhJLlJvcGUucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkKewoKCXZhciBwb2ludHMgPSB0aGlzLnBvaW50czsKCWlmKHBvaW50cy5sZW5ndGggPCAxKXJldHVybjsKCgl2YXIgdmVydGljaWVzID0gdGhpcy52ZXJ0aWNpZXMKCgl2YXIgbGFzdFBvaW50ID0gcG9pbnRzWzBdOwoJdmFyIG5leHRQb2ludDsKCXZhciBwZXJwID0ge3g6MCwgeTowfTsKCXZhciBwb2ludCA9IHBvaW50c1swXTsKCgl0aGlzLmNvdW50LT0wLjI7CgoJdmVydGljaWVzWzBdID0gcG9pbnQueCArIHBlcnAueAoJdmVydGljaWVzWzFdID0gcG9pbnQueSArIHBlcnAueSAvLysgMjAwCgl2ZXJ0aWNpZXNbMl0gPSBwb2ludC54IC0gcGVycC54Cgl2ZXJ0aWNpZXNbM10gPSBwb2ludC55IC0gcGVycC55Ly8rMjAwCgkvLyB0aW1lIHRvIGRvIHNvbWUgc21hcnQgZHJhd2luZyEKCgl2YXIgdG90YWwgPSBwb2ludHMubGVuZ3RoOwoKCWZvciAodmFyIGkgPSAgMTsgaSA8IHRvdGFsOyBpKyspCgl7CgoJCXZhciBwb2ludCA9IHBvaW50c1tpXTsKCQl2YXIgaW5kZXggPSBpICogNDsKCgkJaWYoaSA8IHBvaW50cy5sZW5ndGgtMSkKCQl7CgkJCW5leHRQb2ludCA9IHBvaW50c1tpKzFdOwoJCX0KCQllbHNlCgkJewoJCQluZXh0UG9pbnQgPSBwb2ludAoJCX0KCgkJcGVycC55ID0gLShuZXh0UG9pbnQueCAtIGxhc3RQb2ludC54KTsKCQlwZXJwLnggPSBuZXh0UG9pbnQueSAtIGxhc3RQb2ludC55OwoKCQl2YXIgcmF0aW8gPSAoMSAtIChpIC8gKHRvdGFsLTEpKSkgKiAxMDsKCQkJCWlmKHJhdGlvID4gMSlyYXRpbyA9IDE7CgoJCXZhciBwZXJwTGVuZ3RoID0gTWF0aC5zcXJ0KHBlcnAueCAqIHBlcnAueCArIHBlcnAueSAqIHBlcnAueSk7CgkJdmFyIG51bSA9IHRoaXMudGV4dHVyZS5oZWlnaHQvMi8vKDIwICsgTWF0aC5hYnMoTWF0aC5zaW4oKGkgKyB0aGlzLmNvdW50KSAqIDAuMykgKiA1MCkgKSogcmF0aW87CgkJcGVycC54IC89IHBlcnBMZW5ndGg7CgkJcGVycC55IC89IHBlcnBMZW5ndGg7CgoJCXBlcnAueCAqPSBudW07CgkJcGVycC55ICo9IG51bTsKCgkJdmVydGljaWVzW2luZGV4XSA9IHBvaW50LnggKyBwZXJwLngKCQl2ZXJ0aWNpZXNbaW5kZXgrMV0gPSBwb2ludC55ICsgcGVycC55CgkJdmVydGljaWVzW2luZGV4KzJdID0gcG9pbnQueCAtIHBlcnAueAoJCXZlcnRpY2llc1tpbmRleCszXSA9IHBvaW50LnkgLSBwZXJwLnkKCgkJbGFzdFBvaW50ID0gcG9pbnQ7Cgl9CgoJUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0uY2FsbCggdGhpcyApOwp9CgpQSVhJLlJvcGUucHJvdG90eXBlLnNldFRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CgkvLyBzdG9wIGN1cnJlbnQgdGV4dHVyZQoJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCXRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9CgoKCgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgovKioKICogQSB0aWxpbmcgc3ByaXRlIGlzIGEgZmFzdCB3YXkgb2YgcmVuZGVyaW5nIGEgdGlsaW5nIGltYWdlCiAqCiAqIEBjbGFzcyBUaWxpbmdTcHJpdGUKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IHRoZSB0ZXh0dXJlIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSAgdGhlIHdpZHRoIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgdGlsaW5nIHNwcml0ZQogKi8KUElYSS5UaWxpbmdTcHJpdGUgPSBmdW5jdGlvbih0ZXh0dXJlLCB3aWR0aCwgaGVpZ2h0KQp7CglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKCS8qKgoJICogVGhlIHRleHR1cmUgdGhhdCB0aGUgc3ByaXRlIGlzIHVzaW5nCgkgKgoJICogQHByb3BlcnR5IHRleHR1cmUKCSAqIEB0eXBlIFRleHR1cmUKCSAqLwoJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCgkvKioKCSAqIFRoZSB3aWR0aCBvZiB0aGUgdGlsaW5nIHNwcml0ZQoJICoKCSAqIEBwcm9wZXJ0eSB3aWR0aAoJICogQHR5cGUgTnVtYmVyCgkgKi8KCXRoaXMud2lkdGggPSB3aWR0aDsKCgkvKioKCSAqIFRoZSBoZWlnaHQgb2YgdGhlIHRpbGluZyBzcHJpdGUKCSAqCgkgKiBAcHJvcGVydHkgaGVpZ2h0CgkgKiBAdHlwZSBOdW1iZXIKCSAqLwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJLyoqCgkgKiBUaGUgc2NhbGluZyBvZiB0aGUgaW1hZ2UgdGhhdCBpcyBiZWluZyB0aWxlZAoJICoKCSAqIEBwcm9wZXJ0eSB0aWxlU2NhbGUKCSAqIEB0eXBlIFBvaW50CgkgKi8KCXRoaXMudGlsZVNjYWxlID0gbmV3IFBJWEkuUG9pbnQoMSwxKTsKCgkvKioKCSAqIFRoZSBvZmZzZXQgcG9zaXRpb24gb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQKCSAqCgkgKiBAcHJvcGVydHkgdGlsZVBvc2l0aW9uCgkgKiBAdHlwZSBQb2ludAoJICovCgl0aGlzLnRpbGVQb3NpdGlvbiA9IG5ldyBQSVhJLlBvaW50KDAsMCk7CgoJdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKCgl0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUwKfQoKLy8gY29uc3RydWN0b3IKUElYSS5UaWxpbmdTcHJpdGUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlRpbGluZ1Nwcml0ZTsKCi8qKgogKiBTZXRzIHRoZSB0ZXh0dXJlIG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqCiAqIEBtZXRob2Qgc2V0VGV4dHVyZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIFBJWEkgdGV4dHVyZSB0aGF0IGlzIGRpc3BsYXllZCBieSB0aGUgc3ByaXRlCiAqLwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKCS8vVE9ETyBTRVQgVEhFIFRFWFRVUkVTCgkvL1RPRE8gVklTSUJJTElUWQoKCS8vIHN0b3AgY3VycmVudCB0ZXh0dXJlCgl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KCi8qKgogKiBXaGVuIHRoZSB0ZXh0dXJlIGlzIHVwZGF0ZWQsIHRoaXMgZXZlbnQgd2lsbCBmaXJlIHRvIHVwZGF0ZSB0aGUgZnJhbWUKICoKICogQG1ldGhvZCBvblRleHR1cmVVcGRhdGUKICogQHBhcmFtIGV2ZW50CiAqIEBwcml2YXRlCiAqLwpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oZXZlbnQpCnsKCXRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogVGhpcyBpcyB0aGUgYmFzZSBjbGFzcyBmb3IgIGNyZWF0aW5nIGEgcGl4aS5qcyBmaWx0ZXIuIEN1cnJlbnRseSBvbmx5IHdlYkdMIHN1cHBvcnRzIGZpbHRlcnMuCiAqIElmIHlvdSB3YW50IHRvIG1ha2UgYSBjdXN0b20gZmlsdGVyIHRoaXMgc2hvdWxkIGJlIHlvdXIgYmFzZSBjbGFzcy4KICogQGNsYXNzIEFic3RyYWN0RmlsdGVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gZnJhZ21lbnRTcmMKICogQHBhcmFtIHVuaWZvcm1zICAKICovClBJWEkuQWJzdHJhY3RGaWx0ZXIgPSBmdW5jdGlvbihmcmFnbWVudFNyYywgdW5pZm9ybXMpCnsKCS8qKgoJKiBBbiBhcnJheSBvZiBwYXNzZXMgLSBzb21lIGZpbHRlcnMgY29udGFpbiBhIGZldyBzdGVwcyB0aGlzIGFycmF5IHNpbXBseSBzdG9yZXMgdGhlIHN0ZXBzIGluIGEgbGluaWVhciBmYXNoaW9uLgoJKiBGb3IgZXhhbXBsZSB0aGUgYmx1ciBmaWx0ZXIgaGFzIHR3byBwYXNzZXMgYmx1clggYW5kIGJsdXJZLgoJKiBAcHJvcGVydHkgcGFzc2VzCgkqIEB0eXBlIEFycmF5IGFuIGFycmF5IG9mIGZpbHRlciBvYmplY3RzCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgoKCXRoaXMuZGlydHkgPSB0cnVlOwoJdGhpcy5wYWRkaW5nID0gMDsKCgkvKioKCUBwcm9wZXJ0eSB1bmlmb3JtcwoJQHByaXZhdGUKCSovCgl0aGlzLnVuaWZvcm1zID0gdW5pZm9ybXMgfHwge307CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBmcmFnbWVudFNyYyB8fCBbXTsKfQoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIAogKiBUaGUgQmx1ckZpbHRlciBhcHBsaWVzIGEgR2F1c3NpYW4gYmx1ciB0byBhbiBvYmplY3QuIAogKiBUaGUgc3RyZW5ndGggb2YgdGhlIGJsdXIgY2FuIGJlIHNldCBmb3IgeC0gYW5kIHktYXhpcyBzZXBhcmF0ZWx5IChhbHdheXMgcmVsYXRpdmUgdG8gdGhlIHN0YWdlKS4KICoKICogQGNsYXNzIEJsdXJGaWx0ZXIKICogQGNvbnRydWN0b3IKICovClBJWEkuQmx1ckZpbHRlciA9IGZ1bmN0aW9uKCkKewogICAgCgl0aGlzLmJsdXJYRmlsdGVyID0gbmV3IFBJWEkuQmx1clhGaWx0ZXIoKTsKCXRoaXMuYmx1cllGaWx0ZXIgPSBuZXcgUElYSS5CbHVyWUZpbHRlcigpOwoKCXRoaXMucGFzc2VzID1bdGhpcy5ibHVyWEZpbHRlciwgdGhpcy5ibHVyWUZpbHRlcl07CgkKfQoKLyoqCiAqIFNldHMgdGhlIHN0cmVuZ3RoIG9mIGJvdGggdGhlIGJsdXJYIGFuZCBibHVyWSBwcm9wZXJ0aWVzIHNpbXVsdGFuZW91c2x5CiAqCiAqIEBwcm9wZXJ0eSBibHVyCiAqIEB0eXBlIE51bWJlciB0aGUgc3RyZW5ndGggb2YgdGhlIGJsdXIKICogQGRlZmF1bHQgMgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuQmx1ckZpbHRlci5wcm90b3R5cGUsICdibHVyJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5ibHVyWEZpbHRlci5ibHVyOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAJCXRoaXMuYmx1clhGaWx0ZXIuYmx1ciA9IHRoaXMuYmx1cllGaWx0ZXIuYmx1ciA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIHRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1clggcHJvcGVydHkgc2ltdWx0YW5lb3VzbHkKICoKICogQHByb3BlcnR5IGJsdXJYCiAqIEB0eXBlIE51bWJlciB0aGUgc3RyZW5ndGggb2YgdGhlIGJsdXJYCiAqIEBkZWZhdWx0IDIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkJsdXJGaWx0ZXIucHJvdG90eXBlLCAnYmx1clgnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmJsdXJYRmlsdGVyLmJsdXI7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuYmx1clhGaWx0ZXIuYmx1ciA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIHRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1clggcHJvcGVydHkgc2ltdWx0YW5lb3VzbHkKICoKICogQHByb3BlcnR5IGJsdXJZCiAqIEB0eXBlIE51bWJlciB0aGUgc3RyZW5ndGggb2YgdGhlIGJsdXJZCiAqIEBkZWZhdWx0IDIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkJsdXJGaWx0ZXIucHJvdG90eXBlLCAnYmx1clknLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmJsdXJZRmlsdGVyLmJsdXI7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuYmx1cllGaWx0ZXIuYmx1ciA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuQmx1clhGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlibHVyOiB7dHlwZTogJzFmJywgdmFsdWU6IDEvNTEyfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IGJsdXI7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgCSJ2ZWM0IHN1bSA9IHZlYzQoMC4wKTsiLAoKCSAgCSJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCAtIDQuMCpibHVyLCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMDU7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggLSAzLjAqYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjA5OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54IC0gMi4wKmJsdXIsIHZUZXh0dXJlQ29vcmQueSkpICogMC4xMjsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCAtIGJsdXIsIHZUZXh0dXJlQ29vcmQueSkpICogMC4xNTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55KSkgKiAwLjE2OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54ICsgYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjE1OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54ICsgMi4wKmJsdXIsIHZUZXh0dXJlQ29vcmQueSkpICogMC4xMjsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCArIDMuMCpibHVyLCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMDk7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggKyA0LjAqYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjA1OyIsCgkgCgkJImdsX0ZyYWdDb2xvciA9IHN1bTsiLAoKCSAgIn0iCgldOwp9CgpQSVhJLkJsdXJYRmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuQmx1clhGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5CbHVyWEZpbHRlcjsKCgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5CbHVyWEZpbHRlci5wcm90b3R5cGUsICdibHVyJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlIC8gKDEvNzAwMCk7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlID0gKDEvNzAwMCkgKiB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCgpQSVhJLkJsdXJZRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJYmx1cjoge3R5cGU6ICcxZicsIHZhbHVlOiAxLzUxMn0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBmbG9hdCBibHVyOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoJICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgIAkidmVjNCBzdW0gPSB2ZWM0KDAuMCk7IiwKCgkgIAkic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSAtIDQuMCpibHVyKSkgKiAwLjA1OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkgLSAzLjAqYmx1cikpICogMC4wOTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55IC0gMi4wKmJsdXIpKSAqIDAuMTI7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSAtIGJsdXIpKSAqIDAuMTU7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSkpICogMC4xNjsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55ICsgYmx1cikpICogMC4xNTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55ICsgMi4wKmJsdXIpKSAqIDAuMTI7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSArIDMuMCpibHVyKSkgKiAwLjA5OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkgKyA0LjAqYmx1cikpICogMC4wNTsiLAoJIAoJCSJnbF9GcmFnQ29sb3IgPSBzdW07IiwKCgkgICJ9IgoJXTsKfQoKUElYSS5CbHVyWUZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLkJsdXJZRmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQmx1cllGaWx0ZXI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5CbHVyWUZpbHRlci5wcm90b3R5cGUsICdibHVyJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlIC8gKDEvNzAwMCk7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCS8vdGhpcy5wYWRkaW5nID0gdmFsdWU7CiAgICAJdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlID0gKDEvNzAwMCkgKiB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIAogKiBUaGUgQ29sb3JNYXRyaXhGaWx0ZXIgY2xhc3MgbGV0cyB5b3UgYXBwbHkgYSA0eDQgbWF0cml4IHRyYW5zZm9ybWF0aW9uIG9uIHRoZSBSR0JBIAogKiBjb2xvciBhbmQgYWxwaGEgdmFsdWVzIG9mIGV2ZXJ5IHBpeGVsIG9uIHlvdXIgZGlzcGxheU9iamVjdCB0byBwcm9kdWNlIGEgcmVzdWx0IAogKiB3aXRoIGEgbmV3IHNldCBvZiBSR0JBIGNvbG9yIGFuZCBhbHBoYSB2YWx1ZXMuIEl0cyBwcmV0dHkgcG93ZXJmdWwhCiAqIEBjbGFzcyBDb2xvck1hdHJpeEZpbHRlcgogKiBAY29udHJ1Y3RvcgogKi8KUElYSS5Db2xvck1hdHJpeEZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJCgkvLyBzZXQgdGhlIHVuaWZvcm1zCgl0aGlzLnVuaWZvcm1zID0gewoJCW1hdHJpeDoge3R5cGU6ICdtYXQ0JywgdmFsdWU6IFsxLDAsMCwwLAoJCQkJCQkJCQkgICAwLDEsMCwwLAoJCQkJCQkJCQkgICAwLDAsMSwwLAoJCQkJCQkJCQkgICAwLDAsMCwxXX0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBmbG9hdCBpbnZlcnQ7IiwKCSAgInVuaWZvcm0gbWF0NCBtYXRyaXg7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCkgKiBtYXRyaXg7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gZ2xfRnJhZ0NvbG9yICogdkNvbG9yOyIsCgkgICJ9IgoJXTsKCQp9CgpQSVhJLkNvbG9yTWF0cml4RmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuQ29sb3JNYXRyaXhGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Db2xvck1hdHJpeEZpbHRlcjsKCi8qKgogKiBTZXRzIHRoZSBtYXRyaXggb2YgdGhlIGNvbG9yIG1hdHJpeCBmaWx0ZXIKICoKICogQHByb3BlcnR5IG1hdHJpeAogKiBAdHlwZSBBcnJheSBhbmQgYXJyYXkgb2YgMjYgbnVtYmVycwogKiBAZGVmYXVsdCBbMSwwLDAsMCwwLDEsMCwwLDAsMCwxLDAsMCwwLDAsMV0KICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkNvbG9yTWF0cml4RmlsdGVyLnByb3RvdHlwZSwgJ21hdHJpeCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMubWF0cml4LnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLnVuaWZvcm1zLm1hdHJpeC52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgoKUElYSS5Dcm9zc0hhdGNoRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJYmx1cjoge3R5cGU6ICcxZicsIHZhbHVlOiAxLzUxMn0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBmbG9hdCBibHVyOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoJICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgIAkKCSAgICAKCQkiICAgIGZsb2F0IGx1bSA9IGxlbmd0aCh0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQueHkpLnJnYik7IiwKCQkiICAgICAiLAoJCSIgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgxLjAsIDEuMCwgMS4wLCAxLjApOyIsCgkJIiAgICAgIiwKCQkiICAgIGlmIChsdW0gPCAxLjAwKSB7IiwKCQkiICAgICAgICBpZiAobW9kKGdsX0ZyYWdDb29yZC54ICsgZ2xfRnJhZ0Nvb3JkLnksIDEwLjApID09IDAuMCkgeyIsCgkJIiAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC4wLCAwLjAsIDAuMCwgMS4wKTsiLAoJCSIgICAgICAgIH0iLAoJCSIgICAgfSIsCgkJIiAgICAgIiwKCQkiICAgIGlmIChsdW0gPCAwLjc1KSB7IiwKCQkiICAgICAgICBpZiAobW9kKGdsX0ZyYWdDb29yZC54IC0gZ2xfRnJhZ0Nvb3JkLnksIDEwLjApID09IDAuMCkgeyIsCgkJIiAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC4wLCAwLjAsIDAuMCwgMS4wKTsiLAoJCSIgICAgICAgIH0iLAoJCSIgICAgfSIsCgkJIiAgICAgIiwKCQkiICAgIGlmIChsdW0gPCAwLjUwKSB7IiwKCQkiICAgICAgICBpZiAobW9kKGdsX0ZyYWdDb29yZC54ICsgZ2xfRnJhZ0Nvb3JkLnkgLSA1LjAsIDEwLjApID09IDAuMCkgeyIsCgkJIiAgICAgICAgICAgIGdsX0ZyYWdDb2xvciA9IHZlYzQoMC4wLCAwLjAsIDAuMCwgMS4wKTsiLAoJCSIgICAgICAgIH0iLAoJCSIgICAgfSIsCgkJIiAgICAgIiwKCQkiICAgIGlmIChsdW0gPCAwLjMpIHsiLAoJCSIgICAgICAgIGlmIChtb2QoZ2xfRnJhZ0Nvb3JkLnggLSBnbF9GcmFnQ29vcmQueSAtIDUuMCwgMTAuMCkgPT0gMC4wKSB7IiwKCQkiICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjAsIDAuMCwgMC4wLCAxLjApOyIsCgkJIiAgICAgICAgfSIsCgkJIiAgICB9IiwKCQkifSIKCV07Cn0KClBJWEkuQ3Jvc3NIYXRjaEZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLkNyb3NzSGF0Y2hGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5CbHVyWUZpbHRlcjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkNyb3NzSGF0Y2hGaWx0ZXIucHJvdG90eXBlLCAnYmx1cicsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuYmx1ci52YWx1ZSAvICgxLzcwMDApOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAkvL3RoaXMucGFkZGluZyA9IHZhbHVlOwogICAgCXRoaXMudW5pZm9ybXMuYmx1ci52YWx1ZSA9ICgxLzcwMDApICogdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogCiAqIFRoZSBEaXNwbGFjZW1lbnRGaWx0ZXIgY2xhc3MgdXNlcyB0aGUgcGl4ZWwgdmFsdWVzIGZyb20gdGhlIHNwZWNpZmllZCB0ZXh0dXJlIChjYWxsZWQgdGhlIGRpc3BsYWNlbWVudCBtYXApIHRvIHBlcmZvcm0gYSBkaXNwbGFjZW1lbnQgb2YgYW4gb2JqZWN0LiAKICogWW91IGNhbiB1c2UgdGhpcyBmaWx0ZXIgdG8gYXBwbHkgYWxsIG1hbm9yIG9mIGNyYXp5IHdhcnBpbmcgZWZmZWN0cwogKiBDdXJyZW50bHkgdGhlIHIgcHJvcGVydHkgb2YgdGhlIHRleHR1cmUgaXMgdXNlZCBvZmZzZXQgdGhlIHggYW5kIHRoZSBnIHByb3Blcnkgb2YgdGhlIHRleHR1cmUgaXMgdXNlZCB0byBvZmZzZXQgdGhlIHkuCiAqIEBjbGFzcyBEaXNwbGFjZW1lbnRGaWx0ZXIKICogQGNvbnRydWN0b3IKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSB0ZXh0dXJlIHVzZWQgZm9yIHRoZSBkaXNwbGFjZW10ZW50IG1hcCAqIG11c3QgYmUgcG93ZXIgb2YgMiB0ZXh0dXJlIGF0IHRoZSBtb21lbnQKICovClBJWEkuRGlzcGxhY2VtZW50RmlsdGVyID0gZnVuY3Rpb24odGV4dHVyZSkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJdGV4dHVyZS5iYXNlVGV4dHVyZS5fcG93ZXJPZjIgPSB0cnVlOwoKCS8vIHNldCB0aGUgdW5pZm9ybXMKCS8vY29uc29sZS5sb2coKQoJdGhpcy51bmlmb3JtcyA9IHsKCQlkaXNwbGFjZW1lbnRNYXA6IHt0eXBlOiAnc2FtcGxlcjJEJywgdmFsdWU6dGV4dHVyZX0sCgkJc2NhbGU6CQkJIHt0eXBlOiAnMmYnLCB2YWx1ZTp7eDozMCwgeTozMH19LAoJCW9mZnNldDoJCQkge3R5cGU6ICcyZicsIHZhbHVlOnt4OjAsIHk6MH19LAoJCW1hcERpbWVuc2lvbnM6ICAge3R5cGU6ICcyZicsIHZhbHVlOnt4OjEsIHk6NTExMn19LAoJCWRpbWVuc2lvbnM6ICAge3R5cGU6ICc0ZnYnLCB2YWx1ZTpbMCwwLDAsMF19Cgl9OwoJCgoJaWYodGV4dHVyZS5iYXNlVGV4dHVyZS5oYXNMb2FkZWQpCgl7CgkJdGhpcy51bmlmb3Jtcy5tYXBEaW1lbnNpb25zLnZhbHVlLnggPSB0ZXh0dXJlLndpZHRoOwoJCXRoaXMudW5pZm9ybXMubWFwRGltZW5zaW9ucy52YWx1ZS55ID0gdGV4dHVyZS5oZWlnaHQ7Cgl9CgllbHNlCgl7CgkJdGhpcy5ib3VuZExvYWRlZEZ1bmN0aW9uID0gdGhpcy5vblRleHR1cmVMb2FkZWQuYmluZCh0aGlzKTsKCgkJdGV4dHVyZS5iYXNlVGV4dHVyZS5vbigibG9hZGVkIiwgdGhpcy5ib3VuZExvYWRlZEZ1bmN0aW9uKTsKCX0KCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgZGlzcGxhY2VtZW50TWFwOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoJICAidW5pZm9ybSB2ZWMyIHNjYWxlOyIsCgkgICJ1bmlmb3JtIHZlYzIgb2Zmc2V0OyIsCgkgICJ1bmlmb3JtIHZlYzQgZGltZW5zaW9uczsiLAoJICAidW5pZm9ybSB2ZWMyIG1hcERpbWVuc2lvbnM7IiwvLyA9IHZlYzIoMjU2LjAsIDI1Ni4wKTsiLAoJIC8vICJjb25zdCB2ZWMyIHRleHR1cmVEaW1lbnNpb25zID0gdmVjMig3NTAuMCwgNzUwLjApOyIsCgkgIAoJICAidm9pZCBtYWluKHZvaWQpIHsiLAoJICAJInZlYzIgbWFwQ29yZHMgPSB2VGV4dHVyZUNvb3JkLnh5OyIsCi8vCSAgCSJtYXBDb3JkcyAtPSA7IiwKCSAJIm1hcENvcmRzICs9IChkaW1lbnNpb25zLnp3ICsgb2Zmc2V0KS8gZGltZW5zaW9ucy54eSA7IiwKCSAJIm1hcENvcmRzLnkgKj0gLTEuMDsiLAoJIAkibWFwQ29yZHMueSArPSAxLjA7IiwKCSAgCSJ2ZWMyIG1hdFNhbXBsZSA9IHRleHR1cmUyRChkaXNwbGFjZW1lbnRNYXAsIG1hcENvcmRzKS54eTsiLAoJCSJtYXRTYW1wbGUgLT0gMC41OyIsCSAgCgkgCSJtYXRTYW1wbGUgKj0gc2NhbGU7IiwKCSAJIm1hdFNhbXBsZSAvPSBtYXBEaW1lbnNpb25zOyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggKyBtYXRTYW1wbGUueCwgdlRleHR1cmVDb29yZC55ICsgbWF0U2FtcGxlLnkpKTsiLAoJCSJnbF9GcmFnQ29sb3IucmdiID0gbWl4KCBnbF9GcmFnQ29sb3IucmdiLCBnbF9GcmFnQ29sb3IucmdiLCAxLjApOyIsCgkJInZlYzIgY29yZCA9IHZUZXh0dXJlQ29vcmQ7IiwKCQkKCQkvLyJnbF9GcmFnQ29sb3IgPSAgdGV4dHVyZTJEKGRpc3BsYWNlbWVudE1hcCwgY29yZCk7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gZ2xfRnJhZ0NvbG9yICogdkNvbG9yOyIsCgkgICAgCgkgICJ9IgoJXTsKCQp9CgpQSVhJLkRpc3BsYWNlbWVudEZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLkRpc3BsYWNlbWVudEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkRpc3BsYWNlbWVudEZpbHRlcjsKClBJWEkuRGlzcGxhY2VtZW50RmlsdGVyLnByb3RvdHlwZS5vblRleHR1cmVMb2FkZWQgPSBmdW5jdGlvbigpCnsKCQoJdGhpcy51bmlmb3Jtcy5tYXBEaW1lbnNpb25zLnZhbHVlLnggPSB0aGlzLnVuaWZvcm1zLmRpc3BsYWNlbWVudE1hcC52YWx1ZS53aWR0aDsKCXRoaXMudW5pZm9ybXMubWFwRGltZW5zaW9ucy52YWx1ZS55ID0gdGhpcy51bmlmb3Jtcy5kaXNwbGFjZW1lbnRNYXAudmFsdWUuaGVpZ2h0OwoKCXRoaXMudW5pZm9ybXMuZGlzcGxhY2VtZW50TWFwLnZhbHVlLmJhc2VUZXh0dXJlLm9mZigibG9hZGVkIiwgdGhpcy5ib3VuZExvYWRlZEZ1bmN0aW9uKQoKfQoKLyoqCiAqIFRoZSB0ZXh0dXJlIHVzZWQgZm9yIHRoZSBkaXNwbGFjZW10ZW50IG1hcCAqIG11c3QgYmUgcG93ZXIgb2YgMiB0ZXh0dXJlIGF0IHRoZSBtb21lbnQKICoKICogQHByb3BlcnR5IG1hcAogKiBAdHlwZSBUZXh0dXJlCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5EaXNwbGFjZW1lbnRGaWx0ZXIucHJvdG90eXBlLCAnbWFwJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5kaXNwbGFjZW1lbnRNYXAudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMudW5pZm9ybXMuZGlzcGxhY2VtZW50TWFwLnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFRoZSBtdWx0aXBsaWVyIHVzZWQgdG8gc2NhbGUgdGhlIGRpc3BsYWNlbWVudCByZXN1bHQgZnJvbSB0aGUgbWFwIGNhbGN1bGF0aW9uLgogKgogKiBAcHJvcGVydHkgc2NhbGUKICogQHR5cGUgUG9pbnQKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYWNlbWVudEZpbHRlci5wcm90b3R5cGUsICdzY2FsZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuc2NhbGUudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMudW5pZm9ybXMuc2NhbGUudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogVGhlIG9mZnNldCB1c2VkIHRvIG1vdmUgdGhlIGRpc3BsYWNlbWVudCBtYXAuCiAqCiAqIEBwcm9wZXJ0eSBvZmZzZXQKICogQHR5cGUgUG9pbnQKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYWNlbWVudEZpbHRlci5wcm90b3R5cGUsICdvZmZzZXQnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLm9mZnNldC52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy51bmlmb3Jtcy5vZmZzZXQudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICogb3JpZ2luYWwgZmlsdGVyOiBodHRwczovL2dpdGh1Yi5jb20vZXZhbncvZ2xmeC5qcy9ibG9iL21hc3Rlci9zcmMvZmlsdGVycy9mdW4vZG90c2NyZWVuLmpzCiAqLwoKLyoqCiAqIAogKiBUaGlzIGZpbHRlciBhcHBsaWVzIGEgcGl4bGF0ZSBlZmZlY3QgbWFraW5nIGRpc3BsYXkgb2JqZWN0cyBhcHBlYXIgImJsb2NreSIKICogQGNsYXNzIFBpeGVsYXRlRmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLkRvdFNjcmVlbkZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJc2NhbGU6IHt0eXBlOiAnMWYnLCB2YWx1ZToxfSwKCQlhbmdsZToge3R5cGU6ICcxZicsIHZhbHVlOjV9LAoJCWRpbWVuc2lvbnM6ICAge3R5cGU6ICc0ZnYnLCB2YWx1ZTpbMCwwLDAsMF19Cgl9OwoKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIHZlYzQgZGltZW5zaW9uczsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCgkgICAgInVuaWZvcm0gZmxvYXQgYW5nbGU7IiwKCSAgICAidW5pZm9ybSBmbG9hdCBzY2FsZTsiLAoKCSAgICAiZmxvYXQgcGF0dGVybigpIHsiLAoJICAgIAkiZmxvYXQgcyA9IHNpbihhbmdsZSksIGMgPSBjb3MoYW5nbGUpOyIsCgkgICAgCSJ2ZWMyIHRleCA9IHZUZXh0dXJlQ29vcmQgKiBkaW1lbnNpb25zLnh5OyIsCgkgICAgCSJ2ZWMyIHBvaW50ID0gdmVjMigiLAoJICAgIAkJImMgKiB0ZXgueCAtIHMgKiB0ZXgueSwiLAoJICAgIAkJInMgKiB0ZXgueCArIGMgKiB0ZXgueSIsCgkgICAgCSIpICogc2NhbGU7IiwKCSAgICAJInJldHVybiAoc2luKHBvaW50LngpICogc2luKHBvaW50LnkpKSAqIDQuMDsiLAoJICAgICJ9IiwKCgkgICAgInZvaWQgbWFpbigpIHsiLAogICAgICAgICAgICAidmVjNCBjb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCk7IiwKICAgICAgICAgICAgImZsb2F0IGF2ZXJhZ2UgPSAoY29sb3IuciArIGNvbG9yLmcgKyBjb2xvci5iKSAvIDMuMDsiLAogICAgICAgICAgICAiZ2xfRnJhZ0NvbG9yID0gdmVjNCh2ZWMzKGF2ZXJhZ2UgKiAxMC4wIC0gNS4wICsgcGF0dGVybigpKSwgY29sb3IuYSk7IiwKICAgICAgICAifSIsCgldOwp9CgpQSVhJLkRvdFNjcmVlbkZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRvdFNjcmVlbkZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5Eb3RTY3JlZW5GaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Eb3RTY3JlZW5GaWx0ZXI7CgovKioKICogCiAqIFRoaXMgZGVzY3JpYmVzIHRoZSB0aGUgc2NhbGUKICogQHByb3BlcnR5IHNjYWxlCiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRG90U2NyZWVuRmlsdGVyLnByb3RvdHlwZSwgJ3NjYWxlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5zY2FsZS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5zY2FsZS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiAKICogVGhpcyByYWRpdXMgZGVzY3JpYmVzIGFuZ2xlCiAqIEBwcm9wZXJ0eSBhbmdsZQogKiBAdHlwZSBOdW1iZXIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRvdFNjcmVlbkZpbHRlci5wcm90b3R5cGUsICdhbmdsZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuYW5nbGUudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuZGlydHkgPSB0cnVlOwogICAgCXRoaXMudW5pZm9ybXMuYW5nbGUudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuRmlsdGVyQmxvY2sgPSBmdW5jdGlvbigpCnsKCXRoaXMudmlzaWJsZSA9IHRydWU7Cgl0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwp9Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogCiAqIFRoaXMgaW52ZXJ0cyB5b3VyIGRpc3BsYXlPYmplY3RzIGNvbG9ycy4KICogQGNsYXNzIEludmVydEZpbHRlcgogKiBAY29udHJ1Y3RvcgogKi8KUElYSS5JbnZlcnRGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlpbnZlcnQ6IHt0eXBlOiAnMWYnLCB2YWx1ZTogMX0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBmbG9hdCBpbnZlcnQ7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCk7IiwKCQkiZ2xfRnJhZ0NvbG9yLnJnYiA9IG1peCggKHZlYzMoMSktZ2xfRnJhZ0NvbG9yLnJnYikgKiBnbF9GcmFnQ29sb3IuYSwgZ2xfRnJhZ0NvbG9yLnJnYiwgMS4wIC0gaW52ZXJ0KTsiLAoJCS8vImdsX0ZyYWdDb2xvci5yZ2IgPSBnbF9GcmFnQ29sb3IucmdiICAqIGdsX0ZyYWdDb2xvci5hOyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IGdsX0ZyYWdDb2xvciAqIHZDb2xvcjsiLAoJICAifSIKCV07CgkKfQoKUElYSS5JbnZlcnRGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5JbnZlcnRGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5JbnZlcnRGaWx0ZXI7CgovKioKVGhlIHN0cmVuZ3RoIG9mIHRoZSBpbnZlcnQuIDEgd2lsbCBmdWxseSBpbnZlcnQgdGhlIGNvbG9ycywgMCB3aWxsIG1ha2UgdGhlIG9iamVjdCBpdHMgbm9ybWFsIGNvbG9yCkBwcm9wZXJ0eSBpbnZlcnQKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuSW52ZXJ0RmlsdGVyLnByb3RvdHlwZSwgJ2ludmVydCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuaW52ZXJ0LnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLnVuaWZvcm1zLmludmVydC52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiAKICogVGhpcyBmaWx0ZXIgYXBwbGllcyBhIHBpeGxhdGUgZWZmZWN0IG1ha2luZyBkaXNwbGF5IG9iamVjdHMgYXBwZWFyICJibG9ja3kiCiAqIEBjbGFzcyBQaXhlbGF0ZUZpbHRlcgogKiBAY29udHJ1Y3RvcgogKi8KUElYSS5QaXhlbGF0ZUZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJaW52ZXJ0OiB7dHlwZTogJzFmJywgdmFsdWU6IDB9LAoJCWRpbWVuc2lvbnM6IHt0eXBlOiAnNGZ2JywgdmFsdWU6bmV3IEZsb2F0MzJBcnJheShbMTAwMDAsIDEwMCwgMTAsIDEwXSl9LAoJCXBpeGVsU2l6ZToge3R5cGU6ICcyZicsIHZhbHVlOnt4OjEwLCB5OjEwfX0sCgl9OwoKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIHZlYzIgdGVzdERpbTsiLAoJICAidW5pZm9ybSB2ZWM0IGRpbWVuc2lvbnM7IiwKCSAgInVuaWZvcm0gdmVjMiBwaXhlbFNpemU7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgCSJ2ZWMyIGNvb3JkID0gdlRleHR1cmVDb29yZDsiLAoKCSAJInZlYzIgc2l6ZSA9IGRpbWVuc2lvbnMueHkvcGl4ZWxTaXplOyIsCgoJIAkidmVjMiBjb2xvciA9IGZsb29yKCAoIHZUZXh0dXJlQ29vcmQgKiBzaXplICkgKSAvIHNpemUgKyBwaXhlbFNpemUvZGltZW5zaW9ucy54eSAqIDAuNTsiLAoJICAgICJnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIGNvbG9yKTsiLAoJICAifSIKCV07CgkKCn0KClBJWEkuUGl4ZWxhdGVGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5QaXhlbGF0ZUZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlBpeGVsYXRlRmlsdGVyOwoKLyoqCiAqIAogKiBUaGlzIGEgcG9pbnQgdGhhdCBkZXNjcmliZXMgdGhlIHNpemUgb2YgdGhlIGJsb2NzLiB4IGlzIHRoZSB3aWR0aCBvZiB0aGUgYmxvY2sgYW5kIHkgaXMgdGhlIHRoZSBoZWlnaHQKICogQHByb3BlcnR5IHNpemUKICogQHR5cGUgUG9pbnQKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlBpeGVsYXRlRmlsdGVyLnByb3RvdHlwZSwgJ3NpemUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnBpeGVsU2l6ZS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5waXhlbFNpemUudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuUkdCU3BsaXRGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlyZWQ6IHt0eXBlOiAnMmYnLCB2YWx1ZToge3g6MjAsIHk6MjB9fSwKCQlncmVlbjoge3R5cGU6ICcyZicsIHZhbHVlOiB7eDotMjAsIHk6MjB9fSwKCQlibHVlOiB7dHlwZTogJzJmJywgdmFsdWU6IHt4OjIwLCB5Oi0yMH19LAoJCWRpbWVuc2lvbnM6ICAge3R5cGU6ICc0ZnYnLCB2YWx1ZTpbMCwwLDAsMF19Cgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSB2ZWMyIHJlZDsiLAoJICAidW5pZm9ybSB2ZWMyIGdyZWVuOyIsCgkgICJ1bmlmb3JtIHZlYzIgYmx1ZTsiLAoJICAidW5pZm9ybSB2ZWM0IGRpbWVuc2lvbnM7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgCSAgImdsX0ZyYWdDb2xvci5yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkICsgcmVkL2RpbWVuc2lvbnMueHkpLnI7IiwKCSAgCSAgImdsX0ZyYWdDb2xvci5nID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkICsgZ3JlZW4vZGltZW5zaW9ucy54eSkuZzsiLAoJICAJICAiZ2xfRnJhZ0NvbG9yLmIgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQgKyBibHVlL2RpbWVuc2lvbnMueHkpLmI7IiwKCSAgCSAgImdsX0ZyYWdDb2xvci5hID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkKS5hOyIsCgkgICJ9IgoJXTsKfQoKUElYSS5SR0JTcGxpdEZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLlJHQlNwbGl0RmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUkdCU3BsaXRGaWx0ZXI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5SR0JTcGxpdEZpbHRlci5wcm90b3R5cGUsICdhbmdsZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuYmx1ci52YWx1ZSAvICgxLzcwMDApOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAkvL3RoaXMucGFkZGluZyA9IHZhbHVlOwogICAgCXRoaXMudW5pZm9ybXMuYmx1ci52YWx1ZSA9ICgxLzcwMDApICogdmFsdWU7CiAgICB9Cn0pOwoKLyoqCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIAogKiBUaGlzIGFwcGxpZXMgYSBzZXBpYSBlZmZlY3QgdG8geW91ciBkaXNwbGF5T2JqZWN0cy4KICogQGNsYXNzIFNlcGlhRmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLlNlcGlhRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJc2VwaWE6IHt0eXBlOiAnMWYnLCB2YWx1ZTogMX0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSBmbG9hdCBzZXBpYTsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAJICAgCgkgICJjb25zdCBtYXQzIHNlcGlhTWF0cml4ID0gbWF0MygwLjM1ODgsIDAuNzA0NCwgMC4xMzY4LCAwLjI5OTAsIDAuNTg3MCwgMC4xMTQwLCAwLjIzOTIsIDAuNDY5NiwgMC4wOTEyKTsiLAoJICAidm9pZCBtYWluKHZvaWQpIHsiLAoJICAgICJnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQpOyIsCgkJImdsX0ZyYWdDb2xvci5yZ2IgPSBtaXgoIGdsX0ZyYWdDb2xvci5yZ2IsIGdsX0ZyYWdDb2xvci5yZ2IgKiBzZXBpYU1hdHJpeCwgc2VwaWEpOyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IGdsX0ZyYWdDb2xvciAqIHZDb2xvcjsiLAoJICAifSIKCV07CgkKfQoKUElYSS5TZXBpYUZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLlNlcGlhRmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuU2VwaWFGaWx0ZXI7CgovKioKVGhlIHN0cmVuZ3RoIG9mIHRoZSBzZXBpYS4gMSB3aWxsIGFwcGx5IHRoZSBmdWxsIHNlcGlhIGVmZmVjdCwgMCB3aWxsIG1ha2UgdGhlIG9iamVjdCBpdHMgbm9ybWFsIGNvbG9yCkBwcm9wZXJ0eSBzZXBpYQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5TZXBpYUZpbHRlci5wcm90b3R5cGUsICdzZXBpYScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuc2VwaWEudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMudW5pZm9ybXMuc2VwaWEudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCgpQSVhJLlNtYXJ0Qmx1ckZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJCgkvLyBzZXQgdGhlIHVuaWZvcm1zCgl0aGlzLnVuaWZvcm1zID0gewoJCWJsdXI6IHt0eXBlOiAnMWYnLCB2YWx1ZTogMS81MTJ9LAoJfTsKCQoJdGhpcy5mcmFnbWVudFNyYyA9IFsKCSAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCiAJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKICAJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKICAgIC8vICAidW5pZm9ybSB2ZWMyIGRlbHRhOyIsCiAgICAgICJjb25zdCB2ZWMyIGRlbHRhID0gdmVjMigxLjAvMTAuMCwgMC4wKTsiLAogICAgIC8vICJ1bmlmb3JtIGZsb2F0IGRhcmtuZXNzOyIsCgkgIAoJICAiZmxvYXQgcmFuZG9tKHZlYzMgc2NhbGUsIGZsb2F0IHNlZWQpIHsiLAoJICAgICAgICAicmV0dXJuIGZyYWN0KHNpbihkb3QoZ2xfRnJhZ0Nvb3JkLnh5eiArIHNlZWQsIHNjYWxlKSkgKiA0Mzc1OC41NDUzICsgc2VlZCk7IiwKCSAgICJ9IiwKCSAgIAoJICAgCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgCgkgICJ2ZWM0IGNvbG9yID0gdmVjNCgwLjApOyIsCgkgICJmbG9hdCB0b3RhbCA9IDAuMDsiLAoJICAKCSAgImZsb2F0IG9mZnNldCA9IHJhbmRvbSh2ZWMzKDEyLjk4OTgsIDc4LjIzMywgMTUxLjcxODIpLCAwLjApOyIsCgkgICAgICAgICAgICAKCSAgImZvciAoZmxvYXQgdCA9IC0zMC4wOyB0IDw9IDMwLjA7IHQrKykgeyIsCgkgICAgICAgICAgICJmbG9hdCBwZXJjZW50ID0gKHQgKyBvZmZzZXQgLSAwLjUpIC8gMzAuMDsiLAoJICAgICAgICAgICAgICAgICJmbG9hdCB3ZWlnaHQgPSAxLjAgLSBhYnMocGVyY2VudCk7IiwKCSAgICAgICAgICAgICAgICAidmVjNCBzYW1wbGUgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQgKyBkZWx0YSAqIHBlcmNlbnQpOyIsCgkgICAgICAgICAgICAgICAgInNhbXBsZS5yZ2IgKj0gc2FtcGxlLmE7IiwKCSAgICAgICAgICAgICAgICAiY29sb3IgKz0gc2FtcGxlICogd2VpZ2h0OyIsCgkgICAgICAgICAgICAgICAgInRvdGFsICs9IHdlaWdodDsiLAoJICAgICAgICAgICAgIn0iLAoJICAgICAgICAgICAgCgkgICAgICAgICAgICAiZ2xfRnJhZ0NvbG9yID0gY29sb3IgLyB0b3RhbDsiLAoJICAgICAgICAgICAgImdsX0ZyYWdDb2xvci5yZ2IgLz0gZ2xfRnJhZ0NvbG9yLmEgKyAwLjAwMDAxOyIsCgkgICAgICAgICAgLy8gICJnbF9GcmFnQ29sb3IucmdiICo9IGRhcmtuZXNzOyIsCgkgICJ9IgoJXTsKfQoKUElYSS5TbWFydEJsdXJGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5TbWFydEJsdXJGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TbWFydEJsdXJGaWx0ZXI7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5TbWFydEJsdXJGaWx0ZXIucHJvdG90eXBlLCAnYmx1cicsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMuYmx1ci52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiAKICogVGhpcyBmaWx0ZXIgYXBwbGllcyBhIHBpeGxhdGUgZWZmZWN0IG1ha2luZyBkaXNwbGF5IG9iamVjdHMgYXBwZWFyICJibG9ja3kiCiAqIEBjbGFzcyBQaXhlbGF0ZUZpbHRlcgogKiBAY29udHJ1Y3RvcgogKi8KUElYSS5Ud2lzdEZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJcmFkaXVzOiB7dHlwZTogJzFmJywgdmFsdWU6MC41fSwKCQlhbmdsZToge3R5cGU6ICcxZicsIHZhbHVlOjV9LAoJCW9mZnNldDoge3R5cGU6ICcyZicsIHZhbHVlOnt4OjAuNSwgeTowLjV9fSwKCX07CgoJdGhpcy5mcmFnbWVudFNyYyA9IFsKCSAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCgkgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAoJICAidmFyeWluZyBmbG9hdCB2Q29sb3I7IiwKCSAgInVuaWZvcm0gdmVjNCBkaW1lbnNpb25zOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoJICAKCSAgInVuaWZvcm0gZmxvYXQgcmFkaXVzOyIsCiAgICAgICJ1bmlmb3JtIGZsb2F0IGFuZ2xlOyIsCiAgICAgICJ1bmlmb3JtIHZlYzIgb2Zmc2V0OyIsCgoJICAidm9pZCBtYWluKHZvaWQpIHsiLAoJIAkidmVjMiBjb29yZCA9IHZUZXh0dXJlQ29vcmQgLSBvZmZzZXQ7IiwKCQkiZmxvYXQgZGlzdGFuY2UgPSBsZW5ndGgoY29vcmQpOyIsCgkgCQoJIAkiaWYgKGRpc3RhbmNlIDwgcmFkaXVzKXsiLAoKCQkgCSJmbG9hdCByYXRpbyA9IChyYWRpdXMgLSBkaXN0YW5jZSkgLyByYWRpdXM7IiwKCQkgCSJmbG9hdCBhbmdsZU1vZCA9IHJhdGlvICogcmF0aW8gKiBhbmdsZTsiLAoJCSAJImZsb2F0IHMgPSBzaW4oYW5nbGVNb2QpOyIsCgkJIAkiZmxvYXQgYyA9IGNvcyhhbmdsZU1vZCk7IiwKCQkgCSJjb29yZCA9IHZlYzIoY29vcmQueCAqIGMgLSBjb29yZC55ICogcywgY29vcmQueCAqIHMgKyBjb29yZC55ICogYyk7IiwKCgkgCSJ9IiwKCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgY29vcmQrb2Zmc2V0KTsiLAoJICAifSIKCV07Cn0KClBJWEkuVHdpc3RGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5Ud2lzdEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlR3aXN0RmlsdGVyOwoKLyoqCiAqIAogKiBUaGlzIHBvaW50IGRlc2NyaWJlcyB0aGUgdGhlIG9mZnNldCBvZiB0aGUgdHdpc3QKICogQHByb3BlcnR5IHNpemUKICogQHR5cGUgUG9pbnQKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlR3aXN0RmlsdGVyLnByb3RvdHlwZSwgJ29mZnNldCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMub2Zmc2V0LnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLm9mZnNldC52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiAKICogVGhpcyByYWRpdXMgZGVzY3JpYmVzIHNpemUgb2YgdGhlIHR3aXN0CiAqIEBwcm9wZXJ0eSBzaXplCiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuVHdpc3RGaWx0ZXIucHJvdG90eXBlLCAncmFkaXVzJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5yYWRpdXMudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuZGlydHkgPSB0cnVlOwogICAgCXRoaXMudW5pZm9ybXMucmFkaXVzLnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIAogKiBUaGlzIHJhZGl1cyBkZXNjcmliZXMgYW5nbGUgb2YgdGhlIHR3aXN0CiAqIEBwcm9wZXJ0eSBhbmdsZQogKiBAdHlwZSBOdW1iZXIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlR3aXN0RmlsdGVyLnByb3RvdHlwZSwgJ2FuZ2xlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5hbmdsZS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5hbmdsZS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogVGhlIEdyYXBoaWNzIGNsYXNzIGNvbnRhaW5zIGEgc2V0IG9mIG1ldGhvZHMgdGhhdCB5b3UgY2FuIHVzZSB0byBjcmVhdGUgcHJpbWl0aXZlIHNoYXBlcyBhbmQgbGluZXMuCiAqIEl0IGlzIGltcG9ydGFudCB0byBrbm93IHRoYXQgd2l0aCB0aGUgd2ViR0wgcmVuZGVyZXIgb25seSBzaW1wbGUgcG9seXMgY2FuIGJlIGZpbGxlZCBhdCB0aGlzIHN0YWdlCiAqIENvbXBsZXggcG9seXMgd2lsbCBub3QgYmUgZmlsbGVkLiBIZXJlcyBhbiBleGFtcGxlIG9mIGEgY29tcGxleCBwb2x5OiBodHRwOi8vd3d3Lmdvb2Rib3lkaWdpdGFsLmNvbS93cC1jb250ZW50L3VwbG9hZHMvMjAxMy8wNi9jb21wbGV4UG9seWdvbi5wbmcKICoKICogQGNsYXNzIEdyYXBoaWNzCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkdyYXBoaWNzID0gZnVuY3Rpb24oKQp7CglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKCXRoaXMucmVuZGVyYWJsZSA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGUgYWxwaGEgb2YgdGhlIGZpbGwgb2YgdGhpcyBncmFwaGljcyBvYmplY3QKICAgICAqCiAgICAgKiBAcHJvcGVydHkgZmlsbEFscGhhCiAgICAgKiBAdHlwZSBOdW1iZXIKICAgICAqLwoJdGhpcy5maWxsQWxwaGEgPSAxOwoKICAgIC8qKgogICAgICogVGhlIHdpZHRoIG9mIGFueSBsaW5lcyBkcmF3bgogICAgICoKICAgICAqIEBwcm9wZXJ0eSBsaW5lV2lkdGgKICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCgl0aGlzLmxpbmVXaWR0aCA9IDA7CgogICAgLyoqCiAgICAgKiBUaGUgY29sb3Igb2YgYW55IGxpbmVzIGRyYXduCiAgICAgKgogICAgICogQHByb3BlcnR5IGxpbmVDb2xvcgogICAgICogQHR5cGUgU3RyaW5nCiAgICAgKi8KCXRoaXMubGluZUNvbG9yID0gImJsYWNrIjsKCiAgICAvKioKICAgICAqIEdyYXBoaWNzIGRhdGEKICAgICAqCiAgICAgKiBAcHJvcGVydHkgZ3JhcGhpY3NEYXRhCiAgICAgKiBAdHlwZSBBcnJheQogICAgICogQHByaXZhdGUKICAgICAqLwoJdGhpcy5ncmFwaGljc0RhdGEgPSBbXTsKCiAgICAvKioKICAgICAqIEN1cnJlbnQgcGF0aAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBjdXJyZW50UGF0aAogICAgICogQHR5cGUgT2JqZWN0CiAgICAgKiBAcHJpdmF0ZQogICAgICovCgl0aGlzLmN1cnJlbnRQYXRoID0ge3BvaW50czpbXX07Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuR3JhcGhpY3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuR3JhcGhpY3M7CgovKioKICogU3BlY2lmaWVzIGEgbGluZSBzdHlsZSB1c2VkIGZvciBzdWJzZXF1ZW50IGNhbGxzIHRvIEdyYXBoaWNzIG1ldGhvZHMgc3VjaCBhcyB0aGUgbGluZVRvKCkgbWV0aG9kIG9yIHRoZSBkcmF3Q2lyY2xlKCkgbWV0aG9kLgogKgogKiBAbWV0aG9kIGxpbmVTdHlsZQogKiBAcGFyYW0gbGluZVdpZHRoIHtOdW1iZXJ9IHdpZHRoIG9mIHRoZSBsaW5lIHRvIGRyYXcsIHdpbGwgdXBkYXRlIHRoZSBvYmplY3QncyBzdG9yZWQgc3R5bGUKICogQHBhcmFtIGNvbG9yIHtOdW1iZXJ9IGNvbG9yIG9mIHRoZSBsaW5lIHRvIGRyYXcsIHdpbGwgdXBkYXRlIHRoZSBvYmplY3QncyBzdG9yZWQgc3R5bGUKICogQHBhcmFtIGFscGhhIHtOdW1iZXJ9IGFscGhhIG9mIHRoZSBsaW5lIHRvIGRyYXcsIHdpbGwgdXBkYXRlIHRoZSBvYmplY3QncyBzdG9yZWQgc3R5bGUKICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmxpbmVTdHlsZSA9IGZ1bmN0aW9uKGxpbmVXaWR0aCwgY29sb3IsIGFscGhhKQp7CglpZih0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGggPT0gMCl0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCgl0aGlzLmxpbmVXaWR0aCA9IGxpbmVXaWR0aCB8fCAwOwoJdGhpcy5saW5lQ29sb3IgPSBjb2xvciB8fCAwOwoJdGhpcy5saW5lQWxwaGEgPSAoYWxwaGEgPT0gdW5kZWZpbmVkKSA/IDEgOiBhbHBoYTsKCgl0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCgkJCQkJCWZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywgcG9pbnRzOltdLCB0eXBlOlBJWEkuR3JhcGhpY3MuUE9MWX07CgoJdGhpcy5ncmFwaGljc0RhdGEucHVzaCh0aGlzLmN1cnJlbnRQYXRoKTsKfQoKLyoqCiAqIE1vdmVzIHRoZSBjdXJyZW50IGRyYXdpbmcgcG9zaXRpb24gdG8gKHgsIHkpLgogKgogKiBAbWV0aG9kIG1vdmVUbwogKiBAcGFyYW0geCB7TnVtYmVyfSB0aGUgWCBjb29yZCB0byBtb3ZlIHRvCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IHRoZSBZIGNvb3JkIHRvIG1vdmUgdG8KICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLm1vdmVUbyA9IGZ1bmN0aW9uKHgsIHkpCnsKCWlmKHRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCA9PSAwKXRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKCXRoaXMuY3VycmVudFBhdGggPSB0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCgkJCQkJCWZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywgcG9pbnRzOltdLCB0eXBlOlBJWEkuR3JhcGhpY3MuUE9MWX07CgoJdGhpcy5jdXJyZW50UGF0aC5wb2ludHMucHVzaCh4LCB5KTsKCgl0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwp9CgovKioKICogRHJhd3MgYSBsaW5lIHVzaW5nIHRoZSBjdXJyZW50IGxpbmUgc3R5bGUgZnJvbSB0aGUgY3VycmVudCBkcmF3aW5nIHBvc2l0aW9uIHRvICh4LCB5KTsKICogdGhlIGN1cnJlbnQgZHJhd2luZyBwb3NpdGlvbiBpcyB0aGVuIHNldCB0byAoeCwgeSkuCiAqCiAqIEBtZXRob2QgbGluZVRvCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IHRoZSBYIGNvb3JkIHRvIGRyYXcgdG8KICogQHBhcmFtIHkge051bWJlcn0gdGhlIFkgY29vcmQgdG8gZHJhdyB0bwogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUubGluZVRvID0gZnVuY3Rpb24oeCwgeSkKewoJdGhpcy5jdXJyZW50UGF0aC5wb2ludHMucHVzaCh4LCB5KTsKCXRoaXMuZGlydHkgPSB0cnVlOwp9CgovKioKICogU3BlY2lmaWVzIGEgc2ltcGxlIG9uZS1jb2xvciBmaWxsIHRoYXQgc3Vic2VxdWVudCBjYWxscyB0byBvdGhlciBHcmFwaGljcyBtZXRob2RzCiAqIChzdWNoIGFzIGxpbmVUbygpIG9yIGRyYXdDaXJjbGUoKSkgdXNlIHdoZW4gZHJhd2luZy4KICoKICogQG1ldGhvZCBiZWdpbkZpbGwKICogQHBhcmFtIGNvbG9yIHt1aW50fSB0aGUgY29sb3Igb2YgdGhlIGZpbGwKICogQHBhcmFtIGFscGhhIHtOdW1iZXJ9IHRoZSBhbHBoYQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuYmVnaW5GaWxsID0gZnVuY3Rpb24oY29sb3IsIGFscGhhKQp7Cgl0aGlzLmZpbGxpbmcgPSB0cnVlOwoJdGhpcy5maWxsQ29sb3IgPSBjb2xvciB8fCAwOwoJdGhpcy5maWxsQWxwaGEgPSAoYWxwaGEgPT0gdW5kZWZpbmVkKSA/IDEgOiBhbHBoYTsKfQoKLyoqCiAqIEFwcGxpZXMgYSBmaWxsIHRvIHRoZSBsaW5lcyBhbmQgc2hhcGVzIHRoYXQgd2VyZSBhZGRlZCBzaW5jZSB0aGUgbGFzdCBjYWxsIHRvIHRoZSBiZWdpbkZpbGwoKSBtZXRob2QuCiAqCiAqIEBtZXRob2QgZW5kRmlsbAogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuZW5kRmlsbCA9IGZ1bmN0aW9uKCkKewoJdGhpcy5maWxsaW5nID0gZmFsc2U7Cgl0aGlzLmZpbGxDb2xvciA9IG51bGw7Cgl0aGlzLmZpbGxBbHBoYSA9IDE7Cn0KCi8qKgogKiBAbWV0aG9kIGRyYXdSZWN0CiAqCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSB0b3AtbGVmdCBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSB0b3AtbGVmdCBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSBUaGUgd2lkdGggb2YgdGhlIHJlY3RhbmdsZQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IFRoZSBoZWlnaHQgb2YgdGhlIHJlY3RhbmdsZQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuZHJhd1JlY3QgPSBmdW5jdGlvbiggeCwgeSwgd2lkdGgsIGhlaWdodCApCnsKCWlmKHRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCA9PSAwKXRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKCXRoaXMuY3VycmVudFBhdGggPSB7bGluZVdpZHRoOnRoaXMubGluZVdpZHRoLCBsaW5lQ29sb3I6dGhpcy5saW5lQ29sb3IsIGxpbmVBbHBoYTp0aGlzLmxpbmVBbHBoYSwKCQkJCQkJZmlsbENvbG9yOnRoaXMuZmlsbENvbG9yLCBmaWxsQWxwaGE6dGhpcy5maWxsQWxwaGEsIGZpbGw6dGhpcy5maWxsaW5nLAoJCQkJCQlwb2ludHM6W3gsIHksIHdpZHRoLCBoZWlnaHRdLCB0eXBlOlBJWEkuR3JhcGhpY3MuUkVDVH07CgoJdGhpcy5ncmFwaGljc0RhdGEucHVzaCh0aGlzLmN1cnJlbnRQYXRoKTsKCXRoaXMuZGlydHkgPSB0cnVlOwp9CgovKioKICogRHJhd3MgYSBjaXJjbGUuCiAqCiAqIEBtZXRob2QgZHJhd0NpcmNsZQogKiBAcGFyYW0geCB7TnVtYmVyfSBUaGUgWCBjb29yZCBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlCiAqIEBwYXJhbSByYWRpdXMge051bWJlcn0gVGhlIHJhZGl1cyBvZiB0aGUgY2lyY2xlCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5kcmF3Q2lyY2xlID0gZnVuY3Rpb24oIHgsIHksIHJhZGl1cykKewoJaWYodGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoID09IDApdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgoJdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAoJCQkJCQlmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCgkJCQkJCXBvaW50czpbeCwgeSwgcmFkaXVzLCByYWRpdXNdLCB0eXBlOlBJWEkuR3JhcGhpY3MuQ0lSQ307CgoJdGhpcy5ncmFwaGljc0RhdGEucHVzaCh0aGlzLmN1cnJlbnRQYXRoKTsKCXRoaXMuZGlydHkgPSB0cnVlOwp9CgovKioKICogRHJhd3MgYW4gZWxpcHNlLgogKgogKiBAbWV0aG9kIGRyYXdFbGlwc2UKICogQHBhcmFtIHgge051bWJlcn0KICogQHBhcmFtIHkge051bWJlcn0KICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9CiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0KICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdFbGlwc2UgPSBmdW5jdGlvbiggeCwgeSwgd2lkdGgsIGhlaWdodCkKewoJaWYodGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoID09IDApdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgoJdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAoJCQkJCQlmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCgkJCQkJCXBvaW50czpbeCwgeSwgd2lkdGgsIGhlaWdodF0sIHR5cGU6UElYSS5HcmFwaGljcy5FTElQfTsKCgl0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cn0KCi8qKgogKiBDbGVhcnMgdGhlIGdyYXBoaWNzIHRoYXQgd2VyZSBkcmF3biB0byB0aGlzIEdyYXBoaWNzIG9iamVjdCwgYW5kIHJlc2V0cyBmaWxsIGFuZCBsaW5lIHN0eWxlIHNldHRpbmdzLgogKgogKiBAbWV0aG9kIGNsZWFyCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkKewoJdGhpcy5saW5lV2lkdGggPSAwOwoJdGhpcy5maWxsaW5nID0gZmFsc2U7CgoJdGhpcy5kaXJ0eSA9IHRydWU7Cgl0aGlzLmNsZWFyRGlydHkgPSB0cnVlOwoJdGhpcy5ncmFwaGljc0RhdGEgPSBbXTsKCgl0aGlzLmJvdW5kcyA9IG51bGwvL25ldyBQSVhJLlJlY3RhbmdsZSgpOwp9CgoKUElYSS5HcmFwaGljcy5wcm90b3R5cGUudXBkYXRlRmlsdGVyQm91bmRzID0gZnVuY3Rpb24oKQp7CglpZighdGhpcy5ib3VuZHMpCgl7CgkJdmFyIG1pblggPSBJbmZpbml0eTsKCQl2YXIgbWF4WCA9IC1JbmZpbml0eTsKCgkJdmFyIG1pblkgPSBJbmZpbml0eTsKCQl2YXIgbWF4WSA9IC1JbmZpbml0eTsKCgkJdmFyIHBvaW50cywgeCwgeTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykgewoJCQkKCgkJCXZhciBkYXRhID0gdGhpcy5ncmFwaGljc0RhdGFbaV07CgkJCXZhciB0eXBlID0gZGF0YS50eXBlOwoJCQl2YXIgbGluZVdpZHRoID0gZGF0YS5saW5lV2lkdGg7CgoJCQlwb2ludHMgPSBkYXRhLnBvaW50czsKCgkJCWlmKHR5cGUgPT09IFBJWEkuR3JhcGhpY3MuUkVDVCkKCQkJewoJCQkJeCA9IHBvaW50cy54IC0gbGluZVdpZHRoLzI7CgkJCQl5ID0gcG9pbnRzLnkgLSBsaW5lV2lkdGgvMjsKCQkJCXZhciB3aWR0aCA9IHBvaW50cy53aWR0aCArIGxpbmVXaWR0aDsKCQkJCXZhciBoZWlnaHQgPSBwb2ludHMuaGVpZ2h0ICsgbGluZVdpZHRoOwoKCQkJCW1pblggPSB4IDwgbWluWCA/IHggOiBtaW5YOwoJCQkJbWF4WCA9IHggKyB3aWR0aCA+IG1heFggPyB4ICsgd2lkdGggOiBtYXhYOwoKCQkJCW1pblkgPSB5IDwgbWluWSA/IHggOiBtaW5ZOwoJCQkJbWF4WSA9IHkgKyBoZWlnaHQgPiBtYXhZID8geSArIGhlaWdodCA6IG1heFk7CgkJCX0KCQkJZWxzZSBpZih0eXBlID09PSBQSVhJLkdyYXBoaWNzLkNJUkMgfHwgdHlwZSA9PT0gUElYSS5HcmFwaGljcy5FTElQKQoJCQl7CgkJCQl4ID0gcG9pbnRzLng7CgkJCQl5ID0gcG9pbnRzLnk7CgkJCQl2YXIgcmFkaXVzID0gcG9pbnRzLnJhZGl1cyArIGxpbmVXaWR0aC8yOwoJCQkJCgkJCQltaW5YID0geCAtIHJhZGl1cyA8IG1pblggPyB4IC0gcmFkaXVzIDogbWluWDsKCQkJCW1heFggPSB4ICsgcmFkaXVzID4gbWF4WCA/IHggKyByYWRpdXMgOiBtYXhYOwoKCQkJCW1pblkgPSB5IC0gcmFkaXVzIDwgbWluWSA/IHkgLSByYWRpdXMgOiBtaW5ZOwoJCQkJbWF4WSA9IHkgKyByYWRpdXMgPiBtYXhZID8geSArIHJhZGl1cyA6IG1heFk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBQT0xZCgkJCQlmb3IgKHZhciBqID0gMDsgaiA8IHBvaW50cy5sZW5ndGg7IGorPTIpIAoJCQkJewoJCQkJCQoJCQkJCXggPSBwb2ludHNbal07CgkJCQkJeSA9IHBvaW50c1tqKzFdOwoKCQkJCQltaW5YID0geC1saW5lV2lkdGggPCBtaW5YID8geC1saW5lV2lkdGggOiBtaW5YOwoJCQkJCW1heFggPSB4K2xpbmVXaWR0aCA+IG1heFggPyB4K2xpbmVXaWR0aCA6IG1heFg7CgoJCQkJCW1pblkgPSB5LWxpbmVXaWR0aCA8IG1pblkgPyB5LWxpbmVXaWR0aCA6IG1pblk7CgkJCQkJbWF4WSA9IHkrbGluZVdpZHRoID4gbWF4WSA/IHkrbGluZVdpZHRoIDogbWF4WTsKCQkJCX07CgkJCX0KCgkJfTsKCgkJdGhpcy5ib3VuZHMgPSBuZXcgUElYSS5SZWN0YW5nbGUobWluWCwgbWluWSwgbWF4WCAtIG1pblgsIG1heFkgLSBtaW5ZKTsKCgl9CgovLwljb25zb2xlLmxvZyh0aGlzLmJvdW5kcyk7Cn0KCi8vIFNPTUUgVFlQRVM6ClBJWEkuR3JhcGhpY3MuUE9MWSA9IDA7ClBJWEkuR3JhcGhpY3MuUkVDVCA9IDE7ClBJWEkuR3JhcGhpY3MuQ0lSQyA9IDI7ClBJWEkuR3JhcGhpY3MuRUxJUCA9IDM7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBBIHNldCBvZiBmdW5jdGlvbnMgdXNlZCBieSB0aGUgY2FudmFzIHJlbmRlcmVyIHRvIGRyYXcgdGhlIHByaW1pdGl2ZSBncmFwaGljcyBkYXRhCiAqCiAqIEBjbGFzcyBDYW52YXNHcmFwaGljcwogKi8KUElYSS5DYW52YXNHcmFwaGljcyA9IGZ1bmN0aW9uKCkKewoKfQoKCi8qCiAqIFJlbmRlcnMgdGhlIGdyYXBoaWNzIG9iamVjdAogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgcmVuZGVyR3JhcGhpY3MKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIGNvbnRleHQge0NvbnRleHQyRH0KICovClBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MgPSBmdW5jdGlvbihncmFwaGljcywgY29udGV4dCkKewoJdmFyIHdvcmxkQWxwaGEgPSBncmFwaGljcy53b3JsZEFscGhhOwoKCWZvciAodmFyIGk9MDsgaSA8IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykKCXsKCQl2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKCQl2YXIgcG9pbnRzID0gZGF0YS5wb2ludHM7CgoJCWNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmxpbmVDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKCgkJY29udGV4dC5saW5lV2lkdGggPSBkYXRhLmxpbmVXaWR0aDsKCgkJaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuUE9MWSkKCQl7CgkJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgoJCQljb250ZXh0Lm1vdmVUbyhwb2ludHNbMF0sIHBvaW50c1sxXSk7CgoJCQlmb3IgKHZhciBqPTE7IGogPCBwb2ludHMubGVuZ3RoLzI7IGorKykKCQkJewoJCQkJY29udGV4dC5saW5lVG8ocG9pbnRzW2ogKiAyXSwgcG9pbnRzW2ogKiAyICsgMV0pOwoJCQl9CgoJICAgICAgCS8vIGlmIHRoZSBmaXJzdCBhbmQgbGFzdCBwb2ludCBhcmUgdGhlIHNhbWUgY2xvc2UgdGhlIHBhdGggLSBtdWNoIG5lYXRlciA6KQoJICAgICAgCWlmKHBvaW50c1swXSA9PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0yXSAmJiBwb2ludHNbMV0gPT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMV0pCgkgICAgICAJewoJICAgICAgCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJICAgICAgCX0KCgkJCWlmKGRhdGEuZmlsbCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKCQkJCWNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CiAgICAgIAkJCWNvbnRleHQuZmlsbCgpOwoJCQl9CgkJCWlmKGRhdGEubGluZVdpZHRoKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5saW5lQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAJCQljb250ZXh0LnN0cm9rZSgpOwoJCQl9CgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuUkVDVCkKCQl7CgoJCQlpZihkYXRhLmZpbGxDb2xvciB8fCBkYXRhLmZpbGxDb2xvciA9PT0gMCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKCQkJCWNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CgkJCQljb250ZXh0LmZpbGxSZWN0KHBvaW50c1swXSwgcG9pbnRzWzFdLCBwb2ludHNbMl0sIHBvaW50c1szXSk7CgoJCQl9CgkJCWlmKGRhdGEubGluZVdpZHRoKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5saW5lQWxwaGEgKiB3b3JsZEFscGhhOwoJCQkJY29udGV4dC5zdHJva2VSZWN0KHBvaW50c1swXSwgcG9pbnRzWzFdLCBwb2ludHNbMl0sIHBvaW50c1szXSk7CgkJCX0KCgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuQ0lSQykKCQl7CgkJCS8vIFRPRE8gLSBuZWVkIHRvIGJlIFVuZGVmaW5lZCEKICAgICAgCQljb250ZXh0LmJlZ2luUGF0aCgpOwoJCQljb250ZXh0LmFyYyhwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLDAsMipNYXRoLlBJKTsKCQkJY29udGV4dC5jbG9zZVBhdGgoKTsKCgkJCWlmKGRhdGEuZmlsbCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKCQkJCWNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CiAgICAgIAkJCWNvbnRleHQuZmlsbCgpOwoJCQl9CgkJCWlmKGRhdGEubGluZVdpZHRoKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5saW5lQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAJCQljb250ZXh0LnN0cm9rZSgpOwoJCQl9CgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuRUxJUCkKCQl7CgoJCQkvLyBlbGlwc2UgY29kZSB0YWtlbiBmcm9tOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzIxNzI3OTgvaG93LXRvLWRyYXctYW4tb3ZhbC1pbi1odG1sNS1jYW52YXMKCgkJCXZhciBlbGlwc2VEYXRhID0gIGRhdGEucG9pbnRzOwoKCQkJdmFyIHcgPSBlbGlwc2VEYXRhWzJdICogMjsKCQkJdmFyIGggPSBlbGlwc2VEYXRhWzNdICogMjsKCgkJCXZhciB4ID0gZWxpcHNlRGF0YVswXSAtIHcvMjsKCQkJdmFyIHkgPSBlbGlwc2VEYXRhWzFdIC0gaC8yOwoKICAgICAgCQljb250ZXh0LmJlZ2luUGF0aCgpOwoKCQkJdmFyIGthcHBhID0gLjU1MjI4NDgsCgkJCW94ID0gKHcgLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCgkJCW95ID0gKGggLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCB2ZXJ0aWNhbAoJCQl4ZSA9IHggKyB3LCAgICAgICAgICAgLy8geC1lbmQKCQkJeWUgPSB5ICsgaCwgICAgICAgICAgIC8vIHktZW5kCgkJCXhtID0geCArIHcgLyAyLCAgICAgICAvLyB4LW1pZGRsZQoJCQl5bSA9IHkgKyBoIC8gMjsgICAgICAgLy8geS1taWRkbGUKCgkJCWNvbnRleHQubW92ZVRvKHgsIHltKTsKCQkJY29udGV4dC5iZXppZXJDdXJ2ZVRvKHgsIHltIC0gb3ksIHhtIC0gb3gsIHksIHhtLCB5KTsKCQkJY29udGV4dC5iZXppZXJDdXJ2ZVRvKHhtICsgb3gsIHksIHhlLCB5bSAtIG95LCB4ZSwgeW0pOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeGUsIHltICsgb3ksIHhtICsgb3gsIHllLCB4bSwgeWUpOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeG0gLSBveCwgeWUsIHgsIHltICsgb3ksIHgsIHltKTsKCgkJCWNvbnRleHQuY2xvc2VQYXRoKCk7CgoJCQlpZihkYXRhLmZpbGwpCgkJCXsKCQkJCWNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmZpbGxBbHBoYSAqIHdvcmxkQWxwaGE7CgkJCQljb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEuZmlsbENvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwogICAgICAJCQljb250ZXh0LmZpbGwoKTsKCQkJfQoJCQlpZihkYXRhLmxpbmVXaWR0aCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEubGluZUFscGhhICogd29ybGRBbHBoYTsKICAgICAgCQkJY29udGV4dC5zdHJva2UoKTsKCQkJfQoJCX0KCgl9Owp9CgovKgogKiBSZW5kZXJzIGEgZ3JhcGhpY3MgbWFzawogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgcmVuZGVyR3JhcGhpY3NNYXNrCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSBjb250ZXh0IHtDb250ZXh0MkR9CiAqLwpQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBjb250ZXh0KQp7Cgl2YXIgd29ybGRBbHBoYSA9IGdyYXBoaWNzLndvcmxkQWxwaGE7CgoJdmFyIGxlbiA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7CglpZihsZW4gPT09IDApcmV0dXJuOwoKCWlmKGxlbiA+IDEpCgl7CgkJbGVuID0gMTsKCQljb25zb2xlLmxvZygiUGl4aS5qcyB3YXJuaW5nOiBtYXNrcyBpbiBjYW52YXMgY2FuIG9ubHkgbWFzayB1c2luZyB0aGUgZmlyc3QgcGF0aCBpbiB0aGUgZ3JhcGhpY3Mgb2JqZWN0IikKCX0KCglmb3IgKHZhciBpPTA7IGkgPCAxOyBpKyspCgl7CgkJdmFyIGRhdGEgPSBncmFwaGljcy5ncmFwaGljc0RhdGFbaV07CgkJdmFyIHBvaW50cyA9IGRhdGEucG9pbnRzOwoKCQlpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5QT0xZKQoJCXsKCQkJY29udGV4dC5iZWdpblBhdGgoKTsKCQkJY29udGV4dC5tb3ZlVG8ocG9pbnRzWzBdLCBwb2ludHNbMV0pOwoKCQkJZm9yICh2YXIgaj0xOyBqIDwgcG9pbnRzLmxlbmd0aC8yOyBqKyspCgkJCXsKCQkJCWNvbnRleHQubGluZVRvKHBvaW50c1tqICogMl0sIHBvaW50c1tqICogMiArIDFdKTsKCQkJfQoKCSAgICAgIAkvLyBpZiB0aGUgZmlyc3QgYW5kIGxhc3QgcG9pbnQgYXJlIHRoZSBzYW1lIGNsb3NlIHRoZSBwYXRoIC0gbXVjaCBuZWF0ZXIgOikKCSAgICAgIAlpZihwb2ludHNbMF0gPT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMl0gJiYgcG9pbnRzWzFdID09IHBvaW50c1twb2ludHMubGVuZ3RoLTFdKQoJICAgICAgCXsKCSAgICAgIAkJY29udGV4dC5jbG9zZVBhdGgoKTsKCSAgICAgIAl9CgoJCX0KCQllbHNlIGlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCgkJewoJCQljb250ZXh0LmJlZ2luUGF0aCgpOwoJCQljb250ZXh0LnJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKCQkJY29udGV4dC5jbG9zZVBhdGgoKTsKCQl9CgkJZWxzZSBpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5DSVJDKQoJCXsKCQkJLy8gVE9ETyAtIG5lZWQgdG8gYmUgVW5kZWZpbmVkIQogICAgICAJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgkJCWNvbnRleHQuYXJjKHBvaW50c1swXSwgcG9pbnRzWzFdLCBwb2ludHNbMl0sMCwyKk1hdGguUEkpOwoJCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJCX0KCQllbHNlIGlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLkVMSVApCgkJewoKCQkJLy8gZWxpcHNlIGNvZGUgdGFrZW4gZnJvbTogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8yMTcyNzk4L2hvdy10by1kcmF3LWFuLW92YWwtaW4taHRtbDUtY2FudmFzCgkJCXZhciBlbGlwc2VEYXRhID0gIGRhdGEucG9pbnRzOwoKCQkJdmFyIHcgPSBlbGlwc2VEYXRhWzJdICogMjsKCQkJdmFyIGggPSBlbGlwc2VEYXRhWzNdICogMjsKCgkJCXZhciB4ID0gZWxpcHNlRGF0YVswXSAtIHcvMjsKCQkJdmFyIHkgPSBlbGlwc2VEYXRhWzFdIC0gaC8yOwoKICAgICAgCQljb250ZXh0LmJlZ2luUGF0aCgpOwoKCQkJdmFyIGthcHBhID0gLjU1MjI4NDgsCgkJCW94ID0gKHcgLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCBob3Jpem9udGFsCgkJCW95ID0gKGggLyAyKSAqIGthcHBhLCAvLyBjb250cm9sIHBvaW50IG9mZnNldCB2ZXJ0aWNhbAoJCQl4ZSA9IHggKyB3LCAgICAgICAgICAgLy8geC1lbmQKCQkJeWUgPSB5ICsgaCwgICAgICAgICAgIC8vIHktZW5kCgkJCXhtID0geCArIHcgLyAyLCAgICAgICAvLyB4LW1pZGRsZQoJCQl5bSA9IHkgKyBoIC8gMjsgICAgICAgLy8geS1taWRkbGUKCgkJCWNvbnRleHQubW92ZVRvKHgsIHltKTsKCQkJY29udGV4dC5iZXppZXJDdXJ2ZVRvKHgsIHltIC0gb3ksIHhtIC0gb3gsIHksIHhtLCB5KTsKCQkJY29udGV4dC5iZXppZXJDdXJ2ZVRvKHhtICsgb3gsIHksIHhlLCB5bSAtIG95LCB4ZSwgeW0pOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeGUsIHltICsgb3ksIHhtICsgb3gsIHllLCB4bSwgeWUpOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeG0gLSBveCwgeWUsIHgsIHltICsgb3ksIHgsIHltKTsKCQkJY29udGV4dC5jbG9zZVBhdGgoKTsKCQl9CgoKCX07Cn0KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIHRoZSBDYW52YXNSZW5kZXJlciBkcmF3cyB0aGUgc3RhZ2UgYW5kIGFsbCBpdHMgY29udGVudCBvbnRvIGEgMmQgY2FudmFzLiBUaGlzIHJlbmRlcmVyIHNob3VsZCBiZSB1c2VkIGZvciBicm93c2VycyB0aGF0IGRvIG5vdCBzdXBwb3J0IHdlYkdMLgogKiBEb250IGZvcmdldCB0byBhZGQgdGhlIHZpZXcgdG8geW91ciBET00gb3IgeW91IHdpbGwgbm90IHNlZSBhbnl0aGluZyA6KQogKgogKiBAY2xhc3MgQ2FudmFzUmVuZGVyZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB3aWR0aD0wIHtOdW1iZXJ9IHRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIGhlaWdodD0wIHtOdW1iZXJ9IHRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSB2aWV3IHtDYW52YXN9IHRoZSBjYW52YXMgdG8gdXNlIGFzIGEgdmlldywgb3B0aW9uYWwKICogQHBhcmFtIHRyYW5zcGFyZW50PWZhbHNlIHtCb29sZWFufSB0aGUgdHJhbnNwYXJlbmN5IG9mIHRoZSByZW5kZXIgdmlldywgZGVmYXVsdCBmYWxzZQogKi8KUElYSS5DYW52YXNSZW5kZXJlciA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQsIHZpZXcsIHRyYW5zcGFyZW50KQp7Cgl0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQ7CgoJLyoqCgkgKiBUaGUgd2lkdGggb2YgdGhlIGNhbnZhcyB2aWV3CgkgKgoJICogQHByb3BlcnR5IHdpZHRoCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDgwMAoJICovCgl0aGlzLndpZHRoID0gd2lkdGggfHwgODAwOwoKCS8qKgoJICogVGhlIGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKCSAqCgkgKiBAcHJvcGVydHkgaGVpZ2h0CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDYwMAoJICovCgl0aGlzLmhlaWdodCA9IGhlaWdodCB8fCA2MDA7CgoJLyoqCgkgKiBUaGUgY2FudmFzIGVsZW1lbnQgdGhhdCB0aGUgZXZlcnl0aGluZyBpcyBkcmF3biB0bwoJICoKCSAqIEBwcm9wZXJ0eSB2aWV3CgkgKiBAdHlwZSBDYW52YXMKCSAqLwoJdGhpcy52aWV3ID0gdmlldyB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnY2FudmFzJyApOwoKCS8qKgoJICogVGhlIGNhbnZhcyBjb250ZXh0IHRoYXQgdGhlIGV2ZXJ5dGhpbmcgaXMgZHJhd24gdG8KCSAqIEBwcm9wZXJ0eSBjb250ZXh0CgkgKiBAdHlwZSBDYW52YXMgMmQgQ29udGV4dAoJICovCgl0aGlzLmNvbnRleHQgPSB0aGlzLnZpZXcuZ2V0Q29udGV4dCgiMmQiKTsKCgl0aGlzLnJlZnJlc2ggPSB0cnVlOwoJLy8gaGFjayB0byBlbmFibGUgc29tZSBoYXJkd2FyZSBhY2NlbGVyYXRpb24hCgkvL3RoaXMudmlldy5zdHlsZVsidHJhbnNmb3JtIl0gPSAidHJhbnNsYXRleigwKSI7CgkKICAgIHRoaXMudmlldy53aWR0aCA9IHRoaXMud2lkdGg7Cgl0aGlzLnZpZXcuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7ICAKCXRoaXMuY291bnQgPSAwOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQ2FudmFzUmVuZGVyZXI7CgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIGNhbnZhcyB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBzdGFnZSB7U3RhZ2V9IHRoZSBTdGFnZSBlbGVtZW50IHRvIGJlIHJlbmRlcmVkCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFnZSkKewoJCgkvL3N0YWdlLl9fY2hpbGRyZW5BZGRlZCA9IFtdOwoJLy9zdGFnZS5fX2NoaWxkcmVuUmVtb3ZlZCA9IFtdOwoJCgkvLyB1cGRhdGUgdGV4dHVyZXMgaWYgbmVlZCBiZQoJUElYSS50ZXh0dXJlc1RvVXBkYXRlID0gW107CglQSVhJLnRleHR1cmVzVG9EZXN0cm95ID0gW107CgkKCVBJWEkudmlzaWJsZUNvdW50Kys7CglzdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCQoJLy8gdXBkYXRlIHRoZSBiYWNrZ3JvdW5kIGNvbG9yCglpZih0aGlzLnZpZXcuc3R5bGUuYmFja2dyb3VuZENvbG9yIT1zdGFnZS5iYWNrZ3JvdW5kQ29sb3JTdHJpbmcgJiYgIXRoaXMudHJhbnNwYXJlbnQpdGhpcy52aWV3LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHN0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZzsKCgl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsMCwwLDEsMCwwKTsgCgl0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KQogICAgdGhpcy5yZW5kZXJEaXNwbGF5T2JqZWN0KHN0YWdlKTsKICAgIC8vYXMKICAgCiAgICAvLyBydW4gaW50ZXJhY3Rpb24hCglpZihzdGFnZS5pbnRlcmFjdGl2ZSkKCXsKCQkvL25lZWQgdG8gYWRkIHNvbWUgZXZlbnRzIQoJCWlmKCFzdGFnZS5faW50ZXJhY3RpdmVFdmVudHNBZGRlZCkKCQl7CgkJCXN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkID0gdHJ1ZTsKCQkJc3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnNldFRhcmdldCh0aGlzKTsKCQl9Cgl9CgkKCS8vIHJlbW92ZSBmcmFtZSB1cGRhdGVzLi4KCWlmKFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID4gMCkKCXsKCQlQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzID0gW107Cgl9CgkKCQp9CgovKioKICogcmVzaXplcyB0aGUgY2FudmFzIHZpZXcgdG8gdGhlIHNwZWNpZmllZCB3aWR0aCBhbmQgaGVpZ2h0CiAqCiAqIEBtZXRob2QgcmVzaXplCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSB0aGUgbmV3IHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IHRoZSBuZXcgaGVpZ2h0IG9mIHRoZSBjYW52YXMgdmlldwogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoJdGhpcy53aWR0aCA9IHdpZHRoOwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgkKCXRoaXMudmlldy53aWR0aCA9IHdpZHRoOwoJdGhpcy52aWV3LmhlaWdodCA9IGhlaWdodDsKfQoKLyoqCiAqIFJlbmRlcnMgYSBkaXNwbGF5IG9iamVjdAogKgogKiBAbWV0aG9kIHJlbmRlckRpc3BsYXlPYmplY3QKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBkaXNwbGF5T2JqZWN0IHRvIHJlbmRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRGlzcGxheU9iamVjdCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIG5vIGxvZ2VyIHJlY3VycnNpdmUhCgl2YXIgdHJhbnNmb3JtOwoJdmFyIGNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgkKCWNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gJ3NvdXJjZS1vdmVyJzsKCQoJLy8gb25lIHRoZSBkaXNwbGF5IG9iamVjdCBoaXRzIHRoaXMuIHdlIGNhbiBicmVhayB0aGUgbG9vcAkKCXZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJCglkbwkKCXsKCQl0cmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoJCQoJCWlmKCFkaXNwbGF5T2JqZWN0LnZpc2libGUpCgkJewoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCQkJY29udGludWU7CgkJfQoJCQoJCWlmKCFkaXNwbGF5T2JqZWN0LnJlbmRlcmFibGUpCgkJewoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CgkJCWNvbnRpbnVlOwoJCX0KCQkKCQlpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJewoJCQkJCgkJCXZhciBmcmFtZSA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZTsKCQkJCgkJCWlmKGZyYW1lICYmIGZyYW1lLndpZHRoICYmIGZyYW1lLmhlaWdodCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCQkJCQoJCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSk7CgkJCQkJCgkJCQljb250ZXh0LmRyYXdJbWFnZShkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCAKCQkJCQkJCQkgICBmcmFtZS54LAoJCQkJCQkJCSAgIGZyYW1lLnksCgkJCQkJCQkJICAgZnJhbWUud2lkdGgsCgkJCQkJCQkJICAgZnJhbWUuaGVpZ2h0LAoJCQkJCQkJCSAgIChkaXNwbGF5T2JqZWN0LmFuY2hvci54KSAqIC1mcmFtZS53aWR0aCwgCgkJCQkJCQkJICAgKGRpc3BsYXlPYmplY3QuYW5jaG9yLnkpICogLWZyYW1lLmhlaWdodCwKCQkJCQkJCQkgICBmcmFtZS53aWR0aCwKCQkJCQkJCQkgICBmcmFtZS5oZWlnaHQpOwoJCQl9CQkJCQkgICAKCSAgIAl9CgkgICAJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TdHJpcCkKCQl7CgkJCWNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pCgkJCXRoaXMucmVuZGVyU3RyaXAoZGlzcGxheU9iamVjdCk7CgkJfQoJCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuVGlsaW5nU3ByaXRlKQoJCXsKCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSkKCQkJdGhpcy5yZW5kZXJUaWxpbmdTcHJpdGUoZGlzcGxheU9iamVjdCk7CgkJfQoJCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuQ3VzdG9tUmVuZGVyYWJsZSkKCQl7CgkJCWNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pOwoJCQlkaXNwbGF5T2JqZWN0LnJlbmRlckNhbnZhcyh0aGlzKTsKCQl9CgkJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKCQl7CgkJCWNvbnRleHQuc2V0VHJhbnNmb3JtKHRyYW5zZm9ybVswXSwgdHJhbnNmb3JtWzNdLCB0cmFuc2Zvcm1bMV0sIHRyYW5zZm9ybVs0XSwgdHJhbnNmb3JtWzJdLCB0cmFuc2Zvcm1bNV0pCgkJCVBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MoZGlzcGxheU9iamVjdCwgY29udGV4dCk7CgkJfQoJCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuRmlsdGVyQmxvY2spCgkJewoJCQlpZihkaXNwbGF5T2JqZWN0LmRhdGEgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQogCQkJewoJCQkJdmFyIG1hc2sgPSBkaXNwbGF5T2JqZWN0LmRhdGE7CgoJCQkJaWYoZGlzcGxheU9iamVjdC5vcGVuKQoJCQkJewoJCQkJCWNvbnRleHQuc2F2ZSgpOwoJCQkJCQoJCQkJCXZhciBjYWNoZUFscGhhID0gbWFzay5hbHBoYTsKCQkJCQl2YXIgbWFza1RyYW5zZm9ybSA9IG1hc2sud29ybGRUcmFuc2Zvcm07CgkJCQkJCgkJCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0obWFza1RyYW5zZm9ybVswXSwgbWFza1RyYW5zZm9ybVszXSwgbWFza1RyYW5zZm9ybVsxXSwgbWFza1RyYW5zZm9ybVs0XSwgbWFza1RyYW5zZm9ybVsyXSwgbWFza1RyYW5zZm9ybVs1XSkKCQkJCQkKCQkJCQltYXNrLndvcmxkQWxwaGEgPSAwLjU7CgkJCQkJCgkJCQkJY29udGV4dC53b3JsZEFscGhhID0gMDsKCQkJCQkKCQkJCQlQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayhtYXNrLCBjb250ZXh0KTsKCQkJCQljb250ZXh0LmNsaXAoKTsKCQkJCQkKCQkJCQltYXNrLndvcmxkQWxwaGEgPSBjYWNoZUFscGhhOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWNvbnRleHQucmVzdG9yZSgpOwoJCQkJfQoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8gb25seSBtYXNrcyBzdXBwb3J0ZWQgcmlnaHQgbm93IQoJCQl9CgkJfQoJLy8JY291bnQrKwoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCQkKCQkKCX0KCXdoaWxlKGRpc3BsYXlPYmplY3QgIT0gdGVzdE9iamVjdCkKCgkKfQoKLyoqCiAqIFJlbmRlcnMgYSBmbGF0IHN0cmlwCiAqCiAqIEBtZXRob2QgcmVuZGVyU3RyaXBGbGF0CiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBTdHJpcCB0byByZW5kZXIKICogQHByaXZhdGUKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclN0cmlwRmxhdCA9IGZ1bmN0aW9uKHN0cmlwKQp7Cgl2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCXZhciB2ZXJ0aWNpZXMgPSBzdHJpcC52ZXJ0aWNpZXM7Cgl2YXIgdXZzID0gc3RyaXAudXZzOwoJCgl2YXIgbGVuZ3RoID0gdmVydGljaWVzLmxlbmd0aC8yOwoJdGhpcy5jb3VudCsrOwoJCgljb250ZXh0LmJlZ2luUGF0aCgpOwoJZm9yICh2YXIgaT0xOyBpIDwgbGVuZ3RoLTI7IGkrKykgCgl7CgkJCgkJLy8gZHJhdyBzb21lIHRyaWFuZ2xlcyEKCQl2YXIgaW5kZXggPSBpKjI7CgkJCgkJIHZhciB4MCA9IHZlcnRpY2llc1tpbmRleF0sICAgeDEgPSB2ZXJ0aWNpZXNbaW5kZXgrMl0sIHgyID0gdmVydGljaWVzW2luZGV4KzRdOwogCQkgdmFyIHkwID0gdmVydGljaWVzW2luZGV4KzFdLCB5MSA9IHZlcnRpY2llc1tpbmRleCszXSwgeTIgPSB2ZXJ0aWNpZXNbaW5kZXgrNV07CiAJCSAKCQljb250ZXh0Lm1vdmVUbyh4MCwgeTApOwoJCWNvbnRleHQubGluZVRvKHgxLCB5MSk7CgkJY29udGV4dC5saW5lVG8oeDIsIHkyKTsKCQkKCX07CQoJCgljb250ZXh0LmZpbGxTdHlsZSA9ICIjRkYwMDAwIjsKCWNvbnRleHQuZmlsbCgpOwoJY29udGV4dC5jbG9zZVBhdGgoKTsKfQoKLyoqCiAqIFJlbmRlcnMgYSB0aWxpbmcgc3ByaXRlCiAqCiAqIEBtZXRob2QgcmVuZGVyVGlsaW5nU3ByaXRlCiAqIEBwYXJhbSBzcHJpdGUge1RpbGluZ1Nwcml0ZX0gVGhlIHRpbGluZ3Nwcml0ZSB0byByZW5kZXIKICogQHByaXZhdGUKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclRpbGluZ1Nwcml0ZSA9IGZ1bmN0aW9uKHNwcml0ZSkKewoJdmFyIGNvbnRleHQgPSB0aGlzLmNvbnRleHQ7CgkKCWNvbnRleHQuZ2xvYmFsQWxwaGEgPSBzcHJpdGUud29ybGRBbHBoYTsKCQogCWlmKCFzcHJpdGUuX190aWxlUGF0dGVybikgc3ByaXRlLl9fdGlsZVBhdHRlcm4gPSBjb250ZXh0LmNyZWF0ZVBhdHRlcm4oc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCAicmVwZWF0Iik7CiAJCgljb250ZXh0LmJlZ2luUGF0aCgpOwoJCgl2YXIgdGlsZVBvc2l0aW9uID0gc3ByaXRlLnRpbGVQb3NpdGlvbjsKCXZhciB0aWxlU2NhbGUgPSBzcHJpdGUudGlsZVNjYWxlOwoJCiAgICAvLyBvZmZzZXQKICAgIGNvbnRleHQuc2NhbGUodGlsZVNjYWxlLngsdGlsZVNjYWxlLnkpOwogICAgY29udGV4dC50cmFuc2xhdGUodGlsZVBvc2l0aW9uLngsIHRpbGVQb3NpdGlvbi55KTsKIAkKCWNvbnRleHQuZmlsbFN0eWxlID0gc3ByaXRlLl9fdGlsZVBhdHRlcm47Cgljb250ZXh0LmZpbGxSZWN0KC10aWxlUG9zaXRpb24ueCwtdGlsZVBvc2l0aW9uLnksc3ByaXRlLndpZHRoIC8gdGlsZVNjYWxlLngsIHNwcml0ZS5oZWlnaHQgLyB0aWxlU2NhbGUueSk7CgkKCWNvbnRleHQuc2NhbGUoMS90aWxlU2NhbGUueCwgMS90aWxlU2NhbGUueSk7CiAgICBjb250ZXh0LnRyYW5zbGF0ZSgtdGlsZVBvc2l0aW9uLngsIC10aWxlUG9zaXRpb24ueSk7CiAgICAKICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7Cn0KCi8qKgogKiBSZW5kZXJzIGEgc3RyaXAKICoKICogQG1ldGhvZCByZW5kZXJTdHJpcAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgU3RyaXAgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJTdHJpcCA9IGZ1bmN0aW9uKHN0cmlwKQp7Cgl2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCgkvLyBkcmF3IHRyaWFuZ2xlcyEhCgl2YXIgdmVydGljaWVzID0gc3RyaXAudmVydGljaWVzOwoJdmFyIHV2cyA9IHN0cmlwLnV2czsKCQoJdmFyIGxlbmd0aCA9IHZlcnRpY2llcy5sZW5ndGgvMjsKCXRoaXMuY291bnQrKzsKCWZvciAodmFyIGk9MTsgaSA8IGxlbmd0aC0yOyBpKyspIAoJewoJCQoJCS8vIGRyYXcgc29tZSB0cmlhbmdsZXMhCgkJdmFyIGluZGV4ID0gaSoyOwoJCQoJCSB2YXIgeDAgPSB2ZXJ0aWNpZXNbaW5kZXhdLCAgIHgxID0gdmVydGljaWVzW2luZGV4KzJdLCB4MiA9IHZlcnRpY2llc1tpbmRleCs0XTsKIAkJIHZhciB5MCA9IHZlcnRpY2llc1tpbmRleCsxXSwgeTEgPSB2ZXJ0aWNpZXNbaW5kZXgrM10sIHkyID0gdmVydGljaWVzW2luZGV4KzVdOwogCQkgCiAgCQkgdmFyIHUwID0gdXZzW2luZGV4XSAqIHN0cmlwLnRleHR1cmUud2lkdGgsICAgdTEgPSB1dnNbaW5kZXgrMl0gKiBzdHJpcC50ZXh0dXJlLndpZHRoLCB1MiA9IHV2c1tpbmRleCs0XSogc3RyaXAudGV4dHVyZS53aWR0aDsKICAgCQkgdmFyIHYwID0gdXZzW2luZGV4KzFdKiBzdHJpcC50ZXh0dXJlLmhlaWdodCwgdjEgPSB1dnNbaW5kZXgrM10gKiBzdHJpcC50ZXh0dXJlLmhlaWdodCwgdjIgPSB1dnNbaW5kZXgrNV0qIHN0cmlwLnRleHR1cmUuaGVpZ2h0OwoKCgkJY29udGV4dC5zYXZlKCk7CgkJY29udGV4dC5iZWdpblBhdGgoKTsKCQljb250ZXh0Lm1vdmVUbyh4MCwgeTApOwoJCWNvbnRleHQubGluZVRvKHgxLCB5MSk7CgkJY29udGV4dC5saW5lVG8oeDIsIHkyKTsKCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJCQoJCWNvbnRleHQuY2xpcCgpOwoJCQoJCQogICAgICAgIC8vIENvbXB1dGUgbWF0cml4IHRyYW5zZm9ybQogICAgICAgIHZhciBkZWx0YSA9IHUwKnYxICsgdjAqdTIgKyB1MSp2MiAtIHYxKnUyIC0gdjAqdTEgLSB1MCp2MjsKICAgICAgICB2YXIgZGVsdGFfYSA9IHgwKnYxICsgdjAqeDIgKyB4MSp2MiAtIHYxKngyIC0gdjAqeDEgLSB4MCp2MjsKICAgICAgICB2YXIgZGVsdGFfYiA9IHUwKngxICsgeDAqdTIgKyB1MSp4MiAtIHgxKnUyIC0geDAqdTEgLSB1MCp4MjsKICAgICAgICB2YXIgZGVsdGFfYyA9IHUwKnYxKngyICsgdjAqeDEqdTIgKyB4MCp1MSp2MiAtIHgwKnYxKnUyIC0gdjAqdTEqeDIgLSB1MCp4MSp2MjsKICAgICAgICB2YXIgZGVsdGFfZCA9IHkwKnYxICsgdjAqeTIgKyB5MSp2MiAtIHYxKnkyIC0gdjAqeTEgLSB5MCp2MjsKICAgICAgICB2YXIgZGVsdGFfZSA9IHUwKnkxICsgeTAqdTIgKyB1MSp5MiAtIHkxKnUyIC0geTAqdTEgLSB1MCp5MjsKICAgICAgICB2YXIgZGVsdGFfZiA9IHUwKnYxKnkyICsgdjAqeTEqdTIgKyB5MCp1MSp2MiAtIHkwKnYxKnUyIC0gdjAqdTEqeTIgLSB1MCp5MSp2MjsKCQkKCQkKCQkKCQkgICAgCiAgICAgICAgY29udGV4dC50cmFuc2Zvcm0oZGVsdGFfYS9kZWx0YSwgZGVsdGFfZC9kZWx0YSwKICAgICAgICAgICAgICAgICAgICAgIGRlbHRhX2IvZGVsdGEsIGRlbHRhX2UvZGVsdGEsCiAgICAgICAgICAgICAgICAgICAgICBkZWx0YV9jL2RlbHRhLCBkZWx0YV9mL2RlbHRhKTsKICAgICAgICAgICAgICAgICAKCQljb250ZXh0LmRyYXdJbWFnZShzdHJpcC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSwgMCwgMCk7CgkgIAljb250ZXh0LnJlc3RvcmUoKTsKCX07CgkKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKiBAYXV0aG9yIFJpY2hhcmQgRGF2ZXkgaHR0cDovL3d3dy5waG90b25zdG9ybS5jb20gQHBob3RvbnN0b3JtCiAqLwoKLyoqCiogQGNsYXNzIFBJWEkuUGl4aVNoYWRlcgoqIEBjb25zdHJ1Y3RvcgoqLwpQSVhJLlBpeGlTaGFkZXIgPSBmdW5jdGlvbigpCnsKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FueX0gcHJvZ3JhbSAtIFRoZSBXZWJHTCBwcm9ncmFtLgogICAgKi8KICAgIHRoaXMucHJvZ3JhbTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGZyYWdtZW50U3JjIC0gVGhlIGZyYWdtZW50IHNoYWRlci4KICAgICovCiAgICB0aGlzLmZyYWdtZW50U3JjID0gWwogICAgICAgICJwcmVjaXNpb24gbG93cCBmbG9hdDsiLAogICAgICAgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAogICAgICAgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAogICAgICAgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAogICAgICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCiAgICAgICAgICAgICJnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQpICogdkNvbG9yOyIsCiAgICAgICAgIn0iCiAgICBdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGV4dHVyZUNvdW50IC0gQSBsb2NhbCB0ZXh0dXJlIGNvdW50ZXIgZm9yIG11bHRpLXRleHR1cmUgc2hhZGVycy4KICAgICovCiAgICB0aGlzLnRleHR1cmVDb3VudCA9IDA7CiAgICAKfQoKLyoqCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjaW5pdAoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpCnsKICAgIHZhciBwcm9ncmFtID0gUElYSS5jb21waWxlUHJvZ3JhbSh0aGlzLnZlcnRleFNyYyB8fCBQSVhJLlBpeGlTaGFkZXIuZGVmYXVsdFZlcnRleFNyYywgdGhpcy5mcmFnbWVudFNyYykKICAgIAogICAgdmFyIGdsID0gUElYSS5nbDsKCiAgICBnbC51c2VQcm9ncmFtKHByb2dyYW0pOwogICAgCiAgICAvLyBnZXQgYW5kIHN0b3JlIHRoZSB1bmlmb3JtcyBmb3IgdGhlIHNoYWRlcgogICAgdGhpcy51U2FtcGxlciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAidVNhbXBsZXIiKTsKICAgIHRoaXMucHJvamVjdGlvblZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAicHJvamVjdGlvblZlY3RvciIpOwogICAgdGhpcy5vZmZzZXRWZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgIm9mZnNldFZlY3RvciIpOwogICAgLy8gdGhpcy5kaW1lbnNpb25zID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJkaW1lbnNpb25zIik7CiAgICAKICAgIC8vIGdldCBhbmQgc3RvcmUgdGhlIGF0dHJpYnV0ZXMKICAgIHRoaXMuYVZlcnRleFBvc2l0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFWZXJ0ZXhQb3NpdGlvbiIpOwogICAgdGhpcy5jb2xvckF0dHJpYnV0ZSA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhQ29sb3IiKTsKICAgIHRoaXMuYVRleHR1cmVDb29yZCA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhVGV4dHVyZUNvb3JkIik7CiAgICAgIAogICAgLy8gYWRkIHRob3NlIGN1c3RvbSBzaGFkZXJzIQogICAgZm9yICh2YXIga2V5IGluIHRoaXMudW5pZm9ybXMpCiAgICB7CiAgICAgICAgLy8gZ2V0IHRoZSB1bmlmb3JtIGxvY2F0aW9ucy4uCiAgICAgICAgdGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCBrZXkpOwogICAgfQogIAogICAgdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKfQoKLyoqCiogVXBkYXRlcyB0aGUgc2hhZGVyIHVuaWZvcm0gdmFsdWVzLgoqIFVuaWZvcm1zIGFyZSBzcGVjaWZpZWQgaW4gdGhlIEdMU0xfRVMgU3BlY2lmaWNhdGlvbjogaHR0cDovL3d3dy5raHJvbm9zLm9yZy9yZWdpc3RyeS93ZWJnbC9zcGVjcy9sYXRlc3QvMS4wLwoqIGh0dHA6Ly93d3cua2hyb25vcy5vcmcvcmVnaXN0cnkvZ2xlcy9zcGVjcy8yLjAvR0xTTF9FU19TcGVjaWZpY2F0aW9uXzEuMC4xNy5wZGYKKgoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI3N5bmNVbmlmb3JtcwoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLnN5bmNVbmlmb3JtcyA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy50ZXh0dXJlQ291bnQgPSAxOwoKICAgIHZhciBnbCA9IFBJWEkuZ2w7CiAgICAKICAgIGZvciAodmFyIGtleSBpbiB0aGlzLnVuaWZvcm1zKSAKICAgIHsKICAgICAgICB2YXIgdHlwZSA9IHRoaXMudW5pZm9ybXNba2V5XS50eXBlOwogICAgICAgIHZhciB0cmFuc3Bvc2UgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMudW5pZm9ybXNba2V5XS50cmFuc3Bvc2UpCiAgICAgICAgewogICAgICAgICAgICB0cmFuc3Bvc2UgPSB0aGlzLnVuaWZvcm1zW2tleV0udHJhbnNwb3NlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGUgPT0gIjFmIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTFmKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xmbG9hdCB4KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTFmKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjFmdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0xZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBGbG9hdDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTFmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPEdMZmxvYXQ+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtMWZ2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjFpIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTFpKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xpbnQgeCk7CiAgICAgICAgICAgIGdsLnVuaWZvcm0xaSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIxaXYiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMWl2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgSW50MzJBcnJheSB2KTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMWl2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgc2VxdWVuY2U8bG9uZz4gdik7CiAgICAgICAgICAgIGdsLnVuaWZvcm0xaSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIyZiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0yZihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMZmxvYXQgeCwgR0xmbG9hdCB5KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTJmKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS54LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjJmdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0yZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBGbG9hdDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTJmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPEdMZmxvYXQ+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtMmZ2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjJpIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTJpKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xpbnQgeCwgR0xpbnQgeSk7CiAgICAgICAgICAgIGdsLnVuaWZvcm0yaSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueCwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIyaXYiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMml2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgSW50MzJBcnJheSB2KTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMml2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgc2VxdWVuY2U8bG9uZz4gdik7CiAgICAgICAgICAgIGdsLnVuaWZvcm0yaXYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiM2YiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtM2YoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGZsb2F0IHgsIEdMZmxvYXQgeSwgR0xmbG9hdCB6KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTNmKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS54LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueSwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnopOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIzZnYiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtM2Z2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgRmxvYXQzMkFycmF5IHYpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBzZXF1ZW5jZTxHTGZsb2F0PiB2KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTNmdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIzaSIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zaShXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMaW50IHgsIEdMaW50IHksIEdMaW50IHopOwogICAgICAgICAgICBnbC51bmlmb3JtM2kodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLngsIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS55LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjNpdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBJbnQzMkFycmF5IHYpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBzZXF1ZW5jZTxsb25nPiB2KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTNpdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICI0ZiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm00ZihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMZmxvYXQgeCwgR0xmbG9hdCB5LCBHTGZsb2F0IHosIEdMZmxvYXQgdyk7CiAgICAgICAgICAgIGdsLnVuaWZvcm00Zih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueCwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnksIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS56LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUudyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjRmdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm00ZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBGbG9hdDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPEdMZmxvYXQ+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtNGZ2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjRpIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRpKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xpbnQgeCwgR0xpbnQgeSwgR0xpbnQgeiwgR0xpbnQgdyk7CiAgICAgICAgICAgIGdsLnVuaWZvcm00aSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueCwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnksIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS56LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUudyk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjRpdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm00aXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBJbnQzMkFycmF5IHYpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm00aXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBzZXF1ZW5jZTxsb25nPiB2KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTRpdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICJtYXQyIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybU1hdHJpeDJmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMYm9vbGVhbiB0cmFuc3Bvc2UsIEZsb2F0MzJBcnJheSB2YWx1ZSk7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybU1hdHJpeDJmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMYm9vbGVhbiB0cmFuc3Bvc2UsIHNlcXVlbmNlPEdMZmxvYXQ+IHZhbHVlKTsKICAgICAgICAgICAgZ2wudW5pZm9ybU1hdHJpeDJmdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0cmFuc3Bvc2UsIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIm1hdDMiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtTWF0cml4M2Z2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xib29sZWFuIHRyYW5zcG9zZSwgRmxvYXQzMkFycmF5IHZhbHVlKTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtTWF0cml4M2Z2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xib29sZWFuIHRyYW5zcG9zZSwgc2VxdWVuY2U8R0xmbG9hdD4gdmFsdWUpOwogICAgICAgICAgICBnbC51bmlmb3JtTWF0cml4M2Z2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRyYW5zcG9zZSwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAibWF0NCIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm1NYXRyaXg0ZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGJvb2xlYW4gdHJhbnNwb3NlLCBGbG9hdDMyQXJyYXkgdmFsdWUpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm1NYXRyaXg0ZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGJvb2xlYW4gdHJhbnNwb3NlLCBzZXF1ZW5jZTxHTGZsb2F0PiB2YWx1ZSk7CiAgICAgICAgICAgIGdsLnVuaWZvcm1NYXRyaXg0ZnYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdHJhbnNwb3NlLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICJzYW1wbGVyMkQiKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSAmJiB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUuYmFzZVRleHR1cmUuaGFzTG9hZGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgdGV4dHVyZSA9IHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlOwogICAgICAgICAgICAgICAgdmFyIGltYWdlID0gdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLmJhc2VUZXh0dXJlLnNvdXJjZTsKICAgICAgICAgICAgICAgIHZhciBmb3JtYXQgPSBnbC5SR0JBOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVuaWZvcm1zW2tleV0uZm9ybWF0ICYmIHRoaXMudW5pZm9ybXNba2V5XS5mb3JtYXQgPT0gJ2x1bWluYW5jZScpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgZm9ybWF0ID0gZ2wuTFVNSU5BTkNFOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2xbJ1RFWFRVUkUnICsgdGhpcy50ZXh0dXJlQ291bnRdKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy51bmlmb3Jtc1trZXldLndyYXApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICduby1yZXBlYXQnIHx8IHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09PSBmYWxzZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlR0xUZXh0dXJlTGluZWFyKGdsLCBpbWFnZSwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICdyZXBlYXQnIHx8IHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09PSB0cnVlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVHTFRleHR1cmUoZ2wsIGltYWdlLCBmb3JtYXQsIHRleHR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVuaWZvcm1zW2tleV0ud3JhcCA9PSAnbmVhcmVzdC1yZXBlYXQnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVHTFRleHR1cmVOZWFyZXN0UmVwZWF0KGdsLCBpbWFnZSwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICduZWFyZXN0JykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlR0xUZXh0dXJlTmVhcmVzdChnbCwgaW1hZ2UsIHRleHR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVuaWZvcm1zW2tleV0ud3JhcCA9PSAnYXVkaW8nKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVBdWRpb1RleHR1cmUoZ2wsIHRleHR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVuaWZvcm1zW2tleV0ud3JhcCA9PSAna2V5Ym9hcmQnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVLZXlib2FyZFRleHR1cmUoZ2wsIHRleHR1cmUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUdMVGV4dHVyZUxpbmVhcihnbCwgaW1hZ2UsIHRleHR1cmUpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGdsLnVuaWZvcm0xaSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnRleHR1cmVDb3VudCk7CgogICAgICAgICAgICAgICAgdGhpcy50ZXh0dXJlQ291bnQrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAp9OwoKLyoqCiogQmluZHMgdGhlIGdpdmVuIHRleHR1cmUgYW5kIGltYWdlIGRhdGEuIFRoZSB0ZXh0dXJlIGlzIHNldCB0byBSRVBFQVQuCiogQ29kZSBiYXNlZCBvbiBFZmZlY3RzLmpzIGZyb20gU2hhZGVyVG95LmNvbQoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2NyZWF0ZUdMVGV4dHVyZQoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmNyZWF0ZUdMVGV4dHVyZSA9IGZ1bmN0aW9uKGdsLCBpbWFnZSwgZm9ybWF0LCB0ZXh0dXJlKQp7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlKTsKICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19GTElQX1lfV0VCR0wsIGZhbHNlKTsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZm9ybWF0LCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVJfTUlQTUFQX0xJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5SRVBFQVQpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuUkVQRUFUKTsKICAgIGdsLmdlbmVyYXRlTWlwbWFwKGdsLlRFWFRVUkVfMkQpOwp9CgovKioKKiBCaW5kcyB0aGUgZ2l2ZW4gdGV4dHVyZSBhbmQgaW1hZ2UgZGF0YS4gVGhlIHRleHR1cmUgaXMgc2V0IHRvIENMQU1QX1RPX0VER0UuCiogQ29kZSBiYXNlZCBvbiBFZmZlY3RzLmpzIGZyb20gU2hhZGVyVG95LmNvbQoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2NyZWF0ZUdMVGV4dHVyZUxpbmVhcgoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmNyZWF0ZUdMVGV4dHVyZUxpbmVhciA9IGZ1bmN0aW9uKGdsLCBpbWFnZSwgdGV4dHVyZSkKewogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZSk7CiAgICBnbC5waXhlbFN0b3JlaShnbC5VTlBBQ0tfRkxJUF9ZX1dFQkdMLCBmYWxzZSk7CiAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIGltYWdlKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5DTEFNUF9UT19FREdFKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwp9CgovKioKKiBCaW5kcyB0aGUgZ2l2ZW4gdGV4dHVyZSBhbmQgaW1hZ2UgZGF0YS4gVGhlIHRleHR1cmUgaXMgc2V0IHRvIFJFUEVBVCB3aXRoIE5FQVJFU1QuCiogQ29kZSBiYXNlZCBvbiBFZmZlY3RzLmpzIGZyb20gU2hhZGVyVG95LmNvbQoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2NyZWF0ZUdMVGV4dHVyZU5lYXJlc3RSZXBlYXQKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5jcmVhdGVHTFRleHR1cmVOZWFyZXN0UmVwZWF0ID0gZnVuY3Rpb24oZ2wsIGltYWdlLCB0ZXh0dXJlKQp7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlKTsKICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19GTElQX1lfV0VCR0wsIGZhbHNlKTsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2UpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLk5FQVJFU1QpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLk5FQVJFU1QpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuUkVQRUFUKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLlJFUEVBVCk7Cn0KCi8qKgoqIEJpbmRzIHRoZSBnaXZlbiB0ZXh0dXJlIGFuZCBpbWFnZSBkYXRhLiBUaGUgdGV4dHVyZSBpcyBzZXQgdG8gQ0xBTVBfVE9fRURHRSB3aXRoIE5FQVJFU1QuCiogQ29kZSBiYXNlZCBvbiBFZmZlY3RzLmpzIGZyb20gU2hhZGVyVG95LmNvbQoqIEBtZXRob2QgUElYSS5QaXhpU2hhZGVyI2NyZWF0ZUdMVGV4dHVyZU5lYXJlc3QKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5jcmVhdGVHTFRleHR1cmVOZWFyZXN0ID0gZnVuY3Rpb24oZ2wsIGltYWdlLCB0ZXh0dXJlKQp7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlKTsKICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19GTElQX1lfV0VCR0wsIGZhbHNlKTsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2UpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLk5FQVJFU1QpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLk5FQVJFU1QpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKfQoKLyoqCiogQmluZHMgdGhlIGdpdmVuIHRleHR1cmUgZGF0YS4gVGhlIHRleHR1cmUgaXMgc2V0IHRvIENMQU1QX1RPX0VER0Ugd2l0aCBMVU1JTkFOQ0UuIERlc2lnbmVkIGZvciB1c2Ugd2l0aCByZWFsLXRpbWUgYXVkaW8gZGF0YS4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlQXVkaW9UZXh0dXJlCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuY3JlYXRlQXVkaW9UZXh0dXJlID0gZnVuY3Rpb24oZ2wsIHRleHR1cmUpCnsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpIDsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuTFVNSU5BTkNFLCA1MTIsIDIsIDAsIGdsLkxVTUlOQU5DRSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7Cn0KCi8qKgoqIEJpbmRzIHRoZSBnaXZlbiB0ZXh0dXJlIGRhdGEuIFRoZSB0ZXh0dXJlIGlzIHNldCB0byBDTEFNUF9UT19FREdFIHdpdGggTFVNSU5BTkNFLiBEZXNpZ25lZCBmb3IgdXNlIHdpdGgga2V5Ym9hcmQgaW5wdXQgZGF0YS4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlS2V5Ym9hcmRUZXh0dXJlCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuY3JlYXRlS2V5Ym9hcmRUZXh0dXJlID0gZnVuY3Rpb24oZ2wsIHRleHR1cmUpCnsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5ORUFSRVNUICk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTkVBUkVTVCApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSkgOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5MVU1JTkFOQ0UsIDI1NiwgMiwgMCwgZ2wuTFVNSU5BTkNFLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKfQoKUElYSS5QaXhpU2hhZGVyLmRlZmF1bHRWZXJ0ZXhTcmMgPSBbCiAgICAKICAgICJhdHRyaWJ1dGUgdmVjMiBhVmVydGV4UG9zaXRpb247IiwKICAgICJhdHRyaWJ1dGUgdmVjMiBhVGV4dHVyZUNvb3JkOyIsCiAgICAiYXR0cmlidXRlIGZsb2F0IGFDb2xvcjsiLAoKICAgICJ1bmlmb3JtIHZlYzIgcHJvamVjdGlvblZlY3RvcjsiLAogICAgInVuaWZvcm0gdmVjMiBvZmZzZXRWZWN0b3I7IiwKICAgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAoKICAgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoKICAgICJjb25zdCB2ZWMyIGNlbnRlciA9IHZlYzIoLTEuMCwgMS4wKTsiLAogICAgCiAgICAidm9pZCBtYWluKHZvaWQpIHsiLAogICAgICAgICJnbF9Qb3NpdGlvbiA9IHZlYzQoICgoYVZlcnRleFBvc2l0aW9uICsgb2Zmc2V0VmVjdG9yKSAvIHByb2plY3Rpb25WZWN0b3IpICsgY2VudGVyICwgMC4wLCAxLjApOyIsCiAgICAgICAgInZUZXh0dXJlQ29vcmQgPSBhVGV4dHVyZUNvb3JkOyIsCiAgICAgICAgInZDb2xvciA9IGFDb2xvcjsiLAogICAgIn0iCl07CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKClBJWEkuUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CgkvLyB0aGUgd2ViR0wgcHJvZ3JhbS4uCgl0aGlzLnByb2dyYW07CiAgICAJCiAgICB0aGlzLmZyYWdtZW50U3JjID0gWwogICAgICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKICAgICAgInZhcnlpbmcgdmVjNCB2Q29sb3I7IiwKICAgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKICAgICAgICAiZ2xfRnJhZ0NvbG9yID0gdkNvbG9yOyIsCiAgICAgICJ9IgogICAgXTsKCiAgICB0aGlzLnZlcnRleFNyYyAgPSBbCiAgICAgICJhdHRyaWJ1dGUgdmVjMiBhVmVydGV4UG9zaXRpb247IiwKICAgICAgImF0dHJpYnV0ZSB2ZWM0IGFDb2xvcjsiLAogICAgICAidW5pZm9ybSBtYXQzIHRyYW5zbGF0aW9uTWF0cml4OyIsCiAgICAgICJ1bmlmb3JtIHZlYzIgcHJvamVjdGlvblZlY3RvcjsiLAogICAgICAidW5pZm9ybSB2ZWMyIG9mZnNldFZlY3RvcjsiLAogICAgICAidW5pZm9ybSBmbG9hdCBhbHBoYTsiLAogICAgICAidmFyeWluZyB2ZWM0IHZDb2xvcjsiLAogICAgICAidm9pZCBtYWluKHZvaWQpIHsiLAogICAgICAgICJ2ZWMzIHYgPSB0cmFuc2xhdGlvbk1hdHJpeCAqIHZlYzMoYVZlcnRleFBvc2l0aW9uICwgMS4wKTsiLAogICAgICAgICJ2IC09IG9mZnNldFZlY3Rvci54eXg7IiwKICAgICAgICAiZ2xfUG9zaXRpb24gPSB2ZWM0KCB2LnggLyBwcm9qZWN0aW9uVmVjdG9yLnggLTEuMCwgdi55IC8gLXByb2plY3Rpb25WZWN0b3IueSArIDEuMCAsIDAuMCwgMS4wKTsiLAogICAgICAgICJ2Q29sb3IgPSBhQ29sb3IgICogYWxwaGE7IiwKICAgICAgIn0iCiAgICBdOwoJCn0KClBJWEkuUHJpbWl0aXZlU2hhZGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKQp7Cgl2YXIgcHJvZ3JhbSA9IFBJWEkuY29tcGlsZVByb2dyYW0odGhpcy52ZXJ0ZXhTcmMsIHRoaXMuZnJhZ21lbnRTcmMpOwoJCgl2YXIgZ2wgPSBQSVhJLmdsOwoJCiAgZ2wudXNlUHJvZ3JhbShwcm9ncmFtKTsKCQoJLy8gZ2V0IGFuZCBzdG9yZSB0aGUgdW5pZm9ybXMgZm9yIHRoZSBzaGFkZXIKCXRoaXMucHJvamVjdGlvblZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAicHJvamVjdGlvblZlY3RvciIpOwoJdGhpcy5vZmZzZXRWZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgIm9mZnNldFZlY3RvciIpOwogIAogIC8vIGdldCBhbmQgc3RvcmUgdGhlIGF0dHJpYnV0ZXMKICB0aGlzLmFWZXJ0ZXhQb3NpdGlvbiA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhVmVydGV4UG9zaXRpb24iKTsKCXRoaXMuY29sb3JBdHRyaWJ1dGUgPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAiYUNvbG9yIik7CgkKICB0aGlzLnRyYW5zbGF0aW9uTWF0cml4ID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJ0cmFuc2xhdGlvbk1hdHJpeCIpOwogIHRoaXMuYWxwaGEgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgImFscGhhIik7CgoJdGhpcy5wcm9ncmFtID0gcHJvZ3JhbTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgpQSVhJLlN0cmlwU2hhZGVyID0gZnVuY3Rpb24oKQp7CgkvLyB0aGUgd2ViR0wgcHJvZ3JhbS4uCgl0aGlzLnByb2dyYW07CgkKICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBbCiAgICAgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAogICAgICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKICAgICAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCiAgICAgICJ1bmlmb3JtIGZsb2F0IGFscGhhOyIsCiAgICAgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAogICAgICAidm9pZCBtYWluKHZvaWQpIHsiLAogICAgICAgICJnbF9GcmFnQ29sb3IgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkpKTsiLAogICAgICAgICJnbF9GcmFnQ29sb3IgPSBnbF9GcmFnQ29sb3IgKiBhbHBoYTsiLAogICAgICAifSIKICAgIF07CgogICAgdGhpcy52ZXJ0ZXhTcmMgPSBbCiAgICAgICJhdHRyaWJ1dGUgdmVjMiBhVmVydGV4UG9zaXRpb247IiwKICAgICAgImF0dHJpYnV0ZSB2ZWMyIGFUZXh0dXJlQ29vcmQ7IiwKICAgICAgImF0dHJpYnV0ZSBmbG9hdCBhQ29sb3I7IiwKICAgICAgInVuaWZvcm0gbWF0MyB0cmFuc2xhdGlvbk1hdHJpeDsiLAogICAgICAidW5pZm9ybSB2ZWMyIHByb2plY3Rpb25WZWN0b3I7IiwKICAgICAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCiAgICAgICJ2YXJ5aW5nIHZlYzIgb2Zmc2V0VmVjdG9yOyIsCiAgICAgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAogICAgICAidm9pZCBtYWluKHZvaWQpIHsiLAogICAgICAgICJ2ZWMzIHYgPSB0cmFuc2xhdGlvbk1hdHJpeCAqIHZlYzMoYVZlcnRleFBvc2l0aW9uLCAxLjApOyIsCiAgICAgICAgInYgLT0gb2Zmc2V0VmVjdG9yLnh5eDsiLAogICAgICAgICJnbF9Qb3NpdGlvbiA9IHZlYzQoIHYueCAvIHByb2plY3Rpb25WZWN0b3IueCAtMS4wLCB2LnkgLyBwcm9qZWN0aW9uVmVjdG9yLnkgKyAxLjAgLCAwLjAsIDEuMCk7IiwKICAgICAgICAidlRleHR1cmVDb29yZCA9IGFUZXh0dXJlQ29vcmQ7IiwKICAgICAgICAidkNvbG9yID0gYUNvbG9yOyIsCiAgICAgICJ9IgogICAgXTsKfQoKUElYSS5TdHJpcFNoYWRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkKewoJdmFyIHByb2dyYW0gPSBQSVhJLmNvbXBpbGVQcm9ncmFtKHRoaXMudmVydGV4U3JjLCB0aGlzLmZyYWdtZW50U3JjKQoJCgl2YXIgZ2wgPSBQSVhJLmdsOwoJCiAgICBnbC51c2VQcm9ncmFtKHByb2dyYW0pOwoKCS8vIGdldCBhbmQgc3RvcmUgdGhlIHVuaWZvcm1zIGZvciB0aGUgc2hhZGVyCgl0aGlzLnVTYW1wbGVyID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJ1U2FtcGxlciIpOwoJdGhpcy5wcm9qZWN0aW9uVmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJwcm9qZWN0aW9uVmVjdG9yIik7Cgl0aGlzLm9mZnNldFZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAib2Zmc2V0VmVjdG9yIik7Cgl0aGlzLmNvbG9yQXR0cmlidXRlID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFDb2xvciIpOwoJLy90aGlzLmRpbWVuc2lvbnMgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24odGhpcy5wcm9ncmFtLCAiZGltZW5zaW9ucyIpOwoJCgkvLyBnZXQgYW5kIHN0b3JlIHRoZSBhdHRyaWJ1dGVzCgl0aGlzLmFWZXJ0ZXhQb3NpdGlvbiA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhVmVydGV4UG9zaXRpb24iKTsKCXRoaXMuYVRleHR1cmVDb29yZCA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhVGV4dHVyZUNvb3JkIik7CgkgIAogICAgdGhpcy50cmFuc2xhdGlvbk1hdHJpeCA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAidHJhbnNsYXRpb25NYXRyaXgiKTsKICAgIHRoaXMuYWxwaGEgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgImFscGhhIik7CiAgCgl0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5fYmF0Y2hzID0gW107CgovKioKICogQHByaXZhdGUKICovClBJWEkuX2dldEJhdGNoID0gZnVuY3Rpb24oZ2wpCnsKCWlmKFBJWEkuX2JhdGNocy5sZW5ndGggPT0gMCkKCXsKCQlyZXR1cm4gbmV3IFBJWEkuV2ViR0xCYXRjaChnbCk7Cgl9CgllbHNlCgl7CgkJcmV0dXJuIFBJWEkuX2JhdGNocy5wb3AoKTsKCX0KfQoKLyoqCiAqIEBwcml2YXRlCiAqLwpQSVhJLl9yZXR1cm5CYXRjaCA9IGZ1bmN0aW9uKGJhdGNoKQp7CgliYXRjaC5jbGVhbigpOwkKCVBJWEkuX2JhdGNocy5wdXNoKGJhdGNoKTsKfQoKLyoqCiAqIEBwcml2YXRlCiAqLwpQSVhJLl9yZXN0b3JlQmF0Y2hzID0gZnVuY3Rpb24oZ2wpCnsKCWZvciAodmFyIGk9MDsgaSA8IFBJWEkuX2JhdGNocy5sZW5ndGg7IGkrKykgCgl7CgkgIFBJWEkuX2JhdGNoc1tpXS5yZXN0b3JlTG9zdENvbnRleHQoZ2wpOwoJfTsKfQoKLyoqCiAqIEEgV2ViR0xCYXRjaCBFbmFibGVzIGEgZ3JvdXAgb2Ygc3ByaXRlcyB0byBiZSBkcmF3biB1c2luZyB0aGUgc2FtZSBzZXR0aW5ncy4KICogaWYgYSBncm91cCBvZiBzcHJpdGVzIGFsbCBoYXZlIHRoZSBzYW1lIGJhc2VUZXh0dXJlIGFuZCBibGVuZE1vZGUgdGhlbiB0aGV5IGNhbiBiZSBncm91cGVkIGludG8gYSBiYXRjaC4KICogQWxsIHRoZSBzcHJpdGVzIGluIGEgYmF0Y2ggY2FuIHRoZW4gYmUgZHJhd24gaW4gb25lIGdvIGJ5IHRoZSBHUFUgd2hpY2ggaXMgaHVnZWx5IGVmZmljaWVudC4gQUxMIHNwcml0ZXMKICogaW4gdGhlIHdlYkdMIHJlbmRlcmVyIGFyZSBhZGRlZCB0byBhIGJhdGNoIGV2ZW4gaWYgdGhlIGJhdGNoIG9ubHkgY29udGFpbnMgb25lIHNwcml0ZS4gQmF0Y2hpbmcgaXMgaGFuZGxlZAogKiBhdXRvbWF0aWNhbGx5IGJ5IHRoZSB3ZWJHTCByZW5kZXJlci4gQSBnb29kIHRpcCBpczogdGhlIHNtYWxsZXIgdGhlIG51bWJlciBvZiBiYXRjaHMgdGhlcmUgYXJlLCB0aGUgZmFzdGVyCiAqIHRoZSB3ZWJHTCByZW5kZXJlciB3aWxsIHJ1bi4KICoKICogQGNsYXNzIFdlYkdMQmF0Y2gKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBnbCB7V2ViR0xDb250ZXh0fSBhbiBpbnN0YW5jZSBvZiB0aGUgd2ViR0wgY29udGV4dAogKi8KUElYSS5XZWJHTEJhdGNoID0gZnVuY3Rpb24oZ2wpCnsKCXRoaXMuZ2wgPSBnbDsKCQoJdGhpcy5zaXplID0gMDsKCgl0aGlzLnZlcnRleEJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMuaW5kZXhCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cgl0aGlzLnV2QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy5jb2xvckJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMuYmxlbmRNb2RlID0gUElYSS5ibGVuZE1vZGVzLk5PUk1BTDsKCXRoaXMuZHluYW1pY1NpemUgPSAxOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5XZWJHTEJhdGNoOwoKLyoqCiAqIENsZWFucyB0aGUgYmF0Y2ggc28gdGhhdCBpcyBjYW4gYmUgcmV0dXJuZWQgdG8gYW4gb2JqZWN0IHBvb2wgYW5kIHJldXNlZAogKgogKiBAbWV0aG9kIGNsZWFuCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmNsZWFuID0gZnVuY3Rpb24oKQp7Cgl0aGlzLnZlcnRpY2llcyA9IFtdOwoJdGhpcy51dnMgPSBbXTsKCXRoaXMuaW5kaWNlcyA9IFtdOwoJdGhpcy5jb2xvcnMgPSBbXTsKCXRoaXMuZHluYW1pY1NpemUgPSAxOwoJdGhpcy50ZXh0dXJlID0gbnVsbDsKCXRoaXMubGFzdCA9IG51bGw7Cgl0aGlzLnNpemUgPSAwOwoJdGhpcy5oZWFkOwoJdGhpcy50YWlsOwp9CgovKioKICogUmVjcmVhdGVzIHRoZSBidWZmZXJzIGluIHRoZSBldmVudCBvZiBhIGNvbnRleHQgbG9zcwogKgogKiBAbWV0aG9kIHJlc3RvcmVMb3N0Q29udGV4dAogKiBAcGFyYW0gZ2wge1dlYkdMQ29udGV4dH0KICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUucmVzdG9yZUxvc3RDb250ZXh0ID0gZnVuY3Rpb24oZ2wpCnsKCXRoaXMuZ2wgPSBnbDsKCXRoaXMudmVydGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy5pbmRleEJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMudXZCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cgl0aGlzLmNvbG9yQnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwp9CgovKioKICogaW5pdHMgdGhlIGJhdGNoJ3MgdGV4dHVyZSBhbmQgYmxlbmQgbW9kZSBiYXNlZCBpZiB0aGUgc3VwcGxpZWQgc3ByaXRlCiAqCiAqIEBtZXRob2QgaW5pdAogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBmaXJzdCBzcHJpdGUgdG8gYmUgYWRkZWQgdG8gdGhlIGJhdGNoLiBPbmx5IHNwcml0ZXMgd2l0aAogKgkJdGhlIHNhbWUgYmFzZSB0ZXh0dXJlIGFuZCBibGVuZCBtb2RlIHdpbGwgYmUgYWxsb3dlZCB0byBiZSBhZGRlZCB0byB0aGlzIGJhdGNoCiAqLwkKUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oc3ByaXRlKQp7CglzcHJpdGUuYmF0Y2ggPSB0aGlzOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cgl0aGlzLmJsZW5kTW9kZSA9IHNwcml0ZS5ibGVuZE1vZGU7Cgl0aGlzLnRleHR1cmUgPSBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZTsKCXRoaXMuaGVhZCA9IHNwcml0ZTsKCXRoaXMudGFpbCA9IHNwcml0ZTsKCXRoaXMuc2l6ZSA9IDE7CgoJdGhpcy5ncm93QmF0Y2goKTsKfQoKLyoqCiAqIGluc2VydHMgYSBzcHJpdGUgYmVmb3JlIHRoZSBzcGVjaWZpZWQgc3ByaXRlCiAqCiAqIEBtZXRob2QgaW5zZXJ0QmVmb3JlCiAqIEBwYXJhbSBzcHJpdGUge1Nwcml0ZX0gdGhlIHNwcml0ZSB0byBiZSBhZGRlZAogKiBAcGFyYW0gbmV4dFNwcml0ZSB7bmV4dFNwcml0ZX0gdGhlIGZpcnN0IHNwcml0ZSB3aWxsIGJlIGluc2VydGVkIGJlZm9yZSB0aGlzIHNwcml0ZQogKi8JClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuaW5zZXJ0QmVmb3JlID0gZnVuY3Rpb24oc3ByaXRlLCBuZXh0U3ByaXRlKQp7Cgl0aGlzLnNpemUrKzsKCglzcHJpdGUuYmF0Y2ggPSB0aGlzOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cgl2YXIgdGVtcFByZXYgPSBuZXh0U3ByaXRlLl9fcHJldjsKCW5leHRTcHJpdGUuX19wcmV2ID0gc3ByaXRlOwoJc3ByaXRlLl9fbmV4dCA9IG5leHRTcHJpdGU7CgoJaWYodGVtcFByZXYpCgl7CgkJc3ByaXRlLl9fcHJldiA9IHRlbXBQcmV2OwoJCXRlbXBQcmV2Ll9fbmV4dCA9IHNwcml0ZTsKCX0KCWVsc2UKCXsKCQl0aGlzLmhlYWQgPSBzcHJpdGU7Cgl9Cn0KCi8qKgogKiBpbnNlcnRzIGEgc3ByaXRlIGFmdGVyIHRoZSBzcGVjaWZpZWQgc3ByaXRlCiAqCiAqIEBtZXRob2QgaW5zZXJ0QWZ0ZXIKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRvIGJlIGFkZGVkCiAqIEBwYXJhbSAgcHJldmlvdXNTcHJpdGUge1Nwcml0ZX0gdGhlIGZpcnN0IHNwcml0ZSB3aWxsIGJlIGluc2VydGVkIGFmdGVyIHRoaXMgc3ByaXRlCiAqLwkKUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5pbnNlcnRBZnRlciA9IGZ1bmN0aW9uKHNwcml0ZSwgcHJldmlvdXNTcHJpdGUpCnsKCXRoaXMuc2l6ZSsrOwoKCXNwcml0ZS5iYXRjaCA9IHRoaXM7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCgl2YXIgdGVtcE5leHQgPSBwcmV2aW91c1Nwcml0ZS5fX25leHQ7CglwcmV2aW91c1Nwcml0ZS5fX25leHQgPSBzcHJpdGU7CglzcHJpdGUuX19wcmV2ID0gcHJldmlvdXNTcHJpdGU7CgoJaWYodGVtcE5leHQpCgl7CgkJc3ByaXRlLl9fbmV4dCA9IHRlbXBOZXh0OwoJCXRlbXBOZXh0Ll9fcHJldiA9IHNwcml0ZTsKCX0KCWVsc2UKCXsKCQl0aGlzLnRhaWwgPSBzcHJpdGUKCX0KfQoKLyoqCiAqIHJlbW92ZXMgYSBzcHJpdGUgZnJvbSB0aGUgYmF0Y2gKICoKICogQG1ldGhvZCByZW1vdmUKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRvIGJlIHJlbW92ZWQKICovCQpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnJlbW92ZSA9IGZ1bmN0aW9uKHNwcml0ZSkKewoJdGhpcy5zaXplLS07CgoJaWYodGhpcy5zaXplID09IDApCgl7CgkJc3ByaXRlLmJhdGNoID0gbnVsbDsKCQlzcHJpdGUuX19wcmV2ID0gbnVsbDsKCQlzcHJpdGUuX19uZXh0ID0gbnVsbDsKCQlyZXR1cm47Cgl9CgoJaWYoc3ByaXRlLl9fcHJldikKCXsKCQlzcHJpdGUuX19wcmV2Ll9fbmV4dCA9IHNwcml0ZS5fX25leHQ7Cgl9CgllbHNlCgl7CgkJdGhpcy5oZWFkID0gc3ByaXRlLl9fbmV4dDsKCQl0aGlzLmhlYWQuX19wcmV2ID0gbnVsbDsKCX0KCglpZihzcHJpdGUuX19uZXh0KQoJewoJCXNwcml0ZS5fX25leHQuX19wcmV2ID0gc3ByaXRlLl9fcHJldjsKCX0KCWVsc2UKCXsKCQl0aGlzLnRhaWwgPSBzcHJpdGUuX19wcmV2OwoJCXRoaXMudGFpbC5fX25leHQgPSBudWxsCgl9CgoJc3ByaXRlLmJhdGNoID0gbnVsbDsKCXNwcml0ZS5fX25leHQgPSBudWxsOwoJc3ByaXRlLl9fcHJldiA9IG51bGw7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKfQoKLyoqCiAqIFNwbGl0cyB0aGUgYmF0Y2ggaW50byB0d28gd2l0aCB0aGUgc3BlY2lmaWVkIHNwcml0ZSBiZWluZyB0aGUgc3RhcnQgb2YgdGhlIG5ldyBiYXRjaC4KICoKICogQG1ldGhvZCBzcGxpdAogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdGhhdCBpbmRpY2F0ZXMgd2hlcmUgdGhlIGJhdGNoIHNob3VsZCBiZSBzcGxpdAogKiBAcmV0dXJuIHtXZWJHTEJhdGNofSB0aGUgbmV3IGJhdGNoCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnNwbGl0ID0gZnVuY3Rpb24oc3ByaXRlKQp7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCgl2YXIgYmF0Y2ggPSBuZXcgUElYSS5XZWJHTEJhdGNoKHRoaXMuZ2wpOwoJYmF0Y2guaW5pdChzcHJpdGUpOwoJYmF0Y2gudGV4dHVyZSA9IHRoaXMudGV4dHVyZTsKCWJhdGNoLnRhaWwgPSB0aGlzLnRhaWw7CgoJdGhpcy50YWlsID0gc3ByaXRlLl9fcHJldjsKCXRoaXMudGFpbC5fX25leHQgPSBudWxsOwoKCXNwcml0ZS5fX3ByZXYgPSBudWxsOwoJLy8gcmV0dXJuIGEgc3BsaXRlIGJhdGNoIQoKCS8vIFRPRE8gdGhpcyBzaXplIGlzIHdyb25nIQoJLy8gbmVlZCB0byByZWNhbGN1bGF0ZSA6LyBwcm9ibGVtIHdpdGggYSBsaW5rZWQgbGlzdCEKCS8vIHVubGVzcyBpdCBnZXRzIGNhbGN1bGF0ZWQgaW4gdGhlICJjbGVhbiI/CgoJLy8gbmVlZCB0byBsb29wIHRocm91Z2ggaXRlbXMgYXMgdGhlcmUgaXMgbm8gd2F5IHRvIGtub3cgdGhlIGxlbmd0aCBvbiBhIGxpbmtlZCBsaXN0IDovCgl2YXIgdGVtcFNpemUgPSAwOwoJd2hpbGUoc3ByaXRlKQoJewoJCXRlbXBTaXplKys7CgkJc3ByaXRlLmJhdGNoID0gYmF0Y2g7CgkJc3ByaXRlID0gc3ByaXRlLl9fbmV4dDsKCX0KCgliYXRjaC5zaXplID0gdGVtcFNpemU7Cgl0aGlzLnNpemUgLT0gdGVtcFNpemU7CgoJcmV0dXJuIGJhdGNoOwp9CgovKioKICogTWVyZ2VzIHR3byBiYXRjaHMgdG9nZXRoZXIKICoKICogQG1ldGhvZCBtZXJnZQogKiBAcGFyYW0gYmF0Y2gge1dlYkdMQmF0Y2h9IHRoZSBiYXRjaCB0aGF0IHdpbGwgYmUgbWVyZ2VkIAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5tZXJnZSA9IGZ1bmN0aW9uKGJhdGNoKQp7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCgl0aGlzLnRhaWwuX19uZXh0ID0gYmF0Y2guaGVhZDsKCWJhdGNoLmhlYWQuX19wcmV2ID0gdGhpcy50YWlsOwoKCXRoaXMuc2l6ZSArPSBiYXRjaC5zaXplOwoKCXRoaXMudGFpbCA9IGJhdGNoLnRhaWw7CgoJdmFyIHNwcml0ZSA9IGJhdGNoLmhlYWQ7Cgl3aGlsZShzcHJpdGUpCgl7CgkJc3ByaXRlLmJhdGNoID0gdGhpczsKCQlzcHJpdGUgPSBzcHJpdGUuX19uZXh0OwoJfQp9CgovKioKICogR3Jvd3MgdGhlIHNpemUgb2YgdGhlIGJhdGNoLiBBcyB0aGUgZWxlbWVudHMgaW4gdGhlIGJhdGNoIGNhbm5vdCBoYXZlIGEgZHluYW1pYyBzaXplIHRoaXMKICogZnVuY3Rpb24gaXMgdXNlZCB0byBpbmNyZWFzZSB0aGUgc2l6ZSBvZiB0aGUgYmF0Y2guIEl0IGFsc28gY3JlYXRlcyBhIGxpdHRsZSBleHRyYSByb29tIHNvCiAqIHRoYXQgdGhlIGJhdGNoIGRvZXMgbm90IG5lZWQgdG8gYmUgcmVzaXplZCBldmVyeSB0aW1lIGEgc3ByaXRlIGlzIGFkZGVkCiAqCiAqIEBtZXRob2QgZ3Jvd0JhdGNoCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmdyb3dCYXRjaCA9IGZ1bmN0aW9uKCkKewoJdmFyIGdsID0gdGhpcy5nbDsKCWlmKCB0aGlzLnNpemUgPT0gMSkKCXsKCQl0aGlzLmR5bmFtaWNTaXplID0gMTsKCX0KCWVsc2UKCXsKCQl0aGlzLmR5bmFtaWNTaXplID0gdGhpcy5zaXplICogMS41Cgl9CgkvLyBncm93IHZlcnRzCgl0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkodGhpcy5keW5hbWljU2l6ZSAqIDgpOwoKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUix0aGlzLnZlcnRpY2llcyAsIGdsLkRZTkFNSUNfRFJBVyk7CgoJdGhpcy51dnMgID0gbmV3IEZsb2F0MzJBcnJheSggdGhpcy5keW5hbWljU2l6ZSAqIDggKTsKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2cyAsIGdsLkRZTkFNSUNfRFJBVyk7CgoJdGhpcy5kaXJ0eVVWUyA9IHRydWU7CgoJdGhpcy5jb2xvcnMgID0gbmV3IEZsb2F0MzJBcnJheSggdGhpcy5keW5hbWljU2l6ZSAqIDQgKTsKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmNvbG9yQnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLmNvbG9ycyAsIGdsLkRZTkFNSUNfRFJBVyk7CgoJdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7CgoJdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KHRoaXMuZHluYW1pY1NpemUgKiA2KTsgCgl2YXIgbGVuZ3RoID0gdGhpcy5pbmRpY2VzLmxlbmd0aC82OwoKCWZvciAodmFyIGk9MDsgaSA8IGxlbmd0aDsgaSsrKSAKCXsKCSAgICB2YXIgaW5kZXgyID0gaSAqIDY7CgkgICAgdmFyIGluZGV4MyA9IGkgKiA0OwoJCXRoaXMuaW5kaWNlc1tpbmRleDIgKyAwXSA9IGluZGV4MyArIDA7CgkJdGhpcy5pbmRpY2VzW2luZGV4MiArIDFdID0gaW5kZXgzICsgMTsKCQl0aGlzLmluZGljZXNbaW5kZXgyICsgMl0gPSBpbmRleDMgKyAyOwoJCXRoaXMuaW5kaWNlc1tpbmRleDIgKyAzXSA9IGluZGV4MyArIDA7CgkJdGhpcy5pbmRpY2VzW2luZGV4MiArIDRdID0gaW5kZXgzICsgMjsKCQl0aGlzLmluZGljZXNbaW5kZXgyICsgNV0gPSBpbmRleDMgKyAzOwoJfTsKCglnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kaWNlcywgZ2wuU1RBVElDX0RSQVcpOwp9CgovKioKICogUmVmcmVzaCdzIGFsbCB0aGUgZGF0YSBpbiB0aGUgYmF0Y2ggYW5kIHN5bmMncyBpdCB3aXRoIHRoZSB3ZWJHTCBidWZmZXJzCiAqCiAqIEBtZXRob2QgcmVmcmVzaAogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKQp7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoKCWlmICh0aGlzLmR5bmFtaWNTaXplIDwgdGhpcy5zaXplKQoJewoJCXRoaXMuZ3Jvd0JhdGNoKCk7Cgl9CgoJdmFyIGluZGV4UnVuID0gMDsKCXZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgaW5kZXg7Cgl2YXIgYSwgYiwgYywgZCwgdHgsIHR5OwoKCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5oZWFkOwoKCXdoaWxlKGRpc3BsYXlPYmplY3QpCgl7CgkJaW5kZXggPSBpbmRleFJ1biAqIDg7CgoJCXZhciB0ZXh0dXJlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlOwoKCQl2YXIgZnJhbWUgPSB0ZXh0dXJlLmZyYW1lOwoJCXZhciB0dyA9IHRleHR1cmUuYmFzZVRleHR1cmUud2lkdGg7CgkJdmFyIHRoID0gdGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgoJCXRoaXMudXZzW2luZGV4ICsgMF0gPSBmcmFtZS54IC8gdHc7CgkJdGhpcy51dnNbaW5kZXggKzFdID0gZnJhbWUueSAvIHRoOwoKCQl0aGlzLnV2c1tpbmRleCArMl0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwoJCXRoaXMudXZzW2luZGV4ICszXSA9IGZyYW1lLnkgLyB0aDsKCgkJdGhpcy51dnNbaW5kZXggKzRdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKCQl0aGlzLnV2c1tpbmRleCArNV0gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsgCgoJCXRoaXMudXZzW2luZGV4ICs2XSA9IGZyYW1lLnggLyB0dzsKCQl0aGlzLnV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCgkJZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSA9IGZhbHNlOwoKCQljb2xvckluZGV4ID0gaW5kZXhSdW4gKiA0OwoJCXRoaXMuY29sb3JzW2NvbG9ySW5kZXhdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDFdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDJdID0gdGhpcy5jb2xvcnNbY29sb3JJbmRleCArIDNdID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoKCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fX25leHQ7CgoJCWluZGV4UnVuICsrOwoJfQoKCXRoaXMuZGlydHlVVlMgPSB0cnVlOwoJdGhpcy5kaXJ0eUNvbG9ycyA9IHRydWU7Cn0KCi8qKgogKiBVcGRhdGVzIGFsbCB0aGUgcmVsZXZhbnQgZ2VvbWV0cnkgYW5kIHVwbG9hZHMgdGhlIGRhdGEgdG8gdGhlIEdQVQogKgogKiBAbWV0aG9kIHVwZGF0ZQogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IHRoaXMuZ2w7Cgl2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGluZGV4LCBpbmRleDIsIGluZGV4MwoKCXZhciBhLCBiLCBjLCBkLCB0eCwgdHk7CgoJdmFyIGluZGV4UnVuID0gMDsKCgl2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuaGVhZDsKCXZhciB2ZXJ0aWNpZXMgPSB0aGlzLnZlcnRpY2llczsKCXZhciB1dnMgPSB0aGlzLnV2czsKCXZhciBjb2xvcnMgPSB0aGlzLmNvbG9yczsKCQoJd2hpbGUoZGlzcGxheU9iamVjdCkKCXsKCQlpZihkaXNwbGF5T2JqZWN0LnZjb3VudCA9PT0gUElYSS52aXNpYmxlQ291bnQpCgkJewoJCQl3aWR0aCA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aDsKCQkJaGVpZ2h0ID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCgkJCS8vIFRPRE8gdHJpbT8/CgkJCWFYID0gZGlzcGxheU9iamVjdC5hbmNob3IueDsvLyAtIGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLngKCQkJYVkgPSBkaXNwbGF5T2JqZWN0LmFuY2hvci55OyAvLy0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueQoJCQl3MCA9IHdpZHRoICogKDEtYVgpOwoJCQl3MSA9IHdpZHRoICogLWFYOwoKCQkJaDAgPSBoZWlnaHQgKiAoMS1hWSk7CgkJCWgxID0gaGVpZ2h0ICogLWFZOwoKCQkJaW5kZXggPSBpbmRleFJ1biAqIDg7CgoJCQl3b3JsZFRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CgoJCQlhID0gd29ybGRUcmFuc2Zvcm1bMF07CgkJCWIgPSB3b3JsZFRyYW5zZm9ybVszXTsKCQkJYyA9IHdvcmxkVHJhbnNmb3JtWzFdOwoJCQlkID0gd29ybGRUcmFuc2Zvcm1bNF07CgkJCXR4ID0gd29ybGRUcmFuc2Zvcm1bMl07CgkJCXR5ID0gd29ybGRUcmFuc2Zvcm1bNV07CgoJCQl2ZXJ0aWNpZXNbaW5kZXggKyAwIF0gPSBhICogdzEgKyBjICogaDEgKyB0eDsgCgkJCXZlcnRpY2llc1tpbmRleCArIDEgXSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKCQkJdmVydGljaWVzW2luZGV4ICsgMiBdID0gYSAqIHcwICsgYyAqIGgxICsgdHg7IAoJCQl2ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSBkICogaDEgKyBiICogdzAgKyB0eTsgCgoJCQl2ZXJ0aWNpZXNbaW5kZXggKyA0IF0gPSBhICogdzAgKyBjICogaDAgKyB0eDsgCgkJCXZlcnRpY2llc1tpbmRleCArIDUgXSA9IGQgKiBoMCArIGIgKiB3MCArIHR5OyAKCgkJCXZlcnRpY2llc1tpbmRleCArIDZdID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OyAKCQkJdmVydGljaWVzW2luZGV4ICsgN10gPSAgZCAqIGgwICsgYiAqIHcxICsgdHk7IAoKCQkJaWYoZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSB8fCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudXBkYXRlRnJhbWUpCgkJCXsKCQkJCXRoaXMuZGlydHlVVlMgPSB0cnVlOwoKCQkJCXZhciB0ZXh0dXJlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlOwoKCQkJCXZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CgkJCQl2YXIgdHcgPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwoJCQkJdmFyIHRoID0gdGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgoJCQkJdXZzW2luZGV4ICsgMF0gPSBmcmFtZS54IC8gdHc7CgkJCQl1dnNbaW5kZXggKzFdID0gZnJhbWUueSAvIHRoOwoKCQkJCXV2c1tpbmRleCArMl0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwoJCQkJdXZzW2luZGV4ICszXSA9IGZyYW1lLnkgLyB0aDsKCgkJCQl1dnNbaW5kZXggKzRdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKCQkJCXV2c1tpbmRleCArNV0gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsgCgoJCQkJdXZzW2luZGV4ICs2XSA9IGZyYW1lLnggLyB0dzsKCQkJCXV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCgkJCQlkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lID0gZmFsc2U7CgkJCX0KCgkJCS8vIFRPRE8gdGhpcyBwcm9iYWJseSBjb3VsZCBkbyB3aXRoIHNvbWUgb3B0aW1pc2F0aW9uLi4uLgoJCQlpZihkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgIT0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhKQoJCQl7CgkJCQlkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgoJCQkJdmFyIGNvbG9ySW5kZXggPSBpbmRleFJ1biAqIDQ7CgkJCQljb2xvcnNbY29sb3JJbmRleF0gPSBjb2xvcnNbY29sb3JJbmRleCArIDFdID0gY29sb3JzW2NvbG9ySW5kZXggKyAyXSA9IGNvbG9yc1tjb2xvckluZGV4ICsgM10gPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgkJCQl0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlpbmRleCA9IGluZGV4UnVuICogODsKCgkJCXZlcnRpY2llc1tpbmRleCArIDAgXSA9IHZlcnRpY2llc1tpbmRleCArIDEgXSA9IHZlcnRpY2llc1tpbmRleCArIDIgXSA9IHZlcnRpY2llc1tpbmRleCArIDMgXSA9IHZlcnRpY2llc1tpbmRleCArIDQgXSA9IHZlcnRpY2llc1tpbmRleCArIDUgXSA9IHZlcnRpY2llc1tpbmRleCArIDZdID0gCXZlcnRpY2llc1tpbmRleCArIDddID0gMDsKCQl9CgoJCWluZGV4UnVuKys7CgkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX19uZXh0OwogICB9Cn0KCi8qKgogKiBEcmF3cyB0aGUgYmF0Y2ggdG8gdGhlIGZyYW1lIGJ1ZmZlcgogKgogKiBAbWV0aG9kIHJlbmRlcgogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFydCwgZW5kKQp7CglzdGFydCA9IHN0YXJ0IHx8IDA7CgoJaWYoZW5kID09IHVuZGVmaW5lZCllbmQgPSB0aGlzLnNpemU7CgkKCWlmKHRoaXMuZGlydHkpCgl7CgkJdGhpcy5yZWZyZXNoKCk7CgkJdGhpcy5kaXJ0eSA9IGZhbHNlOwoJfQoKCWlmICh0aGlzLnNpemUgPT0gMClyZXR1cm47CgoJdGhpcy51cGRhdGUoKTsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJLy9UT0RPIG9wdGltaXplIHRoaXMhCgoJdmFyIHNoYWRlclByb2dyYW0gPSBQSVhJLmRlZmF1bHRTaGFkZXI7CgkKCS8vZ2wudXNlUHJvZ3JhbShzaGFkZXJQcm9ncmFtKTsKCgkvLyB1cGRhdGUgdGhlIHZlcnRzLi4KCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CgkvLyBvay4uCglnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0aWNpZXMpCiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlclByb2dyYW0uYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJLy8gdXBkYXRlIHRoZSB1dnMKCS8vdmFyIGlzRGVmYXVsdCA9IChzaGFkZXJQcm9ncmFtID09IFBJWEkuc2hhZGVyUHJvZ3JhbSkKCiAgIAlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CgogICAgaWYodGhpcy5kaXJ0eVVWUykKICAgIHsKICAgIAl0aGlzLmRpcnR5VVZTID0gZmFsc2U7CiAgICAJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsICAwLCB0aGlzLnV2cyk7CiAgICB9CgogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXJQcm9ncmFtLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgogICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLnRleHR1cmUuX2dsVGV4dHVyZSk7CgoJLy8gdXBkYXRlIGNvbG9yIQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JCdWZmZXIpOwoKCWlmKHRoaXMuZGlydHlDb2xvcnMpCiAgICB7CiAgICAJdGhpcy5kaXJ0eUNvbG9ycyA9IGZhbHNlOwogICAgCWdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLmNvbG9ycyk7Cgl9CgogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXJQcm9ncmFtLmNvbG9yQXR0cmlidXRlLCAxLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwoKCXZhciBsZW4gPSBlbmQgLSBzdGFydDsKCiAgICAvLyBEUkFXIFRIQVQgdGhpcyEKICAgIGdsLmRyYXdFbGVtZW50cyhnbC5UUklBTkdMRVMsIGxlbiAqIDYsIGdsLlVOU0lHTkVEX1NIT1JULCBzdGFydCAqIDIgKiA2ICk7Cn0KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIgPSBmdW5jdGlvbih0cmFuc3BhcmVudCkKewoJdGhpcy50cmFuc3BhcmVudCA9IHRyYW5zcGFyZW50OwoJCgl0aGlzLmZpbHRlclN0YWNrID0gW107Cgl0aGlzLnRleHR1cmVQb29sID0gW107CgkKCXRoaXMub2Zmc2V0WCA9IDA7Cgl0aGlzLm9mZnNldFkgPSAwOwoJCgl0aGlzLmluaXRTaGFkZXJCdWZmZXJzKCk7Cn0KCi8vIEFQSQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmJlZ2luID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgYnVmZmVyKQp7Cgl0aGlzLndpZHRoID0gcHJvamVjdGlvbi54ICogMjsKCXRoaXMuaGVpZ2h0ID0gLXByb2plY3Rpb24ueSAqIDI7Cgl0aGlzLmJ1ZmZlciA9IGJ1ZmZlcjsKfQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLnB1c2hGaWx0ZXIgPSBmdW5jdGlvbihmaWx0ZXJCbG9jaykKewoJdmFyIGdsID0gUElYSS5nbDsKCgkvLyBmaWx0ZXIgcHJvZ3JhbQoJLy8gT1BUSU1JU0FUSU9OIC0gdGhlIGZpcnN0IGZpbHRlciBpcyBmcmVlIGlmIGl0cyBhIHNpbXBsZSBjb2xvciBjaGFuZ2U/Cgl0aGlzLmZpbHRlclN0YWNrLnB1c2goZmlsdGVyQmxvY2spOwoKCXZhciBmaWx0ZXIgPSBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXNbMF07CgoJCgoJdGhpcy5vZmZzZXRYICs9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhLng7Cgl0aGlzLm9mZnNldFkgKz0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWEueTsKCQoJCgkKCQoJCgl2YXIgdGV4dHVyZSA9IHRoaXMudGV4dHVyZVBvb2wucG9wKCk7CglpZighdGV4dHVyZSl0ZXh0dXJlID0gbmV3IFBJWEkuRmlsdGVyVGV4dHVyZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkKCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsICB0ZXh0dXJlLnRleHR1cmUpOwoJCgl0aGlzLmdldEJvdW5kcyhmaWx0ZXJCbG9jay50YXJnZXQpOwoJCQoJLy8gYWRkcGFkZGluZz8KCS8vZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLngKCgl2YXIgZmlsdGVyQXJlYSA9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhOwoKCXZhciBwYWRpZG5nID0gZmlsdGVyLnBhZGRpbmc7CglmaWx0ZXJBcmVhLnggLT0gcGFkaWRuZzsKCWZpbHRlckFyZWEueSAtPSBwYWRpZG5nOwoJZmlsdGVyQXJlYS53aWR0aCArPSBwYWRpZG5nICogMjsKCWZpbHRlckFyZWEuaGVpZ2h0ICs9IHBhZGlkbmcgKiAyOwoKCS8vIGNhcCBmaWx0ZXIgdG8gc2NyZWVuIHNpemUuLgoJaWYoZmlsdGVyQXJlYS54IDwgMClmaWx0ZXJBcmVhLnggPSAwOwkKCWlmKGZpbHRlckFyZWEud2lkdGggPiB0aGlzLndpZHRoKWZpbHRlckFyZWEud2lkdGggPSB0aGlzLndpZHRoOwoJaWYoZmlsdGVyQXJlYS55IDwgMClmaWx0ZXJBcmVhLnkgPSAwOwkKCWlmKGZpbHRlckFyZWEuaGVpZ2h0ID4gdGhpcy5oZWlnaHQpZmlsdGVyQXJlYS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCgoJLy9nbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsICBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CglnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRleHR1cmUuZnJhbWVCdWZmZXIpOwogICAKICAvLyBjb25zb2xlLmxvZyhmaWx0ZXJBcmVhKQoJLy8gc2V0IHZpZXcgcG9ydAoJZ2wudmlld3BvcnQoMCwgMCwgZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQpOwkKCQoJUElYSS5wcm9qZWN0aW9uLnggPSBmaWx0ZXJBcmVhLndpZHRoLzI7CglQSVhJLnByb2plY3Rpb24ueSA9IC1maWx0ZXJBcmVhLmhlaWdodC8yOwoJCglQSVhJLm9mZnNldC54ID0gLWZpbHRlckFyZWEueDsgCglQSVhJLm9mZnNldC55ID0gLWZpbHRlckFyZWEueTsKCgkvL2NvbnNvbGUubG9nKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yKQoJLy8gdXBkYXRlIHByb2plY3Rpb24KCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIucHJvamVjdGlvblZlY3RvciwgZmlsdGVyQXJlYS53aWR0aC8yLCAtZmlsdGVyQXJlYS5oZWlnaHQvMik7CglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLm9mZnNldFZlY3RvciwgLWZpbHRlckFyZWEueCwgLWZpbHRlckFyZWEueSk7CgkvL1BJWEkucHJpbWl0aXZlUHJvZ3JhbQoKCWdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsgCglnbC5jbGVhckNvbG9yKDAsMCwwLCAwKTsgICAgIAoJZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgkKCS8vZmlsdGVyLnRleHR1cmUgPSB0ZXh0dXJlOwoJZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZSA9IHRleHR1cmU7CgoJLy9jb25zb2xlLmxvZygiUFVTSCIpCn0KCgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUucG9wRmlsdGVyID0gZnVuY3Rpb24oKQp7CgkKCXZhciBnbCA9IFBJWEkuZ2w7CgkKCXZhciBmaWx0ZXJCbG9jayA9IHRoaXMuZmlsdGVyU3RhY2sucG9wKCk7CgoKCgl2YXIgZmlsdGVyQXJlYSA9IGZpbHRlckJsb2NrLnRhcmdldC5maWx0ZXJBcmVhOwoKCXZhciB0ZXh0dXJlID0gZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZTsKCglpZihmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoID4gMSkKCXsKCQlnbC52aWV3cG9ydCgwLCAwLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CgoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CgkKCQl0aGlzLnZlcnRleEFycmF5WzBdID0gMDsKCQl0aGlzLnZlcnRleEFycmF5WzFdID0gZmlsdGVyQXJlYS5oZWlnaHQ7CgkJCgkJdGhpcy52ZXJ0ZXhBcnJheVsyXSA9IGZpbHRlckFyZWEud2lkdGg7CgkJdGhpcy52ZXJ0ZXhBcnJheVszXSA9IGZpbHRlckFyZWEuaGVpZ2h0OwoJCQoJCXRoaXMudmVydGV4QXJyYXlbNF0gPSAwOwoJCXRoaXMudmVydGV4QXJyYXlbNV0gPSAwOwoJCQoJCXRoaXMudmVydGV4QXJyYXlbNl0gPSBmaWx0ZXJBcmVhLndpZHRoOwoJCXRoaXMudmVydGV4QXJyYXlbN10gPSAwOwoKCgkJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudmVydGV4QXJyYXkpOwoKCQoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKCQkvLyBubm93IHNldCB0aGUgdXZzLi4KCQl0aGlzLnV2QXJyYXlbMl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7CgkJdGhpcy51dkFycmF5WzVdID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7CgkJdGhpcy51dkFycmF5WzZdID0gZmlsdGVyQXJlYS53aWR0aC90aGlzLndpZHRoOwoJCXRoaXMudXZBcnJheVs3XSA9IGZpbHRlckFyZWEuaGVpZ2h0L3RoaXMuaGVpZ2h0OwoJCQoJCWdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnV2QXJyYXkpOwoKCQl2YXIgaW5wdXRUZXh0dXJlID0gdGV4dHVyZTsKCQl2YXIgb3V0cHV0VGV4dHVyZSA9IHRoaXMudGV4dHVyZVBvb2wucG9wKCk7CgkJaWYoIW91dHB1dFRleHR1cmUpb3V0cHV0VGV4dHVyZSA9IG5ldyBQSVhJLkZpbHRlclRleHR1cmUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoJCQoJCS8vIG5lZWQgdG8gY2xlYXIgdGhpcyBGQk8gYXMgaXQgbWF5IGhhdmUgc29tZSBsZWZ0IG92ZXIgZWxlbWVudHMgZnJvbSBhIHBydmlvdXMgZmlsdGVyLgoJCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgb3V0cHV0VGV4dHVyZS5mcmFtZUJ1ZmZlciApOyAgICAgCgkJZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgkgCgkJZ2wuZGlzYWJsZShnbC5CTEVORCk7CgkJCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoLTE7IGkrKykgCgkJewoJCQl2YXIgZmlsdGVyUGFzcyA9IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlc1tpXTsKCQoJCQlnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIG91dHB1dFRleHR1cmUuZnJhbWVCdWZmZXIgKTsKCQkJCgkJCS8vIHNldCB0ZXh0dXJlCgkJICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJCQlnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBpbnB1dFRleHR1cmUudGV4dHVyZSk7CgkJCQoJCQkvLyBkcmF3IHRleHR1cmUuLgoJCQkvL2ZpbHRlclBhc3MuYXBwbHlGaWx0ZXJQYXNzKGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0KTsKCQkJdGhpcy5hcHBseUZpbHRlclBhc3MoZmlsdGVyUGFzcywgZmlsdGVyQXJlYSwgZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQpOwoKCQkJLy8gc3dhcCB0aGUgdGV4dHVyZXMuLgoJCQl2YXIgdGVtcCA9IGlucHV0VGV4dHVyZTsKCQkJaW5wdXRUZXh0dXJlID0gb3V0cHV0VGV4dHVyZTsKCQkJb3V0cHV0VGV4dHVyZSA9IHRlbXA7CgkJCQoJCX07CgoJCWdsLmVuYWJsZShnbC5CTEVORCk7CgoJCXRleHR1cmUgPSBpbnB1dFRleHR1cmU7CgkJdGhpcy50ZXh0dXJlUG9vbC5wdXNoKG91dHB1dFRleHR1cmUpOwoJfQoKCXZhciBmaWx0ZXIgPSBmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXNbZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzLmxlbmd0aC0xXTsKCQoJdGhpcy5vZmZzZXRYIC09IGZpbHRlckFyZWEueDsKCXRoaXMub2Zmc2V0WSAtPSBmaWx0ZXJBcmVhLnk7CgoJCgl2YXIgc2l6ZVggPSB0aGlzLndpZHRoOwoJdmFyIHNpemVZID0gdGhpcy5oZWlnaHQ7CgkKCXZhciBvZmZzZXRYID0gMDsKCXZhciBvZmZzZXRZID0gMDsKCQoJdmFyIGJ1ZmZlciA9IHRoaXMuYnVmZmVyOwoJCgkvLyB0aW1lIHRvIHJlbmRlciB0aGUgZmlsdGVycyB0ZXh0dXJlIHRvIHRoZSBwcmV2aW91cyBzY2VuZQoJaWYodGhpcy5maWx0ZXJTdGFjay5sZW5ndGggPT09IDApCgl7CgkJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRoaXMudHJhbnNwYXJlbnQpOyAKCX0KCWVsc2UKCXsKCQl2YXIgY3VycmVudEZpbHRlciA9IHRoaXMuZmlsdGVyU3RhY2tbdGhpcy5maWx0ZXJTdGFjay5sZW5ndGgtMV07CgkJdmFyIGZpbHRlckFyZWEgPSBjdXJyZW50RmlsdGVyLnRhcmdldC5maWx0ZXJBcmVhOwoJCQoJCXNpemVYID0gZmlsdGVyQXJlYS53aWR0aDsKCQlzaXplWSA9IGZpbHRlckFyZWEuaGVpZ2h0OwoJCQoJCW9mZnNldFggPSBmaWx0ZXJBcmVhLng7CgkJb2Zmc2V0WSA9IGZpbHRlckFyZWEueTsKCQkKCQlidWZmZXIgPSAgY3VycmVudEZpbHRlci5fZ2xGaWx0ZXJUZXh0dXJlLmZyYW1lQnVmZmVyOwoJfQoJCgkKCgkvLyBUT0RPIG5lZWQgdG9yZW1vdmUgdGhlYXNlIGdsb2JhbCBlbGVtZW50cy4uCglQSVhJLnByb2plY3Rpb24ueCA9IHNpemVYLzI7CglQSVhJLnByb2plY3Rpb24ueSA9IC1zaXplWS8yOwoKCVBJWEkub2Zmc2V0LnggPSBvZmZzZXRYOwoJUElYSS5vZmZzZXQueSA9IG9mZnNldFk7IAoJCgoJdmFyIGZpbHRlckFyZWEgPSAgZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWE7Cgl2YXIgeCA9IGZpbHRlckFyZWEueC1vZmZzZXRYOwoJdmFyIHkgPSBmaWx0ZXJBcmVhLnktb2Zmc2V0WTsKCQoJLy8gdXBkYXRlIHRoZSBidWZmZXJzLi4JCgkvLyBtYWtlIHN1cmUgdG8gZmxpcCB0aGUgeSEKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CgkKCXRoaXMudmVydGV4QXJyYXlbMF0gPSB4OwoJdGhpcy52ZXJ0ZXhBcnJheVsxXSA9IHkgKyBmaWx0ZXJBcmVhLmhlaWdodDsKCQoJdGhpcy52ZXJ0ZXhBcnJheVsyXSA9IHggKyBmaWx0ZXJBcmVhLndpZHRoOwoJdGhpcy52ZXJ0ZXhBcnJheVszXSA9IHkgKyBmaWx0ZXJBcmVhLmhlaWdodDsKCQoJdGhpcy52ZXJ0ZXhBcnJheVs0XSA9IHg7Cgl0aGlzLnZlcnRleEFycmF5WzVdID0geTsKCQoJdGhpcy52ZXJ0ZXhBcnJheVs2XSA9IHggKyBmaWx0ZXJBcmVhLndpZHRoOwoJdGhpcy52ZXJ0ZXhBcnJheVs3XSA9IHk7CgoJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudmVydGV4QXJyYXkpOwoJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CgoJdGhpcy51dkFycmF5WzJdID0gZmlsdGVyQXJlYS53aWR0aC90aGlzLndpZHRoOwoJdGhpcy51dkFycmF5WzVdID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7Cgl0aGlzLnV2QXJyYXlbNl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7Cgl0aGlzLnV2QXJyYXlbN10gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKCQoJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudXZBcnJheSk7CgoJZ2wudmlld3BvcnQoMCwgMCwgc2l6ZVgsIHNpemVZKTsJCgkvLyBiaW5kIHRoZSBidWZmZXIKCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgYnVmZmVyICk7CgkKCS8vIHNldCB0ZXh0dXJlCiAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUudGV4dHVyZSk7CgkKCS8vIGFwcGx5IQoJLy9maWx0ZXIuYXBwbHlGaWx0ZXJQYXNzKHNpemVYLCBzaXplWSk7Cgl0aGlzLmFwcGx5RmlsdGVyUGFzcyhmaWx0ZXIsIGZpbHRlckFyZWEsIHNpemVYLCBzaXplWSk7CgoJLy8gbm93IHJlc3RvcmUgdGhlIHJlZ3VsYXIgc2hhZGVyLi4KICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwoJZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBzaXplWC8yLCAtc2l6ZVkvMik7CglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLm9mZnNldFZlY3RvciwgLW9mZnNldFgsIC1vZmZzZXRZKTsKCgkvLyByZXR1cm4gdGhlIHRleHR1cmUgdG8gdGhlIHBvb2wKCXRoaXMudGV4dHVyZVBvb2wucHVzaCh0ZXh0dXJlKTsKCWZpbHRlckJsb2NrLl9nbEZpbHRlclRleHR1cmUgPSBudWxsOwkKfQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmFwcGx5RmlsdGVyUGFzcyA9IGZ1bmN0aW9uKGZpbHRlciwgZmlsdGVyQXJlYSwgd2lkdGgsIGhlaWdodCkKewoJLy8gdXNlIHByb2dyYW0KCXZhciBnbCA9IFBJWEkuZ2w7CgoJaWYoIWZpbHRlci5zaGFkZXIpCgl7CgkJdmFyIHNoYWRlciA9IG5ldyBQSVhJLlBpeGlTaGFkZXIoKTsKCQkJCQoJCXNoYWRlci5mcmFnbWVudFNyYyA9IGZpbHRlci5mcmFnbWVudFNyYzsKCQlzaGFkZXIudW5pZm9ybXMgPSBmaWx0ZXIudW5pZm9ybXM7CgkJc2hhZGVyLmluaXQoKTsKCQkKCQlmaWx0ZXIuc2hhZGVyID0gc2hhZGVyOwoJfQoKCXZhciBzaGFkZXIgPSBmaWx0ZXIuc2hhZGVyOwoJCgkvLyBzZXQgdGhlIHNoYWRlcgoJZ2wudXNlUHJvZ3JhbShzaGFkZXIucHJvZ3JhbSk7CgoJZ2wudW5pZm9ybTJmKHNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCB3aWR0aC8yLCAtaGVpZ2h0LzIpOwoJZ2wudW5pZm9ybTJmKHNoYWRlci5vZmZzZXRWZWN0b3IsIDAsMCkKCglpZihmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucykKCXsKCQkvL2NvbnNvbGUubG9nKGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zKQoJCWZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzBdID0gdGhpcy53aWR0aDsvL3dpZHRoOwoJCWZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzFdID0gdGhpcy5oZWlnaHQ7Ly9oZWlnaHQ7CgkJZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMudmFsdWVbMl0gPSB0aGlzLnZlcnRleEFycmF5WzBdOwoJCWZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zLnZhbHVlWzNdID0gdGhpcy52ZXJ0ZXhBcnJheVs1XTsvL2ZpbHRlckFyZWEuaGVpZ2h0OwoJLy8JY29uc29sZS5sb2codGhpcy52ZXJ0ZXhBcnJheVs1XSkKCX0KCglzaGFkZXIuc3luY1VuaWZvcm1zKCk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVmVydGV4UG9zaXRpb24sIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CiAgIAogICAJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwogICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVRleHR1cmVDb29yZCwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRleEJ1ZmZlcik7CiAgICAKCS8vIGRyYXcgdGhlIGZpbHRlci4uLgogICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgNiwgZ2wuVU5TSUdORURfU0hPUlQsIDAgKTsKfQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmluaXRTaGFkZXJCdWZmZXJzID0gZnVuY3Rpb24oKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoJCgkvLyBjcmVhdGUgc29tZSBidWZmZXJzCgl0aGlzLnZlcnRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwkKCXRoaXMudXZCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMuaW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCQoJLy8gYmluZCBhbmQgdXBsb2FkIHRoZSB2ZXJ0ZXhzLi4KCS8vIGtlZXAgYSByZWZmZXJhbmNlIHRvIHRoZSB2ZXJ0ZXhGbG9hdERhdGEuLgoJdGhpcy52ZXJ0ZXhBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoWzAuMCwgMC4wLCAKCQkJCQkJCQkgICAgICAgICAxLjAsIDAuMCwgCgkJCQkJCQkJICAgICAgICAgMC4wLCAxLjAsIAoJCQkJCQkJCSAgICAgICAgIDEuMCwgMS4wXSk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnZlcnRleEJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKAogICAgZ2wuQVJSQVlfQlVGRkVSLCAKICAgIHRoaXMudmVydGV4QXJyYXksIAogICAgZ2wuU1RBVElDX0RSQVcpOwogICAgCiAgICAKICAgIC8vIGJpbmQgYW5kIHVwbG9hZCB0aGUgdXYgYnVmZmVyCgl0aGlzLnV2QXJyYXkgPSBuZXcgRmxvYXQzMkFycmF5KFswLjAsIDAuMCwgCgkJCQkJCQkJICAgICAxLjAsIDAuMCwgCgkJCQkJCQkJICAgICAwLjAsIDEuMCwgCgkJCQkJCQkJICAgICAxLjAsIDEuMF0pOwoJCQkJCQkJCSAgICAgICAgIAoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YSgKICAgIGdsLkFSUkFZX0JVRkZFUiwgCiAgICB0aGlzLnV2QXJyYXksIAogICAgZ2wuU1RBVElDX0RSQVcpOwogICAgCgkvLyBiaW5kIGFuZCB1cGxvYWQgdGhlIGluZGV4CglnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoCiAgICBnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgCiAgICBuZXcgVWludDE2QXJyYXkoWzAsIDEsIDIsIDEsIDMsIDJdKSwgCiAgICBnbC5TVEFUSUNfRFJBVyk7Cn0KClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyLnByb3RvdHlwZS5nZXRCb3VuZHMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CgkvLyB0aW1lIHRvIGdldCB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgb2JqZWN0IQoJdmFyIHdvcmxkVHJhbnNmb3JtLCB3aWR0aCwgaGVpZ2h0LCBhWCwgYVksIHcwLCB3MSwgaDAsIGgxLCBpbmRleCwgZG9UZXN0OwoJdmFyIGEsIGIsIGMsIGQsIHR4LCB0eSwgeDEsIHgyLCB4MywgeDQsIHkxLCB5MiwgeTMsIHk0OwoKCXZhciB0ZW1wT2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCQoJdmFyIG1heFggPSAtSW5maW5pdHk7Cgl2YXIgbWF4WSA9IC1JbmZpbml0eTsKCQoJdmFyIG1pblggPSBJbmZpbml0eTsKCXZhciBtaW5ZID0gSW5maW5pdHk7CgkKCWRvCQoJewoJCS8vIFRPRE8gY2FuIGJlIG9wdGltaXplZCEgLSB3aGF0IGlmIHRoZXJlIGlzIG5vIHNjYWxlIC8gcm90YXRpb24/CgkJCgkJaWYodGVtcE9iamVjdC52aXNpYmxlKQoJCXsKCQkJaWYodGVtcE9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJCQl7CgkJCQl3aWR0aCA9IHRlbXBPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aDsKCQkJCWhlaWdodCA9IHRlbXBPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgoJCQkJLy8gVE9ETyB0cmltPz8KCQkJCWFYID0gdGVtcE9iamVjdC5hbmNob3IueDsKCQkJCWFZID0gdGVtcE9iamVjdC5hbmNob3IueTsKCQkJCXcwID0gd2lkdGggKiAoMS1hWCk7CgkJCQl3MSA9IHdpZHRoICogLWFYOwoKCQkJCWgwID0gaGVpZ2h0ICogKDEtYVkpOwoJCQkJaDEgPSBoZWlnaHQgKiAtYVk7CgoJCQkJZG9UZXN0ID0gdHJ1ZTsKCQkJfQoJCQllbHNlIGlmKHRlbXBPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJCQl7CgkJCQl0ZW1wT2JqZWN0LnVwZGF0ZUZpbHRlckJvdW5kcygpOwoKCQkJCXZhciBib3VuZHMgPSB0ZW1wT2JqZWN0LmJvdW5kczsKCgkJCQl3aWR0aCA9IGJvdW5kcy53aWR0aDsKCQkJCWhlaWdodCA9IGJvdW5kcy5oZWlnaHQ7CgoJCQkJdzAgPSBib3VuZHMueAoJCQkJdzEgPSBib3VuZHMueCArIGJvdW5kcy53aWR0aDsKCgkJCQloMCA9IGJvdW5kcy55CgkJCQloMSA9IGJvdW5kcy55ICsgYm91bmRzLmhlaWdodDsKCgkJCQlkb1Rlc3QgPSB0cnVlOwkKCQkJfQoJCX0KCQkKCQlpZihkb1Rlc3QpCgkJewoJCQl3b3JsZFRyYW5zZm9ybSA9IHRlbXBPYmplY3Qud29ybGRUcmFuc2Zvcm07CgoJCQlhID0gd29ybGRUcmFuc2Zvcm1bMF07CgkJCWIgPSB3b3JsZFRyYW5zZm9ybVszXTsKCQkJYyA9IHdvcmxkVHJhbnNmb3JtWzFdOwoJCQlkID0gd29ybGRUcmFuc2Zvcm1bNF07CgkJCXR4ID0gd29ybGRUcmFuc2Zvcm1bMl07CgkJCXR5ID0gd29ybGRUcmFuc2Zvcm1bNV07CgoJCQl4MSA9IGEgKiB3MSArIGMgKiBoMSArIHR4OyAKCQkJeTEgPSBkICogaDEgKyBiICogdzEgKyB0eTsKCgkJCXgyID0gYSAqIHcwICsgYyAqIGgxICsgdHg7IAoJCQl5MiA9IGQgKiBoMSArIGIgKiB3MCArIHR5OyAKCgkJCXgzID0gYSAqIHcwICsgYyAqIGgwICsgdHg7IAoJCQl5MyA9IGQgKiBoMCArIGIgKiB3MCArIHR5OyAKCgkJCXg0ID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OyAKCQkJeTQgPSAgZCAqIGgwICsgYiAqIHcxICsgdHk7IAoKCQkJbWluWCA9IHgxIDwgbWluWCA/IHgxIDogbWluWDsKCQkJbWluWCA9IHgyIDwgbWluWCA/IHgyIDogbWluWDsKCQkJbWluWCA9IHgzIDwgbWluWCA/IHgzIDogbWluWDsKCQkJbWluWCA9IHg0IDwgbWluWCA/IHg0IDogbWluWDsKCQkJCgkJCW1pblkgPSB5MSA8IG1pblkgPyB5MSA6IG1pblk7CgkJCW1pblkgPSB5MiA8IG1pblkgPyB5MiA6IG1pblk7CgkJCW1pblkgPSB5MyA8IG1pblkgPyB5MyA6IG1pblk7CgkJCW1pblkgPSB5NCA8IG1pblkgPyB5NCA6IG1pblk7CgkJCQoJCQltYXhYID0geDEgPiBtYXhYID8geDEgOiBtYXhYOwoJCQltYXhYID0geDIgPiBtYXhYID8geDIgOiBtYXhYOwoJCQltYXhYID0geDMgPiBtYXhYID8geDMgOiBtYXhYOwoJCQltYXhYID0geDQgPiBtYXhYID8geDQgOiBtYXhYOwoJCQkKCQkJbWF4WSA9IHkxID4gbWF4WSA/IHkxIDogbWF4WTsKCQkJbWF4WSA9IHkyID4gbWF4WSA/IHkyIDogbWF4WTsKCQkJbWF4WSA9IHkzID4gbWF4WSA/IHkzIDogbWF4WTsKCQkJbWF4WSA9IHk0ID4gbWF4WSA/IHk0IDogbWF4WTsKCQl9CgoJCWRvVGVzdCA9IGZhbHNlOwoJCXRlbXBPYmplY3QgPSB0ZW1wT2JqZWN0Ll9pTmV4dDsKCgl9Cgl3aGlsZSh0ZW1wT2JqZWN0ICE9IHRlc3RPYmplY3QpCgkKCS8vIG1heGltdW0gYm91bmRzIGlzIHRoZSBzaXplIG9mIHRoZSBzY3JlZW4uLgoJLy9taW5YID0gbWluWCA+IDAgPyBtaW5YIDogMDsKCS8vbWluWSA9IG1pblkgPiAwID8gbWluWSA6IDA7CgoJZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLnggPSBtaW5YOwoJZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLnkgPSBtaW5ZOwoKLy8JY29uc29sZS5sb2cobWF4WCsgIiA6ICIgKyBtaW5YKQoJZGlzcGxheU9iamVjdC5maWx0ZXJBcmVhLndpZHRoID0gbWF4WCAtIG1pblg7CglkaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEuaGVpZ2h0ID0gbWF4WSAtIG1pblk7Cn0KClBJWEkuRmlsdGVyVGV4dHVyZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCXZhciBnbCA9IFBJWEkuZ2w7CgkKICAgIC8vIG5leHQgdGltZSB0byBjcmVhdGUgYSBmcmFtZSBidWZmZXIgYW5kIHRleHR1cmUKCXRoaXMuZnJhbWVCdWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwogICAgdGhpcy50ZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwoKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsICB0aGlzLnRleHR1cmUpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7CglnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZnJhbWVidWZmZXIgKTsKCQoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmZyYW1lQnVmZmVyICk7CglnbC5mcmFtZWJ1ZmZlclRleHR1cmUyRChnbC5GUkFNRUJVRkZFUiwgZ2wuQ09MT1JfQVRUQUNITUVOVDAsIGdsLlRFWFRVUkVfMkQsIHRoaXMudGV4dHVyZSwgMCk7CgkKCXRoaXMucmVzaXplKHdpZHRoLCBoZWlnaHQpOwp9CgpQSVhJLkZpbHRlclRleHR1cmUucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCXRoaXMud2lkdGggPSB3aWR0aDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCXZhciBnbCA9IFBJWEkuZ2w7CgoJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgIHRoaXMudGV4dHVyZSk7CglnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsICB3aWR0aCwgaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCQp9Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBzZXQgb2YgZnVuY3Rpb25zIHVzZWQgYnkgdGhlIHdlYkdMIHJlbmRlcmVyIHRvIGRyYXcgdGhlIHByaW1pdGl2ZSBncmFwaGljcyBkYXRhCiAqCiAqIEBjbGFzcyBDYW52YXNHcmFwaGljcwogKi8KUElYSS5XZWJHTEdyYXBoaWNzID0gZnVuY3Rpb24oKQp7CgkKfQoKLyoqCiAqIFJlbmRlcnMgdGhlIGdyYXBoaWNzIG9iamVjdAogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgcmVuZGVyR3JhcGhpY3MKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBwcm9qZWN0aW9uKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoJCglpZighZ3JhcGhpY3MuX3dlYkdMKWdyYXBoaWNzLl93ZWJHTCA9IHtwb2ludHM6W10sIGluZGljZXM6W10sIGxhc3RJbmRleDowLCAKCQkJCQkJCQkJCSAgIGJ1ZmZlcjpnbC5jcmVhdGVCdWZmZXIoKSwKCQkJCQkJCQkJCSAgIGluZGV4QnVmZmVyOmdsLmNyZWF0ZUJ1ZmZlcigpfTsKCQoJaWYoZ3JhcGhpY3MuZGlydHkpCgl7CgkJZ3JhcGhpY3MuZGlydHkgPSBmYWxzZTsKCQkKCQlpZihncmFwaGljcy5jbGVhckRpcnR5KQoJCXsKCQkJZ3JhcGhpY3MuY2xlYXJEaXJ0eSA9IGZhbHNlOwoJCQkKCQkJZ3JhcGhpY3MuX3dlYkdMLmxhc3RJbmRleCA9IDA7CgkJCWdyYXBoaWNzLl93ZWJHTC5wb2ludHMgPSBbXTsKCQkJZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMgPSBbXTsKCQkJCgkJfQoJCQoJCVBJWEkuV2ViR0xHcmFwaGljcy51cGRhdGVHcmFwaGljcyhncmFwaGljcyk7Cgl9CgkKCVBJWEkuYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIoKTsKCQoJLy8gVGhpcyAgY291bGQgYmUgc3BlZWRlZCB1cCBmbyBzdXJlIQoJdmFyIG0gPSBQSVhJLm1hdDMuY2xvbmUoZ3JhcGhpY3Mud29ybGRUcmFuc2Zvcm0pOwoJCglQSVhJLm1hdDMudHJhbnNwb3NlKG0pOwoJCgkvLyBzZXQgdGhlIG1hdHJpeCB0cmFuc2Zvcm0gZm9yIHRoZSAKIAlnbC5ibGVuZEZ1bmMoZ2wuT05FLCBnbC5PTkVfTUlOVVNfU1JDX0FMUEhBKTsKCiAJZ2wudW5pZm9ybU1hdHJpeDNmdihQSVhJLnByaW1pdGl2ZVNoYWRlci50cmFuc2xhdGlvbk1hdHJpeCwgZmFsc2UsIG0pOwogCQoJZ2wudW5pZm9ybTJmKFBJWEkucHJpbWl0aXZlU2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgLXByb2plY3Rpb24ueSk7CglnbC51bmlmb3JtMmYoUElYSS5wcmltaXRpdmVTaGFkZXIub2Zmc2V0VmVjdG9yLCAtUElYSS5vZmZzZXQueCwgLVBJWEkub2Zmc2V0LnkpOwoJCglnbC51bmlmb3JtMWYoUElYSS5wcmltaXRpdmVTaGFkZXIuYWxwaGEsIGdyYXBoaWNzLndvcmxkQWxwaGEpOwoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5idWZmZXIpOwoJCglnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCA0ICogNiwgMCk7CglnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKFBJWEkucHJpbWl0aXZlU2hhZGVyLmNvbG9yQXR0cmlidXRlLCA0LCBnbC5GTE9BVCwgZmFsc2UsNCAqIDYsIDIgKiA0KTsKCQoJLy8gc2V0IHRoZSBpbmRleCBidWZmZXIhCglnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuaW5kZXhCdWZmZXIpOwoJCgoJZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFX1NUUklQLCAgZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMubGVuZ3RoLCBnbC5VTlNJR05FRF9TSE9SVCwgMCApOwoJCglQSVhJLmRlYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIoKTsKCQoJCgkvLyByZXR1cm4gdG8gZGVmYXVsdCBzaGFkZXIuLi4KLy8JUElYSS5hY3RpdmF0ZVNoYWRlcihQSVhJLmRlZmF1bHRTaGFkZXIpOwp9CgovKioKICogVXBkYXRlcyB0aGUgZ3JhcGhpY3Mgb2JqZWN0CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCB1cGRhdGVHcmFwaGljcwogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLnVwZGF0ZUdyYXBoaWNzID0gZnVuY3Rpb24oZ3JhcGhpY3MpCnsKCWZvciAodmFyIGk9Z3JhcGhpY3MuX3dlYkdMLmxhc3RJbmRleDsgaSA8IGdyYXBoaWNzLmdyYXBoaWNzRGF0YS5sZW5ndGg7IGkrKykgCgl7CgkJdmFyIGRhdGEgPSBncmFwaGljcy5ncmFwaGljc0RhdGFbaV07CgkJCgkJaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuUE9MWSkKCQl7CgkJCWlmKGRhdGEuZmlsbCkKCQkJewoJCQkJaWYoZGF0YS5wb2ludHMubGVuZ3RoPjMpIAoJCQkJUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkUG9seShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwoJCQl9CgkJCQoJCQlpZihkYXRhLmxpbmVXaWR0aCA+IDApCgkJCXsKCQkJCVBJWEkuV2ViR0xHcmFwaGljcy5idWlsZExpbmUoZGF0YSwgZ3JhcGhpY3MuX3dlYkdMKTsKCQkJfQoJCX0KCQllbHNlIGlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLlJFQ1QpCgkJewoJCQlQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRSZWN0YW5nbGUoZGF0YSwgZ3JhcGhpY3MuX3dlYkdMKTsKCQl9CgkJZWxzZSBpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5DSVJDIHx8IGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLkVMSVApCgkJewoJCQlQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRDaXJjbGUoZGF0YSwgZ3JhcGhpY3MuX3dlYkdMKTsKCQl9Cgl9OwoJCglncmFwaGljcy5fd2ViR0wubGFzdEluZGV4ID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsKCQoJdmFyIGdsID0gUElYSS5nbDsKCglncmFwaGljcy5fd2ViR0wuZ2xQb2ludHMgPSBuZXcgRmxvYXQzMkFycmF5KGdyYXBoaWNzLl93ZWJHTC5wb2ludHMpOwoJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmdsUG9pbnRzLCBnbC5TVEFUSUNfRFJBVyk7CgkKCWdyYXBoaWNzLl93ZWJHTC5nbEluZGljaWVzID0gbmV3IFVpbnQxNkFycmF5KGdyYXBoaWNzLl93ZWJHTC5pbmRpY2VzKTsKCQoJZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmluZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5nbEluZGljaWVzLCBnbC5TVEFUSUNfRFJBVyk7Cn0KCi8qKgogKiBCdWlsZHMgYSByZWN0YW5nbGUgdG8gZHJhdwogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgYnVpbGRSZWN0YW5nbGUKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHdlYkdMRGF0YSB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkUmVjdGFuZ2xlID0gZnVuY3Rpb24oZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpCnsKCS8vIC0tLSAvLwoJLy8gbmVlZCB0byBjb252ZXJ0IHBvaW50cyB0byBhIG5pY2UgcmVndWxhciBkYXRhCgkvLyAKCXZhciByZWN0RGF0YSA9IGdyYXBoaWNzRGF0YS5wb2ludHM7Cgl2YXIgeCA9IHJlY3REYXRhWzBdOwoJdmFyIHkgPSByZWN0RGF0YVsxXTsKCXZhciB3aWR0aCA9IHJlY3REYXRhWzJdOwoJdmFyIGhlaWdodCA9IHJlY3REYXRhWzNdOwoJCgkKCWlmKGdyYXBoaWNzRGF0YS5maWxsKQoJewoJCXZhciBjb2xvciA9IEhFWHRvUkdCKGdyYXBoaWNzRGF0YS5maWxsQ29sb3IpOwoJCXZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7CgkJCgkJdmFyIHIgPSBjb2xvclswXSAqIGFscGhhOwoJCXZhciBnID0gY29sb3JbMV0gKiBhbHBoYTsKCQl2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgkKCQl2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwoJCXZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CgkKCQl2YXIgdmVydFBvcyA9IHZlcnRzLmxlbmd0aC82OwoJCQoJCS8vIHN0YXJ0CgkJdmVydHMucHVzaCh4LCB5KTsKCQl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQkKCQl2ZXJ0cy5wdXNoKHggKyB3aWR0aCwgeSk7CgkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCgkJdmVydHMucHVzaCh4ICwgeSArIGhlaWdodCk7CgkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCgkJdmVydHMucHVzaCh4ICsgd2lkdGgsIHkgKyBoZWlnaHQpOwoJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCQoJCS8vIGluc2VydCAyIGRlYWQgdHJpYW5nbGVzLi4KCQlpbmRpY2VzLnB1c2godmVydFBvcywgdmVydFBvcywgdmVydFBvcysxLCB2ZXJ0UG9zKzIsIHZlcnRQb3MrMywgdmVydFBvcyszKQoJfQoJCglpZihncmFwaGljc0RhdGEubGluZVdpZHRoKQoJewoJCWdyYXBoaWNzRGF0YS5wb2ludHMgPSBbeCwgeSwKCQkJCSAgeCArIHdpZHRoLCB5LAoJCQkJICB4ICsgd2lkdGgsIHkgKyBoZWlnaHQsCgkJCQkgIHgsIHkgKyBoZWlnaHQsCgkJCQkgIHgsIHldOwoJCgkJUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShncmFwaGljc0RhdGEsIHdlYkdMRGF0YSk7Cgl9CgkKfQoKLyoqCiAqIEJ1aWxkcyBhIGNpcmNsZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZENpcmNsZQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRDaXJjbGUgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewoJLy8gLS0tIC8vCgkvLyBuZWVkIHRvIGNvbnZlcnQgcG9pbnRzIHRvIGEgbmljZSByZWd1bGFyIGRhdGEKCS8vIAoJdmFyIHJlY3REYXRhID0gZ3JhcGhpY3NEYXRhLnBvaW50czsKCXZhciB4ID0gcmVjdERhdGFbMF07Cgl2YXIgeSA9IHJlY3REYXRhWzFdOwoJdmFyIHdpZHRoID0gcmVjdERhdGFbMl07Cgl2YXIgaGVpZ2h0ID0gcmVjdERhdGFbM107CgkKCXZhciB0b3RhbFNlZ3MgPSA0MDsKCXZhciBzZWcgPSAoTWF0aC5QSSAqIDIpIC8gdG90YWxTZWdzIDsKCQkKCWlmKGdyYXBoaWNzRGF0YS5maWxsKQoJewoJCXZhciBjb2xvciA9IEhFWHRvUkdCKGdyYXBoaWNzRGF0YS5maWxsQ29sb3IpOwoJCXZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7CgoJCXZhciByID0gY29sb3JbMF0gKiBhbHBoYTsKCQl2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7CgkJdmFyIGIgPSBjb2xvclsyXSAqIGFscGhhOwoJCgkJdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKCQl2YXIgaW5kaWNlcyA9IHdlYkdMRGF0YS5pbmRpY2VzOwoJCgkJdmFyIHZlY1BvcyA9IHZlcnRzLmxlbmd0aC82OwoJCQoJCWluZGljZXMucHVzaCh2ZWNQb3MpOwoJCQoJCWZvciAodmFyIGk9MDsgaSA8IHRvdGFsU2VncyArIDEgOyBpKyspIAoJCXsKCQkJdmVydHMucHVzaCh4LHksIHIsIGcsIGIsIGFscGhhKTsKCQkJCgkJCXZlcnRzLnB1c2goeCArIE1hdGguc2luKHNlZyAqIGkpICogd2lkdGgsCgkJCQkJICAgeSArIE1hdGguY29zKHNlZyAqIGkpICogaGVpZ2h0LAoJCQkJCSAgIHIsIGcsIGIsIGFscGhhKTsKCQkKCQkJaW5kaWNlcy5wdXNoKHZlY1BvcysrLCB2ZWNQb3MrKyk7CgkJfTsKCQkKCQlpbmRpY2VzLnB1c2godmVjUG9zLTEpOwoJfQoJCglpZihncmFwaGljc0RhdGEubGluZVdpZHRoKQoJewoJCWdyYXBoaWNzRGF0YS5wb2ludHMgPSBbXTsKCQkKCQlmb3IgKHZhciBpPTA7IGkgPCB0b3RhbFNlZ3MgKyAxOyBpKyspIAoJCXsKCQkJZ3JhcGhpY3NEYXRhLnBvaW50cy5wdXNoKHggKyBNYXRoLnNpbihzZWcgKiBpKSAqIHdpZHRoLAoJCQkJCQkJCQkgeSArIE1hdGguY29zKHNlZyAqIGkpICogaGVpZ2h0KQoJCX07CgkJCgkJUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShncmFwaGljc0RhdGEsIHdlYkdMRGF0YSk7Cgl9CgkKfQoKLyoqCiAqIEJ1aWxkcyBhIGxpbmUgdG8gZHJhdwogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgYnVpbGRMaW5lCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSB3ZWJHTERhdGEge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5idWlsZExpbmUgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewoJLy8gVE9ETyBPUFRJTUlTRSEKCQoJdmFyIHdyYXAgPSB0cnVlOwoJdmFyIHBvaW50cyA9IGdyYXBoaWNzRGF0YS5wb2ludHM7CglpZihwb2ludHMubGVuZ3RoID09IDApcmV0dXJuOwoJCgkvLyBpZiB0aGUgbGluZSB3aWR0aCBpcyBhbiBvZGQgbnVtYmVyIGFkZCAwLjUgdG8gYWxpZ24gdG8gYSB3aG9sZSBwaXhlbAoJaWYoZ3JhcGhpY3NEYXRhLmxpbmVXaWR0aCUyKQoJewoJCWZvciAodmFyIGkgPSAwOyBpIDwgcG9pbnRzLmxlbmd0aDsgaSsrKSB7CgkJCXBvaW50c1tpXSArPSAwLjU7CgkJfTsKCX0KCgkvLyBnZXQgZmlyc3QgYW5kIGxhc3QgcG9pbnQuLiBmaWd1cmUgb3V0IHRoZSBtaWRkbGUhCgl2YXIgZmlyc3RQb2ludCA9IG5ldyBQSVhJLlBvaW50KCBwb2ludHNbMF0sIHBvaW50c1sxXSApOwoJdmFyIGxhc3RQb2ludCA9IG5ldyBQSVhJLlBvaW50KCBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDJdLCBwb2ludHNbcG9pbnRzLmxlbmd0aCAtIDFdICk7CgkKCS8vIGlmIHRoZSBmaXJzdCBwb2ludCBpcyB0aGUgbGFzdCBwb2ludCAtIGdvb25hIGhhdmUgaXNzdWVzIDopCglpZihmaXJzdFBvaW50LnggPT0gbGFzdFBvaW50LnggJiYgZmlyc3RQb2ludC55ID09IGxhc3RQb2ludC55KQoJewoJCXBvaW50cy5wb3AoKTsKCQlwb2ludHMucG9wKCk7CgkJCgkJbGFzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMl0sIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0gKTsKCQkKCQl2YXIgbWlkUG9pbnRYID0gbGFzdFBvaW50LnggKyAoZmlyc3RQb2ludC54IC0gbGFzdFBvaW50LngpICowLjU7CgkJdmFyIG1pZFBvaW50WSA9IGxhc3RQb2ludC55ICsgKGZpcnN0UG9pbnQueSAtIGxhc3RQb2ludC55KSAqMC41OwoJCQoJCXBvaW50cy51bnNoaWZ0KG1pZFBvaW50WCwgbWlkUG9pbnRZKTsKCQlwb2ludHMucHVzaChtaWRQb2ludFgsIG1pZFBvaW50WSkKCX0KCQoJdmFyIHZlcnRzID0gd2ViR0xEYXRhLnBvaW50czsKCXZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7Cgl2YXIgbGVuZ3RoID0gcG9pbnRzLmxlbmd0aCAvIDI7Cgl2YXIgaW5kZXhDb3VudCA9IHBvaW50cy5sZW5ndGg7Cgl2YXIgaW5kZXhTdGFydCA9IHZlcnRzLmxlbmd0aC82OwoJCgkvLyBEUkFXIHRoZSBMaW5lCgl2YXIgd2lkdGggPSBncmFwaGljc0RhdGEubGluZVdpZHRoIC8gMjsKCQoJLy8gc29ydCBjb2xvcgoJdmFyIGNvbG9yID0gSEVYdG9SR0IoZ3JhcGhpY3NEYXRhLmxpbmVDb2xvcik7Cgl2YXIgYWxwaGEgPSBncmFwaGljc0RhdGEubGluZUFscGhhOwoJdmFyIHIgPSBjb2xvclswXSAqIGFscGhhOwoJdmFyIGcgPSBjb2xvclsxXSAqIGFscGhhOwoJdmFyIGIgPSBjb2xvclsyXSAqIGFscGhhOwoJCgl2YXIgcDF4LCBwMXksIHAyeCwgcDJ5LCBwM3gsIHAzeTsKCXZhciBwZXJweCwgcGVycHksIHBlcnAyeCwgcGVycDJ5LCBwZXJwM3gsIHBlcnAzeTsKCXZhciBpcHgsIGlweTsKCXZhciBhMSwgYjEsIGMxLCBhMiwgYjIsIGMyOwoJdmFyIGRlbm9tLCBwZGlzdCwgZGlzdDsKCQoJcDF4ID0gcG9pbnRzWzBdOwoJcDF5ID0gcG9pbnRzWzFdOwoJCglwMnggPSBwb2ludHNbMl07CglwMnkgPSBwb2ludHNbM107CgkKCXBlcnB4ID0gLShwMXkgLSBwMnkpOwoJcGVycHkgPSAgcDF4IC0gcDJ4OwoJCglkaXN0ID0gTWF0aC5zcXJ0KHBlcnB4KnBlcnB4ICsgcGVycHkqcGVycHkpOwoJCglwZXJweCAvPSBkaXN0OwoJcGVycHkgLz0gZGlzdDsKCXBlcnB4ICo9IHdpZHRoOwoJcGVycHkgKj0gd2lkdGg7CgkKCS8vIHN0YXJ0Cgl2ZXJ0cy5wdXNoKHAxeCAtIHBlcnB4ICwgcDF5IC0gcGVycHksCgkJCQlyLCBnLCBiLCBhbHBoYSk7CgkKCXZlcnRzLnB1c2gocDF4ICsgcGVycHggLCBwMXkgKyBwZXJweSwKCQkJCXIsIGcsIGIsIGFscGhhKTsKCQoJZm9yICh2YXIgaSA9IDE7IGkgPCBsZW5ndGgtMTsgaSsrKSAKCXsKCQlwMXggPSBwb2ludHNbKGktMSkqMl07CgkJcDF5ID0gcG9pbnRzWyhpLTEpKjIgKyAxXTsKCQkKCQlwMnggPSBwb2ludHNbKGkpKjJdCgkJcDJ5ID0gcG9pbnRzWyhpKSoyICsgMV0KCQkKCQlwM3ggPSBwb2ludHNbKGkrMSkqMl07CgkJcDN5ID0gcG9pbnRzWyhpKzEpKjIgKyAxXTsKCQkKCQlwZXJweCA9IC0ocDF5IC0gcDJ5KTsKCQlwZXJweSA9IHAxeCAtIHAyeDsKCQkKCQlkaXN0ID0gTWF0aC5zcXJ0KHBlcnB4KnBlcnB4ICsgcGVycHkqcGVycHkpOwoJCXBlcnB4IC89IGRpc3Q7CgkJcGVycHkgLz0gZGlzdDsKCQlwZXJweCAqPSB3aWR0aDsKCQlwZXJweSAqPSB3aWR0aDsKCgkJcGVycDJ4ID0gLShwMnkgLSBwM3kpOwoJCXBlcnAyeSA9IHAyeCAtIHAzeDsKCQkKCQlkaXN0ID0gTWF0aC5zcXJ0KHBlcnAyeCpwZXJwMnggKyBwZXJwMnkqcGVycDJ5KTsKCQlwZXJwMnggLz0gZGlzdDsKCQlwZXJwMnkgLz0gZGlzdDsKCQlwZXJwMnggKj0gd2lkdGg7CgkJcGVycDJ5ICo9IHdpZHRoOwoJCQoJCWExID0gKC1wZXJweSArIHAxeSkgLSAoLXBlcnB5ICsgcDJ5KTsKCSAgICBiMSA9ICgtcGVycHggKyBwMngpIC0gKC1wZXJweCArIHAxeCk7CgkgICAgYzEgPSAoLXBlcnB4ICsgcDF4KSAqICgtcGVycHkgKyBwMnkpIC0gKC1wZXJweCArIHAyeCkgKiAoLXBlcnB5ICsgcDF5KTsKCSAgICBhMiA9ICgtcGVycDJ5ICsgcDN5KSAtICgtcGVycDJ5ICsgcDJ5KTsKCSAgICBiMiA9ICgtcGVycDJ4ICsgcDJ4KSAtICgtcGVycDJ4ICsgcDN4KTsKCSAgICBjMiA9ICgtcGVycDJ4ICsgcDN4KSAqICgtcGVycDJ5ICsgcDJ5KSAtICgtcGVycDJ4ICsgcDJ4KSAqICgtcGVycDJ5ICsgcDN5KTsKCSAKCSAgICBkZW5vbSA9IGExKmIyIC0gYTIqYjE7CgoJICAgaWYoTWF0aC5hYnMoZGVub20pIDwgMC4xICkKCQl7CgkJCgkJCWRlbm9tKz0xMC4xOwoJCQl2ZXJ0cy5wdXNoKHAyeCAtIHBlcnB4ICwgcDJ5IC0gcGVycHksCgkJCQlyLCBnLCBiLCBhbHBoYSk7CgkKCQkJdmVydHMucHVzaChwMnggKyBwZXJweCAsIHAyeSArIHBlcnB5LAoJCQkJciwgZywgYiwgYWxwaGEpOwoJCQkKCQkJY29udGludWU7CgkJfQoJICAgIAoJICAgIHB4ID0gKGIxKmMyIC0gYjIqYzEpL2Rlbm9tOwoJICAgIHB5ID0gKGEyKmMxIC0gYTEqYzIpL2Rlbm9tOwoJCQoJCQkKCQlwZGlzdCA9IChweCAtcDJ4KSAqIChweCAtcDJ4KSArIChweSAtcDJ5KSArIChweSAtcDJ5KTsKCQkKCgkJaWYocGRpc3QgPiAxNDAgKiAxNDApCgkJewoJCQlwZXJwM3ggPSBwZXJweCAtIHBlcnAyeDsKCQkJcGVycDN5ID0gcGVycHkgLSBwZXJwMnk7CgkJCQoJCQlkaXN0ID0gTWF0aC5zcXJ0KHBlcnAzeCpwZXJwM3ggKyBwZXJwM3kqcGVycDN5KTsKCQkJcGVycDN4IC89IGRpc3Q7CgkJCXBlcnAzeSAvPSBkaXN0OwoJCQlwZXJwM3ggKj0gd2lkdGg7CgkJCXBlcnAzeSAqPSB3aWR0aDsKCQkJCgkJCXZlcnRzLnB1c2gocDJ4IC0gcGVycDN4LCBwMnkgLXBlcnAzeSk7CgkJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCQkKCQkJdmVydHMucHVzaChwMnggKyBwZXJwM3gsIHAyeSArcGVycDN5KTsKCQkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCQoJCQl2ZXJ0cy5wdXNoKHAyeCAtIHBlcnAzeCwgcDJ5IC1wZXJwM3kpOwoJCQl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQkJCgkJCWluZGV4Q291bnQrKzsKCQl9CgkJZWxzZQoJCXsKCgkJCXZlcnRzLnB1c2gocHggLCBweSk7CgkJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCQkKCQkJdmVydHMucHVzaChwMnggLSAocHgtcDJ4KSwgcDJ5IC0gKHB5IC0gcDJ5KSk7CgkJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCX0KCX0KCQoJcDF4ID0gcG9pbnRzWyhsZW5ndGgtMikqMl0KCXAxeSA9IHBvaW50c1sobGVuZ3RoLTIpKjIgKyAxXSAKCQoJcDJ4ID0gcG9pbnRzWyhsZW5ndGgtMSkqMl0KCXAyeSA9IHBvaW50c1sobGVuZ3RoLTEpKjIgKyAxXQoJCglwZXJweCA9IC0ocDF5IC0gcDJ5KQoJcGVycHkgPSBwMXggLSBwMng7CgkKCWRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CglwZXJweCAvPSBkaXN0OwoJcGVycHkgLz0gZGlzdDsKCXBlcnB4ICo9IHdpZHRoOwoJcGVycHkgKj0gd2lkdGg7CgkKCXZlcnRzLnB1c2gocDJ4IC0gcGVycHggLCBwMnkgLSBwZXJweSkKCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCgl2ZXJ0cy5wdXNoKHAyeCArIHBlcnB4ICwgcDJ5ICsgcGVycHkpCgl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQoJaW5kaWNlcy5wdXNoKGluZGV4U3RhcnQpOwoJCglmb3IgKHZhciBpPTA7IGkgPCBpbmRleENvdW50OyBpKyspIAoJewoJCWluZGljZXMucHVzaChpbmRleFN0YXJ0KyspOwoJfTsKCQoJaW5kaWNlcy5wdXNoKGluZGV4U3RhcnQtMSk7Cn0KCi8qKgogKiBCdWlsZHMgYSBwb2x5Z29uIHRvIGRyYXcKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIGJ1aWxkUG9seQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRQb2x5ID0gZnVuY3Rpb24oZ3JhcGhpY3NEYXRhLCB3ZWJHTERhdGEpCnsKCXZhciBwb2ludHMgPSBncmFwaGljc0RhdGEucG9pbnRzOwoJaWYocG9pbnRzLmxlbmd0aCA8IDYpcmV0dXJuOwoJCgkvLyBnZXQgZmlyc3QgYW5kIGxhc3QgcG9pbnQuLiBmaWd1cmUgb3V0IHRoZSBtaWRkbGUhCgl2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwoJdmFyIGluZGljZXMgPSB3ZWJHTERhdGEuaW5kaWNlczsKCQoJdmFyIGxlbmd0aCA9IHBvaW50cy5sZW5ndGggLyAyOwoJCgkvLyBzb3J0IGNvbG9yCgl2YXIgY29sb3IgPSBIRVh0b1JHQihncmFwaGljc0RhdGEuZmlsbENvbG9yKTsKCXZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5maWxsQWxwaGE7Cgl2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7Cgl2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7Cgl2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgkKCXZhciB0cmlhbmdsZXMgPSBQSVhJLlBvbHlLLlRyaWFuZ3VsYXRlKHBvaW50cyk7CgkKCXZhciB2ZXJ0UG9zID0gdmVydHMubGVuZ3RoIC8gNjsKCQoJZm9yICh2YXIgaT0wOyBpIDwgdHJpYW5nbGVzLmxlbmd0aDsgaSs9MykgCgl7CgkJaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpXSArIHZlcnRQb3MpOwoJCWluZGljZXMucHVzaCh0cmlhbmdsZXNbaV0gKyB2ZXJ0UG9zKTsKCQlpbmRpY2VzLnB1c2godHJpYW5nbGVzW2krMV0gKyB2ZXJ0UG9zKTsKCQlpbmRpY2VzLnB1c2godHJpYW5nbGVzW2krMl0gK3ZlcnRQb3MpOwoJCWluZGljZXMucHVzaCh0cmlhbmdsZXNbaSsyXSArIHZlcnRQb3MpOwoJfTsKCQoJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgCgl7CgkJdmVydHMucHVzaChwb2ludHNbaSAqIDJdLCBwb2ludHNbaSAqIDIgKyAxXSwKCQkJCSAgIHIsIGcsIGIsIGFscGhhKTsKCX07Cn0KCmZ1bmN0aW9uIEhFWHRvUkdCKGhleCkgewoJcmV0dXJuIFsoaGV4ID4+IDE2ICYgMHhGRikgLyAyNTUsICggaGV4ID4+IDggJiAweEZGKSAvIDI1NSwgKGhleCAmIDB4RkYpLyAyNTVdOwp9CgoKCgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuX2RlZmF1bHRGcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMSwxKTsKCi8vIGFuIGluc3RhbmNlIG9mIHRoZSBnbCBjb250ZXh0Li4KLy8gb25seSBvbmUgYXQgdGhlIG1vbWVudCA6LwpQSVhJLmdsOwoKLyoqCiAqIHRoZSBXZWJHTFJlbmRlcmVyIGlzIGRyYXdzIHRoZSBzdGFnZSBhbmQgYWxsIGl0cyBjb250ZW50IG9udG8gYSB3ZWJHTCBlbmFibGVkIGNhbnZhcy4gVGhpcyByZW5kZXJlcgogKiBzaG91bGQgYmUgdXNlZCBmb3IgYnJvd3NlcnMgc3VwcG9ydCB3ZWJHTC4gVGhpcyBSZW5kZXIgd29ya3MgYnkgYXV0b21hdGljYWxseSBtYW5hZ2luZyB3ZWJHTEJhdGNocy4KICogU28gbm8gbmVlZCBmb3IgU3ByaXRlIEJhdGNoJ3Mgb3IgU3ByaXRlIENsb3VkJ3MKICogRG9udCBmb3JnZXQgdG8gYWRkIHRoZSB2aWV3IHRvIHlvdXIgRE9NIG9yIHlvdSB3aWxsIG5vdCBzZWUgYW55dGhpbmcgOikKICoKICogQGNsYXNzIFdlYkdMUmVuZGVyZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB3aWR0aD0wIHtOdW1iZXJ9IHRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIGhlaWdodD0wIHtOdW1iZXJ9IHRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSB2aWV3IHtDYW52YXN9IHRoZSBjYW52YXMgdG8gdXNlIGFzIGEgdmlldywgb3B0aW9uYWwKICogQHBhcmFtIHRyYW5zcGFyZW50PWZhbHNlIHtCb29sZWFufSB0aGUgdHJhbnNwYXJlbmN5IG9mIHRoZSByZW5kZXIgdmlldywgZGVmYXVsdCBmYWxzZQogKiBAcGFyYW0gYW50aWFsaWFzPWZhbHNlIHtCb29sZWFufSBzZXRzIGFudGlhbGlhcyAob25seSBhcHBsaWNhYmxlIGluIGNocm9tZSBhdCB0aGUgbW9tZW50KQogKiAKICovClBJWEkuV2ViR0xSZW5kZXJlciA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQsIHZpZXcsIHRyYW5zcGFyZW50LCBhbnRpYWxpYXMpCnsKCS8vIGRvIGEgY2F0Y2guLiBvbmx5IDEgd2ViR0wgcmVuZGVyZXIuLgoKCXRoaXMudHJhbnNwYXJlbnQgPSAhIXRyYW5zcGFyZW50OwoKCXRoaXMud2lkdGggPSB3aWR0aCB8fCA4MDA7Cgl0aGlzLmhlaWdodCA9IGhlaWdodCB8fCA2MDA7CgoJdGhpcy52aWV3ID0gdmlldyB8fCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAnY2FudmFzJyApOyAKICAgIHRoaXMudmlldy53aWR0aCA9IHRoaXMud2lkdGg7Cgl0aGlzLnZpZXcuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgoJLy8gZGVhbCB3aXRoIGxvc2luZyBjb250ZXh0Li4JCiAgICB2YXIgc2NvcGUgPSB0aGlzOwoJdGhpcy52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmdsY29udGV4dGxvc3QnLCBmdW5jdGlvbihldmVudCkgeyBzY29wZS5oYW5kbGVDb250ZXh0TG9zdChldmVudCk7IH0sIGZhbHNlKQoJdGhpcy52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmdsY29udGV4dHJlc3RvcmVkJywgZnVuY3Rpb24oZXZlbnQpIHsgc2NvcGUuaGFuZGxlQ29udGV4dFJlc3RvcmVkKGV2ZW50KTsgfSwgZmFsc2UpCgoJdGhpcy5iYXRjaHMgPSBbXTsKCgl2YXIgb3B0aW9ucyA9IHsKCQlhbHBoYTogdGhpcy50cmFuc3BhcmVudCwKCQlhbnRpYWxpYXM6ISFhbnRpYWxpYXMsIC8vIFNQRUVEIFVQPz8KCQlwcmVtdWx0aXBsaWVkQWxwaGE6ZmFsc2UsCgkJc3RlbmNpbDp0cnVlCgl9CgoJLy90cnkgJ2V4cGVyaW1lbnRhbC13ZWJnbCcKCXRyeSB7CgkJUElYSS5nbCA9IHRoaXMuZ2wgPSB0aGlzLnZpZXcuZ2V0Q29udGV4dCgiZXhwZXJpbWVudGFsLXdlYmdsIiwgIG9wdGlvbnMpOwoJfSBjYXRjaCAoZSkgewoJCS8vdHJ5ICd3ZWJnbCcKCQl0cnkgewoJCQlQSVhJLmdsID0gdGhpcy5nbCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCJ3ZWJnbCIsICBvcHRpb25zKTsKCQl9IGNhdGNoIChlKSB7CgkJCS8vIGZhaWwsIG5vdCBhYmxlIHRvIGdldCBhIGNvbnRleHQKCQkJdGhyb3cgbmV3IEVycm9yKCIgVGhpcyBicm93c2VyIGRvZXMgbm90IHN1cHBvcnQgd2ViR0wuIFRyeSB1c2luZyB0aGUgY2FudmFzIHJlbmRlcmVyIiArIHRoaXMpOwoJCX0KCX0KCiAgICBQSVhJLmluaXREZWZhdWx0U2hhZGVycygpOwogCgoJCgogICAvLyBQSVhJLmFjdGl2YXRlRGVmYXVsdFNoYWRlcigpOwoKICAgIHZhciBnbCA9IHRoaXMuZ2w7CiAgICAKICAgIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwoKCiAgICBQSVhJLldlYkdMUmVuZGVyZXIuZ2wgPSBnbDsKCiAgICB0aGlzLmJhdGNoID0gbmV3IFBJWEkuV2ViR0xCYXRjaChnbCk7CiAgIAlnbC5kaXNhYmxlKGdsLkRFUFRIX1RFU1QpOwogICAJZ2wuZGlzYWJsZShnbC5DVUxMX0ZBQ0UpOwoKICAgIGdsLmVuYWJsZShnbC5CTEVORCk7CiAgICBnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdGhpcy50cmFuc3BhcmVudCk7IAoKICAgIFBJWEkucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KDQwMCwgMzAwKTsKICAgIFBJWEkub2Zmc2V0ID0gbmV3IFBJWEkuUG9pbnQoMCwgMCk7CgogICAgLy8gVE9ETyByZW1vdmUgdGhlYXNlIGdsb2JhbHMuLgoKICAgIHRoaXMucmVzaXplKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKICAgIHRoaXMuY29udGV4dExvc3QgPSBmYWxzZTsKCgkvL1BJWEkucHVzaFNoYWRlcihQSVhJLmRlZmF1bHRTaGFkZXIpOwoKICAgIHRoaXMuc3RhZ2VSZW5kZXJHcm91cCA9IG5ldyBQSVhJLldlYkdMUmVuZGVyR3JvdXAodGhpcy5nbCwgdGhpcy50cmFuc3BhcmVudCk7CiAgLy8gIHRoaXMuc3RhZ2VSZW5kZXJHcm91cC4gPSB0aGlzLnRyYW5zcGFyZW50Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLldlYkdMUmVuZGVyZXI7CgovKioKICogR2V0cyBhIG5ldyBXZWJHTEJhdGNoIGZyb20gdGhlIHBvb2wKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGdldEJhdGNoCiAqIEByZXR1cm4ge1dlYkdMQmF0Y2h9CiAqIEBwcml2YXRlIAogKi8KUElYSS5XZWJHTFJlbmRlcmVyLmdldEJhdGNoID0gZnVuY3Rpb24oKQp7CglpZihQSVhJLl9iYXRjaHMubGVuZ3RoID09IDApCgl7CgkJcmV0dXJuIG5ldyBQSVhJLldlYkdMQmF0Y2goUElYSS5XZWJHTFJlbmRlcmVyLmdsKTsKCX0KCWVsc2UKCXsKCQlyZXR1cm4gUElYSS5fYmF0Y2hzLnBvcCgpOwoJfQp9CgovKioKICogUHV0cyBhIGJhdGNoIGJhY2sgaW50byB0aGUgcG9vbAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgcmV0dXJuQmF0Y2gKICogQHBhcmFtIGJhdGNoIHtXZWJHTEJhdGNofSBUaGUgYmF0Y2ggdG8gcmV0dXJuCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2ggPSBmdW5jdGlvbihiYXRjaCkKewoJYmF0Y2guY2xlYW4oKTsJCglQSVhJLl9iYXRjaHMucHVzaChiYXRjaCk7Cn0KCi8qKgogKiBSZW5kZXJzIHRoZSBzdGFnZSB0byBpdHMgd2ViR0wgdmlldwogKgogKiBAbWV0aG9kIHJlbmRlcgogKiBAcGFyYW0gc3RhZ2Uge1N0YWdlfSB0aGUgU3RhZ2UgZWxlbWVudCB0byBiZSByZW5kZXJlZAogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFnZSkKewoJaWYodGhpcy5jb250ZXh0TG9zdClyZXR1cm47CgkKCQoJLy8gaWYgcmVuZGVyaW5nIGEgbmV3IHN0YWdlIGNsZWFyIHRoZSBiYXRjaHMuLgoJaWYodGhpcy5fX3N0YWdlICE9PSBzdGFnZSkKCXsKCQkvLyBUT0RPIG1ha2UgdGhpcyB3b3JrCgkJLy8gZG9udCB0aGluayB0aGlzIGlzIG5lZWRlZCBhbnkgbW9yZT8KCQl0aGlzLl9fc3RhZ2UgPSBzdGFnZTsKCQl0aGlzLnN0YWdlUmVuZGVyR3JvdXAuc2V0UmVuZGVyYWJsZShzdGFnZSk7Cgl9CgoJLy8gdXBkYXRlIGFueSB0ZXh0dXJlcwkKCVBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcygpOwoJCQoJLy8gdXBkYXRlIHRoZSBzY2VuZSBncmFwaAkKCVBJWEkudmlzaWJsZUNvdW50Kys7CglzdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCQoJdmFyIGdsID0gdGhpcy5nbDsKCQoJLy8gLS0gRG9lcyB0aGlzIG5lZWQgdG8gYmUgc2V0IGV2ZXJ5IGZyYW1lPyAtLSAvLwoJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRoaXMudHJhbnNwYXJlbnQpOyAKCWdsLnZpZXdwb3J0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsJCgkKICAgCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgbnVsbCk7CgkJCglnbC5jbGVhckNvbG9yKHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzBdLHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzFdLHN0YWdlLmJhY2tncm91bmRDb2xvclNwbGl0WzJdLCAhdGhpcy50cmFuc3BhcmVudCk7ICAgICAKCWdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwoKCS8vIEhBQ0sgVE8gVEVTVAoJCgl0aGlzLnN0YWdlUmVuZGVyR3JvdXAuYmFja2dyb3VuZENvbG9yID0gc3RhZ2UuYmFja2dyb3VuZENvbG9yU3BsaXQ7CgkKCVBJWEkucHJvamVjdGlvbi54ID0gIHRoaXMud2lkdGgvMjsKCVBJWEkucHJvamVjdGlvbi55ID0gIC10aGlzLmhlaWdodC8yOwoJCgl0aGlzLnN0YWdlUmVuZGVyR3JvdXAucmVuZGVyKFBJWEkucHJvamVjdGlvbik7CgkKCS8vIGludGVyYWN0aW9uCgkvLyBydW4gaW50ZXJhY3Rpb24hCglpZihzdGFnZS5pbnRlcmFjdGl2ZSkKCXsKCQkvL25lZWQgdG8gYWRkIHNvbWUgZXZlbnRzIQoJCWlmKCFzdGFnZS5faW50ZXJhY3RpdmVFdmVudHNBZGRlZCkKCQl7CgkJCXN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkID0gdHJ1ZTsKCQkJc3RhZ2UuaW50ZXJhY3Rpb25NYW5hZ2VyLnNldFRhcmdldCh0aGlzKTsKCQl9Cgl9CgkKCS8vIGFmdGVyIHJlbmRlcmluZyBsZXRzIGNvbmZpcm0gYWxsIGZyYW1lcyB0aGF0IGhhdmUgYmVlbiB1b2RhdGVkLi4KCWlmKFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID4gMCkKCXsKCQlmb3IgKHZhciBpPTA7IGkgPCBQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLmxlbmd0aDsgaSsrKSAKCQl7CgkJICAJUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlc1tpXS51cGRhdGVGcmFtZSA9IGZhbHNlOwoJCX07CgkJCgkJUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcyA9IFtdOwoJfQp9CgovKioKICogVXBkYXRlcyB0aGUgdGV4dHVyZXMgbG9hZGVkIGludG8gdGhpcyB3ZWJnbCByZW5kZXJlcgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZXMKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcyA9IGZ1bmN0aW9uKCkKewoJLy9UT0RPIGJyZWFrIHRoaXMgb3V0IGludG8gYSB0ZXh0dXJlIG1hbmFnZXIuLi4KCWZvciAodmFyIGk9MDsgaSA8IFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5sZW5ndGg7IGkrKykgUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmUoUElYSS50ZXh0dXJlc1RvVXBkYXRlW2ldKTsKCWZvciAodmFyIGk9MDsgaSA8IFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kubGVuZ3RoOyBpKyspIFBJWEkuV2ViR0xSZW5kZXJlci5kZXN0cm95VGV4dHVyZShQSVhJLnRleHR1cmVzVG9EZXN0cm95W2ldKTsKCVBJWEkudGV4dHVyZXNUb1VwZGF0ZSA9IFtdOwoJUElYSS50ZXh0dXJlc1RvRGVzdHJveSA9IFtdOwp9CgovKioKICogVXBkYXRlcyBhIGxvYWRlZCB3ZWJnbCB0ZXh0dXJlCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCB1cGRhdGVUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgdGV4dHVyZSB0byB1cGRhdGUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewoJLy9UT0RPIGJyZWFrIHRoaXMgb3V0IGludG8gYSB0ZXh0dXJlIG1hbmFnZXIuLi4KCXZhciBnbCA9IFBJWEkuZ2w7CgkKCWlmKCF0ZXh0dXJlLl9nbFRleHR1cmUpCgl7CgkJdGV4dHVyZS5fZ2xUZXh0dXJlID0gZ2wuY3JlYXRlVGV4dHVyZSgpOwoJfQoKCWlmKHRleHR1cmUuaGFzTG9hZGVkKQoJewoJCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUuX2dsVGV4dHVyZSk7CgkgCWdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19QUkVNVUxUSVBMWV9BTFBIQV9XRUJHTCwgdHJ1ZSk7CgoJCWdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgdGV4dHVyZS5zb3VyY2UpOwoJCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwoJCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwoKCQkvLyByZWd1bGVyLi4uCgoJCWlmKCF0ZXh0dXJlLl9wb3dlck9mMikKCQl7CgkJCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwoJCQlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCQl9CgkJZWxzZQoJCXsKCQkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuUkVQRUFUKTsKCQkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuUkVQRUFUKTsKCQl9CgoJCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIG51bGwpOwoJfQp9CgovKioKICogRGVzdHJveXMgYSBsb2FkZWQgd2ViZ2wgdGV4dHVyZQogKgogKiBAbWV0aG9kIGRlc3Ryb3lUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgdGV4dHVyZSB0byB1cGRhdGUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5kZXN0cm95VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKCS8vVE9ETyBicmVhayB0aGlzIG91dCBpbnRvIGEgdGV4dHVyZSBtYW5hZ2VyLi4uCgl2YXIgZ2wgPSBQSVhJLmdsOwoKCWlmKHRleHR1cmUuX2dsVGV4dHVyZSkKCXsKCQl0ZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CgkJZ2wuZGVsZXRlVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlLl9nbFRleHR1cmUpOwoJfQp9CgovKioKICogcmVzaXplcyB0aGUgd2ViR0wgdmlldyB0byB0aGUgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQKICoKICogQG1ldGhvZCByZXNpemUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IHRoZSBuZXcgd2lkdGggb2YgdGhlIHdlYkdMIHZpZXcKICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSB0aGUgbmV3IGhlaWdodCBvZiB0aGUgd2ViR0wgdmlldwogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7Cgl0aGlzLndpZHRoID0gd2lkdGg7Cgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgl0aGlzLnZpZXcud2lkdGggPSB3aWR0aDsKCXRoaXMudmlldy5oZWlnaHQgPSBoZWlnaHQ7CgoJdGhpcy5nbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CQoKCS8vdmFyIHByb2plY3Rpb25NYXRyaXggPSB0aGlzLnByb2plY3Rpb25NYXRyaXg7CgoJUElYSS5wcm9qZWN0aW9uLnggPSAgdGhpcy53aWR0aC8yOwoJUElYSS5wcm9qZWN0aW9uLnkgPSAgLXRoaXMuaGVpZ2h0LzI7CgkKCS8vUElYSS5zaXplLnggPSAgdGhpcy53aWR0aC8yOwoJLy9QSVhJLnNpemUueSA9ICAtdGhpcy5oZWlnaHQvMjsKCi8vCXByb2plY3Rpb25NYXRyaXhbMF0gPSAyL3RoaXMud2lkdGg7Ci8vCXByb2plY3Rpb25NYXRyaXhbNV0gPSAtMi90aGlzLmhlaWdodDsKLy8JcHJvamVjdGlvbk1hdHJpeFsxMl0gPSAtMTsKLy8JcHJvamVjdGlvbk1hdHJpeFsxM10gPSAxOwp9CgovKioKICogSGFuZGxlcyBhIGxvc3Qgd2ViZ2wgY29udGV4dAogKgogKiBAbWV0aG9kIGhhbmRsZUNvbnRleHRMb3N0CiAqIEBwYXJhbSBldmVudCB7RXZlbnR9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLmhhbmRsZUNvbnRleHRMb3N0ID0gZnVuY3Rpb24oZXZlbnQpCnsKCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7Cgl0aGlzLmNvbnRleHRMb3N0ID0gdHJ1ZTsKfQoKLyoqCiAqIEhhbmRsZXMgYSByZXN0b3JlZCB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgaGFuZGxlQ29udGV4dFJlc3RvcmVkCiAqIEBwYXJhbSBldmVudCB7RXZlbnR9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLmhhbmRsZUNvbnRleHRSZXN0b3JlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7Cgl0aGlzLmdsID0gdGhpcy52aWV3LmdldENvbnRleHQoImV4cGVyaW1lbnRhbC13ZWJnbCIsICB7ICAJCgkJYWxwaGE6IHRydWUKICAgIH0pOwoKCXRoaXMuaW5pdFNoYWRlcnMoKTsJCgoJZm9yKHZhciBrZXkgaW4gUElYSS5UZXh0dXJlQ2FjaGUpIAoJewogICAgICAgIAl2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2tleV0uYmFzZVRleHR1cmU7CiAgICAgICAgCXRleHR1cmUuX2dsVGV4dHVyZSA9IG51bGw7CiAgICAgICAgCVBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlKHRleHR1cmUpOwoJfTsKCglmb3IgKHZhciBpPTA7IGkgPCAgdGhpcy5iYXRjaHMubGVuZ3RoOyBpKyspIAoJewoJCXRoaXMuYmF0Y2hzW2ldLnJlc3RvcmVMb3N0Q29udGV4dCh0aGlzLmdsKS8vCgkJdGhpcy5iYXRjaHNbaV0uZGlydHkgPSB0cnVlOwoJfTsKCglQSVhJLl9yZXN0b3JlQmF0Y2hzKHRoaXMuZ2wpOwoKCXRoaXMuY29udGV4dExvc3QgPSBmYWxzZTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIFdlYkdMQmF0Y2ggRW5hYmxlcyBhIGdyb3VwIG9mIHNwcml0ZXMgdG8gYmUgZHJhd24gdXNpbmcgdGhlIHNhbWUgc2V0dGluZ3MuCiAqIGlmIGEgZ3JvdXAgb2Ygc3ByaXRlcyBhbGwgaGF2ZSB0aGUgc2FtZSBiYXNlVGV4dHVyZSBhbmQgYmxlbmRNb2RlIHRoZW4gdGhleSBjYW4gYmUKICogZ3JvdXBlZCBpbnRvIGEgYmF0Y2guIEFsbCB0aGUgc3ByaXRlcyBpbiBhIGJhdGNoIGNhbiB0aGVuIGJlIGRyYXduIGluIG9uZSBnbyBieSB0aGUKICogR1BVIHdoaWNoIGlzIGh1Z2VseSBlZmZpY2llbnQuIEFMTCBzcHJpdGVzIGluIHRoZSB3ZWJHTCByZW5kZXJlciBhcmUgYWRkZWQgdG8gYSBiYXRjaAogKiBldmVuIGlmIHRoZSBiYXRjaCBvbmx5IGNvbnRhaW5zIG9uZSBzcHJpdGUuIEJhdGNoaW5nIGlzIGhhbmRsZWQgYXV0b21hdGljYWxseSBieSB0aGUKICogd2ViR0wgcmVuZGVyZXIuIEEgZ29vZCB0aXAgaXM6IHRoZSBzbWFsbGVyIHRoZSBudW1iZXIgb2YgYmF0Y2hzIHRoZXJlIGFyZSwgdGhlIGZhc3RlcgogKiB0aGUgd2ViR0wgcmVuZGVyZXIgd2lsbCBydW4uCiAqCiAqIEBjbGFzcyBXZWJHTEJhdGNoCiAqIEBjb250cnVjdG9yCiAqIEBwYXJhbSBnbCB7V2ViR0xDb250ZXh0fSBBbiBpbnN0YW5jZSBvZiB0aGUgd2ViR0wgY29udGV4dAogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwID0gZnVuY3Rpb24oZ2wsIHRyYW5zcGFyZW50KQp7Cgl0aGlzLmdsID0gZ2w7Cgl0aGlzLnJvb3Q7CgkKCXRoaXMuYmFja2dyb3VuZENvbG9yOwoJdGhpcy50cmFuc3BhcmVudCA9IHRyYW5zcGFyZW50ID09IHVuZGVmaW5lZCA/IHRydWUgOiB0cmFuc3BhcmVudDsKCQoJdGhpcy5iYXRjaHMgPSBbXTsKCXRoaXMudG9SZW1vdmUgPSBbXTsKCS8vIGNvbnNvbGUubG9nKHRoaXMudHJhbnNwYXJlbnQpCgl0aGlzLmZpbHRlck1hbmFnZXIgPSBuZXcgUElYSS5XZWJHTEZpbHRlck1hbmFnZXIodGhpcy50cmFuc3BhcmVudCk7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLldlYkdMUmVuZGVyR3JvdXA7CgovKioKICogQWRkIGEgZGlzcGxheSBvYmplY3QgdG8gdGhlIHdlYmdsIHJlbmRlcmVyCiAqCiAqIEBtZXRob2Qgc2V0UmVuZGVyYWJsZQogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUgCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnNldFJlbmRlcmFibGUgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CgkvLyBoYXMgdGhpcyBjaGFuZ2VkPz8KCWlmKHRoaXMucm9vdCl0aGlzLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbih0aGlzLnJvb3QpOwoJCglkaXNwbGF5T2JqZWN0LndvcmxkVmlzaWJsZSA9IGRpc3BsYXlPYmplY3QudmlzaWJsZTsKCQoJLy8gc29vb29vbyAvLwoJLy8gdG8gY2hlY2sgaWYgYW55IGJhdGNocyBleGlzdCBhbHJlYWR5Pz8KCQoJLy8gVE9ETyB3aGF0IGlmIGl0cyBhbHJlYWR5IGhhcyBhbiBvYmplY3Q/IHNob3VsZCByZW1vdmUgaXQKCXRoaXMucm9vdCA9IGRpc3BsYXlPYmplY3Q7Cgl0aGlzLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihkaXNwbGF5T2JqZWN0KTsKfQoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyB3ZWJnbCB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBwcm9qZWN0aW9uIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHByb2plY3Rpb24sIGJ1ZmZlcikKewoJUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmVzKCk7CgkKCXZhciBnbCA9IHRoaXMuZ2w7CglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgcHJvamVjdGlvbi55KTsKCgl0aGlzLmZpbHRlck1hbmFnZXIuYmVnaW4ocHJvamVjdGlvbiwgYnVmZmVyKTsKCgkKCWdsLmJsZW5kRnVuYyhnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQUxQSEEpOwoJLy8gd2lsbCByZW5kZXIgYWxsIHRoZSBlbGVtZW50cyBpbiB0aGUgZ3JvdXAKCXZhciByZW5kZXJhYmxlOwoKCWZvciAodmFyIGk9MDsgaSA8IHRoaXMuYmF0Y2hzLmxlbmd0aDsgaSsrKSAKCXsKCQkKCQlyZW5kZXJhYmxlID0gdGhpcy5iYXRjaHNbaV07CgkJaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCQl7CgkJCXRoaXMuYmF0Y2hzW2ldLnJlbmRlcigpOwoJCQljb250aW51ZTsKCQl9CgkJCgkJLy8gcmVuZGVyIHNwZWNpYWwKCQl0aGlzLnJlbmRlclNwZWNpYWwocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7Cgl9CgkKfQoKLyoqCiAqIFJlbmRlcnMgYSBzcGVjaWZpYyBkaXNwbGF5T2JqZWN0CiAqCiAqIEBtZXRob2QgcmVuZGVyU3BlY2lmaWMKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBwcm9qZWN0aW9uIHtPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlclNwZWNpZmljID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcHJvamVjdGlvbiwgYnVmZmVyKQp7CglQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZXMoKTsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBwcm9qZWN0aW9uLngsIHByb2plY3Rpb24ueSk7CgoJdGhpcy5maWx0ZXJNYW5hZ2VyLmJlZ2luKHByb2plY3Rpb24sIGJ1ZmZlcik7CgoJLy8gdG8gZG8hCgkvLyByZW5kZXIgcGFydCBvZiB0aGUgc2NlbmUuLi4KCQoJdmFyIHN0YXJ0SW5kZXg7Cgl2YXIgc3RhcnRCYXRjaEluZGV4OwoJCgl2YXIgZW5kSW5kZXg7Cgl2YXIgZW5kQmF0Y2hJbmRleDsKCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgTkVYVCBTUFJJVEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IG5leHQgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIGl0IGtlZXBzIGxvb2tpbmcgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgZ2V0cyB0byB0aGUgZW5kIG9mIHRoZSBkaXNwbGF5CgkgKiAgc2NlbmUgZ3JhcGgKCSAqLwoJdmFyIG5leHRSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXdoaWxlKG5leHRSZW5kZXJhYmxlLl9pTmV4dCkKCXsKCQlpZihuZXh0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIG5leHRSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7CgkJbmV4dFJlbmRlcmFibGUgPSBuZXh0UmVuZGVyYWJsZS5faU5leHQ7Cgl9Cgl2YXIgc3RhcnRCYXRjaCA9IG5leHRSZW5kZXJhYmxlLmJhdGNoOwoJLy9jb25zb2xlLmxvZyhuZXh0UmVuZGVyYWJsZSk7CgkKCS8vY29uc29sZS5sb2cocmVuZGVyYWJsZSkKCWlmKG5leHRSZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJc3RhcnRCYXRjaCA9IG5leHRSZW5kZXJhYmxlLmJhdGNoOwoJCQoJCXZhciBoZWFkID0gc3RhcnRCYXRjaC5oZWFkOwoJCXZhciBuZXh0ID0gaGVhZDsKCQkKCQkvLyBvayBub3cgd2UgaGF2ZSB0aGUgYmF0Y2guLiBuZWVkIHRvIGZpbmQgdGhlIHN0YXJ0IGluZGV4IQoJCWlmKGhlYWQgPT0gbmV4dFJlbmRlcmFibGUpCgkJewoJCQlzdGFydEluZGV4ID0gMDsKCQl9CgkJZWxzZQoJCXsKCQkJc3RhcnRJbmRleCA9IDE7CgkJCQoJCQl3aGlsZShoZWFkLl9fbmV4dCAhPSBuZXh0UmVuZGVyYWJsZSkKCQkJewoJCQkJc3RhcnRJbmRleCsrOwoJCQkJaGVhZCA9IGhlYWQuX19uZXh0OwoJCQl9CgkJfQoJfQoJZWxzZQoJewoJCXN0YXJ0QmF0Y2ggPSBuZXh0UmVuZGVyYWJsZTsKCX0KCQoJLy8gR2V0IHRoZSBMQVNUIHJlbmRlcmFibGUgb2JqZWN0Cgl2YXIgbGFzdFJlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0Lmxhc3Q7Cgl3aGlsZShsYXN0UmVuZGVyYWJsZS5faVByZXYpCgl7CgkJaWYobGFzdFJlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBsYXN0UmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJCWxhc3RSZW5kZXJhYmxlID0gbGFzdFJlbmRlcmFibGUuX2lOZXh0OwoJfQoJCglpZihsYXN0UmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCWVuZEJhdGNoID0gbGFzdFJlbmRlcmFibGUuYmF0Y2g7CgkJCgkJdmFyIGhlYWQgPSBlbmRCYXRjaC5oZWFkOwoJCQoJCWlmKGhlYWQgPT0gbGFzdFJlbmRlcmFibGUpCgkJewoJCQllbmRJbmRleCA9IDA7CgkJfQoJCWVsc2UKCQl7CgkJCWVuZEluZGV4ID0gMTsKCQkJCgkJCXdoaWxlKGhlYWQuX19uZXh0ICE9IGxhc3RSZW5kZXJhYmxlKQoJCQl7CgkJCQllbmRJbmRleCsrOwoJCQkJaGVhZCA9IGhlYWQuX19uZXh0OwoJCQl9CgkJfQoJfQoJZWxzZQoJewoJCWVuZEJhdGNoID0gbGFzdFJlbmRlcmFibGU7Cgl9CgkKCS8vY29uc29sZS5sb2coZW5kQmF0Y2gpOwoJLy8gVE9ETyAtIG5lZWQgdG8gZm9sZCB0aGlzIHVwIGEgYml0IQoJCglpZihzdGFydEJhdGNoID09IGVuZEJhdGNoKQoJewoJCWlmKHN0YXJ0QmF0Y2ggaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgkJewoJCQlzdGFydEJhdGNoLnJlbmRlcihzdGFydEluZGV4LCBlbmRJbmRleCsxKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5yZW5kZXJTcGVjaWFsKHN0YXJ0QmF0Y2gsIHByb2plY3Rpb24pOwoJCX0KCQlyZXR1cm47Cgl9CgkKCS8vIG5vdyB3ZSBoYXZlIGZpcnN0IGFuZCBsYXN0IQoJc3RhcnRCYXRjaEluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZihzdGFydEJhdGNoKTsKCWVuZEJhdGNoSW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKGVuZEJhdGNoKTsKCQoJLy8gRE8gdGhlIGZpcnN0IGJhdGNoCglpZihzdGFydEJhdGNoIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJewoJCXN0YXJ0QmF0Y2gucmVuZGVyKHN0YXJ0SW5kZXgpOwoJfQoJZWxzZQoJewoJCXRoaXMucmVuZGVyU3BlY2lhbChzdGFydEJhdGNoLCBwcm9qZWN0aW9uKTsKCX0KCQoJLy8gRE8gdGhlIG1pZGRsZSBiYXRjaHMuLgoJZm9yICh2YXIgaT1zdGFydEJhdGNoSW5kZXgrMTsgaSA8IGVuZEJhdGNoSW5kZXg7IGkrKykgCgl7CgkJcmVuZGVyYWJsZSA9IHRoaXMuYmF0Y2hzW2ldOwoJCgkJaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCQl7CgkJCXRoaXMuYmF0Y2hzW2ldLnJlbmRlcigpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLnJlbmRlclNwZWNpYWwocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7CgkJfQoJfQoJCgkvLyBETyB0aGUgbGFzdCBiYXRjaC4uCglpZihlbmRCYXRjaCBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCXsKCQllbmRCYXRjaC5yZW5kZXIoMCwgZW5kSW5kZXgrMSk7Cgl9CgllbHNlCgl7CgkJdGhpcy5yZW5kZXJTcGVjaWFsKGVuZEJhdGNoLCBwcm9qZWN0aW9uKTsKCX0KfQoKLyoqCiAqIFJlbmRlcnMgYSBzcGVjaWZpYyByZW5kZXJhYmxlCiAqCiAqIEBtZXRob2QgcmVuZGVyU3BlY2lhbAogKiBAcGFyYW0gcmVuZGVyYWJsZSB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3BlY2lhbCA9IGZ1bmN0aW9uKHJlbmRlcmFibGUsIHByb2plY3Rpb24pCnsKCQoJdmFyIHdvcmxkVmlzaWJsZSA9IHJlbmRlcmFibGUudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudAoKCglpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCgl7CgkJaWYod29ybGRWaXNpYmxlKXRoaXMucmVuZGVyVGlsaW5nU3ByaXRlKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQoJZWxzZSBpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5TdHJpcCkKCXsKCQlpZih3b3JsZFZpc2libGUpdGhpcy5yZW5kZXJTdHJpcChyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuQ3VzdG9tUmVuZGVyYWJsZSkKCXsKCQlpZih3b3JsZFZpc2libGUpIHJlbmRlcmFibGUucmVuZGVyV2ViR0wodGhpcywgcHJvamVjdGlvbik7Cgl9CgllbHNlIGlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJewoJCWlmKHdvcmxkVmlzaWJsZSAmJiByZW5kZXJhYmxlLnJlbmRlcmFibGUpIFBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuRmlsdGVyQmxvY2spCgl7CgkJdGhpcy5oYW5kbGVGaWx0ZXJCbG9jayhyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KfQoKZmxpcCA9IGZhbHNlOwp2YXIgbWFza1N0YWNrID0gW107CnZhciBtYXNrUG9zaXRpb24gPSAwOwoKLy92YXIgdXNlZE1hc2tTdGFjayA9IFtdOwoKUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5oYW5kbGVGaWx0ZXJCbG9jayA9IGZ1bmN0aW9uKGZpbHRlckJsb2NrLCBwcm9qZWN0aW9uKQp7CgkvKgoJICogZm9yIG5vdyBvbmx5IG1hc2tzIGFyZSBzdXBwb3J0ZWQuLgoJICovCgl2YXIgZ2wgPSBQSVhJLmdsOwoJCglpZihmaWx0ZXJCbG9jay5vcGVuKQoJewoJCWlmKGZpbHRlckJsb2NrLmRhdGEgaW5zdGFuY2VvZiBBcnJheSkKCQl7CgkJCXRoaXMuZmlsdGVyTWFuYWdlci5wdXNoRmlsdGVyKGZpbHRlckJsb2NrKTsKCQkJLy8gb2sgc28uLgoJCQkKCQl9CgkJZWxzZQoJCXsJCgkJCW1hc2tQb3NpdGlvbisrOwoKCQkJbWFza1N0YWNrLnB1c2goZmlsdGVyQmxvY2spCgkKCQkJZ2wuZW5hYmxlKGdsLlNURU5DSUxfVEVTVCk7CgkJCQoJCQlnbC5jb2xvck1hc2soZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UpOwoJCQkKCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuQUxXQVlTLDEsMSk7CgkJCWdsLnN0ZW5jaWxPcChnbC5LRUVQLGdsLktFRVAsZ2wuSU5DUik7CgkKCQkJUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzKGZpbHRlckJsb2NrLmRhdGEsIHByb2plY3Rpb24pOwoJCQkKCQkJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOwoJCQlnbC5zdGVuY2lsRnVuYyhnbC5OT1RFUVVBTCwwLG1hc2tTdGFjay5sZW5ndGgpOwoJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLktFRVApOwoJCX0KCX0KCWVsc2UKCXsKCQlpZihmaWx0ZXJCbG9jay5kYXRhIGluc3RhbmNlb2YgQXJyYXkpCgkJewoJCQl0aGlzLmZpbHRlck1hbmFnZXIucG9wRmlsdGVyKCk7CgkJfQoJCWVsc2UKCQl7CgkJCXZhciBtYXNrRGF0YSA9IG1hc2tTdGFjay5wb3AoZmlsdGVyQmxvY2spCgoKCQkJaWYobWFza0RhdGEpCgkJCXsKCQkJCWdsLmNvbG9yTWFzayhmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CgkJCQoJCQkJZ2wuc3RlbmNpbEZ1bmMoZ2wuQUxXQVlTLDEsMSk7CgkJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLkRFQ1IpOwoKCQkJCVBJWEkuV2ViR0xHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhtYXNrRGF0YS5kYXRhLCBwcm9qZWN0aW9uKTsKCQkJCgkJCQlnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgkJCQlnbC5zdGVuY2lsRnVuYyhnbC5OT1RFUVVBTCwwLG1hc2tTdGFjay5sZW5ndGgpOwoJCQkJZ2wuc3RlbmNpbE9wKGdsLktFRVAsZ2wuS0VFUCxnbC5LRUVQKTsKCQkJfTsKCgkJCWdsLmRpc2FibGUoZ2wuU1RFTkNJTF9URVNUKTsKCQl9Cgl9Cn0KCi8qKgogKiBVcGRhdGVzIGEgd2ViZ2wgdGV4dHVyZQogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmUKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnVwZGF0ZVRleHR1cmUgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CgkKCS8vIFRPRE8gZGVmaW5pdGVseSBjYW4gb3B0aW1zZSB0aGlzIGZ1bmN0aW9uLi4KCQoJdGhpcy5yZW1vdmVPYmplY3QoZGlzcGxheU9iamVjdCk7CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIFBSRVZJT1VTIFJFTkRFUkFCTEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IHByZXZpb3VzIHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBJdCBrZWVwcyBnb2luZyBiYWNrIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIHRoZSBzdGFnZQoJICovCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZSAhPSB0aGlzLnJvb3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlID0gcHJldmlvdXNSZW5kZXJhYmxlLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgTkVYVCBTUFJJVEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IG5leHQgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIGl0IGtlZXBzIGxvb2tpbmcgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgZ2V0cyB0byB0aGUgZW5kIG9mIHRoZSBkaXNwbGF5CgkgKiAgc2NlbmUgZ3JhcGgKCSAqLwoJdmFyIG5leHRSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5sYXN0OwoJd2hpbGUobmV4dFJlbmRlcmFibGUuX2lOZXh0KQoJewoJCW5leHRSZW5kZXJhYmxlID0gbmV4dFJlbmRlcmFibGUuX2lOZXh0OwoJCWlmKG5leHRSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbmV4dFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJdGhpcy5pbnNlcnRPYmplY3QoZGlzcGxheU9iamVjdCwgcHJldmlvdXNSZW5kZXJhYmxlLCBuZXh0UmVuZGVyYWJsZSk7Cn0KCi8qKgogKiBBZGRzIGZpbHRlciBibG9ja3MKICoKICogQG1ldGhvZCBhZGRGaWx0ZXJCbG9ja3MKICogQHBhcmFtIHN0YXJ0IHtGaWx0ZXJCbG9ja30KICogQHBhcmFtIGVuZCB7RmlsdGVyQmxvY2t9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmFkZEZpbHRlckJsb2NrcyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKCXN0YXJ0Ll9fcmVuZGVyR3JvdXAgPSB0aGlzOwoJZW5kLl9fcmVuZGVyR3JvdXAgPSB0aGlzOwoJLyoKCSAqICBMT09LIEZPUiBUSEUgUFJFVklPVVMgUkVOREVSQUJMRQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgcHJldmlvdXMgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIEl0IGtlZXBzIGdvaW5nIGJhY2sgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgdGhlIHN0YWdlCgkgKi8KCXZhciBwcmV2aW91c1JlbmRlcmFibGUgPSBzdGFydDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZSAhPSB0aGlzLnJvb3QuZmlyc3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlID0gcHJldmlvdXNSZW5kZXJhYmxlLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCXRoaXMuaW5zZXJ0QWZ0ZXIoc3RhcnQsIHByZXZpb3VzUmVuZGVyYWJsZSk7CgkJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlMiA9IGVuZDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZTIgIT0gdGhpcy5yb290LmZpcnN0KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZTIgPSBwcmV2aW91c1JlbmRlcmFibGUyLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUyLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlMi5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJdGhpcy5pbnNlcnRBZnRlcihlbmQsIHByZXZpb3VzUmVuZGVyYWJsZTIpOwp9CgovKioKICogUmVtb3ZlIGZpbHRlciBibG9ja3MKICoKICogQG1ldGhvZCByZW1vdmVGaWx0ZXJCbG9ja3MKICogQHBhcmFtIHN0YXJ0IHtGaWx0ZXJCbG9ja30KICogQHBhcmFtIGVuZCB7RmlsdGVyQmxvY2t9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbW92ZUZpbHRlckJsb2NrcyA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKCXRoaXMucmVtb3ZlT2JqZWN0KHN0YXJ0KTsKCXRoaXMucmVtb3ZlT2JqZWN0KGVuZCk7Cn0KCi8qKgogKiBBZGRzIGEgZGlzcGxheSBvYmplY3QgYW5kIGNoaWxkcmVuIHRvIHRoZSB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5hZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4gPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CglpZihkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXApZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihkaXNwbGF5T2JqZWN0KTsKCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgUFJFVklPVVMgUkVOREVSQUJMRQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgcHJldmlvdXMgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIEl0IGtlZXBzIGdvaW5nIGJhY2sgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgdGhlIHN0YWdlCgkgKi8KCQoJdmFyIHByZXZpb3VzUmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl3aGlsZShwcmV2aW91c1JlbmRlcmFibGUgIT0gdGhpcy5yb290LmZpcnN0KQoJewoJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHByZXZpb3VzUmVuZGVyYWJsZS5faVByZXY7CgkJaWYocHJldmlvdXNSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgcHJldmlvdXNSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIE5FWFQgU1BSSVRFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBuZXh0IHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBpdCBrZWVwcyBsb29raW5nIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIGdldHMgdG8gdGhlIGVuZCBvZiB0aGUgZGlzcGxheQoJICogIHNjZW5lIGdyYXBoCgkgKi8KCXZhciBuZXh0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QubGFzdDsKCXdoaWxlKG5leHRSZW5kZXJhYmxlLl9pTmV4dCkKCXsKCQluZXh0UmVuZGVyYWJsZSA9IG5leHRSZW5kZXJhYmxlLl9pTmV4dDsKCQlpZihuZXh0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIG5leHRSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9CgkKCS8vIG9uZSB0aGUgZGlzcGxheSBvYmplY3QgaGl0cyB0aGlzLiB3ZSBjYW4gYnJlYWsgdGhlIGxvb3AJCgkKCXZhciB0ZW1wT2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCWRvCQoJewoJCXRlbXBPYmplY3QuX19yZW5kZXJHcm91cCA9IHRoaXM7CgkJCgkJaWYodGVtcE9iamVjdC5yZW5kZXJhYmxlKQoJCXsKCQkKCQkJdGhpcy5pbnNlcnRPYmplY3QodGVtcE9iamVjdCwgcHJldmlvdXNSZW5kZXJhYmxlLCBuZXh0UmVuZGVyYWJsZSk7CgkJCXByZXZpb3VzUmVuZGVyYWJsZSA9IHRlbXBPYmplY3Q7CgkJfQoJCQoJCXRlbXBPYmplY3QgPSB0ZW1wT2JqZWN0Ll9pTmV4dDsKCX0KCXdoaWxlKHRlbXBPYmplY3QgIT0gdGVzdE9iamVjdCkKfQoKLyoqCiAqIFJlbW92ZXMgYSBkaXNwbGF5IG9iamVjdCBhbmQgY2hpbGRyZW4gdG8gdGhlIHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCByZW1vdmVEaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4KICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbiA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCWlmKGRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cCAhPSB0aGlzKXJldHVybjsKCQovLwl2YXIgZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7Cgl2YXIgbGFzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdDsKCWRvCQoJewoJCWRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cCA9IG51bGw7CgkJaWYoZGlzcGxheU9iamVjdC5yZW5kZXJhYmxlKXRoaXMucmVtb3ZlT2JqZWN0KGRpc3BsYXlPYmplY3QpOwoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCX0KCXdoaWxlKGRpc3BsYXlPYmplY3QpCn0KCi8qKgogKiBJbnNlcnRzIGEgZGlzcGxheU9iamVjdCBpbnRvIHRoZSBsaW5rZWQgbGlzdAogKgogKiBAbWV0aG9kIGluc2VydE9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByZXZpb3VzT2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gbmV4dE9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaW5zZXJ0T2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcHJldmlvdXNPYmplY3QsIG5leHRPYmplY3QpCnsKCS8vIHdoaWxlIGxvb3BpbmcgYmVsb3cgVEhFIE9CSkVDVCBNQVkgTk9UIEhBVkUgQkVFTiBBRERFRAoJdmFyIHByZXZpb3VzU3ByaXRlID0gcHJldmlvdXNPYmplY3Q7Cgl2YXIgbmV4dFNwcml0ZSA9IG5leHRPYmplY3Q7CgkKCS8qCgkgKiBzbyBub3cgd2UgaGF2ZSB0aGUgbmV4dCByZW5kZXJhYmxlIGFuZCB0aGUgcHJldmlvdXMgcmVuZGVyYWJsZQoJICogCgkgKi8KCWlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQl2YXIgcHJldmlvdXNCYXRjaAoJCXZhciBuZXh0QmF0Y2gKCQkKCQlpZihwcmV2aW91c1Nwcml0ZSBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJCXsKCQkJcHJldmlvdXNCYXRjaCA9IHByZXZpb3VzU3ByaXRlLmJhdGNoOwoJCQlpZihwcmV2aW91c0JhdGNoKQoJCQl7CgkJCQlpZihwcmV2aW91c0JhdGNoLnRleHR1cmUgPT0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlICYmIHByZXZpb3VzQmF0Y2guYmxlbmRNb2RlID09IGRpc3BsYXlPYmplY3QuYmxlbmRNb2RlKQoJCQkJewoJCQkJCXByZXZpb3VzQmF0Y2guaW5zZXJ0QWZ0ZXIoZGlzcGxheU9iamVjdCwgcHJldmlvdXNTcHJpdGUpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoJCX0KCQllbHNlCgkJewoJCQkvLyBUT0RPIHJld29yZCEKCQkJcHJldmlvdXNCYXRjaCA9IHByZXZpb3VzU3ByaXRlOwoJCX0KCQoJCWlmKG5leHRTcHJpdGUpCgkJewoJCQlpZihuZXh0U3ByaXRlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJCXsKCQkJCW5leHRCYXRjaCA9IG5leHRTcHJpdGUuYmF0Y2g7CgkJCQoJCQkJLy9iYXRjaCBtYXkgbm90IGV4aXN0IGlmIGl0ZW0gd2FzIGFkZGVkIHRvIHRoZSBkaXNwbGF5IGxpc3QgYnV0IG5vdCB0byB0aGUgd2ViR0wKCQkJCWlmKG5leHRCYXRjaCkKCQkJCXsKCQkJCQlpZihuZXh0QmF0Y2gudGV4dHVyZSA9PSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUgJiYgbmV4dEJhdGNoLmJsZW5kTW9kZSA9PSBkaXNwbGF5T2JqZWN0LmJsZW5kTW9kZSkKCQkJCQl7CgkJCQkJCW5leHRCYXRjaC5pbnNlcnRCZWZvcmUoZGlzcGxheU9iamVjdCwgbmV4dFNwcml0ZSk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJaWYobmV4dEJhdGNoID09IHByZXZpb3VzQmF0Y2gpCgkJCQkJCXsKCQkJCQkJCS8vIFRIRVJFIElTIEEgU1BMSVQgSU4gVEhJUyBCQVRDSCEgLy8KCQkJCQkJCXZhciBzcGxpdEJhdGNoID0gcHJldmlvdXNCYXRjaC5zcGxpdChuZXh0U3ByaXRlKTsKCQkJCQkJCS8vIENPT0whCgkJCQkJCQkvLyBhZGQgaXQgYmFjayBpbnRvIHRoZSBhcnJheQkKCQkJCQkJCS8qCgkJCQkJCQkgKiBPT1BTIQoJCQkJCQkJICogc2VlbXMgdGhlIG5ldyBzcHJpdGUgaXMgaW4gdGhlIG1pZGRsZSBvZiBhIGJhdGNoCgkJCQkJCQkgKiBsZXRzIHNwbGl0IGl0Li4gCgkJCQkJCQkgKi8KCQkJCQkJCXZhciBiYXRjaCA9IFBJWEkuV2ViR0xSZW5kZXJlci5nZXRCYXRjaCgpOwoKCQkJCQkJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIHByZXZpb3VzQmF0Y2ggKTsKCQkJCQkJCWJhdGNoLmluaXQoZGlzcGxheU9iamVjdCk7CgkJCQkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgYmF0Y2gsIHNwbGl0QmF0Y2gpOwoJCQkJCQkJCgkJCQkJCQlyZXR1cm47CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBUT0RPIHJlLXdvcmQhCgkJCQkKCQkJCW5leHRCYXRjaCA9IG5leHRTcHJpdGU7CgkJCX0KCQl9CgkJCgkJLyoKCQkgKiBsb29rcyBsaWtlIGl0IGRvZXMgbm90IGJlbG9uZyB0byBhbnkgYmF0Y2ghCgkJICogYnV0IGlzIGFsc28gbm90IGludGVyc2VjdGluZyBvbmUuLgoJCSAqIHRpbWUgdG8gY3JlYXRlIGFuZXcgb25lIQoJCSAqLwoJCQoJCXZhciBiYXRjaCA9ICBQSVhJLldlYkdMUmVuZGVyZXIuZ2V0QmF0Y2goKTsKCQliYXRjaC5pbml0KGRpc3BsYXlPYmplY3QpOwoKCQlpZihwcmV2aW91c0JhdGNoKSAvLyBpZiB0aGlzIGlzIGludmFsaWQgaXQgbWVhbnMgCgkJewoJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBiYXRjaCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuYmF0Y2hzLnB1c2goYmF0Y2gpOwoJCX0KCQkKCQlyZXR1cm47Cgl9CgllbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlRpbGluZ1Nwcml0ZSkKCXsKCQkKCQkvLyBhZGQgdG8gYSBiYXRjaCEhCgkJdGhpcy5pbml0VGlsaW5nU3ByaXRlKGRpc3BsYXlPYmplY3QpOwoJLy8JdGhpcy5iYXRjaHMucHVzaChkaXNwbGF5T2JqZWN0KTsKCQkKCX0KCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3RyaXApCgl7CgkJLy8gYWRkIHRvIGEgYmF0Y2ghIQoJCXRoaXMuaW5pdFN0cmlwKGRpc3BsYXlPYmplY3QpOwoJLy8JdGhpcy5iYXRjaHMucHVzaChkaXNwbGF5T2JqZWN0KTsKCX0KCWVsc2UgaWYoZGlzcGxheU9iamVjdCkvLyBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCgl7CgkJLy9kaXNwbGF5T2JqZWN0LmluaXRXZWJHTCh0aGlzKTsKCQkKCQkvLyBhZGQgdG8gYSBiYXRjaCEhCgkJLy90aGlzLmluaXRTdHJpcChkaXNwbGF5T2JqZWN0KTsKCQkvL3RoaXMuYmF0Y2hzLnB1c2goZGlzcGxheU9iamVjdCk7Cgl9CgkKCXRoaXMuaW5zZXJ0QWZ0ZXIoZGlzcGxheU9iamVjdCwgcHJldmlvdXNTcHJpdGUpOwoJCQkKCS8vIGluc2VydCBhbmQgU1BMSVQhCgp9CgovKioKICogSW5zZXJ0cyBhIGRpc3BsYXlPYmplY3QgaW50byB0aGUgbGlua2VkIGxpc3QKICoKICogQG1ldGhvZCBpbnNlcnRBZnRlcgogKiBAcGFyYW0gaXRlbSB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBvYmplY3QgdG8gaW5zZXJ0CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluc2VydEFmdGVyID0gZnVuY3Rpb24oaXRlbSwgZGlzcGxheU9iamVjdCkKewoJaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCXZhciBwcmV2aW91c0JhdGNoID0gZGlzcGxheU9iamVjdC5iYXRjaDsKCQkKCQlpZihwcmV2aW91c0JhdGNoKQoJCXsKCQkJLy8gc28gdGhpcyBvYmplY3QgaXMgaW4gYSBiYXRjaCEKCQkJCgkJCS8vIGlzIGl0IG5vdD8gbmVlZCB0byBzcGxpdCB0aGUgYmF0Y2gKCQkJaWYocHJldmlvdXNCYXRjaC50YWlsID09IGRpc3BsYXlPYmplY3QpCgkJCXsKCQkJCS8vIGlzIGl0IHRhaWw/IGluc2VydCBpbiB0byBiYXRjaHMJCgkJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgaXRlbSk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBUT0RPIE1PRElGWSBBREQgLyBSRU1PVkUgQ0hJTEQgVE8gQUNDT1VOVCBGT1IgRklMVEVSUyAoYWxzbyBnZXQgcHJldiBhbmQgbmV4dCkgLy8KCQkJCQoJCQkJLy8gVEhFUkUgSVMgQSBTUExJVCBJTiBUSElTIEJBVENIISAvLwoJCQkJdmFyIHNwbGl0QmF0Y2ggPSBwcmV2aW91c0JhdGNoLnNwbGl0KGRpc3BsYXlPYmplY3QuX19uZXh0KTsKCQkJCQoJCQkJLy8gQ09PTCEKCQkJCS8vIGFkZCBpdCBiYWNrIGludG8gdGhlIGFycmF5CQoJCQkJLyoKCQkJCSAqIE9PUFMhCgkJCQkgKiBzZWVtcyB0aGUgbmV3IHNwcml0ZSBpcyBpbiB0aGUgbWlkZGxlIG9mIGEgYmF0Y2gKCQkJCSAqIGxldHMgc3BsaXQgaXQuLiAKCQkJCSAqLwoJCQkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggcHJldmlvdXNCYXRjaCApOwoJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGl0ZW0sIHNwbGl0QmF0Y2gpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuYmF0Y2hzLnB1c2goaXRlbSk7CgkJfQoJfQoJZWxzZQoJewoJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIGRpc3BsYXlPYmplY3QgKTsKCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgaXRlbSk7Cgl9Cn0KCi8qKgogKiBSZW1vdmVzIGEgZGlzcGxheU9iamVjdCBmcm9tIHRoZSBsaW5rZWQgbGlzdAogKgogKiBAbWV0aG9kIHJlbW92ZU9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIG9iamVjdCB0byByZW1vdmUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVtb3ZlT2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJLy8gbG9vcCB0aHJvdWdoIGNoaWxkcmVuLi4KCS8vIGRpc3BsYXkgb2JqZWN0IC8vCgkKCS8vIGFkZCBhIGNoaWxkIGZyb20gdGhlIHJlbmRlciBncm91cC4uCgkvLyByZW1vdmUgaXQgYW5kIGFsbCBpdHMgY2hpbGRyZW4hCgkvL2Rpc3BsYXlPYmplY3QuY2FjaGVWaXNpYmxlID0gZmFsc2U7Ly9kaXNwbGF5T2JqZWN0LnZpc2libGU7CgoJLyoKCSAqIHJlbW92aW5nIGlzIGEgbG90IHF1aWNrZXIuLgoJICogCgkgKi8KCXZhciBiYXRjaFRvUmVtb3ZlOwoJCglpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJLy8gc2hvdWxkIGFsd2F5cyBoYXZlIGEgYmF0Y2ghCgkJdmFyIGJhdGNoID0gZGlzcGxheU9iamVjdC5iYXRjaDsKCQlpZighYmF0Y2gpcmV0dXJuOyAvLyB0aGlzIG1lYW5zIHRoZSBkaXNwbGF5IGxpc3QgaGFzIGJlZW4gYWx0ZXJlZCBiZWZyZSByZW5kZXJpbmcKCQkKCQliYXRjaC5yZW1vdmUoZGlzcGxheU9iamVjdCk7CgkJCgkJaWYoYmF0Y2guc2l6ZT09MCkKCQl7CgkJCWJhdGNoVG9SZW1vdmUgPSBiYXRjaDsKCQl9Cgl9CgllbHNlCgl7CgkJYmF0Y2hUb1JlbW92ZSA9IGRpc3BsYXlPYmplY3Q7Cgl9CgkKCS8qCgkgKiBMb29rcyBsaWtlIHRoZXJlIGlzIHNvbXRoaW5nIHRoYXQgbmVlZHMgcmVtb3ZpbmchCgkgKi8KCWlmKGJhdGNoVG9SZW1vdmUpCQoJewoJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIGJhdGNoVG9SZW1vdmUgKTsKCQlpZihpbmRleCA9PSAtMSlyZXR1cm47Ly8gdGhpcyBtZWFucyBpdCB3YXMgYWRkZWQgdGhlbiByZW1vdmVkIGJlZm9yZSByZW5kZXJlZAoJCQoJCS8vIG9rIHNvLi4gY2hlY2sgdG8gc2VlIGlmIHlvdSBhZGphY2VudCBiYXRjaHMgc2hvdWxkIGJlIGpvaW5lZC4KCQkvLyBUT0RPIG1heSBvcHRpbWlzZT8KCQlpZihpbmRleCA9PSAwIHx8IGluZGV4ID09IHRoaXMuYmF0Y2hzLmxlbmd0aC0xKQoJCXsKCQkJLy8gd2hhIC0gZXZhISBqdXN0IGdldCBvZiB0aGUgZW1wdHkgYmF0Y2ghCgkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCwgMSk7CgkJCWlmKGJhdGNoVG9SZW1vdmUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKGJhdGNoVG9SZW1vdmUpOwoJCQoJCQlyZXR1cm47CgkJfQoJCQoJCWlmKHRoaXMuYmF0Y2hzW2luZGV4LTFdIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoICYmIHRoaXMuYmF0Y2hzW2luZGV4KzFdIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJaWYodGhpcy5iYXRjaHNbaW5kZXgtMV0udGV4dHVyZSA9PSB0aGlzLmJhdGNoc1tpbmRleCsxXS50ZXh0dXJlICYmIHRoaXMuYmF0Y2hzW2luZGV4LTFdLmJsZW5kTW9kZSA9PSB0aGlzLmJhdGNoc1tpbmRleCsxXS5ibGVuZE1vZGUpCgkJCXsKCQkJCS8vY29uc29sZS5sb2coIk1FUkdFIikKCQkJCXRoaXMuYmF0Y2hzW2luZGV4LTFdLm1lcmdlKHRoaXMuYmF0Y2hzW2luZGV4KzFdKTsKCQkJCQoJCQkJaWYoYmF0Y2hUb1JlbW92ZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaClQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2goYmF0Y2hUb1JlbW92ZSk7CgkJCQlQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2godGhpcy5iYXRjaHNbaW5kZXgrMV0pOwoJCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4LCAyKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQkKCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgsIDEpOwoJCWlmKGJhdGNoVG9SZW1vdmUgaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpUElYSS5XZWJHTFJlbmRlcmVyLnJldHVybkJhdGNoKGJhdGNoVG9SZW1vdmUpOwoJfQp9CgoKLyoqCiAqIEluaXRpYWxpemVzIGEgdGlsaW5nIHNwcml0ZQogKgogKiBAbWV0aG9kIGluaXRUaWxpbmdTcHJpdGUKICogQHBhcmFtIHNwcml0ZSB7VGlsaW5nU3ByaXRlfSBUaGUgdGlsaW5nIHNwcml0ZSB0byBpbml0aWFsaXplCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluaXRUaWxpbmdTcHJpdGUgPSBmdW5jdGlvbihzcHJpdGUpCnsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJLy8gbWFrZSB0aGUgdGV4dHVyZSB0aWxhYmxlLi4KCQkJCglzcHJpdGUudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMCwKCQkJCQkJCQkJCSAgc3ByaXRlLndpZHRoLCAwLAoJCQkJCQkJCQkJICBzcHJpdGUud2lkdGgsICBzcHJpdGUuaGVpZ2h0LAoJCQkJCQkJCQkJIDAsICBzcHJpdGUuaGVpZ2h0XSk7CgkJCQkJCglzcHJpdGUudXZzID0gbmV3IEZsb2F0MzJBcnJheShbMCwgMCwKCQkJCQkJCQkJMSwgMCwKCQkJCQkJCQkJMSwgMSwKCQkJCQkJCQkJMCwgMV0pOwoJCQkJCglzcHJpdGUuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShbMSwxLDEsMV0pOwoJCglzcHJpdGUuaW5kaWNlcyA9ICBuZXcgVWludDE2QXJyYXkoWzAsIDEsIDMsMl0pLy8sIDJdKTsKCQoJc3ByaXRlLl92ZXJ0ZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5faW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5fdXZCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXNwcml0ZS5fY29sb3JCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCQkJCQkJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl92ZXJ0ZXhCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS52ZXJ0aWNpZXMsIGdsLlNUQVRJQ19EUkFXKTsKCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl91dkJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgIHNwcml0ZS51dnMsIGdsLkRZTkFNSUNfRFJBVyk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5fY29sb3JCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHNwcml0ZS5jb2xvcnMsIGdsLlNUQVRJQ19EUkFXKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzcHJpdGUuX2luZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHNwcml0ZS5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7CiAgICAKLy8gICAgcmV0dXJuICggKHggPiAwKSAmJiAoKHggJiAoeCAtIDEpKSA9PSAwKSApOwoKCWlmKHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpCgl7CiAgICAJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CiAgICAJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuUkVQRUFUKTsKCQlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5SRVBFQVQpOwoJCXNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLl9wb3dlck9mMiA9IHRydWU7Cgl9CgllbHNlCgl7CgkJc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX3Bvd2VyT2YyID0gdHJ1ZTsKCX0KfQoKLyoqCiAqIFJlbmRlcnMgYSBTdHJpcAogKgogKiBAbWV0aG9kIHJlbmRlclN0cmlwCiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBzdHJpcCB0byByZW5kZXIKICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3RyaXAgPSBmdW5jdGlvbihzdHJpcCwgcHJvamVjdGlvbikKewoJdmFyIGdsID0gdGhpcy5nbDsKCglQSVhJLmFjdGl2YXRlU3RyaXBTaGFkZXIoKTsKCgl2YXIgc2hhZGVyID0gUElYSS5zdHJpcFNoYWRlcjsKCgl2YXIgcHJvZ3JhbSA9IHNoYWRlci5wcm9ncmFtOwoJCgl2YXIgbSA9IFBJWEkubWF0My5jbG9uZShzdHJpcC53b3JsZFRyYW5zZm9ybSk7CgkKCVBJWEkubWF0My50cmFuc3Bvc2UobSk7CgkKLy8JY29uc29sZS5sb2cocHJvamVjdGlvbikKCS8vIHNldCB0aGUgbWF0cml4IHRyYW5zZm9ybSBmb3IgdGhlIAogCWdsLnVuaWZvcm1NYXRyaXgzZnYoc2hhZGVyLnRyYW5zbGF0aW9uTWF0cml4LCBmYWxzZSwgbSk7CglnbC51bmlmb3JtMmYoc2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgcHJvamVjdGlvbi55KTsKCWdsLnVuaWZvcm0yZihzaGFkZXIub2Zmc2V0VmVjdG9yLCAtUElYSS5vZmZzZXQueCwgLVBJWEkub2Zmc2V0LnkpOwoJCglnbC51bmlmb3JtMWYoc2hhZGVyLmFscGhhLCBzdHJpcC53b3JsZEFscGhhKTsKCgkvKgoJaWYoc3RyaXAuYmxlbmRNb2RlID09IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUwpCgl7CgkJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSk7Cgl9CgllbHNlCgl7CgkJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19DT0xPUik7Cgl9CgkqLwoJCgkvL2NvbnNvbGUubG9nKCIhISIpCglpZighc3RyaXAuZGlydHkpCgl7CQoJCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdmVydGV4QnVmZmVyKTsKCQlnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgc3RyaXAudmVydGljaWVzKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyB1cGRhdGUgdGhlIHV2cwoJICAgCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdXZCdWZmZXIpOwoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCQoJICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgkJCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl9jb2xvckJ1ZmZlcik7CgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDEsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKCSAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5faW5kZXhCdWZmZXIpOwoJfQoJZWxzZQoJewoJCXN0cmlwLmRpcnR5ID0gZmFsc2U7CgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl92ZXJ0ZXhCdWZmZXIpOwoJCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC52ZXJ0aWNpZXMsIGdsLlNUQVRJQ19EUkFXKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyB1cGRhdGUgdGhlIHV2cwoJICAgCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdXZCdWZmZXIpOwoJICAgCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC51dnMsIGdsLlNUQVRJQ19EUkFXKQoJICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFUZXh0dXJlQ29vcmQsIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCQoJICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgkvLwljb25zb2xlLmxvZyhzdHJpcC50ZXh0dXJlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl9jb2xvckJ1ZmZlcik7CgkJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLmNvbG9ycywgZ2wuU1RBVElDX0RSQVcpCgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDEsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkJCgkJLy8gZG9udCBuZWVkIHRvIHVwbG9hZCEKCSAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5faW5kZXhCdWZmZXIpOwoJICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKCSAgICAKCX0KCQoJZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFX1NUUklQLCBzdHJpcC5pbmRpY2VzLmxlbmd0aCwgZ2wuVU5TSUdORURfU0hPUlQsIDApOwogICAgCiAgICBQSVhJLmRlYWN0aXZhdGVTdHJpcFNoYWRlcigpOwogIAkvL2dsLnVzZVByb2dyYW0oUElYSS5jdXJyZW50UHJvZ3JhbSk7Cn0KCi8qKgogKiBSZW5kZXJzIGEgVGlsaW5nU3ByaXRlCiAqCiAqIEBtZXRob2QgcmVuZGVyVGlsaW5nU3ByaXRlCiAqIEBwYXJhbSBzcHJpdGUge1RpbGluZ1Nwcml0ZX0gVGhlIHRpbGluZyBzcHJpdGUgdG8gcmVuZGVyCiAqIEBwYXJhbSBwcm9qZWN0aW9uTWF0cml4IHtPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLnJlbmRlclRpbGluZ1Nwcml0ZSA9IGZ1bmN0aW9uKHNwcml0ZSwgcHJvamVjdGlvbk1hdHJpeCkKewoJdmFyIGdsID0gdGhpcy5nbDsKCgoJdmFyIHNoYWRlclByb2dyYW0gPSBQSVhJLnNoYWRlclByb2dyYW07CgkKCXZhciB0aWxlUG9zaXRpb24gPSBzcHJpdGUudGlsZVBvc2l0aW9uOwoJdmFyIHRpbGVTY2FsZSA9IHNwcml0ZS50aWxlU2NhbGU7CgkKCXZhciBvZmZzZXRYID0gIHRpbGVQb3NpdGlvbi54L3Nwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwoJdmFyIG9mZnNldFkgPSAgdGlsZVBvc2l0aW9uLnkvc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0OwoJCgl2YXIgc2NhbGVYID0gIChzcHJpdGUud2lkdGggLyBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aCkgIC8gdGlsZVNjYWxlLng7Cgl2YXIgc2NhbGVZID0gIChzcHJpdGUuaGVpZ2h0IC8gc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0KSAvIHRpbGVTY2FsZS55OwoKCXNwcml0ZS51dnNbMF0gPSAwIC0gb2Zmc2V0WDsKCXNwcml0ZS51dnNbMV0gPSAwIC0gb2Zmc2V0WTsKCQoJc3ByaXRlLnV2c1syXSA9ICgxICogc2NhbGVYKSAgLW9mZnNldFg7CglzcHJpdGUudXZzWzNdID0gMCAtIG9mZnNldFk7CgkKCXNwcml0ZS51dnNbNF0gPSAoMSAqc2NhbGVYKSAtIG9mZnNldFg7CglzcHJpdGUudXZzWzVdID0gKDEgKnNjYWxlWSkgLSBvZmZzZXRZOwoJCglzcHJpdGUudXZzWzZdID0gMCAtIG9mZnNldFg7CglzcHJpdGUudXZzWzddID0gKDEgKnNjYWxlWSkgLSBvZmZzZXRZOwoJCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl91dkJ1ZmZlcik7CglnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgc3ByaXRlLnV2cykKCQoJdGhpcy5yZW5kZXJTdHJpcChzcHJpdGUsIHByb2plY3Rpb25NYXRyaXgpOwp9CgovKioKICogSW5pdGlhbGl6ZXMgYSBzdHJpcCB0byBiZSByZW5kZXJlZAogKgogKiBAbWV0aG9kIGluaXRTdHJpcAogKiBAcGFyYW0gc3RyaXAge1N0cmlwfSBUaGUgc3RyaXAgdG8gaW5pdGlhbGl6ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5pbml0U3RyaXAgPSBmdW5jdGlvbihzdHJpcCkKewoJLy8gYnVpbGQgdGhlIHN0cmlwIQoJdmFyIGdsID0gdGhpcy5nbDsKCXZhciBzaGFkZXJQcm9ncmFtID0gdGhpcy5zaGFkZXJQcm9ncmFtOwoJCglzdHJpcC5fdmVydGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzdHJpcC5faW5kZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXN0cmlwLl91dkJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3RyaXAuX2NvbG9yQnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fdmVydGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC52ZXJ0aWNpZXMsIGdsLkRZTkFNSUNfRFJBVyk7CgoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl91dkJ1ZmZlcik7CiAgICBnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgIHN0cmlwLnV2cywgZ2wuU1RBVElDX0RSQVcpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzdHJpcC5fY29sb3JCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLmNvbG9ycywgZ2wuU1RBVElDX0RSQVcpOwoKCQogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuX2luZGV4QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKfQoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKUElYSS5pbml0RGVmYXVsdFNoYWRlcnMgPSBmdW5jdGlvbigpIAp7CglQSVhJLnByaW1pdGl2ZVNoYWRlciA9IG5ldyBQSVhJLlByaW1pdGl2ZVNoYWRlcigpOwogIFBJWEkucHJpbWl0aXZlU2hhZGVyLmluaXQoKTsKCiAgUElYSS5zdHJpcFNoYWRlciA9IG5ldyBQSVhJLlN0cmlwU2hhZGVyKCk7CiAgUElYSS5zdHJpcFNoYWRlci5pbml0KCk7CgoJUElYSS5kZWZhdWx0U2hhZGVyID0gbmV3IFBJWEkuUGl4aVNoYWRlcigpOwoJUElYSS5kZWZhdWx0U2hhZGVyLmluaXQoKTsKCiAgdmFyIGdsID0gUElYSS5nbDsgCiAgdmFyIHNoYWRlclByb2dyYW0gPSBQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbTsKIAoKICBnbC51c2VQcm9ncmFtKHNoYWRlclByb2dyYW0pOwogIAogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwp9CgpQSVhJLmFjdGl2YXRlUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgdmFyIGdsID0gUElYSS5nbDsKICAKICBnbC51c2VQcm9ncmFtKFBJWEkucHJpbWl0aXZlU2hhZGVyLnByb2dyYW0pOwogIAogIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVZlcnRleFBvc2l0aW9uKTsKICBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKICBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwoKICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKfSAKClBJWEkuZGVhY3RpdmF0ZVByaW1pdGl2ZVNoYWRlciA9IGZ1bmN0aW9uKCkKewogIHZhciBnbCA9IFBJWEkuZ2w7CgogIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwogIAogIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLnByaW1pdGl2ZVNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CgogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5jb2xvckF0dHJpYnV0ZSk7CiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwoKfQoKUElYSS5hY3RpdmF0ZVN0cmlwU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgdmFyIGdsID0gUElYSS5nbDsKICAKICBnbC51c2VQcm9ncmFtKFBJWEkuc3RyaXBTaGFkZXIucHJvZ3JhbSk7CiAvLyBnbC5kaXNhYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwp9IAoKUElYSS5kZWFjdGl2YXRlU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKICB2YXIgZ2wgPSBQSVhJLmdsOwoKICBnbC51c2VQcm9ncmFtKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9ncmFtKTsKICAvL2dsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVGV4dHVyZUNvb3JkKTsKfQoKLyoKClNIQURFUiBDT01QSUxFUiBIRUxQRVJTCiovCgpQSVhJLkNvbXBpbGVWZXJ0ZXhTaGFkZXIgPSBmdW5jdGlvbihnbCwgc2hhZGVyU3JjKQp7CiAgcmV0dXJuIFBJWEkuX0NvbXBpbGVTaGFkZXIoZ2wsIHNoYWRlclNyYywgZ2wuVkVSVEVYX1NIQURFUik7Cn0KClBJWEkuQ29tcGlsZUZyYWdtZW50U2hhZGVyID0gZnVuY3Rpb24oZ2wsIHNoYWRlclNyYykKewogIHJldHVybiBQSVhJLl9Db21waWxlU2hhZGVyKGdsLCBzaGFkZXJTcmMsIGdsLkZSQUdNRU5UX1NIQURFUik7Cn0KClBJWEkuX0NvbXBpbGVTaGFkZXIgPSBmdW5jdGlvbihnbCwgc2hhZGVyU3JjLCBzaGFkZXJUeXBlKQp7CiAgdmFyIHNyYyA9IHNoYWRlclNyYy5qb2luKCJcbiIpOwogIHZhciBzaGFkZXIgPSBnbC5jcmVhdGVTaGFkZXIoc2hhZGVyVHlwZSk7CiAgZ2wuc2hhZGVyU291cmNlKHNoYWRlciwgc3JjKTsKICBnbC5jb21waWxlU2hhZGVyKHNoYWRlcik7CgogIGlmICghZ2wuZ2V0U2hhZGVyUGFyYW1ldGVyKHNoYWRlciwgZ2wuQ09NUElMRV9TVEFUVVMpKSB7CiAgICBjb25zb2xlLmxvZyhnbC5nZXRTaGFkZXJJbmZvTG9nKHNoYWRlcikpOwogICAgcmV0dXJuIG51bGw7CiAgfQoKICByZXR1cm4gc2hhZGVyOwp9CgoKUElYSS5jb21waWxlUHJvZ3JhbSA9IGZ1bmN0aW9uKHZlcnRleFNyYywgZnJhZ21lbnRTcmMpCnsKCXZhciBnbCA9IFBJWEkuZ2w7Cgl2YXIgZnJhZ21lbnRTaGFkZXIgPSBQSVhJLkNvbXBpbGVGcmFnbWVudFNoYWRlcihnbCwgZnJhZ21lbnRTcmMpOwoJdmFyIHZlcnRleFNoYWRlciA9IFBJWEkuQ29tcGlsZVZlcnRleFNoYWRlcihnbCwgdmVydGV4U3JjKTsKCQoJdmFyIHNoYWRlclByb2dyYW0gPSBnbC5jcmVhdGVQcm9ncmFtKCk7CgkKICAgIGdsLmF0dGFjaFNoYWRlcihzaGFkZXJQcm9ncmFtLCB2ZXJ0ZXhTaGFkZXIpOwogICAgZ2wuYXR0YWNoU2hhZGVyKHNoYWRlclByb2dyYW0sIGZyYWdtZW50U2hhZGVyKTsKICAgIGdsLmxpbmtQcm9ncmFtKHNoYWRlclByb2dyYW0pOwoKICAgIGlmICghZ2wuZ2V0UHJvZ3JhbVBhcmFtZXRlcihzaGFkZXJQcm9ncmFtLCBnbC5MSU5LX1NUQVRVUykpIHsKICAgICAgICBjb25zb2xlLmxvZygiQ291bGQgbm90IGluaXRpYWxpc2Ugc2hhZGVycyIpOwogICAgfQoKCXJldHVybiBzaGFkZXJQcm9ncmFtOwp9IAoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIFRleHQgT2JqZWN0IHdpbGwgY3JlYXRlIGEgbGluZShzKSBvZiB0ZXh0IHVzaW5nIGJpdG1hcCBmb250LiBUbyBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgIlxuIiwgIlxyIiBvciAiXHJcbiIKICogWW91IGNhbiBnZW5lcmF0ZSB0aGUgZm50IGZpbGVzIHVzaW5nCiAqIGh0dHA6Ly93d3cuYW5nZWxjb2RlLmNvbS9wcm9kdWN0cy9ibWZvbnQvIGZvciB3aW5kb3dzIG9yCiAqIGh0dHA6Ly93d3cuYm1nbHlwaC5jb20vIGZvciBtYWMuCiAqCiAqIEBjbGFzcyBCaXRtYXBUZXh0CiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0IHtTdHJpbmd9IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKiBAcGFyYW0gc3R5bGUge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIHN0eWxlLmZvbnQge1N0cmluZ30gVGhlIHNpemUgKG9wdGlvbmFsKSBhbmQgYml0bWFwIGZvbnQgaWQgKHJlcXVpcmVkKSBlcSAiQXJpYWwiIG9yICIyMHB4IEFyaWFsIiAobXVzdCBoYXZlIGxvYWRlZCBwcmV2aW91c2x5KQogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSJsZWZ0Il0ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoImxlZnQiLCAiY2VudGVyIiBvciAicmlnaHQiKQogKi8KUElYSS5CaXRtYXBUZXh0ID0gZnVuY3Rpb24odGV4dCwgc3R5bGUpCnsKICAgIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKHRoaXMpOwoKICAgIHRoaXMuc2V0VGV4dCh0ZXh0KTsKICAgIHRoaXMuc2V0U3R5bGUoc3R5bGUpOwogICAgdGhpcy51cGRhdGVUZXh0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2UKCn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlKTsKUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQml0bWFwVGV4dDsKCi8qKgogKiBTZXQgdGhlIGNvcHkgZm9yIHRoZSB0ZXh0IG9iamVjdAogKgogKiBAbWV0aG9kIHNldFRleHQKICogQHBhcmFtIHRleHQge1N0cmluZ30gVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqLwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICB0aGlzLnRleHQgPSB0ZXh0IHx8ICIgIjsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFNldCB0aGUgc3R5bGUgb2YgdGhlIHRleHQKICoKICogQG1ldGhvZCBzZXRTdHlsZQogKiBAcGFyYW0gc3R5bGUge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIHN0eWxlLmZvbnQge1N0cmluZ30gVGhlIHNpemUgKG9wdGlvbmFsKSBhbmQgYml0bWFwIGZvbnQgaWQgKHJlcXVpcmVkKSBlcSAiQXJpYWwiIG9yICIyMHB4IEFyaWFsIiAobXVzdCBoYXZlIGxvYWRlZCBwcmV2aW91c2x5KQogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSJsZWZ0Il0ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoImxlZnQiLCAiY2VudGVyIiBvciAicmlnaHQiKQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS5zZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlKQp7CiAgICBzdHlsZSA9IHN0eWxlIHx8IHt9OwogICAgc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAibGVmdCI7CiAgICB0aGlzLnN0eWxlID0gc3R5bGU7CgogICAgdmFyIGZvbnQgPSBzdHlsZS5mb250LnNwbGl0KCIgIik7CiAgICB0aGlzLmZvbnROYW1lID0gZm9udFtmb250Lmxlbmd0aCAtIDFdOwogICAgdGhpcy5mb250U2l6ZSA9IGZvbnQubGVuZ3RoID49IDIgPyBwYXJzZUludChmb250W2ZvbnQubGVuZ3RoIC0gMl0sIDEwKSA6IFBJWEkuQml0bWFwVGV4dC5mb250c1t0aGlzLmZvbnROYW1lXS5zaXplOwoKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFJlbmRlcnMgdGV4dAogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHQKICogQHByaXZhdGUKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlVGV4dCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIGRhdGEgPSBQSVhJLkJpdG1hcFRleHQuZm9udHNbdGhpcy5mb250TmFtZV07CiAgICB2YXIgcG9zID0gbmV3IFBJWEkuUG9pbnQoKTsKICAgIHZhciBwcmV2Q2hhckNvZGUgPSBudWxsOwogICAgdmFyIGNoYXJzID0gW107CiAgICB2YXIgbWF4TGluZVdpZHRoID0gMDsKICAgIHZhciBsaW5lV2lkdGhzID0gW107CiAgICB2YXIgbGluZSA9IDA7CiAgICB2YXIgc2NhbGUgPSB0aGlzLmZvbnRTaXplIC8gZGF0YS5zaXplOwogICAgZm9yKHZhciBpID0gMDsgaSA8IHRoaXMudGV4dC5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgY2hhckNvZGUgPSB0aGlzLnRleHQuY2hhckNvZGVBdChpKTsKICAgICAgICBpZigvKD86XHJcbnxccnxcbikvLnRlc3QodGhpcy50ZXh0LmNoYXJBdChpKSkpCiAgICAgICAgewogICAgICAgICAgICBsaW5lV2lkdGhzLnB1c2gocG9zLngpOwogICAgICAgICAgICBtYXhMaW5lV2lkdGggPSBNYXRoLm1heChtYXhMaW5lV2lkdGgsIHBvcy54KTsKICAgICAgICAgICAgbGluZSsrOwoKICAgICAgICAgICAgcG9zLnggPSAwOwogICAgICAgICAgICBwb3MueSArPSBkYXRhLmxpbmVIZWlnaHQ7CiAgICAgICAgICAgIHByZXZDaGFyQ29kZSA9IG51bGw7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgdmFyIGNoYXJEYXRhID0gZGF0YS5jaGFyc1tjaGFyQ29kZV07CiAgICAgICAgaWYoIWNoYXJEYXRhKSBjb250aW51ZTsKCiAgICAgICAgaWYocHJldkNoYXJDb2RlICYmIGNoYXJEYXRhW3ByZXZDaGFyQ29kZV0pCiAgICAgICAgewogICAgICAgICAgIHBvcy54ICs9IGNoYXJEYXRhLmtlcm5pbmdbcHJldkNoYXJDb2RlXTsKICAgICAgICB9CiAgICAgICAgY2hhcnMucHVzaCh7dGV4dHVyZTpjaGFyRGF0YS50ZXh0dXJlLCBsaW5lOiBsaW5lLCBjaGFyQ29kZTogY2hhckNvZGUsIHBvc2l0aW9uOiBuZXcgUElYSS5Qb2ludChwb3MueCArIGNoYXJEYXRhLnhPZmZzZXQsIHBvcy55ICsgY2hhckRhdGEueU9mZnNldCl9KTsKICAgICAgICBwb3MueCArPSBjaGFyRGF0YS54QWR2YW5jZTsKCiAgICAgICAgcHJldkNoYXJDb2RlID0gY2hhckNvZGU7CiAgICB9CgogICAgbGluZVdpZHRocy5wdXNoKHBvcy54KTsKICAgIG1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgcG9zLngpOwoKICAgIHZhciBsaW5lQWxpZ25PZmZzZXRzID0gW107CiAgICBmb3IoaSA9IDA7IGkgPD0gbGluZTsgaSsrKQogICAgewogICAgICAgIHZhciBhbGlnbk9mZnNldCA9IDA7CiAgICAgICAgaWYodGhpcy5zdHlsZS5hbGlnbiA9PSAicmlnaHQiKQogICAgICAgIHsKICAgICAgICAgICAgYWxpZ25PZmZzZXQgPSBtYXhMaW5lV2lkdGggLSBsaW5lV2lkdGhzW2ldOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmKHRoaXMuc3R5bGUuYWxpZ24gPT0gImNlbnRlciIpCiAgICAgICAgewogICAgICAgICAgICBhbGlnbk9mZnNldCA9IChtYXhMaW5lV2lkdGggLSBsaW5lV2lkdGhzW2ldKSAvIDI7CiAgICAgICAgfQogICAgICAgIGxpbmVBbGlnbk9mZnNldHMucHVzaChhbGlnbk9mZnNldCk7CiAgICB9CgogICAgZm9yKGkgPSAwOyBpIDwgY2hhcnMubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgICAgdmFyIGMgPSBuZXcgUElYSS5TcHJpdGUoY2hhcnNbaV0udGV4dHVyZSkvL1BJWEkuU3ByaXRlLmZyb21GcmFtZShjaGFyc1tpXS5jaGFyQ29kZSk7CiAgICAgICAgYy5wb3NpdGlvbi54ID0gKGNoYXJzW2ldLnBvc2l0aW9uLnggKyBsaW5lQWxpZ25PZmZzZXRzW2NoYXJzW2ldLmxpbmVdKSAqIHNjYWxlOwogICAgICAgIGMucG9zaXRpb24ueSA9IGNoYXJzW2ldLnBvc2l0aW9uLnkgKiBzY2FsZTsKICAgICAgICBjLnNjYWxlLnggPSBjLnNjYWxlLnkgPSBzY2FsZTsKICAgICAgICB0aGlzLmFkZENoaWxkKGMpOwogICAgfQoKICAgIHRoaXMud2lkdGggPSBwb3MueCAqIHNjYWxlOwogICAgdGhpcy5oZWlnaHQgPSAocG9zLnkgKyBkYXRhLmxpbmVIZWlnaHQpICogc2NhbGU7Cn07CgovKioKICogVXBkYXRlcyB0aGUgdHJhbnNmb3Igb2YgdGhpcyBvYmplY3QKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CglpZih0aGlzLmRpcnR5KQoJewogICAgICAgIHdoaWxlKHRoaXMuY2hpbGRyZW4ubGVuZ3RoID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVtb3ZlQ2hpbGQodGhpcy5nZXRDaGlsZEF0KDApKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51cGRhdGVUZXh0KCk7CgogICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKCX0KCglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKHRoaXMpOwp9OwoKUElYSS5CaXRtYXBUZXh0LmZvbnRzID0ge307CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgVGV4dCBPYmplY3Qgd2lsbCBjcmVhdGUgYSBsaW5lKHMpIG9mIHRleHQgdG8gc3BsaXQgYSBsaW5lIHlvdSBjYW4gdXNlICJcbiIKICoKICogQGNsYXNzIFRleHQKICogQGV4dGVuZHMgU3ByaXRlCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfSBUaGUgY29weSB0aGF0IHlvdSB3b3VsZCBsaWtlIHRoZSB0ZXh0IHRvIGRpc3BsYXkKICogQHBhcmFtIFtzdHlsZV0ge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIFtzdHlsZS5mb250XSB7U3RyaW5nfSBkZWZhdWx0ICJib2xkIDIwcHQgQXJpYWwiIFRoZSBzdHlsZSBhbmQgc2l6ZSBvZiB0aGUgZm9udAogKiBAcGFyYW0gW3N0eWxlLmZpbGw9ImJsYWNrIl0ge09iamVjdH0gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IGVnICJyZWQiLCAiIzAwRkYwMCIKICogQHBhcmFtIFtzdHlsZS5hbGlnbj0ibGVmdCJdIHtTdHJpbmd9IEFuIGFsaWdubWVudCBvZiB0aGUgbXVsdGlsaW5lIHRleHQgKCJsZWZ0IiwgImNlbnRlciIgb3IgInJpZ2h0IikKICogQHBhcmFtIFtzdHlsZS5zdHJva2VdIHtTdHJpbmd9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBzdHJva2UgZWcgImJsdWUiLCAiI0ZDRkYwMCIKICogQHBhcmFtIFtzdHlsZS5zdHJva2VUaGlja25lc3M9MF0ge051bWJlcn0gQSBudW1iZXIgdGhhdCByZXByZXNlbnRzIHRoZSB0aGlja25lc3Mgb2YgdGhlIHN0cm9rZS4gRGVmYXVsdCBpcyAwIChubyBzdHJva2UpCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXA9ZmFsc2VdIHtCb29sZWFufSBJbmRpY2F0ZXMgaWYgd29yZCB3cmFwIHNob3VsZCBiZSB1c2VkCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXBXaWR0aD0xMDBdIHtOdW1iZXJ9IFRoZSB3aWR0aCBhdCB3aGljaCB0ZXh0IHdpbGwgd3JhcAogKi8KUElYSS5UZXh0ID0gZnVuY3Rpb24odGV4dCwgc3R5bGUpCnsKICAgIHRoaXMuY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiY2FudmFzIik7CiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCIyZCIpOwogICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBQSVhJLlRleHR1cmUuZnJvbUNhbnZhcyh0aGlzLmNhbnZhcykpOwoKICAgIHRoaXMuc2V0VGV4dCh0ZXh0KTsKICAgIHRoaXMuc2V0U3R5bGUoc3R5bGUpOwoKICAgIHRoaXMudXBkYXRlVGV4dCgpOwogICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwp9OwoKLy8gY29uc3RydWN0b3IKUElYSS5UZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUElYSS5UZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVGV4dDsKCi8qKgogKiBTZXQgdGhlIHN0eWxlIG9mIHRoZSB0ZXh0CiAqCiAqIEBtZXRob2Qgc2V0U3R5bGUKICogQHBhcmFtIFtzdHlsZV0ge09iamVjdH0gVGhlIHN0eWxlIHBhcmFtZXRlcnMKICogQHBhcmFtIFtzdHlsZS5mb250PSJib2xkIDIwcHQgQXJpYWwiXSB7U3RyaW5nfSBUaGUgc3R5bGUgYW5kIHNpemUgb2YgdGhlIGZvbnQKICogQHBhcmFtIFtzdHlsZS5maWxsPSJibGFjayJdIHtPYmplY3R9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBlZyAicmVkIiwgIiMwMEZGMDAiCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249ImxlZnQiXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgibGVmdCIsICJjZW50ZXIiIG9yICJyaWdodCIpCiAqIEBwYXJhbSBbc3R5bGUuc3Ryb2tlPSJibGFjayJdIHtTdHJpbmd9IEEgY2FudmFzIGZpbGxzdHlsZSB0aGF0IHdpbGwgYmUgdXNlZCBvbiB0aGUgdGV4dCBzdHJva2UgZWcgImJsdWUiLCAiI0ZDRkYwMCIKICogQHBhcmFtIFtzdHlsZS5zdHJva2VUaGlja25lc3M9MF0ge051bWJlcn0gQSBudW1iZXIgdGhhdCByZXByZXNlbnRzIHRoZSB0aGlja25lc3Mgb2YgdGhlIHN0cm9rZS4gRGVmYXVsdCBpcyAwIChubyBzdHJva2UpCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXA9ZmFsc2VdIHtCb29sZWFufSBJbmRpY2F0ZXMgaWYgd29yZCB3cmFwIHNob3VsZCBiZSB1c2VkCiAqIEBwYXJhbSBbc3R5bGUud29yZFdyYXBXaWR0aD0xMDBdIHtOdW1iZXJ9IFRoZSB3aWR0aCBhdCB3aGljaCB0ZXh0IHdpbGwgd3JhcAogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5zZXRTdHlsZSA9IGZ1bmN0aW9uKHN0eWxlKQp7CiAgICBzdHlsZSA9IHN0eWxlIHx8IHt9OwogICAgc3R5bGUuZm9udCA9IHN0eWxlLmZvbnQgfHwgImJvbGQgMjBwdCBBcmlhbCI7CiAgICBzdHlsZS5maWxsID0gc3R5bGUuZmlsbCB8fCAiYmxhY2siOwogICAgc3R5bGUuYWxpZ24gPSBzdHlsZS5hbGlnbiB8fCAibGVmdCI7CiAgICBzdHlsZS5zdHJva2UgPSBzdHlsZS5zdHJva2UgfHwgImJsYWNrIjsgLy9wcm92aWRlIGEgZGVmYXVsdCwgc2VlOiBodHRwczovL2dpdGh1Yi5jb20vR29vZEJveURpZ2l0YWwvcGl4aS5qcy9pc3N1ZXMvMTM2CiAgICBzdHlsZS5zdHJva2VUaGlja25lc3MgPSBzdHlsZS5zdHJva2VUaGlja25lc3MgfHwgMDsKICAgIHN0eWxlLndvcmRXcmFwID0gc3R5bGUud29yZFdyYXAgfHwgZmFsc2U7CiAgICBzdHlsZS53b3JkV3JhcFdpZHRoID0gc3R5bGUud29yZFdyYXBXaWR0aCB8fCAxMDA7CiAgICB0aGlzLnN0eWxlID0gc3R5bGU7CiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKfTsKCi8qKgogKiBTZXQgdGhlIGNvcHkgZm9yIHRoZSB0ZXh0IG9iamVjdC4gVG8gc3BsaXQgYSBsaW5lIHlvdSBjYW4gdXNlICJcbiIKICoKICogQG1ldGhvcyBzZXRUZXh0CiAqIEBwYXJhbSB7U3RyaW5nfSB0ZXh0IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5zZXRUZXh0ID0gZnVuY3Rpb24odGV4dCkKewogICAgdGhpcy50ZXh0ID0gdGV4dC50b1N0cmluZygpIHx8ICIgIjsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFJlbmRlcnMgdGV4dAogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHQKICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUudXBkYXRlVGV4dCA9IGZ1bmN0aW9uKCkKewoJdGhpcy5jb250ZXh0LmZvbnQgPSB0aGlzLnN0eWxlLmZvbnQ7CgoJdmFyIG91dHB1dFRleHQgPSB0aGlzLnRleHQ7CgoJLy8gd29yZCB3cmFwCgkvLyBwcmVzZXJ2ZSBvcmlnaW5hbCB0ZXh0CglpZih0aGlzLnN0eWxlLndvcmRXcmFwKW91dHB1dFRleHQgPSB0aGlzLndvcmRXcmFwKHRoaXMudGV4dCk7CgoJLy9zcGxpdCB0ZXh0IGludG8gbGluZXMKCXZhciBsaW5lcyA9IG91dHB1dFRleHQuc3BsaXQoLyg/OlxyXG58XHJ8XG4pLyk7CgoJLy9jYWxjdWxhdGUgdGV4dCB3aWR0aAoJdmFyIGxpbmVXaWR0aHMgPSBbXTsKCXZhciBtYXhMaW5lV2lkdGggPSAwOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKCXsKCQl2YXIgbGluZVdpZHRoID0gdGhpcy5jb250ZXh0Lm1lYXN1cmVUZXh0KGxpbmVzW2ldKS53aWR0aDsKCQlsaW5lV2lkdGhzW2ldID0gbGluZVdpZHRoOwoJCW1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgbGluZVdpZHRoKTsKCX0KCXRoaXMuY2FudmFzLndpZHRoID0gbWF4TGluZVdpZHRoICsgdGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3M7CgoJLy9jYWxjdWxhdGUgdGV4dCBoZWlnaHQKCXZhciBsaW5lSGVpZ2h0ID0gdGhpcy5kZXRlcm1pbmVGb250SGVpZ2h0KCJmb250OiAiICsgdGhpcy5zdHlsZS5mb250ICArICI7IikgKyB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKCXRoaXMuY2FudmFzLmhlaWdodCA9IGxpbmVIZWlnaHQgKiBsaW5lcy5sZW5ndGg7CgoJLy9zZXQgY2FudmFzIHRleHQgc3R5bGVzCgl0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdGhpcy5zdHlsZS5maWxsOwoJdGhpcy5jb250ZXh0LmZvbnQgPSB0aGlzLnN0eWxlLmZvbnQ7CgoJdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gdGhpcy5zdHlsZS5zdHJva2U7Cgl0aGlzLmNvbnRleHQubGluZVdpZHRoID0gdGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3M7CgoJdGhpcy5jb250ZXh0LnRleHRCYXNlbGluZSA9ICJ0b3AiOwoKCS8vZHJhdyBsaW5lcyBsaW5lIGJ5IGxpbmUKCWZvciAoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKCXsKCQl2YXIgbGluZVBvc2l0aW9uID0gbmV3IFBJWEkuUG9pbnQodGhpcy5zdHlsZS5zdHJva2VUaGlja25lc3MgLyAyLCB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzcyAvIDIgKyBpICogbGluZUhlaWdodCk7CgoJCWlmKHRoaXMuc3R5bGUuYWxpZ24gPT0gInJpZ2h0IikKCQl7CgkJCWxpbmVQb3NpdGlvbi54ICs9IG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV07CgkJfQoJCWVsc2UgaWYodGhpcy5zdHlsZS5hbGlnbiA9PSAiY2VudGVyIikKCQl7CgkJCWxpbmVQb3NpdGlvbi54ICs9IChtYXhMaW5lV2lkdGggLSBsaW5lV2lkdGhzW2ldKSAvIDI7CgkJfQoKCQlpZih0aGlzLnN0eWxlLnN0cm9rZSAmJiB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzcykKCQl7CgkJCXRoaXMuY29udGV4dC5zdHJva2VUZXh0KGxpbmVzW2ldLCBsaW5lUG9zaXRpb24ueCwgbGluZVBvc2l0aW9uLnkpOwoJCX0KCgkJaWYodGhpcy5zdHlsZS5maWxsKQoJCXsKCQkJdGhpcy5jb250ZXh0LmZpbGxUZXh0KGxpbmVzW2ldLCBsaW5lUG9zaXRpb24ueCwgbGluZVBvc2l0aW9uLnkpOwoJCX0KCX0KCiAgICB0aGlzLnVwZGF0ZVRleHR1cmUoKTsKfTsKCi8qKgogKiBVcGRhdGVzIHRleHR1cmUgc2l6ZSBiYXNlZCBvbiBjYW52YXMgc2l6ZQogKgogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmUKICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUudXBkYXRlVGV4dHVyZSA9IGZ1bmN0aW9uKCkKewogICAgdGhpcy50ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoID0gdGhpcy5jYW52YXMud2lkdGg7CiAgICB0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUuaGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0OwogICAgdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoID0gdGhpcy5jYW52YXMud2lkdGg7CiAgICB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0OwoKICAJdGhpcy5fd2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMuX2hlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDsKCiAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUpOwp9OwoKLyoqCiAqIFVwZGF0ZXMgdGhlIHRyYW5zZm9yIG9mIHRoaXMgb2JqZWN0CiAqCiAqIEBtZXRob2QgdXBkYXRlVHJhbnNmb3JtCiAqIEBwcml2YXRlCiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybSA9IGZ1bmN0aW9uKCkKewoJaWYodGhpcy5kaXJ0eSkKCXsKCQl0aGlzLnVwZGF0ZVRleHQoKTsKCQl0aGlzLmRpcnR5ID0gZmFsc2U7Cgl9CgoJUElYSS5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKHRoaXMpOwp9OwoKLyoKICogaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3VzZXJzLzM0NDQxL2VsbGlzYmJlbgogKiBncmVhdCBzb2x1dGlvbiB0byB0aGUgcHJvYmxlbSEKICoKICogQG1ldGhvZCBkZXRlcm1pbmVGb250SGVpZ2h0CiAqIEBwYXJhbSBmb250U3R5bGUge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUuZGV0ZXJtaW5lRm9udEhlaWdodCA9IGZ1bmN0aW9uKGZvbnRTdHlsZSkKewoJLy8gYnVpbGQgYSBsaXR0bGUgcmVmZXJlbmNlIGRpY3Rpb25hcnkgc28gaWYgdGhlIGZvbnQgc3R5bGUgaGFzIGJlZW4gdXNlZCByZXR1cm4gYQoJLy8gY2FjaGVkIHZlcnNpb24uLi4KCXZhciByZXN1bHQgPSBQSVhJLlRleHQuaGVpZ2h0Q2FjaGVbZm9udFN0eWxlXTsKCglpZighcmVzdWx0KQoJewoJCXZhciBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXTsKCQl2YXIgZHVtbXkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKCQl2YXIgZHVtbXlUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIk0iKTsKCQlkdW1teS5hcHBlbmRDaGlsZChkdW1teVRleHQpOwoJCWR1bW15LnNldEF0dHJpYnV0ZSgic3R5bGUiLCBmb250U3R5bGUgKyAnO3Bvc2l0aW9uOmFic29sdXRlO3RvcDowO2xlZnQ6MCcpOwoJCWJvZHkuYXBwZW5kQ2hpbGQoZHVtbXkpOwoKCQlyZXN1bHQgPSBkdW1teS5vZmZzZXRIZWlnaHQ7CgkJUElYSS5UZXh0LmhlaWdodENhY2hlW2ZvbnRTdHlsZV0gPSByZXN1bHQ7CgoJCWJvZHkucmVtb3ZlQ2hpbGQoZHVtbXkpOwoJfQoKCXJldHVybiByZXN1bHQ7Cn07CgovKioKICogQXBwbGllcyBuZXdsaW5lcyB0byBhIHN0cmluZyB0byBoYXZlIGl0IG9wdGltYWxseSBmaXQgaW50byB0aGUgaG9yaXpvbnRhbAogKiBib3VuZHMgc2V0IGJ5IHRoZSBUZXh0IG9iamVjdCdzIHdvcmRXcmFwV2lkdGggcHJvcGVydHkuCiAqCiAqIEBtZXRob2Qgd29yZFdyYXAKICogQHBhcmFtIHRleHQge1N0cmluZ30KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUud29yZFdyYXAgPSBmdW5jdGlvbih0ZXh0KQp7CgkvLyBHcmVlZHkgd3JhcHBpbmcgYWxnb3JpdGhtIHRoYXQgd2lsbCB3cmFwIHdvcmRzIGFzIHRoZSBsaW5lIGdyb3dzIGxvbmdlcgoJLy8gdGhhbiBpdHMgaG9yaXpvbnRhbCBib3VuZHMuCgl2YXIgcmVzdWx0ID0gIiI7Cgl2YXIgbGluZXMgPSB0ZXh0LnNwbGl0KCJcbiIpOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKCXsKCQl2YXIgc3BhY2VMZWZ0ID0gdGhpcy5zdHlsZS53b3JkV3JhcFdpZHRoOwoJCXZhciB3b3JkcyA9IGxpbmVzW2ldLnNwbGl0KCIgIik7CgkJZm9yICh2YXIgaiA9IDA7IGogPCB3b3Jkcy5sZW5ndGg7IGorKykKCQl7CgkJCXZhciB3b3JkV2lkdGggPSB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQod29yZHNbal0pLndpZHRoOwoJCQl2YXIgd29yZFdpZHRoV2l0aFNwYWNlID0gd29yZFdpZHRoICsgdGhpcy5jb250ZXh0Lm1lYXN1cmVUZXh0KCIgIikud2lkdGg7CgkJCWlmKHdvcmRXaWR0aFdpdGhTcGFjZSA+IHNwYWNlTGVmdCkKCQkJewoJCQkJLy8gU2tpcCBwcmludGluZyB0aGUgbmV3bGluZSBpZiBpdCdzIHRoZSBmaXJzdCB3b3JkIG9mIHRoZSBsaW5lIHRoYXQgaXMKCQkJCS8vIGdyZWF0ZXIgdGhhbiB0aGUgd29yZCB3cmFwIHdpZHRoLgoJCQkJaWYoaiA+IDApCgkJCQl7CgkJCQkJcmVzdWx0ICs9ICJcbiI7CgkJCQl9CgkJCQlyZXN1bHQgKz0gd29yZHNbal0gKyAiICI7CgkJCQlzcGFjZUxlZnQgPSB0aGlzLnN0eWxlLndvcmRXcmFwV2lkdGggLSB3b3JkV2lkdGg7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlzcGFjZUxlZnQgLT0gd29yZFdpZHRoV2l0aFNwYWNlOwoJCQkJcmVzdWx0ICs9IHdvcmRzW2pdICsgIiAiOwoJCQl9CgkJfQoJCXJlc3VsdCArPSAiXG4iOwoJfQoJcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBEZXN0cm95cyB0aGlzIHRleHQgb2JqZWN0CiAqCiAqIEBtZXRob2QgZGVzdHJveQogKiBAcGFyYW0gZGVzdHJveVRleHR1cmUge0Jvb2xlYW59CiAqLwpQSVhJLlRleHQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihkZXN0cm95VGV4dHVyZSkKewoJaWYoZGVzdHJveVRleHR1cmUpCgl7CgkJdGhpcy50ZXh0dXJlLmRlc3Ryb3koKTsKCX0KCn07CgpQSVhJLlRleHQuaGVpZ2h0Q2FjaGUgPSB7fTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLkJhc2VUZXh0dXJlQ2FjaGUgPSB7fTsKUElYSS50ZXh0dXJlc1RvVXBkYXRlID0gW107ClBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kgPSBbXTsKCi8qKgogKiBBIHRleHR1cmUgc3RvcmVzIHRoZSBpbmZvcm1hdGlvbiB0aGF0IHJlcHJlc2VudHMgYW4gaW1hZ2UuIEFsbCB0ZXh0dXJlcyBoYXZlIGEgYmFzZSB0ZXh0dXJlCiAqCiAqIEBjbGFzcyBCYXNlVGV4dHVyZQogKiBAdXNlcyBFdmVudFRhcmdldAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHNvdXJjZSB7U3RyaW5nfSB0aGUgc291cmNlIG9iamVjdCAoaW1hZ2Ugb3IgY2FudmFzKQogKi8KUElYSS5CYXNlVGV4dHVyZSA9IGZ1bmN0aW9uKHNvdXJjZSkKewoJUElYSS5FdmVudFRhcmdldC5jYWxsKCB0aGlzICk7CgoJLyoqCgkgKiBbcmVhZC1vbmx5XSBUaGUgd2lkdGggb2YgdGhlIGJhc2UgdGV4dHVyZSBzZXQgd2hlbiB0aGUgaW1hZ2UgaGFzIGxvYWRlZAoJICoKCSAqIEBwcm9wZXJ0eSB3aWR0aAoJICogQHR5cGUgTnVtYmVyCgkgKiBAcmVhZE9ubHkKCSAqLwoJdGhpcy53aWR0aCA9IDEwMDsKCgkvKioKCSAqIFtyZWFkLW9ubHldIFRoZSBoZWlnaHQgb2YgdGhlIGJhc2UgdGV4dHVyZSBzZXQgd2hlbiB0aGUgaW1hZ2UgaGFzIGxvYWRlZAoJICoKCSAqIEBwcm9wZXJ0eSBoZWlnaHQKCSAqIEB0eXBlIE51bWJlcgoJICogQHJlYWRPbmx5CgkgKi8KCXRoaXMuaGVpZ2h0ID0gMTAwOwoKCS8qKgoJICogW3JlYWQtb25seV0gRGVzY3JpYmVzIGlmIHRoZSBiYXNlIHRleHR1cmUgaGFzIGxvYWRlZCBvciBub3QKCSAqCgkgKiBAcHJvcGVydHkgaGFzTG9hZGVkCgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAcmVhZE9ubHkKCSAqLwoJdGhpcy5oYXNMb2FkZWQgPSBmYWxzZTsKCgkvKioKCSAqIFRoZSBzb3VyY2UgdGhhdCBpcyBsb2FkZWQgdG8gY3JlYXRlIHRoZSB0ZXh0dXJlCgkgKgoJICogQHByb3BlcnR5IHNvdXJjZQoJICogQHR5cGUgSW1hZ2UKCSAqLwoJdGhpcy5zb3VyY2UgPSBzb3VyY2U7CgoJaWYoIXNvdXJjZSlyZXR1cm47CgoJaWYodGhpcy5zb3VyY2UgaW5zdGFuY2VvZiBJbWFnZSB8fCB0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpCgl7CgkJaWYodGhpcy5zb3VyY2UuY29tcGxldGUpCgkJewoJCQl0aGlzLmhhc0xvYWRlZCA9IHRydWU7CgkJCXRoaXMud2lkdGggPSB0aGlzLnNvdXJjZS53aWR0aDsKCQkJdGhpcy5oZWlnaHQgPSB0aGlzLnNvdXJjZS5oZWlnaHQ7CgoJCQlQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzKTsKCQl9CgkJZWxzZQoJCXsKCgkJCXZhciBzY29wZSA9IHRoaXM7CgkJCXRoaXMuc291cmNlLm9ubG9hZCA9IGZ1bmN0aW9uKCl7CgoJCQkJc2NvcGUuaGFzTG9hZGVkID0gdHJ1ZTsKCQkJCXNjb3BlLndpZHRoID0gc2NvcGUuc291cmNlLndpZHRoOwoJCQkJc2NvcGUuaGVpZ2h0ID0gc2NvcGUuc291cmNlLmhlaWdodDsKCgkJCQkvLyBhZGQgaXQgdG8gc29tZXdoZXJlLi4uCgkJCQlQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaChzY29wZSk7CgkJCQlzY29wZS5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICdsb2FkZWQnLCBjb250ZW50OiBzY29wZSB9ICk7CgkJCX0KCQkJLy8JdGhpcy5pbWFnZS5zcmMgPSBpbWFnZVVybDsKCQl9Cgl9CgllbHNlCgl7CgkJdGhpcy5oYXNMb2FkZWQgPSB0cnVlOwoJCXRoaXMud2lkdGggPSB0aGlzLnNvdXJjZS53aWR0aDsKCQl0aGlzLmhlaWdodCA9IHRoaXMuc291cmNlLmhlaWdodDsKCgkJUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcyk7Cgl9CgoJdGhpcy5fcG93ZXJPZjIgPSBmYWxzZTsKfQoKUElYSS5CYXNlVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkJhc2VUZXh0dXJlOwoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgYmFzZSB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgZGVzdHJveQogKi8KUElYSS5CYXNlVGV4dHVyZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkKewoJaWYodGhpcy5zb3VyY2UgaW5zdGFuY2VvZiBJbWFnZSkKCXsKCQl0aGlzLnNvdXJjZS5zcmMgPSBudWxsOwoJfQoJdGhpcy5zb3VyY2UgPSBudWxsOwoJUElYSS50ZXh0dXJlc1RvRGVzdHJveS5wdXNoKHRoaXMpOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIGJhc2UgdGV4dHVyZSBiYXNlZCBvbiBhbiBpbWFnZSB1cmwKICogSWYgdGhlIGltYWdlIGlzIG5vdCBpbiB0aGUgYmFzZSB0ZXh0dXJlIGNhY2hlIGl0IHdpbGwgYmUgIGNyZWF0ZWQgYW5kIGxvYWRlZAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZnJvbUltYWdlCiAqIEBwYXJhbSBpbWFnZVVybCB7U3RyaW5nfSBUaGUgaW1hZ2UgdXJsIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4gQmFzZVRleHR1cmUKICovClBJWEkuQmFzZVRleHR1cmUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VVcmwsIGNyb3Nzb3JpZ2luKQp7Cgl2YXIgYmFzZVRleHR1cmUgPSBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdOwoJaWYoIWJhc2VUZXh0dXJlKQoJewoJCS8vIG5ldyBJbWFnZSgpIGJyZWFrcyB0ZXggbG9hZGluZyBpbiBzb21lIHZlcnNpb25zIG9mIENocm9tZS4KCQkvLyBTZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTIzODA3MQoJCXZhciBpbWFnZSA9IG5ldyBJbWFnZSgpOy8vZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CgkJaWYgKGNyb3Nzb3JpZ2luKQoJCXsKCQkJaW1hZ2UuY3Jvc3NPcmlnaW4gPSAnJzsKCQl9CgkJaW1hZ2Uuc3JjID0gaW1hZ2VVcmw7CgkJYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZShpbWFnZSk7CgkJUElYSS5CYXNlVGV4dHVyZUNhY2hlW2ltYWdlVXJsXSA9IGJhc2VUZXh0dXJlOwoJfQoKCXJldHVybiBiYXNlVGV4dHVyZTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuVGV4dHVyZUNhY2hlID0ge307ClBJWEkuRnJhbWVDYWNoZSA9IHt9OwoKLyoqCiAqIEEgdGV4dHVyZSBzdG9yZXMgdGhlIGluZm9ybWF0aW9uIHRoYXQgcmVwcmVzZW50cyBhbiBpbWFnZSBvciBwYXJ0IG9mIGFuIGltYWdlLiBJdCBjYW5ub3QgYmUgYWRkZWQKICogdG8gdGhlIGRpc3BsYXkgbGlzdCBkaXJlY3RseS4gVG8gZG8gdGhpcyB1c2UgUElYSS5TcHJpdGUuIElmIG5vIGZyYW1lIGlzIHByb3ZpZGVkIHRoZW4gdGhlIHdob2xlIGltYWdlIGlzIHVzZWQKICoKICogQGNsYXNzIFRleHR1cmUKICogQHVzZXMgRXZlbnRUYXJnZXQKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBiYXNlVGV4dHVyZSB7QmFzZVRleHR1cmV9IFRoZSBiYXNlIHRleHR1cmUgc291cmNlIHRvIGNyZWF0ZSB0aGUgdGV4dHVyZSBmcm9tCiAqIEBwYXJhbSBmcmFtZSB7UmVjdGFuZ2xlfSBUaGUgcmVjdGFuZ2xlIGZyYW1lIG9mIHRoZSB0ZXh0dXJlIHRvIHNob3cKICovClBJWEkuVGV4dHVyZSA9IGZ1bmN0aW9uKGJhc2VUZXh0dXJlLCBmcmFtZSkKewoJUElYSS5FdmVudFRhcmdldC5jYWxsKCB0aGlzICk7CgoJaWYoIWZyYW1lKQoJewoJCXRoaXMubm9GcmFtZSA9IHRydWU7CgkJZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLDEsMSk7Cgl9CgoJaWYoYmFzZVRleHR1cmUgaW5zdGFuY2VvZiBQSVhJLlRleHR1cmUpCgkJYmFzZVRleHR1cmUgPSBiYXNlVGV4dHVyZS5iYXNlVGV4dHVyZTsKCgkvKioKCSAqIFRoZSBiYXNlIHRleHR1cmUgb2YgdGhpcyB0ZXh0dXJlCgkgKgoJICogQHByb3BlcnR5IGJhc2VUZXh0dXJlCgkgKiBAdHlwZSBCYXNlVGV4dHVyZQoJICovCgl0aGlzLmJhc2VUZXh0dXJlID0gYmFzZVRleHR1cmU7CgoJLyoqCgkgKiBUaGUgZnJhbWUgc3BlY2lmaWVzIHRoZSByZWdpb24gb2YgdGhlIGJhc2UgdGV4dHVyZSB0aGF0IHRoaXMgdGV4dHVyZSB1c2VzCgkgKgoJICogQHByb3BlcnR5IGZyYW1lCgkgKiBAdHlwZSBSZWN0YW5nbGUKCSAqLwoJdGhpcy5mcmFtZSA9IGZyYW1lOwoKCS8qKgoJICogVGhlIHRyaW0gcG9pbnQKCSAqCgkgKiBAcHJvcGVydHkgdHJpbQoJICogQHR5cGUgUG9pbnQKCSAqLwoJdGhpcy50cmltID0gbmV3IFBJWEkuUG9pbnQoKTsKCgl0aGlzLnNjb3BlID0gdGhpczsKCglpZihiYXNlVGV4dHVyZS5oYXNMb2FkZWQpCgl7CgkJaWYodGhpcy5ub0ZyYW1lKWZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwgYmFzZVRleHR1cmUud2lkdGgsIGJhc2VUZXh0dXJlLmhlaWdodCk7CgkJLy9jb25zb2xlLmxvZyhmcmFtZSkKCgkJdGhpcy5zZXRGcmFtZShmcmFtZSk7Cgl9CgllbHNlCgl7CgkJdmFyIHNjb3BlID0gdGhpczsKCQliYXNlVGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCAnbG9hZGVkJywgZnVuY3Rpb24oKXsgc2NvcGUub25CYXNlVGV4dHVyZUxvYWRlZCgpfSApOwoJfQp9CgpQSVhJLlRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5UZXh0dXJlOwoKLyoqCiAqIENhbGxlZCB3aGVuIHRoZSBiYXNlIHRleHR1cmUgaXMgbG9hZGVkCiAqCiAqIEBtZXRob2Qgb25CYXNlVGV4dHVyZUxvYWRlZAogKiBAcGFyYW0gZXZlbnQKICogQHByaXZhdGUKICovClBJWEkuVGV4dHVyZS5wcm90b3R5cGUub25CYXNlVGV4dHVyZUxvYWRlZCA9IGZ1bmN0aW9uKGV2ZW50KQp7Cgl2YXIgYmFzZVRleHR1cmUgPSB0aGlzLmJhc2VUZXh0dXJlOwoJYmFzZVRleHR1cmUucmVtb3ZlRXZlbnRMaXN0ZW5lciggJ2xvYWRlZCcsIHRoaXMub25Mb2FkZWQgKTsKCglpZih0aGlzLm5vRnJhbWUpdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsIGJhc2VUZXh0dXJlLndpZHRoLCBiYXNlVGV4dHVyZS5oZWlnaHQpOwoJdGhpcy5ub0ZyYW1lID0gZmFsc2U7Cgl0aGlzLndpZHRoID0gdGhpcy5mcmFtZS53aWR0aDsKCXRoaXMuaGVpZ2h0ID0gdGhpcy5mcmFtZS5oZWlnaHQ7CgoJdGhpcy5zY29wZS5kaXNwYXRjaEV2ZW50KCB7IHR5cGU6ICd1cGRhdGUnLCBjb250ZW50OiB0aGlzIH0gKTsKfQoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgdGV4dHVyZQogKgogKiBAbWV0aG9kIGRlc3Ryb3kKICogQHBhcmFtIGRlc3Ryb3lCYXNlIHtCb29sZWFufSBXaGV0aGVyIHRvIGRlc3Ryb3kgdGhlIGJhc2UgdGV4dHVyZSBhcyB3ZWxsCiAqLwpQSVhJLlRleHR1cmUucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbihkZXN0cm95QmFzZSkKewoJaWYoZGVzdHJveUJhc2UpdGhpcy5iYXNlVGV4dHVyZS5kZXN0cm95KCk7Cn0KCi8qKgogKiBTcGVjaWZpZXMgdGhlIHJlY3RhbmdsZSByZWdpb24gb2YgdGhlIGJhc2VUZXh0dXJlCiAqCiAqIEBtZXRob2Qgc2V0RnJhbWUKICogQHBhcmFtIGZyYW1lIHtSZWN0YW5nbGV9IFRoZSBmcmFtZSBvZiB0aGUgdGV4dHVyZSB0byBzZXQgaXQgdG8KICovClBJWEkuVGV4dHVyZS5wcm90b3R5cGUuc2V0RnJhbWUgPSBmdW5jdGlvbihmcmFtZSkKewoJdGhpcy5mcmFtZSA9IGZyYW1lOwoJdGhpcy53aWR0aCA9IGZyYW1lLndpZHRoOwoJdGhpcy5oZWlnaHQgPSBmcmFtZS5oZWlnaHQ7CgoJaWYoZnJhbWUueCArIGZyYW1lLndpZHRoID4gdGhpcy5iYXNlVGV4dHVyZS53aWR0aCB8fCBmcmFtZS55ICsgZnJhbWUuaGVpZ2h0ID4gdGhpcy5iYXNlVGV4dHVyZS5oZWlnaHQpCgl7CgkJdGhyb3cgbmV3IEVycm9yKCJUZXh0dXJlIEVycm9yOiBmcmFtZSBkb2VzIG5vdCBmaXQgaW5zaWRlIHRoZSBiYXNlIFRleHR1cmUgZGltZW5zaW9ucyAiICsgdGhpcyk7Cgl9CgoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7CgoJUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5wdXNoKHRoaXMpOwoJLy90aGlzLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ3VwZGF0ZScsIGNvbnRlbnQ6IHRoaXMgfSApOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHRleHR1cmUgYmFzZWQgb24gYW4gaW1hZ2UgdXJsCiAqIElmIHRoZSBpbWFnZSBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHBhcmFtIGltYWdlVXJsIHtTdHJpbmd9IFRoZSBpbWFnZSB1cmwgb2YgdGhlIHRleHR1cmUKICogQHBhcmFtIGNyb3Nzb3JpZ2luIHtCb29sZWFufSBXaGV0aGVyIHJlcXVlc3RzIHNob3VsZCBiZSB0cmVhdGVkIGFzIGNyb3Nzb3JpZ2luCiAqIEByZXR1cm4gVGV4dHVyZQogKi8KUElYSS5UZXh0dXJlLmZyb21JbWFnZSA9IGZ1bmN0aW9uKGltYWdlVXJsLCBjcm9zc29yaWdpbikKewoJdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtpbWFnZVVybF07CgoJaWYoIXRleHR1cmUpCgl7CgkJdGV4dHVyZSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZS5mcm9tSW1hZ2UoaW1hZ2VVcmwsIGNyb3Nzb3JpZ2luKSk7CgkJUElYSS5UZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdID0gdGV4dHVyZTsKCX0KCglyZXR1cm4gdGV4dHVyZTsKfQoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSB0ZXh0dXJlIGJhc2VkIG9uIGEgZnJhbWUgaWQKICogSWYgdGhlIGZyYW1lIGlkIGlzIG5vdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSBhbiBlcnJvciB3aWxsIGJlIHRocm93bgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZnJvbUZyYW1lCiAqIEBwYXJhbSBmcmFtZUlkIHtTdHJpbmd9IFRoZSBmcmFtZSBpZCBvZiB0aGUgdGV4dHVyZQogKiBAcmV0dXJuIFRleHR1cmUKICovClBJWEkuVGV4dHVyZS5mcm9tRnJhbWUgPSBmdW5jdGlvbihmcmFtZUlkKQp7Cgl2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2ZyYW1lSWRdOwoJaWYoIXRleHR1cmUpdGhyb3cgbmV3IEVycm9yKCJUaGUgZnJhbWVJZCAnIisgZnJhbWVJZCArIicgZG9lcyBub3QgZXhpc3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgIiArIHRoaXMpOwoJcmV0dXJuIHRleHR1cmU7Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgdGV4dHVyZSBiYXNlZCBvbiBhIGNhbnZhcyBlbGVtZW50CiAqIElmIHRoZSBjYW52YXMgaXMgbm90IGluIHRoZSB0ZXh0dXJlIGNhY2hlIGl0IHdpbGwgYmUgIGNyZWF0ZWQgYW5kIGxvYWRlZAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZnJvbUNhbnZhcwogKiBAcGFyYW0gY2FudmFzIHtDYW52YXN9IFRoZSBjYW52YXMgZWxlbWVudCBzb3VyY2Ugb2YgdGhlIHRleHR1cmUKICogQHJldHVybiBUZXh0dXJlCiAqLwpQSVhJLlRleHR1cmUuZnJvbUNhbnZhcyA9IGZ1bmN0aW9uKGNhbnZhcykKewoJdmFyCWJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoY2FudmFzKTsKCXJldHVybiBuZXcgUElYSS5UZXh0dXJlKGJhc2VUZXh0dXJlKTsKfQoKCi8qKgogKiBBZGRzIGEgdGV4dHVyZSB0byB0aGUgdGV4dHVyZUNhY2hlLgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgYWRkVGV4dHVyZVRvQ2FjaGUKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9CiAqIEBwYXJhbSBpZCB7U3RyaW5nfSB0aGUgaWQgdGhhdCB0aGUgdGV4dHVyZSB3aWxsIGJlIHN0b3JlZCBhZ2FpbnN0LgogKi8KUElYSS5UZXh0dXJlLmFkZFRleHR1cmVUb0NhY2hlID0gZnVuY3Rpb24odGV4dHVyZSwgaWQpCnsKCVBJWEkuVGV4dHVyZUNhY2hlW2lkXSA9IHRleHR1cmU7Cn0KCi8qKgogKiBSZW1vdmUgYSB0ZXh0dXJlIGZyb20gdGhlIHRleHR1cmVDYWNoZS4KICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHJlbW92ZVRleHR1cmVGcm9tQ2FjaGUKICogQHBhcmFtIGlkIHtTdHJpbmd9IHRoZSBpZCBvZiB0aGUgdGV4dHVyZSB0byBiZSByZW1vdmVkCiAqIEByZXR1cm4ge1RleHR1cmV9IHRoZSB0ZXh0dXJlIHRoYXQgd2FzIHJlbW92ZWQKICovClBJWEkuVGV4dHVyZS5yZW1vdmVUZXh0dXJlRnJvbUNhY2hlID0gZnVuY3Rpb24oaWQpCnsKCXZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbaWRdCglQSVhJLlRleHR1cmVDYWNoZVtpZF0gPSBudWxsOwoJcmV0dXJuIHRleHR1cmU7Cn0KCi8vIHRoaXMgaXMgbW9yZSBmb3Igd2ViR0wuLiBpdCBjb250YWlucyB1cGRhdGVkIGZyYW1lcy4uClBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMgPSBbXTsKCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiBBIFJlbmRlclRleHR1cmUgaXMgYSBzcGVjaWFsIHRleHR1cmUgdGhhdCBhbGxvd3MgYW55IHBpeGkgZGlzcGxheU9iamVjdCB0byBiZSByZW5kZXJlZCB0byBpdC4KCiBfX0hpbnRfXzogQWxsIERpc3BsYXlPYmplY3RzIChleG1wbC4gU3ByaXRlcykgdGhhdCByZW5kZXJzIG9uIFJlbmRlclRleHR1cmUgc2hvdWxkIGJlIHByZWxvYWRlZC4gCiBPdGhlcndpc2UgYmxhY2sgcmVjdGFuZ2xlcyB3aWxsIGJlIGRyYXduIGluc3RlYWQuICAKIAogUmVuZGVyVGV4dHVyZSB0YWtlcyBzbmFwc2hvdCBvZiBEaXNwbGF5T2JqZWN0IHBhc3NlZCB0byByZW5kZXIgbWV0aG9kLiBJZiBEaXNwbGF5T2JqZWN0IGlzIHBhc3NlZCB0byByZW5kZXIgbWV0aG9kLCBwb3NpdGlvbiBhbmQgcm90YXRpb24gb2YgaXQgd2lsbCBiZSBpZ25vcmVkLiBGb3IgZXhhbXBsZToKIAoJdmFyIHJlbmRlclRleHR1cmUgPSBuZXcgUElYSS5SZW5kZXJUZXh0dXJlKDgwMCwgNjAwKTsKCXZhciBzcHJpdGUgPSBQSVhJLlNwcml0ZS5mcm9tSW1hZ2UoInNwaW5PYmpfMDEucG5nIik7CglzcHJpdGUucG9zaXRpb24ueCA9IDgwMC8yOwoJc3ByaXRlLnBvc2l0aW9uLnkgPSA2MDAvMjsKCXNwcml0ZS5hbmNob3IueCA9IDAuNTsKCXNwcml0ZS5hbmNob3IueSA9IDAuNTsKCXJlbmRlclRleHR1cmUucmVuZGVyKHNwcml0ZSk7CgogU3ByaXRlIGluIHRoaXMgY2FzZSB3aWxsIGJlIHJlbmRlcmVkIHRvIDAsMCBwb3NpdGlvbi4gVG8gcmVuZGVyIHRoaXMgc3ByaXRlIGF0IGNlbnRlciBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHNob3VsZCBiZSB1c2VkOgoKCXZhciBkb2MgPSBuZXcgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyKCk7Cglkb2MuYWRkQ2hpbGQoc3ByaXRlKTsKCXJlbmRlclRleHR1cmUucmVuZGVyKGRvYyk7ICAvLyBSZW5kZXJzIHRvIGNlbnRlciBvZiByZW5kZXJUZXh0dXJlCgogQGNsYXNzIFJlbmRlclRleHR1cmUKIEBleHRlbmRzIFRleHR1cmUKIEBjb25zdHJ1Y3RvcgogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IFRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRleHR1cmUKIEBwYXJhbSBoZWlnaHQge051bWJlcn0gVGhlIGhlaWdodCBvZiB0aGUgcmVuZGVyIHRleHR1cmUKICovClBJWEkuUmVuZGVyVGV4dHVyZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCVBJWEkuRXZlbnRUYXJnZXQuY2FsbCggdGhpcyApOwoKCXRoaXMud2lkdGggPSB3aWR0aCB8fCAxMDA7Cgl0aGlzLmhlaWdodCA9IGhlaWdodCB8fCAxMDA7CgoJdGhpcy5pbmRldGl0eU1hdHJpeCA9IFBJWEkubWF0My5jcmVhdGUoKTsKCgl0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsJCgoJaWYoUElYSS5nbCkKCXsKCQl0aGlzLmluaXRXZWJHTCgpOwoJfQoJZWxzZQoJewoJCXRoaXMuaW5pdENhbnZhcygpOwoJfQp9CgpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5UZXh0dXJlLnByb3RvdHlwZSApOwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SZW5kZXJUZXh0dXJlOwoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSB3ZWJnbCBkYXRhIGZvciB0aGlzIHRleHR1cmUKICoKICogQG1ldGhvZCBpbml0V2ViR0wKICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuaW5pdFdlYkdMID0gZnVuY3Rpb24oKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoJdGhpcy5nbEZyYW1lYnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKCiAgIAlnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmdsRnJhbWVidWZmZXIuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CQoKCXRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSgpOwoKCXRoaXMuYmFzZVRleHR1cmUud2lkdGggPSB0aGlzLndpZHRoOwoJdGhpcy5iYXNlVGV4dHVyZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoKCWdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CgogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7CgoJdGhpcy5iYXNlVGV4dHVyZS5pc1JlbmRlciA9IHRydWU7CgoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCWdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGdsLkZSQU1FQlVGRkVSLCBnbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlLCAwKTsKCgkvLyBjcmVhdGUgYSBwcm9qZWN0aW9uIG1hdHJpeC4uCgl0aGlzLnByb2plY3Rpb24gPSBuZXcgUElYSS5Qb2ludCh0aGlzLndpZHRoLzIgLCAtdGhpcy5oZWlnaHQvMik7CgoJLy8gc2V0IHRoZSBjb3JyZWN0IHJlbmRlciBmdW5jdGlvbi4uCgl0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyV2ViR0w7Cn0KCgpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCgl0aGlzLndpZHRoID0gd2lkdGg7Cgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCQoJaWYoUElYSS5nbCkKCXsKCQl0aGlzLnByb2plY3Rpb24ueCA9IHRoaXMud2lkdGgvMgoJCXRoaXMucHJvamVjdGlvbi55ID0gLXRoaXMuaGVpZ2h0LzI7CgkKCQl2YXIgZ2wgPSBQSVhJLmdsOwoJCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgkJZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCX0KCWVsc2UKCXsKCQkKCQl0aGlzLmZyYW1lLndpZHRoID0gdGhpcy53aWR0aAoJCXRoaXMuZnJhbWUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgkJdGhpcy5yZW5kZXJlci5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoJfQp9CgovKioKICogSW5pdGlhbGl6ZXMgdGhlIGNhbnZhcyBkYXRhIGZvciB0aGlzIHRleHR1cmUKICoKICogQG1ldGhvZCBpbml0Q2FudmFzCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRDYW52YXMgPSBmdW5jdGlvbigpCnsKCXRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5DYW52YXNSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgbnVsbCwgMCk7CgoJdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMucmVuZGVyZXIudmlldyk7Cgl0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCgl0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyQ2FudmFzOwp9CgovKioKICogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgogKgogKiBAbWV0aG9kIHJlbmRlcldlYkdMCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgZGlzcGxheSBvYmplY3QgdG8gcmVuZGVyIHRoaXMgdGV4dHVyZSBvbgogKiBAcGFyYW0gY2xlYXIge0Jvb2xlYW59IElmIHRydWUgdGhlIHRleHR1cmUgd2lsbCBiZSBjbGVhcmVkIGJlZm9yZSB0aGUgZGlzcGxheU9iamVjdCBpcyBkcmF3bgogKiBAcHJpdmF0ZQogKi8KUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJXZWJHTCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhcikKewoJdmFyIGdsID0gUElYSS5nbDsKCgkvLyBlbmFibGUgdGhlIGFscGhhIGNvbG9yIG1hc2suLgoJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOyAKCglnbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CQoKCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgoJaWYoY2xlYXIpCgl7CgkJZ2wuY2xlYXJDb2xvcigwLDAsMCwgMCk7ICAgICAKCQlnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCX0KCgkvLyBUSElTIFdJTEwgTUVTUyBXSVRIIEhJVCBURVNUSU5HIQoJdmFyIGNoaWxkcmVuID0gZGlzcGxheU9iamVjdC5jaGlsZHJlbjsKCgkvL1RPRE8gLT8gY3JlYXRlIGEgbmV3IG9uZT8/PyBkb250IHRoaW5rIHNvIQoJdmFyIG9yaWdpbmFsV29ybGRUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsvL3N0aGlzLmluZGV0aXR5TWF0cml4OwoJLy8gbW9kaWZ5IHRvIGZsaXAuLi4KCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0gPSAtMTsKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSB0aGlzLnByb2plY3Rpb24ueSAqIC0yOwoKCWlmKHBvc2l0aW9uKQoJewoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gLT0gcG9zaXRpb24ueTsKCX0KCQoJUElYSS52aXNpYmxlQ291bnQrKzsKCWRpc3BsYXlPYmplY3QudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CgkKCWZvcih2YXIgaT0wLGo9Y2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKCXsKCQljaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsJCgl9CgoJdmFyIHJlbmRlckdyb3VwID0gZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwOwoKCWlmKHJlbmRlckdyb3VwKQoJewoJCWlmKGRpc3BsYXlPYmplY3QgPT0gcmVuZGVyR3JvdXAucm9vdCkKCQl7CgkJCXJlbmRlckdyb3VwLnJlbmRlcih0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7CgkJfQoJCWVsc2UKCQl7CgkJCXJlbmRlckdyb3VwLnJlbmRlclNwZWNpZmljKGRpc3BsYXlPYmplY3QsIHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCQl9Cgl9CgllbHNlCgl7CgkJaWYoIXRoaXMucmVuZGVyR3JvdXApdGhpcy5yZW5kZXJHcm91cCA9IG5ldyBQSVhJLldlYkdMUmVuZGVyR3JvdXAoZ2wpOwoJCXRoaXMucmVuZGVyR3JvdXAuc2V0UmVuZGVyYWJsZShkaXNwbGF5T2JqZWN0KTsKCQl0aGlzLnJlbmRlckdyb3VwLnJlbmRlcih0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7Cgl9CgkKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBvcmlnaW5hbFdvcmxkVHJhbnNmb3JtOwp9CgoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZS4KICoKICogQG1ldGhvZCByZW5kZXJDYW52YXMKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uCiAqIEBwYXJhbSBjbGVhciB7Qm9vbGVhbn0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlckNhbnZhcyA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhcikKewoJdmFyIGNoaWxkcmVuID0gZGlzcGxheU9iamVjdC5jaGlsZHJlbjsKCglkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOwoJCglpZihwb3NpdGlvbikKCXsKCQlkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdID0gcG9zaXRpb24ueDsKCQlkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdID0gcG9zaXRpb24ueTsKCX0KCQoKCWZvcih2YXIgaT0wLGo9Y2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKCXsKCQljaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsJCgl9CgoJaWYoY2xlYXIpdGhpcy5yZW5kZXJlci5jb250ZXh0LmNsZWFyUmVjdCgwLDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCQogICAgdGhpcy5yZW5kZXJlci5yZW5kZXJEaXNwbGF5T2JqZWN0KGRpc3BsYXlPYmplY3QpOwogICAgCiAgICB0aGlzLnJlbmRlcmVyLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsMCwwLDEsMCwwKTsgCiAgICAKCiAgLy8gIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMuYmFzZVRleHR1cmUpOwp9CgovKioKICogaHR0cHM6Ly9naXRodWIuY29tL21yZG9vYi9ldmVudHRhcmdldC5qcy8KICogVEhhbmtTIG1yIERPb2IhCiAqLwoKLyoqCiAqIEFkZHMgZXZlbnQgZW1pdHRlciBmdW5jdGlvbmFsaXR5IHRvIGEgY2xhc3MKICoKICogQGNsYXNzIEV2ZW50VGFyZ2V0CiAqIEBleGFtcGxlCiAqCQlmdW5jdGlvbiBNeUVtaXR0ZXIoKSB7CiAqCQkJUElYSS5FdmVudFRhcmdldC5jYWxsKHRoaXMpOyAvL21peGVzIGluIGV2ZW50IHRhcmdldCBzdHVmZgogKgkJfQogKgogKgkJdmFyIGVtID0gbmV3IE15RW1pdHRlcigpOwogKgkJZW0uZW1pdCh7IHR5cGU6ICdldmVudE5hbWUnLCBkYXRhOiAnc29tZSBkYXRhJyB9KTsKICovClBJWEkuRXZlbnRUYXJnZXQgPSBmdW5jdGlvbiAoKSB7CgoJdmFyIGxpc3RlbmVycyA9IHt9OwoKCXRoaXMuYWRkRXZlbnRMaXN0ZW5lciA9IHRoaXMub24gPSBmdW5jdGlvbiAoIHR5cGUsIGxpc3RlbmVyICkgewoKCgkJaWYgKCBsaXN0ZW5lcnNbIHR5cGUgXSA9PT0gdW5kZWZpbmVkICkgewoKCQkJbGlzdGVuZXJzWyB0eXBlIF0gPSBbXTsKCgkJfQoKCQlpZiAoIGxpc3RlbmVyc1sgdHlwZSBdLmluZGV4T2YoIGxpc3RlbmVyICkgPT09IC0gMSApIHsKCgkJCWxpc3RlbmVyc1sgdHlwZSBdLnB1c2goIGxpc3RlbmVyICk7CgkJfQoKCX07CgoJdGhpcy5kaXNwYXRjaEV2ZW50ID0gdGhpcy5lbWl0ID0gZnVuY3Rpb24gKCBldmVudCApIHsKCgkJaWYgKCAhbGlzdGVuZXJzWyBldmVudC50eXBlIF0gfHwgIWxpc3RlbmVyc1sgZXZlbnQudHlwZSBdLmxlbmd0aCApIHsKCgkJCXJldHVybjsKCgkJfQoKCQlmb3IodmFyIGkgPSAwLCBsID0gbGlzdGVuZXJzWyBldmVudC50eXBlIF0ubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CgoJCQlsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXVsgaSBdKCBldmVudCApOwoKCQl9CgoJfTsKCgl0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIgPSB0aGlzLm9mZiA9IGZ1bmN0aW9uICggdHlwZSwgbGlzdGVuZXIgKSB7CgoJCXZhciBpbmRleCA9IGxpc3RlbmVyc1sgdHlwZSBdLmluZGV4T2YoIGxpc3RlbmVyICk7CgoJCWlmICggaW5kZXggIT09IC0gMSApIHsKCgkJCWxpc3RlbmVyc1sgdHlwZSBdLnNwbGljZSggaW5kZXgsIDEgKTsKCgkJfQoKCX07Cgp9OwoKLyoKCVBvbHlLIGxpYnJhcnkKCXVybDogaHR0cDovL3BvbHlrLml2YW5rLm5ldAoJUmVsZWFzZWQgdW5kZXIgTUlUIGxpY2VuY2UuCgoJQ29weXJpZ2h0IChjKSAyMDEyIEl2YW4gS3Vja2lyCgoJUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24KCW9idGFpbmluZyBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uCglmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0CglyZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwKCWNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCgljb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUKCVNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nCgljb25kaXRpb25zOgoKCVRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlCglpbmNsdWRlZCBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCglUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKCUVYUFJFU1MgT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUwoJT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKCU5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCglIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwKCVdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORwoJRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUgoJT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoKCVRoaXMgaXMgYW4gYW1hemluZyBsaWIhCgoJc2xpZ2h0bHkgbW9kaWZpZWQgYnkgbWF0IGdyb3ZlcyAobWF0Z3JvdmVzLmNvbSk7CiovCgpQSVhJLlBvbHlLID0ge307CgovKioKICogVHJpYW5ndWxhdGVzIHNoYXBlcyBmb3Igd2ViR0wgZ3JhcGhpYyBmaWxscwogKgogKiBAbWV0aG9kIFRyaWFuZ3VsYXRlCiAqIEBuYW1lc3BhY2UgUG9seUsKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLlBvbHlLLlRyaWFuZ3VsYXRlID0gZnVuY3Rpb24ocCkKewoJdmFyIHNpZ24gPSB0cnVlOwoKCXZhciBuID0gcC5sZW5ndGg+PjE7CglpZihuPDMpIHJldHVybiBbXTsKCXZhciB0Z3MgPSBbXTsKCXZhciBhdmwgPSBbXTsKCWZvcih2YXIgaT0wOyBpPG47IGkrKykgYXZsLnB1c2goaSk7CgoJdmFyIGkgPSAwOwoJdmFyIGFsID0gbjsKCXdoaWxlKGFsID4gMykKCXsKCQl2YXIgaTAgPSBhdmxbKGkrMCklYWxdOwoJCXZhciBpMSA9IGF2bFsoaSsxKSVhbF07CgkJdmFyIGkyID0gYXZsWyhpKzIpJWFsXTsKCgkJdmFyIGF4ID0gcFsyKmkwXSwgIGF5ID0gcFsyKmkwKzFdOwoJCXZhciBieCA9IHBbMippMV0sICBieSA9IHBbMippMSsxXTsKCQl2YXIgY3ggPSBwWzIqaTJdLCAgY3kgPSBwWzIqaTIrMV07CgoJCXZhciBlYXJGb3VuZCA9IGZhbHNlOwoJCWlmKFBJWEkuUG9seUsuX2NvbnZleChheCwgYXksIGJ4LCBieSwgY3gsIGN5LCBzaWduKSkKCQl7CgkJCWVhckZvdW5kID0gdHJ1ZTsKCQkJZm9yKHZhciBqPTA7IGo8YWw7IGorKykKCQkJewoJCQkJdmFyIHZpID0gYXZsW2pdOwoJCQkJaWYodmk9PWkwIHx8IHZpPT1pMSB8fCB2aT09aTIpIGNvbnRpbnVlOwoJCQkJaWYoUElYSS5Qb2x5Sy5fUG9pbnRJblRyaWFuZ2xlKHBbMip2aV0sIHBbMip2aSsxXSwgYXgsIGF5LCBieCwgYnksIGN4LCBjeSkpIHtlYXJGb3VuZCA9IGZhbHNlOyBicmVhazt9CgkJCX0KCQl9CgkJaWYoZWFyRm91bmQpCgkJewoJCQl0Z3MucHVzaChpMCwgaTEsIGkyKTsKCQkJYXZsLnNwbGljZSgoaSsxKSVhbCwgMSk7CgkJCWFsLS07CgkJCWkgPSAwOwoJCX0KCQllbHNlIGlmKGkrKyA+IDMqYWwpCgkJewoJCQkvLyBuZWVkIHRvIGZsaXAgZmxpcCByZXZlcnNlIGl0IQoJCQkvLyByZXNldCEKCQkJaWYoc2lnbikKCQkJewoJCQkJdmFyIHRncyA9IFtdOwoJCQkJYXZsID0gW107CgkJCQlmb3IodmFyIGk9MDsgaTxuOyBpKyspIGF2bC5wdXNoKGkpOwoKCQkJCWkgPSAwOwoJCQkJYWwgPSBuOwoKCQkJCXNpZ24gPSBmYWxzZTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCWNvbnNvbGUubG9nKCJQSVhJIFdhcm5pbmc6IHNoYXBlIHRvbyBjb21wbGV4IHRvIGZpbGwiKQoJCQkJcmV0dXJuIFtdOwoJCQl9CgkJfQoJfQoJdGdzLnB1c2goYXZsWzBdLCBhdmxbMV0sIGF2bFsyXSk7CglyZXR1cm4gdGdzOwp9CgovKioKICogQ2hlY2tzIGlmIGEgcG9pbnQgaXMgd2l0aGluIGEgdHJpYW5nbGUKICoKICogQGNsYXNzIF9Qb2ludEluVHJpYW5nbGUKICogQG5hbWVzcGFjZSBQb2x5SwogKiBAcHJpdmF0ZQogKi8KUElYSS5Qb2x5Sy5fUG9pbnRJblRyaWFuZ2xlID0gZnVuY3Rpb24ocHgsIHB5LCBheCwgYXksIGJ4LCBieSwgY3gsIGN5KQp7Cgl2YXIgdjB4ID0gY3gtYXg7Cgl2YXIgdjB5ID0gY3ktYXk7Cgl2YXIgdjF4ID0gYngtYXg7Cgl2YXIgdjF5ID0gYnktYXk7Cgl2YXIgdjJ4ID0gcHgtYXg7Cgl2YXIgdjJ5ID0gcHktYXk7CgoJdmFyIGRvdDAwID0gdjB4KnYweCt2MHkqdjB5OwoJdmFyIGRvdDAxID0gdjB4KnYxeCt2MHkqdjF5OwoJdmFyIGRvdDAyID0gdjB4KnYyeCt2MHkqdjJ5OwoJdmFyIGRvdDExID0gdjF4KnYxeCt2MXkqdjF5OwoJdmFyIGRvdDEyID0gdjF4KnYyeCt2MXkqdjJ5OwoKCXZhciBpbnZEZW5vbSA9IDEgLyAoZG90MDAgKiBkb3QxMSAtIGRvdDAxICogZG90MDEpOwoJdmFyIHUgPSAoZG90MTEgKiBkb3QwMiAtIGRvdDAxICogZG90MTIpICogaW52RGVub207Cgl2YXIgdiA9IChkb3QwMCAqIGRvdDEyIC0gZG90MDEgKiBkb3QwMikgKiBpbnZEZW5vbTsKCgkvLyBDaGVjayBpZiBwb2ludCBpcyBpbiB0cmlhbmdsZQoJcmV0dXJuICh1ID49IDApICYmICh2ID49IDApICYmICh1ICsgdiA8IDEpOwp9CgovKioKICogQ2hlY2tzIGlmIGEgc2hhcGUgaXMgY29udmV4CiAqCiAqIEBjbGFzcyBfY29udmV4CiAqIEBuYW1lc3BhY2UgUG9seUsKICogQHByaXZhdGUKICovClBJWEkuUG9seUsuX2NvbnZleCA9IGZ1bmN0aW9uKGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHNpZ24pCnsKCXJldHVybiAoKGF5LWJ5KSooY3gtYngpICsgKGJ4LWF4KSooY3ktYnkpID49IDApID09IHNpZ247Cn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgQ2FtZXJhIGlzIHlvdXIgdmlldyBpbnRvIHRoZSBnYW1lIHdvcmxkLiBJdCBoYXMgYSBwb3NpdGlvbiBhbmQgc2l6ZSBhbmQgcmVuZGVycyBvbmx5IHRob3NlIG9iamVjdHMgd2l0aGluIGl0cyBmaWVsZCBvZiB2aWV3LgoqIFRoZSBnYW1lIGF1dG9tYXRpY2FsbHkgY3JlYXRlcyBhIHNpbmdsZSBTdGFnZSBzaXplZCBjYW1lcmEgb24gYm9vdC4gTW92ZSB0aGUgY2FtZXJhIGFyb3VuZCB0aGUgd29ybGQgd2l0aCBQaGFzZXIuQ2FtZXJhLngveQoqCiogQGNsYXNzIFBoYXNlci5DYW1lcmEKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IGlkIC0gTm90IGJlaW5nIHVzZWQgYXQgdGhlIG1vbWVudCwgd2lsbCBiZSB3aGVuIFBoYXNlciBzdXBwb3J0cyBtdWx0aXBsZSBjYW1lcmEKKiBAcGFyYW0ge251bWJlcn0geCAtIFBvc2l0aW9uIG9mIHRoZSBjYW1lcmEgb24gdGhlIFggYXhpcwoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gUG9zaXRpb24gb2YgdGhlIGNhbWVyYSBvbiB0aGUgWSBheGlzCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSB2aWV3IHJlY3RhbmdsZQoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSB2aWV3IHJlY3RhbmdsZQoqLwpQaGFzZXIuQ2FtZXJhID0gZnVuY3Rpb24gKGdhbWUsIGlkLCB4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuV29ybGR9IHdvcmxkIC0gQSByZWZlcmVuY2UgdG8gdGhlIGdhbWUgd29ybGQuCgkqLwoJdGhpcy53b3JsZCA9IGdhbWUud29ybGQ7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpZCAtIFJlc2VydmVkIGZvciBmdXR1cmUgbXVsdGlwbGUgY2FtZXJhIHNldC11cHMuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pZCA9IDA7IAoKCS8qKgoJKiBDYW1lcmEgdmlldy4gCgkqIFRoZSB2aWV3IGludG8gdGhlIHdvcmxkIHdlIHdpc2ggdG8gcmVuZGVyIChieSBkZWZhdWx0IHRoZSBnYW1lIGRpbWVuc2lvbnMpLgogICAgKiBUaGUgeC95IHZhbHVlcyBhcmUgaW4gd29ybGQgY29vcmRpbmF0ZXMsIG5vdCBzY3JlZW4gY29vcmRpbmF0ZXMsIHRoZSB3aWR0aC9oZWlnaHQgaXMgaG93IG1hbnkgcGl4ZWxzIHRvIHJlbmRlci4KICAgICogT2JqZWN0cyBvdXRzaWRlIG9mIHRoaXMgdmlldyBhcmUgbm90IHJlbmRlcmVkICh1bmxlc3Mgc2V0IHRvIGlnbm9yZSB0aGUgQ2FtZXJhLCBpLmUuIFVJPykuCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gdmlldwoJKi8KICAgIHRoaXMudmlldyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IHNjcmVlblZpZXcgLSBVc2VkIGJ5IFNwcml0ZXMgdG8gd29yayBvdXQgQ2FtZXJhIGN1bGxpbmcuCgkqLwoJdGhpcy5zY3JlZW5WaWV3ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAqIFRoZSBDYW1lcmEgaXMgYm91bmQgdG8gdGhpcyBSZWN0YW5nbGUgYW5kIGNhbm5vdCBtb3ZlIG91dHNpZGUgb2YgaXQuIEJ5IGRlZmF1bHQgaXQgaXMgZW5hYmxlZCBhbmQgc2V0IHRvIHRoZSBzaXplIG9mIHRoZSBXb3JsZC4KICAgICogVGhlIFJlY3RhbmdsZSBjYW4gYmUgbG9jYXRlZCBhbnl3aGVyZSBpbiB0aGUgd29ybGQgYW5kIHVwZGF0ZWQgYXMgb2Z0ZW4gYXMgeW91IGxpa2UuIElmIHlvdSBkb24ndCB3aXNoIHRoZSBDYW1lcmEgdG8gYmUgYm91bmQKICAgICogYXQgYWxsIHRoZW4gc2V0IHRoaXMgdG8gbnVsbC4gVGhlIHZhbHVlcyBjYW4gYmUgYW55dGhpbmcgYW5kIGFyZSBpbiBXb3JsZCBjb29yZGluYXRlcywgd2l0aCAwLDAgYmVpbmcgdGhlIGNlbnRlciBvZiB0aGUgd29ybGQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzIC0gVGhlIFJlY3RhbmdsZSBpbiB3aGljaCB0aGUgQ2FtZXJhIGlzIGJvdW5kZWQuIFNldCB0byBudWxsIHRvIGFsbG93IGZvciBtb3ZlbWVudCBhbnl3aGVyZS4KICAgICovCiAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGRlYWR6b25lIC0gTW92aW5nIGluc2lkZSB0aGlzIFJlY3RhbmdsZSB3aWxsIG5vdCBjYXVzZSBjYW1lcmEgbW92aW5nLgoJKi8KICAgIHRoaXMuZGVhZHpvbmUgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBXaGV0aGVyIHRoaXMgY2FtZXJhIGlzIHZpc2libGUgb3Igbm90LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXRMaW1pdCAtIFdoZXRoZXIgdGhpcyBjYW1lcmEgaXMgZmx1c2ggd2l0aCB0aGUgV29ybGQgQm91bmRzIG9yIG5vdC4KICAgICovCiAgICB0aGlzLmF0TGltaXQgPSB7IHg6IGZhbHNlLCB5OiBmYWxzZSB9OwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHRhcmdldCAtIElmIHRoZSBjYW1lcmEgaXMgdHJhY2tpbmcgYSBTcHJpdGUsIHRoaXMgaXMgYSByZWZlcmVuY2UgdG8gaXQsIG90aGVyd2lzZSBudWxsLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGFyZ2V0ID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGVkZ2UgLSBFZGdlIHByb3BlcnR5LgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2VkZ2UgPSAwOwoKICAgIHRoaXMuZGlzcGxheU9iamVjdCA9IG51bGw7CgkKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX0xPQ0tPTiA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuQ2FtZXJhLkZPTExPV19QTEFURk9STUVSID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV04gPSAyOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkNhbWVyYS5GT0xMT1dfVE9QRE9XTl9USUdIVCA9IDM7CgpQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSA9IHsKCgkvKioKICAgICogVGVsbHMgdGhpcyBjYW1lcmEgd2hpY2ggc3ByaXRlIHRvIGZvbGxvdy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2ZvbGxvdwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHRhcmdldCAtIFRoZSBvYmplY3QgeW91IHdhbnQgdGhlIGNhbWVyYSB0byB0cmFjay4gU2V0IHRvIG51bGwgdG8gbm90IGZvbGxvdyBhbnl0aGluZy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdHlsZV0gTGV2ZXJhZ2Ugb25lIG9mIHRoZSBleGlzdGluZyAiZGVhZHpvbmUiIHByZXNldHMuIElmIHlvdSB1c2UgYSBjdXN0b20gZGVhZHpvbmUsIGlnbm9yZSB0aGlzIHBhcmFtZXRlciBhbmQgbWFudWFsbHkgc3BlY2lmeSB0aGUgZGVhZHpvbmUgYWZ0ZXIgY2FsbGluZyBmb2xsb3coKS4KICAgICovCiAgICBmb2xsb3c6IGZ1bmN0aW9uICh0YXJnZXQsIHN0eWxlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3R5bGUgPT09ICJ1bmRlZmluZWQiKSB7IHN0eWxlID0gUGhhc2VyLkNhbWVyYS5GT0xMT1dfTE9DS09OOyB9CgogICAgICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwoKICAgICAgICB2YXIgaGVscGVyOwoKICAgICAgICBzd2l0Y2ggKHN0eWxlKSB7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX1BMQVRGT1JNRVI6CiAgICAgICAgICAgICAgICB2YXIgdyA9IHRoaXMud2lkdGggLyA4OwogICAgICAgICAgICAgICAgdmFyIGggPSB0aGlzLmhlaWdodCAvIDM7CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKHRoaXMud2lkdGggLSB3KSAvIDIsICh0aGlzLmhlaWdodCAtIGgpIC8gMiAtIGggKiAwLjI1LCB3LCBoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBQaGFzZXIuQ2FtZXJhLkZPTExPV19UT1BET1dOOgogICAgICAgICAgICAgICAgaGVscGVyID0gTWF0aC5tYXgodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpIC8gNDsKICAgICAgICAgICAgICAgIHRoaXMuZGVhZHpvbmUgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgodGhpcy53aWR0aCAtIGhlbHBlcikgLyAyLCAodGhpcy5oZWlnaHQgLSBoZWxwZXIpIC8gMiwgaGVscGVyLCBoZWxwZXIpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV05fVElHSFQ6CiAgICAgICAgICAgICAgICBoZWxwZXIgPSBNYXRoLm1heCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCkgLyA4OwogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCh0aGlzLndpZHRoIC0gaGVscGVyKSAvIDIsICh0aGlzLmhlaWdodCAtIGhlbHBlcikgLyAyLCBoZWxwZXIsIGhlbHBlcik7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgUGhhc2VyLkNhbWVyYS5GT0xMT1dfTE9DS09OOgogICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG51bGw7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgY2FtZXJhIGZvY3VzIG9uIGEgZGlzcGxheSBvYmplY3QgaW5zdGFudGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjZm9jdXNPbgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBmb2N1cyB0aGUgY2FtZXJhIG9uLiBNdXN0IGhhdmUgdmlzaWJsZSB4L3kgcHJvcGVydGllcy4KICAgICovCiAgICBmb2N1c09uOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCkgewoKICAgICAgICB0aGlzLnNldFBvc2l0aW9uKE1hdGgucm91bmQoZGlzcGxheU9iamVjdC54IC0gdGhpcy52aWV3LmhhbGZXaWR0aCksIE1hdGgucm91bmQoZGlzcGxheU9iamVjdC55IC0gdGhpcy52aWV3LmhhbGZIZWlnaHQpKTsKCiAgICB9LAoKCS8qKgogICAgKiBNb3ZlIHRoZSBjYW1lcmEgZm9jdXMgb24gYSBsb2NhdGlvbiBpbnN0YW50bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNmb2N1c09uWFkKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24uCiAgICAqLwogICAgZm9jdXNPblhZOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnNldFBvc2l0aW9uKE1hdGgucm91bmQoeCAtIHRoaXMudmlldy5oYWxmV2lkdGgpLCBNYXRoLnJvdW5kKHkgLSB0aGlzLnZpZXcuaGFsZkhlaWdodCkpOwoKICAgIH0sCgoJLyoqCiAgICAqIFVwZGF0ZSBmb2N1c2luZyBhbmQgc2Nyb2xsaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnRhcmdldCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXBkYXRlVGFyZ2V0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRpc3BsYXlPYmplY3QucG9zaXRpb24ueCA9IC10aGlzLnZpZXcueDsKICAgICAgICB0aGlzLmRpc3BsYXlPYmplY3QucG9zaXRpb24ueSA9IC10aGlzLnZpZXcueTsKCiAgICB9LAoKICAgIHVwZGF0ZVRhcmdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5kZWFkem9uZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC54IC0gdGhpcy5kZWFkem9uZS54OwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy54ID4gdGhpcy5fZWRnZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLl9lZGdlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9lZGdlID0gdGhpcy50YXJnZXQueCArIHRoaXMudGFyZ2V0LndpZHRoIC0gdGhpcy5kZWFkem9uZS54IC0gdGhpcy5kZWFkem9uZS53aWR0aDsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueCA8IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy54ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnkgLSB0aGlzLmRlYWR6b25lLnk7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnkgPiB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC55ICsgdGhpcy50YXJnZXQuaGVpZ2h0IC0gdGhpcy5kZWFkem9uZS55IC0gdGhpcy5kZWFkem9uZS5oZWlnaHQ7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnkgPCB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mb2N1c09uWFkodGhpcy50YXJnZXQueCwgdGhpcy50YXJnZXQueSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0Qm91bmRzVG9Xb3JsZDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmJvdW5kcy5zZXRUbyh0aGlzLmdhbWUud29ybGQueCwgdGhpcy5nYW1lLndvcmxkLnksIHRoaXMuZ2FtZS53b3JsZC53aWR0aCwgdGhpcy5nYW1lLndvcmxkLmhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogTWV0aG9kIGNhbGxlZCB0byBlbnN1cmUgdGhlIGNhbWVyYSBkb2Vzbid0IHZlbnR1cmUgb3V0c2lkZSBvZiB0aGUgZ2FtZSB3b3JsZC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2NoZWNrV29ybGRCb3VuZHMKICAgICovCiAgICBjaGVja0JvdW5kczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmF0TGltaXQueCA9IGZhbHNlOwogICAgICAgIHRoaXMuYXRMaW1pdC55ID0gZmFsc2U7CgogICAgICAgIC8vICBNYWtlIHN1cmUgd2UgZGlkbid0IGdvIG91dHNpZGUgdGhlIGNhbWVyYXMgYm91bmRzCiAgICAgICAgaWYgKHRoaXMudmlldy54IDwgdGhpcy5ib3VuZHMueCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC54ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLmJvdW5kcy54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmlldy54ID4gdGhpcy5ib3VuZHMucmlnaHQgLSB0aGlzLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnggPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueCA9ICh0aGlzLmJvdW5kcy5yaWdodCAtIHRoaXMud2lkdGgpICsgMTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnZpZXcueSA8IHRoaXMuYm91bmRzLnRvcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC55ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnkgPSB0aGlzLmJvdW5kcy50b3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy52aWV3LnkgPiB0aGlzLmJvdW5kcy5ib3R0b20gLSB0aGlzLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYXRMaW1pdC55ID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy52aWV3LnkgPSAodGhpcy5ib3VuZHMuYm90dG9tIC0gdGhpcy5oZWlnaHQpICsgMTsKICAgICAgICB9CgogICAgICAgIHRoaXMudmlldy5mbG9vcigpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgaGVscGVyIGZ1bmN0aW9uIHRvIHNldCBib3RoIHRoZSBYIGFuZCBZIHByb3BlcnRpZXMgb2YgdGhlIGNhbWVyYSBhdCBvbmNlCiAgICAqIHdpdGhvdXQgaGF2aW5nIHRvIHVzZSBnYW1lLmNhbWVyYS54IGFuZCBnYW1lLmNhbWVyYS55LgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI3NldFBvc2l0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uLgogICAgKi8KICAgIHNldFBvc2l0aW9uOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnZpZXcueCA9IHg7CiAgICAgICAgdGhpcy52aWV3LnkgPSB5OwoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHNpemUgb2YgdGhlIHZpZXcgcmVjdGFuZ2xlIGdpdmVuIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IGluIHBhcmFtZXRlcnMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjc2V0U2l6ZQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgZGVzaXJlZCB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBkZXNpcmVkIGhlaWdodC4KICAgICovCiAgICBzZXRTaXplOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnZpZXcud2lkdGggPSB3aWR0aDsKICAgICAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIH0KCn07CgovKioKKiBUaGUgQ2FtZXJhcyB4IGNvb3JkaW5hdGUuIFRoaXMgdmFsdWUgaXMgYXV0b21hdGljYWxseSBjbGFtcGVkIGlmIGl0IGZhbGxzIG91dHNpZGUgb2YgdGhlIFdvcmxkIGJvdW5kcy4KKiBAbmFtZSBQaGFzZXIuQ2FtZXJhI3gKKiBAcHJvcGVydHkge251bWJlcn0geCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyB4IHBvc2l0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNhbWVyYS5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcueDsKICAgIH0sCiAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMudmlldy54ID0gdmFsdWU7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBDYW1lcmFzIHkgY29vcmRpbmF0ZS4gVGhpcyB2YWx1ZSBpcyBhdXRvbWF0aWNhbGx5IGNsYW1wZWQgaWYgaXQgZmFsbHMgb3V0c2lkZSBvZiB0aGUgV29ybGQgYm91bmRzLgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHkgcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgInkiLCB7CgkKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy52aWV3LnkgPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kcygpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgd2lkdGguIEJ5IGRlZmF1bHQgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgR2FtZSBzaXplIGFuZCBzaG91bGQgbm90IGJlIGFkanVzdGVkIGZvciBub3cuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyB3aWR0aC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAid2lkdGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy53aWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnZpZXcud2lkdGggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgaGVpZ2h0LiBCeSBkZWZhdWx0IHRoaXMgaXMgdGhlIHNhbWUgYXMgdGhlIEdhbWUgc2l6ZSBhbmQgc2hvdWxkIG5vdCBiZSBhZGp1c3RlZCBmb3Igbm93LgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjaGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgY2FtZXJhcyBoZWlnaHQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgImhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy52aWV3LmhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnZpZXcuaGVpZ2h0ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoaXMgaXMgYSBiYXNlIFN0YXRlIGNsYXNzIHdoaWNoIGNhbiBiZSBleHRlbmRlZCBpZiB5b3UgYXJlIGNyZWF0aW5nIHlvdXIgb3duIGdhbWUuCiogSXQgcHJvdmlkZXMgcXVpY2sgYWNjZXNzIHRvIGNvbW1vbiBmdW5jdGlvbnMgc3VjaCBhcyB0aGUgY2FtZXJhLCBjYWNoZSwgaW5wdXQsIG1hdGNoLCBzb3VuZCBhbmQgbW9yZS4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhdGUKKiBAY29uc3RydWN0b3IKKi8KClBoYXNlci5TdGF0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgoJKi8KICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lT2JqZWN0RmFjdG9yeX0gYWRkIC0gUmVmZXJlbmNlIHRvIHRoZSBHYW1lT2JqZWN0RmFjdG9yeS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFkZCA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLlBoeXNpY3NNYW5hZ2VyfSBjYW1lcmEgLSBBIGhhbmR5IHJlZmVyZW5jZSB0byB3b3JsZC5jYW1lcmEuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jYW1lcmEgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuQ2FjaGV9IGNhY2hlIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgY2FjaGUuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jYWNoZSA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5JbnB1dH0gaW5wdXQgLSBSZWZlcmVuY2UgdG8gdGhlIGlucHV0IG1hbmFnZXIKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmlucHV0ID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkxvYWRlcn0gbG9hZCAtIFJlZmVyZW5jZSB0byB0aGUgYXNzZXRzIGxvYWRlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmxvYWQgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuTWF0aH0gbWF0aCAtIFJlZmVyZW5jZSB0byB0aGUgbWF0aCBoZWxwZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5tYXRoID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kTWFuYWdlcn0gc291bmQgLSBSZWZlcmVuY2UgdG8gdGhlIHNvdW5kIG1hbmFnZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zb3VuZCA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TdGFnZX0gc3RhZ2UgLSBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc3RhZ2UgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuVGltZU1hbmFnZXJ9IHRpbWUgLSBSZWZlcmVuY2UgdG8gZ2FtZSBjbG9jay4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnRpbWUgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuVHdlZW5NYW5hZ2VyfSB0d2VlbnMgLSBSZWZlcmVuY2UgdG8gdGhlIHR3ZWVuIG1hbmFnZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50d2VlbnMgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuV29ybGR9IHdvcmxkIC0gUmVmZXJlbmNlIHRvIHRoZSB3b3JsZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLndvcmxkID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGFkZCAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucGFydGljbGVzID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuUGh5c2ljc01hbmFnZXJ9IHBoeXNpY3MgLSBSZWZlcmVuY2UgdG8gdGhlIHBoeXNpY3MgbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnBoeXNpY3MgPSBudWxsOwoKfTsKClBoYXNlci5TdGF0ZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIE92ZXJyaWRlIHRoaXMgbWV0aG9kIHRvIGFkZCBzb21lIGxvYWQgb3BlcmF0aW9ucy4KICAgICogSWYgeW91IG5lZWQgdG8gdXNlIHRoZSBsb2FkZXIsIHlvdSBtYXkgbmVlZCB0byB1c2UgdGhlbSBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjcHJlbG9hZAogICAgKi8KICAgIHByZWxvYWQ6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCB1cGRhdGUgbG9naWMgaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI2xvYWRVcGRhdGUKICAgICovCiAgICBsb2FkVXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBQdXQgcmVuZGVyIG9wZXJhdGlvbnMgaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI2xvYWRSZW5kZXIKICAgICovCiAgICBsb2FkUmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIGdhbWUgZW5naW5lIHN1Y2Nlc3NmdWxseSBzd2l0Y2hlcyBzdGF0ZXMuCiAgICAqIEZlZWwgZnJlZSB0byBhZGQgYW55IHNldHVwIGNvZGUgaGVyZSAoZG8gbm90IGxvYWQgYW55dGhpbmcgaGVyZSwgb3ZlcnJpZGUgcHJlbG9hZCgpIGluc3RlYWQpLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjY3JlYXRlCiAgICAqLwogICAgY3JlYXRlOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBQdXQgdXBkYXRlIGxvZ2ljIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCByZW5kZXIgb3BlcmF0aW9ucyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjcmVuZGVyCiAgICAqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGlzIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCB3aGVuIGdhbWUgcGF1c2VkLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjcGF1c2VkCiAgICAqLwogICAgcGF1c2VkOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGlzIG1ldGhvZCB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBzdGF0ZSBpcyBkZXN0cm95ZWQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFN0YXRlIE1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIGxvYWRpbmcsIHNldHRpbmcgdXAgYW5kIHN3aXRjaGluZyBnYW1lIHN0YXRlcy4KKiAKKiBAY2xhc3MgUGhhc2VyLlN0YXRlTWFuYWdlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge1BoYXNlci5TdGF0ZXxPYmplY3R9IFtwZW5kaW5nU3RhdGU9bnVsbF0gLSBBIFN0YXRlIG9iamVjdCB0byBzZWVkIHRoZSBtYW5hZ2VyIHdpdGguCiovClBoYXNlci5TdGF0ZU1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSwgcGVuZGluZ1N0YXRlKSB7CgoJLyoqCgkqIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBzdGF0ZXMuCgkqLwoJdGhpcy5zdGF0ZXMgPSB7fTsKCglpZiAocGVuZGluZ1N0YXRlICE9PSBudWxsKQoJewoJCXRoaXMuX3BlbmRpbmdTdGF0ZSA9IHBlbmRpbmdTdGF0ZTsKCX0KCn07CgpQaGFzZXIuU3RhdGVNYW5hZ2VyLnByb3RvdHlwZSA9IHsKCQoJLyoqCgkqIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lLgoJKi8KCWdhbWU6IG51bGwsCgoJLyoqCgkqIFRoZSBzdGF0ZSB0byBiZSBzd2l0Y2hlZCB0byBpbiB0aGUgbmV4dCBmcmFtZS4KCSogQHByb3BlcnR5IHtTdGF0ZX0gX3BlbmRpbmdTdGF0ZSAKCSogQHByaXZhdGUKCSovCglfcGVuZGluZ1N0YXRlOiBudWxsLAoKCS8qKgoJKiBGbGFnIHRoYXQgc2V0cyBpZiB0aGUgU3RhdGUgaGFzIGJlZW4gY3JlYXRlZCBvciBub3QuCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn1fY3JlYXRlZAoJKiBAcHJpdmF0ZQoJKi8KCV9jcmVhdGVkOiBmYWxzZSwKCgkvKioKCSogVGhlIHN0YXRlIHRvIGJlIHN3aXRjaGVkIHRvIGluIHRoZSBuZXh0IGZyYW1lLgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBzdGF0ZXMKCSovCglzdGF0ZXM6IHt9LAoKCS8qKgoJKiBUaGUgY3VycmVudCBhY3RpdmUgU3RhdGUgb2JqZWN0IChkZWZhdWx0cyB0byBudWxsKS4KCSogQHByb3BlcnR5IHtzdHJpbmd9IGN1cnJlbnQKCSovCgljdXJyZW50OiAnJywKCQoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgc3RhdGUgaXMgc3RhcnRlZCAoaS5lLiBzZXQgYXMgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlKS4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Jbml0Q2FsbGJhY2sKCSovCglvbkluaXRDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIGluaXQgc3RhdGVzIChsb2FkaW5nIGFzc2V0cy4uLikuCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUHJlbG9hZENhbGxiYWNrCgkqLwoJb25QcmVsb2FkQ2FsbGJhY2s6IG51bGwsCgkKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gY3JlYXRlIHN0YXRlcyAoc2V0dXAgc3RhdGVzLi4uKS4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25DcmVhdGVDYWxsYmFjawoJKi8KCW9uQ3JlYXRlQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBTdGF0ZSBpcyB1cGRhdGVkLCB0aGlzIGRvZXNuJ3QgaGFwcGVuIGR1cmluZyBsb2FkIChAc2VlIG9uTG9hZFVwZGF0ZUNhbGxiYWNrKS4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25VcGRhdGVDYWxsYmFjawoJKi8KCW9uVXBkYXRlQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgU3RhdGUgaXMgcmVuZGVyZWQsIHRoaXMgZG9lc24ndCBoYXBwZW4gZHVyaW5nIGxvYWQgKHNlZSBvbkxvYWRSZW5kZXJDYWxsYmFjaykuCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUmVuZGVyQ2FsbGJhY2sKCSovCglvblJlbmRlckNhbGxiYWNrOiBudWxsLAoKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIGJlZm9yZSB0aGUgU3RhdGUgaXMgcmVuZGVyZWQgYW5kIGJlZm9yZSB0aGUgc3RhZ2UgaXMgY2xlYXJlZC4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25QcmVSZW5kZXJDYWxsYmFjawoJKi8KCW9uUHJlUmVuZGVyQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgU3RhdGUgaXMgdXBkYXRlZCBidXQgb25seSBkdXJpbmcgdGhlIGxvYWQgcHJvY2Vzcy4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Mb2FkVXBkYXRlQ2FsbGJhY2sKCSovCglvbkxvYWRVcGRhdGVDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBTdGF0ZSBpcyByZW5kZXJlZCBidXQgb25seSBkdXJpbmcgdGhlIGxvYWQgcHJvY2Vzcy4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Mb2FkUmVuZGVyQ2FsbGJhY2sKCSovCglvbkxvYWRSZW5kZXJDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHN0YXRlcyBwYXVzZWQuCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uUGF1c2VkQ2FsbGJhY2sKCSovCglvblBhdXNlZENhbGxiYWNrOiBudWxsLAoKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHN0YXRlIGlzIHNodXQgZG93biAoaS5lLiBzd2FwcGVkIHRvIGFub3RoZXIgc3RhdGUpLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblNodXREb3duQ2FsbGJhY2sKCSovCglvblNodXREb3duQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjYm9vdAoJKiBAcHJpdmF0ZQoJKi8KCWJvb3Q6IGZ1bmN0aW9uICgpIHsKCgkJLy8gY29uc29sZS5sb2coJ1BoYXNlci5TdGF0ZU1hbmFnZXIuYm9vdCcpOwoKCQlpZiAodGhpcy5fcGVuZGluZ1N0YXRlICE9PSBudWxsKQoJCXsKCQkJLy8gY29uc29sZS5sb2coJ19wZW5kaW5nU3RhdGUgZm91bmQnKTsKCQkJLy8gY29uc29sZS5sb2codHlwZW9mIHRoaXMuX3BlbmRpbmdTdGF0ZSk7CgoJCQlpZiAodHlwZW9mIHRoaXMuX3BlbmRpbmdTdGF0ZSA9PT0gJ3N0cmluZycpCgkJCXsKCQkJCS8vCVN0YXRlIHdhcyBhbHJlYWR5IGFkZGVkLCBzbyBqdXN0IHN0YXJ0IGl0CgkJCQl0aGlzLnN0YXJ0KHRoaXMuX3BlbmRpbmdTdGF0ZSwgZmFsc2UsIGZhbHNlKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuYWRkKCdkZWZhdWx0JywgdGhpcy5fcGVuZGluZ1N0YXRlLCB0cnVlKTsKCQkJfQoKCQl9CgoJfSwKCgkvKioKICAgICogQWRkIGEgbmV3IFN0YXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjYWRkCiAgICAqIEBwYXJhbSBrZXkge3N0cmluZ30gLSBBIHVuaXF1ZSBrZXkgeW91IHVzZSB0byByZWZlcmVuY2UgdGhpcyBzdGF0ZSwgaS5lLiAiTWFpbk1lbnUiLCAiTGV2ZWwxIi4KICAgICogQHBhcmFtIHN0YXRlIHtTdGF0ZX0gLSBUaGUgc3RhdGUgeW91IHdhbnQgdG8gc3dpdGNoIHRvLgogICAgKiBAcGFyYW0gYXV0b1N0YXJ0IHtib29sZWFufSAtIFN0YXJ0IHRoZSBzdGF0ZSBpbW1lZGlhdGVseSBhZnRlciBjcmVhdGluZyBpdD8gKGRlZmF1bHQgdHJ1ZSkKICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChrZXksIHN0YXRlLCBhdXRvU3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBhdXRvU3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IGF1dG9TdGFydCA9IGZhbHNlOyB9CgoJCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLmFkZFN0YXRlJywga2V5KTsKCQkvLyBjb25zb2xlLmxvZyh0eXBlb2Ygc3RhdGUpOwoJCS8vIGNvbnNvbGUubG9nKCdhdXRvU3RhcnQ/JywgYXV0b1N0YXJ0KTsKCgkJdmFyIG5ld1N0YXRlOwoKCQlpZiAoc3RhdGUgaW5zdGFuY2VvZiBQaGFzZXIuU3RhdGUpCgkJewoJCQkvLyBjb25zb2xlLmxvZygnUGhhc2VyLlN0YXRlTWFuYWdlci5hZGRTdGF0ZTogUGhhc2VyLlN0YXRlIGdpdmVuJyk7CgkJCW5ld1N0YXRlID0gc3RhdGU7CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gJ29iamVjdCcpCgkJewoJCQkvLyBjb25zb2xlLmxvZygnUGhhc2VyLlN0YXRlTWFuYWdlci5hZGRTdGF0ZTogT2JqZWN0IGdpdmVuJyk7CgkJCW5ld1N0YXRlID0gc3RhdGU7CgkJCW5ld1N0YXRlLmdhbWUgPSB0aGlzLmdhbWU7CgkJfQoJCWVsc2UgaWYgKHR5cGVvZiBzdGF0ZSA9PT0gJ2Z1bmN0aW9uJykKCQl7CgkJCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLmFkZFN0YXRlOiBGdW5jdGlvbiBnaXZlbicpOwoJCQluZXdTdGF0ZSA9IG5ldyBzdGF0ZSh0aGlzLmdhbWUpOwoJCX0KCgkJdGhpcy5zdGF0ZXNba2V5XSA9IG5ld1N0YXRlOwoKCQlpZiAoYXV0b1N0YXJ0KQoJCXsKCQkJaWYgKHRoaXMuZ2FtZS5pc0Jvb3RlZCkKCQkJewoJCQkJLy8gY29uc29sZS5sb2coJ0dhbWUgaXMgYm9vdGVkLCBzbyB3ZSBjYW4gc3RhcnQgdGhlIHN0YXRlIG5vdycpOwoJCQkJdGhpcy5zdGFydChrZXkpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8gY29uc29sZS5sb2coJ0dhbWUgaXMgTk9UIGJvb3RlZCwgc28gc2V0IHRoZSBjdXJyZW50IHN0YXRlIGFzIHBlbmRpbmcnKTsKCQkJCXRoaXMuX3BlbmRpbmdTdGF0ZSA9IGtleTsKCQkJfQoJCX0KCgkJcmV0dXJuIG5ld1N0YXRlOwoKICAgIH0sCgoJLyoqCiAgICAgKiBEZWxldGUgdGhlIGdpdmVuIHN0YXRlLgogICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3JlbW92ZQogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEEgdW5pcXVlIGtleSB5b3UgdXNlIHRvIHJlZmVyZW5jZSB0aGlzIHN0YXRlLCBpLmUuICJNYWluTWVudSIsICJMZXZlbDEiLgogICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAJaWYgKHRoaXMuY3VycmVudCA9PSBrZXkpCiAgICAJewoJICAgICAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CgoJICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vblNodXREb3duQ2FsbGJhY2sgPSBudWxsOwoKCSAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjayA9IG51bGw7CgkgICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vblBhdXNlZENhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vbkRlc3Ryb3lDYWxsYmFjayA9IG51bGw7CiAgICAJfQoKICAgIAlkZWxldGUgdGhpcy5zdGF0ZXNba2V5XTsKCiAgICB9LAoKCS8qKgogICAgKiBTdGFydCB0aGUgZ2l2ZW4gc3RhdGUKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3N0YXJ0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoZSBzdGF0ZSB5b3Ugd2FudCB0byBzdGFydC4KICAgICogQHBhcmFtIHtib29sZWFufSBbY2xlYXJXb3JsZF0gLSBjbGVhciBldmVyeXRoaW5nIGluIHRoZSB3b3JsZD8gKERlZmF1bHQgdG8gdHJ1ZSkKICAgICogQHBhcmFtIHtib29sZWFufSBbY2xlYXJDYWNoZV0gLSBjbGVhciBhc3NldCBjYWNoZT8gKERlZmF1bHQgdG8gZmFsc2UgYW5kIE9OTFkgYXZhaWxhYmxlIHdoZW4gY2xlYXJXb3JsZD10cnVlKQogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoa2V5LCBjbGVhcldvcmxkLCBjbGVhckNhY2hlKSB7CgogICAgCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLnN0YXJ0Jywga2V5KTsKICAgIAkvLyBjb25zb2xlLmxvZyh0aGlzKTsKICAgIAkvLyBjb25zb2xlLmxvZyh0aGlzLmNhbGxiYWNrQ29udGV4dCk7CgogICAgICAgIGlmICh0eXBlb2YgY2xlYXJXb3JsZCA9PT0gInVuZGVmaW5lZCIpIHsgY2xlYXJXb3JsZCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIGNsZWFyQ2FjaGUgPT09ICJ1bmRlZmluZWQiKSB7IGNsZWFyQ2FjaGUgPSBmYWxzZTsgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlzQm9vdGVkID09IGZhbHNlKQogICAgICAgIHsKCQkJLy8gY29uc29sZS5sb2coJ0dhbWUgaXMgTk9UIGJvb3RlZCwgc28gc2V0IHRoZSByZXF1ZXN0ZWQgc3RhdGUgYXMgcGVuZGluZycpOwoJCQl0aGlzLl9wZW5kaW5nU3RhdGUgPSBrZXk7CgkJCXJldHVybjsKICAgICAgICB9CgoJCWlmICh0aGlzLmNoZWNrU3RhdGUoa2V5KSA9PSBmYWxzZSkKCQl7CgkJCXJldHVybjsKCQl9CgkJZWxzZQoJCXsKCQkJLy8JQWxyZWFkeSBnb3QgYSBzdGF0ZSBydW5uaW5nPwoJCQlpZiAodGhpcy5jdXJyZW50KQoJCQl7CgkJCQl0aGlzLm9uU2h1dERvd25DYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwoJCQl9CgoJICAgICAgICBpZiAoY2xlYXJXb3JsZCkKCSAgICAgICAgewoJCQkJdGhpcy5nYW1lLnR3ZWVucy5yZW1vdmVBbGwoKTsKCgkgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQuZGVzdHJveSgpOwoKCSAgICAgICAgICAgIGlmIChjbGVhckNhY2hlID09IHRydWUpCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLmRlc3Ryb3koKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCQkJdGhpcy5zZXRDdXJyZW50U3RhdGUoa2V5KTsKCQl9CgogICAgICAgIGlmICh0aGlzLm9uUHJlbG9hZENhbGxiYWNrKQogICAgICAgIHsKCSAgICAJLy8gY29uc29sZS5sb2coJ1ByZWxvYWQgQ2FsbGJhY2sgZm91bmQnKTsKICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWQucmVzZXQoKTsKICAgICAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwoKICAgICAgICAgICAgLy8gIElzIHRoZSBsb2FkZXIgZW1wdHk/CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUubG9hZC5xdWV1ZVNpemUgPT0gMCkKICAgICAgICAgICAgewoJCSAgICAJLy8gY29uc29sZS5sb2coJ0xvYWRlciBxdWV1ZSBlbXB0eScpOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWRDb21wbGV0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewoJCSAgICAJLy8gY29uc29sZS5sb2coJ0xvYWRlciBzdGFydGVkJyk7CiAgICAgICAgICAgICAgICAvLyAgU3RhcnQgdGhlIGxvYWRlciBnb2luZyBhcyB3ZSBoYXZlIHNvbWV0aGluZyBpbiB0aGUgcXVldWUKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5sb2FkLnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKCQkJLy8gY29uc29sZS5sb2coJ1ByZWxvYWQgY2FsbGJhY2sgbm90IGZvdW5kJyk7CiAgICAgICAgICAgIC8vICBObyBpbml0PyBUaGVuIHRoZXJlIHdhcyBub3RoaW5nIHRvIGxvYWQgZWl0aGVyCiAgICAgICAgICAgIHRoaXMuZ2FtZS5sb2FkQ29tcGxldGUoKTsKICAgICAgICB9CgogICAgfSwKCQoJLyoqCgkqIFVzZWQgYnkgb25Jbml0IGFuZCBvblNodXRkb3duIHdoZW4gdGhvc2UgZnVuY3Rpb25zIGRvbid0IGV4aXN0IG9uIHRoZSBzdGF0ZQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjZHVtbXkKICAgICogQHByaXZhdGUKICAgICovCiAgICBkdW1teTogZnVuY3Rpb24gKCkgewogICAgfSwKCgkvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNjaGVja1N0YXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUga2V5IG9mIHRoZSBzdGF0ZSB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgY2hlY2tTdGF0ZTogZnVuY3Rpb24gKGtleSkgewoKCQlpZiAodGhpcy5zdGF0ZXNba2V5XSkKCQl7CgkJCXZhciB2YWxpZCA9IGZhbHNlOwoKCQkJaWYgKHRoaXMuc3RhdGVzW2tleV1bJ3ByZWxvYWQnXSkgeyB2YWxpZCA9IHRydWU7IH0KCgkJCWlmICh2YWxpZCA9PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydsb2FkUmVuZGVyJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgkJCWlmICh2YWxpZCA9PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydsb2FkVXBkYXRlJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgkJCWlmICh2YWxpZCA9PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydjcmVhdGUnXSkgeyB2YWxpZCA9IHRydWU7IH0KCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ3VwZGF0ZSddKSB7IHZhbGlkID0gdHJ1ZTsgfQoJCQlpZiAodmFsaWQgPT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsncHJlUmVuZGVyJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgkJCWlmICh2YWxpZCA9PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydyZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ3BhdXNlZCddKSB7IHZhbGlkID0gdHJ1ZTsgfQoKICAgICAgICAJaWYgKHZhbGlkID09IGZhbHNlKQogICAgICAgIAl7CgkgICAgICAgICAgICBjb25zb2xlLndhcm4oIkludmFsaWQgUGhhc2VyIFN0YXRlIG9iamVjdCBnaXZlbi4gTXVzdCBjb250YWluIGF0IGxlYXN0IGEgb25lIG9mIHRoZSByZXF1aXJlZCBmdW5jdGlvbnMuIik7CgkgICAgICAgICAgICByZXR1cm4gZmFsc2U7CgkgICAgICAgIH0KCgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlCgkJewoJCQljb25zb2xlLndhcm4oIlBoYXNlci5TdGF0ZU1hbmFnZXIgLSBObyBzdGF0ZSBmb3VuZCB3aXRoIHRoZSBrZXk6ICIgKyBrZXkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKICAgIH0sCgoJLyoqCiAgICAqIExpbmtzIGdhbWUgcHJvcGVydGllcyB0byB0aGUgU3RhdGUgZ2l2ZW4gYnkgdGhlIGtleS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2xpbmsKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFN0YXRlIGtleS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGxpbms6IGZ1bmN0aW9uIChrZXkpIHsKCgkJLy8gY29uc29sZS5sb2coJ2xpbmtlZCcpOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uZ2FtZSA9IHRoaXMuZ2FtZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmFkZCA9IHRoaXMuZ2FtZS5hZGQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5jYW1lcmEgPSB0aGlzLmdhbWUuY2FtZXJhOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uY2FjaGUgPSB0aGlzLmdhbWUuY2FjaGU7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5pbnB1dCA9IHRoaXMuZ2FtZS5pbnB1dDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmxvYWQgPSB0aGlzLmdhbWUubG9hZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLm1hdGggPSB0aGlzLmdhbWUubWF0aDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnNvdW5kID0gdGhpcy5nYW1lLnNvdW5kOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uc3RhZ2UgPSB0aGlzLmdhbWUuc3RhZ2U7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS50aW1lID0gdGhpcy5nYW1lLnRpbWU7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS50d2VlbnMgPSB0aGlzLmdhbWUudHdlZW5zOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ud29ybGQgPSB0aGlzLmdhbWUud29ybGQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5wYXJ0aWNsZXMgPSB0aGlzLmdhbWUucGFydGljbGVzOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ucGh5c2ljcyA9IHRoaXMuZ2FtZS5waHlzaWNzOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ucm5kID0gdGhpcy5nYW1lLnJuZDsKCiAgICB9LAoKCS8qKgogICAgKiBTZXRzIHRoZSBjdXJyZW50IFN0YXRlLiBTaG91bGQgbm90IGJlIGNhbGxlZCBkaXJlY3RseSAodXNlIFN0YXRlTWFuYWdlci5zdGFydCkKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3NldEN1cnJlbnRTdGF0ZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gU3RhdGUga2V5LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJc2V0Q3VycmVudFN0YXRlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5zdGF0ZXNba2V5XTsKCiAgICAgICAgdGhpcy5saW5rKGtleSk7CgogICAgICAgIC8vCVVzZWQgd2hlbiB0aGUgc3RhdGUgaXMgc2V0IGFzIGJlaW5nIHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZQogICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydpbml0J10gfHwgdGhpcy5kdW1teTsKCiAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3ByZWxvYWQnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydsb2FkUmVuZGVyJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnbG9hZFVwZGF0ZSddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnY3JlYXRlJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uVXBkYXRlQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWyd1cGRhdGUnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25QcmVSZW5kZXJDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3ByZVJlbmRlciddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vblJlbmRlckNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsncmVuZGVyJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydwYXVzZWQnXSB8fCBudWxsOwoKICAgICAgICAvLwlVc2VkIHdoZW4gdGhlIHN0YXRlIGlzIG5vIGxvbmdlciB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUKICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3NodXRkb3duJ10gfHwgdGhpcy5kdW1teTsKCgkJdGhpcy5jdXJyZW50ID0ga2V5OwoJCXRoaXMuX2NyZWF0ZWQgPSBmYWxzZTsKCgkJdGhpcy5vbkluaXRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwoKCX0sCgoJLyoqCgkqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNsb2FkQ29tcGxldGUKICAgICogQHByb3RlY3RlZAoJKi8KICAgIGxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKCkgewoKCQkvLyBjb25zb2xlLmxvZygnUGhhc2VyLlN0YXRlTWFuYWdlci5sb2FkQ29tcGxldGUnKTsKCiAgICAgICAgaWYgKHRoaXMuX2NyZWF0ZWQgPT0gZmFsc2UgJiYgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrKQogICAgICAgIHsKCQkJLy8gY29uc29sZS5sb2coJ0NyZWF0ZSBjYWxsYmFjayBmb3VuZCcpOwoJICAgICAgICB0aGlzLl9jcmVhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CgkgICAgICAgIHRoaXMuX2NyZWF0ZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKCSovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAJaWYgKHRoaXMuX2NyZWF0ZWQgJiYgdGhpcy5vblVwZGF0ZUNhbGxiYWNrKQogICAgCXsKCQkJdGhpcy5vblVwZGF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CiAgICAJfQogICAgCWVsc2UKICAgIAl7CgkJICAgIGlmICh0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrKQoJCSAgICB7CgkJICAgIAl0aGlzLm9uTG9hZFVwZGF0ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgkJCX0KCQl9CgogICAgfSwKCgkvKioKCSogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3ByZVJlbmRlcgogICAgKiBAcHJvdGVjdGVkCgkqLwogICAgcHJlUmVuZGVyOiBmdW5jdGlvbiAoKSB7CgoJICAgIGlmICh0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2spCgkgICAgewoJICAgIAl0aGlzLm9uUHJlUmVuZGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCQl9CgogICAgfSwKCgkvKioKCSogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI3JlbmRlcgogICAgKiBAcHJvdGVjdGVkCgkqLwogICAgcmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgCWlmICh0aGlzLl9jcmVhdGVkICYmIHRoaXMub25SZW5kZXJDYWxsYmFjaykKICAgIAl7CiAgICAJCWlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkNBTlZBUykKICAgIAkJewoJCSAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQuc2F2ZSgpOwoJCSAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgCQl9CgoJCQl0aGlzLm9uUmVuZGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCiAgICAJCWlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkNBTlZBUykKICAgIAkJewoJCSAgICAgICAgdGhpcy5nYW1lLmNvbnRleHQucmVzdG9yZSgpOwogICAgCQl9CQkJCiAgICAJfQogICAgCWVsc2UKICAgIAl7CgkJICAgIGlmICh0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrKQoJCSAgICB7CgkJICAgIAl0aGlzLm9uTG9hZFJlbmRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgkJCX0KCQl9CgogICAgfSwKCgkvKioKICAgICogTnVrZSB0aGUgZW50aXJlIGdhbWUgZnJvbSBvcmJpdAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSBudWxsOwoKICAgICAgICB0aGlzLm9uSW5pdENhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IG51bGw7CgogICAgICAgIHRoaXMub25QcmVsb2FkQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25DcmVhdGVDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vblVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25QYXVzZWRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vbkRlc3Ryb3lDYWxsYmFjayA9IG51bGw7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5zdGF0ZXMgPSB7fTsKICAgICAgICB0aGlzLl9wZW5kaW5nU3RhdGUgPSBudWxsOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGJhc2ljIGxpbmtlZCBsaXN0IGRhdGEgc3RydWN0dXJlLgoqCiogQGNsYXNzIFBoYXNlci5MaW5rZWRMaXN0CiogQGNvbnN0cnVjdG9yCiovClBoYXNlci5MaW5rZWRMaXN0ID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gbmV4dCAtIE5leHQgZWxlbWVudCBpbiB0aGUgbGlzdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLm5leHQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gcHJldiAtIFByZXZpb3VzIGVsZW1lbnQgaW4gdGhlIGxpc3QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5wcmV2ID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IGZpcnN0IC0gRmlyc3QgZWxlbWVudCBpbiB0aGUgbGlzdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmZpcnN0ID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IGxhc3QgLSBMYXN0IGVsZW1lbnQgaW4gdGhlIGxpc3QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5sYXN0ID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBnYW1lIC0gTnVtYmVyIG9mIGVsZW1lbnRzIGluIHRoZSBsaXN0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudG90YWwgPSAwOwoKfTsKClBoYXNlci5MaW5rZWRMaXN0LnByb3RvdHlwZSA9IHsKCgkvKioKICAgICogQWRkcyBhIG5ldyBlbGVtZW50IHRvIHRoaXMgbGlua2VkIGxpc3QuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5MaW5rZWRMaXN0I2FkZAoJKiBAcGFyYW0ge29iamVjdH0gY2hpbGQgLSBUaGUgZWxlbWVudCB0byBhZGQgdG8gdGhpcyBsaXN0LiBDYW4gYmUgYSBQaGFzZXIuU3ByaXRlIG9yIGFueSBvdGhlciBvYmplY3QgeW91IG5lZWQgdG8gcXVpY2tseSBpdGVyYXRlIHRocm91Z2guCgkqIEByZXR1cm4ge29iamVjdH0gVGhlIGNoaWxkIHRoYXQgd2FzIGFkZGVkLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgCS8vCUlmIHRoZSBsaXN0IGlzIGVtcHR5CiAgICAJaWYgKHRoaXMudG90YWwgPT0gMCAmJiB0aGlzLmZpcnN0ID09IG51bGwgJiYgdGhpcy5sYXN0ID09IG51bGwpCiAgICAJewogICAgCQl0aGlzLmZpcnN0ID0gY2hpbGQ7CiAgICAJCXRoaXMubGFzdCA9IGNoaWxkOwoJICAgIAl0aGlzLm5leHQgPSBjaGlsZDsKCSAgICAJY2hpbGQucHJldiA9IHRoaXM7CgkgICAgCXRoaXMudG90YWwrKzsKICAgIAkJcmV0dXJuIGNoaWxkOwogICAgCX0KCiAgICAJLy8JR2V0IGdldHMgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiB0aGUgbGlzdCwgcmVnYXJkbGVzcyBvZiBhbnl0aGluZywgYW5kIGl0IHdvbid0IGhhdmUgYW55IGNoaWxkcmVuIG9mIGl0cyBvd24gKG5vbi1uZXN0ZWQgbGlzdCkKICAgIAl0aGlzLmxhc3QubmV4dCA9IGNoaWxkOwoKICAgIAljaGlsZC5wcmV2ID0gdGhpcy5sYXN0OwoKICAgIAl0aGlzLmxhc3QgPSBjaGlsZDsKCgkJdGhpcy50b3RhbCsrOwoKCQlyZXR1cm4gY2hpbGQ7CgogICAgfSwKCgkvKioKICAgICogUmVtb3ZlcyB0aGUgZ2l2ZW4gZWxlbWVudCBmcm9tIHRoaXMgbGlua2VkIGxpc3QgaWYgaXQgZXhpc3RzLgogCSogCiAJKiBAbWV0aG9kIFBoYXNlci5MaW5rZWRMaXN0I3JlbW92ZQogCSogQHBhcmFtIHtvYmplY3R9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgbGlzdC4KICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChjaGlsZCkgewoKICAgIAlpZiAoY2hpbGQgPT0gdGhpcy5maXJzdCkKICAgIAl7CgkJCS8vIEl0IHdhcyAnZmlyc3QnLCBtYWtlICdmaXJzdCcgcG9pbnQgdG8gZmlyc3QubmV4dAogICAgCQl0aGlzLmZpcnN0ID0gdGhpcy5maXJzdC5uZXh0OwogICAgCX0gICAgICAKCQllbHNlIGlmIChjaGlsZCA9PSB0aGlzLmxhc3QpCgkJewoJCQkvLyBJdCB3YXMgJ2xhc3QnLCBtYWtlICdsYXN0JyBwb2ludCB0byBsYXN0LnByZXYKCQkJdGhpcy5sYXN0ID0gdGhpcy5sYXN0LnByZXY7CgkJfSAKCgkJaWYgKGNoaWxkLnByZXYpCgkJewoJCQkvLyBtYWtlIGNoaWxkLnByZXYubmV4dCBwb2ludCB0byBjaGlsZHMubmV4dCBpbnN0ZWFkIG9mIGNoaWxkCgkJCWNoaWxkLnByZXYubmV4dCA9IGNoaWxkLm5leHQ7IAoJCX0gCgoJCWlmIChjaGlsZC5uZXh0KQoJCXsKCQkJLy8gbWFrZSBjaGlsZC5uZXh0LnByZXYgcG9pbnQgdG8gY2hpbGQucHJldiBpbnN0ZWFkIG9mIGNoaWxkCgkJCWNoaWxkLm5leHQucHJldiA9IGNoaWxkLnByZXY7CgkJfQoKCQljaGlsZC5uZXh0ID0gY2hpbGQucHJldiA9IG51bGw7CgoJCWlmICh0aGlzLmZpcnN0ID09IG51bGwgKQoJCXsKCQkJdGhpcy5sYXN0ID0gbnVsbDsKCQl9CgoJCXRoaXMudG90YWwtLTsKCiAgICB9LAoKCS8qKgogICAgKiBDYWxscyBhIGZ1bmN0aW9uIG9uIGFsbCBtZW1iZXJzIG9mIHRoaXMgbGlzdCwgdXNpbmcgdGhlIG1lbWJlciBhcyB0aGUgY29udGV4dCBmb3IgdGhlIGNhbGxiYWNrLgogICAgKiBUaGUgZnVuY3Rpb24gbXVzdCBleGlzdCBvbiB0aGUgbWVtYmVyLgogIAkqIAogIAkqIEBtZXRob2QgUGhhc2VyLkxpbmtlZExpc3QjY2FsbEFsbAogIAkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRvIGNhbGwuCiAgICAqLwogICAgY2FsbEFsbDogZnVuY3Rpb24gKGNhbGxiYWNrKSB7CgogICAgCWlmICghdGhpcy5maXJzdCB8fCAhdGhpcy5sYXN0KQogICAgCXsKICAgIAkJcmV0dXJuOwogICAgCX0KCgkJdmFyIGVudGl0eSA9IHRoaXMuZmlyc3Q7CgkJCgkJZG8JCgkJewoJCQlpZiAoZW50aXR5ICYmIGVudGl0eVtjYWxsYmFja10pCgkJCXsKCQkJCWVudGl0eVtjYWxsYmFja10uY2FsbChlbnRpdHkpOwoJCQl9CgoJCQllbnRpdHkgPSBlbnRpdHkubmV4dDsKCgkJfQoJCXdoaWxlKGVudGl0eSAhPSB0aGlzLmxhc3QubmV4dCkJCQkKCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlNpZ25hbAoqIEBjbGFzc2Rlc2MgQSBTaWduYWwgaXMgdXNlZCBmb3Igb2JqZWN0IGNvbW11bmljYXRpb24gdmlhIGEgY3VzdG9tIGJyb2FkY2FzdGVyIGluc3RlYWQgb2YgRXZlbnRzLgoqIEBhdXRob3IgTWlsbGVyIE1lZGVpcm9zIGh0dHA6Ly9taWxsZXJtZWRlaXJvcy5naXRodWIuY29tL2pzLXNpZ25hbHMvCiogQGNvbnN0cnVjdG9yCiovClBoYXNlci5TaWduYWwgPSBmdW5jdGlvbiAoKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7QXJyYXkuPFBoYXNlci5TaWduYWxCaW5kaW5nPn0gX2JpbmRpbmdzIC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5fYmluZGluZ3MgPSBbXTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9wcmV2UGFyYW1zIC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5fcHJldlBhcmFtcyA9IG51bGw7CgoJLy8gZW5mb3JjZSBkaXNwYXRjaCB0byBhd2F5cyB3b3JrIG9uIHNhbWUgY29udGV4dCAoIzQ3KQoJdmFyIHNlbGYgPSB0aGlzOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBkaXNwYXRjaCAtIERlc2NyaXB0aW9uLgoJKi8KCXRoaXMuZGlzcGF0Y2ggPSBmdW5jdGlvbigpewoJCVBoYXNlci5TaWduYWwucHJvdG90eXBlLmRpc3BhdGNoLmFwcGx5KHNlbGYsIGFyZ3VtZW50cyk7Cgl9OwoKfTsKClBoYXNlci5TaWduYWwucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBJZiBTaWduYWwgc2hvdWxkIGtlZXAgcmVjb3JkIG9mIHByZXZpb3VzbHkgZGlzcGF0Y2hlZCBwYXJhbWV0ZXJzIGFuZAoJKiBhdXRvbWF0aWNhbGx5IGV4ZWN1dGUgbGlzdGVuZXIgZHVyaW5nIGBhZGQoKWAvYGFkZE9uY2UoKWAgaWYgU2lnbmFsIHdhcwoJKiBhbHJlYWR5IGRpc3BhdGNoZWQgYmVmb3JlLgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IG1lbW9yaXplCgkqLwoJbWVtb3JpemU6IGZhbHNlLAoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IF9zaG91bGRQcm9wYWdhdGUgCgkqIEBwcml2YXRlCgkqLwoJX3Nob3VsZFByb3BhZ2F0ZTogdHJ1ZSwKCgkvKioKCSogSWYgU2lnbmFsIGlzIGFjdGl2ZSBhbmQgc2hvdWxkIGJyb2FkY2FzdCBldmVudHMuCgkqIDxwPjxzdHJvbmc+SU1QT1JUQU5UOjwvc3Ryb25nPiBTZXR0aW5nIHRoaXMgcHJvcGVydHkgZHVyaW5nIGEgZGlzcGF0Y2ggd2lsbCBvbmx5IGFmZmVjdCB0aGUgbmV4dCBkaXNwYXRjaCwgaWYgeW91IHdhbnQgdG8gc3RvcCB0aGUgcHJvcGFnYXRpb24gb2YgYSBzaWduYWwgdXNlIGBoYWx0KClgIGluc3RlYWQuPC9wPgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZQogICAgKiBAZGVmYXVsdAogICAgKi8KCWFjdGl2ZTogdHJ1ZSwKCgkvKioKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3ZhbGlkYXRlTGlzdGVuZXIKCSogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gZm5OYW1lIC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCiAgICAqLwoJdmFsaWRhdGVMaXN0ZW5lcjogZnVuY3Rpb24gKGxpc3RlbmVyLCBmbk5hbWUpIHsKCQlpZiAodHlwZW9mIGxpc3RlbmVyICE9PSAnZnVuY3Rpb24nKSB7CgkJCXRocm93IG5ldyBFcnJvciggJ2xpc3RlbmVyIGlzIGEgcmVxdWlyZWQgcGFyYW0gb2Yge2ZufSgpIGFuZCBzaG91bGQgYmUgYSBGdW5jdGlvbi4nLnJlcGxhY2UoJ3tmbn0nLCBmbk5hbWUpICk7CgkJfQoJfSwKCgkvKioKCSAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNfcmVnaXN0ZXJMaXN0ZW5lcgoJICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNPbmNlIC0gRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gLSBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIC0gVGhlIHByaW9yaXR5IGxldmVsIG9mIHRoZSBldmVudCBsaXN0ZW5lci4gTGlzdGVuZXJzIHdpdGggaGlnaGVyIHByaW9yaXR5IHdpbGwgYmUgZXhlY3V0ZWQgYmVmb3JlIGxpc3RlbmVycyB3aXRoIGxvd2VyIHByaW9yaXR5LiBMaXN0ZW5lcnMgd2l0aCBzYW1lIHByaW9yaXR5IGxldmVsIHdpbGwgYmUgZXhlY3V0ZWQgYXQgdGhlIHNhbWUgb3JkZXIgYXMgdGhleSB3ZXJlIGFkZGVkLiAoZGVmYXVsdCA9IDApLgoJICogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KCSAqIEBwcml2YXRlCgkgKi8KCV9yZWdpc3Rlckxpc3RlbmVyOiBmdW5jdGlvbiAobGlzdGVuZXIsIGlzT25jZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSkgewoKCQl2YXIgcHJldkluZGV4ID0gdGhpcy5faW5kZXhPZkxpc3RlbmVyKGxpc3RlbmVyLCBsaXN0ZW5lckNvbnRleHQpLAoJCQliaW5kaW5nOwoKCQlpZiAocHJldkluZGV4ICE9PSAtMSkgewoJCQliaW5kaW5nID0gdGhpcy5fYmluZGluZ3NbcHJldkluZGV4XTsKCQkJaWYgKGJpbmRpbmcuaXNPbmNlKCkgIT09IGlzT25jZSkgewoJCQkJdGhyb3cgbmV3IEVycm9yKCdZb3UgY2Fubm90IGFkZCcrIChpc09uY2U/ICcnIDogJ09uY2UnKSArJygpIHRoZW4gYWRkJysgKCFpc09uY2U/ICcnIDogJ09uY2UnKSArJygpIHRoZSBzYW1lIGxpc3RlbmVyIHdpdGhvdXQgcmVtb3ZpbmcgdGhlIHJlbGF0aW9uc2hpcCBmaXJzdC4nKTsKCQkJfQoJCX0gZWxzZSB7CgkJCWJpbmRpbmcgPSBuZXcgUGhhc2VyLlNpZ25hbEJpbmRpbmcodGhpcywgbGlzdGVuZXIsIGlzT25jZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSk7CgkJCXRoaXMuX2FkZEJpbmRpbmcoYmluZGluZyk7CgkJfQoKCQlpZiAodGhpcy5tZW1vcml6ZSAmJiB0aGlzLl9wcmV2UGFyYW1zKXsKCQkJYmluZGluZy5leGVjdXRlKHRoaXMuX3ByZXZQYXJhbXMpOwoJCX0KCgkJcmV0dXJuIGJpbmRpbmc7Cgl9LAoKCS8qKgoJICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19hZGRCaW5kaW5nIAoJICogQHBhcmFtIHtQaGFzZXIuU2lnbmFsQmluZGluZ30gYmluZGluZyAtIEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KCSAqIEBwcml2YXRlCgkgKi8KCV9hZGRCaW5kaW5nOiBmdW5jdGlvbiAoYmluZGluZykgewoJCS8vc2ltcGxpZmllZCBpbnNlcnRpb24gc29ydAoJCXZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwoJCWRvIHsgLS1uOyB9IHdoaWxlICh0aGlzLl9iaW5kaW5nc1tuXSAmJiBiaW5kaW5nLl9wcmlvcml0eSA8PSB0aGlzLl9iaW5kaW5nc1tuXS5fcHJpb3JpdHkpOwoJCXRoaXMuX2JpbmRpbmdzLnNwbGljZShuICsgMSwgMCwgYmluZGluZyk7Cgl9LAoKCS8qKgoJICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19pbmRleE9mTGlzdGVuZXIKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCgkgKiBAcmV0dXJuIHtudW1iZXJ9IERlc2NyaXB0aW9uLgoJICogQHByaXZhdGUKCSAqLwoJX2luZGV4T2ZMaXN0ZW5lcjogZnVuY3Rpb24gKGxpc3RlbmVyLCBjb250ZXh0KSB7CgkJdmFyIG4gPSB0aGlzLl9iaW5kaW5ncy5sZW5ndGgsCgkJCWN1cjsKCQl3aGlsZSAobi0tKSB7CgkJCWN1ciA9IHRoaXMuX2JpbmRpbmdzW25dOwoJCQlpZiAoY3VyLl9saXN0ZW5lciA9PT0gbGlzdGVuZXIgJiYgY3VyLmNvbnRleHQgPT09IGNvbnRleHQpIHsKCQkJCXJldHVybiBuOwoJCQl9CgkJfQoJCXJldHVybiAtMTsKCX0sCgoJLyoqCgkgKiBDaGVjayBpZiBsaXN0ZW5lciB3YXMgYXR0YWNoZWQgdG8gU2lnbmFsLgoJICogCgkgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjaGFzCgkgKiBAcGFyYW0ge0Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtPYmplY3R9IFtjb250ZXh0XSAtIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCgkgKiBAcmV0dXJuIHtib29sZWFufSBJZiBTaWduYWwgaGFzIHRoZSBzcGVjaWZpZWQgbGlzdGVuZXIuCgkgKi8KCWhhczogZnVuY3Rpb24gKGxpc3RlbmVyLCBjb250ZXh0KSB7CgkJcmV0dXJuIHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lciwgY29udGV4dCkgIT09IC0xOwoJfSwKCgkvKioKCSAqIEFkZCBhIGxpc3RlbmVyIHRvIHRoZSBzaWduYWwuCgkgKiAKCSAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNhZGQKCSAqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KCSAqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIExpc3RlbmVycyB3aXRoIGhpZ2hlciBwcmlvcml0eSB3aWxsIGJlIGV4ZWN1dGVkIGJlZm9yZSBsaXN0ZW5lcnMgd2l0aCBsb3dlciBwcmlvcml0eS4gTGlzdGVuZXJzIHdpdGggc2FtZSBwcmlvcml0eSBsZXZlbCB3aWxsIGJlIGV4ZWN1dGVkIGF0IHRoZSBzYW1lIG9yZGVyIGFzIHRoZXkgd2VyZSBhZGRlZC4gKGRlZmF1bHQgPSAwKS4KCSAqIEByZXR1cm4ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBBbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBiaW5kaW5nIGJldHdlZW4gdGhlIFNpZ25hbCBhbmQgbGlzdGVuZXIuCgkgKi8KCWFkZDogZnVuY3Rpb24gKGxpc3RlbmVyLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgkJdGhpcy52YWxpZGF0ZUxpc3RlbmVyKGxpc3RlbmVyLCAnYWRkJyk7CgkJcmV0dXJuIHRoaXMuX3JlZ2lzdGVyTGlzdGVuZXIobGlzdGVuZXIsIGZhbHNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KTsKCX0sCgoJLyoqCgkqIEFkZCBsaXN0ZW5lciB0byB0aGUgc2lnbmFsIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQgYWZ0ZXIgZmlyc3QgZXhlY3V0aW9uICh3aWxsIGJlIGV4ZWN1dGVkIG9ubHkgb25jZSkuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNhZGRPbmNlCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgoJKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KCSogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eV0gVGhlIHByaW9yaXR5IGxldmVsIG9mIHRoZSBldmVudCBsaXN0ZW5lci4gTGlzdGVuZXJzIHdpdGggaGlnaGVyIHByaW9yaXR5IHdpbGwgYmUgZXhlY3V0ZWQgYmVmb3JlIGxpc3RlbmVycyB3aXRoIGxvd2VyIHByaW9yaXR5LiBMaXN0ZW5lcnMgd2l0aCBzYW1lIHByaW9yaXR5IGxldmVsIHdpbGwgYmUgZXhlY3V0ZWQgYXQgdGhlIHNhbWUgb3JkZXIgYXMgdGhleSB3ZXJlIGFkZGVkLiAoZGVmYXVsdCA9IDApCgkqIEByZXR1cm4ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBBbiBPYmplY3QgcmVwcmVzZW50aW5nIHRoZSBiaW5kaW5nIGJldHdlZW4gdGhlIFNpZ25hbCBhbmQgbGlzdGVuZXIuCgkqLwoJYWRkT25jZTogZnVuY3Rpb24gKGxpc3RlbmVyLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgkJdGhpcy52YWxpZGF0ZUxpc3RlbmVyKGxpc3RlbmVyLCAnYWRkT25jZScpOwoJCXJldHVybiB0aGlzLl9yZWdpc3Rlckxpc3RlbmVyKGxpc3RlbmVyLCB0cnVlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KTsKCX0sCgoJLyoqCgkqIFJlbW92ZSBhIHNpbmdsZSBsaXN0ZW5lciBmcm9tIHRoZSBkaXNwYXRjaCBxdWV1ZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3JlbW92ZQoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciBIYW5kbGVyIGZ1bmN0aW9uIHRoYXQgc2hvdWxkIGJlIHJlbW92ZWQuCgkqIEBwYXJhbSB7b2JqZWN0fSBbY29udGV4dF0gRXhlY3V0aW9uIGNvbnRleHQgKHNpbmNlIHlvdSBjYW4gYWRkIHRoZSBzYW1lIGhhbmRsZXIgbXVsdGlwbGUgdGltZXMgaWYgZXhlY3V0aW5nIGluIGEgZGlmZmVyZW50IGNvbnRleHQpLgoJKiBAcmV0dXJuIHtmdW5jdGlvbn0gTGlzdGVuZXIgaGFuZGxlciBmdW5jdGlvbi4KCSovCglyZW1vdmU6IGZ1bmN0aW9uIChsaXN0ZW5lciwgY29udGV4dCkgewoKCQl0aGlzLnZhbGlkYXRlTGlzdGVuZXIobGlzdGVuZXIsICdyZW1vdmUnKTsKCgkJdmFyIGkgPSB0aGlzLl9pbmRleE9mTGlzdGVuZXIobGlzdGVuZXIsIGNvbnRleHQpOwoKCQlpZiAoaSAhPT0gLTEpCgkJewoJCQl0aGlzLl9iaW5kaW5nc1tpXS5fZGVzdHJveSgpOyAvL25vIHJlYXNvbiB0byBhIFBoYXNlci5TaWduYWxCaW5kaW5nIGV4aXN0IGlmIGl0IGlzbid0IGF0dGFjaGVkIHRvIGEgc2lnbmFsCgkJCXRoaXMuX2JpbmRpbmdzLnNwbGljZShpLCAxKTsKCQl9CgoJCXJldHVybiBsaXN0ZW5lcjsKCgl9LAoKCS8qKgoJKiBSZW1vdmUgYWxsIGxpc3RlbmVycyBmcm9tIHRoZSBTaWduYWwuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNyZW1vdmVBbGwKCSovCglyZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCQl2YXIgbiA9IHRoaXMuX2JpbmRpbmdzLmxlbmd0aDsKCQl3aGlsZSAobi0tKSB7CgkJCXRoaXMuX2JpbmRpbmdzW25dLl9kZXN0cm95KCk7CgkJfQoJCXRoaXMuX2JpbmRpbmdzLmxlbmd0aCA9IDA7Cgl9LAoKCS8qKgoJKiBHZXRzIHRoZSB0b3RhbCBudW1iZXIgb2YgbGlzdGVuZXJlcyBhdHRhY2hlZCB0byB0aHMgU2lnbmFsLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZ2V0TnVtTGlzdGVuZXJzCgkqIEByZXR1cm4ge251bWJlcn0gTnVtYmVyIG9mIGxpc3RlbmVycyBhdHRhY2hlZCB0byB0aGUgU2lnbmFsLgoJKi8KCWdldE51bUxpc3RlbmVyczogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLl9iaW5kaW5ncy5sZW5ndGg7Cgl9LAoKCS8qKgoJKiBTdG9wIHByb3BhZ2F0aW9uIG9mIHRoZSBldmVudCwgYmxvY2tpbmcgdGhlIGRpc3BhdGNoIHRvIG5leHQgbGlzdGVuZXJzIG9uIHRoZSBxdWV1ZS4KCSogPHA+PHN0cm9uZz5JTVBPUlRBTlQ6PC9zdHJvbmc+IHNob3VsZCBiZSBjYWxsZWQgb25seSBkdXJpbmcgc2lnbmFsIGRpc3BhdGNoLCBjYWxsaW5nIGl0IGJlZm9yZS9hZnRlciBkaXNwYXRjaCB3b24ndCBhZmZlY3Qgc2lnbmFsIGJyb2FkY2FzdC48L3A+CgkqIEBzZWUgU2lnbmFsLnByb3RvdHlwZS5kaXNhYmxlCgkqCgkqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNoYWx0CgkqLwoJaGFsdDogZnVuY3Rpb24gKCkgewoJCXRoaXMuX3Nob3VsZFByb3BhZ2F0ZSA9IGZhbHNlOwoJfSwKCgkvKioKCSogRGlzcGF0Y2gvQnJvYWRjYXN0IFNpZ25hbCB0byBhbGwgbGlzdGVuZXJzIGFkZGVkIHRvIHRoZSBxdWV1ZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2Rpc3BhdGNoCgkqIEBwYXJhbSB7YW55fSBbcGFyYW1zXSAtIFBhcmFtZXRlcnMgdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIGVhY2ggaGFuZGxlci4KCSovCglkaXNwYXRjaDogZnVuY3Rpb24gKHBhcmFtcykgewoJCWlmICghIHRoaXMuYWN0aXZlKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBwYXJhbXNBcnIgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpLAoJCQluID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoLAoJCQliaW5kaW5nczsKCgkJaWYgKHRoaXMubWVtb3JpemUpIHsKCQkJdGhpcy5fcHJldlBhcmFtcyA9IHBhcmFtc0FycjsKCQl9CgoJCWlmICghIG4pIHsKCQkJLy9zaG91bGQgY29tZSBhZnRlciBtZW1vcml6ZQoJCQlyZXR1cm47CgkJfQoKCQliaW5kaW5ncyA9IHRoaXMuX2JpbmRpbmdzLnNsaWNlKCk7IC8vY2xvbmUgYXJyYXkgaW4gY2FzZSBhZGQvcmVtb3ZlIGl0ZW1zIGR1cmluZyBkaXNwYXRjaAoJCXRoaXMuX3Nob3VsZFByb3BhZ2F0ZSA9IHRydWU7IC8vaW4gY2FzZSBgaGFsdGAgd2FzIGNhbGxlZCBiZWZvcmUgZGlzcGF0Y2ggb3IgZHVyaW5nIHRoZSBwcmV2aW91cyBkaXNwYXRjaC4KCgkJLy9leGVjdXRlIGFsbCBjYWxsYmFja3MgdW50aWwgZW5kIG9mIHRoZSBsaXN0IG9yIHVudGlsIGEgY2FsbGJhY2sgcmV0dXJucyBgZmFsc2VgIG9yIHN0b3BzIHByb3BhZ2F0aW9uCgkJLy9yZXZlcnNlIGxvb3Agc2luY2UgbGlzdGVuZXJzIHdpdGggaGlnaGVyIHByaW9yaXR5IHdpbGwgYmUgYWRkZWQgYXQgdGhlIGVuZCBvZiB0aGUgbGlzdAoJCWRvIHsgbi0tOyB9IHdoaWxlIChiaW5kaW5nc1tuXSAmJiB0aGlzLl9zaG91bGRQcm9wYWdhdGUgJiYgYmluZGluZ3Nbbl0uZXhlY3V0ZShwYXJhbXNBcnIpICE9PSBmYWxzZSk7Cgl9LAoKCS8qKgoJKiBGb3JnZXQgbWVtb3JpemVkIGFyZ3VtZW50cy4KCSogQHNlZSBTaWduYWwubWVtb3JpemUKCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2ZvcmdldAogCSovCglmb3JnZXQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5fcHJldlBhcmFtcyA9IG51bGw7Cgl9LAoKCS8qKgoJKiBSZW1vdmUgYWxsIGJpbmRpbmdzIGZyb20gc2lnbmFsIGFuZCBkZXN0cm95IGFueSByZWZlcmVuY2UgdG8gZXh0ZXJuYWwgb2JqZWN0cyAoZGVzdHJveSBTaWduYWwgb2JqZWN0KS4KCSogPHA+PHN0cm9uZz5JTVBPUlRBTlQ6PC9zdHJvbmc+IGNhbGxpbmcgYW55IG1ldGhvZCBvbiB0aGUgc2lnbmFsIGluc3RhbmNlIGFmdGVyIGNhbGxpbmcgZGlzcG9zZSB3aWxsIHRocm93IGVycm9ycy48L3A+CgkqCgkqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNkaXNwb3NlCgkqLwoJZGlzcG9zZTogZnVuY3Rpb24gKCkgewoJCXRoaXMucmVtb3ZlQWxsKCk7CgkJZGVsZXRlIHRoaXMuX2JpbmRpbmdzOwoJCWRlbGV0ZSB0aGlzLl9wcmV2UGFyYW1zOwoJfSwKCgkvKioKCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3RvU3RyaW5nCgkqIEByZXR1cm4ge3N0cmluZ30gU3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvYmplY3QuCgkqLwoJdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gJ1tQaGFzZXIuU2lnbmFsIGFjdGl2ZTonKyB0aGlzLmFjdGl2ZSArJyBudW1MaXN0ZW5lcnM6JysgdGhpcy5nZXROdW1MaXN0ZW5lcnMoKSArJ10nOwoJfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5TaWduYWxCaW5kaW5nCioKKiBPYmplY3QgdGhhdCByZXByZXNlbnRzIGEgYmluZGluZyBiZXR3ZWVuIGEgU2lnbmFsIGFuZCBhIGxpc3RlbmVyIGZ1bmN0aW9uLgoqIDxiciAvPi0gPHN0cm9uZz5UaGlzIGlzIGFuIGludGVybmFsIGNvbnN0cnVjdG9yIGFuZCBzaG91bGRuJ3QgYmUgY2FsbGVkIGJ5IHJlZ3VsYXIgdXNlcnMuPC9zdHJvbmc+CiogPGJyIC8+LSBpbnNwaXJlZCBieSBKb2EgRWJlcnQgQVMzIFNpZ25hbEJpbmRpbmcgYW5kIFJvYmVydCBQZW5uZXIncyBTbG90IGNsYXNzZXMuCioKKiBAY2xhc3MgUGhhc2VyLlNpZ25hbEJpbmRpbmcKKiBAbmFtZSBTaWduYWxCaW5kaW5nCiogQGF1dGhvciBNaWxsZXIgTWVkZWlyb3MgaHR0cDovL21pbGxlcm1lZGVpcm9zLmdpdGh1Yi5jb20vanMtc2lnbmFscy8KKiBAY29uc3RydWN0b3IKKiBAaW5uZXIKKiBAcGFyYW0ge1NpZ25hbH0gc2lnbmFsIC0gUmVmZXJlbmNlIHRvIFNpZ25hbCBvYmplY3QgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCiogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCiogQHBhcmFtIHtib29sZWFufSBpc09uY2UgLSBJZiBiaW5kaW5nIHNob3VsZCBiZSBleGVjdXRlZCBqdXN0IG9uY2UuCiogQHBhcmFtIHtvYmplY3R9IFtsaXN0ZW5lckNvbnRleHRdIC0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSAtIFRoZSBwcmlvcml0eSBsZXZlbCBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIChkZWZhdWx0ID0gMCkuCiovClBoYXNlci5TaWduYWxCaW5kaW5nID0gZnVuY3Rpb24gKHNpZ25hbCwgbGlzdGVuZXIsIGlzT25jZSwgbGlzdGVuZXJDb250ZXh0LCBwcmlvcml0eSkgewoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBfbGlzdGVuZXIgLSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fbGlzdGVuZXIgPSBsaXN0ZW5lcjsKCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBfaXNPbmNlIC0gSWYgYmluZGluZyBzaG91bGQgYmUgZXhlY3V0ZWQganVzdCBvbmNlLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2lzT25jZSA9IGlzT25jZTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R8dW5kZWZpbmVkfG51bGx9IGNvbnRleHQgLSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgoJKiBAbWVtYmVyb2YgU2lnbmFsQmluZGluZy5wcm90b3R5cGUKCSovCiAgICB0aGlzLmNvbnRleHQgPSBsaXN0ZW5lckNvbnRleHQ7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7U2lnbmFsfSBfc2lnbmFsIC0gUmVmZXJlbmNlIHRvIFNpZ25hbCBvYmplY3QgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fc2lnbmFsID0gc2lnbmFsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gX3ByaW9yaXR5IC0gTGlzdGVuZXIgcHJpb3JpdHkuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fcHJpb3JpdHkgPSBwcmlvcml0eSB8fCAwOwoKfTsKClBoYXNlci5TaWduYWxCaW5kaW5nLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSWYgYmluZGluZyBpcyBhY3RpdmUgYW5kIHNob3VsZCBiZSBleGVjdXRlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUKICAgICogQGRlZmF1bHQKICAgICovIAogICAgYWN0aXZlOiB0cnVlLAoKICAgIC8qKgogICAgKiBEZWZhdWx0IHBhcmFtZXRlcnMgcGFzc2VkIHRvIGxpc3RlbmVyIGR1cmluZyBgU2lnbmFsLmRpc3BhdGNoYCBhbmQgYFNpZ25hbEJpbmRpbmcuZXhlY3V0ZWAgKGN1cnJpZWQgcGFyYW1ldGVycykuCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl8bnVsbH0gcGFyYW1zIAogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICBwYXJhbXM6IG51bGwsCgogICAgLyoqCiAgICAqIENhbGwgbGlzdGVuZXIgcGFzc2luZyBhcmJpdHJhcnkgcGFyYW1ldGVycy4KICAgICogPHA+SWYgYmluZGluZyB3YXMgYWRkZWQgdXNpbmcgYFNpZ25hbC5hZGRPbmNlKClgIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSByZW1vdmVkIGZyb20gc2lnbmFsIGRpc3BhdGNoIHF1ZXVlLCB0aGlzIG1ldGhvZCBpcyB1c2VkIGludGVybmFsbHkgZm9yIHRoZSBzaWduYWwgZGlzcGF0Y2guPC9wPgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2V4ZWN1dGUKICAgICogQHBhcmFtIHthcnJheX0gW3BhcmFtc0Fycl0gLSBBcnJheSBvZiBwYXJhbWV0ZXJzIHRoYXQgc2hvdWxkIGJlIHBhc3NlZCB0byB0aGUgbGlzdGVuZXIuCiAgICAqIEByZXR1cm4ge0Rlc2NyaXB0aW9ufSBWYWx1ZSByZXR1cm5lZCBieSB0aGUgbGlzdGVuZXIuCiAgICAqLwogICAgZXhlY3V0ZTogZnVuY3Rpb24gKHBhcmFtc0FycikgewoKICAgICAgICB2YXIgaGFuZGxlclJldHVybiwgcGFyYW1zOwoKICAgICAgICBpZiAodGhpcy5hY3RpdmUgJiYgISF0aGlzLl9saXN0ZW5lcikKICAgICAgICB7CiAgICAgICAgICAgIHBhcmFtcyA9IHRoaXMucGFyYW1zPyB0aGlzLnBhcmFtcy5jb25jYXQocGFyYW1zQXJyKSA6IHBhcmFtc0FycjsKICAgICAgICAgICAgaGFuZGxlclJldHVybiA9IHRoaXMuX2xpc3RlbmVyLmFwcGx5KHRoaXMuY29udGV4dCwgcGFyYW1zKTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9pc09uY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBoYW5kbGVyUmV0dXJuOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERldGFjaCBiaW5kaW5nIGZyb20gc2lnbmFsLgogICAgKiA8cD5hbGlhcyB0bzogQHNlZSBteVNpZ25hbC5yZW1vdmUobXlCaW5kaW5nLmdldExpc3RlbmVyKCkpOwogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2RldGFjaAogICAgKiBAcmV0dXJuIHtmdW5jdGlvbnxudWxsfSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwgb3IgYG51bGxgIGlmIGJpbmRpbmcgd2FzIHByZXZpb3VzbHkgZGV0YWNoZWQuCiAgICAqLwogICAgZGV0YWNoOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaXNCb3VuZCgpID8gdGhpcy5fc2lnbmFsLnJlbW92ZSh0aGlzLl9saXN0ZW5lciwgdGhpcy5jb250ZXh0KSA6IG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2lzQm91bmQKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBiaW5kaW5nIGlzIHN0aWxsIGJvdW5kIHRvIHRoZSBzaWduYWwgYW5kIGhhcyBhIGxpc3RlbmVyLgogICAgKi8KICAgIGlzQm91bmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKCEhdGhpcy5fc2lnbmFsICYmICEhdGhpcy5fbGlzdGVuZXIpOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNpc09uY2UKICAgICogQHJldHVybiB7Ym9vbGVhbn0gSWYgU2lnbmFsQmluZGluZyB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgb25jZS4KICAgICovCiAgICBpc09uY2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5faXNPbmNlOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNnZXRMaXN0ZW5lcgogICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0gSGFuZGxlciBmdW5jdGlvbiBib3VuZCB0byB0aGUgc2lnbmFsLgogICAgKi8KICAgIGdldExpc3RlbmVyOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2xpc3RlbmVyOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNnZXRTaWduYWwKICAgICogQHJldHVybiB7U2lnbmFsfSBTaWduYWwgdGhhdCBsaXN0ZW5lciBpcyBjdXJyZW50bHkgYm91bmQgdG8uCiAgICAqLwogICAgZ2V0U2lnbmFsOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3NpZ25hbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjX2Rlc3Ryb3kKICAgICogRGVsZXRlIGluc3RhbmNlIHByb3BlcnRpZXMKICAgICogQHByaXZhdGUKICAgICovCiAgICBfZGVzdHJveTogZnVuY3Rpb24gKCkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9zaWduYWw7CiAgICAgICAgZGVsZXRlIHRoaXMuX2xpc3RlbmVyOwogICAgICAgIGRlbGV0ZSB0aGlzLmNvbnRleHQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gU3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBvYmplY3QuCiAgICAqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gJ1tQaGFzZXIuU2lnbmFsQmluZGluZyBpc09uY2U6JyArIHRoaXMuX2lzT25jZSArJywgaXNCb3VuZDonKyB0aGlzLmlzQm91bmQoKSArJywgYWN0aXZlOicgKyB0aGlzLmFjdGl2ZSArICddJzsKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKiogCiogVGhpcyBpcyBhIGJhc2UgRmlsdGVyIHRlbXBsYXRlIHRvIHVzZSBmb3IgYW55IFBoYXNlciBmaWx0ZXIgZGV2ZWxvcG1lbnQuCiogCiogQGNsYXNzIFBoYXNlci5GaWx0ZXIKKiBAY2xhc3NkZXNjIFBoYXNlciAtIEZpbHRlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge09iamVjdH0gdW5pZm9ybXMgLSBVbmlmb3JtIG1hcHBpbmdzIG9iamVjdAoqIEBwYXJhbSB7QXJyYXl9IGZyYWdtZW50U3JjIC0gVGhlIGZyYWdtZW50IHNoYWRlciBjb2RlLgoqLwpQaGFzZXIuRmlsdGVyID0gZnVuY3Rpb24gKGdhbWUsIHVuaWZvcm1zLCBmcmFnbWVudFNyYykgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdCwgZWl0aGVyIFBoYXNlci5XRUJHTF9GSUxURVIgb3IgUGhhc2VyLkNBTlZBU19GSUxURVIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50eXBlID0gIFBoYXNlci5XRUJHTF9GSUxURVI7CiAgICAKICAgIC8qKgogICAgKiBBbiBhcnJheSBvZiBwYXNzZXMgLSBzb21lIGZpbHRlcnMgY29udGFpbiBhIGZldyBzdGVwcyB0aGlzIGFycmF5IHNpbXBseSBzdG9yZXMgdGhlIHN0ZXBzIGluIGEgbGluZWFyIGZhc2hpb24uCiAgICAqIEZvciBleGFtcGxlIHRoZSBibHVyIGZpbHRlciBoYXMgdHdvIHBhc3NlcyBibHVyWCBhbmQgYmx1clkuCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IHBhc3NlcyAtIEFuIGFycmF5IG9mIGZpbHRlciBvYmplY3RzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMucGFzc2VzID0gW3RoaXNdOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXJ0eSAtIEludGVybmFsIFBJWEkgdmFyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFkZGluZyAtIEludGVybmFsIFBJWEkgdmFyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFkZGluZyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSB1bmlmb3JtcyAtIERlZmF1bHQgdW5pZm9ybSBtYXBwaW5ncy4KICAgICovCiAgICB0aGlzLnVuaWZvcm1zID0gewoKICAgICAgICByZXNvbHV0aW9uOiB7IHR5cGU6ICczZicsIHZhbHVlOiB7IHg6IDI1NiwgeTogMjU2LCB6OiAwIH19LAogICAgICAgIHRpbWU6IHsgdHlwZTogJzFmJywgdmFsdWU6IDAgfSwKICAgICAgICBtb3VzZTogeyB0eXBlOiAnNGYnLCB2YWx1ZTogeyB4OiAwLCB5OiAwLCB6OiAwLCB3OiAwIH19CgogICAgfTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGZyYWdtZW50U3JjIC0gVGhlIGZyYWdtZW50IHNoYWRlciBjb2RlLgogICAgKi8KICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBmcmFnbWVudFNyYyB8fCBbXTsKCn07CgpQaGFzZXIuRmlsdGVyLnByb3RvdHlwZSA9IHsKCiAgICBpbml0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gIFRoaXMgc2hvdWxkIGJlIG92ZXItcmlkZGVuLiBXaWxsIHJlY2VpdmUgYSB2YXJpYWJsZSBudW1iZXIgb2YgYXJndW1lbnRzLgogICAgfSwKCiAgICBzZXRSZXNvbHV0aW9uOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueCA9IHdpZHRoOwogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS55ID0gaGVpZ2h0OwoKICAgIH0sCgogICAgdXBkYXRlOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodHlwZW9mIHBvaW50ZXIgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy51bmlmb3Jtcy5tb3VzZS54ID0gcG9pbnRlci54OwogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLm1vdXNlLnkgPSBwb2ludGVyLnk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVuaWZvcm1zLnRpbWUudmFsdWUgPSB0aGlzLmdhbWUudGltZS50b3RhbEVsYXBzZWRTZWNvbmRzKCk7IAoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGRvd24gdGhpcyBGaWx0ZXIgYW5kIG51bGwgb3V0IHJlZmVyZW5jZXMKICAgICogQG1ldGhvZCBQaGFzZXIuRmlsdGVyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgCiAgICB9Cgp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5GaWx0ZXIucHJvdG90eXBlLCAnd2lkdGgnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueCA9IHZhbHVlOwogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkZpbHRlci5wcm90b3R5cGUsICdoZWlnaHQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKiogCiogVGhpcyBpcyBhIGJhc2UgUGx1Z2luIHRlbXBsYXRlIHRvIHVzZSBmb3IgYW55IFBoYXNlciBwbHVnaW4gZGV2ZWxvcG1lbnQuCiogCiogQGNsYXNzIFBoYXNlci5QbHVnaW4KKiBAY2xhc3NkZXNjIFBoYXNlciAtIFBsdWdpbgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge0FueX0gcGFyZW50IC0gVGhlIG9iamVjdCB0aGF0IG93bnMgdGhpcyBwbHVnaW4sIHVzdWFsbHkgUGhhc2VyLlBsdWdpbk1hbmFnZXIuCiovClBoYXNlci5QbHVnaW4gPSBmdW5jdGlvbiAoZ2FtZSwgcGFyZW50KSB7CgogICAgaWYgKHR5cGVvZiBwYXJlbnQgPT09ICd1bmRlZmluZWQnKSB7IHBhcmVudCA9IG51bGw7IH0KCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoJKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge0FueX0gcGFyZW50IC0gVGhlIHBhcmVudCBvZiB0aGlzIHBsdWdpbi4gSWYgYWRkZWQgdG8gdGhlIFBsdWdpbk1hbmFnZXIgdGhlIHBhcmVudCB3aWxsIGJlIHNldCB0byB0aGF0LCBvdGhlcndpc2UgaXQgd2lsbCBiZSBudWxsLgoJKi8KICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhY3RpdmUgLSBBIFBsdWdpbiB3aXRoIGFjdGl2ZT10cnVlIGhhcyBpdHMgcHJlVXBkYXRlIGFuZCB1cGRhdGUgbWV0aG9kcyBjYWxsZWQgYnkgdGhlIHBhcmVudCwgb3RoZXJ3aXNlIHRoZXkgYXJlIHNraXBwZWQuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIEEgUGx1Z2luIHdpdGggdmlzaWJsZT10cnVlIGhhcyBpdHMgcmVuZGVyIGFuZCBwb3N0UmVuZGVyIG1ldGhvZHMgY2FsbGVkIGJ5IHRoZSBwYXJlbnQsIG90aGVyd2lzZSB0aGV5IGFyZSBza2lwcGVkLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBoYXNQcmVVcGRhdGUgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcHJlVXBkYXRlIG1ldGhvZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmhhc1ByZVVwZGF0ZSA9IGZhbHNlOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBoYXNVcGRhdGUgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGFuIHVwZGF0ZSBtZXRob2QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5oYXNVcGRhdGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBoYXNQb3N0VXBkYXRlIC0gQSBmbGFnIHRvIGluZGljYXRlIGlmIHRoaXMgcGx1Z2luIGhhcyBhIHBvc3RVcGRhdGUgbWV0aG9kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGFzUG9zdFVwZGF0ZSA9IGZhbHNlOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBoYXNSZW5kZXIgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcmVuZGVyIG1ldGhvZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmhhc1JlbmRlciA9IGZhbHNlOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBoYXNQb3N0UmVuZGVyIC0gQSBmbGFnIHRvIGluZGljYXRlIGlmIHRoaXMgcGx1Z2luIGhhcyBhIHBvc3RSZW5kZXIgbWV0aG9kLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuaGFzUG9zdFJlbmRlciA9IGZhbHNlOwoKfTsKClBoYXNlci5QbHVnaW4ucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBQcmUtdXBkYXRlIGlzIGNhbGxlZCBhdCB0aGUgdmVyeSBzdGFydCBvZiB0aGUgdXBkYXRlIGN5Y2xlLCBiZWZvcmUgYW55IG90aGVyIHN1YnN5c3RlbXMgaGF2ZSBiZWVuIHVwZGF0ZWQgKGluY2x1ZGluZyBQaHlzaWNzKS4KICAgICogSXQgaXMgb25seSBjYWxsZWQgaWYgYWN0aXZlIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jcHJlVXBkYXRlCiAgICAqLwogICAgcHJlVXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGUgaXMgY2FsbGVkIGFmdGVyIGFsbCB0aGUgY29yZSBzdWJzeXN0ZW1zIChJbnB1dCwgVHdlZW5zLCBTb3VuZCwgZXRjKSBhbmQgdGhlIFN0YXRlIGhhdmUgdXBkYXRlZCwgYnV0IGJlZm9yZSB0aGUgcmVuZGVyLgogICAgKiBJdCBpcyBvbmx5IGNhbGxlZCBpZiBhY3RpdmUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBpcyBjYWxsZWQgcmlnaHQgYWZ0ZXIgdGhlIEdhbWUgUmVuZGVyZXIgY29tcGxldGVzLCBidXQgYmVmb3JlIHRoZSBTdGF0ZS5yZW5kZXIuCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIHZpc2libGUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNyZW5kZXIKICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFBvc3QtcmVuZGVyIGlzIGNhbGxlZCBhZnRlciB0aGUgR2FtZSBSZW5kZXJlciBhbmQgU3RhdGUucmVuZGVyIGhhdmUgcnVuLgogICAgKiBJdCBpcyBvbmx5IGNhbGxlZCBpZiB2aXNpYmxlIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jcG9zdFJlbmRlcgogICAgKi8KICAgIHBvc3RSZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGRvd24gdGhpcyBQbHVnaW4gYW5kIG51bGwgb3V0IHJlZmVyZW5jZXMKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5wYXJlbnQgPSBudWxsOwogICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqIAoqIERlc2NyaXB0aW9uLgoqIAoqIEBjbGFzcyBQaGFzZXIuUGx1Z2luTWFuYWdlcgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gUGx1Z2luTWFuYWdlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBwYXJlbnQgLSBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLlBsdWdpbk1hbmFnZXIgPSBmdW5jdGlvbihnYW1lLCBwYXJlbnQpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoJKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfcGFyZW50IC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fcGFyZW50ID0gcGFyZW50OwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHthcnJheX0gcGx1Z2lucyAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMucGx1Z2lucyA9IFtdOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHthcnJheX0gX3BsdWdpbnNMZW5ndGggLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gMDsKCn07CgpQaGFzZXIuUGx1Z2luTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBQbHVnaW4gdG8gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAqIFRoZSBwbHVnaW4ncyBnYW1lIGFuZCBwYXJlbnQgcmVmZXJlbmNlIGFyZSBzZXQgdG8gdGhpcyBnYW1lIGFuZCBwbHVnaW5tYW5hZ2VyIHBhcmVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNhZGQKICAgICogQHBhcmFtIHtQaGFzZXIuUGx1Z2lufSBwbHVnaW4gLSBEZXNjcmlwdGlvbi4KICAgICogQHJldHVybiB7UGhhc2VyLlBsdWdpbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAocGx1Z2luKSB7CgogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgLy8gIFByb3RvdHlwZT8KICAgICAgICBpZiAodHlwZW9mIHBsdWdpbiA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbiA9IG5ldyBwbHVnaW4odGhpcy5nYW1lLCB0aGlzLl9wYXJlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uZ2FtZSA9IHRoaXMuZ2FtZTsKICAgICAgICAgICAgcGx1Z2luLnBhcmVudCA9IHRoaXMuX3BhcmVudDsKICAgICAgICB9CgogICAgICAgIC8vICBDaGVjayBmb3IgbWV0aG9kcyBub3cgdG8gYXZvaWQgaGF2aW5nIHRvIGRvIHRoaXMgZXZlcnkgbG9vcAogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydwcmVVcGRhdGUnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5oYXNQcmVVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3VwZGF0ZSddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1VwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncG9zdFVwZGF0ZSddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1Bvc3RVcGRhdGUgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3JlbmRlciddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1JlbmRlciA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncG9zdFJlbmRlciddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1Bvc3RSZW5kZXIgPSB0cnVlOwogICAgICAgICAgICByZXN1bHQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gIFRoZSBwbHVnaW4gbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBvZiB0aGUgYWJvdmUgZnVuY3Rpb25zIHRvIGJlIGFkZGVkIHRvIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgICAgIGlmIChyZXN1bHQpCiAgICAgICAgewogICAgICAgICAgICBpZiAocGx1Z2luLmhhc1ByZVVwZGF0ZSB8fCBwbHVnaW4uaGFzVXBkYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwbHVnaW4uYWN0aXZlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHBsdWdpbi5oYXNSZW5kZXIgfHwgcGx1Z2luLmhhc1Bvc3RSZW5kZXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBsdWdpbi52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fcGx1Z2luc0xlbmd0aCA9IHRoaXMucGx1Z2lucy5wdXNoKHBsdWdpbik7CgogICAgICAgICAgICAvLyBBbGxvd3MgcGx1Z2lucyB0byBydW4gcG90ZW50aWFsbHkgZGVzdHJ1Y3RpdmUgY29kZSBvdXRzaWRlIG9mIHRoZSBjb25zdHJ1Y3RvciwgYW5kIG9ubHkgaWYgYmVpbmcgYWRkZWQgdG8gdGhlIFBsdWdpbk1hbmFnZXIKICAgICAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ2luaXQnXSA9PT0gJ2Z1bmN0aW9uJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLmluaXQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHBsdWdpbjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICAqIFJlbW92ZSBhIFBsdWdpbiBmcm9tIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNyZW1vdmUKICAgICAqIEBwYXJhbSB7UGhhc2VyLlBsdWdpbn0gcGx1Z2luIC0gVGhlIHBsdWdpbiB0byBiZSByZW1vdmVkLgogICAgICovCiAgICByZW1vdmU6IGZ1bmN0aW9uIChwbHVnaW4pIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0gPT09IHBsdWdpbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLmRlc3Ryb3koKTsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2lucy5zcGxpY2UodGhpcy5fcCwgMSk7CiAgICAgICAgICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoLS07CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogUmVtb3ZlcyBhbGwgUGx1Z2lucyBmcm9tIHRoZSBQbHVnaW5NYW5hZ2VyLgogICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNyZW1vdmVBbGwKICAgICAqLwogICAgcmVtb3ZlQWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmRlc3Ryb3koKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5wbHVnaW5zLmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5fcGx1Z2luc0xlbmd0aCA9IDA7CiAgICB9LAoKICAgIC8qKgogICAgKiBQcmUtdXBkYXRlIGlzIGNhbGxlZCBhdCB0aGUgdmVyeSBzdGFydCBvZiB0aGUgdXBkYXRlIGN5Y2xlLCBiZWZvcmUgYW55IG90aGVyIHN1YnN5c3RlbXMgaGF2ZSBiZWVuIHVwZGF0ZWQgKGluY2x1ZGluZyBQaHlzaWNzKS4KICAgICogSXQgb25seSBjYWxscyBwbHVnaW5zIHdobyBoYXZlIGFjdGl2ZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNwcmVVcGRhdGUKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wbHVnaW5zW3RoaXMuX3BdLmFjdGl2ZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUHJlVXBkYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucHJlVXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlIGlzIGNhbGxlZCBhZnRlciBhbGwgdGhlIGNvcmUgc3Vic3lzdGVtcyAoSW5wdXQsIFR3ZWVucywgU291bmQsIGV0YykgYW5kIHRoZSBTdGF0ZSBoYXZlIHVwZGF0ZWQsIGJ1dCBiZWZvcmUgdGhlIHJlbmRlci4KICAgICogSXQgb25seSBjYWxscyBwbHVnaW5zIHdobyBoYXZlIGFjdGl2ZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0uYWN0aXZlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS51cGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQb3N0VXBkYXRlIGlzIHRoZSBsYXN0IHRoaW5nIHRvIGJlIGNhbGxlZCBiZWZvcmUgdGhlIHdvcmxkIHJlbmRlci4KICAgICogSW4gcGFydGljdWxhciwgaXQgaXMgY2FsbGVkIGFmdGVyIHRoZSB3b3JsZCBwb3N0VXBkYXRlLCB3aGljaCBtZWFucyB0aGUgY2FtZXJhIGhhcyBiZWVuIGFkanVzdGVkLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgYWN0aXZlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3Bvc3RVcGRhdGUKICAgICovCiAgICBwb3N0VXBkYXRlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wbHVnaW5zW3RoaXMuX3BdLmFjdGl2ZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUG9zdFVwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnBvc3RVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgaXMgY2FsbGVkIHJpZ2h0IGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGNvbXBsZXRlcywgYnV0IGJlZm9yZSB0aGUgU3RhdGUucmVuZGVyLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgdmlzaWJsZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNyZW5kZXIKICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BsdWdpbnNMZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5wbHVnaW5zW3RoaXMuX3BdLnZpc2libGUgJiYgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmhhc1JlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBvc3QtcmVuZGVyIGlzIGNhbGxlZCBhZnRlciB0aGUgR2FtZSBSZW5kZXJlciBhbmQgU3RhdGUucmVuZGVyIGhhdmUgcnVuLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgdmlzaWJsZT10cnVlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNwb3N0UmVuZGVyCiAgICAqLwogICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0udmlzaWJsZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUG9zdFJlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnBvc3RSZW5kZXIoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhciBkb3duIHRoaXMgUGx1Z2luTWFuYWdlciBhbmQgbnVsbCBvdXQgcmVmZXJlbmNlcwogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luTWFuYWdlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnBsdWdpbnMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gMDsKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwogICAgICAgIHRoaXMuX3BhcmVudCA9IG51bGw7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBTdGFnZSBjb250cm9scyB0aGUgY2FudmFzIG9uIHdoaWNoIGV2ZXJ5dGhpbmcgaXMgZGlzcGxheWVkLiBJdCBoYW5kbGVzIGRpc3BsYXkgd2l0aGluIHRoZSBicm93c2VyLAoqIGZvY3VzIGhhbmRsaW5nLCBnYW1lIHJlc2l6aW5nLCBzY2FsaW5nIGFuZCB0aGUgcGF1c2UsIGJvb3QgYW5kIG9yaWVudGF0aW9uIHNjcmVlbnMuCioKKiBAY2xhc3MgUGhhc2VyLlN0YWdlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBjYW52YXMgZWxlbWVudC4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBjYW52YXMgZWxlbWVudC4KICovClBoYXNlci5TdGFnZSA9IGZ1bmN0aW9uIChnYW1lLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gZ2FtZSAtIEJhY2tncm91bmQgY29sb3Igb2YgdGhlIHN0YWdlIChkZWZhdWx0cyB0byBibGFjaykuIFNldCB2aWEgdGhlIHB1YmxpYyBiYWNrZ3JvdW5kQ29sb3IgcHJvcGVydHkuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0ICdyZ2IoMCwwLDApJwoJKi8KICAgIHRoaXMuX2JhY2tncm91bmRDb2xvciA9ICdyZ2IoMCwwLDApJzsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG9mZnNldCAtIEdldCB0aGUgb2Zmc2V0IHZhbHVlcyAoZm9yIGlucHV0IGFuZCBvdGhlciB0aGluZ3MpLgoJKi8KCXRoaXMub2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFJlZmVyZW5jZSB0byB0aGUgbmV3bHkgY3JlYXRlZCAmbHQ7Y2FudmFzJmd0OyBlbGVtZW50LgogICAgKi8KICAgIHRoaXMuY2FudmFzID0gUGhhc2VyLkNhbnZhcy5jcmVhdGUod2lkdGgsIGhlaWdodCk7IAogICAgdGhpcy5jYW52YXMuc3R5bGVbJy13ZWJraXQtZnVsbC1zY3JlZW4nXSA9ICd3aWR0aDogMTAwJTsgaGVpZ2h0OiAxMDAlJzsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5TdGFnZX0gX3N0YWdlIC0gVGhlIFBpeGkgU3RhZ2Ugd2hpY2ggaXMgaG9va2VkIHRvIHRoZSByZW5kZXJlci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9zdGFnZSA9IG5ldyBQSVhJLlN0YWdlKDB4MDAwMDAwLCBmYWxzZSk7CiAgICB0aGlzLl9zdGFnZS5uYW1lID0gJ19zdGFnZV9yb290JzsKICAgIHRoaXMuX3N0YWdlLmludGVyYWN0aXZlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY2FsZU1vZGUgLSBUaGUgY3VycmVudCBzY2FsZU1vZGUuCiAgICAqLyAgICAKICAgIHRoaXMuc2NhbGVNb2RlID0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLk5PX1NDQUxFOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TdGFnZVNjYWxlTW9kZX0gc2NhbGUgLSBUaGUgc2NhbGUgb2YgdGhlIGN1cnJlbnQgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlN0YWdlU2NhbGVNb2RlKHRoaXMuZ2FtZSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gYXNwZWN0UmF0aW8gLSBBc3BlY3QgcmF0aW8uCiAgICAgKi8KICAgIHRoaXMuYXNwZWN0UmF0aW8gPSB3aWR0aCAvIGhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9uZXh0T2Zmc2V0Q2hlY2sgLSBUaGUgdGltZSB0byBydW4gdGhlIG5leHQgb2Zmc2V0IGNoZWNrLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX25leHRPZmZzZXRDaGVjayA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfGZhbHNlfSBjaGVja09mZnNldEludGVydmFsIC0gVGhlIHRpbWUgKGluIG1zKSBiZXR3ZWVuIHdoaWNoIHRoZSBzdGFnZSBzaG91bGQgY2hlY2sgdG8gc2VlIGlmIGl0IGhhcyBtb3ZlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNoZWNrT2Zmc2V0SW50ZXJ2YWwgPSAyNTAwOwoKfTsKClBoYXNlci5TdGFnZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEluaXRpYWxpc2VzIHRoZSBzdGFnZSBhbmQgYWRkcyB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZSNib290CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgYm9vdDogZnVuY3Rpb24gKCkgewoKICAgICAgICBQaGFzZXIuQ2FudmFzLmdldE9mZnNldCh0aGlzLmNhbnZhcywgdGhpcy5vZmZzZXQpOwoKICAgICAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnksIHRoaXMuZ2FtZS53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCk7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX29uQ2hhbmdlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy52aXNpYmlsaXR5Q2hhbmdlKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIFBoYXNlci5DYW52YXMuc2V0VXNlclNlbGVjdCh0aGlzLmNhbnZhcywgJ25vbmUnKTsKICAgICAgICBQaGFzZXIuQ2FudmFzLnNldFRvdWNoQWN0aW9uKHRoaXMuY2FudmFzLCAnbm9uZScpOwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd2aXNpYmlsaXR5Y2hhbmdlJywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlJywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwYWdlaGlkZScsIHRoaXMuX29uQ2hhbmdlLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncGFnZXNob3cnLCB0aGlzLl9vbkNoYW5nZSwgZmFsc2UpOwoKICAgICAgICB3aW5kb3cub25ibHVyID0gdGhpcy5fb25DaGFuZ2U7CiAgICAgICAgd2luZG93Lm9uZm9jdXMgPSB0aGlzLl9vbkNoYW5nZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSdW5zIFN0YWdlIHByb2Nlc3NlcyB0aGF0IG5lZWQgcGVyaW9kaWMgdXBkYXRlcywgc3VjaCBhcyB0aGUgb2Zmc2V0IGNoZWNrcy4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2UjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmNoZWNrT2Zmc2V0SW50ZXJ2YWwgIT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS50aW1lLm5vdyA+IHRoaXMuX25leHRPZmZzZXRDaGVjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgUGhhc2VyLkNhbnZhcy5nZXRPZmZzZXQodGhpcy5jYW52YXMsIHRoaXMub2Zmc2V0KTsKICAgICAgICAgICAgICAgIHRoaXMuX25leHRPZmZzZXRDaGVjayA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuY2hlY2tPZmZzZXRJbnRlcnZhbDsKICAgICAgICAgICAgfQoKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogVGhpcyBtZXRob2QgaXMgY2FsbGVkIHdoZW4gdGhlIGRvY3VtZW50IHZpc2liaWxpdHkgaXMgY2hhbmdlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2UjdmlzaWJpbGl0eUNoYW5nZQogICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIEl0cyB0eXBlIHdpbGwgYmUgdXNlZCB0byBkZWNpZGUgd2hldGhlciB0aGUgZ2FtZSBzaG91bGQgYmUgcGF1c2VkIG9yIG5vdC4KICAgICovCiAgICB2aXNpYmlsaXR5Q2hhbmdlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZVZpc2liaWxpdHlDaGFuZ2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZXZlbnQudHlwZSA9PSAncGFnZWhpZGUnIHx8IGV2ZW50LnR5cGUgPT0gJ2JsdXInIHx8IGRvY3VtZW50WydoaWRkZW4nXSA9PSB0cnVlIHx8IGRvY3VtZW50Wyd3ZWJraXRIaWRkZW4nXSA9PSB0cnVlKQogICAgICAgIHsKCSAgICAgICAgdGhpcy5nYW1lLnBhdXNlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CgkgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCn07CgovKioKKiBAbmFtZSBQaGFzZXIuU3RhZ2UjYmFja2dyb3VuZENvbG9yCiogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSBiYWNrZ3JvdW5kQ29sb3IgLSBHZXRzIGFuZCBzZXRzIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9mIHRoZSBzdGFnZS4gVGhlIGNvbG9yIGNhbiBiZSBnaXZlbiBhcyBhIG51bWJlcjogMHhmZjAwMDAgb3IgYSBoZXggc3RyaW5nOiAnI2ZmMDAwMCcKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TdGFnZS5wcm90b3R5cGUsICJiYWNrZ3JvdW5kQ29sb3IiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2JhY2tncm91bmRDb2xvcjsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdGhpcy5fYmFja2dyb3VuZENvbG9yID0gY29sb3I7CgogICAgICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PSBQaGFzZXIuQ0FOVkFTKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFNldCBpdCBkaXJlY3RseSwgdGhpcyBhbGxvd3MgdXMgdG8gdXNlIHJnYiBhbHBoYSB2YWx1ZXMgaW4gQ2FudmFzIG1vZGUuCiAgICAgICAgICAgIHRoaXMuX3N0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZyA9IGNvbG9yOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGNvbG9yID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY29sb3IgPSBQaGFzZXIuQ29sb3IuaGV4VG9SR0IoY29sb3IpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9zdGFnZS5zZXRCYWNrZ3JvdW5kQ29sb3IoY29sb3IpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciBHcm91cCBjb25zdHJ1Y3Rvci4KKiBAY2xhc3MgUGhhc2VyLkdyb3VwCiogQGNsYXNzZGVzYyBBIEdyb3VwIGlzIGEgY29udGFpbmVyIGZvciBkaXNwbGF5IG9iamVjdHMgdGhhdCBhbGxvd3MgZm9yIGZhc3QgcG9vbGluZywgcmVjeWNsaW5nIGFuZCBjb2xsaXNpb24gY2hlY2tzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0geyp9IHBhcmVudCAtIFRoZSBwYXJlbnQgR3JvdXAgb3IgRGlzcGxheU9iamVjdENvbnRhaW5lciB0aGF0IHdpbGwgaG9sZCB0aGlzIGdyb3VwLCBpZiBhbnkuCiogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPWdyb3VwXSAtIEEgbmFtZSBmb3IgdGhpcyBHcm91cC4gTm90IHVzZWQgaW50ZXJuYWxseSBidXQgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuCiogQHBhcmFtIHtib29sZWFufSBbdXNlU3RhZ2U9ZmFsc2VdIC0gU2hvdWxkIHRoZSBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHRoaXMgR3JvdXAgY3JlYXRlcyBiZSBhZGRlZCB0byB0aGUgV29ybGQgKGRlZmF1bHQsIGZhbHNlKSBvciBkaXJlY3QgdG8gdGhlIFN0YWdlICh0cnVlKS4KKi8KUGhhc2VyLkdyb3VwID0gZnVuY3Rpb24gKGdhbWUsIHBhcmVudCwgbmFtZSwgdXNlU3RhZ2UpIHsKCglpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHBhcmVudCA9PT0gbnVsbCkKCXsKCQlwYXJlbnQgPSBnYW1lLndvcmxkOwoJfQoKCWlmICh0eXBlb2YgdXNlU3RhZ2UgPT09ICd1bmRlZmluZWQnKQoJewoJCXVzZVN0YWdlID0gZmFsc2U7Cgl9CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoJCiAgICAvKioKCSogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBBIG5hbWUgZm9yIHRoaXMgR3JvdXAuIE5vdCB1c2VkIGludGVybmFsbHkgYnV0IHVzZWZ1bCBmb3IgZGVidWdnaW5nLgoJKi8KCXRoaXMubmFtZSA9IG5hbWUgfHwgJ2dyb3VwJzsKCglpZiAodXNlU3RhZ2UpCgl7CgkJdGhpcy5fY29udGFpbmVyID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZTsKCX0KCWVsc2UKCXsKCQl0aGlzLl9jb250YWluZXIgPSBuZXcgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyKCk7CgkJdGhpcy5fY29udGFpbmVyLm5hbWUgPSB0aGlzLm5hbWU7CgoJCWlmIChwYXJlbnQpCgkJewoJCQlpZiAocGFyZW50IGluc3RhbmNlb2YgUGhhc2VyLkdyb3VwKQoJCQl7CgkJCQlwYXJlbnQuX2NvbnRhaW5lci5hZGRDaGlsZCh0aGlzLl9jb250YWluZXIpOwoJCQkJcGFyZW50Ll9jb250YWluZXIudXBkYXRlVHJhbnNmb3JtKCk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlwYXJlbnQuYWRkQ2hpbGQodGhpcy5fY29udGFpbmVyKTsKCQkJCXBhcmVudC51cGRhdGVUcmFuc2Zvcm0oKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmFkZENoaWxkKHRoaXMuX2NvbnRhaW5lcik7CgkJCXRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CgkJfQoJfQoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIEludGVybmFsIFBoYXNlciBUeXBlIHZhbHVlLgoJKiBAcHJvdGVjdGVkCgkqLwoJdGhpcy50eXBlID0gUGhhc2VyLkdST1VQOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyBpcyB0cnVlIHRoZSB0aGUgR3JvdXAgaXMgdXBkYXRlZCwgb3RoZXJ3aXNlIGl0IGlzIHNraXBwZWQuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBSZXBsYWNlcyB0aGUgUElYSS5Qb2ludCB3aXRoIGEgc2xpZ2h0bHkgbW9yZSBmbGV4aWJsZSBvbmUuCiAgICAqLyAKICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBUaGUgY3Vyc29yIGlzIGEgc2ltcGxlIHdheSB0byBpdGVyYXRlIHRocm91Z2ggdGhlIG9iamVjdHMgaW4gYSBHcm91cCB1c2luZyB0aGUgR3JvdXAubmV4dCBhbmQgR3JvdXAucHJldmlvdXMgZnVuY3Rpb25zLgogICAgKiBUaGUgY3Vyc29yIGlzIHNldCB0byB0aGUgZmlyc3QgY2hpbGQgYWRkZWQgdG8gdGhlIEdyb3VwIGFuZCBkb2Vzbid0IGNoYW5nZSB1bmxlc3MgeW91IGNhbGwgbmV4dCwgcHJldmlvdXMgb3Igc2V0IGl0IGRpcmVjdGx5IHdpdGggR3JvdXAuY3Vyc29yLgogICAgKiBAcHJvcGVydHkge2FueX0gY3Vyc29yIC0gVGhlIGN1cnJlbnQgZGlzcGxheSBvYmplY3QgdGhhdCB0aGUgR3JvdXAgY3Vyc29yIGlzIHBvaW50aW5nIHRvLgogICAgKi8gCiAgICB0aGlzLmN1cnNvciA9IG51bGw7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9OT05FID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCA9IDI7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcgPSAtMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5TT1JUX0RFU0NFTkRJTkcgPSAxOwoKUGhhc2VyLkdyb3VwLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhbiBleGlzdGluZyBvYmplY3QgdG8gdGhpcyBHcm91cC4gVGhlIG9iamVjdCBjYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuCiAgICAqIFRoZSBjaGlsZCBpcyBhdXRvbWF0aWNhbGx5IGFkZGVkIHRvIHRoZSB0b3Agb2YgdGhlIEdyb3VwLCBzbyByZW5kZXJzIG9uLXRvcCBvZiBldmVyeXRoaW5nIGVsc2Ugd2l0aGluIHRoZSBHcm91cC4gSWYgeW91IG5lZWQgdG8gY29udHJvbAogICAgKiB0aGF0IHRoZW4gc2VlIHRoZSBhZGRBdCBtZXRob2QuCiAgICAqCiAgICAqIEBzZWUgUGhhc2VyLkdyb3VwI2NyZWF0ZQogICAgKiBAc2VlIFBoYXNlci5Hcm91cCNhZGRBdAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNhZGQKCSogQHBhcmFtIHsqfSBjaGlsZCAtIEFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5CdXR0b24gb3IgYW55IG90aGVyIGRpc3BsYXkgb2JqZWN0Li4KCSogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIGFkZGVkIHRvIHRoZSBHcm91cC4KICAgICovCglhZGQ6IGZ1bmN0aW9uIChjaGlsZCkgewoKCQlpZiAoY2hpbGQuZ3JvdXAgIT09IHRoaXMpCgkJewoJCQljaGlsZC5ncm91cCA9IHRoaXM7CgoJCQlpZiAoY2hpbGQuZXZlbnRzKQoJCQl7CgkJCQljaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwoJCQl9CgoJCQl0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwoKCQkJY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgoJCQlpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gY2hpbGQ7CgkJCX0KCQl9CgoJCXJldHVybiBjaGlsZDsKCgl9LAoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGlzIEdyb3VwLiBUaGUgb2JqZWN0IGNhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4KICAgICogVGhlIGNoaWxkIGlzIGFkZGVkIHRvIHRoZSBHcm91cCBhdCB0aGUgbG9jYXRpb24gc3BlY2lmaWVkIGJ5IHRoZSBpbmRleCB2YWx1ZSwgdGhpcyBhbGxvd3MgeW91IHRvIGNvbnRyb2wgY2hpbGQgb3JkZXJpbmcuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2FkZEF0CgkqIEBwYXJhbSB7Kn0gY2hpbGQgLSBBbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4uCgkqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCB3aXRoaW4gdGhlIEdyb3VwIHRvIGluc2VydCB0aGUgY2hpbGQgdG8uCgkqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBhZGRlZCB0byB0aGUgR3JvdXAuCgkqLwoJYWRkQXQ6IGZ1bmN0aW9uIChjaGlsZCwgaW5kZXgpIHsKCgkJaWYgKGNoaWxkLmdyb3VwICE9PSB0aGlzKQoJCXsKCQkJY2hpbGQuZ3JvdXAgPSB0aGlzOwoKCQkJaWYgKGNoaWxkLmV2ZW50cykKCQkJewoJCQkJY2hpbGQuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKCQkJfQoKCQkJdGhpcy5fY29udGFpbmVyLmFkZENoaWxkQXQoY2hpbGQsIGluZGV4KTsKCgkJCWNoaWxkLnVwZGF0ZVRyYW5zZm9ybSgpOwoKCQkJaWYgKHRoaXMuY3Vyc29yID09PSBudWxsKQoJCQl7CgkJCQl0aGlzLmN1cnNvciA9IGNoaWxkOwoJCQl9CgkJfQoKCQlyZXR1cm4gY2hpbGQ7CgoJfSwKCiAgICAvKioKCSogUmV0dXJucyB0aGUgY2hpbGQgZm91bmQgYXQgdGhlIGdpdmVuIGluZGV4IHdpdGhpbiB0aGlzIEdyb3VwLgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRBdAogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkdyb3VwCgkqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCB0byByZXR1cm4gdGhlIGNoaWxkIGZyb20uCgkqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBmb3VuZCBhdCB0aGUgZ2l2ZW4gaW5kZXguCgkqLwoJZ2V0QXQ6IGZ1bmN0aW9uIChpbmRleCkgewoKCQlyZXR1cm4gdGhpcy5fY29udGFpbmVyLmdldENoaWxkQXQoaW5kZXgpOwoKCX0sCgogICAgLyoqCgkqIEF1dG9tYXRpY2FsbHkgY3JlYXRlcyBhIG5ldyBQaGFzZXIuU3ByaXRlIG9iamVjdCBhbmQgYWRkcyBpdCB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAuCgkqIFVzZWZ1bCBpZiB5b3UgZG9uJ3QgbmVlZCB0byBjcmVhdGUgdGhlIFNwcml0ZSBpbnN0YW5jZXMgYmVmb3JlLWhhbmQuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NyZWF0ZQoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZGlzcGxheSB0aGUgbmV3bHkgY3JlYXRlZCBTcHJpdGUgYXQuIFRoZSB2YWx1ZSBpcyBpbiByZWxhdGlvbiB0byB0aGUgR3JvdXAueCBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGRpc3BsYXkgdGhlIG5ld2x5IGNyZWF0ZWQgU3ByaXRlIGF0LiBUaGUgdmFsdWUgaXMgaW4gcmVsYXRpb24gdG8gdGhlIEdyb3VwLnkgcG9pbnQuCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5jYWNoZSBrZXkgb2YgdGhlIGltYWdlIHRoYXQgdGhpcyBTcHJpdGUgd2lsbCB1c2UuCgkqIEBwYXJhbSB7bnVtYmVyfHN0cmluZ30gW2ZyYW1lXSAtIElmIHRoZSBTcHJpdGUgaW1hZ2UgY29udGFpbnMgbXVsdGlwbGUgZnJhbWVzIHlvdSBjYW4gc3BlY2lmeSB3aGljaCBvbmUgdG8gdXNlIGhlcmUuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gW2V4aXN0cz10cnVlXSAtIFRoZSBkZWZhdWx0IGV4aXN0cyBzdGF0ZSBvZiB0aGUgU3ByaXRlLgoJKiBAcmV0dXJuIHtQaGFzZXIuU3ByaXRlfSBUaGUgY2hpbGQgdGhhdCB3YXMgY3JlYXRlZC4KCSovCgljcmVhdGU6IGZ1bmN0aW9uICh4LCB5LCBrZXksIGZyYW1lLCBleGlzdHMpIHsKCgkJaWYgKHR5cGVvZiBleGlzdHMgPT0gJ3VuZGVmaW5lZCcpIHsgZXhpc3RzID0gdHJ1ZTsgfQoKCQl2YXIgY2hpbGQgPSBuZXcgUGhhc2VyLlNwcml0ZSh0aGlzLmdhbWUsIHgsIHksIGtleSwgZnJhbWUpOwoKCQljaGlsZC5ncm91cCA9IHRoaXM7CgkJY2hpbGQuZXhpc3RzID0gZXhpc3RzOwoJCWNoaWxkLnZpc2libGUgPSBleGlzdHM7CgkJY2hpbGQuYWxpdmUgPSBleGlzdHM7CgoJCWlmIChjaGlsZC5ldmVudHMpCgkJewoJCQljaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwoJCX0KCgkJdGhpcy5fY29udGFpbmVyLmFkZENoaWxkKGNoaWxkKTsKCQkJCgkJY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgoJCWlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKCQl7CgkJCXRoaXMuY3Vyc29yID0gY2hpbGQ7CgkJfQoKCQlyZXR1cm4gY2hpbGQ7CgoJfSwKCiAgICAvKioKCSogQXV0b21hdGljYWxseSBjcmVhdGVzIG11bHRpcGxlIFBoYXNlci5TcHJpdGUgb2JqZWN0cyBhbmQgYWRkcyB0aGVtIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KCSogVXNlZnVsIGlmIHlvdSBuZWVkIHRvIHF1aWNrbHkgZ2VuZXJhdGUgYSBwb29sIG9mIGlkZW50aWNhbCBzcHJpdGVzLCBzdWNoIGFzIGJ1bGxldHMuIEJ5IGRlZmF1bHQgdGhlIHNwcml0ZXMgd2lsbCBiZSBzZXQgdG8gbm90IGV4aXN0CgkqIGFuZCB3aWxsIGJlIHBvc2l0aW9uZWQgYXQgMCwgMCAocmVsYXRpdmUgdG8gdGhlIEdyb3VwLngveSkKCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY3JlYXRlTXVsdGlwbGUKCSogQHBhcmFtIHtudW1iZXJ9IHF1YW50aXR5IC0gVGhlIG51bWJlciBvZiBTcHJpdGVzIHRvIGNyZWF0ZS4KCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgaW1hZ2UgdGhhdCB0aGlzIFNwcml0ZSB3aWxsIHVzZS4KCSogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBbZnJhbWVdIC0gSWYgdGhlIFNwcml0ZSBpbWFnZSBjb250YWlucyBtdWx0aXBsZSBmcmFtZXMgeW91IGNhbiBzcGVjaWZ5IHdoaWNoIG9uZSB0byB1c2UgaGVyZS4KCSogQHBhcmFtIHtib29sZWFufSBbZXhpc3RzPWZhbHNlXSAtIFRoZSBkZWZhdWx0IGV4aXN0cyBzdGF0ZSBvZiB0aGUgU3ByaXRlLgoJKi8KCWNyZWF0ZU11bHRpcGxlOiBmdW5jdGlvbiAocXVhbnRpdHksIGtleSwgZnJhbWUsIGV4aXN0cykgewoKCQlpZiAodHlwZW9mIGV4aXN0cyA9PSAndW5kZWZpbmVkJykgeyBleGlzdHMgPSBmYWxzZTsgfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHF1YW50aXR5OyBpKyspCgkJewoJCQl2YXIgY2hpbGQgPSBuZXcgUGhhc2VyLlNwcml0ZSh0aGlzLmdhbWUsIDAsIDAsIGtleSwgZnJhbWUpOwoKCQkJY2hpbGQuZ3JvdXAgPSB0aGlzOwoJCQljaGlsZC5leGlzdHMgPSBleGlzdHM7CgkJCWNoaWxkLnZpc2libGUgPSBleGlzdHM7CgkJCWNoaWxkLmFsaXZlID0gZXhpc3RzOwoKCQkJaWYgKGNoaWxkLmV2ZW50cykKCQkJewoJCQkJY2hpbGQuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKCQkJfQoKCQkJdGhpcy5fY29udGFpbmVyLmFkZENoaWxkKGNoaWxkKTsKCQkJY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgoJCQlpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gY2hpbGQ7CgkJCX0KCgkJfQoKCX0sCgogICAgLyoqCgkqIEFkdmFuY2VzIHRoZSBHcm91cCBjdXJzb3IgdG8gdGhlIG5leHQgb2JqZWN0IGluIHRoZSBHcm91cC4gSWYgaXQncyBhdCB0aGUgZW5kIG9mIHRoZSBHcm91cCBpdCB3cmFwcyBhcm91bmQgdG8gdGhlIGZpcnN0IG9iamVjdC4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjbmV4dAoJKi8KCW5leHQ6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuY3Vyc29yKQoJCXsKCQkJLy8JV3JhcCB0aGUgY3Vyc29yPwoJCQlpZiAodGhpcy5jdXJzb3IgPT0gdGhpcy5fY29udGFpbmVyLmxhc3QpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5jdXJzb3IuX2lOZXh0OwoJCQl9CgkJfQoKCX0sCgogICAgLyoqCgkqIE1vdmVzIHRoZSBHcm91cCBjdXJzb3IgdG8gdGhlIHByZXZpb3VzIG9iamVjdCBpbiB0aGUgR3JvdXAuIElmIGl0J3MgYXQgdGhlIHN0YXJ0IG9mIHRoZSBHcm91cCBpdCB3cmFwcyBhcm91bmQgdG8gdGhlIGxhc3Qgb2JqZWN0LgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNwcmV2aW91cwoJKi8KCXByZXZpb3VzOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLmN1cnNvcikKCQl7CgkJCS8vCVdyYXAgdGhlIGN1cnNvcj8KCQkJaWYgKHRoaXMuY3Vyc29yID09IHRoaXMuX2NvbnRhaW5lci5faU5leHQpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLmxhc3Q7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl0aGlzLmN1cnNvciA9IHRoaXMuY3Vyc29yLl9pUHJldjsKCQkJfQoJCX0KCgl9LAoKCWNoaWxkVGVzdDogZnVuY3Rpb24gKHByZWZpeCwgY2hpbGQpIHsKCgkJdmFyIHMgPSBwcmVmaXggKyAnIG5leHQ6ICc7CgoJCWlmIChjaGlsZC5faU5leHQpCgkJewoJCQlzID0gcyArIGNoaWxkLl9pTmV4dC5uYW1lOwoJCX0KCQllbHNlCgkJewoJCQlzID0gcyArICctbnVsbC0nOwoJCX0KCgkJcyA9IHMgKyAnICcgKyBwcmVmaXggKyAnIHByZXY6ICc7CgoJCWlmIChjaGlsZC5faVByZXYpCgkJewoJCQlzID0gcyArIGNoaWxkLl9pUHJldi5uYW1lOwoJCX0KCQllbHNlCgkJewoJCQlzID0gcyArICctbnVsbC0nOwoJCX0KCgkJY29uc29sZS5sb2cocyk7CgoJfSwKCglzd2FwSW5kZXg6IGZ1bmN0aW9uIChpbmRleDEsIGluZGV4MikgewoKCQl2YXIgY2hpbGQxID0gdGhpcy5nZXRBdChpbmRleDEpOwoJCXZhciBjaGlsZDIgPSB0aGlzLmdldEF0KGluZGV4Mik7CgoJCWNvbnNvbGUubG9nKCdzd2FwSW5kZXggJywgaW5kZXgxLCAnIHdpdGggJywgaW5kZXgyKTsKCgkJdGhpcy5zd2FwKGNoaWxkMSwgY2hpbGQyKTsKCgl9LAoKCS8qKgoJKiBTd2FwcyB0aGUgcG9zaXRpb24gb2YgdHdvIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuIEJvdGggY2hpbGRyZW4gbXVzdCBiZSBpbiB0aGlzIEdyb3VwLgoJKiBZb3UgY2Fubm90IHN3YXAgYSBjaGlsZCB3aXRoIGl0c2VsZiwgb3Igc3dhcCB1bi1wYXJlbnRlZCBjaGlsZHJlbiwgZG9pbmcgc28gd2lsbCByZXR1cm4gZmFsc2UuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3N3YXAKCSogQHBhcmFtIHsqfSBjaGlsZDEgLSBUaGUgZmlyc3QgY2hpbGQgdG8gc3dhcC4KCSogQHBhcmFtIHsqfSBjaGlsZDIgLSBUaGUgc2Vjb25kIGNoaWxkIHRvIHN3YXAuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIHN3YXAgd2FzIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSBmYWxzZS4KCSovCglzd2FwOiBmdW5jdGlvbiAoY2hpbGQxLCBjaGlsZDIpIHsKCgkJaWYgKGNoaWxkMSA9PT0gY2hpbGQyIHx8ICFjaGlsZDEucGFyZW50IHx8ICFjaGlsZDIucGFyZW50IHx8IGNoaWxkMS5ncm91cCAhPT0gdGhpcyB8fCBjaGlsZDIuZ3JvdXAgIT09IHRoaXMpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLwlDYWNoZSB0aGUgdmFsdWVzCgkJdmFyIGNoaWxkMVByZXYgPSBjaGlsZDEuX2lQcmV2OwoJCXZhciBjaGlsZDFOZXh0ID0gY2hpbGQxLl9pTmV4dDsKCQl2YXIgY2hpbGQyUHJldiA9IGNoaWxkMi5faVByZXY7CgkJdmFyIGNoaWxkMk5leHQgPSBjaGlsZDIuX2lOZXh0OwoKCQl2YXIgZW5kTm9kZSA9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dDsKCQl2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwoJCQkKCQlkbwoJCXsKCQkJaWYgKGN1cnJlbnROb2RlICE9PSBjaGlsZDEgJiYgY3VycmVudE5vZGUgIT09IGNoaWxkMikKCQkJewoJCQkJaWYgKGN1cnJlbnROb2RlLmZpcnN0ID09PSBjaGlsZDEpCgkJCQl7CgkJCQkJY3VycmVudE5vZGUuZmlyc3QgPSBjaGlsZDI7CgkJCQl9CgkJCQllbHNlIGlmIChjdXJyZW50Tm9kZS5maXJzdCA9PT0gY2hpbGQyKQoJCQkJewoJCQkJCWN1cnJlbnROb2RlLmZpcnN0ID0gY2hpbGQxOwoJCQkJfQoKCQkJCWlmIChjdXJyZW50Tm9kZS5sYXN0ID09PSBjaGlsZDEpCgkJCQl7CgkJCQkJY3VycmVudE5vZGUubGFzdCA9IGNoaWxkMjsKCQkJCX0KCQkJCWVsc2UgaWYgKGN1cnJlbnROb2RlLmxhc3QgPT09IGNoaWxkMikKCQkJCXsKCQkJCQljdXJyZW50Tm9kZS5sYXN0ID0gY2hpbGQxOwoJCQkJfQoJCQl9CgoJCQljdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKCQl9CgkJd2hpbGUgKGN1cnJlbnROb2RlICE9IGVuZE5vZGUpCgoJCWlmIChjaGlsZDEuX2lOZXh0ID09IGNoaWxkMikKCQl7CgkJCS8vCVRoaXMgaXMgYSBkb3dud2FyZCAoQSB0byBCKSBuZWlnaGJvdXIgc3dhcAoJCQljaGlsZDEuX2lOZXh0ID0gY2hpbGQyTmV4dDsKCQkJY2hpbGQxLl9pUHJldiA9IGNoaWxkMjsKCQkJY2hpbGQyLl9pTmV4dCA9IGNoaWxkMTsKCQkJY2hpbGQyLl9pUHJldiA9IGNoaWxkMVByZXY7CgoJCQlpZiAoY2hpbGQxUHJldikgeyBjaGlsZDFQcmV2Ll9pTmV4dCA9IGNoaWxkMjsgfQoJCQlpZiAoY2hpbGQyTmV4dCkgeyBjaGlsZDJOZXh0Ll9pUHJldiA9IGNoaWxkMTsgfQoKCQkJaWYgKGNoaWxkMS5fX3JlbmRlckdyb3VwKQoJCQl7CgkJCQljaGlsZDEuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMSk7CgkJCX0KCgkJCWlmIChjaGlsZDIuX19yZW5kZXJHcm91cCkKCQkJewoJCQkJY2hpbGQyLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDIpOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJZWxzZSBpZiAoY2hpbGQyLl9pTmV4dCA9PSBjaGlsZDEpCgkJewoJCQkvLwlUaGlzIGlzIGFuIHVwd2FyZCAoQiB0byBBKSBuZWlnaGJvdXIgc3dhcAoJCQljaGlsZDEuX2lOZXh0ID0gY2hpbGQyOwoJCQljaGlsZDEuX2lQcmV2ID0gY2hpbGQyUHJldjsKCQkJY2hpbGQyLl9pTmV4dCA9IGNoaWxkMU5leHQ7CgkJCWNoaWxkMi5faVByZXYgPSBjaGlsZDE7CgoJCQlpZiAoY2hpbGQyUHJldikgeyBjaGlsZDJQcmV2Ll9pTmV4dCA9IGNoaWxkMTsgfQoJCQlpZiAoY2hpbGQxTmV4dCkgeyBjaGlsZDFOZXh0Ll9pUHJldiA9IGNoaWxkMjsgfQoKCQkJaWYgKGNoaWxkMS5fX3JlbmRlckdyb3VwKQoJCQl7CgkJCQljaGlsZDEuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMSk7CgkJCX0KCgkJCWlmIChjaGlsZDIuX19yZW5kZXJHcm91cCkKCQkJewoJCQkJY2hpbGQyLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDIpOwoJCQl9CgoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkJZWxzZQoJCXsKCQkJLy8JQ2hpbGRyZW4gYXJlIGZhciBhcGFydAoJCQljaGlsZDEuX2lOZXh0ID0gY2hpbGQyTmV4dDsKCQkJY2hpbGQxLl9pUHJldiA9IGNoaWxkMlByZXY7CgkJCWNoaWxkMi5faU5leHQgPSBjaGlsZDFOZXh0OwoJCQljaGlsZDIuX2lQcmV2ID0gY2hpbGQxUHJldjsKCgkJCWlmIChjaGlsZDFQcmV2KSB7IGNoaWxkMVByZXYuX2lOZXh0ID0gY2hpbGQyOyB9CgkJCWlmIChjaGlsZDFOZXh0KSB7IGNoaWxkMU5leHQuX2lQcmV2ID0gY2hpbGQyOyB9CgkJCWlmIChjaGlsZDJQcmV2KSB7IGNoaWxkMlByZXYuX2lOZXh0ID0gY2hpbGQxOyB9CgkJCWlmIChjaGlsZDJOZXh0KSB7IGNoaWxkMk5leHQuX2lQcmV2ID0gY2hpbGQxOyB9CgoJCQlpZiAoY2hpbGQxLl9fcmVuZGVyR3JvdXApCgkJCXsKCQkJCWNoaWxkMS5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQxKTsKCQkJfQoKCQkJaWYgKGNoaWxkMi5fX3JlbmRlckdyb3VwKQoJCQl7CgkJCQljaGlsZDIuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMik7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoJCQoJfSwKCgkvKioKCSogQnJpbmdzIHRoZSBnaXZlbiBjaGlsZCB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAgc28gaXQgcmVuZGVycyBhYm92ZSBhbGwgb3RoZXIgY2hpbGRyZW4uCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2JyaW5nVG9Ub3AKCSogQHBhcmFtIHsqfSBjaGlsZCAtIFRoZSBjaGlsZCB0byBicmluZyB0byB0aGUgdG9wIG9mIHRoaXMgR3JvdXAuCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBtb3ZlZC4KCSovCglicmluZ1RvVG9wOiBmdW5jdGlvbiAoY2hpbGQpIHsKCgkJaWYgKGNoaWxkLmdyb3VwID09PSB0aGlzKQoJCXsKCQkJdGhpcy5yZW1vdmUoY2hpbGQpOwoJCQl0aGlzLmFkZChjaGlsZCk7CgkJfQoKCQlyZXR1cm4gY2hpbGQ7CgoJfSwKCgkvKioKCSogR2V0IHRoZSBpbmRleCBwb3NpdGlvbiBvZiB0aGUgZ2l2ZW4gY2hpbGQgaW4gdGhpcyBHcm91cC4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0SW5kZXgKCSogQHBhcmFtIHsqfSBjaGlsZCAtIFRoZSBjaGlsZCB0byBnZXQgdGhlIGluZGV4IGZvci4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaW5kZXggb2YgdGhlIGNoaWxkIG9yIC0xIGlmIGl0J3Mgbm90IGEgbWVtYmVyIG9mIHRoaXMgR3JvdXAuCgkqLwoJZ2V0SW5kZXg6IGZ1bmN0aW9uIChjaGlsZCkgewoKCQlyZXR1cm4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmluZGV4T2YoY2hpbGQpOwoKCX0sCgoJLyoqCgkqIFJlcGxhY2VzIGEgY2hpbGQgb2YgdGhpcyBHcm91cCB3aXRoIHRoZSBnaXZlbiBuZXdDaGlsZC4gVGhlIG5ld0NoaWxkIGNhbm5vdCBiZSBhIG1lbWJlciBvZiB0aGlzIEdyb3VwLgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZXBsYWNlCgkqIEBwYXJhbSB7Kn0gb2xkQ2hpbGQgLSBUaGUgY2hpbGQgaW4gdGhpcyBHcm91cCB0aGF0IHdpbGwgYmUgcmVwbGFjZWQuCgkqIEBwYXJhbSB7Kn0gbmV3Q2hpbGQgLSBUaGUgY2hpbGQgdG8gYmUgaW5zZXJ0ZWQgaW50byB0aGlzIGdyb3VwLgoJKi8KCXJlcGxhY2U6IGZ1bmN0aW9uIChvbGRDaGlsZCwgbmV3Q2hpbGQpIHsKCgkJaWYgKCF0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQoJCXsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIGluZGV4ID0gdGhpcy5nZXRJbmRleChvbGRDaGlsZCk7CgkJCgkJaWYgKGluZGV4ICE9IC0xKQoJCXsKCQkJaWYgKG5ld0NoaWxkLnBhcmVudCAhPSB1bmRlZmluZWQpCgkJCXsKCQkJCW5ld0NoaWxkLmV2ZW50cy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcGF0Y2gobmV3Q2hpbGQsIHRoaXMpOwoJCQkJbmV3Q2hpbGQucGFyZW50LnJlbW92ZUNoaWxkKG5ld0NoaWxkKTsKCQkJfQoKCQkJdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKG9sZENoaWxkKTsKCQkJdGhpcy5fY29udGFpbmVyLmFkZENoaWxkQXQobmV3Q2hpbGQsIGluZGV4KTsKCgkJCW5ld0NoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChuZXdDaGlsZCwgdGhpcyk7CgkJCW5ld0NoaWxkLnVwZGF0ZVRyYW5zZm9ybSgpOwoKCQkJaWYgKHRoaXMuY3Vyc29yID09IG9sZENoaWxkKQoJCQl7CgkJCQl0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CgkJCX0KCQl9CgoJfSwKCgkvKioKICAgICAqIFNldHMgdGhlIGdpdmVuIHByb3BlcnR5IHRvIHRoZSBnaXZlbiB2YWx1ZSBvbiB0aGUgY2hpbGQuIFRoZSBvcGVyYXRpb24gY29udHJvbHMgdGhlIGFzc2lnbm1lbnQgb2YgdGhlIHZhbHVlLgogICAgICoKICAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3NldFByb3BlcnR5CiAgICAgKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIHNldCB0aGUgcHJvcGVydHkgdmFsdWUgb24uCiAgICAgKiBAcGFyYW0ge2FycmF5fSBrZXkgLSBBbiBhcnJheSBvZiBzdHJpbmdzIHRoYXQgbWFrZSB1cCB0aGUgcHJvcGVydHkgdGhhdCB3aWxsIGJlIHNldC4KICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdGhhdCB3aWxsIGJlIHNldC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3BlcmF0aW9uPTBdIC0gQ29udHJvbHMgaG93IHRoZSB2YWx1ZSBpcyBhc3NpZ25lZC4gQSB2YWx1ZSBvZiAwIHJlcGxhY2VzIHRoZSB2YWx1ZSB3aXRoIHRoZSBuZXcgb25lLiBBIHZhbHVlIG9mIDEgYWRkcyBpdCwgMiBzdWJ0cmFjdHMgaXQsIDMgbXVsdGlwbGllcyBpdCBhbmQgNCBkaXZpZGVzIGl0LgogICAgICovCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24gKGNoaWxkLCBrZXksIHZhbHVlLCBvcGVyYXRpb24pIHsKCgkJb3BlcmF0aW9uID0gb3BlcmF0aW9uIHx8IDA7CgoJCS8vCUFzIHVnbHkgYXMgdGhpcyBhcHByb2FjaCBsb29rcywgYW5kIGFsdGhvdWdoIGl0J3MgbGltaXRlZCB0byBhIGRlcHRoIG9mIG9ubHkgNCwgaXQncyBleHRyZW1lbHkgZmFzdC4KCQkvLwlNdWNoIGZhc3RlciB0aGFuIGEgZm9yIGxvb3Agb3Igb2JqZWN0IGl0ZXJhdGlvbi4gVGhlcmUgYXJlIG5vIGNoZWNrcywgc28gaWYgdGhlIGtleSBpc24ndCB2YWxpZCB0aGVuIGl0J2xsIGZhaWwKCQkvLwlidXQgYXMgeW91IGFyZSBsaWtlbHkgdG8gY2FsbCB0aGlzIGZyb20gaW5uZXIgbG9vcHMgdGhhdCBoYXZlIHRvIHBlcmZvcm0gd2VsbCwgSSdsbCB0YWtlIHRoYXQgdHJhZGUgb2ZmLgoKCQkvLwkwID0gRXF1YWxzCgkJLy8JMSA9IEFkZAoJCS8vCTIgPSBTdWJ0cmFjdAoJCS8vCTMgPSBNdWx0aXBseQoJCS8vCTQgPSBEaXZpZGUKCgkJdmFyIGxlbiA9IGtleS5sZW5ndGg7CgoJCWlmIChsZW4gPT0gMSkKCQl7CgkJCWlmIChvcGVyYXRpb24gPT0gMCkgeyBjaGlsZFtrZXlbMF1dID0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDEpIHsgY2hpbGRba2V5WzBdXSArPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dIC09IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAzKSB7IGNoaWxkW2tleVswXV0gKj0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDQpIHsgY2hpbGRba2V5WzBdXSAvPSB2YWx1ZTsgfQoJCX0KCQllbHNlIGlmIChsZW4gPT0gMikKCQl7CgkJCWlmIChvcGVyYXRpb24gPT0gMCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gKz0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDIpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dIC09IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAzKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSAqPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gLz0gdmFsdWU7IH0KCQl9CgkJZWxzZSBpZiAobGVuID09IDMpCgkJewoJCQlpZiAob3BlcmF0aW9uID09IDApIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV0gPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSArPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAtPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMykgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAqPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSAvPSB2YWx1ZTsgfQoJCX0KCQllbHNlIGlmIChsZW4gPT0gNCkKCQl7CgkJCWlmIChvcGVyYXRpb24gPT0gMCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dID0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDEpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSArPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dIC09IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAzKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gKj0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDQpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSAvPSB2YWx1ZTsgfQoJCX0KCQllbHNlCgkJewoJCQkvLwlUT0RPIC0gRGVlcCBwcm9wZXJ0eSBzY2FuZQoJCX0KCgl9LAoKCS8qKgogICAgICogVGhpcyBmdW5jdGlvbiBhbGxvd3MgeW91IHRvIHF1aWNrbHkgc2V0IHRoZSBzYW1lIHByb3BlcnR5IGFjcm9zcyBhbGwgY2hpbGRyZW4gb2YgdGhpcyBHcm91cCB0byBhIG5ldyB2YWx1ZS4KICAgICAqIFRoZSBvcGVyYXRpb24gcGFyYW1ldGVyIGNvbnRyb2xzIGhvdyB0aGUgbmV3IHZhbHVlIGlzIGFzc2lnbmVkIHRvIHRoZSBwcm9wZXJ0eSwgZnJvbSBzaW1wbGUgcmVwbGFjZW1lbnQgdG8gYWRkaXRpb24gYW5kIG11bHRpcGxpY2F0aW9uLgogICAgICoKICAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3NldEFsbAogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBwcm9wZXJ0eSwgYXMgYSBzdHJpbmcsIHRvIGJlIHNldC4gRm9yIGV4YW1wbGU6ICdib2R5LnZlbG9jaXR5LngnCiAgICAgKiBAcGFyYW0geyp9IHZhbHVlIC0gVGhlIHZhbHVlIHRoYXQgd2lsbCBiZSBzZXQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjaGVja0FsaXZlPWZhbHNlXSAtIElmIHNldCB0aGVuIG9ubHkgY2hpbGRyZW4gd2l0aCBhbGl2ZT10cnVlIHdpbGwgYmUgdXBkYXRlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrVmlzaWJsZT1mYWxzZV0gLSBJZiBzZXQgdGhlbiBvbmx5IGNoaWxkcmVuIHdpdGggdmlzaWJsZT10cnVlIHdpbGwgYmUgdXBkYXRlZC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBbb3BlcmF0aW9uPTBdIC0gQ29udHJvbHMgaG93IHRoZSB2YWx1ZSBpcyBhc3NpZ25lZC4gQSB2YWx1ZSBvZiAwIHJlcGxhY2VzIHRoZSB2YWx1ZSB3aXRoIHRoZSBuZXcgb25lLiBBIHZhbHVlIG9mIDEgYWRkcyBpdCwgMiBzdWJ0cmFjdHMgaXQsIDMgbXVsdGlwbGllcyBpdCBhbmQgNCBkaXZpZGVzIGl0LgogICAgICovCglzZXRBbGw6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIG9wZXJhdGlvbikgewoKCQlrZXkgPSBrZXkuc3BsaXQoJy4nKTsKCgkJaWYgKHR5cGVvZiBjaGVja0FsaXZlID09PSAndW5kZWZpbmVkJykgeyBjaGVja0FsaXZlID0gZmFsc2U7IH0KCQlpZiAodHlwZW9mIGNoZWNrVmlzaWJsZSA9PT0gJ3VuZGVmaW5lZCcpIHsgY2hlY2tWaXNpYmxlID0gZmFsc2U7IH0KCgkJb3BlcmF0aW9uID0gb3BlcmF0aW9uIHx8IDA7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQoJCXsKCQkJdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKCQkJCQoJCQlkbwkKCQkJewoJCQkJaWYgKChjaGVja0FsaXZlID09IGZhbHNlIHx8IChjaGVja0FsaXZlICYmIGN1cnJlbnROb2RlLmFsaXZlKSkgJiYgKGNoZWNrVmlzaWJsZSA9PSBmYWxzZSB8fCAoY2hlY2tWaXNpYmxlICYmIGN1cnJlbnROb2RlLnZpc2libGUpKSkKCQkJCXsKCQkJCQl0aGlzLnNldFByb3BlcnR5KGN1cnJlbnROb2RlLCBrZXksIHZhbHVlLCBvcGVyYXRpb24pOwoJCQkJfQoKCQkJCWN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwoJCQl9CgkJCXdoaWxlIChjdXJyZW50Tm9kZSAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpCgkJfQoKCX0sCgoJLyoqCiAgICAgKiBBZGRzIHRoZSBhbW91bnQgdG8gdGhlIGdpdmVuIHByb3BlcnR5IG9uIGFsbCBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLgogICAgICogR3JvdXAuYWRkQWxsKCd4JywgMTApIHdpbGwgYWRkIDEwIHRvIHRoZSBjaGlsZC54IHZhbHVlLgogICAgICoKICAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2FkZEFsbAogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIGluY3JlbWVudCwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGluY3JlbWVudCB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMCB0aGVuIGFkZEFsbCgneCcsIDQwKSB3b3VsZCBtYWtlIGNoaWxkLnggPSA1MC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tBbGl2ZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyBhbGl2ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAgKi8KCWFkZEFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKCQl0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDEpOwoKCX0sCgoJLyoqCiAgICAgKiBTdWJ0cmFjdHMgdGhlIGFtb3VudCBmcm9tIHRoZSBnaXZlbiBwcm9wZXJ0eSBvbiBhbGwgY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4KICAgICAqIEdyb3VwLnN1YkFsbCgneCcsIDEwKSB3aWxsIG1pbnVzIDEwIGZyb20gdGhlIGNoaWxkLnggdmFsdWUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc3ViQWxsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gZGVjcmVtZW50LCBmb3IgZXhhbXBsZSAnYm9keS52ZWxvY2l0eS54JyBvciAnYW5nbGUnLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgcHJvcGVydHkuIElmIGNoaWxkLnggPSA1MCB0aGVuIHN1YkFsbCgneCcsIDQwKSB3b3VsZCBtYWtlIGNoaWxkLnggPSAxMC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tBbGl2ZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyBhbGl2ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAgKi8KCXN1YkFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKCQl0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDIpOwoKCX0sCgoJLyoqCiAgICAgKiBNdWx0aXBsaWVzIHRoZSBnaXZlbiBwcm9wZXJ0eSBieSB0aGUgYW1vdW50IG9uIGFsbCBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLgogICAgICogR3JvdXAubXVsdGlwbHlBbGwoJ3gnLCAyKSB3aWxsIHgyIHRoZSBjaGlsZC54IHZhbHVlLgogICAgICoKICAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI211bHRpcGx5QWxsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gbXVsdGlwbHksIGZvciBleGFtcGxlICdib2R5LnZlbG9jaXR5LngnIG9yICdhbmdsZScuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBtdWx0aXBseSB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMCB0aGVuIG11bHRpcGx5QWxsKCd4JywgMikgd291bGQgbWFrZSBjaGlsZC54ID0gMjAuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrQWxpdmUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgYWxpdmUuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrVmlzaWJsZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyB2aXNpYmxlLgogICAgICovCgltdWx0aXBseUFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKCQl0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDMpOwoKCX0sCgoJLyoqCiAgICAgKiBEaXZpZGVzIHRoZSBnaXZlbiBwcm9wZXJ0eSBieSB0aGUgYW1vdW50IG9uIGFsbCBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLgogICAgICogR3JvdXAuZGl2aWRlQWxsKCd4JywgMikgd2lsbCBoYWxmIHRoZSBjaGlsZC54IHZhbHVlLgogICAgICoKICAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2RpdmlkZUFsbAogICAgICogQHBhcmFtIHtzdHJpbmd9IHByb3BlcnR5IC0gVGhlIHByb3BlcnR5IHRvIGRpdmlkZSwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGRpdmlkZSB0aGUgcHJvcGVydHkgYnkuIElmIGNoaWxkLnggPSAxMDAgdGhlbiBkaXZpZGVBbGwoJ3gnLCAyKSB3b3VsZCBtYWtlIGNoaWxkLnggPSA1MC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tBbGl2ZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyBhbGl2ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAgKi8KCWRpdmlkZUFsbDogZnVuY3Rpb24gKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSkgewoKCQl0aGlzLnNldEFsbChwcm9wZXJ0eSwgYW1vdW50LCBjaGVja0FsaXZlLCBjaGVja1Zpc2libGUsIDQpOwoKCX0sCgoJLyoqCiAgICAqIENhbGxzIGEgZnVuY3Rpb24gb24gYWxsIG9mIHRoZSBjaGlsZHJlbiB0aGF0IGhhdmUgZXhpc3RzPXRydWUgaW4gdGhpcyBHcm91cC4KICAgICogQWZ0ZXIgdGhlIGV4aXN0c1ZhbHVlIHBhcmFtZXRlciB5b3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2hpbGQgY2FsbGJhY2suCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjYWxsQWxsRXhpc3RzCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgZXhpc3RzIG9uIHRoZSBjaGlsZHJlbiB0aGF0IHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGV4aXN0c1ZhbHVlIC0gT25seSBjaGlsZHJlbiB3aXRoIGV4aXN0cz1leGlzdHNWYWx1ZSB3aWxsIGJlIGNhbGxlZC4KICAgICogQHBhcmFtIHsuLi4qfSBwYXJhbWV0ZXIgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2suCiAgICAqLwoJY2FsbEFsbEV4aXN0czogZnVuY3Rpb24gKGNhbGxiYWNrLCBleGlzdHNWYWx1ZSkgewoKCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoKCQlpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKCQl7CgkJCXZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CgkJCQkKCQkJZG8JCgkJCXsKCQkJCWlmIChjdXJyZW50Tm9kZS5leGlzdHMgPT0gZXhpc3RzVmFsdWUgJiYgY3VycmVudE5vZGVbY2FsbGJhY2tdKQoJCQkJewoJCQkJCWN1cnJlbnROb2RlW2NhbGxiYWNrXS5hcHBseShjdXJyZW50Tm9kZSwgYXJncyk7CgkJCQl9CgoJCQkJY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CgkJCX0KCQkJd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCkKCgkJfQoKCX0sCgoJLyoqCiAgICAqIENhbGxzIGEgZnVuY3Rpb24gb24gYWxsIG9mIHRoZSBjaGlsZHJlbiB0aGF0IGhhdmUgZXhpc3RzPXRydWUgaW4gdGhpcyBHcm91cC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxiYWNrRnJvbUFycmF5CiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjaGlsZCAtIFRoZSBvYmplY3QgdG8gaW5zcGVjdC4KICAgICogQHBhcmFtIHthcnJheX0gY2FsbGJhY2sgLSBUaGUgYXJyYXkgb2YgZnVuY3Rpb24gbmFtZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgc2l6ZSBvZiB0aGUgYXJyYXkgKHByZS1jYWxjdWxhdGVkIGluIGNhbGxBbGwpLgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJY2FsbGJhY2tGcm9tQXJyYXk6IGZ1bmN0aW9uIChjaGlsZCwgY2FsbGJhY2ssIGxlbmd0aCkgewoKCQkvLwlLaW5kYSBsb29rcyBsaWtlIGEgQ2hyaXN0bWFzIHRyZWUKCgkJaWYgKGxlbmd0aCA9PSAxKQoJCXsKCQkJaWYgKGNoaWxkW2NhbGxiYWNrWzBdXSkKCQkJewoJCQkJcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXTsKCQkJfQoJCX0KCQllbHNlIGlmIChsZW5ndGggPT0gMikKCQl7CgkJCWlmIChjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dKQoJCQl7CgkJCQlyZXR1cm4gY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXTsKCQkJfQoJCX0KCQllbHNlIGlmIChsZW5ndGggPT0gMykKCQl7CgkJCWlmIChjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dW2NhbGxiYWNrWzJdXSkKCQkJewoJCQkJcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dOwoJCQl9CgkJfQoJCWVsc2UgaWYgKGxlbmd0aCA9PSA0KQoJCXsKCQkJaWYgKGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dW2NhbGxiYWNrWzNdXSkKCQkJewoJCQkJcmV0dXJuIGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dW2NhbGxiYWNrWzNdXTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlpZiAoY2hpbGRbY2FsbGJhY2tdKQoJCQl7CgkJCQlyZXR1cm4gY2hpbGRbY2FsbGJhY2tdOwoJCQl9CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCgkvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgb2YgdGhlIGNoaWxkcmVuIHJlZ2FyZGxlc3MgaWYgdGhleSBhcmUgZGVhZCBvciBhbGl2ZSAoc2VlIGNhbGxBbGxFeGlzdHMgaWYgeW91IG5lZWQgY29udHJvbCBvdmVyIHRoYXQpCiAgICAqIEFmdGVyIHRoZSBtZXRob2QgcGFyYW1ldGVyIGFuZCBjb250ZXh0IHlvdSBjYW4gYWRkIGFzIG1hbnkgZXh0cmEgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjaGlsZC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxBbGwKICAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZCAtIEEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIFRoZSBmdW5jdGlvbiBtdXN0IGV4aXN0IG9uIHRoZSBjaGlsZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb250ZXh0PScnXSAtIEEgc3RyaW5nIGNvbnRhaW5pbmcgdGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIG1ldGhvZCB3aWxsIGJlIGV4ZWN1dGVkLiBMZWF2ZSB0byAnJyB0byBkZWZhdWx0IHRvIHRoZSBjaGlsZC4KICAgICogQHBhcmFtIHsuLi4qfSBwYXJhbWV0ZXIgLSBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgbWV0aG9kLgogICAgKi8KCWNhbGxBbGw6IGZ1bmN0aW9uIChtZXRob2QsIGNvbnRleHQpIHsKCgkJaWYgKHR5cGVvZiBtZXRob2QgPT09ICd1bmRlZmluZWQnKQoJCXsKCQkJcmV0dXJuOwoJCX0KCgkJLy8JRXh0cmFjdCB0aGUgbWV0aG9kIGludG8gYW4gYXJyYXkKCQltZXRob2QgPSBtZXRob2Quc3BsaXQoJy4nKTsKCgkJdmFyIG1ldGhvZExlbmd0aCA9IG1ldGhvZC5sZW5ndGg7CgoJCWlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3VuZGVmaW5lZCcpCgkJewoJCQljb250ZXh0ID0gbnVsbDsKCQl9CgkJZWxzZQoJCXsKCQkJLy8JRXh0cmFjdCB0aGUgY29udGV4dCBpbnRvIGFuIGFycmF5CgkJCWlmICh0eXBlb2YgY29udGV4dCA9PT0gJ3N0cmluZycpCgkJCXsKCQkJCWNvbnRleHQgPSBjb250ZXh0LnNwbGl0KCcuJyk7CgkJCQl2YXIgY29udGV4dExlbmd0aCA9IGNvbnRleHQubGVuZ3RoOwoJCQl9CgkJfQoKCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJCXZhciBjYWxsYmFjayA9IG51bGw7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQoJCXsKCQkJdmFyIGNoaWxkID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKCQkJCQoJCQlkbwkKCQkJewoJCQkJY2FsbGJhY2sgPSB0aGlzLmNhbGxiYWNrRnJvbUFycmF5KGNoaWxkLCBtZXRob2QsIG1ldGhvZExlbmd0aCk7CgoJCQkJaWYgKGNvbnRleHQgJiYgY2FsbGJhY2spCgkJCQl7CgkJCQkJY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5jYWxsYmFja0Zyb21BcnJheShjaGlsZCwgY29udGV4dCwgY29udGV4dExlbmd0aCk7CgkKCQkJCQlpZiAoY2FsbGJhY2spCgkJCQkJewoJCQkJCQljYWxsYmFjay5hcHBseShjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoJCQkJCX0KCQkJCX0KCQkJCWVsc2UgaWYgKGNhbGxiYWNrKQoJCQkJewoJCQkJCWNhbGxiYWNrLmFwcGx5KGNoaWxkLCBhcmdzKTsKCQkJCX0KCgkJCQljaGlsZCA9IGNoaWxkLl9pTmV4dDsKCQkJfQoJCQl3aGlsZSAoY2hpbGQgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KQoKCQl9CgoJfSwKCgkvKioKCSogQWxsb3dzIHlvdSB0byBjYWxsIHlvdXIgb3duIGZ1bmN0aW9uIG9uIGVhY2ggbWVtYmVyIG9mIHRoaXMgR3JvdXAuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAJKiBBZnRlciB0aGUgY2hlY2tFeGlzdHMgcGFyYW1ldGVyIHlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgCSogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2goYXdhcmRCb251c0dvbGQsIHRoaXMsIHRydWUsIDEwMCwgNTAwKQoJKiAKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaAoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLiBFYWNoIGNoaWxkIG9mIHRoZSBHcm91cCB3aWxsIGJlIHBhc3NlZCB0byBpdCBhcyBpdHMgZmlyc3QgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0V4aXN0cyAtIElmIHNldCBvbmx5IGNoaWxkcmVuIHdpdGggZXhpc3RzPXRydWUgd2lsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrLCBvdGhlcndpc2UgYWxsIGNoaWxkcmVuIHdpbGwgYmUgcGFzc2VkLgoJKi8KCWZvckVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBjaGVja0V4aXN0cykgewoKCQlpZiAodHlwZW9mIGNoZWNrRXhpc3RzID09PSAndW5kZWZpbmVkJykKCQl7CgkJCWNoZWNrRXhpc3RzID0gZmFsc2U7CgkJfQoKCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDMpOwoJCWFyZ3MudW5zaGlmdChudWxsKTsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCgkJewoJCQl2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwoJCQkJCgkJCWRvCQoJCQl7CgkJCQlpZiAoY2hlY2tFeGlzdHMgPT0gZmFsc2UgfHwgKGNoZWNrRXhpc3RzICYmIGN1cnJlbnROb2RlLmV4aXN0cykpCgkJCQl7CgkJCQkJYXJnc1swXSA9IGN1cnJlbnROb2RlOwoJCQkJCWNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgkJCQl9CgoJCQkJY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CgkJCX0KCQkJd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCk7CgoJCX0KCgl9LAoKCS8qKgoJKiBBbGxvd3MgeW91IHRvIGNhbGwgeW91ciBvd24gZnVuY3Rpb24gb24gZWFjaCBhbGl2ZSBtZW1iZXIgb2YgdGhpcyBHcm91cCAod2hlcmUgY2hpbGQuYWxpdmU9dHJ1ZSkuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAJKiBZb3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQuCiAgIAkqIEZvciBleGFtcGxlOiBHcm91cC5mb3JFYWNoQWxpdmUoY2F1c2VEYW1hZ2UsIHRoaXMsIDUwMCkKCSogCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2ZvckVhY2hBbGl2ZQoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLiBFYWNoIGNoaWxkIG9mIHRoZSBHcm91cCB3aWxsIGJlIHBhc3NlZCB0byBpdCBhcyBpdHMgZmlyc3QgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KCSovCglmb3JFYWNoRXhpc3RzOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJCWFyZ3MudW5zaGlmdChudWxsKTsKCgkJdGhpcy5pdGVyYXRlKCdleGlzdHMnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCgl9LAoKCS8qKgoJKiBBbGxvd3MgeW91IHRvIGNhbGwgeW91ciBvd24gZnVuY3Rpb24gb24gZWFjaCBhbGl2ZSBtZW1iZXIgb2YgdGhpcyBHcm91cCAod2hlcmUgY2hpbGQuYWxpdmU9dHJ1ZSkuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAJKiBZb3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQuCiAgIAkqIEZvciBleGFtcGxlOiBHcm91cC5mb3JFYWNoQWxpdmUoY2F1c2VEYW1hZ2UsIHRoaXMsIDUwMCkKCSogCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2ZvckVhY2hBbGl2ZQoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLiBFYWNoIGNoaWxkIG9mIHRoZSBHcm91cCB3aWxsIGJlIHBhc3NlZCB0byBpdCBhcyBpdHMgZmlyc3QgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KCSovCglmb3JFYWNoQWxpdmU6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkJYXJncy51bnNoaWZ0KG51bGwpOwoKCQl0aGlzLml0ZXJhdGUoJ2FsaXZlJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgoJfSwKCgkvKioKCSogQWxsb3dzIHlvdSB0byBjYWxsIHlvdXIgb3duIGZ1bmN0aW9uIG9uIGVhY2ggZGVhZCBtZW1iZXIgb2YgdGhpcyBHcm91cCAod2hlcmUgYWxpdmU9ZmFsc2UpLiBZb3UgbXVzdCBwYXNzIHRoZSBjYWxsYmFjayBhbmQgY29udGV4dCBpbiB3aGljaCBpdCB3aWxsIHJ1bi4KICAgCSogWW91IGNhbiBhZGQgYXMgbWFueSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLgogICAJKiBGb3IgZXhhbXBsZTogR3JvdXAuZm9yRWFjaERlYWQoYnJpbmdUb0xpZmUsIHRoaXMpCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNmb3JFYWNoRGVhZAoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkLiBFYWNoIGNoaWxkIG9mIHRoZSBHcm91cCB3aWxsIGJlIHBhc3NlZCB0byBpdCBhcyBpdHMgZmlyc3QgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGZ1bmN0aW9uIHNob3VsZCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KCSovCglmb3JFYWNoRGVhZDogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCQlhcmdzLnVuc2hpZnQobnVsbCk7CgoJCXRoaXMuaXRlcmF0ZSgnYWxpdmUnLCBmYWxzZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgoJfSwKCgkvKioKCSogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHNvcnQgdGhlIGdyb3VwIGFjY29yZGluZyB0byBhIHBhcnRpY3VsYXIgdmFsdWUgYW5kIG9yZGVyLgoJKiBGb3IgZXhhbXBsZSB0byBkZXB0aCBzb3J0IFNwcml0ZXMgZm9yIFplbGRhLXN0eWxlIGdhbWUgeW91IG1pZ2h0IGNhbGwgYGdyb3VwLnNvcnQoJ3knLCBQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcpYCBhdCB0aGUgYm90dG9tIG9mIHlvdXIgYFN0YXRlLnVwZGF0ZSgpYC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc29ydAoJKiBAcGFyYW0ge3N0cmluZ30gW2luZGV4PSd5J10gLSBUaGUgYHN0cmluZ2AgbmFtZSBvZiB0aGUgcHJvcGVydHkgeW91IHdhbnQgdG8gc29ydCBvbi4KCSogQHBhcmFtIHtudW1iZXJ9IFtvcmRlcj1QaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkddIC0gVGhlIGBHcm91cGAgY29uc3RhbnQgdGhhdCBkZWZpbmVzIHRoZSBzb3J0IG9yZGVyLiBQb3NzaWJsZSB2YWx1ZXMgYXJlIFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORyBhbmQgUGhhc2VyLkdyb3VwLlNPUlRfREVTQ0VORElORy4KCSovCglzb3J0OiBmdW5jdGlvbiAoaW5kZXgsIG9yZGVyKSB7CgoJCWlmICh0eXBlb2YgaW5kZXggPT09ICd1bmRlZmluZWQnKSB7IGluZGV4ID0gJ3knOyB9CgkJaWYgKHR5cGVvZiBvcmRlciA9PT0gJ3VuZGVmaW5lZCcpIHsgb3JkZXIgPSBQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkc7IH0KCgkJdmFyIHN3YXBwZWQ7CgkJdmFyIHRlbXA7CgoJICAgIGRvIHsKCgkgICAgICAgIHN3YXBwZWQgPSBmYWxzZTsKCgkgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoIC0gMTsgaSA8IGxlbjsgaSsrKQoJICAgICAgICB7CgkgICAgICAgIAlpZiAob3JkZXIgPT0gUGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HKQoJICAgICAgICAJewoJCSAgICAgICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV1baW5kZXhdID4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXVtpbmRleF0pCgkJICAgICAgICAgICAgewoJCSAgICAgICAgICAgIAl0aGlzLnN3YXAodGhpcy5nZXRBdChpKSwgdGhpcy5nZXRBdChpICsgMSkpOwoJCSAgICAgICAgICAgICAgICB0ZW1wID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldOwoJCSAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV0gPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdOwoJCSAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdID0gdGVtcDsKCQkgICAgICAgICAgICAgICAgc3dhcHBlZCA9IHRydWU7CgkJICAgICAgICAgICAgfQoJICAgICAgICAJfQoJICAgICAgICAJZWxzZQoJICAgICAgICAJewoJCSAgICAgICAgICAgIGlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV1baW5kZXhdIDwgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2kgKyAxXVtpbmRleF0pCgkJICAgICAgICAgICAgewoJCSAgICAgICAgICAgIAl0aGlzLnN3YXAodGhpcy5nZXRBdChpKSwgdGhpcy5nZXRBdChpICsgMSkpOwoJCSAgICAgICAgICAgICAgICB0ZW1wID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldOwoJCSAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV0gPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdOwoJCSAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdID0gdGVtcDsKCQkgICAgICAgICAgICAgICAgc3dhcHBlZCA9IHRydWU7CgkJICAgICAgICAgICAgfQoJICAgICAgICAJfQoJICAgICAgICB9CgkgICAgfSB3aGlsZSAoc3dhcHBlZCk7CgoJfSwKCgkvKioKCSogSXRlcmF0ZXMgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIEdyb3VwLiBXaGVuIGEgY2hpbGQgaGFzIGEgcHJvcGVydHkgbWF0Y2hpbmcga2V5IHRoYXQgZXF1YWxzIHRoZSBnaXZlbiB2YWx1ZSwgaXQgaXMgY29uc2lkZXJlZCBhcyBhIG1hdGNoLgoJKiBNYXRjaGVkIGNoaWxkcmVuIGNhbiBiZSBzZW50IHRvIHRoZSBvcHRpb25hbCBjYWxsYmFjaywgb3Igc2ltcGx5IHJldHVybmVkIG9yIGNvdW50ZWQuCiAgIAkqIFlvdSBjYW4gYWRkIGFzIG1hbnkgY2FsbGJhY2sgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZCwgYWZ0ZXIgdGhlIGNhbGxiYWNrQ29udGV4dCBwYXJhbWV0ZXIuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNpdGVyYXRlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgY2hpbGQgcHJvcGVydHkgdG8gY2hlY2ssIGkuZS4gJ2V4aXN0cycsICdhbGl2ZScsICdoZWFsdGgnCgkqIEBwYXJhbSB7YW55fSB2YWx1ZSAtIElmIGNoaWxkLmtleSA9PT0gdGhpcyB2YWx1ZSBpdCB3aWxsIGJlIGNvbnNpZGVyZWQgYSBtYXRjaC4gTm90ZSB0aGF0IGEgc3RyaWN0IGNvbXBhcmlzb24gaXMgdXNlZC4KCSogQHBhcmFtIHtudW1iZXJ9IHJldHVyblR5cGUgLSBIb3cgdG8gcmV0dXJuIHRoZSBkYXRhIGZyb20gdGhpcyBtZXRob2QuIEVpdGhlciBQaGFzZXIuR3JvdXAuUkVUVVJOX05PTkUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwgb3IgUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRC4KCSogQHBhcmFtIHtmdW5jdGlvbn0gW2NhbGxiYWNrPW51bGxdIC0gT3B0aW9uYWwgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZCBvbiBlYWNoIG1hdGNoaW5nIGNoaWxkLiBFYWNoIGNoaWxkIG9mIHRoZSBHcm91cCB3aWxsIGJlIHBhc3NlZCB0byBpdCBhcyBpdHMgZmlyc3QgcGFyYW1ldGVyLgogICAgKiBAcGFyYW0ge09iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgoJKi8KCWl0ZXJhdGU6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCByZXR1cm5UeXBlLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKSB7CgoJCWlmIChyZXR1cm5UeXBlID09IFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwgJiYgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA9PSAwKQoJCXsKCQkJcmV0dXJuIC0xOwoJCX0KCgkJaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gJ3VuZGVmaW5lZCcpCgkJewoJCQljYWxsYmFjayA9IGZhbHNlOwoJCX0KCgkJdmFyIHRvdGFsID0gMDsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCgkJewoJCQl2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwoJCQkJCgkJCWRvCQoJCQl7CgkJCQlpZiAoY3VycmVudE5vZGVba2V5XSA9PT0gdmFsdWUpCgkJCQl7CgkJCQkJdG90YWwrKzsKCgkJCQkJaWYgKGNhbGxiYWNrKQoJCQkJCXsKCQkJCQkJYXJnc1swXSA9IGN1cnJlbnROb2RlOwoJCQkJCQljYWxsYmFjay5hcHBseShjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoJCQkJCX0KCgkJCQkJaWYgKHJldHVyblR5cGUgPT0gUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCkKCQkJCQl7CgkJCQkJCXJldHVybiBjdXJyZW50Tm9kZTsKCQkJCQl9CgkJCQl9CgoJCQkJY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CgkJCX0KCQkJd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCk7CgkJfQoKCQlpZiAocmV0dXJuVHlwZSA9PSBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKQoJCXsKCQkJcmV0dXJuIHRvdGFsOwoJCX0KCQllbHNlIGlmIChyZXR1cm5UeXBlID09IFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpCgkJewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJfSwKCgkvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHJldHJpZXZlIHRoZSBmaXJzdCBvYmplY3Qgd2l0aCBleGlzdHMgPT0gKHRoZSBnaXZlbiBzdGF0ZSkgaW4gdGhlIEdyb3VwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRGaXJzdEV4aXN0cwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHN0YXRlIC0gVHJ1ZSBvciBmYWxzZS4KICAgICogQHJldHVybiB7QW55fSBUaGUgZmlyc3QgY2hpbGQsIG9yIG51bGwgaWYgbm9uZSBmb3VuZC4KICAgICovCglnZXRGaXJzdEV4aXN0czogZnVuY3Rpb24gKHN0YXRlKSB7CgoJCWlmICh0eXBlb2Ygc3RhdGUgIT09ICdib29sZWFuJykKCQl7CgkJCXN0YXRlID0gdHJ1ZTsKCQl9CgoJCXJldHVybiB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHN0YXRlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKTsKCgl9LAoKCS8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIGZpcnN0IG9iamVjdCB3aXRoIGFsaXZlID09IHRydWUgaW4gdGhlIGdyb3VwLgogICAgKiBUaGlzIGlzIGhhbmR5IGZvciBjaGVja2luZyBpZiBldmVyeXRoaW5nIGhhcyBiZWVuIHdpcGVkIG91dCwgb3IgY2hvb3NpbmcgYSBzcXVhZCBsZWFkZXIsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0Rmlyc3RBbGl2ZQogICAgKiBAcmV0dXJuIHtBbnl9IFRoZSBmaXJzdCBhbGl2ZSBjaGlsZCwgb3IgbnVsbCBpZiBub25lIGZvdW5kLgogICAgKi8KCWdldEZpcnN0QWxpdmU6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKTsKCgl9LAoKCS8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIGZpcnN0IG9iamVjdCB3aXRoIGFsaXZlID09IGZhbHNlIGluIHRoZSBncm91cC4KICAgICogVGhpcyBpcyBoYW5keSBmb3IgY2hlY2tpbmcgaWYgZXZlcnl0aGluZyBoYXMgYmVlbiB3aXBlZCBvdXQsIG9yIGNob29zaW5nIGEgc3F1YWQgbGVhZGVyLCBldGMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEZpcnN0RGVhZAogICAgKiBAcmV0dXJuIHtBbnl9IFRoZSBmaXJzdCBkZWFkIGNoaWxkLCBvciBudWxsIGlmIG5vbmUgZm91bmQuCiAgICAqLwoJZ2V0Rmlyc3REZWFkOiBmdW5jdGlvbiAoKSB7CgoJCXJldHVybiB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgZmFsc2UsIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpOwoKCX0sCgoJLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byBmaW5kIG91dCBob3cgbWFueSBtZW1iZXJzIG9mIHRoZSBncm91cCBhcmUgYWxpdmUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NvdW50TGl2aW5nCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBjaGlsZHJlbiBmbGFnZ2VkIGFzIGFsaXZlLiBSZXR1cm5zIC0xIGlmIEdyb3VwIGlzIGVtcHR5LgogICAgKi8KCWNvdW50TGl2aW5nOiBmdW5jdGlvbiAoKSB7CgoJCXJldHVybiB0aGlzLml0ZXJhdGUoJ2FsaXZlJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCk7CgoJfSwKCgkvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIGZpbmQgb3V0IGhvdyBtYW55IG1lbWJlcnMgb2YgdGhlIGdyb3VwIGFyZSBkZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjb3VudERlYWQKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNoaWxkcmVuIGZsYWdnZWQgYXMgZGVhZC4gUmV0dXJucyAtMSBpZiBHcm91cCBpcyBlbXB0eS4KICAgICovCgljb3VudERlYWQ6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCBmYWxzZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCk7CgoJfSwKCgkvKioKICAgICogUmV0dXJucyBhIG1lbWJlciBhdCByYW5kb20gZnJvbSB0aGUgZ3JvdXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldFJhbmRvbQogICAgKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleCAtIE9wdGlvbmFsIG9mZnNldCBvZmYgdGhlIGZyb250IG9mIHRoZSBhcnJheS4gRGVmYXVsdCB2YWx1ZSBpcyAwLCBvciB0aGUgYmVnaW5uaW5nIG9mIHRoZSBhcnJheS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIE9wdGlvbmFsIHJlc3RyaWN0aW9uIG9uIHRoZSBudW1iZXIgb2YgdmFsdWVzIHlvdSB3YW50IHRvIHJhbmRvbWx5IHNlbGVjdCBmcm9tLgogICAgKiBAcmV0dXJuIHtBbnl9IEEgcmFuZG9tIGNoaWxkIG9mIHRoaXMgR3JvdXAuCiAgICAqLwoJZ2V0UmFuZG9tOiBmdW5jdGlvbiAoc3RhcnRJbmRleCwgbGVuZ3RoKSB7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApCgkJewoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCXN0YXJ0SW5kZXggPSBzdGFydEluZGV4IHx8IDA7CgkJbGVuZ3RoID0gbGVuZ3RoIHx8IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGg7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUubWF0aC5nZXRSYW5kb20odGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLCBzdGFydEluZGV4LCBsZW5ndGgpOwoKCX0sCgoJLyoqCgkqIFJlbW92ZXMgdGhlIGdpdmVuIGNoaWxkIGZyb20gdGhpcyBHcm91cCBhbmQgc2V0cyBpdHMgZ3JvdXAgcHJvcGVydHkgdG8gbnVsbC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcmVtb3ZlCgkqIEBwYXJhbSB7QW55fSBjaGlsZCAtIFRoZSBjaGlsZCB0byByZW1vdmUuCgkqLwoJcmVtb3ZlOiBmdW5jdGlvbiAoY2hpbGQpIHsKCgkJaWYgKGNoaWxkLmV2ZW50cykKCQl7CgkJCWNoaWxkLmV2ZW50cy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwoJCX0KCgkJdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKGNoaWxkKTsKCgkJaWYgKHRoaXMuY3Vyc29yID09IGNoaWxkKQoJCXsKCQkJaWYgKHRoaXMuX2NvbnRhaW5lci5faU5leHQpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gbnVsbDsKCQkJfQoJCX0KCgkJY2hpbGQuZ3JvdXAgPSBudWxsOwoKCX0sCgoJLyoqCgkqIFJlbW92ZXMgYWxsIGNoaWxkcmVuIGZyb20gdGhpcyBHcm91cCwgc2V0dGluZyBhbGwgZ3JvdXAgcHJvcGVydGllcyB0byBudWxsLgoJKiBUaGUgR3JvdXAgY29udGFpbmVyIHJlbWFpbnMgb24gdGhlIGRpc3BsYXkgbGlzdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcmVtb3ZlQWxsCgkqLwoJcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApCgkJewoJCQlyZXR1cm47CgkJfQoKCQlkbwoJCXsKCQkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5ldmVudHMpCgkJCXsKCQkJCXRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXS5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXSwgdGhpcyk7CgkJCX0KCQkJdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlblswXSk7CgkJfQoJCXdoaWxlICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCk7CgoJCXRoaXMuY3Vyc29yID0gbnVsbDsKCgl9LAoKCS8qKgoJKiBSZW1vdmVzIGFsbCBjaGlsZHJlbiBmcm9tIHRoaXMgR3JvdXAgd2hvcyBpbmRleCBmYWxscyBiZXRlZW4gdGhlIGdpdmVuIHN0YXJ0SW5kZXggYW5kIGVuZEluZGV4IHZhbHVlcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjcmVtb3ZlQmV0d2VlbgoJKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleCAtIFRoZSBpbmRleCB0byBzdGFydCByZW1vdmluZyBjaGlsZHJlbiBmcm9tLgoJKiBAcGFyYW0ge251bWJlcn0gZW5kSW5kZXggLSBUaGUgaW5kZXggdG8gc3RvcCByZW1vdmluZyBjaGlsZHJlbiBmcm9tLiBNdXN0IGJlIGhpZ2hlciB0aGFuIHN0YXJ0SW5kZXggYW5kIGxlc3MgdGhhbiB0aGUgbGVuZ3RoIG9mIHRoZSBHcm91cC4KCSovCQoJcmVtb3ZlQmV0d2VlbjogZnVuY3Rpb24gKHN0YXJ0SW5kZXgsIGVuZEluZGV4KSB7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApCgkJewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoc3RhcnRJbmRleCA+IGVuZEluZGV4IHx8IHN0YXJ0SW5kZXggPCAwIHx8IGVuZEluZGV4ID4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWZvciAodmFyIGkgPSBzdGFydEluZGV4OyBpIDwgZW5kSW5kZXg7IGkrKykKCQl7CgkJCXZhciBjaGlsZCA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXTsKCQkJY2hpbGQuZXZlbnRzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CgkJCXRoaXMuX2NvbnRhaW5lci5yZW1vdmVDaGlsZChjaGlsZCk7CgkKCQkJaWYgKHRoaXMuY3Vyc29yID09IGNoaWxkKQoJCQl7CgkJCQlpZiAodGhpcy5fY29udGFpbmVyLl9pTmV4dCkKCQkJCXsKCQkJCQl0aGlzLmN1cnNvciA9IHRoaXMuX2NvbnRhaW5lci5faU5leHQ7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJdGhpcy5jdXJzb3IgPSBudWxsOwoJCQkJfQoJCQl9CgkJfQoKCX0sCgoJLyoqCgkqIERlc3Ryb3lzIHRoaXMgR3JvdXAuIFJlbW92ZXMgYWxsIGNoaWxkcmVuLCB0aGVuIHJlbW92ZXMgdGhlIGNvbnRhaW5lciBmcm9tIHRoZSBkaXNwbGF5IGxpc3QgYW5kIG51bGxzIHJlZmVyZW5jZXMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2Rlc3Ryb3kKCSovCglkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMucmVtb3ZlQWxsKCk7CgoJCXRoaXMuX2NvbnRhaW5lci5wYXJlbnQucmVtb3ZlQ2hpbGQodGhpcy5fY29udGFpbmVyKTsKCgkJdGhpcy5fY29udGFpbmVyID0gbnVsbDsKCgkJdGhpcy5nYW1lID0gbnVsbDsKCgkJdGhpcy5leGlzdHMgPSBmYWxzZTsKCgkJdGhpcy5jdXJzb3IgPSBudWxsOwoKCX0sCgoJdmFsaWRhdGU6IGZ1bmN0aW9uICgpIHsKCgkJdmFyIHRlc3RPYmplY3QgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmxhc3QuX2lOZXh0OwoJCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZTsKCQl2YXIgbmV4dE9iamVjdCA9IG51bGw7CgkJdmFyIHByZXZPYmplY3QgPSBudWxsOwoJCXZhciBjb3VudCA9IDA7CgoJCWRvCQoJCXsKCQkJaWYgKGNvdW50ID4gMCkKCQkJewoJCQkJLy8JY2hlY2sgbmV4dAoJCQkJaWYgKGRpc3BsYXlPYmplY3QgIT09IG5leHRPYmplY3QpCgkJCQl7CgkJCQkJY29uc29sZS5sb2coJ2NoZWNrIG5leHQgZmFpbCcpOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQkvLwljaGVjayBwcmV2aW91cwoJCQkJaWYgKGRpc3BsYXlPYmplY3QuX2lQcmV2ICE9PSBwcmV2T2JqZWN0KQoJCQkJewoJCQkJCWNvbnNvbGUubG9nKCdjaGVjayBwcmV2aW91cyBmYWlsJyk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgoJCQkvLwlTZXQgdGhlIG5leHQgb2JqZWN0CgkJCW5leHRPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCQkJcHJldk9iamVjdCA9IGRpc3BsYXlPYmplY3Q7CgoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CgoJCQljb3VudCsrOwoKCQl9CgkJd2hpbGUoZGlzcGxheU9iamVjdCAhPSB0ZXN0T2JqZWN0KQoKCQlyZXR1cm4gdHJ1ZTsKCgl9LAoKCS8qKgoJKiBEdW1wcyBvdXQgYSBsaXN0IG9mIEdyb3VwIGNoaWxkcmVuIGFuZCB0aGVpciBpbmRleCBwb3NpdGlvbnMgdG8gdGhlIGJyb3dzZXIgY29uc29sZS4gVXNlZnVsIGZvciBncm91cCBkZWJ1Z2dpbmcuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2R1bXAKCSogQHBhcmFtIHtib29sZWFufSBbZnVsbD1mYWxzZV0gLSBJZiBmdWxsIHRoZSBkdW1wIHdpbGwgaW5jbHVkZSB0aGUgZW50aXJlIGRpc3BsYXkgbGlzdCwgc3RhcnQgZnJvbSB0aGUgU3RhZ2UuIE90aGVyd2lzZSBpdCB3aWxsIG9ubHkgaW5jbHVkZSB0aGlzIGNvbnRhaW5lci4KCSovCglkdW1wOiBmdW5jdGlvbiAoZnVsbCkgewoKCQlpZiAodHlwZW9mIGZ1bGwgPT0gJ3VuZGVmaW5lZCcpCgkJewoJCQlmdWxsID0gZmFsc2U7CgkJfQoKCQl2YXIgc3BhY2luZyA9IDIwOwoJCXZhciBvdXRwdXQgPSAiXG4iICsgUGhhc2VyLlV0aWxzLnBhZCgnTm9kZScsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnTmV4dCcsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnUHJldmlvdXMnLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJ0ZpcnN0Jywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCdMYXN0Jywgc3BhY2luZyk7CgoJCWNvbnNvbGUubG9nKG91dHB1dCk7CgoJCXZhciBvdXRwdXQgPSBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZyk7CgkJY29uc29sZS5sb2cob3V0cHV0KTsKCgkJaWYgKGZ1bGwpCgkJewoJCQl2YXIgdGVzdE9iamVjdCA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UubGFzdC5faU5leHQ7CgkJCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZTsKCQl9CgkJZWxzZQoJCXsKCQkJdmFyIHRlc3RPYmplY3QgPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQ7CgkJCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5fY29udGFpbmVyOwoJCX0KCQkKCQlkbwkKCQl7CgkJCXZhciBuYW1lID0gZGlzcGxheU9iamVjdC5uYW1lIHx8ICcqJzsKCgkJCWlmICh0aGlzLmN1cnNvciA9PSBkaXNwbGF5T2JqZWN0KQoJCQl7CgkJCQl2YXIgbmFtZSA9ICc+ICcgKyBuYW1lOwoJCQl9CgoJCQl2YXIgbmFtZU5leHQgPSAnLSc7CgkJCXZhciBuYW1lUHJldiA9ICctJzsKCQkJdmFyIG5hbWVGaXJzdCA9ICctJzsKCQkJdmFyIG5hbWVMYXN0ID0gJy0nOwoKCQkJaWYgKGRpc3BsYXlPYmplY3QuX2lOZXh0KQoJCQl7CgkJCQluYW1lTmV4dCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0Lm5hbWU7CgkJCX0KCgkJCWlmIChkaXNwbGF5T2JqZWN0Ll9pUHJldikKCQkJewoJCQkJbmFtZVByZXYgPSBkaXNwbGF5T2JqZWN0Ll9pUHJldi5uYW1lOwoJCQl9CgoJCQlpZiAoZGlzcGxheU9iamVjdC5maXJzdCkKCQkJewoJCQkJbmFtZUZpcnN0ID0gZGlzcGxheU9iamVjdC5maXJzdC5uYW1lOwoJCQl9CgoJCQlpZiAoZGlzcGxheU9iamVjdC5sYXN0KQoJCQl7CgkJCQluYW1lTGFzdCA9IGRpc3BsYXlPYmplY3QubGFzdC5uYW1lOwoJCQl9CgoJCQlpZiAodHlwZW9mIG5hbWVOZXh0ID09PSAndW5kZWZpbmVkJykKCQkJewoJCQkJbmFtZU5leHQgPSAnLSc7CgkJCX0KCgkJCWlmICh0eXBlb2YgbmFtZVByZXYgPT09ICd1bmRlZmluZWQnKQoJCQl7CgkJCQluYW1lUHJldiA9ICctJzsKCQkJfQoKCQkJaWYgKHR5cGVvZiBuYW1lRmlyc3QgPT09ICd1bmRlZmluZWQnKQoJCQl7CgkJCQluYW1lRmlyc3QgPSAnLSc7CgkJCX0KCgkJCWlmICh0eXBlb2YgbmFtZUxhc3QgPT09ICd1bmRlZmluZWQnKQoJCQl7CgkJCQluYW1lTGFzdCA9ICctJzsKCQkJfQoKCQkJdmFyIG91dHB1dCA9IFBoYXNlci5VdGlscy5wYWQobmFtZSwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVOZXh0LCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQobmFtZVByZXYsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lRmlyc3QsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lTGFzdCwgc3BhY2luZyk7CgkJCWNvbnNvbGUubG9nKG91dHB1dCk7CgoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CgoJCX0KCQl3aGlsZShkaXNwbGF5T2JqZWN0ICE9IHRlc3RPYmplY3QpCgoJfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Hcm91cCN0b3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgY2hpbGRyZW4gaW4gdGhpcyBHcm91cCwgcmVnYXJkbGVzcyBvZiB0aGVpciBhbGl2ZSBzdGF0ZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ0b3RhbCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgIAlyZXR1cm4gdGhpcy5pdGVyYXRlKCdleGlzdHMnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKICAgICAgICAvLyByZXR1cm4gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI2xlbmd0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgbnVtYmVyIG9mIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAibGVuZ3RoIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgCXJldHVybiB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwpOwogICAgICAgIC8vIHJldHVybiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFlvdSBjYW4gYWRqdXN0IHRoZSBHcm91cCBjb250YWluZXIgaXRzZWxmIGJ5IG1vZGlmeWluZyBpdHMgY29vcmRpbmF0ZXMuCiogVGhpcyB3aWxsIGhhdmUgbm8gaW1wYWN0IG9uIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5wb3NpdGlvbi54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gWW91IGNhbiBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyBjb29yZGluYXRlcy4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHgveSBjb29yZGluYXRlcyBvZiBpdHMgY2hpbGRyZW4sIGJ1dCBpdCB3aWxsIHVwZGF0ZSB0aGVpciB3b3JsZFRyYW5zZm9ybSBhbmQgb24tc2NyZWVuIHBvc2l0aW9uLgoqIEBuYW1lIFBoYXNlci5Hcm91cCN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAieSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIG9mIHRoZSBHcm91cCBjb250YWluZXIuIFRoaXMgd2lsbCBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyByb3RhdGlvbi4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHJvdGF0aW9uIHZhbHVlIG9mIGl0cyBjaGlsZHJlbiwgYnV0IGl0IHdpbGwgdXBkYXRlIHRoZWlyIHdvcmxkVHJhbnNmb3JtIGFuZCBvbi1zY3JlZW4gcG9zaXRpb24uCiogQG5hbWUgUGhhc2VyLkdyb3VwI2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIGdpdmVuIGluIGRlZ3JlZXMsIHdoZXJlIDAgZGVncmVlcyA9IHRvIHRoZSByaWdodC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJhbmdsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLl9jb250YWluZXIucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgYW5nbGUgb2Ygcm90YXRpb24gb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gVGhpcyB3aWxsIGFkanVzdCB0aGUgR3JvdXAgY29udGFpbmVyIGl0c2VsZiBieSBtb2RpZnlpbmcgaXRzIHJvdGF0aW9uLgoqIFRoaXMgd2lsbCBoYXZlIG5vIGltcGFjdCBvbiB0aGUgcm90YXRpb24gdmFsdWUgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjcm90YXRpb24KKiBAcHJvcGVydHkge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgb2Ygcm90YXRpb24gZ2l2ZW4gaW4gcmFkaWFucy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJyb3RhdGlvbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnJvdGF0aW9uOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5yb3RhdGlvbiA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIFRoZSB2aXNpYmxlIHN0YXRlIG9mIHRoZSBHcm91cC4gTm9uLXZpc2libGUgR3JvdXBzIGFuZCBhbGwgb2YgdGhlaXIgY2hpbGRyZW4gYXJlIG5vdCByZW5kZXJlZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ2aXNpYmxlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIudmlzaWJsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIudmlzaWJsZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjYWxwaGEKKiBAcHJvcGVydHkge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgdmFsdWUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJhbHBoYSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmFscGhhOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5hbHBoYSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiAiVGhpcyB3b3JsZCBpcyBidXQgYSBjYW52YXMgdG8gb3VyIGltYWdpbmF0aW9uLiIgLSBIZW5yeSBEYXZpZCBUaG9yZWF1CioKKiBBIGdhbWUgaGFzIG9ubHkgb25lIHdvcmxkLiBUaGUgd29ybGQgaXMgYW4gYWJzdHJhY3QgcGxhY2UgaW4gd2hpY2ggYWxsIGdhbWUgb2JqZWN0cyBsaXZlLiBJdCBpcyBub3QgYm91bmQKKiBieSBzdGFnZSBsaW1pdHMgYW5kIGNhbiBiZSBhbnkgc2l6ZS4gWW91IGxvb2sgaW50byB0aGUgd29ybGQgdmlhIGNhbWVyYXMuIEFsbCBnYW1lIG9iamVjdHMgbGl2ZSB3aXRoaW4KKiB0aGUgd29ybGQgYXQgd29ybGQtYmFzZWQgY29vcmRpbmF0ZXMuIEJ5IGRlZmF1bHQgYSB3b3JsZCBpcyBjcmVhdGVkIHRoZSBzYW1lIHNpemUgYXMgeW91ciBTdGFnZS4KKgoqIEBjbGFzcyBQaGFzZXIuV29ybGQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gUmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Xb3JsZCA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgUGhhc2VyLkdyb3VwLmNhbGwodGhpcywgZ2FtZSwgbnVsbCwgJ19fd29ybGQnLCBmYWxzZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIFJlcGxhY2VzIHRoZSBQSVhJLlBvaW50IHdpdGggYSBzbGlnaHRseSBtb3JlIGZsZXhpYmxlIG9uZS4KICAgICovIAogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIFRoZSBXb3JsZCBoYXMgbm8gZml4ZWQgc2l6ZSwgYnV0IGl0IGRvZXMgaGF2ZSBhIGJvdW5kcyBvdXRzaWRlIG9mIHdoaWNoIG9iamVjdHMgYXJlIG5vIGxvbmdlciBjb25zaWRlcmVkIGFzIGJlaW5nICJpbiB3b3JsZCIgYW5kIHlvdSBzaG91bGQgdXNlIHRoaXMgdG8gY2xlYW4tdXAgdGhlIGRpc3BsYXkgbGlzdCBhbmQgcHVyZ2UgZGVhZCBvYmplY3RzLgogICAgKiBCeSBkZWZhdWx0IHdlIHNldCB0aGUgQm91bmRzIHRvIGJlIGZyb20gMCwwIHRvIEdhbWUud2lkdGgsR2FtZS5oZWlnaHQuIEkuZS4gaXQgd2lsbCBtYXRjaCB0aGUgc2l6ZSBnaXZlbiB0byB0aGUgZ2FtZSBjb25zdHJ1Y3RvciB3aXRoIDAsMCByZXByZXNlbnRpbmcgdGhlIHRvcC1sZWZ0IG9mIHRoZSBkaXNwbGF5LgogICAgKiBIb3dldmVyIDAsMCBpcyBhY3R1YWxseSB0aGUgY2VudGVyIG9mIHRoZSB3b3JsZCwgYW5kIGlmIHlvdSByb3RhdGUgb3Igc2NhbGUgdGhlIHdvcmxkIGFsbCBvZiB0aGF0IHdpbGwgaGFwcGVuIGZyb20gMCwwLgogICAgKiBTbyBpZiB5b3Ugd2FudCB0byBtYWtlIGEgZ2FtZSBpbiB3aGljaCB0aGUgd29ybGQgaXRzZWxmIHdpbGwgcm90YXRlIHlvdSBzaG91bGQgYWRqdXN0IHRoZSBib3VuZHMgc28gdGhhdCAwLDAgaXMgdGhlIGNlbnRlciBwb2ludCwgaS5lLiBzZXQgdGhlbSB0byAtMTAwMCwtMTAwMCwyMDAwLDIwMDAgZm9yIGEgMjAwMHgyMDAwIHNpemVkIHdvcmxkIGNlbnRlcmVkIGFyb3VuZCAwLDAuCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzIC0gQm91bmQgb2YgdGhpcyB3b3JsZCB0aGF0IG9iamVjdHMgY2FuIG5vdCBlc2NhcGUgZnJvbS4KCSovCgl0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIGdhbWUud2lkdGgsIGdhbWUuaGVpZ2h0KTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuQ2FtZXJhfSBjYW1lcmEgLSBDYW1lcmEgaW5zdGFuY2UuCgkqLwoJdGhpcy5jYW1lcmEgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFJlbmRlck9yZGVySUQgLSBSZXNldCBlYWNoIGZyYW1lLCBrZWVwcyBhIGNvdW50IG9mIHRoZSB0b3RhbCBudW1iZXIgb2Ygb2JqZWN0cyB1cGRhdGVkLgoJKi8KCXRoaXMuY3VycmVudFJlbmRlck9yZGVySUQgPSAwOwoJCn07CgpQaGFzZXIuV29ybGQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuR3JvdXAucHJvdG90eXBlKTsKUGhhc2VyLldvcmxkLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Xb3JsZDsKCi8qKgoqIEluaXRpYWxpc2VzIHRoZSBnYW1lIHdvcmxkLgoqCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjYm9vdAoqIEBwcm90ZWN0ZWQKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5ib290ID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuY2FtZXJhID0gbmV3IFBoYXNlci5DYW1lcmEodGhpcy5nYW1lLCAwLCAwLCAwLCB0aGlzLmdhbWUud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQpOwoKICAgIHRoaXMuY2FtZXJhLmRpc3BsYXlPYmplY3QgPSB0aGlzLl9jb250YWluZXI7CgogICAgdGhpcy5nYW1lLmNhbWVyYSA9IHRoaXMuY2FtZXJhOwoKfQoKLyoqCiogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBldmVyeSBmcmFtZSwgYW5kIGlzIHdoZXJlIG1haW4gbG9naWMgaGFwcGVucy4KKiAKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCN1cGRhdGUKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CgoJdGhpcy5jdXJyZW50UmVuZGVyT3JkZXJJRCA9IDA7CiAgICAKCWlmICh0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dCkKCXsKCQl2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dDsKICAgICAgICB2YXIgc2tpcENoaWxkcmVuOwoJCQoJCWRvCgkJewogICAgICAgICAgICBza2lwQ2hpbGRyZW4gPSBmYWxzZTsKCgkJCWlmIChjdXJyZW50Tm9kZVsncHJlVXBkYXRlJ10pCgkJCXsKCQkJCXNraXBDaGlsZHJlbiA9IChjdXJyZW50Tm9kZS5wcmVVcGRhdGUoKSA9PT0gZmFsc2UpOwoJCQl9CgoJCQlpZiAoY3VycmVudE5vZGVbJ3VwZGF0ZSddKQoJCQl7CgkJCQlza2lwQ2hpbGRyZW4gPSAoY3VycmVudE5vZGUudXBkYXRlKCkgPT09IGZhbHNlKSB8fCBza2lwQ2hpbGRyZW47CgkJCX0KCQkJCiAgICAgICAgICAgIGlmIChza2lwQ2hpbGRyZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubGFzdC5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICAgICAgfQoJCQkKCQl9CgkJd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UubGFzdC5faU5leHQpCgl9Cgp9CgovKioKKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGV2ZXJ5IGZyYW1lLCBhbmQgaXMgd2hlcmUgbWFpbiBsb2dpYyBoYXBwZW5zLgoqIEBtZXRob2QgUGhhc2VyLldvcmxkI3Bvc3RVcGRhdGUKKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5wb3N0VXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuY2FtZXJhLnVwZGF0ZSgpOwoKICAgIGlmICh0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dCkKICAgIHsKICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmZpcnN0Ll9pTmV4dDsKICAgICAgICAKICAgICAgICBkbyAgCiAgICAgICAgewogICAgICAgICAgICBpZiAoY3VycmVudE5vZGVbJ3Bvc3RVcGRhdGUnXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudE5vZGUucG9zdFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UubGFzdC5faU5leHQpCiAgICB9Cgp9CgovKioKKiBVcGRhdGVzIHRoZSBzaXplIG9mIHRoaXMgd29ybGQuIE5vdGUgdGhhdCB0aGlzIGRvZXNuJ3QgbW9kaWZ5IHRoZSB3b3JsZCB4L3kgY29vcmRpbmF0ZXMsIGp1c3QgdGhlIHdpZHRoIGFuZCBoZWlnaHQuCiogSWYgeW91IG5lZWQgdG8gYWRqdXN0IHRoZSBib3VuZHMgb2YgdGhlIHdvcmxkCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjc2V0Qm91bmRzCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUb3AgbGVmdCBtb3N0IGNvcm5lciBvZiB0aGUgd29ybGQuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUb3AgbGVmdCBtb3N0IGNvcm5lciBvZiB0aGUgd29ybGQuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gTmV3IHdpZHRoIG9mIHRoZSB3b3JsZC4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gTmV3IGhlaWdodCBvZiB0aGUgd29ybGQuCiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUuc2V0Qm91bmRzID0gZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICB0aGlzLmJvdW5kcy5zZXRUbyh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCiAgICBpZiAodGhpcy5jYW1lcmEuYm91bmRzKQogICAgewogICAgICAgIHRoaXMuY2FtZXJhLmJvdW5kcy5zZXRUbyh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKICAgIH0KCn0KCi8qKgoqIERlc3Ryb3llciBvZiB3b3JsZHMuCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjZGVzdHJveQoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5jYW1lcmEueCA9IDA7CiAgICB0aGlzLmNhbWVyYS55ID0gMDsKCiAgICB0aGlzLmdhbWUuaW5wdXQucmVzZXQodHJ1ZSk7CgogICAgdGhpcy5yZW1vdmVBbGwoKTsKCn0KCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCB3aWR0aCBvZiB0aGUgZ2FtZSB3b3JsZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJ3aWR0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMud2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5ib3VuZHMud2lkdGggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI2hlaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgaGVpZ2h0IG9mIHRoZSBnYW1lIHdvcmxkLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgImhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuaGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYm91bmRzLmhlaWdodCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjY2VudGVyWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjZW50ZXJYIC0gR2V0cyB0aGUgWCBwb3NpdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjZW50ZXIgcG9pbnQgb2YgdGhlIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgImNlbnRlclgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLmhhbGZXaWR0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI2NlbnRlclkKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIEdldHMgdGhlIFkgcG9zaXRpb24gY29ycmVzcG9uZGluZyB0byB0aGUgY2VudGVyIHBvaW50IG9mIHRoZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJjZW50ZXJZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5oYWxmSGVpZ2h0OwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjcmFuZG9tWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByYW5kb21YIC0gR2V0cyBhIHJhbmRvbSBpbnRlZ2VyIHdoaWNoIGlzIGxlc3NlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBjdXJyZW50IHdpZHRoIG9mIHRoZSBnYW1lIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgInJhbmRvbVgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcy54IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLngsICh0aGlzLmJvdW5kcy53aWR0aCAtIE1hdGguYWJzKHRoaXMuYm91bmRzLngpKSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLngsIHRoaXMuYm91bmRzLndpZHRoKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjcmFuZG9tWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByYW5kb21ZIC0gR2V0cyBhIHJhbmRvbSBpbnRlZ2VyIHdoaWNoIGlzIGxlc3NlciB0aGFuIG9yIGVxdWFsIHRvIHRoZSBjdXJyZW50IGhlaWdodCBvZiB0aGUgZ2FtZSB3b3JsZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJyYW5kb21ZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5ib3VuZHMueSA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmJvdW5kcy55LCAodGhpcy5ib3VuZHMuaGVpZ2h0IC0gTWF0aC5hYnModGhpcy5ib3VuZHMueSkpKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5ib3VuZHMueSwgdGhpcy5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIEdldHMgb3Igc2V0cyB0aGUgdmlzaWJsZSBzdGF0ZSBvZiB0aGUgV29ybGQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAidmlzaWJsZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnZpc2libGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnZpc2libGUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogR2FtZSBjb25zdHJ1Y3RvcgoqCiogSW5zdGFudGlhdGUgYSBuZXcgPGNvZGU+UGhhc2VyLkdhbWU8L2NvZGU+IG9iamVjdC4KKiBAY2xhc3MgUGhhc2VyLkdhbWUKKiBAY2xhc3NkZXNjIFRoaXMgaXMgd2hlcmUgdGhlIG1hZ2ljIGhhcHBlbnMuIFRoZSBHYW1lIG9iamVjdCBpcyB0aGUgaGVhcnQgb2YgeW91ciBnYW1lLAoqIHByb3ZpZGluZyBxdWljayBhY2Nlc3MgdG8gY29tbW9uIGZ1bmN0aW9ucyBhbmQgaGFuZGxpbmcgdGhlIGJvb3QgcHJvY2Vzcy4KKiAiSGVsbCwgdGhlcmUgYXJlIG5vIHJ1bGVzIGhlcmUgLSB3ZSdyZSB0cnlpbmcgdG8gYWNjb21wbGlzaCBzb21ldGhpbmcuIgoqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRob21hcyBBLiBFZGlzb24KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoPTgwMF0gLSBUaGUgd2lkdGggb2YgeW91ciBnYW1lIGluIGdhbWUgcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTYwMF0gLSBUaGUgaGVpZ2h0IG9mIHlvdXIgZ2FtZSBpbiBnYW1lIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gW3JlbmRlcmVyPVBoYXNlci5BVVRPXSAtIFdoaWNoIHJlbmRlcmVyIHRvIHVzZSAoY2FudmFzIG9yIHdlYmdsKQoqIEBwYXJhbSB7SFRNTEVsZW1lbnR9IFtwYXJlbnQ9JyddIC0gVGhlIEdhbWVzIERPTSBwYXJlbnQuCiogQHBhcmFtIHthbnl9IFtzdGF0ZT1udWxsXSAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW3RyYW5zcGFyZW50PWZhbHNlXSAtIFVzZSBhIHRyYW5zcGFyZW50IGNhbnZhcyBiYWNrZ3JvdW5kIG9yIG5vdC4KKiBAcGFyYW0gIHtib29sZWFufSBbYW50aWFsaWFzPXRydWVdIC0gQW50aS1hbGlhcyBncmFwaGljcy4KKi8KUGhhc2VyLkdhbWUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCwgcmVuZGVyZXIsIHBhcmVudCwgc3RhdGUsIHRyYW5zcGFyZW50LCBhbnRpYWxpYXMpIHsKCgl3aWR0aCA9IHdpZHRoIHx8IDgwMDsKCWhlaWdodCA9IGhlaWdodCB8fCA2MDA7CglyZW5kZXJlciA9IHJlbmRlcmVyIHx8IFBoYXNlci5BVVRPOwoJcGFyZW50ID0gcGFyZW50IHx8ICcnOwoJc3RhdGUgPSBzdGF0ZSB8fCBudWxsOwoKCWlmICh0eXBlb2YgdHJhbnNwYXJlbnQgPT0gJ3VuZGVmaW5lZCcpIHsgdHJhbnNwYXJlbnQgPSBmYWxzZTsgfQoJaWYgKHR5cGVvZiBhbnRpYWxpYXMgPT0gJ3VuZGVmaW5lZCcpIHsgYW50aWFsaWFzID0gdHJ1ZTsgfQoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gaWQgLSBQaGFzZXIgR2FtZSBJRCAoZm9yIHdoZW4gUGl4aSBzdXBwb3J0cyBtdWx0aXBsZSBpbnN0YW5jZXMpLgoJKi8KCXRoaXMuaWQgPSBQaGFzZXIuR0FNRVMucHVzaCh0aGlzKSAtIDE7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7SFRNTEVsZW1lbnR9IHBhcmVudCAtIFRoZSBHYW1lcyBET00gcGFyZW50LgoJKi8KCXRoaXMucGFyZW50ID0gcGFyZW50OwoKCS8vCURvIHNvbWUgbW9yZSBpbnRlbGxpZ2VudCBzaXplIHBhcnNpbmcgaGVyZSwgc28gdGhleSBjYW4gc2V0ICIxMDAlIiBmb3IgZXhhbXBsZSwgbWF5YmUgcGFzcyB0aGUgc2NhbGUgbW9kZSBpbiBoZXJlIHRvbz8KCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIEdhbWUgd2lkdGggKGluIHBpeGVscykuCgkqLwoJdGhpcy53aWR0aCA9IHdpZHRoOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIEdhbWUgaGVpZ2h0IChpbiBwaXhlbHMpLgoJKi8KCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHRyYW5zcGFyZW50IC0gVXNlIGEgdHJhbnNwYXJlbnQgY2FudmFzIGJhY2tncm91bmQgb3Igbm90LgoJKi8KCXRoaXMudHJhbnNwYXJlbnQgPSB0cmFuc3BhcmVudDsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhbnRpYWxpYXMgLSBBbnRpLWFsaWFzIGdyYXBoaWNzIChpbiBXZWJHTCB0aGlzIGhlbHBzIHdpdGggZWRnZXMsIGluIENhbnZhczJEIGl0IHJldGFpbnMgcGl4ZWwtYXJ0IHF1YWxpdHkpLgoJKi8KCXRoaXMuYW50aWFsaWFzID0gYW50aWFsaWFzOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcmVuZGVyZXIgLSBUaGUgUGl4aSBSZW5kZXJlcgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucmVuZGVyZXIgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc3RhdGUgLSBUaGUgU3RhdGVNYW5hZ2VyLgoJKi8KCXRoaXMuc3RhdGUgPSBuZXcgUGhhc2VyLlN0YXRlTWFuYWdlcih0aGlzLCBzdGF0ZSk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3BhdXNlZCAtIElzIGdhbWUgcGF1c2VkPwoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcmVuZGVyVHlwZSAtIFRoZSBSZW5kZXJlciB0aGlzIFBoYXNlci5HYW1lIHdpbGwgdXNlLiBFaXRoZXIgUGhhc2VyLlJFTkRFUkVSX0FVVE8sIFBoYXNlci5SRU5ERVJFUl9DQU5WQVMgb3IgUGhhc2VyLlJFTkRFUkVSX1dFQkdMLgoJKi8KCXRoaXMucmVuZGVyVHlwZSA9IHJlbmRlcmVyOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IF9sb2FkQ29tcGxldGUgLSBXaGV0aGVyIGxvYWQgY29tcGxldGUgbG9hZGluZyBvciBub3QuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fbG9hZENvbXBsZXRlID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNCb290ZWQgLSBXaGV0aGVyIHRoZSBnYW1lIGVuZ2luZSBpcyBib290ZWQsIGFrYSBhdmFpbGFibGUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc0Jvb3RlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGlkIC1JcyBnYW1lIHJ1bm5pbmcgb3IgcGF1c2VkPwoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZX0gcmFmIC0gQXV0b21hdGljYWxseSBoYW5kbGVzIHRoZSBjb3JlIGdhbWUgbG9vcCB2aWEgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIG9yIHNldFRpbWVvdXQKCSogQGRlZmF1bHQKCSovCgl0aGlzLnJhZiA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5fSBhZGQgLSBSZWZlcmVuY2UgdG8gdGhlIEdhbWVPYmplY3QgRmFjdG9yeS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFkZCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkNhY2hlfSBjYWNoZSAtIFJlZmVyZW5jZSB0byB0aGUgYXNzZXRzIGNhY2hlLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY2FjaGUgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5JbnB1dH0gaW5wdXQgLSBSZWZlcmVuY2UgdG8gdGhlIGlucHV0IG1hbmFnZXIKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmlucHV0ID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuTG9hZGVyfSBsb2FkIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgbG9hZGVyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubG9hZCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLk1hdGh9IG1hdGggLSBSZWZlcmVuY2UgdG8gdGhlIG1hdGggaGVscGVyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubWF0aCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLk5ldH0gbmV0IC0gUmVmZXJlbmNlIHRvIHRoZSBuZXR3b3JrIGNsYXNzLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubmV0ID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU291bmRNYW5hZ2VyfSBzb3VuZCAtIFJlZmVyZW5jZSB0byB0aGUgc291bmQgbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnNvdW5kID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU3RhZ2V9IHN0YWdlIC0gUmVmZXJlbmNlIHRvIHRoZSBzdGFnZS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnN0YWdlID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuVGltZU1hbmFnZXJ9IHRpbWUgLSBSZWZlcmVuY2UgdG8gZ2FtZSBjbG9jay4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnRpbWUgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Ud2Vlbk1hbmFnZXJ9IHR3ZWVucyAtIFJlZmVyZW5jZSB0byB0aGUgdHdlZW4gbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnR3ZWVucyA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIFJlZmVyZW5jZSB0byB0aGUgd29ybGQuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy53b3JsZCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuUGh5c2ljc01hbmFnZXJ9IHBoeXNpY3MgLSBSZWZlcmVuY2UgdG8gdGhlIHBoeXNpY3MgbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnBoeXNpY3MgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yfSBybmQgLSBJbnN0YW5jZSBvZiByZXBlYXRhYmxlIHJhbmRvbSBkYXRhIGdlbmVyYXRvciBoZWxwZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5ybmQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5EZXZpY2V9IGRldmljZSAtIENvbnRhaW5zIGRldmljZSBpbmZvcm1hdGlvbiBhbmQgY2FwYWJpbGl0aWVzLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuZGV2aWNlID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5QaHlzaWNzTWFuYWdlcn0gY2FtZXJhIC0gQSBoYW5keSByZWZlcmVuY2UgdG8gd29ybGQuY2FtZXJhLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuY2FtZXJhID0gbnVsbDsKCgkgICAvKioKCSogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gQSBoYW5keSByZWZlcmVuY2UgdG8gcmVuZGVyZXIudmlldy4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmNhbnZhcyA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Q29udGV4dH0gY29udGV4dCAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHJlbmRlcmVyLmNvbnRleHQgKG9ubHkgc2V0IGZvciBDQU5WQVMgZ2FtZXMpCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5jb250ZXh0ID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuVXRpbHMuRGVidWd9IGRlYnVnIC0gQSBzZXQgb2YgdXNlZnVsIGRlYnVnIHV0aWxpdGllLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZGVidWcgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5QYXJ0aWNsZXN9IHBhcnRpY2xlcyAtIFRoZSBQYXJ0aWNsZSBNYW5hZ2VyLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucGFydGljbGVzID0gbnVsbDsKCgl2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHRoaXMuX29uQm9vdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gX3RoaXMuYm9vdCgpOwogICAgfQoKCWlmIChkb2N1bWVudC5yZWFkeVN0YXRlID09PSAnY29tcGxldGUnIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdpbnRlcmFjdGl2ZScpCgl7CgkJd2luZG93LnNldFRpbWVvdXQodGhpcy5fb25Cb290LCAwKTsKCX0KCWVsc2UKCXsKCQlkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgdGhpcy5fb25Cb290LCBmYWxzZSk7CgkJd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWQnLCB0aGlzLl9vbkJvb3QsIGZhbHNlKTsKCX0KCglyZXR1cm4gdGhpczsKCn07CgpQaGFzZXIuR2FtZS5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIEluaXRpYWxpemUgZW5naW5lIHN1YiBtb2R1bGVzIGFuZCBzdGFydCB0aGUgZ2FtZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR2FtZSNib290CgkqIEBwcm90ZWN0ZWQKCSovCglib290OiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLmlzQm9vdGVkKQoJCXsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCFkb2N1bWVudC5ib2R5KQoJCXsKCQkJd2luZG93LnNldFRpbWVvdXQodGhpcy5fb25Cb290LCAyMCk7CgkJfQoJCWVsc2UKCQl7CgkJCWRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0aGlzLl9vbkJvb3QpOwoJCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMuX29uQm9vdCk7CgoJCQl0aGlzLm9uUGF1c2UgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCQkJdGhpcy5vblJlc3VtZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKCQkJdGhpcy5pc0Jvb3RlZCA9IHRydWU7CgoJCQl0aGlzLmRldmljZSA9IG5ldyBQaGFzZXIuRGV2aWNlKCk7CgkJCXRoaXMubWF0aCA9IFBoYXNlci5NYXRoOwoJCQl0aGlzLnJuZCA9IG5ldyBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcihbKERhdGUubm93KCkgKiBNYXRoLnJhbmRvbSgpKS50b1N0cmluZygpXSk7CgoJCQl0aGlzLnN0YWdlID0gbmV3IFBoYXNlci5TdGFnZSh0aGlzLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgoJCQl0aGlzLnNldFVwUmVuZGVyZXIoKTsKCgkJCXRoaXMud29ybGQgPSBuZXcgUGhhc2VyLldvcmxkKHRoaXMpOwoJCQl0aGlzLmFkZCA9IG5ldyBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkodGhpcyk7CgkJCXRoaXMuY2FjaGUgPSBuZXcgUGhhc2VyLkNhY2hlKHRoaXMpOwoJCQl0aGlzLmxvYWQgPSBuZXcgUGhhc2VyLkxvYWRlcih0aGlzKTsKCQkJdGhpcy50aW1lID0gbmV3IFBoYXNlci5UaW1lKHRoaXMpOwoJCQl0aGlzLnR3ZWVucyA9IG5ldyBQaGFzZXIuVHdlZW5NYW5hZ2VyKHRoaXMpOwoJCQl0aGlzLmlucHV0ID0gbmV3IFBoYXNlci5JbnB1dCh0aGlzKTsKCQkJdGhpcy5zb3VuZCA9IG5ldyBQaGFzZXIuU291bmRNYW5hZ2VyKHRoaXMpOwoJCQl0aGlzLnBoeXNpY3MgPSBuZXcgUGhhc2VyLlBoeXNpY3MuQXJjYWRlKHRoaXMpOwoJCQl0aGlzLnBhcnRpY2xlcyA9IG5ldyBQaGFzZXIuUGFydGljbGVzKHRoaXMpOwoJCQl0aGlzLnBsdWdpbnMgPSBuZXcgUGhhc2VyLlBsdWdpbk1hbmFnZXIodGhpcywgdGhpcyk7CgkJCXRoaXMubmV0ID0gbmV3IFBoYXNlci5OZXQodGhpcyk7CgkJCXRoaXMuZGVidWcgPSBuZXcgUGhhc2VyLlV0aWxzLkRlYnVnKHRoaXMpOwoKCQkJdGhpcy5zdGFnZS5ib290KCk7CgkJCXRoaXMud29ybGQuYm9vdCgpOwoJCQl0aGlzLmlucHV0LmJvb3QoKTsKCQkJdGhpcy5zb3VuZC5ib290KCk7CgkJCXRoaXMuc3RhdGUuYm9vdCgpOwoKCQkJdGhpcy5sb2FkLm9uTG9hZENvbXBsZXRlLmFkZCh0aGlzLmxvYWRDb21wbGV0ZSwgdGhpcyk7CgoJCQl0aGlzLnNob3dEZWJ1Z0hlYWRlcigpOwoKCSAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9sb2FkQ29tcGxldGUgPSBmYWxzZTsKCgkJCXRoaXMucmFmID0gbmV3IFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcyk7CgkJCXRoaXMucmFmLnN0YXJ0KCk7CgoJCX0KCgl9LAoKCS8qKgogICAgKiBEaXNwbGF5cyBhIFBoYXNlciB2ZXJzaW9uIGRlYnVnIGhlYWRlciBpbiB0aGUgY29uc29sZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNzaG93RGVidWdIZWFkZXIKICAgICogQHByb3RlY3RlZAogICAgKi8KCXNob3dEZWJ1Z0hlYWRlcjogZnVuY3Rpb24gKCkgewoKCQl2YXIgdiA9IFBoYXNlci5ERVZfVkVSU0lPTjsKCQl2YXIgciA9ICdDYW52YXMnOwoJCXZhciBhID0gJ0hUTUwgQXVkaW8nOwoKCQlpZiAodGhpcy5yZW5kZXJUeXBlID09IFBoYXNlci5XRUJHTCkKCQl7CgkJCXIgPSAnV2ViR0wnOwoJCX0KCgkJaWYgKHRoaXMuZGV2aWNlLndlYkF1ZGlvKQoJCXsKCQkJYSA9ICdXZWJBdWRpbyc7CgkJfQoKCQlpZiAodGhpcy5kZXZpY2UuY2hyb21lKQoJCXsKCQkJdmFyIGFyZ3MgPSBbIAoJCQkJJyVjICVjICVjICBQaGFzZXIgdicgKyB2ICsgJyAtIFJlbmRlcmVyOiAnICsgciArICcgLSBBdWRpbzogJyArIGEgKyAnICAlYyAlYyAnLAoJCQkJJ2JhY2tncm91bmQ6ICMwMGJmZjMnLAoJCQkJJ2JhY2tncm91bmQ6ICMwMDcyYmMnLAoJCQkJJ2NvbG9yOiAjZmZmZmZmOyBiYWNrZ3JvdW5kOiAjMDAzNDcxJywKCQkJCSdiYWNrZ3JvdW5kOiAjMDA3MmJjJywKCQkJCSdiYWNrZ3JvdW5kOiAjMDBiZmYzJwoJCQldOwoKCQkJY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgYXJncyk7CgkJfQoJCWVsc2UKCQl7CgkJCWNvbnNvbGUubG9nKCdQaGFzZXIgdicgKyB2ICsgJyAtIFJlbmRlcmVyOiAnICsgciArICcgLSBBdWRpbzogJyArIGEpOwoJCX0KCgl9LAoKCS8qKgoJKiBDaGVja3MgaWYgdGhlIGRldmljZSBpcyBjYXBhYmxlIG9mIHVzaW5nIHRoZSByZXF1ZXN0ZWQgcmVuZGVyZXIgYW5kIHNldHMgaXQgdXAgb3IgYW4gYWx0ZXJuYXRpdmUgaWYgbm90LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5HYW1lI3NldFVwUmVuZGVyZXIKCSogQHByb3RlY3RlZAoJKi8KCXNldFVwUmVuZGVyZXI6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMucmVuZGVyVHlwZSA9PT0gUGhhc2VyLkNBTlZBUyB8fCAodGhpcy5yZW5kZXJUeXBlID09PSBQaGFzZXIuQVVUTyAmJiB0aGlzLmRldmljZS53ZWJHTCA9PSBmYWxzZSkpCgkJewoJCQlpZiAodGhpcy5kZXZpY2UuY2FudmFzKQoJCQl7CgkJCQl0aGlzLnJlbmRlclR5cGUgPSBQaGFzZXIuQ0FOVkFTOwoJCQkJdGhpcy5yZW5kZXJlciA9IG5ldyBQSVhJLkNhbnZhc1JlbmRlcmVyKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCB0aGlzLnN0YWdlLmNhbnZhcywgdGhpcy50cmFuc3BhcmVudCk7CgkJCQlQaGFzZXIuQ2FudmFzLnNldFNtb290aGluZ0VuYWJsZWQodGhpcy5yZW5kZXJlci5jb250ZXh0LCB0aGlzLmFudGlhbGlhcyk7CgkJCQl0aGlzLmNhbnZhcyA9IHRoaXMucmVuZGVyZXIudmlldzsKCQkJCXRoaXMuY29udGV4dCA9IHRoaXMucmVuZGVyZXIuY29udGV4dDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRocm93IG5ldyBFcnJvcignUGhhc2VyLkdhbWUgLSBjYW5ub3QgY3JlYXRlIENhbnZhcyBvciBXZWJHTCBjb250ZXh0LCBhYm9ydGluZy4nKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQkvLwlUaGV5IHJlcXVlc3RlZCBXZWJHTCwgYW5kIHRoZWlyIGJyb3dzZXIgc3VwcG9ydHMgaXQKCQkJdGhpcy5yZW5kZXJUeXBlID0gUGhhc2VyLldFQkdMOwoJCQl0aGlzLnJlbmRlcmVyID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgdGhpcy5zdGFnZS5jYW52YXMsIHRoaXMudHJhbnNwYXJlbnQsIHRoaXMuYW50aWFsaWFzKTsKCQkJdGhpcy5jYW52YXMgPSB0aGlzLnJlbmRlcmVyLnZpZXc7CgkJCXRoaXMuY29udGV4dCA9IG51bGw7CgkJfQoKICAgICAgICBQaGFzZXIuQ2FudmFzLmFkZFRvRE9NKHRoaXMucmVuZGVyZXIudmlldywgdGhpcy5wYXJlbnQsIHRydWUpOwogICAgICAgIFBoYXNlci5DYW52YXMuc2V0VG91Y2hBY3Rpb24odGhpcy5yZW5kZXJlci52aWV3KTsKCgl9LAoKCS8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgbG9hZCBoYXMgZmluaXNoZWQsIGFmdGVyIHByZWxvYWQgd2FzIHJ1bi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNsb2FkQ29tcGxldGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9sb2FkQ29tcGxldGUgPSB0cnVlOwoKICAgICAgICB0aGlzLnN0YXRlLmxvYWRDb21wbGV0ZSgpOwoKICAgIH0sCgoJLyoqCiAgICAqIFRoZSBjb3JlIGdhbWUgbG9vcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSN1cGRhdGUKICAgICogQHByb3RlY3RlZAoJKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIFRoZSBjdXJyZW50IHRpbWUgYXMgcHJvdmlkZWQgYnkgUmVxdWVzdEFuaW1hdGlvbkZyYW1lLgogICAgKi8KCXVwZGF0ZTogZnVuY3Rpb24gKHRpbWUpIHsKCgkJdGhpcy50aW1lLnVwZGF0ZSh0aW1lKTsKCgkJaWYgKHRoaXMuX3BhdXNlZCkKCQl7CgkJCXRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UuX3N0YWdlKTsKCQkJdGhpcy5wbHVnaW5zLnJlbmRlcigpOwoJCQl0aGlzLnN0YXRlLnJlbmRlcigpOwoJCX0KCQllbHNlCgkJewoJICAgICAgICB0aGlzLnBsdWdpbnMucHJlVXBkYXRlKCk7CgkgICAgICAgIHRoaXMucGh5c2ljcy5wcmVVcGRhdGUoKTsKCgkgICAgICAgIHRoaXMuc3RhZ2UudXBkYXRlKCk7CgkgICAgICAgIHRoaXMuaW5wdXQudXBkYXRlKCk7CgkgICAgICAgIHRoaXMudHdlZW5zLnVwZGF0ZSgpOwoJICAgICAgICB0aGlzLnNvdW5kLnVwZGF0ZSgpOwoJCQl0aGlzLndvcmxkLnVwZGF0ZSgpOwoJCQl0aGlzLnBhcnRpY2xlcy51cGRhdGUoKTsKCQkJdGhpcy5zdGF0ZS51cGRhdGUoKTsKCSAgICAgICAgdGhpcy5wbHVnaW5zLnVwZGF0ZSgpOwoKCQkJdGhpcy53b3JsZC5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgIHRoaXMucGx1Z2lucy5wb3N0VXBkYXRlKCk7CgoJCQl0aGlzLnJlbmRlcmVyLnJlbmRlcih0aGlzLnN0YWdlLl9zdGFnZSk7CgkJCXRoaXMucGx1Z2lucy5yZW5kZXIoKTsKCQkJdGhpcy5zdGF0ZS5yZW5kZXIoKTsKCgkJCXRoaXMucGx1Z2lucy5wb3N0UmVuZGVyKCk7CgkJfQoKCX0sCgoJLyoqCiAgICAqIE51a2UgdGhlIGVudGlyZSBnYW1lIGZyb20gb3JiaXQKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZSNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKCQl0aGlzLnJhZi5zdG9wKCk7CgogICAgCXRoaXMuaW5wdXQuZGVzdHJveSgpOwoKICAgIAl0aGlzLnN0YXRlLmRlc3Ryb3koKTsKCiAgICAgICAgdGhpcy5zdGF0ZSA9IG51bGw7CiAgICAgICAgdGhpcy5jYWNoZSA9IG51bGw7CiAgICAgICAgdGhpcy5pbnB1dCA9IG51bGw7CiAgICAgICAgdGhpcy5sb2FkID0gbnVsbDsKICAgICAgICB0aGlzLnNvdW5kID0gbnVsbDsKICAgICAgICB0aGlzLnN0YWdlID0gbnVsbDsKICAgICAgICB0aGlzLnRpbWUgPSBudWxsOwogICAgICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgICAgIHRoaXMuaXNCb290ZWQgPSBmYWxzZTsKCiAgICB9Cgp9OwoKLyoqCiogVGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgR2FtZS4gQSBwYXVzZWQgZ2FtZSBkb2Vzbid0IHVwZGF0ZSBhbnkgb2YgaXRzIHN1YnN5c3RlbXMuCiogV2hlbiBhIGdhbWUgaXMgcGF1c2VkIHRoZSBvblBhdXNlIGV2ZW50IGlzIGRpc3BhdGNoZWQuIFdoZW4gaXQgaXMgcmVzdW1lZCB0aGUgb25SZXN1bWUgZXZlbnQgaXMgZGlzcGF0Y2hlZC4KKiBAbmFtZSBQaGFzZXIuR2FtZSNwYXVzZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZCAtIEdldHMgYW5kIHNldHMgdGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgR2FtZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HYW1lLnByb3RvdHlwZSwgInBhdXNlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fcGF1c2VkOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgIAlpZiAodmFsdWUgPT09IHRydWUpCiAgICAJewogICAgCQlpZiAodGhpcy5fcGF1c2VkID09IGZhbHNlKQogICAgCQl7CgkgICAgCQl0aGlzLl9wYXVzZWQgPSB0cnVlOwoJICAgIAkJdGhpcy5vblBhdXNlLmRpc3BhdGNoKHRoaXMpOwogICAgCQl9CiAgICAJfQogICAgCWVsc2UKICAgIAl7CiAgICAJCWlmICh0aGlzLl9wYXVzZWQpCiAgICAJCXsKCSAgICAJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJICAgIAkJdGhpcy5vblJlc3VtZS5kaXNwYXRjaCh0aGlzKTsKICAgIAkJfQogICAgCX0KCiAgICB9Cgp9KTsKCi8qKgoqICJEZWxldGVkIGNvZGUgaXMgZGVidWdnZWQgY29kZS4iIC0gSmVmZiBTaWNrZWwKKi8KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENvbnN0cnVjdG9yIGZvciBQaGFzZXIgSW5wdXQuCiogQGNsYXNzIFBoYXNlci5JbnB1dAoqIEBjbGFzc2Rlc2MgQSBnYW1lIHNwZWNpZmljIElucHV0IG1hbmFnZXIgdGhhdCBsb29rcyBhZnRlciB0aGUgbW91c2UsIGtleWJvYXJkIGFuZCB0b3VjaCBvYmplY3RzLgoqIFRoaXMgaXMgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3AuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLklucHV0ID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBoaXRDYW52YXMgLSBEZXNjcmlwdGlvbi4gCiAgICAqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5oaXRDYW52YXMgPSBudWxsOwogICAgCgkvKioKICAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGhpdENvbnRleHQgLSBEZXNjcmlwdGlvbi4gCiAgICAgKiBAZGVmYXVsdAogCSovCiAgICB0aGlzLmhpdENvbnRleHQgPSBudWxsOwoJCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuSW5wdXQuTU9VU0VfT1ZFUlJJREVTX1RPVUNIID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUgPSAyOwoKUGhhc2VyLklucHV0LnByb3RvdHlwZSA9IHsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUKICAgICovCQogICAgZ2FtZTogbnVsbCwKCiAgICAvKioKICAgICogSG93IG9mdGVuIHNob3VsZCB0aGUgaW5wdXQgcG9pbnRlcnMgYmUgY2hlY2tlZCBmb3IgdXBkYXRlcz8KICAgICogQSB2YWx1ZSBvZiAwIG1lYW5zIGV2ZXJ5IHNpbmdsZSBmcmFtZSAoNjBmcHMpLCBhIHZhbHVlIG9mIDEgbWVhbnMgZXZlcnkgb3RoZXIgZnJhbWUgKDMwZnBzKSBhbmQgc28gb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwb2xsUmF0ZSAKICAgICogQGRlZmF1bHQKICAgICovCiAgICBwb2xsUmF0ZTogMCwKICAgIAogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gX3BvbGxDb3VudGVyIC0gRGVzY3JpcHRpb24uCiAgICAgKiBAcHJpdmF0ZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgX3BvbGxDb3VudGVyOiAwLAoKICAgIC8qKgogICAgKiBBIHZlY3RvciBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBwcmV2aW91cyBwb3NpdGlvbiBvZiB0aGUgUG9pbnRlci4KICAgICogQHByb3BlcnR5IHtWZWMyfSB2ZWN0b3IKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgX29sZFBvc2l0aW9uOiBudWxsLAoKICAgIC8qKgogICAgKiBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50IFBvaW50ZXIgZXZlbnQKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF94CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgX3g6IDAsCgogICAgLyoqCiAgICAqIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnQgUG9pbnRlciBldmVudAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3kKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBfeTogMCwKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIElucHV0LmRpc2FibGVkOiB0cnVlLiBXaGlsZSBzZXQgYWxsIG5ldyBpbnB1dCByZWxhdGVkIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICAqIElmIHlvdSBuZWVkIHRvIGRpc2FibGUganVzdCBvbmUgdHlwZSBvZiBpbnB1dCwgZm9yIGV4YW1wbGUgbW91c2UsIHVzZSBJbnB1dC5tb3VzZS5kaXNhYmxlZDogdHJ1ZSBpbnN0ZWFkCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQKICAgICogQGRlZmF1bHQKICAgICovCiAgICBkaXNhYmxlZDogZmFsc2UsCgogICAgLyoqCiAgICAqIENvbnRyb2xzIHRoZSBleHBlY3RlZCBiZWhhdmlvdXIgd2hlbiB1c2luZyBhIG1vdXNlIGFuZCB0b3VjaCB0b2dldGhlciBvbiBhIG11bHRpLWlucHV0IGRldmljZS4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gbXVsdGlJbnB1dE92ZXJyaWRlCiAgICAqLwogICAgbXVsdGlJbnB1dE92ZXJyaWRlOiBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSwKCiAgICAvKioKICAgICogQSB2ZWN0b3Igb2JqZWN0IHJlcHJlc2VudGluZyB0aGUgY3VycmVudCBwb3NpdGlvbiBvZiB0aGUgUG9pbnRlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHBvc2l0aW9uOiBudWxsLAoKICAgIC8qKgogICAgKiBBIHZlY3RvciBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBzcGVlZCBvZiB0aGUgUG9pbnRlci4gT25seSByZWFsbHkgdXNlZnVsIGluIHNpbmdsZSBQb2ludGVyIGdhbWVzLAogICAgKiBvdGhlcndpc2Ugc2VlIHRoZSBQb2ludGVyIG9iamVjdHMgZGlyZWN0bHkuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzcGVlZAogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICBzcGVlZDogbnVsbCwKCiAgICAvKioKICAgICogQSBDaXJjbGUgb2JqZWN0IGNlbnRlcmVkIG9uIHRoZSB4L3kgc2NyZWVuIGNvb3JkaW5hdGVzIG9mIHRoZSBJbnB1dC4KICAgICogRGVmYXVsdCBzaXplIG9mIDQ0cHggKEFwcGxlcyByZWNvbW1lbmRlZCAiZmluZ2VyIHRpcCIgc2l6ZSkgYnV0IGNhbiBiZSBjaGFuZ2VkIHRvIGFueXRoaW5nLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DaXJjbGV9IGNpcmNsZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGNpcmNsZTogbnVsbCwKCiAgICAvKioKICAgICogVGhlIHNjYWxlIGJ5IHdoaWNoIGFsbCBpbnB1dCBjb29yZGluYXRlcyBhcmUgbXVsdGlwbGllZCwgY2FsY3VsYXRlZCBieSB0aGUgU3RhZ2VTY2FsZU1vZGUuCiAgICAqIEluIGFuIHVuLXNjYWxlZCBnYW1lIHRoZSB2YWx1ZXMgd2lsbCBiZSB4OiAxIGFuZCB5OiAxLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBzY2FsZTogbnVsbCwKCiAgICAvKioKICAgICogVGhlIG1heGltdW0gbnVtYmVyIG9mIFBvaW50ZXJzIGFsbG93ZWQgdG8gYmUgYWN0aXZlIGF0IGFueSBvbmUgdGltZS4KICAgICogRm9yIGxvdHMgb2YgZ2FtZXMgaXQncyB1c2VmdWwgdG8gc2V0IHRoaXMgdG8gMS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFBvaW50ZXJzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbWF4UG9pbnRlcnM6IDEwLAoKICAgIC8qKgogICAgKiBUaGUgY3VycmVudCBudW1iZXIgb2YgYWN0aXZlIFBvaW50ZXJzLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFBvaW50ZXJzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgY3VycmVudFBvaW50ZXJzOiAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBQb2ludGVyIGhhcyB0byBiZSBwcmVzc2VkIGRvd24gYW5kIHRoZW4gcmVsZWFzZWQgdG8gYmUgY29uc2lkZXJlZCBhIHRhcCBvciBjbGlja2UKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRhcFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0YXBSYXRlOiAyMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJldHdlZW4gdGFwcyBvZiB0aGUgc2FtZSBQb2ludGVyIGZvciBpdCB0byBiZSBjb25zaWRlcmVkIGEgZG91YmxlIHRhcCAvIGNsaWNrCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkb3VibGVUYXBSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgZG91YmxlVGFwUmF0ZTogMzAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGF0IHRoZSBQb2ludGVyIGhhcyB0byBiZSBwcmVzc2VkIGRvd24gZm9yIGl0IHRvIGZpcmUgYSBvbkhvbGQgZXZlbnQKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhvbGRSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgaG9sZFJhdGU6IDIwMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJlbG93IHdoaWNoIHRoZSBQb2ludGVyIGlzIGNvbnNpZGVyZWQganVzdFByZXNzZWQKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGp1c3RQcmVzc2VkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGp1c3RQcmVzc2VkUmF0ZTogMjAwLAoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBiZWxvdyB3aGljaCB0aGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RSZWxlYXNlZCAKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGp1c3RSZWxlYXNlZFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBqdXN0UmVsZWFzZWRSYXRlOiAyMDAsCgogICAgLyoqCiAgICAqIFNldHMgaWYgdGhlIFBvaW50ZXIgb2JqZWN0cyBzaG91bGQgcmVjb3JkIGEgaGlzdG9yeSBvZiB4L3kgY29vcmRpbmF0ZXMgdGhleSBoYXZlIHBhc3NlZCB0aHJvdWdoLgogICAgKiBUaGUgaGlzdG9yeSBpcyBjbGVhcmVkIGVhY2ggdGltZSB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIGRvd24uCiAgICAqIFRoZSBoaXN0b3J5IGlzIHVwZGF0ZWQgYXQgdGhlIHJhdGUgc3BlY2lmaWVkIGluIElucHV0LnBvbGxSYXRlCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVjb3JkUG9pbnRlckhpc3RvcnkKICAgICogQGRlZmF1bHQKICAgICovCiAgICByZWNvcmRQb2ludGVySGlzdG9yeTogZmFsc2UsCgogICAgLyoqCiAgICAqIFRoZSByYXRlIGluIG1pbGxpc2Vjb25kcyBhdCB3aGljaCB0aGUgUG9pbnRlciBvYmplY3RzIHNob3VsZCB1cGRhdGUgdGhlaXIgdHJhY2tpbmcgaGlzdG9yeQogICAgKiBAcHJvcGVydHkge251bWJlcn0gcmVjb3JkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHJlY29yZFJhdGU6IDEwMCwKCiAgICAvKioKICAgICogVGhlIHRvdGFsIG51bWJlciBvZiBlbnRyaWVzIHRoYXQgY2FuIGJlIHJlY29yZGVkIGludG8gdGhlIFBvaW50ZXIgb2JqZWN0cyB0cmFja2luZyBoaXN0b3J5LgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyB0cmFja2luZyBvbmUgZXZlbnQgZXZlcnkgMTAwbXMsIHRoZW4gYSB0cmFja0xpbWl0IG9mIDEwMCB3b3VsZCBzdG9yZSB0aGUgbGFzdCAxMCBzZWNvbmRzIHdvcnRoIG9mIGhpc3RvcnkuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZWNvcmRMaW1pdAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHJlY29yZExpbWl0OiAxMDAsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjEKICAgICovCiAgICBwb2ludGVyMTogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMgogICAgKi8KICAgIHBvaW50ZXIyOiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0ICAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjMKICAgICovCiAgICBwb2ludGVyMzogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyNAogICAgKi8KICAgIHBvaW50ZXI0OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI1CiAgICAqLwogICAgcG9pbnRlcjU6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjYKICAgICovCiAgICBwb2ludGVyNjogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdCAgCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI3CiAgICAqLwogICAgcG9pbnRlcjc6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjgKICAgICovCiAgICBwb2ludGVyODogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyOQogICAgKi8gCiAgICBwb2ludGVyOTogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjEwCiAgICAqLwogICAgcG9pbnRlcjEwOiBudWxsLAoKICAgIC8qKgogICAgKiBUaGUgbW9zdCByZWNlbnRseSBhY3RpdmUgUG9pbnRlciBvYmplY3QuCiAgICAqIFdoZW4geW91J3ZlIGxpbWl0ZWQgbWF4IHBvaW50ZXJzIHRvIDEgdGhpcyB3aWxsIGFjY3VyYXRlbHkgYmUgZWl0aGVyIHRoZSBmaXJzdCBmaW5nZXIgdG91Y2hlZCBvciBtb3VzZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gYWN0aXZlUG9pbnRlcgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGFjdGl2ZVBvaW50ZXI6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBtb3VzZSBoYXMgaXRzIG93biB1bmlxdWUgUGhhc2VyLlBvaW50ZXIgb2JqZWN0IHdoaWNoIHlvdSBjYW4gdXNlIGlmIG1ha2luZyBhIGRlc2t0b3Agc3BlY2lmaWMgZ2FtZS4KICAgICogQHByb3BlcnR5IHtQb2ludGVyfSBtb3VzZVBvaW50ZXIKICAgICogQGRlZmF1bHQKICAgICovCiAgICBtb3VzZVBvaW50ZXI6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgTW91c2UgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuTW91c2V9IG1vdXNlIC0gVGhlIE1vdXNlIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbW91c2U6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgS2V5Ym9hcmQgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuS2V5Ym9hcmR9IGtleWJvYXJkIC0gVGhlIEtleWJvYXJkIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAga2V5Ym9hcmQ6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgVG91Y2ggSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuVG91Y2h9IHRvdWNoIC0gdGhlIFRvdWNoIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdG91Y2g6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBUaGUgTVNQb2ludGVyIElucHV0IG1hbmFnZXIuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLk1TUG9pbnRlcn0gbXNwb2ludGVyIC0gVGhlIE1TUG9pbnRlciBJbnB1dCBtYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG1zcG9pbnRlcjogbnVsbCwKCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgcHJlc3NlZCBkb3duLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRG93bgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG9uRG93bjogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIEEgU2lnbmFsIHRoYXQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgYSBwb2ludGVyIGlzIHJlbGVhc2VkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVXAKICAgICogQGRlZmF1bHQKICAgICovCiAgICBvblVwOiBudWxsLAogICAgCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgdGFwcGVkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uVGFwCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25UYXA6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBBIFNpZ25hbCB0aGF0IGlzIGRpc3BhdGNoZWQgZWFjaCB0aW1lIGEgcG9pbnRlciBpcyBoZWxkIGRvd24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Ib2xkCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25Ib2xkOiBudWxsLAoKICAgIC8qKgogICAgKiBBIGxpbmtlZCBsaXN0IG9mIGludGVyYWN0aXZlIG9iamVjdHMsIHRoZSBJbnB1dEhhbmRsZXIgY29tcG9uZW50cyAoYmVsb25naW5nIHRvIFNwcml0ZXMpIHJlZ2lzdGVyIHRoZW1zZWx2ZXMgd2l0aCB0aGlzLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5MaW5rZWRMaXN0fSBpbnRlcmFjdGl2ZUl0ZW1zCiAgICAqLwogICAgaW50ZXJhY3RpdmVJdGVtczogbmV3IFBoYXNlci5MaW5rZWRMaXN0KCksCgoJLyoqCiAgICAqIFN0YXJ0cyB0aGUgSW5wdXQgTWFuYWdlciBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNib290CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgoJICAgIHRoaXMubW91c2VQb2ludGVyID0gbmV3IFBoYXNlci5Qb2ludGVyKHRoaXMuZ2FtZSwgMCk7CgkgICAgdGhpcy5wb2ludGVyMSA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIDEpOwoJICAgIHRoaXMucG9pbnRlcjIgPSBuZXcgUGhhc2VyLlBvaW50ZXIodGhpcy5nYW1lLCAyKTsKCgkgICAgdGhpcy5tb3VzZSA9IG5ldyBQaGFzZXIuTW91c2UodGhpcy5nYW1lKTsKCSAgICB0aGlzLmtleWJvYXJkID0gbmV3IFBoYXNlci5LZXlib2FyZCh0aGlzLmdhbWUpOwoJICAgIHRoaXMudG91Y2ggPSBuZXcgUGhhc2VyLlRvdWNoKHRoaXMuZ2FtZSk7CgkgICAgdGhpcy5tc3BvaW50ZXIgPSBuZXcgUGhhc2VyLk1TUG9pbnRlcih0aGlzLmdhbWUpOwoKCSAgICB0aGlzLm9uRG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgkgICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCSAgICB0aGlzLm9uVGFwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCSAgICB0aGlzLm9uSG9sZCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgoJICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoJICAgIHRoaXMuc3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgkgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCSAgICB0aGlzLl9vbGRQb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCgkgICAgdGhpcy5jaXJjbGUgPSBuZXcgUGhhc2VyLkNpcmNsZSgwLCAwLCA0NCk7CgoJICAgIHRoaXMuYWN0aXZlUG9pbnRlciA9IHRoaXMubW91c2VQb2ludGVyOwoJICAgIHRoaXMuY3VycmVudFBvaW50ZXJzID0gMDsKCgkgICAgdGhpcy5oaXRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKCSAgICB0aGlzLmhpdENhbnZhcy53aWR0aCA9IDE7CgkgICAgdGhpcy5oaXRDYW52YXMuaGVpZ2h0ID0gMTsKICAgICAgICB0aGlzLmhpdENvbnRleHQgPSB0aGlzLmhpdENhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKICAgICAgICB0aGlzLm1vdXNlLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5rZXlib2FyZC5zdGFydCgpOwogICAgICAgIHRoaXMudG91Y2guc3RhcnQoKTsKICAgICAgICB0aGlzLm1zcG9pbnRlci5zdGFydCgpOwogICAgICAgIHRoaXMubW91c2VQb2ludGVyLmFjdGl2ZSA9IHRydWU7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgYWxsIG9mIHRoZSBJbnB1dCBNYW5hZ2VycyBmcm9tIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMubW91c2Uuc3RvcCgpOwogICAgICAgIHRoaXMua2V5Ym9hcmQuc3RvcCgpOwogICAgICAgIHRoaXMudG91Y2guc3RvcCgpOwogICAgICAgIHRoaXMubXNwb2ludGVyLnN0b3AoKTsKCiAgICB9LAoKCS8qKgogICAgKiBBZGQgYSBuZXcgUG9pbnRlciBvYmplY3QgdG8gdGhlIElucHV0IE1hbmFnZXIuIEJ5IGRlZmF1bHQgSW5wdXQgY3JlYXRlcyAzIHBvaW50ZXIgb2JqZWN0czogbW91c2VQb2ludGVyLCBwb2ludGVyMSBhbmQgcG9pbnRlcjIuCiAgICAqIElmIHlvdSBuZWVkIG1vcmUgdGhlbiB1c2UgdGhpcyB0byBjcmVhdGUgYSBuZXcgb25lLCB1cCB0byBhIG1heGltdW0gb2YgMTAuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2FkZFBvaW50ZXIKICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IEEgcmVmZXJlbmNlIHRvIHRoZSBuZXcgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgY3JlYXRlZC4KICAgICovCiAgICBhZGRQb2ludGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBuZXh0ID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDEwOyBpID4gMDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gPT09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5leHQgPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobmV4dCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJZb3UgY2FuIG9ubHkgaGF2ZSAxMCBQb2ludGVyIG9iamVjdHMiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXNbJ3BvaW50ZXInICsgbmV4dF0gPSBuZXcgUGhhc2VyLlBvaW50ZXIodGhpcy5nYW1lLCBuZXh0KTsKICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ3BvaW50ZXInICsgbmV4dF07CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCiAgICAqIFVwZGF0ZXMgdGhlIElucHV0IE1hbmFnZXIuIENhbGxlZCBieSB0aGUgY29yZSBHYW1lIGxvb3AuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnBvbGxSYXRlID4gMCAmJiB0aGlzLl9wb2xsQ291bnRlciA8IHRoaXMucG9sbFJhdGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2xsQ291bnRlcisrOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwZWVkLnggPSB0aGlzLnBvc2l0aW9uLnggLSB0aGlzLl9vbGRQb3NpdGlvbi54OwogICAgICAgIHRoaXMuc3BlZWQueSA9IHRoaXMucG9zaXRpb24ueSAtIHRoaXMuX29sZFBvc2l0aW9uLnk7CgogICAgICAgIHRoaXMuX29sZFBvc2l0aW9uLmNvcHlGcm9tKHRoaXMucG9zaXRpb24pOwogICAgICAgIHRoaXMubW91c2VQb2ludGVyLnVwZGF0ZSgpOwoKICAgICAgICB0aGlzLnBvaW50ZXIxLnVwZGF0ZSgpOwogICAgICAgIHRoaXMucG9pbnRlcjIudXBkYXRlKCk7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIzKSB7IHRoaXMucG9pbnRlcjMudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNCkgeyB0aGlzLnBvaW50ZXI0LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjUpIHsgdGhpcy5wb2ludGVyNS51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI2KSB7IHRoaXMucG9pbnRlcjYudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNykgeyB0aGlzLnBvaW50ZXI3LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjgpIHsgdGhpcy5wb2ludGVyOC51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI5KSB7IHRoaXMucG9pbnRlcjkudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyMTApIHsgdGhpcy5wb2ludGVyMTAudXBkYXRlKCk7IH0KCiAgICAgICAgdGhpcy5fcG9sbENvdW50ZXIgPSAwOwogICAgfSwKCgkvKioKICAgICogUmVzZXQgYWxsIG9mIHRoZSBQb2ludGVycyBhbmQgSW5wdXQgc3RhdGVzCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3Jlc2V0CiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gaGFyZCAtIEEgc29mdCByZXNldCAoaGFyZCA9IGZhbHNlKSB3b24ndCByZXNldCBhbnkgU2lnbmFscyB0aGF0IG1pZ2h0IGJlIGJvdW5kLiBBIGhhcmQgcmVzZXQgd2lsbC4KICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKGhhcmQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pc0Jvb3RlZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaGFyZCA9PSAndW5kZWZpbmVkJykgeyBoYXJkID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5rZXlib2FyZC5yZXNldCgpOwogICAgICAgIHRoaXMubW91c2VQb2ludGVyLnJlc2V0KCk7CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IDEwOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpc1sncG9pbnRlcicgKyBpXS5yZXNldCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRQb2ludGVycyA9IDA7CiAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CgogICAgICAgIGlmIChoYXJkID09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRG93bi5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25VcC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25UYXAuZGlzcG9zZSgpOwogICAgICAgICAgICB0aGlzLm9uSG9sZC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25Eb3duID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vblVwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vblRhcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CiAgICAgICAgICAgIHRoaXMub25Ib2xkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAgICAgICAgIHRoaXMuaW50ZXJhY3RpdmVJdGVtcy5jYWxsQWxsKCdyZXNldCcpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcG9sbENvdW50ZXIgPSAwOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0cyB0aGUgc3BlZWQgYW5kIG9sZCBwb3NpdGlvbiBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNyZXNldFNwZWVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gU2V0cyB0aGUgb2xkUG9zaXRpb24ueCB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBTZXRzIHRoZSBvbGRQb3NpdGlvbi55IHZhbHVlLgogICAgKi8KICAgIHJlc2V0U3BlZWQ6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuX29sZFBvc2l0aW9uLnNldFRvKHgsIHkpOwogICAgICAgIHRoaXMuc3BlZWQuc2V0VG8oMCwgMCk7CgogICAgfSwKCgkvKioKICAgICogRmluZCB0aGUgZmlyc3QgZnJlZSBQb2ludGVyIG9iamVjdCBhbmQgc3RhcnQgaXQsIHBhc3NpbmcgaW4gdGhlIGV2ZW50IGRhdGEuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLlRvdWNoIGFuZCBQaGFzZXIuTVNQb2ludGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNzdGFydFBvaW50ZXIKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50IC0gVGhlIGV2ZW50IGRhdGEgZnJvbSB0aGUgVG91Y2ggZXZlbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBUaGUgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgc3RhcnRlZCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IGlzIGF2YWlsYWJsZS4KICAgICovCiAgICBzdGFydFBvaW50ZXI6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5tYXhQb2ludGVycyA8IDEwICYmIHRoaXMudG90YWxBY3RpdmVQb2ludGVycyA9PSB0aGlzLm1heFBvaW50ZXJzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5hY3RpdmUgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMS5zdGFydChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjIuc3RhcnQoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSA9PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5zdGFydChldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgoJLyoqCiAgICAqIFVwZGF0ZXMgdGhlIG1hdGNoaW5nIFBvaW50ZXIgb2JqZWN0LCBwYXNzaW5nIGluIHRoZSBldmVudCBkYXRhLiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGFuZCBzaG91bGQgbm90IG5vcm1hbGx5IG5lZWQgdG8gYmUgaW52b2tlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjdXBkYXRlUG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyB1cGRhdGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHVwZGF0ZVBvaW50ZXI6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5hY3RpdmUgJiYgdGhpcy5wb2ludGVyMS5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMS5tb3ZlKGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5wb2ludGVyMi5hY3RpdmUgJiYgdGhpcy5wb2ludGVyMi5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMi5tb3ZlKGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPD0gMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5hY3RpdmUgJiYgdGhpc1sncG9pbnRlcicgKyBpXS5pZGVudGlmaWVyID09IGV2ZW50LmlkZW50aWZpZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ3BvaW50ZXInICsgaV0ubW92ZShldmVudCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgoJLyoqCiAgICAqIFN0b3BzIHRoZSBtYXRjaGluZyBQb2ludGVyIG9iamVjdCwgcGFzc2luZyBpbiB0aGUgZXZlbnQgZGF0YS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjc3RvcFBvaW50ZXIKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50IC0gVGhlIGV2ZW50IGRhdGEgZnJvbSB0aGUgVG91Y2ggZXZlbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBUaGUgUG9pbnRlciBvYmplY3QgdGhhdCB3YXMgc3RvcHBlZCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IGlzIGF2YWlsYWJsZS4KICAgICovCiAgICBzdG9wUG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIxLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxLnN0b3AoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIyLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyLnN0b3AoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSAmJiB0aGlzWydwb2ludGVyJyArIGldLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5zdG9wKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKICAgICogR2V0IHRoZSBuZXh0IFBvaW50ZXIgb2JqZWN0IHdob3MgYWN0aXZlIHByb3BlcnR5IG1hdGNoZXMgdGhlIGdpdmVuIHN0YXRlCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2dldFBvaW50ZXIKICAgICogQHBhcmFtIHtib29sZWFufSBzdGF0ZSAtIFRoZSBzdGF0ZSB0aGUgUG9pbnRlciBzaG91bGQgYmUgaW4gKGZhbHNlIGZvciBpbmFjdGl2ZSwgdHJ1ZSBmb3IgYWN0aXZlKS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IEEgUG9pbnRlciBvYmplY3Qgb3IgbnVsbCBpZiBubyBQb2ludGVyIG9iamVjdCBtYXRjaGVzIHRoZSByZXF1ZXN0ZWQgc3RhdGUuCiAgICAqLwogICAgZ2V0UG9pbnRlcjogZnVuY3Rpb24gKHN0YXRlKSB7CgogICAgICAgIHN0YXRlID0gc3RhdGUgfHwgZmFsc2U7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSA9PSBzdGF0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKICAgICogR2V0IHRoZSBQb2ludGVyIG9iamVjdCB3aG9zIGlkZW50aWZpZWQgcHJvcGVydHkgbWF0Y2hlcyB0aGUgZ2l2ZW4gaWRlbnRpZmllciB2YWx1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjZ2V0UG9pbnRlckZyb21JZGVudGlmaWVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpZGVudGlmaWVyIC0gVGhlIFBvaW50ZXIuaWRlbnRpZmllciB2YWx1ZSB0byBzZWFyY2ggZm9yLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gQSBQb2ludGVyIG9iamVjdCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IG1hdGNoZXMgdGhlIHJlcXVlc3RlZCBpZGVudGlmaWVyLgogICAgKi8KICAgIGdldFBvaW50ZXJGcm9tSWRlbnRpZmllcjogZnVuY3Rpb24gKGlkZW50aWZpZXIpIHsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjI7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uaWRlbnRpZmllciA9PSBpZGVudGlmaWVyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9Cgp9OwoKLyoqCiogVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4gVGhpcyB2YWx1ZSB0YWtlcyBnYW1lIHNjYWxpbmcgaW50byBhY2NvdW50IGF1dG9tYXRpY2FsbHkuIFNlZSBQb2ludGVyLnNjcmVlblgvY2xpZW50WCBmb3Igc291cmNlIHZhbHVlcy4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl94OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX3ggPSBNYXRoLmZsb29yKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4gVGhpcyB2YWx1ZSB0YWtlcyBnYW1lIHNjYWxpbmcgaW50byBhY2NvdW50IGF1dG9tYXRpY2FsbHkuIFNlZSBQb2ludGVyLnNjcmVlblkvY2xpZW50WSBmb3Igc291cmNlIHZhbHVlcy4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjeQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ5IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl95ID0gTWF0aC5mbG9vcih2YWx1ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5JbnB1dCNwb2xsTG9ja2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwb2xsTG9ja2VkIC0gVHJ1ZSBpZiB0aGUgSW5wdXQgaXMgY3VycmVudGx5IHBvbGwgcmF0ZSBsb2NrZWQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAicG9sbExvY2tlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMucG9sbFJhdGUgPiAwICYmIHRoaXMuX3BvbGxDb3VudGVyIDwgdGhpcy5wb2xsUmF0ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB0b3RhbCBudW1iZXIgb2YgaW5hY3RpdmUgUG9pbnRlcnMKKiBAbmFtZSBQaGFzZXIuSW5wdXQjdG90YWxJbmFjdGl2ZVBvaW50ZXJzCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsSW5hY3RpdmVQb2ludGVycyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgaW5hY3RpdmUgUG9pbnRlcnMuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAidG90YWxJbmFjdGl2ZVBvaW50ZXJzIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAxMCAtIHRoaXMuY3VycmVudFBvaW50ZXJzOwogICAgfQoKfSk7CgovKioKKiBUaGUgdG90YWwgbnVtYmVyIG9mIGFjdGl2ZSBQb2ludGVycwoqIEBuYW1lIFBoYXNlci5JbnB1dCN0b3RhbEFjdGl2ZVBvaW50ZXJzCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsQWN0aXZlUG9pbnRlcnMgLSBUaGUgdG90YWwgbnVtYmVyIG9mIGFjdGl2ZSBQb2ludGVycy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ0b3RhbEFjdGl2ZVBvaW50ZXJzIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50UG9pbnRlcnMgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8PSAxMDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5hY3RpdmUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFBvaW50ZXJzKys7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRQb2ludGVyczsKCiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3b3JsZCBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiogQG5hbWUgUGhhc2VyLklucHV0I3dvcmxkWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZFggLSBUaGUgd29ybGQgWCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgIndvcmxkWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLng7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3b3JsZCBZIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiogQG5hbWUgUGhhc2VyLklucHV0I3dvcmxkWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3b3JsZFkgLSBUaGUgd29ybGQgWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgIndvcmxkWSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnkgKyB0aGlzLnk7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuS2V5CiogQGNsYXNzZGVzYyBJZiB5b3UgbmVlZCBtb3JlIGZpbmUtZ3JhaW5lZCBjb250cm9sIG92ZXIgdGhlIGhhbmRsaW5nIG9mIHNwZWNpZmljIGtleXMgeW91IGNhbiBjcmVhdGUgYW5kIHVzZSBQaGFzZXIuS2V5IG9iamVjdHMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXkgY29kZSB0aGlzIEtleSBpcyByZXNwb25zaWJsZSBmb3IuCiovClBoYXNlci5LZXkgPSBmdW5jdGlvbiAoZ2FtZSwga2V5Y29kZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEb3duIC0gVGhlICJkb3duIiBzdGF0ZSBvZiB0aGUga2V5LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuaXNEb3duID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNVcCAtIFRoZSAidXAiIHN0YXRlIG9mIHRoZSBrZXkuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc1VwID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWx0S2V5IC0gVGhlIGRvd24gc3RhdGUgb2YgdGhlIEFMVCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmFsdEtleSA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGN0cmxLZXkgLSBUaGUgZG93biBzdGF0ZSBvZiB0aGUgQ1RSTCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmN0cmxLZXkgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBzaGlmdEtleSAtIFRoZSBkb3duIHN0YXRlIG9mIHRoZSBTSElGVCBrZXksIGlmIHByZXNzZWQgYXQgdGhlIHNhbWUgdGltZSBhcyB0aGlzIGtleS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnNoaWZ0S2V5ID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lRG93biAtIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUga2V5IHdhcyBsYXN0IHByZXNzZWQgZG93bi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnRpbWVEb3duID0gMDsKCgkvKioKCSogSWYgdGhlIGtleSBpcyBkb3duIHRoaXMgdmFsdWUgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoYXQga2V5IHByZXNzIGFuZCBpcyBjb25zdGFudGx5IHVwZGF0ZWQuCgkqIElmIHRoZSBrZXkgaXMgdXAgaXQgaG9sZHMgdGhlIGR1cmF0aW9uIG9mIHRoZSBwcmV2aW91cyBkb3duIHNlc3Npb24uCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoaXMga2V5IGhhcyBiZWVuIGhlbGQgZG93biBmb3IuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5kdXJhdGlvbiA9IDA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lVXAgLSBUaGUgdGltZXN0YW1wIHdoZW4gdGhlIGtleSB3YXMgbGFzdCByZWxlYXNlZC4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnRpbWVVcCA9IDA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZXBlYXRzIC0gSWYgYSBrZXkgaXMgaGVsZCBkb3duIHRoaXMgaG9sZHMgZG93biB0aGUgbnVtYmVyIG9mIHRpbWVzIHRoZSBrZXkgaGFzICdyZXBlYXRlZCcuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5yZXBlYXRzID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGtleUNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGlzIGtleS4KCSovCgl0aGlzLmtleUNvZGUgPSBrZXljb2RlOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRG93biAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEtleSBpcyBwcmVzc2VkIGRvd24uIEl0IGlzIG9ubHkgZGlzcGF0Y2hlZCBvbmNlICh1bnRpbCB0aGUga2V5IGlzIHJlbGVhc2VkIGFnYWluKS4KCSovCiAgICB0aGlzLm9uRG93biA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25VcCAtIFRoaXMgU2lnbmFsIGlzIGRpc3BhdGNoZWQgZXZlcnkgdGltZSB0aGlzIEtleSBpcyBwcmVzc2VkIGRvd24uIEl0IGlzIG9ubHkgZGlzcGF0Y2hlZCBvbmNlICh1bnRpbCB0aGUga2V5IGlzIHJlbGVhc2VkIGFnYWluKS4KCSovCiAgICB0aGlzLm9uVXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoJCn07CgpQaGFzZXIuS2V5LnByb3RvdHlwZSA9IHsKCgkvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLktleWJvYXJkLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXkjcHJvY2Vzc0tleURvd24KICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudC4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5hbHRLZXkgPSBldmVudC5hbHRLZXk7CiAgICAgICAgdGhpcy5jdHJsS2V5ID0gZXZlbnQuY3RybEtleTsKICAgICAgICB0aGlzLnNoaWZ0S2V5ID0gZXZlbnQuc2hpZnRLZXk7CgogICAgICAgIGlmICh0aGlzLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIC8vICBLZXkgd2FzIGFscmVhZHkgaGVsZCBkb3duLCB0aGlzIG11c3QgYmUgYSByZXBlYXQgcmF0ZSBiYXNlZCBldmVudAogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gZXZlbnQudGltZVN0YW1wIC0gdGhpcy50aW1lRG93bjsKICAgICAgICAgICAgdGhpcy5yZXBlYXRzKys7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5pc1VwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudGltZURvd24gPSBldmVudC50aW1lU3RhbXA7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSAwOwogICAgICAgICAgICB0aGlzLnJlcGVhdHMgPSAwOwoKICAgICAgICAgICAgdGhpcy5vbkRvd24uZGlzcGF0Y2godGhpcyk7CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5LZXlib2FyZC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I3Byb2Nlc3NLZXlVcAogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0tleVVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwogICAgICAgIHRoaXMudGltZVVwID0gZXZlbnQudGltZVN0YW1wOwoKICAgICAgICB0aGlzLm9uVXAuZGlzcGF0Y2godGhpcyk7CgogICAgfSwKCgkvKioKCSogUmV0dXJucyB0aGUgImp1c3QgcHJlc3NlZCIgc3RhdGUgb2YgdGhlIEtleS4gSnVzdCBwcmVzc2VkIGlzIGNvbnNpZGVyZWQgdHJ1ZSBpZiB0aGUga2V5IHdhcyBwcmVzc2VkIGRvd24gd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCBwcmVzc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCBwcmVzc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gJiYgdGhpcy5kdXJhdGlvbiA8IGR1cmF0aW9uKTsKCiAgICB9LAoKCS8qKgoJKiBSZXR1cm5zIHRoZSAianVzdCByZWxlYXNlZCIgc3RhdGUgb2YgdGhlIEtleS4gSnVzdCByZWxlYXNlZCBpcyBjb25zaWRlcmVkIGFzIGJlaW5nIHRydWUgaWYgdGhlIGtleSB3YXMgcmVsZWFzZWQgd2l0aGluIHRoZSBkdXJhdGlvbiBnaXZlbiAoZGVmYXVsdCAyNTBtcykKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5I2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCByZWxlYXNlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGp1c3QgcmVsZWFzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIHJldHVybiAodGhpcy5pc0Rvd24gPT0gZmFsc2UgJiYgKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMudGltZVVwIDwgZHVyYXRpb24pKTsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gS2V5Ym9hcmQgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLktleWJvYXJkCiogQGNsYXNzZGVzYyBBIEtleWJvYXJkIG9iamVjdCBEZXNjcmlwdGlvbi4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5LZXlib2FyZCA9IGZ1bmN0aW9uIChnYW1lKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoJCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2tleXMgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9rZXlzID0ge307CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfaG90a2V5cyAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2hvdGtleXMgPSB7fTsKCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2NhcHR1cmUgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9jYXB0dXJlID0ge307CgogICAgLyoqCiAgICAqIFlvdSBjYW4gZGlzYWJsZSBhbGwgS2V5Ym9hcmQgSW5wdXQgYnkgc2V0dGluZyBkaXNhYmxlZCB0byB0cnVlLiBXaGlsZSB0cnVlIGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkIC0gVGhlIGRpc2FibGVkIHN0YXRlIG9mIHRoZSBLZXlib2FyZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbktleURvd24KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbktleURvd24gPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uS2V5VXAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbktleVVwID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtPYmplY3R9IGNhbGxiYWNrQ29udGV4dCAtIFRoZSBjb250ZXh0IHVuZGVyIHdoaWNoIHRoZSBjYWxsYmFja3MgYXJlIHJ1bi4KICAgICovCiAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uRG93bkNhbGxiYWNrIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBrZXkgaXMgcHJlc3NlZCBkb3duLgogICAgKi8KICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblVwQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyByZWxlYXNlZC4KICAgICovCiAgICB0aGlzLm9uVXBDYWxsYmFjayA9IG51bGw7CgkKfTsKClBoYXNlci5LZXlib2FyZC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBjYWxsYmFja3MgdG8gdGhlIEtleWJvYXJkIGhhbmRsZXIgc28gdGhhdCBlYWNoIHRpbWUgYSBrZXkgaXMgcHJlc3NlZCBkb3duIG9yIHJlbGVhc2VzIHRoZSBjYWxsYmFja3MgYXJlIGFjdGl2YXRlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjYWRkQ2FsbGJhY2tzCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrcyBhcmUgcnVuLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBvbkRvd24gLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyBwcmVzc2VkIGRvd24uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtvblVwPW51bGxdIC0gVGhpcyBjYWxsYmFjayBpcyBpbnZva2VkIGV2ZXJ5IHRpbWUgYSBrZXkgaXMgcmVsZWFzZWQuCiAgICAqLwogICAgYWRkQ2FsbGJhY2tzOiBmdW5jdGlvbiAoY29udGV4dCwgb25Eb3duLCBvblVwKSB7CgogICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLm9uRG93bkNhbGxiYWNrID0gb25Eb3duOwoKICAgICAgICBpZiAodHlwZW9mIG9uVXAgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vblVwQ2FsbGJhY2sgPSBvblVwOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB5b3UgbmVlZCBtb3JlIGZpbmUtZ3JhaW5lZCBjb250cm9sIG92ZXIgYSBLZXkgeW91IGNhbiBjcmVhdGUgYSBuZXcgUGhhc2VyLktleSBvYmplY3QgdmlhIHRoaXMgbWV0aG9kLgogICAgKiBUaGUgS2V5IG9iamVjdCBjYW4gdGhlbiBiZSBwb2xsZWQsIGhhdmUgZXZlbnRzIGF0dGFjaGVkIHRvIGl0LCBldGMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2FkZEtleQogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXksIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRV9CQVIKICAgICogQHJldHVybiB7UGhhc2VyLktleX0gVGhlIEtleSBvYmplY3Qgd2hpY2ggeW91IGNhbiBzdG9yZSBsb2NhbGx5IGFuZCByZWZlcmVuY2UgZGlyZWN0bHkuCiAgICAqLwogICAgYWRkS2V5OiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICB0aGlzLl9ob3RrZXlzW2tleWNvZGVdID0gbmV3IFBoYXNlci5LZXkodGhpcy5nYW1lLCBrZXljb2RlKTsKCiAgICAgICAgdGhpcy5hZGRLZXlDYXB0dXJlKGtleWNvZGUpOwoKICAgICAgICByZXR1cm4gdGhpcy5faG90a2V5c1trZXljb2RlXTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgS2V5IG9iamVjdCBmcm9tIHRoZSBLZXlib2FyZCBtYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNyZW1vdmVLZXkKICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGUga2V5IHRvIHJlbW92ZSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFX0JBUgogICAgKi8KICAgIHJlbW92ZUtleTogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgZGVsZXRlICh0aGlzLl9ob3RrZXlzW2tleWNvZGVdKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGFuZCByZXR1cm5zIGFuIG9iamVjdCBjb250YWluaW5nIDQgaG90a2V5cyBmb3IgVXAsIERvd24sIExlZnQgYW5kIFJpZ2h0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNjcmVhdGVDdXJzb3JLZXlzCiAgICAqIEByZXR1cm4ge29iamVjdH0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJvcGVydGllczogdXAsIGRvd24sIGxlZnQgYW5kIHJpZ2h0LiBXaGljaCBjYW4gYmUgcG9sbGVkIGxpa2UgYW55IG90aGVyIFBoYXNlci5LZXkgb2JqZWN0LgogICAgKi8KICAgIGNyZWF0ZUN1cnNvcktleXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHsgCiAgICAgICAgICAgIHVwOiB0aGlzLmFkZEtleShQaGFzZXIuS2V5Ym9hcmQuVVApLCAKICAgICAgICAgICAgZG93bjogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLkRPV04pLCAKICAgICAgICAgICAgbGVmdDogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLkxFRlQpLCAKICAgICAgICAgICAgcmlnaHQ6IHRoaXMuYWRkS2V5KFBoYXNlci5LZXlib2FyZC5SSUdIVCkKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBLZXlib2FyZCBldmVudCBsaXN0ZW5lcnMgcnVubmluZyAoa2V5ZG93biBhbmQga2V5dXApLiBUaGV5IGFyZSBhdHRhY2hlZCB0byB0aGUgZG9jdW1lbnQuYm9keS4KICAgICogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuSW5wdXQgYW5kIHNob3VsZCBub3Qgbm9ybWFsbHkgYmUgaW52b2tlZCBkaXJlY3RseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICB0aGlzLl9vbktleURvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NLZXlEb3duKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9vbktleVVwID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5wcm9jZXNzS2V5VXAoZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuX29uS2V5RG93biwgZmFsc2UpOwogICAgICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLl9vbktleVVwLCBmYWxzZSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgdGhlIEtleWJvYXJkIGV2ZW50IGxpc3RlbmVycyBmcm9tIHJ1bm5pbmcgKGtleWRvd24gYW5kIGtleXVwKS4gVGhleSBhcmUgcmVtb3ZlZCBmcm9tIHRoZSBkb2N1bWVudC5ib2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLl9vbktleURvd24pOwogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5dXAnLCB0aGlzLl9vbktleVVwKTsKCiAgICB9LAoKCS8qKgogICAgKiBCeSBkZWZhdWx0IHdoZW4gYSBrZXkgaXMgcHJlc3NlZCBQaGFzZXIgd2lsbCBub3Qgc3RvcCB0aGUgZXZlbnQgZnJvbSBwcm9wYWdhdGluZyB1cCB0byB0aGUgYnJvd3Nlci4KICAgICogVGhlcmUgYXJlIHNvbWUga2V5cyB0aGlzIGNhbiBiZSBhbm5veWluZyBmb3IsIGxpa2UgdGhlIGFycm93IGtleXMgb3Igc3BhY2UgYmFyLCB3aGljaCBtYWtlIHRoZSBicm93c2VyIHdpbmRvdyBzY3JvbGwuCiAgICAqIFlvdSBjYW4gdXNlIGFkZEtleUNhcHR1cmUgdG8gY29uc3VtZSB0aGUga2V5Ym9hcmQgZXZlbnQgZm9yIHNwZWNpZmljIGtleXMgc28gaXQgZG9lc24ndCBidWJibGUgdXAgdG8gdGhlIHRoZSBicm93c2VyLgogICAgKiBQYXNzIGluIGVpdGhlciBhIHNpbmdsZSBrZXljb2RlIG9yIGFuIGFycmF5L2hhc2ggb2Yga2V5Y29kZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2FkZEtleUNhcHR1cmUKICAgICogQHBhcmFtIHtBbnl9IGtleWNvZGUKICAgICovCiAgICBhZGRLZXlDYXB0dXJlOiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBpZiAodHlwZW9mIGtleWNvZGUgPT09ICdvYmplY3QnKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIGtleWNvZGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX2NhcHR1cmVba2V5Y29kZVtrZXldXSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY2FwdHVyZVtrZXljb2RlXSA9IHRydWU7CiAgICAgICAgfQogICAgfSwKCgkvKioKCSogUmVtb3ZlcyBhbiBleGlzdGluZyBrZXkgY2FwdHVyZS4KCSogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcmVtb3ZlS2V5Q2FwdHVyZQogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZQogICAgKi8KICAgIHJlbW92ZUtleUNhcHR1cmU6IGZ1bmN0aW9uIChrZXljb2RlKSB7CgogICAgICAgIGRlbGV0ZSB0aGlzLl9jYXB0dXJlW2tleWNvZGVdOwoKICAgIH0sCgoJLyoqCgkqIENsZWFyIGFsbCBzZXQga2V5IGNhcHR1cmVzLgoJKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNjbGVhckNhcHR1cmVzCiAgICAqLwogICAgY2xlYXJDYXB0dXJlczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9jYXB0dXJlID0ge307CgogICAgfSwKCgkvKioKCSogUHJvY2VzcyB0aGUga2V5ZG93biBldmVudC4KCSogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcHJvY2Vzc0tleURvd24KICAgICogQHBhcmFtIHtLZXlib2FyZEV2ZW50fSBldmVudAogICAgKiBAcHJvdGVjdGVkCiAgICAqLyAgICAKICAgIHByb2Nlc3NLZXlEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2NhcHR1cmVbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMub25Eb3duQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uRG93bkNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdICYmIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uaXNEb3duKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEtleSBhbHJlYWR5IGRvd24gYW5kIHN0aWxsIGRvd24sIHNvIHVwZGF0ZQogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmR1cmF0aW9uID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lRG93bjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCF0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgTm90IHVzZWQgdGhpcyBrZXkgYmVmb3JlLCBzbyByZWdpc3RlciBpdAogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXSA9IHsKICAgICAgICAgICAgICAgICAgICBpc0Rvd246IHRydWUsCiAgICAgICAgICAgICAgICAgICAgdGltZURvd246IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgICAgICB0aW1lVXA6IDAsCiAgICAgICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgS2V5IHVzZWQgYmVmb3JlIGJ1dCBmcmVzaGx5IGRvd24KICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uaXNEb3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0udGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9ob3RrZXlzW2V2ZW50LmtleUNvZGVdLnByb2Nlc3NLZXlEb3duKGV2ZW50KTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogUHJvY2VzcyB0aGUga2V5dXAgZXZlbnQuCgkqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3Byb2Nlc3NLZXlVcAogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzS2V5VXA6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2FwdHVyZVtldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vblVwQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0ucHJvY2Vzc0tleVVwKGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGtleSBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0gPSB7CiAgICAgICAgICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgICAgICAgICAgdGltZURvd246IHRoaXMuZ2FtZS50aW1lLm5vdywKICAgICAgICAgICAgICAgIHRpbWVVcDogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgZHVyYXRpb246IDAKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogUmVzZXQgdGhlICJpc0Rvd24iIHN0YXRlIG9mIGFsbCBrZXlzLgoJKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNyZXNldAogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLl9rZXlzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fa2V5c1trZXldLmlzRG93biA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiB0aGUga2V5LiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBrZXkgd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKQogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VfQkFSCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCBwcmVzc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCBwcmVzc2VkIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKGtleWNvZGUsIGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2tleWNvZGVdICYmIHRoaXMuX2tleXNba2V5Y29kZV0uaXNEb3duICYmIHRoaXMuX2tleXNba2V5Y29kZV0uZHVyYXRpb24gPCBkdXJhdGlvbikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHJlbGVhc2VkIiBzdGF0ZSBvZiB0aGUgS2V5LiBKdXN0IHJlbGVhc2VkIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcgdHJ1ZSBpZiB0aGUga2V5IHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKQogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VfQkFSCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb249MjUwXSAtIFRoZSBkdXJhdGlvbiBiZWxvdyB3aGljaCB0aGUga2V5IGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcganVzdCByZWxlYXNlZC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGp1c3QgcmVsZWFzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKGtleWNvZGUsIGR1cmF0aW9uKSB7CgogICAgICAgIGlmICh0eXBlb2YgZHVyYXRpb24gPT09ICJ1bmRlZmluZWQiKSB7IGR1cmF0aW9uID0gMjUwOyB9CgogICAgICAgIGlmICh0aGlzLl9rZXlzW2tleWNvZGVdICYmIHRoaXMuX2tleXNba2V5Y29kZV0uaXNEb3duID09PSBmYWxzZSAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fa2V5c1trZXljb2RlXS50aW1lVXAgPCBkdXJhdGlvbikpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRydWUgb2YgdGhlIGtleSBpcyBjdXJyZW50bHkgcHJlc3NlZCBkb3duLiBOb3RlIHRoYXQgaXQgY2FuIG9ubHkgZGV0ZWN0IGtleSBwcmVzc2VzIG9uIHRoZSB3ZWIgYnJvd3Nlci4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjaXNEb3duCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRV9CQVIKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGlzIGN1cnJlbnRseSBkb3duLgogICAgKi8KICAgIGlzRG93bjogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd247CiAgICAgICAgfQoKCQlyZXR1cm4gZmFsc2U7CgogICAgfQoKfTsKClBoYXNlci5LZXlib2FyZC5BID0gIkEiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5CID0gIkIiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5DID0gIkMiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5EID0gIkQiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5FID0gIkUiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5GID0gIkYiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5HID0gIkciLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5IID0gIkgiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5JID0gIkkiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5KID0gIkoiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5LID0gIksiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5MID0gIkwiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5NID0gIk0iLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5OID0gIk4iLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5PID0gIk8iLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5QID0gIlAiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5RID0gIlEiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5SID0gIlIiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5TID0gIlMiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5UID0gIlQiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5VID0gIlUiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5WID0gIlYiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5XID0gIlciLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5YID0gIlgiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5ZID0gIlkiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5aID0gIloiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5aRVJPID0gIjAiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5PTkUgPSAiMSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlRXTyA9ICIyIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVEhSRUUgPSAiMyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkZPVVIgPSAiNCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkZJVkUgPSAiNSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlNJWCA9ICI2Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuU0VWRU4gPSAiNyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkVJR0hUID0gIjgiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5OSU5FID0gIjkiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfMCA9IDk2OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzEgPSA5NzsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8yID0gOTg7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfMyA9IDk5OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzQgPSAxMDA7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNSA9IDEwMTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF82ID0gMTAyOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzcgPSAxMDM7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfOCA9IDEwNDsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF85ID0gMTA1OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX01VTFRJUExZID0gMTA2OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0FERCA9IDEwNzsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9FTlRFUiA9IDEwODsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9TVUJUUkFDVCA9IDEwOTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF9ERUNJTUFMID0gMTEwOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0RJVklERSA9IDExMTsKUGhhc2VyLktleWJvYXJkLkYxID0gMTEyOwpQaGFzZXIuS2V5Ym9hcmQuRjIgPSAxMTM7ClBoYXNlci5LZXlib2FyZC5GMyA9IDExNDsKUGhhc2VyLktleWJvYXJkLkY0ID0gMTE1OwpQaGFzZXIuS2V5Ym9hcmQuRjUgPSAxMTY7ClBoYXNlci5LZXlib2FyZC5GNiA9IDExNzsKUGhhc2VyLktleWJvYXJkLkY3ID0gMTE4OwpQaGFzZXIuS2V5Ym9hcmQuRjggPSAxMTk7ClBoYXNlci5LZXlib2FyZC5GOSA9IDEyMDsKUGhhc2VyLktleWJvYXJkLkYxMCA9IDEyMTsKUGhhc2VyLktleWJvYXJkLkYxMSA9IDEyMjsKUGhhc2VyLktleWJvYXJkLkYxMiA9IDEyMzsKUGhhc2VyLktleWJvYXJkLkYxMyA9IDEyNDsKUGhhc2VyLktleWJvYXJkLkYxNCA9IDEyNTsKUGhhc2VyLktleWJvYXJkLkYxNSA9IDEyNjsKUGhhc2VyLktleWJvYXJkLkNPTE9OID0gMTg2OwpQaGFzZXIuS2V5Ym9hcmQuRVFVQUxTID0gMTg3OwpQaGFzZXIuS2V5Ym9hcmQuVU5ERVJTQ09SRSA9IDE4OTsKUGhhc2VyLktleWJvYXJkLlFVRVNUSU9OX01BUksgPSAxOTE7ClBoYXNlci5LZXlib2FyZC5USUxERSA9IDE5MjsKUGhhc2VyLktleWJvYXJkLk9QRU5fQlJBQ0tFVCA9IDIxOTsKUGhhc2VyLktleWJvYXJkLkJBQ0tXQVJEX1NMQVNIID0gMjIwOwpQaGFzZXIuS2V5Ym9hcmQuQ0xPU0VEX0JSQUNLRVQgPSAyMjE7ClBoYXNlci5LZXlib2FyZC5RVU9URVMgPSAyMjI7ClBoYXNlci5LZXlib2FyZC5CQUNLU1BBQ0UgPSA4OwpQaGFzZXIuS2V5Ym9hcmQuVEFCID0gOTsKUGhhc2VyLktleWJvYXJkLkNMRUFSID0gMTI7ClBoYXNlci5LZXlib2FyZC5FTlRFUiA9IDEzOwpQaGFzZXIuS2V5Ym9hcmQuU0hJRlQgPSAxNjsKUGhhc2VyLktleWJvYXJkLkNPTlRST0wgPSAxNzsKUGhhc2VyLktleWJvYXJkLkFMVCA9IDE4OwpQaGFzZXIuS2V5Ym9hcmQuQ0FQU19MT0NLID0gMjA7ClBoYXNlci5LZXlib2FyZC5FU0MgPSAyNzsKUGhhc2VyLktleWJvYXJkLlNQQUNFQkFSID0gMzI7ClBoYXNlci5LZXlib2FyZC5QQUdFX1VQID0gMzM7ClBoYXNlci5LZXlib2FyZC5QQUdFX0RPV04gPSAzNDsKUGhhc2VyLktleWJvYXJkLkVORCA9IDM1OwpQaGFzZXIuS2V5Ym9hcmQuSE9NRSA9IDM2OwpQaGFzZXIuS2V5Ym9hcmQuTEVGVCA9IDM3OwpQaGFzZXIuS2V5Ym9hcmQuVVAgPSAzODsKUGhhc2VyLktleWJvYXJkLlJJR0hUID0gMzk7ClBoYXNlci5LZXlib2FyZC5ET1dOID0gNDA7ClBoYXNlci5LZXlib2FyZC5JTlNFUlQgPSA0NTsKUGhhc2VyLktleWJvYXJkLkRFTEVURSA9IDQ2OwpQaGFzZXIuS2V5Ym9hcmQuSEVMUCA9IDQ3OwpQaGFzZXIuS2V5Ym9hcmQuTlVNX0xPQ0sgPSAxNDQ7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBNb3VzZSBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuTW91c2UKKiBAY2xhc3NkZXNjIFRoZSBNb3VzZSBjbGFzcwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLk1vdXNlID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgkKCS8qKgoJKiBAcHJvcGVydHkge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gRGVzY3JpcHRpb24uCgkqLwoJdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzLmdhbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG1vdXNlRG93bkNhbGxiYWNrIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5tb3VzZURvd25DYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBtb3VzZU1vdmVDYWxsYmFjayAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubW91c2VNb3ZlQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gbW91c2VVcENhbGxiYWNrIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5tb3VzZVVwQ2FsbGJhY2sgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gYnV0dG9uLSBUaGUgdHlwZSBvZiBjbGljaywgZWl0aGVyOiBQaGFzZXIuTW91c2UuTk9fQlVUVE9OLCBQaGFzZXIuTW91c2UuTEVGVF9CVVRUT04sIFBoYXNlci5Nb3VzZS5NSURETEVfQlVUVE9OIG9yIFBoYXNlci5Nb3VzZS5SSUdIVF9CVVRUT04uCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5idXR0b24gPSAtMTsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBJZiB0aGUgbW91c2UgaGFzIGJlZW4gUG9pbnRlciBMb2NrZWQgc3VjY2Vzc2Z1bGx5IHRoaXMgd2lsbCBiZSBzZXQgdG8gdHJ1ZS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb2NrZWQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBUaGlzIGV2ZW50IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgb3IgbGVhdmVzIHBvaW50ZXIgbG9jayBzdGF0ZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBwb2ludGVyTG9jawogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucG9pbnRlckxvY2sgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCiAgICAvKioKICAgICogVGhlIGJyb3dzZXIgbW91c2UgZXZlbnQuCiAgICAqIEBwcm9wZXJ0eSB7TW91c2VFdmVudH0gZXZlbnQKICAgICovCiAgICB0aGlzLmV2ZW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Nb3VzZURvd24KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlRG93bjsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTW91c2VNb3ZlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fb25Nb3VzZU1vdmU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1vdXNlVXAKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlVXA7Cgp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLk1vdXNlLk5PX0JVVFRPTiA9IC0xOwovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuTEVGVF9CVVRUT04gPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLk1vdXNlLk1JRERMRV9CVVRUT04gPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLk1vdXNlLlJJR0hUX0JVVFRPTiA9IDI7CgpQaGFzZXIuTW91c2UucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBTdGFydHMgdGhlIGV2ZW50IGxpc3RlbmVycyBydW5uaW5nLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmFuZHJvaWQgJiYgdGhpcy5nYW1lLmRldmljZS5jaHJvbWUgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQW5kcm9pZCBzdG9jayBicm93c2VyIGZpcmVzIG1vdXNlIGV2ZW50cyBldmVuIGlmIHlvdSBwcmV2ZW50RGVmYXVsdCBvbiB0aGUgdG91Y2hTdGFydCwgc28gLi4uCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX29uTW91c2VEb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIHJldHVybiBfdGhpcy5vbk1vdXNlRG93bihldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgdGhpcy5fb25Nb3VzZU1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VNb3ZlKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9vbk1vdXNlVXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VVcChldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgLy8gdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fb25Nb3VzZURvd24sIHRydWUpOwogICAgICAgIC8vIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX29uTW91c2VNb3ZlLCB0cnVlKTsKICAgICAgICAvLyB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5fb25Nb3VzZVVwLCB0cnVlKTsKCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fb25Nb3VzZURvd24sIHRydWUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX29uTW91c2VNb3ZlLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZXVwJywgdGhpcy5fb25Nb3VzZVVwLCB0cnVlKTsKCiAgICB9LAoKCS8qKgoJKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgZG93biBldmVudCBmcm9tIHRoZSBicm93c2VyLgoJKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNvbk1vdXNlRG93bgogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50CiAgICAqLwogICAgb25Nb3VzZURvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgIHRoaXMuYnV0dG9uID0gZXZlbnQud2hpY2g7CgogICAgICAgIGlmICh0aGlzLm1vdXNlRG93bkNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZURvd25DYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudFsnaWRlbnRpZmllciddID0gMDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlUG9pbnRlci5zdGFydChldmVudCk7CgogICAgfSwKCgkvKioKICAgICogVGhlIGludGVybmFsIG1ldGhvZCB0aGF0IGhhbmRsZXMgdGhlIG1vdXNlIG1vdmUgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4KCSogQG1ldGhvZCBQaGFzZXIuTW91c2Ujb25Nb3VzZU1vdmUKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fSBldmVudAogICAgKi8KICAgIG9uTW91c2VNb3ZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgICAgICBpZiAodGhpcy5tb3VzZU1vdmVDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW91c2VNb3ZlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnRbJ2lkZW50aWZpZXInXSA9IDA7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZVBvaW50ZXIubW92ZShldmVudCk7CgogICAgfSwKCgkvKioKICAgICogVGhlIGludGVybmFsIG1ldGhvZCB0aGF0IGhhbmRsZXMgdGhlIG1vdXNlIHVwIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuCgkqIEBtZXRob2QgUGhhc2VyLk1vdXNlI29uTW91c2VVcAogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50CiAgICAqLwogICAgb25Nb3VzZVVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50OwoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIAl0aGlzLmJ1dHRvbiA9IFBoYXNlci5Nb3VzZS5OT19CVVRUT047CgogICAgICAgIGlmICh0aGlzLm1vdXNlVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubW91c2VVcENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50WydpZGVudGlmaWVyJ10gPSAwOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2VQb2ludGVyLnN0b3AoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBicm93c2VyIHN1cHBvcnRzIGl0IHlvdSBjYW4gcmVxdWVzdCB0aGF0IHRoZSBwb2ludGVyIGJlIGxvY2tlZCB0byB0aGUgYnJvd3NlciB3aW5kb3cuCiAgICAqIFRoaXMgaXMgY2xhc3NpY2FsbHkga25vd24gYXMgJ0ZQUyBjb250cm9scycsIHdoZXJlIHRoZSBwb2ludGVyIGNhbid0IGxlYXZlIHRoZSBicm93c2VyIHVudGlsIHRoZSB1c2VyIHByZXNzZXMgYW4gZXhpdCBrZXkuCiAgICAqIElmIHRoZSBicm93c2VyIHN1Y2Nlc3NmdWxseSBlbnRlcnMgYSBsb2NrZWQgc3RhdGUgdGhlIGV2ZW50IFBoYXNlci5Nb3VzZS5wb2ludGVyTG9jayB3aWxsIGJlIGRpc3BhdGNoZWQgYW5kIHRoZSBmaXJzdCBwYXJhbWV0ZXIgd2lsbCBiZSAndHJ1ZScuCgkqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3JlcXVlc3RQb2ludGVyTG9jawogICAgKi8KICAgIHJlcXVlc3RQb2ludGVyTG9jazogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5wb2ludGVyTG9jaykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5nYW1lLnN0YWdlLmNhbnZhczsKCiAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdFBvaW50ZXJMb2NrID0gZWxlbWVudC5yZXF1ZXN0UG9pbnRlckxvY2sgfHwgZWxlbWVudC5tb3pSZXF1ZXN0UG9pbnRlckxvY2sgfHwgZWxlbWVudC53ZWJraXRSZXF1ZXN0UG9pbnRlckxvY2s7CgogICAgICAgICAgICBlbGVtZW50LnJlcXVlc3RQb2ludGVyTG9jaygpOwoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucG9pbnRlckxvY2tDaGFuZ2UoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21venBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogSW50ZXJuYWwgcG9pbnRlckxvY2tDaGFuZ2UgaGFuZGxlci4KCSogQG1ldGhvZCBQaGFzZXIuTW91c2UjcG9pbnRlckxvY2tDaGFuZ2UKICAgICogQHBhcmFtIHtNb3VzZUV2ZW50fSBldmVudAogICAgKi8KICAgIHBvaW50ZXJMb2NrQ2hhbmdlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzOwoKICAgICAgICBpZiAoZG9jdW1lbnQucG9pbnRlckxvY2tFbGVtZW50ID09PSBlbGVtZW50IHx8IGRvY3VtZW50Lm1velBvaW50ZXJMb2NrRWxlbWVudCA9PT0gZWxlbWVudCB8fCBkb2N1bWVudC53ZWJraXRQb2ludGVyTG9ja0VsZW1lbnQgPT09IGVsZW1lbnQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUG9pbnRlciB3YXMgc3VjY2Vzc2Z1bGx5IGxvY2tlZAogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMucG9pbnRlckxvY2suZGlzcGF0Y2godHJ1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQb2ludGVyIHdhcyB1bmxvY2tlZAogICAgICAgICAgICB0aGlzLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnBvaW50ZXJMb2NrLmRpc3BhdGNoKGZhbHNlKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogSW50ZXJuYWwgcmVsZWFzZSBwb2ludGVyIGxvY2sgaGFuZGxlci4KCSogQG1ldGhvZCBQaGFzZXIuTW91c2UjcmVsZWFzZVBvaW50ZXJMb2NrCiAgICAqLwogICAgcmVsZWFzZVBvaW50ZXJMb2NrOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGRvY3VtZW50LmV4aXRQb2ludGVyTG9jayA9IGRvY3VtZW50LmV4aXRQb2ludGVyTG9jayB8fCBkb2N1bWVudC5tb3pFeGl0UG9pbnRlckxvY2sgfHwgZG9jdW1lbnQud2Via2l0RXhpdFBvaW50ZXJMb2NrOwoKICAgICAgICBkb2N1bWVudC5leGl0UG9pbnRlckxvY2soKTsKCiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW96cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignd2Via2l0cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CgogICAgfSwKCgkvKioKICAgICogU3RvcCB0aGUgZXZlbnQgbGlzdGVuZXJzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuX29uTW91c2VEb3duLCB0cnVlKTsKICAgICAgICAvLyB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuX29uTW91c2VNb3ZlLCB0cnVlKTsKICAgICAgICAvLyB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93biwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBNU1BvaW50ZXIgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLk1TUG9pbnRlcgoqIEBjbGFzc2Rlc2MgVGhlIE1TUG9pbnRlciBjbGFzcyBoYW5kbGVzIHRvdWNoIGludGVyYWN0aW9ucyB3aXRoIHRoZSBnYW1lIGFuZCB0aGUgcmVzdWx0aW5nIFBvaW50ZXIgb2JqZWN0cy4KKiBJdCB3aWxsIHdvcmsgb25seSBpbiBJbnRlcm5ldCBFeHBsb3JlciAxMCBhbmQgV2luZG93cyBTdG9yZSBvciBXaW5kb3dzIFBob25lIDggYXBwcyB1c2luZyBKYXZhU2NyaXB0LgoqIGh0dHA6Ly9tc2RuLm1pY3Jvc29mdC5jb20vZW4tdXMvbGlicmFyeS9pZS9oaDY3MzU1Nyh2PXZzLjg1KS5hc3B4CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuTVNQb2ludGVyID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgkKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBjYWxsYmFja0NvbnRleHQgLSBEZXNjcmlwdGlvbi4KCSovCgl0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXMuZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gbW91c2VEb3duQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLm1vdXNlRG93bkNhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IG1vdXNlTW92ZUNhbGxiYWNrIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5tb3VzZU1vdmVDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBtb3VzZVVwQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLm1vdXNlVXBDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gZGlzYWJsZSBhbGwgSW5wdXQgYnkgc2V0dGluZyBkaXNhYmxlZCA9IHRydWUuIFdoaWxlIHNldCBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9vbk1TUG9pbnRlckRvd24KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbk1TUG9pbnRlckRvd24gPSBudWxsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9vbk1TUG9pbnRlck1vdmUKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbk1TUG9pbnRlck1vdmUgPSBudWxsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9vbk1TUG9pbnRlclVwCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25NU1BvaW50ZXJVcCA9IG51bGw7Cgp9OwoKUGhhc2VyLk1TUG9pbnRlci5wcm90b3R5cGUgPSB7CgoJLyoqCiAgICAqIFN0YXJ0cyB0aGUgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLm1zcG9pbnRlciA9PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25NU1BvaW50ZXJEb3duID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Qb2ludGVyRG93bihldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vbk1TUG9pbnRlck1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblBvaW50ZXJNb3ZlKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uTVNQb2ludGVyVXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblBvaW50ZXJVcChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJEb3duJywgdGhpcy5fb25NU1BvaW50ZXJEb3duLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlck1vdmUnLCB0aGlzLl9vbk1TUG9pbnRlck1vdmUsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyVXAnLCB0aGlzLl9vbk1TUG9pbnRlclVwLCBmYWxzZSk7CgogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5zdHlsZVsnLW1zLWNvbnRlbnQtem9vbWluZyddID0gJ25vbmUnOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5zdHlsZVsnLW1zLXRvdWNoLWFjdGlvbiddID0gJ25vbmUnOwoKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNvblBvaW50ZXJEb3duCiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKiovCiAgICBvblBvaW50ZXJEb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5pZGVudGlmaWVyID0gZXZlbnQucG9pbnRlcklkOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RhcnRQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI29uUG9pbnRlck1vdmUKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqKi8KICAgIG9uUG9pbnRlck1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2ZW50LmlkZW50aWZpZXIgPSBldmVudC5wb2ludGVySWQ7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC51cGRhdGVQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI29uUG9pbnRlclVwCiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKiovCiAgICBvblBvaW50ZXJVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuaWRlbnRpZmllciA9IGV2ZW50LnBvaW50ZXJJZDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0LnN0b3BQb2ludGVyKGV2ZW50KTsKCiAgICB9LAoKCS8qKgogICAgKiBTdG9wIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1TUG9pbnRlciNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlckRvd24nLCB0aGlzLl9vbk1TUG9pbnRlckRvd24pOwogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyTW92ZScsIHRoaXMuX29uTVNQb2ludGVyTW92ZSk7CiAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJVcCcsIHRoaXMuX29uTVNQb2ludGVyVXApOwoKICAgIH0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIFBvaW50ZXIgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlBvaW50ZXIKKiBAY2xhc3NkZXNjIEEgUG9pbnRlciBvYmplY3QgaXMgdXNlZCBieSB0aGUgTW91c2UsIFRvdWNoIGFuZCBNU1BvaW50IG1hbmFnZXJzIGFuZCByZXByZXNlbnRzIGEgc2luZ2xlIGZpbmdlciBvbiB0aGUgdG91Y2ggc2NyZWVuLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBpZCAtIERlc2NyaXB0aW9uLgoqLwpQaGFzZXIuUG9pbnRlciA9IGZ1bmN0aW9uIChnYW1lLCBpZCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gaWQgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLmlkID0gaWQ7CgogICAgLyoqCiAgICAqIExvY2FsIHByaXZhdGUgdmFyaWFibGUgdG8gc3RvcmUgdGhlIHN0YXR1cyBvZiBkaXNwYXRjaGluZyBhIGhvbGQgZXZlbnQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2hvbGRTZW50CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5faG9sZFNlbnQgPSBmYWxzZTsKCiAgICAvKioKICAgICogTG9jYWwgcHJpdmF0ZSB2YXJpYWJsZSBzdG9yaW5nIHRoZSBzaG9ydC10ZXJtIGhpc3Rvcnkgb2YgcG9pbnRlciBtb3ZlbWVudHMuCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9oaXN0b3J5CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faGlzdG9yeSA9IFtdOwoKICAgIC8qKgogICAgKiBMb2NhbCBwcml2YXRlIHZhcmlhYmxlIHN0b3JpbmcgdGhlIHRpbWUgYXQgd2hpY2ggdGhlIG5leHQgaGlzdG9yeSBkcm9wIHNob3VsZCBvY2N1cgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2xhc3REcm9wCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fbmV4dERyb3AgPSAwOwoKICAgIC8qKgogICAgICogTW9uaXRvciBldmVudHMgb3V0c2lkZSBvZiBhIHN0YXRlIHJlc2V0IGxvb3AuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9zdGF0ZVJlc2V0CiAgICAgKiBAcHJpdmF0ZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5fc3RhdGVSZXNldCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSB3aXRoaW5HYW1lCiAgICAqLwogICAgdGhpcy53aXRoaW5HYW1lID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFRoZSBob3Jpem9udGFsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0IGluIHBpeGVscywgZXhjbHVkaW5nIGFueSBzY3JvbGwgb2Zmc2V0LgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY2xpZW50WAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2xpZW50WCA9IC0xOwoKICAgIC8qKgogICAgKiBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBleGNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjbGllbnRZCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jbGllbnRZID0gLTE7CgogICAgLyoqCiAgICAqIFRoZSBob3Jpem9udGFsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0IGluIHBpeGVscywgaW5jbHVkaW5nIGFueSBzY3JvbGwgb2Zmc2V0LgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFnZVgKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VYID0gLTE7CgogICAgLyoqCiAgICAqIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCBpbiBwaXhlbHMsIGluY2x1ZGluZyBhbnkgc2Nyb2xsIG9mZnNldC4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhZ2VZCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlWSA9IC0xOwoKICAgIC8qKgogICAgKiBUaGUgaG9yaXpvbnRhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBzY3JlZW4gaW4gcGl4ZWxzLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2NyZWVuWAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2NyZWVuWCA9IC0xOwoKICAgIC8qKgogICAgKiBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgc2NyZWVuIGluIHBpeGVscy4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcmVlblkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnNjcmVlblkgPSAtMTsKCiAgICAvKioKICAgICogVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgZ2FtZSBlbGVtZW50LiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgc2NhbGVkIGJhc2VkIG9uIGdhbWUgc2l6ZS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHgKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnggPSAtMTsKCiAgICAvKioKICAgICogVGhlIHZlcnRpY2FsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIGdhbWUgZWxlbWVudC4gVGhpcyB2YWx1ZSBpcyBhdXRvbWF0aWNhbGx5IHNjYWxlZCBiYXNlZCBvbiBnYW1lIHNpemUuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy55ID0gLTE7CgogICAgLyoqCiAgICAqIElmIHRoZSBQb2ludGVyIGlzIGEgbW91c2UgdGhpcyBpcyB0cnVlLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNNb3VzZQogICAgKiBAdHlwZSB7Ym9vbGVhbn0KICAgICovCiAgICB0aGlzLmlzTW91c2UgPSBmYWxzZTsKCiAgICAvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgdG91Y2hpbmcgdGhlIHRvdWNoc2NyZWVuLCBvciB0aGUgbW91c2UgYnV0dG9uIGlzIGhlbGQgZG93biwgaXNEb3duIGlzIHNldCB0byB0cnVlLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRG93bgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CgogICAgLyoqCiAgICAqIElmIHRoZSBQb2ludGVyIGlzIG5vdCB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgdXAsIGlzVXAgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNVcAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNVcCA9IHRydWU7CgogICAgLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGZpcnN0IHRvdWNoZWQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGltZURvd24KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVEb3duID0gMDsKCiAgICAvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgbGVmdCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lVXAKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRpbWVVcCA9IDA7CgogICAgLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIHdhcyBsYXN0IHRhcHBlZCBvciBjbGlja2VkLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJldmlvdXNUYXBUaW1lCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wcmV2aW91c1RhcFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBUaGUgdG90YWwgbnVtYmVyIG9mIHRpbWVzIHRoaXMgUG9pbnRlciBoYXMgYmVlbiB0b3VjaGVkIHRvIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsVG91Y2hlcwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG90YWxUb3VjaGVzID0gMDsKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxpc2Vjb25kcyBzaW5jZSB0aGUgbGFzdCBjbGljay4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1zU2luY2VMYXN0Q2xpY2sKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1zU2luY2VMYXN0Q2xpY2sgPSBOdW1iZXIuTUFYX1ZBTFVFOwoKICAgIC8qKgogICAgKiBUaGUgR2FtZSBPYmplY3QgdGhpcyBQb2ludGVyIGlzIGN1cnJlbnRseSBvdmVyIC8gdG91Y2hpbmcgLyBkcmFnZ2luZy4KICAgICogQHByb3BlcnR5IHtBbnl9IHRhcmdldE9iamVjdAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKCiAgICAvKioKICAgICogQW4gYWN0aXZlIHBvaW50ZXIgaXMgb25lIHRoYXQgaXMgY3VycmVudGx5IHByZXNzZWQgZG93biBvbiB0aGUgZGlzcGxheS4gQSBNb3VzZSBpcyBhbHdheXMgYWN0aXZlLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEEgUGhhc2VyLlBvaW50IG9iamVjdCBjb250YWluaW5nIHRoZSBjdXJyZW50IHgveSB2YWx1ZXMgb2YgdGhlIHBvaW50ZXIgb24gdGhlIGRpc3BsYXkuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwb3NpdGlvbgogICAgKi8KICAgIHRoaXMucG9zaXRpb24gPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAKICAgIC8qKgogICAgKiBBIFBoYXNlci5Qb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgeC95IHZhbHVlcyBvZiB0aGUgcG9pbnRlciB3aGVuIGl0IHdhcyBsYXN0IGluIGEgZG93biBzdGF0ZSBvbiB0aGUgZGlzcGxheS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uRG93bgogICAgKi8KICAgIHRoaXMucG9zaXRpb25Eb3duID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKICAgIC8qKgogICAgKiBBIFBoYXNlci5DaXJjbGUgdGhhdCBpcyBjZW50ZXJlZCBvbiB0aGUgeC95IGNvb3JkaW5hdGVzIG9mIHRoaXMgcG9pbnRlciwgdXNlZnVsIGZvciBoaXQgZGV0ZWN0aW9uLgogICAgKiBUaGUgQ2lyY2xlIHNpemUgaXMgNDRweCAoQXBwbGVzIHJlY29tbWVuZGVkICJmaW5nZXIgdGlwIiBzaXplKS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuQ2lyY2xlfSBjaXJjbGUKICAgICovCiAgICB0aGlzLmNpcmNsZSA9IG5ldyBQaGFzZXIuQ2lyY2xlKDAsIDAsIDQ0KTsKCiAgICBpZiAoaWQgPT0gMCkKICAgIHsKICAgICAgICB0aGlzLmlzTW91c2UgPSB0cnVlOwogICAgfQoKfTsKClBoYXNlci5Qb2ludGVyLnByb3RvdHlwZSA9IHsKCgkvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgaXMgcHJlc3NlZCBvbnRvIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNzdGFydAogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuaWRlbnRpZmllciA9IGV2ZW50LmlkZW50aWZpZXI7CiAgICAgICAgdGhpcy50YXJnZXQgPSBldmVudC50YXJnZXQ7CgogICAgICAgIGlmICh0eXBlb2YgZXZlbnQuYnV0dG9uICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYnV0dG9uID0gZXZlbnQuYnV0dG9uOwogICAgICAgIH0KCiAgICAgICAgLy8gIEZpeCB0byBzdG9wIHJvZ3VlIGJyb3dzZXIgcGx1Z2lucyBmcm9tIGJsb2NraW5nIHRoZSB2aXNpYmlsaXR5IHN0YXRlIGV2ZW50CiAgICAgICAgaWYgKHRoaXMuZ2FtZS5wYXVzZWQgPT0gdHJ1ZSAmJiB0aGlzLmdhbWUuc3RhZ2Uuc2NhbGUuaW5jb3JyZWN0T3JpZW50YXRpb24gPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5faGlzdG9yeS5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuYWN0aXZlID0gdHJ1ZTsKICAgICAgICB0aGlzLndpdGhpbkdhbWUgPSB0cnVlOwogICAgICAgIHRoaXMuaXNEb3duID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzVXAgPSBmYWxzZTsKCiAgICAgICAgLy8gIFdvcmsgb3V0IGhvdyBsb25nIGl0IGhhcyBiZWVuIHNpbmNlIHRoZSBsYXN0IGNsaWNrCiAgICAgICAgdGhpcy5tc1NpbmNlTGFzdENsaWNrID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lRG93bjsKICAgICAgICB0aGlzLnRpbWVEb3duID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMuX2hvbGRTZW50ID0gZmFsc2U7CgogICAgICAgIC8vICBUaGlzIHNldHMgdGhlIHgveSBhbmQgb3RoZXIgbG9jYWwgdmFsdWVzCiAgICAgICAgdGhpcy5tb3ZlKGV2ZW50KTsKCiAgICAgICAgLy8geCBhbmQgeSBhcmUgdGhlIG9sZCB2YWx1ZXMgaGVyZT8KICAgICAgICB0aGlzLnBvc2l0aW9uRG93bi5zZXRUbyh0aGlzLngsIHRoaXMueSk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT0gMCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQueCA9IHRoaXMueDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnkgPSB0aGlzLnk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5wb3NpdGlvbi5zZXRUbyh0aGlzLngsIHRoaXMueSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vbkRvd24uZGlzcGF0Y2godGhpcywgZXZlbnQpOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQucmVzZXRTcGVlZCh0aGlzLngsIHRoaXMueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zdGF0ZVJlc2V0ID0gZmFsc2U7CiAgICAgICAgdGhpcy50b3RhbFRvdWNoZXMrKzsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMrKzsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll90b3VjaGVkSGFuZGxlcih0aGlzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgoJLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5hY3RpdmUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5faG9sZFNlbnQgPT0gZmFsc2UgJiYgdGhpcy5kdXJhdGlvbiA+PSB0aGlzLmdhbWUuaW5wdXQuaG9sZFJhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT0gMCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uSG9sZC5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9ob2xkU2VudCA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBVcGRhdGUgdGhlIGRyb3BwaW5ncyBoaXN0b3J5CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQucmVjb3JkUG9pbnRlckhpc3RvcnkgJiYgdGhpcy5nYW1lLnRpbWUubm93ID49IHRoaXMuX25leHREcm9wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9uZXh0RHJvcCA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZ2FtZS5pbnB1dC5yZWNvcmRSYXRlOwoKICAgICAgICAgICAgICAgIHRoaXMuX2hpc3RvcnkucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgeDogdGhpcy5wb3NpdGlvbi54LAogICAgICAgICAgICAgICAgICAgIHk6IHRoaXMucG9zaXRpb24ueQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKHRoaXMuX2hpc3RvcnkubGVuZ3RoID4gdGhpcy5nYW1lLmlucHV0LnJlY29yZExpbWl0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpc3Rvcnkuc2hpZnQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgUG9pbnRlciBpcyBtb3ZlZAogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI21vdmUKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgbW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQucG9sbExvY2tlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgZXZlbnQuYnV0dG9uICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYnV0dG9uID0gZXZlbnQuYnV0dG9uOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jbGllbnRYID0gZXZlbnQuY2xpZW50WDsKICAgICAgICB0aGlzLmNsaWVudFkgPSBldmVudC5jbGllbnRZOwoKICAgICAgICB0aGlzLnBhZ2VYID0gZXZlbnQucGFnZVg7CiAgICAgICAgdGhpcy5wYWdlWSA9IGV2ZW50LnBhZ2VZOwoKICAgICAgICB0aGlzLnNjcmVlblggPSBldmVudC5zY3JlZW5YOwogICAgICAgIHRoaXMuc2NyZWVuWSA9IGV2ZW50LnNjcmVlblk7CgogICAgICAgIHRoaXMueCA9ICh0aGlzLnBhZ2VYIC0gdGhpcy5nYW1lLnN0YWdlLm9mZnNldC54KSAqIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS54OwogICAgICAgIHRoaXMueSA9ICh0aGlzLnBhZ2VZIC0gdGhpcy5nYW1lLnN0YWdlLm9mZnNldC55KSAqIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS55OwoKICAgICAgICB0aGlzLnBvc2l0aW9uLnNldFRvKHRoaXMueCwgdGhpcy55KTsKICAgICAgICB0aGlzLmNpcmNsZS54ID0gdGhpcy54OwogICAgICAgIHRoaXMuY2lyY2xlLnkgPSB0aGlzLnk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggfHwgdGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSB8fCAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuVE9VQ0hfT1ZFUlJJREVTX01PVVNFICYmIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMgPT0gMCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlciA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC54ID0gdGhpcy54OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQueSA9IHRoaXMueTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnBvc2l0aW9uLnNldFRvKHRoaXMuZ2FtZS5pbnB1dC54LCB0aGlzLmdhbWUuaW5wdXQueSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jaXJjbGUueCA9IHRoaXMuZ2FtZS5pbnB1dC54OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuY2lyY2xlLnkgPSB0aGlzLmdhbWUuaW5wdXQueTsKICAgICAgICB9CgogICAgICAgIC8vICBJZiB0aGUgZ2FtZSBpcyBwYXVzZWQgd2UgZG9uJ3QgcHJvY2VzcyBhbnkgdGFyZ2V0IG9iamVjdHMKICAgICAgICBpZiAodGhpcy5nYW1lLnBhdXNlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgLy8gIEVhc3kgb3V0IGlmIHdlJ3JlIGRyYWdnaW5nIHNvbWV0aGluZyBhbmQgaXQgc3RpbGwgZXhpc3RzCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ICE9PSBudWxsICYmIHRoaXMudGFyZ2V0T2JqZWN0LmlzRHJhZ2dlZCA9PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0LnVwZGF0ZSh0aGlzKSA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgogICAgICAgIC8vICBXb3JrIG91dCB3aGljaCBvYmplY3QgaXMgb24gdGhlIHRvcAogICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPcmRlcklEID0gLTE7CiAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCA9IG51bGw7CiAgICAgICAgdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCA9IC0xOwoKICAgICAgICAvLyAgSnVzdCBydW4gdGhyb3VnaCB0aGUgbGlua2VkIGxpc3QKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMudG90YWwgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMubmV4dDsKCiAgICAgICAgICAgIGRvICAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIElmIHRoZSBvYmplY3QgaXMgdXNpbmcgcGl4ZWxQZXJmZWN0IGNoZWNrcywgb3IgaGFzIGEgaGlnaGVyIElucHV0TWFuYWdlci5Qcmlvcml0eUlEIE9SIGlmIHRoZSBwcmlvcml0eSBJRCBpcyB0aGUgc2FtZSBhcyB0aGUgY3VycmVudCBoaWdoZXN0IEFORCBpdCBoYXMgYSBoaWdoZXIgcmVuZGVyT3JkZXJJRCwgdGhlbiBzZXQgaXQgdG8gdGhlIHRvcAogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnBpeGVsUGVyZmVjdCB8fCBjdXJyZW50Tm9kZS5wcmlvcml0eUlEID4gdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCB8fCAoY3VycmVudE5vZGUucHJpb3JpdHlJRCA9PSB0aGlzLl9oaWdoZXN0SW5wdXRQcmlvcml0eUlEICYmIGN1cnJlbnROb2RlLnNwcml0ZS5yZW5kZXJPcmRlcklEID4gdGhpcy5faGlnaGVzdFJlbmRlck9yZGVySUQpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5jaGVja1BvaW50ZXJPdmVyKHRoaXMpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0hSTyBzZXQnLCBjdXJyZW50Tm9kZS5zcHJpdGUubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPcmRlcklEID0gY3VycmVudE5vZGUuc3ByaXRlLnJlbmRlck9yZGVySUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZ2hlc3RJbnB1dFByaW9yaXR5SUQgPSBjdXJyZW50Tm9kZS5wcmlvcml0eUlEOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0ID0gY3VycmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSBudWxsKQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBUaGUgcG9pbnRlciBpc24ndCBjdXJyZW50bHkgb3ZlciBhbnl0aGluZywgY2hlY2sgaWYgd2UndmUgZ290IGEgbGluZ2VyaW5nIHByZXZpb3VzIHRhcmdldAogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCJUaGUgcG9pbnRlciBpc24ndCBjdXJyZW50bHkgb3ZlciBhbnl0aGluZywgY2hlY2sgaWYgd2UndmUgZ290IGEgbGluZ2VyaW5nIHByZXZpb3VzIHRhcmdldCIpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3BvaW50ZXJPdXRIYW5kbGVyKHRoaXMpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCA9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQW5kIG5vdyBzZXQgdGhlIG5ldyBvbmUKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdBbmQgbm93IHNldCB0aGUgbmV3IG9uZScpOwogICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0OwogICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdC5fcG9pbnRlck92ZXJIYW5kbGVyKHRoaXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdlJ3ZlIGdvdCBhIHRhcmdldCBmcm9tIHRoZSBsYXN0IHVwZGF0ZQogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIldlJ3ZlIGdvdCBhIHRhcmdldCBmcm9tIHRoZSBsYXN0IHVwZGF0ZSIpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ID09IHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFNhbWUgdGFyZ2V0IGFzIGJlZm9yZSwgc28gdXBkYXRlIGl0CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIlNhbWUgdGFyZ2V0IGFzIGJlZm9yZSwgc28gdXBkYXRlIGl0Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QudXBkYXRlKHRoaXMpID09IGZhbHNlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhlIHRhcmdldCBoYXMgY2hhbmdlZCwgc28gdGVsbCB0aGUgb2xkIG9uZSB3ZSd2ZSBsZWZ0IGl0CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIlRoZSB0YXJnZXQgaGFzIGNoYW5nZWQsIHNvIHRlbGwgdGhlIG9sZCBvbmUgd2UndmUgbGVmdCBpdCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9wb2ludGVyT3V0SGFuZGxlcih0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gIEFuZCBub3cgc2V0IHRoZSBuZXcgb25lCiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QgPSB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0OwogICAgICAgICAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9wb2ludGVyT3ZlckhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGxlYXZlcyB0aGUgdGFyZ2V0IGFyZWEuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjbGVhdmUKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgbGVhdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLndpdGhpbkdhbWUgPSBmYWxzZTsKICAgICAgICB0aGlzLm1vdmUoZXZlbnQpOwoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGxlYXZlcyB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjc3RvcAogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuX3N0YXRlUmVzZXQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5vblVwLmRpc3BhdGNoKHRoaXMsIGV2ZW50KTsKCiAgICAgICAgICAgIC8vICBXYXMgaXQgYSB0YXA/CiAgICAgICAgICAgIGlmICh0aGlzLmR1cmF0aW9uID49IDAgJiYgdGhpcy5kdXJhdGlvbiA8PSB0aGlzLmdhbWUuaW5wdXQudGFwUmF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFdhcyBpdCBhIGRvdWJsZS10YXA/CiAgICAgICAgICAgICAgICBpZiAodGhpcy50aW1lVXAgLSB0aGlzLnByZXZpb3VzVGFwVGltZSA8IHRoaXMuZ2FtZS5pbnB1dC5kb3VibGVUYXBSYXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBZZXMsIGxldCdzIGRpc3BhdGNoIHRoZSBzaWduYWwgdGhlbiB3aXRoIHRoZSAybmQgcGFyYW1ldGVyIHNldCB0byB0cnVlCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uVGFwLmRpc3BhdGNoKHRoaXMsIHRydWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBXYXNuJ3QgYSBkb3VibGUtdGFwLCBzbyBkaXNwYXRjaCBhIHNpbmdsZSB0YXAgc2lnbmFsCiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uVGFwLmRpc3BhdGNoKHRoaXMsIGZhbHNlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnByZXZpb3VzVGFwVGltZSA9IHRoaXMudGltZVVwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgTW91c2UgaXMgYWx3YXlzIGFjdGl2ZQogICAgICAgIGlmICh0aGlzLmlkID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLndpdGhpbkdhbWUgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRG93biA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNVcCA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLmlzTW91c2UgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzLS07CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMudG90YWwgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMubmV4dDsKICAgICAgICAgICAgCiAgICAgICAgICAgIGRvICAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLl9yZWxlYXNlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUubmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gbnVsbCkKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9yZWxlYXNlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCgkvKioKICAgICogVGhlIFBvaW50ZXIgaXMgY29uc2lkZXJlZCBqdXN0UHJlc3NlZCBpZiB0aGUgdGltZSBpdCB3YXMgcHJlc3NlZCBvbnRvIHRoZSB0b3VjaHNjcmVlbiBvciBjbGlja2VkIGlzIGxlc3MgdGhhbiBqdXN0UHJlc3NlZFJhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbl0KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKGR1cmF0aW9uKSB7CgogICAgICAgIGR1cmF0aW9uID0gZHVyYXRpb24gfHwgdGhpcy5nYW1lLmlucHV0Lmp1c3RQcmVzc2VkUmF0ZTsKCiAgICAgICAgcmV0dXJuICh0aGlzLmlzRG93biA9PT0gdHJ1ZSAmJiAodGhpcy50aW1lRG93biArIGR1cmF0aW9uKSA+IHRoaXMuZ2FtZS50aW1lLm5vdyk7CgogICAgfSwKCgkvKioKICAgICogVGhlIFBvaW50ZXIgaXMgY29uc2lkZXJlZCBqdXN0UmVsZWFzZWQgaWYgdGhlIHRpbWUgaXQgbGVmdCB0aGUgdG91Y2hzY3JlZW4gaXMgbGVzcyB0aGFuIGp1c3RSZWxlYXNlZFJhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjanVzdFJlbGVhc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZHVyYXRpb25dCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiB8fCB0aGlzLmdhbWUuaW5wdXQuanVzdFJlbGVhc2VkUmF0ZTsKCiAgICAgICAgcmV0dXJuICh0aGlzLmlzVXAgPT09IHRydWUgJiYgKHRoaXMudGltZVVwICsgZHVyYXRpb24pID4gdGhpcy5nYW1lLnRpbWUubm93KTsKCiAgICB9LAoKCS8qKgogICAgKiBSZXNldHMgdGhlIFBvaW50ZXIgcHJvcGVydGllcy4gQ2FsbGVkIGJ5IElucHV0TWFuYWdlci5yZXNldCB3aGVuIHlvdSBwZXJmb3JtIGEgU3RhdGUgY2hhbmdlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYWN0aXZlID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlkZW50aWZpZXIgPSBudWxsOwogICAgICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc1VwID0gdHJ1ZTsKICAgICAgICB0aGlzLnRvdGFsVG91Y2hlcyA9IDA7CiAgICAgICAgdGhpcy5faG9sZFNlbnQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9oaXN0b3J5Lmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5fc3RhdGVSZXNldCA9IHRydWU7CgogICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0Ll9yZWxlYXNlZEhhbmRsZXIodGhpcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CgogICAgfSwKCgkvKioKICAgICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICoqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIlt7UG9pbnRlciAoaWQ9IiArIHRoaXMuaWQgKyAiIGlkZW50aWZlcj0iICsgdGhpcy5pZGVudGlmaWVyICsgIiBhY3RpdmU9IiArIHRoaXMuYWN0aXZlICsgIiBkdXJhdGlvbj0iICsgdGhpcy5kdXJhdGlvbiArICIgd2l0aGluR2FtZT0iICsgdGhpcy53aXRoaW5HYW1lICsgIiB4PSIgKyB0aGlzLnggKyAiIHk9IiArIHRoaXMueSArICIgY2xpZW50WD0iICsgdGhpcy5jbGllbnRYICsgIiBjbGllbnRZPSIgKyB0aGlzLmNsaWVudFkgKyAiIHNjcmVlblg9IiArIHRoaXMuc2NyZWVuWCArICIgc2NyZWVuWT0iICsgdGhpcy5zY3JlZW5ZICsgIiBwYWdlWD0iICsgdGhpcy5wYWdlWCArICIgcGFnZVk9IiArIHRoaXMucGFnZVkgKyAiKX1dIjsKICAgIH0KCn07CgovKioKKiBIb3cgbG9uZyB0aGUgUG9pbnRlciBoYXMgYmVlbiBkZXByZXNzZWQgb24gdGhlIHRvdWNoc2NyZWVuLiBJZiBub3QgY3VycmVudGx5IGRvd24gaXQgcmV0dXJucyAtMS4KKiBAbmFtZSBQaGFzZXIuUG9pbnRlciNkdXJhdGlvbgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIEhvdyBsb25nIHRoZSBQb2ludGVyIGhhcyBiZWVuIGRlcHJlc3NlZCBvbiB0aGUgdG91Y2hzY3JlZW4uIElmIG5vdCBjdXJyZW50bHkgZG93biBpdCByZXR1cm5zIC0xLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlLCAiZHVyYXRpb24iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzVXApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lRG93bjsKCiAgICB9Cgp9KTsKCi8qKgoqIEdldHMgdGhlIFggdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQG5hbWUgUGhhc2VyLlBvaW50ZXIjd29ybGRYCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIFggdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJ3b3JsZFgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgoJCXJldHVybiB0aGlzLmdhbWUud29ybGQuY2FtZXJhLnggKyB0aGlzLng7CgogICAgfQoKfSk7CgovKioKKiBHZXRzIHRoZSBZIHZhbHVlIG9mIHRoaXMgUG9pbnRlciBpbiB3b3JsZCBjb29yZGluYXRlcyBiYXNlZCBvbiB0aGUgd29ybGQgY2FtZXJhLgoqIEBuYW1lIFBoYXNlci5Qb2ludGVyI3dvcmxkWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBZIHZhbHVlIG9mIHRoaXMgUG9pbnRlciBpbiB3b3JsZCBjb29yZGluYXRlcyBiYXNlZCBvbiB0aGUgd29ybGQgY2FtZXJhLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlLCAid29ybGRZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKCQlyZXR1cm4gdGhpcy5nYW1lLndvcmxkLmNhbWVyYS55ICsgdGhpcy55OwoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlRvdWNoIGhhbmRsZXMgdG91Y2ggZXZlbnRzIHdpdGggeW91ciBnYW1lLiBOb3RlOiBBbmRyb2lkIDIueCBvbmx5IHN1cHBvcnRzIDEgdG91Y2ggZXZlbnQgYXQgb25jZSwgbm8gbXVsdGktdG91Y2guCioKKiBAY2xhc3MgUGhhc2VyLlRvdWNoCiogQGNsYXNzZGVzYyBUaGUgVG91Y2ggY2xhc3MgaGFuZGxlcyB0b3VjaCBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZ2FtZSBhbmQgdGhlIHJlc3VsdGluZyBQb2ludGVyIG9iamVjdHMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVG91Y2ggPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCiAgICAqIFlvdSBjYW4gZGlzYWJsZSBhbGwgSW5wdXQgYnkgc2V0dGluZyBkaXNhYmxlZCA9IHRydWUuIFdoaWxlIHNldCBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjZGlzYWJsZWQKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGNhbGxiYWNrQ29udGV4dCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSB0b3VjaFN0YXJ0Q2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSB0b3VjaE1vdmVDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hNb3ZlQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gdG91Y2hFbmRDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hFbmRDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSB0b3VjaEVudGVyQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdWNoRW50ZXJDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSB0b3VjaExlYXZlQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdWNoTGVhdmVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0b3VjaENhbmNlbENhbGxiYWNrIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3VjaENhbmNlbENhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcHJldmVudERlZmF1bHQgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByZXZlbnREZWZhdWx0ID0gdHJ1ZTsKCiAgICB0aGlzLl9vblRvdWNoU3RhcnQgPSBudWxsOwogICAgdGhpcy5fb25Ub3VjaE1vdmUgPSBudWxsOwogICAgdGhpcy5fb25Ub3VjaEVuZCA9IG51bGw7CiAgICB0aGlzLl9vblRvdWNoRW50ZXIgPSBudWxsOwogICAgdGhpcy5fb25Ub3VjaExlYXZlID0gbnVsbDsKICAgIHRoaXMuX29uVG91Y2hDYW5jZWwgPSBudWxsOwogICAgdGhpcy5fb25Ub3VjaE1vdmUgPSBudWxsOwoKfTsKClBoYXNlci5Ub3VjaC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFN0YXJ0cyB0aGUgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UudG91Y2gpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vblRvdWNoU3RhcnQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoU3RhcnQoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaE1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoTW92ZShldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoRW5kID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaEVuZChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoRW50ZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoRW50ZXIoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaExlYXZlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMub25Ub3VjaExlYXZlKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hDYW5jZWwgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoQ2FuY2VsKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLl9vblRvdWNoU3RhcnQsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5fb25Ub3VjaE1vdmUsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLl9vblRvdWNoRW5kLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW50ZXInLCB0aGlzLl9vblRvdWNoRW50ZXIsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hsZWF2ZScsIHRoaXMuX29uVG91Y2hMZWF2ZSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRoaXMuX29uVG91Y2hDYW5jZWwsIGZhbHNlKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ29uc3VtZXMgYWxsIHRvdWNobW92ZSBldmVudHMgb24gdGhlIGRvY3VtZW50IChvbmx5IGVuYWJsZSB0aGlzIGlmIHlvdSBrbm93IHlvdSBuZWVkIGl0ISkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI2NvbnN1bWVUb3VjaE1vdmUKICAgICovCiAgICBjb25zdW1lRG9jdW1lbnRUb3VjaGVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2RvY3VtZW50VG91Y2hNb3ZlID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfTsKCiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5fZG9jdW1lbnRUb3VjaE1vdmUsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaFN0YXJ0CiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKi8KICAgIG9uVG91Y2hTdGFydDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoU3RhcnRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hTdGFydENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIC8vICBldmVudC50YXJnZXRUb3VjaGVzID0gbGlzdCBvZiBhbGwgdG91Y2hlcyBvbiB0aGUgVEFSR0VUIEVMRU1FTlQgKGkuZS4gZ2FtZSBkb20gZWxlbWVudCkKICAgICAgICAvLyAgZXZlbnQudG91Y2hlcyA9IGxpc3Qgb2YgYWxsIHRvdWNoZXMgb24gdGhlIEVOVElSRSBET0NVTUVOVCwgbm90IGp1c3QgdGhlIHRhcmdldCBlbGVtZW50CiAgICAgICAgLy8gIGV2ZW50LmNoYW5nZWRUb3VjaGVzID0gdGhlIHRvdWNoZXMgdGhhdCBDSEFOR0VEIGluIHRoaXMgZXZlbnQsIG5vdCB0aGUgdG90YWwgbnVtYmVyIG9mIHRoZW0KICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnN0YXJ0UG9pbnRlcihldmVudC5jaGFuZ2VkVG91Y2hlc1tpXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRvdWNoIGNhbmNlbCAtIHRvdWNoZXMgdGhhdCB3ZXJlIGRpc3J1cHRlZCAocGVyaGFwcyBieSBtb3ZpbmcgaW50byBhIHBsdWdpbiBvciBicm93c2VyIGNocm9tZSkuCiAgICAqIE9jY3VycyBmb3IgZXhhbXBsZSBvbiBpT1Mgd2hlbiB5b3UgcHV0IGRvd24gNCBmaW5nZXJzIGFuZCB0aGUgYXBwIHNlbGVjdG9yIFVJIGFwcGVhcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hDYW5jZWwKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgb25Ub3VjaENhbmNlbDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIFRvdWNoIGNhbmNlbCAtIHRvdWNoZXMgdGhhdCB3ZXJlIGRpc3J1cHRlZCAocGVyaGFwcyBieSBtb3ZpbmcgaW50byBhIHBsdWdpbiBvciBicm93c2VyIGNocm9tZSkKICAgICAgICAvLyAgaHR0cDovL3d3dy53My5vcmcvVFIvdG91Y2gtZXZlbnRzLyNkZm4tdG91Y2hjYW5jZWwKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnN0b3BQb2ludGVyKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2ldKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRm9yIHRvdWNoIGVudGVyIGFuZCBsZWF2ZSBpdHMgYSBsaXN0IG9mIHRoZSB0b3VjaCBwb2ludHMgdGhhdCBoYXZlIGVudGVyZWQgb3IgbGVmdCB0aGUgdGFyZ2V0LgogICAgKiBEb2Vzbid0IGFwcGVhciB0byBiZSBzdXBwb3J0ZWQgYnkgbW9zdCBicm93c2VycyBvbiBhIGNhbnZhcyBlbGVtZW50IHlldC4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaEVudGVyCiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKi8KICAgIG9uVG91Y2hFbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoRW50ZXJDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hFbnRlckNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCd0b3VjaCBlbnRlcicpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBGb3IgdG91Y2ggZW50ZXIgYW5kIGxlYXZlIGl0cyBhIGxpc3Qgb2YgdGhlIHRvdWNoIHBvaW50cyB0aGF0IGhhdmUgZW50ZXJlZCBvciBsZWZ0IHRoZSB0YXJnZXQuCiAgICAqIERvZXNuJ3QgYXBwZWFyIHRvIGJlIHN1cHBvcnRlZCBieSBtb3N0IGJyb3dzZXJzIG9uIGEgY2FudmFzIGVsZW1lbnQgeWV0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoTGVhdmUKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLyAgICAKICAgIG9uVG91Y2hMZWF2ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoTGVhdmVDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hMZWF2ZUNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnByZXZlbnREZWZhdWx0KQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCd0b3VjaCBsZWF2ZScpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaE1vdmUKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgb25Ub3VjaE1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy50b3VjaE1vdmVDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hNb3ZlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC51cGRhdGVQb2ludGVyKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2ldKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hFbmQKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgb25Ub3VjaEVuZDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoRW5kQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnRvdWNoRW5kQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIEZvciB0b3VjaCBlbmQgaXRzIGEgbGlzdCBvZiB0aGUgdG91Y2ggcG9pbnRzIHRoYXQgaGF2ZSBiZWVuIHJlbW92ZWQgZnJvbSB0aGUgc3VyZmFjZQogICAgICAgIC8vICBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL0RPTS9Ub3VjaExpc3QKICAgICAgICAvLyAgZXZlbnQuY2hhbmdlZFRvdWNoZXMgPSB0aGUgdG91Y2hlcyB0aGF0IENIQU5HRUQgaW4gdGhpcyBldmVudCwgbm90IHRoZSB0b3RhbCBudW1iZXIgb2YgdGhlbQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLnRvdWNoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgdGhpcy5fb25Ub3VjaFN0YXJ0KTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9vblRvdWNoTW92ZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLCB0aGlzLl9vblRvdWNoRW5kKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVudGVyJywgdGhpcy5fb25Ub3VjaEVudGVyKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGxlYXZlJywgdGhpcy5fb25Ub3VjaExlYXZlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGNhbmNlbCcsIHRoaXMuX29uVG91Y2hDYW5jZWwpOwogICAgICAgIH0KCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDb25zdHJ1Y3RvciBmb3IgUGhhc2VyIElucHV0SGFuZGxlci4KKiBAY2xhc3MgUGhhc2VyLklucHV0SGFuZGxlcgoqIEBjbGFzc2Rlc2MgRGVzY3JpcHRpb24uCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBnYW1lIC0gRGVzY3JpcHRpb24uCiovClBoYXNlci5JbnB1dEhhbmRsZXIgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gRGVzY3JpcHRpb24uIAoJKi8KCXRoaXMuc3ByaXRlID0gc3ByaXRlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAogICAgKi8KICAgIHRoaXMuZ2FtZSA9IHNwcml0ZS5nYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGVuYWJsZWQgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgogICAgLy8JTGlua2VkIGxpc3QgcmVmZXJlbmNlcwoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHBhcmVudCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBuZXh0IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubmV4dCA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBwcmV2IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucHJldiA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBsYXN0IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubGFzdCA9IHRoaXM7CgkKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBmaXJzdCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCgl0aGlzLmZpcnN0ID0gdGhpczsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHByaW9yaXR5SUQgLSBUaGUgUHJpb3JpdHlJRCBjb250cm9scyB3aGljaCBTcHJpdGUgcmVjZWl2ZXMgYW4gSW5wdXQgZXZlbnQgZmlyc3QgaWYgdGhleSBzaG91bGQgb3ZlcmxhcC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnByaW9yaXR5SUQgPSAwOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB1c2VIYW5kQ3Vyc29yIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudXNlSGFuZEN1cnNvciA9IGZhbHNlOwoJCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc0RyYWdnZWQgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5pc0RyYWdnZWQgPSBmYWxzZTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxsb3dIb3Jpem9udGFsRHJhZyAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFsbG93SG9yaXpvbnRhbERyYWcgPSB0cnVlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1ZlcnRpY2FsRHJhZyAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFsbG93VmVydGljYWxEcmFnID0gdHJ1ZTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYnJpbmdUb1RvcCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmJyaW5nVG9Ub3AgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gc25hcE9mZnNldCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnNuYXBPZmZzZXQgPSBudWxsOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBzbmFwT25EcmFnIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc25hcE9uRHJhZyA9IGZhbHNlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBzbmFwT25SZWxlYXNlIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc25hcE9uUmVsZWFzZSA9IGZhbHNlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNuYXBYIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc25hcFggPSAwOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNuYXBZIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc25hcFkgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcGl4ZWxQZXJmZWN0IC0gU2hvdWxkIHdlIHVzZSBwaXhlbCBwZXJmZWN0IGhpdCBkZXRlY3Rpb24/IFdhcm5pbmc6IGV4cGVuc2l2ZS4gT25seSBlbmFibGUgaWYgeW91IHJlYWxseSBuZWVkIGl0IQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucGl4ZWxQZXJmZWN0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwaXhlbFBlcmZlY3RBbHBoYSAtIFRoZSBhbHBoYSB0b2xlcmFuY2UgdGhyZXNob2xkLiBJZiB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIHBpeGVsIG1hdGNoZXMgb3IgaXMgYWJvdmUgdGhpcyB2YWx1ZSwgaXQncyBjb25zaWRlcmVkIGEgaGl0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGl4ZWxQZXJmZWN0QWxwaGEgPSAyNTU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZHJhZ2dhYmxlIC0gSXMgdGhpcyBzcHJpdGUgYWxsb3dlZCB0byBiZSBkcmFnZ2VkIGJ5IHRoZSBtb3VzZT8gdHJ1ZSA9IHllcywgZmFsc2UgPSBubwogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLmRyYWdnYWJsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBib3VuZHNSZWN0IC0gQSByZWdpb24gb2YgdGhlIGdhbWUgd29ybGQgd2l0aGluIHdoaWNoIHRoZSBzcHJpdGUgaXMgcmVzdHJpY3RlZCBkdXJpbmcgZHJhZy4KICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgdGhpcy5ib3VuZHNSZWN0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gYm91bmRzU3ByaXRlIC0gQSBTcHJpdGUgdGhlIGJvdW5kcyBvZiB3aGljaCB0aGlzIHNwcml0ZSBpcyByZXN0cmljdGVkIGR1cmluZyBkcmFnLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYm91bmRzU3ByaXRlID0gbnVsbDsKCiAgICAvKioKICAgICogSWYgdGhpcyBvYmplY3QgaXMgc2V0IHRvIGNvbnN1bWUgdGhlIHBvaW50ZXIgZXZlbnQgdGhlbiBpdCB3aWxsIHN0b3AgYWxsIHByb3BvZ2F0aW9uIGZyb20gdGhpcyBvYmplY3Qgb24uCiAgICAqIEZvciBleGFtcGxlIGlmIHlvdSBoYWQgYSBzdGFjayBvZiA2IHNwcml0ZXMgd2l0aCB0aGUgc2FtZSBwcmlvcml0eSBJRHMgYW5kIG9uZSBjb25zdW1lZCB0aGUgZXZlbnQsIG5vbmUgb2YgdGhlIG90aGVycyB3b3VsZCByZWNlaXZlIGl0LgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbnN1bWVQb2ludGVyRXZlbnQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbnN1bWVQb2ludGVyRXZlbnQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IF90ZW1wUG9pbnQgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90ZW1wUG9pbnQgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIHRoaXMuX3BvaW50ZXJEYXRhID0gW107CgogICAgdGhpcy5fcG9pbnRlckRhdGEucHVzaCh7CiAgICAgICAgaWQ6IDAsCiAgICAgICAgeDogMCwKICAgICAgICB5OiAwLAogICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgaXNVcDogZmFsc2UsCiAgICAgICAgaXNPdmVyOiBmYWxzZSwKICAgICAgICBpc091dDogZmFsc2UsCiAgICAgICAgdGltZU92ZXI6IDAsCiAgICAgICAgdGltZU91dDogMCwKICAgICAgICB0aW1lRG93bjogMCwKICAgICAgICB0aW1lVXA6IDAsCiAgICAgICAgZG93bkR1cmF0aW9uOiAwLAogICAgICAgIGlzRHJhZ2dlZDogZmFsc2UKICAgIH0pOwoKfTsKClBoYXNlci5JbnB1dEhhbmRsZXIucHJvdG90eXBlID0gewoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3N0YXJ0CgkqIEBwYXJhbSB7bnVtYmVyfSBwcmlvcml0eSAtIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge2Jvb2xlYW59IHVzZUhhbmRDdXJzb3IgLSBEZXNjcmlwdGlvbi4KCSogQHJldHVybiB7UGhhc2VyLlNwcml0ZX0gRGVzY3JpcHRpb24uCgkqLwoJc3RhcnQ6IGZ1bmN0aW9uIChwcmlvcml0eSwgdXNlSGFuZEN1cnNvcikgewoKCQlwcmlvcml0eSA9IHByaW9yaXR5IHx8IDA7CgkJaWYgKHR5cGVvZiB1c2VIYW5kQ3Vyc29yID09ICd1bmRlZmluZWQnKSB7IHVzZUhhbmRDdXJzb3IgPSBmYWxzZTsgfQoKICAgICAgICAvLyAgVHVybmluZyBvbgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUmVnaXN0ZXIsIGV0YwoJCQl0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5hZGQodGhpcyk7CiAgICAgICAgICAgIHRoaXMudXNlSGFuZEN1cnNvciA9IHVzZUhhbmRDdXJzb3I7CiAgICAgICAgICAgIHRoaXMucHJpb3JpdHlJRCA9IHByaW9yaXR5OwoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtpXSA9IHsKICAgICAgICAgICAgICAgICAgICBpZDogaSwKICAgICAgICAgICAgICAgICAgICB4OiAwLAogICAgICAgICAgICAgICAgICAgIHk6IDAsCiAgICAgICAgICAgICAgICAgICAgaXNEb3duOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBpc1VwOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBpc092ZXI6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzT3V0OiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICB0aW1lT3ZlcjogMCwKICAgICAgICAgICAgICAgICAgICB0aW1lT3V0OiAwLAogICAgICAgICAgICAgICAgICAgIHRpbWVEb3duOiAwLAogICAgICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgICAgICBkb3duRHVyYXRpb246IDAsCiAgICAgICAgICAgICAgICAgICAgaXNEcmFnZ2VkOiBmYWxzZQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zbmFwT2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludDsKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKCiAgICAgICAgICAgIC8vICBDcmVhdGUgdGhlIHNpZ25hbHMgdGhlIElucHV0IGNvbXBvbmVudCB3aWxsIGVtaXQKICAgICAgICAgICAgaWYgKHRoaXMuc3ByaXRlLmV2ZW50cyAmJiB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE92ZXIgPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdmVyID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE91dCA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXREb3duID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dFVwID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RhcnQgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdG9wID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLnNwcml0ZTsKCgl9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3Jlc2V0CgkqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldID0gewogICAgICAgICAgICAgICAgaWQ6IGksCiAgICAgICAgICAgICAgICB4OiAwLAogICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgICAgICAgICBpc1VwOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzT3ZlcjogZmFsc2UsCiAgICAgICAgICAgICAgICBpc091dDogZmFsc2UsCiAgICAgICAgICAgICAgICB0aW1lT3ZlcjogMCwKICAgICAgICAgICAgICAgIHRpbWVPdXQ6IDAsCiAgICAgICAgICAgICAgICB0aW1lRG93bjogMCwKICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgIGRvd25EdXJhdGlvbjogMCwKICAgICAgICAgICAgICAgIGlzRHJhZ2dlZDogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICB9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3N0b3AKCSovCglzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBUdXJuaW5nIG9mZgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBEZS1yZWdpc3RlciwgZXRjCiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwoJCQl0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5yZW1vdmUodGhpcyk7CiAgICAgICAgfQoKCX0sCgoJLyoqCgkqIENsZWFuIHVwIG1lbW9yeS4KCSogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rlc3Ryb3kKCSovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLnJlbW92ZSh0aGlzKTsKCiAgICAgICAgCXRoaXMuc3RvcCgpOwoKICAgICAgICAJdGhpcy5zcHJpdGUgPSBudWxsOwogICAgICAgIH0KICAgIH0sCgoJLyoqCiAgICAqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIElucHV0IHBvaW50ZXIsIHJlbGF0aXZlIHRvIHRoZSB0b3AtbGVmdCBvZiB0aGUgcGFyZW50IFNwcml0ZS4KICAgICogVGhpcyB2YWx1ZSBpcyBvbmx5IHNldCB3aGVuIHRoZSBwb2ludGVyIGlzIG92ZXIgdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyWAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLgogICAgKi8gICAgCiAgICBwb2ludGVyWDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLng7CgogICAgfSwKCgkvKioKICAgICogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgSW5wdXQgcG9pbnRlciwgcmVsYXRpdmUgdG8gdGhlIHRvcC1sZWZ0IG9mIHRoZSBwYXJlbnQgU3ByaXRlCiAgICAqIFRoaXMgdmFsdWUgaXMgb25seSBzZXQgd2hlbiB0aGUgcG9pbnRlciBpcyBvdmVyIHRoaXMgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclkKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgSW5wdXQgcG9pbnRlci4KICAgICovCiAgICBwb2ludGVyWTogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnk7CgogICAgfSwKCgkvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgdG91Y2hpbmcgdGhlIHRvdWNoc2NyZWVuLCBvciB0aGUgbW91c2UgYnV0dG9uIGlzIGhlbGQgZG93biwgaXNEb3duIGlzIHNldCB0byB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlckRvd24KICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgcG9pbnRlckRvd246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0Rvd247CgogICAgfSwKCgkvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgbm90IHRvdWNoaW5nIHRoZSB0b3VjaHNjcmVlbiwgb3IgdGhlIG1vdXNlIGJ1dHRvbiBpcyB1cCwgaXNVcCBpcyBzZXQgdG8gdHJ1ZQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclVwCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHBvaW50ZXJVcDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzVXA7CgogICAgfSwKCgkvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgZmlyc3QgdG91Y2hlZCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZURvd24KICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZURvd246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lRG93bjsKCiAgICB9LAoKCS8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBsZWZ0IHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lVXAKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZVVwOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZVVwOwoKICAgIH0sCgoJLyoqCiAgICAqIElzIHRoZSBQb2ludGVyIG92ZXIgdGhpcyBTcHJpdGU/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyT3ZlcgogICAgKiBAcGFyYW0ge251bWJlcn0gW2luZGV4XSAtIFRoZSBJRCBudW1iZXIgb2YgYSBQb2ludGVyIHRvIGNoZWNrLiBJZiB5b3UgZG9uJ3QgcHJvdmlkZSBhIG51bWJlciBpdCB3aWxsIGNoZWNrIGFsbCBQb2ludGVycy4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gcG9pbnRlciAoaWYgYSBpbmRleCB3YXMgZ2l2ZW4sIG9yIGFueSBwb2ludGVyIGlmIG5vdCkgaXMgb3ZlciB0aGlzIG9iamVjdC4KICAgICovCiAgICBwb2ludGVyT3ZlcjogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGluZGV4ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtpXS5pc092ZXIpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbaW5kZXhdLmlzT3ZlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCiAgICAqIElzIHRoZSBQb2ludGVyIG91dHNpZGUgb2YgdGhpcyBTcHJpdGU/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyT3V0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaW5kZXhdIC0gVGhlIElEIG51bWJlciBvZiBhIFBvaW50ZXIgdG8gY2hlY2suIElmIHlvdSBkb24ndCBwcm92aWRlIGEgbnVtYmVyIGl0IHdpbGwgY2hlY2sgYWxsIFBvaW50ZXJzLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwb2ludGVyIChpZiBhIGluZGV4IHdhcyBnaXZlbiwgb3IgYW55IHBvaW50ZXIgaWYgbm90KSBpcyBvdXQgb2YgdGhpcyBvYmplY3QuCiAgICAqLwogICAgcG9pbnRlck91dDogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW2ldLmlzT3V0KQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW2luZGV4XS5pc091dDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGZpcnN0IHRvdWNoZWQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclRpbWVPdmVyCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlclRpbWVPdmVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU92ZXI7CgogICAgfSwKCgkvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgbGVmdCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU91dAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJUaW1lT3V0OiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU91dDsKCiAgICB9LAoKCS8qKgogICAgKiBJcyB0aGlzIHNwcml0ZSBiZWluZyBkcmFnZ2VkIGJ5IHRoZSBtb3VzZSBvciBub3Q/CiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU91dAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJEcmFnZ2VkOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNEcmFnZ2VkOwoKICAgIH0sCgoJLyoqCiAgICAqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gcG9pbnRlciBpcyBvdmVyIHRoaXMgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tQb2ludGVyT3ZlcgogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBjaGVja1BvaW50ZXJPdmVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkICYmIHRoaXMuc3ByaXRlLnZpc2libGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5nZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbih0aGlzLl90ZW1wUG9pbnQsIHBvaW50ZXIueCwgcG9pbnRlci55KTsKCiAgICAgICAgICAgIGlmICh0aGlzLl90ZW1wUG9pbnQueCA+PSAwICYmIHRoaXMuX3RlbXBQb2ludC54IDw9IHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZS53aWR0aCAmJiB0aGlzLl90ZW1wUG9pbnQueSA+PSAwICYmIHRoaXMuX3RlbXBQb2ludC55IDw9IHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZS5oZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnBpeGVsUGVyZmVjdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5jaGVja1BpeGVsKHRoaXMuX3RlbXBQb2ludC54LCB0aGlzLl90ZW1wUG9pbnQueSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKCS8qKgogICAgKiBSdW5zIGEgcGl4ZWwgcGVyZmVjdCBjaGVjayBhZ2FpbnN0IHRoZSBnaXZlbiB4L3kgY29vcmRpbmF0ZXMgb2YgdGhlIFNwcml0ZSB0aGlzIElucHV0SGFuZGxlciBpcyBib3VuZCB0by4KICAgICogSXQgY29tcGFyZXMgdGhlIGFscGhhIHZhbHVlIG9mIHRoZSBwaXhlbCBhbmQgaWYgPj0gSW5wdXRIYW5kbGVyLnBpeGVsUGVyZmVjdEFscGhhIGl0IHJldHVybnMgdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2NoZWNrUGl4ZWwKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGNoZWNrLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gY2hlY2suCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IHRydWUgaWYgdGhlcmUgaXMgdGhlIGFscGhhIG9mIHRoZSBwaXhlbCBpcyA+PSBJbnB1dEhhbmRsZXIucGl4ZWxQZXJmZWN0QWxwaGEKICAgICovCiAgICBjaGVja1BpeGVsOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICAvLyAgR3JhYiBhIHBpeGVsIGZyb20gb3VyIGltYWdlIGludG8gdGhlIGhpdENhbnZhcyBhbmQgdGhlbiB0ZXN0IGl0CiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmhpdENvbnRleHQuY2xlYXJSZWN0KDAsIDAsIDEsIDEpOwoKICAgICAgICAgICAgeCArPSB0aGlzLnNwcml0ZS50ZXh0dXJlLmZyYW1lLng7CiAgICAgICAgICAgIHkgKz0gdGhpcy5zcHJpdGUudGV4dHVyZS5mcmFtZS55OwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmhpdENvbnRleHQuZHJhd0ltYWdlKHRoaXMuc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCB4LCB5LCAxLCAxLCAwLCAwLCAxLCAxKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhciByZ2IgPSB0aGlzLmdhbWUuaW5wdXQuaGl0Q29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgMSwgMSk7CgogICAgICAgICAgICBpZiAocmdiLmRhdGFbM10gPj0gdGhpcy5waXhlbFBlcmZlY3RBbHBoYSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKCS8qKgogICAgKiBVcGRhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciN1cGRhdGUKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkID09IGZhbHNlIHx8IHRoaXMuc3ByaXRlLnZpc2libGUgPT0gZmFsc2UgfHwgKHRoaXMuc3ByaXRlLmdyb3VwICYmIHRoaXMuc3ByaXRlLmdyb3VwLnZpc2libGUgPT0gZmFsc2UpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlck91dEhhbmRsZXIocG9pbnRlcik7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmRyYWdnYWJsZSAmJiB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID09IHBvaW50ZXIuaWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy51cGRhdGVEcmFnKHBvaW50ZXIpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc092ZXIgPT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUG9pbnRlck92ZXIocG9pbnRlcikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnggPSBwb2ludGVyLnggLSB0aGlzLnNwcml0ZS54OwogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueSA9IHBvaW50ZXIueSAtIHRoaXMuc3ByaXRlLnk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJPdXRIYW5kbGVyKHBvaW50ZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCgkvKioKICAgICAqIERlc2NyaXB0aW9uLgogICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI19wb2ludGVyT3ZlckhhbmRsZXIKICAgICAqIEBwcml2YXRlCiAgICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICAqLwogICAgX3BvaW50ZXJPdmVySGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3V0ID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVPdmVyID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS54ID0gcG9pbnRlci54IC0gdGhpcy5zcHJpdGUueDsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueSA9IHBvaW50ZXIueSAtIHRoaXMuc3ByaXRlLnk7CgogICAgICAgICAgICBpZiAodGhpcy51c2VIYW5kQ3Vyc29yICYmIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAicG9pbnRlciI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3Zlci5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CiAgICAgICAgfQogICAgfSwKCgkvKioKICAgICAqIERlc2NyaXB0aW9uLgogICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI19wb2ludGVyT3V0SGFuZGxlcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgICovCiAgICBfcG9pbnRlck91dEhhbmRsZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9IGZhbHNlOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3V0ID0gdHJ1ZTsKICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lT3V0ID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgICAgICBpZiAodGhpcy51c2VIYW5kQ3Vyc29yICYmIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRHJhZ2dlZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlICYmIHRoaXMuc3ByaXRlLmV2ZW50cykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3V0LmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICAqIERlc2NyaXB0aW9uLgogICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI190b3VjaGVkSGFuZGxlcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgICovCiAgICBfdG91Y2hlZEhhbmRsZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gPT0gZmFsc2UgJiYgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc1VwID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVEb3duID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dERvd24uZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwoKICAgICAgICAgICAgLy8gIFN0YXJ0IGRyYWcKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuaXNEcmFnZ2VkID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0RHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuYnJpbmdUb1RvcCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuYnJpbmdUb1RvcCgpOwoJCQl9CiAgICAgICAgfQoKICAgICAgICAvLyAgQ29uc3VtZSB0aGUgZXZlbnQ/CiAgICAgICAgcmV0dXJuIHRoaXMuY29uc3VtZVBvaW50ZXJFdmVudDsKCiAgICB9LAoKCS8qKgogICAgICogRGVzY3JpcHRpb24uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3JlbGVhc2VkSGFuZGxlcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgICovCiAgICBfcmVsZWFzZWRIYW5kbGVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICAvLyAgSWYgd2FzIHByZXZpb3VzbHkgdG91Y2hlZCBieSB0aGlzIFBvaW50ZXIsIGNoZWNrIGlmIHN0aWxsIGlzIEFORCBzdGlsbCBvdmVyIHRoaXMgaXRlbQogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gJiYgcG9pbnRlci5pc1VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEb3duID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzVXAgPSB0cnVlOwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS50aW1lVXAgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmRvd25EdXJhdGlvbiA9IHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVVcCAtIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVEb3duOwoKICAgICAgICAgICAgLy8gIE9ubHkgcmVsZWFzZSB0aGUgSW5wdXRVcCBzaWduYWwgaWYgdGhlIHBvaW50ZXIgaXMgc3RpbGwgb3ZlciB0aGlzIHNwcml0ZQogICAgICAgICAgICBpZiAodGhpcy5jaGVja1BvaW50ZXJPdmVyKHBvaW50ZXIpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdyZWxlYXNlZEhhbmRsZXI6ICcgKyBEYXRlLm5vdygpKTsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0VXAuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFBvaW50ZXIgb3V0c2lkZSB0aGUgc3ByaXRlPyBSZXNldCB0aGUgY3Vyc29yCiAgICAgICAgICAgICAgICBpZiAodGhpcy51c2VIYW5kQ3Vyc29yKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGUuY3Vyc29yID0gImRlZmF1bHQiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgU3RvcCBkcmFnCiAgICAgICAgICAgIGlmICh0aGlzLmRyYWdnYWJsZSAmJiB0aGlzLmlzRHJhZ2dlZCAmJiB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID09IHBvaW50ZXIuaWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcERyYWcocG9pbnRlcik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogVXBkYXRlcyB0aGUgUG9pbnRlciBkcmFnIG9uIHRoaXMgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjdXBkYXRlRHJhZwogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICB1cGRhdGVEcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAocG9pbnRlci5pc1VwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zdG9wRHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYWxsb3dIb3Jpem9udGFsRHJhZykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSBwb2ludGVyLnggKyB0aGlzLl9kcmFnUG9pbnQueCArIHRoaXMuZHJhZ09mZnNldC54OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gcG9pbnRlci55ICsgdGhpcy5fZHJhZ1BvaW50LnkgKyB0aGlzLmRyYWdPZmZzZXQueTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmJvdW5kc1JlY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzUmVjdCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYm91bmRzU3ByaXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kc1Nwcml0ZSgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc25hcE9uRHJhZykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSBNYXRoLnJvdW5kKHRoaXMuc3ByaXRlLnggLyB0aGlzLnNuYXBYKSAqIHRoaXMuc25hcFg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBNYXRoLnJvdW5kKHRoaXMuc3ByaXRlLnkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICB9LAoKCS8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGVudGVyZWQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RPdmVyCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3Zlci4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0T3ZlcjogZnVuY3Rpb24gKHBvaW50ZXIsIGRlbGF5KSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CiAgICAJZGVsYXkgPSBkZWxheSB8fCA1MDA7CgogICAgICAgIHJldHVybiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNPdmVyICYmIHRoaXMub3ZlckR1cmF0aW9uKHBvaW50ZXIpIDwgZGVsYXkpOwoKICAgIH0sCgoJLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcG9pbnRlciBoYXMgbGVmdCB0aGUgU3ByaXRlIHdpdGhpbiB0aGUgc3BlY2lmaWVkIGRlbGF5IHRpbWUgKGRlZmF1bHRzIHRvIDUwMG1zLCBoYWxmIGEgc2Vjb25kKQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjanVzdE91dAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG91dC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0T3V0OiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgIAlkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc091dCAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU91dCA8IGRlbGF5KSk7CgogICAgfSwKCgkvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBlbnRlcmVkIHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG92ZXIuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAganVzdFByZXNzZWQ6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgCWRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRG93biAmJiB0aGlzLmRvd25EdXJhdGlvbihwb2ludGVyKSA8IGRlbGF5KTsKCiAgICB9LAoKCS8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGxlZnQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RSZWxlYXNlZAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmVsb3cgd2hpY2ggdGhlIHBvaW50ZXIgaXMgY29uc2lkZXJlZCBhcyBqdXN0IG91dC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgCWRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzVXAgJiYgKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVVcCA8IGRlbGF5KSk7CgogICAgfSwKCgkvKioKICAgICogSWYgdGhlIHBvaW50ZXIgaXMgY3VycmVudGx5IG92ZXIgdGhpcyBTcHJpdGUgdGhpcyByZXR1cm5zIGhvdyBsb25nIGl0IGhhcyBiZWVuIHRoZXJlIGZvciBpbiBtaWxsaXNlY29uZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNvdmVyRHVyYXRpb24KICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhlIHBvaW50ZXIgaGFzIGJlZW4gb3ZlciB0aGUgU3ByaXRlLCBvciAtMSBpZiBub3Qgb3Zlci4KICAgICovCiAgICBvdmVyRHVyYXRpb246IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIGlmICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc092ZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZU92ZXI7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gLTE7CgogICAgfSwKCgkvKioKICAgICogSWYgdGhlIHBvaW50ZXIgaXMgY3VycmVudGx5IG92ZXIgdGhpcyBTcHJpdGUgdGhpcyByZXR1cm5zIGhvdyBsb25nIGl0IGhhcyBiZWVuIHRoZXJlIGZvciBpbiBtaWxsaXNlY29uZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNkb3duRHVyYXRpb24KICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhlIHBvaW50ZXIgaGFzIGJlZW4gcHJlc3NlZCBkb3duIG9uIHRoZSBTcHJpdGUsIG9yIC0xIGlmIG5vdCBvdmVyLgogICAgKi8KICAgIGRvd25EdXJhdGlvbjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRG93bikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lRG93bjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAtMTsKCiAgICB9LAoKCS8qKgogICAgKiBNYWtlIHRoaXMgU3ByaXRlIGRyYWdnYWJsZSBieSB0aGUgbW91c2UuIFlvdSBjYW4gYWxzbyBvcHRpb25hbGx5IHNldCBtb3VzZVN0YXJ0RHJhZ0NhbGxiYWNrIGFuZCBtb3VzZVN0b3BEcmFnQ2FsbGJhY2sKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2VuYWJsZURyYWcKICAgICogQHBhcmFtCWxvY2tDZW50ZXIJCQlJZiBmYWxzZSB0aGUgU3ByaXRlIHdpbGwgZHJhZyBmcm9tIHdoZXJlIHlvdSBjbGljayBpdCBtaW51cyB0aGUgZHJhZ09mZnNldC4gSWYgdHJ1ZSBpdCB3aWxsIGNlbnRlciBpdHNlbGYgdG8gdGhlIHRpcCBvZiB0aGUgbW91c2UgcG9pbnRlci4KICAgICogQHBhcmFtCWJyaW5nVG9Ub3AJCQlJZiB0cnVlIHRoZSBTcHJpdGUgd2lsbCBiZSBib3VnaHQgdG8gdGhlIHRvcCBvZiB0aGUgcmVuZGVyaW5nIGxpc3QgaW4gaXRzIGN1cnJlbnQgR3JvdXAuCiAgICAqIEBwYXJhbQlwaXhlbFBlcmZlY3QJCUlmIHRydWUgaXQgd2lsbCB1c2UgYSBwaXhlbCBwZXJmZWN0IHRlc3QgdG8gc2VlIGlmIHlvdSBjbGlja2VkIHRoZSBTcHJpdGUuIEZhbHNlIHVzZXMgdGhlIGJvdW5kaW5nIGJveC4KICAgICogQHBhcmFtCWFscGhhVGhyZXNob2xkCQlJZiB1c2luZyBwaXhlbCBwZXJmZWN0IGNvbGxpc2lvbiB0aGlzIHNwZWNpZmllcyB0aGUgYWxwaGEgbGV2ZWwgZnJvbSAwIHRvIDI1NSBhYm92ZSB3aGljaCBhIGNvbGxpc2lvbiBpcyBwcm9jZXNzZWQgKGRlZmF1bHQgMjU1KQogICAgKiBAcGFyYW0JYm91bmRzUmVjdAkJCUlmIHlvdSB3YW50IHRvIHJlc3RyaWN0IHRoZSBkcmFnIG9mIHRoaXMgc3ByaXRlIHRvIGEgc3BlY2lmaWMgRmx4UmVjdCwgcGFzcyB0aGUgRmx4UmVjdCBoZXJlLCBvdGhlcndpc2UgaXQncyBmcmVlIHRvIGRyYWcgYW55d2hlcmUKICAgICogQHBhcmFtCWJvdW5kc1Nwcml0ZQkJSWYgeW91IHdhbnQgdG8gcmVzdHJpY3QgdGhlIGRyYWcgb2YgdGhpcyBzcHJpdGUgdG8gd2l0aGluIHRoZSBib3VuZGluZyBib3ggb2YgYW5vdGhlciBzcHJpdGUsIHBhc3MgaXQgaGVyZQogICAgKi8KICAgIGVuYWJsZURyYWc6IGZ1bmN0aW9uIChsb2NrQ2VudGVyLCBicmluZ1RvVG9wLCBwaXhlbFBlcmZlY3QsIGFscGhhVGhyZXNob2xkLCBib3VuZHNSZWN0LCBib3VuZHNTcHJpdGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsb2NrQ2VudGVyID09ICd1bmRlZmluZWQnKSB7IGxvY2tDZW50ZXIgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgYnJpbmdUb1RvcCA9PSAndW5kZWZpbmVkJykgeyBicmluZ1RvVG9wID0gZmFsc2U7IH0KICAgICAgICBpZiAodHlwZW9mIHBpeGVsUGVyZmVjdCA9PSAndW5kZWZpbmVkJykgeyBwaXhlbFBlcmZlY3QgPSBmYWxzZTsgfQoKICAgICAgICBhbHBoYVRocmVzaG9sZCA9IGFscGhhVGhyZXNob2xkIHx8IDI1NTsKICAgICAgICBib3VuZHNSZWN0ID0gYm91bmRzUmVjdCB8fCBudWxsOwogICAgICAgIGJvdW5kc1Nwcml0ZSA9IGJvdW5kc1Nwcml0ZSB8fCBudWxsOwoKICAgICAgICB0aGlzLl9kcmFnUG9pbnQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgdGhpcy5kcmFnZ2FibGUgPSB0cnVlOwogICAgICAgIHRoaXMuYnJpbmdUb1RvcCA9IGJyaW5nVG9Ub3A7CiAgICAgICAgdGhpcy5kcmFnT2Zmc2V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgICAgIHRoaXMuZHJhZ0Zyb21DZW50ZXIgPSBsb2NrQ2VudGVyOwoKICAgICAgICB0aGlzLnBpeGVsUGVyZmVjdCA9IHBpeGVsUGVyZmVjdDsKICAgICAgICB0aGlzLnBpeGVsUGVyZmVjdEFscGhhID0gYWxwaGFUaHJlc2hvbGQ7CgogICAgICAgIGlmIChib3VuZHNSZWN0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ib3VuZHNSZWN0ID0gYm91bmRzUmVjdDsKICAgICAgICB9CgogICAgICAgIGlmIChib3VuZHNTcHJpdGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJvdW5kc1Nwcml0ZSA9IGJvdW5kc1Nwcml0ZTsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogU3RvcHMgdGhpcyBzcHJpdGUgZnJvbSBiZWluZyBhYmxlIHRvIGJlIGRyYWdnZWQuIElmIGl0IGlzIGN1cnJlbnRseSB0aGUgdGFyZ2V0IG9mIGFuIGFjdGl2ZSBkcmFnIGl0IHdpbGwgYmUgc3RvcHBlZCBpbW1lZGlhdGVseS4gQWxzbyBkaXNhYmxlcyBhbnkgc2V0IGNhbGxiYWNrcy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rpc2FibGVEcmFnCiAgICAqLwogICAgZGlzYWJsZURyYWc6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtpXS5pc0RyYWdnZWQgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5kcmFnZ2FibGUgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPSAtMTsKCiAgICB9LAoKCS8qKgogICAgKiBDYWxsZWQgYnkgUG9pbnRlciB3aGVuIGRyYWcgc3RhcnRzIG9uIHRoaXMgU3ByaXRlLiBTaG91bGQgbm90IHVzdWFsbHkgYmUgY2FsbGVkIGRpcmVjdGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RhcnREcmFnCiAgICAqLwogICAgc3RhcnREcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICB0aGlzLmlzRHJhZ2dlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9IHBvaW50ZXIuaWQ7CiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMuZHJhZ0Zyb21DZW50ZXIpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5jZW50ZXJPbihwb2ludGVyLngsIHBvaW50ZXIueSk7CiAgICAgICAgICAgIHRoaXMuX2RyYWdQb2ludC5zZXRUbyh0aGlzLnNwcml0ZS54IC0gcG9pbnRlci54LCB0aGlzLnNwcml0ZS55IC0gcG9pbnRlci55KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLnggLSBwb2ludGVyLngsIHRoaXMuc3ByaXRlLnkgLSBwb2ludGVyLnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy51cGRhdGVEcmFnKHBvaW50ZXIpOwogICAgICAgIAogICAgICAgIGlmICh0aGlzLmJyaW5nVG9Ub3ApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS5icmluZ1RvVG9wKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RhcnQuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCBieSBQb2ludGVyIHdoZW4gZHJhZyBpcyBzdG9wcGVkIG9uIHRoaXMgU3ByaXRlLiBTaG91bGQgbm90IHVzdWFsbHkgYmUgY2FsbGVkIGRpcmVjdGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RvcERyYWcKICAgICovCiAgICBzdG9wRHJhZzogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgdGhpcy5pc0RyYWdnZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID0gLTE7CiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuc25hcE9uUmVsZWFzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSBNYXRoLnJvdW5kKHRoaXMuc3ByaXRlLnggLyB0aGlzLnNuYXBYKSAqIHRoaXMuc25hcFg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBNYXRoLnJvdW5kKHRoaXMuc3ByaXRlLnkgLyB0aGlzLnNuYXBZKSAqIHRoaXMuc25hcFk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25EcmFnU3RvcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CiAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgICAgIGlmICh0aGlzLmNoZWNrUG9pbnRlck92ZXIocG9pbnRlcikgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyT3V0SGFuZGxlcihwb2ludGVyKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogUmVzdHJpY3RzIHRoaXMgc3ByaXRlIHRvIGRyYWcgbW92ZW1lbnQgb25seSBvbiB0aGUgZ2l2ZW4gYXhpcy4gTm90ZTogSWYgYm90aCBhcmUgc2V0IHRvIGZhbHNlIHRoZSBzcHJpdGUgd2lsbCBuZXZlciBtb3ZlIQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc2V0RHJhZ0xvY2sKICAgICogQHBhcmFtCWFsbG93SG9yaXpvbnRhbAkJVG8gZW5hYmxlIHRoZSBzcHJpdGUgdG8gYmUgZHJhZ2dlZCBob3Jpem9udGFsbHkgc2V0IHRvIHRydWUsIG90aGVyd2lzZSBmYWxzZQogICAgKiBAcGFyYW0JYWxsb3dWZXJ0aWNhbAkJVG8gZW5hYmxlIHRoZSBzcHJpdGUgdG8gYmUgZHJhZ2dlZCB2ZXJ0aWNhbGx5IHNldCB0byB0cnVlLCBvdGhlcndpc2UgZmFsc2UKICAgICovCiAgICBzZXREcmFnTG9jazogZnVuY3Rpb24gKGFsbG93SG9yaXpvbnRhbCwgYWxsb3dWZXJ0aWNhbCkgewoKICAgICAgICBpZiAodHlwZW9mIGFsbG93SG9yaXpvbnRhbCA9PSAndW5kZWZpbmVkJykgeyBhbGxvd0hvcml6b250YWwgPSB0cnVlOyB9CiAgICAJaWYgKHR5cGVvZiBhbGxvd1ZlcnRpY2FsID09ICd1bmRlZmluZWQnKSB7IGFsbG93VmVydGljYWwgPSB0cnVlOyB9CgogICAgICAgIHRoaXMuYWxsb3dIb3Jpem9udGFsRHJhZyA9IGFsbG93SG9yaXpvbnRhbDsKICAgICAgICB0aGlzLmFsbG93VmVydGljYWxEcmFnID0gYWxsb3dWZXJ0aWNhbDsKCiAgICB9LAoKCS8qKgogICAgKiBNYWtlIHRoaXMgU3ByaXRlIHNuYXAgdG8gdGhlIGdpdmVuIGdyaWQgZWl0aGVyIGR1cmluZyBkcmFnIG9yIHdoZW4gaXQncyByZWxlYXNlZC4KICAgICogRm9yIGV4YW1wbGUgMTZ4MTYgYXMgdGhlIHNuYXBYIGFuZCBzbmFwWSB3b3VsZCBtYWtlIHRoZSBzcHJpdGUgc25hcCB0byBldmVyeSAxNiBwaXhlbHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNlbmFibGVTbmFwCiAgICAqIEBwYXJhbQlzbmFwWAkJVGhlIHdpZHRoIG9mIHRoZSBncmlkIGNlbGwgaW4gcGl4ZWxzCiAgICAqIEBwYXJhbQlzbmFwWQkJVGhlIGhlaWdodCBvZiB0aGUgZ3JpZCBjZWxsIGluIHBpeGVscwogICAgKiBAcGFyYW0Jb25EcmFnCQlJZiB0cnVlIHRoZSBzcHJpdGUgd2lsbCBzbmFwIHRvIHRoZSBncmlkIHdoaWxlIGJlaW5nIGRyYWdnZWQKICAgICogQHBhcmFtCW9uUmVsZWFzZQlJZiB0cnVlIHRoZSBzcHJpdGUgd2lsbCBzbmFwIHRvIHRoZSBncmlkIHdoZW4gcmVsZWFzZWQKICAgICovCiAgICBlbmFibGVTbmFwOiBmdW5jdGlvbiAoc25hcFgsIHNuYXBZLCBvbkRyYWcsIG9uUmVsZWFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIG9uRHJhZyA9PSAndW5kZWZpbmVkJykgeyBvbkRyYWcgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvblJlbGVhc2UgPT0gJ3VuZGVmaW5lZCcpIHsgb25SZWxlYXNlID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5zbmFwWCA9IHNuYXBYOwogICAgICAgIHRoaXMuc25hcFkgPSBzbmFwWTsKICAgICAgICB0aGlzLnNuYXBPbkRyYWcgPSBvbkRyYWc7CiAgICAgICAgdGhpcy5zbmFwT25SZWxlYXNlID0gb25SZWxlYXNlOwoKICAgIH0sCgoJLyoqCiAgICAqIFN0b3BzIHRoZSBzcHJpdGUgZnJvbSBzbmFwcGluZyB0byBhIGdyaWQgZHVyaW5nIGRyYWcgb3IgcmVsZWFzZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rpc2FibGVTbmFwCiAgICAqLwogICAgZGlzYWJsZVNuYXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5zbmFwT25EcmFnID0gZmFsc2U7CiAgICAgICAgdGhpcy5zbmFwT25SZWxlYXNlID0gZmFsc2U7CgogICAgfSwKCgkvKioKICAgICogQm91bmRzIFJlY3QgY2hlY2sgZm9yIHRoZSBzcHJpdGUgZHJhZwogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tCb3VuZHNSZWN0CiAgICAqLwogICAgY2hlY2tCb3VuZHNSZWN0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS54IDwgdGhpcy5ib3VuZHNSZWN0LmxlZnQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gdGhpcy5ib3VuZHNSZWN0Lng7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS54ICsgdGhpcy5zcHJpdGUud2lkdGgpID4gdGhpcy5ib3VuZHNSZWN0LnJpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHRoaXMuYm91bmRzUmVjdC5yaWdodCAtIHRoaXMuc3ByaXRlLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnkgPCB0aGlzLmJvdW5kc1JlY3QudG9wKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHRoaXMuYm91bmRzUmVjdC50b3A7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS55ICsgdGhpcy5zcHJpdGUuaGVpZ2h0KSA+IHRoaXMuYm91bmRzUmVjdC5ib3R0b20pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gdGhpcy5ib3VuZHNSZWN0LmJvdHRvbSAtIHRoaXMuc3ByaXRlLmhlaWdodDsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogUGFyZW50IFNwcml0ZSBCb3VuZHMgY2hlY2sgZm9yIHRoZSBzcHJpdGUgZHJhZy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2NoZWNrQm91bmRzU3ByaXRlCiAgICAqLwogICAgY2hlY2tCb3VuZHNTcHJpdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnggPCB0aGlzLmJvdW5kc1Nwcml0ZS54KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHRoaXMuYm91bmRzU3ByaXRlLng7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS54ICsgdGhpcy5zcHJpdGUud2lkdGgpID4gKHRoaXMuYm91bmRzU3ByaXRlLnggKyB0aGlzLmJvdW5kc1Nwcml0ZS53aWR0aCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gKHRoaXMuYm91bmRzU3ByaXRlLnggKyB0aGlzLmJvdW5kc1Nwcml0ZS53aWR0aCkgLSB0aGlzLnNwcml0ZS53aWR0aDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnNwcml0ZS55IDwgdGhpcy5ib3VuZHNTcHJpdGUueSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSB0aGlzLmJvdW5kc1Nwcml0ZS55OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICgodGhpcy5zcHJpdGUueSArIHRoaXMuc3ByaXRlLmhlaWdodCkgPiAodGhpcy5ib3VuZHNTcHJpdGUueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gKHRoaXMuYm91bmRzU3ByaXRlLnkgKyB0aGlzLmJvdW5kc1Nwcml0ZS5oZWlnaHQpIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgIH0KCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgoKLyoqCiogVGhlIEV2ZW50cyBjb21wb25lbnQgaXMgYSBjb2xsZWN0aW9uIG9mIGV2ZW50cyBmaXJlZCBieSB0aGUgcGFyZW50IGdhbWUgb2JqZWN0IGFuZCBpdHMgY29tcG9uZW50cy4KKiAKKiBAY2xhc3MgUGhhc2VyLkV2ZW50cwoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBBIHJlZmVyZW5jZSB0byBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLkV2ZW50cyA9IGZ1bmN0aW9uIChzcHJpdGUpIHsKCQoJdGhpcy5wYXJlbnQgPSBzcHJpdGU7Cgl0aGlzLm9uQWRkZWRUb0dyb3VwID0gbmV3IFBoYXNlci5TaWduYWw7Cgl0aGlzLm9uUmVtb3ZlZEZyb21Hcm91cCA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJdGhpcy5vbktpbGxlZCA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJdGhpcy5vblJldml2ZWQgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCXRoaXMub25PdXRPZkJvdW5kcyA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKICAgIHRoaXMub25JbnB1dE92ZXIgPSBudWxsOwogICAgdGhpcy5vbklucHV0T3V0ID0gbnVsbDsKICAgIHRoaXMub25JbnB1dERvd24gPSBudWxsOwogICAgdGhpcy5vbklucHV0VXAgPSBudWxsOwogICAgdGhpcy5vbkRyYWdTdGFydCA9IG51bGw7CiAgICB0aGlzLm9uRHJhZ1N0b3AgPSBudWxsOwoKCXRoaXMub25BbmltYXRpb25TdGFydCA9IG51bGw7Cgl0aGlzLm9uQW5pbWF0aW9uQ29tcGxldGUgPSBudWxsOwoJdGhpcy5vbkFuaW1hdGlvbkxvb3AgPSBudWxsOwoKfTsKClBoYXNlci5FdmVudHMucHJvdG90eXBlID0gewoKCWRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5wYXJlbnQgPSBudWxsOwoJCXRoaXMub25BZGRlZFRvR3JvdXAuZGlzcG9zZSgpOwoJCXRoaXMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3Bvc2UoKTsKCQl0aGlzLm9uS2lsbGVkLmRpc3Bvc2UoKTsKCQl0aGlzLm9uUmV2aXZlZC5kaXNwb3NlKCk7CgkJdGhpcy5vbk91dE9mQm91bmRzLmRpc3Bvc2UoKTsKCgkJaWYgKHRoaXMub25JbnB1dE92ZXIpCgkJewoJCSAgICB0aGlzLm9uSW5wdXRPdmVyLmRpc3Bvc2UoKTsKCQkgICAgdGhpcy5vbklucHV0T3V0LmRpc3Bvc2UoKTsKCQkgICAgdGhpcy5vbklucHV0RG93bi5kaXNwb3NlKCk7CgkJICAgIHRoaXMub25JbnB1dFVwLmRpc3Bvc2UoKTsKCQkgICAgdGhpcy5vbkRyYWdTdGFydC5kaXNwb3NlKCk7CgkJICAgIHRoaXMub25EcmFnU3RvcC5kaXNwb3NlKCk7CgkJfQoKCQlpZiAodGhpcy5vbkFuaW1hdGlvblN0YXJ0KQoJCXsKCQkJdGhpcy5vbkFuaW1hdGlvblN0YXJ0LmRpc3Bvc2UoKTsKCQkJdGhpcy5vbkFuaW1hdGlvbkNvbXBsZXRlLmRpc3Bvc2UoKTsKCQkJdGhpcy5vbkFuaW1hdGlvbkxvb3AuZGlzcG9zZSgpOwoJCX0KCgl9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgR2FtZSBPYmplY3QgRmFjdG9yeSBpcyBhIHF1aWNrIHdheSB0byBjcmVhdGUgYWxsIG9mIHRoZSBkaWZmZXJlbnQgc29ydHMgb2YgY29yZSBvYmplY3RzIHRoYXQgUGhhc2VyIHVzZXMuCioKKiBAY2xhc3MgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCQogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLldvcmxkfSB3b3JsZCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBnYW1lIHdvcmxkLgoJKi8KCXRoaXMud29ybGQgPSB0aGlzLmdhbWUud29ybGQ7Cgp9OwoKUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhbiBleGlzdGluZyBvYmplY3QgdG8gdGhlIGdhbWUgd29ybGQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2V4aXN0aW5nCiAgICAqIEBwYXJhbSB7Kn0gb2JqZWN0IC0gQW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuLgogICAgKiBAcmV0dXJuIHsqfSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIEdyb3VwLgogICAgKi8KICAgIGV4aXN0aW5nOiBmdW5jdGlvbiAob2JqZWN0KSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChvYmplY3QpOwoKICAgIH0sCgoJLyoqCiAgICAqIENyZWF0ZSBhIG5ldyBTcHJpdGUgd2l0aCBzcGVjaWZpYyBwb3NpdGlvbiBhbmQgc3ByaXRlIHNoZWV0IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3Rvcnkjc3ByaXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2ZyYW1lXSAtIElmIHRoZSBzcHJpdGUgdXNlcyBhbiBpbWFnZSBmcm9tIGEgdGV4dHVyZSBhdGxhcyBvciBzcHJpdGUgc2hlZXQgeW91IGNhbiBwYXNzIHRoZSBmcmFtZSBoZXJlLiBFaXRoZXIgYSBudW1iZXIgZm9yIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHJldHVybnMge1BoYXNlci5TcHJpdGV9IHRoZSBuZXdseSBjcmVhdGVkIHNwcml0ZSBvYmplY3QuCiAgICAqLwogICAgc3ByaXRlOiBmdW5jdGlvbiAoeCwgeSwga2V5LCBmcmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5jcmVhdGUoeCwgeSwga2V5LCBmcmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlIGEgbmV3IFNwcml0ZSB3aXRoIHNwZWNpZmljIHBvc2l0aW9uIGFuZCBzcHJpdGUgc2hlZXQga2V5IHRoYXQgd2lsbCBhdXRvbWF0aWNhbGx5IGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgdGhlIGdpdmVuIHBhcmVudC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjY2hpbGQKICAgICogQHBhcmFtIHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIEdyb3VwIHRvIGFkZCB0aGlzIGNoaWxkIHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBzcHJpdGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHNwcml0ZS4KICAgICogQHBhcmFtIHtzdHJpbmd8UmVuZGVyVGV4dHVyZX0gW2tleV0gLSBUaGUgaW1hZ2Uga2V5IGFzIGRlZmluZWQgaW4gdGhlIEdhbWUuQ2FjaGUgdG8gdXNlIGFzIHRoZSB0ZXh0dXJlIGZvciB0aGlzIHNwcml0ZSBPUiBhIFJlbmRlclRleHR1cmUuCiAgICAqIEBwYXJhbSAge3N0cmluZ3xudW1iZXJ9IFtmcmFtZV0gLSBJZiB0aGUgc3ByaXRlIHVzZXMgYW4gaW1hZ2UgZnJvbSBhIHRleHR1cmUgYXRsYXMgb3Igc3ByaXRlIHNoZWV0IHlvdSBjYW4gcGFzcyB0aGUgZnJhbWUgaGVyZS4gRWl0aGVyIGEgbnVtYmVyIGZvciBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEByZXR1cm5zIHtQaGFzZXIuU3ByaXRlfSB0aGUgbmV3bHkgY3JlYXRlZCBzcHJpdGUgb2JqZWN0LgogICAgKi8KICAgIGNoaWxkOiBmdW5jdGlvbiAoZ3JvdXAsIHgsIHksIGtleSwgZnJhbWUpIHsKCiAgICAgICAgcmV0dXJuIGdyb3VwLmNyZWF0ZSh4LCB5LCBrZXksIGZyYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGUgYSB0d2VlbiBvYmplY3QgZm9yIGEgc3BlY2lmaWMgb2JqZWN0LiBUaGUgb2JqZWN0IGNhbiBiZSBhbnkgSmF2YVNjcmlwdCBvYmplY3Qgb3IgUGhhc2VyIG9iamVjdCBzdWNoIGFzIFNwcml0ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdHdlZW4KICAgICogQHBhcmFtIHtvYmplY3R9IG9iaiAtIE9iamVjdCB0aGUgdHdlZW4gd2lsbCBiZSBydW4gb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdHdlZW46IGZ1bmN0aW9uIChvYmopIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS50d2VlbnMuY3JlYXRlKG9iaik7CgogICAgfSwKCiAgICAvKioKICAgICogQSBHcm91cCBpcyBhIGNvbnRhaW5lciBmb3IgZGlzcGxheSBvYmplY3RzIHRoYXQgYWxsb3dzIGZvciBmYXN0IHBvb2xpbmcsIHJlY3ljbGluZyBhbmQgY29sbGlzaW9uIGNoZWNrcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZ3JvdXAKICAgICogQHBhcmFtIHsqfSBwYXJlbnQgLSBUaGUgcGFyZW50IEdyb3VwIG9yIERpc3BsYXlPYmplY3RDb250YWluZXIgdGhhdCB3aWxsIGhvbGQgdGhpcyBncm91cCwgaWYgYW55LgogICAgKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9Z3JvdXBdIC0gQSBuYW1lIGZvciB0aGlzIEdyb3VwLiBOb3QgdXNlZCBpbnRlcm5hbGx5IGJ1dCB1c2VmdWwgZm9yIGRlYnVnZ2luZy4KICAgICogQHJldHVybiB7UGhhc2VyLkdyb3VwfSBUaGUgbmV3bHkgY3JlYXRlZCBncm91cC4KICAgICovCiAgICBncm91cDogZnVuY3Rpb24gKHBhcmVudCwgbmFtZSkgewoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Hcm91cCh0aGlzLmdhbWUsIHBhcmVudCwgbmFtZSk7CgogICAgfSwKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgaW5zdGFuY2Ugb2YgdGhlIFNvdW5kIGNsYXNzLgogICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjYXVkaW8KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5jYWNoZSBrZXkgb2YgdGhlIHNvdW5kIHRoYXQgdGhpcyBvYmplY3Qgd2lsbCB1c2UuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gdm9sdW1lIC0gVGhlIHZvbHVtZSBhdCB3aGljaCB0aGUgc291bmQgd2lsbCBiZSBwbGF5ZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IGxvb3AgLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgICogQHJldHVybiB7UGhhc2VyLlNvdW5kfSBUaGUgbmV3bHkgY3JlYXRlZCB0ZXh0IG9iamVjdC4KICAgICAqLwogICAgYXVkaW86IGZ1bmN0aW9uIChrZXksIHZvbHVtZSwgbG9vcCkgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnNvdW5kLmFkZChrZXksIHZvbHVtZSwgbG9vcCk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyA8Y29kZT5UaWxlU3ByaXRlPC9jb2RlPi4KICAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3RpbGVTcHJpdGUKICAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVTcHJpdGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSB0aWxlc3ByaXRlLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIHRpbGVzcHJpdGUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGZyYW1lIC0gSWYgdGhpcyBTcHJpdGUgaXMgdXNpbmcgcGFydCBvZiBhIHNwcml0ZSBzaGVldCBvciB0ZXh0dXJlIGF0bGFzIHlvdSBjYW4gc3BlY2lmeSB0aGUgZXhhY3QgZnJhbWUgdG8gdXNlIGJ5IGdpdmluZyBhIHN0cmluZyBvciBudW1lcmljIGluZGV4LgogICAgICogQHJldHVybiB7UGhhc2VyLlRpbGVTcHJpdGV9IFRoZSBuZXdseSBjcmVhdGVkIHRpbGVTcHJpdGUgb2JqZWN0LgogICAgICovCiAgICB0aWxlU3ByaXRlOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5LCBmcmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5UaWxlU3ByaXRlKHRoaXMuZ2FtZSwgeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5LCBmcmFtZSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPlRleHQ8L2NvZGU+LgogICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGV4dAogICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGV4dCBvYmplY3QuCiAgICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgogICAgICogQHBhcmFtIHtvYmplY3R9IHN0eWxlIC0gVGhlIHN0eWxlIG9iamVjdCBjb250YWluaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbGlrZSBmb250LCBmb250IHNpemUgLCBldGMuCiAgICAgKiBAcmV0dXJuIHtQaGFzZXIuVGV4dH0gVGhlIG5ld2x5IGNyZWF0ZWQgdGV4dCBvYmplY3QuCiAgICAgKi8KICAgIHRleHQ6IGZ1bmN0aW9uICh4LCB5LCB0ZXh0LCBzdHlsZSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5UZXh0KHRoaXMuZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPkJ1dHRvbjwvY29kZT4gb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNidXR0b24KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgYnV0dG9uIG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgYnV0dG9uIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtrZXldIFRoZSBpbWFnZSBrZXkgYXMgZGVmaW5lZCBpbiB0aGUgR2FtZS5DYWNoZSB0byB1c2UgYXMgdGhlIHRleHR1cmUgZm9yIHRoaXMgYnV0dG9uLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhpcyBidXR0b24gaXMgcHJlc3NlZAogICAgKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykKICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3ZlckZyYW1lXSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG92ZXIgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW291dEZyYW1lXSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG91dCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZG93bkZyYW1lXSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGEgZG93biBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJ1dHRvbn0gVGhlIG5ld2x5IGNyZWF0ZWQgYnV0dG9uIG9iamVjdC4KICAgICovCiAgICBidXR0b246IGZ1bmN0aW9uICh4LCB5LCBrZXksIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5CdXR0b24odGhpcy5nYW1lLCB4LCB5LCBrZXksIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPkdyYXBoaWNzPC9jb2RlPiBvYmplY3QuCiAgICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNncmFwaGljcwogICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgogICAgICogQHJldHVybiB7UGhhc2VyLkdyYXBoaWNzfSBUaGUgbmV3bHkgY3JlYXRlZCBncmFwaGljcyBvYmplY3QuCiAgICAgKi8KICAgIGdyYXBoaWNzOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5HcmFwaGljcyh0aGlzLmdhbWUsIHgsIHkpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFbWl0dGVyIGlzIGEgbGlnaHR3ZWlnaHQgcGFydGljbGUgZW1pdHRlci4gSXQgY2FuIGJlIHVzZWQgZm9yIG9uZS10aW1lIGV4cGxvc2lvbnMgb3IgZm9yCiAgICAqIGNvbnRpbnVvdXMgZWZmZWN0cyBsaWtlIHJhaW4gYW5kIGZpcmUuIEFsbCBpdCByZWFsbHkgZG9lcyBpcyBsYXVuY2ggUGFydGljbGUgb2JqZWN0cyBvdXQKICAgICogYXQgc2V0IGludGVydmFscywgYW5kIGZpeGVzIHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmluZGdseS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZW1pdHRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gW3g9MF0gLSBUaGUgeCBjb29yZGluYXRlIHdpdGhpbiB0aGUgRW1pdHRlciB0aGF0IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgY29vcmRpbmF0ZSB3aXRoaW4gdGhlIEVtaXR0ZXIgdGhhdCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4UGFydGljbGVzPTUwXSAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4KICAgICogQHJldHVybiB7UGhhc2VyLkVtaXR0ZXJ9IFRoZSBuZXdseSBjcmVhdGVkIGVtaXR0ZXIgb2JqZWN0LgogICAgKi8KICAgIGVtaXR0ZXI6IGZ1bmN0aW9uICh4LCB5LCBtYXhQYXJ0aWNsZXMpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5wYXJ0aWNsZXMuYWRkKG5ldyBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyKHRoaXMuZ2FtZSwgeCwgeSwgbWF4UGFydGljbGVzKSk7CgogICAgfSwKCiAgICAvKioKICAgICogKiBDcmVhdGUgYSBuZXcgPGNvZGU+Qml0bWFwVGV4dDwvY29kZT4uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2JpdG1hcFRleHQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgYml0bWFwVGV4dCBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IGJpdG1hcFRleHQgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBhY3R1YWwgdGV4dCB0aGF0IHdpbGwgYmUgd3JpdHRlbi4KICAgICogQHBhcmFtIHtvYmplY3R9IHN0eWxlIC0gVGhlIHN0eWxlIG9iamVjdCBjb250YWluaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbGlrZSBmb250LCBmb250IHNpemUgLCBldGMuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBUZXh0fSBUaGUgbmV3bHkgY3JlYXRlZCBiaXRtYXBUZXh0IG9iamVjdC4KICAgICovCiAgICBiaXRtYXBUZXh0OiBmdW5jdGlvbiAoeCwgeSwgdGV4dCwgc3R5bGUpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQuYWRkKG5ldyBQaGFzZXIuQml0bWFwVGV4dCh0aGlzLmdhbWUsIHgsIHksIHRleHQsIHN0eWxlKSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ3JlYXRlcyBhIG5ldyBUaWxlbWFwIG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGlsZW1hcAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgSlNPTiBmaWxlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZW1hcH0gVGhlIG5ld2x5IGNyZWF0ZWQgdGlsZW1hcCBvYmplY3QuCiAgICAqLwogICAgdGlsZW1hcDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5UaWxlbWFwKHRoaXMuZ2FtZSwga2V5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbGVzZXQgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0aWxlc2V0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgaW1hZ2Uga2V5IGFzIGRlZmluZWQgaW4gdGhlIEdhbWUuQ2FjaGUgdG8gdXNlIGFzIHRoZSB0aWxlc2V0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZXNldH0gVGhlIG5ld2x5IGNyZWF0ZWQgdGlsZXNldCBvYmplY3QuCiAgICAqLwogICAgdGlsZXNldDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhY2hlLmdldFRpbGVzZXQoa2V5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbGVtYXAgTGF5ZXIgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0aWxlbWFwTGF5ZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZW1hcExheWVyLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlbWFwTGF5ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCBvZiB0aGUgdGlsZW1hcExheWVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodCBvZiB0aGUgdGlsZW1hcExheWVyLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZW1hcExheWVyfSBUaGUgbmV3bHkgY3JlYXRlZCB0aWxlbWFwbGF5ZXIgb2JqZWN0LgogICAgKi8KICAgIHRpbGVtYXBMYXllcjogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIHRpbGVzZXQsIHRpbGVtYXAsIGxheWVyKSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChuZXcgUGhhc2VyLlRpbGVtYXBMYXllcih0aGlzLmdhbWUsIHgsIHksIHdpZHRoLCBoZWlnaHQsIHRpbGVzZXQsIHRpbGVtYXAsIGxheWVyKSk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBkeW5hbWljIGluaXRpYWxseSBibGFuayBjYW52YXMgdG8gd2hpY2ggaW1hZ2VzIGNhbiBiZSBkcmF3bi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjcmVuZGVyVGV4dHVyZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgcmVuZGVyIHRleHR1cmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCBvZiB0aGUgcmVuZGVyIHRleHR1cmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHJldHVybiB7UGhhc2VyLlJlbmRlclRleHR1cmV9IFRoZSBuZXdseSBjcmVhdGVkIHJlbmRlclRleHR1cmUgb2JqZWN0LgogICAgKi8KICAgIHJlbmRlclRleHR1cmU6IGZ1bmN0aW9uIChrZXksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdmFyIHRleHR1cmUgPSBuZXcgUGhhc2VyLlJlbmRlclRleHR1cmUodGhpcy5nYW1lLCBrZXksIHdpZHRoLCBoZWlnaHQpOwoKICAgICAgICB0aGlzLmdhbWUuY2FjaGUuYWRkUmVuZGVyVGV4dHVyZShrZXksIHRleHR1cmUpOwoKICAgICAgICByZXR1cm4gdGV4dHVyZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIEJpdG1hcERhdGEgb2JqZWN0IHdoaWNoIGNhbiBiZSBtYW5pcHVsYXRlZCBhbmQgZHJhd24gdG8gbGlrZSBhIHRyYWRpdGlvbmFsIENhbnZhcyBvYmplY3QgYW5kIHVzZWQgdG8gdGV4dHVyZSBTcHJpdGVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNiaXRtYXBEYXRhCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MjU2XSAtIFRoZSB3aWR0aCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0PTI1Nl0gLSBUaGUgaGVpZ2h0IG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBuZXdseSBjcmVhdGVkIEJpdG1hcERhdGEgb2JqZWN0LgogICAgKi8KICAgIGJpdG1hcERhdGE6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLkJpdG1hcERhdGEodGhpcy5nYW1lLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIFdlYkdMIHNoYWRlci9maWx0ZXIgdGhhdCBjYW4gYmUgYXBwbGllZCB0byBTcHJpdGVzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNmaWx0ZXIKICAgICogQHBhcmFtIHtzdHJpbmd9IGZpbHRlciAtIFRoZSBuYW1lIG9mIHRoZSBmaWx0ZXIgeW91IHdpc2ggdG8gY3JlYXRlLCBmb3IgZXhhbXBsZSAiSHVlUm90YXRlIiBvciAiU2luZVdhdmUiCiAgICAqIEBwYXJhbSB7Li4ufSAtIFdoYXRldmVyIHBhcmFtZXRlcnMgYXJlIG5lZWRlZCB0byBiZSBwYXNzZWQgdG8gdGhlIGZpbHRlciBpbml0IGZ1bmN0aW9uLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRmlsdGVyfSBUaGUgbmV3bHkgY3JlYXRlZCBQaGFzZXIuRmlsdGVyIG9iamVjdC4KICAgICovCiAgICBmaWx0ZXI6IGZ1bmN0aW9uIChmaWx0ZXIpIHsKCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCiAgICAgICAgdmFyIGYgPSBuZXcgUGhhc2VyLkZpbHRlcltmaWx0ZXJdKHRoaXMuZ2FtZSk7CgogICAgICAgIGYuaW5pdC5hcHBseShmLCBhcmdzKTsKCiAgICAgICAgcmV0dXJuIGY7CgogICAgfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBgQml0bWFwRGF0YWAgb2JqZWN0LgoqCiogQGNsYXNzIFBoYXNlci5CaXRtYXBEYXRhCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9MjU2XSAtIFRoZSB3aWR0aCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MjU2XSAtIFRoZSBoZWlnaHQgb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgoqLwpQaGFzZXIuQml0bWFwRGF0YSA9IGZ1bmN0aW9uIChnYW1lLCB3aWR0aCwgaGVpZ2h0KSB7CgoJaWYgKHR5cGVvZiB3aWR0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgd2lkdGggPSAyNTY7IH0KCWlmICh0eXBlb2YgaGVpZ2h0ID09PSAndW5kZWZpbmVkJykgeyBoZWlnaHQgPSAyNTY7IH0KCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBCaXRtYXBEYXRhLgoJKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKi8KCXRoaXMud2lkdGggPSB3aWR0aDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICovCgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkvKioKCSogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byB3aGljaCB0aGlzIEJpdG1hcERhdGEgZHJhd3MuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh3aWR0aCwgaGVpZ2h0KTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gVGhlIDJkIGNvbnRleHQgb2YgdGhlIGNhbnZhcy4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwoKCS8qKgoJKiBAcHJvcGVydHkge2FycmF5fSBpbWFnZURhdGEgLSBUaGUgY2FudmFzIGltYWdlIGRhdGEuCgkqLwoJdGhpcy5pbWFnZURhdGEgPSB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKCS8qKgoJKiBAcHJvcGVydHkge1VJbnQ4Q2xhbXBlZH0gcGl4ZWxzIC0gQSByZWZlcmVuY2UgdG8gdGhlIGNvbnRleHQgaW1hZ2VEYXRhIGJ1ZmZlci4KCSovCglpZiAodGhpcy5pbWFnZURhdGEuZGF0YS5idWZmZXIpCgl7CgkJdGhpcy5waXhlbHMgPSB0aGlzLmltYWdlRGF0YS5kYXRhLmJ1ZmZlcjsKCX0KCWVsc2UKCXsKCQl0aGlzLnBpeGVscyA9IHRoaXMuaW1hZ2VEYXRhLmRhdGE7Cgl9CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UElYSS5CYXNlVGV4dHVyZX0gYmFzZVRleHR1cmUgLSBUaGUgUElYSS5CYXNlVGV4dHVyZS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUodGhpcy5jYW52YXMpOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtQSVhJLlRleHR1cmV9IHRleHR1cmUgLSBUaGUgUElYSS5UZXh0dXJlLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudGV4dHVyZSA9IG5ldyBQSVhJLlRleHR1cmUodGhpcy5iYXNlVGV4dHVyZSk7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gdGV4dHVyZUZyYW1lIC0gVGhlIEZyYW1lIHRoaXMgQml0bWFwRGF0YSB1c2VzIGZvciByZW5kZXJpbmcuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50ZXh0dXJlRnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIHdpZHRoLCBoZWlnaHQsICdiaXRtYXBEYXRhJywgZ2FtZS5ybmQudXVpZCgpKTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKCSovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuQklUTUFQREFUQTsKCgl0aGlzLl9kaXJ0eSA9IGZhbHNlOwoKfQoKUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlID0gewoKCS8qKgoJKiBVcGRhdGVzIHRoZSBnaXZlbiBTcHJpdGUgc28gdGhhdCBpdCB1c2VzIHRoaXMgQml0bWFwRGF0YSBhcyBpdHMgdGV4dHVyZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5hZGQKCSogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRvIGFwcGx5IHRoaXMgdGV4dHVyZSB0by4KCSovCglhZGQ6IGZ1bmN0aW9uIChzcHJpdGUpIHsKCgkJc3ByaXRlLmxvYWRUZXh0dXJlKHRoaXMpOwoKCX0sCgoJLyoqCgkqIEdpdmVuIGFuIGFycmF5IG9mIFNwcml0ZXMgaXQgd2lsbCB1cGRhdGUgZWFjaCBvZiB0aGVtIHNvIHRoYXQgdGhlaXIgVGV4dHVyZXMgcmVmZXJlbmNlIHRoaXMgQml0bWFwRGF0YS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5hZGRUbwoJKiBAcGFyYW0ge1BoYXNlci5TcHJpdGVbXX0gc3ByaXRlcyAtIEFuIGFycmF5IG9mIFNwcml0ZXMgdG8gYXBwbHkgdGhpcyB0ZXh0dXJlIHRvLgoJKi8KCWFkZFRvOiBmdW5jdGlvbiAoc3ByaXRlcykgewoKCQlmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspCgkJewoJCSAgICBpZiAob2JqZWN0c1tpXS50ZXh0dXJlKQoJCSAgICB7CgkJICAgIH0KCQl9CgoJfSwKCgkvKioKCSogQ2xlYXJzIHRoZSBCaXRtYXBEYXRhLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNsZWFyCgkqLwoJY2xlYXI6IGZ1bmN0aW9uICgpIHsKCgkgICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgoJfSwKCglyZWZyZXNoQnVmZmVyOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuaW1hZ2VEYXRhID0gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkJdGhpcy5waXhlbHMgPSBuZXcgSW50MzJBcnJheSh0aGlzLmltYWdlRGF0YS5kYXRhLmJ1ZmZlcik7CgoJCS8vIHRoaXMuZGF0YTggPSBuZXcgVWludDhDbGFtcGVkQXJyYXkodGhpcy5pbWFnZURhdGEuYnVmZmVyKTsKCQkvLyB0aGlzLmRhdGEzMiA9IG5ldyBVaW50MzJBcnJheSh0aGlzLmltYWdlRGF0YS5idWZmZXIpOwoKCX0sCgoJLyoqCgkqIFNldHMgdGhlIGNvbG9yIG9mIHRoZSBnaXZlbiBwaXhlbCB0byB0aGUgc3BlY2lmaWVkIHJlZCwgZ3JlZW4sIGJsdWUgYW5kIGFscGhhIHZhbHVlcy4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zZXRQaXhlbDMyCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGJlIHNldC4KCSogQHBhcmFtIHtudW1iZXJ9IHJlZCAtIFRoZSByZWQgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KCSogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIGdyZWVuIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCgkqIEBwYXJhbSB7bnVtYmVyfSBibHVlIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KCSogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGFscGhhIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCgkqLwogICAgc2V0UGl4ZWwzMjogZnVuY3Rpb24gKHgsIHksIHJlZCwgZ3JlZW4sIGJsdWUsIGFscGhhKSB7CgogICAgCWlmICh4ID49IDAgJiYgeCA8PSB0aGlzLndpZHRoICYmIHkgPj0gMCAmJiB5IDw9IHRoaXMuaGVpZ2h0KQogICAgCXsKCQkJdGhpcy5waXhlbHNbeSAqIHRoaXMud2lkdGggKyB4XSA9IChhbHBoYSA8PCAyNCkgfCAoYmx1ZSA8PCAxNikgfCAoZ3JlZW4gPDwgOCkgfCByZWQ7CgogICAgCQkvKgogICAgCQlpZiAodGhpcy5pc0xpdHRsZUVuZGlhbikKICAgIAkJewoJCQkJdGhpcy5kYXRhMzJbeSAqIHRoaXMud2lkdGggKyB4XSA9IChhbHBoYSA8PCAyNCkgfCAoYmx1ZSA8PCAxNikgfCAoZ3JlZW4gPDwgOCkgfCByZWQ7CiAgICAJCX0KICAgIAkJZWxzZQogICAgCQl7CgkJCQl0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdID0gKHJlZCA8PCAyNCkgfCAoZ3JlZW4gPDwgMTYpIHwgKGJsdWUgPDwgOCkgfCBhbHBoYTsKICAgIAkJfQogICAgCQkqLwoKICAgIAkJLy8gdGhpcy5pbWFnZURhdGEuZGF0YS5zZXQodGhpcy5kYXRhOCk7CgogICAgCQl0aGlzLmNvbnRleHQucHV0SW1hZ2VEYXRhKHRoaXMuaW1hZ2VEYXRhLCAwLCAwKTsKCgkJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKICAgIAl9CgogICAgfSwKCgkvKioKCSogU2V0cyB0aGUgY29sb3Igb2YgdGhlIGdpdmVuIHBpeGVsIHRvIHRoZSBzcGVjaWZpZWQgcmVkLCBncmVlbiBhbmQgYmx1ZSB2YWx1ZXMuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc2V0UGl4ZWwKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgoJKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpCgkqIEBwYXJhbSB7bnVtYmVyfSBncmVlbiAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpCgkqIEBwYXJhbSB7bnVtYmVyfSBibHVlIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KQoJKi8KICAgIHNldFBpeGVsOiBmdW5jdGlvbiAoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSkgewoKICAgIAl0aGlzLnNldFBpeGVsMzIoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSwgMjU1KTsKCiAgICB9LAoKCS8qKgoJKiBHZXQgYSBjb2xvciBvZiBhIHNwZWNpZmljIHBpeGVsLgoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGdldC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCgkqIEByZXR1cm4ge251bWJlcn0gQSBuYXRpdmUgY29sb3IgdmFsdWUgaW50ZWdlciAoZm9ybWF0OiAweFJSR0dCQikKCSovCiAgICBnZXRQaXhlbDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAJaWYgKHggPj0gMCAmJiB4IDw9IHRoaXMud2lkdGggJiYgeSA+PSAwICYmIHkgPD0gdGhpcy5oZWlnaHQpCiAgICAJewoJCQlyZXR1cm4gdGhpcy5kYXRhMzJbeSAqIHRoaXMud2lkdGggKyB4XTsKICAgIAl9CgogICAgfSwKCgkvKioKCSogR2V0IGEgY29sb3Igb2YgYSBzcGVjaWZpYyBwaXhlbCAoaW5jbHVkaW5nIGFscGhhIHZhbHVlKS4KCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gZ2V0LgoJKiBAcmV0dXJuIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhBQVJSR0dCQikKCSovCiAgICBnZXRQaXhlbDMyOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgIAlpZiAoeCA+PSAwICYmIHggPD0gdGhpcy53aWR0aCAmJiB5ID49IDAgJiYgeSA8PSB0aGlzLmhlaWdodCkKICAgIAl7CgkJCXJldHVybiB0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdOwogICAgCX0KCiAgICB9LAoKICAgIC8qKgogICAgICogR2V0IHBpeGVscyBpbiBhcnJheSBpbiBhIHNwZWNpZmljIFJlY3RhbmdsZS4KICAgICAqIEBwYXJhbSByZWN0IHtSZWN0YW5nbGV9IFRoZSBzcGVjaWZpYyBSZWN0YW5nbGUuCiAgICAgKiBAcmV0dXJuIHthcnJheX0gQ2FudmFzUGl4ZWxBcnJheS4KICAgICAqLwogICAgZ2V0UGl4ZWxzOiBmdW5jdGlvbiAocmVjdCkgewoKICAgICAgICAvLyByZXR1cm4gdGhpcy5jb250ZXh0LmdldEltYWdlRGF0YShyZWN0LngsIHJlY3QueSwgcmVjdC53aWR0aCwgcmVjdC5oZWlnaHQpOwoKICAgIH0sCgoJLyoqCgkqIEFkZHMgYW4gYXJjIHRvIHRoZSBwYXRoIHdoaWNoIGlzIGNlbnRlcmVkIGF0ICh4LCB5KSBwb3NpdGlvbiB3aXRoIHJhZGl1cyByIHN0YXJ0aW5nIGF0IHN0YXJ0QW5nbGUgYW5kIGVuZGluZyBhdCBlbmRBbmdsZSAKCSogZ29pbmcgaW4gdGhlIGdpdmVuIGRpcmVjdGlvbiBieSBhbnRpY2xvY2t3aXNlIChkZWZhdWx0aW5nIHRvIGNsb2Nrd2lzZSkuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuYXJjCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGFyYydzIGNlbnRlcgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBhcmMncyBjZW50ZXIKCSogQHBhcmFtIHtudW1iZXJ9IHJhZGl1cyAtIFRoZSBhcmMncyByYWRpdXMKCSogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0QW5nbGUgLSBUaGUgc3RhcnRpbmcgcG9pbnQsIG1lYXN1cmVkIGZyb20gdGhlIHggYXhpcywgZnJvbSB3aGljaCBpdCB3aWxsIGJlIGRyYXduLCBleHByZXNzZWQgaW4gcmFkaWFucy4KCSogQHBhcmFtIHtudW1iZXJ9IGVuZEFuZ2xlIC0gVGhlIGVuZCBhcmMncyBhbmdsZSB0byB3aGljaCBpdCB3aWxsIGJlIGRyYXduLCBleHByZXNzZWQgaW4gcmFkaWFucy4KCSogQHBhcmFtIHtib29sZWFufSBbYW50aWNsb2Nrd2lzZT10cnVlXSAtIHRydWUgZHJhd3MgdGhlIGFyYyBhbnRpY2xvY2t3aXNlLCBvdGhlcndpc2UgaW4gYSBjbG9ja3dpc2UgZGlyZWN0aW9uLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglhcmM6IGZ1bmN0aW9uICh4LCB5LCByYWRpdXMsIHN0YXJ0QW5nbGUsIGVuZEFuZ2xlLCBhbnRpY2xvY2t3aXNlKSB7CgoJCWlmICh0eXBlb2YgYW50aWNsb2Nrd2lzZSA9PT0gJ3VuZGVmaW5lZCcpIHsgYW50aWNsb2Nrd2lzZSA9IGZhbHNlOyB9CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuYXJjKHgsIHksIHJhZGl1cywgc3RhcnRBbmdsZSwgZW5kQW5nbGUsIGFudGljbG9ja3dpc2UpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZHMgYW4gYXJjIHdpdGggdGhlIGdpdmVuIGNvbnRyb2wgcG9pbnRzIGFuZCByYWRpdXMsIGNvbm5lY3RlZCB0byB0aGUgcHJldmlvdXMgcG9pbnQgYnkgYSBzdHJhaWdodCBsaW5lLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmFyY1RvCgkqIEBwYXJhbSB7bnVtYmVyfSB4MQoJKiBAcGFyYW0ge251bWJlcn0geTEKCSogQHBhcmFtIHtudW1iZXJ9IHgyCgkqIEBwYXJhbSB7bnVtYmVyfSB5MgoJKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWFyY1RvOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIsIHJhZGl1cykgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LmFyY1RvKHgxLCB5MSwgeDIsIHkyLCByYWRpdXMpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEJlZ2lucyBhIGZpbGwgd2l0aCB0aGUgc3BlY2lmaWVkIGNvbG9yLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuYmVnaW5GaWxsCgkqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIEEgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWUgKGV4LiAicmVkIiwgIiNGRjAwMDAiLCBvciAicmdiYSgyNTUsMCwwLDAuNSkiKS4gU2V0dGluZyB0byBudWxsIHdpbGwgcmVzdWx0IGluIG5vIGZpbGwuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWJlZ2luRmlsbDogZnVuY3Rpb24gKGNvbG9yKSB7CgoJCXRoaXMuZmlsbFN0eWxlKGNvbG9yKTsKCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQmVnaW5zIGEgbGluZWFyIGdyYWRpZW50IGZpbGwgZGVmaW5lZCBieSB0aGUgbGluZSAoeDAsIHkwKSB0byAoeDEsIHkxKS4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBGb3IKCSogZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIGRlZmluZXMgYSBibGFjayB0byB3aGl0ZSB2ZXJ0aWNhbCBncmFkaWVudCByYW5naW5nIGZyb20gMjBweCB0byAxMjBweCwgYW5kIGRyYXdzIGEgc3F1YXJlIHRvIGRpc3BsYXkgaXQ6CgkqCgkqICAgICAgYGBgbXlHcmFwaGljcy5iZWdpbkxpbmVhckdyYWRpZW50RmlsbChbIiMwMDAiLCIjRkZGIl0sIFswLCAxXSwgMCwgMjAsIDAsIDEyMCkucmVjdCgyMCwgMjAsIDEyMCwgMTIwKTtgYGAKCSoKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZWdpbkxpbmVhckdyYWRpZW50RmlsbAoJKiBAcGFyYW0ge0FycmF5fSBjb2xvcnMgLSBBbiBhcnJheSBvZiBDU1MgY29tcGF0aWJsZSBjb2xvciB2YWx1ZXMuIEZvciBleGFtcGxlLCBbIiNGMDAiLCIjMDBGIl0gd291bGQgZGVmaW5lIGEgZ3JhZGllbnQgZHJhd2luZyBmcm9tIHJlZCB0byBibHVlLgoJKiBAcGFyYW0ge0FycmF5fSByYXRpb3MgLSBBbiBhcnJheSBvZiBncmFkaWVudCBwb3NpdGlvbnMgd2hpY2ggY29ycmVzcG9uZCB0byB0aGUgY29sb3JzLiBGb3IgZXhhbXBsZSwgWzAuMSwgMC45XSB3b3VsZCBkcmF3IHRoZSBmaXJzdCBjb2xvciB0byAxMCUgdGhlbiBpbnRlcnBvbGF0aW5nIHRvIHRoZSBzZWNvbmQgY29sb3IgYXQgOTAlLgoJKiBAcGFyYW0ge251bWJlcn0geDAgLSBUaGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgoJKiBAcGFyYW0ge251bWJlcn0geTAgLSBUaGUgcG9zaXRpb24gb2YgdGhlIGZpcnN0IHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgoJKiBAcGFyYW0ge251bWJlcn0geDEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KCSogQHBhcmFtIHtudW1iZXJ9IHkxIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBzZWNvbmQgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWJlZ2luTGluZWFyR3JhZGllbnRGaWxsOiBmdW5jdGlvbiAoY29sb3JzLCByYXRpb3MsIHgwLCB5MCwgeDEsIHkxKSB7CgoJCXZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlTGluZWFyR3JhZGllbnQoeDAsIHkwLCB4MSwgeTEpOwoKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQoJCXsKCQkJZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKCQl9CgoJCXRoaXMuZmlsbFN0eWxlKGdyYWRpZW50KTsKCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQmVnaW5zIGEgbGluZWFyIGdyYWRpZW50IHN0cm9rZSBkZWZpbmVkIGJ5IHRoZSBsaW5lICh4MCwgeTApIHRvICh4MSwgeTEpLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvcgoJKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIGJsYWNrIHRvIHdoaXRlIHZlcnRpY2FsIGdyYWRpZW50IHJhbmdpbmcgZnJvbSAyMHB4IHRvIDEyMHB4LCBhbmQgZHJhd3MgYQoJKiBzcXVhcmUgdG8gZGlzcGxheSBpdDoKCSoKCSogICAgICBgYGBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDEwKS5iZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlKFsiIzAwMCIsIiNGRkYiXSwgWzAsIDFdLCAwLCAyMCwgMCwgMTIwKS5kcmF3UmVjdCgyMCwgMjAsIDEyMCwgMTIwKTtgYGAKCSoKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlCgkqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCgkqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgoJKiBAcGFyYW0ge251bWJlcn0geTEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZTogZnVuY3Rpb24gKGNvbG9ycywgcmF0aW9zLCB4MCwgeTAsIHgxLCB5MSkgewoKCQl2YXIgZ3JhZGllbnQgPSB0aGlzLmNyZWF0ZUxpbmVhckdyYWRpZW50KHgwLCB5MCwgeDEsIHkxKTsKCgkJZm9yICh2YXIgaSA9IDAsIGxlbiA9IGNvbG9ycy5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCWdyYWRpZW50LmFkZENvbG9yU3RvcChyYXRpb3NbaV0sIGNvbG9yc1tpXSk7CgkJfQoKCQl0aGlzLnN0cm9rZVN0eWxlKGdyYWRpZW50KTsKCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQmVnaW5zIGEgcmFkaWFsIGdyYWRpZW50IHN0cm9rZS4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBGb3IgZXhhbXBsZSwgdGhlIGZvbGxvd2luZyBjb2RlIGRlZmluZXMgYSByZWQgdG8KCSogYmx1ZSByYWRpYWwgZ3JhZGllbnQgY2VudGVyZWQgYXQgKDEwMCwgMTAwKSwgd2l0aCBhIHJhZGl1cyBvZiA1MCwgYW5kIGRyYXdzIGEgcmVjdGFuZ2xlIHRvIGRpc3BsYXkgaXQ6CgkqCgkqICAgICAgbXlHcmFwaGljcy5zZXRTdHJva2VTdHlsZSgxMCkKCSogICAgICAgICAgLmJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UoWyIjRjAwIiwiIzAwRiJdLCBbMCwgMV0sIDEwMCwgMTAwLCAwLCAxMDAsIDEwMCwgNTApCgkqICAgICAgICAgIC5kcmF3UmVjdCg1MCwgOTAsIDE1MCwgMTEwKTsKCSoKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZWdpblJhZGlhbEdyYWRpZW50U3Ryb2tlCgkqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCgkqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSByMCAtIFJhZGl1cyBvZiB0aGUgaW5uZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5MSAtIENlbnRlciBwb3NpdGlvbiBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSByMSAtIFJhZGl1cyBvZiB0aGUgb3V0ZXIgY2lyY2xlIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2U6IGZ1bmN0aW9uIChjb2xvcnMsIHJhdGlvcywgeDAsIHkwLCByMCwgeDEsIHkxLCByMSkgewoKCQl2YXIgZ3JhZGllbnQgPSB0aGlzLmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgwLCB5MCwgcjAsIHgxLCB5MSwgcjEpOwoKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQoJCXsKCQkJZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKCQl9CgoJCXRoaXMuc3Ryb2tlU3R5bGUoZ3JhZGllbnQpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTdGFydHMgYSBuZXcgcGF0aCBieSByZXNldHRpbmcgdGhlIGxpc3Qgb2Ygc3ViLXBhdGhzLiBDYWxsIHRoaXMgbWV0aG9kIHdoZW4geW91IHdhbnQgdG8gY3JlYXRlIGEgbmV3IHBhdGguCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuYmVnaW5QYXRoCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWJlZ2luUGF0aDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQmVnaW5zIGEgc3Ryb2tlIHdpdGggdGhlIHNwZWNpZmllZCBjb2xvci4gVGhpcyBlbmRzIHRoZSBjdXJyZW50IHN1Yi1wYXRoLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmJlZ2luU3Ryb2tlCgkqIEBwYXJhbSB7U3RyaW5nfSBjb2xvciBBIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlIChleC4gIiNGRjAwMDAiLCAicmVkIiwgb3IgInJnYmEoMjU1LDAsMCwwLjUpIikuIFNldHRpbmcgdG8gbnVsbCB3aWxsIHJlc3VsdCBpbiBubyBzdHJva2UuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWJlZ2luU3Ryb2tlOiBmdW5jdGlvbiAoY29sb3IpIHsKCgkJdGhpcy5zdHJva2VTdHlsZShjb2xvcik7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkcyBhIGJlemllciBjdXJ2ZSBmcm9tIHRoZSBjdXJyZW50IGNvbnRleHQgcG9pbnQgdG8gKHgsIHkpIHVzaW5nIHRoZSBjb250cm9sIHBvaW50cyAoY3AxeCwgY3AxeSkgYW5kIChjcDJ4LCBjcDJ5KS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZXppZXJDdXJ2ZVRvCgkqIEBwYXJhbSB7bnVtYmVyfSBjcDF4IC0gVGhlIHggYXhpcyBvZiBjb250cm9sIHBvaW50IDEuCgkqIEBwYXJhbSB7bnVtYmVyfSBjcDF5IC0gVGhlIHkgYXhpcyBvZiBjb250cm9sIHBvaW50IDEuCgkqIEBwYXJhbSB7bnVtYmVyfSBjcDJ4IC0gVGhlIHggYXhpcyBvZiBjb250cm9sIHBvaW50IDIuCgkqIEBwYXJhbSB7bnVtYmVyfSBjcDJ5IC0gVGhlIHkgYXhpcyBvZiBjb250cm9sIHBvaW50IDIuCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGVuZGluZyBwb2ludC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmV6aWVyQ3VydmVUbzogZnVuY3Rpb24gKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5iZXppZXJDdXJ2ZVRvKGNwMXgsIGNwMXksIGNwMngsIGNwMnksIHgsIHkpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIERyYXdzIGEgY2lyY2xlIHdpdGggdGhlIHNwZWNpZmllZCByYWRpdXMgYXQgKHgsIHkpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNpcmNsZQoJKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgY2lyY2xlLgoJKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgY2lyY2xlLgoJKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzIC0gUmFkaXVzIG9mIGNpcmNsZSBpbiByYWRpYW5zLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgljaXJjbGU6IGZ1bmN0aW9uICh4LCB5LCByYWRpdXMpIHsKCgkJdGhpcy5hcmMoeCwgeSwgcmFkaXVzLCAwLCBNYXRoLlBJKjIpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldHMgYWxsIHBpeGVscyBpbiB0aGUgcmVjdGFuZ2xlIGRlZmluZWQgYnkgc3RhcnRpbmcgcG9pbnQgKHgsIHkpIGFuZCBzaXplICh3aWR0aCwgaGVpZ2h0KSB0byB0cmFuc3BhcmVudCBibGFjay4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5jbGVhclJlY3QKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgoJKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgljbGVhclJlY3Q6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuY2xlYXJSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIENyZWF0ZXMgYSBjbGlwcGluZyBwYXRoIGZyb20gdGhlIGN1cnJlbnQgc3ViLXBhdGhzLiBFdmVyeXRoaW5nIGRyYXduIGFmdGVyIGNsaXAoKSBpcyBjYWxsZWQgYXBwZWFycyBpbnNpZGUgdGhlIGNsaXBwaW5nIHBhdGggb25seS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5jbGlwCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWNsaXA6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuY2xpcCgpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFRyaWVzIHRvIGRyYXcgYSBzdHJhaWdodCBsaW5lIGZyb20gdGhlIGN1cnJlbnQgcG9pbnQgdG8gdGhlIHN0YXJ0LiBJZiB0aGUgc2hhcGUgaGFzIGFscmVhZHkgYmVlbiBjbG9zZWQgb3IgaGFzIG9ubHkgb25lIHBvaW50LCB0aGlzIGZ1bmN0aW9uIGRvZXMgbm90aGluZy4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5jbG9zZVBhdGgKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJY2xvc2VQYXRoOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQ3JlYXRlcyBhIGxpbmVhciBncmFkaWVudCB3aXRoIGRlZmluZWQgYnkgYW4gaW1hZ2luYXJ5IGxpbmUgd2hpY2ggaW1wbGllcyB0aGUgZGlyZWN0aW9uIG9mIHRoZSBncmFkaWVudC4KCSogT25jZSB0aGUgZ3JhZGllbnQgaXMgY3JlYXRlZCBjb2xvcnMgY2FuIGJlIGluc2VydGVkIHVzaW5nIHRoZSBhZGRDb2xvclN0b3AgbWV0aG9kLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNyZWF0ZUxpbmVhckdyYWRpZW50CgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGdyYWRpZW50cyBzdGFydGluZyBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZ3JhZGllbnRzIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIGdyYWRpZW50LgoJKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgZ3JhZGllbnQuCgkqIEByZXR1cm4ge0NhbnZhc0dyYWRpZW50fSBUaGUgTGluZWFyIEdyYWRpZW50LgoJKi8KCWNyZWF0ZUxpbmVhckdyYWRpZW50OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKCQlyZXR1cm4gdGhpcy5jb250ZXh0LmNyZWF0ZUxpbmVhckdyYWRpZW50KHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKCX0sCgoJLy8JY3JlYXRlUGF0dGVybgoKCS8qKgoJKiBDcmVhdGVzIGEgcmFkaWFsIGdyYWRpZW50LgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNyZWF0ZVJhZGlhbEdyYWRpZW50CgkqIEBwYXJhbSB7bnVtYmVyfSB4MAoJKiBAcGFyYW0ge251bWJlcn0geTAKCSogQHBhcmFtIHtudW1iZXJ9IHIwCgkqIEBwYXJhbSB7bnVtYmVyfSB4MQoJKiBAcGFyYW0ge251bWJlcn0geTEKCSogQHBhcmFtIHtudW1iZXJ9IHIxCgkqIEByZXR1cm4ge0NhbnZhc0dyYWRpZW50fSBUaGUgUmFkaWFsIEdyYWRpZW50LgoJKi8KCWNyZWF0ZVJhZGlhbEdyYWRpZW50OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKCQlyZXR1cm4gdGhpcy5jb250ZXh0LmNyZWF0ZVJhZGlhbEdyYWRpZW50KHgwLCB5MCwgcjAsIHgxLCB5MSwgcjEpOwoKCX0sCgoJLy8JZHJhd0ltYWdlCgkvLwlkcmF3U3lzdGVtRm9jdXNSaW5nICg/KQoKCS8qKgoJKiBEcmF3cyBhbiBlbGxpcHNlIChvdmFsKSB3aXRoIGEgc3BlY2lmaWVkIHdpZHRoICh3KSBhbmQgaGVpZ2h0IChoKS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5lbGxpcHNlCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBlbGxpcHNlLgoJKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSBjZW50ZXIgcG9pbnQgb2YgZWxsaXBzZS4KCSogQHBhcmFtIHtudW1iZXJ9IHcgLSBoZWlnaHQgKGhvcml6b250YWwgZGlhbWV0ZXIpIG9mIGVsbGlwc2UuIFRoZSBob3Jpem9udGFsIHJhZGl1cyB3aWxsIGJlIGhhbGYgb2YgdGhpcyBudW1iZXIuCgkqIEBwYXJhbSB7bnVtYmVyfSBoIC0gd2lkdGggKHZlcnRpY2FsIGRpYW1ldGVyKSBvZiBlbGxpcHNlLiBUaGUgdmVydGljYWwgcmFkaXVzIHdpbGwgYmUgaGFsZiBvZiB0aGlzIG51bWJlci4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJZWxsaXBzZTogZnVuY3Rpb24gKHgsIHksIHcsIGgpIHsKCgkJdmFyIGsgPSAwLjU1MjI4NDg7CgkJdmFyIG94ID0gKHcgLyAyKSAqIGs7CgkJdmFyIG95ID0gKGggLyAyKSAqIGs7CgkJdmFyIHhlID0geCArIHc7CgkJdmFyIHllID0geSArIGg7CgkJdmFyIHhtID0geCArIHcgLyAyOwoJCXZhciB5bSA9IHkgKyBoIC8gMjsKCQkJCgkJdGhpcy5tb3ZlVG8oeCwgeW0pOwoJCXRoaXMuYmV6aWVyQ3VydmVUbyh4LCB5bSAtIG95LCB4bSAtIG94LCB5LCB4bSwgeSk7CgkJdGhpcy5iZXppZXJDdXJ2ZVRvKHhtICsgb3gsIHksIHhlLCB5bSAtIG95LCB4ZSwgeW0pOwoJCXRoaXMuYmV6aWVyQ3VydmVUbyh4ZSwgeW0gKyBveSwgeG0gKyBveCwgeWUsIHhtLCB5ZSk7CgkJdGhpcy5iZXppZXJDdXJ2ZVRvKHhtIC0gb3gsIHllLCB4LCB5bSArIG95LCB4LCB5bSk7CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEZpbGxzIHRoZSBzdWJwYXRocyB3aXRoIHRoZSBjdXJyZW50IGZpbGwgc3R5bGUuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuZmlsbAoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglmaWxsOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuZmlsbCgpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIERyYXdzIGEgZmlsbGVkIHJlY3RhbmdsZSBhdCAoeCwgeSkgcG9zaXRpb24gd2hvc2Ugc2l6ZSBpcyBkZXRlcm1pbmVkIGJ5IHdpZHRoIGFuZCBoZWlnaHQuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuZmlsbFJlY3QKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgoJKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglmaWxsUmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5maWxsUmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIHRoZSBmaWxsIHN0eWxlLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmZpbGxTdHlsZQoJKiBAcGFyYW0ge3N0cmluZ30gY29sb3IgLSBUaGUgZmlsbCBjb2xvciB2YWx1ZSBpbiBDU1MgZm9ybWF0OiAjUlJHR0JCIG9yIHJnYmEocixnLGIsYSkKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJZmlsbFN0eWxlOiBmdW5jdGlvbiAoY29sb3IpIHsKCgkJdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLy8JZmlsbFRleHQKCgkvKioKCSogU2V0cyB0aGUgZm9udC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5mb250CgkqIEBwYXJhbSB7RE9NU3RyaW5nfSBmb250IC0gVGhlIGZvbnQgdG8gYmUgdXNlZCBmb3IgYW55IHRleHQgcmVuZGVyaW5nLiBEZWZhdWx0IHZhbHVlIDEwcHggc2Fucy1zZXJpZi4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJZm9udDogZnVuY3Rpb24gKGZvbnQpIHsKCgkJdGhpcy5jb250ZXh0LmZvbnQgPSBmb250OwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFscGhhIHZhbHVlIHRoYXQgaXMgYXBwbGllZCB0byBzaGFwZXMgYW5kIGltYWdlcyBiZWZvcmUgdGhleSBhcmUgY29tcG9zaXRlZCBvbnRvIHRoZSBjYW52YXMuIERlZmF1bHQgMS4wIChvcGFxdWUpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmdsb2JhbEFscGhhCgkqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIEFscGhhIHZhbHVlIHRoYXQgaXMgYXBwbGllZCB0byBzaGFwZXMgYW5kIGltYWdlcyBiZWZvcmUgdGhleSBhcmUgY29tcG9zaXRlZCBvbnRvIHRoZSBjYW52YXMuIERlZmF1bHQgMS4wIChvcGFxdWUpLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglnbG9iYWxBbHBoYTogZnVuY3Rpb24gKGFscGhhKSB7CgoJCXRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IGFscGhhOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFdpdGggZ2xvYmFsQWxwaGEgYXBwbGllZCB0aGlzIHNldHMgaG93IHNoYXBlcyBhbmQgaW1hZ2VzIGFyZSBkcmF3biBvbnRvIHRoZSBleGlzdGluZyBiaXRtYXAuIFBvc3NpYmxlIHZhbHVlczogc291cmNlLWF0b3AsIHNvdXJjZS1pbiwgc291cmNlLW91dCwKCSogc291cmNlLW92ZXIgKGRlZmF1bHQpLCBkZXN0aW5hdGlvbi1hdG9wLCBkZXN0aW5hdGlvbi1pbiwgZGVzdGluYXRpb24tb3V0LCBkZXN0aW5hdGlvbi1vdmVyLCBsaWdodGVyLCBkYXJrZXIsIGNvcHkgYW5kIHhvci4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24KCSogQHBhcmFtIHtET01TdHJpbmd9IG9wZXJhdGlvbiAtIFRoZSBjb21wb3NpdGUgb3BlcmF0aW9uIHRvIGFwcGx5LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglnbG9iYWxDb21wb3NpdGVPcGVyYXRpb246IGZ1bmN0aW9uIChvcGVyYXRpb24pIHsKCgkJdGhpcy5jb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9IG9wZXJhdGlvbjsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBUeXBlIG9mIGVuZGluZ3Mgb24gdGhlIGVuZCBvZiBsaW5lcy4gUG9zc2libGUgdmFsdWVzOiBidXR0IChkZWZhdWx0KSwgcm91bmQsIHNxdWFyZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5saW5lQ2FwCgkqIEBwYXJhbSB7RE9NU3RyaW5nfSBzdHlsZSAtIFBvc3NpYmxlIHZhbHVlczogYnV0dCAoZGVmYXVsdCksIHJvdW5kLCBzcXVhcmUKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJbGluZUNhcDogZnVuY3Rpb24gKHN0eWxlKSB7CgoJCXRoaXMuY29udGV4dC5saW5lQ2FwID0gc3R5bGU7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU3BlY2lmaWVzIHdoZXJlIHRvIHN0YXJ0IGEgZGFzaGFycmF5IG9uIGEgbGluZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5saW5lRGFzaE9mZnNldAoJKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0IC0gU3BlY2lmaWVzIHdoZXJlIHRvIHN0YXJ0IGEgZGFzaGFycmF5IG9uIGEgbGluZS4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJbGluZURhc2hPZmZzZXQ6IGZ1bmN0aW9uIChvZmZzZXQpIHsKCgkJdGhpcy5jb250ZXh0LmxpbmVEYXNoT2Zmc2V0ID0gb2Zmc2V0OwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIERlZmluZXMgdGhlIHR5cGUgb2YgY29ybmVycyB3aGVyZSB0d28gbGluZXMgbWVldC4gUG9zc2libGUgdmFsdWVzOiByb3VuZCwgYmV2ZWwsIG1pdGVyIChkZWZhdWx0KQoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmxpbmVKb2luCgkqIEBwYXJhbSB7RE9NU3RyaW5nfSBqb2luIC0gUG9zc2libGUgdmFsdWVzOiByb3VuZCwgYmV2ZWwsIG1pdGVyIChkZWZhdWx0KQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglsaW5lSm9pbjogZnVuY3Rpb24gKGpvaW4pIHsKCgkJdGhpcy5jb250ZXh0LmxpbmVKb2luID0gam9pbjsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBXaWR0aCBvZiBsaW5lcy4gRGVmYXVsdCAxLjAKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5saW5lV2lkdGgKCSogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgbGluZXMuIERlZmF1bHQgMS4wCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWxpbmVXaWR0aDogZnVuY3Rpb24gKHdpZHRoKSB7CgoJCXRoaXMuY29udGV4dC5saW5lV2lkdGggPSB3aWR0aDsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBEZWZhdWx0IDEwLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLm1pdGVyTGltaXQKCSogQHBhcmFtIHtudW1iZXJ9IGxpbWl0IC0gRGVmYXVsdCAxMC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJbWl0ZXJMaW1pdDogZnVuY3Rpb24gKGxpbWl0KSB7CgoJCXRoaXMuY29udGV4dC5taXRlckxpbWl0ID0gbGltaXQ7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwlnZXRJbWFnZURhdGEKCS8vCWdldExpbmVEYXNoCgkvLwlpc1BvaW50SW5QYXRoCgkvLwlpc1BvaW50SW5TdHJva2UKCgkvKioKCSogQ29ubmVjdHMgdGhlIGxhc3QgcG9pbnQgaW4gdGhlIHN1YnBhdGggdG8gdGhlIHgsIHkgY29vcmRpbmF0ZXMgd2l0aCBhIHN0cmFpZ2h0IGxpbmUuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEubGluZVRvCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGVuZCBvZiB0aGUgbGluZS4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZW5kIG9mIHRoZSBsaW5lLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglsaW5lVG86IGZ1bmN0aW9uICh4LCB5KSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQubGluZVRvKHgsIHkpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLy8JbWVhc3VyZVRleHQKCgkvKioKCSogTW92ZXMgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIGEgbmV3IHN1YnBhdGggdG8gdGhlICh4LCB5KSBjb29yZGluYXRlcy4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5tb3ZlVG8KCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBwb2ludC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJbW92ZVRvOiBmdW5jdGlvbiAoeCwgeSkgewoKCQl0aGlzLmNvbnRleHQubW92ZVRvKHgsIHkpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLy8JcHV0SW1hZ2VEYXRhCgoJLyoqCgkqIERyYXdzIGEgcXVhZHJhdGljIGN1cnZlIGZyb20gdGhlIGN1cnJlbnQgZHJhd2luZyBwb2ludCB0byAoeCwgeSkgdXNpbmcgdGhlIGNvbnRyb2wgcG9pbnQgKGNweCwgY3B5KS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5xdWFkcmF0aWNDdXJ2ZVRvCgkqIEBwYXJhbSB7TnVtYmVyfSBjcHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb250cm9sIHBvaW50LgoJKiBAcGFyYW0ge051bWJlcn0gY3B5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29udHJvbCBwb2ludC4KCSogQHBhcmFtIHtOdW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7TnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglxdWFkcmF0aWNDdXJ2ZVRvOiBmdW5jdGlvbihjcHgsIGNweSwgeCwgeSkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnF1YWRyYXRpY0N1cnZlVG8oY3B4LCBjcHksIHgsIHkpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIERyYXdzIGEgcmVjdGFuZ2xlIGF0ICh4LCB5KSBwb3NpdGlvbiB3aG9zZSBzaXplIGlzIGRldGVybWluZWQgYnkgd2lkdGggYW5kIGhlaWdodC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5yZWN0CgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlcyB3aWR0aC4KCSogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSByZWN0YW5nbGVzIGhlaWdodC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJcmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5yZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwoJCXJldHVybiB0aGlzOwoKCX0sCgkKCS8qKgoJKiBSZXN0b3JlcyB0aGUgZHJhd2luZyBzdHlsZSBzdGF0ZSB0byB0aGUgbGFzdCBlbGVtZW50IG9uIHRoZSAnc3RhdGUgc3RhY2snIHNhdmVkIGJ5IHNhdmUoKS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5yZXN0b3JlCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXJlc3RvcmU6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5yZXN0b3JlKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogUm90YXRlcyB0aGUgZHJhd2luZyBjb250ZXh0IHZhbHVlcyBieSByIHJhZGlhbnMuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucm90YXRlCgkqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBnaXZlbiBpbiByYWRpYW5zLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglyb3RhdGU6IGZ1bmN0aW9uIChhbmdsZSkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnJvdGF0ZShhbmdsZSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0cyB0aGUgc3Ryb2tlIHN0eWxlIGZvciB0aGUgY3VycmVudCBzdWItcGF0aC4gTGlrZSBhbGwgZHJhd2luZyBtZXRob2RzLCB0aGlzIGNhbiBiZSBjaGFpbmVkLCBzbyB5b3UgY2FuIGRlZmluZQoJKiB0aGUgc3Ryb2tlIHN0eWxlIGFuZCBjb2xvciBpbiBhIHNpbmdsZSBsaW5lIG9mIGNvZGUgbGlrZSBzbzoKCSoKCSogICAgICBgYGBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDgsInJvdW5kIikuYmVnaW5TdHJva2UoIiNGMDAiKTtgYGAKCSoKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zZXRTdHJva2VTdHlsZQoJKiBAcGFyYW0ge251bWJlcn0gdGhpY2tuZXNzIC0gVGhlIHdpZHRoIG9mIHRoZSBzdHJva2UuCgkqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2NhcHM9MF0gLSBJbmRpY2F0ZXMgdGhlIHR5cGUgb2YgY2FwcyB0byB1c2UgYXQgdGhlIGVuZCBvZiBsaW5lcy4gT25lIG9mIGJ1dHQsIHJvdW5kLCBvciBzcXVhcmUuIERlZmF1bHRzIHRvICJidXR0Ii4gQWxzbyBhY2NlcHRzIHRoZSB2YWx1ZXMgMCAoYnV0dCksIDEgKHJvdW5kKSwgYW5kIDIgKHNxdWFyZSkgZm9yIHVzZSB3aXRoIGhlIHRpbnkgQVBJLgoJKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtqb2ludHM9MF0gU3BlY2lmaWVzIHRoZSB0eXBlIG9mIGpvaW50cyB0aGF0IHNob3VsZCBiZSB1c2VkIHdoZXJlIHR3byBsaW5lcyBtZWV0LiBPbmUgb2YgYmV2ZWwsIHJvdW5kLCBvciBtaXRlci4gRGVmYXVsdHMgdG8gIm1pdGVyIi4gQWxzbyBhY2NlcHRzIHRoZSB2YWx1ZXMgMCAobWl0ZXIpLCAxIChyb3VuZCksIGFuZCAyIChiZXZlbCkgZm9yIHVzZSB3aXRoIHRoZSB0aW55IEFQSS4KCSogQHBhcmFtIHtudW1iZXJ9IFttaXRlckxpbWl0PTEwXSAtIElmIGpvaW50cyBpcyBzZXQgdG8gIm1pdGVyIiwgdGhlbiB5b3UgY2FuIHNwZWNpZnkgYSBtaXRlciBsaW1pdCByYXRpbyB3aGljaCBjb250cm9scyBhdCB3aGF0IHBvaW50IGEgbWl0ZXJlZCBqb2ludCB3aWxsIGJlIGNsaXBwZWQuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gW2lnbm9yZVNjYWxlPWZhbHNlXSAtIElmIHRydWUsIHRoZSBzdHJva2Ugd2lsbCBiZSBkcmF3biBhdCB0aGUgc3BlY2lmaWVkIHRoaWNrbmVzcyByZWdhcmRsZXNzIG9mIGFjdGl2ZSB0cmFuc2Zvcm1hdGlvbnMuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXNldFN0cm9rZVN0eWxlOiBmdW5jdGlvbiAodGhpY2tuZXNzLCBjYXBzLCBqb2ludHMsIG1pdGVyTGltaXQsIGlnbm9yZVNjYWxlKSB7CgoJCWlmICh0eXBlb2YgdGhpY2tuZXNzID09PSAndW5kZWZpbmVkJykgeyB0aGlja25lc3MgPSAxOyB9CgkJaWYgKHR5cGVvZiBjYXBzID09PSAndW5kZWZpbmVkJykgeyBjYXBzID0gJ2J1dHQnOyB9CgkJaWYgKHR5cGVvZiBqb2ludHMgPT09ICd1bmRlZmluZWQnKSB7IGpvaW50cyA9ICdtaXRlcic7IH0KCQlpZiAodHlwZW9mIG1pdGVyTGltaXQgPT09ICd1bmRlZmluZWQnKSB7IG1pdGVyTGltaXQgPSAxMDsgfQoKCQl0aGlzLmxpbmVXaWR0aCh0aGlja25lc3MpOwoJCXRoaXMubGluZUNhcChjYXBzKTsKCQl0aGlzLmxpbmVKb2luKGpvaW50cyk7CgkJdGhpcy5taXRlckxpbWl0KG1pdGVyTGltaXQpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTYXZlcyB0aGUgY3VycmVudCBkcmF3aW5nIHN0eWxlIHN0YXRlIHVzaW5nIGEgc3RhY2sgc28geW91IGNhbiByZXZlcnQgYW55IGNoYW5nZSB5b3UgbWFrZSB0byBpdCB1c2luZyByZXN0b3JlKCkuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc2F2ZQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglzYXZlOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuc2F2ZSgpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNjYWxlcyB0aGUgY3VycmVudCBkcmF3aW5nIGNvbnRleHQuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc2NhbGUKCSogQHBhcmFtIHtudW1iZXJ9IHgKCSogQHBhcmFtIHtudW1iZXJ9IHkKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc2NhbGU6IGZ1bmN0aW9uICh4LCB5KSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuc2NhbGUoeCwgeSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc2Nyb2xsUGF0aEludG9WaWV3CgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXNjcm9sbFBhdGhJbnRvVmlldzogZnVuY3Rpb24gKCkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnNjcm9sbFBhdGhJbnRvVmlldygpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLy8Jc2V0TGluZURhc2gKCS8vCXNldFRyYW5zZm9ybQoKCS8qKgoJKiBTdHJva2VzIHRoZSBzdWJwYXRocyB3aXRoIHRoZSBjdXJyZW50IHN0cm9rZSBzdHlsZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zdHJva2UKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc3Ryb2tlOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogUGFpbnRzIGEgcmVjdGFuZ2xlIHdoaWNoIGhhcyBhIHN0YXJ0aW5nIHBvaW50IGF0ICh4LCB5KSBhbmQgaGFzIGEgdyB3aWR0aCBhbmQgYW4gaCBoZWlnaHQgb250byB0aGUgY2FudmFzLCB1c2luZyB0aGUgY3VycmVudCBzdHJva2Ugc3R5bGUuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc3Ryb2tlUmVjdAoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgZm9yIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgcmVjdGFuZ2xlLgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgZm9yIHRoZSBzdGFydGluZyBwb2ludCBvZiB0aGUgcmVjdGFuZ2xlLgoJKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgcmVjdGFuZ2xlcyB3aWR0aC4KCSogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSByZWN0YW5nbGVzIGhlaWdodC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc3Ryb2tlUmVjdDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQ29sb3Igb3Igc3R5bGUgdG8gdXNlIGZvciB0aGUgbGluZXMgYXJvdW5kIHNoYXBlcy4gRGVmYXVsdCAjMDAwIChibGFjaykuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuc3Ryb2tlU3R5bGUKCSogQHBhcmFtIHtzdHJpbmd9IHN0eWxlIC0gQ29sb3Igb3Igc3R5bGUgdG8gdXNlIGZvciB0aGUgbGluZXMgYXJvdW5kIHNoYXBlcy4gRGVmYXVsdCAjMDAwIChibGFjaykuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXN0cm9rZVN0eWxlOiBmdW5jdGlvbiAoc3R5bGUpIHsKCgkJdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gc3R5bGU7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwlzdHJva2VUZXh0CgkvLwl0cmFuc2Zvcm0KCS8vCXRyYW5zbGF0ZQoKCS8qKgoJKiBJZiB0aGUgZ2FtZSBpcyBydW5uaW5nIGluIFdlYkdMIHRoaXMgd2lsbCBwdXNoIHRoZSB0ZXh0dXJlIHVwIHRvIHRoZSBHUFUgaWYgaXQncyBkaXJ0eS4KCSogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBpZiB0aGUgQml0bWFwRGF0YSBpcyBiZWluZyB1c2VkIGJ5IGEgU3ByaXRlLCBvdGhlcndpc2UgeW91IG5lZWQgdG8gcmVtZW1iZXIgdG8gY2FsbCBpdCBpbiB5b3VyIHJlbmRlciBmdW5jdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5yZW5kZXIKCSovCglyZW5kZXI6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuX2RpcnR5KQoJCXsKCQkgICAgLy8gIE9ubHkgbmVlZGVkIGlmIHJ1bm5pbmcgaW4gV2ViR0wsIG90aGVyd2lzZSB0aGlzIGFycmF5IHdpbGwgbmV2ZXIgZ2V0IGNsZWFyZWQgZG93bgoJCSAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT0gUGhhc2VyLldFQkdMKQoJCSAgICB7CgkJICAgICAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLmJhc2VUZXh0dXJlKTsKCQkgICAgfQoKCQkJdGhpcy5fZGlydHkgPSBmYWxzZTsKCQl9CgoJfQoKfQoKLy8JRWFzZWxKUyBUaW55IEFQSSBlbXVsYXRpb24KCi8qKgoqIFNob3J0Y3V0IHRvIG1vdmVUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubW92ZVRvOwoKLyoqCiogU2hvcnRjdXQgdG8gbGluZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLm10CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5sdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5saW5lVG87CgovKioKKiBTaG9ydGN1dCB0byBhcmNUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXJjVG87CgovKioKKiBTaG9ydGN1dCB0byBiZXppZXJDdXJ2ZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJ0CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5idCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZXppZXJDdXJ2ZVRvOwoJCi8qKgoqIFNob3J0Y3V0IHRvIHF1YWRyYXRpY0N1cnZlVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnF0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnF1YWRyYXRpY0N1cnZlVG87CgkKLyoqCiogU2hvcnRjdXQgdG8gYXJjLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmEKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmEgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYXJjOwoKLyoqCiogU2hvcnRjdXQgdG8gcmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJlY3Q7CgkKLyoqCiogU2hvcnRjdXQgdG8gY2xvc2VQYXRoLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNwCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jcCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jbG9zZVBhdGg7CgovKioKKiBTaG9ydGN1dCB0byBjbGVhci4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNsZWFyOwoJCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luRmlsbC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5mCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5mID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luRmlsbDsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luTGluZWFyR3JhZGllbnRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5sZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpbkxpbmVhckdyYWRpZW50RmlsbDsKCQovKioKKiBTaG9ydGN1dCB0byBiZWdpblJhZGlhbEdyYWRpZW50RmlsbC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yZgoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5SYWRpYWxHcmFkaWVudEZpbGw7CgkKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5CaXRtYXBGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJmCiovCi8vUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luQml0bWFwRmlsbDsKCQovKioKKiBTaG9ydGN1dCB0byBlbmRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lbmRGaWxsOwoKLyoqCiogU2hvcnRjdXQgdG8gc2V0U3Ryb2tlU3R5bGUuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc3MKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnNzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnNldFN0cm9rZVN0eWxlOwoJCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luU3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5TdHJva2U7CgkKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5scwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubHMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5MaW5lYXJHcmFkaWVudFN0cm9rZTsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2U7CgkKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5CaXRtYXBTdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnMKKi8KLy8gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJzID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luQml0bWFwU3Ryb2tlOwoJCi8qKgoqIFNob3J0Y3V0IHRvIGVuZFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lcwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZXMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZW5kU3Ryb2tlOwoJCi8qKgoqIFNob3J0Y3V0IHRvIHJlY3QuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHIKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRyID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJlY3Q7CgkKLyoqCiogU2hvcnRjdXQgdG8gZHJhd1JvdW5kUmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5ycgoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHJhd1JvdW5kUmVjdDsKCQovKioKKiBTaG9ydGN1dCB0byBkcmF3Um91bmRSZWN0Q29tcGxleC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yYwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHJhd1JvdW5kUmVjdENvbXBsZXg7CgovKioKKiBTaG9ydGN1dCB0byBkcmF3Q2lyY2xlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRjCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kYyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5jaXJjbGU7CgkKLyoqCiogU2hvcnRjdXQgdG8gZHJhd0VsbGlwc2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGUKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRlID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVsbGlwc2U7CgkKLyoqCiogU2hvcnRjdXQgdG8gZHJhd1BvbHlTdGFyLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRwCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3UG9seVN0YXI7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGUgYSBuZXcgYFNwcml0ZWAgb2JqZWN0LiBTcHJpdGVzIGFyZSB0aGUgbGlmZWJsb29kIG9mIHlvdXIgZ2FtZSwgdXNlZCBmb3IgbmVhcmx5IGV2ZXJ5dGhpbmcgdmlzdWFsLgoqIEF0IGl0cyBtb3N0IGJhc2ljIGEgU3ByaXRlIGNvbnNpc3RzIG9mIGEgc2V0IG9mIGNvb3JkaW5hdGVzIGFuZCBhIHRleHR1cmUgdGhhdCBpcyByZW5kZXJlZCB0byB0aGUgY2FudmFzLgoqIFRoZXkgYWxzbyBjb250YWluIGFkZGl0aW9uYWwgcHJvcGVydGllcyBhbGxvd2luZyBmb3IgcGh5c2ljcyBtb3Rpb24gKHZpYSBTcHJpdGUuYm9keSksIGlucHV0IGhhbmRsaW5nICh2aWEgU3ByaXRlLmlucHV0KSwKKiBldmVudHMgKHZpYSBTcHJpdGUuZXZlbnRzKSwgYW5pbWF0aW9uICh2aWEgU3ByaXRlLmFuaW1hdGlvbnMpLCBjYW1lcmEgY3VsbGluZyBhbmQgbW9yZS4gUGxlYXNlIHNlZSB0aGUgRXhhbXBsZXMgZm9yIHVzZSBjYXNlcy4KKgoqIEBjbGFzcyBQaGFzZXIuU3ByaXRlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBmcmFtZSAtIElmIHRoaXMgU3ByaXRlIGlzIHVzaW5nIHBhcnQgb2YgYSBzcHJpdGUgc2hlZXQgb3IgdGV4dHVyZSBhdGxhcyB5b3UgY2FuIHNwZWNpZnkgdGhlIGV4YWN0IGZyYW1lIHRvIHVzZSBieSBnaXZpbmcgYSBzdHJpbmcgb3IgbnVtZXJpYyBpbmRleC4KKi8KUGhhc2VyLlNwcml0ZSA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCBrZXksIGZyYW1lKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICBrZXkgPSBrZXkgfHwgbnVsbDsKICAgIGZyYW1lID0gZnJhbWUgfHwgbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwogCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBJZiBleGlzdHMgPSBmYWxzZSB0aGVuIHRoZSBTcHJpdGUgaXNuJ3QgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3Agb3IgcGh5c2ljcyBzdWJzeXN0ZW0gYXQgYWxsLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKCgkvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGl2ZSAtIFRoaXMgaXMgYSBoYW5keSBsaXR0bGUgdmFyIHlvdXIgZ2FtZSBjYW4gdXNlIHRvIGRldGVybWluZSBpZiBhIHNwcml0ZSBpcyBhbGl2ZSBvciBub3QsIGl0IGRvZXNuJ3QgZWZmZWN0IHJlbmRlcmluZy4KICAgCSogQGRlZmF1bHQKICAgCSovCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKCgkvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR3JvdXB9IGdyb3VwIC0gVGhlIHBhcmVudCBHcm91cCBvZiB0aGlzIFNwcml0ZS4gVGhpcyBpcyB1c3VhbGx5IHNldCBhZnRlciBTcHJpdGUgaW5zdGFudGlhdGlvbiBieSB0aGUgcGFyZW50LgogICAJKi8KICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgdXNlciBkZWZpbmVkIG5hbWUgZ2l2ZW4gdG8gdGhpcyBTcHJpdGUuCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgY29uc3QgdHlwZSBvZiB0aGlzIG9iamVjdC4KICAgICogQGRlZmF1bHQKCSovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuU1BSSVRFOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcmVuZGVyT3JkZXJJRCAtIFVzZWQgYnkgdGhlIFJlbmRlcmVyIGFuZCBJbnB1dCBNYW5hZ2VyIHRvIGNvbnRyb2wgcGlja2luZyBvcmRlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnJlbmRlck9yZGVySUQgPSAtMTsKCiAgICAvKioKICAgICogSWYgeW91IHdvdWxkIGxpa2UgdGhlIFNwcml0ZSB0byBoYXZlIGEgbGlmZXNwYW4gb25jZSAnYm9ybicgeW91IGNhbiBzZXQgdGhpcyB0byBhIHBvc2l0aXZlIHZhbHVlLiBIYW5keSBmb3IgcGFydGljbGVzLCBidWxsZXRzLCBldGMuCgkqIFRoZSBsaWZlc3BhbiBpcyBkZWNyZW1lbnRlZCBieSBnYW1lLnRpbWUuZWxhcHNlZCBlYWNoIHVwZGF0ZSwgb25jZSBpdCByZWFjaGVzIHplcm8gdGhlIGtpbGwoKSBmdW5jdGlvbiBpcyBjYWxsZWQuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsaWZlc3BhbiAtIFRoZSBsaWZlc3BhbiBvZiB0aGUgU3ByaXRlIChpbiBtcykgYmVmb3JlIGl0IHdpbGwgYmUga2lsbGVkLgoJKiBAZGVmYXVsdAoJKi8gICAgCiAgICB0aGlzLmxpZmVzcGFuID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtFdmVudHN9IGV2ZW50cyAtIFRoZSBFdmVudHMgeW91IGNhbiBzdWJzY3JpYmUgdG8gdGhhdCBhcmUgZGlzcGF0Y2hlZCB3aGVuIGNlcnRhaW4gdGhpbmdzIGhhcHBlbiBvbiB0aGlzIFNwcml0ZSBvciBpdHMgY29tcG9uZW50cy4KICAgICovCiAgICB0aGlzLmV2ZW50cyA9IG5ldyBQaGFzZXIuRXZlbnRzKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5BbmltYXRpb25NYW5hZ2VyfSBhbmltYXRpb25zIC0gVGhpcyBtYW5hZ2VzIGFuaW1hdGlvbnMgb2YgdGhlIHNwcml0ZS4gWW91IGNhbiBtb2RpZnkgYW5pbWF0aW9ucyB0aHJvdWdoIGl0IChzZWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIpCiAgICAqLwogICAgdGhpcy5hbmltYXRpb25zID0gbmV3IFBoYXNlci5BbmltYXRpb25NYW5hZ2VyKHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0lucHV0SGFuZGxlcn0gaW5wdXQgLSBUaGUgSW5wdXQgSGFuZGxlciBDb21wb25lbnQuCiAgICAqLwogICAgdGhpcy5pbnB1dCA9IG5ldyBQaGFzZXIuSW5wdXRIYW5kbGVyKHRoaXMpOwoKICAgIC8qKgogICAgKiAgQHByb3BlcnR5IHtzdHJpbmd8UGhhc2VyLlJlbmRlclRleHR1cmV8UGhhc2VyLkJpdG1hcERhdGF8UElYSS5UZXh0dXJlfSBrZXkgLSBUaGlzIGlzIHRoZSBpbWFnZSBvciB0ZXh0dXJlIHVzZWQgYnkgdGhlIFNwcml0ZSBkdXJpbmcgcmVuZGVyaW5nLiBJdCBjYW4gYmUgYSBzdHJpbmcgd2hpY2ggaXMgYSByZWZlcmVuY2UgdG8gdGhlIENhY2hlIGVudHJ5LCBvciBhbiBpbnN0YW5jZSBvZiBhIFJlbmRlclRleHR1cmUsIEJpdG1hcERhdGEgb3IgUElYSS5UZXh0dXJlLgogICAgKi8KICAgIHRoaXMua2V5ID0ga2V5OwoKICAgIC8qKgogICAgKiAgQHByb3BlcnR5IHtQaGFzZXIuRnJhbWV9IGN1cnJlbnRGcmFtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgZGlzcGxheWVkIGZyYW1lLgogICAgKi8KICAgIHRoaXMuY3VycmVudEZyYW1lID0gbnVsbDsKCiAgICBpZiAoa2V5IGluc3RhbmNlb2YgUGhhc2VyLlJlbmRlclRleHR1cmUpCiAgICB7CiAgICAgICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBrZXkpOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRUZXh0dXJlRnJhbWUoa2V5Lm5hbWUpOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUGhhc2VyLkJpdG1hcERhdGEpCiAgICB7CiAgICAgICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBrZXkudGV4dHVyZSwga2V5LnRleHR1cmVGcmFtZSk7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0ga2V5LnRleHR1cmVGcmFtZTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSBpbnN0YW5jZW9mIFBJWEkuVGV4dHVyZSkKICAgIHsKICAgICAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIGtleSk7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gZnJhbWU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgaWYgKGtleSA9PT0gbnVsbCB8fCB0eXBlb2Yga2V5ID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGtleSA9ICdfX2RlZmF1bHQnOwogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycgJiYgdGhpcy5nYW1lLmNhY2hlLmNoZWNrSW1hZ2VLZXkoa2V5KSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGtleSA9ICdfX21pc3NpbmcnOwogICAgICAgICAgICB0aGlzLmtleSA9IGtleTsKICAgICAgICB9CgogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTcHJpdGVTaGVldChrZXkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hbmltYXRpb25zLmxvYWRGcmFtZURhdGEodGhpcy5nYW1lLmNhY2hlLmdldEZyYW1lRGF0YShrZXkpKTsKCiAgICAgICAgICAgIGlmIChmcmFtZSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWUoa2V5KTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAqIFRoZSByZWN0YW5ndWxhciBhcmVhIGZyb20gdGhlIHRleHR1cmUgdGhhdCB3aWxsIGJlIHJlbmRlcmVkLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IHRleHR1cmVSZWdpb24KICAgICovCiAgICB0aGlzLnRleHR1cmVSZWdpb24gPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh0aGlzLnRleHR1cmUuZnJhbWUueCwgdGhpcy50ZXh0dXJlLmZyYW1lLnksIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aCwgdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodCk7CgogICAgLyoqCiAgICAqIFRoZSBhbmNob3Igc2V0cyB0aGUgb3JpZ2luIHBvaW50IG9mIHRoZSB0ZXh0dXJlLgogICAgKiBUaGUgZGVmYXVsdCBpcyAwLDAgdGhpcyBtZWFucyB0aGUgdGV4dHVyZXMgb3JpZ2luIGlzIHRoZSB0b3AgbGVmdCAKICAgICogU2V0dGluZyB0aGFuIGFuY2hvciB0byAwLjUsMC41IG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgY2VudGVyZWQKICAgICogU2V0dGluZyB0aGUgYW5jaG9yIHRvIDEsMSB3b3VsZCBtZWFuIHRoZSB0ZXh0dXJlcyBvcmlnaW4gcG9pbnRzIHdpbGwgYmUgdGhlIGJvdHRvbSByaWdodAogICAgKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gVGhlIGFuY2hvciBhcm91bmQgd2l0aCBTcHJpdGUgcm90YXRpb24gYW5kIHNjYWxpbmcgdGFrZXMgcGxhY2UuCiAgICAqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIG9mIHRoaXMgU3ByaXRlLgogICAgKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSBvZiB0aGlzIFNwcml0ZS4KICAgICovCiAgICB0aGlzLnkgPSB5OwoKCXRoaXMucG9zaXRpb24ueCA9IHg7Cgl0aGlzLnBvc2l0aW9uLnkgPSB5OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gd29ybGQgLSBUaGUgd29ybGQgY29vcmRpbmF0ZXMgb2YgdGhpcyBTcHJpdGUuIFRoaXMgZGlmZmVycyBmcm9tIHRoZSB4L3kgY29vcmRpbmF0ZXMgd2hpY2ggYXJlIHJlbGF0aXZlIHRvIHRoZSBTcHJpdGVzIGNvbnRhaW5lci4KICAgICovCiAgICB0aGlzLndvcmxkID0gbmV3IFBoYXNlci5Qb2ludCh4LCB5KTsKCiAgICAvKioKICAgICogU2hvdWxkIHRoaXMgU3ByaXRlIGJlIGF1dG9tYXRpY2FsbHkgY3VsbGVkIGlmIG91dCBvZiByYW5nZSBvZiB0aGUgY2FtZXJhPwogICAgKiBBIGN1bGxlZCBzcHJpdGUgaGFzIGl0cyByZW5kZXJhYmxlIHByb3BlcnR5IHNldCB0byAnZmFsc2UnLgogICAgKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1dG9DdWxsIC0gQSBmbGFnIGluZGljYXRpbmcgaWYgdGhlIFNwcml0ZSBzaG91bGQgYmUgYXV0b21hdGljYWxseSBjYW1lcmEgY3VsbGVkIG9yIG5vdC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmF1dG9DdWxsID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIFRoZSBzY2FsZSBvZiB0aGUgU3ByaXRlIHdoZW4gcmVuZGVyZWQuIEJ5IGRlZmF1bHQgaXQncyBzZXQgdG8gMSAobm8gc2NhbGUpLiBZb3UgY2FuIG1vZGlmeSBpdCB2aWEgc2NhbGUueCBvciBzY2FsZS55IG9yIHNjYWxlLnNldFRvKHgsIHkpLiBBIHZhbHVlIG9mIDEgbWVhbnMgbm8gY2hhbmdlIHRvIHRoZSBzY2FsZSwgMC41IG1lYW5zICJoYWxmIHRoZSBzaXplIiwgMiBtZWFucyAidHdpY2UgdGhlIHNpemUiLCBldGMuCiAgICAqLyAKICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gX2NhY2hlIC0gQSBtaW5pIGNhY2hlIGZvciBzdG9yaW5nIGFsbCBvZiB0aGUgY2FsY3VsYXRlZCB2YWx1ZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2FjaGUgPSB7IAoKICAgICAgICBkaXJ0eTogZmFsc2UsCgogICAgICAgIC8vICBUcmFuc2Zvcm0gY2FjaGUKICAgICAgICBhMDA6IC0xLCBhMDE6IC0xLCBhMDI6IC0xLCBhMTA6IC0xLCBhMTE6IC0xLCBhMTI6IC0xLCBpZDogLTEsIAoKICAgICAgICAvLyAgSW5wdXQgc3BlY2lmaWMgdHJhbnNmb3JtIGNhY2hlCiAgICAgICAgaTAxOiAtMSwgaTEwOiAtMSwgaWRpOiAtMSwKCiAgICAgICAgLy8gIEJvdW5kcyBjaGVjawogICAgICAgIGxlZnQ6IG51bGwsIHJpZ2h0OiBudWxsLCB0b3A6IG51bGwsIGJvdHRvbTogbnVsbCwgCgogICAgICAgIC8vICBkZWx0YSBjYWNoZQogICAgICAgIHByZXZYOiB4LCBwcmV2WTogeSwKCiAgICAgICAgLy8gIFRoZSBwcmV2aW91cyBjYWxjdWxhdGVkIHBvc2l0aW9uCiAgICAgICAgeDogLTEsIHk6IC0xLAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCBzY2FsZSB2YWx1ZXMgYmFzZWQgb24gdGhlIHdvcmxkVHJhbnNmb3JtCiAgICAgICAgc2NhbGVYOiAxLCBzY2FsZVk6IDEsCgogICAgICAgIC8vICBUaGUgd2lkdGgvaGVpZ2h0IG9mIHRoZSBpbWFnZSwgYmFzZWQgb24gdGhlIHVuLW1vZGlmaWVkIGZyYW1lIHNpemUgbXVsdGlwbGllZCBieSB0aGUgZmluYWwgY2FsY3VsYXRlZCBzY2FsZSBzaXplCiAgICAgICAgd2lkdGg6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVXLCBoZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVILAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCB3aWR0aC9oZWlnaHQgb2YgdGhlIGltYWdlIGlmIGZyb20gYSB0cmltbWVkIGF0bGFzLCBtdWx0aXBsaWVkIGJ5IHRoZSBmaW5hbCBjYWxjdWxhdGVkIHNjYWxlIHNpemUKICAgICAgICBoYWxmV2lkdGg6IE1hdGguZmxvb3IodGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcgLyAyKSwgaGFsZkhlaWdodDogTWF0aC5mbG9vcih0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplSCAvIDIpLAoKICAgICAgICAvLyAgVGhlIHdpZHRoL2hlaWdodCBvZiB0aGUgaW1hZ2UsIGJhc2VkIG9uIHRoZSB1bi1tb2RpZmllZCBmcmFtZSBzaXplIG11bHRpcGxpZWQgYnkgdGhlIGZpbmFsIGNhbGN1bGF0ZWQgc2NhbGUgc2l6ZQogICAgICAgIGNhbGNXaWR0aDogLTEsIGNhbGNIZWlnaHQ6IC0xLAoKICAgICAgICAvLyAgVGhlIGN1cnJlbnQgZnJhbWUgZGV0YWlscwogICAgICAgIC8vIGZyYW1lSUQ6IHRoaXMuY3VycmVudEZyYW1lLnV1aWQsIGZyYW1lV2lkdGg6IHRoaXMuY3VycmVudEZyYW1lLndpZHRoLCBmcmFtZUhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0LAogICAgICAgIGZyYW1lSUQ6IC0xLCBmcmFtZVdpZHRoOiB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aCwgZnJhbWVIZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLmhlaWdodCwKCiAgICAgICAgLy8gIElmIHRoaXMgc3ByaXRlIHZpc2libGUgdG8gdGhlIGNhbWVyYSAocmVnYXJkbGVzcyBvZiBiZWluZyBzZXQgdG8gdmlzaWJsZSBvciBub3QpCiAgICAgICAgY2FtZXJhVmlzaWJsZTogdHJ1ZSwKCiAgICAgICAgLy8gIENyb3AgY2FjaGUKICAgICAgICBjcm9wWDogMCwgY3JvcFk6IDAsIGNyb3BXaWR0aDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcsIGNyb3BIZWlnaHQ6IHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVICgogICAgfTsKICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gb2Zmc2V0IC0gQ29ybmVyIHBvaW50IGRlZmF1bHRzLiBTaG91bGQgbm90IHR5cGljYWxseSBiZSBtb2RpZmllZC4KICAgICovICAgIAogICAgdGhpcy5vZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNlbnRlciAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgY2VudGVyIGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmNlbnRlciA9IG5ldyBQaGFzZXIuUG9pbnQoeCArIE1hdGguZmxvb3IodGhpcy5fY2FjaGUud2lkdGggLyAyKSwgeSArIE1hdGguZmxvb3IodGhpcy5fY2FjaGUuaGVpZ2h0IC8gMikpOwogICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdG9wTGVmdCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgdG9wIGxlZnQgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMudG9wTGVmdCA9IG5ldyBQaGFzZXIuUG9pbnQoeCwgeSk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdG9wUmlnaHQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIHRvcCByaWdodCBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy50b3BSaWdodCA9IG5ldyBQaGFzZXIuUG9pbnQoeCArIHRoaXMuX2NhY2hlLndpZHRoLCB5KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3R0b21SaWdodCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgYm90dG9tIHJpZ2h0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmJvdHRvbVJpZ2h0ID0gbmV3IFBoYXNlci5Qb2ludCh4ICsgdGhpcy5fY2FjaGUud2lkdGgsIHkgKyB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGJvdHRvbUxlZnQgLSBBIFBvaW50IGNvbnRhaW5pbmcgdGhlIGJvdHRvbSBsZWZ0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLmJvdHRvbUxlZnQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkgKyB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgCiAgICAvKioKICAgICogVGhpcyBSZWN0YW5nbGUgb2JqZWN0IGZ1bGx5IGVuY29tcGFzc2VzIHRoZSBTcHJpdGUgYW5kIGlzIHVwZGF0ZWQgaW4gcmVhbC10aW1lLgogICAgKiBUaGUgYm91bmRzIGlzIHRoZSBmdWxsIGJvdW5kaW5nIGFyZWEgYWZ0ZXIgcm90YXRpb24gYW5kIHNjYWxlIGhhdmUgYmVlbiB0YWtlbiBpbnRvIGFjY291bnQuIEl0IHNob3VsZCBub3QgYmUgbW9kaWZpZWQgZGlyZWN0bHkuCiAgICAqIEl0J3MgdXNlZCBmb3IgQ2FtZXJhIGN1bGxpbmcgYW5kIHBoeXNpY3MgYm9keSBhbGlnbm1lbnQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gYm91bmRzCiAgICAqLwogICAgdGhpcy5ib3VuZHMgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh4LCB5LCB0aGlzLl9jYWNoZS53aWR0aCwgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBCeSBkZWZhdWx0IFNwcml0ZXMgaGF2ZSBhIFBoYXNlci5QaHlzaWNzIEJvZHkgYXR0YWNoZWQgdG8gdGhlbS4gWW91IGNhbiBvcGVyYXRlIHBoeXNpY3MgYWN0aW9ucyB2aWEgdGhpcyBwcm9wZXJ0eSwgb3IgbnVsbCBpdCB0byBza2lwIGFsbCBwaHlzaWNzIHVwZGF0ZXMuCiAgICAqLwogICAgdGhpcy5ib2R5ID0gbmV3IFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5KHRoaXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVhbHRoIC0gSGVhbHRoIHZhbHVlLiBVc2VkIGluIGNvbWJpbmF0aW9uIHdpdGggZGFtYWdlKCkgdG8gYWxsb3cgZm9yIHF1aWNrIGtpbGxpbmcgb2YgU3ByaXRlcy4KICAgICovICAgIAogICAgdGhpcy5oZWFsdGggPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGluV29ybGQgLSBUaGlzIHZhbHVlIGlzIHNldCB0byB0cnVlIGlmIHRoZSBTcHJpdGUgaXMgcG9zaXRpb25lZCB3aXRoaW4gdGhlIFdvcmxkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgdGhpcy5pbldvcmxkID0gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKHRoaXMuYm91bmRzLCB0aGlzLmdhbWUud29ybGQuYm91bmRzKTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbldvcmxkVGhyZXNob2xkIC0gQSB0aHJlc2hvbGQgdmFsdWUgYXBwbGllZCB0byB0aGUgaW5Xb3JsZCBjaGVjay4gSWYgeW91IGRvbid0IHdhbnQgYSBTcHJpdGUgdG8gYmUgY29uc2lkZXJlZCAib3V0IG9mIHRoZSB3b3JsZCIgdW50aWwgYXQgbGVhc3QgMTAwcHggYXdheSBmb3IgZXhhbXBsZSB0aGVuIHNldCBpdCB0byAxMDAuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pbldvcmxkVGhyZXNob2xkID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvdXRPZkJvdW5kc0tpbGwgLSBJZiB0cnVlIHRoZSBTcHJpdGUgaXMga2lsbGVkIGFzIHNvb24gYXMgU3ByaXRlLmluV29ybGQgaXMgZmFsc2UuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vdXRPZkJvdW5kc0tpbGwgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX291dE9mQm91bmRzRmlyZWQgLSBJbnRlcm5hbCBmbGFnLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQSBTcHJpdGUgdGhhdCBpcyBmaXhlZCB0byB0aGUgY2FtZXJhIGlnbm9yZXMgdGhlIHBvc2l0aW9uIG9mIGFueSBhbmNlc3RvcnMgaW4gdGhlIGRpc3BsYXkgbGlzdCBhbmQgdXNlcyBpdHMgeC95IGNvb3JkaW5hdGVzIGFzIG9mZnNldHMgZnJvbSB0aGUgdG9wIGxlZnQgb2YgdGhlIGNhbWVyYS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXhlZFRvQ2FtZXJhIC0gRml4ZXMgdGhpcyBTcHJpdGUgdG8gdGhlIENhbWVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpeGVkVG9DYW1lcmEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNhbWVyYU9mZnNldCAtIElmIHRoaXMgU3ByaXRlIGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgdGhlbiB1c2UgdGhpcyBQb2ludCB0byBzcGVjaWZ5IGhvdyBmYXIgYXdheSBmcm9tIHRoZSBDYW1lcmEgeC95IGl0J3MgcmVuZGVyZWQuCiAgICAqLwogICAgdGhpcy5jYW1lcmFPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBZb3UgY2FuIGNyb3AgdGhlIFNwcml0ZXMgdGV4dHVyZSBieSBtb2RpZnlpbmcgdGhlIGNyb3AgcHJvcGVydGllcy4gRm9yIGV4YW1wbGUgY3JvcC53aWR0aCA9IDUwIHdvdWxkIHNldCB0aGUgU3ByaXRlIHRvIG9ubHkgcmVuZGVyIDUwcHggd2lkZS4KICAgICogVGhlIGNyb3AgaXMgb25seSBhcHBsaWVkIGlmIHlvdSBoYXZlIHNldCBTcHJpdGUuY3JvcEVuYWJsZWQgdG8gdHJ1ZS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBjcm9wIC0gVGhlIGNyb3AgUmVjdGFuZ2xlIGFwcGxpZWQgdG8gdGhlIFNwcml0ZSB0ZXh0dXJlIGJlZm9yZSByZW5kZXJpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgdGhpcy5fY2FjaGUud2lkdGgsIHRoaXMuX2NhY2hlLmhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3JvcEVuYWJsZWQgLSBJZiB0cnVlIHRoZSBTcHJpdGUuY3JvcCBwcm9wZXJ0eSBpcyB1c2VkIHRvIGNyb3AgdGhlIHRleHR1cmUgYmVmb3JlIHJlbmRlci4gU2V0IHRvIGZhbHNlIHRvIGRpc2FibGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jcm9wRW5hYmxlZCA9IGZhbHNlOwoKICAgIHRoaXMudXBkYXRlQ2FjaGUoKTsKICAgIHRoaXMudXBkYXRlQm91bmRzKCk7Cgp9OwoKLy8gIE5lZWRlZCB0byBrZWVwIHRoZSBQSVhJLlNwcml0ZSBjb25zdHJ1Y3RvciBpbiB0aGUgcHJvdG90eXBlIGNoYWluIChhcyB0aGUgY29yZSBwaXhpIHJlbmRlcmVyIHVzZXMgYW4gaW5zdGFuY2VvZiBjaGVjayBzYWRseSkKUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlNwcml0ZTsKCi8qKgoqIEF1dG9tYXRpY2FsbHkgY2FsbGVkIGJ5IFdvcmxkLnByZVVwZGF0ZS4gSGFuZGxlcyBjYWNoZSB1cGRhdGVzLCBsaWZlc3BhbiBjaGVja3MsIGFuaW1hdGlvbiB1cGRhdGVzIGFuZCBwaHlzaWNzIHVwZGF0ZXMuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcHJlVXBkYXRlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucHJlVXBkYXRlID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKCF0aGlzLmV4aXN0cyB8fCAodGhpcy5ncm91cCAmJiAhdGhpcy5ncm91cC5leGlzdHMpKQogICAgewogICAgICAgIHRoaXMucmVuZGVyT3JkZXJJRCA9IC0xOwogICAgICAgIAogICAgICAgIC8vIFNraXAgY2hpbGRyZW4gaWYgbm90IGV4aXN0cwogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAodGhpcy5saWZlc3BhbiA+IDApCiAgICB7CiAgICAgICAgdGhpcy5saWZlc3BhbiAtPSB0aGlzLmdhbWUudGltZS5lbGFwc2VkOwoKICAgICAgICBpZiAodGhpcy5saWZlc3BhbiA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5raWxsKCk7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CgogICAgdGhpcy5fY2FjaGUuZGlydHkgPSBmYWxzZTsKCiAgICBpZiAodGhpcy52aXNpYmxlKQogICAgewogICAgICAgIHRoaXMucmVuZGVyT3JkZXJJRCA9IHRoaXMuZ2FtZS53b3JsZC5jdXJyZW50UmVuZGVyT3JkZXJJRCsrOwogICAgfQoKICAgIHRoaXMudXBkYXRlQ2FjaGUoKTsKCiAgICB0aGlzLnVwZGF0ZUFuaW1hdGlvbigpOwoKICAgIHRoaXMudXBkYXRlQ3JvcCgpOwoKICAgIC8vICBSZS1ydW4gdGhlIGNhbWVyYSB2aXNpYmlsaXR5IGNoZWNrCiAgICBpZiAodGhpcy5fY2FjaGUuZGlydHkgfHwgdGhpcy53b3JsZC54ICE9PSB0aGlzLl9jYWNoZS5wcmV2WCB8fCB0aGlzLndvcmxkLnkgIT09IHRoaXMuX2NhY2hlLnByZXZZKQogICAgewogICAgICAgIHRoaXMudXBkYXRlQm91bmRzKCk7CiAgICB9CgogICAgaWYgKHRoaXMuYm9keSkKICAgIHsKICAgICAgICB0aGlzLmJvZHkucHJlVXBkYXRlKCk7CiAgICB9CgogICAgcmV0dXJuIHRydWU7Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVDYWNoZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnVwZGF0ZUNhY2hlID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5fY2FjaGUucHJldlggPSB0aGlzLndvcmxkLng7CiAgICB0aGlzLl9jYWNoZS5wcmV2WSA9IHRoaXMud29ybGQueTsKCiAgICBpZiAodGhpcy5maXhlZFRvQ2FtZXJhKQogICAgewogICAgICAgIHRoaXMueCA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy54ICsgdGhpcy5jYW1lcmFPZmZzZXQueDsKICAgICAgICB0aGlzLnkgPSB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueSArIHRoaXMuY2FtZXJhT2Zmc2V0Lnk7CiAgICB9CgogICAgdGhpcy53b3JsZC5zZXRUbyh0aGlzLmdhbWUuY2FtZXJhLnggKyB0aGlzLndvcmxkVHJhbnNmb3JtWzJdLCB0aGlzLmdhbWUuY2FtZXJhLnkgKyB0aGlzLndvcmxkVHJhbnNmb3JtWzVdKTsKCiAgICBpZiAodGhpcy53b3JsZFRyYW5zZm9ybVsxXSAhPSB0aGlzLl9jYWNoZS5pMDEgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVszXSAhPSB0aGlzLl9jYWNoZS5pMTAgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVswXSAhPSB0aGlzLl9jYWNoZS5hMDAgfHwgdGhpcy53b3JsZFRyYW5zZm9ybVs0MV0gIT0gdGhpcy5fY2FjaGUuYTExKQogICAgewogICAgICAgIHRoaXMuX2NhY2hlLmEwMCA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMF07ICAvLyAgc2NhbGVYICAgICAgICAgYSAgICAgfGEgYyB0eHwKICAgICAgICB0aGlzLl9jYWNoZS5hMDEgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzFdOyAgLy8gIHNrZXdZICAgICAgICAgIGMgICAgIHxiIGQgdHl8CiAgICAgICAgdGhpcy5fY2FjaGUuYTEwID0gdGhpcy53b3JsZFRyYW5zZm9ybVszXTsgIC8vICBza2V3WCAgICAgICAgICBiICAgICB8MCAwICAxfAogICAgICAgIHRoaXMuX2NhY2hlLmExMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bNF07ICAvLyAgc2NhbGVZICAgICAgICAgZAoKICAgICAgICB0aGlzLl9jYWNoZS5pMDEgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzFdOyAgLy8gIHNrZXdZICAgICAgICAgIGMgKHJlbWFpbnMgbm9uLW1vZGlmaWVkIGZvciBpbnB1dCBjaGVja3MpCiAgICAgICAgdGhpcy5fY2FjaGUuaTEwID0gdGhpcy53b3JsZFRyYW5zZm9ybVszXTsgIC8vICBza2V3WCAgICAgICAgICBiIChyZW1haW5zIG5vbi1tb2RpZmllZCBmb3IgaW5wdXQgY2hlY2tzKQoKICAgICAgICB0aGlzLl9jYWNoZS5zY2FsZVggPSBNYXRoLnNxcnQoKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmEwMCkgKyAodGhpcy5fY2FjaGUuYTAxICogdGhpcy5fY2FjaGUuYTAxKSk7IC8vIHJvdW5kIHRoaXMgb2ZmIGEgYml0PwogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWSA9IE1hdGguc3FydCgodGhpcy5fY2FjaGUuYTEwICogdGhpcy5fY2FjaGUuYTEwKSArICh0aGlzLl9jYWNoZS5hMTEgKiB0aGlzLl9jYWNoZS5hMTEpKTsgLy8gcm91bmQgdGhpcyBvZmYgYSBiaXQ/CgogICAgICAgIHRoaXMuX2NhY2hlLmEwMSAqPSAtMTsKICAgICAgICB0aGlzLl9jYWNoZS5hMTAgKj0gLTE7CgogICAgICAgIHRoaXMuX2NhY2hlLmlkID0gMSAvICh0aGlzLl9jYWNoZS5hMDAgKiB0aGlzLl9jYWNoZS5hMTEgKyB0aGlzLl9jYWNoZS5hMDEgKiAtdGhpcy5fY2FjaGUuYTEwKTsKICAgICAgICB0aGlzLl9jYWNoZS5pZGkgPSAxIC8gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmExMSArIHRoaXMuX2NhY2hlLmkwMSAqIC10aGlzLl9jYWNoZS5pMTApOwoKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgdGhpcy5fY2FjaGUuYTAyID0gdGhpcy53b3JsZFRyYW5zZm9ybVsyXTsgIC8vICB0cmFuc2xhdGVYICAgICB0eAogICAgdGhpcy5fY2FjaGUuYTEyID0gdGhpcy53b3JsZFRyYW5zZm9ybVs1XTsgIC8vICB0cmFuc2xhdGVZICAgICB0eQoKfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIGNhbGxlZCBieSBwcmVVcGRhdGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjdXBkYXRlQW5pbWF0aW9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQW5pbWF0aW9uID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucy51cGRhdGUoKSB8fCAodGhpcy5jdXJyZW50RnJhbWUgJiYgdGhpcy5jdXJyZW50RnJhbWUudXVpZCAhPSB0aGlzLl9jYWNoZS5mcmFtZUlEKSkKICAgIHsKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZUlEID0gdGhpcy5jdXJyZW50RnJhbWUudXVpZDsKCiAgICAgICAgdGhpcy5fY2FjaGUuZnJhbWVXaWR0aCA9IHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZUhlaWdodCA9IHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgogICAgICAgIHRoaXMuX2NhY2hlLndpZHRoID0gdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fY2FjaGUuaGVpZ2h0ID0gdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0OwoKICAgICAgICB0aGlzLl9jYWNoZS5oYWxmV2lkdGggPSBNYXRoLmZsb29yKHRoaXMuX2NhY2hlLndpZHRoIC8gMik7CiAgICAgICAgdGhpcy5fY2FjaGUuaGFsZkhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5fY2FjaGUuaGVpZ2h0IC8gMik7CgogICAgICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gdHJ1ZTsKCiAgICB9Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVDcm9wCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQ3JvcCA9IGZ1bmN0aW9uKCkgewoKICAgIC8vICBUaGlzIG9ubHkgcnVucyBpZiBjcm9wIGlzIGVuYWJsZWQKICAgIGlmICh0aGlzLmNyb3BFbmFibGVkICYmICh0aGlzLmNyb3Aud2lkdGggIT0gdGhpcy5fY2FjaGUuY3JvcFdpZHRoIHx8IHRoaXMuY3JvcC5oZWlnaHQgIT0gdGhpcy5fY2FjaGUuY3JvcEhlaWdodCB8fCB0aGlzLmNyb3AueCAhPSB0aGlzLl9jYWNoZS5jcm9wWCB8fCB0aGlzLmNyb3AueSAhPSB0aGlzLl9jYWNoZS5jcm9wWSkpCiAgICB7CiAgICAgICAgdGhpcy5jcm9wLmZsb29yQWxsKCk7CgogICAgICAgIHRoaXMuX2NhY2hlLmNyb3BYID0gdGhpcy5jcm9wLng7CiAgICAgICAgdGhpcy5fY2FjaGUuY3JvcFkgPSB0aGlzLmNyb3AueTsKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wV2lkdGggPSB0aGlzLmNyb3Aud2lkdGg7CiAgICAgICAgdGhpcy5fY2FjaGUuY3JvcEhlaWdodCA9IHRoaXMuY3JvcC5oZWlnaHQ7CgogICAgICAgIHRoaXMudGV4dHVyZS5mcmFtZSA9IHRoaXMuY3JvcDsKICAgICAgICB0aGlzLnRleHR1cmUud2lkdGggPSB0aGlzLmNyb3Aud2lkdGg7CiAgICAgICAgdGhpcy50ZXh0dXJlLmhlaWdodCA9IHRoaXMuY3JvcC5oZWlnaHQ7CgogICAgICAgIHRoaXMudGV4dHVyZS51cGRhdGVGcmFtZSA9IHRydWU7CgogICAgICAgIFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMucHVzaCh0aGlzLnRleHR1cmUpOwogICAgfQoKfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIGNhbGxlZCBieSBwcmVVcGRhdGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjdXBkYXRlQm91bmRzCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQm91bmRzID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5vZmZzZXQuc2V0VG8odGhpcy5fY2FjaGUuYTAyIC0gKHRoaXMuYW5jaG9yLnggKiB0aGlzLndpZHRoKSwgdGhpcy5fY2FjaGUuYTEyIC0gKHRoaXMuYW5jaG9yLnkgKiB0aGlzLmhlaWdodCkpOwoKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmNlbnRlciwgdGhpcy5vZmZzZXQueCArICh0aGlzLndpZHRoIC8gMiksIHRoaXMub2Zmc2V0LnkgKyAodGhpcy5oZWlnaHQgLyAyKSk7CiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy50b3BMZWZ0LCB0aGlzLm9mZnNldC54LCB0aGlzLm9mZnNldC55KTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLnRvcFJpZ2h0LCB0aGlzLm9mZnNldC54ICsgdGhpcy53aWR0aCwgdGhpcy5vZmZzZXQueSk7CiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy5ib3R0b21MZWZ0LCB0aGlzLm9mZnNldC54LCB0aGlzLm9mZnNldC55ICsgdGhpcy5oZWlnaHQpOwogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuYm90dG9tUmlnaHQsIHRoaXMub2Zmc2V0LnggKyB0aGlzLndpZHRoLCB0aGlzLm9mZnNldC55ICsgdGhpcy5oZWlnaHQpOwoKICAgIHRoaXMuX2NhY2hlLmxlZnQgPSBQaGFzZXIuTWF0aC5taW4odGhpcy50b3BMZWZ0LngsIHRoaXMudG9wUmlnaHQueCwgdGhpcy5ib3R0b21MZWZ0LngsIHRoaXMuYm90dG9tUmlnaHQueCk7CiAgICB0aGlzLl9jYWNoZS5yaWdodCA9IFBoYXNlci5NYXRoLm1heCh0aGlzLnRvcExlZnQueCwgdGhpcy50b3BSaWdodC54LCB0aGlzLmJvdHRvbUxlZnQueCwgdGhpcy5ib3R0b21SaWdodC54KTsKICAgIHRoaXMuX2NhY2hlLnRvcCA9IFBoYXNlci5NYXRoLm1pbih0aGlzLnRvcExlZnQueSwgdGhpcy50b3BSaWdodC55LCB0aGlzLmJvdHRvbUxlZnQueSwgdGhpcy5ib3R0b21SaWdodC55KTsKICAgIHRoaXMuX2NhY2hlLmJvdHRvbSA9IFBoYXNlci5NYXRoLm1heCh0aGlzLnRvcExlZnQueSwgdGhpcy50b3BSaWdodC55LCB0aGlzLmJvdHRvbUxlZnQueSwgdGhpcy5ib3R0b21SaWdodC55KTsKCiAgICB0aGlzLmJvdW5kcy5zZXRUbyh0aGlzLl9jYWNoZS5sZWZ0LCB0aGlzLl9jYWNoZS50b3AsIHRoaXMuX2NhY2hlLnJpZ2h0IC0gdGhpcy5fY2FjaGUubGVmdCwgdGhpcy5fY2FjaGUuYm90dG9tIC0gdGhpcy5fY2FjaGUudG9wKTsKCiAgICB0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCiAgICBpZiAodGhpcy5pbldvcmxkID09IGZhbHNlKQogICAgewogICAgICAgIC8vICBTcHJpdGUgV0FTIG91dCBvZiB0aGUgc2NyZWVuLCBpcyBpdCBzdGlsbD8KICAgICAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMsIHRoaXMuaW5Xb3JsZFRocmVzaG9sZCk7CgogICAgICAgIGlmICh0aGlzLmluV29ybGQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgSXQncyBiYWNrIGFnYWluLCByZXNldCB0aGUgT09CIGNoZWNrCiAgICAgICAgICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSBmYWxzZTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgLy8gICBTcHJpdGUgV0FTIGluIHRoZSBzY3JlZW4sIGhhcyBpdCBub3cgbGVmdD8KICAgICAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMsIHRoaXMuaW5Xb3JsZFRocmVzaG9sZCk7CgogICAgICAgIGlmICh0aGlzLmluV29ybGQgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmV2ZW50cy5vbk91dE9mQm91bmRzLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICB0aGlzLl9vdXRPZkJvdW5kc0ZpcmVkID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLm91dE9mQm91bmRzS2lsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5raWxsKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdGhpcy5fY2FjaGUuY2FtZXJhVmlzaWJsZSA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmdhbWUud29ybGQuY2FtZXJhLnNjcmVlblZpZXcsIHRoaXMuYm91bmRzLCAwKTsKCiAgICBpZiAodGhpcy5hdXRvQ3VsbCkKICAgIHsKICAgICAgICAvLyAgV29uJ3QgZ2V0IHJlbmRlcmVkIGJ1dCB3aWxsIHN0aWxsIGdldCBpdHMgdHJhbnNmb3JtIHVwZGF0ZWQKICAgICAgICB0aGlzLnJlbmRlcmFibGUgPSB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlOwogICAgfQoKICAgIC8vICBVcGRhdGUgb3VyIHBoeXNpY3MgYm91bmRzCiAgICBpZiAodGhpcy5ib2R5KQogICAgewogICAgICAgIHRoaXMuYm9keS51cGRhdGVCb3VuZHModGhpcy5jZW50ZXIueCwgdGhpcy5jZW50ZXIueSwgdGhpcy5fY2FjaGUuc2NhbGVYLCB0aGlzLl9jYWNoZS5zY2FsZVkpOwogICAgfQoKfTsKCi8qKgoqIEdldHMgdGhlIGxvY2FsIHBvc2l0aW9uIG9mIGEgY29vcmRpbmF0ZSByZWxhdGl2ZSB0byB0aGUgU3ByaXRlLCBmYWN0b3JpbmcgaW4gcm90YXRpb24gYW5kIHNjYWxlLgoqIE1vc3RseSBvbmx5IHVzZWQgaW50ZXJuYWxseS4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjZ2V0TG9jYWxQb3NpdGlvbgoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHAgLSBUaGUgUG9pbnQgb2JqZWN0IHRvIHN0b3JlIHRoZSByZXN1bHRzIGluLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHBhcmFtIHtudW1iZXJ9IHN4IC0gU2NhbGUgZmFjdG9yIHRvIGJlIGFwcGxpZWQuCiogQHBhcmFtIHtudW1iZXJ9IHN5IC0gU2NhbGUgZmFjdG9yIHRvIGJlIGFwcGxpZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgdHJhbnNsYXRlZCBwb2ludC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZ2V0TG9jYWxQb3NpdGlvbiA9IGZ1bmN0aW9uKHAsIHgsIHkpIHsKCiAgICBwLnggPSAoKHRoaXMuX2NhY2hlLmExMSAqIHRoaXMuX2NhY2hlLmlkICogeCArIC10aGlzLl9jYWNoZS5hMDEgKiB0aGlzLl9jYWNoZS5pZCAqIHkgKyAodGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuYTAxIC0gdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuYTExKSAqIHRoaXMuX2NhY2hlLmlkKSAqIHRoaXMuc2NhbGUueCkgKyB0aGlzLl9jYWNoZS5hMDI7CiAgICBwLnkgPSAoKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmlkICogeSArIC10aGlzLl9jYWNoZS5hMTAgKiB0aGlzLl9jYWNoZS5pZCAqIHggKyAoLXRoaXMuX2NhY2hlLmExMiAqIHRoaXMuX2NhY2hlLmEwMCArIHRoaXMuX2NhY2hlLmEwMiAqIHRoaXMuX2NhY2hlLmExMCkgKiB0aGlzLl9jYWNoZS5pZCkgKiB0aGlzLnNjYWxlLnkpICsgdGhpcy5fY2FjaGUuYTEyOwoKICAgIHJldHVybiBwOwoKfTsKCi8qKgoqIEdldHMgdGhlIGxvY2FsIHVubW9kaWZpZWQgcG9zaXRpb24gb2YgYSBjb29yZGluYXRlIHJlbGF0aXZlIHRvIHRoZSBTcHJpdGUsIGZhY3RvcmluZyBpbiByb3RhdGlvbiBhbmQgc2NhbGUuCiogTW9zdGx5IG9ubHkgdXNlZCBpbnRlcm5hbGx5IGJ5IHRoZSBJbnB1dCBNYW5hZ2VyLCBidXQgYWxzbyB1c2VmdWwgZm9yIGN1c3RvbSBoaXQgZGV0ZWN0aW9uLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNnZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbgoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHAgLSBUaGUgUG9pbnQgb2JqZWN0IHRvIHN0b3JlIHRoZSByZXN1bHRzIGluLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIFNwcml0ZSB0byB0cmFuc2xhdGUuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgdHJhbnNsYXRlZCBwb2ludC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZ2V0TG9jYWxVbm1vZGlmaWVkUG9zaXRpb24gPSBmdW5jdGlvbihwLCBneCwgZ3kpIHsKCiAgICBwLnggPSAodGhpcy5fY2FjaGUuYTExICogdGhpcy5fY2FjaGUuaWRpICogZ3ggKyAtdGhpcy5fY2FjaGUuaTAxICogdGhpcy5fY2FjaGUuaWRpICogZ3kgKyAodGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuaTAxIC0gdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuYTExKSAqIHRoaXMuX2NhY2hlLmlkaSkgKyAodGhpcy5hbmNob3IueCAqIHRoaXMuX2NhY2hlLndpZHRoKTsKICAgIHAueSA9ICh0aGlzLl9jYWNoZS5hMDAgKiB0aGlzLl9jYWNoZS5pZGkgKiBneSArIC10aGlzLl9jYWNoZS5pMTAgKiB0aGlzLl9jYWNoZS5pZGkgKiBneCArICgtdGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuYTAwICsgdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuaTEwKSAqIHRoaXMuX2NhY2hlLmlkaSkgKyAodGhpcy5hbmNob3IueSAqIHRoaXMuX2NhY2hlLmhlaWdodCk7CgogICAgcmV0dXJuIHA7Cgp9OwoKLyoqCiogUmVzZXRzIHRoZSBTcHJpdGUuY3JvcCB2YWx1ZSBiYWNrIHRvIHRoZSBmcmFtZSBkaW1lbnNpb25zLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Jlc2V0Q3JvcAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnJlc2V0Q3JvcCA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMuY3JvcCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIHRoaXMuX2NhY2hlLndpZHRoLCB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgdGhpcy50ZXh0dXJlLnNldEZyYW1lKHRoaXMuY3JvcCk7CiAgICB0aGlzLmNyb3BFbmFibGVkID0gZmFsc2U7Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSBXb3JsZCBwb3N0VXBkYXRlIGN5Y2xlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Bvc3RVcGRhdGUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5wb3N0VXBkYXRlID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMua2V5IGluc3RhbmNlb2YgUGhhc2VyLkJpdG1hcERhdGEgJiYgdGhpcy5rZXkuX2RpcnR5KQogICAgewogICAgICAgIHRoaXMua2V5LnJlbmRlcigpOwogICAgfQoKICAgIGlmICh0aGlzLmV4aXN0cykKICAgIHsKICAgICAgICAvLyAgVGhlIHNwcml0ZSBpcyBwb3NpdGlvbmVkIGluIHRoaXMgY2FsbCwgYWZ0ZXIgdGFraW5nIGludG8gY29uc2lkZXJhdGlvbiBtb3Rpb24gdXBkYXRlcyBhbmQgY29sbGlzaW9uCiAgICAgICAgaWYgKHRoaXMuYm9keSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYm9keS5wb3N0VXBkYXRlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5maXhlZFRvQ2FtZXJhKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY2FjaGUueCA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy54ICsgdGhpcy5jYW1lcmFPZmZzZXQueDsKICAgICAgICAgICAgdGhpcy5fY2FjaGUueSA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy55ICsgdGhpcy5jYW1lcmFPZmZzZXQueTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgICAgICAgICAgdGhpcy5fY2FjaGUueSA9IHRoaXMueTsKICAgICAgICB9CgogICAgICAgIHRoaXMud29ybGQuc2V0VG8odGhpcy5nYW1lLmNhbWVyYS54ICsgdGhpcy53b3JsZFRyYW5zZm9ybVsyXSwgdGhpcy5nYW1lLmNhbWVyYS55ICsgdGhpcy53b3JsZFRyYW5zZm9ybVs1XSk7CgogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMuX2NhY2hlLng7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy5fY2FjaGUueTsKICAgIH0KCn07CgovKioKKiBDaGFuZ2VzIHRoZSBUZXh0dXJlIHRoZSBTcHJpdGUgaXMgdXNpbmcgZW50aXJlbHkuIFRoZSBvbGQgdGV4dHVyZSBpcyByZW1vdmVkIGFuZCB0aGUgbmV3IG9uZSBpcyByZWZlcmVuY2VkIG9yIGZldGNoZWQgZnJvbSB0aGUgQ2FjaGUuCiogVGhpcyBjYXVzZXMgYSBXZWJHTCB0ZXh0dXJlIHVwZGF0ZSwgc28gdXNlIHNwYXJpbmdseSBvciBpbiBsb3ctaW50ZW5zaXR5IHBvcnRpb25zIG9mIHlvdXIgZ2FtZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNsb2FkVGV4dHVyZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtzdHJpbmd8UGhhc2VyLlJlbmRlclRleHR1cmV8UGhhc2VyLkJpdG1hcERhdGF8UElYSS5UZXh0dXJlfSBrZXkgLSBUaGlzIGlzIHRoZSBpbWFnZSBvciB0ZXh0dXJlIHVzZWQgYnkgdGhlIFNwcml0ZSBkdXJpbmcgcmVuZGVyaW5nLiBJdCBjYW4gYmUgYSBzdHJpbmcgd2hpY2ggaXMgYSByZWZlcmVuY2UgdG8gdGhlIENhY2hlIGVudHJ5LCBvciBhbiBpbnN0YW5jZSBvZiBhIFJlbmRlclRleHR1cmUsIEJpdG1hcERhdGEgb3IgUElYSS5UZXh0dXJlLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gZnJhbWUgLSBJZiB0aGlzIFNwcml0ZSBpcyB1c2luZyBwYXJ0IG9mIGEgc3ByaXRlIHNoZWV0IG9yIHRleHR1cmUgYXRsYXMgeW91IGNhbiBzcGVjaWZ5IHRoZSBleGFjdCBmcmFtZSB0byB1c2UgYnkgZ2l2aW5nIGEgc3RyaW5nIG9yIG51bWVyaWMgaW5kZXguCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmxvYWRUZXh0dXJlID0gZnVuY3Rpb24gKGtleSwgZnJhbWUpIHsKCiAgICB0aGlzLmtleSA9IGtleTsKCiAgICBpZiAoa2V5IGluc3RhbmNlb2YgUGhhc2VyLlJlbmRlclRleHR1cmUpCiAgICB7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0VGV4dHVyZUZyYW1lKGtleS5uYW1lKTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSBpbnN0YW5jZW9mIFBoYXNlci5CaXRtYXBEYXRhKQogICAgewogICAgICAgIHRoaXMuc2V0VGV4dHVyZShrZXkudGV4dHVyZSk7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBrZXkudGV4dHVyZUZyYW1lOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUElYSS5UZXh0dXJlKQogICAgewogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gZnJhbWU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBrZXkgPT09ICd1bmRlZmluZWQnIHx8IHRoaXMuZ2FtZS5jYWNoZS5jaGVja0ltYWdlS2V5KGtleSkgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAga2V5ID0gJ19fZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5pc1Nwcml0ZVNoZWV0KGtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFuaW1hdGlvbnMubG9hZEZyYW1lRGF0YSh0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWVEYXRhKGtleSkpOwoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZnJhbWUgPT09ICdzdHJpbmcnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nYW1lLmNhY2hlLmdldEZyYW1lKGtleSk7CiAgICAgICAgICAgIHRoaXMuc2V0VGV4dHVyZShQSVhJLlRleHR1cmVDYWNoZVtrZXldKTsKICAgICAgICB9CiAgICB9Cgp9OwoKLyoqCiogTW92ZXMgdGhlIHNwcml0ZSBzbyBpdHMgY2VudGVyIGlzIGxvY2F0ZWQgb24gdGhlIGdpdmVuIHggYW5kIHkgY29vcmRpbmF0ZXMuCiogRG9lc24ndCBjaGFuZ2UgdGhlIGFuY2hvciBwb2ludCBvZiB0aGUgc3ByaXRlLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNjZW50ZXJPbgoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmNlbnRlck9uID0gZnVuY3Rpb24oeCwgeSkgewoKICAgIHRoaXMueCA9IHggKyAodGhpcy54IC0gdGhpcy5jZW50ZXIueCk7CiAgICB0aGlzLnkgPSB5ICsgKHRoaXMueSAtIHRoaXMuY2VudGVyLnkpOwogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogQnJpbmdzIGEgJ2RlYWQnIFNwcml0ZSBiYWNrIHRvIGxpZmUsIG9wdGlvbmFsbHkgZ2l2aW5nIGl0IHRoZSBoZWFsdGggdmFsdWUgc3BlY2lmaWVkLgoqIEEgcmVzdXJyZWN0ZWQgU3ByaXRlIGhhcyBpdHMgYWxpdmUsIGV4aXN0cyBhbmQgdmlzaWJsZSBwcm9wZXJ0aWVzIGFsbCBzZXQgdG8gdHJ1ZS4KKiBJdCB3aWxsIGRpc3BhdGNoIHRoZSBvblJldml2ZWQgZXZlbnQsIHlvdSBjYW4gbGlzdGVuIHRvIFNwcml0ZS5ldmVudHMub25SZXZpdmVkIGZvciB0aGUgc2lnbmFsLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNyZXZpdmUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEBwYXJhbSB7bnVtYmVyfSBbaGVhbHRoPTFdIC0gVGhlIGhlYWx0aCB0byBnaXZlIHRoZSBTcHJpdGUuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucmV2aXZlID0gZnVuY3Rpb24oaGVhbHRoKSB7CgogICAgaWYgKHR5cGVvZiBoZWFsdGggPT09ICd1bmRlZmluZWQnKSB7IGhlYWx0aCA9IDE7IH0KCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLmhlYWx0aCA9IGhlYWx0aDsKCiAgICBpZiAodGhpcy5ldmVudHMpCiAgICB7CiAgICAgICAgdGhpcy5ldmVudHMub25SZXZpdmVkLmRpc3BhdGNoKHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIEtpbGxzIGEgU3ByaXRlLiBBIGtpbGxlZCBTcHJpdGUgaGFzIGl0cyBhbGl2ZSwgZXhpc3RzIGFuZCB2aXNpYmxlIHByb3BlcnRpZXMgYWxsIHNldCB0byBmYWxzZS4KKiBJdCB3aWxsIGRpc3BhdGNoIHRoZSBvbktpbGxlZCBldmVudCwgeW91IGNhbiBsaXN0ZW4gdG8gU3ByaXRlLmV2ZW50cy5vbktpbGxlZCBmb3IgdGhlIHNpZ25hbC4KKiBOb3RlIHRoYXQga2lsbGluZyBhIFNwcml0ZSBpcyBhIHdheSBmb3IgeW91IHRvIHF1aWNrbHkgcmVjeWNsZSBpdCBpbiBhIFNwcml0ZSBwb29sLCBpdCBkb2Vzbid0IGZyZWUgaXQgdXAgZnJvbSBtZW1vcnkuCiogSWYgeW91IGRvbid0IG5lZWQgdGhpcyBTcHJpdGUgYW55IG1vcmUgeW91IHNob3VsZCBjYWxsIFNwcml0ZS5kZXN0cm95IGluc3RlYWQuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2tpbGwKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmtpbGwgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLmFsaXZlID0gZmFsc2U7CiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwogICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CgogICAgaWYgKHRoaXMuZXZlbnRzKQogICAgewogICAgICAgIHRoaXMuZXZlbnRzLm9uS2lsbGVkLmRpc3BhdGNoKHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIERlc3Ryb3lzIHRoZSBTcHJpdGUuIFRoaXMgcmVtb3ZlcyBpdCBmcm9tIGl0cyBwYXJlbnQgZ3JvdXAsIGRlc3Ryb3lzIHRoZSBpbnB1dCwgZXZlbnQgYW5kIGFuaW1hdGlvbiBoYW5kbGVycyBpZiBwcmVzZW50CiogYW5kIG51bGxzIGl0cyByZWZlcmVuY2UgdG8gZ2FtZSwgZnJlZWluZyBpdCB1cCBmb3IgZ2FyYmFnZSBjb2xsZWN0aW9uLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNkZXN0cm95CiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIGlmICh0aGlzLmlucHV0KQogICAgewogICAgICAgIHRoaXMuaW5wdXQuZGVzdHJveSgpOwogICAgfQoKICAgIGlmICh0aGlzLmV2ZW50cykKICAgIHsKICAgICAgICB0aGlzLmV2ZW50cy5kZXN0cm95KCk7CiAgICB9CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucykKICAgIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZGVzdHJveSgpOwogICAgfQoKICAgIHRoaXMuYWxpdmUgPSBmYWxzZTsKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CiAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKCiAgICB0aGlzLmdhbWUgPSBudWxsOwoKfTsKCi8qKgoqIERhbWFnZXMgdGhlIFNwcml0ZSwgdGhpcyByZW1vdmVzIHRoZSBnaXZlbiBhbW91bnQgZnJvbSB0aGUgU3ByaXRlcyBoZWFsdGggcHJvcGVydHkuCiogSWYgaGVhbHRoIGlzIHRoZW4gdGFrZW4gYmVsb3cgemVybyBTcHJpdGUua2lsbCBpcyBjYWxsZWQuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2RhbWFnZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgU3ByaXRlLmhlYWx0aCB2YWx1ZS4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5kYW1hZ2UgPSBmdW5jdGlvbihhbW91bnQpIHsKCiAgICBpZiAodGhpcy5hbGl2ZSkKICAgIHsKICAgICAgICB0aGlzLmhlYWx0aCAtPSBhbW91bnQ7CgogICAgICAgIGlmICh0aGlzLmhlYWx0aCA8IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmtpbGwoKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogUmVzZXRzIHRoZSBTcHJpdGUuIFRoaXMgcGxhY2VzIHRoZSBTcHJpdGUgYXQgdGhlIGdpdmVuIHgveSB3b3JsZCBjb29yZGluYXRlcyBhbmQgdGhlbgoqIHNldHMgYWxpdmUsIGV4aXN0cywgdmlzaWJsZSBhbmQgcmVuZGVyYWJsZSBhbGwgdG8gdHJ1ZS4gQWxzbyByZXNldHMgdGhlIG91dE9mQm91bmRzIHN0YXRlIGFuZCBoZWFsdGggdmFsdWVzLgoqIElmIHRoZSBTcHJpdGUgaGFzIGEgcGh5c2ljcyBib2R5IHRoYXQgdG9vIGlzIHJlc2V0LgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNyZXNldAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSBbaGVhbHRoPTFdIC0gVGhlIGhlYWx0aCB0byBnaXZlIHRoZSBTcHJpdGUuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbih4LCB5LCBoZWFsdGgpIHsKCiAgICBpZiAodHlwZW9mIGhlYWx0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVhbHRoID0gMTsgfQoKICAgIHRoaXMueCA9IHg7CiAgICB0aGlzLnkgPSB5OwogICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy54OwogICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy55OwogICAgdGhpcy5hbGl2ZSA9IHRydWU7CiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSBmYWxzZTsKCiAgICB0aGlzLmhlYWx0aCA9IGhlYWx0aDsKCiAgICBpZiAodGhpcy5ib2R5KQogICAgewogICAgICAgIHRoaXMuYm9keS5yZXNldCgpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwogICAgCn07CgovKioKKiBCcmluZ3MgdGhlIFNwcml0ZSB0byB0aGUgdG9wIG9mIHRoZSBkaXNwbGF5IGxpc3QgaXQgaXMgYSBjaGlsZCBvZi4gU3ByaXRlcyB0aGF0IGFyZSBtZW1iZXJzIG9mIGEgUGhhc2VyLkdyb3VwIGFyZSBvbmx5CiogYm91Z2h0IHRvIHRoZSB0b3Agb2YgdGhhdCBHcm91cCwgbm90IHRoZSBlbnRpcmUgZGlzcGxheSBsaXN0LgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNicmluZ1RvVG9wCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5icmluZ1RvVG9wID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5icmluZ1RvVG9wKHRoaXMpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuZ2FtZS53b3JsZC5icmluZ1RvVG9wKHRoaXMpOwogICAgfQoKICAgIHJldHVybiB0aGlzOwoKfTsKCi8qKgoqIFBsYXkgYW4gYW5pbWF0aW9uIGJhc2VkIG9uIHRoZSBnaXZlbiBrZXkuIFRoZSBhbmltYXRpb24gc2hvdWxkIHByZXZpb3VzbHkgaGF2ZSBiZWVuIGFkZGVkIHZpYSBzcHJpdGUuYW5pbWF0aW9ucy5hZGQoKQoqIElmIHRoZSByZXF1ZXN0ZWQgYW5pbWF0aW9uIGlzIGFscmVhZHkgcGxheWluZyB0aGlzIHJlcXVlc3Qgd2lsbCBiZSBpZ25vcmVkLiBJZiB5b3UgbmVlZCB0byByZXNldCBhbiBhbHJlYWR5IHJ1bm5pbmcgYW5pbWF0aW9uIGRvIHNvIGRpcmVjdGx5IG9uIHRoZSBBbmltYXRpb24gb2JqZWN0IGl0c2VsZi4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcGxheQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRvIGJlIHBsYXllZCwgZS5nLiAiZmlyZSIsICJ3YWxrIiwgImp1bXAiLgoqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPW51bGxdIC0gVGhlIGZyYW1lcmF0ZSB0byBwbGF5IHRoZSBhbmltYXRpb24gYXQuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBmcmFtZVJhdGUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gYmUgbG9vcGVkIGFmdGVyIHBsYXliYWNrLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGxvb3AgdmFsdWUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgoqIEBwYXJhbSB7Ym9vbGVhbn0gW2tpbGxPbkNvbXBsZXRlPWZhbHNlXSAtIElmIHNldCB0byB0cnVlIHdoZW4gdGhlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKG9ubHkgaGFwcGVucyBpZiBsb29wPWZhbHNlKSB0aGUgcGFyZW50IFNwcml0ZSB3aWxsIGJlIGtpbGxlZC4KKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSBBIHJlZmVyZW5jZSB0byBwbGF5aW5nIEFuaW1hdGlvbiBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucGxheSA9IGZ1bmN0aW9uIChuYW1lLCBmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgogICAgaWYgKHRoaXMuYW5pbWF0aW9ucykKICAgIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLnBsYXkobmFtZSwgZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSk7CiAgICB9Cgp9OwoKLyoqCiogSW5kaWNhdGVzIHRoZSByb3RhdGlvbiBvZiB0aGUgU3ByaXRlLCBpbiBkZWdyZWVzLCBmcm9tIGl0cyBvcmlnaW5hbCBvcmllbnRhdGlvbi4gVmFsdWVzIGZyb20gMCB0byAxODAgcmVwcmVzZW50IGNsb2Nrd2lzZSByb3RhdGlvbjsgdmFsdWVzIGZyb20gMCB0byAtMTgwIHJlcHJlc2VudCBjb3VudGVyY2xvY2t3aXNlIHJvdGF0aW9uLgoqIFZhbHVlcyBvdXRzaWRlIHRoaXMgcmFuZ2UgYXJlIGFkZGVkIHRvIG9yIHN1YnRyYWN0ZWQgZnJvbSAzNjAgdG8gb2J0YWluIGEgdmFsdWUgd2l0aGluIHRoZSByYW5nZS4gRm9yIGV4YW1wbGUsIHRoZSBzdGF0ZW1lbnQgcGxheWVyLmFuZ2xlID0gNDUwIGlzIHRoZSBzYW1lIGFzIHBsYXllci5hbmdsZSA9IDkwLgoqIElmIHlvdSB3aXNoIHRvIHdvcmsgaW4gcmFkaWFucyBpbnN0ZWFkIG9mIGRlZ3JlZXMgdXNlIHRoZSBwcm9wZXJ0eSBTcHJpdGUucm90YXRpb24gaW5zdGVhZC4KKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2FuZ2xlCiogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ2xlIC0gR2V0cyBvciBzZXRzIHRoZSBTcHJpdGVzIGFuZ2xlIG9mIHJvdGF0aW9uIGluIGRlZ3JlZXMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLndyYXBBbmdsZShQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoUGhhc2VyLk1hdGgud3JhcEFuZ2xlKHZhbHVlKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjZnJhbWUKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgaW5kZXggYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgImZyYW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLmZyYW1lOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5mcmFtZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2ZyYW1lTmFtZQoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmcmFtZU5hbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgbmFtZSBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiZnJhbWVOYW1lIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hbmltYXRpb25zLmZyYW1lTmFtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmFuaW1hdGlvbnMuZnJhbWVOYW1lID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjaW5DYW1lcmEKKiBAcHJvcGVydHkge2Jvb2xlYW59IGluQ2FtZXJhIC0gSXMgdGhpcyBzcHJpdGUgdmlzaWJsZSB0byB0aGUgY2FtZXJhIG9yIG5vdD8KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiaW5DYW1lcmEiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlOwogICAgfQoKfSk7CgovKioKKiBUaGUgd2lkdGggb2YgdGhlIHNwcml0ZSBpbiBwaXhlbHMsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgZGVzaXJlZC4KKiBJZiB5b3Ugd2lzaCB0byBjcm9wIHRoZSBTcHJpdGUgaW5zdGVhZCBzZWUgdGhlIFNwcml0ZS5jcm9wIHZhbHVlLgoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSN3aWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgU3ByaXRlIGluIHBpeGVscy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAnd2lkdGgnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5zY2FsZS54ICogdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgdGhpcy5zY2FsZS54ID0gdmFsdWUgLyB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5zY2FsZVggPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuX3dpZHRoID0gdmFsdWU7CgogICAgfQoKfSk7CgovKioKKiBUaGUgaGVpZ2h0IG9mIHRoZSBzcHJpdGUgaW4gcGl4ZWxzLCBzZXR0aW5nIHRoaXMgd2lsbCBhY3R1YWxseSBtb2RpZnkgdGhlIHNjYWxlIHRvIGFjaGVpdmUgdGhlIHZhbHVlIGRlc2lyZWQuCiogSWYgeW91IHdpc2ggdG8gY3JvcCB0aGUgU3ByaXRlIGluc3RlYWQgc2VlIHRoZSBTcHJpdGUuY3JvcCB2YWx1ZS4KKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjaGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIFNwcml0ZSBpbiBwaXhlbHMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgJ2hlaWdodCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjYWxlLnkgKiB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQ7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgdGhpcy5zY2FsZS55ID0gdmFsdWUgLyB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQ7CiAgICAgICAgdGhpcy5fY2FjaGUuc2NhbGVZID0gdmFsdWUgLyB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQ7CiAgICAgICAgdGhpcy5faGVpZ2h0ID0gdmFsdWU7CgogICAgfQoKfSk7CgovKioKKiBCeSBkZWZhdWx0IGEgU3ByaXRlIHdvbid0IHByb2Nlc3MgYW55IGlucHV0IGV2ZW50cyBhdCBhbGwuIEJ5IHNldHRpbmcgaW5wdXRFbmFibGVkIHRvIHRydWUgdGhlIFBoYXNlci5JbnB1dEhhbmRsZXIgaXMKKiBhY3RpdmF0ZWQgZm9yIHRoaXMgU3ByaXRlIGluc3RhbmNlIGFuZCBpdCB3aWxsIHRoZW4gc3RhcnQgdG8gcHJvY2VzcyBjbGljay90b3VjaCBldmVudHMgYW5kIG1vcmUuCioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI2lucHV0RW5hYmxlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5wdXRFbmFibGVkIC0gU2V0IHRvIHRydWUgdG8gYWxsb3cgdGhpcyBTcHJpdGUgdG8gcmVjZWl2ZSBpbnB1dCBldmVudHMsIG90aGVyd2lzZSBmYWxzZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiaW5wdXRFbmFibGVkIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuICh0aGlzLmlucHV0LmVuYWJsZWQpOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQuZW5hYmxlZCA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdGFydCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LmVuYWJsZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaW5wdXQuc3RvcCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlIGEgbmV3IDxjb2RlPlRpbGVTcHJpdGU8L2NvZGU+LgoqIEBjbGFzcyBQaGFzZXIuVGlsZW1hcAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZVNwcml0ZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIHRoZSB3aWR0aCBvZiB0aGUgdGlsZXNwcml0ZS4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodCBvZiB0aGUgdGlsZXNwcml0ZS4KKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSBvciBQSVhJLlRleHR1cmUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBmcmFtZSAtIElmIHRoaXMgU3ByaXRlIGlzIHVzaW5nIHBhcnQgb2YgYSBzcHJpdGUgc2hlZXQgb3IgdGV4dHVyZSBhdGxhcyB5b3UgY2FuIHNwZWNpZnkgdGhlIGV4YWN0IGZyYW1lIHRvIHVzZSBieSBnaXZpbmcgYSBzdHJpbmcgb3IgbnVtZXJpYyBpbmRleC4KKi8KUGhhc2VyLlRpbGVTcHJpdGUgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgd2lkdGgsIGhlaWdodCwga2V5LCBmcmFtZSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAgd2lkdGggPSB3aWR0aCB8fCAyNTY7CiAgICBoZWlnaHQgPSBoZWlnaHQgfHwgMjU2OwogICAga2V5ID0ga2V5IHx8IG51bGw7CiAgICBmcmFtZSA9IGZyYW1lIHx8IG51bGw7CgoJUGhhc2VyLlNwcml0ZS5jYWxsKHRoaXMsIGdhbWUsIHgsIHksIGtleSwgZnJhbWUpOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0ZXh0dXJlIC0gRGVzY3JpcHRpb24uIAogICAgKi8KICAgIHRoaXMudGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2tleV07CgoJUElYSS5UaWxpbmdTcHJpdGUuY2FsbCh0aGlzLCB0aGlzLnRleHR1cmUsIHdpZHRoLCBoZWlnaHQpOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0eXBlIC0gRGVzY3JpcHRpb24uIAogICAgKi8KCXRoaXMudHlwZSA9IFBoYXNlci5USUxFU1BSSVRFOwoKCS8qKgoJKiBAcHJvcGVydHkge1BvaW50fSB0aWxlU2NhbGUgLSBUaGUgc2NhbGluZyBvZiB0aGUgaW1hZ2UgdGhhdCBpcyBiZWluZyB0aWxlZC4KCSovCQoJdGhpcy50aWxlU2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKCS8qKgoJKiBAcHJvcGVydHkge1BvaW50fSB0aWxlUG9zaXRpb24gLSBUaGUgb2Zmc2V0IHBvc2l0aW9uIG9mIHRoZSBpbWFnZSB0aGF0IGlzIGJlaW5nIHRpbGVkLgoJKi8JCgl0aGlzLnRpbGVQb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoMCwgMCk7Cgp9OwoKUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlID0gUGhhc2VyLlV0aWxzLmV4dGVuZCh0cnVlLCBQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUsIFBoYXNlci5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlRpbGVTcHJpdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlRpbGVTcHJpdGU7CgovLyAgQWRkIG91ciBvd24gY3VzdG9tIG1ldGhvZHMKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZSBhIG5ldyA8Y29kZT5UZXh0PC9jb2RlPi4KKiBAY2xhc3MgUGhhc2VyLlRleHQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgoqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgoqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSAtIFRoZSBzdHlsZSBvYmplY3QgY29udGFpbmluZyBzdHlsZSBhdHRyaWJ1dGVzIGxpa2UgZm9udCwgZm9udCBzaXplICwKKi8KUGhhc2VyLlRleHQgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIHRleHQgPSB0ZXh0IHx8ICcnOwogICAgc3R5bGUgPSBzdHlsZSB8fCAnJzsKCiAgICAvLyAgSWYgZXhpc3RzID0gZmFsc2UgdGhlbiB0aGUgU3ByaXRlIGlzbid0IHVwZGF0ZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wIG9yIHBoeXNpY3Mgc3Vic3lzdGVtIGF0IGFsbAoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhpc3RzIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKICAgIC8vICBUaGlzIGlzIGEgaGFuZHkgbGl0dGxlIHZhciB5b3VyIGdhbWUgY2FuIHVzZSB0byBkZXRlcm1pbmUgaWYgYSBzcHJpdGUgaXMgYWxpdmUgb3Igbm90LCBpdCBkb2Vzbid0IGVmZmVjdCByZW5kZXJpbmcKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5hbGl2ZSA9IHRydWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGdyb3VwIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5ncm91cCA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5uYW1lID0gJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICB0aGlzLl90ZXh0ID0gdGV4dDsKICAgIHRoaXMuX3N0eWxlID0gc3R5bGU7CgogICAgUElYSS5UZXh0LmNhbGwodGhpcywgdGV4dCwgc3R5bGUpOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdHlwZSAtIERlc2NyaXB0aW9uLiAKICAgICAqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLlRFWFQ7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBwb3NpdGlvbiAtIERlc2NyaXB0aW9uLiAKICAgICAqLwogICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy54ID0geDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMueSA9IHk7CgogICAgLy8gIFJlcGxhY2VzIHRoZSBQSVhJLlBvaW50IHdpdGggYSBzbGlnaHRseSBtb3JlIGZsZXhpYmxlIG9uZQogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gRGVzY3JpcHRpb24uIAogICAgICovCiAgICB0aGlzLmFuY2hvciA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBEZXNjcmlwdGlvbi4gCiAgICAgKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8vICBBIG1pbmkgY2FjaGUgZm9yIHN0b3JpbmcgYWxsIG9mIHRoZSBjYWxjdWxhdGVkIHZhbHVlcwogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9jYWNoZSAtIERlc2NyaXB0aW9uLiAKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jYWNoZSA9IHsgCgogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogMSwgYTAxOiAwLCBhMDI6IHgsIGExMDogMCwgYTExOiAxLCBhMTI6IHksIGlkOiAxLCAKCiAgICAgICAgLy8gIFRoZSBwcmV2aW91cyBjYWxjdWxhdGVkIHBvc2l0aW9uCiAgICAgICAgeDogLTEsIHk6IC0xLAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCBzY2FsZSB2YWx1ZXMgYmFzZWQgb24gdGhlIHdvcmxkVHJhbnNmb3JtCiAgICAgICAgc2NhbGVYOiAxLCBzY2FsZVk6IDEKCiAgICB9OwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlbmRlcmFibGUgLSBEZXNjcmlwdGlvbi4gCiAgICAqLwogICAgdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKCn07CgpQaGFzZXIuVGV4dC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuVGV4dC5wcm90b3R5cGUpOwpQaGFzZXIuVGV4dC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGV4dDsKCi8qKgoqIEF1dG9tYXRpY2FsbHkgY2FsbGVkIGJ5IFdvcmxkLnVwZGF0ZS4KKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS51cGRhdGUKKi8KUGhhc2VyLlRleHQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICghdGhpcy5leGlzdHMpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gZmFsc2U7CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgogICAgaWYgKHRoaXMucG9zaXRpb24ueCAhPSB0aGlzLl9jYWNoZS54IHx8IHRoaXMucG9zaXRpb24ueSAhPSB0aGlzLl9jYWNoZS55KQogICAgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMuX2NhY2hlLng7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy5fY2FjaGUueTsKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9Cgp9CgovKioKKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95CiovClBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuY2FudmFzLnBhcmVudE5vZGUpCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmNhbnZhcyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMgPSBudWxsOwogICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICB9CgogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCn0KCi8qKgoqIEdldAoqIEByZXR1cm5zIHtEZXNjcmlwdGlvbn0KKi8vKioKKiBTZXQKKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2YWx1ZSAtIERlc2NyaXB0aW9uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGV4dC5wcm90b3R5cGUsICdhbmdsZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZCh2YWx1ZSk7CiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGV4dC5wcm90b3R5cGUsICdjb250ZW50JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3RleHQ7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKCiAgICAgICAgLy8gIExldCdzIG5vdCB1cGRhdGUgdW5sZXNzIG5lZWRlZCwgdGhpcyB3YXkgd2UgY2FuIHNhZmVseSB1cGRhdGUgdGhlIHRleHQgaW4gYSBjb3JlIGxvb3Agd2l0aG91dCBjb25zdGFudCByZS1kcmF3cwogICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy5fdGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3RleHQgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5zZXRUZXh0KHZhbHVlKTsKICAgICAgICB9CgogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRleHQucHJvdG90eXBlLCAnZm9udCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAvLyAgTGV0J3Mgbm90IHVwZGF0ZSB1bmxlc3MgbmVlZGVkLCB0aGlzIHdheSB3ZSBjYW4gc2FmZWx5IHVwZGF0ZSB0aGUgdGV4dCBpbiBhIGNvcmUgbG9vcCB3aXRob3V0IGNvbnN0YW50IHJlLWRyYXdzCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl9zdHlsZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuc2V0U3R5bGUodmFsdWUpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgYEJpdG1hcFRleHRgIG9iamVjdC4gQml0bWFwVGV4dCB3b3JrIGJ5IHRha2luZyBhIHRleHR1cmUgZmlsZSBhbmQgYW4gWE1MIGZpbGUgdGhhdCBkZXNjcmliZXMgdGhlIGZvbnQgbGF5b3V0LgoqIE9uIFdpbmRvd3MgeW91IGNhbiB1c2UgdGhlIGZyZWUgYXBwIEJNRm9udDogaHR0cDovL3d3dy5hbmdlbGNvZGUuY29tL3Byb2R1Y3RzL2JtZm9udC8KKiBPbiBPUyBYIHdlIHJlY29tbWVuZCBHbHlwaCBEZXNpZ25lcjogaHR0cDovL3d3dy43MXNxdWFyZWQuY29tL2VuL2dseXBoZGVzaWduZXIKKgoqIEBjbGFzcyBQaGFzZXIuQml0bWFwVGV4dAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBhY3R1YWwgdGV4dCB0aGF0IHdpbGwgYmUgd3JpdHRlbi4KKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsIGV0Yy4KKi8KUGhhc2VyLkJpdG1hcFRleHQgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKCiAgICB0ZXh0ID0gdGV4dCB8fCAnJzsKICAgIHN0eWxlID0gc3R5bGUgfHwgJyc7CgoJLyoqIAoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyA9IGZhbHNlIHRoZW4gdGhlIFNwcml0ZSBpc24ndCB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcCBvciBwaHlzaWNzIHN1YnN5c3RlbSBhdCBhbGwuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKCS8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhpcyBpcyBhIGhhbmR5IGxpdHRsZSB2YXIgeW91ciBnYW1lIGNhbiB1c2UgdG8gZGV0ZXJtaW5lIGlmIGEgc3ByaXRlIGlzIGFsaXZlIG9yIG5vdCwgaXQgZG9lc24ndCBlZmZlY3QgcmVuZGVyaW5nLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYWxpdmUgPSB0cnVlOwoKCS8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBncm91cCAtIERlc2NyaXB0aW9uLgogCSogQGRlZmF1bHQKIAkqLwogICAgdGhpcy5ncm91cCA9IG51bGw7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCiAgCSogQGRlZmF1bHQKICAJKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICBQSVhJLkJpdG1hcFRleHQuY2FsbCh0aGlzLCB0ZXh0LCBzdHlsZSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHR5cGUgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuQklUTUFQVEVYVDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHBvc2l0aW9uLnggLSBEZXNjcmlwdGlvbi4KCSovCiAgICB0aGlzLnBvc2l0aW9uLnggPSB4OwogICAgCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHBvc2l0aW9uLnkgLSBEZXNjcmlwdGlvbi4KCSovCiAgICB0aGlzLnBvc2l0aW9uLnkgPSB5OwoKICAgIC8vICBSZXBsYWNlcyB0aGUgUElYSS5Qb2ludCB3aXRoIGEgc2xpZ2h0bHkgbW9yZSBmbGV4aWJsZSBvbmUKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYW5jaG9yIC0gRGVzY3JpcHRpb24uCgkqLwogICAgdGhpcy5hbmNob3IgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGUgLSBEZXNjcmlwdGlvbi4KCSovCiAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvLyAgQSBtaW5pIGNhY2hlIGZvciBzdG9yaW5nIGFsbCBvZiB0aGUgY2FsY3VsYXRlZCB2YWx1ZXMKCS8qKgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FjaGUgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9jYWNoZSA9IHsgCgogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogMSwgYTAxOiAwLCBhMDI6IHgsIGExMDogMCwgYTExOiAxLCBhMTI6IHksIGlkOiAxLCAKCiAgICAgICAgLy8gIFRoZSBwcmV2aW91cyBjYWxjdWxhdGVkIHBvc2l0aW9uCiAgICAgICAgeDogLTEsIHk6IC0xLAoKICAgICAgICAvLyAgVGhlIGFjdHVhbCBzY2FsZSB2YWx1ZXMgYmFzZWQgb24gdGhlIHdvcmxkVHJhbnNmb3JtCiAgICAgICAgc2NhbGVYOiAxLCBzY2FsZVk6IDEKCiAgICB9OwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlbmRlcmFibGUgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwoKfTsKClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZSk7Ci8vIFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSA9IFBoYXNlci5VdGlscy5leHRlbmQodHJ1ZSwgUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZSk7ClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5CaXRtYXBUZXh0OwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQudXBkYXRlCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUudXBkYXRlCiovClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAoIXRoaXMuZXhpc3RzKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IGZhbHNlOwoKICAgIHRoaXMuX2NhY2hlLnggPSB0aGlzLng7CiAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwoKICAgIGlmICh0aGlzLnBvc2l0aW9uLnggIT0gdGhpcy5fY2FjaGUueCB8fCB0aGlzLnBvc2l0aW9uLnkgIT0gdGhpcy5fY2FjaGUueSkKICAgIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLl9jYWNoZS54OwogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHRoaXMuX2NhY2hlLnk7CiAgICAgICAgdGhpcy5fY2FjaGUuZGlydHkgPSB0cnVlOwogICAgfQoKICAgIHRoaXMucGl2b3QueCA9IHRoaXMuYW5jaG9yLngqdGhpcy53aWR0aDsKICAgIHRoaXMucGl2b3QueSA9IHRoaXMuYW5jaG9yLnkqdGhpcy5oZWlnaHQ7Cgp9CgovKioKKiBAbWV0aG9kIFBoYXNlci5UZXh0LnByb3RvdHlwZS5kZXN0cm95CiovClBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuY2FudmFzICYmIHRoaXMuY2FudmFzLnBhcmVudE5vZGUpCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCh0aGlzLmNhbnZhcyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5jYW52YXMgPSBudWxsOwogICAgICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICB9CgogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCn0KCi8qKgoqIEdldAoqIEByZXR1cm5zIHtEZXNjcmlwdGlvbn0KKi8vKioKKiBTZXQKKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2YWx1ZSAtIERlc2NyaXB0aW9uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUsICdhbmdsZScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZCh2YWx1ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIEdldAoqIEByZXR1cm5zIHtEZXNjcmlwdGlvbn0KKi8vKioKKiBTZXQKKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2YWx1ZSAtIERlc2NyaXB0aW9uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUsICd4JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBHZXQKKiBAcmV0dXJucyB7RGVzY3JpcHRpb259CiovLyoqCiogU2V0CiogQHBhcmFtIHtEZXNjcmlwdGlvbn0gdmFsdWUgLSBEZXNjcmlwdGlvbgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLCAneScsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlIGEgbmV3IGBCdXR0b25gIG9iamVjdC4gQSBCdXR0b24gaXMgYSBzcGVjaWFsIHR5cGUgb2YgU3ByaXRlIHRoYXQgaXMgc2V0LXVwIHRvIGhhbmRsZSBQb2ludGVyIGV2ZW50cyBhdXRvbWF0aWNhbGx5LiBUaGUgZm91ciBzdGF0ZXMgYSBCdXR0b24gcmVzcG9uZHMgdG8gYXJlOgoqICdPdmVyJyAtIHdoZW4gdGhlIFBvaW50ZXIgbW92ZXMgb3ZlciB0aGUgQnV0dG9uLiBUaGlzIGlzIGFsc28gY29tbW9ubHkga25vd24gYXMgJ2hvdmVyJy4KKiAnT3V0JyAtIHdoZW4gdGhlIFBvaW50ZXIgdGhhdCB3YXMgcHJldmlvdXNseSBvdmVyIHRoZSBCdXR0b24gbW92ZXMgb3V0IG9mIGl0LgoqICdEb3duJyAtIHdoZW4gdGhlIFBvaW50ZXIgaXMgcHJlc3NlZCBkb3duIG9uIHRoZSBCdXR0b24uIEkuZS4gdG91Y2hlZCBvbiBhIHRvdWNoIGVuYWJsZWQgZGV2aWNlIG9yIGNsaWNrZWQgd2l0aCB0aGUgbW91c2UuCiogJ1VwJyAtIHdoZW4gdGhlIFBvaW50ZXIgdGhhdCB3YXMgcHJlc3NlZCBkb3duIG9uIHRoZSBCdXR0b24gaXMgcmVsZWFzZWQgYWdhaW4uCiogWW91IGNhbiBzZXQgYSB1bmlxdWUgdGV4dHVyZSBmcmFtZSBhbmQgU291bmQgZm9yIGFueSBvZiB0aGVzZSBzdGF0ZXMuCioKKiBAY2xhc3MgUGhhc2VyLkJ1dHRvbgoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIFggcG9zaXRpb24gb2YgdGhlIEJ1dHRvbi4KKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gWSBwb3NpdGlvbiBvZiB0aGUgQnV0dG9uLgoqIEBwYXJhbSB7c3RyaW5nfSBba2V5XSAtIFRoZSBpbWFnZSBrZXkgYXMgZGVmaW5lZCBpbiB0aGUgR2FtZS5DYWNoZSB0byB1c2UgYXMgdGhlIHRleHR1cmUgZm9yIHRoaXMgQnV0dG9uLgoqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gLSBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoaXMgQnV0dG9uIGlzIHByZXNzZWQuCiogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0NvbnRleHRdIC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdGhlIGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3ZlckZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3ZlciBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdXRGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG91dCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtkb3duRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhIGRvd24gc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiovClBoYXNlci5CdXR0b24gPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwga2V5LCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIGtleSA9IGtleSB8fCBudWxsOwogICAgY2FsbGJhY2sgPSBjYWxsYmFjayB8fCBudWxsOwogICAgY2FsbGJhY2tDb250ZXh0ID0gY2FsbGJhY2tDb250ZXh0IHx8IHRoaXM7CgoJUGhhc2VyLlNwcml0ZS5jYWxsKHRoaXMsIGdhbWUsIHgsIHksIGtleSwgb3V0RnJhbWUpOwoKCS8qKiAKCSogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgUGhhc2VyIE9iamVjdCBUeXBlLgoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5CVVRUT047CgoJLyoqIAoJKiBAcHJvcGVydHkge3N0cmluZ30gX29uT3ZlckZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uT3ZlckZyYW1lTmFtZSA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtzdHJpbmd9IF9vbk91dEZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uT3V0RnJhbWVOYW1lID0gbnVsbDsKICAgIAoJLyoqIAoJKiBAcHJvcGVydHkge3N0cmluZ30gX29uRG93bkZyYW1lTmFtZSAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uRG93bkZyYW1lTmFtZSA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtzdHJpbmd9IF9vblVwRnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25VcEZyYW1lTmFtZSA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtudW1iZXJ9IF9vbk92ZXJGcmFtZUlEIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25PdmVyRnJhbWVJRCA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtudW1iZXJ9IF9vbk91dEZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9vbk91dEZyYW1lSUQgPSBudWxsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb25Eb3duRnJhbWVJRCAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uRG93bkZyYW1lSUQgPSBudWxsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb25VcEZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9vblVwRnJhbWVJRCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25PdmVyU291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIE92ZXIgc3RhdGUgaXMgYWN0aXZhdGVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdmVyU291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmR9IG9uT3V0U291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIE91dCBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk91dFNvdW5kID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kfSBvbkRvd25Tb3VuZCAtIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiB0aGlzIEJ1dHRvbnMgRG93biBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbkRvd25Tb3VuZCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25VcFNvdW5kIC0gVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIHRoaXMgQnV0dG9ucyBVcCBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vblVwU291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uT3ZlclNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uT3ZlclNvdW5kLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub25PdmVyU291bmRNYXJrZXIgPSAnJzsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvbk91dFNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uT3V0U291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk91dFNvdW5kTWFya2VyID0gJyc7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb25Eb3duU291bmRNYXJrZXIgLSBUaGUgU291bmQgTWFya2VyIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgb25Eb3duU291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbkRvd25Tb3VuZE1hcmtlciA9ICcnOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uVXBTb3VuZE1hcmtlciAtIFRoZSBTb3VuZCBNYXJrZXIgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBvblVwU291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vblVwU291bmRNYXJrZXIgPSAnJzsKCgkvKiogCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dE92ZXIgLSBUaGUgU2lnbmFsIChvciBldmVudCkgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgQnV0dG9uIGlzIGluIGFuIE92ZXIgc3RhdGUuCgkqLwogICAgdGhpcy5vbklucHV0T3ZlciA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dE91dCAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gT3V0IHN0YXRlLgoJKi8KICAgIHRoaXMub25JbnB1dE91dCA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dERvd24gLSBUaGUgU2lnbmFsIChvciBldmVudCkgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgQnV0dG9uIGlzIGluIGFuIERvd24gc3RhdGUuCgkqLwogICAgdGhpcy5vbklucHV0RG93biA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25JbnB1dFVwIC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBVcCBzdGF0ZS4KCSovCiAgICB0aGlzLm9uSW5wdXRVcCA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmcmVlemVGcmFtZXMgLSBXaGVuIHRydWUgdGhlIEJ1dHRvbiB3aWxsIGNlYXNlIHRvIGNoYW5nZSB0ZXh0dXJlIGZyYW1lIG9uIGFsbCBldmVudHMgKG92ZXIsIG91dCwgdXAsIGRvd24pLgogICAgKi8KICAgIHRoaXMuZnJlZXplRnJhbWVzID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFdoZW4gdGhlIEJ1dHRvbiBpcyBjbGlja2VkIHlvdSBjYW4gb3B0aW9uYWxseSBmb3JjZSB0aGUgc3RhdGUgdG8gIm91dCIuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZm9yY2VPdXQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZvcmNlT3V0ID0gdHJ1ZTsKCiAgICB0aGlzLnNldEZyYW1lcyhvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUpOwoKICAgIGlmIChjYWxsYmFjayAhPT0gbnVsbCkKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRVcC5hZGQoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICB9CgogICAgdGhpcy5pbnB1dC5zdGFydCgwLCB0cnVlKTsKCiAgICAvLyAgUmVkaXJlY3QgdGhlIGlucHV0IGV2ZW50cyB0byBoZXJlIHNvIHdlIGNhbiBoYW5kbGUgYW5pbWF0aW9uIHVwZGF0ZXMsIGV0YwogICAgdGhpcy5ldmVudHMub25JbnB1dE92ZXIuYWRkKHRoaXMub25JbnB1dE92ZXJIYW5kbGVyLCB0aGlzKTsKICAgIHRoaXMuZXZlbnRzLm9uSW5wdXRPdXQuYWRkKHRoaXMub25JbnB1dE91dEhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5ldmVudHMub25JbnB1dERvd24uYWRkKHRoaXMub25JbnB1dERvd25IYW5kbGVyLCB0aGlzKTsKICAgIHRoaXMuZXZlbnRzLm9uSW5wdXRVcC5hZGQodGhpcy5vbklucHV0VXBIYW5kbGVyLCB0aGlzKTsKCn07CgpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZSA9IFBoYXNlci5VdGlscy5leHRlbmQodHJ1ZSwgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUsIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCBQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5CdXR0b247CgovKioKKiBVc2VkIHRvIG1hbnVhbGx5IHNldCB0aGUgZnJhbWVzIHRoYXQgd2lsbCBiZSB1c2VkIGZvciB0aGUgZGlmZmVyZW50IHN0YXRlcyBvZiB0aGUgYnV0dG9uCiogZXhhY3RseSBsaWtlIHNldHRpbmcgdGhlbSBpbiB0aGUgY29uc3RydWN0b3IuCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldEZyYW1lcwoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW292ZXJGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG92ZXIgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3V0RnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdXQgc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZG93bkZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYSBkb3duIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRGcmFtZXMgPSBmdW5jdGlvbiAob3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lKSB7CgogICAgaWYgKG92ZXJGcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIG92ZXJGcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbk92ZXJGcmFtZU5hbWUgPSBvdmVyRnJhbWU7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IG92ZXJGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbk92ZXJGcmFtZUlEID0gb3ZlckZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlck92ZXIoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IG92ZXJGcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAob3V0RnJhbWUgIT09IG51bGwpCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBvdXRGcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbk91dEZyYW1lTmFtZSA9IG91dEZyYW1lOwogICAgICAgICAgICB0aGlzLl9vblVwRnJhbWVOYW1lID0gb3V0RnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IG91dEZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3V0RnJhbWVJRCA9IG91dEZyYW1lOwogICAgICAgICAgICB0aGlzLl9vblVwRnJhbWVJRCA9IG91dEZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlck92ZXIoKSA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IG91dEZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGlmIChkb3duRnJhbWUgIT09IG51bGwpCiAgICB7CiAgICAgICAgaWYgKHR5cGVvZiBkb3duRnJhbWUgPT09ICdzdHJpbmcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25Eb3duRnJhbWVOYW1lID0gZG93bkZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlckRvd24oKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBkb3duRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25Eb3duRnJhbWVJRCA9IGRvd25GcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJEb3duKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBkb3duRnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9OwoKLyoqCiogU2V0cyB0aGUgc291bmRzIHRvIGJlIHBsYXllZCB3aGVuZXZlciB0aGlzIEJ1dHRvbiBpcyBpbnRlcmFjdGVkIHdpdGguIFNvdW5kcyBjYW4gYmUgZWl0aGVyIGZ1bGwgU291bmQgb2JqZWN0cywgb3IgbWFya2VycyBwb2ludGluZyB0byBhIHNlY3Rpb24gb2YgYSBTb3VuZCBvYmplY3QuCiogVGhlIG1vc3QgY29tbW9uIGZvcm1zIG9mIHNvdW5kcyBhcmUgJ2hvdmVyJyBlZmZlY3RzIGFuZCAnY2xpY2snIGVmZmVjdHMsIHdoaWNoIGlzIHdoeSB0aGUgb3JkZXIgb2YgdGhlIHBhcmFtZXRlcnMgaXMgb3ZlclNvdW5kIHRoZW4gZG93blNvdW5kLgoqIENhbGwgdGhpcyBmdW5jdGlvbiB3aXRoIG5vIHBhcmFtZXRlcnMgYXQgYWxsIHRvIHJlc2V0IGFsbCBzb3VuZHMgb24gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFNvdW5kcwoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbb3ZlclNvdW5kXSAtIE92ZXIgQnV0dG9uIFNvdW5kLgoqIEBwYXJhbSB7c3RyaW5nfSBbb3Zlck1hcmtlcl0gLSBPdmVyIEJ1dHRvbiBTb3VuZCBNYXJrZXIuCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtkb3duU291bmRdIC0gRG93biBCdXR0b24gU291bmQuCiogQHBhcmFtIHtzdHJpbmd9IFtkb3duTWFya2VyXSAtIERvd24gQnV0dG9uIFNvdW5kIE1hcmtlci4KKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW291dFNvdW5kXSAtIE91dCBCdXR0b24gU291bmQuCiogQHBhcmFtIHtzdHJpbmd9IFtvdXRNYXJrZXJdIC0gT3V0IEJ1dHRvbiBTb3VuZCBNYXJrZXIuCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IFt1cFNvdW5kXSAtIFVwIEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW3VwTWFya2VyXSAtIFVwIEJ1dHRvbiBTb3VuZCBNYXJrZXIuCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFNvdW5kcyA9IGZ1bmN0aW9uIChvdmVyU291bmQsIG92ZXJNYXJrZXIsIGRvd25Tb3VuZCwgZG93bk1hcmtlciwgb3V0U291bmQsIG91dE1hcmtlciwgdXBTb3VuZCwgdXBNYXJrZXIpIHsKCiAgICB0aGlzLnNldE92ZXJTb3VuZChvdmVyU291bmQsIG92ZXJNYXJrZXIpOwogICAgdGhpcy5zZXRPdXRTb3VuZChvdXRTb3VuZCwgb3V0TWFya2VyKTsKICAgIHRoaXMuc2V0VXBTb3VuZCh1cFNvdW5kLCB1cE1hcmtlcik7CiAgICB0aGlzLnNldERvd25Tb3VuZChkb3duU291bmQsIGRvd25NYXJrZXIpOwoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBtb3ZlcyBvdmVyIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRPdmVyU291bmQKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgU291bmQgdGhhdCB3aWxsIGJlIHBsYXllZC4KKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcl0gLSBBIFNvdW5kIE1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBpbiB0aGUgcGxheWJhY2suCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE92ZXJTb3VuZCA9IGZ1bmN0aW9uIChzb3VuZCwgbWFya2VyKSB7CgogICAgdGhpcy5vbk92ZXJTb3VuZCA9IG51bGw7CiAgICB0aGlzLm9uT3ZlclNvdW5kTWFya2VyID0gJyc7CgogICAgaWYgKHNvdW5kIGluc3RhbmNlb2YgUGhhc2VyLlNvdW5kKQogICAgewogICAgICAgIHRoaXMub25PdmVyU291bmQgPSBzb3VuZDsKICAgIH0KCiAgICBpZiAodHlwZW9mIG1hcmtlciA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAgICAgdGhpcy5vbk92ZXJTb3VuZE1hcmtlciA9IG1hcmtlcjsKICAgIH0KCn0KCi8qKgoqIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiBhIFBvaW50ZXIgbW92ZXMgb3V0IG9mIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRPdXRTb3VuZAoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCB0aGF0IHdpbGwgYmUgcGxheWVkLgoqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyXSAtIEEgU291bmQgTWFya2VyIHRoYXQgd2lsbCBiZSB1c2VkIGluIHRoZSBwbGF5YmFjay4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0T3V0U291bmQgPSBmdW5jdGlvbiAoc291bmQsIG1hcmtlcikgewoKICAgIHRoaXMub25PdXRTb3VuZCA9IG51bGw7CiAgICB0aGlzLm9uT3V0U291bmRNYXJrZXIgPSAnJzsKCiAgICBpZiAoc291bmQgaW5zdGFuY2VvZiBQaGFzZXIuU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbk91dFNvdW5kID0gc291bmQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXJrZXIgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMub25PdXRTb3VuZE1hcmtlciA9IG1hcmtlcjsKICAgIH0KCn0KCi8qKgoqIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiBhIFBvaW50ZXIgY2xpY2tzIG9uIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRVcFNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRVcFNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uVXBTb3VuZCA9IG51bGw7CiAgICB0aGlzLm9uVXBTb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uVXBTb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uVXBTb3VuZE1hcmtlciA9IG1hcmtlcjsKICAgIH0KCn0KCi8qKgoqIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiBhIFBvaW50ZXIgY2xpY2tzIG9uIHRoaXMgQnV0dG9uLgoqCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXREb3duU291bmQKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgU291bmQgdGhhdCB3aWxsIGJlIHBsYXllZC4KKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcl0gLSBBIFNvdW5kIE1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBpbiB0aGUgcGxheWJhY2suCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldERvd25Tb3VuZCA9IGZ1bmN0aW9uIChzb3VuZCwgbWFya2VyKSB7CgogICAgdGhpcy5vbkRvd25Tb3VuZCA9IG51bGw7CiAgICB0aGlzLm9uRG93blNvdW5kTWFya2VyID0gJyc7CgogICAgaWYgKHNvdW5kIGluc3RhbmNlb2YgUGhhc2VyLlNvdW5kKQogICAgewogICAgICAgIHRoaXMub25Eb3duU291bmQgPSBzb3VuZDsKICAgIH0KCiAgICBpZiAodHlwZW9mIG1hcmtlciA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAgICAgdGhpcy5vbkRvd25Tb3VuZE1hcmtlciA9IG1hcmtlcjsKICAgIH0KCn0KCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE92ZXJIYW5kbGVyID0gZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICBpZiAodGhpcy5mcmVlemVGcmFtZXMgPT0gZmFsc2UpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX29uT3ZlckZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vbk92ZXJGcmFtZU5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX29uT3ZlckZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vbk92ZXJGcmFtZUlEOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5vbk92ZXJTb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3ZlclNvdW5kLnBsYXkodGhpcy5vbk92ZXJTb3VuZE1hcmtlcik7CiAgICB9CgogICAgaWYgKHRoaXMub25JbnB1dE92ZXIpCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0T3Zlci5kaXNwYXRjaCh0aGlzLCBwb2ludGVyKTsKICAgIH0KfTsKCi8qKgoqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgaGFuZGxlcyBpbnB1dCBldmVudHMuCioKKiBAcHJvdGVjdGVkCiogQG1ldGhvZCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIKKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyIC0gVGhlIFBvaW50ZXIgdGhhdCBhY3RpdmF0ZWQgdGhlIEJ1dHRvbi4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE91dEhhbmRsZXIgPSBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PSBmYWxzZSkKICAgIHsKICAgICAgICBpZiAodGhpcy5fb25PdXRGcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25PdXRGcmFtZU5hbWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX29uT3V0RnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uT3V0RnJhbWVJRDsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMub25PdXRTb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3V0U291bmQucGxheSh0aGlzLm9uT3V0U291bmRNYXJrZXIpOwogICAgfQoKICAgIGlmICh0aGlzLm9uSW5wdXRPdXQpCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0T3V0LmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0RG93bkhhbmRsZXIgPSBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PSBmYWxzZSkKICAgIHsKICAgICAgICBpZiAodGhpcy5fb25Eb3duRnJhbWVOYW1lICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHRoaXMuX29uRG93bkZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25Eb3duRnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uRG93bkZyYW1lSUQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLm9uRG93blNvdW5kKQogICAgewogICAgICAgIHRoaXMub25Eb3duU291bmQucGxheSh0aGlzLm9uRG93blNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0RG93bikKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXREb3duLmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0VXBIYW5kbGVyID0gZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICBpZiAodGhpcy5mcmVlemVGcmFtZXMgPT0gZmFsc2UpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX29uVXBGcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25VcEZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25VcEZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vblVwRnJhbWVJRDsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMub25VcFNvdW5kKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kLnBsYXkodGhpcy5vblVwU291bmRNYXJrZXIpOwogICAgfQoKICAgIGlmICh0aGlzLmZvcmNlT3V0ICYmIHRoaXMuZnJlZXplRnJhbWVzID09IGZhbHNlKQogICAgewogICAgICAgIGlmICh0aGlzLl9vbk91dEZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vbk91dEZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25PdXRGcmFtZUlEICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lID0gdGhpcy5fb25PdXRGcmFtZUlEOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0VXApCiAgICB7CiAgICAgICAgdGhpcy5vbklucHV0VXAuZGlzcGF0Y2godGhpcywgcG9pbnRlcik7CiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyA8Y29kZT5HcmFwaGljczwvY29kZT4gb2JqZWN0LgoqIAoqIEBjbGFzcyBQaGFzZXIuR3JhcGhpY3MKKiBAY29uc3RydWN0b3IKKgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGdyYXBoaWNzIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiovClBoYXNlci5HcmFwaGljcyA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5KSB7CgogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICBQSVhJLkdyYXBoaWNzLmNhbGwodGhpcyk7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHR5cGUgLSBEZXNjcmlwdGlvbi4KCSovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuR1JBUEhJQ1M7CgogICAgdGhpcy5wb3NpdGlvbi54ID0geDsKICAgIHRoaXMucG9zaXRpb24ueSA9IHk7ICAgIAoKfTsKClBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuR3JhcGhpY3MucHJvdG90eXBlKTsKUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5HcmFwaGljczsKCi8vICBBZGQgb3VyIG93biBjdXN0b20gbWV0aG9kcwoKLyoqCiogRGVzY3JpcHRpb24uCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5kZXN0cm95CiovClBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMuY2xlYXIoKTsKCiAgICBpZiAodGhpcy5ncm91cCkKICAgIHsKICAgICAgICB0aGlzLmdyb3VwLnJlbW92ZSh0aGlzKTsKICAgIH0KCiAgICB0aGlzLmdhbWUgPSBudWxsOwoKfQoKLyoKKiBEcmF3cyBhIHtQaGFzZXIuUG9seWdvbn0gb3IgYSB7UElYSS5Qb2x5Z29ufSBmaWxsZWQKKi8KUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZS5kcmF3UG9seWdvbiA9IGZ1bmN0aW9uIChwb2x5KSB7CgogICAgZ3JhcGhpY3MubW92ZVRvKHBvbHkucG9pbnRzWzBdLngsIHBvbHkucG9pbnRzWzBdLnkpOwoKICAgIGZvciAodmFyIGkgPSAxOyBpIDwgcG9seS5wb2ludHMubGVuZ3RoOyBpICs9IDEpCiAgICB7CiAgICAgICAgZ3JhcGhpY3MubGluZVRvKHBvbHkucG9pbnRzW2ldLngsIHBvbHkucG9pbnRzW2ldLnkpOwogICAgfQoKICAgIGdyYXBoaWNzLmxpbmVUbyhwb2x5LnBvaW50c1swXS54LCBwb2x5LnBvaW50c1swXS55KTsKICAgIAp9CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLndyYXBBbmdsZShQaGFzZXIuTWF0aC5yYWRUb0RlZyh0aGlzLnJvdGF0aW9uKSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnJvdGF0aW9uID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoUGhhc2VyLk1hdGgud3JhcEFuZ2xlKHZhbHVlKSk7CiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLCAneCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBvc2l0aW9uLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLnBvc2l0aW9uLnggPSB2YWx1ZTsKICAgIH0KCn0pOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUsICd5JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIFJlbmRlclRleHR1cmUgaXMgYSBzcGVjaWFsIHRleHR1cmUgdGhhdCBhbGxvd3MgYW55IGRpc3BsYXlPYmplY3QgdG8gYmUgcmVuZGVyZWQgdG8gaXQuCiogQGNsYXNzIFBoYXNlci5SZW5kZXJUZXh0dXJlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgcmVuZGVyIHRleHR1cmUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodCBvZiB0aGUgcmVuZGVyIHRleHR1cmUuCiovClBoYXNlci5SZW5kZXJUZXh0dXJlID0gZnVuY3Rpb24gKGdhbWUsIGtleSwgd2lkdGgsIGhlaWdodCkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gdGhlIG5hbWUgb2YgdGhlIG9iamVjdC4gCgkqLwogICAgdGhpcy5uYW1lID0ga2V5OwoKCVBJWEkuRXZlbnRUYXJnZXQuY2FsbCh0aGlzKTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoLiAKICAgICovCgl0aGlzLndpZHRoID0gd2lkdGggfHwgMTAwOwoJCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQuIAogICAgKi8KCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDEwMDsKCgkvKioKICAgICogQHByb3BlcnR5IHtQSVhJLm1hdDN9IGluZGV0aXR5TWF0cml4IC0gTWF0cml4IG9iamVjdC4gCiAJKi8KCXRoaXMuaW5kZXRpdHlNYXRyaXggPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UElYSS5SZWN0YW5nbGV9IGZyYW1lIC0gVGhlIGZyYW1lIGZvciB0aGlzIHRleHR1cmUuIAogICAgKi8KCXRoaXMuZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwkKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBCYXNlIFBoYXNlciBvYmplY3QgdHlwZS4gCiAgICAqLwoJdGhpcy50eXBlID0gUGhhc2VyLlJFTkRFUlRFWFRVUkU7CgoJdGhpcy5fdGVtcFBvaW50ID0geyB4OiAwLCB5OiAwIH07CgoJaWYgKFBJWEkuZ2wpCgl7CgkJdGhpcy5pbml0V2ViR0woKTsKCX0KCWVsc2UKCXsKCQl0aGlzLmluaXRDYW52YXMoKTsKCX0KCQp9OwoKUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlRleHR1cmUucHJvdG90eXBlKTsKUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SZW5kZXJUZXh0dXJlOwoKLyoqCiogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLiBJZiB0aGUgZGlzcGxheSBvYmplY3QgaXMgYSBHcm91cCBvciBoYXMgY2hpbGRyZW4gaXQgd2lsbAoqIGRyYXcgYWxsIGNoaWxkcmVuIGFzIHdlbGwuCioKKiBAbWV0aG9kIHJlbmRlcgoqIEBwYXJhbSB7RGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uLgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbcG9zaXRpb25dIC0gV2hlcmUgdG8gZHJhdyB0aGUgZGlzcGxheSBvYmplY3QuCiogQHBhcmFtIHtib29sZWFufSBbY2xlYXI9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKSB7CgoJaWYgKHR5cGVvZiBwb3NpdGlvbiA9PT0gJ3VuZGVmaW5lZCcpIHsgcG9zaXRpb24gPSBmYWxzZTsgfQoJaWYgKHR5cGVvZiBjbGVhciA9PT0gJ3VuZGVmaW5lZCcpIHsgY2xlYXIgPSBmYWxzZTsgfQoKCWlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUGhhc2VyLkdyb3VwKQoJewoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9jb250YWluZXI7Cgl9CgoJaWYgKFBJWEkuZ2wpCgl7CgkJdGhpcy5yZW5kZXJXZWJHTChkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIpOwoJfQoJZWxzZQoJewoJCXRoaXMucmVuZGVyQ2FudmFzKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhcik7Cgl9Cgp9CgovKioKKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUgYXQgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcy4KKiBJZiB0aGUgZGlzcGxheSBvYmplY3QgaXMgYSBHcm91cCBvciBoYXMgY2hpbGRyZW4gaXQgd2lsbCBkcmF3IGFsbCBjaGlsZHJlbiBhcyB3ZWxsLgoqCiogQG1ldGhvZCByZW5kZXJYWQoqIEBwYXJhbSB7RGlzcGxheU9iamVjdH0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgYXQuCiogQHBhcmFtIHtib29sZWFufSBbY2xlYXI9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduLgoqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyWFkgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCB4LCB5LCBjbGVhcikgewoKCXRoaXMuX3RlbXBQb2ludC54ID0geDsKCXRoaXMuX3RlbXBQb2ludC55ID0geTsKCgl0aGlzLnJlbmRlcihkaXNwbGF5T2JqZWN0LCB0aGlzLl90ZW1wUG9pbnQsIGNsZWFyKTsKCn0KCi8qKgogKiBJbml0aWFsaXplcyB0aGUgd2ViZ2wgZGF0YSBmb3IgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgaW5pdFdlYkdMCiAqIEBwcml2YXRlCiAqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuaW5pdFdlYkdMID0gZnVuY3Rpb24oKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoJdGhpcy5nbEZyYW1lYnVmZmVyID0gZ2wuY3JlYXRlRnJhbWVidWZmZXIoKTsKCiAgIAlnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci53aWR0aCA9IHRoaXMud2lkdGg7CiAgICB0aGlzLmdsRnJhbWVidWZmZXIuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CQoKCXRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSgpOwoKCXRoaXMuYmFzZVRleHR1cmUud2lkdGggPSB0aGlzLndpZHRoOwoJdGhpcy5iYXNlVGV4dHVyZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoKCWdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7CgogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7CgoJdGhpcy5iYXNlVGV4dHVyZS5pc1JlbmRlciA9IHRydWU7CgoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCWdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGdsLkZSQU1FQlVGRkVSLCBnbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlLCAwKTsKCgkvLyBjcmVhdGUgYSBwcm9qZWN0aW9uIG1hdHJpeC4uCgl0aGlzLnByb2plY3Rpb24gPSBuZXcgUElYSS5Qb2ludCh0aGlzLndpZHRoLzIgLCAtdGhpcy5oZWlnaHQvMik7CgoJLy8gc2V0IHRoZSBjb3JyZWN0IHJlbmRlciBmdW5jdGlvbi4uCgkvLyB0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyV2ViR0w7Cn0KCgpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoKCXRoaXMud2lkdGggPSB3aWR0aDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoJCglpZihQSVhJLmdsKQoJewoJCXRoaXMucHJvamVjdGlvbi54ID0gdGhpcy53aWR0aC8yCgkJdGhpcy5wcm9qZWN0aW9uLnkgPSAtdGhpcy5oZWlnaHQvMjsKCQoJCXZhciBnbCA9IFBJWEkuZ2w7CgkJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKCQlnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsICB0aGlzLndpZHRoLCAgdGhpcy5oZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwoJfQoJZWxzZQoJewoJCQoJCXRoaXMuZnJhbWUud2lkdGggPSB0aGlzLndpZHRoCgkJdGhpcy5mcmFtZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCQl0aGlzLnJlbmRlcmVyLnJlc2l6ZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7Cgl9Cn0KCi8qKgogKiBJbml0aWFsaXplcyB0aGUgY2FudmFzIGRhdGEgZm9yIHRoaXMgdGV4dHVyZQogKgogKiBAbWV0aG9kIGluaXRDYW52YXMKICogQHByaXZhdGUKICovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0Q2FudmFzID0gZnVuY3Rpb24oKQp7Cgl0aGlzLnJlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQsIG51bGwsIDApOwoKCXRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSh0aGlzLnJlbmRlcmVyLnZpZXcpOwoJdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgoJLy8gdGhpcy5yZW5kZXIgPSB0aGlzLnJlbmRlckNhbnZhczsKfQoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZS4KICoKICogQG1ldGhvZCByZW5kZXJXZWJHTAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24KICogQHBhcmFtIGNsZWFyIHtCb29sZWFufSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24KICogQHByaXZhdGUKICovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJXZWJHTCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhcikKewoJdmFyIGdsID0gUElYSS5nbDsKCgkvLyBlbmFibGUgdGhlIGFscGhhIGNvbG9yIG1hc2suLgoJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOyAKCglnbC52aWV3cG9ydCgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CQoKCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgoJaWYoY2xlYXIpCgl7CgkJZ2wuY2xlYXJDb2xvcigwLDAsMCwgMCk7ICAgICAKCQlnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCX0KCgkvLyBUSElTIFdJTEwgTUVTUyBXSVRIIEhJVCBURVNUSU5HIQoJdmFyIGNoaWxkcmVuID0gZGlzcGxheU9iamVjdC5jaGlsZHJlbjsKCgkvL1RPRE8gLT8gY3JlYXRlIGEgbmV3IG9uZT8/PyBkb250IHRoaW5rIHNvIQoJdmFyIG9yaWdpbmFsV29ybGRUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsvL3N0aGlzLmluZGV0aXR5TWF0cml4OwoJLy8gbW9kaWZ5IHRvIGZsaXAuLi4KCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0gPSAtMTsKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSB0aGlzLnByb2plY3Rpb24ueSAqIC0yOwoKCWlmKHBvc2l0aW9uKQoJewoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gLT0gcG9zaXRpb24ueTsKCX0KCQoJUElYSS52aXNpYmxlQ291bnQrKzsKCWRpc3BsYXlPYmplY3QudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CgkKCWZvcih2YXIgaT0wLGo9Y2hpbGRyZW4ubGVuZ3RoOyBpPGo7IGkrKykKCXsKCQljaGlsZHJlbltpXS51cGRhdGVUcmFuc2Zvcm0oKTsJCgl9CgoJdmFyIHJlbmRlckdyb3VwID0gZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwOwoKCWlmKHJlbmRlckdyb3VwKQoJewoJCWlmKGRpc3BsYXlPYmplY3QgPT0gcmVuZGVyR3JvdXAucm9vdCkKCQl7CgkJCXJlbmRlckdyb3VwLnJlbmRlcih0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7CgkJfQoJCWVsc2UKCQl7CgkJCXJlbmRlckdyb3VwLnJlbmRlclNwZWNpZmljKGRpc3BsYXlPYmplY3QsIHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCQl9Cgl9CgllbHNlCgl7CgkJaWYoIXRoaXMucmVuZGVyR3JvdXApdGhpcy5yZW5kZXJHcm91cCA9IG5ldyBQSVhJLldlYkdMUmVuZGVyR3JvdXAoZ2wpOwoJCXRoaXMucmVuZGVyR3JvdXAuc2V0UmVuZGVyYWJsZShkaXNwbGF5T2JqZWN0KTsKCQl0aGlzLnJlbmRlckdyb3VwLnJlbmRlcih0aGlzLnByb2plY3Rpb24sIHRoaXMuZ2xGcmFtZWJ1ZmZlcik7Cgl9CgkKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBvcmlnaW5hbFdvcmxkVHJhbnNmb3JtOwp9CgoKLyoqCiAqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZS4KICoKICogQG1ldGhvZCByZW5kZXJDYW52YXMKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uCiAqIEBwYXJhbSBjbGVhciB7Qm9vbGVhbn0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduCiAqIEBwcml2YXRlCiAqLwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7Cgl2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgkKCWlmKHBvc2l0aW9uKQoJewoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSBwb3NpdGlvbi55OwoJfQoJCgoJZm9yKHZhciBpPTAsaj1jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCWNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KCglpZihjbGVhcil0aGlzLnJlbmRlcmVyLmNvbnRleHQuY2xlYXJSZWN0KDAsMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoJCiAgICB0aGlzLnJlbmRlcmVyLnJlbmRlckRpc3BsYXlPYmplY3QoZGlzcGxheU9iamVjdCk7CiAgICAKICAgIHRoaXMucmVuZGVyZXIuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOyAKICAgIAoKICAvLyAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcy5iYXNlVGV4dHVyZSk7Cn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBDYW52YXMgY2xhc3MgaGFuZGxlcyBldmVyeXRoaW5nIHJlbGF0ZWQgdG8gdGhlICZsdDtjYW52YXMmZ3Q7IHRhZyBhcyBhIERPTSBFbGVtZW50LCBsaWtlIHN0eWxlcywgb2Zmc2V0LCBhc3BlY3QgcmF0aW8KKgoqIEBjbGFzcyBQaGFzZXIuQ2FudmFzCiogQHN0YXRpYwoqLwpQaGFzZXIuQ2FudmFzID0gewoKICAgIC8qKgogICAgKiBDcmVhdGVzIHRoZSAmbHQ7Y2FudmFzJmd0OyB0YWcKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLmNyZWF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgZGVzaXJlZCB3aWR0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBkZXNpcmVkIGhlaWdodC4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFRoZSBuZXdseSBjcmVhdGVkICZsdDtjYW52YXMmZ3Q7IHRhZy4KICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHdpZHRoID0gd2lkdGggfHwgMjU2OwogICAgICAgIGhlaWdodCA9IGhlaWdodCB8fCAyNTY7CgogICAgICAgIHZhciBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgICBjYW52YXMud2lkdGggPSB3aWR0aDsKICAgICAgICBjYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIGNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGhlIERPTSBvZmZzZXQgdmFsdWVzIG9mIGFueSBnaXZlbiBlbGVtZW50CiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5nZXRPZmZzZXQKICAgICogQHBhcmFtIHtIVE1MRWxlbWVudH0gZWxlbWVudCAtIFRoZSB0YXJnZXRlZCBlbGVtZW50IHRoYXQgd2Ugd2FudCB0byByZXRyaWV2ZSB0aGUgb2Zmc2V0LgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW3BvaW50XSAtIFRoZSBwb2ludCB3ZSB3YW50IHRvIHRha2UgdGhlIHgveSB2YWx1ZXMgb2YgdGhlIG9mZnNldC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSAtIEEgcG9pbnQgb2JqZXQgd2l0aCB0aGUgb2Zmc2V0WCBhbmQgWSBhcyBpdHMgcHJvcGVydGllcy4KICAgICovICAgIAogICAgZ2V0T2Zmc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgcG9pbnQpIHsKCiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50OwoKICAgICAgICB2YXIgYm94ID0gZWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgICAgICB2YXIgY2xpZW50VG9wID0gZWxlbWVudC5jbGllbnRUb3AgfHwgZG9jdW1lbnQuYm9keS5jbGllbnRUb3AgfHwgMDsKICAgICAgICB2YXIgY2xpZW50TGVmdCA9IGVsZW1lbnQuY2xpZW50TGVmdCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudExlZnQgfHwgMDsKICAgICAgICB2YXIgc2Nyb2xsVG9wID0gd2luZG93LnBhZ2VZT2Zmc2V0IHx8IGVsZW1lbnQuc2Nyb2xsVG9wIHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsVG9wOwogICAgICAgIHZhciBzY3JvbGxMZWZ0ID0gd2luZG93LnBhZ2VYT2Zmc2V0IHx8IGVsZW1lbnQuc2Nyb2xsTGVmdCB8fCBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQ7CgogICAgICAgIHBvaW50LnggPSBib3gubGVmdCArIHNjcm9sbExlZnQgLSBjbGllbnRMZWZ0OwogICAgICAgIHBvaW50LnkgPSBib3gudG9wICsgc2Nyb2xsVG9wIC0gY2xpZW50VG9wOwoKICAgICAgICByZXR1cm4gcG9pbnQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgYXNwZWN0IHJhdGlvIG9mIHRoZSBnaXZlbiBjYW52YXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5nZXRBc3BlY3RSYXRpbwogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIGdldCB0aGUgYXNwZWN0IHJhdGlvIGZyb20uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHJhdGlvIGJldHdlZW4gY2FudmFzJyB3aWR0aCBhbmQgaGVpZ2h0LgogICAgKi8gICAgICAgIAogICAgZ2V0QXNwZWN0UmF0aW86IGZ1bmN0aW9uIChjYW52YXMpIHsKICAgICAgICByZXR1cm4gY2FudmFzLndpZHRoIC8gY2FudmFzLmhlaWdodDsKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGJhY2tncm91bmQgY29sb3IgYmVoaW5kIHRoZSBjYW52YXMuIFRoaXMgY2hhbmdlcyB0aGUgY2FudmFzIHN0eWxlIHByb3BlcnR5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0QmFja2dyb3VuZENvbG9yCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gc2V0IHRoZSBiYWNrZ3JvdW5kIGNvbG9yIG9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIFRoZSBjb2xvciB0byBzZXQuIENhbiBiZSBpbiB0aGUgZm9ybWF0ICdyZ2IocixnLGIpJywgb3IgJyNSUkdHQkInIG9yIGFueSB2YWxpZCBDU1MgY29sb3IuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldEJhY2tncm91bmRDb2xvcjogZnVuY3Rpb24gKGNhbnZhcywgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDAsMCwwKSc7CgogICAgICAgIGNhbnZhcy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKICAgICAgICAKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHRvdWNoLWFjdGlvbiBwcm9wZXJ0eSBvbiB0aGUgY2FudmFzIHN0eWxlLiBDYW4gYmUgdXNlZCB0byBkaXNhYmxlIGRlZmF1bHQgYnJvd3NlciB0b3VjaCBhY3Rpb25zLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0VG91Y2hBY3Rpb24KICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIHRvdWNoIGFjdGlvbiBvbi4KICAgICogQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gLSBUaGUgdG91Y2ggYWN0aW9uIHRvIHNldC4gRGVmYXVsdHMgdG8gJ25vbmUnLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gVGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0VG91Y2hBY3Rpb246IGZ1bmN0aW9uIChjYW52YXMsIHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJ25vbmUnOwoKICAgICAgICBjYW52YXMuc3R5bGUubXNUb3VjaEFjdGlvbiA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnbXMtdG91Y2gtYWN0aW9uJ10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJ3RvdWNoLWFjdGlvbiddID0gdmFsdWU7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgdXNlci1zZWxlY3QgcHJvcGVydHkgb24gdGhlIGNhbnZhcyBzdHlsZS4gQ2FuIGJlIHVzZWQgdG8gZGlzYWJsZSBkZWZhdWx0IGJyb3dzZXIgc2VsZWN0aW9uIGFjdGlvbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRVc2VyU2VsZWN0CiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gc2V0IHRoZSB0b3VjaCBhY3Rpb24gb24uCiAgICAqIEBwYXJhbSB7U3RyaW5nfSBbdmFsdWVdIC0gVGhlIHRvdWNoIGFjdGlvbiB0byBzZXQuIERlZmF1bHRzIHRvICdub25lJy4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldFVzZXJTZWxlY3Q6IGZ1bmN0aW9uIChjYW52YXMsIHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgJ25vbmUnOwoKICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtdG91Y2gtY2FsbG91dCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyctd2Via2l0LXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy1raHRtbC11c2VyLXNlbGVjdCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyctbW96LXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy1tcy11c2VyLXNlbGVjdCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyd1c2VyLXNlbGVjdCddID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWyctd2Via2l0LXRhcC1oaWdobGlnaHQtY29sb3InXSA9ICdyZ2JhKDAsIDAsIDAsIDApJzsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHRoZSBnaXZlbiBjYW52YXMgZWxlbWVudCB0byB0aGUgRE9NLiBUaGUgY2FudmFzIHdpbGwgYmUgYWRkZWQgYXMgYSBjaGlsZCBvZiB0aGUgZ2l2ZW4gcGFyZW50LgogICAgKiBJZiBubyBwYXJlbnQgaXMgZ2l2ZW4gaXQgd2lsbCBiZSBhZGRlZCBhcyBhIGNoaWxkIG9mIHRoZSBkb2N1bWVudC5ib2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuYWRkVG9ET00KICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIHRvdWNoIGFjdGlvbiBvbi4KICAgICogQHBhcmFtIHtzdHJpbmd8SFRNTEVsZW1lbnR9IHBhcmVudCAtIFRoZSBET00gZWxlbWVudCB0byBhZGQgdGhlIGNhbnZhcyB0by4gRGVmYXVsdHMgdG8gJycuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcmZsb3dIaWRkZW4gLSBJZiBzZXQgdG8gdHJ1ZSBpdCB3aWxsIGFkZCB0aGUgb3ZlcmZsb3c9J2hpZGRlbicgc3R5bGUgdG8gdGhlIHBhcmVudCBET00gZWxlbWVudC4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFJldHVybnMgdGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgYWRkVG9ET006IGZ1bmN0aW9uIChjYW52YXMsIHBhcmVudCwgb3ZlcmZsb3dIaWRkZW4pIHsKCiAgICAgICAgdmFyIHRhcmdldDsKCiAgICAgICAgaWYgKHR5cGVvZiBvdmVyZmxvd0hpZGRlbiA9PT0gJ3VuZGVmaW5lZCcpIHsgb3ZlcmZsb3dIaWRkZW4gPSB0cnVlOyB9CgogICAgICAgIGlmIChwYXJlbnQpCiAgICAgICAgewogICAgICAgICAgICAvLyBob3BlZnVsbHkgYW4gZWxlbWVudCBJRAogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHBhcmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gcXVpY2sgdGVzdCBmb3IgYSBIVE1MZWxlbWVudAogICAgICAgICAgICBlbHNlIGlmICh0eXBlb2YgcGFyZW50ID09PSAnb2JqZWN0JyAmJiBwYXJlbnQubm9kZVR5cGUgPT09IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhcmdldCA9IHBhcmVudDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG92ZXJmbG93SGlkZGVuKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0YXJnZXQuc3R5bGUub3ZlcmZsb3cgPSAnaGlkZGVuJzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gZmFsbGJhY2ssIGNvdmVycyBhbiBpbnZhbGlkIElEIGFuZCBhIG5vbmUgSFRNTGVsZW1lbnQgb2JqZWN0CiAgICAgICAgaWYoIXRhcmdldCkKICAgICAgICB7CiAgICAgICAgICAgIHRhcmdldCA9IGRvY3VtZW50LmJvZHk7CiAgICAgICAgfQoKICAgICAgICB0YXJnZXQuYXBwZW5kQ2hpbGQoY2FudmFzKTsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB0cmFuc2Zvcm0gb2YgdGhlIGdpdmVuIGNhbnZhcyB0byB0aGUgbWF0cml4IHZhbHVlcyBwcm92aWRlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFRyYW5zZm9ybQogICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dCAtIFRoZSBjb250ZXh0IHRvIHNldCB0aGUgdHJhbnNmb3JtIG9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWCAtIFRoZSB2YWx1ZSB0byB0cmFuc2xhdGUgaG9yaXpvbnRhbGx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gdHJhbnNsYXRlWSAtIFRoZSB2YWx1ZSB0byB0cmFuc2xhdGUgdmVydGljYWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxlWCAtIFRoZSB2YWx1ZSB0byBzY2FsZSBob3Jpem9udGFsbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzY2FsZVkgLSBUaGUgdmFsdWUgdG8gc2NhbGUgdmVydGljYWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNrZXdYIC0gVGhlIHZhbHVlIHRvIHNrZXcgaG9yaXpvbnRhbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBza2V3WSAtIFRoZSB2YWx1ZSB0byBza2V3IHZlcnRpY2FsbHkgYnkuCiAgICAqIEByZXR1cm4ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gUmV0dXJucyB0aGUgc291cmNlIGNvbnRleHQuCiAgICAqLwogICAgc2V0VHJhbnNmb3JtOiBmdW5jdGlvbiAoY29udGV4dCwgdHJhbnNsYXRlWCwgdHJhbnNsYXRlWSwgc2NhbGVYLCBzY2FsZVksIHNrZXdYLCBza2V3WSkgewoKICAgICAgICBjb250ZXh0LnNldFRyYW5zZm9ybShzY2FsZVgsIHNrZXdYLCBza2V3WSwgc2NhbGVZLCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZKTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgSW1hZ2UgU21vb3RoaW5nIHByb3BlcnR5IG9uIHRoZSBnaXZlbiBjb250ZXh0LiBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZSBpbWFnZSBzbW9vdGhpbmcuCiAgICAqIEJ5IGRlZmF1bHQgYnJvd3NlcnMgaGF2ZSBpbWFnZSBzbW9vdGhpbmcgZW5hYmxlZCwgd2hpY2ggaXNuJ3QgYWx3YXlzIHdoYXQgeW91IHZpc3VhbGx5IHdhbnQsIGVzcGVjaWFsbHkKICAgICogd2hlbiB1c2luZyBwaXhlbCBhcnQgaW4gYSBnYW1lLiBOb3RlIHRoYXQgdGhpcyBzZXRzIHRoZSBwcm9wZXJ0eSBvbiB0aGUgY29udGV4dCBpdHNlbGYsIHNvIHRoYXQgYW55IGltYWdlCiAgICAqIGRyYXduIHRvIHRoZSBjb250ZXh0IHdpbGwgYmUgYWZmZWN0ZWQuIFRoaXMgc2V0cyB0aGUgcHJvcGVydHkgYWNyb3NzIGFsbCBjdXJyZW50IGJyb3dzZXJzIGJ1dCBzdXBwb3J0IGlzCiAgICAqIHBhdGNoeSBvbiBlYXJsaWVyIGJyb3dzZXJzLCBlc3BlY2lhbGx5IG9uIG1vYmlsZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFNtb290aGluZ0VuYWJsZWQKICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgY29udGV4dCB0byBlbmFibGUgb3IgZGlzYWJsZSB0aGUgaW1hZ2Ugc21vb3RoaW5nIG9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZhbHVlIC0gSWYgc2V0IHRvIHRydWUgaXQgd2lsbCBlbmFibGUgaW1hZ2Ugc21vb3RoaW5nLCBmYWxzZSB3aWxsIGRpc2FibGUgaXQuCiAgICAqIEByZXR1cm4ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gUmV0dXJucyB0aGUgc291cmNlIGNvbnRleHQuCiAgICAqLwogICAgc2V0U21vb3RoaW5nRW5hYmxlZDogZnVuY3Rpb24gKGNvbnRleHQsIHZhbHVlKSB7CgogICAgICAgIGNvbnRleHRbJ2ltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CiAgICAgICAgY29udGV4dFsnbW96SW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0WydvSW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0Wyd3ZWJraXRJbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwogICAgICAgIGNvbnRleHRbJ21zSW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKCiAgICAgICAgcmV0dXJuIGNvbnRleHQ7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgQ1NTIGltYWdlLXJlbmRlcmluZyBwcm9wZXJ0eSBvbiB0aGUgZ2l2ZW4gY2FudmFzIHRvIGJlICdjcmlzcCcgKGFrYSAnb3B0aW1pemUgY29udHJhc3Qgb24gd2Via2l0JykuCiAgICAqIE5vdGUgdGhhdCBpZiB0aGlzIGRvZXNuJ3QgZ2l2ZW4gdGhlIGRlc2lyZWQgcmVzdWx0IHRoZW4gc2VlIHRoZSBzZXRTbW9vdGhpbmdFbmFibGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0SW1hZ2VSZW5kZXJpbmdDcmlzcAogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCBpbWFnZS1yZW5kZXJpbmcgY3Jpc3Agb24uCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldEltYWdlUmVuZGVyaW5nQ3Jpc3A6IGZ1bmN0aW9uIChjYW52YXMpIHsKCiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdjcmlzcC1lZGdlcyc7CiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICctbW96LWNyaXNwLWVkZ2VzJzsKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJy13ZWJraXQtb3B0aW1pemUtY29udHJhc3QnOwogICAgICAgIGNhbnZhcy5zdHlsZS5tc0ludGVycG9sYXRpb25Nb2RlID0gJ25lYXJlc3QtbmVpZ2hib3InOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIENTUyBpbWFnZS1yZW5kZXJpbmcgcHJvcGVydHkgb24gdGhlIGdpdmVuIGNhbnZhcyB0byBiZSAnYmljdWJpYycgKGFrYSAnYXV0bycpLgogICAgKiBOb3RlIHRoYXQgaWYgdGhpcyBkb2Vzbid0IGdpdmVuIHRoZSBkZXNpcmVkIHJlc3VsdCB0aGVuIHNlZSB0aGUgQ2FudmFzVXRpbHMuc2V0U21vb3RoaW5nRW5hYmxlZCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRJbWFnZVJlbmRlcmluZ0JpY3ViaWMKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIFRoZSBjYW52YXMgdG8gc2V0IGltYWdlLXJlbmRlcmluZyBiaWN1YmljIG9uLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRJbWFnZVJlbmRlcmluZ0JpY3ViaWM6IGZ1bmN0aW9uIChjYW52YXMpIHsKCiAgICAgICAgY2FudmFzLnN0eWxlWydpbWFnZS1yZW5kZXJpbmcnXSA9ICdhdXRvJzsKICAgICAgICBjYW52YXMuc3R5bGUubXNJbnRlcnBvbGF0aW9uTW9kZSA9ICdiaWN1YmljJzsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQW4gQW5pbWF0aW9uIGluc3RhbmNlIGNvbnRhaW5zIGEgc2luZ2xlIGFuaW1hdGlvbiBhbmQgdGhlIGNvbnRyb2xzIHRvIHBsYXkgaXQuCiogSXQgaXMgY3JlYXRlZCBieSB0aGUgQW5pbWF0aW9uTWFuYWdlciwgY29uc2lzdHMgb2YgQW5pbWF0aW9uLkZyYW1lIG9iamVjdHMgYW5kIGJlbG9uZ3MgdG8gYSBzaW5nbGUgR2FtZSBPYmplY3Qgc3VjaCBhcyBhIFNwcml0ZS4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUgCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlID0gZnVuY3Rpb24gKGdhbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBzdGFnZSBhZnRlciBjYWxjdWxhdGlvbi4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHN0YWdlIGFmdGVyIGNhbGN1bGF0aW9uLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluV2lkdGggLSBNaW5pbXVtIHdpZHRoIHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pbldpZHRoID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFdpZHRoIC0gTWF4aW11bSB3aWR0aCB0aGUgY2FudmFzIHNob3VsZCBiZSBzY2FsZWQgdG8gKGluIHBpeGVscykuCiAgICAqIElmIG51bGwgaXQgd2lsbCBzY2FsZSB0byB3aGF0ZXZlciB3aWR0aCB0aGUgYnJvd3NlciBjYW4gaGFuZGxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4V2lkdGggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluSGVpZ2h0IC0gTWluaW11bSBoZWlnaHQgdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluSGVpZ2h0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEhlaWdodCAtIE1heGltdW0gaGVpZ2h0IHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogSWYgbnVsbCBpdCB3aWxsIHNjYWxlIHRvIHdoYXRldmVyIGhlaWdodCB0aGUgYnJvd3NlciBjYW4gaGFuZGxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4SGVpZ2h0ID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydEhlaWdodCAtIFN0YWdlIGhlaWdodCB3aGVuIHN0YXJ0aW5nIHRoZSBnYW1lLgogICAgKiBAZGVmYXVsdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N0YXJ0SGVpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZUxhbmRzY2FwZSAtIElmIHRoZSBnYW1lIHNob3VsZCBiZSBmb3JjZWQgdG8gdXNlIExhbmRzY2FwZSBtb2RlLCB0aGlzIGlzIHNldCB0byB0cnVlIGJ5IEdhbWUuU3RhZ2UKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZvcmNlTGFuZHNjYXBlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZm9yY2VQb3J0cmFpdCAtIElmIHRoZSBnYW1lIHNob3VsZCBiZSBmb3JjZWQgdG8gdXNlIFBvcnRyYWl0IG1vZGUsIHRoaXMgaXMgc2V0IHRvIHRydWUgYnkgR2FtZS5TdGFnZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgICB0aGlzLmZvcmNlUG9ydHJhaXQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpbmNvcnJlY3RPcmllbnRhdGlvbiAtIElmIHRoZSBnYW1lIHNob3VsZCBiZSBmb3JjZWQgdG8gdXNlIGEgc3BlY2lmaWMgb3JpZW50YXRpb24gYW5kIHRoZSBkZXZpY2UgY3VycmVudGx5IGlzbid0IGluIHRoYXQgb3JpZW50YXRpb24gdGhpcyBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFnZUFsaWduSG9yaXpvbnRhbGx5IC0gSWYgeW91IHdpc2ggdG8gYWxpZ24geW91ciBnYW1lIGluIHRoZSBtaWRkbGUgb2YgdGhlIHBhZ2UgdGhlbiB5b3UgY2FuIHNldCB0aGlzIHZhbHVlIHRvIHRydWUuCiAgICAqIEl0IHdpbGwgcGxhY2UgYSByZS1jYWxjdWxhdGVkIG1hcmdpbi1sZWZ0IHBpeGVsIHZhbHVlIG9udG8gdGhlIGNhbnZhcyBlbGVtZW50IHdoaWNoIGlzIHVwZGF0ZWQgb24gb3JpZW50YXRpb24vcmVzaXppbmcuCiAgICAqIEl0IGRvZXNuJ3QgY2FyZSBhYm91dCBhbnkgb3RoZXIgRE9NIGVsZW1lbnQgdGhhdCBtYXkgYmUgb24gdGhlIHBhZ2UsIGl0IGxpdGVyYWxseSBqdXN0IHNldHMgdGhlIG1hcmdpbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VBbGlnbkhvcml6b250YWxseSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhZ2VBbGlnblZlcnRpY2FsbHkgLSBJZiB5b3Ugd2lzaCB0byBhbGlnbiB5b3VyIGdhbWUgaW4gdGhlIG1pZGRsZSBvZiB0aGUgcGFnZSB0aGVuIHlvdSBjYW4gc2V0IHRoaXMgdmFsdWUgdG8gdHJ1ZS4KICAgICogSXQgd2lsbCBwbGFjZSBhIHJlLWNhbGN1bGF0ZWQgbWFyZ2luLWxlZnQgcGl4ZWwgdmFsdWUgb250byB0aGUgY2FudmFzIGVsZW1lbnQgd2hpY2ggaXMgdXBkYXRlZCBvbiBvcmllbnRhdGlvbi9yZXNpemluZy4KICAgICogSXQgZG9lc24ndCBjYXJlIGFib3V0IGFueSBvdGhlciBET00gZWxlbWVudCB0aGF0IG1heSBiZSBvbiB0aGUgcGFnZSwgaXQgbGl0ZXJhbGx5IGp1c3Qgc2V0cyB0aGUgbWFyZ2luLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFnZUFsaWduVmVydGljYWxseSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3dpZHRoIC0gQ2FjaGVkIHN0YWdlIHdpZHRoIGZvciBmdWxsIHNjcmVlbiBtb2RlLgogICAgKiBAZGVmYXVsdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3dpZHRoID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9oZWlnaHQgLSBDYWNoZWQgc3RhZ2UgaGVpZ2h0IGZvciBmdWxsIHNjcmVlbiBtb2RlLgogICAgKiBAZGVmYXVsdAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2hlaWdodCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhJdGVyYXRpb25zIC0gVGhlIG1heGltdW0gbnVtYmVyIG9mIHRpbWVzIGl0IHdpbGwgdHJ5IHRvIHJlc2l6ZSB0aGUgY2FudmFzIHRvIGZpbGwgdGhlIGJyb3dzZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhJdGVyYXRpb25zID0gNTsKICAgIAoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BJWEkuU3ByaXRlfSBvcmllbnRhdGlvblNwcml0ZSAtIFRoZSBTcHJpdGUgdGhhdCBpcyBvcHRpb25hbGx5IGRpc3BsYXllZCBpZiB0aGUgYnJvd3NlciBlbnRlcnMgYW4gdW5zdXBwb3J0ZWQgb3JpZW50YXRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gZW50ZXJMYW5kc2NhcGUgLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIGxhbmRzY2FwZSBvcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmVudGVyTGFuZHNjYXBlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlclBvcnRyYWl0IC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGVudGVycyBob3Jpem9udGFsIG9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMuZW50ZXJQb3J0cmFpdCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gZW50ZXJJbmNvcnJlY3RPcmllbnRhdGlvbiAtIFRoZSBldmVudCB0aGF0IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgYW4gaW5jb3JyZWN0IG9yaWVudGF0aW9uLCBhcyBkZWZpbmVkIGJ5IGZvcmNlT3JpZW50YXRpb24uCiAgICAqLwogICAgdGhpcy5lbnRlckluY29ycmVjdE9yaWVudGF0aW9uID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBsZWF2ZUluY29ycmVjdE9yaWVudGF0aW9uIC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGxlYXZlcyBhbiBpbmNvcnJlY3Qgb3JpZW50YXRpb24sIGFzIGRlZmluZWQgYnkgZm9yY2VPcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIGlmICh3aW5kb3dbJ29yaWVudGF0aW9uJ10pCiAgICB7CiAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IHdpbmRvd1snb3JpZW50YXRpb24nXTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAod2luZG93Lm91dGVyV2lkdGggPiB3aW5kb3cub3V0ZXJIZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gOTA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSAwOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlRmFjdG9yIC0gVGhlIHNjYWxlIGZhY3RvciBiYXNlZCBvbiB0aGUgZ2FtZSBkaW1lbnNpb25zIHZzLiB0aGUgc2NhbGVkIGRpbWVuc2lvbnMuCiAgICAqLwogICAgdGhpcy5zY2FsZUZhY3RvciA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhc3BlY3RSYXRpbyAtIEFzcGVjdCByYXRpby4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFzcGVjdFJhdGlvID0gMDsKCiAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdvcmllbnRhdGlvbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5jaGVja09yaWVudGF0aW9uKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmNoZWNrUmVzaXplKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRmdWxsc2NyZWVuY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmZ1bGxTY3JlZW5DaGFuZ2UoZXZlbnQpOwogICAgfSwgZmFsc2UpOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuZnVsbFNjcmVlbkNoYW5nZShldmVudCk7CiAgICB9LCBmYWxzZSk7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5mdWxsU2NyZWVuQ2hhbmdlKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCQp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlLkVYQUNUX0ZJVCA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLlN0YWdlU2NhbGVNb2RlLlNIT1dfQUxMID0gMjsKClBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRyaWVzIHRvIGVudGVyIHRoZSBicm93c2VyIGludG8gZnVsbCBzY3JlZW4gbW9kZS4KICAgICogUGxlYXNlIG5vdGUgdGhhdCB0aGlzIG5lZWRzIHRvIGJlIHN1cHBvcnRlZCBieSB0aGUgd2ViIGJyb3dzZXIgYW5kIGlzbid0IHRoZSBzYW1lIHRoaW5nIGFzIHNldHRpbmcgeW91ciBnYW1lIHRvIGZpbGwgdGhlIGJyb3dzZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3N0YXJ0RnVsbFNjcmVlbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFudGlhbGlhcyAtIFlvdSBjYW4gdG9nZ2xlIHRoZSBhbnRpLWFsaWFzIGZlYXR1cmUgb2YgdGhlIGNhbnZhcyBiZWZvcmUganVtcGluZyBpbiB0byBmdWxsIHNjcmVlbiAoZmFsc2UgPSByZXRhaW4gcGl4ZWwgYXJ0LCB0cnVlID0gc21vb3RoIGFydCkKICAgICovCiAgICBzdGFydEZ1bGxTY3JlZW46IGZ1bmN0aW9uIChhbnRpYWxpYXMpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNGdWxsU2NyZWVuKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBhbnRpYWxpYXMgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRTbW9vdGhpbmdFbmFibGVkKHRoaXMuZ2FtZS5jb250ZXh0LCBhbnRpYWxpYXMpOwogICAgICAgIH0KCiAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmdhbWUuY2FudmFzOwogICAgICAgIAogICAgICAgIHRoaXMuX3dpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICB0aGlzLl9oZWlnaHQgPSB0aGlzLmhlaWdodDsKCiAgICAgICAgY29uc29sZS5sb2coJ3N0YXJ0RnVsbFNjcmVlbicsIHRoaXMuX3dpZHRoLCB0aGlzLl9oZWlnaHQpOwoKICAgICAgICBpZiAoZWxlbWVudFsncmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnRbJ3JlcXVlc3RGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZWxlbWVudFsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnRbJ21velJlcXVlc3RGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZWxlbWVudFsnd2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGVsZW1lbnRbJ3dlYmtpdFJlcXVlc3RGdWxsU2NyZWVuJ10oRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIGZ1bGwgc2NyZWVuIG1vZGUgaWYgdGhlIGJyb3dzZXIgaXMgaW4gaXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3N0b3BGdWxsU2NyZWVuCiAgICAqLwogICAgc3RvcEZ1bGxTY3JlZW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKGRvY3VtZW50WydjYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnY2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50Wydtb3pDYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnbW96Q2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRvY3VtZW50Wyd3ZWJraXRDYW5jZWxGdWxsU2NyZWVuJ10pCiAgICAgICAgewogICAgICAgICAgICBkb2N1bWVudFsnd2Via2l0Q2FuY2VsRnVsbFNjcmVlbiddKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIG9mIGxlYXZlcyBmdWxsIHNjcmVlbiBtb2RlLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNmdWxsU2NyZWVuQ2hhbmdlCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gVGhlIGZ1bGxzY3JlZW5jaGFuZ2UgZXZlbnQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGZ1bGxTY3JlZW5DaGFuZ2U6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5pc0Z1bGxTY3JlZW4pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlWyd3aWR0aCddID0gJzEwMCUnOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlWydoZWlnaHQnXSA9ICcxMDAlJzsKCiAgICAgICAgICAgIHRoaXMuc2V0TWF4aW11bSgpOwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnNjYWxlLnNldFRvKHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodCk7CgogICAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnggPSB0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoOwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ3dpZHRoJ10gPSB0aGlzLmdhbWUud2lkdGggKyAncHgnOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlWydoZWlnaHQnXSA9IHRoaXMuZ2FtZS5oZWlnaHQgKyAncHgnOwoKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMuX3dpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMuX2hlaWdodDsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS5zZXRUbyh0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQpOwoKICAgICAgICAgICAgdGhpcy5hc3BlY3RSYXRpbyA9IHRoaXMud2lkdGggLyB0aGlzLmhlaWdodDsKICAgICAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci54ID0gdGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aDsKICAgICAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci55ID0gdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0OwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBJZiB5b3UgbmVlZCB5b3VyIGdhbWUgdG8gcnVuIGluIG9ubHkgb25lIG9yaWVudGF0aW9uIHlvdSBjYW4gZm9yY2UgdGhhdCB0byBoYXBwZW4uCiAgICAqIFRoZSBvcHRpb25hbCBvcmllbnRhdGlvbkltYWdlIGlzIGRpc3BsYXllZCB3aGVuIHRoZSBnYW1lIGlzIGluIHRoZSBpbmNvcnJlY3Qgb3JpZW50YXRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2ZvcmNlT3JpZW50YXRpb24KICAgICogQHBhcmFtIHtib29sZWFufSBmb3JjZUxhbmRzY2FwZSAtIHRydWUgaWYgdGhlIGdhbWUgc2hvdWxkIHJ1biBpbiBsYW5kc2NhcGUgbW9kZSBvbmx5LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZVBvcnRyYWl0PWZhbHNlXSAtIHRydWUgaWYgdGhlIGdhbWUgc2hvdWxkIHJ1biBpbiBwb3J0cmFpdCBtb2RlIG9ubHkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbb3JpZW50YXRpb25JbWFnZT0nJ10gLSBUaGUgc3RyaW5nIG9mIGFuIGltYWdlIGluIHRoZSBQaGFzZXIuQ2FjaGUgdG8gZGlzcGxheSB3aGVuIHRoaXMgZ2FtZSBpcyBpbiB0aGUgaW5jb3JyZWN0IG9yaWVudGF0aW9uLgogICAgKi8KICAgIGZvcmNlT3JpZW50YXRpb246IGZ1bmN0aW9uIChmb3JjZUxhbmRzY2FwZSwgZm9yY2VQb3J0cmFpdCwgb3JpZW50YXRpb25JbWFnZSkgewoKICAgICAgICBpZiAodHlwZW9mIGZvcmNlUG9ydHJhaXQgPT09ICd1bmRlZmluZWQnKSB7IGZvcmNlUG9ydHJhaXQgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLmZvcmNlTGFuZHNjYXBlID0gZm9yY2VMYW5kc2NhcGU7CiAgICAgICAgdGhpcy5mb3JjZVBvcnRyYWl0ID0gZm9yY2VQb3J0cmFpdDsKCiAgICAgICAgaWYgKHR5cGVvZiBvcmllbnRhdGlvbkltYWdlICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChvcmllbnRhdGlvbkltYWdlID09IG51bGwgfHwgdGhpcy5nYW1lLmNhY2hlLmNoZWNrSW1hZ2VLZXkob3JpZW50YXRpb25JbWFnZSkgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uSW1hZ2UgPSAnX19kZWZhdWx0JzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZSA9IG5ldyBQSVhJLlNwcml0ZShQSVhJLlRleHR1cmVDYWNoZVtvcmllbnRhdGlvbkltYWdlXSk7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUuYW5jaG9yLnggPSAwLjU7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUuYW5jaG9yLnkgPSAwLjU7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUucG9zaXRpb24ueCA9IHRoaXMuZ2FtZS53aWR0aCAvIDI7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUucG9zaXRpb24ueSA9IHRoaXMuZ2FtZS5oZWlnaHQgLyAyOwoKICAgICAgICAgICAgdGhpcy5jaGVja09yaWVudGF0aW9uU3RhdGUoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlLmFkZENoaWxkKHRoaXMub3JpZW50YXRpb25TcHJpdGUpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgdGhlIGJyb3dzZXIgaXMgaW4gdGhlIGNvcnJlY3Qgb3JpZW50YXRpb24gZm9yIHlvdXIgZ2FtZSAoaWYgZm9yY2VMYW5kc2NhcGUgb3IgZm9yY2VQb3J0cmFpdCBoYXZlIGJlZW4gc2V0KQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNjaGVja09yaWVudGF0aW9uU3RhdGUKICAgICovCiAgICBjaGVja09yaWVudGF0aW9uU3RhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIFRoZXkgYXJlIGluIHRoZSB3cm9uZyBvcmllbnRhdGlvbgogICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCh0aGlzLmZvcmNlTGFuZHNjYXBlICYmIHdpbmRvdy5pbm5lcldpZHRoID4gd2luZG93LmlubmVySGVpZ2h0KSB8fCAodGhpcy5mb3JjZVBvcnRyYWl0ICYmIHdpbmRvdy5pbm5lckhlaWdodCA+IHdpbmRvdy5pbm5lcldpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEJhY2sgdG8gbm9ybWFsCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24uZGlzcGF0Y2goKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcmllbnRhdGlvblNwcml0ZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKCh0aGlzLmZvcmNlTGFuZHNjYXBlICYmIHdpbmRvdy5pbm5lcldpZHRoIDwgd2luZG93LmlubmVySGVpZ2h0KSB8fCAodGhpcy5mb3JjZVBvcnRyYWl0ICYmIHdpbmRvdy5pbm5lckhlaWdodCA8IHdpbmRvdy5pbm5lcldpZHRoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFNob3cgb3JpZW50YXRpb24gc2NyZWVuCiAgICAgICAgICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5lbnRlckluY29ycmVjdE9yaWVudGF0aW9uLmRpc3BhdGNoKCk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMub3JpZW50YXRpb25TcHJpdGUgJiYgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLndvcmxkLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIEhhbmRsZSB3aW5kb3cub3JpZW50YXRpb25jaGFuZ2UgZXZlbnRzCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2NoZWNrT3JpZW50YXRpb24KICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBUaGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZGF0YS4KICAgICovCiAgICBjaGVja09yaWVudGF0aW9uOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IHdpbmRvd1snb3JpZW50YXRpb24nXTsKCiAgICAgICAgaWYgKHRoaXMuaXNMYW5kc2NhcGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVudGVyTGFuZHNjYXBlLmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIHRydWUsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlclBvcnRyYWl0LmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIGZhbHNlLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlICE9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlIHdpbmRvdy5yZXNpemUgZXZlbnRzCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2NoZWNrUmVzaXplCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gVGhlIHJlc2l6ZSBldmVudCBkYXRhLgogICAgKi8KICAgIGNoZWNrUmVzaXplOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHdpbmRvdy5vdXRlcldpZHRoID4gd2luZG93Lm91dGVySGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IDkwOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzTGFuZHNjYXBlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlckxhbmRzY2FwZS5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCB0cnVlLCBmYWxzZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW50ZXJQb3J0cmFpdC5kaXNwYXRjaCh0aGlzLm9yaWVudGF0aW9uLCBmYWxzZSwgdHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSAhPT0gUGhhc2VyLlN0YWdlU2NhbGVNb2RlLk5PX1NDQUxFKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNoZWNrT3JpZW50YXRpb25TdGF0ZSgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlLWNhbGN1bGF0ZSBzY2FsZSBtb2RlIGFuZCB1cGRhdGUgc2NyZWVuIHNpemUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3JlZnJlc2gKICAgICovCiAgICByZWZyZXNoOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgCiAgICAgICAgLy8gIFdlIGNhbid0IGRvIGFueXRoaW5nIGFib3V0IHRoZSBzdGF0dXMgYmFycyBpbiBpUGFkcywgd2ViIGFwcHMgb3IgZGVza3RvcHMKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5pUGFkID09IGZhbHNlICYmIHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXBwID09IGZhbHNlICYmIHRoaXMuZ2FtZS5kZXZpY2UuZGVza3RvcCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsnc3R5bGUnXS5taW5IZWlnaHQgPSAnMjAwMHB4JzsKICAgICAgICAgICAgLy8gdGhpcy5fc3RhcnRIZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQ7CgogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5hbmRyb2lkICYmIHRoaXMuZ2FtZS5kZXZpY2UuY2hyb21lID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jaGVjayA9PSBudWxsICYmIHRoaXMubWF4SXRlcmF0aW9ucyA+IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pdGVyYXRpb25zID0gdGhpcy5tYXhJdGVyYXRpb25zOwogICAgICAgICAgICB0aGlzLl9jaGVjayA9IHdpbmRvdy5zZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuc2V0U2NyZWVuU2l6ZSgpOwogICAgICAgICAgICB9LCAxMCk7CiAgICAgICAgICAgIHRoaXMuc2V0U2NyZWVuU2l6ZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgc2NyZWVuIHNpemUgYXV0b21hdGljYWxseSBiYXNlZCBvbiB0aGUgc2NhbGVNb2RlLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvcmNlIC0gSWYgZm9yY2UgaXMgdHJ1ZSBpdCB3aWxsIHRyeSB0byByZXNpemUgdGhlIGdhbWUgcmVnYXJkbGVzcyBvZiB0aGUgZG9jdW1lbnQgZGltZW5zaW9ucy4KICAgICovCiAgICBzZXRTY3JlZW5TaXplOiBmdW5jdGlvbiAoZm9yY2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBmb3JjZSA9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIGZvcmNlID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlQYWQgPT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS53ZWJBcHAgPT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS5kZXNrdG9wID09IGZhbHNlKSAKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmFuZHJvaWQgJiYgdGhpcy5nYW1lLmRldmljZS5jaHJvbWUgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5faXRlcmF0aW9ucy0tOwoKICAgICAgICBpZiAoZm9yY2UgfHwgd2luZG93LmlubmVySGVpZ2h0ID4gdGhpcy5fc3RhcnRIZWlnaHQgfHwgdGhpcy5faXRlcmF0aW9ucyA8IDApCiAgICAgICAgewogICAgICAgICAgICAvLyBTZXQgbWluaW11bSBoZWlnaHQgb2YgY29udGVudCB0byBuZXcgd2luZG93IGhlaWdodAogICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnRbJ3N0eWxlJ10ubWluSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0ICsgJ3B4JzsKICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXRNYXhpbXVtKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSA9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuRVhBQ1RfRklUKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEV4YWN0Rml0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy5nYW1lLnN0YWdlLnNjYWxlTW9kZSA9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuU0hPV19BTEwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0U2hvd0FsbCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNldFNpemUoKTsKICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVjayk7CiAgICAgICAgICAgIHRoaXMuX2NoZWNrID0gbnVsbDsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgY2FudmFzIHN0eWxlIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzIGJhc2VkIG9uIG1pbldpZHRoL0hlaWdodCBhbmQgbWF4V2lkdGgvSGVpZ2h0LgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNzZXRTaXplCiAgICAqLwogICAgc2V0U2l6ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm1heFdpZHRoICYmIHRoaXMud2lkdGggPiB0aGlzLm1heFdpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tYXhXaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWF4SGVpZ2h0ICYmIHRoaXMuaGVpZ2h0ID4gdGhpcy5tYXhIZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5tYXhIZWlnaHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLm1pbldpZHRoICYmIHRoaXMud2lkdGggPCB0aGlzLm1pbldpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5taW5XaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWluSGVpZ2h0ICYmIHRoaXMuaGVpZ2h0IDwgdGhpcy5taW5IZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5taW5IZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUud2lkdGggPSB0aGlzLndpZHRoICsgJ3B4JzsKICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLmhlaWdodCA9IHRoaXMuaGVpZ2h0ICsgJ3B4JzsKICAgICAgICAKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc2NhbGUuc2V0VG8odGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0KTsKCiAgICAgICAgaWYgKHRoaXMucGFnZUFsaWduSG9yaXpvbnRhbGx5KQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMud2lkdGggPCB3aW5kb3cuaW5uZXJXaWR0aCAmJiB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpbkxlZnQgPSBNYXRoLnJvdW5kKCh3aW5kb3cuaW5uZXJXaWR0aCAtIHRoaXMud2lkdGgpIC8gMikgKyAncHgnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5tYXJnaW5MZWZ0ID0gJzBweCc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnBhZ2VBbGlnblZlcnRpY2FsbHkpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5oZWlnaHQgPCB3aW5kb3cuaW5uZXJIZWlnaHQgJiYgdGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS5tYXJnaW5Ub3AgPSBNYXRoLnJvdW5kKCh3aW5kb3cuaW5uZXJIZWlnaHQgLSB0aGlzLmhlaWdodCkgLyAyKSArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpblRvcCA9ICcwcHgnOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBQaGFzZXIuQ2FudmFzLmdldE9mZnNldCh0aGlzLmdhbWUuY2FudmFzLCB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0KTsKICAgICAgICAKICAgICAgICB0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICAgIAogICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueCA9IHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGg7CiAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci55ID0gdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0OwoKICAgICAgICB0aGlzLmNoZWNrT3JpZW50YXRpb25TdGF0ZSgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcy53aWR0aCBlcXVhbCB0byB3aW5kb3cuaW5uZXJXaWR0aCBhbmQgdGhpcy5oZWlnaHQgZXF1YWwgdG8gd2luZG93LmlubmVySGVpZ2h0CiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldE1heGltdW0KICAgICovCiAgICBzZXRNYXhpbXVtOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMud2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICB0aGlzLmhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxjdWxhdGVzIHRoZSBtdWx0aXBsaWVyIG5lZWRlZCB0byBzY2FsZSB0aGUgZ2FtZSBwcm9wb3J0aW9uYWxseS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0U2hvd0FsbAogICAgKi8KICAgIHNldFNob3dBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIG11bHRpcGxpZXIgPSBNYXRoLm1pbigod2luZG93LmlubmVySGVpZ2h0IC8gdGhpcy5nYW1lLmhlaWdodCksICh3aW5kb3cuaW5uZXJXaWR0aCAvIHRoaXMuZ2FtZS53aWR0aCkpOwoKICAgICAgICB0aGlzLndpZHRoID0gTWF0aC5yb3VuZCh0aGlzLmdhbWUud2lkdGggKiBtdWx0aXBsaWVyKTsKICAgICAgICB0aGlzLmhlaWdodCA9IE1hdGgucm91bmQodGhpcy5nYW1lLmhlaWdodCAqIG11bHRpcGxpZXIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzIG9mIHRoZSBjYW52YXMsIG5vIGxhcmdlciB0aGFuIHRoZSBtYXhXaWR0aC9IZWlnaHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldEV4YWN0Rml0CiAgICAqLwogICAgc2V0RXhhY3RGaXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGF2YWlsYWJsZVdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7CiAgICAgICAgdmFyIGF2YWlsYWJsZUhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICAgICAgLy8gY29uc29sZS5sb2coJ2F2YWlsYWJsZScsIGF2YWlsYWJsZVdpZHRoLCBhdmFpbGFibGVIZWlnaHQpOwoKICAgICAgICBpZiAodGhpcy5tYXhXaWR0aCAmJiBhdmFpbGFibGVXaWR0aCA+IHRoaXMubWF4V2lkdGgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5tYXhXaWR0aDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IGF2YWlsYWJsZVdpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMubWF4SGVpZ2h0ICYmIGF2YWlsYWJsZUhlaWdodCA+IHRoaXMubWF4SGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1heEhlaWdodDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSBhdmFpbGFibGVIZWlnaHQ7CiAgICAgICAgfQoKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjaXNGdWxsU2NyZWVuCiogQHByb3BlcnR5IHtib29sZWFufSBpc0Z1bGxTY3JlZW4gLSBSZXR1cm5zIHRydWUgaWYgdGhlIGJyb3dzZXIgaXMgaW4gZnVsbCBzY3JlZW4gbW9kZSwgb3RoZXJ3aXNlIGZhbHNlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlN0YWdlU2NhbGVNb2RlLnByb3RvdHlwZSwgImlzRnVsbFNjcmVlbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIChkb2N1bWVudFsnZnVsbHNjcmVlbkVsZW1lbnQnXSB8fCBkb2N1bWVudFsnbW96RnVsbFNjcmVlbkVsZW1lbnQnXSB8fCBkb2N1bWVudFsnd2Via2l0RnVsbHNjcmVlbkVsZW1lbnQnXSkKCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNpc1BvcnRyYWl0CiogQHByb3BlcnR5IHtib29sZWFufSBpc1BvcnRyYWl0IC0gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIGRpbWVuc2lvbnMgbWF0Y2ggYSBwb3J0cmFpdCBkaXNwbGF5LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlN0YWdlU2NhbGVNb2RlLnByb3RvdHlwZSwgImlzUG9ydHJhaXQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb24gPT0gMCB8fCB0aGlzLm9yaWVudGF0aW9uID09IDE4MDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2lzTGFuZHNjYXBlCiogQHByb3BlcnR5IHtib29sZWFufSBpc0xhbmRzY2FwZSAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBkaW1lbnNpb25zIG1hdGNoIGEgbGFuZHNjYXBlIGRpc3BsYXkuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNMYW5kc2NhcGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3JpZW50YXRpb24gPT09IDkwIHx8IHRoaXMub3JpZW50YXRpb24gPT09IC05MDsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogRGV0ZWN0cyBkZXZpY2Ugc3VwcG9ydCBjYXBhYmlsaXRpZXMuIFVzaW5nIHNvbWUgZWxlbWVudHMgZnJvbSBTeXN0ZW0uanMgYnkgTXJEb29iIGFuZCBNb2Rlcm5penIKKgoqIEBjbGFzcyBQaGFzZXIuRGV2aWNlCiogQGNvbnN0cnVjdG9yCiovCgpQaGFzZXIuRGV2aWNlID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgogICAgKiBBbiBvcHRpb25hbCAnZml4JyBmb3IgdGhlIGhvcnJlbmRvdXMgQW5kcm9pZCBzdG9jayBicm93c2VyIGJ1ZyBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2FuZHJvaWQvaXNzdWVzL2RldGFpbD9pZD0zOTI0NwogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdGNoQW5kcm9pZENsZWFyUmVjdEJ1ZyAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGF0Y2hBbmRyb2lkQ2xlYXJSZWN0QnVnID0gZmFsc2U7CgogICAgLy8gIE9wZXJhdGluZyBTeXN0ZW0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkZXNrdG9wIC0gSXMgcnVubmluZyBkZXNrdG9wPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGVza3RvcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlPUyAtIElzIHJ1bm5pbmcgb24gaU9TPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaU9TID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYW5kcm9pZCAtIElzIHJ1bm5pbmcgb24gYW5kcm9pZD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZHJvaWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjaHJvbWVPUyAtIElzIHJ1bm5pbmcgb24gY2hyb21lT1M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaHJvbWVPUyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxpbnV4IC0gSXMgcnVubmluZyBvbiBsaW51eD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxpbnV4ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWFjT1MgLSBJcyBydW5uaW5nIG9uIG1hY09TPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWFjT1MgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3aW5kb3dzIC0gSXMgcnVubmluZyBvbiB3aW5kb3dzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2luZG93cyA9IGZhbHNlOwoKICAgIC8vICBGZWF0dXJlcwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNhbnZhcyAtIElzIGNhbnZhcyBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaWxlIC0gSXMgZmlsZSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maWxlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZmlsZVN5c3RlbSAtIElzIGZpbGVTeXN0ZW0gYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlsZVN5c3RlbSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvY2FsU3RvcmFnZSAtIElzIGxvY2FsU3RvcmFnZSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJHTCAtIElzIHdlYkdMIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYkdMID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd29ya2VyIC0gSXMgd29ya2VyIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndvcmtlciA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHRvdWNoIC0gSXMgdG91Y2ggYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2ggPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtc3BvaW50ZXIgLSBJcyBtc3BvaW50ZXIgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubXNwb2ludGVyID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3NzM0QgLSBJcyBjc3MzRCBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jc3MzRCA9IGZhbHNlOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwb2ludGVyTG9jayAtIElzIFBvaW50ZXIgTG9jayBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wb2ludGVyTG9jayA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHR5cGVkQXJyYXkgLSBEb2VzIHRoZSBicm93c2VyIHN1cHBvcnQgVHlwZWRBcnJheXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50eXBlZEFycmF5ID0gZmFsc2U7CgogICAgLy8gIEJyb3dzZXIKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhcm9yYSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gQXJvcmEuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hcm9yYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNocm9tZSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gQ2hyb21lLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2hyb21lID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXBpcGhhbnkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEVwaXBoYW55LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZXBpcGhhbnkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaXJlZm94IC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBGaXJlZm94LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmlyZWZveCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGllIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBJbnRlcm5ldCBFeHBsb3Jlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmllID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpZVZlcnNpb24gLSBJZiBydW5uaW5nIGluIEludGVybmV0IEV4cGxvcmVyIHRoaXMgd2lsbCBjb250YWluIHRoZSBtYWpvciB2ZXJzaW9uIG51bWJlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmllVmVyc2lvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbW9iaWxlU2FmYXJpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBNb2JpbGUgU2FmYXJpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubW9iaWxlU2FmYXJpID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWlkb3JpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBNaWRvcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taWRvcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvcGVyYSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gT3BlcmEuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vcGVyYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNhZmFyaSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gU2FmYXJpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2FmYXJpID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2ViQXBwIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBhcyBhIFdlYkFwcCwgaS5lLiB3aXRoaW4gYSBXZWJWaWV3CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJBcHAgPSBmYWxzZTsKCiAgICAvLyAgQXVkaW8KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhdWRpb0RhdGEgLSBBcmUgQXVkaW8gdGFncyBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hdWRpb0RhdGEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJBdWRpbyAtIElzIHRoZSBXZWJBdWRpbyBBUEkgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2ViQXVkaW8gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvZ2cgLSBDYW4gdGhpcyBkZXZpY2UgcGxheSBvZ2cgZmlsZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vZ2cgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBvcHVzIC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgb3B1cyBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9wdXMgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtcDMgLSBDYW4gdGhpcyBkZXZpY2UgcGxheSBtcDMgZmlsZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tcDMgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3YXYgLSBDYW4gdGhpcyBkZXZpY2UgcGxheSB3YXYgZmlsZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53YXYgPSBmYWxzZTsKCiAgICAvKioKICAgICogQ2FuIHRoaXMgZGV2aWNlIHBsYXkgbTRhIGZpbGVzPwogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG00YSAtIFRydWUgaWYgdGhpcyBkZXZpY2UgY2FuIHBsYXkgbTRhIGZpbGVzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubTRhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gd2VibSAtIENhbiB0aGlzIGRldmljZSBwbGF5IHdlYm0gZmlsZXM/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJtID0gZmFsc2U7CgogICAgLy8gIERldmljZQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlQaG9uZSAtIElzIHJ1bm5pbmcgb24gaVBob25lPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaVBob25lID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaVBob25lNCAtIElzIHJ1bm5pbmcgb24gaVBob25lND8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlQaG9uZTQgPSBmYWxzZTsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaVBhZCAtIElzIHJ1bm5pbmcgb24gaVBhZD8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlQYWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBpeGVsUmF0aW8gLSBQaXhlbFJhdGlvIG9mIHRoZSBob3N0IGRldmljZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBpeGVsUmF0aW8gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxpdHRsZUVuZGlhbiAtIElzIHRoZSBkZXZpY2UgYmlnIG9yIGxpdHRsZSBlbmRpYW4/IChvbmx5IGRldGVjdGVkIGlmIHRoZSBicm93c2VyIHN1cHBvcnRzIFR5cGVkQXJyYXlzKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGl0dGxlRW5kaWFuID0gZmFsc2U7CgogICAgLy8gIFJ1biB0aGUgY2hlY2tzCiAgICB0aGlzLl9jaGVja0F1ZGlvKCk7CiAgICB0aGlzLl9jaGVja0Jyb3dzZXIoKTsKICAgIHRoaXMuX2NoZWNrQ1NTM0QoKTsKICAgIHRoaXMuX2NoZWNrRGV2aWNlKCk7CiAgICB0aGlzLl9jaGVja0ZlYXR1cmVzKCk7CiAgICB0aGlzLl9jaGVja09TKCk7CiAgICAKfTsKClBoYXNlci5EZXZpY2UucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDaGVjayB3aGljaCBPUyBpcyBnYW1lIHJ1bm5pbmcgb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tPUwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja09TOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CgogICAgICAgIGlmICgvQW5kcm9pZC8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5hbmRyb2lkID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9Dck9TLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLmNocm9tZU9TID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9pUFthb11kfGlQaG9uZS9pLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuaU9TID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9MaW51eC8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5saW51eCA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvTWFjIE9TLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLm1hY09TID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9XaW5kb3dzLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLndpbmRvd3MgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMud2luZG93cyB8fCB0aGlzLm1hY09TIHx8IHRoaXMubGludXgpIHsKICAgICAgICAgICAgdGhpcy5kZXNrdG9wID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgSFRNTDUgZmVhdHVyZXMgb2YgdGhlIGhvc3QgZW52aXJvbm1lbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tGZWF0dXJlcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja0ZlYXR1cmVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY2FudmFzID0gISF3aW5kb3dbJ0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCddOwoKICAgICAgICB0cnkgewogICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9ICEhbG9jYWxTdG9yYWdlLmdldEl0ZW07CiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgdGhpcy5sb2NhbFN0b3JhZ2UgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZmlsZSA9ICEhd2luZG93WydGaWxlJ10gJiYgISF3aW5kb3dbJ0ZpbGVSZWFkZXInXSAmJiAhIXdpbmRvd1snRmlsZUxpc3QnXSAmJiAhIXdpbmRvd1snQmxvYiddOwogICAgICAgIHRoaXMuZmlsZVN5c3RlbSA9ICEhd2luZG93WydyZXF1ZXN0RmlsZVN5c3RlbSddOwogICAgICAgIHRoaXMud2ViR0wgPSAoIGZ1bmN0aW9uICgpIHsgdHJ5IHsgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7IHJldHVybiAhISB3aW5kb3cuV2ViR0xSZW5kZXJpbmdDb250ZXh0ICYmICggY2FudmFzLmdldENvbnRleHQoICd3ZWJnbCcgKSB8fCBjYW52YXMuZ2V0Q29udGV4dCggJ2V4cGVyaW1lbnRhbC13ZWJnbCcgKSApOyB9IGNhdGNoKCBlICkgeyByZXR1cm4gZmFsc2U7IH0gfSApKCk7CgogICAgICAgIGlmICh0aGlzLndlYkdMID09PSBudWxsIHx8IHRoaXMud2ViR0wgPT09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53ZWJHTCA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndlYkdMID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMud29ya2VyID0gISF3aW5kb3dbJ1dvcmtlciddOwogICAgICAgIAogICAgICAgIGlmICgnb250b3VjaHN0YXJ0JyBpbiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgfHwgd2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICAgICAgICAgIHRoaXMudG91Y2ggPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5uYXZpZ2F0b3IubXNQb2ludGVyRW5hYmxlZCkgewogICAgICAgICAgICB0aGlzLm1zcG9pbnRlciA9IHRydWU7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHRoaXMucG9pbnRlckxvY2sgPSAncG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudCB8fCAnbW96UG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudCB8fCAnd2Via2l0UG9pbnRlckxvY2tFbGVtZW50JyBpbiBkb2N1bWVudDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGF0IGJyb3dzZXIgaXMgZ2FtZSBydW5uaW5nIGluLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrQnJvd3NlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja0Jyb3dzZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCiAgICAgICAgaWYgKC9Bcm9yYS8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5hcm9yYSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvQ2hyb21lLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLmNocm9tZSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvRXBpcGhhbnkvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuZXBpcGhhbnkgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL0ZpcmVmb3gvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuZmlyZWZveCA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvTW9iaWxlIFNhZmFyaS8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5tb2JpbGVTYWZhcmkgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL01TSUUgKFxkK1wuXGQrKTsvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuaWUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmllVmVyc2lvbiA9IHBhcnNlSW50KFJlZ0V4cC4kMSk7CiAgICAgICAgfSBlbHNlIGlmICgvTWlkb3JpLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLm1pZG9yaSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvT3BlcmEvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMub3BlcmEgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL1NhZmFyaS8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5zYWZhcmkgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gV2ViQXBwIG1vZGUgaW4gaU9TCiAgICAgICAgaWYgKG5hdmlnYXRvclsnc3RhbmRhbG9uZSddKSB7CiAgICAgICAgICAgIHRoaXMud2ViQXBwID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgYXVkaW8gc3VwcG9ydC4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0F1ZGlvCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrQXVkaW86IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5hdWRpb0RhdGEgPSAhISh3aW5kb3dbJ0F1ZGlvJ10pOwogICAgICAgIHRoaXMud2ViQXVkaW8gPSAhISh3aW5kb3dbJ3dlYmtpdEF1ZGlvQ29udGV4dCddIHx8IHdpbmRvd1snQXVkaW9Db250ZXh0J10pOwogICAgICAgIHZhciBhdWRpb0VsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpOwogICAgICAgIHZhciByZXN1bHQgPSBmYWxzZTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKHJlc3VsdCA9ICEhYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKSB7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL29nZzsgY29kZWNzPSJ2b3JiaXMiJykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMub2dnID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9vZ2c7IGNvZGVjcz0ib3B1cyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHVzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9tcGVnOycpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm1wMyA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTWltZXR5cGVzIGFjY2VwdGVkOgogICAgICAgICAgICAgICAgLy8gICBkZXZlbG9wZXIubW96aWxsYS5vcmcvRW4vTWVkaWFfZm9ybWF0c19zdXBwb3J0ZWRfYnlfdGhlX2F1ZGlvX2FuZF92aWRlb19lbGVtZW50cwogICAgICAgICAgICAgICAgLy8gICBiaXQubHkvaXBob25lb3Njb2RlY3MKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL3dhdjsgY29kZWNzPSIxIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLndhdiA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8veC1tNGE7JykgfHwgYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby9hYWM7JykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubTRhID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby93ZWJtOyBjb2RlY3M9InZvcmJpcyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy53ZWJtID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgUGl4ZWxSYXRpbyBvZiBkZXZpY2VzLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrRGV2aWNlCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrRGV2aWNlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGl4ZWxSYXRpbyA9IHdpbmRvd1snZGV2aWNlUGl4ZWxSYXRpbyddIHx8IDE7CiAgICAgICAgdGhpcy5pUGhvbmUgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignaXBob25lJykgIT0gLTE7CiAgICAgICAgdGhpcy5pUGhvbmU0ID0gKHRoaXMucGl4ZWxSYXRpbyA9PSAyICYmIHRoaXMuaVBob25lKTsKICAgICAgICB0aGlzLmlQYWQgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkuaW5kZXhPZignaXBhZCcpICE9IC0xOwoKICAgICAgICBpZiAodHlwZW9mIEludDhBcnJheSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpdHRsZUVuZGlhbiA9IG5ldyBJbnQ4QXJyYXkobmV3IEludDE2QXJyYXkoWzFdKS5idWZmZXIpWzBdID4gMDsKICAgICAgICAgICAgdGhpcy50eXBlZEFycmF5ID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5saXR0bGVFbmRpYW4gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50eXBlZEFycmF5ID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGhvc3QgZW52aXJvbm1lbnQgc3VwcG9ydCAzRCBDU1MuCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tDU1MzRAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9jaGVja0NTUzNEOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3AnKTsKICAgICAgICB2YXIgaGFzM2Q7CiAgICAgICAgdmFyIHRyYW5zZm9ybXMgPSB7CiAgICAgICAgICAgICd3ZWJraXRUcmFuc2Zvcm0nOiAnLXdlYmtpdC10cmFuc2Zvcm0nLAogICAgICAgICAgICAnT1RyYW5zZm9ybSc6ICctby10cmFuc2Zvcm0nLAogICAgICAgICAgICAnbXNUcmFuc2Zvcm0nOiAnLW1zLXRyYW5zZm9ybScsCiAgICAgICAgICAgICdNb3pUcmFuc2Zvcm0nOiAnLW1vei10cmFuc2Zvcm0nLAogICAgICAgICAgICAndHJhbnNmb3JtJzogJ3RyYW5zZm9ybScKICAgICAgICB9OwoKICAgICAgICAvLyBBZGQgaXQgdG8gdGhlIGJvZHkgdG8gZ2V0IHRoZSBjb21wdXRlZCBzdHlsZS4KICAgICAgICBkb2N1bWVudC5ib2R5Lmluc2VydEJlZm9yZShlbCwgbnVsbCk7CgogICAgICAgIGZvciAodmFyIHQgaW4gdHJhbnNmb3JtcykgewogICAgICAgICAgICBpZiAoZWwuc3R5bGVbdF0gIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgZWwuc3R5bGVbdF0gPSAidHJhbnNsYXRlM2QoMXB4LDFweCwxcHgpIjsKICAgICAgICAgICAgICAgIGhhczNkID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUoZWwpLmdldFByb3BlcnR5VmFsdWUodHJhbnNmb3Jtc1t0XSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChlbCk7CiAgICAgICAgdGhpcy5jc3MzRCA9IChoYXMzZCAhPT0gdW5kZWZpbmVkICYmIGhhczNkLmxlbmd0aCA+IDAgJiYgaGFzM2QgIT09ICJub25lIik7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgaG9zdCBlbnZpcm9ubWVudCBjYW4gcGxheSBhdWRpby4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI2NhblBsYXlBdWRpbwogICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZSAtIE9uZSBvZiAnbXAzLCAnb2dnJywgJ200YScsICd3YXYnLCAnd2VibScuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIGZpbGUgdHlwZSBpcyBzdXBwb3J0ZWQgYnkgdGhlIGJyb3dzZXIsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjYW5QbGF5QXVkaW86IGZ1bmN0aW9uICh0eXBlKSB7CgogICAgICAgIGlmICh0eXBlID09ICdtcDMnICYmIHRoaXMubXAzKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ29nZycgJiYgKHRoaXMub2dnIHx8IHRoaXMub3B1cykpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnbTRhJyAmJiB0aGlzLm00YSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICd3YXYnICYmIHRoaXMud2F2KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3dlYm0nICYmIHRoaXMud2VibSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoZXRoZXIgdGhlIGNvbnNvbGUgaXMgb3Blbi4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI2lzQ29uc29sZU9wZW4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYnJvd3NlciBkZXYgY29uc29sZSBpcyBvcGVuLgogICAgKi8KICAgIGlzQ29uc29sZU9wZW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHdpbmRvdy5jb25zb2xlICYmIHdpbmRvdy5jb25zb2xlWydmaXJlYnVnJ10pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3cuY29uc29sZSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUucHJvZmlsZSgpOwogICAgICAgICAgICBjb25zb2xlLnByb2ZpbGVFbmQoKTsKCiAgICAgICAgICAgIGlmIChjb25zb2xlLmNsZWFyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmNsZWFyKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiBjb25zb2xlWydwcm9maWxlcyddLmxlbmd0aCA+IDA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEFic3RyYWN0cyBhd2F5IHRoZSB1c2Ugb2YgUkFGIG9yIHNldFRpbWVPdXQgZm9yIHRoZSBjb3JlIGdhbWUgdXBkYXRlIGxvb3AuCioKKiBAY2xhc3MgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSAKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihnYW1lKSB7CgkKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gVGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc1J1bm5pbmcgLSB0cnVlIGlmIFJlcXVlc3RBbmltYXRpb25GcmFtZSBpcyBydW5uaW5nLCBvdGhlcndpc2UgZmFsc2UuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCgl2YXIgdmVuZG9ycyA9IFsKCQknbXMnLCAKCQknbW96JywgCgkJJ3dlYmtpdCcsIAoJCSdvJwoJXTsKCglmb3IgKHZhciB4ID0gMDsgeCA8IHZlbmRvcnMubGVuZ3RoICYmICF3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lOyB4KyspCgl7CgkJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOwoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdICsgJ0NhbmNlbEFuaW1hdGlvbkZyYW1lJ107Cgl9CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2lzU2V0VGltZU91dCAgLSB0cnVlIGlmIHRoZSBicm93c2VyIGlzIHVzaW5nIHNldFRpbWVvdXQgaW5zdGVhZCBvZiByYWYuCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5faXNTZXRUaW1lT3V0ID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbkxvb3AgLSBUaGUgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSB1cGRhdGUuCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5fb25Mb29wID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IF90aW1lT3V0SUQgLSBUaGUgY2FsbGJhY2sgSUQgdXNlZCB3aGVuIGNhbGxpbmcgY2FuY2VsLgoJKiBAcHJpdmF0ZQoJKi8KCXRoaXMuX3RpbWVPdXRJRCA9IG51bGw7Cgp9OwoKUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZS5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIFN0YXJ0cyB0aGUgcmVxdWVzdEFuaW1hdGlvRnJhbWUgcnVubmluZyBvciBzZXRUaW1lb3V0IGlmIHVuYXZhaWxhYmxlIGluIGJyb3dzZXIKCSogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI3N0YXJ0CgkqLwoJc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5pc1J1bm5pbmcgPSB0cnVlOwoKCQl2YXIgX3RoaXMgPSB0aGlzOwoKCQlpZiAoIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpCgkJewoJCQl0aGlzLl9pc1NldFRpbWVPdXQgPSB0cnVlOwoKICAgICAgICAgICAgdGhpcy5fb25Mb29wID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZVNldFRpbWVvdXQoKTsKICAgICAgICAgICAgfTsKCgkJCXRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuX29uTG9vcCwgMCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuX2lzU2V0VGltZU91dCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5fb25Mb29wID0gZnVuY3Rpb24gKHRpbWUpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy51cGRhdGVSQUYodGltZSk7CiAgICAgICAgICAgIH07CgoJCQl0aGlzLl90aW1lT3V0SUQgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuX29uTG9vcCk7CgkJfQoKCX0sCgoJLyoqCgkqIFRoZSB1cGRhdGUgbWV0aG9kIGZvciB0aGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lCgkqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSN1cGRhdGVSQUYJCgkqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gQSB0aW1lc3RhbXAsIGVpdGhlciBmcm9tIFJBRiBvciBzZXRUaW1lT3V0CgkqLwoJdXBkYXRlUkFGOiBmdW5jdGlvbiAodGltZSkgewoKCQl0aGlzLmdhbWUudXBkYXRlKHRpbWUpOwoKCQl0aGlzLl90aW1lT3V0SUQgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKHRoaXMuX29uTG9vcCk7CgoJfSwKCgkvKioKCSogVGhlIHVwZGF0ZSBtZXRob2QgZm9yIHRoZSBzZXRUaW1lb3V0LgoJKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjdXBkYXRlU2V0VGltZW91dAoJKi8KCXVwZGF0ZVNldFRpbWVvdXQ6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5nYW1lLnVwZGF0ZShEYXRlLm5vdygpKTsKCgkJdGhpcy5fdGltZU91dElEID0gd2luZG93LnNldFRpbWVvdXQodGhpcy5fb25Mb29wLCB0aGlzLmdhbWUudGltZS50aW1lVG9DYWxsKTsKCgl9LAoKCS8qKgoJKiBTdG9wcyB0aGUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIGZyb20gcnVubmluZy4KCSogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI3N0b3AKCSovCglzdG9wOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLl9pc1NldFRpbWVPdXQpCgkJewoJCQljbGVhclRpbWVvdXQodGhpcy5fdGltZU91dElEKTsKCQl9CgkJZWxzZQoJCXsKCQkJd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lKHRoaXMuX3RpbWVPdXRJRCk7CgkJfQoKCQl0aGlzLmlzUnVubmluZyA9IGZhbHNlOwoKCX0sCgoJLyoqCgkqIElzIHRoZSBicm93c2VyIHVzaW5nIHNldFRpbWVvdXQ/CgkqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSNpc1NldFRpbWVPdXQKCSogQHJldHVybiB7Ym9vbGVhbn0KCSovCglpc1NldFRpbWVPdXQ6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gdGhpcy5faXNTZXRUaW1lT3V0OwoJfSwKCgkvKioKCSogSXMgdGhlIGJyb3dzZXIgdXNpbmcgcmVxdWVzdEFuaW1hdGlvbkZyYW1lPwoJKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjaXNSQUYKCSogQHJldHVybiB7Ym9vbGVhbn0KCSovCglpc1JBRjogZnVuY3Rpb24gKCkgewoJCXJldHVybiAodGhpcy5faXNTZXRUaW1lT3V0ID09PSBmYWxzZSk7Cgl9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciBjb25zdHJ1Y3Rvci4KKiAKKiBAY2xhc3MgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IKKiBAY2xhc3NkZXNjIEFuIGV4dHJlbWVseSB1c2VmdWwgcmVwZWF0YWJsZSByYW5kb20gZGF0YSBnZW5lcmF0b3IuIEFjY2VzcyBpdCB2aWEgUGhhc2VyLkdhbWUucm5kCiogQmFzZWQgb24gTm9uc2Vuc2UgYnkgSm9zaCBGYXVsIGh0dHBzOi8vZ2l0aHViLmNvbS9qb2NhZmEvTm9uc2Vuc2UuCiogUmFuZG9tIG51bWJlciBnZW5lcmF0b3IgZnJvbSBodHRwOi8vYmFhZ29lLm9yZy9lbi93aWtpL0JldHRlcl9yYW5kb21fbnVtYmVyc19mb3JfamF2YXNjcmlwdAoqIAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7YXJyYXl9IHNlZWRzCiovClBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yID0gZnVuY3Rpb24gKHNlZWRzKSB7CgkKCWlmICh0eXBlb2Ygc2VlZHMgPT09ICJ1bmRlZmluZWQiKSB7IHNlZWRzID0gW107IH0KCgl0aGlzLnNvdyhzZWVkcyk7Cgp9OwoKUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IucHJvdG90eXBlID0gewoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gYwoJKiBAcHJpdmF0ZQoJKi8KCWM6IDEsCgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzMAoJKiBAcHJpdmF0ZQoJKi8KCXMwOiAwLAoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gczEKCSogQHByaXZhdGUKCSovCglzMTogMCwKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHMyCgkqIEBwcml2YXRlCgkqLwoJczI6IDAsCgoJLyoqCgkqIFByaXZhdGUgcmFuZG9tIGhlbHBlci4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNybmQKCSogQHByaXZhdGUKCSogQHJldHVybiB7bnVtYmVyfSBEZXNjcmlwdGlvbi4KCSovCglybmQ6IGZ1bmN0aW9uICgpIHsKCgkJdmFyIHQgPSAyMDkxNjM5ICogdGhpcy5zMCArIHRoaXMuYyAqIDIuMzI4MzA2NDM2NTM4Njk2M2UtMTA7IC8vIDJeLTMyCgoJCXRoaXMuYyA9IHQgfCAwOwoJCXRoaXMuczAgPSB0aGlzLnMxOwoJCXRoaXMuczEgPSB0aGlzLnMyOwoJCXRoaXMuczIgPSB0IC0gdGhpcy5jOwoKCQlyZXR1cm4gdGhpcy5zMjsKCX0sCgoJLyoqCgkqIFJlc2V0IHRoZSBzZWVkIG9mIHRoZSByYW5kb20gZGF0YSBnZW5lcmF0b3IuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3NvdwoJKiBAcGFyYW0ge2FycmF5fSBzZWVkcwoJKi8KCXNvdzogZnVuY3Rpb24gKHNlZWRzKSB7CgoJCWlmICh0eXBlb2Ygc2VlZHMgPT09ICJ1bmRlZmluZWQiKSB7IHNlZWRzID0gW107IH0KCgkJdGhpcy5zMCA9IHRoaXMuaGFzaCgnICcpOwoJCXRoaXMuczEgPSB0aGlzLmhhc2godGhpcy5zMCk7CgkJdGhpcy5zMiA9IHRoaXMuaGFzaCh0aGlzLnMxKTsKCQl0aGlzLmMgPSAxOwoKCQl2YXIgc2VlZDsKCgkJZm9yICh2YXIgaSA9IDA7IHNlZWQgPSBzZWVkc1tpKytdOyApCgkJewoJCQl0aGlzLnMwIC09IHRoaXMuaGFzaChzZWVkKTsKCQkJdGhpcy5zMCArPSB+fih0aGlzLnMwIDwgMCk7CgkJCXRoaXMuczEgLT0gdGhpcy5oYXNoKHNlZWQpOwoJCQl0aGlzLnMxICs9IH5+KHRoaXMuczEgPCAwKTsKCQkJdGhpcy5zMiAtPSB0aGlzLmhhc2goc2VlZCk7CgkJCXRoaXMuczIgKz0gfn4odGhpcy5zMiA8IDApOwoJCX0KCQkKCX0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2hhc2gKCSogQHBhcmFtIHtBbnl9IGRhdGEKCSogQHByaXZhdGUKCSogQHJldHVybiB7bnVtYmVyfSBEZXNjcmlwdGlvbi4KCSovCgloYXNoOiBmdW5jdGlvbiAoZGF0YSkgewoKCQl2YXIgaCwgaSwgbjsKCQluID0gMHhlZmM4MjQ5ZDsKCQlkYXRhID0gZGF0YS50b1N0cmluZygpOwoKCQlmb3IgKGkgPSAwOyBpIDwgZGF0YS5sZW5ndGg7IGkrKykgewoJCQluICs9IGRhdGEuY2hhckNvZGVBdChpKTsKCQkJaCA9IDAuMDI1MTk2MDMyODI0MTY5MzggKiBuOwoJCQluID0gaCA+Pj4gMDsKCQkJaCAtPSBuOwoJCQloICo9IG47CgkJCW4gPSBoID4+PiAwOwoJCQloIC09IG47CgkJCW4gKz0gaCAqIDB4MTAwMDAwMDAwOy8vIDJeMzIKCQl9CgoJCXJldHVybiAobiA+Pj4gMCkgKiAyLjMyODMwNjQzNjUzODY5NjNlLTEwOy8vIDJeLTMyCgoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gMCBhbmQgMl4zMi4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNpbnRlZ2VyCgkqIEByZXR1cm4ge251bWJlcn0KCSovCglpbnRlZ2VyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5ybmQuYXBwbHkodGhpcykgKiAweDEwMDAwMDAwMDsvLyAyXjMyCgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gMCBhbmQgMS4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNmcmFjCgkqIEByZXR1cm4ge251bWJlcn0KCSovCQoJZnJhYzogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMucm5kLmFwcGx5KHRoaXMpICsgKHRoaXMucm5kLmFwcGx5KHRoaXMpICogMHgyMDAwMDAgfCAwKSAqIDEuMTEwMjIzMDI0NjI1MTU2NWUtMTY7Ly8gMl4tNTMKCX0sCgoJLyoqCgkqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JlYWwKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCXJlYWw6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmludGVnZXIoKSArIHRoaXMuZnJhYygpOwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSBpbnRlZ2VyIGJldHdlZW4gbWluIGFuZCBtYXguCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjaW50ZWdlckluUmFuZ2UKCSogQHBhcmFtIHtudW1iZXJ9IG1pbgoJKiBAcGFyYW0ge251bWJlcn0gbWF4CgkqIEByZXR1cm4ge251bWJlcn0KCSovCglpbnRlZ2VySW5SYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgkJcmV0dXJuIE1hdGguZmxvb3IodGhpcy5yZWFsSW5SYW5nZShtaW4sIG1heCkpOwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIG1pbiBhbmQgbWF4LgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JlYWxJblJhbmdlCgkqIEBwYXJhbSB7bnVtYmVyfSBtaW4KCSogQHBhcmFtIHtudW1iZXJ9IG1heAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJcmVhbEluUmFuZ2U6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKCQlyZXR1cm4gdGhpcy5mcmFjKCkgKiAobWF4IC0gbWluKSArIG1pbjsKCgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gLTEgYW5kIDEuCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3Ijbm9ybWFsCgkqIEByZXR1cm4ge251bWJlcn0KCSovCglub3JtYWw6IGZ1bmN0aW9uICgpIHsKCQlyZXR1cm4gMSAtIDIgKiB0aGlzLmZyYWMoKTsKCX0sCgoJLyoqCgkqIFJldHVybnMgYSB2YWxpZCBSRkM0MTIyIHZlcnNpb240IElEIGhleCBzdHJpbmcgZnJvbSBodHRwczovL2dpc3QuZ2l0aHViLmNvbS8xMzA4MzY4CgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjdXVpZAoJKiBAcmV0dXJuIHtzdHJpbmd9CgkqLwoJdXVpZDogZnVuY3Rpb24gKCkgewoKCQl2YXIgYSwgYjsKCgkJZm9yICgKCQkJYj1hPScnOwoJCQlhKys8MzY7CgkJCWIrPX5hJTV8YSozJjQ/KGFeMTU/OF50aGlzLmZyYWMoKSooYV4yMD8xNjo0KTo0KS50b1N0cmluZygxNik6Jy0nCgkJKTsKCgkJcmV0dXJuIGI7CgoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSBtZW1iZXIgb2YgYGFycmF5YC4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNwaWNrCgkqIEBwYXJhbSB7QW55fSBhcnkKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCXBpY2s6IGZ1bmN0aW9uIChhcnkpIHsKCQlyZXR1cm4gYXJ5W3RoaXMuaW50ZWdlckluUmFuZ2UoMCwgYXJ5Lmxlbmd0aCldOwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSBtZW1iZXIgb2YgYGFycmF5YCwgZmF2b3JpbmcgdGhlIGVhcmxpZXIgZW50cmllcy4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN3ZWlnaHRlZFBpY2sKCSogQHBhcmFtIHtBbnl9IGFyeQoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJd2VpZ2h0ZWRQaWNrOiBmdW5jdGlvbiAoYXJ5KSB7CgkJcmV0dXJuIGFyeVt+fihNYXRoLnBvdyh0aGlzLmZyYWMoKSwgMikgKiBhcnkubGVuZ3RoKV07Cgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIHRpbWVzdGFtcCBiZXR3ZWVuIG1pbiBhbmQgbWF4LCBvciBiZXR3ZWVuIHRoZSBiZWdpbm5pbmcgb2YgMjAwMCBhbmQgdGhlIGVuZCBvZiAyMDIwIGlmIG1pbiBhbmQgbWF4IGFyZW4ndCBzcGVjaWZpZWQuCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjdGltZXN0YW1wCgkqIEBwYXJhbSB7bnVtYmVyfSBtaW4KCSogQHBhcmFtIHtudW1iZXJ9IG1heAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJdGltZXN0YW1wOiBmdW5jdGlvbiAoYSwgYikgewoJCXJldHVybiB0aGlzLnJlYWxJblJhbmdlKGEgfHwgOTQ2Njg0ODAwMDAwLCBiIHx8IDE1Nzc4NjIwMDAwMDApOwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSBhbmdsZSBiZXR3ZWVuIC0xODAgYW5kIDE4MC4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNhbmdsZQoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJYW5nbGU6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmludGVnZXJJblJhbmdlKC0xODAsIDE4MCk7Cgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBjb2xsZWN0aW9uIG9mIG1hdGhlbWF0aWNhbCBtZXRob2RzLgoqCiogQGNsYXNzIFBoYXNlci5NYXRoCiovClBoYXNlci5NYXRoID0gewoKCS8qKgoJKiA9IDIgJnBpOwoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI1BJMgoJKi8KCVBJMjogTWF0aC5QSSAqIDIsCgoJLyoqCgkqIFR3byBudW1iZXIgYXJlIGZ1enp5RXF1YWwgaWYgdGhlaXIgZGlmZmVyZW5jZSBpcyBsZXNzIHRoYW4gJmVwc2lsb247LiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUVxdWFsCgkqIEBwYXJhbSB7bnVtYmVyfSBhCgkqIEBwYXJhbSB7bnVtYmVyfSBiCgkqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHxhLWJ8PCZlcHNpbG9uOwoJKi8KICAgIGZ1enp5RXF1YWw6IGZ1bmN0aW9uIChhLCBiLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKGEgLSBiKSA8IGVwc2lsb247CiAgICB9LAoKCS8qKgoJKiBhIGlzIGZ1enp5TGVzc1RoYW4gYiBpZiBpdCBpcyBsZXNzIHRoYW4gYiArICZlcHNpbG9uOy4gCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjZnV6enlFcXVhbAoJKiBAcGFyYW0ge251bWJlcn0gYQoJKiBAcGFyYW0ge251bWJlcn0gYgoJKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKCSogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhPGIrJmVwc2lsb247CgkqLwogICAgZnV6enlMZXNzVGhhbjogZnVuY3Rpb24gKGEsIGIsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gYSA8IGIgKyBlcHNpbG9uOwogICAgfSwKCgkvKioKCSogYSBpcyBmdXp6eUdyZWF0ZXJUaGFuIGIgaWYgaXQgaXMgbW9yZSB0aGFuIGIgLSAmZXBzaWxvbjsuICAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUdyZWF0ZXJUaGFuCgkqIEBwYXJhbSB7bnVtYmVyfSBhCgkqIEBwYXJhbSB7bnVtYmVyfSBiCgkqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGE+YismZXBzaWxvbjsKCSovCiAgICBmdXp6eUdyZWF0ZXJUaGFuOiBmdW5jdGlvbiAoYSwgYiwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBhID4gYiAtIGVwc2lsb247CiAgICB9LAoKCS8qKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUNlaWwKCSogQHBhcmFtIHtudW1iZXJ9IHZhbAoJKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKCSogQHJldHVybiB7Ym9vbGVhbn0gY2VpbGluZyh2YWwtJmVwc2lsb247KQoJKi8KICAgIGZ1enp5Q2VpbDogZnVuY3Rpb24gKHZhbCwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBNYXRoLmNlaWwodmFsIC0gZXBzaWxvbik7CiAgICB9LAoKCS8qKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUZsb29yCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWwKCSogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCgkqIEByZXR1cm4ge2Jvb2xlYW59IGZsb29yKHZhbC0mZXBzaWxvbjspCgkqLwogICAgZnV6enlGbG9vcjogZnVuY3Rpb24gKHZhbCwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHZhbCArIGVwc2lsb24pOwogICAgfSwKCgkvKiogCiAgICAqIEF2ZXJhZ2VzIGFsbCB2YWx1ZXMgcGFzc2VkIHRvIHRoZSBmdW5jdGlvbiBhbmQgcmV0dXJucyB0aGUgcmVzdWx0LiBZb3UgY2FuIHBhc3MgYXMgbWFueSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2F2ZXJhZ2UKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYXZlcmFnZSBvZiBhbGwgZ2l2ZW4gdmFsdWVzLgoJKi8KICAgIGF2ZXJhZ2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGFyZ3MgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgX2kgPSAwOyBfaSA8IChhcmd1bWVudHMubGVuZ3RoIC0gMCk7IF9pKyspIHsKICAgICAgICAgICAgYXJnc1tfaV0gPSBhcmd1bWVudHNbX2kgKyAwXTsKICAgICAgICB9CgogICAgICAgIHZhciBhdmcgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgYXZnICs9IGFyZ3NbaV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXZnIC8gYXJncy5sZW5ndGg7CgogICAgfSwKCgkvKiogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjdHJ1bmNhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IG4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIHRydW5jYXRlOiBmdW5jdGlvbiAobikgewogICAgICAgIHJldHVybiAobiA+IDApID8gTWF0aC5mbG9vcihuKSA6IE1hdGguY2VpbChuKTsKICAgIH0sCgoJLyoqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NoZWFyCgkqIEBwYXJhbSB7bnVtYmVyfSBuCgkqIEByZXR1cm4ge251bWJlcn0gbiBtb2QgMQoJKi8KICAgIHNoZWFyOiBmdW5jdGlvbiAobikgewogICAgICAgIHJldHVybiBuICUgMTsKICAgIH0sCgoJLyoqCgkqIFNuYXAgYSB2YWx1ZSB0byBuZWFyZXN0IGdyaWQgc2xpY2UsIHVzaW5nIHJvdW5kaW5nLgoJKgoJKiBFeGFtcGxlOiBpZiB5b3UgaGF2ZSBhbiBpbnRlcnZhbCBnYXAgb2YgNSBhbmQgYSBwb3NpdGlvbiBvZiAxMi4uLiB5b3Ugd2lsbCBzbmFwIHRvIDEwIHdoZXJlYXMgMTQgd2lsbCBzbmFwIHRvIDE1LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUbwoJKiBAcGFyYW0ge251bWJlcn0gaW5wdXQgLSBUaGUgdmFsdWUgdG8gc25hcC4KCSogQHBhcmFtIHtudW1iZXJ9IGdhcCAtIFRoZSBpbnRlcnZhbCBnYXAgb2YgdGhlIGdyaWQuCgkqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnRdIC0gT3B0aW9uYWwgc3RhcnRpbmcgb2Zmc2V0IGZvciBnYXAuCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBzbmFwVG86IGZ1bmN0aW9uIChpbnB1dCwgZ2FwLCBzdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAidW5kZWZpbmVkIikgeyBzdGFydCA9IDA7IH0KCiAgICAgICAgaWYgKGdhcCA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGlucHV0IC09IHN0YXJ0OwogICAgICAgIGlucHV0ID0gZ2FwICogTWF0aC5yb3VuZChpbnB1dCAvIGdhcCk7CgogICAgICAgIHJldHVybiBzdGFydCArIGlucHV0OwoKICAgIH0sCgoJLyoqCiAgICAqIFNuYXAgYSB2YWx1ZSB0byBuZWFyZXN0IGdyaWQgc2xpY2UsIHVzaW5nIGZsb29yLgogICAgKgogICAgKiBFeGFtcGxlOiBpZiB5b3UgaGF2ZSBhbiBpbnRlcnZhbCBnYXAgb2YgNSBhbmQgYSBwb3NpdGlvbiBvZiAxMi4uLiB5b3Ugd2lsbCBzbmFwIHRvIDEwLiBBcyB3aWxsIDE0IHNuYXAgdG8gMTAuLi4gYnV0IDE2IHdpbGwgc25hcCB0byAxNQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0Zsb29yCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dCAtIFRoZSB2YWx1ZSB0byBzbmFwLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ2FwIC0gVGhlIGludGVydmFsIGdhcCBvZiB0aGUgZ3JpZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0gLSBPcHRpb25hbCBzdGFydGluZyBvZmZzZXQgZm9yIGdhcC4KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHNuYXBUb0Zsb29yOiBmdW5jdGlvbiAoaW5wdXQsIGdhcCwgc3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnQgPSAwOyB9CgogICAgICAgIGlmIChnYXAgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBpbnB1dCAtPSBzdGFydDsKICAgICAgICBpbnB1dCA9IGdhcCAqIE1hdGguZmxvb3IoaW5wdXQgLyBnYXApOwoKICAgICAgICByZXR1cm4gc3RhcnQgKyBpbnB1dDsKCiAgICB9LAoKCS8qKgoJKiBTbmFwIGEgdmFsdWUgdG8gbmVhcmVzdCBncmlkIHNsaWNlLCB1c2luZyBjZWlsLgoJKgoJKiBFeGFtcGxlOiBpZiB5b3UgaGF2ZSBhbiBpbnRlcnZhbCBnYXAgb2YgNSBhbmQgYSBwb3NpdGlvbiBvZiAxMi4uLiB5b3Ugd2lsbCBzbmFwIHRvIDE1LiBBcyB3aWxsIDE0IHdpbGwgc25hcCB0byAxNS4uLiBidXQgMTYgd2lsbCBzbmFwIHRvIDIwLgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0NlaWwKICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0IC0gVGhlIHZhbHVlIHRvIHNuYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnYXAgLSBUaGUgaW50ZXJ2YWwgZ2FwIG9mIHRoZSBncmlkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0XSAtIE9wdGlvbmFsIHN0YXJ0aW5nIG9mZnNldCBmb3IgZ2FwLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgc25hcFRvQ2VpbDogZnVuY3Rpb24gKGlucHV0LCBnYXAsIHN0YXJ0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IHN0YXJ0ID0gMDsgfQoKICAgICAgICBpZiAoZ2FwID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0OwogICAgICAgIH0KCiAgICAgICAgaW5wdXQgLT0gc3RhcnQ7CiAgICAgICAgaW5wdXQgPSBnYXAgKiBNYXRoLmNlaWwoaW5wdXQgLyBnYXApOwoKICAgICAgICByZXR1cm4gc3RhcnQgKyBpbnB1dDsKCiAgICB9LAoKCgkvKioKCSogU25hcHMgYSB2YWx1ZSB0byB0aGUgbmVhcmVzdCB2YWx1ZSBpbiBhbiBhcnJheS4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbmFwVG9JbkFycmF5CgkqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dAoJKiBAcGFyYW0ge2FycmF5fSBhcnIgCgkqIEBwYXJhbSB7Ym9vbGVhbn0gc29ydCAtIFRydWUgaWYgdGhlIGFycmF5IG5lZWRzIHRvIGJlIHNvcnRlZC4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIHNuYXBUb0luQXJyYXk6IGZ1bmN0aW9uIChpbnB1dCwgYXJyLCBzb3J0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc29ydCA9PT0gInVuZGVmaW5lZCIpIHsgc29ydCA9IHRydWU7IH0KCiAgICAgICAgaWYgKHNvcnQpIHsKICAgICAgICAgICAgYXJyLnNvcnQoKTsKICAgICAgICB9CgogICAgICAgIGlmIChpbnB1dCA8IGFyclswXSkgewogICAgICAgICAgICByZXR1cm4gYXJyWzBdOwogICAgICAgIH0KCiAgICAgICAgdmFyIGkgPSAxOwogICAgICAgIAogICAgICAgIHdoaWxlIChhcnJbaV0gPCBpbnB1dCkgewogICAgICAgICAgICBpKys7CiAgICAgICAgfQoKICAgICAgICB2YXIgbG93ID0gYXJyW2kgLSAxXTsKICAgICAgICB2YXIgaGlnaCA9IChpIDwgYXJyLmxlbmd0aCkgPyBhcnJbaV0gOiBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuICgoaGlnaCAtIGlucHV0KSA8PSAoaW5wdXQgLSBsb3cpKSA/IGhpZ2ggOiBsb3c7CgogICAgfSwKCgkvKioKCSogUm91bmQgdG8gc29tZSBwbGFjZSBjb21wYXJhdGl2ZSB0byBhICdiYXNlJywgZGVmYXVsdCBpcyAxMCBmb3IgZGVjaW1hbCBwbGFjZS4KCSoKCSogJ3BsYWNlJyBpcyByZXByZXNlbnRlZCBieSB0aGUgcG93ZXIgYXBwbGllZCB0byAnYmFzZScgdG8gZ2V0IHRoYXQgcGxhY2UKCSogZS5nLgoJKiAyMDAwLzcgfj0gMjg1LjcxNDI4NTcxNDI4NTcxNDI4NTcxNCB+PSAoYmluKTEwMDAxMTEwMS4xMDExMDExMDExMDExMDExCgkqCgkqIHJvdW5kVG8oMjAwMC83LDMpID09IDAKCSogcm91bmRUbygyMDAwLzcsMikgPT0gMzAwCgkqIHJvdW5kVG8oMjAwMC83LDEpID09IDI5MAoJKiByb3VuZFRvKDIwMDAvNywwKSA9PSAyODYKCSogcm91bmRUbygyMDAwLzcsLTEpID09IDI4NS43CgkqIHJvdW5kVG8oMjAwMC83LC0yKSA9PSAyODUuNzEKCSogcm91bmRUbygyMDAwLzcsLTMpID09IDI4NS43MTQKCSogcm91bmRUbygyMDAwLzcsLTQpID09IDI4NS43MTQzCgkqIHJvdW5kVG8oMjAwMC83LC01KSA9PSAyODUuNzE0MjkKCSoKCSogcm91bmRUbygyMDAwLzcsMywyKSAgPT0gMjg4ICAgICAgIC0tIDEwMDEwMDAwMAoJKiByb3VuZFRvKDIwMDAvNywyLDIpICA9PSAyODQgICAgICAgLS0gMTAwMDExMTAwCgkqIHJvdW5kVG8oMjAwMC83LDEsMikgID09IDI4NiAgICAgICAtLSAxMDAwMTExMTAKCSogcm91bmRUbygyMDAwLzcsMCwyKSAgPT0gMjg2ICAgICAgIC0tIDEwMDAxMTExMAoJKiByb3VuZFRvKDIwMDAvNywtMSwyKSA9PSAyODUuNSAgICAgLS0gMTAwMDExMTAxLjEKCSogcm91bmRUbygyMDAwLzcsLTIsMikgPT0gMjg1Ljc1ICAgIC0tIDEwMDAxMTEwMS4xMQoJKiByb3VuZFRvKDIwMDAvNywtMywyKSA9PSAyODUuNzUgICAgLS0gMTAwMDExMTAxLjExCgkqIHJvdW5kVG8oMjAwMC83LC00LDIpID09IDI4NS42ODc1ICAtLSAxMDAwMTExMDEuMTAxMQoJKiByb3VuZFRvKDIwMDAvNywtNSwyKSA9PSAyODUuNzE4NzUgLS0gMTAwMDExMTAxLjEwMTExCgkqCgkqIE5vdGUgd2hhdCBvY2N1cnMgd2hlbiB3ZSByb3VuZCB0byB0aGUgM3JkIHNwYWNlICg4dGhzIHBsYWNlKSwgMTAwMTAwMDAwLCB0aGlzIGlzIHRvIGJlIGFzc3VtZWQKCSogYmVjYXVzZSB3ZSBhcmUgcm91bmRpbmcgMTAwMDExLjEwMTEwMTEwMTEwMTEwMTEgd2hpY2ggcm91bmRzIHVwLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNyb3VuZFRvCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KCSogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgoJKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICByb3VuZFRvOiBmdW5jdGlvbiAodmFsdWUsIHBsYWNlLCBiYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgcGxhY2UgPT09ICJ1bmRlZmluZWQiKSB7IHBsYWNlID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gInVuZGVmaW5lZCIpIHsgYmFzZSA9IDEwOyB9CiAgICAgICAgCiAgICAgICAgdmFyIHAgPSBNYXRoLnBvdyhiYXNlLCAtcGxhY2UpOwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgogICAgLyoqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjZmxvb3JUbwoJKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gcm91bmQuCgkqIEBwYXJhbSB7bnVtYmVyfSBwbGFjZSAtIFRoZSBwbGFjZSB0byByb3VuZCB0by4KCSogQHBhcmFtIHtudW1iZXJ9IGJhc2UgLSBUaGUgYmFzZSB0byByb3VuZCBpbi4uLiBkZWZhdWx0IGlzIDEwIGZvciBkZWNpbWFsLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgZmxvb3JUbzogZnVuY3Rpb24gKHZhbHVlLCBwbGFjZSwgYmFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIHBsYWNlID09PSAidW5kZWZpbmVkIikgeyBwbGFjZSA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJ1bmRlZmluZWQiKSB7IGJhc2UgPSAxMDsgfQoKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CgogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgogICAgLyoqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2VpbFRvCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KCSogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgoJKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBjZWlsVG86IGZ1bmN0aW9uICh2YWx1ZSwgcGxhY2UsIGJhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBwbGFjZSA9PT0gInVuZGVmaW5lZCIpIHsgcGxhY2UgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAidW5kZWZpbmVkIikgeyBiYXNlID0gMTA7IH0KCiAgICAgICAgdmFyIHAgPSBNYXRoLnBvdyhiYXNlLCAtcGxhY2UpOwoKICAgICAgICByZXR1cm4gTWF0aC5jZWlsKHZhbHVlICogcCkgLyBwOwoKICAgIH0sCgoJLyoqCgkqIEEgb25lIGRpbWVuc2lvbmFsIGxpbmVhciBpbnRlcnBvbGF0aW9uIG9mIGEgdmFsdWUuCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjaW50ZXJwb2xhdGVGbG9hdAoJKiBAcGFyYW0ge251bWJlcn0gYQoJKiBAcGFyYW0ge251bWJlcn0gYgoJKiBAcGFyYW0ge251bWJlcn0gd2VpZ2h0IAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgaW50ZXJwb2xhdGVGbG9hdDogZnVuY3Rpb24gKGEsIGIsIHdlaWdodCkgewogICAgICAgIHJldHVybiAoYiAtIGEpICogd2VpZ2h0ICsgYTsKICAgIH0sCgoJLyoqCgkqIEZpbmQgdGhlIGFuZ2xlIG9mIGEgc2VnbWVudCBmcm9tICh4MSwgeTEpIC0+ICh4MiwgeTIgKS4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNhbmdsZUJldHdlZW4KCSogQHBhcmFtIHtudW1iZXJ9IHgxCgkqIEBwYXJhbSB7bnVtYmVyfSB5MQoJKiBAcGFyYW0ge251bWJlcn0geDIKCSogQHBhcmFtIHtudW1iZXJ9IHkyCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBhbmdsZUJldHdlZW46IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHkyIC0geTEsIHgyIC0geDEpOwogICAgfSwKCgkvKioKCSogU2V0IGFuIGFuZ2xlICB3aXRoaW4gdGhlIGJvdW5kcyBvZiAtJnBpOyB0byZwaTsuCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjbm9ybWFsaXplQW5nbGUKCSogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlCgkqIEBwYXJhbSB7Ym9vbGVhbn0gcmFkaWFucyAtIFRydWUgaWYgYW5nbGUgc2l6ZSBpcyBleHByZXNzZWQgaW4gcmFkaWFucy4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIG5vcm1hbGl6ZUFuZ2xlOiBmdW5jdGlvbiAoYW5nbGUsIHJhZGlhbnMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByYWRpYW5zID09PSAidW5kZWZpbmVkIikgeyByYWRpYW5zID0gdHJ1ZTsgfQoKICAgICAgICB2YXIgcmQgPSAocmFkaWFucykgPyBNYXRoLlBJIDogMTgwOwogICAgICAgIHJldHVybiB0aGlzLndyYXAoYW5nbGUsIHJkLCAtcmQpOwogICAgICAgIAogICAgfSwKCgkvKioKCSogQ2xvc2VzdCBhbmdsZSBiZXR3ZWVuIHR3byBhbmdsZXMgZnJvbSBhMSB0byBhMgoJKiBhYnNvbHV0ZSB2YWx1ZSB0aGUgcmV0dXJuIGZvciBleGFjdCBhbmdsZQoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI25lYXJlc3RBbmdsZUJldHdlZW4KCSogQHBhcmFtIHtudW1iZXJ9IGExCgkqIEBwYXJhbSB7bnVtYmVyfSBhMgoJKiBAcGFyYW0ge2Jvb2xlYW59IHJhZGlhbnMgLSBUcnVlIGlmIGFuZ2xlIHNpemVzIGFyZSBleHByZXNzZWQgaW4gcmFkaWFucy4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIG5lYXJlc3RBbmdsZUJldHdlZW46IGZ1bmN0aW9uIChhMSwgYTIsIHJhZGlhbnMpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByYWRpYW5zID09PSAidW5kZWZpbmVkIikgeyByYWRpYW5zID0gdHJ1ZTsgfQoKICAgICAgICB2YXIgcmQgPSAocmFkaWFucykgPyBNYXRoLlBJIDogMTgwOwogICAgICAgIGExID0gdGhpcy5ub3JtYWxpemVBbmdsZShhMSwgcmFkaWFucyk7CiAgICAgICAgYTIgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGEyLCByYWRpYW5zKTsKICAgICAgICAKICAgICAgICBpZiAoYTEgPCAtcmQgLyAyICYmIGEyID4gcmQgLyAyKQogICAgICAgIHsKICAgICAgICAgICAgYTEgKz0gcmQgKiAyOwogICAgICAgIH0KCiAgICAgICAgaWYgKGEyIDwgLXJkIC8gMiAmJiBhMSA+IHJkIC8gMikKICAgICAgICB7CiAgICAgICAgICAgIGEyICs9IHJkICogMjsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhMiAtIGExOwoKICAgIH0sCgoJLyoqCgkqIEludGVycG9sYXRlIGFjcm9zcyB0aGUgc2hvcnRlc3QgYXJjIGJldHdlZW4gdHdvIGFuZ2xlcy4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNpbnRlcnBvbGF0ZUFuZ2xlcwoJKiBAcGFyYW0ge251bWJlcn0gYTEgLSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtudW1iZXJ9IGEyIC0gRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgLSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtib29sZWFufSByYWRpYW5zIC0gVHJ1ZSBpZiBhbmdsZSBzaXplcyBhcmUgZXhwcmVzc2VkIGluIHJhZGlhbnMuCgkqIEBwYXJhbSB7RGVzY3JpcHRpb259IGVhc2UgLSBEZXNjcmlwdGlvbi4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIGludGVycG9sYXRlQW5nbGVzOiBmdW5jdGlvbiAoYTEsIGEyLCB3ZWlnaHQsIHJhZGlhbnMsIGVhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiByYWRpYW5zID09PSAidW5kZWZpbmVkIikgeyByYWRpYW5zID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgZWFzZSA9PT0gInVuZGVmaW5lZCIpIHsgZWFzZSA9IG51bGw7IH0KCiAgICAgICAgYTEgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGExLCByYWRpYW5zKTsKICAgICAgICBhMiA9IHRoaXMubm9ybWFsaXplQW5nbGVUb0Fub3RoZXIoYTIsIGExLCByYWRpYW5zKTsKCiAgICAgICAgcmV0dXJuICh0eXBlb2YgZWFzZSA9PT0gJ2Z1bmN0aW9uJykgPyBlYXNlKHdlaWdodCwgYTEsIGEyIC0gYTEsIDEpIDogdGhpcy5pbnRlcnBvbGF0ZUZsb2F0KGExLCBhMiwgd2VpZ2h0KTsKCiAgICB9LAoKCS8qKgoJKiBHZW5lcmF0ZSBhIHJhbmRvbSBib29sIHJlc3VsdCBiYXNlZCBvbiB0aGUgY2hhbmNlIHZhbHVlLgoJKiA8cD4KCSogUmV0dXJucyB0cnVlIG9yIGZhbHNlIGJhc2VkIG9uIHRoZSBjaGFuY2UgdmFsdWUgKGRlZmF1bHQgNTAlKS4gRm9yIGV4YW1wbGUgaWYgeW91IHdhbnRlZCBhIHBsYXllciB0byBoYXZlIGEgMzAlIGNoYW5jZQoJKiBvZiBnZXR0aW5nIGEgYm9udXMsIGNhbGwgY2hhbmNlUm9sbCgzMCkgLSB0cnVlIG1lYW5zIHRoZSBjaGFuY2UgcGFzc2VkLCBmYWxzZSBtZWFucyBpdCBmYWlsZWQuCgkqIDwvcD4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjaGFuY2VSb2xsCgkqIEBwYXJhbSB7bnVtYmVyfSBjaGFuY2UgLSBUaGUgY2hhbmNlIG9mIHJlY2VpdmluZyB0aGUgdmFsdWUuIEEgbnVtYmVyIGJldHdlZW4gMCBhbmQgMTAwIChlZmZlY3RpdmVseSAwJSB0byAxMDAlKS4KCSogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcm9sbCBwYXNzZWQsIG9yIGZhbHNlIG90aGVyd2lzZS4KCSovCiAgICBjaGFuY2VSb2xsOiBmdW5jdGlvbiAoY2hhbmNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgY2hhbmNlID09PSAidW5kZWZpbmVkIikgeyBjaGFuY2UgPSA1MDsgfQogICAgICAgIAogICAgICAgIGlmIChjaGFuY2UgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoY2hhbmNlID49IDEwMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoTWF0aC5yYW5kb20oKSAqIDEwMCA+PSBjaGFuY2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYW4gQXJyYXkgY29udGFpbmluZyB0aGUgbnVtYmVycyBmcm9tIG1pbiB0byBtYXggKGluY2x1c2l2ZSkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbnVtYmVyQXJyYXkKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIHRoZSBhcnJheSBzdGFydHMgd2l0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRoZSBhcnJheSBjb250YWlucy4KICAgICogQHJldHVybiB7YXJyYXl9IFRoZSBhcnJheSBvZiBudW1iZXIgdmFsdWVzLgogICAgKi8KICAgIG51bWJlckFycmF5OiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IFtdOwoKICAgICAgICBmb3IgKHZhciBpID0gbWluOyBpIDw9IG1heDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0LnB1c2goaSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgIH0sCgoJLyoqCgkqIEFkZHMgdGhlIGdpdmVuIGFtb3VudCB0byB0aGUgdmFsdWUsIGJ1dCBuZXZlciBsZXRzIHRoZSB2YWx1ZSBnbyBvdmVyIHRoZSBzcGVjaWZpZWQgbWF4aW11bS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXhBZGQKCSogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIGFkZCB0aGUgYW1vdW50IHRvLgoJKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBhZGQgdG8gdGhlIHZhbHVlLgoJKiBAcGFyYW0ge251bWJlcn0gbWF4LSBUaGUgbWF4aW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZS4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIG1heEFkZDogZnVuY3Rpb24gKHZhbHVlLCBhbW91bnQsIG1heCkgewoKICAgICAgICB2YWx1ZSArPSBhbW91bnQ7CgogICAgICAgIGlmICh2YWx1ZSA+IG1heCkKICAgICAgICB7CiAgICAgICAgICAgIHZhbHVlID0gbWF4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgIH0sCgoJLyoqCgkqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4gYW1vdW50IGZyb20gdGhlIHZhbHVlLCBidXQgbmV2ZXIgbGV0cyB0aGUgdmFsdWUgZ28gYmVsb3cgdGhlIHNwZWNpZmllZCBtaW5pbXVtLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI21pblN1YgoJKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgYmFzZSB2YWx1ZS4KCSogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gc3VidHJhY3QgZnJvbSB0aGUgYmFzZSB2YWx1ZS4KCSogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgdmFsdWUuCgkqLwogICAgbWluU3ViOiBmdW5jdGlvbiAodmFsdWUsIGFtb3VudCwgbWluKSB7CgogICAgICAgIHZhbHVlIC09IGFtb3VudDsKICAgICAgICAKICAgICAgICBpZiAodmFsdWUgPCBtaW4pCiAgICAgICAgewogICAgICAgICAgICB2YWx1ZSA9IG1pbjsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2YWx1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBFbnN1cmVzIHRoYXQgdGhlIHZhbHVlIGFsd2F5cyBzdGF5cyBiZXR3ZWVuIG1pbiBhbmQgbWF4LCBieSB3cmFwcGluZyB0aGUgdmFsdWUgYXJvdW5kLgogICAgKiA8cD5tYXggc2hvdWxkIGJlIGxhcmdlciB0aGFuIG1pbiwgb3IgdGhlIGZ1bmN0aW9uIHdpbGwgcmV0dXJuIDA8L3A+CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcAogICAgKiBAcGFyYW0gdmFsdWUgVGhlIHZhbHVlIHRvIHdyYXAKICAgICogQHBhcmFtIG1pbiBUaGUgbWluaW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZQogICAgKiBAcGFyYW0gbWF4IFRoZSBtYXhpbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIHdyYXBwZWQgdmFsdWUKICAgICovCiAgICB3cmFwOiBmdW5jdGlvbiAodmFsdWUsIG1pbiwgbWF4KSB7CgogICAgICAgIHZhciByYW5nZSA9IG1heCAtIG1pbjsKCiAgICAgICAgaWYgKHJhbmdlIDw9IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CgogICAgICAgIHZhciByZXN1bHQgPSAodmFsdWUgLSBtaW4pICUgcmFuZ2U7CgogICAgICAgIGlmIChyZXN1bHQgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ICs9IHJhbmdlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gcmVzdWx0ICsgbWluOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdmFsdWUgdG8gYW1vdW50IGFuZCBlbnN1cmVzIHRoYXQgdGhlIHJlc3VsdCBhbHdheXMgc3RheXMgYmV0d2VlbiAwIGFuZCBtYXgsIGJ5IHdyYXBwaW5nIHRoZSB2YWx1ZSBhcm91bmQuCiAgICAqIDxwPlZhbHVlcyBtdXN0IGJlIHBvc2l0aXZlIGludGVnZXJzLCBhbmQgYXJlIHBhc3NlZCB0aHJvdWdoIE1hdGguYWJzPC9wPgogICAgKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3dyYXBWYWx1ZQoJKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gYWRkIHRoZSBhbW91bnQgdG8uCgkqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGFkZCB0byB0aGUgdmFsdWUuCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB0aGUgdmFsdWUgaXMgYWxsb3dlZCB0byBiZS4KCSogQHJldHVybiB7bnVtYmVyfSBUaGUgd3JhcHBlZCB2YWx1ZS4KICAgICovCiAgICB3cmFwVmFsdWU6IGZ1bmN0aW9uICh2YWx1ZSwgYW1vdW50LCBtYXgpIHsKCiAgICAgICAgdmFyIGRpZmY7CiAgICAgICAgdmFsdWUgPSBNYXRoLmFicyh2YWx1ZSk7CiAgICAgICAgYW1vdW50ID0gTWF0aC5hYnMoYW1vdW50KTsKICAgICAgICBtYXggPSBNYXRoLmFicyhtYXgpOwogICAgICAgIGRpZmYgPSAodmFsdWUgKyBhbW91bnQpICUgbWF4OwoKICAgICAgICByZXR1cm4gZGlmZjsKCiAgICB9LAoKCS8qKgoJKiBSYW5kb21seSByZXR1cm5zIGVpdGhlciBhIDEgb3IgLTEuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjcmFuZG9tU2lnbgoJKiBAcmV0dXJuIHtudW1iZXJ9CTEgb3IgLTEKCSovCiAgICByYW5kb21TaWduOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIChNYXRoLnJhbmRvbSgpID4gMC41KSA/IDEgOiAtMTsKICAgIH0sCgoJLyoqCgkqIFJldHVybnMgdHJ1ZSBpZiB0aGUgbnVtYmVyIGdpdmVuIGlzIG9kZC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNpc09kZAoJKiBAcGFyYW0ge251bWJlcn0gbiAtIFRoZSBudW1iZXIgdG8gY2hlY2suCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBvZGQuIEZhbHNlIGlmIHRoZSBnaXZlbiBudW1iZXIgaXMgZXZlbi4KCSovCiAgICBpc09kZDogZnVuY3Rpb24gKG4pIHsKCiAgICAgICAgcmV0dXJuIChuICYgMSk7CgogICAgfSwKCgkvKioKCSogUmV0dXJucyB0cnVlIGlmIHRoZSBudW1iZXIgZ2l2ZW4gaXMgZXZlbi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNpc0V2ZW4KCSogQHBhcmFtIHtudW1iZXJ9IG4gLSBUaGUgbnVtYmVyIHRvIGNoZWNrLgoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBudW1iZXIgaXMgZXZlbi4gRmFsc2UgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBvZGQuCgkqLwogICAgaXNFdmVuOiBmdW5jdGlvbiAobikgewoKICAgICAgICBpZiAobiAmIDEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTaWduaWZpY2FudGx5IGZhc3RlciB2ZXJzaW9uIG9mIE1hdGgubWF4CiAgICAqIFNlZSBodHRwOi8vanNwZXJmLmNvbS9tYXRoLXMtbWluLW1heC12cy1ob21lbWFkZS81CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWF4CiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGhpZ2hlc3QgdmFsdWUgZnJvbSB0aG9zZSBnaXZlbi4KICAgICovCiAgICBtYXg6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDEsIG1heCA9IDAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHNbbWF4XSA8IGFyZ3VtZW50c1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWF4ID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICByZXR1cm4gYXJndW1lbnRzW21heF07CgogICAgfSwKCiAgICAvKioKICAgICogU2lnbmlmaWNhbnRseSBmYXN0ZXIgdmVyc2lvbiBvZiBNYXRoLm1pbgogICAgKiBTZWUgaHR0cDovL2pzcGVyZi5jb20vbWF0aC1zLW1pbi1tYXgtdnMtaG9tZW1hZGUvNQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI21pbgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBsb3dlc3QgdmFsdWUgZnJvbSB0aG9zZSBnaXZlbi4KICAgICovCiAgICBtaW46IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9MSAsIG1pbiA9IDAsIGxlbiA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHNbaV0gPCBhcmd1bWVudHNbbWluXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbWluID0gaTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGFyZ3VtZW50c1ttaW5dOwoKICAgIH0sCgoJLyoqCgkqIEtlZXBzIGFuIGFuZ2xlIHZhbHVlIGJldHdlZW4gLTE4MCBhbmQgKzE4MDxicj4KCSogU2hvdWxkIGJlIGNhbGxlZCB3aGVuZXZlciB0aGUgYW5nbGUgaXMgdXBkYXRlZCBvbiB0aGUgU3ByaXRlIHRvIHN0b3AgaXQgZnJvbSBnb2luZyBpbnNhbmUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcEFuZ2xlCgkqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSB2YWx1ZSB0byBjaGVjawoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgYW5nbGUgdmFsdWUsIHJldHVybnMgdGhlIHNhbWUgYXMgdGhlIGlucHV0IGFuZ2xlIGlmIGl0IHdhcyB3aXRoaW4gYm91bmRzLgoJKi8KICAgIHdyYXBBbmdsZTogZnVuY3Rpb24gKGFuZ2xlKSB7CgogICAgICAgIHZhciByZXN1bHQgPSBhbmdsZTsKCiAgICAgICAgLy8gIE5vdGhpbmcgbmVlZHMgdG8gY2hhbmdlCiAgICAgICAgaWYgKGFuZ2xlID49IC0xODAgJiYgYW5nbGUgPD0gMTgwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGFuZ2xlOwogICAgICAgIH0KCiAgICAgICAgLy8gIEVsc2Ugbm9ybWFsaXNlIGl0IHRvIC0xODAsIDE4MAogICAgICAgIHJlc3VsdCA9IChhbmdsZSArIDE4MCkgJSAzNjA7CgogICAgICAgIGlmIChyZXN1bHQgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ICs9IDM2MDsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQgLSAxODA7CgogICAgfSwKCgkvKioKCSogS2VlcHMgYW4gYW5nbGUgdmFsdWUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXggdmFsdWVzLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2FuZ2xlTGltaXQKCSogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIHZhbHVlIHRvIGNoZWNrLiBNdXN0IGJlIGJldHdlZW4gLTE4MCBhbmQgKzE4MC4KCSogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIGFuZ2xlIHRoYXQgaXMgYWxsb3dlZCAobXVzdCBiZSAtMTgwIG9yIGdyZWF0ZXIpLgoJKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gYW5nbGUgdGhhdCBpcyBhbGxvd2VkIChtdXN0IGJlIDE4MCBvciBsZXNzKS4KCSoKCSogQHJldHVybiB7bnVtYmVyfSBUaGUgbmV3IGFuZ2xlIHZhbHVlLCByZXR1cm5zIHRoZSBzYW1lIGFzIHRoZSBpbnB1dCBhbmdsZSBpZiBpdCB3YXMgd2l0aGluIGJvdW5kcwoJKi8KICAgIGFuZ2xlTGltaXQ6IGZ1bmN0aW9uIChhbmdsZSwgbWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IGFuZ2xlOwoKICAgICAgICBpZiAoYW5nbGUgPiBtYXgpCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBtYXg7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGFuZ2xlIDwgbWluKQogICAgICAgIHsKICAgICAgICAgICAgcmVzdWx0ID0gbWluOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNsaW5lYXJJbnRlcnBvbGF0aW9uCgkqIEBwYXJhbSB7bnVtYmVyfSB2CgkqIEBwYXJhbSB7bnVtYmVyfSBrCgkqIEByZXR1cm4ge251bWJlcn0gCgkqLwogICAgbGluZWFySW50ZXJwb2xhdGlvbjogZnVuY3Rpb24gKHYsIGspIHsKCiAgICAgICAgdmFyIG0gPSB2Lmxlbmd0aCAtIDE7CiAgICAgICAgdmFyIGYgPSBtICogazsKICAgICAgICB2YXIgaSA9IE1hdGguZmxvb3IoZik7CgogICAgICAgIGlmIChrIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpbmVhcih2WzBdLCB2WzFdLCBmKTsKICAgICAgICB9CgogICAgICAgIGlmIChrID4gMSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxpbmVhcih2W21dLCB2W20gLSAxXSwgbSAtIGYpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMubGluZWFyKHZbaV0sIHZbaSArIDEgPiBtID8gbSA6IGkgKyAxXSwgZiAtIGkpOwoKICAgIH0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2JlemllckludGVycG9sYXRpb24KCSogQHBhcmFtIHtudW1iZXJ9IHYKCSogQHBhcmFtIHtudW1iZXJ9IGsKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIGJlemllckludGVycG9sYXRpb246IGZ1bmN0aW9uICh2LCBrKSB7CgogICAgICAgIHZhciBiID0gMDsKICAgICAgICB2YXIgbiA9IHYubGVuZ3RoIC0gMTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPD0gbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgYiArPSBNYXRoLnBvdygxIC0gaywgbiAtIGkpICogTWF0aC5wb3coaywgaSkgKiB2W2ldICogdGhpcy5iZXJuc3RlaW4obiwgaSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYjsKCiAgICB9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjYXRtdWxsUm9tSW50ZXJwb2xhdGlvbgoJKiBAcGFyYW0ge251bWJlcn0gdgoJKiBAcGFyYW0ge251bWJlcn0gawoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgY2F0bXVsbFJvbUludGVycG9sYXRpb246IGZ1bmN0aW9uICh2LCBrKSB7CgogICAgICAgIHZhciBtID0gdi5sZW5ndGggLSAxOwogICAgICAgIHZhciBmID0gbSAqIGs7CiAgICAgICAgdmFyIGkgPSBNYXRoLmZsb29yKGYpOwoKICAgICAgICBpZiAodlswXSA9PT0gdlttXSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChrIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaSA9IE1hdGguZmxvb3IoZiA9IG0gKiAoMSArIGspKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2F0bXVsbFJvbSh2WyhpIC0gMSArIG0pICUgbV0sIHZbaV0sIHZbKGkgKyAxKSAlIG1dLCB2WyhpICsgMikgJSBtXSwgZiAtIGkpOwoKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGsgPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdlswXSAtICh0aGlzLmNhdG11bGxSb20odlswXSwgdlswXSwgdlsxXSwgdlsxXSwgLWYpIC0gdlswXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChrID4gMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHZbbV0gLSAodGhpcy5jYXRtdWxsUm9tKHZbbV0sIHZbbV0sIHZbbSAtIDFdLCB2W20gLSAxXSwgZiAtIG0pIC0gdlttXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLmNhdG11bGxSb20odltpID8gaSAtIDEgOiAwXSwgdltpXSwgdlttIDwgaSArIDEgPyBtIDogaSArIDFdLCB2W20gPCBpICsgMiA/IG0gOiBpICsgMl0sIGYgLSBpKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjTGluZWFyCgkqIEBwYXJhbSB7bnVtYmVyfSBwMAoJKiBAcGFyYW0ge251bWJlcn0gcDEKCSogQHBhcmFtIHtudW1iZXJ9IHQKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIGxpbmVhcjogZnVuY3Rpb24gKHAwLCBwMSwgdCkgewogICAgICAgIHJldHVybiAocDEgLSBwMCkgKiB0ICsgcDA7CiAgICB9LAoKCS8qKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Jlcm5zdGVpbgoJKiBAcGFyYW0ge251bWJlcn0gbgoJKiBAcGFyYW0ge251bWJlcn0gaQoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgYmVybnN0ZWluOiBmdW5jdGlvbiAobiwgaSkgewogICAgICAgIHJldHVybiB0aGlzLmZhY3RvcmlhbChuKSAvIHRoaXMuZmFjdG9yaWFsKGkpIC8gdGhpcy5mYWN0b3JpYWwobiAtIGkpOwogICAgfSwKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2F0bXVsbFJvbQoJKiBAcGFyYW0ge251bWJlcn0gcDAKCSogQHBhcmFtIHtudW1iZXJ9IHAxCgkqIEBwYXJhbSB7bnVtYmVyfSBwMgoJKiBAcGFyYW0ge251bWJlcn0gcDMKCSogQHBhcmFtIHtudW1iZXJ9IHQKCSogQHJldHVybiB7bnVtYmVyfSAKCSovCiAgICBjYXRtdWxsUm9tOiBmdW5jdGlvbiAocDAsIHAxLCBwMiwgcDMsIHQpIHsKCiAgICAgICAgdmFyIHYwID0gKHAyIC0gcDApICogMC41LCB2MSA9IChwMyAtIHAxKSAqIDAuNSwgdDIgPSB0ICogdCwgdDMgPSB0ICogdDI7CgogICAgICAgIHJldHVybiAoMiAqIHAxIC0gMiAqIHAyICsgdjAgKyB2MSkgKiB0MyArICgtMyAqIHAxICsgMyAqIHAyIC0gMiAqIHYwIC0gdjEpICogdDIgKyB2MCAqIHQgKyBwMTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2RpZmZlcmVuY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IGEKICAgICogQHBhcmFtIHtudW1iZXJ9IGIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIGRpZmZlcmVuY2U6IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYWJzKGEgLSBiKTsKICAgIH0sCgoJLyoqCgkqIEZldGNoIGEgcmFuZG9tIGVudHJ5IGZyb20gdGhlIGdpdmVuIGFycmF5LgoJKiBXaWxsIHJldHVybiBudWxsIGlmIHJhbmRvbSBzZWxlY3Rpb24gaXMgbWlzc2luZywgb3IgYXJyYXkgaGFzIG5vIGVudHJpZXMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjZ2V0UmFuZG9tCgkqIEBwYXJhbSB7YXJyYXl9IG9iamVjdHMgLSBBbiBhcnJheSBvZiBvYmplY3RzLgoJKiBAcGFyYW0ge251bWJlcn0gc3RhcnRJbmRleCAtIE9wdGlvbmFsIG9mZnNldCBvZmYgdGhlIGZyb250IG9mIHRoZSBhcnJheS4gRGVmYXVsdCB2YWx1ZSBpcyAwLCBvciB0aGUgYmVnaW5uaW5nIG9mIHRoZSBhcnJheS4KCSogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIE9wdGlvbmFsIHJlc3RyaWN0aW9uIG9uIHRoZSBudW1iZXIgb2YgdmFsdWVzIHlvdSB3YW50IHRvIHJhbmRvbWx5IHNlbGVjdCBmcm9tLgoJKiBAcmV0dXJuIHtvYmplY3R9IFRoZSByYW5kb20gb2JqZWN0IHRoYXQgd2FzIHNlbGVjdGVkLgoJKi8KICAgIGdldFJhbmRvbTogZnVuY3Rpb24gKG9iamVjdHMsIHN0YXJ0SW5kZXgsIGxlbmd0aCkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0SW5kZXggPT09ICJ1bmRlZmluZWQiKSB7IHN0YXJ0SW5kZXggPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBsZW5ndGggPT09ICJ1bmRlZmluZWQiKSB7IGxlbmd0aCA9IDA7IH0KICAgICAgICAKICAgICAgICBpZiAob2JqZWN0cyAhPSBudWxsKSB7CgogICAgICAgICAgICB2YXIgbCA9IGxlbmd0aDsKCiAgICAgICAgICAgIGlmICgobCA9PSAwKSB8fCAobCA+IG9iamVjdHMubGVuZ3RoIC0gc3RhcnRJbmRleCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGwgPSBvYmplY3RzLmxlbmd0aCAtIHN0YXJ0SW5kZXg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChsID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIG9iamVjdHNbc3RhcnRJbmRleCArIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIGwpXTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKCSogUm91bmQgZG93biB0byB0aGUgbmV4dCB3aG9sZSBudW1iZXIuIEUuZy4gZmxvb3IoMS43KSA9PSAxLCBhbmQgZmxvb3IoLTIuNykgPT0gLTIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjZmxvb3IKCSogQHBhcmFtIHtudW1iZXJ9IFZhbHVlCUFueSBudW1iZXIuCgkqIEByZXR1cm4ge251bWJlcn0gVGhlIHJvdW5kZWQgdmFsdWUgb2YgdGhhdCBudW1iZXIuCgkqLwogICAgZmxvb3I6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB2YXIgbiA9IHZhbHVlIHwgMDsKCiAgICAgICAgcmV0dXJuICh2YWx1ZSA+IDApID8gKG4pIDogKChuICE9IHZhbHVlKSA/IChuIC0gMSkgOiAobikpOwoKICAgIH0sCgoJLyoqCgkqIFJvdW5kIHVwIHRvIHRoZSBuZXh0IHdob2xlIG51bWJlci4gIEUuZy4gY2VpbCgxLjMpID09IDIsIGFuZCBjZWlsKC0yLjMpID09IC0zLgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NlaWwKCSogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gQW55IG51bWJlci4KCSogQHJldHVybiB7bnVtYmVyfSBUaGUgcm91bmRlZCB2YWx1ZSBvZiB0aGF0IG51bWJlci4KCSovCiAgICBjZWlsOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB2YXIgbiA9IHZhbHVlIHwgMDsKICAgICAgICByZXR1cm4gKHZhbHVlID4gMCkgPyAoKG4gIT0gdmFsdWUpID8gKG4gKyAxKSA6IChuKSkgOiAobik7CiAgICB9LAoKCS8qKgogICAgKiBHZW5lcmF0ZSBhIHNpbmUgYW5kIGNvc2luZSB0YWJsZSBzaW11bHRhbmVvdXNseSBhbmQgZXh0cmVtZWx5IHF1aWNrbHkuIEJhc2VkIG9uIHJlc2VhcmNoIGJ5IEZyYW5reSBvZiBzY2VuZS5hdAogICAgKiA8cD4KICAgICogVGhlIHBhcmFtZXRlcnMgYWxsb3cgeW91IHRvIHNwZWNpZnkgdGhlIGxlbmd0aCwgYW1wbGl0dWRlIGFuZCBmcmVxdWVuY3kgb2YgdGhlIHdhdmUuIE9uY2UgeW91IGhhdmUgY2FsbGVkIHRoaXMgZnVuY3Rpb24KICAgICogeW91IHNob3VsZCBnZXQgdGhlIHJlc3VsdHMgdmlhIGdldFNpblRhYmxlKCkgYW5kIGdldENvc1RhYmxlKCkuIFRoaXMgZ2VuZXJhdG9yIGlzIGZhc3QgZW5vdWdoIHRvIGJlIHVzZWQgaW4gcmVhbC10aW1lLgogICAgKiA8L3A+CiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2luQ29zR2VuZXJhdG9yCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZW5ndGggLSBUaGUgbGVuZ3RoIG9mIHRoZSB3YXZlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzaW5BbXBsaXR1ZGUgLSBUaGUgYW1wbGl0dWRlIHRvIGFwcGx5IHRvIHRoZSBzaW5lIHRhYmxlIChkZWZhdWx0IDEuMCkgaWYgeW91IG5lZWQgdmFsdWVzIGJldHdlZW4gc2F5IC0rIDEyNSB0aGVuIGdpdmUgMTI1IGFzIHRoZSB2YWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gY29zQW1wbGl0dWRlIC0gVGhlIGFtcGxpdHVkZSB0byBhcHBseSB0byB0aGUgY29zaW5lIHRhYmxlIChkZWZhdWx0IDEuMCkgaWYgeW91IG5lZWQgdmFsdWVzIGJldHdlZW4gc2F5IC0rIDEyNSB0aGVuIGdpdmUgMTI1IGFzIHRoZSB2YWx1ZQogICAgKiBAcGFyYW0ge251bWJlcn0gZnJlcXVlbmN5ICAtIFRoZSBmcmVxdWVuY3kgb2YgdGhlIHNpbmUgYW5kIGNvc2luZSB0YWJsZSBkYXRhCiAgICAqIEByZXR1cm4ge0FycmF5fSBSZXR1cm5zIHRoZSBzaW5lIHRhYmxlCiAgICAqLwogICAgc2luQ29zR2VuZXJhdG9yOiBmdW5jdGlvbiAobGVuZ3RoLCBzaW5BbXBsaXR1ZGUsIGNvc0FtcGxpdHVkZSwgZnJlcXVlbmN5KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc2luQW1wbGl0dWRlID09PSAidW5kZWZpbmVkIikgeyBzaW5BbXBsaXR1ZGUgPSAxLjA7IH0KICAgICAgICBpZiAodHlwZW9mIGNvc0FtcGxpdHVkZSA9PT0gInVuZGVmaW5lZCIpIHsgY29zQW1wbGl0dWRlID0gMS4wOyB9CiAgICAgICAgaWYgKHR5cGVvZiBmcmVxdWVuY3kgPT09ICJ1bmRlZmluZWQiKSB7IGZyZXF1ZW5jeSA9IDEuMDsgfQogICAgICAgIAogICAgICAgIHZhciBzaW4gPSBzaW5BbXBsaXR1ZGU7CiAgICAgICAgdmFyIGNvcyA9IGNvc0FtcGxpdHVkZTsKICAgICAgICB2YXIgZnJxID0gZnJlcXVlbmN5ICogTWF0aC5QSSAvIGxlbmd0aDsKICAgICAgICAKICAgICAgICB2YXIgY29zVGFibGUgPSBbXTsKICAgICAgICB2YXIgc2luVGFibGUgPSBbXTsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGxlbmd0aDsgYysrKSB7CgogICAgICAgICAgICBjb3MgLT0gc2luICogZnJxOwogICAgICAgICAgICBzaW4gKz0gY29zICogZnJxOwoKICAgICAgICAgICAgY29zVGFibGVbY10gPSBjb3M7CiAgICAgICAgICAgIHNpblRhYmxlW2NdID0gc2luOwoKICAgICAgICB9CgogICAgICAgIHJldHVybiB7IHNpbjogc2luVGFibGUsIGNvczogY29zVGFibGUsIGxlbmd0aDogbGVuZ3RoIH07CgogICAgfSwKCgkvKioKCSogUmVtb3ZlcyB0aGUgdG9wIGVsZW1lbnQgZnJvbSB0aGUgc3RhY2sgYW5kIHJlLWluc2VydHMgaXQgb250byB0aGUgYm90dG9tLCB0aGVuIHJldHVybnMgaXQuCgkqIFRoZSBvcmlnaW5hbCBzdGFjayBpcyBtb2RpZmllZCBpbiB0aGUgcHJvY2Vzcy4gVGhpcyBlZmZlY3RpdmVseSBtb3ZlcyB0aGUgcG9zaXRpb24gb2YgdGhlIGRhdGEgZnJvbSB0aGUgc3RhcnQgdG8gdGhlIGVuZCBvZiB0aGUgdGFibGUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NoaWZ0CiAgICAqIEBwYXJhbSB7YXJyYXl9IHN0YWNrIC0gVGhlIGFycmF5IHRvIHNoaWZ0LgogICAgKiBAcmV0dXJuIHthbnl9IFRoZSBzaGlmdGVkIHZhbHVlLgogICAgKi8KICAgIHNoaWZ0OiBmdW5jdGlvbiAoc3RhY2spIHsKCiAgICAJdmFyIHMgPSBzdGFjay5zaGlmdCgpOwogICAgCXN0YWNrLnB1c2gocyk7CgogICAgCXJldHVybiBzOwoKICAgIH0sCgoJLyoqCiAgICAqIFNodWZmbGVzIHRoZSBkYXRhIGluIHRoZSBnaXZlbiBhcnJheSBpbnRvIGEgbmV3IG9yZGVyCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2h1ZmZsZUFycmF5CiAgICAqIEBwYXJhbSB7YXJyYXl9IGFycmF5IC0gVGhlIGFycmF5IHRvIHNodWZmbGUKICAgICogQHJldHVybiB7YXJyYXl9IFRoZSBhcnJheQogICAgKi8KICAgIHNodWZmbGVBcnJheTogZnVuY3Rpb24gKGFycmF5KSB7CgogICAgICAgIGZvciAodmFyIGkgPSBhcnJheS5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7CgogICAgICAgICAgICB2YXIgaiA9IE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChpICsgMSkpOwogICAgICAgICAgICB2YXIgdGVtcCA9IGFycmF5W2ldOwogICAgICAgICAgICBhcnJheVtpXSA9IGFycmF5W2pdOwogICAgICAgICAgICBhcnJheVtqXSA9IHRlbXA7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXJyYXk7CgogICAgfSwKCgkvKioKICAgICogUmV0dXJucyB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIGdpdmVuIHNldCBvZiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlzdGFuY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHgxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MQogICAgKiBAcGFyYW0ge251bWJlcn0geDIKICAgICogQHBhcmFtIHtudW1iZXJ9IHkyCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiAgICAqKi8KICAgIGRpc3RhbmNlOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIpIHsKCiAgICAgICAgdmFyIGR4ID0geDEgLSB4MjsKICAgICAgICB2YXIgZHkgPSB5MSAtIHkyOwoKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KGR4ICogZHggKyBkeSAqIGR5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSByb3VuZGVkIGRpc3RhbmNlIGJldHdlZW4gdGhlIHR3byBnaXZlbiBzZXQgb2YgY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Rpc3RhbmNlUm91bmRlZAogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KICAgICoqLwogICAgZGlzdGFuY2VSb3VuZGVkOiBmdW5jdGlvbiAoeDEsIHkxLCB4MiwgeTIpIHsKCiAgICAJcmV0dXJuIE1hdGgucm91bmQoUGhhc2VyLk1hdGguZGlzdGFuY2UoeDEsIHkxLCB4MiwgeTIpKTsKCiAgICB9LAoKCS8qKgoJKiBGb3JjZSBhIHZhbHVlIHdpdGhpbiB0aGUgYm91bmRhcmllcyBvZiB0d28gdmFsdWVzLgoJKiBDbGFtcCB2YWx1ZSB0byByYW5nZSA8YSwgYj4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2xhbXAKCSogQHBhcmFtIHtudW1iZXJ9IHgKCSogQHBhcmFtIHtudW1iZXJ9IGEKCSogQHBhcmFtIHtudW1iZXJ9IGIKICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KCWNsYW1wOiBmdW5jdGlvbiAoIHgsIGEsIGIgKSB7CgoJCXJldHVybiAoIHggPCBhICkgPyBhIDogKCAoIHggPiBiICkgPyBiIDogeCApOwoKCX0sCiAKCS8qKgoJKiBDbGFtcCB2YWx1ZSB0byByYW5nZSA8YSwgaW5mKS4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2xhbXBCb3R0b20KCSogQHBhcmFtIHtudW1iZXJ9IHgKCSogQHBhcmFtIHtudW1iZXJ9IGEKICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KCWNsYW1wQm90dG9tOiBmdW5jdGlvbiAoIHgsIGEgKSB7CgoJCXJldHVybiB4IDwgYSA/IGEgOiB4OwoKCX0sCgogICAgLyoqCiAgICAqIENoZWNrcyBpZiB0d28gdmFsdWVzIGFyZSB3aXRoaW4gdGhlIGdpdmVuIHRvbGVyYW5jZSBvZiBlYWNoIG90aGVyLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCN3aXRoaW4KICAgICogQHBhcmFtIHtudW1iZXJ9IGEgLSBUaGUgZmlyc3QgbnVtYmVyIHRvIGNoZWNrCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiIC0gVGhlIHNlY29uZCBudW1iZXIgdG8gY2hlY2sKICAgICogQHBhcmFtIHtudW1iZXJ9IHRvbGVyYW5jZSAtIFRoZSB0b2xlcmFuY2UuIEFueXRoaW5nIGVxdWFsIHRvIG9yIGxlc3MgdGhhbiB0aGlzIGlzIGNvbnNpZGVyZWQgd2l0aGluIHRoZSByYW5nZS4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhIGlzIDw9IHRvbGVyYW5jZSBvZiBiLgogICAgKi8KICAgIHdpdGhpbjogZnVuY3Rpb24gKCBhLCBiLCB0b2xlcmFuY2UgKSB7CgogICAgICAgIHJldHVybiAoTWF0aC5hYnMoYSAtIGIpIDw9IHRvbGVyYW5jZSk7CgogICAgfSwKIAoJLyoqCgkqIExpbmVhciBtYXBwaW5nIGZyb20gcmFuZ2UgPGExLCBhMj4gdG8gcmFuZ2UgPGIxLCBiMj4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWFwTGluZWFyCgkqIEBwYXJhbSB7bnVtYmVyfSB4CgkqIEBwYXJhbSB7bnVtYmVyfSBhMQoJKiBAcGFyYW0ge251bWJlcn0gYTEKCSogQHBhcmFtIHtudW1iZXJ9IGEyCgkqIEBwYXJhbSB7bnVtYmVyfSBiMQoJKiBAcGFyYW0ge251bWJlcn0gYjIKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCW1hcExpbmVhcjogZnVuY3Rpb24gKCB4LCBhMSwgYTIsIGIxLCBiMiApIHsKCgkJcmV0dXJuIGIxICsgKCB4IC0gYTEgKSAqICggYjIgLSBiMSApIC8gKCBhMiAtIGExICk7CgoJfSwKCgkvKioKCSogU21vb3Roc3RlcCBmdW5jdGlvbiBhcyBkZXRhaWxlZCBhdCBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1Ntb290aHN0ZXAKCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjc21vb3Roc3RlcAoJKiBAcGFyYW0ge251bWJlcn0geAoJKiBAcGFyYW0ge251bWJlcn0gbWluCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXgKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCXNtb290aHN0ZXA6IGZ1bmN0aW9uICggeCwgbWluLCBtYXggKSB7CgoJCWlmICggeCA8PSBtaW4gKSByZXR1cm4gMDsKCQlpZiAoIHggPj0gbWF4ICkgcmV0dXJuIDE7CgoJCXggPSAoIHggLSBtaW4gKS8oIG1heCAtIG1pbiApOwoKCQlyZXR1cm4geCp4KigzIC0gMip4KTsKCgl9LAoKCS8qKgogICAgKiBTbW9vdGhlcnN0ZXAgZnVuY3Rpb24gYXMgZGV0YWlsZWQgYXQgaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9TbW9vdGhzdGVwCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3Ntb290aGVyc3RlcAoJKiBAcGFyYW0ge251bWJlcn0geAoJKiBAcGFyYW0ge251bWJlcn0gbWluCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXgKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCXNtb290aGVyc3RlcDogZnVuY3Rpb24gKCB4LCBtaW4sIG1heCApIHsKCgkJaWYgKCB4IDw9IG1pbiApIHJldHVybiAwOwoJCWlmICggeCA+PSBtYXggKSByZXR1cm4gMTsKCgkJeCA9ICggeCAtIG1pbiApLyggbWF4IC0gbWluICk7CgoJCXJldHVybiB4KngqeCooeCooeCo2IC0gMTUpICsgMTApOwoKCX0sCgoJLyoqCgkqIEEgdmFsdWUgcmVwcmVzZW50aW5nIHRoZSBzaWduIG9mIHRoZSB2YWx1ZS4KCSogLTEgZm9yIG5lZ2F0aXZlLCArMSBmb3IgcG9zaXRpdmUsIDAgaWYgdmFsdWUgaXMgMAoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaWduCgkqIEBwYXJhbSB7bnVtYmVyfSB4CgkqIEByZXR1cm4ge251bWJlcn0KCSovCglzaWduOiBmdW5jdGlvbiAoIHggKSB7CgoJCXJldHVybiAoIHggPCAwICkgPyAtMSA6ICggKCB4ID4gMCApID8gMSA6IDAgKTsKCgl9LAoKCS8qKgoJKiBDb252ZXJ0IGRlZ3JlZXMgdG8gcmFkaWFucy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGVnVG9SYWQKCSogQHJldHVybiB7ZnVuY3Rpb259CgkqLwoJZGVnVG9SYWQ6IGZ1bmN0aW9uKCkgewoKCQl2YXIgZGVncmVlVG9SYWRpYW5zRmFjdG9yID0gTWF0aC5QSSAvIDE4MDsKCgkJcmV0dXJuIGZ1bmN0aW9uICggZGVncmVlcyApIHsKCgkJCXJldHVybiBkZWdyZWVzICogZGVncmVlVG9SYWRpYW5zRmFjdG9yOwoKCQl9OwoKCX0oKSwKCgkvKioKCSogQ29udmVydCBkZWdyZWVzIHRvIHJhZGlhbnMuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JhZFRvRGVnCgkqIEByZXR1cm4ge2Z1bmN0aW9ufQoJKi8KCXJhZFRvRGVnOiBmdW5jdGlvbigpIHsKCgkJdmFyIHJhZGlhblRvRGVncmVlc0ZhY3RvciA9IDE4MCAvIE1hdGguUEk7CgoJCXJldHVybiBmdW5jdGlvbiAoIHJhZGlhbnMgKSB7CgoJCQlyZXR1cm4gcmFkaWFucyAqIHJhZGlhblRvRGVncmVlc0ZhY3RvcjsKCgkJfTsKCgl9KCkKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKICogSmF2YXNjcmlwdCBRdWFkVHJlZSAKICogQHZlcnNpb24gMS4wCiAqIEBhdXRob3IgVGltbyBIYXVzbWFubgogKgogKiBAdmVyc2lvbiAxLjIsIFNlcHRlbWJlciA0dGggMjAxMwogKiBAYXV0aG9yIFJpY2hhcmQgRGF2ZXkKICogVGhlIG9yaWdpbmFsIGNvZGUgd2FzIGEgY29udmVyc2lvbiBvZiB0aGUgSmF2YSBjb2RlIHBvc3RlZCB0byBHYW1lRGV2VHV0cy4gSG93ZXZlciBJJ3ZlIHR3ZWFrZWQKICogaXQgbWFzc2l2ZWx5IHRvIGFkZCBub2RlIGluZGV4aW5nLCByZW1vdmVkIGxvdHMgb2YgdGVtcC4gdmFyIGNyZWF0aW9uIGFuZCBzaWduaWZpY2FudGx5CiAqIGluY3JlYXNlZCBwZXJmb3JtYW5jZSBhcyBhIHJlc3VsdC4KICoKICogT3JpZ2luYWwgdmVyc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vdGltb2hhdXNtYW5uL3F1YWR0cmVlLWpzLwogKi8KIAovKioKKiBAY29weXJpZ2h0IMKpIDIwMTIgVGltbyBIYXVzbWFubgoqCiogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nCiogYSBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCiogIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZwoqIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwKKiBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8KKiBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8KKiB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CioKKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZQoqIGluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoqCiogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsCiogRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GCiogTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQKKiBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFCiogTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTgoqIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTgoqIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLgoqLwoKLyoqCiAqIFF1YWRUcmVlIENvbnN0cnVjdG9yCiAqIAogKiBAY2xhc3MgUGhhc2VyLlF1YWRUcmVlCiAqIEBjbGFzc2Rlc2MgQSBRdWFkVHJlZSBpbXBsZW1lbnRhdGlvbi4gVGhlIG9yaWdpbmFsIGNvZGUgd2FzIGEgY29udmVyc2lvbiBvZiB0aGUgSmF2YSBjb2RlIHBvc3RlZCB0byBHYW1lRGV2VHV0cy4gSG93ZXZlciBJJ3ZlIHR3ZWFrZWQKICogaXQgbWFzc2l2ZWx5IHRvIGFkZCBub2RlIGluZGV4aW5nLCByZW1vdmVkIGxvdHMgb2YgdGVtcC4gdmFyIGNyZWF0aW9uIGFuZCBzaWduaWZpY2FudGx5IGluY3JlYXNlZCBwZXJmb3JtYW5jZSBhcyBhIHJlc3VsdC4gT3JpZ2luYWwgdmVyc2lvbiBhdCBodHRwczovL2dpdGh1Yi5jb20vdGltb2hhdXNtYW5uL3F1YWR0cmVlLWpzLwogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHtEZXNjcmlwdGlvbn0gcGh5c2ljc01hbmFnZXIgLSBEZXNjcmlwdGlvbi4KICogQHBhcmFtIHtEZXNjcmlwdGlvbn0geCAtIERlc2NyaXB0aW9uLgogKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB5IC0gRGVzY3JpcHRpb24uCiAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB5b3VyIGdhbWUgaW4gZ2FtZSBwaXhlbHMuCiAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHlvdXIgZ2FtZSBpbiBnYW1lIHBpeGVscy4KICogQHBhcmFtIHtudW1iZXJ9IG1heE9iamVjdHMgLSBEZXNjcmlwdGlvbi4KICogQHBhcmFtIHtudW1iZXJ9IG1heExldmVscyAtIERlc2NyaXB0aW9uLgogKiBAcGFyYW0ge251bWJlcn0gbGV2ZWwgLSBEZXNjcmlwdGlvbi4KICovClBoYXNlci5RdWFkVHJlZSA9IGZ1bmN0aW9uIChwaHlzaWNzTWFuYWdlciwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbWF4T2JqZWN0cywgbWF4TGV2ZWxzLCBsZXZlbCkgewoJCQoJdGhpcy5waHlzaWNzTWFuYWdlciA9IHBoeXNpY3NNYW5hZ2VyOwoJdGhpcy5JRCA9IHBoeXNpY3NNYW5hZ2VyLnF1YWRUcmVlSUQ7CglwaHlzaWNzTWFuYWdlci5xdWFkVHJlZUlEKys7CgoJdGhpcy5tYXhPYmplY3RzID0gbWF4T2JqZWN0cyB8fCAxMDsKCXRoaXMubWF4TGV2ZWxzID0gbWF4TGV2ZWxzIHx8IDQ7Cgl0aGlzLmxldmVsID0gbGV2ZWwgfHwgMDsKCgl0aGlzLmJvdW5kcyA9IHsgCgkJeDogTWF0aC5yb3VuZCh4KSwgCgkJeTogTWF0aC5yb3VuZCh5KSwgCgkJd2lkdGg6IHdpZHRoLCAKCQloZWlnaHQ6IGhlaWdodCwgCgkJc3ViV2lkdGg6IE1hdGguZmxvb3Iod2lkdGggLyAyKSwKCQlzdWJIZWlnaHQ6IE1hdGguZmxvb3IoaGVpZ2h0IC8gMiksCgkJcmlnaHQ6IE1hdGgucm91bmQoeCkgKyBNYXRoLmZsb29yKHdpZHRoIC8gMiksCgkJYm90dG9tOiBNYXRoLnJvdW5kKHkpICsgTWF0aC5mbG9vcihoZWlnaHQgLyAyKQoJfTsKCQoJdGhpcy5vYmplY3RzID0gW107Cgl0aGlzLm5vZGVzID0gW107Cgp9OwoKUGhhc2VyLlF1YWRUcmVlLnByb3RvdHlwZSA9IHsKCgkvKgoJKiBTcGxpdCB0aGUgbm9kZSBpbnRvIDQgc3Vibm9kZXMKCSogCgkqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3NwbGl0CgkqLwoJc3BsaXQ6IGZ1bmN0aW9uKCkgewoKCQl0aGlzLmxldmVsKys7CgkJCgkgCS8vCXRvcCByaWdodCBub2RlCgkJdGhpcy5ub2Rlc1swXSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5waHlzaWNzTWFuYWdlciwgdGhpcy5ib3VuZHMucmlnaHQsIHRoaXMuYm91bmRzLnksIHRoaXMuYm91bmRzLnN1YldpZHRoLCB0aGlzLmJvdW5kcy5zdWJIZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMsIHRoaXMubGV2ZWwpOwoJCQoJCS8vCXRvcCBsZWZ0IG5vZGUKCQl0aGlzLm5vZGVzWzFdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLnBoeXNpY3NNYW5hZ2VyLCB0aGlzLmJvdW5kcy54LCB0aGlzLmJvdW5kcy55LCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKCQkKCQkvLwlib3R0b20gbGVmdCBub2RlCgkJdGhpcy5ub2Rlc1syXSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5waHlzaWNzTWFuYWdlciwgdGhpcy5ib3VuZHMueCwgdGhpcy5ib3VuZHMuYm90dG9tLCB0aGlzLmJvdW5kcy5zdWJXaWR0aCwgdGhpcy5ib3VuZHMuc3ViSGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzLCB0aGlzLmxldmVsKTsKCQkKCQkvLwlib3R0b20gcmlnaHQgbm9kZQoJCXRoaXMubm9kZXNbM10gPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMucGh5c2ljc01hbmFnZXIsIHRoaXMuYm91bmRzLnJpZ2h0LCB0aGlzLmJvdW5kcy5ib3R0b20sIHRoaXMuYm91bmRzLnN1YldpZHRoLCB0aGlzLmJvdW5kcy5zdWJIZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMsIHRoaXMubGV2ZWwpOwoKCX0sCgoJLyoKCSAqIEluc2VydCB0aGUgb2JqZWN0IGludG8gdGhlIG5vZGUuIElmIHRoZSBub2RlCgkgKiBleGNlZWRzIHRoZSBjYXBhY2l0eSwgaXQgd2lsbCBzcGxpdCBhbmQgYWRkIGFsbAoJICogb2JqZWN0cyB0byB0aGVpciBjb3JyZXNwb25kaW5nIHN1Ym5vZGVzLgoJICogCgkgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNpbnNlcnQKCSAqIEBwYXJhbSB7b2JqZWN0fSBib2R5IC0gRGVzY3JpcHRpb24uCgkgKi8KCWluc2VydDogZnVuY3Rpb24gKGJvZHkpIHsKCQkKCQl2YXIgaSA9IDA7CgkJdmFyIGluZGV4OwoJIAkKCSAJLy8JaWYgd2UgaGF2ZSBzdWJub2RlcyAuLi4KCQlpZiAodGhpcy5ub2Rlc1swXSAhPSBudWxsKQoJCXsKCQkJaW5kZXggPSB0aGlzLmdldEluZGV4KGJvZHkpOwoJIAoJCSAgCWlmIChpbmRleCAhPT0gLTEpCgkJICAJewoJCQkJdGhpcy5ub2Rlc1tpbmRleF0uaW5zZXJ0KGJvZHkpOwoJCQkgCXJldHVybjsKCQkJfQoJCX0KCSAKCSAJdGhpcy5vYmplY3RzLnB1c2goYm9keSk7CgkJCgkJaWYgKHRoaXMub2JqZWN0cy5sZW5ndGggPiB0aGlzLm1heE9iamVjdHMgJiYgdGhpcy5sZXZlbCA8IHRoaXMubWF4TGV2ZWxzKQoJCXsKCQkJLy8JU3BsaXQgaWYgd2UgZG9uJ3QgYWxyZWFkeSBoYXZlIHN1Ym5vZGVzCgkJCWlmICh0aGlzLm5vZGVzWzBdID09IG51bGwpCgkJCXsKCQkJCXRoaXMuc3BsaXQoKTsKCQkJfQoJCQkKCQkJLy8JQWRkIG9iamVjdHMgdG8gc3Vibm9kZXMKCQkJd2hpbGUgKGkgPCB0aGlzLm9iamVjdHMubGVuZ3RoKQoJCQl7CgkJCQlpbmRleCA9IHRoaXMuZ2V0SW5kZXgodGhpcy5vYmplY3RzW2ldKTsKCQkJCQoJCQkJaWYgKGluZGV4ICE9PSAtMSkKCQkJCXsKCQkJCQkvLwl0aGlzIGlzIGV4cGVuc2l2ZSAtIHNlZSB3aGF0IHdlIGNhbiBkbyBhYm91dCBpdAoJCQkJCXRoaXMubm9kZXNbaW5kZXhdLmluc2VydCh0aGlzLm9iamVjdHMuc3BsaWNlKGksIDEpWzBdKTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQlpKys7CgkJCSAJfQoJCSAJfQoJCX0KCSB9LAoJIAoJLyoKCSAqIERldGVybWluZSB3aGljaCBub2RlIHRoZSBvYmplY3QgYmVsb25ncyB0by4KCSAqIAoJICogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjZ2V0SW5kZXgKCSAqIEBwYXJhbSB7b2JqZWN0fSByZWN0CS0gRGVzY3JpcHRpb24uCgkgKiBAcmV0dXJuIHtudW1iZXJ9IGluZGV4IC0JSW5kZXggb2YgdGhlIHN1Ym5vZGUgKDAtMyksIG9yIC0xIGlmIHJlY3QgY2Fubm90IGNvbXBsZXRlbHkgZml0IHdpdGhpbiBhIHN1Ym5vZGUgYW5kIGlzIHBhcnQgb2YgdGhlIHBhcmVudCBub2RlLgoJICovCglnZXRJbmRleDogZnVuY3Rpb24gKHJlY3QpIHsKCQkKCQkvLwlkZWZhdWx0IGlzIHRoYXQgcmVjdCBkb2Vzbid0IGZpdCwgaS5lLiBpdCBzdHJhZGRsZXMgdGhlIGludGVybmFsIHF1YWRyYW50cwoJCXZhciBpbmRleCA9IC0xOwoKCQlpZiAocmVjdC54IDwgdGhpcy5ib3VuZHMucmlnaHQgJiYgcmVjdC5yaWdodCA8IHRoaXMuYm91bmRzLnJpZ2h0KQoJCXsKCQkJaWYgKChyZWN0LnkgPCB0aGlzLmJvdW5kcy5ib3R0b20gJiYgcmVjdC5ib3R0b20gPCB0aGlzLmJvdW5kcy5ib3R0b20pKQoJCQl7CgkJCQkvLwlyZWN0IGZpdHMgd2l0aGluIHRoZSB0b3AtbGVmdCBxdWFkcmFudCBvZiB0aGlzIHF1YWR0cmVlCgkJCQlpbmRleCA9IDE7CgkJCX0KCQkJZWxzZSBpZiAoKHJlY3QueSA+IHRoaXMuYm91bmRzLmJvdHRvbSkpCgkJCXsKCQkJCS8vCXJlY3QgZml0cyB3aXRoaW4gdGhlIGJvdHRvbS1sZWZ0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKCQkJCWluZGV4ID0gMjsKCQkJfQoJCX0KCQllbHNlIGlmIChyZWN0LnggPiB0aGlzLmJvdW5kcy5yaWdodCkKCQl7CgkJCS8vCXJlY3QgY2FuIGNvbXBsZXRlbHkgZml0IHdpdGhpbiB0aGUgcmlnaHQgcXVhZHJhbnRzCgkJCWlmICgocmVjdC55IDwgdGhpcy5ib3VuZHMuYm90dG9tICYmIHJlY3QuYm90dG9tIDwgdGhpcy5ib3VuZHMuYm90dG9tKSkKCQkJewoJCQkJLy8JcmVjdCBmaXRzIHdpdGhpbiB0aGUgdG9wLXJpZ2h0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKCQkJCWluZGV4ID0gMDsKCQkJfQoJCQllbHNlIGlmICgocmVjdC55ID4gdGhpcy5ib3VuZHMuYm90dG9tKSkKCQkJewoJCQkJLy8JcmVjdCBmaXRzIHdpdGhpbiB0aGUgYm90dG9tLXJpZ2h0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKCQkJCWluZGV4ID0gMzsKCQkJfQoJCX0KCSAKCQlyZXR1cm4gaW5kZXg7CgoJfSwKCgkgLyoKCSAqIFJldHVybiBhbGwgb2JqZWN0cyB0aGF0IGNvdWxkIGNvbGxpZGUgd2l0aCB0aGUgZ2l2ZW4gb2JqZWN0LgoJICogCgkgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNyZXRyaWV2ZQoJICogQHBhcmFtIHtvYmplY3R9IHJlY3QJLSBEZXNjcmlwdGlvbi4KCSAqIEBSZXR1cm4ge2FycmF5fSAtIEFycmF5IHdpdGggYWxsIGRldGVjdGVkIG9iamVjdHMuCgkgKi8KCXJldHJpZXZlOiBmdW5jdGlvbiAoc3ByaXRlKSB7CgkgCQoJCXZhciByZXR1cm5PYmplY3RzID0gdGhpcy5vYmplY3RzOwoKCQlzcHJpdGUuYm9keS5xdWFkVHJlZUluZGV4ID0gdGhpcy5nZXRJbmRleChzcHJpdGUuYm9keSk7CgoJCS8vCVRlbXAgc3RvcmUgZm9yIHRoZSBub2RlIElEcyB0aGlzIHNwcml0ZSBpcyBpbiwgd2UgY2FuIHVzZSB0aGlzIGZvciBmYXN0IGVsaW1pbmF0aW9uIGxhdGVyCgkJc3ByaXRlLmJvZHkucXVhZFRyZWVJRHMucHVzaCh0aGlzLklEKTsKCgkJaWYgKHRoaXMubm9kZXNbMF0pCgkJewoJCQkvLwlpZiByZWN0IGZpdHMgaW50byBhIHN1Ym5vZGUgLi4KCQkJaWYgKHNwcml0ZS5ib2R5LnF1YWRUcmVlSW5kZXggIT09IC0xKQoJCQl7CgkJCQlyZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1tzcHJpdGUuYm9keS5xdWFkVHJlZUluZGV4XS5yZXRyaWV2ZShzcHJpdGUpKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCS8vCWlmIHJlY3QgZG9lcyBub3QgZml0IGludG8gYSBzdWJub2RlLCBjaGVjayBpdCBhZ2FpbnN0IGFsbCBzdWJub2RlcyAodW5yb2xsZWQgZm9yIHNwZWVkKQoJCQkJcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbMF0ucmV0cmlldmUoc3ByaXRlKSk7CgkJCQlyZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1sxXS5yZXRyaWV2ZShzcHJpdGUpKTsKCQkJCXJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzWzJdLnJldHJpZXZlKHNwcml0ZSkpOwoJCQkJcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbM10ucmV0cmlldmUoc3ByaXRlKSk7CgkJCX0KCQl9CgkgCgkJcmV0dXJuIHJldHVybk9iamVjdHM7CgoJfSwKCgkvKgoJICogQ2xlYXIgdGhlIHF1YWR0cmVlLgoJICogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjY2xlYXIKCSAqLwoJY2xlYXI6IGZ1bmN0aW9uICgpIHsKCQkKCQl0aGlzLm9iamVjdHMgPSBbXTsKCSAKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5ub2Rlcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCS8vIGlmICh0eXBlb2YgdGhpcy5ub2Rlc1tpXSAhPT0gJ3VuZGVmaW5lZCcpCgkJCWlmICh0aGlzLm5vZGVzW2ldKQoJCQl7CgkJCQl0aGlzLm5vZGVzW2ldLmNsZWFyKCk7CgkJCQlkZWxldGUgdGhpcy5ub2Rlc1tpXTsKCQkgIAl9CgkJfQoJfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgQ2lyY2xlIG9iamVjdCB3aXRoIHRoZSBjZW50ZXIgY29vcmRpbmF0ZSBzcGVjaWZpZWQgYnkgdGhlIHggYW5kIHkgcGFyYW1ldGVycyBhbmQgdGhlIGRpYW1ldGVyIHNwZWNpZmllZCBieSB0aGUgZGlhbWV0ZXIgcGFyYW1ldGVyLiBJZiB5b3UgY2FsbCB0aGlzIGZ1bmN0aW9uIHdpdGhvdXQgcGFyYW1ldGVycywgYSBjaXJjbGUgd2l0aCB4LCB5LCBkaWFtZXRlciBhbmQgcmFkaXVzIHByb3BlcnRpZXMgc2V0IHRvIDAgaXMgY3JlYXRlZC4KKiBAY2xhc3MgQ2lyY2xlCiogQGNsYXNzZGVzYyBQaGFzZXIgLSBDaXJjbGUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge251bWJlcn0gW3hdIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgoqIEBwYXJhbSB7bnVtYmVyfSBbeV0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiogQHBhcmFtIHtudW1iZXJ9IFtkaWFtZXRlcl0gVGhlIGRpYW1ldGVyIG9mIHRoZSBjaXJjbGUuCiogQHJldHVybiB7UGhhc2VyLkNpcmNsZX0gVGhpcyBjaXJjbGUgb2JqZWN0CioqLwpQaGFzZXIuQ2lyY2xlID0gZnVuY3Rpb24gKHgsIHksIGRpYW1ldGVyKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICBkaWFtZXRlciA9IGRpYW1ldGVyIHx8IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqKi8KICAgIHRoaXMueCA9IHg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqKi8KICAgIHRoaXMueSA9IHk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZGlhbWV0ZXIgLSBUaGUgZGlhbWV0ZXIgb2YgdGhlIGNpcmNsZS4KICAgICogQHByaXZhdGUKICAgICoqLwogICAgdGhpcy5fZGlhbWV0ZXIgPSBkaWFtZXRlcjsKCiAgICBpZiAoZGlhbWV0ZXIgPiAwKQogICAgewogICAgCS8qKgogICAgCSogQHByb3BlcnR5IHtudW1iZXJ9IF9yYWRpdXMgLSBUaGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUuCiAgICAJKiBAcHJpdmF0ZQogICAgICAgICoqLwogICAgICAgIHRoaXMuX3JhZGl1cyA9IGRpYW1ldGVyICogMC41OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICB9Cgp9OwoKUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFRoZSBjaXJjdW1mZXJlbmNlIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjaXJjdW1mZXJlbmNlCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICoqLwogICAgY2lyY3VtZmVyZW5jZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAyICogKE1hdGguUEkgKiB0aGlzLl9yYWRpdXMpOwogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgbWVtYmVycyBvZiBDaXJjbGUgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNzZXRUbwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgY2lyY2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gZGlhbWV0ZXIgLSBUaGUgZGlhbWV0ZXIgb2YgdGhlIGNpcmNsZSBpbiBwaXhlbHMuCiAgICAqIEByZXR1cm4ge0NpcmNsZX0gVGhpcyBjaXJjbGUgb2JqZWN0LgogICAgKiovCiAgICBzZXRUbzogZnVuY3Rpb24gKHgsIHksIGRpYW1ldGVyKSB7CiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHRoaXMuX2RpYW1ldGVyID0gZGlhbWV0ZXI7CiAgICAgICAgdGhpcy5fcmFkaXVzID0gZGlhbWV0ZXIgKiAwLjU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgQ2lyY2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29weUZyb20KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSBmcm9tLgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICoqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnksIHNvdXJjZS5kaWFtZXRlcik7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMgZnJvbSB0aGlzIENpcmNsZSB0byBhbnkgZ2l2ZW4gb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29weVRvCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0IC0gVGhlIG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoaXMgZGVzdCBvYmplY3QuCiAgICAqKi8KICAgIGNvcHlUbzogZnVuY3Rpb24oZGVzdCkgewogICAgICAgIGRlc3RbeF0gPSB0aGlzLng7CiAgICAgICAgZGVzdFt5XSA9IHRoaXMueTsKICAgICAgICBkZXN0W2RpYW1ldGVyXSA9IHRoaXMuX2RpYW1ldGVyOwogICAgICAgIHJldHVybiBkZXN0OwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGlzdGFuY2UgZnJvbSB0aGUgY2VudGVyIG9mIHRoZSBDaXJjbGUgb2JqZWN0IHRvIHRoZSBnaXZlbiBvYmplY3QKICAgICogKGNhbiBiZSBDaXJjbGUsIFBvaW50IG9yIGFueXRoaW5nIHdpdGggeC95IHByb3BlcnRpZXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNkaXN0YW5jZQogICAgKiBAcGFyYW0ge29iamVjdH0gZGVzdCAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyb3VuZF0gLSBSb3VuZCB0aGUgZGlzdGFuY2UgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciAoZGVmYXVsdCBmYWxzZSkuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiAgICAqLwogICAgZGlzdGFuY2U6IGZ1bmN0aW9uIChkZXN0LCByb3VuZCkgewoKICAgICAgICBpZiAodHlwZW9mIHJvdW5kID09PSAidW5kZWZpbmVkIikgeyByb3VuZCA9IGZhbHNlIH0KCiAgICAgICAgaWYgKHJvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLmRpc3RhbmNlUm91bmQodGhpcy54LCB0aGlzLnksIGRlc3QueCwgZGVzdC55KTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLmRpc3RhbmNlKHRoaXMueCwgdGhpcy55LCBkZXN0LngsIGRlc3QueSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBuZXcgQ2lyY2xlIG9iamVjdCB3aXRoIHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgYXMgdGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY2xvbmUKICAgICogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBvdXQgLSBPcHRpb25hbCBDaXJjbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IENpcmNsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICogQHJldHVybiB7UGhhc2VyLkNpcmNsZX0gVGhlIGNsb25lZCBDaXJjbGUgb2JqZWN0LgogICAgKi8KICAgIGNsb25lOiBmdW5jdGlvbihvdXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuQ2lyY2xlKCk7IH0KCiAgICAgICAgcmV0dXJuIG91dC5zZXRUbyhhLngsIGEueSwgYS5kaWFtZXRlcik7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIHRydWUgaWYgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcyBhcmUgd2l0aGluIHRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NvbnRhaW5zCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggdmFsdWUgb2YgdGhlIGNvb3JkaW5hdGUgdG8gdGVzdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSB2YWx1ZSBvZiB0aGUgY29vcmRpbmF0ZSB0byB0ZXN0LgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBjb29yZGluYXRlcyBhcmUgd2l0aGluIHRoaXMgY2lyY2xlLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29udGFpbnM6IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5DaXJjbGUuY29udGFpbnModGhpcywgeCwgeSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgUG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvb3JkaW5hdGVzIG9mIGEgcG9pbnQgb24gdGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIENpcmNsZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gYW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjaXJjdW1mZXJlbmNlUG9pbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcmV0dXJuIHRoZSBwb2ludCBmcm9tLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiBhbmdsZSBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIEFuIG9wdGlvbmFsIFBvaW50IG9iamVjdCB0byBwdXQgdGhlIHJlc3VsdCBpbiB0by4gSWYgbm9uZSBzcGVjaWZpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgUG9pbnQgb2JqZWN0IGhvbGRpbmcgdGhlIHJlc3VsdC4KICAgICovCiAgICBjaXJjdW1mZXJlbmNlUG9pbnQ6IGZ1bmN0aW9uIChhbmdsZSwgYXNEZWdyZWVzLCBvdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLkNpcmNsZS5jaXJjdW1mZXJlbmNlUG9pbnQodGhpcywgYW5nbGUsIGFzRGVncmVlcywgb3V0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIEFkanVzdHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBDaXJjbGUgb2JqZWN0LCBhcyBkZXRlcm1pbmVkIGJ5IGl0cyBjZW50ZXIgY29vcmRpbmF0ZSwgYnkgdGhlIHNwZWNpZmllZCBhbW91bnRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjb2Zmc2V0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeCAtIE1vdmVzIHRoZSB4IHZhbHVlIG9mIHRoZSBDaXJjbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcGFyYW0ge251bWJlcn0gZHkgLSBNb3ZlcyB0aGUgeSB2YWx1ZSBvZiB0aGUgQ2lyY2xlIG9iamVjdCBieSB0aGlzIGFtb3VudC4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIENpcmNsZSBvYmplY3QuCiAgICAqKi8KICAgIG9mZnNldDogZnVuY3Rpb24gKGR4LCBkeSkgewogICAgICAgIHRoaXMueCArPSBkeDsKICAgICAgICB0aGlzLnkgKz0gZHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgQ2lyY2xlIG9iamVjdCB1c2luZyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgQ2lyY2xlLm9mZnNldCgpIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNvZmZzZXRQb2ludAogICAgKiBAcGFyYW0ge1BvaW50fSBwb2ludCBBIFBvaW50IG9iamVjdCB0byB1c2UgdG8gb2Zmc2V0IHRoaXMgQ2lyY2xlIG9iamVjdCAob3IgYW55IHZhbGlkIG9iamVjdCB3aXRoIGV4cG9zZWQgeCBhbmQgeSBwcm9wZXJ0aWVzKS4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIENpcmNsZSBvYmplY3QuCiAgICAqKi8KICAgIG9mZnNldFBvaW50OiBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQocG9pbnQueCwgcG9pbnQueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCiAgICAqKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICJbe1BoYXNlci5DaXJjbGUgKHg9IiArIHRoaXMueCArICIgeT0iICsgdGhpcy55ICsgIiBkaWFtZXRlcj0iICsgdGhpcy5kaWFtZXRlciArICIgcmFkaXVzPSIgKyB0aGlzLnJhZGl1cyArICIpfV0iOwogICAgfQoKfTsKCi8qKgoqIFRoZSBsYXJnZXN0IGRpc3RhbmNlIGJldHdlZW4gYW55IHR3byBwb2ludHMgb24gdGhlIGNpcmNsZS4gVGhlIHNhbWUgYXMgdGhlIHJhZGl1cyAqIDIuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNkaWFtZXRlcgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkaWFtZXRlciAtIEdldHMgb3Igc2V0cyB0aGUgZGlhbWV0ZXIgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiZGlhbWV0ZXIiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2RpYW1ldGVyOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gdmFsdWUgKiAwLjU7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgbGVuZ3RoIG9mIGEgbGluZSBleHRlbmRpbmcgZnJvbSB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUgdG8gYW55IHBvaW50IG9uIHRoZSBjaXJjbGUgaXRzZWxmLiBUaGUgc2FtZSBhcyBoYWxmIHRoZSBkaWFtZXRlci4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI3JhZGl1cwoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByYWRpdXMgLSBHZXRzIG9yIHNldHMgdGhlIHJhZGl1cyBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJyYWRpdXMiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9yYWRpdXM7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSB2YWx1ZSAqIDI7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBsZWZ0bW9zdCBwb2ludCBvZiB0aGUgY2lyY2xlLiBDaGFuZ2luZyB0aGUgbGVmdCBwcm9wZXJ0eSBvZiBhIENpcmNsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzLiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSBkaWFtZXRlciwgd2hlcmVhcyBjaGFuZ2luZyB0aGUgeCB2YWx1ZSBkb2VzIG5vdCBhZmZlY3QgdGhlIGRpYW1ldGVyIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjbGVmdAoqIEBwcm9wZXR5IHtudW1iZXJ9IGxlZnQgLSBHZXRzIG9yIHNldHMgdGhlIHZhbHVlIG9mIHRoZSBsZWZ0bW9zdCBwb2ludCBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJsZWZ0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54IC0gdGhpcy5fcmFkaXVzOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IHRoaXMueCkgewogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSAwOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSB0aGlzLnggLSB2YWx1ZTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHJpZ2h0bW9zdCBwb2ludCBvZiB0aGUgY2lyY2xlLiBDaGFuZ2luZyB0aGUgcmlnaHQgcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcy4gSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgZGlhbWV0ZXIsIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHggdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSBkaWFtZXRlciBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI3JpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gR2V0cyBvciBzZXRzIHRoZSB2YWx1ZSBvZiB0aGUgcmlnaHRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgInJpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLl9yYWRpdXM7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIDwgdGhpcy54KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHZhbHVlIC0gdGhpcy54OwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHN1bSBvZiB0aGUgeSBtaW51cyB0aGUgcmFkaXVzIHByb3BlcnR5LiBDaGFuZ2luZyB0aGUgdG9wIHByb3BlcnR5IG9mIGEgQ2lyY2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMsIGJ1dCBkb2VzIGNoYW5nZSB0aGUgZGlhbWV0ZXIuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSN0b3AKKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gR2V0cyBvciBzZXRzIHRoZSB0b3Agb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAidG9wIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgLSB0aGlzLl9yYWRpdXM7CiAgICB9LAogICAgCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+IHRoaXMueSkgewogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSAwOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSB0aGlzLnkgLSB2YWx1ZTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHkgYW5kIHJhZGl1cyBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgYm90dG9tIHByb3BlcnR5IG9mIGEgQ2lyY2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMsIGJ1dCBkb2VzIGNoYW5nZSB0aGUgZGlhbWV0ZXIuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNib3R0b20KKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gR2V0cyBvciBzZXRzIHRoZSBib3R0b20gb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiYm90dG9tIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgKyB0aGlzLl9yYWRpdXM7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSA8IHRoaXMueSkgewogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSAwOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5yYWRpdXMgPSB2YWx1ZSAtIHRoaXMueTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBhcmVhIG9mIHRoaXMgQ2lyY2xlLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjYXJlYQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhcmVhIC0gVGhlIGFyZWEgb2YgdGhpcyBjaXJjbGUuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImFyZWEiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuX3JhZGl1cyA+IDApIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGguUEkgKiB0aGlzLl9yYWRpdXMgKiB0aGlzLl9yYWRpdXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgb3Igbm90IHRoaXMgQ2lyY2xlIG9iamVjdCBpcyBlbXB0eS4gV2lsbCByZXR1cm4gYSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBDaXJjbGUgb2JqZWN0cyBkaWFtZXRlciBpcyBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gMDsgb3RoZXJ3aXNlIGZhbHNlLgoqIElmIHNldCB0byB0cnVlIGl0IHdpbGwgcmVzZXQgYWxsIG9mIHRoZSBDaXJjbGUgb2JqZWN0cyBwcm9wZXJ0aWVzIHRvIDAuIEEgQ2lyY2xlIG9iamVjdCBpcyBlbXB0eSBpZiBpdHMgZGlhbWV0ZXIgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDAuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNlbXB0eQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1wdHkgLSBHZXRzIG9yIHNldHMgdGhlIGVtcHR5IHN0YXRlIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImVtcHR5IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy5fZGlhbWV0ZXIgPT0gMCk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXRUbygwLCAwLCAwKTsKICAgIH0KCn0pOwoKLyoqCiogUmV0dXJuIHRydWUgaWYgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcyBhcmUgd2l0aGluIHRoZSBDaXJjbGUgb2JqZWN0LgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5jb250YWlucwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBDaXJjbGUgdG8gYmUgY2hlY2tlZC4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSB2YWx1ZSBvZiB0aGUgY29vcmRpbmF0ZSB0byB0ZXN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBjaXJjbGUsIG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5jb250YWlucyA9IGZ1bmN0aW9uIChhLCB4LCB5KSB7CgogICAgLy8gIENoZWNrIGlmIHgveSBhcmUgd2l0aGluIHRoZSBib3VuZHMgZmlyc3QKICAgIGlmICh4ID49IGEubGVmdCAmJiB4IDw9IGEucmlnaHQgJiYgeSA+PSBhLnRvcCAmJiB5IDw9IGEuYm90dG9tKSB7CgogICAgICAgIHZhciBkeCA9IChhLnggLSB4KSAqIChhLnggLSB4KTsKICAgICAgICB2YXIgZHkgPSAoYS55IC0geSkgKiAoYS55IC0geSk7CgogICAgICAgIHJldHVybiAoZHggKyBkeSkgPD0gKGEucmFkaXVzICogYS5yYWRpdXMpOwoKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgbWF0Y2guIFRoaXMgbWV0aG9kIGNvbXBhcmVzIHRoZSB4LCB5IGFuZCBkaWFtZXRlciBwcm9wZXJ0aWVzLgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5lcXVhbHMKKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGEgLSBUaGUgZmlyc3QgQ2lyY2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGIgLSBUaGUgc2Vjb25kIENpcmNsZSBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBvYmplY3QgaGFzIGV4YWN0bHkgdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSBhbmQgZGlhbWV0ZXIgcHJvcGVydGllcyBhcyB0aGlzIENpcmNsZSBvYmplY3Q7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5lcXVhbHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChhLnggPT0gYi54ICYmIGEueSA9PSBiLnkgJiYgYS5kaWFtZXRlciA9PSBiLmRpYW1ldGVyKTsKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIENpcmNsZSBvYmplY3RzIGludGVyc2VjdC4KKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIHJhZGl1cyBkaXN0YW5jZXMgYmV0d2VlbiB0aGUgdHdvIENpcmNsZSBvYmplY3RzIHRvIHNlZSBpZiB0aGV5IGludGVyc2VjdC4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuaW50ZXJzZWN0cwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYiAtIFRoZSBzZWNvbmQgQ2lyY2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoaXMgQ2lyY2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmludGVyc2VjdHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChQaGFzZXIuTWF0aC5kaXN0YW5jZShhLngsIGEueSwgYi54LCBiLnkpIDw9IChhLnJhZGl1cyArIGIucmFkaXVzKSk7Cn07CgovKioKKiBSZXR1cm5zIGEgUG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGNvb3JkaW5hdGVzIG9mIGEgcG9pbnQgb24gdGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIENpcmNsZSBiYXNlZCBvbiB0aGUgZ2l2ZW4gYW5nbGUuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmNpcmN1bWZlcmVuY2VQb2ludAoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zICh1bmxlc3MgYXNEZWdyZWVzIGlzIHRydWUpIHRvIHJldHVybiB0aGUgcG9pbnQgZnJvbS4KKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiBhbmdsZSBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gQW4gb3B0aW9uYWwgUG9pbnQgb2JqZWN0IHRvIHB1dCB0aGUgcmVzdWx0IGluIHRvLiBJZiBub25lIHNwZWNpZmllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIFBvaW50IG9iamVjdCBob2xkaW5nIHRoZSByZXN1bHQuCiovClBoYXNlci5DaXJjbGUuY2lyY3VtZmVyZW5jZVBvaW50ID0gZnVuY3Rpb24gKGEsIGFuZ2xlLCBhc0RlZ3JlZXMsIG91dCkgewoKICAgIGlmICh0eXBlb2YgYXNEZWdyZWVzID09PSAidW5kZWZpbmVkIikgeyBhc0RlZ3JlZXMgPSBmYWxzZTsgfQogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIGlmIChhc0RlZ3JlZXMgPT09IHRydWUpIHsKICAgICAgICBhbmdsZSA9IFBoYXNlci5NYXRoLnJhZFRvRGVnKGFuZ2xlKTsKICAgIH0KCiAgICBvdXQueCA9IGEueCArIGEucmFkaXVzICogTWF0aC5jb3MoYW5nbGUpOwogICAgb3V0LnkgPSBhLnkgKyBhLnJhZGl1cyAqIE1hdGguc2luKGFuZ2xlKTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIENoZWNrcyBpZiB0aGUgZ2l2ZW4gQ2lyY2xlIGFuZCBSZWN0YW5nbGUgb2JqZWN0cyBpbnRlcnNlY3QuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmludGVyc2VjdHNSZWN0YW5nbGUKKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGMgLSBUaGUgQ2lyY2xlIG9iamVjdCB0byB0ZXN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gciAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0IHRvIHRlc3QuCiogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgdHdvIG9iamVjdHMgaW50ZXJzZWN0LCBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5DaXJjbGUuaW50ZXJzZWN0c1JlY3RhbmdsZSA9IGZ1bmN0aW9uIChjLCByKSB7CgogICAgdmFyIGN4ID0gTWF0aC5hYnMoYy54IC0gci54IC0gci5oYWxmV2lkdGgpOwogICAgdmFyIHhEaXN0ID0gci5oYWxmV2lkdGggKyBjLnJhZGl1czsKCiAgICBpZiAoY3ggPiB4RGlzdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICB2YXIgY3kgPSBNYXRoLmFicyhjLnkgLSByLnkgLSByLmhhbGZIZWlnaHQpOwogICAgdmFyIHlEaXN0ID0gci5oYWxmSGVpZ2h0ICsgYy5yYWRpdXM7CgogICAgaWYgKGN5ID4geURpc3QpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgaWYgKGN4IDw9IHIuaGFsZldpZHRoIHx8IGN5IDw9IHIuaGFsZkhlaWdodCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIHZhciB4Q29ybmVyRGlzdCA9IGN4IC0gci5oYWxmV2lkdGg7CiAgICB2YXIgeUNvcm5lckRpc3QgPSBjeSAtIHIuaGFsZkhlaWdodDsKICAgIHZhciB4Q29ybmVyRGlzdFNxID0geENvcm5lckRpc3QgKiB4Q29ybmVyRGlzdDsKICAgIHZhciB5Q29ybmVyRGlzdFNxID0geUNvcm5lckRpc3QgKiB5Q29ybmVyRGlzdDsKICAgIHZhciBtYXhDb3JuZXJEaXN0U3EgPSBjLnJhZGl1cyAqIGMucmFkaXVzOwoKICAgIHJldHVybiB4Q29ybmVyRGlzdFNxICsgeUNvcm5lckRpc3RTcSA8PSBtYXhDb3JuZXJEaXN0U3E7Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBQb2ludC4gSWYgeW91IHBhc3Mgbm8gcGFyYW1ldGVycyBhIFBvaW50IGlzIGNyZWF0ZWQgc2V0IHRvICgwLDApLgoqIEBjbGFzcyBQaGFzZXIuUG9pbnQKKiBAY2xhc3NkZXNjIFRoZSBQb2ludCBvYmplY3QgcmVwcmVzZW50cyBhIGxvY2F0aW9uIGluIGEgdHdvLWRpbWVuc2lvbmFsIGNvb3JkaW5hdGUgc3lzdGVtLCB3aGVyZSB4IHJlcHJlc2VudHMgdGhlIGhvcml6b250YWwgYXhpcyBhbmQgeSByZXByZXNlbnRzIHRoZSB2ZXJ0aWNhbCBheGlzLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSB4IFRoZSBob3Jpem9udGFsIHBvc2l0aW9uIG9mIHRoaXMgUG9pbnQgKGRlZmF1bHQgMCkKKiBAcGFyYW0ge251bWJlcn0geSBUaGUgdmVydGljYWwgcG9zaXRpb24gb2YgdGhpcyBQb2ludCAoZGVmYXVsdCAwKQoqKi8KUGhhc2VyLlBvaW50ID0gZnVuY3Rpb24gKHgsIHkpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQuCiAgICAgKiovCiAgICB0aGlzLnggPSB4OwogICAgCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQuCiAgICAgKiovCiAgICB0aGlzLnkgPSB5OwoKfTsKClBoYXNlci5Qb2ludC5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIGZyb20gYW55IGdpdmVuIG9iamVjdCB0byB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjb3B5RnJvbQogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIG9iamVjdCB0byBjb3B5IGZyb20uCiAgICAqIEByZXR1cm4ge1BvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICoqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnkpOwogICAgfSwKCiAgICAvKioKICAgICogSW52ZXJ0cyB0aGUgeCBhbmQgeSB2YWx1ZXMgb2YgdGhpcyBQb2ludAogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNpbnZlcnQKICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKiovCiAgICBpbnZlcnQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyh0aGlzLnksIHRoaXMueCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB4IGFuZCB5IHZhbHVlcyBvZiB0aGlzIFBvaW50IG9iamVjdCB0byB0aGUgZ2l2ZW4gY29vcmRpbmF0ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIGhvcml6b250YWwgcG9zaXRpb24gb2YgdGhpcyBwb2ludC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgdmVydGljYWwgcG9zaXRpb24gb2YgdGhpcyBwb2ludC4KICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICoqLyAgICAgICAgCiAgICBzZXRUbzogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMgdG8gdGhpcyBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjYWRkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIGFkZCB0byBQb2ludC54LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBhZGQgdG8gUG9pbnQueS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqKi8gICAgICAgIAogICAgYWRkOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggKz0geDsKICAgICAgICB0aGlzLnkgKz0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdWJ0cmFjdHMgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzIGZyb20gdGhpcyBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjc3VidHJhY3QKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gc3VidHJhY3QgZnJvbSBQb2ludC54LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBzdWJ0cmFjdCBmcm9tIFBvaW50LnkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKiovICAgICAgICAKICAgIHN1YnRyYWN0OiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggLT0geDsKICAgICAgICB0aGlzLnkgLT0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNdWx0aXBsaWVzIFBvaW50LnggYW5kIFBvaW50LnkgYnkgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNtdWx0aXBseQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBtdWx0aXBseSBQb2ludC54IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBtdWx0aXBseSBQb2ludC54IGJ5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICoqLyAgICAgICAgCiAgICBtdWx0aXBseTogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy54ICo9IHg7CiAgICAgICAgdGhpcy55ICo9IHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICogRGl2aWRlcyBQb2ludC54IGFuZCBQb2ludC55IGJ5IHRoZSBnaXZlbiB4IGFuZCB5IHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZGl2aWRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIGRpdmlkZSBQb2ludC54IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2YWx1ZSB0byBkaXZpZGUgUG9pbnQueCBieS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqKi8gICAgICAgIAogICAgZGl2aWRlOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggLz0geDsKICAgICAgICB0aGlzLnkgLz0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGFtcHMgdGhlIHggdmFsdWUgb2YgdGhpcyBQb2ludCB0byBiZSBiZXR3ZWVuIHRoZSBnaXZlbiBtaW4gYW5kIG1heC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xhbXBYCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcFg6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnggPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLngsIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGUgeSB2YWx1ZSBvZiB0aGlzIFBvaW50IHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4CiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NsYW1wWQogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xhbXBZOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCiAgICAgICAgdGhpcy55ID0gUGhhc2VyLk1hdGguY2xhbXAodGhpcy55LCBtaW4sIG1heCk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGFtcHMgdGhpcyBQb2ludCBvYmplY3QgdmFsdWVzIHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjbGFtcAogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xhbXA6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnggPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLngsIG1pbiwgbWF4KTsKICAgICAgICB0aGlzLnkgPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLnksIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgY29weSBvZiB0aGUgZ2l2ZW4gUG9pbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2Nsb25lCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0cHV0XSBPcHRpb25hbCBQb2ludCBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGNsb25lOiBmdW5jdGlvbiAob3V0cHV0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBuZXcgUGhhc2VyLlBvaW50OyB9CgogICAgICAgIHJldHVybiBvdXRwdXQuc2V0VG8odGhpcy54LCB0aGlzLnkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIGZyb20gYW55IGdpdmVuIG9iamVjdCB0byB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjb3B5RnJvbQogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIG9iamVjdCB0byBjb3B5IGZyb20uCiAgICAqIEByZXR1cm4ge1BvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICoqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnkpOwogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgZnJvbSB0aGlzIFBvaW50IHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NvcHlUbwogICAgKiBAcGFyYW0ge2FueX0gZGVzdCAtIFRoZSBvYmplY3QgdG8gY29weSB0by4KICAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgZGVzdCBvYmplY3QuCiAgICAqKi8KICAgIGNvcHlUbzogZnVuY3Rpb24oZGVzdCkgewoKICAgICAgICBkZXN0W3hdID0gdGhpcy54OwogICAgICAgIGRlc3RbeV0gPSB0aGlzLnk7CgogICAgICAgIHJldHVybiBkZXN0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRpc3RhbmNlIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBvYmplY3QgKGNhbiBiZSBhIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZGlzdGFuY2UKICAgICogQHBhcmFtIHtvYmplY3R9IGRlc3QgLSBUaGUgdGFyZ2V0IG9iamVjdC4gTXVzdCBoYXZlIHZpc2libGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHRoYXQgcmVwcmVzZW50IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdC4KICAgICogQHBhcmFtIHtib29sZWFufSBbcm91bmRdIC0gUm91bmQgdGhlIGRpc3RhbmNlIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgKGRlZmF1bHQgZmFsc2UpLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGRpc3RhbmNlOiBmdW5jdGlvbiAoZGVzdCwgcm91bmQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlBvaW50LmRpc3RhbmNlKHRoaXMsIGRlc3QsIHJvdW5kKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZ2l2ZW4gb2JqZWN0cyB4L3kgdmFsdWVzIGFyZSBlcXVhbCB0byB0aGlzIFBvaW50IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZXF1YWxzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IG9iamVjdCB0byBjb21wYXJlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFBvaW50cyBhcmUgZXF1YWwsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBlcXVhbHM6IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgcmV0dXJuIChhLnggPT0gdGhpcy54ICYmIGEueSA9PSB0aGlzLnkpOwogICAgfSwKCiAgICAvKioKICAgICogUm90YXRlcyB0aGlzIFBvaW50IGFyb3VuZCB0aGUgeC95IGNvb3JkaW5hdGVzIGdpdmVuIHRvIHRoZSBkZXNpcmVkIGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNyb3RhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKICAgICogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcm90YXRlIHRoZSBQb2ludCB0by4KICAgICogQHBhcmFtIHtib29sZWFufSBhc0RlZ3JlZXMgLSBJcyB0aGUgZ2l2ZW4gcm90YXRpb24gaW4gcmFkaWFucyAoZmFsc2UpIG9yIGRlZ3JlZXMgKHRydWUpPwogICAgKiBAcGFyYW0ge251bWJlcn0gW2Rpc3RhbmNlXSAtIEFuIG9wdGlvbmFsIGRpc3RhbmNlIGNvbnN0cmFpbnQgYmV0d2VlbiB0aGUgUG9pbnQgYW5kIHRoZSBhbmNob3IuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG1vZGlmaWVkIHBvaW50IG9iamVjdC4KICAgICovCiAgICByb3RhdGU6IGZ1bmN0aW9uICh4LCB5LCBhbmdsZSwgYXNEZWdyZWVzLCBkaXN0YW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUG9pbnQucm90YXRlKHRoaXMsIHgsIHksIGFuZ2xlLCBhc0RlZ3JlZXMsIGRpc3RhbmNlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBDYWxjdWxhdGVzIHRoZSBsZW5ndGggb2YgdGhlIHZlY3RvcgogICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZ2V0TWFnbml0dWRlCiAgICAgKiBAcmV0dXJuIHtudW1iZXJ9IHRoZSBsZW5ndGggb2YgdGhlIHZlY3RvcgogICAgICovCiAgICBnZXRNYWduaXR1ZGU6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBNYXRoLnNxcnQoKHRoaXMueCAqIHRoaXMueCkgKyAodGhpcy55ICogdGhpcy55KSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQWx0ZXJzIHRoZSBsZW5ndGggb2YgdGhlIHZlY3RvciB3aXRob3V0IGNoYW5naW5nIHRoZSBkaXJlY3Rpb24KICAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2dldE1hZ25pdHVkZQogICAgICogQHBhcmFtIHtudW1iZXJ9IG1hZ25pdHVkZSB0aGUgZGVzaXJlZCBtYWduaXR1ZGUgb2YgdGhlIHJlc3VsdGluZyB2ZWN0b3IKICAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gdGhlIG1vZGlmaWVkIG9yaWdpbmFsIHZlY3RvcgogICAgICovCiAgICBzZXRNYWduaXR1ZGU6IGZ1bmN0aW9uKG1hZ25pdHVkZSkgewogICAgICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZSgpLm11bHRpcGx5KG1hZ25pdHVkZSwgbWFnbml0dWRlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBbHRlcnMgdGhlIHZlY3RvciBzbyB0aGF0IGl0cyBsZW5ndGggaXMgMSwgYnV0IGl0IHJldGFpbnMgdGhlIHNhbWUgZGlyZWN0aW9uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNub3JtYWxpemUKICAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gdGhlIG1vZGlmaWVkIG9yaWdpbmFsIHZlY3RvcgogICAgICovCiAgICBub3JtYWxpemU6IGZ1bmN0aW9uKCkgewoKICAgICAgICBpZighdGhpcy5pc1plcm8oKSkgewogICAgICAgICAgICB2YXIgbSA9IHRoaXMuZ2V0TWFnbml0dWRlKCk7CiAgICAgICAgICAgIHRoaXMueCAvPSBtOwogICAgICAgICAgICB0aGlzLnkgLz0gbTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmUgaWYgdGhpcyBwb2ludCBpcyBhdCAwLDAKICAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2lzWmVybwogICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGlzIFBvaW50IGlzIDAsMCwgb3RoZXJ3aXNlIGZhbHNlCiAgICAgKi8KICAgIGlzWmVybzogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLnggPT09IDAgJiYgdGhpcy55ID09PSAwKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLgogICAgKiovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnW3tQb2ludCAoeD0nICsgdGhpcy54ICsgJyB5PScgKyB0aGlzLnkgKyAnKX1dJzsKICAgIH0KCn07CgovKioKKiBBZGRzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvZ2V0aGVyIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5hZGQKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBPcHRpb25hbCBQb2ludCB0byBzdG9yZSB0aGUgdmFsdWUgaW4sIGlmIG5vdCBzdXBwbGllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5hZGQgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54ICsgYi54OwogICAgb3V0LnkgPSBhLnkgKyBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBTdWJ0cmFjdHMgdGhlIGNvb3JkaW5hdGVzIG9mIHR3byBwb2ludHMgdG8gY3JlYXRlIGEgbmV3IHBvaW50LgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LnN1YnRyYWN0CiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuc3VidHJhY3QgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54IC0gYi54OwogICAgb3V0LnkgPSBhLnkgLSBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBNdWx0aXBsaWVzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5tdWx0aXBseQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIE9wdGlvbmFsIFBvaW50IHRvIHN0b3JlIHRoZSB2YWx1ZSBpbiwgaWYgbm90IHN1cHBsaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbmV3IFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50Lm11bHRpcGx5ID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCAqIGIueDsKICAgIG91dC55ID0gYS55ICogYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGl2aWRlcyB0aGUgY29vcmRpbmF0ZXMgb2YgdHdvIHBvaW50cyB0byBjcmVhdGUgYSBuZXcgcG9pbnQuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuZGl2aWRlCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQuZGl2aWRlID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7IH0KCiAgICBvdXQueCA9IGEueCAvIGIueDsKICAgIG91dC55ID0gYS55IC8gYi55OwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gZ2l2ZW4gUG9pbnQgb2JqZWN0cyBhcmUgZXF1YWwuIFRoZXkgYXJlIGNvbnNpZGVyZWQgZXF1YWwgaWYgdGhleSBoYXZlIHRoZSBzYW1lIHggYW5kIHkgdmFsdWVzLgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUG9pbnRzIGFyZSBlcXVhbCwgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUG9pbnQuZXF1YWxzID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiAoYS54ID09IGIueCAmJiBhLnkgPT0gYi55KTsKfTsKCi8qKgoqIFJldHVybnMgdGhlIGRpc3RhbmNlIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBvYmplY3QgKGNhbiBiZSBhIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuZGlzdGFuY2UKKiBAcGFyYW0ge29iamVjdH0gYSAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgoqIEBwYXJhbSB7b2JqZWN0fSBiIC0gVGhlIHRhcmdldCBvYmplY3QuIE11c3QgaGF2ZSB2aXNpYmxlIHggYW5kIHkgcHJvcGVydGllcyB0aGF0IHJlcHJlc2VudCB0aGUgY2VudGVyIG9mIHRoZSBvYmplY3QuCiogQHBhcmFtIHtib29sZWFufSBbcm91bmRdIC0gUm91bmQgdGhlIGRpc3RhbmNlIHRvIHRoZSBuZWFyZXN0IGludGVnZXIgKGRlZmF1bHQgZmFsc2UpLgoqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5kaXN0YW5jZSA9IGZ1bmN0aW9uIChhLCBiLCByb3VuZCkgewoKICAgIGlmICh0eXBlb2Ygcm91bmQgPT09ICJ1bmRlZmluZWQiKSB7IHJvdW5kID0gZmFsc2UgfQoKICAgIGlmIChyb3VuZCkKICAgIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2VSb3VuZChhLngsIGEueSwgYi54LCBiLnkpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5kaXN0YW5jZShhLngsIGEueSwgYi54LCBiLnkpOwogICAgfQoKfSwKCi8qKgoqIFJvdGF0ZXMgYSBQb2ludCBhcm91bmQgdGhlIHgveSBjb29yZGluYXRlcyBnaXZlbiB0byB0aGUgZGVzaXJlZCBhbmdsZS4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5yb3RhdGUKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBQb2ludCBvYmplY3QgdG8gcm90YXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgYW5jaG9yIHBvaW50CiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByb3RhdGUgdGhlIFBvaW50IHRvLgoqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIHJvdGF0aW9uIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KKiBAcGFyYW0ge251bWJlcn0gZGlzdGFuY2UgLSBBbiBvcHRpb25hbCBkaXN0YW5jZSBjb25zdHJhaW50IGJldHdlZW4gdGhlIFBvaW50IGFuZCB0aGUgYW5jaG9yLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG1vZGlmaWVkIHBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LnJvdGF0ZSA9IGZ1bmN0aW9uIChhLCB4LCB5LCBhbmdsZSwgYXNEZWdyZWVzLCBkaXN0YW5jZSkgewoKICAgIGFzRGVncmVlcyA9IGFzRGVncmVlcyB8fCBmYWxzZTsKICAgIGRpc3RhbmNlID0gZGlzdGFuY2UgfHwgbnVsbDsKCiAgICBpZiAoYXNEZWdyZWVzKQogICAgewogICAgICAgIGFuZ2xlID0gUGhhc2VyLk1hdGguZGVnVG9SYWQoYW5nbGUpOwogICAgfQoKICAgIC8vICBHZXQgZGlzdGFuY2UgZnJvbSBvcmlnaW4gKGN4L2N5KSB0byB0aGlzIHBvaW50CiAgICBpZiAoZGlzdGFuY2UgPT09IG51bGwpCiAgICB7CiAgICAgICAgZGlzdGFuY2UgPSBNYXRoLnNxcnQoKCh4IC0gYS54KSAqICh4IC0gYS54KSkgKyAoKHkgLSBhLnkpICogKHkgLSBhLnkpKSk7CiAgICB9CgogICAgcmV0dXJuIGEuc2V0VG8oeCArIGRpc3RhbmNlICogTWF0aC5jb3MoYW5nbGUpLCB5ICsgZGlzdGFuY2UgKiBNYXRoLnNpbihhbmdsZSkpOwoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZXMgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIHRoZSB0b3AtbGVmdCBjb3JuZXIgc3BlY2lmaWVkIGJ5IHRoZSB4IGFuZCB5IHBhcmFtZXRlcnMgYW5kIHdpdGggdGhlIHNwZWNpZmllZCB3aWR0aCBhbmQgaGVpZ2h0IHBhcmFtZXRlcnMuIElmIHlvdSBjYWxsIHRoaXMgZnVuY3Rpb24gd2l0aG91dCBwYXJhbWV0ZXJzLCBhIFJlY3RhbmdsZSB3aXRoIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgc2V0IHRvIDAgaXMgY3JlYXRlZC4KKgoqIEBjbGFzcyBQaGFzZXIuUmVjdGFuZ2xlCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlIGluIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgUmVjdGFuZ2xlIGluIHBpeGVscy4KKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KKiovClBoYXNlci5SZWN0YW5nbGUgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAgd2lkdGggPSB3aWR0aCB8fCAwOwogICAgaGVpZ2h0ID0gaGVpZ2h0IHx8IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy55ID0geTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCn07CgpQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QsIGFzIGRldGVybWluZWQgYnkgaXRzIHRvcC1sZWZ0IGNvcm5lciwgYnkgdGhlIHNwZWNpZmllZCBhbW91bnRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjb2Zmc2V0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeCAtIE1vdmVzIHRoZSB4IHZhbHVlIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcGFyYW0ge251bWJlcn0gZHkgLSBNb3ZlcyB0aGUgeSB2YWx1ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBieSB0aGlzIGFtb3VudC4KICAgICogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqKi8KICAgIG9mZnNldDogZnVuY3Rpb24gKGR4LCBkeSkgewoKICAgICAgICB0aGlzLnggKz0gZHg7CiAgICAgICAgdGhpcy55ICs9IGR5OwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAogCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgdXNpbmcgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIFJlY3RhbmdsZS5vZmZzZXQoKSBtZXRob2QsIGV4Y2VwdCB0aGF0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjb2Zmc2V0UG9pbnQKICAgICogQHBhcmFtIHtQb2ludH0gcG9pbnQgLSBBIFBvaW50IG9iamVjdCB0byB1c2UgdG8gb2Zmc2V0IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqKi8KICAgIG9mZnNldFBvaW50OiBmdW5jdGlvbiAocG9pbnQpIHsKICAgICAgICByZXR1cm4gdGhpcy5vZmZzZXQocG9pbnQueCwgcG9pbnQueSk7CiAgICB9LAogCiAgICAvKioKICAgICogU2V0cyB0aGUgbWVtYmVycyBvZiBSZWN0YW5nbGUgdG8gdGhlIHNwZWNpZmllZCB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNzZXRUbwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZSBpbiBwaXhlbHMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBSZWN0YW5nbGUgaW4gcGl4ZWxzLgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdAogICAgKiovCiAgICBzZXRUbzogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdGhpcy54ID0geDsKICAgICAgICB0aGlzLnkgPSB5OwogICAgICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgICAgICB0aGlzLmhlaWdodCA9IGhlaWdodDsKCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKIAogICAgLyoqCiAgICAqIFJ1bnMgTWF0aC5mbG9vcigpIG9uIGJvdGggdGhlIHggYW5kIHkgdmFsdWVzIG9mIHRoaXMgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjZmxvb3IKICAgICoqLwogICAgZmxvb3I6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpOwogICAgICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKCiAgICB9LAogCiAgICAvKioKICAgICogUnVucyBNYXRoLmZsb29yKCkgb24gdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgdmFsdWVzIG9mIHRoaXMgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjZmxvb3JBbGwKICAgICoqLwogICAgZmxvb3JBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy54ID0gTWF0aC5mbG9vcih0aGlzLngpOwogICAgICAgIHRoaXMueSA9IE1hdGguZmxvb3IodGhpcy55KTsKICAgICAgICB0aGlzLndpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoKTsKICAgICAgICB0aGlzLmhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5oZWlnaHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGZyb20gYW55IGdpdmVuIG9iamVjdCB0byB0aGlzIFJlY3RhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7UmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqKi8KICAgIGNvcHlGcm9tOiBmdW5jdGlvbiAoc291cmNlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2V0VG8oc291cmNlLngsIHNvdXJjZS55LCBzb3VyY2Uud2lkdGgsIHNvdXJjZS5oZWlnaHQpOwogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgZnJvbSB0aGlzIFJlY3RhbmdsZSB0byBhbnkgZ2l2ZW4gb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29weVRvCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgdG8uCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhpcyBvYmplY3QuCiAgICAqKi8KICAgIGNvcHlUbzogZnVuY3Rpb24gKGRlc3QpIHsKCiAgICAgICAgZGVzdC54ID0gdGhpcy54OwogICAgICAgIGRlc3QueSA9IHRoaXMueTsKICAgICAgICBkZXN0LndpZHRoID0gdGhpcy53aWR0aDsKICAgICAgICBkZXN0LmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgICAgICByZXR1cm4gZGVzdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbmNyZWFzZXMgdGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhlIHNwZWNpZmllZCBhbW91bnRzLiBUaGUgY2VudGVyIHBvaW50IG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHN0YXlzIHRoZSBzYW1lLCBhbmQgaXRzIHNpemUgaW5jcmVhc2VzIHRvIHRoZSBsZWZ0IGFuZCByaWdodCBieSB0aGUgZHggdmFsdWUsIGFuZCB0byB0aGUgdG9wIGFuZCB0aGUgYm90dG9tIGJ5IHRoZSBkeSB2YWx1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2luZmxhdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gVGhlIGFtb3VudCB0byBiZSBhZGRlZCB0byB0aGUgbGVmdCBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIFRoZSBhbW91bnQgdG8gYmUgYWRkZWQgdG8gdGhlIGJvdHRvbSBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICovCiAgICBpbmZsYXRlOiBmdW5jdGlvbiAoZHgsIGR5KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZSh0aGlzLCBkeCwgZHkpOwogICAgfSwKCiAgICAvKioKICAgICogVGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QsIGV4cHJlc3NlZCBhcyBhIFBvaW50IG9iamVjdCB3aXRoIHRoZSB2YWx1ZXMgb2YgdGhlIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3NpemUKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRwdXRdIC0gT3B0aW9uYWwgUG9pbnQgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LgogICAgKi8KICAgIHNpemU6IGZ1bmN0aW9uIChvdXRwdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5zaXplKHRoaXMsIG91dHB1dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGFzIHRoZSBvcmlnaW5hbCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY2xvbmUKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0cHV0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSAKICAgICovCiAgICBjbG9uZTogZnVuY3Rpb24gKG91dHB1dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNsb25lKHRoaXMsIG91dHB1dCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBjb29yZGluYXRlcyBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGUgcmVnaW9uIGRlZmluZWQgYnkgdGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29udGFpbnMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29udGFpbnM6IGZ1bmN0aW9uICh4LCB5KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnModGhpcywgeCwgeSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QgaXMgZnVsbHkgY29udGFpbmVkIHdpdGhpbiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBzYWlkIHRvIGNvbnRhaW4gYW5vdGhlciBpZiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QgZmFsbHMgZW50aXJlbHkgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHRoZSBmaXJzdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2NvbnRhaW5zUmVjdAogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgY29udGFpbnNSZWN0OiBmdW5jdGlvbiAoYikgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmVjdCh0aGlzLCBiKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgYXJlIGVxdWFsLgogICAgKiBUaGlzIG1ldGhvZCBjb21wYXJlcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIGVhY2ggUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjZXF1YWxzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSB0d28gUmVjdGFuZ2xlcyBoYXZlIGV4YWN0bHkgdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzOyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgZXF1YWxzOiBmdW5jdGlvbiAoYikgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmVxdWFscyh0aGlzLCBiKTsKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHNwZWNpZmllZCBpbiB0aGUgdG9JbnRlcnNlY3QgcGFyYW1ldGVyIGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3QsIHJldHVybnMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uIGFzIGEgUmVjdGFuZ2xlIG9iamVjdC4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0IHdpdGggaXRzIHByb3BlcnRpZXMgc2V0IHRvIDAuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNpbnRlcnNlY3Rpb24KICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IG91dCAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSBpbnRlcnNlY3Rpb24gdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhpcyBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IEEgUmVjdGFuZ2xlIG9iamVjdCB0aGF0IGVxdWFscyB0aGUgYXJlYSBvZiBpbnRlcnNlY3Rpb24uIElmIHRoZSBSZWN0YW5nbGVzIGRvIG5vdCBpbnRlcnNlY3QsIHRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgUmVjdGFuZ2xlIG9iamVjdDsgdGhhdCBpcywgYSBSZWN0YW5nbGUgd2l0aCBpdHMgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBzZXQgdG8gMC4KICAgICovCiAgICBpbnRlcnNlY3Rpb246IGZ1bmN0aW9uIChiLCBvdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3Rpb24odGhpcywgYiwgb3V0cHV0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgaW50ZXJzZWN0IHdpdGggZWFjaCBvdGhlci4KICAgICogVGhpcyBtZXRob2QgY2hlY2tzIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIHRoZSBSZWN0YW5nbGVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW50ZXJzZWN0cwogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBBIHRvbGVyYW5jZSB2YWx1ZSB0byBhbGxvdyBmb3IgYW4gaW50ZXJzZWN0aW9uIHRlc3Qgd2l0aCBwYWRkaW5nLCBkZWZhdWx0IHRvIDAuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhpcyBSZWN0YW5nbGUgb2JqZWN0OyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgaW50ZXJzZWN0czogZnVuY3Rpb24gKGIsIHRvbGVyYW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcywgYiwgdG9sZXJhbmNlKTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgb2JqZWN0IHNwZWNpZmllZCBpbnRlcnNlY3RzIChvdmVybGFwcykgd2l0aCB0aGUgZ2l2ZW4gdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW50ZXJzZWN0c1JhdwogICAgKiBAcGFyYW0ge251bWJlcn0gbGVmdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmlnaHQgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRvcCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gYm90dG9tdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gQSB0b2xlcmFuY2UgdmFsdWUgdG8gYWxsb3cgZm9yIGFuIGludGVyc2VjdGlvbiB0ZXN0IHdpdGggcGFkZGluZywgZGVmYXVsdCB0byAwCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhlIFJlY3RhbmdsZTsgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGludGVyc2VjdHNSYXc6IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHRvbGVyYW5jZSkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHNSYXcodGhpcywgbGVmdCwgcmlnaHQsIHRvcCwgYm90dG9tLCB0b2xlcmFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB0d28gUmVjdGFuZ2xlcyB0b2dldGhlciB0byBjcmVhdGUgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCwgYnkgZmlsbGluZyBpbiB0aGUgaG9yaXpvbnRhbCBhbmQgdmVydGljYWwgc3BhY2UgYmV0d2VlbiB0aGUgdHdvIFJlY3RhbmdsZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSN1bmlvbgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgbmV3IHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBpcyB0aGUgdW5pb24gb2YgdGhlIHR3byBSZWN0YW5nbGVzLgogICAgKi8KICAgIHVuaW9uOiBmdW5jdGlvbiAoYiwgb3V0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUudW5pb24odGhpcywgYiwgb3V0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IEEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICoqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIlt7UmVjdGFuZ2xlICh4PSIgKyB0aGlzLnggKyAiIHk9IiArIHRoaXMueSArICIgd2lkdGg9IiArIHRoaXMud2lkdGggKyAiIGhlaWdodD0iICsgdGhpcy5oZWlnaHQgKyAiIGVtcHR5PSIgKyB0aGlzLmVtcHR5ICsgIil9XSI7CiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNoYWxmV2lkdGgKKiBAcHJvcGVydHkge251bWJlcn0gaGFsZldpZHRoIC0gSGFsZiBvZiB0aGUgd2lkdGggb2YgdGhlIFJlY3RhbmdsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiaGFsZldpZHRoIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMud2lkdGggLyAyKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNoYWxmSGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhhbGZIZWlnaHQgLSBIYWxmIG9mIHRoZSBoZWlnaHQgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiaGFsZkhlaWdodCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5yb3VuZCh0aGlzLmhlaWdodCAvIDIpOwogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIGJvdHRvbSBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgd2lkdGggcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBoZWlnaHQgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNib3R0b20KKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gVGhlIHN1bSBvZiB0aGUgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGVpZ2h0OwogICAgfSwKICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIDw9IHRoaXMueSkgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAodGhpcy55IC0gdmFsdWUpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIGJvdHRvbSByaWdodCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNib3R0b20KKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm90dG9tUmlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIGJvdHRvbSByaWdodCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImJvdHRvbVJpZ2h0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Qb2ludCh0aGlzLnJpZ2h0LCB0aGlzLmJvdHRvbSk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yaWdodCA9IHZhbHVlLng7CiAgICAgICAgdGhpcy5ib3R0b20gPSB2YWx1ZS55OwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBsZWZ0IG9mIHRoZSBSZWN0YW5nbGUuIENoYW5naW5nIHRoZSBsZWZ0IHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4gSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgd2lkdGggcHJvcGVydHksIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHggdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2xlZnQKKiBAcHJvcGVydHkge251bWJlcn0gbGVmdCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnQgb2YgdGhlIFJlY3RhbmdsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAibGVmdCIsIHsKICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA+PSB0aGlzLnJpZ2h0KSB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnJpZ2h0IC0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMueCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgcmlnaHQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLCBob3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3JpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gVGhlIHN1bSBvZiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIGlmICh2YWx1ZSA8PSB0aGlzLngpIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMueCArIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHZvbHVtZSBvZiB0aGUgUmVjdGFuZ2xlIGRlcml2ZWQgZnJvbSB3aWR0aCAqIGhlaWdodC4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3ZvbHVtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2b2x1bWUgLSBUaGUgdm9sdW1lIG9mIHRoZSBSZWN0YW5nbGUgZGVyaXZlZCBmcm9tIHdpZHRoICogaGVpZ2h0LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLndpZHRoICogdGhpcy5oZWlnaHQ7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBwZXJpbWV0ZXIgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlLiBUaGlzIGlzIHRoZSBzdW0gb2YgYWxsIDQgc2lkZXMuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNwZXJpbWV0ZXIKKiBAcHJvcGVydHkge251bWJlcn0gcGVyaW1ldGVyIC0gVGhlIHBlcmltZXRlciBzaXplIG9mIHRoZSBSZWN0YW5nbGUuIFRoaXMgaXMgdGhlIHN1bSBvZiBhbGwgNCBzaWRlcy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAicGVyaW1ldGVyIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMud2lkdGggKiAyKSArICh0aGlzLmhlaWdodCAqIDIpOwogICAgfQoKfSk7CgovKioKKiBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2NlbnRlclgKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJjZW50ZXJYIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54ICsgdGhpcy5oYWxmV2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy54ID0gdmFsdWUgLSB0aGlzLmhhbGZXaWR0aDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBSZWN0YW5nbGUuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNjZW50ZXJZCiogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiY2VudGVyWSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGFsZkhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnkgPSB2YWx1ZSAtIHRoaXMuaGFsZkhlaWdodDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wIG9mIHRoZSBSZWN0YW5nbGUuIENoYW5naW5nIHRoZSB0b3AgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuCiogSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgaGVpZ2h0IHByb3BlcnR5LCB3aGVyZWFzIGNoYW5naW5nIHRoZSB5IHZhbHVlIGRvZXMgbm90IGFmZmVjdCB0aGUgaGVpZ2h0IHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdG9wCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvcCAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIHRvcCBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ0b3AiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID49IHRoaXMuYm90dG9tKSB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gMDsKICAgICAgICAgICAgdGhpcy55ID0gdmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAodGhpcy5ib3R0b20gLSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgdG9wIGxlZnQgY29ybmVyIGFzIGEgUG9pbnQgb2JqZWN0LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdG9wTGVmdAoqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB0b3BMZWZ0IC0gVGhlIGxvY2F0aW9uIG9mIHRoZSBSZWN0YW5nbGVzIHRvcCBsZWZ0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAidG9wTGVmdCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Qb2ludCh0aGlzLngsIHRoaXMueSk7CiAgICB9LAogICAgCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMueCA9IHZhbHVlLng7CiAgICAgICAgdGhpcy55ID0gdmFsdWUueTsKICAgIH0KCn0pOwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIG9yIG5vdCB0aGlzIFJlY3RhbmdsZSBvYmplY3QgaXMgZW1wdHkuIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBlbXB0eSBpZiBpdHMgd2lkdGggb3IgaGVpZ2h0IGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byAwLgoqIElmIHNldCB0byB0cnVlIHRoZW4gYWxsIG9mIHRoZSBSZWN0YW5nbGUgcHJvcGVydGllcyBhcmUgc2V0IHRvIDAuIAoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjZW1wdHkKKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtcHR5IC0gR2V0cyBvciBzZXRzIHRoZSBSZWN0YW5nbGVzIGVtcHR5IHN0YXRlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJlbXB0eSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICghdGhpcy53aWR0aCB8fCAhdGhpcy5oZWlnaHQpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuc2V0VG8oMCwgMCwgMCwgMCk7CiAgICB9Cgp9KTsKCi8qKgoqIEluY3JlYXNlcyB0aGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuIFRoZSBjZW50ZXIgcG9pbnQgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3Qgc3RheXMgdGhlIHNhbWUsIGFuZCBpdHMgc2l6ZSBpbmNyZWFzZXMgdG8gdGhlIGxlZnQgYW5kIHJpZ2h0IGJ5IHRoZSBkeCB2YWx1ZSwgYW5kIHRvIHRoZSB0b3AgYW5kIHRoZSBib3R0b20gYnkgdGhlIGR5IHZhbHVlLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IGR4IC0gVGhlIGFtb3VudCB0byBiZSBhZGRlZCB0byB0aGUgbGVmdCBzaWRlIG9mIHRoZSBSZWN0YW5nbGUuCiogQHBhcmFtIHtudW1iZXJ9IGR5IC0gVGhlIGFtb3VudCB0byBiZSBhZGRlZCB0byB0aGUgYm90dG9tIHNpZGUgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBUaGlzIFJlY3RhbmdsZSBvYmplY3QuCiovClBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZSA9IGZ1bmN0aW9uIChhLCBkeCwgZHkpIHsKICAgIGEueCAtPSBkeDsKICAgIGEud2lkdGggKz0gMiAqIGR4OwogICAgYS55IC09IGR5OwogICAgYS5oZWlnaHQgKz0gMiAqIGR5OwogICAgcmV0dXJuIGE7Cn07CgovKioKKiBJbmNyZWFzZXMgdGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIFJlY3RhbmdsZS5pbmZsYXRlKCkgbWV0aG9kIGV4Y2VwdCBpdCB0YWtlcyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZVBvaW50CiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHBvaW50IC0gVGhlIHggcHJvcGVydHkgb2YgdGhpcyBQb2ludCBvYmplY3QgaXMgdXNlZCB0byBpbmNyZWFzZSB0aGUgaG9yaXpvbnRhbCBkaW1lbnNpb24gb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QuIFRoZSB5IHByb3BlcnR5IGlzIHVzZWQgdG8gaW5jcmVhc2UgdGhlIHZlcnRpY2FsIGRpbWVuc2lvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlUG9pbnQgPSBmdW5jdGlvbiAoYSwgcG9pbnQpIHsKICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGUoYSwgcG9pbnQueCwgcG9pbnQueSk7Cn07CgovKioKKiBUaGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCwgZXhwcmVzc2VkIGFzIGEgUG9pbnQgb2JqZWN0IHdpdGggdGhlIHZhbHVlcyBvZiB0aGUgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5zaXplCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRwdXRdIC0gT3B0aW9uYWwgUG9pbnQgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QKKi8KUGhhc2VyLlJlY3RhbmdsZS5zaXplID0gZnVuY3Rpb24gKGEsIG91dHB1dCkgewogICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQogICAgcmV0dXJuIG91dHB1dC5zZXRUbyhhLndpZHRoLCBhLmhlaWdodCk7Cn07CgovKioKKiBSZXR1cm5zIGEgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIGFzIHRoZSBvcmlnaW5hbCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5jbG9uZQoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dHB1dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhlIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfQoqLwpQaGFzZXIuUmVjdGFuZ2xlLmNsb25lID0gZnVuY3Rpb24gKGEsIG91dHB1dCkgewogICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCk7IH0KICAgIHJldHVybiBvdXRwdXQuc2V0VG8oYS54LCBhLnksIGEud2lkdGgsIGEuaGVpZ2h0KTsKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgc3BlY2lmaWVkIGNvb3JkaW5hdGVzIGFyZSBjb250YWluZWQgd2l0aGluIHRoZSByZWdpb24gZGVmaW5lZCBieSB0aGlzIFJlY3RhbmdsZSBvYmplY3QuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQgdG8gdGVzdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGEsIHgsIHkpIHsKICAgIHJldHVybiAoeCA+PSBhLnggJiYgeCA8PSBhLnJpZ2h0ICYmIHkgPj0gYS55ICYmIHkgPD0gYS5ib3R0b20pOwp9OwoKUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1JhdyA9IGZ1bmN0aW9uIChyeCwgcnksIHJ3LCByaCwgeCwgeSkgewogICAgcmV0dXJuICh4ID49IHJ4ICYmIHggPD0gKHJ4ICsgcncpICYmIHkgPj0gcnkgJiYgeSA8PSAocnkgKyByaCkpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgcG9pbnQgaXMgY29udGFpbmVkIHdpdGhpbiB0aGUgcmVjdGFuZ3VsYXIgcmVnaW9uIGRlZmluZWQgYnkgdGhpcyBSZWN0YW5nbGUgb2JqZWN0LiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIHRoZSBSZWN0YW5nbGUuY29udGFpbnMoKSBtZXRob2QsIGV4Y2VwdCB0aGF0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1BvaW50CiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHBvaW50IC0gVGhlIHBvaW50IG9iamVjdCBiZWluZyBjaGVja2VkLiBDYW4gYmUgUG9pbnQgb3IgYW55IG9iamVjdCB3aXRoIC54IGFuZCAueSB2YWx1ZXMuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGNvbnRhaW5zIHRoZSBzcGVjaWZpZWQgcG9pbnQ7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5jb250YWluc1BvaW50ID0gZnVuY3Rpb24gKGEsIHBvaW50KSB7CiAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5jb250YWlucyhhLCBwb2ludC54LCBwb2ludC55KTsKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdCBpcyBmdWxseSBjb250YWluZWQgd2l0aGluIHRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBBIFJlY3RhbmdsZSBvYmplY3QgaXMgc2FpZCB0byBjb250YWluIGFub3RoZXIgaWYgdGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0IGZhbGxzIGVudGlyZWx5IHdpdGhpbiB0aGUgYm91bmRhcmllcyBvZiB0aGUgZmlyc3QuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmVjdAoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmVjdCA9IGZ1bmN0aW9uIChhLCBiKSB7CgogICAgLy8gIElmIHRoZSBnaXZlbiByZWN0IGhhcyBhIGxhcmdlciB2b2x1bWUgdGhhbiB0aGlzIG9uZSB0aGVuIGl0IGNhbiBuZXZlciBjb250YWluIGl0CiAgICBpZiAoYS52b2x1bWUgPiBiLnZvbHVtZSkKICAgIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgcmV0dXJuIChhLnggPj0gYi54ICYmIGEueSA+PSBiLnkgJiYgYS5yaWdodCA8PSBiLnJpZ2h0ICYmIGEuYm90dG9tIDw9IGIuYm90dG9tKTsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBSZWN0YW5nbGVzIGFyZSBlcXVhbC4KKiBUaGlzIG1ldGhvZCBjb21wYXJlcyB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIGVhY2ggUmVjdGFuZ2xlLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5lcXVhbHMKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSB0d28gUmVjdGFuZ2xlcyBoYXZlIGV4YWN0bHkgdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzOyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuZXF1YWxzID0gZnVuY3Rpb24gKGEsIGIpIHsKICAgIHJldHVybiAoYS54ID09IGIueCAmJiBhLnkgPT0gYi55ICYmIGEud2lkdGggPT0gYi53aWR0aCAmJiBhLmhlaWdodCA9PSBiLmhlaWdodCk7Cn07CgovKioKKiBJZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBzcGVjaWZpZWQgaW4gdGhlIHRvSW50ZXJzZWN0IHBhcmFtZXRlciBpbnRlcnNlY3RzIHdpdGggdGhpcyBSZWN0YW5nbGUgb2JqZWN0LCByZXR1cm5zIHRoZSBhcmVhIG9mIGludGVyc2VjdGlvbiBhcyBhIFJlY3RhbmdsZSBvYmplY3QuIElmIHRoZSBSZWN0YW5nbGVzIGRvIG5vdCBpbnRlcnNlY3QsIHRoaXMgbWV0aG9kIHJldHVybnMgYW4gZW1wdHkgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIGl0cyBwcm9wZXJ0aWVzIHNldCB0byAwLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3Rpb24KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSBpbnRlcnNlY3Rpb24gdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhpcyBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gQSBSZWN0YW5nbGUgb2JqZWN0IHRoYXQgZXF1YWxzIHRoZSBhcmVhIG9mIGludGVyc2VjdGlvbi4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0OyB0aGF0IGlzLCBhIFJlY3RhbmdsZSB3aXRoIGl0cyB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIHNldCB0byAwLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdGlvbiA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBvdXQgID0gb3V0IHx8IG5ldyBQaGFzZXIuUmVjdGFuZ2xlOwoKICAgIGlmIChQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMoYSwgYikpCiAgICB7CiAgICAgICAgb3V0LnggPSBNYXRoLm1heChhLngsIGIueCk7CiAgICAgICAgb3V0LnkgPSBNYXRoLm1heChhLnksIGIueSk7CiAgICAgICAgb3V0LndpZHRoID0gTWF0aC5taW4oYS5yaWdodCwgYi5yaWdodCkgLSBvdXQueDsKICAgICAgICBvdXQuaGVpZ2h0ID0gTWF0aC5taW4oYS5ib3R0b20sIGIuYm90dG9tKSAtIG91dC55OwogICAgfQoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gUmVjdGFuZ2xlcyBpbnRlcnNlY3Qgd2l0aCBlYWNoIG90aGVyLgoqIFRoaXMgbWV0aG9kIGNoZWNrcyB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBvZiB0aGUgUmVjdGFuZ2xlcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cwoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoaXMgUmVjdGFuZ2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMgPSBmdW5jdGlvbiAoYSwgYikgewoKICAgIHJldHVybiAoYS54IDwgYi5yaWdodCAmJiBiLnggPCBhLnJpZ2h0ICYmIGEueSA8IGIuYm90dG9tICYmIGIueSA8IGEuYm90dG9tKTsKCiAgICAvLyByZXR1cm4gKGEueCA8PSBiLnJpZ2h0ICYmIGIueCA8PSBhLnJpZ2h0ICYmIGEueSA8PSBiLmJvdHRvbSAmJiBiLnkgPD0gYS5ib3R0b20pOwoKICAgIC8vIHJldHVybiAoYS5sZWZ0IDw9IGIucmlnaHQgJiYgYi5sZWZ0IDw9IGEucmlnaHQgJiYgYS50b3AgPD0gYi5ib3R0b20gJiYgYi50b3AgPD0gYS5ib3R0b20pOwogICAgLy8gcmV0dXJuICEoYS54ID4gYi5yaWdodCArIHRvbGVyYW5jZSB8fCBhLnJpZ2h0IDwgYi54IC0gdG9sZXJhbmNlIHx8IGEueSA+IGIuYm90dG9tICsgdG9sZXJhbmNlIHx8IGEuYm90dG9tIDwgYi55IC0gdG9sZXJhbmNlKTsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIG9iamVjdCBzcGVjaWZpZWQgaW50ZXJzZWN0cyAob3ZlcmxhcHMpIHdpdGggdGhlIGdpdmVuIHZhbHVlcy4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0c1JhdwoqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHJpZ2h0IC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHRvcCAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSBib3R0b20gLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gQSB0b2xlcmFuY2UgdmFsdWUgdG8gYWxsb3cgZm9yIGFuIGludGVyc2VjdGlvbiB0ZXN0IHdpdGggcGFkZGluZywgZGVmYXVsdCB0byAwCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGludGVyc2VjdHMgd2l0aCB0aGUgUmVjdGFuZ2xlOyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0c1JhdyA9IGZ1bmN0aW9uIChhLCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHRvbGVyYW5jZSkgewoKICAgIGlmICh0eXBlb2YgdG9sZXJhbmNlID09PSAidW5kZWZpbmVkIikgeyB0b2xlcmFuY2UgPSAwOyB9CgogICAgcmV0dXJuICEobGVmdCA+IGEucmlnaHQgKyB0b2xlcmFuY2UgfHwgcmlnaHQgPCBhLmxlZnQgLSB0b2xlcmFuY2UgfHwgdG9wID4gYS5ib3R0b20gKyB0b2xlcmFuY2UgfHwgYm90dG9tIDwgYS50b3AgLSB0b2xlcmFuY2UpOwoKfTsKCi8qKgoqIEFkZHMgdHdvIFJlY3RhbmdsZXMgdG9nZXRoZXIgdG8gY3JlYXRlIGEgbmV3IFJlY3RhbmdsZSBvYmplY3QsIGJ5IGZpbGxpbmcgaW4gdGhlIGhvcml6b250YWwgYW5kIHZlcnRpY2FsIHNwYWNlIGJldHdlZW4gdGhlIHR3byBSZWN0YW5nbGVzLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS51bmlvbgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIG5ldyB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBpcyB0aGUgdW5pb24gb2YgdGhlIHR3byBSZWN0YW5nbGVzLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLnVuaW9uID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIGlmICh0eXBlb2Ygb3V0ID09PSAidW5kZWZpbmVkIikgeyBvdXQgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOyB9CgogICAgcmV0dXJuIG91dC5zZXRUbyhNYXRoLm1pbihhLngsIGIueCksIE1hdGgubWluKGEueSwgYi55KSwgTWF0aC5tYXgoYS5yaWdodCwgYi5yaWdodCkgLSBNYXRoLm1pbihhLmxlZnQsIGIubGVmdCksIE1hdGgubWF4KGEuYm90dG9tLCBiLmJvdHRvbSkgLSBNYXRoLm1pbihhLnRvcCwgYi50b3ApKTsKICAgIAp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBQb2x5Z29uLiBZb3UgaGF2ZSB0byBwcm92aWRlIGEgbGlzdCBvZiBwb2ludHMuCiogVGhpcyBjYW4gYmUgYW4gYXJyYXkgb2YgUG9pbnRzIHRoYXQgZm9ybSB0aGUgcG9seWdvbiwgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMgdGhhdCB3aWxsIGJlIGludGVycHJldGVkIGFzIFt4LHksIHgseSwgLi4uXSwgCiogb3IgdGhlIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGFsbCB0aGUgcG9pbnRzIG9mIHRoZSBwb2x5Z29uIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24obmV3IFBJWEkuUG9pbnQoKSwgbmV3IFBJWEkuUG9pbnQoKSwgLi4uKWAsIG9yIHRoZQoqIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlIGZsYXQgeCx5IHZhbHVlcyBlLmcuIGBuZXcgUElYSS5Qb2x5Z29uKHgseSwgeCx5LCB4LHksIC4uLilgIHdoZXJlIGB4YCBhbmQgYHlgIGFyZSBudW1iZXJzLgoqCiogQGNsYXNzIFBoYXNlci5Qb2x5Z29uCiogQGNsYXNzZGVzYyBUaGUgcG9seWdvbiByZXByZXNlbnRzIGEgbGlzdCBvZiBvcmRlcmRlZCBwb2ludHMgaW4gc3BhY2UKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge0FycmF5PFBoYXNlci5Qb2ludD58QXJyYXk8bnVtYmVyPn0gcG9pbnRzIC0gVGhlIGFycmF5IG9mIFBvaW50cy4KKi8KUGhhc2VyLlBvbHlnb24gPSBmdW5jdGlvbiAocG9pbnRzKSB7CgogICAgUElYSS5Qb2x5Z29uLmNhbGwodGhpcywgcG9pbnRzKTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHR5cGUgLSBUaGUgYmFzZSBvYmplY3QgdHlwZS4KCSovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuUE9MWUdPTjsKCn07CgpQaGFzZXIuUG9seWdvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuUG9seWdvbi5wcm90b3R5cGUpOwpQaGFzZXIuUG9seWdvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUG9seWdvbjsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogRGVzY3JpcHRpb24gb2YgUGhhc2VyLk5ldAoqCiogQGNsYXNzIFBoYXNlci5OZXQKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5OZXQgPSBmdW5jdGlvbiAoZ2FtZSkgewoJCgl0aGlzLmdhbWUgPSBnYW1lOwoKfTsKClBoYXNlci5OZXQucHJvdG90eXBlID0gewoKCS8qKgoJKiBSZXR1cm5zIHRoZSBob3N0bmFtZSBnaXZlbiBieSB0aGUgYnJvd3Nlci4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk5ldCNnZXRIb3N0TmFtZQoJKiBAcmV0dXJuIHtzdHJpbmd9CgkqLyAgICAgICAgCglnZXRIb3N0TmFtZTogZnVuY3Rpb24gKCkgewoKCQlpZiAod2luZG93LmxvY2F0aW9uICYmIHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZSkgewoJCQlyZXR1cm4gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lOwoJCX0KCgkJcmV0dXJuIG51bGw7CgoJfSwKCgkvKioKCSogQ29tcGFyZXMgdGhlIGdpdmVuIGRvbWFpbiBuYW1lIGFnYWluc3QgdGhlIGhvc3RuYW1lIG9mIHRoZSBicm93c2VyIGNvbnRhaW5pbmcgdGhlIGdhbWUuCgkqIElmIHRoZSBkb21haW4gbmFtZSBpcyBmb3VuZCBpdCByZXR1cm5zIHRydWUuCgkqIFlvdSBjYW4gc3BlY2lmeSBhIHBhcnQgb2YgYSBkb21haW4sIGZvciBleGFtcGxlICdnb29nbGUnIHdvdWxkIG1hdGNoICdnb29nbGUuY29tJywgJ2dvb2dsZS5jby51aycsIGV0Yy4KCSogRG8gbm90IGluY2x1ZGUgJ2h0dHA6Ly8nIGF0IHRoZSBzdGFydC4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk5ldCNjaGVja0RvbWFpbk5hbWUKCSogQHBhcmFtIHtzdHJpbmd9IGRvbWFpbgoJKiBAcmV0dXJuIHtib29sZWFufQoJKi8gICAgICAgIAoJY2hlY2tEb21haW5OYW1lOiBmdW5jdGlvbiAoZG9tYWluKSB7CgkJcmV0dXJuIHdpbmRvdy5sb2NhdGlvbi5ob3N0bmFtZS5pbmRleE9mKGRvbWFpbikgIT09IC0xOwoJfSwKCgkvKioKCSogVXBkYXRlcyBhIHZhbHVlIG9uIHRoZSBRdWVyeSBTdHJpbmcgYW5kIHJldHVybnMgaXQgaW4gZnVsbC4KCSogSWYgdGhlIHZhbHVlIGRvZXNuJ3QgYWxyZWFkeSBleGlzdCBpdCBpcyBzZXQuCgkqIElmIHRoZSB2YWx1ZSBleGlzdHMgaXQgaXMgcmVwbGFjZWQgd2l0aCB0aGUgbmV3IHZhbHVlIGdpdmVuLiBJZiB5b3UgZG9uJ3QgcHJvdmlkZSBhIG5ldyB2YWx1ZSBpdCBpcyByZW1vdmVkIGZyb20gdGhlIHF1ZXJ5IHN0cmluZy4KCSogT3B0aW9uYWxseSB5b3UgY2FuIHJlZGlyZWN0IHRvIHRoZSBuZXcgdXJsLCBvciBqdXN0IHJldHVybiBpdCBhcyBhIHN0cmluZy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk5ldCN1cGRhdGVRdWVyeVN0cmluZwoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHF1ZXJ5c3RyaW5nIGtleSB0byB1cGRhdGUuCgkqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZSAtIFRoZSBuZXcgdmFsdWUgdG8gYmUgc2V0LiBJZiBpdCBhbHJlYWR5IGV4aXN0cyBpdCB3aWxsIGJlIHJlcGxhY2VkLgoJKiBAcGFyYW0ge2Jvb2xlYW59IHJlZGlyZWN0IC0gSWYgdHJ1ZSB0aGUgYnJvd3NlciB3aWxsIGlzc3VlIGEgcmVkaXJlY3QgdG8gdGhlIHVybCB3aXRoIHRoZSBuZXcgcXVlcnlzdHJpbmcuCgkqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIG1vZGlmeS4gSWYgbm9uZSBpcyBnaXZlbiBpdCB1c2VzIHdpbmRvdy5sb2NhdGlvbi5ocmVmLgoJKiBAcmV0dXJuIHtzdHJpbmd9IElmIHJlZGlyZWN0IGlzIGZhbHNlIHRoZW4gdGhlIG1vZGlmaWVkIHVybCBhbmQgcXVlcnkgc3RyaW5nIGlzIHJldHVybmVkLgoJKi8KCXVwZGF0ZVF1ZXJ5U3RyaW5nOiBmdW5jdGlvbiAoa2V5LCB2YWx1ZSwgcmVkaXJlY3QsIHVybCkgewoKCQlpZiAodHlwZW9mIHJlZGlyZWN0ID09PSAidW5kZWZpbmVkIikgeyByZWRpcmVjdCA9IGZhbHNlOyB9CgkJaWYgKHR5cGVvZiB1cmwgPT09ICJ1bmRlZmluZWQiKSB7IHVybCA9ICcnOyB9CgoJCWlmICh1cmwgPT0gJycpIHsKCQkJdXJsID0gd2luZG93LmxvY2F0aW9uLmhyZWY7CgkJfQoKCQl2YXIgb3V0cHV0ID0gJyc7CgkJdmFyIHJlID0gbmV3IFJlZ0V4cCgiKFs/fCZdKSIgKyBrZXkgKyAiPS4qPygmfCN8JCkoLiopIiwgImdpIik7CgkJCgkJaWYgKHJlLnRlc3QodXJsKSkKCQl7CgkJCWlmICh0eXBlb2YgdmFsdWUgIT09ICd1bmRlZmluZWQnICYmIHZhbHVlICE9PSBudWxsKQoJCQl7CgkJCQlvdXRwdXQgPSB1cmwucmVwbGFjZShyZSwgJyQxJyArIGtleSArICI9IiArIHZhbHVlICsgJyQyJDMnKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCW91dHB1dCA9IHVybC5yZXBsYWNlKHJlLCAnJDEkMycpLnJlcGxhY2UoLygmfFw/KSQvLCAnJyk7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpCgkJCXsKCQkJCXZhciBzZXBhcmF0b3IgPSB1cmwuaW5kZXhPZignPycpICE9PSAtMSA/ICcmJyA6ICc/JzsKCQkJCXZhciBoYXNoID0gdXJsLnNwbGl0KCcjJyk7CgkJCQl1cmwgPSBoYXNoWzBdICsgc2VwYXJhdG9yICsga2V5ICsgJz0nICsgdmFsdWU7CgoJCQkJaWYgKGhhc2hbMV0pIHsKCQkJCQl1cmwgKz0gJyMnICsgaGFzaFsxXTsKCQkJCX0KCgkJCQlvdXRwdXQgPSB1cmw7CgoJCQl9CgkJCWVsc2UKCQkJewoJCQkJb3V0cHV0ID0gdXJsOwoJCQl9CgkJfQoKCQlpZiAocmVkaXJlY3QpCgkJewoJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IG91dHB1dDsKCQl9CgkJZWxzZQoJCXsKCQkJcmV0dXJuIG91dHB1dDsKCQl9CgoJfSwKCgkvKioKCSogUmV0dXJucyB0aGUgUXVlcnkgU3RyaW5nIGFzIGFuIG9iamVjdC4KCSogSWYgeW91IHNwZWNpZnkgYSBwYXJhbWV0ZXIgaXQgd2lsbCByZXR1cm4ganVzdCB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIsIHNob3VsZCBpdCBleGlzdC4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk5ldCNnZXRRdWVyeVN0cmluZwoJKiBAcGFyYW0ge3N0cmluZ30gW3BhcmFtZXRlcj0nJ10gLSBJZiBzcGVjaWZpZWQgdGhpcyB3aWxsIHJldHVybiBqdXN0IHRoZSB2YWx1ZSBmb3IgdGhhdCBrZXkuCgkqIEByZXR1cm4ge3N0cmluZ3xvYmplY3R9IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBrZXkgdmFsdWUgcGFpcnMgZm91bmQgaW4gdGhlIHF1ZXJ5IHN0cmluZyBvciBqdXN0IHRoZSB2YWx1ZSBpZiBhIHBhcmFtZXRlciB3YXMgZ2l2ZW4uCgkqLwoJZ2V0UXVlcnlTdHJpbmc6IGZ1bmN0aW9uIChwYXJhbWV0ZXIpIHsKCgkJaWYgKHR5cGVvZiBwYXJhbWV0ZXIgPT09ICJ1bmRlZmluZWQiKSB7IHBhcmFtZXRlciA9ICcnOyB9CgoJCXZhciBvdXRwdXQgPSB7fTsKCQl2YXIga2V5VmFsdWVzID0gbG9jYXRpb24uc2VhcmNoLnN1YnN0cmluZygxKS5zcGxpdCgnJicpOwoKCQlmb3IgKHZhciBpIGluIGtleVZhbHVlcykgewoKCQkJdmFyIGtleSA9IGtleVZhbHVlc1tpXS5zcGxpdCgnPScpOwoKCQkJaWYgKGtleS5sZW5ndGggPiAxKQoJCQl7CgkJCQlpZiAocGFyYW1ldGVyICYmIHBhcmFtZXRlciA9PSB0aGlzLmRlY29kZVVSSShrZXlbMF0pKQoJCQkJewoJCQkJCXJldHVybiB0aGlzLmRlY29kZVVSSShrZXlbMV0pOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCW91dHB1dFt0aGlzLmRlY29kZVVSSShrZXlbMF0pXSA9IHRoaXMuZGVjb2RlVVJJKGtleVsxXSk7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBvdXRwdXQ7CgoJfSwKCgkvKioKCSogUmV0dXJucyB0aGUgUXVlcnkgU3RyaW5nIGFzIGFuIG9iamVjdC4KCSogSWYgeW91IHNwZWNpZnkgYSBwYXJhbWV0ZXIgaXQgd2lsbCByZXR1cm4ganVzdCB0aGUgdmFsdWUgb2YgdGhhdCBwYXJhbWV0ZXIsIHNob3VsZCBpdCBleGlzdC4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk5ldCNkZWNvZGVVUkkKCSogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIFVSSSBjb21wb25lbnQgdG8gYmUgZGVjb2RlZC4KCSogQHJldHVybiB7c3RyaW5nfSBUaGUgZGVjb2RlZCB2YWx1ZS4KCSovCglkZWNvZGVVUkk6IGZ1bmN0aW9uICh2YWx1ZSkgewoJCXJldHVybiBkZWNvZGVVUklDb21wb25lbnQodmFsdWUucmVwbGFjZSgvXCsvZywgIiAiKSk7Cgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gVHdlZW5NYW5hZ2VyCiogCiogQGNsYXNzIFBoYXNlci5Ud2Vlbk1hbmFnZXIKKiBAY2xhc3NkZXNjIAoqIFBoYXNlci5HYW1lIGhhcyBhIHNpbmdsZSBpbnN0YW5jZSBvZiB0aGUgVHdlZW5NYW5hZ2VyIHRocm91Z2ggd2hpY2ggYWxsIFR3ZWVuIG9iamVjdHMgYXJlIGNyZWF0ZWQgYW5kIHVwZGF0ZWQuCiogVHdlZW5zIGFyZSBob29rZWQgaW50byB0aGUgZ2FtZSBjbG9jayBhbmQgcGF1c2Ugc3lzdGVtLCBhZGp1c3RpbmcgYmFzZWQgb24gdGhlIGdhbWUgc3RhdGUuCioKKiBUd2Vlbk1hbmFnZXIgaXMgYmFzZWQgaGVhdmlseSBvbiB0d2Vlbi5qcyBieSBodHRwOi8vc29sZWRhZHBlbmFkZXMuY29tLgoqIFRoZSBkaWZmZXJlbmNlIGJlaW5nIHRoYXQgdHdlZW5zIGJlbG9uZyB0byBhIGdhbWVzIGluc3RhbmNlIG9mIFR3ZWVuTWFuYWdlciwgcmF0aGVyIHRoYW4gdG8gYSBnbG9iYWwgVFdFRU4gb2JqZWN0LgoqIEl0IGFsc28gaGFzIGNhbGxiYWNrcyBzd2FwcGVkIGZvciBTaWduYWxzIGFuZCBhIGZldyBpc3N1ZXMgcGF0Y2hlZCB3aXRoIHJlZ2FyZCB0byBwcm9wZXJ0aWVzIGFuZCBjb21wbGV0aW9uIGVycm9ycy4KKiBQbGVhc2Ugc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9zb2xlL3R3ZWVuLmpzIGZvciBhIGZ1bGwgbGlzdCBvZiBjb250cmlidXRvcnMuCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Ud2Vlbk1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7YXJyYXl9IF90d2VlbnMgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCgl0aGlzLl90d2VlbnMgPSBbXTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7YXJyYXl9IF9hZGQgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9hZGQgPSBbXTsKCgl0aGlzLmdhbWUub25QYXVzZS5hZGQodGhpcy5wYXVzZUFsbCwgdGhpcyk7Cgl0aGlzLmdhbWUub25SZXN1bWUuYWRkKHRoaXMucmVzdW1lQWxsLCB0aGlzKTsKCn07CgpQaGFzZXIuVHdlZW5NYW5hZ2VyLnByb3RvdHlwZSA9IHsKCgkvKioKCSogVmVyc2lvbiBudW1iZXIgb2YgdGhpcyBsaWJyYXJ5LgoJKiBAcHJvcGVydHkge3N0cmluZ30gUkVWSVNJT04KCSogQGRlZmF1bHQgCgkqLwkKCVJFVklTSU9OOiAnMTFkZXYnLAoKCS8qKgoJKiBHZXQgYWxsIHRoZSB0d2VlbiBvYmplY3RzIGluIGFuIGFycmF5LgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjZ2V0QWxsCgkqIEByZXR1cm5zIHtQaGFzZXIuVHdlZW5bXX0gQXJyYXkgd2l0aCBhbGwgdHdlZW4gb2JqZWN0cy4KCSovCglnZXRBbGw6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuX3R3ZWVuczsKCgl9LAoKCS8qKgoJKiBSZW1vdmUgYWxsIHR3ZWVuIG9iamVjdHMuCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNyZW1vdmVBbGwKCSovCglyZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fdHdlZW5zID0gW107CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHR3ZWVuIGludG8gdGhlIFR3ZWVuTWFuYWdlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI2FkZAoJKiBAcGFyYW0ge1BoYXNlci5Ud2Vlbn0gdHdlZW4gLSBUaGUgdHdlZW4gb2JqZWN0IHlvdSB3YW50IHRvIGFkZC4KCSogQHJldHVybnMge1BoYXNlci5Ud2Vlbn0gVGhlIHR3ZWVuIG9iamVjdCB5b3UgYWRkZWQgdG8gdGhlIG1hbmFnZXIuCgkqLwoJYWRkOiBmdW5jdGlvbiAoIHR3ZWVuICkgewoKCQl0aGlzLl9hZGQucHVzaCggdHdlZW4gKTsKCgl9LAoKCS8qKgoJKiBDcmVhdGUgYSB0d2VlbiBvYmplY3QgZm9yIGEgc3BlY2lmaWMgb2JqZWN0LiBUaGUgb2JqZWN0IGNhbiBiZSBhbnkgSmF2YVNjcmlwdCBvYmplY3Qgb3IgUGhhc2VyIG9iamVjdCBzdWNoIGFzIFNwcml0ZS4gCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNjcmVhdGUKCSogQHBhcmFtIHtPYmplY3R9IG9iamVjdCAtIE9iamVjdCB0aGUgdHdlZW4gd2lsbCBiZSBydW4gb24uCgkqIEByZXR1cm5zIHtQaGFzZXIuVHdlZW59IFRoZSBuZXdseSBjcmVhdGVkIHR3ZWVuIG9iamVjdC4KCSovCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChvYmplY3QpIHsKCiAgICAgICAgcmV0dXJuIG5ldyBQaGFzZXIuVHdlZW4ob2JqZWN0LCB0aGlzLmdhbWUpOwoKICAgIH0sCgoJLyoqCgkqIFJlbW92ZSBhIHR3ZWVuIGZyb20gdGhpcyBtYW5hZ2VyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjcmVtb3ZlCgkqIEBwYXJhbSB7UGhhc2VyLlR3ZWVufSB0d2VlbiAtIFRoZSB0d2VlbiBvYmplY3QgeW91IHdhbnQgdG8gcmVtb3ZlLgoJKi8KCXJlbW92ZTogZnVuY3Rpb24gKCB0d2VlbiApIHsKCgkJdmFyIGkgPSB0aGlzLl90d2VlbnMuaW5kZXhPZiggdHdlZW4gKTsKCgkJaWYgKCBpICE9PSAtMSApIHsKCgkJCXRoaXMuX3R3ZWVuc1tpXS5wZW5kaW5nRGVsZXRlID0gdHJ1ZTsKCgkJfQoKCX0sCgoJLyoqCgkqIFVwZGF0ZSBhbGwgdGhlIHR3ZWVuIG9iamVjdHMgeW91IGFkZGVkIHRvIHRoaXMgbWFuYWdlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3VwZGF0ZQoJKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJuIGZhbHNlIGlmIHRoZXJlJ3Mgbm8gdHdlZW4gdG8gdXBkYXRlLCBvdGhlcndpc2UgcmV0dXJuIHRydWUuCgkqLwoJdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgoJCWlmICggdGhpcy5fdHdlZW5zLmxlbmd0aCA9PT0gMCAmJiB0aGlzLl9hZGQubGVuZ3RoID09PSAwICkgcmV0dXJuIGZhbHNlOwoKCQl2YXIgaSA9IDA7CgkJdmFyIG51bVR3ZWVucyA9IHRoaXMuX3R3ZWVucy5sZW5ndGg7CgoJCXdoaWxlICggaSA8IG51bVR3ZWVucyApIHsKCgkJCWlmICggdGhpcy5fdHdlZW5zWyBpIF0udXBkYXRlKCB0aGlzLmdhbWUudGltZS5ub3cgKSApIHsKCgkJCQlpKys7CgoJCQl9IGVsc2UgewoKCQkJCXRoaXMuX3R3ZWVucy5zcGxpY2UoIGksIDEgKTsKCgkJCQludW1Ud2VlbnMtLTsKCgkJCX0KCgkJfQoKCQkvLwlJZiB0aGVyZSBhcmUgYW55IG5ldyB0d2VlbnMgdG8gYmUgYWRkZWQsIGRvIHNvIG5vdyAtIG90aGVyd2lzZSB0aGV5IGNhbiBiZSBzcGxpY2VkIG91dCBvZiB0aGUgYXJyYXkgYmVmb3JlIGV2ZXIgcnVubmluZwoJCWlmICh0aGlzLl9hZGQubGVuZ3RoID4gMCkKCQl7CgkJCXRoaXMuX3R3ZWVucyA9IHRoaXMuX3R3ZWVucy5jb25jYXQodGhpcy5fYWRkKTsKCQkJdGhpcy5fYWRkLmxlbmd0aCA9IDA7CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCgl9LAoKCS8qKgoJKiBDaGVja3MgdG8gc2VlIGlmIGEgcGFydGljdWxhciBTcHJpdGUgaXMgY3VycmVudGx5IGJlaW5nIHR3ZWVuZWQuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNpc1R3ZWVuaW5nCgkqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgLSBUaGUgb2JqZWN0IHRvIGNoZWNrIGZvciB0d2VlbnMgYWdhaW5zdC4KCSogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIGN1cnJlbnRseSBiZWluZyB0d2VlbmVkLCBmYWxzZSBpZiBub3QuCgkqLwoJaXNUd2VlbmluZzogZnVuY3Rpb24ob2JqZWN0KSB7CQoKCQlyZXR1cm4gdGhpcy5fdHdlZW5zLnNvbWUoZnVuY3Rpb24odHdlZW4pIHsKCQkJcmV0dXJuIHR3ZWVuLl9vYmplY3QgPT09IG9iamVjdDsKCQl9KTsKCgl9LAoKCS8qKgoJKiBQYXVzZXMgYWxsIGN1cnJlbnRseSBydW5uaW5nIHR3ZWVucy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3VwZGF0ZQoJKi8KCXBhdXNlQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgCWZvciAodmFyIGkgPSB0aGlzLl90d2VlbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIAkJdGhpcy5fdHdlZW5zW2ldLnBhdXNlKCk7CiAgICAJfTsKCiAgICB9LAoKCS8qKgoJKiBQYXVzZXMgYWxsIGN1cnJlbnRseSBwYXVzZWQgdHdlZW5zLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjcmVzdW1lQWxsCgkqLwogICAJcmVzdW1lQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgCWZvciAodmFyIGkgPSB0aGlzLl90d2VlbnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIAkJdGhpcy5fdHdlZW5zW2ldLnJlc3VtZSgpOwogICAgCX07CgogICAgfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVHdlZW4gY29uc3RydWN0b3IKKiBDcmVhdGUgYSBuZXcgPGNvZGU+VHdlZW48L2NvZGU+LgoqCiogQGNsYXNzIFBoYXNlci5Ud2VlbgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7b2JqZWN0fSBvYmplY3QgLSBUYXJnZXQgb2JqZWN0IHdpbGwgYmUgYWZmZWN0ZWQgYnkgdGhpcyB0d2Vlbi4KKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuVHdlZW4gPSBmdW5jdGlvbiAob2JqZWN0LCBnYW1lKSB7CgogICAgLyoqCiAgICAqIFJlZmVyZW5jZSB0byB0aGUgdGFyZ2V0IG9iamVjdC4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9vYmplY3QKICAgICogQHByaXZhdGUKICAgICovCgl0aGlzLl9vYmplY3QgPSBvYmplY3Q7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX21hbmFnZXIgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9tYW5hZ2VyID0gdGhpcy5nYW1lLnR3ZWVuczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNTdGFydCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZhbHVlc1N0YXJ0ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdmFsdWVzRW5kIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdmFsdWVzRW5kID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdmFsdWVzU3RhcnRSZXBlYXQgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdCA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R1cmF0aW9uIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZHVyYXRpb24gPSAxMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3JlcGVhdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3JlcGVhdCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3lveW8gLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl95b3lvID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3JldmVyc2VkIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcmV2ZXJzZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kZWxheVRpbWUgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9kZWxheVRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfc3RhcnRUaW1lIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IG51bGwKICAgICovCiAgICB0aGlzLl9zdGFydFRpbWUgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfZWFzaW5nRnVuY3Rpb24gLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9lYXNpbmdGdW5jdGlvbiA9IFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9pbnRlcnBvbGF0aW9uRnVuY3Rpb24gLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9pbnRlcnBvbGF0aW9uRnVuY3Rpb24gPSBQaGFzZXIuTWF0aC5saW5lYXJJbnRlcnBvbGF0aW9uOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfY2hhaW5lZFR3ZWVucyAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NoYWluZWRUd2VlbnMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX29uU3RhcnRDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uU3RhcnRDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX29uU3RhcnRDYWxsYmFja0ZpcmVkIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25TdGFydENhbGxiYWNrRmlyZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX29uVXBkYXRlQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgbnVsbAogICAgKi8KICAgIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfb25Db21wbGV0ZUNhbGxiYWNrIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IG51bGwKICAgICovCiAgICB0aGlzLl9vbkNvbXBsZXRlQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9wYXVzZWRUaW1lIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcGF1c2VkVGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGVuZGluZ0RlbGV0ZSAtIElmIHRoaXMgdHdlZW4gaXMgcmVhZHkgdG8gYmUgZGVsZXRlZCBieSB0aGUgVHdlZW5NYW5hZ2VyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGVuZGluZ0RlbGV0ZSA9IGZhbHNlOwoKICAgIC8vIFNldCBhbGwgc3RhcnRpbmcgdmFsdWVzIHByZXNlbnQgb24gdGhlIHRhcmdldCBvYmplY3QKICAgIGZvciAoIHZhciBmaWVsZCBpbiBvYmplY3QgKSB7CiAgICAJdGhpcy5fdmFsdWVzU3RhcnRbIGZpZWxkIF0gPSBwYXJzZUZsb2F0KG9iamVjdFtmaWVsZF0sIDEwKTsKICAgIH0KICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25TdGFydCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMub25TdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Db21wbGV0ZSAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMub25Db21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNSdW5uaW5nIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCn07CgpQaGFzZXIuVHdlZW4ucHJvdG90eXBlID0gewoKCS8qKgoJKiBDb25maWd1cmUgdGhlIFR3ZWVuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3RvCgkqIEBwYXJhbSB7b2JqZWN0fSBwcm9wZXJ0aWVzIC0gUHJvcGVydGllcyB5b3Ugd2FudCB0byB0d2Vlbi4KCSogQHBhcmFtIHtudW1iZXJ9IGR1cmF0aW9uIC0gRHVyYXRpb24gb2YgdGhpcyB0d2Vlbi4KCSogQHBhcmFtIHtmdW5jdGlvbn0gZWFzZSAtIEVhc2luZyBmdW5jdGlvbi4KCSogQHBhcmFtIHtib29sZWFufSBhdXRvU3RhcnQgLSBXaGV0aGVyIHRoaXMgdHdlZW4gd2lsbCBzdGFydCBhdXRvbWF0aWNhbGx5IG9yIG5vdC4KCSogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gRGVsYXkgYmVmb3JlIHRoaXMgdHdlZW4gd2lsbCBzdGFydCwgZGVmYXVsdHMgdG8gMCAobm8gZGVsYXkpLgoJKiBAcGFyYW0ge2Jvb2xlYW59IHJlcGVhdCAtIFNob3VsZCB0aGUgdHdlZW4gYXV0b21hdGljYWxseSByZXN0YXJ0IG9uY2UgY29tcGxldGU/IChpZ25vcmVzIGFueSBjaGFpbmVkIHR3ZWVucykuCgkqIEBwYXJhbSB7UGhhc2VyLlR3ZWVufSB5b3lvIC0gRGVzY3JpcHRpb24uCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCXRvOiBmdW5jdGlvbiAoIHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBhdXRvU3RhcnQsIGRlbGF5LCByZXBlYXQsIHlveW8gKSB7CgoJCWR1cmF0aW9uID0gZHVyYXRpb24gfHwgMTAwMDsKCQllYXNlID0gZWFzZSB8fCBudWxsOwoJCWF1dG9TdGFydCA9IGF1dG9TdGFydCB8fCBmYWxzZTsKCQlkZWxheSA9IGRlbGF5IHx8IDA7CgkJcmVwZWF0ID0gcmVwZWF0IHx8IDA7CgkJeW95byA9IHlveW8gfHwgZmFsc2U7CgoJCXZhciBzZWxmOwoJCWlmICh0aGlzLl9wYXJlbnQpCgkJewoJCQlzZWxmID0gdGhpcy5fbWFuYWdlci5jcmVhdGUodGhpcy5fb2JqZWN0KTsKCQkJdGhpcy5fbGFzdENoaWxkLmNoYWluKHNlbGYpOwoJCQl0aGlzLl9sYXN0Q2hpbGQgPSBzZWxmOwoJCX0KCQllbHNlCgkJewoJCQlzZWxmID0gdGhpczsKCQkJdGhpcy5fcGFyZW50ID0gdGhpczsKCQkJdGhpcy5fbGFzdENoaWxkID0gdGhpczsKCQl9CgoJCXNlbGYuX3JlcGVhdCA9IHJlcGVhdDsKICAgICAgICBzZWxmLl9kdXJhdGlvbiA9IGR1cmF0aW9uOwoJCXNlbGYuX3ZhbHVlc0VuZCA9IHByb3BlcnRpZXM7CgogICAgICAgIGlmIChlYXNlICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgc2VsZi5fZWFzaW5nRnVuY3Rpb24gPSBlYXNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKGRlbGF5ID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHNlbGYuX2RlbGF5VGltZSA9IGRlbGF5OwogICAgICAgIH0KCiAgICAgICAgc2VsZi5feW95byA9IHlveW87CgogICAgICAgIGlmIChhdXRvU3RhcnQpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc3RhcnQoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICB9CgoJfSwKCgkvKioKCSogU3RhcnRzIHRoZSB0d2VlbiBydW5uaW5nLiBDYW4gYWxzbyBiZSBjYWxsZWQgYnkgdGhlIGF1dG9TdGFydCBwYXJhbWV0ZXIgb2YgVHdlZW4udG8uCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3N0YXJ0CgkqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gRGVzY3JpcHRpb24uCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCXN0YXJ0OiBmdW5jdGlvbiAoIHRpbWUgKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUgPT09IG51bGwgfHwgdGhpcy5fb2JqZWN0ID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgoJCXRoaXMuX21hbmFnZXIuYWRkKHRoaXMpOwoKCQl0aGlzLm9uU3RhcnQuZGlzcGF0Y2godGhpcy5fb2JqZWN0KTsKCiAgICAgICAgdGhpcy5pc1J1bm5pbmcgPSB0cnVlOwoKCQl0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLl9zdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLl9kZWxheVRpbWU7CgoJCWZvciAoIHZhciBwcm9wZXJ0eSBpbiB0aGlzLl92YWx1ZXNFbmQgKSB7CgoJCQkvLyBjaGVjayBpZiBhbiBBcnJheSB3YXMgcHJvdmlkZWQgYXMgcHJvcGVydHkgdmFsdWUKCQkJaWYgKCB0aGlzLl92YWx1ZXNFbmRbIHByb3BlcnR5IF0gaW5zdGFuY2VvZiBBcnJheSApIHsKCgkJCQlpZiAoIHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXS5sZW5ndGggPT09IDAgKSB7CgoJCQkJCWNvbnRpbnVlOwoKCQkJCX0KCgkJCQkvLyBjcmVhdGUgYSBsb2NhbCBjb3B5IG9mIHRoZSBBcnJheSB3aXRoIHRoZSBzdGFydCB2YWx1ZSBhdCB0aGUgZnJvbnQKCQkJCXRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXSA9IFsgdGhpcy5fb2JqZWN0WyBwcm9wZXJ0eSBdIF0uY29uY2F0KCB0aGlzLl92YWx1ZXNFbmRbIHByb3BlcnR5IF0gKTsKCgkJCX0KCgkJCXRoaXMuX3ZhbHVlc1N0YXJ0WyBwcm9wZXJ0eSBdID0gdGhpcy5fb2JqZWN0WyBwcm9wZXJ0eSBdOwoKCQkJaWYgKCAoIHRoaXMuX3ZhbHVlc1N0YXJ0WyBwcm9wZXJ0eSBdIGluc3RhbmNlb2YgQXJyYXkgKSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl92YWx1ZXNTdGFydFsgcHJvcGVydHkgXSAqPSAxLjA7IC8vIEVuc3VyZXMgd2UncmUgdXNpbmcgbnVtYmVycywgbm90IHN0cmluZ3MKCQkJfQoKCQkJdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbIHByb3BlcnR5IF0gPSB0aGlzLl92YWx1ZXNTdGFydFsgcHJvcGVydHkgXSB8fCAwOwoKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFN0b3BzIHRoZSB0d2VlbiBpZiBydW5uaW5nIGFuZCByZW1vdmVzIGl0IGZyb20gdGhlIFR3ZWVuTWFuYWdlci4gSWYgdGhlcmUgYXJlIGFueSBvbkNvbXBsZXRlIGNhbGxiYWNrcyBvciBldmVudHMgdGhleSBhcmUgbm90IGRpc3BhdGNoZWQuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3N0b3AKCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwoKCQl0aGlzLl9tYW5hZ2VyLnJlbW92ZSh0aGlzKTsKCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0cyBhIGRlbGF5IHRpbWUgYmVmb3JlIHRoaXMgdHdlZW4gd2lsbCBzdGFydC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jZGVsYXkKCSogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgb2YgdGhlIGRlbGF5IGluIG1zLgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglkZWxheTogZnVuY3Rpb24gKCBhbW91bnQgKSB7CgoJCXRoaXMuX2RlbGF5VGltZSA9IGFtb3VudDsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIHRoZSBudW1iZXIgb2YgdGltZXMgdGhpcyB0d2VlbiB3aWxsIHJlcGVhdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jcmVwZWF0CgkqIEBwYXJhbSB7bnVtYmVyfSB0aW1lcyAtIEhvdyBtYW55IHRpbWVzIHRvIHJlcGVhdC4KCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJcmVwZWF0OiBmdW5jdGlvbiAoIHRpbWVzICkgewoKCQl0aGlzLl9yZXBlYXQgPSB0aW1lczsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBBIHR3ZWVuIHRoYXQgaGFzIHlveW8gc2V0IHRvIHRydWUgd2lsbCBydW4gdGhyb3VnaCBmcm9tIHN0YXJ0IHRvIGZpbmlzaCwgdGhlbiByZXZlcnNlIGZyb20gZmluaXNoIHRvIHN0YXJ0LgoJKiBVc2VkIGluIGNvbWJpbmF0aW9uIHdpdGggcmVwZWF0IHlvdSBjYW4gY3JlYXRlIGVuZGxlc3MgbG9vcHMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3lveW8KCSogQHBhcmFtIHtib29sZWFufSB5b3lvIC0gU2V0IHRvIHRydWUgdG8geW95byB0aGlzIHR3ZWVuLgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCgl5b3lvOiBmdW5jdGlvbiggeW95byApIHsKCgkJdGhpcy5feW95byA9IHlveW87CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0IGVhc2luZyBmdW5jdGlvbiB0aGlzIHR3ZWVuIHdpbGwgdXNlLCBpLmUuIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUuIAoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNlYXNpbmcKCSogQHBhcmFtIHtmdW5jdGlvbn0gZWFzaW5nIC0gVGhlIGVhc2luZyBmdW5jdGlvbiB0aGlzIHR3ZWVuIHdpbGwgdXNlLCBpLmUuIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUuCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCWVhc2luZzogZnVuY3Rpb24gKCBlYXNpbmcgKSB7CgoJCXRoaXMuX2Vhc2luZ0Z1bmN0aW9uID0gZWFzaW5nOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldCBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHRoZSB0d2VlbiB3aWxsIHVzZSwgYnkgZGVmYXVsdCBpdCB1c2VzIFBoYXNlci5NYXRoLmxpbmVhckludGVycG9sYXRpb24uCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2ludGVycG9sYXRpb24KCSogQHBhcmFtIHtmdW5jdGlvbn0gaW50ZXJwb2xhdGlvbiAtIFRoZSBpbnRlcnBvbGF0aW9uIGZ1bmN0aW9uIHRvIHVzZSAoUGhhc2VyLk1hdGgubGluZWFySW50ZXJwb2xhdGlvbiBieSBkZWZhdWx0KQoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglpbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAoIGludGVycG9sYXRpb24gKSB7CgoJCXRoaXMuX2ludGVycG9sYXRpb25GdW5jdGlvbiA9IGludGVycG9sYXRpb247CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogWW91IGNhbiBjaGFpbiB0d2VlbnMgdG9nZXRoZXIgYnkgcGFzc2luZyBhIHJlZmVyZW5jZSB0byB0aGUgY2hhaW4gZnVuY3Rpb24uIFRoaXMgZW5hYmxlcyBvbmUgdHdlZW4gdG8gY2FsbCBhbm90aGVyIG9uIGNvbXBsZXRpb24uCgkqIFlvdSBjYW4gcGFzcyBhcyBtYW55IHR3ZWVucyBhcyB5b3UgbGlrZSB0byB0aGlzIGZ1bmN0aW9uLCB0aGV5IHdpbGwgZWFjaCBiZSBjaGFpbmVkIGluIHNlcXVlbmNlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNjaGFpbgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCgljaGFpbjogZnVuY3Rpb24gKCkgewoKCQl0aGlzLl9jaGFpbmVkVHdlZW5zID0gYXJndW1lbnRzOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIExvb3AgYSBjaGFpbiBvZiB0d2VlbnMKCSogCgkqIFVzYWdlOgoJKiBnYW1lLmFkZC50d2VlbihwKS50byh7IHg6IDcwMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lLCB0cnVlKQoJKiAudG8oeyB5OiAzMDAgfSwgMTAwMCwgUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZSkKCSogLnRvKHsgeDogMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lKQoJKiAudG8oeyB5OiAwIH0sIDEwMDAsIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUpCgkqIC5sb29wKCk7CgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2xvb3AKCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJbG9vcDogZnVuY3Rpb24oKSB7CgoJCXRoaXMuX2xhc3RDaGlsZC5jaGFpbih0aGlzKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIGEgY2FsbGJhY2sgdG8gYmUgZmlyZWQgd2hlbiB0aGUgdHdlZW4gc3RhcnRzLiBOb3RlOiBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpbiB0aGUgY29udGV4dCBvZiB0aGUgZ2xvYmFsIHNjb3BlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNvblN0YXJ0Q2FsbGJhY2sKCSogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdG8gaW52b2tlIG9uIHN0YXJ0LgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglvblN0YXJ0Q2FsbGJhY2s6IGZ1bmN0aW9uICggY2FsbGJhY2sgKSB7CgoJCXRoaXMuX29uU3RhcnRDYWxsYmFjayA9IGNhbGxiYWNrOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldHMgYSBjYWxsYmFjayB0byBiZSBmaXJlZCBlYWNoIHRpbWUgdGhpcyB0d2VlbiB1cGRhdGVzLiBOb3RlOiBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpbiB0aGUgY29udGV4dCBvZiB0aGUgZ2xvYmFsIHNjb3BlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNvblVwZGF0ZUNhbGxiYWNrCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRvIGludm9rZSBlYWNoIHRpbWUgdGhpcyB0d2VlbiBpcyB1cGRhdGVkLgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglvblVwZGF0ZUNhbGxiYWNrOiBmdW5jdGlvbiAoIGNhbGxiYWNrICkgewoKCQl0aGlzLl9vblVwZGF0ZUNhbGxiYWNrID0gY2FsbGJhY2s7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0cyBhIGNhbGxiYWNrIHRvIGJlIGZpcmVkIHdoZW4gdGhlIHR3ZWVuIGNvbXBsZXRlcy4gTm90ZTogY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgaW4gdGhlIGNvbnRleHQgb2YgdGhlIGdsb2JhbCBzY29wZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jb25Db21wbGV0ZUNhbGxiYWNrCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGNhbGxiYWNrIHRvIGludm9rZSBvbiBjb21wbGV0aW9uLgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglvbkNvbXBsZXRlQ2FsbGJhY2s6IGZ1bmN0aW9uICggY2FsbGJhY2sgKSB7CgoJCXRoaXMuX29uQ29tcGxldGVDYWxsYmFjayA9IGNhbGxiYWNrOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFBhdXNlcyB0aGUgdHdlZW4uIAoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNwYXVzZQoJKi8KICAgIHBhdXNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fcGF1c2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9wYXVzZWRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgfSwKCgkvKioKCSogUmVzdW1lcyBhIHBhdXNlZCB0d2Vlbi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jcmVzdW1lCgkqLwogICAgcmVzdW1lOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fcGF1c2VkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fc3RhcnRUaW1lICs9ICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wYXVzZWRUaW1lKTsKICAgIH0sCgoJLyoqCgkqIENvcmUgdHdlZW4gdXBkYXRlIGZ1bmN0aW9uIGNhbGxlZCBieSB0aGUgVHdlZW5NYW5hZ2VyLiBEb2VzIG5vdCBuZWVkIHRvIGJlIGludm9rZWQgZGlyZWN0bHkuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3VwZGF0ZQoJKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIEEgdGltZXN0YW1wIHBhc3NlZCBpbiBieSB0aGUgVHdlZW5NYW5hZ2VyLgoJKiBAcmV0dXJuIHtib29sZWFufSBmYWxzZSBpZiB0aGUgdHdlZW4gaGFzIGNvbXBsZXRlZCBhbmQgc2hvdWxkIGJlIGRlbGV0ZWQgZnJvbSB0aGUgbWFuYWdlciwgb3RoZXJ3aXNlIHRydWUgKHN0aWxsIGFjdGl2ZSkuCgkqLwoJdXBkYXRlOiBmdW5jdGlvbiAoIHRpbWUgKSB7CgoJCWlmICh0aGlzLnBlbmRpbmdEZWxldGUpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKICAgICAgICBpZiAodGhpcy5fcGF1c2VkIHx8IHRpbWUgPCB0aGlzLl9zdGFydFRpbWUpIHsKCiAgICAgICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgICB9CgoJCXZhciBwcm9wZXJ0eTsKCgkJaWYgKCB0aW1lIDwgdGhpcy5fc3RhcnRUaW1lICkgewoKCQkJcmV0dXJuIHRydWU7CgoJCX0KCgkJaWYgKCB0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9PT0gZmFsc2UgKSB7CgoJCQlpZiAoIHRoaXMuX29uU3RhcnRDYWxsYmFjayAhPT0gbnVsbCApIHsKCgkJCQl0aGlzLl9vblN0YXJ0Q2FsbGJhY2suY2FsbCggdGhpcy5fb2JqZWN0ICk7CgoJCQl9CgoJCQl0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9IHRydWU7CgoJCX0KCgkJdmFyIGVsYXBzZWQgPSAoIHRpbWUgLSB0aGlzLl9zdGFydFRpbWUgKSAvIHRoaXMuX2R1cmF0aW9uOwoJCWVsYXBzZWQgPSBlbGFwc2VkID4gMSA/IDEgOiBlbGFwc2VkOwoKCQl2YXIgdmFsdWUgPSB0aGlzLl9lYXNpbmdGdW5jdGlvbiggZWxhcHNlZCApOwoKCQlmb3IgKCBwcm9wZXJ0eSBpbiB0aGlzLl92YWx1ZXNFbmQgKSB7CgoJCQl2YXIgc3RhcnQgPSB0aGlzLl92YWx1ZXNTdGFydFsgcHJvcGVydHkgXSB8fCAwOwoJCQl2YXIgZW5kID0gdGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdOwoKCQkJaWYgKCBlbmQgaW5zdGFuY2VvZiBBcnJheSApIHsKCgkJCQl0aGlzLl9vYmplY3RbIHByb3BlcnR5IF0gPSB0aGlzLl9pbnRlcnBvbGF0aW9uRnVuY3Rpb24oIGVuZCwgdmFsdWUgKTsKCgkJCX0gZWxzZSB7CgogICAgICAgICAgICAgICAgLy8gUGFyc2VzIHJlbGF0aXZlIGVuZCB2YWx1ZXMgd2l0aCBzdGFydCBhcyBiYXNlIChlLmcuOiArMTAsIC0zKQoJCQkJaWYgKCB0eXBlb2YoZW5kKSA9PT0gInN0cmluZyIgKSB7CgkJCQkJZW5kID0gc3RhcnQgKyBwYXJzZUZsb2F0KGVuZCwgMTApOwoJCQkJfQoKCQkJCS8vIHByb3RlY3QgYWdhaW5zdCBub24gbnVtZXJpYyBwcm9wZXJ0aWVzLgogICAgICAgICAgICAgICAgaWYgKCB0eXBlb2YoZW5kKSA9PT0gIm51bWJlciIgKSB7CgkJCQkJdGhpcy5fb2JqZWN0WyBwcm9wZXJ0eSBdID0gc3RhcnQgKyAoIGVuZCAtIHN0YXJ0ICkgKiB2YWx1ZTsKCQkJCX0KCgkJCX0KCgkJfQoKCQlpZiAoIHRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgIT09IG51bGwgKSB7CgoJCQl0aGlzLl9vblVwZGF0ZUNhbGxiYWNrLmNhbGwoIHRoaXMuX29iamVjdCwgdmFsdWUgKTsKCgkJfQoKCQlpZiAoIGVsYXBzZWQgPT0gMSApIHsKCgkJCWlmICggdGhpcy5fcmVwZWF0ID4gMCApIHsKCgkJCQlpZiAoIGlzRmluaXRlKCB0aGlzLl9yZXBlYXQgKSApIHsKCQkJCQl0aGlzLl9yZXBlYXQtLTsKCQkJCX0KCgkJCQkvLyByZWFzc2lnbiBzdGFydGluZyB2YWx1ZXMsIHJlc3RhcnQgYnkgbWFraW5nIHN0YXJ0VGltZSA9IG5vdwoJCQkJZm9yICggcHJvcGVydHkgaW4gdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXQgKSB7CgoJCQkJCWlmICggdHlwZW9mKCB0aGlzLl92YWx1ZXNFbmRbIHByb3BlcnR5IF0gKSA9PT0gInN0cmluZyIgKSB7CgkJCQkJCXRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0WyBwcm9wZXJ0eSBdID0gdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbIHByb3BlcnR5IF0gKyBwYXJzZUZsb2F0KHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXSwgMTApOwoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3lveW8pIHsKCQkJCQkJdmFyIHRtcCA9IHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0WyBwcm9wZXJ0eSBdOwoJCQkJCQl0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFsgcHJvcGVydHkgXSA9IHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXTsKCQkJCQkJdGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdID0gdG1wOwoJCQkJCQl0aGlzLl9yZXZlcnNlZCA9ICF0aGlzLl9yZXZlcnNlZDsKCQkJCQl9CgkJCQkJdGhpcy5fdmFsdWVzU3RhcnRbIHByb3BlcnR5IF0gPSB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFsgcHJvcGVydHkgXTsKCgkJCQl9CgoJCQkJdGhpcy5fc3RhcnRUaW1lID0gdGltZSArIHRoaXMuX2RlbGF5VGltZTsKCgkJCQl0aGlzLm9uQ29tcGxldGUuZGlzcGF0Y2godGhpcy5fb2JqZWN0KTsKCgkJCQlpZiAoIHRoaXMuX29uQ29tcGxldGVDYWxsYmFjayAhPT0gbnVsbCApIHsKCQkJCQl0aGlzLl9vbkNvbXBsZXRlQ2FsbGJhY2suY2FsbCggdGhpcy5fb2JqZWN0ICk7CgkJCQl9CgoJCQkJcmV0dXJuIHRydWU7CgoJCQl9IGVsc2UgewoKCQkJCXRoaXMub25Db21wbGV0ZS5kaXNwYXRjaCh0aGlzLl9vYmplY3QpOwoKCQkJCWlmICggdGhpcy5fb25Db21wbGV0ZUNhbGxiYWNrICE9PSBudWxsICkgewoJCQkJCXRoaXMuX29uQ29tcGxldGVDYWxsYmFjay5jYWxsKCB0aGlzLl9vYmplY3QgKTsKCQkJCX0KCgkJCQlmb3IgKCB2YXIgaSA9IDAsIG51bUNoYWluZWRUd2VlbnMgPSB0aGlzLl9jaGFpbmVkVHdlZW5zLmxlbmd0aDsgaSA8IG51bUNoYWluZWRUd2VlbnM7IGkgKysgKSB7CgoJCQkJCXRoaXMuX2NoYWluZWRUd2VlbnNbIGkgXS5zdGFydCggdGltZSApOwoKCQkJCX0KCgkJCQlyZXR1cm4gZmFsc2U7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfQoJCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgZWFzaW5nIG1ldGhvZHMgZGVmaW5pbmcgZWFzZS1pbiBlYXNlLW91dCBjdXJ2ZXMuCioKKiBAY2xhc3MgUGhhc2VyLkVhc2luZwoqLwpQaGFzZXIuRWFzaW5nID0gewoKICAgIC8qKgogICAgKiBMaW5lYXIgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5MaW5lYXIKICAgICovCglMaW5lYXI6IHsKCgkJLyoqCgkJKiBFYXNlLWluLgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5MaW5lYXIjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLgoJCSogQHJldHVybnMge251bWJlcn0ga14yLgoJCSovCgkJTm9uZTogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGs7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBRdWFkcmF0aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5RdWFkcmF0aWMKICAgICovCglRdWFkcmF0aWM6IHsKCgkJLyoqCgkJKiBFYXNlLWluLgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFkcmF0aWMjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IGteMi4KCQkqLwoJCUluOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gayAqIGs7CgoJCX0sCgoJCS8qKgoJCSogRWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYyNPdXQgCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IGsqICgyLWspLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gayAqICggMiAtIGsgKTsKCgkJfSwKCgkJLyoqCgkJKiBFYXNlLWluL291dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhZHJhdGljI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogayAqIGs7CgkJCXJldHVybiAtIDAuNSAqICggLS1rICogKCBrIC0gMiApIC0gMSApOwoKCQl9CgoJfSwKCiAgICAvKioKICAgICogQ3ViaWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5DdWJpYwogICAgKi8KCUN1YmljOiB7CgoJCS8qKgoJCSogQ3ViaWMgZWFzZS1pbi4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ3ViaWMjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiBrICogayAqIGs7CgoJCX0sCgoJCS8qKgoJCSogQ3ViaWMgZWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkN1YmljI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIC0tayAqIGsgKiBrICsgMTsKCgkJfSwKCgkJLyoqCgkJKiBDdWJpYyBlYXNlLWluL291dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ3ViaWMjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBrICogayAqIGs7CgkJCXJldHVybiAwLjUgKiAoICggayAtPSAyICkgKiBrICogayArIDIgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIFF1YXJ0aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5RdWFydGljCiAgICAqLwoJUXVhcnRpYzogewoKCQkvKioKCQkqIFF1YXJ0aWMgZWFzZS1pbi4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhcnRpYyNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGsgKiBrICogayAqIGs7CgoJCX0sCgoJCS8qKgoJCSogUXVhcnRpYyBlYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhcnRpYyNPdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiAxIC0gKCAtLWsgKiBrICogayAqIGsgKTsKCgkJfSwKCgkJLyoqCgkJKiBRdWFydGljIGVhc2UtaW4vb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFydGljI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggKCBrICo9IDIgKSA8IDEpIHJldHVybiAwLjUgKiBrICogayAqIGsgKiBrOwoJCQlyZXR1cm4gLSAwLjUgKiAoICggayAtPSAyICkgKiBrICogayAqIGsgLSAyICk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBRdWludGljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuUXVpbnRpYwogICAgKi8KCVF1aW50aWM6IHsKCgkJLyoqCgkJKiBRdWludGljIGVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1aW50aWMjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiBrICogayAqIGsgKiBrICogazsKCgkJfSwKCgkJLyoqCgkJKiBRdWludGljIGVhc2Utb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWludGljI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIC0tayAqIGsgKiBrICogayAqIGsgKyAxOwoKCQl9LAoKCQkvKioKCQkqIFF1aW50aWMgZWFzZS1pbi9vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1aW50aWMjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBrICogayAqIGsgKiBrICogazsKCQkJcmV0dXJuIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiBrICogayAqIGsgKyAyICk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBTaW51c29pZGFsIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbAogICAgKi8KCVNpbnVzb2lkYWw6IHsKCgkJLyoqCgkJKiBTaW51c29pZGFsIGVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlNpbnVzb2lkYWwjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiAxIC0gTWF0aC5jb3MoIGsgKiBNYXRoLlBJIC8gMiApOwoKCQl9LAoKCQkvKioKCQkqIFNpbnVzb2lkYWwgZWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlNpbnVzb2lkYWwjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gTWF0aC5zaW4oIGsgKiBNYXRoLlBJIC8gMiApOwoKCQl9LAoKCQkvKioKCQkqIFNpbnVzb2lkYWwgZWFzZS1pbi9vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlNpbnVzb2lkYWwjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIDAuNSAqICggMSAtIE1hdGguY29zKCBNYXRoLlBJICogayApICk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBFeHBvbmVudGlhbCBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsCiAgICAqLwoJRXhwb25lbnRpYWw6IHsKCgkJLyoqCgkJKiBFeHBvbmVudGlhbCBlYXNlLWluLgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FeHBvbmVudGlhbCNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGsgPT09IDAgPyAwIDogTWF0aC5wb3coIDEwMjQsIGsgLSAxICk7CgoJCX0sCgoJCS8qKgoJCSogRXhwb25lbnRpYWwgZWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGsgPT09IDEgPyAxIDogMSAtIE1hdGgucG93KCAyLCAtIDEwICogayApOwoKCQl9LAoKCQkvKioKCQkqIEV4cG9uZW50aWFsIGVhc2UtaW4vb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FeHBvbmVudGlhbCNJbk91dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKCQkJaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CgkJCWlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogTWF0aC5wb3coIDEwMjQsIGsgLSAxICk7CgkJCXJldHVybiAwLjUgKiAoIC0gTWF0aC5wb3coIDIsIC0gMTAgKiAoIGsgLSAxICkgKSArIDIgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIENpcmN1bGFyIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIKICAgICovCglDaXJjdWxhcjogewoKCQkvKioKCQkqIENpcmN1bGFyIGVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkNpcmN1bGFyI0luIAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gMSAtIE1hdGguc3FydCggMSAtIGsgKiBrICk7CgoJCX0sCgoJCS8qKgoJCSogQ2lyY3VsYXIgZWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkNpcmN1bGFyI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIE1hdGguc3FydCggMSAtICggLS1rICogayApICk7CgoJCX0sCgoJCS8qKgoJCSogQ2lyY3VsYXIgZWFzZS1pbi9vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkNpcmN1bGFyI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggKCBrICo9IDIgKSA8IDEpIHJldHVybiAtIDAuNSAqICggTWF0aC5zcXJ0KCAxIC0gayAqIGspIC0gMSk7CgkJCXJldHVybiAwLjUgKiAoIE1hdGguc3FydCggMSAtICggayAtPSAyKSAqIGspICsgMSk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBFbGFzdGljIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuRWxhc3RpYwogICAgKi8KCUVsYXN0aWM6IHsKCgkJLyoqCgkJKiBFbGFzdGljIGVhc2UtaW4uCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkVsYXN0aWMjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzLCBhID0gMC4xLCBwID0gMC40OwoJCQlpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKCQkJaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CgkJCWlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KCQkJZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKCQkJcmV0dXJuIC0gKCBhICogTWF0aC5wb3coIDIsIDEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSApOwoKCQl9LAoKCQkvKioKCQkqIEVsYXN0aWMgZWFzZS1vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkVsYXN0aWMjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQl2YXIgcywgYSA9IDAuMSwgcCA9IDAuNDsKCQkJaWYgKCBrID09PSAwICkgcmV0dXJuIDA7CgkJCWlmICggayA9PT0gMSApIHJldHVybiAxOwoJCQlpZiAoICFhIHx8IGEgPCAxICkgeyBhID0gMTsgcyA9IHAgLyA0OyB9CgkJCWVsc2UgcyA9IHAgKiBNYXRoLmFzaW4oIDEgLyBhICkgLyAoIDIgKiBNYXRoLlBJICk7CgkJCXJldHVybiAoIGEgKiBNYXRoLnBvdyggMiwgLSAxMCAqIGspICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSArIDEgKTsKCgkJfSwKCgkJLyoqCgkJKiBFbGFzdGljIGVhc2UtaW4vb3V0LgogICAgICAgICoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5FbGFzdGljI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzLCBhID0gMC4xLCBwID0gMC40OwoJCQlpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKCQkJaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CgkJCWlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KCQkJZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAtIDAuNSAqICggYSAqIE1hdGgucG93KCAyLCAxMCAqICggayAtPSAxICkgKSAqIE1hdGguc2luKCAoIGsgLSBzICkgKiAoIDIgKiBNYXRoLlBJICkgLyBwICkgKTsKCQkJcmV0dXJuIGEgKiBNYXRoLnBvdyggMiwgLTEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSAqIDAuNSArIDE7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBCYWNrIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuQmFjawogICAgKi8KCUJhY2s6IHsKCgkJLyoqCgkJKiBCYWNrIGVhc2UtaW4uCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJhY2sjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzID0gMS43MDE1ODsKCQkJcmV0dXJuIGsgKiBrICogKCAoIHMgKyAxICkgKiBrIC0gcyApOwoKCQl9LAoKCQkvKioKCQkqIEJhY2sgZWFzZS1vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJhY2sjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQl2YXIgcyA9IDEuNzAxNTg7CgkJCXJldHVybiAtLWsgKiBrICogKCAoIHMgKyAxICkgKiBrICsgcyApICsgMTsKCgkJfSwKCgkJLyoqCgkJKiBCYWNrIGVhc2UtaW4vb3V0LgogICAgICAgICoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5CYWNrI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzID0gMS43MDE1OCAqIDEuNTI1OwoJCQlpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqICggayAqIGsgKiAoICggcyArIDEgKSAqIGsgLSBzICkgKTsKCQkJcmV0dXJuIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiAoICggcyArIDEgKSAqIGsgKyBzICkgKyAyICk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBCb3VuY2UgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5Cb3VuY2UKICAgICovCglCb3VuY2U6IHsKCgkJLyoqCgkJKiBCb3VuY2UgZWFzZS1pbi4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQm91bmNlI0luIAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwoJCUluOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gMSAtIFBoYXNlci5FYXNpbmcuQm91bmNlLk91dCggMSAtIGsgKTsKCgkJfSwKCgkJLyoqCgkJKiBCb3VuY2UgZWFzZS1vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJvdW5jZSNPdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggayA8ICggMSAvIDIuNzUgKSApIHsKCgkJCQlyZXR1cm4gNy41NjI1ICogayAqIGs7CgoJCQl9IGVsc2UgaWYgKCBrIDwgKCAyIC8gMi43NSApICkgewoKCQkJCXJldHVybiA3LjU2MjUgKiAoIGsgLT0gKCAxLjUgLyAyLjc1ICkgKSAqIGsgKyAwLjc1OwoKCQkJfSBlbHNlIGlmICggayA8ICggMi41IC8gMi43NSApICkgewoKCQkJCXJldHVybiA3LjU2MjUgKiAoIGsgLT0gKCAyLjI1IC8gMi43NSApICkgKiBrICsgMC45Mzc1OwoKCQkJfSBlbHNlIHsKCgkJCQlyZXR1cm4gNy41NjI1ICogKCBrIC09ICggMi42MjUgLyAyLjc1ICkgKSAqIGsgKyAwLjk4NDM3NTsKCgkJCX0KCgkJfSwKCgkJLyoqCgkJKiBCb3VuY2UgZWFzZS1pbi9vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJvdW5jZSNJbk91dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwoJCUluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlpZiAoIGsgPCAwLjUgKSByZXR1cm4gUGhhc2VyLkVhc2luZy5Cb3VuY2UuSW4oIGsgKiAyICkgKiAwLjU7CgkJCXJldHVybiBQaGFzZXIuRWFzaW5nLkJvdW5jZS5PdXQoIGsgKiAyIC0gMSApICogMC41ICsgMC41OwoKCQl9CgoJfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRpbWUgY29uc3RydWN0b3IuCioKKiBAY2xhc3MgUGhhc2VyLlRpbWUKKiBAY2xhc3NkZXNjIFRoaXMgaXMgdGhlIGNvcmUgaW50ZXJuYWwgZ2FtZSBjbG9jay4gSXQgbWFuYWdlcyB0aGUgZWxhcHNlZCB0aW1lIGFuZCBjYWxjdWxhdGlvbiBvZiBlbGFwc2VkIHZhbHVlcywgdXNlZCBmb3IgZ2FtZSBvYmplY3QgbW90aW9uIGFuZCB0d2VlbnMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlRpbWUgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogVGhlIHRpbWUgYXQgd2hpY2ggdGhlIEdhbWUgaW5zdGFuY2Ugc3RhcnRlZC4KCSogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydGVkCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fc3RhcnRlZCA9IDA7CgoJLyoqCgkqIFRoZSB0aW1lIChpbiBtcykgdGhhdCB0aGUgbGFzdCBzZWNvbmQgY291bnRlciB0aWNrZWQgb3Zlci4KCSogQHByb3BlcnR5IHtudW1iZXJ9IF90aW1lTGFzdFNlY29uZAoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuX3RpbWVMYXN0U2Vjb25kID0gMDsKCgkvKioKCSogVGhlIHRpbWUgdGhlIGdhbWUgc3RhcnRlZCBiZWluZyBwYXVzZWQuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcGF1c2VTdGFydGVkCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fcGF1c2VTdGFydGVkID0gMDsKCgkvKioKCSogVGhlIGVsYXBzZWQgdGltZSBjYWxjdWxhdGVkIGZvciB0aGUgcGh5c2ljcyBtb3Rpb24gdXBkYXRlcy4KCSogQHByb3BlcnR5IHtudW1iZXJ9IHBoeXNpY3NFbGFwc2VkCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5waHlzaWNzRWxhcHNlZCA9IDA7CgoJLyoqCgkqIEdhbWUgdGltZSBjb3VudGVyLgoJKiBAcHJvcGVydHkge251bWJlcn0gdGltZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudGltZSA9IDA7CgoJLyoqCgkqIFJlY29yZHMgaG93IGxvbmcgdGhlIGdhbWUgaGFzIGJlZW4gcGF1c2VkIGZvci4gSXMgcmVzZXQgZWFjaCB0aW1lIHRoZSBnYW1lIHBhdXNlcy4KCSogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFRpbWUKCSogQGRlZmF1bHQKCSovCgl0aGlzLnBhdXNlZFRpbWUgPSAwOwoKCS8qKgoJKiBUaGUgdGltZSByaWdodCBub3cuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBub3cKICAgICogQGRlZmF1bHQKCSovCgl0aGlzLm5vdyA9IDA7CgoJLyoqCgkqIEVsYXBzZWQgdGltZSBzaW5jZSB0aGUgbGFzdCBmcmFtZS4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGVsYXBzZWQKCSogQGRlZmF1bHQKCSovCgl0aGlzLmVsYXBzZWQgPSAwOwoKCS8qKgoJKiBGcmFtZXMgcGVyIHNlY29uZC4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGZwcwoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZnBzID0gMDsKCgkvKioKCSogVGhlIGxvd2VzdCByYXRlIHRoZSBmcHMgaGFzIGRyb3BwZWQgdG8uCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcHNNaW4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmZwc01pbiA9IDEwMDA7CgoJLyoqCgkqIFRoZSBoaWdoZXN0IHJhdGUgdGhlIGZwcyBoYXMgcmVhY2hlZCAodXN1YWxseSBubyBoaWdoZXIgdGhhbiA2MGZwcykuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcHNNYXgKCSogQGRlZmF1bHQKCSovCgl0aGlzLmZwc01heCA9IDA7CgoJLyoqCgkqIFRoZSBtaW5pbXVtIGFtb3VudCBvZiB0aW1lIHRoZSBnYW1lIGhhcyB0YWtlbiBiZXR3ZWVuIHR3byBmcmFtZXMuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtc01pbgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubXNNaW4gPSAxMDAwOwoKCS8qKgoJKiBUaGUgbWF4aW11bSBhbW91bnQgb2YgdGltZSB0aGUgZ2FtZSBoYXMgdGFrZW4gYmV0d2VlbiB0d28gZnJhbWVzLgoJKiBAcHJvcGVydHkge251bWJlcn0gbXNNYXgKCSogQGRlZmF1bHQKCSovCgl0aGlzLm1zTWF4ID0gMDsKCgkvKioKCSogVGhlIG51bWJlciBvZiBmcmFtZXMgcmVjb3JkIGluIHRoZSBsYXN0IHNlY29uZC4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lcwoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZnJhbWVzID0gMDsKCgkvKioKCSogUmVjb3JkcyBob3cgbG9uZyB0aGUgZ2FtZSB3YXMgcGF1c2VkIGZvciBpbiBtaWxpc2Vjb25kcy4KCSogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlRHVyYXRpb24KCSogQGRlZmF1bHQKCSovCgl0aGlzLnBhdXNlRHVyYXRpb24gPSAwOwoKCS8qKgoJKiBUaGUgdmFsdWUgdGhhdCBzZXRUaW1lb3V0IG5lZWRzIHRvIHdvcmsgb3V0IHdoZW4gdG8gbmV4dCB1cGRhdGUKCSogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVUb0NhbGwKCSogQGRlZmF1bHQKCSovCgl0aGlzLnRpbWVUb0NhbGwgPSAwOwoKCS8qKgoJKiBJbnRlcm5hbCB2YWx1ZSB1c2VkIGJ5IHRpbWVUb0NhbGwgYXMgcGFydCBvZiB0aGUgc2V0VGltZW91dCBsb29wCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsYXN0VGltZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubGFzdFRpbWUgPSAwOwoKCS8vCUxpc3RlbiBmb3IgZ2FtZSBwYXVzZS9yZXN1bWUgZXZlbnRzCgl0aGlzLmdhbWUub25QYXVzZS5hZGQodGhpcy5nYW1lUGF1c2VkLCB0aGlzKTsKCXRoaXMuZ2FtZS5vblJlc3VtZS5hZGQodGhpcy5nYW1lUmVzdW1lZCwgdGhpcyk7CgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IF9qdXN0UmVzdW1lZAogICAgKiBAZGVmYXVsdAoJKi8KCXRoaXMuX2p1c3RSZXN1bWVkID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlRpbWUucHJvdG90eXBlID0gewoKCS8qKgoJKiBUaGUgbnVtYmVyIG9mIHNlY29uZHMgdGhhdCBoYXZlIGVsYXBzZWQgc2luY2UgdGhlIGdhbWUgd2FzIHN0YXJ0ZWQuCgkqIEBtZXRob2QgUGhhc2VyLlRpbWUjdG90YWxFbGFwc2VkU2Vjb25kcwoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJdG90YWxFbGFwc2VkU2Vjb25kczogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICh0aGlzLm5vdyAtIHRoaXMuX3N0YXJ0ZWQpICogMC4wMDE7Cgl9LAoKCS8qKgoJKiBVcGRhdGVzIHRoZSBnYW1lIGNsb2NrIGFuZCBjYWxjdWxhdGUgdGhlIGZwcy4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuR2FtZS4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSN1cGRhdGUKCSogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBUaGUgY3VycmVudCB0aW1lc3RhbXAsIGVpdGhlciBwZXJmb3JtYW5jZS5ub3cgb3IgRGF0ZS5ub3cgZGVwZW5kaW5nIG9uIHRoZSBicm93c2VyLgoJKi8KCXVwZGF0ZTogZnVuY3Rpb24gKHRpbWUpIHsKCgkJdGhpcy5ub3cgPSB0aW1lOwoKCQlpZiAodGhpcy5fanVzdFJlc3VtZWQpCgkJewoJCQl0aGlzLnRpbWUgPSB0aGlzLm5vdzsKCQkJdGhpcy5fanVzdFJlc3VtZWQgPSBmYWxzZTsKCQl9CgoJCXRoaXMudGltZVRvQ2FsbCA9IHRoaXMuZ2FtZS5tYXRoLm1heCgwLCAxNiAtICh0aW1lIC0gdGhpcy5sYXN0VGltZSkpOwoKCQl0aGlzLmVsYXBzZWQgPSB0aGlzLm5vdyAtIHRoaXMudGltZTsKCgkJdGhpcy5tc01pbiA9IHRoaXMuZ2FtZS5tYXRoLm1pbih0aGlzLm1zTWluLCB0aGlzLmVsYXBzZWQpOwoJCXRoaXMubXNNYXggPSB0aGlzLmdhbWUubWF0aC5tYXgodGhpcy5tc01heCwgdGhpcy5lbGFwc2VkKTsKCgkJdGhpcy5mcmFtZXMrKzsKCgkJaWYgKHRoaXMubm93ID4gdGhpcy5fdGltZUxhc3RTZWNvbmQgKyAxMDAwKQoJCXsKCQkJdGhpcy5mcHMgPSBNYXRoLnJvdW5kKCh0aGlzLmZyYW1lcyAqIDEwMDApIC8gKHRoaXMubm93IC0gdGhpcy5fdGltZUxhc3RTZWNvbmQpKTsKCQkJdGhpcy5mcHNNaW4gPSB0aGlzLmdhbWUubWF0aC5taW4odGhpcy5mcHNNaW4sIHRoaXMuZnBzKTsKCQkJdGhpcy5mcHNNYXggPSB0aGlzLmdhbWUubWF0aC5tYXgodGhpcy5mcHNNYXgsIHRoaXMuZnBzKTsKCQkJdGhpcy5fdGltZUxhc3RTZWNvbmQgPSB0aGlzLm5vdzsKCQkJdGhpcy5mcmFtZXMgPSAwOwoJCX0KCgkJdGhpcy50aW1lID0gdGhpcy5ub3c7CiAgICAgICAgdGhpcy5sYXN0VGltZSA9IHRpbWUgKyB0aGlzLnRpbWVUb0NhbGw7CgkJdGhpcy5waHlzaWNzRWxhcHNlZCA9IDEuMCAqICh0aGlzLmVsYXBzZWQgLyAxMDAwKTsKCgkJLy8JQ2xhbXAgdGhlIGRlbHRhCgkJaWYgKHRoaXMucGh5c2ljc0VsYXBzZWQgPiAxKQoJCXsKCQkJdGhpcy5waHlzaWNzRWxhcHNlZCA9IDE7CgkJfQoKCQkvLyAgUGF1c2VkPwoJCWlmICh0aGlzLmdhbWUucGF1c2VkKQoJCXsKCQkJdGhpcy5wYXVzZWRUaW1lID0gdGhpcy5ub3cgLSB0aGlzLl9wYXVzZVN0YXJ0ZWQ7CgkJfQoKCX0sCgoJLyoqCgkqIENhbGxlZCB3aGVuIHRoZSBnYW1lIGVudGVycyBhIHBhdXNlZCBzdGF0ZS4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSNnYW1lUGF1c2VkCgkqIEBwcml2YXRlCgkqLwoJZ2FtZVBhdXNlZDogZnVuY3Rpb24gKCkgewoJCQoJCXRoaXMuX3BhdXNlU3RhcnRlZCA9IHRoaXMubm93OwoKCX0sCgoJLyoqCgkqIENhbGxlZCB3aGVuIHRoZSBnYW1lIHJlc3VtZXMgZnJvbSBhIHBhdXNlZCBzdGF0ZS4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSNnYW1lUmVzdW1lZAoJKiBAcHJpdmF0ZQoJKi8KCWdhbWVSZXN1bWVkOiBmdW5jdGlvbiAoKSB7CgoJCS8vICBMZXZlbCBvdXQgdGhlIGVsYXBzZWQgdGltZXIgdG8gYXZvaWQgc3Bpa2VzCgkJdGhpcy50aW1lID0gRGF0ZS5ub3coKTsKCQl0aGlzLnBhdXNlRHVyYXRpb24gPSB0aGlzLnBhdXNlZFRpbWU7CgkJdGhpcy5fanVzdFJlc3VtZWQgPSB0cnVlOwoKCX0sCgoJLyoqCgkqIEhvdyBsb25nIGhhcyBwYXNzZWQgc2luY2UgdGhlIGdpdmVuIHRpbWUuCgkqIEBtZXRob2QgUGhhc2VyLlRpbWUjZWxhcHNlZFNpbmNlCgkqIEBwYXJhbSB7bnVtYmVyfSBzaW5jZSAtIFRoZSB0aW1lIHlvdSB3YW50IHRvIG1lYXN1cmUgYWdhaW5zdC4KCSogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHRoZSBnaXZlbiB0aW1lIGFuZCBub3cuCgkqLwoJZWxhcHNlZFNpbmNlOiBmdW5jdGlvbiAoc2luY2UpIHsKCQlyZXR1cm4gdGhpcy5ub3cgLSBzaW5jZTsKCX0sCgoJLyoqCgkqIEhvdyBsb25nIGhhcyBwYXNzZWQgc2luY2UgdGhlIGdpdmVuIHRpbWUgKGluIHNlY29uZHMpLgoJKiBAbWV0aG9kIFBoYXNlci5UaW1lI2VsYXBzZWRTZWNvbmRzU2luY2UKCSogQHBhcmFtIHtudW1iZXJ9IHNpbmNlIC0gVGhlIHRpbWUgeW91IHdhbnQgdG8gbWVhc3VyZSAoaW4gc2Vjb25kcykuCgkqIEByZXR1cm4ge251bWJlcn0gRHVyYXRpb24gYmV0d2VlbiBnaXZlbiB0aW1lIGFuZCBub3cgKGluIHNlY29uZHMpLgoJKi8KCWVsYXBzZWRTZWNvbmRzU2luY2U6IGZ1bmN0aW9uIChzaW5jZSkgewoJCXJldHVybiAodGhpcy5ub3cgLSBzaW5jZSkgKiAwLjAwMTsKCX0sCgoJLyoqCgkqIFJlc2V0cyB0aGUgcHJpdmF0ZSBfc3RhcnRlZCB2YWx1ZSB0byBub3cuCgkqIEBtZXRob2QgUGhhc2VyLlRpbWUjcmVzZXQKCSovCglyZXNldDogZnVuY3Rpb24gKCkgewoJCXRoaXMuX3N0YXJ0ZWQgPSB0aGlzLm5vdzsKCX0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBBbmltYXRpb24gTWFuYWdlciBpcyB1c2VkIHRvIGFkZCwgcGxheSBhbmQgdXBkYXRlIFBoYXNlciBBbmltYXRpb25zLgoqIEFueSBHYW1lIE9iamVjdCBzdWNoIGFzIFBoYXNlci5TcHJpdGUgdGhhdCBzdXBwb3J0cyBhbmltYXRpb24gY29udGFpbnMgYSBzaW5nbGUgQW5pbWF0aW9uTWFuYWdlciBpbnN0YW5jZS4KKgoqIEBjbGFzcyBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gQSByZWZlcmVuY2UgdG8gdGhlIEdhbWUgT2JqZWN0IHRoYXQgb3ducyB0aGlzIEFuaW1hdGlvbk1hbmFnZXIuCiovClBoYXNlci5BbmltYXRpb25NYW5hZ2VyID0gZnVuY3Rpb24gKHNwcml0ZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgU3ByaXRlIHRoYXQgb3ducyB0aGlzIEFuaW1hdGlvbk1hbmFnZXIuCiAgICAqLwoJdGhpcy5zcHJpdGUgPSBzcHJpdGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCgl0aGlzLmdhbWUgPSBzcHJpdGUuZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWV9IGN1cnJlbnRGcmFtZSAtIFRoZSBjdXJyZW50bHkgZGlzcGxheWVkIEZyYW1lIG9mIGFuaW1hdGlvbiwgaWYgYW55LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuY3VycmVudEZyYW1lID0gbnVsbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXBkYXRlSWZWaXNpYmxlIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gZGF0YSBjb250aW51ZSB0byB1cGRhdGUgZXZlbiBpZiB0aGUgU3ByaXRlLnZpc2libGUgaXMgc2V0IHRvIGZhbHNlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudXBkYXRlSWZWaXNpYmxlID0gdHJ1ZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc0xvYWRlZCAtIFNldCB0byB0cnVlIG9uY2UgYW5pbWF0aW9uIGRhdGEgaGFzIGJlZW4gbG9hZGVkLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuaXNMb2FkZWQgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWVEYXRhfSBfZnJhbWVEYXRhIC0gQSB0ZW1wLiB2YXIgZm9yIGhvbGRpbmcgdGhlIGN1cnJlbnRseSBwbGF5aW5nIEFuaW1hdGlvbnMgRnJhbWVEYXRhLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuX2ZyYW1lRGF0YSA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfYW5pbXMgLSBBbiBpbnRlcm5hbCBvYmplY3QgdGhhdCBzdG9yZXMgYWxsIG9mIHRoZSBBbmltYXRpb24gaW5zdGFuY2VzLgoJKiBAcHJpdmF0ZQoJKi8gICAKCXRoaXMuX2FuaW1zID0ge307CgoJLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfb3V0cHV0RnJhbWVzIC0gQW4gaW50ZXJuYWwgb2JqZWN0IHRvIGhlbHAgYXZvaWQgZ2MuCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5fb3V0cHV0RnJhbWVzID0gW107Cgp9OwoKUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBMb2FkcyBGcmFtZURhdGEgaW50byB0aGUgaW50ZXJuYWwgdGVtcG9yYXJ5IHZhcnMgYW5kIHJlc2V0cyB0aGUgZnJhbWUgaW5kZXggdG8gemVyby4KICAgICogVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSB3aGVuIGEgbmV3IFNwcml0ZSBpcyBjcmVhdGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2xvYWRGcmFtZURhdGEKICAgICogQHByaXZhdGUKICAgICogQHBhcmFtIHtQaGFzZXIuRnJhbWVEYXRhfSBmcmFtZURhdGEgLSBUaGUgRnJhbWVEYXRhIHNldCB0byBsb2FkLgogICAgKi8KCWxvYWRGcmFtZURhdGE6IGZ1bmN0aW9uIChmcmFtZURhdGEpIHsKCgkJdGhpcy5fZnJhbWVEYXRhID0gZnJhbWVEYXRhOwoJCXRoaXMuZnJhbWUgPSAwOwoJCXRoaXMuaXNMb2FkZWQgPSB0cnVlOwoKCX0sCgoJLyoqCgkqIEFkZHMgYSBuZXcgYW5pbWF0aW9uIHVuZGVyIHRoZSBnaXZlbiBrZXkuIE9wdGlvbmFsbHkgc2V0IHRoZSBmcmFtZXMsIGZyYW1lIHJhdGUgYW5kIGxvb3AuCgkqIEFuaW1hdGlvbnMgYWRkZWQgaW4gdGhpcyB3YXkgYXJlIHBsYXllZCBiYWNrIHdpdGggdGhlIHBsYXkgZnVuY3Rpb24uCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjYWRkCgkqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIHVuaXF1ZSAod2l0aGluIHRoaXMgU3ByaXRlKSBuYW1lIGZvciB0aGUgYW5pbWF0aW9uLCBpLmUuICJydW4iLCAiZmlyZSIsICJ3YWxrIi4KCSogQHBhcmFtIHtBcnJheX0gW2ZyYW1lcz1udWxsXSAtIEFuIGFycmF5IG9mIG51bWJlcnMvc3RyaW5ncyB0aGF0IGNvcnJlc3BvbmQgdG8gdGhlIGZyYW1lcyB0byBhZGQgdG8gdGhpcyBhbmltYXRpb24gYW5kIGluIHdoaWNoIG9yZGVyLiBlLmcuIFsxLCAyLCAzXSBvciBbJ3J1bjAnLCAncnVuMScsIHJ1bjJdKS4gSWYgbnVsbCB0aGVuIGFsbCBmcmFtZXMgd2lsbCBiZSB1c2VkLgoJKiBAcGFyYW0ge251bWJlcn0gW2ZyYW1lUmF0ZT02MF0gLSBUaGUgc3BlZWQgYXQgd2hpY2ggdGhlIGFuaW1hdGlvbiBzaG91bGQgcGxheS4gVGhlIHNwZWVkIGlzIGdpdmVuIGluIGZyYW1lcyBwZXIgc2Vjb25kLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBhbmltYXRpb24gaXMgbG9vcGVkIG9yIGp1c3QgcGxheXMgb25jZS4KCSogQHBhcmFtIHtib29sZWFufSBbdXNlTnVtZXJpY0luZGV4PXRydWVdIC0gQXJlIHRoZSBnaXZlbiBmcmFtZXMgdXNpbmcgbnVtZXJpYyBpbmRleGVzIChkZWZhdWx0KSBvciBzdHJpbmdzPwoJKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSBUaGUgQW5pbWF0aW9uIG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgoJKi8KCWFkZDogZnVuY3Rpb24gKG5hbWUsIGZyYW1lcywgZnJhbWVSYXRlLCBsb29wLCB1c2VOdW1lcmljSW5kZXgpIHsKCgkJaWYgKHRoaXMuX2ZyYW1lRGF0YSA9PSBudWxsKQoJCXsKCQkJY29uc29sZS53YXJuKCdObyBGcmFtZURhdGEgYXZhaWxhYmxlIGZvciBQaGFzZXIuQW5pbWF0aW9uICcgKyBuYW1lKTsKCQkJcmV0dXJuOwoJCX0KCgkJZnJhbWVSYXRlID0gZnJhbWVSYXRlIHx8IDYwOwoKCQlpZiAodHlwZW9mIGxvb3AgPT09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKCQkvLwlJZiB0aGV5IGRpZG4ndCBzZXQgdGhlIHVzZU51bWVyaWNJbmRleCB0aGVuIGxldCdzIGF0IGxlYXN0IHRyeSBhbmQgZ3Vlc3MgaXQKCQlpZiAodHlwZW9mIHVzZU51bWVyaWNJbmRleCA9PT0gJ3VuZGVmaW5lZCcpCgkJewoJCQlpZiAoZnJhbWVzICYmIHR5cGVvZiBmcmFtZXNbMF0gPT09ICdudW1iZXInKQoJCQl7CgkJCQl1c2VOdW1lcmljSW5kZXggPSB0cnVlOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdXNlTnVtZXJpY0luZGV4ID0gZmFsc2U7CgkJCX0KCQl9CgoJCS8vICBDcmVhdGUgdGhlIHNpZ25hbHMgdGhlIEFuaW1hdGlvbk1hbmFnZXIgd2lsbCBlbWl0CgkJaWYgKHRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvblN0YXJ0ID09IG51bGwpCgkJewoJCQl0aGlzLnNwcml0ZS5ldmVudHMub25BbmltYXRpb25TdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgkJCXRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvbkNvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCQkJdGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uTG9vcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgkJfQoKICAgIAl0aGlzLl9vdXRwdXRGcmFtZXMubGVuZ3RoID0gMDsKCgkJdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lSW5kZXhlcyhmcmFtZXMsIHVzZU51bWVyaWNJbmRleCwgdGhpcy5fb3V0cHV0RnJhbWVzKTsKCgkJdGhpcy5fYW5pbXNbbmFtZV0gPSBuZXcgUGhhc2VyLkFuaW1hdGlvbih0aGlzLmdhbWUsIHRoaXMuc3ByaXRlLCBuYW1lLCB0aGlzLl9mcmFtZURhdGEsIHRoaXMuX291dHB1dEZyYW1lcywgZnJhbWVSYXRlLCBsb29wKTsKCQl0aGlzLmN1cnJlbnRBbmltID0gdGhpcy5fYW5pbXNbbmFtZV07CgkJdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRBbmltLmN1cnJlbnRGcmFtZTsKCQl0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCgkJcmV0dXJuIHRoaXMuX2FuaW1zW25hbWVdOwoKCX0sCgoJLyoqCgkqIENoZWNrIHdoZXRoZXIgdGhlIGZyYW1lcyBpbiB0aGUgZ2l2ZW4gYXJyYXkgYXJlIHZhbGlkIGFuZCBleGlzdC4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciN2YWxpZGF0ZUZyYW1lcwoJKiBAcGFyYW0ge0FycmF5fSBmcmFtZXMgLSBBbiBhcnJheSBvZiBmcmFtZXMgdG8gYmUgdmFsaWRhdGVkLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBWYWxpZGF0ZSB0aGUgZnJhbWVzIGJhc2VkIG9uIHRoZWlyIG51bWVyaWMgaW5kZXggKHRydWUpIG9yIHN0cmluZyBpbmRleCAoZmFsc2UpCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYWxsIGdpdmVuIEZyYW1lcyBhcmUgdmFsaWQsIG90aGVyd2lzZSBmYWxzZS4KCSovCgl2YWxpZGF0ZUZyYW1lczogZnVuY3Rpb24gKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4KSB7CgoJCWlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09ICd1bmRlZmluZWQnKSB7IHVzZU51bWVyaWNJbmRleCA9IHRydWU7IH0KCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspCgkJewoJCQlpZiAodXNlTnVtZXJpY0luZGV4ID09IHRydWUpCgkJCXsKCQkJCWlmIChmcmFtZXNbaV0gPiB0aGlzLl9mcmFtZURhdGEudG90YWwpCgkJCQl7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJCWVsc2UKCQkJewoJCQkJaWYgKHRoaXMuX2ZyYW1lRGF0YS5jaGVja0ZyYW1lTmFtZShmcmFtZXNbaV0pID09IGZhbHNlKQoJCQkJewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRydWU7CgoJfSwKCgkvKioKCSogUGxheSBhbiBhbmltYXRpb24gYmFzZWQgb24gdGhlIGdpdmVuIGtleS4gVGhlIGFuaW1hdGlvbiBzaG91bGQgcHJldmlvdXNseSBoYXZlIGJlZW4gYWRkZWQgdmlhIHNwcml0ZS5hbmltYXRpb25zLmFkZCgpCgkqIElmIHRoZSByZXF1ZXN0ZWQgYW5pbWF0aW9uIGlzIGFscmVhZHkgcGxheWluZyB0aGlzIHJlcXVlc3Qgd2lsbCBiZSBpZ25vcmVkLiBJZiB5b3UgbmVlZCB0byByZXNldCBhbiBhbHJlYWR5IHJ1bm5pbmcgYW5pbWF0aW9uIGRvIHNvIGRpcmVjdGx5IG9uIHRoZSBBbmltYXRpb24gb2JqZWN0IGl0c2VsZi4KCSogCgkqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjcGxheQoJKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgcGxheWVkLCBlLmcuICJmaXJlIiwgIndhbGsiLCAianVtcCIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPW51bGxdIC0gVGhlIGZyYW1lcmF0ZSB0byBwbGF5IHRoZSBhbmltYXRpb24gYXQuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBmcmFtZVJhdGUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNob3VsZCB0aGUgYW5pbWF0aW9uIGJlIGxvb3BlZCBhZnRlciBwbGF5YmFjay4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBsb29wIHZhbHVlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBba2lsbE9uQ29tcGxldGU9ZmFsc2VdIC0gSWYgc2V0IHRvIHRydWUgd2hlbiB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlcyAob25seSBoYXBwZW5zIGlmIGxvb3A9ZmFsc2UpIHRoZSBwYXJlbnQgU3ByaXRlIHdpbGwgYmUga2lsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSBBIHJlZmVyZW5jZSB0byBwbGF5aW5nIEFuaW1hdGlvbiBpbnN0YW5jZS4KCSovCglwbGF5OiBmdW5jdGlvbiAobmFtZSwgZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSkgewoKCQlpZiAodGhpcy5fYW5pbXNbbmFtZV0pCgkJewoJCQlpZiAodGhpcy5jdXJyZW50QW5pbSA9PSB0aGlzLl9hbmltc1tuYW1lXSkKCQkJewoJCQkJaWYgKHRoaXMuY3VycmVudEFuaW0uaXNQbGF5aW5nID09IGZhbHNlKQoJCQkJewoJCQkgICAgICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gZmFsc2U7CgkJCQkJcmV0dXJuIHRoaXMuY3VycmVudEFuaW0ucGxheShmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKCQkJICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gZmFsc2U7CgkJCQlyZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5wbGF5KGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpOwoJCQl9CgkJfQoKCX0sCgoJLyoqCgkqIFN0b3AgcGxheWJhY2sgb2YgYW4gYW5pbWF0aW9uLiBJZiBhIG5hbWUgaXMgZ2l2ZW4gdGhhdCBzcGVjaWZpYyBhbmltYXRpb24gaXMgc3RvcHBlZCwgb3RoZXJ3aXNlIHRoZSBjdXJyZW50IGFuaW1hdGlvbiBpcyBzdG9wcGVkLgoJKiBUaGUgY3VycmVudEFuaW0gcHJvcGVydHkgb2YgdGhlIEFuaW1hdGlvbk1hbmFnZXIgaXMgYXV0b21hdGljYWxseSBzZXQgdG8gdGhlIGFuaW1hdGlvbiBnaXZlbi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNzdG9wCgkqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT1udWxsXSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgc3RvcHBlZCwgZS5nLiAiZmlyZSIuIElmIG5vbmUgaXMgZ2l2ZW4gdGhlIGN1cnJlbnRseSBydW5uaW5nIGFuaW1hdGlvbiBpcyBzdG9wcGVkLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldEZyYW1lPWZhbHNlXSAtIFdoZW4gdGhlIGFuaW1hdGlvbiBpcyBzdG9wcGVkIHNob3VsZCB0aGUgY3VycmVudEZyYW1lIGJlIHNldCB0byB0aGUgZmlyc3QgZnJhbWUgb2YgdGhlIGFuaW1hdGlvbiAodHJ1ZSkgb3IgcGF1c2VkIG9uIHRoZSBsYXN0IGZyYW1lIGRpc3BsYXllZCAoZmFsc2UpCgkqLwoJc3RvcDogZnVuY3Rpb24gKG5hbWUsIHJlc2V0RnJhbWUpIHsKCgkJaWYgKHR5cGVvZiByZXNldEZyYW1lID09ICd1bmRlZmluZWQnKSB7IHJlc2V0RnJhbWUgPSBmYWxzZTsgfQoKCQlpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpCgkJewoJCQlpZiAodGhpcy5fYW5pbXNbbmFtZV0pCgkJCXsKCQkJCXRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKCQkJCXRoaXMuY3VycmVudEFuaW0uc3RvcChyZXNldEZyYW1lKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlpZiAodGhpcy5jdXJyZW50QW5pbSkKCQkJewoJCQkJdGhpcy5jdXJyZW50QW5pbS5zdG9wKHJlc2V0RnJhbWUpOwoJCQl9CgkJfQoKCX0sCgoJLyoqCgkqIFRoZSBtYWluIHVwZGF0ZSBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGhlIFNwcml0ZXMgdXBkYXRlIGxvb3AuIEl0J3MgcmVzcG9uc2libGUgZm9yIHVwZGF0aW5nIGFuaW1hdGlvbiBmcmFtZXMgYW5kIGZpcmluZyByZWxhdGVkIGV2ZW50cy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjdXBkYXRlCgkqIEBwcm90ZWN0ZWQKICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhIG5ldyBhbmltYXRpb24gZnJhbWUgaGFzIGJlZW4gc2V0LCBvdGhlcndpc2UgZmFsc2UuCgkqLwoJdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLnVwZGF0ZUlmVmlzaWJsZSAmJiB0aGlzLnNwcml0ZS52aXNpYmxlID09IGZhbHNlKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKHRoaXMuY3VycmVudEFuaW0gJiYgdGhpcy5jdXJyZW50QW5pbS51cGRhdGUoKSA9PSB0cnVlKQoJCXsKCQkJdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRBbmltLmN1cnJlbnRGcmFtZTsKCQkJdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CgkJCXJldHVybiB0cnVlOwoJCX0KCgkJcmV0dXJuIGZhbHNlOwoKCX0sCgoJLyoqCgkqIFJldHVybnMgYW4gYW5pbWF0aW9uIHRoYXQgd2FzIHByZXZpb3VzbHkgYWRkZWQgYnkgbmFtZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNnZXRBbmltYXRpb24KCSogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgYW5pbWF0aW9uIHRvIGJlIHJldHVybmVkLCBlLmcuICJmaXJlIi4KICAgICogQHJldHVybiB7UGhhc2VyLkFuaW1hdGlvbnxib29sZWFufSBUaGUgQW5pbWF0aW9uIGluc3RhbmNlLCBpZiBmb3VuZCwgb3RoZXJ3aXNlIGZhbHNlLgoJKi8KCWdldEFuaW1hdGlvbjogZnVuY3Rpb24gKG5hbWUpIHsKCgkJaWYgKHR5cGVvZiBuYW1lID09ICdzdHJpbmcnKQoJCXsKCQkJaWYgKHRoaXMuX2FuaW1zW25hbWVdKQoJCQl7CgkJCQlyZXR1cm4gdGhpcy5fYW5pbXNbbmFtZV07CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCgl9LAoKICAgIC8qKgogICAgKiBSZWZyZXNoZXMgdGhlIGN1cnJlbnQgZnJhbWUgZGF0YSBiYWNrIHRvIHRoZSBwYXJlbnQgU3ByaXRlIGFuZCBhbHNvIHJlc2V0cyB0aGUgdGV4dHVyZSBkYXRhLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3JlZnJlc2hGcmFtZQogICAgKi8KCXJlZnJlc2hGcmFtZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnNwcml0ZS5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTsKCQl0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCgl9LAoKICAgIC8qKgogICAgKiBEZXN0cm95cyBhbGwgcmVmZXJlbmNlcyB0aGlzIEFuaW1hdGlvbk1hbmFnZXIgY29udGFpbnMuIFNldHMgdGhlIF9hbmltcyB0byBhIG5ldyBvYmplY3QgYW5kIG51bGxzIHRoZSBjdXJyZW50IGFuaW1hdGlvbi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLl9hbmltcyA9IHt9OwogICAgICAgIHRoaXMuX2ZyYW1lRGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CiAgICAgICAgdGhpcy5jdXJyZW50QW5pbSA9IG51bGw7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwoKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZURhdGEKKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBjdXJyZW50IGFuaW1hdGlvbnMgRnJhbWVEYXRhLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAiZnJhbWVEYXRhIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9mcmFtZURhdGE7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lVG90YWwKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWVUb3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoZSBjdXJyZW50bHkgbG9hZGVkIEZyYW1lRGF0YSwgb3IgLTEgaWYgbm8gRnJhbWVEYXRhIGlzIGxvYWRlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgImZyYW1lVG90YWwiLCB7CiAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lRGF0YS50b3RhbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjcGF1c2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSBHZXRzIGFuZCBzZXRzIHRoZSBwYXVzZWQgc3RhdGUgb2YgdGhlIGN1cnJlbnQgYW5pbWF0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAicGF1c2VkIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5pc1BhdXNlZDsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHRoaXMuY3VycmVudEFuaW0ucGF1c2VkID0gdmFsdWU7CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBpbmRleCBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgImZyYW1lIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgIAlpZiAodGhpcy5jdXJyZW50RnJhbWUpCiAgICAJewoJICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVJbmRleDsKCSAgICB9CgkgICAgCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInICYmIHRoaXMuX2ZyYW1lRGF0YSAmJiB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpOwogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwoJCQl0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNmcmFtZU5hbWUKKiBAcHJvcGVydHkge3N0cmluZ30gZnJhbWVOYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIG5hbWUgYW5kIHVwZGF0ZXMgdGhlIFRleHR1cmUgQ2FjaGUgZm9yIGRpc3BsYXkuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICJmcmFtZU5hbWUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgCWlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgIAl7CgkgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5uYW1lOwogICAgCX0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnICYmIHRoaXMuX2ZyYW1lRGF0YSAmJiB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVCeU5hbWUodmFsdWUpICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVCeU5hbWUodmFsdWUpOwogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdGhpcy5jdXJyZW50RnJhbWUuaW5kZXg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwoJCQl0aGlzLnNwcml0ZS5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJDYW5ub3Qgc2V0IGZyYW1lTmFtZTogIiArIHZhbHVlKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEFuIEFuaW1hdGlvbiBpbnN0YW5jZSBjb250YWlucyBhIHNpbmdsZSBhbmltYXRpb24gYW5kIHRoZSBjb250cm9scyB0byBwbGF5IGl0LgoqIEl0IGlzIGNyZWF0ZWQgYnkgdGhlIEFuaW1hdGlvbk1hbmFnZXIsIGNvbnNpc3RzIG9mIEFuaW1hdGlvbi5GcmFtZSBvYmplY3RzIGFuZCBiZWxvbmdzIHRvIGEgc2luZ2xlIEdhbWUgT2JqZWN0IHN1Y2ggYXMgYSBTcHJpdGUuCioKKiBAY2xhc3MgUGhhc2VyLkFuaW1hdGlvbgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHBhcmVudCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBvd25lciBvZiB0aGlzIEFuaW1hdGlvbi4KKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSB1bmlxdWUgbmFtZSBmb3IgdGhpcyBhbmltYXRpb24sIHVzZWQgaW4gcGxheWJhY2sgY29tbWFuZHMuCiogQHBhcmFtIHtQaGFzZXIuRnJhbWVEYXRhfSBmcmFtZURhdGEgLSBUaGUgRnJhbWVEYXRhIG9iamVjdCB0aGF0IGNvbnRhaW5zIGFsbCBmcmFtZXMgdXNlZCBieSB0aGlzIEFuaW1hdGlvbi4KKiBAcGFyYW0geyhBcnJheS48bnVtYmVyPnxBcnJheS48c3RyaW5nPil9IGZyYW1lcyAtIEFuIGFycmF5IG9mIG51bWJlcnMgb3Igc3RyaW5ncyBpbmRpY2F0aW5nIHdoaWNoIGZyYW1lcyB0byBwbGF5IGluIHdoaWNoIG9yZGVyLgoqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJldHdlZW4gZWFjaCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uLCBnaXZlbiBpbiBtcy4KKiBAcGFyYW0ge2Jvb2xlYW59IGxvb3BlZCAtIFNob3VsZCB0aGlzIGFuaW1hdGlvbiBsb29wIG9yIHBsYXkgdGhyb3VnaCBvbmNlLgoqLwpQaGFzZXIuQW5pbWF0aW9uID0gZnVuY3Rpb24gKGdhbWUsIHBhcmVudCwgbmFtZSwgZnJhbWVEYXRhLCBmcmFtZXMsIGRlbGF5LCBsb29wZWQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gX3BhcmVudCAtIEEgcmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgU3ByaXRlIHRoYXQgb3ducyB0aGlzIEFuaW1hdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCgl0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lRGF0YX0gX2ZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgdGhlIEFuaW1hdGlvbiB1c2VzLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ZyYW1lRGF0YSA9IGZyYW1lRGF0YTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgdXNlciBkZWZpbmVkIG5hbWUgZ2l2ZW4gdG8gdGhpcyBBbmltYXRpb24uCiAgICAqLwogICAgdGhpcy5uYW1lID0gbmFtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF9mcmFtZXMKICAgICogQHByaXZhdGUKICAgICovCgl0aGlzLl9mcmFtZXMgPSBbXTsKICAgIHRoaXMuX2ZyYW1lcyA9IHRoaXMuX2ZyYW1lcy5jb25jYXQoZnJhbWVzKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRlbGF5IC0gVGhlIGRlbGF5IGluIG1zIGJldHdlZW4gZWFjaCBmcmFtZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKi8KCXRoaXMuZGVsYXkgPSAxMDAwIC8gZGVsYXk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9vcGVkIC0gVGhlIGxvb3Agc3RhdGUgb2YgdGhlIEFuaW1hdGlvbi4KICAgICovCgl0aGlzLmxvb3BlZCA9IGxvb3BlZDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb29wZWQgLSBUaGUgbG9vcCBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKi8KICAgIHRoaXMua2lsbE9uQ29tcGxldGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc0ZpbmlzaGVkIC0gVGhlIGZpbmlzaGVkIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uIFNldCB0byB0cnVlIG9uY2UgcGxheWJhY2sgY29tcGxldGVzLCBmYWxzZSBkdXJpbmcgcGxheWJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwoJdGhpcy5pc0ZpbmlzaGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNQbGF5aW5nIC0gVGhlIHBsYXlpbmcgc3RhdGUgb2YgdGhlIEFuaW1hdGlvbi4gU2V0IHRvIGZhbHNlIG9uY2UgcGxheWJhY2sgY29tcGxldGVzLCB0cnVlIGR1cmluZyBwbGF5YmFjay4KICAgICogQGRlZmF1bHQKICAgICovCgl0aGlzLmlzUGxheWluZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUGF1c2VkIC0gVGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNQYXVzZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfcGF1c2VTdGFydFRpbWUgLSBUaGUgdGltZSB0aGUgYW5pbWF0aW9uIHBhdXNlZC4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wYXVzZVN0YXJ0VGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZnJhbWVJbmRleAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KCXRoaXMuX2ZyYW1lSW5kZXggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2ZyYW1lRGlmZgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2ZyYW1lRGlmZiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZnJhbWVTa2lwCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZnJhbWVTa2lwID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWV9IGN1cnJlbnRGcmFtZSAtIFRoZSBjdXJyZW50bHkgZGlzcGxheWVkIGZyYW1lIG9mIHRoZSBBbmltYXRpb24uCiAgICAqLwoJdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCQp9OwoKUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFBsYXlzIHRoaXMgYW5pbWF0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jcGxheQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gW2ZyYW1lUmF0ZT1udWxsXSAtIFRoZSBmcmFtZXJhdGUgdG8gcGxheSB0aGUgYW5pbWF0aW9uIGF0LiBUaGUgc3BlZWQgaXMgZ2l2ZW4gaW4gZnJhbWVzIHBlciBzZWNvbmQuIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgZnJhbWVSYXRlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBTaG91bGQgdGhlIGFuaW1hdGlvbiBiZSBsb29wZWQgYWZ0ZXIgcGxheWJhY2suIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgbG9vcCB2YWx1ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2tpbGxPbkNvbXBsZXRlPWZhbHNlXSAtIElmIHNldCB0byB0cnVlIHdoZW4gdGhlIGFuaW1hdGlvbiBjb21wbGV0ZXMgKG9ubHkgaGFwcGVucyBpZiBsb29wPWZhbHNlKSB0aGUgcGFyZW50IFNwcml0ZSB3aWxsIGJlIGtpbGxlZC4KICAgICogQHJldHVybiB7UGhhc2VyLkFuaW1hdGlvbn0gLSBBIHJlZmVyZW5jZSB0byB0aGlzIEFuaW1hdGlvbiBpbnN0YW5jZS4KICAgICovCiAgICBwbGF5OiBmdW5jdGlvbiAoZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIGZyYW1lUmF0ZSA9PT0gJ251bWJlcicpCiAgICAgICAgewogICAgICAgICAgICAvLyAgSWYgdGhleSBzZXQgYSBuZXcgZnJhbWUgcmF0ZSB0aGVuIHVzZSBpdCwgb3RoZXJ3aXNlIHVzZSB0aGUgb25lIHNldCBvbiBjcmVhdGlvbgogICAgICAgICAgICB0aGlzLmRlbGF5ID0gMTAwMCAvIGZyYW1lUmF0ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgbG9vcCA9PT0gJ2Jvb2xlYW4nKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElmIHRoZXkgc2V0IGEgbmV3IGxvb3AgdmFsdWUgdGhlbiB1c2UgaXQsIG90aGVyd2lzZSB1c2UgdGhlIG9uZSBzZXQgb24gY3JlYXRpb24KICAgICAgICAgICAgdGhpcy5sb29wZWQgPSBsb29wOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBraWxsT25Db21wbGV0ZSAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUmVtb3ZlIHRoZSBwYXJlbnQgc3ByaXRlIG9uY2UgdGhlIGFuaW1hdGlvbiBoYXMgZmluaXNoZWQ/CiAgICAgICAgICAgIHRoaXMua2lsbE9uQ29tcGxldGUgPSBraWxsT25Db21wbGV0ZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICB0aGlzLmlzRmluaXNoZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgICAgICB0aGlzLl90aW1lTGFzdEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIHRoaXMuX3RpbWVOZXh0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmRlbGF5OwoKICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gMDsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCQl0aGlzLl9wYXJlbnQuc2V0VGV4dHVyZShQSVhJLlRleHR1cmVDYWNoZVt0aGlzLmN1cnJlbnRGcmFtZS51dWlkXSk7CgogICAgICAgIGlmICh0aGlzLl9wYXJlbnQuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LmV2ZW50cy5vbkFuaW1hdGlvblN0YXJ0LmRpc3BhdGNoKHRoaXMuX3BhcmVudCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoaXMgYW5pbWF0aW9uIGJhY2sgdG8gdGhlIGZpcnN0IGZyYW1lIGFuZCByZXN0YXJ0cyB0aGUgYW5pbWF0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jcmVzdGFydAogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIHJlc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIHRoaXMuX3RpbWVMYXN0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy5fdGltZU5leHRGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZGVsYXk7CgogICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSAwOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVJbmRleF0pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3BzIHBsYXliYWNrIG9mIHRoaXMgYW5pbWF0aW9uIGFuZCBzZXQgaXQgdG8gYSBmaW5pc2hlZCBzdGF0ZS4gSWYgYSByZXNldEZyYW1lIGlzIHByb3ZpZGVkIGl0IHdpbGwgc3RvcCBwbGF5YmFjayBhbmQgc2V0IGZyYW1lIHRvIHRoZSBmaXJzdCBpbiB0aGUgYW5pbWF0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jc3RvcAogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyZXNldEZyYW1lPWZhbHNlXSAtIElmIHRydWUgYWZ0ZXIgdGhlIGFuaW1hdGlvbiBzdG9wcyB0aGUgY3VycmVudEZyYW1lIHZhbHVlIHdpbGwgYmUgc2V0IHRvIHRoZSBmaXJzdCBmcmFtZSBpbiB0aGlzIGFuaW1hdGlvbi4KICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAocmVzZXRGcmFtZSkgewoKICAgICAgICBpZiAodHlwZW9mIHJlc2V0RnJhbWUgPT09ICd1bmRlZmluZWQnKSB7IHJlc2V0RnJhbWUgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKHJlc2V0RnJhbWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbMF0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIHRoaXMgYW5pbWF0aW9uLiBDYWxsZWQgYXV0b21hdGljYWxseSBieSB0aGUgQW5pbWF0aW9uTWFuYWdlci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI3VwZGF0ZQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc1BhdXNlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZyA9PSB0cnVlICYmIHRoaXMuZ2FtZS50aW1lLm5vdyA+PSB0aGlzLl90aW1lTmV4dEZyYW1lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZnJhbWVTa2lwID0gMTsKCiAgICAgICAgICAgIC8vICBMYWdnaW5nPwogICAgICAgICAgICB0aGlzLl9mcmFtZURpZmYgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl90aW1lTmV4dEZyYW1lOwoKICAgICAgICAgICAgdGhpcy5fdGltZUxhc3RGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKCiAgICAgICAgICAgIGlmICh0aGlzLl9mcmFtZURpZmYgPiB0aGlzLmRlbGF5KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2UgbmVlZCB0byBza2lwIGEgZnJhbWUsIHdvcmsgb3V0IGhvdyBtYW55CiAgICAgICAgICAgICAgICB0aGlzLl9mcmFtZVNraXAgPSBNYXRoLmZsb29yKHRoaXMuX2ZyYW1lRGlmZiAvIHRoaXMuZGVsYXkpOwoKICAgICAgICAgICAgICAgIHRoaXMuX2ZyYW1lRGlmZiAtPSAodGhpcy5fZnJhbWVTa2lwICogdGhpcy5kZWxheSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBBbmQgd2hhdCdzIGxlZnQgbm93PwogICAgICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgKHRoaXMuZGVsYXkgLSB0aGlzLl9mcmFtZURpZmYpOwoKICAgICAgICAgICAgdGhpcy5fZnJhbWVJbmRleCArPSB0aGlzLl9mcmFtZVNraXA7CgogICAgICAgICAgICBpZiAodGhpcy5fZnJhbWVJbmRleCA+PSB0aGlzLl9mcmFtZXMubGVuZ3RoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wZWQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZnJhbWVJbmRleCAlPSB0aGlzLl9mcmFtZXMubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LmV2ZW50cy5vbkFuaW1hdGlvbkxvb3AuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2xlYW5zIHVwIHRoaXMgYW5pbWF0aW9uIHJlYWR5IGZvciBkZWxldGlvbi4gTnVsbHMgYWxsIHZhbHVlcyBhbmQgcmVmZXJlbmNlcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uI2Rlc3Ryb3kKICAgICogQG1lbWJlcm9mIFBoYXNlci5BbmltYXRpb24KICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gbnVsbDsKICAgICAgICB0aGlzLl9mcmFtZXMgPSBudWxsOwogICAgICAgIHRoaXMuX2ZyYW1lRGF0YSA9IG51bGw7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGludGVybmFsbHkgd2hlbiB0aGUgYW5pbWF0aW9uIGZpbmlzaGVzIHBsYXliYWNrLiBTZXRzIHRoZSBpc1BsYXlpbmcgYW5kIGlzRmluaXNoZWQgc3RhdGVzIGFuZCBkaXNwYXRjaGVzIHRoZSBvbkFuaW1hdGlvbkNvbXBsZXRlIGV2ZW50IGlmIGl0IGV4aXN0cyBvbiB0aGUgcGFyZW50LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jb25Db21wbGV0ZQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIG9uQ29tcGxldGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLmlzRmluaXNoZWQgPSB0cnVlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIGlmICh0aGlzLl9wYXJlbnQuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LmV2ZW50cy5vbkFuaW1hdGlvbkNvbXBsZXRlLmRpc3BhdGNoKHRoaXMuX3BhcmVudCwgdGhpcyk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5raWxsT25Db21wbGV0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BhcmVudC5raWxsKCk7CiAgICAgICAgfQoKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI3BhdXNlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF1c2VkIC0gR2V0cyBhbmQgc2V0cyB0aGUgcGF1c2VkIHN0YXRlIG9mIHRoaXMgQW5pbWF0aW9uLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICJwYXVzZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmlzUGF1c2VkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5pc1BhdXNlZCA9IHZhbHVlOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICAvLyAgUGF1c2VkCiAgICAgICAgICAgIHRoaXMuX3BhdXNlU3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgVW4tcGF1c2VkCiAgICAgICAgICAgIGlmICh0aGlzLmlzUGxheWluZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdGltZU5leHRGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZGVsYXk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI2ZyYW1lVG90YWwKKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWVUb3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoZSBjdXJyZW50bHkgbG9hZGVkIEZyYW1lRGF0YSwgb3IgLTEgaWYgbm8gRnJhbWVEYXRhIGlzIGxvYWRlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlLCAiZnJhbWVUb3RhbCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbiNmcmFtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBpbmRleCBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb24ucHJvdG90eXBlLCAiZnJhbWUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRGcmFtZS5pbmRleDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lSW5kZXg7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodmFsdWUpOwoKICAgICAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gdmFsdWU7CgkJCXRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBSZWFsbHkgaGFuZHkgZnVuY3Rpb24gZm9yIHdoZW4geW91IGFyZSBjcmVhdGluZyBhcnJheXMgb2YgYW5pbWF0aW9uIGRhdGEgYnV0IGl0J3MgdXNpbmcgZnJhbWUgbmFtZXMgYW5kIG5vdCBudW1iZXJzLgoqIEZvciBleGFtcGxlIGltYWdpbmUgeW91J3ZlIGdvdCAzMCBmcmFtZXMgbmFtZWQ6ICdleHBsb3Npb25fMDAwMS1sYXJnZScgdG8gJ2V4cGxvc2lvbl8wMDMwLWxhcmdlJwoqIFlvdSBjb3VsZCB1c2UgdGhpcyBmdW5jdGlvbiB0byBnZW5lcmF0ZSB0aG9zZSBieSBkb2luZzogUGhhc2VyLkFuaW1hdGlvbi5nZW5lcmF0ZUZyYW1lTmFtZXMoJ2V4cGxvc2lvbl8nLCAxLCAzMCwgJy1sYXJnZScsIDQpOwoqCiogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcwoqIEBwYXJhbSB7c3RyaW5nfSBwcmVmaXggLSBUaGUgc3RhcnQgb2YgdGhlIGZpbGVuYW1lLiBJZiB0aGUgZmlsZW5hbWUgd2FzICdleHBsb3Npb25fMDAwMS1sYXJnZScgdGhlIHByZWZpeCB3b3VsZCBiZSAnZXhwbG9zaW9uXycuCiogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gVGhlIG51bWJlciB0byBzdGFydCBzZXF1ZW50aWFsbHkgY291bnRpbmcgZnJvbS4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGUgc3RhcnQgaXMgMS4KKiBAcGFyYW0ge251bWJlcn0gc3RvcCAtIFRoZSBudW1iZXIgdG8gY291bnQgdG8uIElmIHlvdXIgZnJhbWVzIGFyZSBuYW1lZCAnZXhwbG9zaW9uXzAwMDEnIHRvICdleHBsb3Npb25fMDAzNCcgdGhlIHN0b3AgdmFsdWUgaXMgMzQuCiogQHBhcmFtIHtzdHJpbmd9IFtzdWZmaXg9JyddIC0gVGhlIGVuZCBvZiB0aGUgZmlsZW5hbWUuIElmIHRoZSBmaWxlbmFtZSB3YXMgJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0aGUgcHJlZml4IHdvdWxkIGJlICctbGFyZ2UnLgoqIEBwYXJhbSB7bnVtYmVyfSBbemVyb1BhZD0wXSAtIFRoZSBudW1iZXIgb2YgemVyb2VzIHRvIHBhZCB0aGUgbWluIGFuZCBtYXggdmFsdWVzIHdpdGguIElmIHlvdXIgZnJhbWVzIGFyZSBuYW1lZCAnZXhwbG9zaW9uXzAwMDEnIHRvICdleHBsb3Npb25fMDAzNCcgdGhlbiB0aGUgemVyb1BhZCBpcyA0LgoqLwpQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcyA9IGZ1bmN0aW9uIChwcmVmaXgsIHN0YXJ0LCBzdG9wLCBzdWZmaXgsIHplcm9QYWQpIHsKCiAgICBpZiAodHlwZW9mIHN1ZmZpeCA9PSAndW5kZWZpbmVkJykgeyBzdWZmaXggPSAnJzsgfQoKICAgIHZhciBvdXRwdXQgPSBbXTsKICAgIHZhciBmcmFtZSA9ICcnOwoKICAgIGlmIChzdGFydCA8IHN0b3ApCiAgICB7CiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDw9IHN0b3A7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgemVyb1BhZCA9PSAnbnVtYmVyJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIHN0ciwgbGVuLCBwYWQsIGRpcgogICAgICAgICAgICAgICAgZnJhbWUgPSBQaGFzZXIuVXRpbHMucGFkKGkudG9TdHJpbmcoKSwgemVyb1BhZCwgJzAnLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZyYW1lID0gaS50b1N0cmluZygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmcmFtZSA9IHByZWZpeCArIGZyYW1lICsgc3VmZml4OwoKICAgICAgICAgICAgb3V0cHV0LnB1c2goZnJhbWUpOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPj0gc3RvcDsgaS0tKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB6ZXJvUGFkID09ICdudW1iZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgc3RyLCBsZW4sIHBhZCwgZGlyCiAgICAgICAgICAgICAgICBmcmFtZSA9IFBoYXNlci5VdGlscy5wYWQoaS50b1N0cmluZygpLCB6ZXJvUGFkLCAnMCcsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZnJhbWUgPSBpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZyYW1lID0gcHJlZml4ICsgZnJhbWUgKyBzdWZmaXg7CgogICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZSk7CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiBvdXRwdXQ7Cgp9CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIEZyYW1lIGlzIGEgc2luZ2xlIGZyYW1lIG9mIGFuIGFuaW1hdGlvbiBhbmQgaXMgcGFydCBvZiBhIEZyYW1lRGF0YSBjb2xsZWN0aW9uLgoqCiogQGNsYXNzIFBoYXNlci5GcmFtZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIEZyYW1lIHdpdGhpbiB0aGUgRnJhbWVEYXRhIHNldCBpdCBpcyBiZWluZyBhZGRlZCB0by4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIGZyYW1lIHdpdGhpbiB0aGUgdGV4dHVyZSBpbWFnZS4KKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZS4gSW4gVGV4dHVyZSBBdGxhcyBkYXRhIHRoaXMgaXMgdXN1YWxseSBzZXQgdG8gdGhlIGZpbGVuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfSB1dWlkIC0gSW50ZXJuYWwgVVVJRCBrZXkuCiovClBoYXNlci5GcmFtZSA9IGZ1bmN0aW9uIChpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbmFtZSwgdXVpZCkgewoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhpcyBGcmFtZSB3aXRoaW4gdGhlIEZyYW1lRGF0YSBzZXQgaXQgaXMgYmVpbmcgYWRkZWQgdG8uCgkqLwoJdGhpcy5pbmRleCA9IGluZGV4OwoJCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCgkqLwoJdGhpcy54ID0geDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCgkqLwoJdGhpcy55ID0geTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIGZyYW1lLgoJKi8KCXRoaXMud2lkdGggPSB3aWR0aDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgZnJhbWUuCgkqLwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVXNlZnVsIGZvciBUZXh0dXJlIEF0bGFzIGZpbGVzIChpcyBzZXQgdG8gdGhlIGZpbGVuYW1lIHZhbHVlKS4KCSovCgl0aGlzLm5hbWUgPSBuYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gdXVpZCAtIEEgbGluayB0byB0aGUgUElYSS5UZXh0dXJlQ2FjaGUgZW50cnkuCgkqLwoJdGhpcy51dWlkID0gdXVpZDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclggLSBDZW50ZXIgWCBwb3NpdGlvbiB3aXRoaW4gdGhlIGltYWdlIHRvIGN1dCBmcm9tLgoJKi8KICAgIHRoaXMuY2VudGVyWCA9IE1hdGguZmxvb3Iod2lkdGggLyAyKTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclkgLSBDZW50ZXIgWSBwb3NpdGlvbiB3aXRoaW4gdGhlIGltYWdlIHRvIGN1dCBmcm9tLgoJKi8KICAgIHRoaXMuY2VudGVyWSA9IE1hdGguZmxvb3IoaGVpZ2h0IC8gMik7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBkaXN0YW5jZSAtIFRoZSBkaXN0YW5jZSBmcm9tIHRoZSB0b3AgbGVmdCB0byB0aGUgYm90dG9tLXJpZ2h0IG9mIHRoaXMgRnJhbWUuCgkqLwoJdGhpcy5kaXN0YW5jZSA9IFBoYXNlci5NYXRoLmRpc3RhbmNlKDAsIDAsIHdpZHRoLCBoZWlnaHQpOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHJvdGF0ZWQgLSBSb3RhdGVkPyAobm90IHlldCBpbXBsZW1lbnRlZCkKCSogQGRlZmF1bHQKCSovCgl0aGlzLnJvdGF0ZWQgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtzdHJpbmd9IHJvdGF0aW9uRGlyZWN0aW9uIC0gRWl0aGVyICdjdycgb3IgJ2NjdycsIHJvdGF0aW9uIGlzIGFsd2F5cyA5MCBkZWdyZWVzLgoJKiBAZGVmYXVsdCAnY3cnCgkqLwoJdGhpcy5yb3RhdGlvbkRpcmVjdGlvbiA9ICdjdyc7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJpbW1lZCAtIFdhcyBpdCB0cmltbWVkIHdoZW4gcGFja2VkPwoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudHJpbW1lZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlU2l6ZVcgLSBXaWR0aCBvZiB0aGUgb3JpZ2luYWwgc3ByaXRlLgoJKi8KICAgIHRoaXMuc291cmNlU2l6ZVcgPSB3aWR0aDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNvdXJjZVNpemVIIC0gSGVpZ2h0IG9mIHRoZSBvcmlnaW5hbCBzcHJpdGUuCgkqLwogICAgdGhpcy5zb3VyY2VTaXplSCA9IGhlaWdodDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVYIC0gWCBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBzcHJpdGUgaW5zaWRlIG9yaWdpbmFsIHNwcml0ZS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnNwcml0ZVNvdXJjZVNpemVYID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVZIC0gWSBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBzcHJpdGUgaW5zaWRlIG9yaWdpbmFsIHNwcml0ZS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnNwcml0ZVNvdXJjZVNpemVZID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHNwcml0ZVNvdXJjZVNpemVXIC0gV2lkdGggb2YgdGhlIHRyaW1tZWQgc3ByaXRlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuc3ByaXRlU291cmNlU2l6ZVcgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZUggLSBIZWlnaHQgb2YgdGhlIHRyaW1tZWQgc3ByaXRlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuc3ByaXRlU291cmNlU2l6ZUggPSAwOwoKfTsKClBoYXNlci5GcmFtZS5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIElmIHRoZSBmcmFtZSB3YXMgdHJpbW1lZCB3aGVuIGFkZGVkIHRvIHRoZSBUZXh0dXJlIEF0bGFzIHRoaXMgcmVjb3JkcyB0aGUgdHJpbSBhbmQgc291cmNlIGRhdGEuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkZyYW1lI3NldFRyaW0KCSogQHBhcmFtIHtib29sZWFufSB0cmltbWVkIC0gSWYgdGhpcyBmcmFtZSB3YXMgdHJpbW1lZCBvciBub3QuCgkqIEBwYXJhbSB7bnVtYmVyfSBhY3R1YWxXaWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZnJhbWUgYmVmb3JlIGJlaW5nIHRyaW1tZWQuCgkqIEBwYXJhbSB7bnVtYmVyfSBhY3R1YWxIZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBmcmFtZSBiZWZvcmUgYmVpbmcgdHJpbW1lZC4KCSogQHBhcmFtIHtudW1iZXJ9IGRlc3RYIC0gVGhlIGRlc3RpbmF0aW9uIFggcG9zaXRpb24gb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCgkqIEBwYXJhbSB7bnVtYmVyfSBkZXN0WSAtIFRoZSBkZXN0aW5hdGlvbiBZIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIGZyYW1lIGZvciBkaXNwbGF5LgoJKiBAcGFyYW0ge251bWJlcn0gZGVzdFdpZHRoIC0gVGhlIGRlc3RpbmF0aW9uIHdpZHRoIG9mIHRoZSB0cmltbWVkIGZyYW1lIGZvciBkaXNwbGF5LgoJKiBAcGFyYW0ge251bWJlcn0gZGVzdEhlaWdodCAtIFRoZSBkZXN0aW5hdGlvbiBoZWlnaHQgb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCgkqLwogICAgc2V0VHJpbTogZnVuY3Rpb24gKHRyaW1tZWQsIGFjdHVhbFdpZHRoLCBhY3R1YWxIZWlnaHQsIGRlc3RYLCBkZXN0WSwgZGVzdFdpZHRoLCBkZXN0SGVpZ2h0KSB7CgogICAgICAgIHRoaXMudHJpbW1lZCA9IHRyaW1tZWQ7CgogICAgICAgIGlmICh0cmltbWVkKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IGFjdHVhbFdpZHRoOwogICAgICAgICAgICB0aGlzLmhlaWdodCA9IGFjdHVhbEhlaWdodDsKICAgICAgICAgICAgdGhpcy5zb3VyY2VTaXplVyA9IGFjdHVhbFdpZHRoOwogICAgICAgICAgICB0aGlzLnNvdXJjZVNpemVIID0gYWN0dWFsSGVpZ2h0OwoJCSAgICB0aGlzLmNlbnRlclggPSBNYXRoLmZsb29yKGFjdHVhbFdpZHRoIC8gMik7CgkJICAgIHRoaXMuY2VudGVyWSA9IE1hdGguZmxvb3IoYWN0dWFsSGVpZ2h0IC8gMik7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVggPSBkZXN0WDsKICAgICAgICAgICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplWSA9IGRlc3RZOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVXID0gZGVzdFdpZHRoOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVIID0gZGVzdEhlaWdodDsKICAgICAgICB9CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEZyYW1lRGF0YSBpcyBhIGNvbnRhaW5lciBmb3IgRnJhbWUgb2JqZWN0cywgd2hpY2ggYXJlIHRoZSBpbnRlcm5hbCByZXByZXNlbnRhdGlvbiBvZiBhbmltYXRpb24gZGF0YSBpbiBQaGFzZXIuCioKKiBAY2xhc3MgUGhhc2VyLkZyYW1lRGF0YQoqIEBjb25zdHJ1Y3RvcgoqLwpQaGFzZXIuRnJhbWVEYXRhID0gZnVuY3Rpb24gKCkgewoKCS8qKgoJKiBAcHJvcGVydHkge0FycmF5fSBfZnJhbWVzIC0gTG9jYWwgYXJyYXkgb2YgZnJhbWVzLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2ZyYW1lcyA9IFtdOwoKCgkvKioKCSogQHByb3BlcnR5IHtBcnJheX0gX2ZyYW1lTmFtZXMgLSBMb2NhbCBhcnJheSBvZiBmcmFtZSBuYW1lcyBmb3IgbmFtZSB0byBpbmRleCBjb252ZXJzaW9ucy4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9mcmFtZU5hbWVzID0gW107Cgp9OwoKUGhhc2VyLkZyYW1lRGF0YS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgRnJhbWUgdG8gdGhpcyBGcmFtZURhdGEgY29sbGVjdGlvbi4gVHlwaWNhbGx5IGNhbGxlZCBieSB0aGUgQW5pbWF0aW9uLlBhcnNlciBhbmQgbm90IGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjYWRkRnJhbWUKICAgICogQHBhcmFtIHtQaGFzZXIuRnJhbWV9IGZyYW1lIC0gVGhlIGZyYW1lIHRvIGFkZCB0byB0aGlzIEZyYW1lRGF0YSBzZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIHRoYXQgd2FzIGp1c3QgYWRkZWQuCiAgICAqLwogICAgYWRkRnJhbWU6IGZ1bmN0aW9uIChmcmFtZSkgewoKICAgICAgICBmcmFtZS5pbmRleCA9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7CgogICAgICAgIHRoaXMuX2ZyYW1lcy5wdXNoKGZyYW1lKTsKCiAgICAgICAgaWYgKGZyYW1lLm5hbWUgIT09ICcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZnJhbWVOYW1lc1tmcmFtZS5uYW1lXSA9IGZyYW1lLmluZGV4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZyYW1lOwoKICAgIH0sCgoJLyoqCgkqIEdldCBhIEZyYW1lIGJ5IGl0cyBudW1lcmljYWwgaW5kZXguCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZQoJKiBAcGFyYW0ge251bWJlcn0gaW5kZXggLSBUaGUgaW5kZXggb2YgdGhlIGZyYW1lIHlvdSB3YW50IHRvIGdldC4KCSogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUsIGlmIGZvdW5kLgoJKi8KICAgIGdldEZyYW1lOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZyYW1lcy5sZW5ndGggPiBpbmRleCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXNbaW5kZXhdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgRnJhbWUgYnkgaXRzIGZyYW1lIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZUJ5TmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZSB5b3Ugd2FudCB0byBnZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lLCBpZiBmb3VuZC4KICAgICovCiAgICBnZXRGcmFtZUJ5TmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9mcmFtZU5hbWVzW25hbWVdID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVOYW1lc1tuYW1lXV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBpZiB0aGVyZSBpcyBhIEZyYW1lIHdpdGggdGhlIGdpdmVuIG5hbWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNjaGVja0ZyYW1lTmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBmcmFtZSB5b3Ugd2FudCB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZnJhbWUgaXMgZm91bmQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjaGVja0ZyYW1lTmFtZTogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ZyYW1lTmFtZXNbbmFtZV0gPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIAogICAgfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmdlIG9mIGZyYW1lcyBiYXNlZCBvbiB0aGUgZ2l2ZW4gc3RhcnQgYW5kIGVuZCBmcmFtZSBpbmRleGVzIGFuZCByZXR1cm5zIHRoZW0gaW4gYW4gQXJyYXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZVJhbmdlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBzdGFydGluZyBmcmFtZSBpbmRleC4KCSogQHBhcmFtIHtudW1iZXJ9IGVuZCAtIFRoZSBlbmRpbmcgZnJhbWUgaW5kZXguCgkqIEBwYXJhbSB7QXJyYXl9IFtvdXRwdXRdIC0gSWYgZ2l2ZW4gdGhlIHJlc3VsdHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoaXMgYXJyYXkgb3RoZXJ3aXNlIGEgbmV3IGFycmF5IHdpbGwgYmUgY3JlYXRlZC4KCSogQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIEZyYW1lcyBiZXR3ZWVuIHRoZSBzdGFydCBhbmQgZW5kIGluZGV4IHZhbHVlcywgb3IgYW4gZW1wdHkgYXJyYXkgaWYgbm9uZSB3ZXJlIGZvdW5kLgoJKi8KICAgIGdldEZyYW1lUmFuZ2U6IGZ1bmN0aW9uIChzdGFydCwgZW5kLCBvdXRwdXQpIHsKICAgICAgICAKICAgICAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gW107IH0KCiAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDw9IGVuZDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5fZnJhbWVzW2ldKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCgkvKioKCSogUmV0dXJucyBhbGwgb2YgdGhlIEZyYW1lcyBpbiB0aGlzIEZyYW1lRGF0YSBzZXQgd2hlcmUgdGhlIGZyYW1lIGluZGV4IGlzIGZvdW5kIGluIHRoZSBpbnB1dCBhcnJheS4KICAgICogVGhlIGZyYW1lcyBhcmUgcmV0dXJuZWQgaW4gdGhlIG91dHB1dCBhcnJheSwgb3IgaWYgbm9uZSBpcyBwcm92aWRlZCBpbiBhIG5ldyBBcnJheSBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNnZXRGcmFtZXMKICAgICogQHBhcmFtIHtBcnJheX0gZnJhbWVzIC0gQW4gQXJyYXkgY29udGFpbmluZyB0aGUgaW5kZXhlcyBvZiB0aGUgZnJhbWVzIHRvIHJldHJpZXZlLiBJZiB0aGUgYXJyYXkgaXMgZW1wdHkgdGhlbiBhbGwgZnJhbWVzIGluIHRoZSBGcmFtZURhdGEgYXJlIHJldHVybmVkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBBcmUgdGhlIGdpdmVuIGZyYW1lcyB1c2luZyBudW1lcmljIGluZGV4ZXMgKGRlZmF1bHQpIG9yIHN0cmluZ3M/IChmYWxzZSkKICAgICogQHBhcmFtIHtBcnJheX0gW291dHB1dF0gLSBJZiBnaXZlbiB0aGUgcmVzdWx0cyB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZSBlbmQgb2YgdGhpcyBhcnJheSBvdGhlcndpc2UgYSBuZXcgYXJyYXkgd2lsbCBiZSBjcmVhdGVkLgogICAgKiBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgYWxsIEZyYW1lcyBpbiB0aGlzIEZyYW1lRGF0YSBzZXQgbWF0Y2hpbmcgdGhlIGdpdmVuIG5hbWVzIG9yIElEcy4KCSovCiAgICBnZXRGcmFtZXM6IGZ1bmN0aW9uIChmcmFtZXMsIHVzZU51bWVyaWNJbmRleCwgb3V0cHV0KSB7CgogICAgICAgIGlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09PSAidW5kZWZpbmVkIikgeyB1c2VOdW1lcmljSW5kZXggPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IFtdOyB9CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVzID09PSAidW5kZWZpbmVkIiB8fCBmcmFtZXMubGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgTm8gaW5wdXQgYXJyYXksIHNvIHdlIGxvb3AgdGhyb3VnaCBhbGwgZnJhbWVzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fZnJhbWVzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2Ugb25seSBuZWVkIHRoZSBpbmRleGVzCiAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLl9mcmFtZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJbnB1dCBhcnJheSBnaXZlbiwgbG9vcCB0aHJvdWdoIHRoYXQgaW5zdGVhZAogICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gZnJhbWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgRG9lcyB0aGUgaW5wdXQgYXJyYXkgY29udGFpbiBuYW1lcyBvciBpbmRleGVzPwogICAgICAgICAgICAgICAgaWYgKHVzZU51bWVyaWNJbmRleCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhlIGFjdHVhbCBmcmFtZQogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuZ2V0RnJhbWUoZnJhbWVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFRoZSBhY3R1YWwgZnJhbWUKICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmdldEZyYW1lQnlOYW1lKGZyYW1lc1tpXSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYWxsIG9mIHRoZSBGcmFtZSBpbmRleGVzIGluIHRoaXMgRnJhbWVEYXRhIHNldC4KICAgICogVGhlIGZyYW1lcyBpbmRleGVzIGFyZSByZXR1cm5lZCBpbiB0aGUgb3V0cHV0IGFycmF5LCBvciBpZiBub25lIGlzIHByb3ZpZGVkIGluIGEgbmV3IEFycmF5IG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2dldEZyYW1lSW5kZXhlcwogICAgKiBAcGFyYW0ge0FycmF5fSBmcmFtZXMgLSBBbiBBcnJheSBjb250YWluaW5nIHRoZSBpbmRleGVzIG9mIHRoZSBmcmFtZXMgdG8gcmV0cmlldmUuIElmIHRoZSBhcnJheSBpcyBlbXB0eSB0aGVuIGFsbCBmcmFtZXMgaW4gdGhlIEZyYW1lRGF0YSBhcmUgcmV0dXJuZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZU51bWVyaWNJbmRleD10cnVlXSAtIEFyZSB0aGUgZ2l2ZW4gZnJhbWVzIHVzaW5nIG51bWVyaWMgaW5kZXhlcyAoZGVmYXVsdCkgb3Igc3RyaW5ncz8gKGZhbHNlKQogICAgKiBAcGFyYW0ge0FycmF5fSBbb3V0cHV0XSAtIElmIGdpdmVuIHRoZSByZXN1bHRzIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiB0aGlzIGFycmF5IG90aGVyd2lzZSBhIG5ldyBhcnJheSB3aWxsIGJlIGNyZWF0ZWQuCiAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBhbGwgRnJhbWUgaW5kZXhlcyBtYXRjaGluZyB0aGUgZ2l2ZW4gbmFtZXMgb3IgSURzLgogICAgKi8KICAgIGdldEZyYW1lSW5kZXhlczogZnVuY3Rpb24gKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4LCBvdXRwdXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB1c2VOdW1lcmljSW5kZXggPT09ICJ1bmRlZmluZWQiKSB7IHVzZU51bWVyaWNJbmRleCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gW107IH0KCiAgICAgICAgaWYgKHR5cGVvZiBmcmFtZXMgPT09ICJ1bmRlZmluZWQiIHx8IGZyYW1lcy5sZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBObyBmcmFtZXMgYXJyYXksIHNvIHdlIGxvb3AgdGhyb3VnaCBhbGwgZnJhbWVzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLl9mcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuX2ZyYW1lc1tpXS5pbmRleCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElucHV0IGFycmF5IGdpdmVuLCBsb29wIHRocm91Z2ggdGhhdCBpbnN0ZWFkCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBmcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb2VzIHRoZSBmcmFtZXMgYXJyYXkgY29udGFpbiBuYW1lcyBvciBpbmRleGVzPwogICAgICAgICAgICAgICAgaWYgKHVzZU51bWVyaWNJbmRleCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZXNbaV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEZyYW1lQnlOYW1lKGZyYW1lc1tpXSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLmdldEZyYW1lQnlOYW1lKGZyYW1lc1tpXSkuaW5kZXgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKCiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLkZyYW1lRGF0YSN0b3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgZnJhbWVzIGluIHRoaXMgRnJhbWVEYXRhIHNldC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5GcmFtZURhdGEucHJvdG90eXBlLCAidG90YWwiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lcy5sZW5ndGg7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFJlc3BvbnNpYmxlIGZvciBwYXJzaW5nIHNwcml0ZSBzaGVldCBhbmQgSlNPTiBkYXRhIGludG8gdGhlIGludGVybmFsIEZyYW1lRGF0YSBmb3JtYXQgdGhhdCBQaGFzZXIgdXNlcyBmb3IgYW5pbWF0aW9ucy4KKgoqIEBjbGFzcyBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyCiovClBoYXNlci5BbmltYXRpb25QYXJzZXIgPSB7CgogICAgLyoqCiAgICAqIFBhcnNlIGEgU3ByaXRlIFNoZWV0IGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuc3ByaXRlU2hlZXQKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSBTcHJpdGUgU2hlZXQgaW1hZ2UuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZVdpZHRoIC0gVGhlIGZpeGVkIHdpZHRoIG9mIGVhY2ggZnJhbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lSGVpZ2h0IC0gVGhlIGZpeGVkIGhlaWdodCBvZiBlYWNoIGZyYW1lIG9mIHRoZSBhbmltYXRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVNYXg9LTFdIC0gVGhlIHRvdGFsIG51bWJlciBvZiBhbmltYXRpb24gZnJhbWVzIHRvIGV4dGFjdCBmcm9tIHRoZSBTcHJpdGUgU2hlZXQuIFRoZSBkZWZhdWx0IHZhbHVlIG9mIC0xIG1lYW5zICJleHRyYWN0IGFsbCBmcmFtZXMiLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBzcHJpdGVTaGVldDogZnVuY3Rpb24gKGdhbWUsIGtleSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4KSB7CgogICAgICAgIC8vICBIb3cgYmlnIGlzIG91ciBpbWFnZT8KICAgICAgICB2YXIgaW1nID0gZ2FtZS5jYWNoZS5nZXRJbWFnZShrZXkpOwoKICAgICAgICBpZiAoaW1nID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIHZhciB3aWR0aCA9IGltZy53aWR0aDsKICAgICAgICB2YXIgaGVpZ2h0ID0gaW1nLmhlaWdodDsKCiAgICAgICAgaWYgKGZyYW1lV2lkdGggPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZyYW1lV2lkdGggPSBNYXRoLmZsb29yKC13aWR0aCAvIE1hdGgubWluKC0xLCBmcmFtZVdpZHRoKSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoZnJhbWVIZWlnaHQgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGZyYW1lSGVpZ2h0ID0gTWF0aC5mbG9vcigtaGVpZ2h0IC8gTWF0aC5taW4oLTEsIGZyYW1lSGVpZ2h0KSk7CiAgICAgICAgfQoKICAgICAgICB2YXIgcm93ID0gTWF0aC5yb3VuZCh3aWR0aCAvIGZyYW1lV2lkdGgpOwogICAgICAgIHZhciBjb2x1bW4gPSBNYXRoLnJvdW5kKGhlaWdodCAvIGZyYW1lSGVpZ2h0KTsKICAgICAgICB2YXIgdG90YWwgPSByb3cgKiBjb2x1bW47CiAgICAgICAgCiAgICAgICAgaWYgKGZyYW1lTWF4ICE9PSAtMSkKICAgICAgICB7CiAgICAgICAgICAgIHRvdGFsID0gZnJhbWVNYXg7CiAgICAgICAgfQoKICAgICAgICAvLyAgWmVybyBvciBzbWFsbGVyIHRoYW4gZnJhbWUgc2l6ZXM/CiAgICAgICAgaWYgKHdpZHRoID09IDAgfHwgaGVpZ2h0ID09IDAgfHwgd2lkdGggPCBmcmFtZVdpZHRoIHx8IGhlaWdodCA8IGZyYW1lSGVpZ2h0IHx8IHRvdGFsID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLnNwcml0ZVNoZWV0OiB3aWR0aC9oZWlnaHQgemVybyBvciB3aWR0aC9oZWlnaHQgPCBnaXZlbiBmcmFtZVdpZHRoL2ZyYW1lSGVpZ2h0Iik7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgLy8gIExldCdzIGNyZWF0ZSBzb21lIGZyYW1lcyB0aGVuCiAgICAgICAgdmFyIGRhdGEgPSBuZXcgUGhhc2VyLkZyYW1lRGF0YSgpOwogICAgICAgIHZhciB4ID0gMDsKICAgICAgICB2YXIgeSA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWw7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKGksIHgsIHksIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0LCAnJywgdXVpZCkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldLCB7CiAgICAgICAgICAgICAgICB4OiB4LAogICAgICAgICAgICAgICAgeTogeSwKICAgICAgICAgICAgICAgIHdpZHRoOiBmcmFtZVdpZHRoLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZUhlaWdodAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHggKz0gZnJhbWVXaWR0aDsKCiAgICAgICAgICAgIGlmICh4ID09PSB3aWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgICAgICAgICB5ICs9IGZyYW1lSGVpZ2h0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aGUgSlNPTiBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGEKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge09iamVjdH0ganNvbiAtIFRoZSBKU09OIGRhdGEgZnJvbSB0aGUgVGV4dHVyZSBBdGxhcy4gTXVzdCBiZSBpbiBBcnJheSBmb3JtYXQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUtleSAtIFRoZSBHYW1lLkNhY2hlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBpbWFnZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgSlNPTkRhdGE6IGZ1bmN0aW9uIChnYW1lLCBqc29uLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICghanNvblsnZnJhbWVzJ10pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGE6IEludmFsaWQgVGV4dHVyZSBBdGxhcyBKU09OIGdpdmVuLCBtaXNzaW5nICdmcmFtZXMnIGFycmF5Iik7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CiAgICAgICAgCiAgICAgICAgLy8gIEJ5IHRoaXMgc3RhZ2UgZnJhbWVzIGlzIGEgZnVsbHkgcGFyc2VkIGFycmF5CiAgICAgICAgdmFyIGZyYW1lcyA9IGpzb25bJ2ZyYW1lcyddOwogICAgICAgIHZhciBuZXdGcmFtZTsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgbmV3RnJhbWUgPSBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAJZnJhbWVzW2ldLmZyYW1lLngsIAogICAgICAgICAgICAJZnJhbWVzW2ldLmZyYW1lLnksIAogICAgICAgICAgICAJZnJhbWVzW2ldLmZyYW1lLncsIAogICAgICAgICAgICAJZnJhbWVzW2ldLmZyYW1lLmgsIAogICAgICAgICAgICAJZnJhbWVzW2ldLmZpbGVuYW1lLAogICAgICAgICAgICAgICAgdXVpZAoJCQkpKTsKCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbY2FjaGVLZXldLCB7CiAgICAgICAgICAgICAgICB4OiBmcmFtZXNbaV0uZnJhbWUueCwKICAgICAgICAgICAgICAgIHk6IGZyYW1lc1tpXS5mcmFtZS55LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lc1tpXS5mcmFtZS53LAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZXNbaV0uZnJhbWUuaAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChmcmFtZXNbaV0udHJpbW1lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSgKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0udHJpbW1lZCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNvdXJjZVNpemUudywgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNvdXJjZVNpemUuaCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUueCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUueSwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUudywgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUuaAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAvLyAgV2UgaGFkIHRvIGhhY2sgUGl4aSB0byBnZXQgdGhpcyB0byB3b3JrIDooCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltbWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueCA9IGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLng7CiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltLnkgPSBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS55OwoKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGhlIEpTT04gZGF0YSBhbmQgZXh0cmFjdCB0aGUgYW5pbWF0aW9uIGZyYW1lIGRhdGEgZnJvbSBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhSGFzaAogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIEpTT04gZGF0YSBmcm9tIHRoZSBUZXh0dXJlIEF0bGFzLiBNdXN0IGJlIGluIEpTT04gSGFzaCBmb3JtYXQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjYWNoZUtleSAtIFRoZSBHYW1lLkNhY2hlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBpbWFnZS4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gQSBGcmFtZURhdGEgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHBhcnNlZCBmcmFtZXMuCiAgICAqLwogICAgSlNPTkRhdGFIYXNoOiBmdW5jdGlvbiAoZ2FtZSwganNvbiwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIWpzb25bJ2ZyYW1lcyddKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhSGFzaDogSW52YWxpZCBUZXh0dXJlIEF0bGFzIEpTT04gZ2l2ZW4sIG1pc3NpbmcgJ2ZyYW1lcycgb2JqZWN0Iik7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGpzb24pOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CgogICAgICAgIC8vICBCeSB0aGlzIHN0YWdlIGZyYW1lcyBpcyBhIGZ1bGx5IHBhcnNlZCBhcnJheQogICAgICAgIHZhciBmcmFtZXMgPSBqc29uWydmcmFtZXMnXTsKICAgICAgICB2YXIgbmV3RnJhbWU7CiAgICAgICAgdmFyIGkgPSAwOwogICAgICAgIAogICAgICAgIGZvciAodmFyIGtleSBpbiBmcmFtZXMpCiAgICAgICAgewogICAgICAgICAgICB2YXIgdXVpZCA9IGdhbWUucm5kLnV1aWQoKTsKCiAgICAgICAgICAgIG5ld0ZyYW1lID0gZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLngsIAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUueSwgCiAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5mcmFtZS53LCAKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLmgsIAogICAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgICAgdXVpZAogICAgICAgICAgICApKTsKCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbY2FjaGVLZXldLCB7CiAgICAgICAgICAgICAgICB4OiBmcmFtZXNba2V5XS5mcmFtZS54LAogICAgICAgICAgICAgICAgeTogZnJhbWVzW2tleV0uZnJhbWUueSwKICAgICAgICAgICAgICAgIHdpZHRoOiBmcmFtZXNba2V5XS5mcmFtZS53LAogICAgICAgICAgICAgICAgaGVpZ2h0OiBmcmFtZXNba2V5XS5mcmFtZS5oCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGZyYW1lc1trZXldLnRyaW1tZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5ld0ZyYW1lLnNldFRyaW0oCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0udHJpbW1lZCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc291cmNlU2l6ZS53LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zb3VyY2VTaXplLmgsIAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUueCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS55LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLncsIAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUuaAogICAgICAgICAgICAgICAgKTsKCiAgICAgICAgICAgICAgICAvLyAgV2UgaGFkIHRvIGhhY2sgUGl4aSB0byBnZXQgdGhpcyB0byB3b3JrIDooCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltbWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueCA9IGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUueDsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueSA9IGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUueTsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhcnNlIHRoZSBYTUwgZGF0YSBhbmQgZXh0cmFjdCB0aGUgYW5pbWF0aW9uIGZyYW1lIGRhdGEgZnJvbSBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGEKICAgICogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgogICAgKiBAcGFyYW0ge09iamVjdH0geG1sIC0gVGhlIFhNTCBkYXRhIGZyb20gdGhlIFRleHR1cmUgQXRsYXMuIE11c3QgYmUgaW4gU3RhcmxpbmcgWE1MIGZvcm1hdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlS2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGltYWdlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBYTUxEYXRhOiBmdW5jdGlvbiAoZ2FtZSwgeG1sLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICgheG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdUZXh0dXJlQXRsYXMnKSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLkFuaW1hdGlvblBhcnNlci5YTUxEYXRhOiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgWE1MIGdpdmVuLCBtaXNzaW5nIDxUZXh0dXJlQXRsYXM+IHRhZyIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CiAgICAgICAgdmFyIGZyYW1lcyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnU3ViVGV4dHVyZScpOwogICAgICAgIHZhciBuZXdGcmFtZTsKCiAgICAgICAgdmFyIHV1aWQ7CiAgICAgICAgdmFyIGZyYW1lOwogICAgICAgIHZhciB4OwogICAgICAgIHZhciB5OwogICAgICAgIHZhciB3aWR0aDsKICAgICAgICB2YXIgaGVpZ2h0OwogICAgICAgIHZhciBmcmFtZVg7CiAgICAgICAgdmFyIGZyYW1lWTsKICAgICAgICB2YXIgZnJhbWVXaWR0aDsKICAgICAgICB2YXIgZnJhbWVIZWlnaHQ7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBmcmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgZnJhbWUgPSBmcmFtZXNbaV0uYXR0cmlidXRlczsKCiAgICAgICAgICAgIG5hbWUgPSBmcmFtZS5uYW1lLm5vZGVWYWx1ZTsKICAgICAgICAgICAgeCA9IHBhcnNlSW50KGZyYW1lLngubm9kZVZhbHVlKTsKICAgICAgICAgICAgeSA9IHBhcnNlSW50KGZyYW1lLnkubm9kZVZhbHVlKTsKICAgICAgICAgICAgd2lkdGggPSBwYXJzZUludChmcmFtZS53aWR0aC5ub2RlVmFsdWUpOwogICAgICAgICAgICBoZWlnaHQgPSBwYXJzZUludChmcmFtZS5oZWlnaHQubm9kZVZhbHVlKTsKCiAgICAgICAgICAgIGZyYW1lWCA9IG51bGw7CiAgICAgICAgICAgIGZyYW1lWSA9IG51bGw7CgogICAgICAgICAgICBpZiAoZnJhbWUuZnJhbWVYKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmcmFtZVggPSBNYXRoLmFicyhwYXJzZUludChmcmFtZS5mcmFtZVgubm9kZVZhbHVlKSk7CiAgICAgICAgICAgICAgICBmcmFtZVkgPSBNYXRoLmFicyhwYXJzZUludChmcmFtZS5mcmFtZVkubm9kZVZhbHVlKSk7CiAgICAgICAgICAgICAgICBmcmFtZVdpZHRoID0gcGFyc2VJbnQoZnJhbWUuZnJhbWVXaWR0aC5ub2RlVmFsdWUpOwogICAgICAgICAgICAgICAgZnJhbWVIZWlnaHQgPSBwYXJzZUludChmcmFtZS5mcmFtZUhlaWdodC5ub2RlVmFsdWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBuZXdGcmFtZSA9IGRhdGEuYWRkRnJhbWUobmV3IFBoYXNlci5GcmFtZShpLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBuYW1lLCB1dWlkKSk7CgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2NhY2hlS2V5XSwgewogICAgICAgICAgICAgICAgeDogeCwKICAgICAgICAgICAgICAgIHk6IHksCiAgICAgICAgICAgICAgICB3aWR0aDogd2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGhlaWdodAogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vICBUcmltbWVkPwogICAgICAgICAgICBpZiAoZnJhbWVYICE9PSBudWxsIHx8IGZyYW1lWSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSh0cnVlLCB3aWR0aCwgaGVpZ2h0LCBmcmFtZVgsIGZyYW1lWSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQpOwoKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnJlYWxTaXplID0geyB4OiBmcmFtZVgsIHk6IGZyYW1lWSwgdzogZnJhbWVXaWR0aCwgaDogZnJhbWVIZWlnaHQgfTsKCiAgICAgICAgICAgICAgICAvLyAgV2UgaGFkIHRvIGhhY2sgUGl4aSB0byBnZXQgdGhpcyB0byB3b3JrIDooCiAgICAgICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXS50cmltbWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueCA9IGZyYW1lWDsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueSA9IGZyYW1lWTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5DYWNoZSBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyAgICBQaGFzZXIuQ2FjaGUKKiBAY2xhc3NkZXNjIEEgZ2FtZSBvbmx5IGhhcyBvbmUgaW5zdGFuY2Ugb2YgYSBDYWNoZSBhbmQgaXQgaXMgdXNlZCB0byBzdG9yZSBhbGwgZXh0ZXJuYWxseSBsb2FkZWQgYXNzZXRzIHN1Y2gKKiBhcyBpbWFnZXMsIHNvdW5kcyBhbmQgZGF0YSBmaWxlcyBhcyBhIHJlc3VsdCBvZiBMb2FkZXIgY2FsbHMuIENhY2hlIGl0ZW1zIHVzZSBzdHJpbmcgYmFzZWQga2V5cyBmb3IgbG9vay11cC4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5DYWNoZSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gZ2FtZSAtIENhbnZhcyBrZXktdmFsdWUgY29udGFpbmVyLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2NhbnZhc2VzID0ge307CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfaW1hZ2VzIC0gSW1hZ2Uga2V5LXZhbHVlIGNvbnRhaW5lci4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9pbWFnZXMgPSB7fTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF90ZXh0dXJlcyAtIFJlbmRlclRleHR1cmUga2V5LXZhbHVlIGNvbnRhaW5lci4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl90ZXh0dXJlcyA9IHt9OwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gX3NvdW5kcyAtIFNvdW5kIGtleS12YWx1ZSBjb250YWluZXIuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fc291bmRzID0ge307CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdGV4dCAtIFRleHQga2V5LXZhbHVlIGNvbnRhaW5lci4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl90ZXh0ID0ge307CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfdGlsZW1hcHMgLSBUaWxlbWFwIGtleS12YWx1ZSBjb250YWluZXIuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fdGlsZW1hcHMgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF90aWxlc2V0cyAtIFRpbGVzZXQga2V5LXZhbHVlIGNvbnRhaW5lci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90aWxlc2V0cyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2JpdG1hcERhdGFzIC0gQml0bWFwRGF0YSBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JpdG1hcERhdGFzID0ge307CgogICAgdGhpcy5hZGREZWZhdWx0SW1hZ2UoKTsKICAgIHRoaXMuYWRkTWlzc2luZ0ltYWdlKCk7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Tb3VuZFVubG9jayAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMub25Tb3VuZFVubG9jayA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKfTsKClBoYXNlci5DYWNoZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBjYW52YXMgb2JqZWN0IGluIHRvIHRoZSBjYWNoZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQ2FudmFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoaXMgY2FudmFzLgogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBDYW52YXMgRE9NIGVsZW1lbnQuCiAgICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gUmVuZGVyIGNvbnRleHQgb2YgdGhpcyBjYW52YXMuCiAgICAqLwogICAgYWRkQ2FudmFzOiBmdW5jdGlvbiAoa2V5LCBjYW52YXMsIGNvbnRleHQpIHsKCiAgICAgICAgdGhpcy5fY2FudmFzZXNba2V5XSA9IHsgY2FudmFzOiBjYW52YXMsIGNvbnRleHQ6IGNvbnRleHQgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBCaXRtYXBEYXRhIG9iamVjdCBpbiB0byB0aGUgY2FjaGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZEJpdG1hcERhdGEKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhpcyBCaXRtYXBEYXRhLgogICAgKiBAcGFyYW0ge1BoYXNlci5CaXRtYXBEYXRhfSBiaXRtYXBEYXRhIC0gVGhlIEJpdG1hcERhdGEgb2JqZWN0IHRvIGJlIGFkZGRlZCB0byB0aGUgY2FjaGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBvYmplY3QgdG8gYmUgYWRkZGVkIHRvIHRoZSBjYWNoZS4KICAgICovCiAgICBhZGRCaXRtYXBEYXRhOiBmdW5jdGlvbiAoa2V5LCBiaXRtYXBEYXRhKSB7CgogICAgICAgIHRoaXMuX2JpdG1hcERhdGFzW2tleV0gPSBiaXRtYXBEYXRhOwoKICAgICAgICByZXR1cm4gYml0bWFwRGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgUGhhc2VyLlJlbmRlclRleHR1cmUgaW4gdG8gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRSZW5kZXJUZXh0dXJlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlRleHR1cmV9IHRleHR1cmUgLSBUaGUgdGV4dHVyZSB0byB1c2UgYXMgdGhlIGJhc2Ugb2YgdGhlIFJlbmRlclRleHR1cmUuCiAgICAqLwogICAgYWRkUmVuZGVyVGV4dHVyZTogZnVuY3Rpb24gKGtleSwgdGV4dHVyZSkgewoKICAgICAgICB2YXIgZnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIHRleHR1cmUud2lkdGgsIHRleHR1cmUuaGVpZ2h0LCAnJywgJycpOwoKICAgICAgICB0aGlzLl90ZXh0dXJlc1trZXldID0geyB0ZXh0dXJlOiB0ZXh0dXJlLCBmcmFtZTogZnJhbWUgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgc3ByaXRlIHNoZWV0IGluIHRvIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkU3ByaXRlU2hlZXQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHNwcml0ZSBzaGVldCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHNwcml0ZSBzaGVldCBkYXRhLgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVXaWR0aCAtIFdpZHRoIG9mIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZUhlaWdodCAtIEhlaWdodCBvZiB0aGUgc3ByaXRlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVNYXggLSBIb3cgbWFueSBmcmFtZXMgc3RvcmVkIGluIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqLwogICAgYWRkU3ByaXRlU2hlZXQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4KSB7CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgc3ByaXRlU2hlZXQ6IHRydWUsIGZyYW1lV2lkdGg6IGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0OiBmcmFtZUhlaWdodCB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5zcHJpdGVTaGVldCh0aGlzLmdhbWUsIGtleSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsIGZyYW1lTWF4KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdGlsZSBzZXQgaW4gdG8gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUaWxlc2V0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyB0aWxlIHNldCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHRpbGUgc2V0IGRhdGEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlV2lkdGggLSBXaWR0aCBvZiB0aGUgc3ByaXRlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUhlaWdodCAtIEhlaWdodCBvZiB0aGUgc3ByaXRlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZU1heCAtIEhvdyBtYW55IHRpbGVzIHN0b3JlZCBpbiB0aGUgc3ByaXRlIHNoZWV0LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbGVNYXJnaW49MF0gLSBJZiB0aGUgdGlsZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggYSBtYXJnaW4sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbGVTcGFjaW5nPTBdIC0gSWYgdGhlIHRpbGVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIHNwYWNpbmcgYmV0d2VlbiB0aGVtLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KICAgICovCiAgICBhZGRUaWxlc2V0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1heCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcpIHsKCiAgICAgICAgdGhpcy5fdGlsZXNldHNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHRpbGVXaWR0aDogdGlsZVdpZHRoLCB0aWxlSGVpZ2h0OiB0aWxlSGVpZ2h0LCB0aWxlTWFyZ2luOiB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZzogdGlsZVNwYWNpbmcgfTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIHRoaXMuX3RpbGVzZXRzW2tleV0udGlsZURhdGEgPSBQaGFzZXIuVGlsZW1hcFBhcnNlci50aWxlc2V0KHRoaXMuZ2FtZSwga2V5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXgsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdGlsZW1hcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkVGlsZW1hcAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoZSB0aWxlbWFwIGltYWdlLgogICAgKiBAcGFyYW0ge29iamVjdH0gbWFwRGF0YSAtIFRoZSB0aWxlbWFwIGRhdGEgb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0gZm9ybWF0IC0gVGhlIGZvcm1hdCBvZiB0aGUgdGlsZW1hcCBkYXRhLgogICAgKi8KICAgIGFkZFRpbGVtYXA6IGZ1bmN0aW9uIChrZXksIHVybCwgbWFwRGF0YSwgZm9ybWF0KSB7CgogICAgICAgIHRoaXMuX3RpbGVtYXBzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBtYXBEYXRhLCBmb3JtYXQ6IGZvcm1hdCB9OwoKICAgICAgICB0aGlzLl90aWxlbWFwc1trZXldLmxheWVycyA9IFBoYXNlci5UaWxlbWFwUGFyc2VyLnBhcnNlKHRoaXMuZ2FtZSwgbWFwRGF0YSwgZm9ybWF0KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdGV4dHVyZSBhdGxhcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkVGV4dHVyZUF0bGFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyB0ZXh0dXJlIGF0bGFzIGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgdGV4dHVyZSBhdGxhcyBkYXRhLgogICAgKiBAcGFyYW0ge29iamVjdH0gYXRsYXNEYXRhICAtIFRleHR1cmUgYXRsYXMgZnJhbWVzIGRhdGEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmb3JtYXQgLSBUaGUgZm9ybWF0IG9mIHRoZSB0ZXh0dXJlIGF0bGFzLgogICAgKi8KICAgIGFkZFRleHR1cmVBdGxhczogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhLCBhdGxhc0RhdGEsIGZvcm1hdCkgewoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHNwcml0ZVNoZWV0OiB0cnVlIH07CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoZGF0YSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0pOwoKICAgICAgICBpZiAoZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5KU09ORGF0YSh0aGlzLmdhbWUsIGF0bGFzRGF0YSwga2V5KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0gpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhSGFzaCh0aGlzLmdhbWUsIGF0bGFzRGF0YSwga2V5KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGEodGhpcy5nYW1lLCBhdGxhc0RhdGEsIGtleSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBCaXRtYXAgRm9udC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQml0bWFwRm9udAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgZm9udCB4bWwgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBmb250IGRhdGEuCiAgICAqIEBwYXJhbSB4bWxEYXRhIHtvYmplY3R9IFRleHR1cmUgYXRsYXMgZnJhbWVzIGRhdGEuCiAgICAqLwogICAgYWRkQml0bWFwRm9udDogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhLCB4bWxEYXRhKSB7CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgc3ByaXRlU2hlZXQ6IHRydWUgfTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIFBoYXNlci5Mb2FkZXJQYXJzZXIuYml0bWFwRm9udCh0aGlzLmdhbWUsIHhtbERhdGEsIGtleSk7CiAgICAgICAgLy8gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhID0gUGhhc2VyLkFuaW1hdGlvblBhcnNlci5YTUxEYXRhKHRoaXMuZ2FtZSwgeG1sRGF0YSwga2V5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgZGVmYXVsdCBpbWFnZSB0byBiZSB1c2VkIGluIHNwZWNpYWwgY2FzZXMgc3VjaCBhcyBXZWJHTCBGaWx0ZXJzLiBJcyBtYXBwZWQgdG8gdGhlIGtleSBfX2RlZmF1bHQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZERlZmF1bHRJbWFnZQogICAgKi8KICAgIGFkZERlZmF1bHRJbWFnZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgaW1nID0gbmV3IEltYWdlKCk7CiAgICAgICAgaW1nLnNyYyA9ICJkYXRhOmltYWdlL3BuZztiYXNlNjQsaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUNBQUFBQWdBUU1BQUFCSnRPaTNBQUFBQTFCTVZFWC8vLytueEJ2SUFBQUFBWFJTVGxNQVFPYllaZ0FBQUJWSlJFRlVlRjdOd0lFQUFBQUFnS0Q5cWRlb2NBTUFvQUFCbTNEa2NBQUFBQUJKUlU1RXJrSmdnZz09IjsKCiAgICAgICAgdGhpcy5faW1hZ2VzWydfX2RlZmF1bHQnXSA9IHsgdXJsOiBudWxsLCBkYXRhOiBpbWcsIHNwcml0ZVNoZWV0OiBmYWxzZSB9OwogICAgICAgIHRoaXMuX2ltYWdlc1snX19kZWZhdWx0J10uZnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIDMyLCAzMiwgJycsICcnKTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlWydfX2RlZmF1bHQnXSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGltZyk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbJ19fZGVmYXVsdCddID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fZGVmYXVsdCddKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGFuIGltYWdlIHRvIGJlIHVzZWQgd2hlbiBhIGtleSBpcyB3cm9uZyAvIG1pc3NpbmcuIElzIG1hcHBlZCB0byB0aGUga2V5IF9fbWlzc2luZy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkTWlzc2luZ0ltYWdlCiAgICAqLwogICAgYWRkTWlzc2luZ0ltYWdlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpbWcuc3JjID0gImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0NBSUFBQUQ4R08yakFBQUFHWFJGV0hSVGIyWjBkMkZ5WlFCQlpHOWlaU0JKYldGblpWSmxZV1I1Y2NsbFBBQUFBSjlKUkVGVWVOcTAxc3NPd3lBTVJGRzQ2di8vTXQxRVNtZ2grREZtRTJHUE9CQVJLYjJOVmpvKzE3UFhMRDhhMStwbDUrQSt3U2dGeWd5bVdZSEJiMEZ0c0toSkRkWmxuY0cySXpKNGF5b01EdjIwd1RtU016Q2xFZ2JXWU5UQWtRMForT0orQS9lV25BYVI5K294Q0Y0T3MwSDhodHNNVXArcHdjZ0JCaU1ObkF3RjhHcUlnTDJoQXphR0ZGZ1phdURQS0FCbW93WjRHTDM2OS8wcndBQ3AyeUEvdHRtdnNRQUFBQUJKUlU1RXJrSmdnZz09IjsKCiAgICAgICAgdGhpcy5faW1hZ2VzWydfX21pc3NpbmcnXSA9IHsgdXJsOiBudWxsLCBkYXRhOiBpbWcsIHNwcml0ZVNoZWV0OiBmYWxzZSB9OwogICAgICAgIHRoaXMuX2ltYWdlc1snX19taXNzaW5nJ10uZnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIDMyLCAzMiwgJycsICcnKTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlWydfX21pc3NpbmcnXSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGltZyk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbJ19fbWlzc2luZyddID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fbWlzc2luZyddKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgdGV4dCBkYXRhLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSB0ZXh0IGRhdGEuIAogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgdGV4dCBkYXRhIGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgdGV4dCBkYXRhLgogICAgKi8gICAgCiAgICBhZGRUZXh0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEpIHsKCiAgICAgICAgdGhpcy5fdGV4dFtrZXldID0gewogICAgICAgICAgICB1cmw6IHVybCwKICAgICAgICAgICAgZGF0YTogZGF0YQogICAgICAgIH07CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGltYWdlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRJbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgaW1hZ2UgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSBpbWFnZSBkYXRhLgogICAgKi8KICAgIGFkZEltYWdlOiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogZmFsc2UgfTsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIGRhdGEud2lkdGgsIGRhdGEuaGVpZ2h0LCBrZXksIHRoaXMuZ2FtZS5ybmQudXVpZCgpKTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IHNvdW5kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBzb3VuZCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHNvdW5kIGRhdGEuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gd2ViQXVkaW8gLSBUcnVlIGlmIHRoZSBmaWxlIGlzIHVzaW5nIHdlYiBhdWRpby4KICAgICogQHBhcmFtIHtib29sZWFufSBhdWRpb1RhZyAtIFRydWUgaWYgdGhlIGZpbGUgaXMgdXNpbmcgbGVnYWN5IEhUTUwgYXVkaW8uCiAgICAqLwogICAgYWRkU291bmQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgd2ViQXVkaW8sIGF1ZGlvVGFnKSB7CgogICAgICAgIHdlYkF1ZGlvID0gd2ViQXVkaW8gfHwgdHJ1ZTsKICAgICAgICBhdWRpb1RhZyA9IGF1ZGlvVGFnIHx8IGZhbHNlOwoKICAgICAgICB2YXIgbG9ja2VkID0gdGhpcy5nYW1lLnNvdW5kLnRvdWNoTG9ja2VkOwogICAgICAgIHZhciBkZWNvZGVkID0gZmFsc2U7CgogICAgICAgIGlmIChhdWRpb1RhZykKICAgICAgICB7CiAgICAgICAgICAgIGRlY29kZWQgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fc291bmRzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBpc0RlY29kaW5nOiBmYWxzZSwgZGVjb2RlZDogZGVjb2RlZCwgd2ViQXVkaW86IHdlYkF1ZGlvLCBhdWRpb1RhZzogYXVkaW9UYWcgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZWxvYWQgYSBzb3VuZC4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVsb2FkU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHJlbG9hZFNvdW5kOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRhdGEuc3JjID0gdGhpcy5fc291bmRzW2tleV0udXJsOwoKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5hZGRFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5yZWxvYWRTb3VuZENvbXBsZXRlKGtleSk7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRhdGEubG9hZCgpOwogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZWxvYWRTb3VuZENvbXBsZXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICovCiAgICByZWxvYWRTb3VuZENvbXBsZXRlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmxvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm9uU291bmRVbmxvY2suZGlzcGF0Y2goa2V5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3VwZGF0ZVNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICovCiAgICB1cGRhdGVTb3VuZDogZnVuY3Rpb24gKGtleSwgcHJvcGVydHksIHZhbHVlKSB7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV1bcHJvcGVydHldID0gdmFsdWU7CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCgkqIEFkZCBhIG5ldyBkZWNvZGVkIHNvdW5kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNkZWNvZGVkU291bmQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgoJKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIHNvdW5kIGRhdGEuCgkqLwogICAgZGVjb2RlZFNvdW5kOiBmdW5jdGlvbiAoa2V5LCBkYXRhKSB7CgogICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRhdGEgPSBkYXRhOwogICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmRlY29kZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX3NvdW5kc1trZXldLmlzRGVjb2RpbmcgPSBmYWxzZTsKCiAgICB9LAoKCS8qKgoJKiBHZXQgYSBjYW52YXMgb2JqZWN0IGZyb20gdGhlIGNhY2hlIGJ5IGl0cyBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldENhbnZhcwoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBjYW52YXMgeW91IHdhbnQuCgkqIEByZXR1cm4ge29iamVjdH0gVGhlIGNhbnZhcyB5b3Ugd2FudC4KCSovCiAgICBnZXRDYW52YXM6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2NhbnZhc2VzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fY2FudmFzZXNba2V5XS5jYW52YXM7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBCaXRtYXBEYXRhIG9iamVjdCBmcm9tIHRoZSBjYWNoZSBieSBpdHMga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRCaXRtYXBEYXRhCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIEJpdG1hcERhdGEgb2JqZWN0IHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIHJlcXVlc3RlZCBCaXRtYXBEYXRhIG9iamVjdCBpZiBmb3VuZCwgb3IgbnVsbCBpZiBub3QuCiAgICAqLwogICAgZ2V0Qml0bWFwRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fYml0bWFwRGF0YXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9iaXRtYXBEYXRhc1trZXldOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIGFuIGltYWdlIGtleSBleGlzdHMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2NoZWNrSW1hZ2VLZXkKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBleGlzdHMsIG90aGVyd2lzZSBmYWxzZS4KICAgICovICAgIAogICAgY2hlY2tJbWFnZUtleTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKCS8qKgoJKiBHZXQgaW1hZ2UgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEltYWdlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGltYWdlIHlvdSB3YW50LgoJKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBpbWFnZSBkYXRhIHlvdSB3YW50LgoJKi8gICAgCiAgICBnZXRJbWFnZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0aWxlIHNldCBpbWFnZSBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGlsZVNldEltYWdlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGltYWdlIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBpbWFnZSBkYXRhIHlvdSB3YW50LgogICAgKi8gICAgCiAgICBnZXRUaWxlc2V0SW1hZ2U6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RpbGVzZXRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGlsZXNldHNba2V5XS5kYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRpbGUgc2V0IGltYWdlIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUaWxlc2V0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGltYWdlIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZXNldH0gVGhlIHRpbGVzZXQgZGF0YS4gVGhlIHRpbGVzZXQgaW1hZ2UgaXMgaW4gdGhlIGRhdGEgcHJvcGVydHksIHRoZSB0aWxlIGRhdGEgaW4gdGlsZURhdGEuCiAgICAqLyAgICAKICAgIGdldFRpbGVzZXQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RpbGVzZXRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGlsZXNldHNba2V5XS50aWxlRGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0aWxlbWFwIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUaWxlbWFwCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHRpbGVtYXAgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhlIHRpbGVtYXAgZGF0YS4gVGhlIHRpbGVzZXQgaW1hZ2UgaXMgaW4gdGhlIGRhdGEgcHJvcGVydHksIHRoZSBtYXAgZGF0YSBpbiBtYXBEYXRhLgogICAgKi8KICAgIGdldFRpbGVtYXBEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90aWxlbWFwc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3RpbGVtYXBzW2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgoJLyoqCgkqIEdldCBmcmFtZSBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0RnJhbWVEYXRhCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCgkqIEByZXR1cm4ge1BoYXNlci5GcmFtZURhdGF9IFRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgoJKi8KICAgIGdldEZyYW1lRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIGZyYW1lIG91dCBvZiBhIGZyYW1lRGF0YSBzZXQgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRGcmFtZUJ5SW5kZXgKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICovCiAgICBnZXRGcmFtZUJ5SW5kZXg6IGZ1bmN0aW9uIChrZXksIGZyYW1lKSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhLmdldEZyYW1lKGZyYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIGZyYW1lIG91dCBvZiBhIGZyYW1lRGF0YSBzZXQgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRGcmFtZUJ5TmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKi8KICAgIGdldEZyYW1lQnlOYW1lOiBmdW5jdGlvbiAoa2V5LCBmcmFtZSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZShmcmFtZSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIHNpbmdsZSBmcmFtZSBieSBrZXkuIFlvdSdkIG9ubHkgZG8gdGhpcyB0byBnZXQgdGhlIGRlZmF1bHQgRnJhbWUgY3JlYXRlZCBmb3IgYSBub24tYXRsYXMvc3ByaXRlc2hlZXQgaW1hZ2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCiAgICAqLwogICAgZ2V0RnJhbWU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldICYmIHRoaXMuX2ltYWdlc1trZXldLnNwcml0ZVNoZWV0ID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBzaW5nbGUgZnJhbWUgYnkga2V5LiBZb3UnZCBvbmx5IGRvIHRoaXMgdG8gZ2V0IHRoZSBkZWZhdWx0IEZyYW1lIGNyZWF0ZWQgZm9yIGEgbm9uLWF0bGFzL3Nwcml0ZXNoZWV0IGltYWdlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0dXJlRnJhbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICovCiAgICBnZXRUZXh0dXJlRnJhbWU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RleHR1cmVzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZXNba2V5XS5mcmFtZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgUmVuZGVyVGV4dHVyZSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHR1cmUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgUmVuZGVyVGV4dHVyZSB5b3Ugd2FudC4KICAgICogQHJldHVybiB7UGhhc2VyLlJlbmRlclRleHR1cmV9IFRoZSBSZW5kZXJUZXh0dXJlIHlvdSB3YW50LgogICAgKi8KICAgIGdldFRleHR1cmU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RleHR1cmVzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dHVyZXNba2V5XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgoJLyoqCgkqIEdldCBzb3VuZCBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFNvdW5kCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHlvdSB3YW50LgoJKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBzb3VuZCB5b3Ugd2FudC4KCSovCiAgICBnZXRTb3VuZDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291bmRzW2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKCS8qKgoJKiBHZXQgc291bmQgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFNvdW5kRGF0YQoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCB5b3Ugd2FudC4KCSogQHJldHVybiB7b2JqZWN0fSBUaGUgc291bmQgZGF0YSB5b3Ugd2FudC4KCSovCiAgICBnZXRTb3VuZERhdGE6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3NvdW5kc1trZXldLmRhdGE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKCS8qKgoJKiBDaGVjayBpZiB0aGUgZ2l2ZW4gc291bmQgaGFzIGZpbmlzaGVkIGRlY29kaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNpc1NvdW5kRGVjb2RlZAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCB5b3Ugd2FudC4KCSogQHJldHVybiB7Ym9vbGVhbn0gVGhlIGRlY29kZWQgc3RhdGUgb2YgdGhlIFNvdW5kIG9iamVjdC4KCSovCiAgICBpc1NvdW5kRGVjb2RlZDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZDsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogQ2hlY2sgaWYgdGhlIGdpdmVuIHNvdW5kIGlzIHJlYWR5IGZvciBwbGF5YmFjay4gQSBzb3VuZCBpcyBjb25zaWRlcmVkIHJlYWR5IHdoZW4gaXQgaGFzIGZpbmlzaGVkIGRlY29kaW5nIGFuZCB0aGUgZGV2aWNlIGlzIG5vIGxvbmdlciB0b3VjaCBsb2NrZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU291bmRSZWFkeQoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzb3VuZCB5b3Ugd2FudC4KCSogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgc291bmQgaXMgZGVjb2RlZCBhbmQgdGhlIGRldmljZSBpcyBub3QgdG91Y2ggbG9ja2VkLgoJKi8KICAgIGlzU291bmRSZWFkeTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICByZXR1cm4gKHRoaXMuX3NvdW5kc1trZXldICYmIHRoaXMuX3NvdW5kc1trZXldLmRlY29kZWQgJiYgdGhpcy5nYW1lLnNvdW5kLnRvdWNoTG9ja2VkID09IGZhbHNlKTsKCiAgICB9LAoKCS8qKgoJKiBDaGVjayB3aGV0aGVyIGFuIGltYWdlIGFzc2V0IGlzIHNwcml0ZSBzaGVldCBvciBub3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU3ByaXRlU2hlZXQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgc3ByaXRlIHNoZWV0IHlvdSB3YW50LgoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBpbWFnZSBpcyBhIHNwcml0ZSBzaGVldC4KCSovCiAgICBpc1Nwcml0ZVNoZWV0OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5zcHJpdGVTaGVldDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKCS8qKgoJKiBHZXQgdGV4dCBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGV4dAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSB0ZXh0IGRhdGEgeW91IHdhbnQuCgkqIEByZXR1cm4ge29iamVjdH0gVGhlIHRleHQgZGF0YSB5b3Ugd2FudC4KCSovCiAgICBnZXRUZXh0OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl90ZXh0W2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGV4dFtrZXldLmRhdGE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0aGUgY2FjaGUga2V5cyBmcm9tIGEgZ2l2ZW4gYXJyYXkgb2Ygb2JqZWN0cy4KICAgICogTm9ybWFsbHkgeW91IGRvbid0IGNhbGwgdGhpcyBkaXJlY3RseSBidXQgaW5zdGVhZCB1c2UgZ2V0SW1hZ2VLZXlzLCBnZXRTb3VuZEtleXMsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0S2V5cwogICAgKiBAcGFyYW0ge0FycmF5fSBhcnJheSAtIEFuIGFycmF5IG9mIGl0ZW1zIHRvIHJldHVybiB0aGUga2V5cyBmb3IuCiAgICAqIEByZXR1cm4ge0FycmF5fSBUaGUgYXJyYXkgb2YgaXRlbSBrZXlzLgogICAgKi8KICAgIGdldEtleXM6IGZ1bmN0aW9uIChhcnJheSkgewoKICAgICAgICB2YXIgb3V0cHV0ID0gW107CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gYXJyYXkpCiAgICAgICAgewogICAgICAgICAgICBpZiAoaXRlbSAhPT0gJ19fZGVmYXVsdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGl0ZW0pOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0sCgoJLyoqCgkqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgSW1hZ2VzIGluIHRoZSBDYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0SW1hZ2VLZXlzCgkqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgoJKi8KICAgIGdldEltYWdlS2V5czogZnVuY3Rpb24gKCkgewogICAgCXJldHVybiB0aGlzLmdldEtleXModGhpcy5faW1hZ2VzKTsKICAgIH0sCgoJLyoqCgkqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgU291bmRzIGluIHRoZSBDYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0U291bmRLZXlzCgkqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgoJKi8KICAgIGdldFNvdW5kS2V5czogZnVuY3Rpb24gKCkgewogICAgCXJldHVybiB0aGlzLmdldEtleXModGhpcy5fc291bmRzKTsKICAgIH0sCgoJLyoqCgkqIFJldHVybnMgYW4gYXJyYXkgY29udGFpbmluZyBhbGwgb2YgdGhlIGtleXMgb2YgVGV4dCBGaWxlcyBpbiB0aGUgQ2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHRLZXlzCgkqIEByZXR1cm4ge0FycmF5fSBUaGUgc3RyaW5nIGJhc2VkIGtleXMgaW4gdGhlIENhY2hlLgoJKi8KICAgIGdldFRleHRLZXlzOiBmdW5jdGlvbiAoKSB7CiAgICAJcmV0dXJuIHRoaXMuZ2V0S2V5cyh0aGlzLl90ZXh0KTsKICAgIH0sCgoJLyoqCgkqIFJlbW92ZXMgYSBjYW52YXMgZnJvbSB0aGUgY2FjaGUuCiAgICAqCgkqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZUNhbnZhcwogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCgkqLwogICAgcmVtb3ZlQ2FudmFzOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX2NhbnZhc2VzW2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGFuIGltYWdlIGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVJbWFnZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byByZW1vdmUuCiAgICAqLwogICAgcmVtb3ZlSW1hZ2U6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5faW1hZ2VzW2tleV07CiAgICB9LAoKICAgIC8qKgogICAgKiBSZW1vdmVzIGEgc291bmQgZnJvbSB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZVNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVTb3VuZDogZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9zb3VuZHNba2V5XTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSB0ZXh0IGZyb20gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZW1vdmVUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVUZXh0OiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3RleHRba2V5XTsKICAgIH0sCgoJLyoqCgkqIENsZWFycyB0aGUgY2FjaGUuIFJlbW92ZXMgZXZlcnkgbG9jYWwgY2FjaGUgb2JqZWN0IHJlZmVyZW5jZS4KICAgICoKCSogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZGVzdHJveQoJKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl9jYW52YXNlcykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9jYW52YXNlc1tpdGVtWydrZXknXV07CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIHRoaXMuX2ltYWdlcykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9pbWFnZXNbaXRlbVsna2V5J11dOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl9zb3VuZHMpCiAgICAgICAgewogICAgICAgICAgICBkZWxldGUgdGhpcy5fc291bmRzW2l0ZW1bJ2tleSddXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5fdGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl90ZXh0W2l0ZW1bJ2tleSddXTsKICAgICAgICB9CiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIGxvYWRlciBjb25zdHJ1Y3Rvci4KKiBUaGUgTG9hZGVyIGhhbmRsZXMgbG9hZGluZyBhbGwgZXh0ZXJuYWwgY29udGVudCBzdWNoIGFzIEltYWdlcywgU291bmRzLCBUZXh0dXJlIEF0bGFzZXMgYW5kIGRhdGEgZmlsZXMuCiogSXQgdXNlcyBhIGNvbWJpbmF0aW9uIG9mIEltYWdlKCkgbG9hZGluZyBhbmQgeGhyIGFuZCBwcm92aWRlcyBwcm9ncmVzcyBhbmQgY29tcGxldGlvbiBjYWxsYmFja3MuCiogQGNsYXNzIFBoYXNlci5Mb2FkZXIKKiBAY2xhc3NkZXNjICBUaGUgTG9hZGVyIGhhbmRsZXMgbG9hZGluZyBhbGwgZXh0ZXJuYWwgY29udGVudCBzdWNoIGFzIEltYWdlcywgU291bmRzLCBUZXh0dXJlIEF0bGFzZXMgYW5kIGRhdGEgZmlsZXMuCiogSXQgdXNlcyBhIGNvbWJpbmF0aW9uIG9mIEltYWdlKCkgbG9hZGluZyBhbmQgeGhyIGFuZCBwcm92aWRlcyBwcm9ncmVzcyBhbmQgY29tcGxldGlvbiBjYWxsYmFja3MuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuTG9hZGVyID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7YXJyYXl9IF9rZXlzIC0gQXJyYXkgc3RvcmVzIGFzc2V0cyBrZXlzLiBTbyB5b3UgY2FuIGdldCB0aGF0IGFzc2V0IGJ5IGl0cyB1bmlxdWUga2V5LgoJKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX2tleXMgPSBbXTsKCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2ZpbGVMaXN0IC0gQ29udGFpbnMgYWxsIHRoZSBhc3NldHMgZmlsZSBpbmZvcy4KCSogQHByaXZhdGUKICAgICovCgl0aGlzLl9maWxlTGlzdCA9IHt9OwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gX3Byb2dyZXNzQ2h1bmsgLSBJbmRpY2F0ZXMgYXNzZXRzIGxvYWRpbmcgcHJvZ3Jlc3MuIChmcm9tIDAgdG8gMTAwKQoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuX3Byb2dyZXNzQ2h1bmsgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge1hNTEh0dHBSZXF1ZXN0fSAtIEFuIFhNTEh0dHBSZXF1ZXN0IG9iamVjdCB1c2VkIGZvciBsb2FkaW5nIHRleHQgYW5kIGF1ZGlvIGRhdGEuCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5feGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CgoJLyoqIAoJKiBAcHJvcGVydHkge251bWJlcn0gLSBMZW5ndGggb2YgYXNzZXRzIHF1ZXVlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucXVldWVTaXplID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc0xvYWRpbmcgLSBUcnVlIGlmIHRoZSBMb2FkZXIgaXMgaW4gdGhlIHByb2Nlc3Mgb2YgbG9hZGluZyB0aGUgcXVldWUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBoYXNMb2FkZWQgLSBUcnVlIGlmIGFsbCBhc3NldHMgaW4gdGhlIHF1ZXVlIGhhdmUgZmluaXNoZWQgbG9hZGluZy4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcHJvZ3Jlc3MgLSBUaGUgTG9hZCBwcm9ncmVzcyBwZXJjZW50YWdlIHZhbHVlIChmcm9tIDAgdG8gMTAwKQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucHJvZ3Jlc3MgPSAwOwoKCS8qKgoJKiBZb3UgY2FuIG9wdGlvbmFsbHkgbGluayBhIHNwcml0ZSB0byB0aGUgcHJlbG9hZGVyLgoJKiBJZiB5b3UgZG8gc28gdGhlIFNwcml0ZSdzIHdpZHRoIG9yIGhlaWdodCB3aWxsIGJlIGNyb3BwZWQgYmFzZWQgb24gdGhlIHBlcmNlbnRhZ2UgbG9hZGVkLgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBwcmVsb2FkU3ByaXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5wcmVsb2FkU3ByaXRlID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtzdHJpbmd9IGNyb3NzT3JpZ2luIC0gVGhlIGNyb3NzT3JpZ2luIHZhbHVlIGFwcGxpZWQgdG8gbG9hZGVkIGltYWdlcwoJKi8KCXRoaXMuY3Jvc3NPcmlnaW4gPSAnJzsKCgkvKioKCSogSWYgeW91IHdhbnQgdG8gYXBwZW5kIGEgVVJMIGJlZm9yZSB0aGUgcGF0aCBvZiBhbnkgYXNzZXQgeW91IGNhbiBzZXQgdGhpcyBoZXJlLgoJKiBVc2VmdWwgaWYgeW91IG5lZWQgdG8gYWxsb3cgYW4gYXNzZXQgdXJsIHRvIGJlIGNvbmZpZ3VyZWQgb3V0c2lkZSBvZiB0aGUgZ2FtZSBjb2RlLgoJKiBNVVNUIGhhdmUgLyBvbiB0aGUgZW5kIG9mIGl0IQoJKiBAcHJvcGVydHkge3N0cmluZ30gYmFzZVVSTAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuYmFzZVVSTCA9ICcnOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uRmlsZUNvbXBsZXRlIC0gRXZlbnQgc2lnbmFsLgoJKi8KCXRoaXMub25GaWxlQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25GaWxlRXJyb3IgLSBFdmVudCBzaWduYWwuCgkqLwoJdGhpcy5vbkZpbGVFcnJvciA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkxvYWRTdGFydCAtIEV2ZW50IHNpZ25hbC4KCSovCgl0aGlzLm9uTG9hZFN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWw7CgkKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTG9hZENvbXBsZXRlIC0gRXZlbnQgc2lnbmFsLgoJKi8KCXRoaXMub25Mb2FkQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9IQVNIID0gMTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkcgPSAyOwoKUGhhc2VyLkxvYWRlci5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIFlvdSBjYW4gc2V0IGEgU3ByaXRlIHRvIGJlIGEgInByZWxvYWQiIHNwcml0ZSBieSBwYXNzaW5nIGl0IHRvIHRoaXMgbWV0aG9kLgoJKiBBICJwcmVsb2FkIiBzcHJpdGUgd2lsbCBoYXZlIGl0cyB3aWR0aCBvciBoZWlnaHQgY3JvcCBhZGp1c3RlZCBiYXNlZCBvbiB0aGUgcGVyY2VudGFnZSBvZiB0aGUgbG9hZGVyIGluIHJlYWwtdGltZS4KCSogVGhpcyBhbGxvd3MgeW91IHRvIGVhc2lseSBtYWtlIGxvYWRpbmcgYmFycyBmb3IgZ2FtZXMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNzZXRQcmVsb2FkU3ByaXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0aGF0IHdpbGwgYmUgY3JvcHBlZCBkdXJpbmcgdGhlIGxvYWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlyZWN0aW9uPTBdIC0gQSB2YWx1ZSBvZiB6ZXJvIG1lYW5zIHRoZSBzcHJpdGUgd2lkdGggd2lsbCBiZSBjcm9wcGVkLCBhIHZhbHVlIG9mIDEgbWVhbnMgaXRzIGhlaWdodCB3aWxsIGJlIGNyb3BwZWQuCiAgICAqLwoJc2V0UHJlbG9hZFNwcml0ZTogZnVuY3Rpb24gKHNwcml0ZSwgZGlyZWN0aW9uKSB7CgoJCWRpcmVjdGlvbiA9IGRpcmVjdGlvbiB8fCAwOwoKCQl0aGlzLnByZWxvYWRTcHJpdGUgPSB7IHNwcml0ZTogc3ByaXRlLCBkaXJlY3Rpb246IGRpcmVjdGlvbiwgd2lkdGg6IHNwcml0ZS53aWR0aCwgaGVpZ2h0OiBzcHJpdGUuaGVpZ2h0LCBjcm9wOiBudWxsIH07CgoJCWlmIChkaXJlY3Rpb24gPT0gMCkKCQl7CgkJCS8vCUhvcml6b250YWwgY3JvcAoJCQl0aGlzLnByZWxvYWRTcHJpdGUuY3JvcCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIDEsIHNwcml0ZS5oZWlnaHQpOwoJCX0KCQllbHNlCgkJewoJCQkvLwlWZXJ0aWNhbCBjcm9wCgkJCXRoaXMucHJlbG9hZFNwcml0ZS5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgc3ByaXRlLndpZHRoLCAxKTsKCQl9CgoJCXNwcml0ZS5jcm9wID0gdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3A7CgkJc3ByaXRlLmNyb3BFbmFibGVkID0gdHJ1ZTsKCgl9LAoKCS8qKgoJKiBDaGVjayB3aGV0aGVyIGFzc2V0IGV4aXN0cyB3aXRoIGEgc3BlY2lmaWMga2V5LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjY2hlY2tLZXlFeGlzdHMKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gY2hlY2suCgkqIEByZXR1cm4ge2Jvb2xlYW59IFJldHVybiB0cnVlIGlmIGV4aXN0cywgb3RoZXJ3aXNlIHJldHVybiBmYWxzZS4KCSovCgljaGVja0tleUV4aXN0czogZnVuY3Rpb24gKGtleSkgewoKCQlpZiAodGhpcy5fZmlsZUxpc3Rba2V5XSkKCQl7CgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCQoJfSwKCgkvKioKCSogUmVzZXQgbG9hZGVyLCB0aGlzIHdpbGwgcmVtb3ZlIGFsbCBsb2FkZWQgYXNzZXRzLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjcmVzZXQKCSovCglyZXNldDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLnByZWxvYWRTcHJpdGUgPSBudWxsOwoJCXRoaXMucXVldWVTaXplID0gMDsKCQl0aGlzLmlzTG9hZGluZyA9IGZhbHNlOwoKCX0sCgoJLyoqCgkqIEludGVybmFsIGZ1bmN0aW9uIHRoYXQgYWRkcyBhIG5ldyBlbnRyeSB0byB0aGUgZmlsZSBsaXN0LiBEbyBub3QgY2FsbCBkaXJlY3RseS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2FkZFRvRmlsZUxpc3QKCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gdHlwZSAtIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7RGVzY3JpcHRpb259IHByb3BlcnRpZXMgLSBEZXNjcmlwdGlvbi4KCSogQHByb3RlY3RlZAoJKi8KCWFkZFRvRmlsZUxpc3Q6IGZ1bmN0aW9uICh0eXBlLCBrZXksIHVybCwgcHJvcGVydGllcykgewoKCQl2YXIgZW50cnkgPSB7CgkJCXR5cGU6IHR5cGUsCgkJCWtleToga2V5LAoJCQl1cmw6IHVybCwKCQkJZGF0YTogbnVsbCwKCQkJZXJyb3I6IGZhbHNlLAoJCQlsb2FkZWQ6IGZhbHNlCgkJfTsKCgkJaWYgKHR5cGVvZiBwcm9wZXJ0aWVzICE9PSAidW5kZWZpbmVkIikKCQl7CgkJCWZvciAodmFyIHByb3AgaW4gcHJvcGVydGllcykKCQkJewoJCQkJZW50cnlbcHJvcF0gPSBwcm9wZXJ0aWVzW3Byb3BdOwoJCQl9CgkJfQoKCQl0aGlzLl9maWxlTGlzdFtrZXldID0gZW50cnk7CgoJCXRoaXMuX2tleXMucHVzaChrZXkpOwoKCQl0aGlzLnF1ZXVlU2l6ZSsrOwoKCX0sCgoJLyoqCgkqIEFkZCBhbiBpbWFnZSB0byB0aGUgTG9hZGVyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjaW1hZ2UKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhpcyBpbWFnZSBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIGltYWdlIGZpbGUuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gb3ZlcndyaXRlIC0gSWYgYW4gZW50cnkgd2l0aCBhIG1hdGNoaW5nIGtleSBhbHJlYWR5IGV4aXN0cyB0aGlzIHdpbGwgb3Zlci13cml0ZSBpdAoJKi8KCWltYWdlOiBmdW5jdGlvbiAoa2V5LCB1cmwsIG92ZXJ3cml0ZSkgewoKCQlpZiAodHlwZW9mIG92ZXJ3cml0ZSA9PT0gInVuZGVmaW5lZCIpIHsgb3ZlcndyaXRlID0gZmFsc2U7IH0KCgkJaWYgKG92ZXJ3cml0ZSB8fCB0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT0gZmFsc2UpCgkJewoJCQl0aGlzLmFkZFRvRmlsZUxpc3QoJ2ltYWdlJywga2V5LCB1cmwpOwoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkIGEgdGV4dCBmaWxlIHRvIHRoZSBMb2FkZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciN0ZXh0CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0IGZpbGUuCgkqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIHRleHQgZmlsZS4KCSogQHBhcmFtIHtib29sZWFufSBvdmVyd3JpdGUgLSBUcnVlIGlmIERlc2NyaXB0aW9uLgoJKi8KCXRleHQ6IGZ1bmN0aW9uIChrZXksIHVybCwgb3ZlcndyaXRlKSB7CgoJCWlmICh0eXBlb2Ygb3ZlcndyaXRlID09PSAidW5kZWZpbmVkIikgeyBvdmVyd3JpdGUgPSBmYWxzZTsgfQoKCQlpZiAob3ZlcndyaXRlIHx8IHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PSBmYWxzZSkKCQl7CgkJCXRoaXMuYWRkVG9GaWxlTGlzdCgndGV4dCcsIGtleSwgdXJsKTsKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyBzcHJpdGUgc2hlZXQgdG8gdGhlIGxvYWRlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3Nwcml0ZXNoZWV0CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBzaGVldCBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoZSBzaGVldCBmaWxlLgoJKiBAcGFyYW0ge251bWJlcn0gZnJhbWVXaWR0aCAtIFdpZHRoIG9mIGVhY2ggc2luZ2xlIGZyYW1lLgoJKiBAcGFyYW0ge251bWJlcn0gZnJhbWVIZWlnaHQgLSBIZWlnaHQgb2YgZWFjaCBzaW5nbGUgZnJhbWUuCgkqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVNYXg9LTFdIC0gSG93IG1hbnkgZnJhbWVzIGluIHRoaXMgc3ByaXRlIHNoZWV0LiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgZGl2aWRlIHRoZSB3aG9sZSBpbWFnZSBpbnRvIGZyYW1lcy4KCSovCglzcHJpdGVzaGVldDogZnVuY3Rpb24gKGtleSwgdXJsLCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgpIHsKCgkJaWYgKHR5cGVvZiBmcmFtZU1heCA9PT0gInVuZGVmaW5lZCIpIHsgZnJhbWVNYXggPSAtMTsgfQoKCQlpZiAodGhpcy5jaGVja0tleUV4aXN0cyhrZXkpID09PSBmYWxzZSkKCQl7CgkJCXRoaXMuYWRkVG9GaWxlTGlzdCgnc3ByaXRlc2hlZXQnLCBrZXksIHVybCwgeyBmcmFtZVdpZHRoOiBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodDogZnJhbWVIZWlnaHQsIGZyYW1lTWF4OiBmcmFtZU1heCB9KTsKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyB0aWxlIHNldCB0byB0aGUgbG9hZGVyLiBUaGVzZSBhcmUgdXNlZCBpbiB0aGUgcmVuZGVyaW5nIG9mIHRpbGUgbWFwcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3RpbGVzZXQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRpbGVzZXQgZmlsZS4KCSogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgdGlsZXNldC4KCSogQHBhcmFtIHtudW1iZXJ9IHRpbGVXaWR0aCAtIFdpZHRoIG9mIGVhY2ggc2luZ2xlIHRpbGUgaW4gcGl4ZWxzLgoJKiBAcGFyYW0ge251bWJlcn0gdGlsZUhlaWdodCAtIEhlaWdodCBvZiBlYWNoIHNpbmdsZSB0aWxlIGluIHBpeGVscy4KCSogQHBhcmFtIHtudW1iZXJ9IFt0aWxlTWF4PS0xXSAtIEhvdyBtYW55IHRpbGVzIGluIHRoaXMgdGlsZXNldC4gSWYgbm90IHNwZWNpZmllZCBpdCB3aWxsIGRpdmlkZSB0aGUgd2hvbGUgaW1hZ2UgaW50byB0aWxlcy4KCSogQHBhcmFtIHtudW1iZXJ9IFt0aWxlTWFyZ2luPTBdIC0gSWYgdGhlIHRpbGVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIGEgbWFyZ2luLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KCSogQHBhcmFtIHtudW1iZXJ9IFt0aWxlU3BhY2luZz0wXSAtIElmIHRoZSB0aWxlcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBzcGFjaW5nIGJldHdlZW4gdGhlbSwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCgkqLwoJdGlsZXNldDogZnVuY3Rpb24gKGtleSwgdXJsLCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXgsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nKSB7CgoJCWlmICh0eXBlb2YgdGlsZU1heCA9PT0gInVuZGVmaW5lZCIpIHsgdGlsZU1heCA9IC0xOyB9CgkJaWYgKHR5cGVvZiB0aWxlTWFyZ2luID09PSAidW5kZWZpbmVkIikgeyB0aWxlTWFyZ2luID0gMDsgfQoJCWlmICh0eXBlb2YgdGlsZVNwYWNpbmcgPT09ICJ1bmRlZmluZWQiKSB7IHRpbGVTcGFjaW5nID0gMDsgfQoKCQlpZiAodGhpcy5jaGVja0tleUV4aXN0cyhrZXkpID09PSBmYWxzZSkKCQl7CgkJCXRoaXMuYWRkVG9GaWxlTGlzdCgndGlsZXNldCcsIGtleSwgdXJsLCB7IHRpbGVXaWR0aDogdGlsZVdpZHRoLCB0aWxlSGVpZ2h0OiB0aWxlSGVpZ2h0LCB0aWxlTWF4OiB0aWxlTWF4LCB0aWxlTWFyZ2luOiB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZzogdGlsZVNwYWNpbmcgfSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBBZGQgYSBuZXcgYXVkaW8gZmlsZSB0byB0aGUgbG9hZGVyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYXVkaW8KCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGF1ZGlvIGZpbGUuCgkqIEBwYXJhbSB7QXJyYXl9IHVybHMgLSBBbiBhcnJheSBjb250YWluaW5nIHRoZSBVUkxzIG9mIHRoZSBhdWRpbyBmaWxlcywgaS5lLjogWyAnanVtcC5tcDMnLCAnanVtcC5vZ2cnLCAnanVtcC5tNGEnIF0uCgkqIEBwYXJhbSB7Ym9vbGVhbn0gYXV0b0RlY29kZSAtIFdoZW4gdXNpbmcgV2ViIEF1ZGlvIHRoZSBhdWRpbyBmaWxlcyBjYW4gZWl0aGVyIGJlIGRlY29kZWQgYXQgbG9hZCB0aW1lIG9yIHJ1bi10aW1lLiBUaGV5IGNhbid0IGJlIHBsYXllZCB1bnRpbCB0aGV5IGFyZSBkZWNvZGVkLCBidXQgdGhpcyBsZXQncyB5b3UgY29udHJvbCB3aGVuIHRoYXQgaGFwcGVucy4gRGVjb2RpbmcgaXMgYSBub24tYmxvY2tpbmcgYXN5bmMgcHJvY2Vzcy4KCSovCglhdWRpbzogZnVuY3Rpb24gKGtleSwgdXJscywgYXV0b0RlY29kZSkgewoKCQlpZiAodHlwZW9mIGF1dG9EZWNvZGUgPT09ICJ1bmRlZmluZWQiKSB7IGF1dG9EZWNvZGUgPSB0cnVlOyB9CgoJCWlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT09IGZhbHNlKQoJCXsKCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCdhdWRpbycsIGtleSwgdXJscywgeyBidWZmZXI6IG51bGwsIGF1dG9EZWNvZGU6IGF1dG9EZWNvZGUgfSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBBZGQgYSBuZXcgdGlsZW1hcCBsb2FkaW5nIHJlcXVlc3QuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciN0aWxlbWFwCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0aWxlbWFwIGRhdGEuCgkqIEBwYXJhbSB7c3RyaW5nfSB0aWxlc2V0VVJMIC0gVGhlIHVybCBvZiB0aGUgdGlsZSBzZXQgaW1hZ2UgZmlsZS4KCSogQHBhcmFtIHtzdHJpbmd9IFttYXBEYXRhVVJMXSAtIFRoZSB1cmwgb2YgdGhlIG1hcCBkYXRhIGZpbGUgKGNzdi9qc29uKQoJKiBAcGFyYW0ge29iamVjdH0gW21hcERhdGFdIC0gQW4gb3B0aW9uYWwgSlNPTiBkYXRhIG9iamVjdCAoY2FuIGJlIGdpdmVuIGluIHBsYWNlIG9mIGEgVVJMKS4KCSogQHBhcmFtIHtzdHJpbmd9IFtmb3JtYXRdIC0gVGhlIGZvcm1hdCBvZiB0aGUgbWFwIGRhdGEuCgkqLwoJdGlsZW1hcDogZnVuY3Rpb24gKGtleSwgbWFwRGF0YVVSTCwgbWFwRGF0YSwgZm9ybWF0KSB7CgoJCWlmICh0eXBlb2YgbWFwRGF0YVVSTCA9PT0gInVuZGVmaW5lZCIpIHsgbWFwRGF0YVVSTCA9IG51bGw7IH0KCQlpZiAodHlwZW9mIG1hcERhdGEgPT09ICJ1bmRlZmluZWQiKSB7IG1hcERhdGEgPSBudWxsOyB9CgkJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICJ1bmRlZmluZWQiKSB7IGZvcm1hdCA9IFBoYXNlci5UaWxlbWFwLkNTVjsgfQoKCQlpZiAobWFwRGF0YVVSTCA9PSBudWxsICYmIG1hcERhdGEgPT0gbnVsbCkKCQl7CgkJCWNvbnNvbGUud2FybignUGhhc2VyLkxvYWRlci50aWxlbWFwIC0gQm90aCBtYXBEYXRhVVJMIGFuZCBtYXBEYXRhIGFyZSBudWxsLiBPbmUgbXVzdCBiZSBzZXQuJyk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT09IGZhbHNlKQoJCXsKCQkJLy8gIEEgVVJMIHRvIGEganNvbi9jc3YgZmlsZSBoYXMgYmVlbiBnaXZlbgoJCQlpZiAobWFwRGF0YVVSTCkKCQkJewoJCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCd0aWxlbWFwJywga2V5LCBtYXBEYXRhVVJMLCB7IGZvcm1hdDogZm9ybWF0IH0pOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJc3dpdGNoIChmb3JtYXQpCgkJCQl7CgkJCQkJLy8gIEEgY3N2IHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KCQkJCQljYXNlIFBoYXNlci5UaWxlbWFwLkNTVjoKCQkJCQkJYnJlYWs7CgoJCQkJCS8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgoJCQkJCWNhc2UgUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTjoKCgkJCQkJCWlmICh0eXBlb2YgbWFwRGF0YSA9PT0gJ3N0cmluZycpCgkJCQkJCXsKCQkJCQkJCW1hcERhdGEgPSBKU09OLnBhcnNlKG1hcERhdGEpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRUaWxlbWFwKGtleSwgbnVsbCwgbWFwRGF0YSwgZm9ybWF0KTsKCgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyBiaXRtYXAgZm9udCBsb2FkaW5nIHJlcXVlc3QuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNiaXRtYXBGb250CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBiaXRtYXAgZm9udC4KCSogQHBhcmFtIHtzdHJpbmd9IHRleHR1cmVVUkwgLSBUaGUgdXJsIG9mIHRoZSBmb250IGltYWdlIGZpbGUuCgkqIEBwYXJhbSB7c3RyaW5nfSBbeG1sVVJMXSAtIFRoZSB1cmwgb2YgdGhlIGZvbnQgZGF0YSBmaWxlICh4bWwvZm50KQoJKiBAcGFyYW0ge29iamVjdH0gW3htbERhdGFdIC0gQW4gb3B0aW9uYWwgWE1MIGRhdGEgb2JqZWN0LgoJKi8KCWJpdG1hcEZvbnQ6IGZ1bmN0aW9uIChrZXksIHRleHR1cmVVUkwsIHhtbFVSTCwgeG1sRGF0YSkgewoKCQlpZiAodHlwZW9mIHhtbFVSTCA9PT0gInVuZGVmaW5lZCIpIHsgeG1sVVJMID0gbnVsbDsgfQoJCWlmICh0eXBlb2YgeG1sRGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgeG1sRGF0YSA9IG51bGw7IH0KCgkJaWYgKHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PT0gZmFsc2UpCgkJewoJCQkvLyAgQSBVUkwgdG8gYSBqc29uL3htbCBmaWxlIGhhcyBiZWVuIGdpdmVuCgkJCWlmICh4bWxVUkwpCgkJCXsKCQkJCXRoaXMuYWRkVG9GaWxlTGlzdCgnYml0bWFwZm9udCcsIGtleSwgdGV4dHVyZVVSTCwgeyB4bWxVUkw6IHhtbFVSTCB9KTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCS8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgoJCQkJaWYgKHR5cGVvZiB4bWxEYXRhID09PSAnc3RyaW5nJykKCQkJCXsKCQkJCQl2YXIgeG1sOwoKCQkJCQl0cnkgIHsKCQkJCQkJaWYgKHdpbmRvd1snRE9NUGFyc2VyJ10pCgkJCQkJCXsKCQkJCQkJCXZhciBkb21wYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCQkJCQl4bWwgPSBkb21wYXJzZXIucGFyc2VGcm9tU3RyaW5nKHhtbERhdGEsICJ0ZXh0L3htbCIpOwoJCQkJCQl9CgkJCQkJCWVsc2UKCQkJCQkJewoJCQkJCQkJeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKCQkJCQkJCXhtbC5hc3luYyA9ICdmYWxzZSc7CgkJCQkJCQl4bWwubG9hZFhNTCh4bWxEYXRhKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQljYXRjaCAoZSkKCQkJCQl7CgkJCQkJCXhtbCA9IHVuZGVmaW5lZDsKCQkJCQl9CgoJCQkJCWlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpCgkJCQkJewoJCQkJCQl0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgQml0bWFwIEZvbnQgWE1MIGdpdmVuIik7CgkJCQkJfQoJCQkJCWVsc2UKCQkJCQl7CgkJCQkJCXRoaXMuYWRkVG9GaWxlTGlzdCgnYml0bWFwZm9udCcsIGtleSwgdGV4dHVyZVVSTCwgeyB4bWxVUkw6IG51bGwsIHhtbERhdGE6IHhtbCB9KTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuIFRoaXMgYXRsYXMgdXNlcyB0aGUgSlNPTiBBcnJheSBkYXRhIGZvcm1hdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzSlNPTkFycmF5CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBiaXRtYXAgZm9udC4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gYXRsYXNVUkwgLSBUaGUgdXJsIG9mIHRoZSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gYXRsYXNEYXRhIC0gRGVzY3JpcHRpb24uCgkqLwoJYXRsYXNKU09OQXJyYXk6IGZ1bmN0aW9uIChrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEpIHsKCgkJcmV0dXJuIHRoaXMuYXRsYXMoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhLCBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSk7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBKU09OIEhhc2ggZGF0YSBmb3JtYXQuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhc0pTT05IYXNoCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSBiaXRtYXAgZm9udC4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gYXRsYXNVUkwgLSBUaGUgdXJsIG9mIHRoZSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gYXRsYXNEYXRhIC0gRGVzY3JpcHRpb24uCgkqLwoJYXRsYXNKU09OSGFzaDogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKCQlyZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0gpOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuIFRoaXMgYXRsYXMgdXNlcyB0aGUgU3RhcmxpbmcgWE1MIGRhdGEgZm9ybWF0LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYXRsYXNYTUwKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGJpdG1hcCBmb250LgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc1VSTCAtIFRoZSB1cmwgb2YgdGhlIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc0RhdGEgLSBEZXNjcmlwdGlvbi4KCSovCglhdGxhc1hNTDogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKCQlyZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkcpOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzIHRvIHRoZSBsb2FkZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhcwoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgdGV4dHVyZSBhdGxhcyBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gdGV4dHVyZVVSTCAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgaW1hZ2UgZmlsZS4KCSogQHBhcmFtIHtzdHJpbmd9IFthdGxhc1VSTF0gLSBUaGUgdXJsIG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGRhdGEgZmlsZSAoanNvbi94bWwpLiBZb3UgZG9uJ3QgbmVlZCB0aGlzIGlmIHlvdSBhcmUgcGFzc2luZyBhbiBhdGxhc0RhdGEgb2JqZWN0IGluc3RlYWQuCgkqIEBwYXJhbSB7b2JqZWN0fSBbYXRsYXNEYXRhXSAtIEEgSlNPTiBvciBYTUwgZGF0YSBvYmplY3QuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgdGhlIGRhdGEgaXMgYmVpbmcgbG9hZGVkIGZyb20gYSBVUkwuCgkqIEBwYXJhbSB7bnVtYmVyfSBbZm9ybWF0XSAtIEEgdmFsdWUgZGVzY3JpYmluZyB0aGUgZm9ybWF0IG9mIHRoZSBkYXRhLCB0aGUgZGVmYXVsdCBpcyBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWS4KCSovCglhdGxhczogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgZm9ybWF0KSB7CgoJCWlmICh0eXBlb2YgYXRsYXNVUkwgPT09ICJ1bmRlZmluZWQiKSB7IGF0bGFzVVJMID0gbnVsbDsgfQoJCWlmICh0eXBlb2YgYXRsYXNEYXRhID09PSAidW5kZWZpbmVkIikgeyBhdGxhc0RhdGEgPSBudWxsOyB9CgkJaWYgKHR5cGVvZiBmb3JtYXQgPT09ICJ1bmRlZmluZWQiKSB7IGZvcm1hdCA9IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZOyB9CgoJCWlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT09IGZhbHNlKQoJCXsKCQkJLy8gIEEgVVJMIHRvIGEganNvbi94bWwgZmlsZSBoYXMgYmVlbiBnaXZlbgoJCQlpZiAoYXRsYXNVUkwpCgkJCXsKCQkJCXRoaXMuYWRkVG9GaWxlTGlzdCgndGV4dHVyZWF0bGFzJywga2V5LCB0ZXh0dXJlVVJMLCB7IGF0bGFzVVJMOiBhdGxhc1VSTCwgZm9ybWF0OiBmb3JtYXQgfSk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlzd2l0Y2ggKGZvcm1hdCkKCQkJCXsKCQkJCQkvLyAgQSBqc29uIHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KCQkJCQljYXNlIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZOiAKCgkJCQkJCWlmICh0eXBlb2YgYXRsYXNEYXRhID09PSAnc3RyaW5nJykKCQkJCQkJewoJCQkJCQkJYXRsYXNEYXRhID0gSlNPTi5wYXJzZShhdGxhc0RhdGEpOwoJCQkJCQl9CgkJCQkJCWJyZWFrOwoKCQkJCQkvLyAgQW4geG1sIHN0cmluZyBvciBvYmplY3QgaGFzIGJlZW4gZ2l2ZW4KCQkJCQljYXNlIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19YTUxfU1RBUkxJTkc6CgoJCQkJCQlpZiAodHlwZW9mIGF0bGFzRGF0YSA9PT0gJ3N0cmluZycpCgkJCQkJCXsKCQkJCQkJCXZhciB4bWw7CgoJCQkJCQkJdHJ5ICB7CgkJCQkJCQkJaWYgKHdpbmRvd1snRE9NUGFyc2VyJ10pCgkJCQkJCQkJewoJCQkJCQkJCQl2YXIgZG9tcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwoJCQkJCQkJCQl4bWwgPSBkb21wYXJzZXIucGFyc2VGcm9tU3RyaW5nKGF0bGFzRGF0YSwgInRleHQveG1sIik7CgkJCQkJCQkJfQoJCQkJCQkJCWVsc2UKCQkJCQkJCQl7CgkJCQkJCQkJCXhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CgkJCQkJCQkJCXhtbC5hc3luYyA9ICdmYWxzZSc7CgkJCQkJCQkJCXhtbC5sb2FkWE1MKGF0bGFzRGF0YSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJY2F0Y2ggKGUpCgkJCQkJCQl7CgkJCQkJCQkJeG1sID0gdW5kZWZpbmVkOwoJCQkJCQkJfQoKCQkJCQkJCWlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpCgkJCQkJCQl7CgkJCQkJCQkJdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgWE1MIGdpdmVuIik7CgkJCQkJCQl9CgkJCQkJCQllbHNlCgkJCQkJCQl7CgkJCQkJCQkJYXRsYXNEYXRhID0geG1sOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCXRoaXMuYWRkVG9GaWxlTGlzdCgndGV4dHVyZWF0bGFzJywga2V5LCB0ZXh0dXJlVVJMLCB7IGF0bGFzVVJMOiBudWxsLCBhdGxhc0RhdGE6IGF0bGFzRGF0YSwgZm9ybWF0OiBmb3JtYXQgfSk7CgoJCQl9CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogUmVtb3ZlIGxvYWRpbmcgcmVxdWVzdCBvZiBhIGZpbGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZW1vdmVGaWxlCgkqIEBwYXJhbSBrZXkge3N0cmluZ30gS2V5IG9mIHRoZSBmaWxlIHlvdSB3YW50IHRvIHJlbW92ZS4KCSovCglyZW1vdmVGaWxlOiBmdW5jdGlvbiAoa2V5KSB7CgoJCWRlbGV0ZSB0aGlzLl9maWxlTGlzdFtrZXldOwoKCX0sCgoJLyoqCgkqIFJlbW92ZSBhbGwgZmlsZSBsb2FkaW5nIHJlcXVlc3RzLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjcmVtb3ZlQWxsCgkqLwoJcmVtb3ZlQWxsOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2ZpbGVMaXN0ID0ge307CgoJfSwKCgkvKioKCSogU3RhcnQgbG9hZGluZyB0aGUgYXNzZXRzLiBOb3JtYWxseSB5b3UgZG9uJ3QgbmVlZCB0byBjYWxsIHRoaXMgeW91cnNlbGYgYXMgdGhlIFN0YXRlTWFuYWdlciB3aWxsIGRvIHNvLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjc3RhcnQKCSovCglzdGFydDogZnVuY3Rpb24gKCkgewoKCQlpZiAodGhpcy5pc0xvYWRpbmcpCgkJewoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLnByb2dyZXNzID0gMDsKCQl0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwoJCXRoaXMuaXNMb2FkaW5nID0gdHJ1ZTsKCgkJdGhpcy5vbkxvYWRTdGFydC5kaXNwYXRjaCh0aGlzLnF1ZXVlU2l6ZSk7CgoJCWlmICh0aGlzLl9rZXlzLmxlbmd0aCA+IDApCgkJewoJCQl0aGlzLl9wcm9ncmVzc0NodW5rID0gMTAwIC8gdGhpcy5fa2V5cy5sZW5ndGg7CgkJCXRoaXMubG9hZEZpbGUoKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5wcm9ncmVzcyA9IDEwMDsKCQkJdGhpcy5oYXNMb2FkZWQgPSB0cnVlOwoJCQl0aGlzLm9uTG9hZENvbXBsZXRlLmRpc3BhdGNoKCk7CgkJfQoKCX0sCgoJLyoqCgkqIExvYWQgZmlsZXMuIFByaXZhdGUgbWV0aG9kIE9OTFkgdXNlZCBieSBsb2FkZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNsb2FkRmlsZQoJKiBAcHJpdmF0ZQoJKi8KCWxvYWRGaWxlOiBmdW5jdGlvbiAoKSB7CgoJCXZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3RbdGhpcy5fa2V5cy5zaGlmdCgpXTsKCQl2YXIgX3RoaXMgPSB0aGlzOwoKCQkvLyAgSW1hZ2Ugb3IgRGF0YT8KCQlzd2l0Y2ggKGZpbGUudHlwZSkKCQl7CgkJCWNhc2UgJ2ltYWdlJzoKCQkJY2FzZSAnc3ByaXRlc2hlZXQnOgoJCQljYXNlICd0ZXh0dXJlYXRsYXMnOgoJCQljYXNlICdiaXRtYXBmb250JzoKCQkJY2FzZSAndGlsZXNldCc6CgkJCQlmaWxlLmRhdGEgPSBuZXcgSW1hZ2UoKTsKCQkJCWZpbGUuZGF0YS5uYW1lID0gZmlsZS5rZXk7CgkJCQlmaWxlLmRhdGEub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBfdGhpcy5maWxlQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJfTsKCQkJCWZpbGUuZGF0YS5vbmVycm9yID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBfdGhpcy5maWxlRXJyb3IoZmlsZS5rZXkpOwoJCQkJfTsKCQkJCWZpbGUuZGF0YS5jcm9zc09yaWdpbiA9IHRoaXMuY3Jvc3NPcmlnaW47CgkJCQlmaWxlLmRhdGEuc3JjID0gdGhpcy5iYXNlVVJMICsgZmlsZS51cmw7CgkJCQlicmVhazsKCgkJCWNhc2UgJ2F1ZGlvJzoKCQkJCWZpbGUudXJsID0gdGhpcy5nZXRBdWRpb1VSTChmaWxlLnVybCk7CgoJCQkJaWYgKGZpbGUudXJsICE9PSBudWxsKQoJCQkJewoJCQkJCS8vICBXZWJBdWRpbyBvciBBdWRpbyBUYWc/CgkJCQkJaWYgKHRoaXMuZ2FtZS5zb3VuZC51c2luZ1dlYkF1ZGlvKQoJCQkJCXsKCQkJCQkJdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUudXJsLCB0cnVlKTsKCQkJCQkJdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJhcnJheWJ1ZmZlciI7CgkJCQkJCXRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCQlyZXR1cm4gX3RoaXMuZmlsZUNvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQkJfTsKCQkJCQkJdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCQlyZXR1cm4gX3RoaXMuZmlsZUVycm9yKGZpbGUua2V5KTsKCQkJCQkJfTsKCQkJCQkJdGhpcy5feGhyLnNlbmQoKTsKCQkJCQl9CgkJCQkJZWxzZSBpZiAodGhpcy5nYW1lLnNvdW5kLnVzaW5nQXVkaW9UYWcpCgkJCQkJewoJCQkJCQlpZiAodGhpcy5nYW1lLnNvdW5kLnRvdWNoTG9ja2VkKQoJCQkJCQl7CgkJCQkJCQkvLyAgSWYgYXVkaW8gaXMgbG9ja2VkIHdlIGNhbid0IGRvIHRoaXMgeWV0LCBzbyBuZWVkIHRvIHF1ZXVlIHRoaXMgbG9hZCByZXF1ZXN0LiBCdW0uCgkJCQkJCQlmaWxlLmRhdGEgPSBuZXcgQXVkaW8oKTsKCQkJCQkJCWZpbGUuZGF0YS5uYW1lID0gZmlsZS5rZXk7CgkJCQkJCQlmaWxlLmRhdGEucHJlbG9hZCA9ICdhdXRvJzsKCQkJCQkJCWZpbGUuZGF0YS5zcmMgPSB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybDsKCQkJCQkJCXRoaXMuZmlsZUNvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQkJfQoJCQkJCQllbHNlCgkJCQkJCXsKCQkJCQkJCWZpbGUuZGF0YSA9IG5ldyBBdWRpbygpOwoJCQkJCQkJZmlsZS5kYXRhLm5hbWUgPSBmaWxlLmtleTsKCQkJCQkJCWZpbGUuZGF0YS5vbmVycm9yID0gZnVuY3Rpb24gKCkgewoJCQkJCQkJCXJldHVybiBfdGhpcy5maWxlRXJyb3IoZmlsZS5rZXkpOwoJCQkJCQkJfTsKCQkJCQkJCWZpbGUuZGF0YS5wcmVsb2FkID0gJ2F1dG8nOwoJCQkJCQkJZmlsZS5kYXRhLnNyYyA9IHRoaXMuYmFzZVVSTCArIGZpbGUudXJsOwoJCQkJCQkJZmlsZS5kYXRhLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgUGhhc2VyLkdBTUVTW3RoaXMuZ2FtZS5pZF0ubG9hZC5maWxlQ29tcGxldGUoZmlsZS5rZXkpLCBmYWxzZSk7CgkJCQkJCQlmaWxlLmRhdGEubG9hZCgpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRoaXMuZmlsZUVycm9yKGZpbGUua2V5KTsKCQkJCX0KCgkJCQlicmVhazsKCgkJCWNhc2UgJ3RpbGVtYXAnOgoJCQkJdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUudXJsLCB0cnVlKTsKCQkJCXRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgoJCQkJaWYgKGZpbGUuZm9ybWF0ID09IFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04pCgkJCQl7CgkJCQkJdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJcmV0dXJuIF90aGlzLmpzb25Mb2FkQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCX07CgkJCQl9CgkJCQllbHNlIGlmIChmaWxlLmZvcm1hdCA9PSBQaGFzZXIuVGlsZW1hcC5DU1YpCgkJCQl7CgkJCQkJdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJcmV0dXJuIF90aGlzLmNzdkxvYWRDb21wbGV0ZShmaWxlLmtleSk7CgkJCQkJfTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQl0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGlsZW1hcCBmb3JtYXQ6ICIgKyBmaWxlLmZvcm1hdCk7CgkJCQl9CgoJCQkJdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoZmlsZS5rZXkpOwoJCQkJfTsKCQkJCXRoaXMuX3hoci5zZW5kKCk7CgkJCQlicmVhazsKCgkJCWNhc2UgJ3RleHQnOgoJCQkJdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUudXJsLCB0cnVlKTsKCQkJCXRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgkJCQl0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBfdGhpcy5maWxlQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJfTsKCQkJCXRoaXMuX3hoci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewoJCQkJCXJldHVybiBfdGhpcy5maWxlRXJyb3IoZmlsZS5rZXkpOwoJCQkJfTsKCQkJCXRoaXMuX3hoci5zZW5kKCk7CgkJCQlicmVhazsKCQl9CgoJfSwKCgkvKioKCSogUHJpdmF0ZSBtZXRob2QgT05MWSB1c2VkIGJ5IGxvYWRlci4KCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2dldEF1ZGlvVVJMCgkqIEBwYXJhbSB7RGVzY3JpcHRpb259IHVybHMgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCglnZXRBdWRpb1VSTDogZnVuY3Rpb24gKHVybHMpIHsKCgkJdmFyIGV4dGVuc2lvbjsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCB1cmxzLmxlbmd0aDsgaSsrKQoJCXsKCQkJZXh0ZW5zaW9uID0gdXJsc1tpXS50b0xvd2VyQ2FzZSgpOwoJCQlleHRlbnNpb24gPSBleHRlbnNpb24uc3Vic3RyKChNYXRoLm1heCgwLCBleHRlbnNpb24ubGFzdEluZGV4T2YoIi4iKSkgfHwgSW5maW5pdHkpICsgMSk7CgoJCQlpZiAodGhpcy5nYW1lLmRldmljZS5jYW5QbGF5QXVkaW8oZXh0ZW5zaW9uKSkKCQkJewoJCQkJcmV0dXJuIHVybHNbaV07CgkJCX0KCgkJfQoKCQlyZXR1cm4gbnVsbDsKCgl9LAoKCS8qKgoJKiBFcnJvciBvY2N1cmVkIHdoZW4gbG9hZCBhIGZpbGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNmaWxlRXJyb3IKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgZXJyb3IgbG9hZGluZyBmaWxlLgoJKi8KCWZpbGVFcnJvcjogZnVuY3Rpb24gKGtleSkgewoKCQl0aGlzLl9maWxlTGlzdFtrZXldLmxvYWRlZCA9IHRydWU7CgkJdGhpcy5fZmlsZUxpc3Rba2V5XS5lcnJvciA9IHRydWU7CgoJCXRoaXMub25GaWxlRXJyb3IuZGlzcGF0Y2goa2V5KTsKCgkJY29uc29sZS53YXJuKCJQaGFzZXIuTG9hZGVyIGVycm9yIGxvYWRpbmcgZmlsZTogIiArIGtleSArICcgZnJvbSBVUkwgJyArIHRoaXMuX2ZpbGVMaXN0W2tleV0udXJsKTsKCgkJdGhpcy5uZXh0RmlsZShrZXksIGZhbHNlKTsKCgl9LAoKCS8qKgoJKiBDYWxsZWQgd2hlbiBhIGZpbGUgaXMgc3VjY2Vzc2Z1bGx5IGxvYWRlZC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2ZpbGVDb21wbGV0ZQoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBzdWNjZXNzZnVsbHkgbG9hZGVkIGZpbGUuCgkqLwoJZmlsZUNvbXBsZXRlOiBmdW5jdGlvbiAoa2V5KSB7CgoJCWlmICghdGhpcy5fZmlsZUxpc3Rba2V5XSkKCQl7CgkJCWNvbnNvbGUud2FybignUGhhc2VyLkxvYWRlciBmaWxlQ29tcGxldGUgaW52YWxpZCBrZXkgJyArIGtleSk7CgkJCXJldHVybjsKCQl9CgkJCgkJdGhpcy5fZmlsZUxpc3Rba2V5XS5sb2FkZWQgPSB0cnVlOwoKCQl2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2tleV07CgkJdmFyIGxvYWROZXh0ID0gdHJ1ZTsKCQl2YXIgX3RoaXMgPSB0aGlzOwoKCQlzd2l0Y2ggKGZpbGUudHlwZSkKCQl7CgkJCWNhc2UgJ2ltYWdlJzoKCgkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkSW1hZ2UoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEpOwoJCQkJYnJlYWs7CgoJCQljYXNlICdzcHJpdGVzaGVldCc6CgoJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFNwcml0ZVNoZWV0KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLmZyYW1lV2lkdGgsIGZpbGUuZnJhbWVIZWlnaHQsIGZpbGUuZnJhbWVNYXgpOwoJCQkJYnJlYWs7CgoJCQljYXNlICd0aWxlc2V0JzoKCgkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGlsZXNldChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZmlsZS50aWxlV2lkdGgsIGZpbGUudGlsZUhlaWdodCwgZmlsZS50aWxlTWF4LCBmaWxlLnRpbGVNYXJnaW4sIGZpbGUudGlsZVNwYWNpbmcpOwoJCQkJYnJlYWs7CgoJCQljYXNlICd0ZXh0dXJlYXRsYXMnOgoKCQkJCWlmIChmaWxlLmF0bGFzVVJMID09IG51bGwpCgkJCQl7CgkJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFRleHR1cmVBdGxhcyhmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZmlsZS5hdGxhc0RhdGEsIGZpbGUuZm9ybWF0KTsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQkvLyAgTG9hZCB0aGUgSlNPTiBvciBYTUwgYmVmb3JlIGNhcnJ5aW5nIG9uIHdpdGggdGhlIG5leHQgZmlsZQoJCQkJCWxvYWROZXh0ID0gZmFsc2U7CgkJCQkJdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUuYXRsYXNVUkwsIHRydWUpOwoJCQkJCXRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgoJCQkJCWlmIChmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9BUlJBWSB8fCBmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfSlNPTl9IQVNIKQoJCQkJCXsKCQkJCQkJdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJCXJldHVybiBfdGhpcy5qc29uTG9hZENvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQkJfTsKCQkJCQl9CgkJCQkJZWxzZSBpZiAoZmlsZS5mb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORykKCQkJCQl7CgkJCQkJCXRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCQlyZXR1cm4gX3RoaXMueG1sTG9hZENvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQkJfTsKCQkJCQl9CgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgZm9ybWF0OiAiICsgZmlsZS5mb3JtYXQpOwoJCQkJCX0KCgkJCQkJdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCXJldHVybiBfdGhpcy5kYXRhTG9hZEVycm9yKGZpbGUua2V5KTsKCQkJCQl9OwoJCQkJCXRoaXMuX3hoci5zZW5kKCk7CgkJCQl9CgkJCQlicmVhazsKCgkJCWNhc2UgJ2JpdG1hcGZvbnQnOgoKCQkJCWlmIChmaWxlLnhtbFVSTCA9PSBudWxsKQoJCQkJewoJCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRCaXRtYXBGb250KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLnhtbERhdGEpOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCS8vICBMb2FkIHRoZSBYTUwgYmVmb3JlIGNhcnJ5aW5nIG9uIHdpdGggdGhlIG5leHQgZmlsZQoJCQkJCWxvYWROZXh0ID0gZmFsc2U7CgkJCQkJdGhpcy5feGhyLm9wZW4oIkdFVCIsIHRoaXMuYmFzZVVSTCArIGZpbGUueG1sVVJMLCB0cnVlKTsKCQkJCQl0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gInRleHQiOwoKCQkJCQl0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCQlyZXR1cm4gX3RoaXMueG1sTG9hZENvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQl9OwoKCQkJCQl0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoZmlsZS5rZXkpOwoJCQkJCX07CgkJCQkJdGhpcy5feGhyLnNlbmQoKTsKCQkJCX0KCQkJCWJyZWFrOwoKCQkJY2FzZSAnYXVkaW8nOgoKCQkJCWlmICh0aGlzLmdhbWUuc291bmQudXNpbmdXZWJBdWRpbykKCQkJCXsKCQkJCQlmaWxlLmRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2U7CgoJCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRTb3VuZChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgdHJ1ZSwgZmFsc2UpOwoKCQkJCQlpZiAoZmlsZS5hdXRvRGVjb2RlKQoJCQkJCXsKCQkJCQkJdGhpcy5nYW1lLmNhY2hlLnVwZGF0ZVNvdW5kKGtleSwgJ2lzRGVjb2RpbmcnLCB0cnVlKTsKCgkJCQkJCXZhciB0aGF0ID0gdGhpczsKCQkJCQkJdmFyIGtleSA9IGZpbGUua2V5OwoKCQkJCQkJdGhpcy5nYW1lLnNvdW5kLmNvbnRleHQuZGVjb2RlQXVkaW9EYXRhKGZpbGUuZGF0YSwgZnVuY3Rpb24gKGJ1ZmZlcikgewoJCQkJCQkJaWYgKGJ1ZmZlcikKCQkJCQkJCXsKCQkJCQkJCQl0aGF0LmdhbWUuY2FjaGUuZGVjb2RlZFNvdW5kKGtleSwgYnVmZmVyKTsKCQkJCQkJCX0KCQkJCQkJfSk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWZpbGUuZGF0YS5yZW1vdmVFdmVudExpc3RlbmVyKCdjYW5wbGF5dGhyb3VnaCcsIFBoYXNlci5HQU1FU1t0aGlzLmdhbWUuaWRdLmxvYWQuZmlsZUNvbXBsZXRlKTsKCQkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkU291bmQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZhbHNlLCB0cnVlKTsKCQkJCX0KCQkJCWJyZWFrOwoKCQkJY2FzZSAndGV4dCc6CgkJCQlmaWxlLmRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2VUZXh0OwoJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFRleHQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEpOwoJCQkJYnJlYWs7CgkJfQoKCQlpZiAobG9hZE5leHQpCgkJewoJCQl0aGlzLm5leHRGaWxlKGtleSwgdHJ1ZSk7CgkJfQoKCX0sCgoJLyoqCgkqIFN1Y2Nlc3NmdWxseSBsb2FkZWQgYSBKU09OIGZpbGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNqc29uTG9hZENvbXBsZXRlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGxvYWRlZCBKU09OIGZpbGUuCgkqLwoJanNvbkxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKGtleSkgewoKCQl2YXIgZGF0YSA9IEpTT04ucGFyc2UodGhpcy5feGhyLnJlc3BvbnNlVGV4dCk7CgkJdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtrZXldOwoKCQlpZiAoZmlsZS50eXBlID09ICd0aWxlbWFwJykKCQl7CgkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRUaWxlbWFwKGZpbGUua2V5LCBmaWxlLnVybCwgZGF0YSwgZmlsZS5mb3JtYXQpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBkYXRhLCBmaWxlLmZvcm1hdCk7CgkJfQoKCQl0aGlzLm5leHRGaWxlKGtleSwgdHJ1ZSk7CgoJfSwKCgkvKioKCSogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhIENTViBmaWxlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjY3N2TG9hZENvbXBsZXRlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGxvYWRlZCBDU1YgZmlsZS4KCSovCgljc3ZMb2FkQ29tcGxldGU6IGZ1bmN0aW9uIChrZXkpIHsKCgkJdmFyIGRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2VUZXh0OwoJCXZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3Rba2V5XTsKCgkJdGhpcy5nYW1lLmNhY2hlLmFkZFRpbGVtYXAoZmlsZS5rZXksIGZpbGUudXJsLCBkYXRhLCBmaWxlLmZvcm1hdCk7CgoJCXRoaXMubmV4dEZpbGUoa2V5LCB0cnVlKTsKCgl9LAoKCS8qKgoJKiBFcnJvciBvY2N1cmVkIHdoZW4gbG9hZCBhIEpTT04uCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNkYXRhTG9hZEVycm9yCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGVycm9yIGxvYWRpbmcgSlNPTiBmaWxlLgoJKi8KCWRhdGFMb2FkRXJyb3I6IGZ1bmN0aW9uIChrZXkpIHsKCgkJdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtrZXldOwoKCQlmaWxlLmVycm9yID0gdHJ1ZTsKCgkJY29uc29sZS53YXJuKCJQaGFzZXIuTG9hZGVyIGRhdGFMb2FkRXJyb3I6ICIgKyBrZXkpOwoKCQl0aGlzLm5leHRGaWxlKGtleSwgdHJ1ZSk7CgoJfSwKCgkvKioKCSogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhbiBYTUwgZmlsZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3htbExvYWRDb21wbGV0ZQoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBsb2FkZWQgWE1MIGZpbGUuCgkqLwoJeG1sTG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoa2V5KSB7CgoJCXZhciBkYXRhID0gdGhpcy5feGhyLnJlc3BvbnNlVGV4dDsKCQl2YXIgeG1sOwoKCQl0cnkKCQl7CgkJCWlmICh3aW5kb3dbJ0RPTVBhcnNlciddKQoJCQl7CgkJCQl2YXIgZG9tcGFyc2VyID0gbmV3IERPTVBhcnNlcigpOwoJCQkJeG1sID0gZG9tcGFyc2VyLnBhcnNlRnJvbVN0cmluZyhkYXRhLCAidGV4dC94bWwiKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXhtbCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MRE9NIik7CgkJCQl4bWwuYXN5bmMgPSAnZmFsc2UnOwoJCQkJeG1sLmxvYWRYTUwoZGF0YSk7CgkJCX0KCQl9CgkJY2F0Y2ggKGUpCgkJewoJCQl4bWwgPSB1bmRlZmluZWQ7CgkJfQoKCQlpZiAoIXhtbCB8fCAheG1sLmRvY3VtZW50RWxlbWVudCB8fCB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoInBhcnNlcmVycm9yIikubGVuZ3RoKQoJCXsKCQkJdGhyb3cgbmV3IEVycm9yKCJQaGFzZXIuTG9hZGVyLiBJbnZhbGlkIFhNTCBnaXZlbiIpOwoJCX0KCgkJdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtrZXldOwoKCQlpZiAoZmlsZS50eXBlID09ICdiaXRtYXBmb250JykKCQl7CgkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRCaXRtYXBGb250KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB4bWwpOwoJCX0KCQllbHNlIGlmIChmaWxlLnR5cGUgPT0gJ3RleHR1cmVhdGxhcycpCgkJewoJCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB4bWwsIGZpbGUuZm9ybWF0KTsKCQl9CgoJCXRoaXMubmV4dEZpbGUoa2V5LCB0cnVlKTsKCgl9LAoKCS8qKgoJKiBIYW5kbGUgbG9hZGluZyBuZXh0IGZpbGUuCgkqCgkqIEBwYXJhbSBwcmV2aW91c0tleSB7c3RyaW5nfSBLZXkgb2YgcHJldmlvdXMgbG9hZGVkIGFzc2V0LgoJKiBAcGFyYW0gc3VjY2VzcyB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcHJldmlvdXMgYXNzZXQgbG9hZGVkIHN1Y2Nlc3NmdWxseSBvciBub3QuCgkqIEBwcml2YXRlCgkqLwoJbmV4dEZpbGU6IGZ1bmN0aW9uIChwcmV2aW91c0tleSwgc3VjY2VzcykgewoKCQl0aGlzLnByb2dyZXNzID0gTWF0aC5yb3VuZCh0aGlzLnByb2dyZXNzICsgdGhpcy5fcHJvZ3Jlc3NDaHVuayk7CgoJCWlmICh0aGlzLnByb2dyZXNzID4gMTAwKQoJCXsKCQkJdGhpcy5wcm9ncmVzcyA9IDEwMDsKCQl9CgoJCWlmICh0aGlzLnByZWxvYWRTcHJpdGUgIT09IG51bGwpCgkJewoJCQlpZiAodGhpcy5wcmVsb2FkU3ByaXRlLmRpcmVjdGlvbiA9PSAwKQoJCQl7CgkJCQl0aGlzLnByZWxvYWRTcHJpdGUuY3JvcC53aWR0aCA9IE1hdGguZmxvb3IoKHRoaXMucHJlbG9hZFNwcml0ZS53aWR0aCAvIDEwMCkgKiB0aGlzLnByb2dyZXNzKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMucHJlbG9hZFNwcml0ZS5jcm9wLmhlaWdodCA9IE1hdGguZmxvb3IoKHRoaXMucHJlbG9hZFNwcml0ZS5oZWlnaHQgLyAxMDApICogdGhpcy5wcm9ncmVzcyk7CgkJCX0KCgkJCXRoaXMucHJlbG9hZFNwcml0ZS5zcHJpdGUuY3JvcCA9IHRoaXMucHJlbG9hZFNwcml0ZS5jcm9wOwoJCX0KCgkJdGhpcy5vbkZpbGVDb21wbGV0ZS5kaXNwYXRjaCh0aGlzLnByb2dyZXNzLCBwcmV2aW91c0tleSwgc3VjY2VzcywgdGhpcy5xdWV1ZVNpemUgLSB0aGlzLl9rZXlzLmxlbmd0aCwgdGhpcy5xdWV1ZVNpemUpOwoKCQlpZiAodGhpcy5fa2V5cy5sZW5ndGggPiAwKQoJCXsKCQkJdGhpcy5sb2FkRmlsZSgpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLmhhc0xvYWRlZCA9IHRydWU7CgkJCXRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CgkJCQoJCQl0aGlzLnJlbW92ZUFsbCgpOwoKCQkJdGhpcy5vbkxvYWRDb21wbGV0ZS5kaXNwYXRjaCgpOwoJCX0KCgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLkxvYWRlclBhcnNlciBwYXJzZXMgZGF0YSBvYmplY3RzIGZyb20gUGhhc2VyLkxvYWRlciB0aGF0IG5lZWQgbW9yZSBwcmVwYXJhdGlvbiBiZWZvcmUgdGhleSBjYW4gYmUgaW5zZXJ0ZWQgaW50byB0aGUgQ2FjaGUuCioKKiBAY2xhc3MgUGhhc2VyLkxvYWRlclBhcnNlcgoqLwpQaGFzZXIuTG9hZGVyUGFyc2VyID0gewoJCiAgICAvKioKICAgICogUGFyc2UgZnJhbWUgZGF0YSBmcm9tIGFuIFhNTCBmaWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXJQYXJzZXIuYml0bWFwRm9udAogICAgKiBAcGFyYW0ge29iamVjdH0geG1sIC0gWE1MIGRhdGEgeW91IHdhbnQgdG8gcGFyc2UuCiAgICAqIEByZXR1cm4ge0ZyYW1lRGF0YX0gR2VuZXJhdGVkIEZyYW1lRGF0YSBvYmplY3QuCiAgICAqLwoJYml0bWFwRm9udDogZnVuY3Rpb24gKGdhbWUsIHhtbCwgY2FjaGVLZXkpIHsKCiAgICAgICAgLy8gIE1hbGZvcm1lZD8KICAgICAgICBpZiAoIXhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnZm9udCcpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuTG9hZGVyUGFyc2VyLmJpdG1hcEZvbnQ6IEludmFsaWQgWE1MIGdpdmVuLCBtaXNzaW5nIDxmb250PiB0YWciKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtjYWNoZUtleV07CgogICAgICAgIHZhciBkYXRhID0ge307CiAgICAgICAgdmFyIGluZm8gPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImluZm8iKVswXTsKICAgICAgICB2YXIgY29tbW9uID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjb21tb24iKVswXTsKICAgICAgICBkYXRhLmZvbnQgPSBpbmZvLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJmYWNlIikubm9kZVZhbHVlOwogICAgICAgIGRhdGEuc2l6ZSA9IHBhcnNlSW50KGluZm8uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInNpemUiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICBkYXRhLmxpbmVIZWlnaHQgPSBwYXJzZUludChjb21tb24uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImxpbmVIZWlnaHQiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICBkYXRhLmNoYXJzID0ge307CgogICAgICAgIC8vcGFyc2UgbGV0dGVycwogICAgICAgIHZhciBsZXR0ZXJzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJjaGFyIik7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGV0dGVycy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjaGFyQ29kZSA9IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImlkIikubm9kZVZhbHVlLCAxMCk7CgogICAgICAgICAgICB2YXIgdGV4dHVyZVJlY3QgPSB7CiAgICAgICAgICAgICAgICB4OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ4Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB5OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ5Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB3aWR0aDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgid2lkdGgiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIGhlaWdodDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiaGVpZ2h0Iikubm9kZVZhbHVlLCAxMCkKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vCU5vdGU6IFRoaXMgbWVhbnMgeW91IGNhbiBvbmx5IGhhdmUgMSBCaXRtYXBGb250IGxvYWRlZCBhdCBvbmNlIQogICAgICAgICAgICAvLwlOZWVkIHRvIHJlcGxhY2UgdGhpcyB3aXRoIG91ciBvd24gaGFuZGxlciBzb29uLgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtjaGFyQ29kZV0gPSBuZXcgUElYSS5UZXh0dXJlKHRleHR1cmUsIHRleHR1cmVSZWN0KTsKCiAgICAgICAgICAgIGRhdGEuY2hhcnNbY2hhckNvZGVdID0gewogICAgICAgICAgICAgICAgeE9mZnNldDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgieG9mZnNldCIpLm5vZGVWYWx1ZSwgMTApLAogICAgICAgICAgICAgICAgeU9mZnNldDogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgieW9mZnNldCIpLm5vZGVWYWx1ZSwgMTApLAogICAgICAgICAgICAgICAgeEFkdmFuY2U6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInhhZHZhbmNlIikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICBrZXJuaW5nOiB7fSwKICAgICAgICAgICAgICAgIHRleHR1cmU6bmV3IFBJWEkuVGV4dHVyZSh0ZXh0dXJlLCB0ZXh0dXJlUmVjdCkKCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICAvL3BhcnNlIGtlcm5pbmdzCiAgICAgICAgdmFyIGtlcm5pbmdzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJrZXJuaW5nIik7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBrZXJuaW5ncy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgdmFyIGZpcnN0ID0gcGFyc2VJbnQoa2VybmluZ3NbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImZpcnN0Iikubm9kZVZhbHVlLCAxMCk7CiAgICAgICAgICAgdmFyIHNlY29uZCA9IHBhcnNlSW50KGtlcm5pbmdzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJzZWNvbmQiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICB2YXIgYW1vdW50ID0gcGFyc2VJbnQoa2VybmluZ3NbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImFtb3VudCIpLm5vZGVWYWx1ZSwgMTApOwoKICAgICAgICAgICAgZGF0YS5jaGFyc1tzZWNvbmRdLmtlcm5pbmdbZmlyc3RdID0gYW1vdW50OwogICAgICAgIH0KCiAgICAgICAgUElYSS5CaXRtYXBUZXh0LmZvbnRzW2RhdGEuZm9udF0gPSBkYXRhOwoKICAgIH0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBTb3VuZCBjbGFzcyBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuU291bmQKKiBAY2xhc3NkZXNjIFRoZSBTb3VuZCBjbGFzcwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBEZWZhdWx0IHZhbHVlIGZvciB0aGUgdm9sdW1lLCBiZXR3ZWVuIDAgYW5kIDEuCiogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgoqLwpQaGFzZXIuU291bmQgPSBmdW5jdGlvbiAoZ2FtZSwga2V5LCB2b2x1bWUsIGxvb3ApIHsKCQoJdm9sdW1lID0gdm9sdW1lIHx8IDE7CglpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgogICAgLyoqCiAgICAqIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogTmFtZSBvZiB0aGUgc291bmQuCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5uYW1lID0ga2V5OwoKICAgIC8qKgogICAgKiBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGtleQogICAgKi8KICAgIHRoaXMua2V5ID0ga2V5OwoKICAgIC8qKgogICAgKiBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvb3AKICAgICovCiAgICB0aGlzLmxvb3AgPSBsb29wOwoKICAgIC8qKgogICAgKiBUaGUgZ2xvYmFsIGF1ZGlvIHZvbHVtZS4gQSB2YWx1ZSBiZXR3ZWVuIDAgKHNpbGVuY2UpIGFuZCAxIChmdWxsIHZvbHVtZSkuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdm9sdW1lCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdm9sdW1lID0gdm9sdW1lOwoKICAgIC8qKgogICAgKiBUaGUgc291bmQgbWFya2VycywgZW1wdHkgYnkgZGVmYXVsdC4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IG1hcmtlcnMKICAgICovCiAgICB0aGlzLm1hcmtlcnMgPSB7fTsKCiAgICAKICAgIC8qKgogICAgKiBSZWZlcmVuY2UgdG8gQXVkaW9Db250ZXh0IGluc3RhbmNlLgogICAgKiBAcHJvcGVydHkge0F1ZGlvQ29udGV4dH0gY29udGV4dAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IG51bGw7CgogICAgLyoqCiAgICAqIERlY29kZWQgZGF0YSBidWZmZXIgLyBBdWRpbyB0YWcuCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9idWZmZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9idWZmZXIgPSBudWxsOwoKICAgIC8qKgogICAgKiBCb29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0aGUgZ2FtZSBpcyBvbiAibXV0ZSIuIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9tdXRlZAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX211dGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBzb3VuZCBzaG91bGQgc3RhcnQgYXV0b21hdGljYWxseS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBhdXRvcGxheQogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuYXV0b3BsYXkgPSBmYWxzZTsKCiAgICAvKioKICAgICogVGhlIHRvdGFsIGR1cmF0aW9uIG9mIHRoZSBzb3VuZCwgaW4gbWlsbGlzZWNvbmRzCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbER1cmF0aW9uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3RhbER1cmF0aW9uID0gMDsKICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdGFydFRpbWUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnN0YXJ0VGltZSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRUaW1lCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHN0b3BUaW1lCiAgICAqLwogICAgdGhpcy5zdG9wVGltZSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYXVzZWRQb3NpdGlvbgogICAgKi8KICAgIHRoaXMucGF1c2VkUG9zaXRpb24gPSAwOwoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFRpbWUKICAgICovCiAgICB0aGlzLnBhdXNlZFRpbWUgPSAwOwoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1BsYXlpbmcKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBjdXJyZW50TWFya2VyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXJyZW50TWFya2VyID0gJyc7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBwZW5kaW5nUGxheWJhY2sKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb3ZlcnJpZGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm92ZXJyaWRlID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSB1c2luZ1dlYkF1ZGlvCiAgICAqLwogICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gdGhpcy5nYW1lLnNvdW5kLnVzaW5nV2ViQXVkaW87CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdXNpbmdBdWRpb1RhZwogICAgKi8KICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRoaXMuZ2FtZS5zb3VuZC51c2luZ0F1ZGlvVGFnOwoKICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICB7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gdGhpcy5nYW1lLnNvdW5kLmNvbnRleHQ7CiAgICAgICAgdGhpcy5tYXN0ZXJHYWluTm9kZSA9IHRoaXMuZ2FtZS5zb3VuZC5tYXN0ZXJHYWluOwoKICAgICAgICBpZiAodHlwZW9mIHRoaXMuY29udGV4dC5jcmVhdGVHYWluID09PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUgPSB0aGlzLmNvbnRleHQuY3JlYXRlR2Fpbk5vZGUoKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYWluTm9kZSA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2b2x1bWUgKiB0aGlzLmdhbWUuc291bmQudm9sdW1lOwogICAgICAgIHRoaXMuZ2Fpbk5vZGUuY29ubmVjdCh0aGlzLm1hc3RlckdhaW5Ob2RlKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKGtleSkgJiYgdGhpcy5nYW1lLmNhY2hlLmlzU291bmRSZWFkeShrZXkpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKGtleSk7CiAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IDA7CgogICAgICAgICAgICBpZiAodGhpcy5fc291bmQuZHVyYXRpb24pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IHRoaXMuX3NvdW5kLmR1cmF0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5vblNvdW5kVW5sb2NrLmFkZCh0aGlzLnNvdW5kSGFzVW5sb2NrZWQsIHRoaXMpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25EZWNvZGVkCiAgICAqLwogICAgdGhpcy5vbkRlY29kZWQgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUGxheQogICAgKi8KICAgIHRoaXMub25QbGF5ID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblBhdXNlCiAgICAqLwogICAgdGhpcy5vblBhdXNlID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblJlc3VtZQogICAgKi8KICAgIHRoaXMub25SZXN1bWUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTG9vcAogICAgKi8KICAgIHRoaXMub25Mb29wID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblN0b3AKICAgICovCiAgICB0aGlzLm9uU3RvcCA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25NdXRlCiAgICAqLwogICAgdGhpcy5vbk11dGUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTWFya2VyQ29tcGxldGUKICAgICovCiAgICB0aGlzLm9uTWFya2VyQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCn07CgpQaGFzZXIuU291bmQucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSB3aGVuIHRoaXMgc291bmQgaXMgdW5sb2NrZWQuCgkqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3NvdW5kSGFzVW5sb2NrZWQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJvdGVjdGVkCgkqLwogICAgc291bmRIYXNVbmxvY2tlZDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAoa2V5ID09IHRoaXMua2V5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKHRoaXMua2V5KTsKICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdzb3VuZCBoYXMgdW5sb2NrZWQnICsgdGhpcy5fc291bmQpOwoJICAgIH0KCgl9LAoKCS8qKgoJICogRGVzY3JpcHRpb24uCgkgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNhZGRNYXJrZXIKCSAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBzdGFydCAtIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHtEZXNjcmlwdGlvbn0gc3RvcCAtIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHtEZXNjcmlwdGlvbn0gdm9sdW1lIC0gRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBsb29wIC0gRGVzY3JpcHRpb24uCiAgICBhZGRNYXJrZXI6IGZ1bmN0aW9uIChuYW1lLCBzdGFydCwgc3RvcCwgdm9sdW1lLCBsb29wKSB7CgogICAgCXZvbHVtZSA9IHZvbHVtZSB8fCAxOwogICAgCWlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAgICAgdGhpcy5tYXJrZXJzW25hbWVdID0gewogICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICBzdGFydDogc3RhcnQsCiAgICAgICAgICAgIHN0b3A6IHN0b3AsCiAgICAgICAgICAgIHZvbHVtZTogdm9sdW1lLAogICAgICAgICAgICBkdXJhdGlvbjogc3RvcCAtIHN0YXJ0LAogICAgICAgICAgICBsb29wOiBsb29wCiAgICAgICAgfTsKCiAgICB9LAogICAgKi8KCiAgICAvKioKICAgICogQWRkcyBhIG1hcmtlciBpbnRvIHRoZSBjdXJyZW50IFNvdW5kLiBBIG1hcmtlciBpcyByZXByZXNlbnRlZCBieSBhIHVuaXF1ZSBrZXkgYW5kIGEgc3RhcnQgdGltZSBhbmQgZHVyYXRpb24uCiAgICAqIFRoaXMgYWxsb3dzIHlvdSB0byBidW5kbGUgbXVsdGlwbGUgc291bmRzIHRvZ2V0aGVyIGludG8gYSBzaW5nbGUgYXVkaW8gZmlsZSBhbmQgdXNlIG1hcmtlcnMgdG8ganVtcCBiZXR3ZWVuIHRoZW0gZm9yIHBsYXliYWNrLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNhZGRNYXJrZXIKICAgICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBBIHVuaXF1ZSBuYW1lIGZvciB0aGlzIG1hcmtlciwgaS5lLiAnZXhwbG9zaW9uJywgJ2d1bnNob3QnLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCAtIFRoZSBzdGFydCBwb2ludCBvZiB0aGlzIG1hcmtlciBpbiB0aGUgYXVkaW8gZmlsZSwgZ2l2ZW4gaW4gc2Vjb25kcy4gMi41ID0gMjUwMG1zLCAwLjUgPSA1MDBtcywgZXRjLgogICAgKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBUaGUgZHVyYXRpb24gb2YgdGhlIG1hcmtlciBpbiBzZWNvbmRzLiAyLjUgPSAyNTAwbXMsIDAuNSA9IDUwMG1zLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gVGhlIHZvbHVtZSB0aGUgc291bmQgd2lsbCBwbGF5IGJhY2sgYXQsIGJldHdlZW4gMCAoc2lsZW50KSBhbmQgMSAoZnVsbCB2b2x1bWUpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNldHMgaWYgdGhlIHNvdW5kIHdpbGwgbG9vcCBvciBub3QuCiAgICAqLwogICAgYWRkTWFya2VyOiBmdW5jdGlvbiAobmFtZSwgc3RhcnQsIGR1cmF0aW9uLCB2b2x1bWUsIGxvb3ApIHsKCiAgICAgICAgdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLm1hcmtlcnNbbmFtZV0gPSB7CiAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgICAgICAgc3RvcDogc3RhcnQgKyBkdXJhdGlvbiwKICAgICAgICAgICAgdm9sdW1lOiB2b2x1bWUsCiAgICAgICAgICAgIGR1cmF0aW9uOiBkdXJhdGlvbiwKICAgICAgICAgICAgZHVyYXRpb25NUzogZHVyYXRpb24gKiAxMDAwLAogICAgICAgICAgICBsb29wOiBsb29wCiAgICAgICAgfTsKCiAgICB9LAoKCS8qKgoJKiBSZW1vdmVzIGEgbWFya2VyIGZyb20gdGhlIHNvdW5kLgoJKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNyZW1vdmVNYXJrZXIKCSogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUga2V5IG9mIHRoZSBtYXJrZXIgdG8gcmVtb3ZlLgoJKi8KICAgIHJlbW92ZU1hcmtlcjogZnVuY3Rpb24gKG5hbWUpIHsKCiAgICAgICAgZGVsZXRlIHRoaXMubWFya2Vyc1tuYW1lXTsKCiAgICB9LAoKCS8qKgoJKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuU291bmRNYW5hZ2VyLgoJKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCN1cGRhdGUKICAgICogQHByb3RlY3RlZAoJKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5wZW5kaW5nUGxheWJhY2sgJiYgdGhpcy5nYW1lLmNhY2hlLmlzU291bmRSZWFkeSh0aGlzLmtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5fdGVtcE1hcmtlciwgdGhpcy5fdGVtcFBvc2l0aW9uLCB0aGlzLl90ZW1wVm9sdW1lLCB0aGlzLl90ZW1wTG9vcCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5zdGFydFRpbWU7CgogICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50VGltZSA+PSB0aGlzLmR1cmF0aW9uTVMpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2codGhpcy5jdXJyZW50TWFya2VyLCAnaGFzIGhpdCBkdXJhdGlvbicpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnbG9vcDEnKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gIHdvbid0IHdvcmsgd2l0aCBtYXJrZXJzLCBuZWVkcyB0byByZXNldCB0aGUgcG9zaXRpb24KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxvb3AuZGlzcGF0Y2godGhpcyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50TWFya2VyID09ICcnKQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdsb29wMicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2xvb3AzJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5jdXJyZW50TWFya2VyLCAwLCB0aGlzLnZvbHVtZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnc3RvcHBpbmcsIG5vIGxvb3AgZm9yIG1hcmtlcicpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubG9vcCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25Mb29wLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBsYXkodGhpcy5jdXJyZW50TWFya2VyLCAwLCB0aGlzLnZvbHVtZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgoJLyoqCiAgICAqIFBsYXkgdGhpcyBzb3VuZCwgb3IgYSBtYXJrZWQgc2VjdGlvbiBvZiBpdC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjcGxheQogICAgKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcj0nJ10gLSBJZiB5b3Ugd2FudCB0byBwbGF5IGEgbWFya2VyIHRoZW4gZ2l2ZSB0aGUga2V5IGhlcmUsIG90aGVyd2lzZSBsZWF2ZSBibGFuayB0byBwbGF5IHRoZSBmdWxsIHNvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3Bvc2l0aW9uPTBdIC0gVGhlIHN0YXJ0aW5nIHBvc2l0aW9uIHRvIHBsYXkgdGhlIHNvdW5kIGZyb20gLSB0aGlzIGlzIGlnbm9yZWQgaWYgeW91IHByb3ZpZGUgYSBtYXJrZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gVm9sdW1lIG9mIHRoZSBzb3VuZCB5b3Ugd2FudCB0byBwbGF5LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIExvb3Agd2hlbiBpdCBmaW5pc2hlZCBwbGF5aW5nPwogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmb3JjZVJlc3RhcnQ9dHJ1ZV0gLSBJZiB0aGUgc291bmQgaXMgYWxyZWFkeSBwbGF5aW5nIHlvdSBjYW4gc2V0IGZvcmNlUmVzdGFydCB0byByZXN0YXJ0IGl0IGZyb20gdGhlIGJlZ2lubmluZy4KICAgICogQHJldHVybiB7U291bmR9IFRoZSBwbGF5aW5nIHNvdW5kIG9iamVjdC4KICAgICovCiAgICBwbGF5OiBmdW5jdGlvbiAobWFya2VyLCBwb3NpdGlvbiwgdm9sdW1lLCBsb29wLCBmb3JjZVJlc3RhcnQpIHsKCiAgICAJbWFya2VyID0gbWFya2VyIHx8ICcnOwogICAgCXBvc2l0aW9uID0gcG9zaXRpb24gfHwgMDsKICAgIAl2b2x1bWUgPSB2b2x1bWUgfHwgMTsKICAgIAlpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CiAgICAJaWYgKHR5cGVvZiBmb3JjZVJlc3RhcnQgPT0gJ3VuZGVmaW5lZCcpIHsgZm9yY2VSZXN0YXJ0ID0gdHJ1ZTsgfQoKICAgICAgICAvLyBjb25zb2xlLmxvZyh0aGlzLm5hbWUgKyAnIHBsYXkgJyArIG1hcmtlciArICcgcG9zaXRpb24gJyArIHBvc2l0aW9uICsgJyB2b2x1bWUgJyArIHZvbHVtZSArICcgbG9vcCAnICsgbG9vcCwgJ2ZvcmNlJywgZm9yY2VSZXN0YXJ0KTsKCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nID09IHRydWUgJiYgZm9yY2VSZXN0YXJ0ID09IGZhbHNlICYmIHRoaXMub3ZlcnJpZGUgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVXNlIFJlc3RhcnQgaW5zdGVhZAogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgdGhpcy5vdmVycmlkZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdhc2tlZCB0byBwbGF5ICcgKyBtYXJrZXIgKyAnIGJ1dCBhbHJlYWR5IHBsYXlpbmcgJyArIHRoaXMuY3VycmVudE1hcmtlcik7CiAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RvcCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZU9mZigwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5zdG9wKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQucGF1c2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5jdXJyZW50TWFya2VyID0gbWFya2VyOwoKICAgICAgICBpZiAobWFya2VyICE9PSAnJykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLm1hcmtlcnNbbWFya2VyXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLnN0YXJ0OwogICAgICAgICAgICAgICAgdGhpcy52b2x1bWUgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLmxvb3AgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS5sb29wOwogICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLmR1cmF0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uZHVyYXRpb25NUzsKCiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnTWFya2VyIExvYWRlZDogJywgbWFya2VyLCAnc3RhcnQ6JywgdGhpcy5wb3NpdGlvbiwgJ2VuZDogJywgdGhpcy5kdXJhdGlvbiwgJ2xvb3AnLCB0aGlzLmxvb3ApOwoKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBNYXJrZXIgPSBtYXJrZXI7CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wUG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgdGhpcy5fdGVtcFZvbHVtZSA9IHRoaXMudm9sdW1lOwogICAgICAgICAgICAgICAgdGhpcy5fdGVtcExvb3AgPSB0aGlzLmxvb3A7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Tb3VuZC5wbGF5OiBhdWRpbyBtYXJrZXIgIiArIG1hcmtlciArICIgZG9lc24ndCBleGlzdCIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdubyBtYXJrZXIgaW5mbyBsb2FkZWQnLCBtYXJrZXIpOwoKICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgICAgICAgICB0aGlzLnZvbHVtZSA9IHZvbHVtZTsKICAgICAgICAgICAgdGhpcy5sb29wID0gbG9vcDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb25NUyA9IDA7CgogICAgICAgICAgICB0aGlzLl90ZW1wTWFya2VyID0gbWFya2VyOwogICAgICAgICAgICB0aGlzLl90ZW1wUG9zaXRpb24gPSBwb3NpdGlvbjsKICAgICAgICAgICAgdGhpcy5fdGVtcFZvbHVtZSA9IHZvbHVtZTsKICAgICAgICAgICAgdGhpcy5fdGVtcExvb3AgPSBsb29wOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBEb2VzIHRoZSBzb3VuZCBuZWVkIGRlY29kaW5nPwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmlzU291bmREZWNvZGVkKHRoaXMua2V5KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvIHdlIG5lZWQgdG8gZG8gdGhpcyBldmVyeSB0aW1lIHdlIHBsYXk/IEhvdyBhYm91dCBqdXN0IGlmIHRoZSBidWZmZXIgaXMgZW1wdHk/CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fYnVmZmVyID09IG51bGwpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYnVmZmVyID0gdGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kRGF0YSh0aGlzLmtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fc291bmQgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyU291cmNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5idWZmZXIgPSB0aGlzLl9idWZmZXI7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jb25uZWN0KHRoaXMuZ2Fpbk5vZGUpOwogICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuYnVmZmVyLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmR1cmF0aW9uID09IDApCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2R1cmF0aW9uIHJlc2V0Jyk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMudG90YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uTVMgPSB0aGlzLnRvdGFsRHVyYXRpb24gKiAxMDAwOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3AgJiYgbWFya2VyID09ICcnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmxvb3AgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vICBVc2VmdWwgdG8gY2FjaGUgdGhpcyBzb21ld2hlcmUgcGVyaGFwcz8KICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5fc291bmQuc3RhcnQgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm5vdGVHcmFpbk9uKDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgICAgIC8vIHRoaXMuX3NvdW5kLm5vdGVHcmFpbk9uKDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24gLyAxMDAwKTsKICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3NvdW5kLm5vdGVPbigwKTsgLy8gdGhlIHplcm8gaXMgdml0YWxseSBpbXBvcnRhbnQsIGNyYXNoZXMgaU9TNiB3aXRob3V0IGl0CgkJCQl9CgkJCQllbHNlCgkJCQl7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5fc291bmQuc3RhcnQoMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbiAvIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0YXJ0KDAsIHRoaXMucG9zaXRpb24sIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgICAgICB0aGlzLnN0b3BUaW1lID0gdGhpcy5zdGFydFRpbWUgKyB0aGlzLmR1cmF0aW9uTVM7CiAgICAgICAgICAgICAgICB0aGlzLm9uUGxheS5kaXNwYXRjaCh0aGlzKTsKCQkJfQoJCQllbHNlCgkJCXsKICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKHRoaXMua2V5KSAmJiB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpLmlzRGVjb2RpbmcgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnNvdW5kLmRlY29kZSh0aGlzLmtleSwgdGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ1NvdW5kIHBsYXkgQXVkaW8nKTsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkgJiYgdGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKHRoaXMua2V5KS5sb2NrZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd0cmllZCBwbGF5aW5nIGxvY2tlZCBzb3VuZCwgcGVuZGluZyBzZXQsIHJlbG9hZCBzdGFydGVkJyk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUucmVsb2FkU291bmQodGhpcy5rZXkpOwogICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NvdW5kIG5vdCBsb2NrZWQsIHN0YXRlPycsIHRoaXMuX3NvdW5kLnJlYWR5U3RhdGUpOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kICYmIHRoaXMuX3NvdW5kLnJlYWR5U3RhdGUgPT0gNCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgLy8gIFRoaXMgZG9lc24ndCBiZWNvbWUgYXZhaWxhYmxlIHVudGlsIHlvdSBjYWxsIHBsYXkoKSwgd29uZGVyZnVsIC4uLgogICAgICAgICAgICAgICAgICAgIHRoaXMudG90YWxEdXJhdGlvbiA9IHRoaXMuX3NvdW5kLmR1cmF0aW9uOwoKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5kdXJhdGlvbiA9PSAwKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IHRoaXMudG90YWxEdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gdGhpcy50b3RhbER1cmF0aW9uICogMTAwMDsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdwbGF5aW5nJywgdGhpcy5fc291bmQpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmN1cnJlbnRUaW1lID0gdGhpcy5wb3NpdGlvbjsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5tdXRlZCA9IHRoaXMuX211dGVkOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9tdXRlZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHRoaXMuX3ZvbHVtZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXJ0VGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3BUaW1lID0gdGhpcy5zdGFydFRpbWUgKyB0aGlzLmR1cmF0aW9uTVM7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vblBsYXkuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogUmVzdGFydCB0aGUgc291bmQsIG9yIGEgbWFya2VkIHNlY3Rpb24gb2YgaXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3Jlc3RhcnQKICAgICogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXI9JyddIC0gSWYgeW91IHdhbnQgdG8gcGxheSBhIG1hcmtlciB0aGVuIGdpdmUgdGhlIGtleSBoZXJlLCBvdGhlcndpc2UgbGVhdmUgYmxhbmsgdG8gcGxheSB0aGUgZnVsbCBzb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtwb3NpdGlvbj0wXSAtIFRoZSBzdGFydGluZyBwb3NpdGlvbiB0byBwbGF5IHRoZSBzb3VuZCBmcm9tIC0gdGhpcyBpcyBpZ25vcmVkIGlmIHlvdSBwcm92aWRlIGEgbWFya2VyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIFZvbHVtZSBvZiB0aGUgc291bmQgeW91IHdhbnQgdG8gcGxheS4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBMb29wIHdoZW4gaXQgZmluaXNoZWQgcGxheWluZz8KICAgICovCiAgICByZXN0YXJ0OiBmdW5jdGlvbiAobWFya2VyLCBwb3NpdGlvbiwgdm9sdW1lLCBsb29wKSB7CgogICAgCW1hcmtlciA9IG1hcmtlciB8fCAnJzsKICAgIAlwb3NpdGlvbiA9IHBvc2l0aW9uIHx8IDA7CiAgICAJdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAJaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnBsYXkobWFya2VyLCBwb3NpdGlvbiwgdm9sdW1lLCBsb29wLCB0cnVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgdGhlIHNvdW5kCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3BhdXNlCiAgICAqLwogICAgcGF1c2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucGF1c2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWRQb3NpdGlvbiA9IHRoaXMuY3VycmVudFRpbWU7CiAgICAgICAgICAgIHRoaXMucGF1c2VkVGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5vblBhdXNlLmRpc3BhdGNoKHRoaXMpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXN1bWVzIHRoZSBzb3VuZAogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNyZXN1bWUKICAgICovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMucGF1c2VkICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmFyIHAgPSB0aGlzLnBvc2l0aW9uICsgKHRoaXMucGF1c2VkUG9zaXRpb24gLyAxMDAwKTsKCiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmJ1ZmZlciA9IHRoaXMuX2J1ZmZlcjsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5nYWluTm9kZSk7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdGFydCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZUdyYWluT24oMCwgcCwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgLy90aGlzLl9zb3VuZC5ub3RlT24oMCk7IC8vIHRoZSB6ZXJvIGlzIHZpdGFsbHkgaW1wb3J0YW50LCBjcmFzaGVzIGlPUzYgd2l0aG91dCBpdAoJCQkJfQoJCQkJZWxzZQoJCQkJewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0YXJ0KDAsIHAsIHRoaXMuZHVyYXRpb24pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQucGxheSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lICs9ICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnBhdXNlZFRpbWUpOwogICAgICAgICAgICB0aGlzLm9uUmVzdW1lLmRpc3BhdGNoKHRoaXMpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBTdG9wIHBsYXlpbmcgdGhpcyBzb3VuZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdG9wID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5ub3RlT2ZmKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0b3AoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wYXVzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHZhciBwcmV2TWFya2VyID0gdGhpcy5jdXJyZW50TWFya2VyOwogICAgICAgIAogICAgICAgIHRoaXMuY3VycmVudE1hcmtlciA9ICcnOwogICAgICAgIHRoaXMub25TdG9wLmRpc3BhdGNoKHRoaXMsIHByZXZNYXJrZXIpOwoKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuU291bmQjaXNEZWNvZGluZwoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEZWNvZGluZyAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgc291bmQgZmlsZSBpcyBzdGlsbCBkZWNvZGluZy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJpc0RlY29kaW5nIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpLmlzRGVjb2Rpbmc7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNpc0RlY29kZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRGVjb2RlZCAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgc291bmQgZmlsZSBoYXMgZGVjb2RlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJpc0RlY29kZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYWNoZS5pc1NvdW5kRGVjb2RlZCh0aGlzLmtleSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNtdXRlCiogQHByb3BlcnR5IHtib29sZWFufSBtdXRlIC0gR2V0cyBvciBzZXRzIHRoZSBtdXRlZCBzdGF0ZSBvZiB0aGlzIHNvdW5kLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgIm11dGUiLCB7CgkKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9tdXRlZDsKICAgIH0sCiAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgCXZhbHVlID0gdmFsdWUgfHwgbnVsbDsKCiAgICAgICAgaWYgKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbXV0ZWQgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbXV0ZVZvbHVtZSA9IHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnICYmIHRoaXMuX3NvdW5kKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9tdXRlVm9sdW1lID0gdGhpcy5fc291bmQudm9sdW1lOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwoKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gdGhpcy5fbXV0ZVZvbHVtZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHRoaXMuX211dGVWb2x1bWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMub25NdXRlLmRpc3BhdGNoKHRoaXMpOwoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI3ZvbHVtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2b2x1bWUgLSBHZXRzIG9yIHNldHMgdGhlIHZvbHVtZSBvZiB0aGlzIHNvdW5kLCBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZC5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3ZvbHVtZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnICYmIHRoaXMuX3NvdW5kKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIENhdXNlcyBhbiBJbmRleCBzaXplIGVycm9yIGluIEZpcmVmb3ggaWYgeW91IGRvbid0IGNsYW1wIHRoZSB2YWx1ZQogICAgICAgICAgICBpZiAodmFsdWUgPj0gMCAmJiB2YWx1ZSA8PSAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl92b2x1bWUgPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBTb3VuZCBNYW5hZ2VyIGNvbnN0cnVjdG9yLgoqIFRoZSBTb3VuZCBNYW5hZ2VyIGlzIHJlc3BvbnNpYmxlIGZvciBwbGF5aW5nIGJhY2sgYXVkaW8gdmlhIGVpdGhlciB0aGUgTGVnYWN5IEhUTUwgQXVkaW8gdGFnIG9yIHZpYSBXZWIgQXVkaW8gaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgaXQuCiogTm90ZTogT24gRmlyZWZveCAyNSsgb24gTGludXggaWYgeW91IGhhdmUgbWVkaWEuZ3N0cmVhbWVyIGRpc2FibGVkIGluIGFib3V0OmNvbmZpZyB0aGVuIGl0IGNhbm5vdCBwbGF5IGJhY2sgbXAzIG9yIG00YSBmaWxlcy4KKgoqIEBjbGFzcyBQaGFzZXIuU291bmRNYW5hZ2VyCiogQGNsYXNzZGVzYyBQaGFzZXIgU291bmQgTWFuYWdlci4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuU291bmRNYW5hZ2VyID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgkKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uU291bmREZWNvZGUgLSBEZXNjcmlwdGlvbi4KCSovCgl0aGlzLm9uU291bmREZWNvZGUgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX211dGVkIC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fbXV0ZWQgPSBmYWxzZTsKICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX3VubG9ja1NvdXJjZSAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdm9sdW1lIC0gVGhlIGdsb2JhbCBhdWRpbyB2b2x1bWUuIEEgdmFsdWUgYmV0d2VlbiAwIChzaWxlbmNlKSBhbmQgMSAoZnVsbCB2b2x1bWUpLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLl92b2x1bWUgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBfc291bmRzIC0gQW4gYXJyYXkgY29udGFpbmluZyBhbGwgdGhlIHNvdW5kcyAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgVGhlIGVtcHR5IGFycmF5LgogICAgKi8KICAgIHRoaXMuX3NvdW5kcyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBjb250ZXh0IC0gRGVzY3JpcHRpb24uIAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29udGV4dCA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nV2ViQXVkaW8gLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSB0cnVlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB1c2luZ0F1ZGlvVGFnIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy51c2luZ0F1ZGlvVGFnID0gZmFsc2U7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IG5vQXVkaW8gLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLm5vQXVkaW8gPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB0b3VjaExvY2tlZCAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGNoYW5uZWxzIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jaGFubmVscyA9IDMyOwoJCn07CgpQaGFzZXIuU291bmRNYW5hZ2VyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSW5pdGlhbGlzZXMgdGhlIHNvdW5kIG1hbmFnZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNib290CiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlPUyAmJiB0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGFubmVscyA9IDE7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS5pT1MgfHwgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10gJiYgd2luZG93WydQaGFzZXJHbG9iYWwnXS5mYWtlaU9TVG91Y2hMb2NrKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2gudG91Y2hTdGFydENhbGxiYWNrID0gdGhpcy51bmxvY2s7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5jYWxsYmFja0NvbnRleHQgPSB0aGlzOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UubW91c2VEb3duQ2FsbGJhY2sgPSB0aGlzLnVubG9jazsKICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXaGF0IGFib3V0IGlPUzU/CiAgICAgICAgICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIGlmICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIENoZWNrIHRvIHNlZSBpZiBhbGwgYXVkaW8gcGxheWJhY2sgaXMgZGlzYWJsZWQgKGkuZS4gaGFuZGxlZCBieSBhIDNyZCBwYXJ0eSBjbGFzcykKICAgICAgICAgICAgaWYgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZGlzYWJsZUF1ZGlvID09IHRydWUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IGZhbHNlOwogICAgICAgICAgICAgICAgdGhpcy5ub0F1ZGlvID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIENoZWNrIGlmIHRoZSBXZWIgQXVkaW8gQVBJIGlzIGRpc2FibGVkIChmb3IgdGVzdGluZyBBdWRpbyBUYWcgcGxheWJhY2sgZHVyaW5nIGRldmVsb3BtZW50KQogICAgICAgICAgICBpZiAod2luZG93WydQaGFzZXJHbG9iYWwnXS5kaXNhYmxlV2ViQXVkaW8gPT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5ub0F1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghIXdpbmRvd1snQXVkaW9Db250ZXh0J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgd2luZG93WydBdWRpb0NvbnRleHQnXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghIXdpbmRvd1snd2Via2l0QXVkaW9Db250ZXh0J10pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQgPSBuZXcgd2luZG93Wyd3ZWJraXRBdWRpb0NvbnRleHQnXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICghIXdpbmRvd1snQXVkaW8nXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5ub0F1ZGlvID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuY29udGV4dC5jcmVhdGVHYWluID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW5Ob2RlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4gPSB0aGlzLmNvbnRleHQuY3JlYXRlR2FpbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZSA9IDE7CiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5jb25uZWN0KHRoaXMuY29udGV4dC5kZXN0aW5hdGlvbik7CiAgICAgICAgfQoKCiAgICB9LAoKICAgIC8qKgogICAgKiBFbmFibGVzIHRoZSBhdWRpbywgdXN1YWxseSBhZnRlciB0aGUgZmlyc3QgdG91Y2guCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciN1bmxvY2sKICAgICovCiAgICB1bmxvY2s6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hMb2NrZWQgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgR2xvYmFsIG92ZXJyaWRlIChtb3N0bHkgZm9yIEF1ZGlvIFRhZyB0ZXN0aW5nKQogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvID09IGZhbHNlIHx8ICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddICYmIHdpbmRvd1snUGhhc2VyR2xvYmFsJ10uZGlzYWJsZVdlYkF1ZGlvID09IHRydWUpKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIENyZWF0ZSBhbiBBdWRpbyB0YWc/CiAgICAgICAgICAgIHRoaXMudG91Y2hMb2NrZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC50b3VjaFN0YXJ0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UuY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlLm1vdXNlRG93bkNhbGxiYWNrID0gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gQ3JlYXRlIGVtcHR5IGJ1ZmZlciBhbmQgcGxheSBpdAogICAgICAgICAgICB2YXIgYnVmZmVyID0gdGhpcy5jb250ZXh0LmNyZWF0ZUJ1ZmZlcigxLCAxLCAyMjA1MCk7CiAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlLmJ1ZmZlciA9IGJ1ZmZlcjsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlLmNvbm5lY3QodGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlLm5vdGVPbigwKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgYWxsIHRoZSBzb3VuZHMgaW4gdGhlIGdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNzdG9wQWxsCiAgICAqLwogICAgc3RvcEFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUGF1c2VzIGFsbCB0aGUgc291bmRzIGluIHRoZSBnYW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjcGF1c2VBbGwKICAgICovCiAgICBwYXVzZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5wYXVzZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIHJlc3VtZXMgZXZlcnkgc291bmQgaW4gdGhlIGdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNyZXN1bWVBbGwKICAgICovCiAgICByZXN1bWVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0ucmVzdW1lKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgIAoJfSwKCgkvKioKICAgICogRGVjb2RlIGEgc291bmQgYnkgaXRzIGFzc2V0cyBrZXkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNkZWNvZGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0cyBrZXkgb2YgdGhlIHNvdW5kIHRvIGJlIGRlY29kZWQuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbc291bmRdIC0gSXRzIGJ1ZmZlciB3aWxsIGJlIHNldCB0byBkZWNvZGVkIGRhdGEuCiAgICAqLwogICAgZGVjb2RlOiBmdW5jdGlvbiAoa2V5LCBzb3VuZCkgewoKICAgICAgICBzb3VuZCA9IHNvdW5kIHx8IG51bGw7CgogICAgICAgIHZhciBzb3VuZERhdGEgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKGtleSk7CgogICAgICAgIGlmIChzb3VuZERhdGEpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmlzU291bmREZWNvZGVkKGtleSkgPT09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUudXBkYXRlU291bmQoa2V5LCAnaXNEZWNvZGluZycsIHRydWUpOwoKICAgICAgICAgICAgICAgIHZhciB0aGF0ID0gdGhpczsKCiAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHQuZGVjb2RlQXVkaW9EYXRhKHNvdW5kRGF0YSwgZnVuY3Rpb24gKGJ1ZmZlcikgewogICAgICAgICAgICAgICAgICAgIHRoYXQuZ2FtZS5jYWNoZS5kZWNvZGVkU291bmQoa2V5LCBidWZmZXIpOwogICAgICAgICAgICAgICAgICAgIGlmIChzb3VuZCkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoYXQub25Tb3VuZERlY29kZS5kaXNwYXRjaChzb3VuZCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVXBkYXRlcyBldmVyeSBzb3VuZCBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy50b3VjaExvY2tlZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLndlYkF1ZGlvICYmIHRoaXMuX3VubG9ja1NvdXJjZSAhPT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKCh0aGlzLl91bmxvY2tTb3VyY2UucGxheWJhY2tTdGF0ZSA9PT0gdGhpcy5fdW5sb2NrU291cmNlLlBMQVlJTkdfU1RBVEUgfHwgdGhpcy5fdW5sb2NrU291cmNlLnBsYXliYWNrU3RhdGUgPT09IHRoaXMuX3VubG9ja1NvdXJjZS5GSU5JU0hFRF9TVEFURSkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3VubG9ja1NvdXJjZSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnVwZGF0ZSgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIGEgbmV3IFNvdW5kIGludG8gdGhlIFNvdW5kTWFuYWdlci4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2FkZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gRGVmYXVsdCB2YWx1ZSBmb3IgdGhlIHZvbHVtZS4KICAgICogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBXaGV0aGVyIG9yIG5vdCB0aGUgc291bmQgd2lsbCBsb29wLgogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGtleSwgdm9sdW1lLCBsb29wKSB7CgogICAgCXZvbHVtZSA9IHZvbHVtZSB8fCAxOwogICAgCWlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAgICAgdmFyIHNvdW5kID0gbmV3IFBoYXNlci5Tb3VuZCh0aGlzLmdhbWUsIGtleSwgdm9sdW1lLCBsb29wKTsKCiAgICAgICAgdGhpcy5fc291bmRzLnB1c2goc291bmQpOwoKICAgICAgICByZXR1cm4gc291bmQ7CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZE1hbmFnZXIjbXV0ZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbXV0ZSAtIEdldHMgb3Igc2V0cyB0aGUgbXV0ZWQgc3RhdGUgb2YgdGhlIFNvdW5kTWFuYWdlci4gVGhpcyBlZmZlY3RzIGFsbCBzb3VuZHMgaW4gdGhlIGdhbWUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU291bmRNYW5hZ2VyLnByb3RvdHlwZSwgIm11dGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLl9tdXRlZDsKCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdmFsdWUgfHwgbnVsbDsKCiAgICAgICAgaWYgKHZhbHVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX211dGVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX211dGVkID0gdHJ1ZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX211dGVWb2x1bWUgPSB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIExvb3AgdGhyb3VnaCBzb3VuZHMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0udXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0ubXV0ZSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX211dGVkID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX211dGVkID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4uZ2Fpbi52YWx1ZSA9IHRoaXMuX211dGVWb2x1bWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBMb29wIHRocm91Z2ggc291bmRzCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLm11dGUgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kTWFuYWdlciN2b2x1bWUKKiBAcHJvcGVydHkge251bWJlcn0gdm9sdW1lIC0gR2V0cyBvciBzZXRzIHRoZSBnbG9iYWwgdm9sdW1lIG9mIHRoZSBTb3VuZE1hbmFnZXIsIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kTWFuYWdlci5wcm90b3R5cGUsICJ2b2x1bWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdm9sdW1lOwogICAgICAgIH0KCiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhbHVlID0gdGhpcy5nYW1lLm1hdGguY2xhbXAodmFsdWUsIDEsIDApOwoKICAgICAgICB0aGlzLl92b2x1bWUgPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQoKICAgICAgICAvLyAgTG9vcCB0aHJvdWdoIHRoZSBzb3VuZCBjYWNoZSBhbmQgY2hhbmdlIHRoZSB2b2x1bWUgb2YgYWxsIGh0bWwgYXVkaW8gdGFncwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXS51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0udm9sdW1lID0gdGhpcy5fc291bmRzW2ldLnZvbHVtZSAqIHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWV0aG9kcyBmb3IgZGlzcGxheWluZyBkZWJ1ZyBpbmZvcm1hdGlvbiBhYm91dCBnYW1lIG9iamVjdHMuIFBoYXNlci5EZWJ1ZyByZXF1aXJlcyBhIENBTlZBUyBnYW1lIHR5cGUgaW4gb3JkZXIgdG8gcmVuZGVyLCBzbyBpZiB5b3UndmUgZ290CiogeW91ciBnYW1lIHNldCB0byB1c2UgUGhhc2VyLkFVVE8gdGhlbiBzd2FwIGl0IGZvciBQaGFzZXIuQ0FOVkFTIHRvIGVuc3VyZSBXZWJHTCBkb2Vzbid0IGtpY2sgaW4sIHRoZW4gdGhlIERlYnVnIGZ1bmN0aW9ucyB3aWxsIGFsbCBkaXNwbGF5LgoqCiogQGNsYXNzIFBoYXNlci5VdGlscy5EZWJ1ZwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlV0aWxzLkRlYnVnID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgoJKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgCgkvKioKCSogQHByb3BlcnR5IHtDb250ZXh0fSBjb250ZXh0IC0gVGhlIGNhbnZhcyBjb250ZXh0IG9uIHdoaWNoIHRvIHJlbmRlciB0aGUgZGVidWcgaW5mb3JtYXRpb24uCgkqLwogICAgdGhpcy5jb250ZXh0ID0gZ2FtZS5jb250ZXh0OwoKCS8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gZm9udCAtIFRoZSBmb250IHRoYXQgdGhlIGRlYnVnIGluZm9ybWF0aW9uIGlzIHJlbmRlcmVkIGluLgoJKiBAZGVmYXVsdCAnMTRweCBDb3VyaWVyJwoJKi8KICAgIHRoaXMuZm9udCA9ICcxNHB4IENvdXJpZXInOwogICAKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gbGluZUhlaWdodCAtIFRoZSBsaW5lIGhlaWdodCBiZXR3ZWVuIHRoZSBkZWJ1ZyB0ZXh0LgoJKi8KICAgIHRoaXMubGluZUhlaWdodCA9IDE2OwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSByZW5kZXJTaGFkb3cgLSBTaG91bGQgdGhlIHRleHQgYmUgcmVuZGVyZWQgd2l0aCBhIHNsaWdodCBzaGFkb3c/IE1ha2VzIGl0IGVhc2llciB0byByZWFkIG9uIGRpZmZlcmVudCB0eXBlcyBvZiBiYWNrZ3JvdW5kLgoJKi8KICAgIHRoaXMucmVuZGVyU2hhZG93ID0gdHJ1ZTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Q29udGV4dH0gY3VycmVudFggLSBUaGUgY3VycmVudCBYIHBvc2l0aW9uIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiB3aWxsIGJlIHJlbmRlcmVkIGF0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY3VycmVudFggPSAwOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRZIC0gVGhlIGN1cnJlbnQgWSBwb3NpdGlvbiB0aGUgZGVidWcgaW5mb3JtYXRpb24gd2lsbCBiZSByZW5kZXJlZCBhdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmN1cnJlbnRZID0gMDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50QWxwaGEgLSBUaGUgY3VycmVudCBhbHBoYSB0aGUgZGVidWcgaW5mb3JtYXRpb24gd2lsbCBiZSByZW5kZXJlZCBhdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmN1cnJlbnRBbHBoYSA9IDE7Cgp9OwoKUGhhc2VyLlV0aWxzLkRlYnVnLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgcmVzZXRzIGFuZCBzdGFydHMgdGhlIGRlYnVnIG91dHB1dCB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3N0YXJ0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gVGhlIGNvbG9yIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgZHJhd24gaW4uCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICh4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHggIT09ICdudW1iZXInKSB7IHggPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5ICE9PSAnbnVtYmVyJykgeyB5ID0gMDsgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5jdXJyZW50WCA9IHg7CiAgICAgICAgdGhpcy5jdXJyZW50WSA9IHk7CiAgICAgICAgdGhpcy5jdXJyZW50Q29sb3IgPSBjb2xvcjsKICAgICAgICB0aGlzLmN1cnJlbnRBbHBoYSA9IHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYTsKCiAgICAgICAgdGhpcy5jb250ZXh0LnNhdmUoKTsKICAgICAgICB0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZm9udCA9IHRoaXMuZm9udDsKICAgICAgICB0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSAxOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IHN0b3BzIHRoZSBkZWJ1ZyBvdXRwdXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgoKICAgICAgICB0aGlzLmNvbnRleHQucmVzdG9yZSgpOwogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IHRoaXMuY3VycmVudEFscGhhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZCB0aGF0IG91dHB1dHMgYSBzaW5nbGUgbGluZSBvZiB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNsaW5lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGxpbmUgb2YgdGV4dCB0byBkcmF3LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSB2YWx1ZSB0aGUgZGVidWcgaW5mbyB3aWxsIHN0YXJ0IGZyb20uCiAgICAqLwogICAgbGluZTogZnVuY3Rpb24gKHRleHQsIHgsIHkpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgeCA9IHggfHwgbnVsbDsKICAgICAgICB5ID0geSB8fCBudWxsOwoKICAgICAgICBpZiAoeCAhPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRYID0geDsKICAgICAgICB9CgogICAgICAgIGlmICh5ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFkgPSB5OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucmVuZGVyU2hhZG93KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9ICdyZ2IoMCwwLDApJzsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KHRleHQsIHRoaXMuY3VycmVudFggKyAxLCB0aGlzLmN1cnJlbnRZICsgMSk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLmN1cnJlbnRDb2xvcjsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGV4dC5maWxsVGV4dCh0ZXh0LCB0aGlzLmN1cnJlbnRYLCB0aGlzLmN1cnJlbnRZKTsKICAgICAgICB0aGlzLmN1cnJlbnRZICs9IHRoaXMubGluZUhlaWdodDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBWaXN1YWxseSByZW5kZXJzIGEgUXVhZFRyZWUgdG8gdGhlIGRpc3BsYXkuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclF1YWRUcmVlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlF1YWRUcmVlfSBxdWFkdHJlZSAtIFRoZSBxdWFkdHJlZSB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIFRoZSBjb2xvciBvZiB0aGUgbGluZXMgaW4gdGhlIHF1YWR0cmVlLgogICAgKi8KICAgIHJlbmRlclF1YWRUcmVlOiBmdW5jdGlvbiAocXVhZHRyZWUsIGNvbG9yKSB7CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMjU1LDAsMCwwLjMpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwoKICAgICAgICB2YXIgYm91bmRzID0gcXVhZHRyZWUuYm91bmRzOwoKICAgICAgICBpZiAocXVhZHRyZWUubm9kZXMubGVuZ3RoID09PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KGJvdW5kcy54LCBib3VuZHMueSwgYm91bmRzLndpZHRoLCBib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5yZW5kZXJUZXh0KHF1YWR0cmVlLklEICsgJyAvICcgKyBxdWFkdHJlZS5vYmplY3RzLmxlbmd0aCwgYm91bmRzLnggKyA0LCBib3VuZHMueSArIDE2LCAncmdiKDAsMjAwLDApJywgJzEycHggQ291cmllcicpOwoKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJ3JnYigwLDI1NSwwKSc7CgogICAgICAgICAgICAvLyBjaGlsZHJlbgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1YWR0cmVlLm9iamVjdHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHF1YWR0cmVlLm9iamVjdHNbaV0ueCwgcXVhZHRyZWUub2JqZWN0c1tpXS55LCBxdWFkdHJlZS5vYmplY3RzW2ldLndpZHRoLCBxdWFkdHJlZS5vYmplY3RzW2ldLmhlaWdodCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBxdWFkdHJlZS5ub2Rlcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJRdWFkVHJlZShxdWFkdHJlZS5ub2Rlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW5kZXJzIHRoZSBjb3JuZXJzIGFuZCBwb2ludCBpbmZvcm1hdGlvbiBvZiB0aGUgZ2l2ZW4gU3ByaXRlLgogICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlQ29ybmVycwogICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRvIGJlIHJlbmRlcmVkLgogICAgICogQHBhcmFtIHtib29sZWFufSBbc2hvd1RleHQ9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgeC95IGNvb3JkaW5hdGVzIG9mIGVhY2ggcG9pbnQgd2lsbCBiZSByZW5kZXJlZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Nob3dCb3VuZHM9ZmFsc2VdIC0gSWYgdHJ1ZSB0aGUgYm91bmRzIHdpbGwgYmUgcmVuZGVyZWQgb3ZlciB0aGUgdG9wIG9mIHRoZSBzcHJpdGUuCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDAsMjU1KSddIC0gVGhlIGNvbG9yIHRoZSB0ZXh0IGlzIHJlbmRlcmVkIGluLgogICAgICovCiAgICByZW5kZXJTcHJpdGVDb3JuZXJzOiBmdW5jdGlvbiAoc3ByaXRlLCBzaG93VGV4dCwgc2hvd0JvdW5kcywgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc2hvd1RleHQgPSBzaG93VGV4dCB8fCBmYWxzZTsKICAgICAgICBzaG93Qm91bmRzID0gc2hvd0JvdW5kcyB8fCBmYWxzZTsKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CgogICAgICAgIGlmIChzaG93Qm91bmRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiYSgwLCAyNTUsIDAsIDAuNyknOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdChzcHJpdGUuYm91bmRzLngsIHNwcml0ZS5ib3VuZHMueSwgc3ByaXRlLmJvdW5kcy53aWR0aCwgc3ByaXRlLmJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHNwcml0ZS50b3BMZWZ0LngsIHNwcml0ZS50b3BMZWZ0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oc3ByaXRlLnRvcFJpZ2h0LngsIHNwcml0ZS50b3BSaWdodC55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHNwcml0ZS5ib3R0b21SaWdodC54LCBzcHJpdGUuYm90dG9tUmlnaHQueSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyhzcHJpdGUuYm90dG9tTGVmdC54LCBzcHJpdGUuYm90dG9tTGVmdC55KTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVN0eWxlID0gJ3JnYmEoMjU1LCAwLCAyNTUsIDAuNyknOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKCiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUub2Zmc2V0KTsKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS5jZW50ZXIpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLnRvcExlZnQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLnRvcFJpZ2h0KTsKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS5ib3R0b21MZWZ0KTsKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS5ib3R0b21SaWdodCk7CgogICAgICAgIGlmIChzaG93VGV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudENvbG9yID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMubGluZSgneDogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcExlZnQueCkgKyAnIHk6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS50b3BMZWZ0LnkpLCBzcHJpdGUudG9wTGVmdC54LCBzcHJpdGUudG9wTGVmdC55KTsKICAgICAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgTWF0aC5mbG9vcihzcHJpdGUudG9wUmlnaHQueCkgKyAnIHk6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS50b3BSaWdodC55KSwgc3ByaXRlLnRvcFJpZ2h0LngsIHNwcml0ZS50b3BSaWdodC55KTsKICAgICAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tTGVmdC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLmJvdHRvbUxlZnQueSksIHNwcml0ZS5ib3R0b21MZWZ0LngsIHNwcml0ZS5ib3R0b21MZWZ0LnkpOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS5ib3R0b21SaWdodC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLmJvdHRvbVJpZ2h0LnkpLCBzcHJpdGUuYm90dG9tUmlnaHQueCwgc3ByaXRlLmJvdHRvbVJpZ2h0LnkpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIFNvdW5kIGluZm9ybWF0aW9uLCBpbmNsdWRpbmcgZGVjb2RlZCBzdGF0ZSwgZHVyYXRpb24sIHZvbHVtZSBhbmQgbW9yZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU291bmRJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBzb3VuZCBvYmplY3QgdG8gZGVidWcuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJTb3VuZEluZm86IGZ1bmN0aW9uIChzb3VuZCwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnU291bmQ6ICcgKyBzb3VuZC5rZXkgKyAnIExvY2tlZDogJyArIHNvdW5kLmdhbWUuc291bmQudG91Y2hMb2NrZWQpOwogICAgICAgIHRoaXMubGluZSgnSXMgUmVhZHk/OiAnICsgdGhpcy5nYW1lLmNhY2hlLmlzU291bmRSZWFkeShzb3VuZC5rZXkpICsgJyBQZW5kaW5nIFBsYXliYWNrOiAnICsgc291bmQucGVuZGluZ1BsYXliYWNrKTsKICAgICAgICB0aGlzLmxpbmUoJ0RlY29kZWQ6ICcgKyBzb3VuZC5pc0RlY29kZWQgKyAnIERlY29kaW5nOiAnICsgc291bmQuaXNEZWNvZGluZyk7CiAgICAgICAgdGhpcy5saW5lKCdUb3RhbCBEdXJhdGlvbjogJyArIHNvdW5kLnRvdGFsRHVyYXRpb24gKyAnIFBsYXlpbmc6ICcgKyBzb3VuZC5pc1BsYXlpbmcpOwogICAgICAgIHRoaXMubGluZSgnVGltZTogJyArIHNvdW5kLmN1cnJlbnRUaW1lKTsKICAgICAgICB0aGlzLmxpbmUoJ1ZvbHVtZTogJyArIHNvdW5kLnZvbHVtZSArICcgTXV0ZWQ6ICcgKyBzb3VuZC5tdXRlKTsKICAgICAgICB0aGlzLmxpbmUoJ1dlYkF1ZGlvOiAnICsgc291bmQudXNpbmdXZWJBdWRpbyArICcgQXVkaW86ICcgKyBzb3VuZC51c2luZ0F1ZGlvVGFnKTsKCiAgICAgICAgaWYgKHNvdW5kLmN1cnJlbnRNYXJrZXIgIT09ICcnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5saW5lKCdNYXJrZXI6ICcgKyBzb3VuZC5jdXJyZW50TWFya2VyICsgJyBEdXJhdGlvbjogJyArIHNvdW5kLmR1cmF0aW9uKTsKICAgICAgICAgICAgdGhpcy5saW5lKCdTdGFydDogJyArIHNvdW5kLm1hcmtlcnNbc291bmQuY3VycmVudE1hcmtlcl0uc3RhcnQgKyAnIFN0b3A6ICcgKyBzb3VuZC5tYXJrZXJzW3NvdW5kLmN1cnJlbnRNYXJrZXJdLnN0b3ApOwogICAgICAgICAgICB0aGlzLmxpbmUoJ1Bvc2l0aW9uOiAnICsgc291bmQucG9zaXRpb24pOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGNhbWVyYSBpbmZvcm1hdGlvbiBpbmNsdWRpbmcgZGltZW5zaW9ucyBhbmQgbG9jYXRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckNhbWVyYUluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuQ2FtZXJhfSBjYW1lcmEgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckNhbWVyYUluZm86IGZ1bmN0aW9uIChjYW1lcmEsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ0NhbWVyYSAoJyArIGNhbWVyYS53aWR0aCArICcgeCAnICsgY2FtZXJhLmhlaWdodCArICcpJyk7CiAgICAgICAgdGhpcy5saW5lKCdYOiAnICsgY2FtZXJhLnggKyAnIFk6ICcgKyBjYW1lcmEueSk7CiAgICAgICAgdGhpcy5saW5lKCdCb3VuZHMgeDogJyArIGNhbWVyYS5ib3VuZHMueCArICcgWTogJyArIGNhbWVyYS5ib3VuZHMueSArICcgdzogJyArIGNhbWVyYS5ib3VuZHMud2lkdGggKyAnIGg6ICcgKyBjYW1lcmEuYm91bmRzLmhlaWdodCk7CiAgICAgICAgdGhpcy5saW5lKCdWaWV3IHg6ICcgKyBjYW1lcmEudmlldy54ICsgJyBZOiAnICsgY2FtZXJhLnZpZXcueSArICcgdzogJyArIGNhbWVyYS52aWV3LndpZHRoICsgJyBoOiAnICsgY2FtZXJhLnZpZXcuaGVpZ2h0KTsKICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgdGhlIFBvaW50ZXIuY2lyY2xlIG9iamVjdCBvbnRvIHRoZSBzdGFnZSBpbiBncmVlbiBpZiBkb3duIG9yIHJlZCBpZiB1cCBhbG9uZyB3aXRoIGRlYnVnIHRleHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckRlYnVnCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtib29sZWFufSBbaGlkZUlmVXA9ZmFsc2VdIC0gRG9lc24ndCByZW5kZXIgdGhlIGNpcmNsZSBpZiB0aGUgcG9pbnRlciBpcyB1cC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtkb3duQ29sb3I9J3JnYmEoMCwyNTUsMCwwLjUpJ10gLSBUaGUgY29sb3IgdGhlIGNpcmNsZSBpcyByZW5kZXJlZCBpbiBpZiBkb3duLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW3VwQ29sb3I9J3JnYmEoMjU1LDAsMCwwLjUpJ10gLSBUaGUgY29sb3IgdGhlIGNpcmNsZSBpcyByZW5kZXJlZCBpbiBpZiB1cCAoYW5kIGhpZGVJZlVwIGlzIGZhbHNlKS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyUG9pbnRlcjogZnVuY3Rpb24gKHBvaW50ZXIsIGhpZGVJZlVwLCBkb3duQ29sb3IsIHVwQ29sb3IsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCB8fCBwb2ludGVyID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGhpZGVJZlVwID09PSAndW5kZWZpbmVkJykgeyBoaWRlSWZVcCA9IGZhbHNlOyB9CiAgICAgICAgZG93bkNvbG9yID0gZG93bkNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC41KSc7CiAgICAgICAgdXBDb2xvciA9IHVwQ29sb3IgfHwgJ3JnYmEoMjU1LDAsMCwwLjUpJzsKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgaWYgKGhpZGVJZlVwID09IHRydWUgJiYgcG9pbnRlci5pc1VwID09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0YXJ0KHBvaW50ZXIueCwgcG9pbnRlci55IC0gMTAwLCBjb2xvcik7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5hcmMocG9pbnRlci54LCBwb2ludGVyLnksIHBvaW50ZXIuY2lyY2xlLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIpOwoKICAgICAgICBpZiAocG9pbnRlci5hY3RpdmUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gZG93bkNvbG9yOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gdXBDb2xvcjsKICAgICAgICB9CgogICAgICAgIHRoaXMuY29udGV4dC5maWxsKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwoKICAgICAgICAvLyAgUmVuZGVyIHRoZSBwb2ludHMKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0Lm1vdmVUbyhwb2ludGVyLnBvc2l0aW9uRG93bi54LCBwb2ludGVyLnBvc2l0aW9uRG93bi55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHBvaW50ZXIucG9zaXRpb24ueCwgcG9pbnRlci5wb3NpdGlvbi55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVdpZHRoID0gMjsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwoKICAgICAgICAvLyAgUmVuZGVyIHRoZSB0ZXh0CiAgICAgICAgLy8gdGhpcy5zdGFydChwb2ludGVyLngsIHBvaW50ZXIueSAtIDEwMCwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnSUQ6ICcgKyBwb2ludGVyLmlkICsgIiBBY3RpdmU6ICIgKyBwb2ludGVyLmFjdGl2ZSk7CiAgICAgICAgdGhpcy5saW5lKCdXb3JsZCBYOiAnICsgcG9pbnRlci53b3JsZFggKyAiIFdvcmxkIFk6ICIgKyBwb2ludGVyLndvcmxkWSk7CiAgICAgICAgdGhpcy5saW5lKCdTY3JlZW4gWDogJyArIHBvaW50ZXIueCArICIgU2NyZWVuIFk6ICIgKyBwb2ludGVyLnkpOwogICAgICAgIHRoaXMubGluZSgnRHVyYXRpb246ICcgKyBwb2ludGVyLmR1cmF0aW9uICsgIiBtcyIpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBTcHJpdGUgSW5wdXQgRGVidWcgaW5mb3JtYXRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUlucHV0SW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovICAgIAogICAgcmVuZGVyU3ByaXRlSW5wdXRJbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdTcHJpdGUgSW5wdXQ6ICgnICsgc3ByaXRlLndpZHRoICsgJyB4ICcgKyBzcHJpdGUuaGVpZ2h0ICsgJyknKTsKICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlclgoKS50b0ZpeGVkKDEpICsgJyB5OiAnICsgc3ByaXRlLmlucHV0LnBvaW50ZXJZKCkudG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5saW5lKCdvdmVyOiAnICsgc3ByaXRlLmlucHV0LnBvaW50ZXJPdmVyKCkgKyAnIGR1cmF0aW9uOiAnICsgc3ByaXRlLmlucHV0Lm92ZXJEdXJhdGlvbigpLnRvRml4ZWQoMCkpOwogICAgICAgIHRoaXMubGluZSgnZG93bjogJyArIHNwcml0ZS5pbnB1dC5wb2ludGVyRG93bigpICsgJyBkdXJhdGlvbjogJyArIHNwcml0ZS5pbnB1dC5kb3duRHVyYXRpb24oKS50b0ZpeGVkKDApKTsKICAgICAgICB0aGlzLmxpbmUoJ2p1c3Qgb3ZlcjogJyArIHNwcml0ZS5pbnB1dC5qdXN0T3ZlcigpICsgJyBqdXN0IG91dDogJyArIHNwcml0ZS5pbnB1dC5qdXN0T3V0KCkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW5kZXIgU3ByaXRlIGNvbGxpc2lvbi4KICAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUNvbGxpc2lvbgogICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRvIGJlIHJlbmRlcmVkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICAqLyAKICAgIHJlbmRlclNwcml0ZUNvbGxpc2lvbjogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnU3ByaXRlIENvbGxpc2lvbjogKCcgKyBzcHJpdGUud2lkdGggKyAnIHggJyArIHNwcml0ZS5oZWlnaHQgKyAnKScpOwogICAgICAgIHRoaXMubGluZSgnbGVmdDogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLmxlZnQpOwogICAgICAgIHRoaXMubGluZSgncmlnaHQ6ICcgKyBzcHJpdGUuYm9keS50b3VjaGluZy5yaWdodCk7CiAgICAgICAgdGhpcy5saW5lKCd1cDogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLnVwKTsKICAgICAgICB0aGlzLmxpbmUoJ2Rvd246ICcgKyBzcHJpdGUuYm9keS50b3VjaGluZy5kb3duKTsKICAgICAgICB0aGlzLmxpbmUoJ3ZlbG9jaXR5Lng6ICcgKyBzcHJpdGUuYm9keS52ZWxvY2l0eS54KTsKICAgICAgICB0aGlzLmxpbmUoJ3ZlbG9jaXR5Lnk6ICcgKyBzcHJpdGUuYm9keS52ZWxvY2l0eS55KTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgZGVidWcgaW5mb3JtYXRpb24gYWJvdXQgdGhlIElucHV0IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVySW5wdXRJbmZvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJJbnB1dEluZm86IGZ1bmN0aW9uICh4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwwKSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnSW5wdXQnKTsKICAgICAgICB0aGlzLmxpbmUoJ1g6ICcgKyB0aGlzLmdhbWUuaW5wdXQueCArICcgWTogJyArIHRoaXMuZ2FtZS5pbnB1dC55KTsKICAgICAgICB0aGlzLmxpbmUoJ1dvcmxkIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQud29ybGRYICsgJyBXb3JsZCBZOiAnICsgdGhpcy5nYW1lLmlucHV0LndvcmxkWSk7CiAgICAgICAgdGhpcy5saW5lKCdTY2FsZSBYOiAnICsgdGhpcy5nYW1lLmlucHV0LnNjYWxlLngudG9GaXhlZCgxKSArICcgU2NhbGUgWTogJyArIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS54LnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgnU2NyZWVuIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlci5zY3JlZW5YICsgJyBTY3JlZW4gWTogJyArIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyLnNjcmVlblkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBkZWJ1ZyBpbmZvcyAoaW5jbHVkaW5nIG5hbWUsIGJvdW5kcyBpbmZvLCBwb3NpdGlvbiBhbmQgc29tZSBvdGhlciBwcm9wZXJ0aWVzKSBhYm91dCB0aGUgU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJTcHJpdGVJbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKCiAgICAgICAgdGhpcy5saW5lKCdTcHJpdGU6ICcgKyAnICgnICsgc3ByaXRlLndpZHRoICsgJyB4ICcgKyBzcHJpdGUuaGVpZ2h0ICsgJykgYW5jaG9yOiAnICsgc3ByaXRlLmFuY2hvci54ICsgJyB4ICcgKyBzcHJpdGUuYW5jaG9yLnkpOwogICAgICAgIHRoaXMubGluZSgneDogJyArIHNwcml0ZS54LnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUueS50b0ZpeGVkKDEpKTsKICAgICAgICB0aGlzLmxpbmUoJ2FuZ2xlOiAnICsgc3ByaXRlLmFuZ2xlLnRvRml4ZWQoMSkgKyAnIHJvdGF0aW9uOiAnICsgc3ByaXRlLnJvdGF0aW9uLnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgndmlzaWJsZTogJyArIHNwcml0ZS52aXNpYmxlICsgJyBpbiBjYW1lcmE6ICcgKyBzcHJpdGUuaW5DYW1lcmEpOwogICAgICAgIHRoaXMubGluZSgnYm9keSB4OiAnICsgc3ByaXRlLmJvZHkueC50b0ZpeGVkKDEpICsgJyB5OiAnICsgc3ByaXRlLmJvZHkueS50b0ZpeGVkKDEpKTsKCiAgICAgICAgLy8gIDAgPSBzY2FsZVgKICAgICAgICAvLyAgMSA9IHNrZXdZCiAgICAgICAgLy8gIDIgPSB0cmFuc2xhdGVYCiAgICAgICAgLy8gIDMgPSBza2V3WAogICAgICAgIC8vICA0ID0gc2NhbGVZCiAgICAgICAgLy8gIDUgPSB0cmFuc2xhdGVZCgogICAgICAgIC8vIHRoaXMubGluZSgnaWQ6ICcgKyBzcHJpdGUuX2lkKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3NjYWxlIHg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMF0pOwogICAgICAgIC8vIHRoaXMubGluZSgnc2NhbGUgeTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs0XSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCd0eDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVsyXSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCd0eTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs1XSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCdza2V3IHg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bM10pOwogICAgICAgIC8vIHRoaXMubGluZSgnc2tldyB5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzFdKTsKICAgICAgICB0aGlzLmxpbmUoJ2RlbHRhWDogJyArIHNwcml0ZS5ib2R5LmRlbHRhWCgpKTsKICAgICAgICB0aGlzLmxpbmUoJ2RlbHRhWTogJyArIHNwcml0ZS5ib2R5LmRlbHRhWSgpKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3NkeDogJyArIHNwcml0ZS5kZWx0YVgoKSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCdzZHk6ICcgKyBzcHJpdGUuZGVsdGFZKCkpOwoKICAgICAgICAvLyB0aGlzLmxpbmUoJ2luQ2FtZXJhOiAnICsgdGhpcy5nYW1lLnJlbmRlcmVyLnNwcml0ZVJlbmRlcmVyLmluQ2FtZXJhKHRoaXMuZ2FtZS5jYW1lcmEsIHNwcml0ZSkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciB0aGUgV29ybGQgVHJhbnNmb3JtIGluZm9ybWF0aW9uIG9mIHRoZSBnaXZlbiBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlcldvcmxkVHJhbnNmb3JtSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyV29ybGRUcmFuc2Zvcm1JbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKCiAgICAgICAgdGhpcy5saW5lKCdXb3JsZCBUcmFuc2Zvcm0nKTsKICAgICAgICB0aGlzLmxpbmUoJ3NrZXdYOiAgJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVszXSk7CiAgICAgICAgdGhpcy5saW5lKCdza2V3WTogICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMV0pOwogICAgICAgIHRoaXMubGluZSgnc2NhbGVYOiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzBdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NjYWxlWTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs0XSk7CiAgICAgICAgdGhpcy5saW5lKCd0cmFuc1g6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMl0pOwogICAgICAgIHRoaXMubGluZSgndHJhbnNZOiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzVdKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgdGhlIExvY2FsIFRyYW5zZm9ybSBpbmZvcm1hdGlvbiBvZiB0aGUgZ2l2ZW4gU3ByaXRlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJMb2NhbFRyYW5zZm9ybUluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckxvY2FsVHJhbnNmb3JtSW5mbzogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CgogICAgICAgIHRoaXMubGluZSgnTG9jYWwgVHJhbnNmb3JtJyk7CiAgICAgICAgdGhpcy5saW5lKCdza2V3WDogICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bM10pOwogICAgICAgIHRoaXMubGluZSgnc2tld1k6ICAnICsgc3ByaXRlLmxvY2FsVHJhbnNmb3JtWzFdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NjYWxlWDogJyArIHNwcml0ZS5sb2NhbFRyYW5zZm9ybVswXSk7CiAgICAgICAgdGhpcy5saW5lKCdzY2FsZVk6ICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bNF0pOwogICAgICAgIHRoaXMubGluZSgndHJhbnNYOiAnICsgc3ByaXRlLmxvY2FsVHJhbnNmb3JtWzJdKTsKICAgICAgICB0aGlzLmxpbmUoJ3RyYW5zWTogJyArIHNwcml0ZS5sb2NhbFRyYW5zZm9ybVs1XSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICByZW5kZXJTcHJpdGVDb29yZHM6IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwoKICAgICAgICBpZiAoc3ByaXRlLm5hbWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpbmUoc3ByaXRlLm5hbWUpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgc3ByaXRlLngpOwogICAgICAgIHRoaXMubGluZSgneTogJyArIHNwcml0ZS55KTsKICAgICAgICB0aGlzLmxpbmUoJ3BvcyB4OiAnICsgc3ByaXRlLnBvc2l0aW9uLngpOwogICAgICAgIHRoaXMubGluZSgncG9zIHk6ICcgKyBzcHJpdGUucG9zaXRpb24ueSk7CiAgICAgICAgdGhpcy5saW5lKCdsb2NhbCB4OiAnICsgc3ByaXRlLmxvY2FsVHJhbnNmb3JtWzJdKTsKICAgICAgICB0aGlzLmxpbmUoJ2xvY2FsIHk6ICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bNV0pOwogICAgICAgIHRoaXMubGluZSgndCB4OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzJdKTsKICAgICAgICB0aGlzLmxpbmUoJ3QgeTogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVs1XSk7CiAgICAgICAgdGhpcy5saW5lKCd3b3JsZCB4OiAnICsgc3ByaXRlLndvcmxkLngpOwogICAgICAgIHRoaXMubGluZSgnd29ybGQgeTogJyArIHNwcml0ZS53b3JsZC55KTsKCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICByZW5kZXJHcm91cEluZm86IGZ1bmN0aW9uIChncm91cCwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CgogICAgICAgIHRoaXMubGluZSgnR3JvdXAgKHNpemU6ICcgKyBncm91cC5sZW5ndGggKyAnKScpOwogICAgICAgIHRoaXMubGluZSgneDogJyArIGdyb3VwLngpOwogICAgICAgIHRoaXMubGluZSgneTogJyArIGdyb3VwLnkpOwoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIFBvaW50IGNvb3JkaW5hdGVzIGluIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUG9pbnRJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBvaW50SW5mbzogZnVuY3Rpb24gKHBvaW50LCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ3B4OiAnICsgcG9pbnQueC50b0ZpeGVkKDEpICsgJyBweTogJyArIHBvaW50LnkudG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBqdXN0IHRoZSBTcHJpdGUuYm9keSBib3VuZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUJvZHkKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUJvZHk6IGZ1bmN0aW9uIChzcHJpdGUsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMjU1LDAsMjU1LCAwLjMpJzsKCiAgICAgICAgdGhpcy5zdGFydCgwLCAwLCBjb2xvcik7CgogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3Qoc3ByaXRlLmJvZHkuc2NyZWVuWCwgc3ByaXRlLmJvZHkuc2NyZWVuWSwgc3ByaXRlLmJvZHkud2lkdGgsIHNwcml0ZS5ib2R5LmhlaWdodCk7CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMganVzdCB0aGUgZnVsbCBTcHJpdGUgYm91bmRzLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVCb3VuZHMKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtmaWxsPWZhbHNlXSAtIElmIGZhbHNlIHRoZSBib3VuZHMgb3V0bGluZSBpcyByZW5kZXJlZCwgaWYgdHJ1ZSB0aGUgd2hvbGUgcmVjdGFuZ2xlIGlzIHJlbmRlcmVkLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUJvdW5kczogZnVuY3Rpb24gKHNwcml0ZSwgY29sb3IsIGZpbGwpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwwLDI1NSknOwoKICAgICAgICBpZiAodHlwZW9mIGZpbGwgPT09ICd1bmRlZmluZWQnKSB7IGZpbGwgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgaWYgKGZpbGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChzcHJpdGUuYm91bmRzLngsIHNwcml0ZS5ib3VuZHMueSwgc3ByaXRlLmJvdW5kcy53aWR0aCwgc3ByaXRlLmJvdW5kcy5oZWlnaHQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3Qoc3ByaXRlLmJvdW5kcy54LCBzcHJpdGUuYm91bmRzLnksIHNwcml0ZS5ib3VuZHMud2lkdGgsIHNwcml0ZS5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBhIHNpbmdsZSBwaXhlbC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUGl4ZWwKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQaXhlbDogZnVuY3Rpb24gKHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwxKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHgsIHksIDIsIDIpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBQb2ludCBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclBvaW50CiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBwb2ludCAtIFRoZSBQb2ludCB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQb2ludDogZnVuY3Rpb24gKHBvaW50LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMSknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChwb2ludC54LCBwb2ludC55LCA0LCA0KTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJSZWN0YW5nbGUKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSByZWN0IC0gVGhlIFJlY3RhbmdsZSB0byByZW5kZXIuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJSZWN0YW5nbGU6IGZ1bmN0aW9uIChyZWN0LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC4zKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHJlY3QueCwgcmVjdC55LCByZWN0LndpZHRoLCByZWN0LmhlaWdodCk7CiAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgQ2lyY2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJDaXJjbGUKICAgICogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBjaXJjbGUgLSBUaGUgQ2lyY2xlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlckNpcmNsZTogZnVuY3Rpb24gKGNpcmNsZSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgwLDI1NSwwLDAuMyknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuYXJjKGNpcmNsZS54LCBjaXJjbGUueSwgY2lyY2xlLnJhZGl1cywgMCwgTWF0aC5QSSAqIDIsIGZhbHNlKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbCgpOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgdGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyVGV4dAogICAgKiBAcGFyYW0ge3N0cmluZ30gdGV4dCAtIFRoZSBsaW5lIG9mIHRleHQgdG8gZHJhdy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gQ29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQgKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICogQHBhcmFtIHtzdHJpbmd9IGZvbnQgLSBUaGUgZm9udCBvZiB0ZXh0IHRvIGRyYXcuCiAgICAqLyAgICAKICAgIHJlbmRlclRleHQ6IGZ1bmN0aW9uICh0ZXh0LCB4LCB5LCBjb2xvciwgZm9udCkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKICAgICAgICBmb250ID0gZm9udCB8fCAnMTZweCBDb3VyaWVyJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIHRoaXMuY29udGV4dC5mb250ID0gZm9udDsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KHRleHQsIHgsIHkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIER1bXBzIHRoZSBMaW5rZWQgTGlzdCB0byB0aGUgY29uc29sZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI1BoYXNlci5MaW5rZWRMaXN0I2R1bXAgCiAgICAqIEBwYXJhbSB7UGhhc2VyLkxpbmtlZExpc3R9IGxpc3QgLSBUaGUgTGlua2VkTGlzdCB0byBkdW1wLgogICAgKi8KICAgIGR1bXBMaW5rZWRMaXN0OiBmdW5jdGlvbiAobGlzdCkgewoKICAgICAgICB2YXIgc3BhY2luZyA9IDIwOwoKICAgICAgICB2YXIgb3V0cHV0ID0gIlxuIiArIFBoYXNlci5VdGlscy5wYWQoJ05vZGUnLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJ05leHQnLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJ1ByZXZpb3VzJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCdGaXJzdCcsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnTGFzdCcsIHNwYWNpbmcpOwogICAgICAgIGNvbnNvbGUubG9nKG91dHB1dCk7CgogICAgICAgIHZhciBvdXRwdXQgPSBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCctLS0tLS0tLS0tJywgc3BhY2luZyk7CiAgICAgICAgY29uc29sZS5sb2cob3V0cHV0KTsKCiAgICAgICAgdmFyIGVudGl0eSA9IGxpc3Q7CgogICAgICAgIHZhciB0ZXN0T2JqZWN0ID0gZW50aXR5Lmxhc3QubmV4dDsKICAgICAgICBlbnRpdHkgPSBlbnRpdHkuZmlyc3Q7CiAgICAgICAgCiAgICAgICAgZG8gIAogICAgICAgIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSBlbnRpdHkuc3ByaXRlLm5hbWUgfHwgJyonOwogICAgICAgICAgICB2YXIgbmFtZU5leHQgPSAnLSc7CiAgICAgICAgICAgIHZhciBuYW1lUHJldiA9ICctJzsKICAgICAgICAgICAgdmFyIG5hbWVGaXJzdCA9ICctJzsKICAgICAgICAgICAgdmFyIG5hbWVMYXN0ID0gJy0nOwoKICAgICAgICAgICAgaWYgKGVudGl0eS5uZXh0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lTmV4dCA9IGVudGl0eS5uZXh0LnNwcml0ZS5uYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZW50aXR5LnByZXYpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVQcmV2ID0gZW50aXR5LnByZXYuc3ByaXRlLm5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChlbnRpdHkuZmlyc3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVGaXJzdCA9IGVudGl0eS5maXJzdC5zcHJpdGUubmFtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGVudGl0eS5sYXN0KQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lTGFzdCA9IGVudGl0eS5sYXN0LnNwcml0ZS5uYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWVOZXh0ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZU5leHQgPSAnLSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgbmFtZVByZXYgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lUHJldiA9ICctJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lRmlyc3QgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lRmlyc3QgPSAnLSc7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgbmFtZUxhc3QgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lTGFzdCA9ICctJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG91dHB1dCA9IFBoYXNlci5VdGlscy5wYWQobmFtZSwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVOZXh0LCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQobmFtZVByZXYsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lRmlyc3QsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lTGFzdCwgc3BhY2luZyk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKG91dHB1dCk7CgogICAgICAgICAgICBlbnRpdHkgPSBlbnRpdHkubmV4dDsKCiAgICAgICAgfQogICAgICAgIHdoaWxlKGVudGl0eSAhPSB0ZXN0T2JqZWN0KQoKICAgIH0KCgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBjb2xsZWN0aW9uIG9mIG1ldGhvZHMgdXNlZnVsIGZvciBtYW5pcHVsYXRpbmcgYW5kIGNvbXBhcmluZyBjb2xvcnMuCioKKiBAY2xhc3MgUGhhc2VyLkNvbG9yCiovClBoYXNlci5Db2xvciA9IHsKCiAgICAvKioKICAgICogR2l2ZW4gYW4gYWxwaGEgYW5kIDMgY29sb3IgdmFsdWVzIHRoaXMgd2lsbCByZXR1cm4gYW4gaW50ZWdlciByZXByZXNlbnRhdGlvbiBvZiBpdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Q29sb3IzMgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBBbHBoYSB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIFJlZCBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBncmVlbiAtIFRoZSBHcmVlbiBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBibHVlIC0gVGhlIEJsdWUgY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBBIG5hdGl2ZSBjb2xvciB2YWx1ZSBpbnRlZ2VyIChmb3JtYXQ6IDB4QUFSUkdHQkIpLgogICAgKi8KICAgIGdldENvbG9yMzI6IGZ1bmN0aW9uIChhbHBoYSwgcmVkLCBncmVlbiwgYmx1ZSkgewogICAgICAgIHJldHVybiBhbHBoYSA8PCAyNCB8IHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gMyBjb2xvciB2YWx1ZXMgdGhpcyB3aWxsIHJldHVybiBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIG9mIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvcgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgUmVkIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIEdyZWVuIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgQmx1ZSBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhSUkdHQkIpLgogICAgKi8KICAgIGdldENvbG9yOiBmdW5jdGlvbiAocmVkLCBncmVlbiwgYmx1ZSkgewogICAgICAgIHJldHVybiByZWQgPDwgMTYgfCBncmVlbiA8PCA4IHwgYmx1ZTsKICAgIH0sCgogICAgLyoqCiAgICAqIENvbnZlcnRzIHRoZSBnaXZlbiBoZXggc3RyaW5nIGludG8gYW4gaW50ZWdlciBjb2xvciB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaGV4VG9SR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge3N0cmluZ30gaCAtIFRoZSBzdHJpbmcgaGV4IGNvbG9yIHRvIGNvbnZlcnQuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSByZ2IgY29sb3IgdmFsdWUuCiAgICAqLwogICAgaGV4VG9SR0I6IGZ1bmN0aW9uIChoKSB7CgogICAgICAgIHZhciBoZXgxNiA9IChoLmNoYXJBdCgwKSA9PSAiIyIpID8gaC5zdWJzdHJpbmcoMSwgNykgOiBoOwoKICAgICAgICBpZiAoaGV4MTYubGVuZ3RoPT0zKQogICAgICAgIHsKICAgICAgICAgICAgaGV4MTYgPSBoZXgxNi5jaGFyQXQoMCkgKyBoZXgxNi5jaGFyQXQoMCkgKyBoZXgxNi5jaGFyQXQoMSkgKyBoZXgxNi5jaGFyQXQoMSkgKyBoZXgxNi5jaGFyQXQoMikgKyBoZXgxNi5jaGFyQXQoMik7CiAgICAgICAgfQoKICAgICAgICB2YXIgcmVkID0gcGFyc2VJbnQoaGV4MTYuc3Vic3RyaW5nKDAsIDIpLCAxNik7CiAgICAgICAgdmFyIGdyZWVuID0gcGFyc2VJbnQoaGV4MTYuc3Vic3RyaW5nKDIsIDQpLCAxNik7CiAgICAgICAgdmFyIGJsdWUgPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoNCwgNiksIDE2KTsKCiAgICAgICAgcmV0dXJuIHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHN0cmluZyBjb250YWluaW5nIGhhbmR5IGluZm9ybWF0aW9uIGFib3V0IHRoZSBnaXZlbiBjb2xvciBpbmNsdWRpbmcgc3RyaW5nIGhleCB2YWx1ZSwKICAgICogUkdCIGZvcm1hdCBpbmZvcm1hdGlvbiBhbmQgSFNMIGluZm9ybWF0aW9uLiBFYWNoIHNlY3Rpb24gc3RhcnRzIG9uIGEgbmV3bGluZSwgMyBsaW5lcyBpbiB0b3RhbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Q29sb3JJbmZvCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gQSBjb2xvciB2YWx1ZSBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IFN0cmluZyBjb250YWluaW5nIHRoZSAzIGxpbmVzIG9mIGluZm9ybWF0aW9uLgogICAgKi8KICAgIGdldENvbG9ySW5mbzogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHZhciBhcmdiID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CiAgICAgICAgdmFyIGhzbCA9IFBoYXNlci5Db2xvci5SR0J0b0hTVihjb2xvcik7CiAgICAgICAgCiAgICAgICAgLy8JSGV4IGZvcm1hdAogICAgICAgIHZhciByZXN1bHQgPSBQaGFzZXIuQ29sb3IuUkdCdG9IZXhzdHJpbmcoY29sb3IpICsgIlxuIjsKICAgICAgICAKICAgICAgICAvLwlSR0IgZm9ybWF0CiAgICAgICAgcmVzdWx0ID0gcmVzdWx0LmNvbmNhdCgiQWxwaGE6ICIgKyBhcmdiLmFscGhhICsgIiBSZWQ6ICIgKyBhcmdiLnJlZCArICIgR3JlZW46ICIgKyBhcmdiLmdyZWVuICsgIiBCbHVlOiAiICsgYXJnYi5ibHVlKSArICJcbiI7CiAgICAgICAgCiAgICAgICAgLy8JSFNMIGluZm8KICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCJIdWU6ICIgKyBoc2wuaHVlICsgIiBTYXR1cmF0aW9uOiAiICsgaHNsLnNhdHVyYXRpb24gKyAiIExpZ2h0bmVzOiAiICsgaHNsLmxpZ2h0bmVzcyk7CgogICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb2xvciBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLlJHQnRvSGV4c3RyaW5nCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGdldCB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIGZvcgogICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyBvZiBsZW5ndGggMTAgY2hhcmFjdGVycyBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIKICAgICovCiAgICBSR0J0b0hleHN0cmluZzogZnVuY3Rpb24gKGNvbG9yKSB7CgogICAgICAgIHZhciBhcmdiID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CgogICAgICAgIHJldHVybiAiMHgiICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5hbHBoYSkgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLnJlZCkgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmdyZWVuKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuYmx1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBjb2xvciBpbiB0aGUgZm9ybWF0ICNSUkdHQkIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLlJHQnRvV2Vic3RyaW5nCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGNvbG9yIHRvIGdldCB0aGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIGZvci4KICAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgb2YgbGVuZ3RoIDEwIGNoYXJhY3RlcnMgaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKi8KICAgIFJHQnRvV2Vic3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKCiAgICAgICAgcmV0dXJuICIjIiArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IucmVkKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuZ3JlZW4pICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ibHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgY29udGFpbmluZyBhIGhleCByZXByZXNlbnRhdGlvbiBvZiB0aGUgZ2l2ZW4gY29sb3IuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgY2hhbm5lbCB0byBnZXQgdGhlIGhleCB2YWx1ZSBmb3IsIG11c3QgYmUgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEEgc3RyaW5nIG9mIGxlbmd0aCAyIGNoYXJhY3RlcnMsIGkuZS4gMjU1ID0gRkYsIDAgPSAwMC4KICAgICovCiAgICBjb2xvclRvSGV4c3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGRpZ2l0cyA9ICIwMTIzNDU2Nzg5QUJDREVGIjsKICAgICAgICB2YXIgbHNkID0gY29sb3IgJSAxNjsKICAgICAgICB2YXIgbXNkID0gKGNvbG9yIC0gbHNkKSAvIDE2OwogICAgICAgIHZhciBoZXhpZmllZCA9IGRpZ2l0cy5jaGFyQXQobXNkKSArIGRpZ2l0cy5jaGFyQXQobHNkKTsKICAgICAgICByZXR1cm4gaGV4aWZpZWQ7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJwb2xhdGVzIHRoZSB0d28gZ2l2ZW4gY29sb3VycyBiYXNlZCBvbiB0aGUgc3VwcGxpZWQgc3RlcCBhbmQgY3VycmVudFN0ZXAgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaW50ZXJwb2xhdGVDb2xvcgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvcjEgLSBUaGUgZmlyc3QgY29sb3IgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvcjIgLSBUaGUgc2Vjb25kIGNvbG9yIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgb2YgdGhlIHJldHVybmVkIGNvbG9yLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlQ29sb3I6IGZ1bmN0aW9uIChjb2xvcjEsIGNvbG9yMiwgc3RlcHMsIGN1cnJlbnRTdGVwLCBhbHBoYSkgewoKICAgICAgICBpZiAodHlwZW9mIGFscGhhID09PSAidW5kZWZpbmVkIikgeyBhbHBoYSA9IDI1NTsgfQoKICAgICAgICB2YXIgc3JjMSA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IxKTsKICAgICAgICB2YXIgc3JjMiA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IyKTsKICAgICAgICB2YXIgciA9ICgoKHNyYzIucmVkIC0gc3JjMS5yZWQpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjMS5yZWQ7CiAgICAgICAgdmFyIGcgPSAoKChzcmMyLmdyZWVuIC0gc3JjMS5ncmVlbikgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMxLmdyZWVuOwogICAgICAgIHZhciBiID0gKCgoc3JjMi5ibHVlIC0gc3JjMS5ibHVlKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYzEuYmx1ZTsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcjMyKGFscGhhLCByLCBnLCBiKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcnBvbGF0ZXMgdGhlIHR3byBnaXZlbiBjb2xvdXJzIGJhc2VkIG9uIHRoZSBzdXBwbGllZCBzdGVwIGFuZCBjdXJyZW50U3RlcCBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5pbnRlcnBvbGF0ZUNvbG9yV2l0aFJHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIFRoZSBmaXJzdCBjb2xvciB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnIC0gVGhlIGdyZWVuIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBiIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXBzIC0gVGhlIG51bWJlciBvZiBzdGVwcyB0byBydW4gdGhlIGludGVycG9sYXRpb24gb3Zlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGN1cnJlbnRTdGVwIC0gVGhlIGN1cnJlbnRTdGVwIHZhbHVlLiBJZiB0aGUgaW50ZXJwb2xhdGlvbiB3aWxsIHRha2UgMTAwIHN0ZXBzLCBhIGN1cnJlbnRTdGVwIHZhbHVlIG9mIDUwIHdvdWxkIGJlIGhhbGYtd2F5IGJldHdlZW4gdGhlIHR3by4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGludGVycG9sYXRlZCBjb2xvciB2YWx1ZS4KICAgICovCiAgICBpbnRlcnBvbGF0ZUNvbG9yV2l0aFJHQjogZnVuY3Rpb24gKGNvbG9yLCByLCBnLCBiLCBzdGVwcywgY3VycmVudFN0ZXApIHsKCiAgICAgICAgdmFyIHNyYyA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IpOwogICAgICAgIHZhciBvciA9ICgoKHIgLSBzcmMucmVkKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5yZWQ7CiAgICAgICAgdmFyIG9nID0gKCgoZyAtIHNyYy5ncmVlbikgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMuZ3JlZW47CiAgICAgICAgdmFyIG9iID0gKCgoYiAtIHNyYy5ibHVlKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5ibHVlOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKG9yLCBvZywgb2IpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVycG9sYXRlcyB0aGUgdHdvIGdpdmVuIGNvbG91cnMgYmFzZWQgb24gdGhlIHN1cHBsaWVkIHN0ZXAgYW5kIGN1cnJlbnRTdGVwIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmludGVycG9sYXRlUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IHIxIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZzEgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIxIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHIyIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZzIgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIyIC0gVGhlIGJsdWUgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0ZXBzIC0gVGhlIG51bWJlciBvZiBzdGVwcyB0byBydW4gdGhlIGludGVycG9sYXRpb24gb3Zlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGN1cnJlbnRTdGVwIC0gVGhlIGN1cnJlbnRTdGVwIHZhbHVlLiBJZiB0aGUgaW50ZXJwb2xhdGlvbiB3aWxsIHRha2UgMTAwIHN0ZXBzLCBhIGN1cnJlbnRTdGVwIHZhbHVlIG9mIDUwIHdvdWxkIGJlIGhhbGYtd2F5IGJldHdlZW4gdGhlIHR3by4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIGludGVycG9sYXRlZCBjb2xvciB2YWx1ZS4KICAgICovCiAgICBpbnRlcnBvbGF0ZVJHQjogZnVuY3Rpb24gKHIxLCBnMSwgYjEsIHIyLCBnMiwgYjIsIHN0ZXBzLCBjdXJyZW50U3RlcCkgewoKICAgICAgICB2YXIgciA9ICgoKHIyIC0gcjEpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgcjE7CiAgICAgICAgdmFyIGcgPSAoKChnMiAtIGcxKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIGcxOwogICAgICAgIHZhciBiID0gKCgoYjIgLSBiMSkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBiMTsKCiAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcihyLCBnLCBiKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgcmFuZG9tIGNvbG9yIHZhbHVlIGJldHdlZW4gYmxhY2sgYW5kIHdoaXRlCiAgICAqIFNldCB0aGUgbWluIHZhbHVlIHRvIHN0YXJ0IGVhY2ggY2hhbm5lbCBmcm9tIHRoZSBnaXZlbiBvZmZzZXQuCiAgICAqIFNldCB0aGUgbWF4IHZhbHVlIHRvIHJlc3RyaWN0IHRoZSBtYXhpbXVtIGNvbG9yIHVzZWQgcGVyIGNoYW5uZWwuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJhbmRvbUNvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBsb3dlc3QgdmFsdWUgdG8gdXNlIGZvciB0aGUgY29sb3IuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgaGlnaGVzdCB2YWx1ZSB0byB1c2UgZm9yIHRoZSBjb2xvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIGFscGhhIHZhbHVlIG9mIHRoZSByZXR1cm5pbmcgY29sb3IgKGRlZmF1bHQgMjU1ID0gZnVsbHkgb3BhcXVlKS4KICAgICogQHJldHVybnMge251bWJlcn0gMzItYml0IGNvbG9yIHZhbHVlIHdpdGggYWxwaGEuCiAgICAqLwogICAgZ2V0UmFuZG9tQ29sb3I6IGZ1bmN0aW9uIChtaW4sIG1heCwgYWxwaGEpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBtaW4gPT09ICJ1bmRlZmluZWQiKSB7IG1pbiA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIG1heCA9PT0gInVuZGVmaW5lZCIpIHsgbWF4ID0gMjU1OyB9CiAgICAgICAgaWYgKHR5cGVvZiBhbHBoYSA9PT0gInVuZGVmaW5lZCIpIHsgYWxwaGEgPSAyNTU7IH0KCiAgICAgICAgLy8JU2FuaXR5IGNoZWNrcwogICAgICAgIGlmIChtYXggPiAyNTUpIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcigyNTUsIDI1NSwgMjU1KTsKICAgICAgICB9CgogICAgICAgIGlmIChtaW4gPiBtYXgpIHsKICAgICAgICAgICAgcmV0dXJuIFBoYXNlci5Db2xvci5nZXRDb2xvcigyNTUsIDI1NSwgMjU1KTsKICAgICAgICB9CgogICAgICAgIHZhciByZWQgPSBtaW4gKyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSk7CiAgICAgICAgdmFyIGdyZWVuID0gbWluICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikpOwogICAgICAgIHZhciBibHVlID0gbWluICsgTWF0aC5yb3VuZChNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbikpOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yMzIoYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybiB0aGUgY29tcG9uZW50IHBhcnRzIG9mIGEgY29sb3IgYXMgYW4gT2JqZWN0IHdpdGggdGhlIHByb3BlcnRpZXMgYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUKICAgICoKICAgICogQWxwaGEgd2lsbCBvbmx5IGJlIHNldCBpZiBpdCBleGlzdCBpbiB0aGUgZ2l2ZW4gY29sb3IgKDB4QUFSUkdHQkIpCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIENvbG9yIGluIFJHQiAoMHhSUkdHQkIpIG9yIEFSR0IgZm9ybWF0ICgweEFBUlJHR0JCKS4KICAgICogQHJldHVybnMge29iamVjdH0gQW4gT2JqZWN0IHdpdGggcHJvcGVydGllczogYWxwaGEsIHJlZCwgZ3JlZW4sIGJsdWUuCiAgICAqLwogICAgZ2V0UkdCOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgYWxwaGE6IGNvbG9yID4+PiAyNCwKICAgICAgICAgICAgcmVkOiBjb2xvciA+PiAxNiAmIDB4RkYsCiAgICAgICAgICAgIGdyZWVuOiBjb2xvciA+PiA4ICYgMHhGRiwKICAgICAgICAgICAgYmx1ZTogY29sb3IgJiAweEZGCiAgICAgICAgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgQ1NTIGZyaWVuZGx5IHN0cmluZyB2YWx1ZSBmcm9tIHRoZSBnaXZlbiBjb2xvci4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0V2ViUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9QSBzdHJpbmcgaW4gdGhlIGZvcm1hdDogJ3JnYmEocixnLGIsYSknCiAgICAqLwogICAgZ2V0V2ViUkdCOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFscGhhID0gKGNvbG9yID4+PiAyNCkgLyAyNTU7CiAgICAgICAgdmFyIHJlZCA9IGNvbG9yID4+IDE2ICYgMHhGRjsKICAgICAgICB2YXIgZ3JlZW4gPSBjb2xvciA+PiA4ICYgMHhGRjsKICAgICAgICB2YXIgYmx1ZSA9IGNvbG9yICYgMHhGRjsKCiAgICAgICAgcmV0dXJuICdyZ2JhKCcgKyByZWQudG9TdHJpbmcoKSArICcsJyArIGdyZWVuLnRvU3RyaW5nKCkgKyAnLCcgKyBibHVlLnRvU3RyaW5nKCkgKyAnLCcgKyBhbHBoYS50b1N0cmluZygpICsgJyknOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgQWxwaGEgY29tcG9uZW50LCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRBbHBoYQogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEFscGhhIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAxICgwIGJlaW5nIG5vIEFscGhhIChvcGFxdWUpLCAxIGZ1bGwgQWxwaGEgKHRyYW5zcGFyZW50KSkuCiAgICAqLwogICAgZ2V0QWxwaGE6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciA+Pj4gMjQ7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBBbHBoYSBjb21wb25lbnQgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEFscGhhRmxvYXQKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBBbHBoYSBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMSAoMCBiZWluZyBubyBBbHBoYSAob3BhcXVlKSwgMSBmdWxsIEFscGhhICh0cmFuc3BhcmVudCkpLgogICAgKi8KICAgIGdldEFscGhhRmxvYXQ6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiAoY29sb3IgPj4+IDI0KSAvIDI1NTsKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIFJlZCBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldFJlZAogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBSZWQgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgUmVkKS4KICAgICovCiAgICBnZXRSZWQ6IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciA+PiAxNiAmIDB4RkY7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBHcmVlbiBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEdyZWVuCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgR3JlZW4gY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgR3JlZW4pLgogICAgKi8KICAgIGdldEdyZWVuOiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gY29sb3IgPj4gOCAmIDB4RkY7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBCbHVlIGNvbXBvbmVudCwgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0Qmx1ZQogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEJsdWUgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDI1NSAoMCBiZWluZyBubyBjb2xvciwgMjU1IGZ1bGwgQmx1ZSkuCiAgICAqLwogICAgZ2V0Qmx1ZTogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGNvbG9yICYgMHhGRjsKICAgIH0KCQp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5QaHlzaWNzCiovClBoYXNlci5QaHlzaWNzID0ge307CgovKioKKiBBcmNhZGUgUGh5c2ljcyBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUKKiBAY2xhc3NkZXNjIEFyY2FkZSBQaHlzaWNzIENvbnN0cnVjdG9yCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlID0gZnVuY3Rpb24gKGdhbWUpIHsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gZ3Jhdml0eSAtIFRoZSBXb3JsZCBncmF2aXR5IHNldHRpbmcuIERlZmF1bHRzIHRvIHg6IDAsIHk6IDAsIG9yIG5vIGdyYXZpdHkuCiAgICAqLwogICAgdGhpcy5ncmF2aXR5ID0gbmV3IFBoYXNlci5Qb2ludDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHMgLSBUaGUgYm91bmRzIGluc2lkZSBvZiB3aGljaCB0aGUgcGh5c2ljcyB3b3JsZCBleGlzdHMuIERlZmF1bHRzIHRvIG1hdGNoIHRoZSB3b3JsZCBib3VuZHMuCiAgICAqLwogICAgdGhpcy5ib3VuZHMgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgwLCAwLCBnYW1lLndvcmxkLndpZHRoLCBnYW1lLndvcmxkLmhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhPYmplY3RzIC0gVXNlZCBieSB0aGUgUXVhZFRyZWUgdG8gc2V0IHRoZSBtYXhpbXVtIG51bWJlciBvZiBvYmplY3RzIHBlciBxdWFkLgogICAgKi8KICAgIHRoaXMubWF4T2JqZWN0cyA9IDEwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4TGV2ZWxzIC0gVXNlZCBieSB0aGUgUXVhZFRyZWUgdG8gc2V0IHRoZSBtYXhpbXVtIG51bWJlciBvZiBpdGVyYXRpb24gbGV2ZWxzLgogICAgKi8KICAgIHRoaXMubWF4TGV2ZWxzID0gNDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IE9WRVJMQVBfQklBUyAtIEEgdmFsdWUgYWRkZWQgdG8gdGhlIGRlbHRhIHZhbHVlcyBkdXJpbmcgY29sbGlzaW9uIGNoZWNrcy4KICAgICovCiAgICB0aGlzLk9WRVJMQVBfQklBUyA9IDQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlF1YWRUcmVlfSBxdWFkVHJlZSAtIFRoZSB3b3JsZCBRdWFkVHJlZS4KICAgICovCiAgICB0aGlzLnF1YWRUcmVlID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLngsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueSwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy53aWR0aCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy5oZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcXVhZFRyZWVJRCAtIFRoZSBRdWFkVHJlZSBJRC4KICAgICovCiAgICB0aGlzLnF1YWRUcmVlSUQgPSAwOwoKICAgIC8vICBBdm9pZCBnYyBzcGlrZXMgYnkgY2FjaGluZyB0aGVzZSB2YWx1ZXMgZm9yIHJlLXVzZQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IF9ib3VuZHMxIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JvdW5kczEgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBfYm91bmRzMiAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9ib3VuZHMyID0gbmV3IFBoYXNlci5SZWN0YW5nbGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfb3ZlcmxhcCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vdmVybGFwID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXhPdmVybGFwIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21heE92ZXJsYXAgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ZlbG9jaXR5MSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92ZWxvY2l0eTEgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3ZlbG9jaXR5MiAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92ZWxvY2l0eTIgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX25ld1ZlbG9jaXR5MSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9uZXdWZWxvY2l0eTEgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX25ld1ZlbG9jaXR5MiAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9uZXdWZWxvY2l0eTIgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2F2ZXJhZ2UgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYXZlcmFnZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IF9tYXBEYXRhIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21hcERhdGEgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXBUaWxlcyAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9tYXBUaWxlcyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3Jlc3VsdCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9yZXN1bHQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90b3RhbCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl90b3RhbCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfYW5nbGUgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYW5nbGUgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R4IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2R4ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9keSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9keSA9IDA7Cgp9OwoKUGhhc2VyLlBoeXNpY3MuQXJjYWRlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgYSBQaHlzaWNzIGJvZHksIGl0IHVwZGF0ZXMgYWxsIG1vdGlvbiByZWxhdGVkIHZhbHVlcyBvbiB0aGUgQm9keS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjdXBkYXRlTW90aW9uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IFRoZSBCb2R5IG9iamVjdCB0byBiZSB1cGRhdGVkLgogICAgKi8KICAgIHVwZGF0ZU1vdGlvbjogZnVuY3Rpb24gKGJvZHkpIHsKCiAgICAgICAgLy8gIElmIHlvdSdyZSB3b25kZXJpbmcgd2h5IHRoZSB2ZWxvY2l0eSBpcyBoYWx2ZWQgYW5kIGFwcGxpZWQgdHdpY2UsIHJlYWQgdGhpczogaHR0cDovL3d3dy5uaWtzdWxhLmh1dC5maS9+aGthbmthYW4vSG9tZXBhZ2VzL2dyYXZpdHkuaHRtbAoKICAgICAgICAvLyAgUm90YXRpb24KICAgICAgICB0aGlzLl92ZWxvY2l0eURlbHRhID0gKHRoaXMuY29tcHV0ZVZlbG9jaXR5KDAsIGJvZHksIGJvZHkuYW5ndWxhclZlbG9jaXR5LCBib2R5LmFuZ3VsYXJBY2NlbGVyYXRpb24sIGJvZHkuYW5ndWxhckRyYWcsIGJvZHkubWF4QW5ndWxhcikgLSBib2R5LmFuZ3VsYXJWZWxvY2l0eSkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCAqIDAuNSAqIDYwOwogICAgICAgIGJvZHkuYW5ndWxhclZlbG9jaXR5ICs9IHRoaXMuX3ZlbG9jaXR5RGVsdGE7CiAgICAgICAgYm9keS5yb3RhdGlvbiArPSAoYm9keS5hbmd1bGFyVmVsb2NpdHkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCk7CiAgICAgICAgYm9keS5hbmd1bGFyVmVsb2NpdHkgKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKCiAgICAgICAgLy8gIEhvcml6b250YWwKICAgICAgICB0aGlzLl92ZWxvY2l0eURlbHRhID0gKHRoaXMuY29tcHV0ZVZlbG9jaXR5KDEsIGJvZHksIGJvZHkudmVsb2NpdHkueCwgYm9keS5hY2NlbGVyYXRpb24ueCwgYm9keS5kcmFnLngsIGJvZHkubWF4VmVsb2NpdHkueCkgLSBib2R5LnZlbG9jaXR5LngpICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQgKiAwLjUgKiA2MDsKICAgICAgICBib2R5LnZlbG9jaXR5LnggKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKICAgICAgICBib2R5LnggKz0gKGJvZHkudmVsb2NpdHkueCAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkKTsKICAgICAgICBib2R5LnZlbG9jaXR5LnggKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKCiAgICAgICAgLy8gIFZlcnRpY2FsCiAgICAgICAgdGhpcy5fdmVsb2NpdHlEZWx0YSA9ICh0aGlzLmNvbXB1dGVWZWxvY2l0eSgyLCBib2R5LCBib2R5LnZlbG9jaXR5LnksIGJvZHkuYWNjZWxlcmF0aW9uLnksIGJvZHkuZHJhZy55LCBib2R5Lm1heFZlbG9jaXR5LnkpIC0gYm9keS52ZWxvY2l0eS55KSAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkICogMC41ICogNjA7CiAgICAgICAgYm9keS52ZWxvY2l0eS55ICs9IHRoaXMuX3ZlbG9jaXR5RGVsdGE7CiAgICAgICAgYm9keS55ICs9IChib2R5LnZlbG9jaXR5LnkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCk7CiAgICAgICAgYm9keS52ZWxvY2l0eS55ICs9IHRoaXMuX3ZlbG9jaXR5RGVsdGE7CgogICAgfSwKCiAgICAvKioKICAgICogQSB0d2Vlbi1saWtlIGZ1bmN0aW9uIHRoYXQgdGFrZXMgYSBzdGFydGluZyB2ZWxvY2l0eSBhbmQgc29tZSBvdGhlciBmYWN0b3JzIGFuZCByZXR1cm5zIGFuIGFsdGVyZWQgdmVsb2NpdHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbXB1dGVWZWxvY2l0eQogICAgKiBAcGFyYW0ge251bWJlcn0gYXhpcyAtIDEgZm9yIGhvcml6b250YWwsIDIgZm9yIHZlcnRpY2FsLgogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5IC0gVGhlIEJvZHkgb2JqZWN0IHRvIGJlIHVwZGF0ZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2ZWxvY2l0eSAtIEFueSBjb21wb25lbnQgb2YgdmVsb2NpdHkgKGUuZy4gMjApLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWNjZWxlcmF0aW9uIC0gUmF0ZSBhdCB3aGljaCB0aGUgdmVsb2NpdHkgaXMgY2hhbmdpbmcuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkcmFnIC0gUmVhbGx5IGtpbmQgb2YgYSBkZWNlbGVyYXRpb24sIHRoaXMgaXMgaG93IG11Y2ggdGhlIHZlbG9jaXR5IGNoYW5nZXMgaWYgQWNjZWxlcmF0aW9uIGlzIG5vdCBzZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtTWF4IC0gQW4gYWJzb2x1dGUgdmFsdWUgY2FwIGZvciB0aGUgdmVsb2NpdHkuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFsdGVyZWQgVmVsb2NpdHkgdmFsdWUuCiAgICAqLwogICAgY29tcHV0ZVZlbG9jaXR5OiBmdW5jdGlvbiAoYXhpcywgYm9keSwgdmVsb2NpdHksIGFjY2VsZXJhdGlvbiwgZHJhZywgbWF4KSB7CgogICAgICAgIG1heCA9IG1heCB8fCAxMDAwMDsKCiAgICAgICAgaWYgKGF4aXMgPT0gMSAmJiBib2R5LmFsbG93R3Jhdml0eSkKICAgICAgICB7CiAgICAgICAgICAgIHZlbG9jaXR5ICs9IHRoaXMuZ3Jhdml0eS54ICsgYm9keS5ncmF2aXR5Lng7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGF4aXMgPT0gMiAmJiBib2R5LmFsbG93R3Jhdml0eSkKICAgICAgICB7CiAgICAgICAgICAgIHZlbG9jaXR5ICs9IHRoaXMuZ3Jhdml0eS55ICsgYm9keS5ncmF2aXR5Lnk7CiAgICAgICAgfQoKICAgICAgICBpZiAoYWNjZWxlcmF0aW9uICE9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdmVsb2NpdHkgKz0gYWNjZWxlcmF0aW9uICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQ7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGRyYWcgIT09IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9kcmFnID0gZHJhZyAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkOwoKICAgICAgICAgICAgaWYgKHZlbG9jaXR5IC0gdGhpcy5fZHJhZyA+IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZlbG9jaXR5IC09IHRoaXMuX2RyYWc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodmVsb2NpdHkgKyB0aGlzLl9kcmFnIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmVsb2NpdHkgKz0gdGhpcy5fZHJhZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZlbG9jaXR5ID0gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHZlbG9jaXR5ID4gbWF4KQogICAgICAgIHsKICAgICAgICAgICAgdmVsb2NpdHkgPSBtYXg7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHZlbG9jaXR5IDwgLW1heCkKICAgICAgICB7CiAgICAgICAgICAgIHZlbG9jaXR5ID0gLW1heDsKICAgICAgICB9CgogICAgICAgIHJldHVybiB2ZWxvY2l0eTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSB0aGUgY29yZSBnYW1lIGxvb3AuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3ByZVVwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJlVXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBDbGVhciB0aGUgdHJlZQogICAgICAgIHRoaXMucXVhZFRyZWUuY2xlYXIoKTsKCiAgICAgICAgLy8gIENyZWF0ZSBvdXIgdHJlZSB3aGljaCBhbGwgb2YgdGhlIFBoeXNpY3MgYm9kaWVzIHdpbGwgYWRkIHRoZW1zZWx2ZXMgdG8KICAgICAgICB0aGlzLnF1YWRUcmVlSUQgPSAwOwogICAgICAgIHRoaXMucXVhZFRyZWUgPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy55LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLndpZHRoLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLmhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscyk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlIGNvcmUgZ2FtZSBsb29wLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNwb3N0VXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwb3N0VXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vICBDbGVhciB0aGUgdHJlZSByZWFkeSBmb3IgdGhlIG5leHQgdXBkYXRlCiAgICAgICAgdGhpcy5xdWFkVHJlZS5jbGVhcigpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBpZiB0d28gU3ByaXRlIG9iamVjdHMgb3ZlcmxhcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjb3ZlcmxhcAogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IG9iamVjdDEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIGNoZWNrLiBDYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSBvciBhbnl0aGluZyB0aGF0IGV4dGVuZHMgaXQuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gb2JqZWN0MiAtIFRoZSBzZWNvbmQgb2JqZWN0IHRvIGNoZWNrLiBDYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSBvciBhbnl0aGluZyB0aGF0IGV4dGVuZHMgaXQuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIGlmIHRoZSB0d28gb2JqZWN0cyBvdmVybGFwLgogICAgKi8KICAgIG92ZXJsYXA6IGZ1bmN0aW9uIChvYmplY3QxLCBvYmplY3QyKSB7CgogICAgICAgIC8vICBPbmx5IHRlc3QgdmFsaWQgb2JqZWN0cwogICAgICAgIGlmIChvYmplY3QxICYmIG9iamVjdDIgJiYgb2JqZWN0MS5leGlzdHMgJiYgb2JqZWN0Mi5leGlzdHMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gKFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyhvYmplY3QxLmJvZHksIG9iamVjdDIuYm9keSkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBmb3IgY29sbGlzaW9uIGJldHdlZW4gdHdvIGdhbWUgb2JqZWN0cy4gVGhlIG9iamVjdHMgY2FuIGJlIFNwcml0ZXMsIEdyb3VwcywgRW1pdHRlcnMgb3IgVGlsZW1hcCBMYXllcnMuCiAgICAqIFlvdSBjYW4gcGVyZm9ybSBTcHJpdGUgdnMuIFNwcml0ZSwgU3ByaXRlIHZzLiBHcm91cCwgR3JvdXAgdnMuIEdyb3VwLCBTcHJpdGUgdnMuIFRpbGVtYXAgTGF5ZXIgb3IgR3JvdXAgdnMuIFRpbGVtYXAgTGF5ZXIgY29sbGlzaW9ucy4KICAgICogVGhlIG9iamVjdHMgYXJlIGFsc28gYXV0b21hdGljYWxseSBzZXBhcmF0ZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGUKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ8UGhhc2VyLlRpbGVtYXB9IG9iamVjdDEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIGNoZWNrLiBDYW4gYmUgYW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkdyb3VwLCBQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXIsIG9yIFBoYXNlci5UaWxlbWFwCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZXxQaGFzZXIuR3JvdXB8UGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyfFBoYXNlci5UaWxlbWFwfSBvYmplY3QyIC0gVGhlIHNlY29uZCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAsIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlciBvciBQaGFzZXIuVGlsZW1hcAogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY29sbGlkZUNhbGxiYWNrPW51bGxdIC0gQW4gb3B0aW9uYWwgY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBpcyBjYWxsZWQgaWYgdGhlIG9iamVjdHMgb3ZlcmxhcC4gVGhlIHR3byBvYmplY3RzIHdpbGwgYmUgcGFzc2VkIHRvIHRoaXMgZnVuY3Rpb24gaW4gdGhlIHNhbWUgb3JkZXIgaW4gd2hpY2ggeW91IHBhc3NlZCB0aGVtIHRvIENvbGxpc2lvbi5vdmVybGFwLgogICAgKiBAcGFyYW0ge2Z1bmN0aW9ufSBbcHJvY2Vzc0NhbGxiYWNrPW51bGxdIC0gQSBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGxldHMgeW91IHBlcmZvcm0gYWRkaXRpb25hbCBjaGVja3MgYWdhaW5zdCB0aGUgdHdvIG9iamVjdHMgaWYgdGhleSBvdmVybGFwLiBJZiB0aGlzIGlzIHNldCB0aGVuIGNvbGxpZGVDYWxsYmFjayB3aWxsIG9ubHkgYmUgY2FsbGVkIGlmIHByb2Nlc3NDYWxsYmFjayByZXR1cm5zIHRydWUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRvIHJ1biB0aGUgY2FsbGJhY2tzLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNvbGxpc2lvbnMgdGhhdCB3ZXJlIHByb2Nlc3NlZC4KICAgICovCiAgICBjb2xsaWRlOiBmdW5jdGlvbiAob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICBjb2xsaWRlQ2FsbGJhY2sgPSBjb2xsaWRlQ2FsbGJhY2sgfHwgbnVsbDsKICAgICAgICBwcm9jZXNzQ2FsbGJhY2sgPSBwcm9jZXNzQ2FsbGJhY2sgfHwgbnVsbDsKICAgICAgICBjYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQgfHwgY29sbGlkZUNhbGxiYWNrOwoKICAgICAgICB0aGlzLl9yZXN1bHQgPSBmYWxzZTsKICAgICAgICB0aGlzLl90b3RhbCA9IDA7CgogICAgICAgIC8vICBPbmx5IGNvbGxpZGUgdmFsaWQgb2JqZWN0cwogICAgICAgIGlmIChvYmplY3QxICYmIG9iamVjdDIgJiYgb2JqZWN0MS5leGlzdHMgJiYgb2JqZWN0Mi5leGlzdHMpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ2FuIGV4cGFuZCB0byBzdXBwb3J0IEJ1dHRvbnMsIFRleHQsIGV0YyBhdCBhIGxhdGVyIGRhdGUuIEZvciBub3cgdGhlc2UgYXJlIHRoZSBlc3NlbnRpYWxzLgoKICAgICAgICAgICAgLy8gIFNQUklURVMKICAgICAgICAgICAgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuU1BSSVRFKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5TUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNTcHJpdGUob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5USUxFTUFQTEFZRVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXIob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gIEdST1VQUwogICAgICAgICAgICBlbHNlIGlmIChvYmplY3QxLnR5cGUgPT0gUGhhc2VyLkdST1VQKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5TUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChvYmplY3QyLCBvYmplY3QxLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNHcm91cChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRU1BUExBWUVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gIFRJTEVNQVAgTEFZRVJTCiAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuVElMRU1BUExBWUVSKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5TUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXIob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyKG9iamVjdDIsIG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vICBFTUlUVEVSCiAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuU1BSSVRFKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzR3JvdXAob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkdST1VQIHx8IG9iamVjdDIudHlwZSA9PSBQaGFzZXIuRU1JVFRFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzR3JvdXAob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKHRoaXMuX3RvdGFsID4gMCk7CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNUaWxlbWFwTGF5ZXI6IGZ1bmN0aW9uIChzcHJpdGUsIHRpbGVtYXBMYXllciwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICB0aGlzLl9tYXBEYXRhID0gdGlsZW1hcExheWVyLmdldFRpbGVzKHNwcml0ZS5ib2R5LngsIHNwcml0ZS5ib2R5LnksIHNwcml0ZS5ib2R5LndpZHRoLCBzcHJpdGUuYm9keS5oZWlnaHQsIHRydWUpOwoKICAgICAgICBpZiAodGhpcy5fbWFwRGF0YS5sZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fbWFwRGF0YS5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnNlcGFyYXRlVGlsZShzcHJpdGUuYm9keSwgdGhpcy5fbWFwRGF0YVtpXSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBUaGV5IGNvbGxpZGVkLCBpcyB0aGVyZSBhIGN1c3RvbSBwcm9jZXNzIGNhbGxiYWNrPwogICAgICAgICAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0NhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX21hcERhdGFbaV0pKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9tYXBEYXRhW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90b3RhbCsrOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGlkZUNhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX21hcERhdGFbaV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVHcm91cFZzVGlsZW1hcExheWVyCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXI6IGZ1bmN0aW9uIChncm91cCwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIGlmIChncm91cC5sZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChncm91cC5sZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChncm91cC5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGdyb3VwLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGRvICAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmV4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihjdXJyZW50Tm9kZSwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSBncm91cC5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlU3ByaXRlVnNTcHJpdGUKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNTcHJpdGU6IGZ1bmN0aW9uIChzcHJpdGUxLCBzcHJpdGUyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHRoaXMuc2VwYXJhdGUoc3ByaXRlMS5ib2R5LCBzcHJpdGUyLmJvZHkpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0KQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoZXkgY29sbGlkZWQsIGlzIHRoZXJlIGEgY3VzdG9tIHByb2Nlc3MgY2FsbGJhY2s/CiAgICAgICAgICAgIGlmIChwcm9jZXNzQ2FsbGJhY2spCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZTEsIHNwcml0ZTIpKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZTEsIHNwcml0ZTIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CgogICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVDYWxsYmFjaykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZTEsIHNwcml0ZTIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFuIGludGVybmFsIGZ1bmN0aW9uLiBVc2UgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLmNvbGxpZGUgaW5zdGVhZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZVNwcml0ZVZzR3JvdXAKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlU3ByaXRlVnNHcm91cDogZnVuY3Rpb24gKHNwcml0ZSwgZ3JvdXAsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgaWYgKGdyb3VwLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIFdoYXQgaXMgdGhlIHNwcml0ZSBjb2xsaWRpbmcgd2l0aCBpbiB0aGUgcXVhZHRyZWU/CiAgICAgICAgdGhpcy5fcG90ZW50aWFscyA9IHRoaXMucXVhZFRyZWUucmV0cmlldmUoc3ByaXRlKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX3BvdGVudGlhbHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2UgaGF2ZSBvdXIgcG90ZW50aWFsIHN1c3BlY3RzLCBhcmUgdGhleSBpbiB0aGlzIGdyb3VwPwogICAgICAgICAgICBpZiAodGhpcy5fcG90ZW50aWFsc1tpXS5zcHJpdGUuZ3JvdXAgPT0gZ3JvdXApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2VwYXJhdGUoc3ByaXRlLmJvZHksIHRoaXMuX3BvdGVudGlhbHNbaV0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZXN1bHQgJiYgcHJvY2Vzc0NhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdCA9IHByb2Nlc3NDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlLCB0aGlzLl9wb3RlbnRpYWxzW2ldLnNwcml0ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl90b3RhbCsrOwoKICAgICAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29sbGlkZUNhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX3BvdGVudGlhbHNbaV0uc3ByaXRlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlR3JvdXBWc0dyb3VwCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgY29sbGlkZUdyb3VwVnNHcm91cDogZnVuY3Rpb24gKGdyb3VwMSwgZ3JvdXAyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIGlmIChncm91cDEubGVuZ3RoID09IDAgfHwgZ3JvdXAyLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGdyb3VwMS5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKICAgICAgICB7CiAgICAgICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IGdyb3VwMS5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBkbyAgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5leGlzdHMpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChjdXJyZW50Tm9kZSwgZ3JvdXAyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSBncm91cDEuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgdHdvIHBoeXNpY3MgYm9kaWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTIgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlOiBmdW5jdGlvbiAoYm9keTEsIGJvZHkyKSB7CgogICAgICAgIHRoaXMuX3Jlc3VsdCA9ICh0aGlzLnNlcGFyYXRlWChib2R5MSwgYm9keTIpIHx8IHRoaXMuc2VwYXJhdGVZKGJvZHkxLCBib2R5MikpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgdHdvIHBoeXNpY3MgYm9kaWVzIG9uIHRoZSB4IGF4aXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlWAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTIgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlWDogZnVuY3Rpb24gKGJvZHkxLCBib2R5MikgewoKICAgICAgICAvLyAgQ2FuJ3Qgc2VwYXJhdGUgdHdvIGltbW92YWJsZSBib2RpZXMKICAgICAgICBpZiAoYm9keTEuaW1tb3ZhYmxlICYmIGJvZHkyLmltbW92YWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwoKICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIGh1bGxzIGFjdHVhbGx5IG92ZXJsYXAKICAgICAgICBpZiAoUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKGJvZHkxLCBib2R5MikpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tYXhPdmVybGFwID0gYm9keTEuZGVsdGFBYnNYKCkgKyBib2R5Mi5kZWx0YUFic1goKSArIHRoaXMuT1ZFUkxBUF9CSUFTOwoKICAgICAgICAgICAgaWYgKGJvZHkxLmRlbHRhWCgpID09IDAgJiYgYm9keTIuZGVsdGFYKCkgPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFRoZXkgb3ZlcmxhcCBidXQgbmVpdGhlciBvZiB0aGVtIGFyZSBtb3ZpbmcKICAgICAgICAgICAgICAgIGJvZHkxLmVtYmVkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJvZHkyLmVtYmVkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChib2R5MS5kZWx0YVgoKSA+IGJvZHkyLmRlbHRhWCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQm9keTEgaXMgbW92aW5nIHJpZ2h0IGFuZC9vciBCb2R5MiBpcyBtb3ZpbmcgbGVmdAogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkxLnggKyBib2R5MS53aWR0aCAtIGJvZHkyLng7CgogICAgICAgICAgICAgICAgaWYgKCh0aGlzLl9vdmVybGFwID4gdGhpcy5fbWF4T3ZlcmxhcCkgfHwgYm9keTEuYWxsb3dDb2xsaXNpb24ucmlnaHQgPT0gZmFsc2UgfHwgYm9keTIuYWxsb3dDb2xsaXNpb24ubGVmdCA9PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5MS50b3VjaGluZy5yaWdodCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYm9keTIudG91Y2hpbmcubGVmdCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoYm9keTEuZGVsdGFYKCkgPCBib2R5Mi5kZWx0YVgoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEJvZHkxIGlzIG1vdmluZyBsZWZ0IGFuZC9vciBCb2R5MiBpcyBtb3ZpbmcgcmlnaHQKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSBib2R5MS54IC0gYm9keTIud2lkdGggLSBib2R5Mi54OwoKICAgICAgICAgICAgICAgIGlmICgoLXRoaXMuX292ZXJsYXAgPiB0aGlzLl9tYXhPdmVybGFwKSB8fCBib2R5MS5hbGxvd0NvbGxpc2lvbi5sZWZ0ID09IGZhbHNlIHx8IGJvZHkyLmFsbG93Q29sbGlzaW9uLnJpZ2h0ID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnRvdWNoaW5nLmxlZnQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnRvdWNoaW5nLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFRoZW4gYWRqdXN0IHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmRpbmdseSAoaWYgdGhlcmUgd2FzIGFueSBvdmVybGFwKQogICAgICAgICAgICBpZiAodGhpcy5fb3ZlcmxhcCAhPSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5MS5vdmVybGFwWCA9IHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICBib2R5Mi5vdmVybGFwWCA9IHRoaXMuX292ZXJsYXA7CgogICAgICAgICAgICAgICAgaWYgKGJvZHkxLmN1c3RvbVNlcGFyYXRlWCB8fCBib2R5Mi5jdXN0b21TZXBhcmF0ZVgpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fdmVsb2NpdHkxID0gYm9keTEudmVsb2NpdHkueDsKICAgICAgICAgICAgICAgIHRoaXMuX3ZlbG9jaXR5MiA9IGJvZHkyLnZlbG9jaXR5Lng7CgogICAgICAgICAgICAgICAgaWYgKCFib2R5MS5pbW1vdmFibGUgJiYgIWJvZHkyLmltbW92YWJsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwICo9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgYm9keTEueCA9IGJvZHkxLnggLSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnggKz0gdGhpcy5fb3ZlcmxhcDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkxID0gTWF0aC5zcXJ0KCh0aGlzLl92ZWxvY2l0eTIgKiB0aGlzLl92ZWxvY2l0eTIgKiBib2R5Mi5tYXNzKSAvIGJvZHkxLm1hc3MpICogKCh0aGlzLl92ZWxvY2l0eTIgPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkyID0gTWF0aC5zcXJ0KCh0aGlzLl92ZWxvY2l0eTEgKiB0aGlzLl92ZWxvY2l0eTEgKiBib2R5MS5tYXNzKSAvIGJvZHkyLm1hc3MpICogKCh0aGlzLl92ZWxvY2l0eTEgPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXZlcmFnZSA9ICh0aGlzLl9uZXdWZWxvY2l0eTEgKyB0aGlzLl9uZXdWZWxvY2l0eTIpICogMC41OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX25ld1ZlbG9jaXR5MSAtPSB0aGlzLl9hdmVyYWdlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX25ld1ZlbG9jaXR5MiAtPSB0aGlzLl9hdmVyYWdlOwoKICAgICAgICAgICAgICAgICAgICBib2R5MS52ZWxvY2l0eS54ID0gdGhpcy5fYXZlcmFnZSArIHRoaXMuX25ld1ZlbG9jaXR5MSAqIGJvZHkxLmJvdW5jZS54OwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnZlbG9jaXR5LnggPSB0aGlzLl9hdmVyYWdlICsgdGhpcy5fbmV3VmVsb2NpdHkyICogYm9keTIuYm91bmNlLng7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICghYm9keTEuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnggPSBib2R5MS54IC0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgICAgICBib2R5MS52ZWxvY2l0eS54ID0gdGhpcy5fdmVsb2NpdHkyIC0gdGhpcy5fdmVsb2NpdHkxICogYm9keTEuYm91bmNlLng7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICghYm9keTIuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkyLnggKz0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgICAgICBib2R5Mi52ZWxvY2l0eS54ID0gdGhpcy5fdmVsb2NpdHkxIC0gdGhpcy5fdmVsb2NpdHkyICogYm9keTIuYm91bmNlLng7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBzZXBhcmF0aW9uIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIHR3byBwaHlzaWNzIGJvZGllcyBvbiB0aGUgeSBheGlzLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZVkKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTEgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkyIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBib2RpZXMgd2VyZSBzZXBhcmF0ZWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBzZXBhcmF0ZVk6IGZ1bmN0aW9uIChib2R5MSwgYm9keTIpIHsKCiAgICAgICAgLy8gIENhbid0IHNlcGFyYXRlIHR3byBpbW1vdmFibGUgb3Igbm9uLWV4aXN0aW5nIGJvZHlzCiAgICAgICAgaWYgKGJvZHkxLmltbW92YWJsZSAmJiBib2R5Mi5pbW1vdmFibGUpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9vdmVybGFwID0gMDsKCiAgICAgICAgLy8gIENoZWNrIGlmIHRoZSBodWxscyBhY3R1YWxseSBvdmVybGFwCiAgICAgICAgaWYgKFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyhib2R5MSwgYm9keTIpKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbWF4T3ZlcmxhcCA9IGJvZHkxLmRlbHRhQWJzWSgpICsgYm9keTIuZGVsdGFBYnNZKCkgKyB0aGlzLk9WRVJMQVBfQklBUzsKCiAgICAgICAgICAgIGlmIChib2R5MS5kZWx0YVkoKSA9PSAwICYmIGJvZHkyLmRlbHRhWSgpID09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBUaGV5IG92ZXJsYXAgYnV0IG5laXRoZXIgb2YgdGhlbSBhcmUgbW92aW5nCiAgICAgICAgICAgICAgICBib2R5MS5lbWJlZGRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBib2R5Mi5lbWJlZGRlZCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAoYm9keTEuZGVsdGFZKCkgPiBib2R5Mi5kZWx0YVkoKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIEJvZHkxIGlzIG1vdmluZyBkb3duIGFuZC9vciBCb2R5MiBpcyBtb3ZpbmcgdXAKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSBib2R5MS55ICsgYm9keTEuaGVpZ2h0IC0gYm9keTIueTsKCiAgICAgICAgICAgICAgICBpZiAoKHRoaXMuX292ZXJsYXAgPiB0aGlzLl9tYXhPdmVybGFwKSB8fCBib2R5MS5hbGxvd0NvbGxpc2lvbi5kb3duID09IGZhbHNlIHx8IGJvZHkyLmFsbG93Q29sbGlzaW9uLnVwID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnRvdWNoaW5nLmRvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnRvdWNoaW5nLnVwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChib2R5MS5kZWx0YVkoKSA8IGJvZHkyLmRlbHRhWSgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQm9keTEgaXMgbW92aW5nIHVwIGFuZC9vciBCb2R5MiBpcyBtb3ZpbmcgZG93bgogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkxLnkgLSBib2R5Mi5oZWlnaHQgLSBib2R5Mi55OwoKICAgICAgICAgICAgICAgIGlmICgoLXRoaXMuX292ZXJsYXAgPiB0aGlzLl9tYXhPdmVybGFwKSB8fCBib2R5MS5hbGxvd0NvbGxpc2lvbi51cCA9PSBmYWxzZSB8fCBib2R5Mi5hbGxvd0NvbGxpc2lvbi5kb3duID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnRvdWNoaW5nLnVwID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBib2R5Mi50b3VjaGluZy5kb3duID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFRoZW4gYWRqdXN0IHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmRpbmdseSAoaWYgdGhlcmUgd2FzIGFueSBvdmVybGFwKQogICAgICAgICAgICBpZiAodGhpcy5fb3ZlcmxhcCAhPSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5MS5vdmVybGFwWSA9IHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICBib2R5Mi5vdmVybGFwWSA9IHRoaXMuX292ZXJsYXA7CgogICAgICAgICAgICAgICAgaWYgKGJvZHkxLmN1c3RvbVNlcGFyYXRlWSB8fCBib2R5Mi5jdXN0b21TZXBhcmF0ZVkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fdmVsb2NpdHkxID0gYm9keTEudmVsb2NpdHkueTsKICAgICAgICAgICAgICAgIHRoaXMuX3ZlbG9jaXR5MiA9IGJvZHkyLnZlbG9jaXR5Lnk7CgogICAgICAgICAgICAgICAgaWYgKCFib2R5MS5pbW1vdmFibGUgJiYgIWJvZHkyLmltbW92YWJsZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwICo9IDAuNTsKCiAgICAgICAgICAgICAgICAgICAgYm9keTEueSA9IGJvZHkxLnkgLSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnkgKz0gdGhpcy5fb3ZlcmxhcDsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkxID0gTWF0aC5zcXJ0KCh0aGlzLl92ZWxvY2l0eTIgKiB0aGlzLl92ZWxvY2l0eTIgKiBib2R5Mi5tYXNzKSAvIGJvZHkxLm1hc3MpICogKCh0aGlzLl92ZWxvY2l0eTIgPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkyID0gTWF0aC5zcXJ0KCh0aGlzLl92ZWxvY2l0eTEgKiB0aGlzLl92ZWxvY2l0eTEgKiBib2R5MS5tYXNzKSAvIGJvZHkyLm1hc3MpICogKCh0aGlzLl92ZWxvY2l0eTEgPiAwKSA/IDEgOiAtMSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fYXZlcmFnZSA9ICh0aGlzLl9uZXdWZWxvY2l0eTEgKyB0aGlzLl9uZXdWZWxvY2l0eTIpICogMC41OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX25ld1ZlbG9jaXR5MSAtPSB0aGlzLl9hdmVyYWdlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX25ld1ZlbG9jaXR5MiAtPSB0aGlzLl9hdmVyYWdlOwoKICAgICAgICAgICAgICAgICAgICBib2R5MS52ZWxvY2l0eS55ID0gdGhpcy5fYXZlcmFnZSArIHRoaXMuX25ld1ZlbG9jaXR5MSAqIGJvZHkxLmJvdW5jZS55OwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnZlbG9jaXR5LnkgPSB0aGlzLl9hdmVyYWdlICsgdGhpcy5fbmV3VmVsb2NpdHkyICogYm9keTIuYm91bmNlLnk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICghYm9keTEuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnkgPSBib2R5MS55IC0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgICAgICBib2R5MS52ZWxvY2l0eS55ID0gdGhpcy5fdmVsb2NpdHkyIC0gdGhpcy5fdmVsb2NpdHkxICogYm9keTEuYm91bmNlLnk7CgogICAgICAgICAgICAgICAgICAgIC8vICBUaGlzIGlzIHNwZWNpYWwgY2FzZSBjb2RlIHRoYXQgaGFuZGxlcyB0aGluZ3MgbGlrZSBob3Jpem9udGFsIG1vdmluZyBwbGF0Zm9ybXMgeW91IGNhbiByaWRlCiAgICAgICAgICAgICAgICAgICAgaWYgKGJvZHkyLmFjdGl2ZSAmJiBib2R5Mi5tb3ZlcyAmJiAoYm9keTEuZGVsdGFZKCkgPiBib2R5Mi5kZWx0YVkoKSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBib2R5MS54ICs9IGJvZHkyLnggLSBib2R5Mi5sYXN0WDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICghYm9keTIuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkyLnkgKz0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgICAgICBib2R5Mi52ZWxvY2l0eS55ID0gdGhpcy5fdmVsb2NpdHkxIC0gdGhpcy5fdmVsb2NpdHkyICogYm9keTIuYm91bmNlLnk7CgogICAgICAgICAgICAgICAgICAgIC8vICBUaGlzIGlzIHNwZWNpYWwgY2FzZSBjb2RlIHRoYXQgaGFuZGxlcyB0aGluZ3MgbGlrZSBob3Jpem9udGFsIG1vdmluZyBwbGF0Zm9ybXMgeW91IGNhbiByaWRlCiAgICAgICAgICAgICAgICAgICAgaWYgKGJvZHkxLnNwcml0ZS5hY3RpdmUgJiYgYm9keTEubW92ZXMgJiYgKGJvZHkxLmRlbHRhWSgpIDwgYm9keTIuZGVsdGFZKCkpKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgYm9keTIueCArPSBib2R5MS54IC0gYm9keTEubGFzdFg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgYSBwaHlzaWNzIGJvZHkgYW5kIGEgdGlsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2VwYXJhdGVUaWxlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkxIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5UaWxlfSB0aWxlIC0gVGhlIHRpbGUgdG8gY29sbGlkZSBhZ2FpbnN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBib2RpZXMgd2VyZSBzZXBhcmF0ZWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBzZXBhcmF0ZVRpbGU6IGZ1bmN0aW9uIChib2R5LCB0aWxlKSB7CgogICAgICAgIHRoaXMuX3Jlc3VsdCA9ICh0aGlzLnNlcGFyYXRlVGlsZVgoYm9keSwgdGlsZSwgdHJ1ZSkgfHwgdGhpcy5zZXBhcmF0ZVRpbGVZKGJvZHksIHRpbGUsIHRydWUpKTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBzZXBhcmF0aW9uIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIGEgcGh5c2ljcyBib2R5IGFuZCBhIHRpbGUgb24gdGhlIHggYXhpcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2VwYXJhdGVUaWxlWAogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZX0gdGlsZSAtIFRoZSB0aWxlIHRvIGNvbGxpZGUgYWdhaW5zdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9kaWVzIHdlcmUgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGVUaWxlWDogZnVuY3Rpb24gKGJvZHksIHRpbGUsIHNlcGFyYXRlKSB7CgogICAgICAgIC8vICBDYW4ndCBzZXBhcmF0ZSB0d28gaW1tb3ZhYmxlIG9iamVjdHMgKHRpbGVzIGFyZSBhbHdheXMgaW1tb3ZhYmxlKQogICAgICAgIGlmIChib2R5LmltbW92YWJsZSB8fCBib2R5LmRlbHRhWCgpID09IDAgfHwgUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKGJvZHkuaHVsbFgsIHRpbGUpID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CgogICAgICAgIC8vICBUaGUgaHVsbHMgb3ZlcmxhcCwgbGV0J3MgcHJvY2VzcyBpdAogICAgICAgIC8vIHRoaXMuX21heE92ZXJsYXAgPSBib2R5LmRlbHRhQWJzWCgpICsgdGhpcy5PVkVSTEFQX0JJQVM7CgogICAgICAgIGlmIChib2R5LmRlbHRhWCgpIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBNb3ZpbmcgbGVmdAogICAgICAgICAgICB0aGlzLl9vdmVybGFwID0gdGlsZS5yaWdodCAtIGJvZHkuaHVsbFgueDsKCiAgICAgICAgICAgIC8vIGlmICgodGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkuYWxsb3dDb2xsaXNpb24ubGVmdCA9PSBmYWxzZSB8fCB0aWxlLnRpbGUuY29sbGlkZVJpZ2h0ID09IGZhbHNlKQogICAgICAgICAgICBpZiAoYm9keS5hbGxvd0NvbGxpc2lvbi5sZWZ0ID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlUmlnaHQgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS50b3VjaGluZy5sZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgTW92aW5nIHJpZ2h0CiAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSBib2R5Lmh1bGxYLnJpZ2h0IC0gdGlsZS54OwoKICAgICAgICAgICAgLy8gaWYgKCh0aGlzLl9vdmVybGFwID4gdGhpcy5fbWF4T3ZlcmxhcCkgfHwgYm9keS5hbGxvd0NvbGxpc2lvbi5yaWdodCA9PSBmYWxzZSB8fCB0aWxlLnRpbGUuY29sbGlkZUxlZnQgPT0gZmFsc2UpCiAgICAgICAgICAgIGlmIChib2R5LmFsbG93Q29sbGlzaW9uLnJpZ2h0ID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlTGVmdCA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5LnRvdWNoaW5nLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIFRoZW4gYWRqdXN0IHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmRpbmdseSAoaWYgdGhlcmUgd2FzIGFueSBvdmVybGFwKQogICAgICAgIGlmICh0aGlzLl9vdmVybGFwICE9IDApCiAgICAgICAgewogICAgICAgICAgICBpZiAoc2VwYXJhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChib2R5LmRlbHRhWCgpIDwgMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5LnggPSBib2R5LnggKyB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkueCA9IGJvZHkueCAtIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGJvZHkuYm91bmNlLnggPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5LnZlbG9jaXR5LnggPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkudmVsb2NpdHkueCA9IC1ib2R5LnZlbG9jaXR5LnggKiBib2R5LmJvdW5jZS54OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJvZHkudXBkYXRlSHVsbHMoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSBhIHBoeXNpY3MgYm9keSBhbmQgYSB0aWxlIG9uIHRoZSB4IGF4aXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlVGlsZVkKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTEgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlRpbGV9IHRpbGUgLSBUaGUgdGlsZSB0byBjb2xsaWRlIGFnYWluc3QuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlVGlsZVk6IGZ1bmN0aW9uIChib2R5LCB0aWxlLCBzZXBhcmF0ZSkgewoKICAgICAgICAvLyAgQ2FuJ3Qgc2VwYXJhdGUgdHdvIGltbW92YWJsZSBvYmplY3RzICh0aWxlcyBhcmUgYWx3YXlzIGltbW92YWJsZSkKICAgICAgICBpZiAoYm9keS5pbW1vdmFibGUgfHwgYm9keS5kZWx0YVkoKSA9PSAwIHx8IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyhib2R5Lmh1bGxZLCB0aWxlKSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwoKICAgICAgICAvLyAgVGhlIGh1bGxzIG92ZXJsYXAsIGxldCdzIHByb2Nlc3MgaXQKICAgICAgICAvLyB0aGlzLl9tYXhPdmVybGFwID0gYm9keS5kZWx0YUFic1koKSArIHRoaXMuT1ZFUkxBUF9CSUFTOwoKICAgICAgICBpZiAoYm9keS5kZWx0YVkoKSA8IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgTW92aW5nIHVwCiAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSB0aWxlLmJvdHRvbSAtIGJvZHkuaHVsbFkueTsKCiAgICAgICAgICAgIC8vIGlmICgodGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkuYWxsb3dDb2xsaXNpb24udXAgPT0gZmFsc2UgfHwgdGlsZS50aWxlLmNvbGxpZGVEb3duID09IGZhbHNlKQogICAgICAgICAgICBpZiAoYm9keS5hbGxvd0NvbGxpc2lvbi51cCA9PSBmYWxzZSB8fCB0aWxlLnRpbGUuY29sbGlkZURvd24gPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS50b3VjaGluZy51cCA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE1vdmluZyBkb3duCiAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSBib2R5Lmh1bGxZLmJvdHRvbSAtIHRpbGUueTsKCiAgICAgICAgICAgIC8vIGlmICgodGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkuYWxsb3dDb2xsaXNpb24uZG93biA9PSBmYWxzZSB8fCB0aWxlLnRpbGUuY29sbGlkZVVwID09IGZhbHNlKQogICAgICAgICAgICBpZiAoYm9keS5hbGxvd0NvbGxpc2lvbi5kb3duID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlVXAgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgYm9keS50b3VjaGluZy5kb3duID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gIFRoZW4gYWRqdXN0IHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmRpbmdseSAoaWYgdGhlcmUgd2FzIGFueSBvdmVybGFwKQogICAgICAgIGlmICh0aGlzLl9vdmVybGFwICE9IDApCiAgICAgICAgewogICAgICAgICAgICBpZiAoc2VwYXJhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChib2R5LmRlbHRhWSgpIDwgMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5LnkgPSBib2R5LnkgKyB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkueSA9IGJvZHkueSAtIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKGJvZHkuYm91bmNlLnkgPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBib2R5LnZlbG9jaXR5LnkgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkudmVsb2NpdHkueSA9IC1ib2R5LnZlbG9jaXR5LnkgKiBib2R5LmJvdW5jZS55OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGJvZHkudXBkYXRlSHVsbHMoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogTW92ZSB0aGUgZ2l2ZW4gZGlzcGxheSBvYmplY3QgdG93YXJkcyB0aGUgZGVzdGluYXRpb24gb2JqZWN0IGF0IGEgc3RlYWR5IHZlbG9jaXR5LgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIG1heFRpbWUgdGhlbiBpdCB3aWxsIGFkanVzdCB0aGUgc3BlZWQgKG92ZXItd3JpdGluZyB3aGF0IHlvdSBzZXQpIHNvIGl0IGFycml2ZXMgYXQgdGhlIGRlc3RpbmF0aW9uIGluIHRoYXQgbnVtYmVyIG9mIHNlY29uZHMuCiAgICAqIFRpbWluZ3MgYXJlIGFwcHJveGltYXRlIGR1ZSB0byB0aGUgd2F5IGJyb3dzZXIgdGltZXJzIHdvcmsuIEFsbG93IGZvciBhIHZhcmlhbmNlIG9mICstIDUwbXMuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogTm90ZTogRG9lc24ndCB0YWtlIGludG8gYWNjb3VudCBhY2NlbGVyYXRpb24sIG1heFZlbG9jaXR5IG9yIGRyYWcgKGlmIHlvdSd2ZSBzZXQgZHJhZyBvciBhY2NlbGVyYXRpb24gdG9vIGhpZ2ggdGhpcyBvYmplY3QgbWF5IG5vdCBtb3ZlIGF0IGFsbCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI21vdmVUb09iamVjdAogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge2FueX0gZGVzdGluYXRpb24gLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZSB0b3dhcmRzLiBDYW4gYmUgYW55IG9iamVjdCBidXQgbXVzdCBoYXZlIHZpc2libGUgeC95IHByb3BlcnRpZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgKGRlZmF1bHQgaXMgNjAgcGl4ZWxzL3NlYykKICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhUaW1lPTBdIC0gVGltZSBnaXZlbiBpbiBtaWxsaXNlY29uZHMgKDEwMDAgPSAxIHNlYykuIElmIHNldCB0aGUgc3BlZWQgaXMgYWRqdXN0ZWQgc28gdGhlIG9iamVjdCB3aWxsIGFycml2ZSBhdCBkZXN0aW5hdGlvbiBpbiB0aGUgZ2l2ZW4gbnVtYmVyIG9mIG1zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB2ZWxvY2l0eS4KICAgICovCiAgICBtb3ZlVG9PYmplY3Q6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbiwgc3BlZWQsIG1heFRpbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4VGltZSA9PT0gJ3VuZGVmaW5lZCcpIHsgbWF4VGltZSA9IDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSBNYXRoLmF0YW4yKGRlc3RpbmF0aW9uLnkgLSBkaXNwbGF5T2JqZWN0LnksIGRlc3RpbmF0aW9uLnggLSBkaXNwbGF5T2JqZWN0LngpOwogICAgICAgIAogICAgICAgIGlmIChtYXhUaW1lID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBrbm93IGhvdyBtYW55IHBpeGVscyB3ZSBuZWVkIHRvIG1vdmUsIGJ1dCBob3cgZmFzdD8KICAgICAgICAgICAgc3BlZWQgPSB0aGlzLmRpc3RhbmNlQmV0d2VlbihkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbikgLyAobWF4VGltZSAvIDEwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS55ID0gTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQ7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBnaXZlbiBkaXNwbGF5IG9iamVjdCB0b3dhcmRzIHRoZSBwb2ludGVyIGF0IGEgc3RlYWR5IHZlbG9jaXR5LiBJZiBubyBwb2ludGVyIGlzIGdpdmVuIGl0IHdpbGwgdXNlIFBoYXNlci5JbnB1dC5hY3RpdmVQb2ludGVyLgogICAgKiBJZiB5b3Ugc3BlY2lmeSBhIG1heFRpbWUgdGhlbiBpdCB3aWxsIGFkanVzdCB0aGUgc3BlZWQgKG92ZXItd3JpdGluZyB3aGF0IHlvdSBzZXQpIHNvIGl0IGFycml2ZXMgYXQgdGhlIGRlc3RpbmF0aW9uIGluIHRoYXQgbnVtYmVyIG9mIHNlY29uZHMuCiAgICAqIFRpbWluZ3MgYXJlIGFwcHJveGltYXRlIGR1ZSB0byB0aGUgd2F5IGJyb3dzZXIgdGltZXJzIHdvcmsuIEFsbG93IGZvciBhIHZhcmlhbmNlIG9mICstIDUwbXMuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI21vdmVUb1BvaW50ZXIKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCAoZGVmYXVsdCBpcyA2MCBwaXhlbHMvc2VjKQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBUaGUgcG9pbnRlciB0byBtb3ZlIHRvd2FyZHMuIERlZmF1bHRzIHRvIFBoYXNlci5JbnB1dC5hY3RpdmVQb2ludGVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFRpbWU9MF0gLSBUaW1lIGdpdmVuIGluIG1pbGxpc2Vjb25kcyAoMTAwMCA9IDEgc2VjKS4gSWYgc2V0IHRoZSBzcGVlZCBpcyBhZGp1c3RlZCBzbyB0aGUgb2JqZWN0IHdpbGwgYXJyaXZlIGF0IGRlc3RpbmF0aW9uIGluIHRoZSBnaXZlbiBudW1iZXIgb2YgbXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHZlbG9jaXR5LgogICAgKi8KICAgIG1vdmVUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBzcGVlZCwgcG9pbnRlciwgbWF4VGltZSkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7CiAgICAgICAgaWYgKHR5cGVvZiBtYXhUaW1lID09PSAndW5kZWZpbmVkJykgeyBtYXhUaW1lID0gMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVUb1BvaW50ZXIoZGlzcGxheU9iamVjdCwgcG9pbnRlcik7CiAgICAgICAgCiAgICAgICAgaWYgKG1heFRpbWUgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdlIGtub3cgaG93IG1hbnkgcGl4ZWxzIHdlIG5lZWQgdG8gbW92ZSwgYnV0IGhvdyBmYXN0PwogICAgICAgICAgICBzcGVlZCA9IHRoaXMuZGlzdGFuY2VUb1BvaW50ZXIoZGlzcGxheU9iamVjdCwgcG9pbnRlcikgLyAobWF4VGltZSAvIDEwMDApOwogICAgICAgIH0KICAgICAgICAKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueCA9IE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS55ID0gTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQ7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBnaXZlbiBkaXNwbGF5IG9iamVjdCB0b3dhcmRzIHRoZSB4L3kgY29vcmRpbmF0ZXMgYXQgYSBzdGVhZHkgdmVsb2NpdHkuCiAgICAqIElmIHlvdSBzcGVjaWZ5IGEgbWF4VGltZSB0aGVuIGl0IHdpbGwgYWRqdXN0IHRoZSBzcGVlZCAob3Zlci13cml0aW5nIHdoYXQgeW91IHNldCkgc28gaXQgYXJyaXZlcyBhdCB0aGUgZGVzdGluYXRpb24gaW4gdGhhdCBudW1iZXIgb2Ygc2Vjb25kcy4KICAgICogVGltaW5ncyBhcmUgYXBwcm94aW1hdGUgZHVlIHRvIHRoZSB3YXkgYnJvd3NlciB0aW1lcnMgd29yay4gQWxsb3cgZm9yIGEgdmFyaWFuY2Ugb2YgKy0gNTBtcy4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiBOb3RlOiBEb2Vzbid0IHRha2UgaW50byBhY2NvdW50IGFjY2VsZXJhdGlvbiwgbWF4VmVsb2NpdHkgb3IgZHJhZyAoaWYgeW91J3ZlIHNldCBkcmFnIG9yIGFjY2VsZXJhdGlvbiB0b28gaGlnaCB0aGlzIG9iamVjdCBtYXkgbm90IG1vdmUgYXQgYWxsKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjbW92ZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCAoZGVmYXVsdCBpcyA2MCBwaXhlbHMvc2VjKQogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFRpbWU9MF0gLSBUaW1lIGdpdmVuIGluIG1pbGxpc2Vjb25kcyAoMTAwMCA9IDEgc2VjKS4gSWYgc2V0IHRoZSBzcGVlZCBpcyBhZGp1c3RlZCBzbyB0aGUgb2JqZWN0IHdpbGwgYXJyaXZlIGF0IGRlc3RpbmF0aW9uIGluIHRoZSBnaXZlbiBudW1iZXIgb2YgbXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHZlbG9jaXR5LgogICAgKi8KICAgIG1vdmVUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSwgc3BlZWQsIG1heFRpbWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4VGltZSA9PT0gJ3VuZGVmaW5lZCcpIHsgbWF4VGltZSA9IDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSBNYXRoLmF0YW4yKHkgLSBkaXNwbGF5T2JqZWN0LnksIHggLSBkaXNwbGF5T2JqZWN0LngpOwogICAgICAgIAogICAgICAgIGlmIChtYXhUaW1lID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBrbm93IGhvdyBtYW55IHBpeGVscyB3ZSBuZWVkIHRvIG1vdmUsIGJ1dCBob3cgZmFzdD8KICAgICAgICAgICAgc3BlZWQgPSB0aGlzLmRpc3RhbmNlVG9YWShkaXNwbGF5T2JqZWN0LCB4LCB5KSAvIChtYXhUaW1lIC8gMTAwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS54ID0gTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQ7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnkgPSBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIHRoZSBhbmdsZSAoaW4gZGVncmVlcykgYW5kIHNwZWVkIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYW5kIHJldHVybiBpdCBhcyBhIFBvaW50IG9iamVjdCwgb3Igc2V0IGl0IHRvIHRoZSBnaXZlbiBwb2ludCBvYmplY3QuCiAgICAqIE9uZSB3YXkgdG8gdXNlIHRoaXMgaXM6IHZlbG9jaXR5RnJvbUFuZ2xlKGFuZ2xlLCAyMDAsIHNwcml0ZS52ZWxvY2l0eSkgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyB2ZWxvY2l0eSBhbmQgbm90IGNyZWF0ZSBhIG5ldyBQb2ludCBvYmplY3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN2ZWxvY2l0eUZyb21BbmdsZQogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gZGVncmVlcyBjYWxjdWxhdGVkIGluIGNsb2Nrd2lzZSBwb3NpdGl2ZSBkaXJlY3Rpb24gKGRvd24gPSA5MCBkZWdyZWVzIHBvc2l0aXZlLCByaWdodCA9IDAgZGVncmVlcyBwb3NpdGl2ZSwgdXAgPSA5MCBkZWdyZWVzIG5lZ2F0aXZlKQogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IFtwb2ludF0gLSBUaGUgUG9pbnQgb2JqZWN0IGluIHdoaWNoIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgd2lsbCBiZSBzZXQgdG8gdGhlIGNhbGN1bGF0ZWQgdmVsb2NpdHkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIFBvaW50IHdoZXJlIHBvaW50LnggY29udGFpbnMgdGhlIHZlbG9jaXR5IHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIHZlbG9jaXR5IHkgdmFsdWUuCiAgICAqLwogICAgdmVsb2NpdHlGcm9tQW5nbGU6IGZ1bmN0aW9uIChhbmdsZSwgc3BlZWQsIHBvaW50KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3ModGhpcy5nYW1lLm1hdGguZGVnVG9SYWQoYW5nbGUpKSAqIHNwZWVkKSwgKE1hdGguc2luKHRoaXMuZ2FtZS5tYXRoLmRlZ1RvUmFkKGFuZ2xlKSkgKiBzcGVlZCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIHRoZSByb3RhdGlvbiAoaW4gcmFkaWFucykgYW5kIHNwZWVkIGNhbGN1bGF0ZSB0aGUgdmVsb2NpdHkgYW5kIHJldHVybiBpdCBhcyBhIFBvaW50IG9iamVjdCwgb3Igc2V0IGl0IHRvIHRoZSBnaXZlbiBwb2ludCBvYmplY3QuCiAgICAqIE9uZSB3YXkgdG8gdXNlIHRoaXMgaXM6IHZlbG9jaXR5RnJvbVJvdGF0aW9uKHJvdGF0aW9uLCAyMDAsIHNwcml0ZS52ZWxvY2l0eSkgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyB2ZWxvY2l0eSBhbmQgbm90IGNyZWF0ZSBhIG5ldyBQb2ludCBvYmplY3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN2ZWxvY2l0eUZyb21Sb3RhdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBbcG9pbnRdIC0gVGhlIFBvaW50IG9iamVjdCBpbiB3aGljaCB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0IHRvIHRoZSBjYWxjdWxhdGVkIHZlbG9jaXR5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IC0gQSBQb2ludCB3aGVyZSBwb2ludC54IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB4IHZhbHVlIGFuZCBwb2ludC55IGNvbnRhaW5zIHRoZSB2ZWxvY2l0eSB5IHZhbHVlLgogICAgKi8KICAgIHZlbG9jaXR5RnJvbVJvdGF0aW9uOiBmdW5jdGlvbiAocm90YXRpb24sIHNwZWVkLCBwb2ludCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgcG9pbnQgPSBwb2ludCB8fCBuZXcgUGhhc2VyLlBvaW50OwoKICAgICAgICByZXR1cm4gcG9pbnQuc2V0VG8oKE1hdGguY29zKHJvdGF0aW9uKSAqIHNwZWVkKSwgKE1hdGguc2luKHJvdGF0aW9uKSAqIHNwZWVkKSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gdGhlIHJvdGF0aW9uIChpbiByYWRpYW5zKSBhbmQgc3BlZWQgY2FsY3VsYXRlIHRoZSBhY2NlbGVyYXRpb24gYW5kIHJldHVybiBpdCBhcyBhIFBvaW50IG9iamVjdCwgb3Igc2V0IGl0IHRvIHRoZSBnaXZlbiBwb2ludCBvYmplY3QuCiAgICAqIE9uZSB3YXkgdG8gdXNlIHRoaXMgaXM6IHZlbG9jaXR5RnJvbVJvdGF0aW9uKHJvdGF0aW9uLCAyMDAsIHNwcml0ZS52ZWxvY2l0eSkgd2hpY2ggd2lsbCBzZXQgdGhlIHZhbHVlcyBkaXJlY3RseSB0byB0aGUgc3ByaXRlcyB2ZWxvY2l0eSBhbmQgbm90IGNyZWF0ZSBhIG5ldyBQb2ludCBvYmplY3QuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRpb25Gcm9tUm90YXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHJvdGF0aW9uIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fG9iamVjdH0gW3BvaW50XSAtIFRoZSBQb2ludCBvYmplY3QgaW4gd2hpY2ggdGhlIHggYW5kIHkgcHJvcGVydGllcyB3aWxsIGJlIHNldCB0byB0aGUgY2FsY3VsYXRlZCBhY2NlbGVyYXRpb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIFBvaW50IHdoZXJlIHBvaW50LnggY29udGFpbnMgdGhlIGFjY2VsZXJhdGlvbiB4IHZhbHVlIGFuZCBwb2ludC55IGNvbnRhaW5zIHRoZSBhY2NlbGVyYXRpb24geSB2YWx1ZS4KICAgICovCiAgICBhY2NlbGVyYXRpb25Gcm9tUm90YXRpb246IGZ1bmN0aW9uIChyb3RhdGlvbiwgc3BlZWQsIHBvaW50KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3Mocm90YXRpb24pICogc3BlZWQpLCAoTWF0aC5zaW4ocm90YXRpb24pICogc3BlZWQpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBhY2NlbGVyYXRpb24ueC95IHByb3BlcnR5IG9uIHRoZSBkaXNwbGF5IG9iamVjdCBzbyBpdCB3aWxsIG1vdmUgdG93YXJkcyB0aGUgdGFyZ2V0IGF0IHRoZSBnaXZlbiBzcGVlZCAoaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuKQogICAgKiBZb3UgbXVzdCBnaXZlIGEgbWF4aW11bSBzcGVlZCB2YWx1ZSwgYmV5b25kIHdoaWNoIHRoZSBkaXNwbGF5IG9iamVjdCB3b24ndCBnbyBhbnkgZmFzdGVyLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRlVG9PYmplY3QKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHthbnl9IGRlc3RpbmF0aW9uIC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUgdG93YXJkcy4gQ2FuIGJlIGFueSBvYmplY3QgYnV0IG11c3QgaGF2ZSB2aXNpYmxlIHgveSBwcm9wZXJ0aWVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIGFjY2VsZXJhdGUgaW4gcGl4ZWxzIHBlciBzZWNvbmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeFNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB4IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeVNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB5IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHRyYWplY3RvcnkuCiAgICAqLwogICAgYWNjZWxlcmF0ZVRvT2JqZWN0OiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgZGVzdGluYXRpb24sIHNwZWVkLCB4U3BlZWRNYXgsIHlTcGVlZE1heCkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB4U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHhTcGVlZE1heCA9IDEwMDA7IH0KICAgICAgICBpZiAodHlwZW9mIHlTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeVNwZWVkTWF4ID0gMTAwMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVCZXR3ZWVuKGRpc3BsYXlPYmplY3QsIGRlc3RpbmF0aW9uKTsKCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LmFjY2VsZXJhdGlvbi5zZXRUbyhNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZCwgTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQpOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5tYXhWZWxvY2l0eS5zZXRUbyh4U3BlZWRNYXgsIHlTcGVlZE1heCk7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBhY2NlbGVyYXRpb24ueC95IHByb3BlcnR5IG9uIHRoZSBkaXNwbGF5IG9iamVjdCBzbyBpdCB3aWxsIG1vdmUgdG93YXJkcyB0aGUgdGFyZ2V0IGF0IHRoZSBnaXZlbiBzcGVlZCAoaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuKQogICAgKiBZb3UgbXVzdCBnaXZlIGEgbWF4aW11bSBzcGVlZCB2YWx1ZSwgYmV5b25kIHdoaWNoIHRoZSBkaXNwbGF5IG9iamVjdCB3b24ndCBnbyBhbnkgZmFzdGVyLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBwb2ludGVyIHRvIG1vdmUgdG93YXJkcy4gRGVmYXVsdHMgdG8gUGhhc2VyLklucHV0LmFjdGl2ZVBvaW50ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgYWNjZWxlcmF0ZSBpbiBwaXhlbHMgcGVyIHNlY29uZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHggdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHkgdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdHJhamVjdG9yeS4KICAgICovCiAgICBhY2NlbGVyYXRlVG9Qb2ludGVyOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgcG9pbnRlciwgc3BlZWQsIHhTcGVlZE1heCwgeVNwZWVkTWF4KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIHBvaW50ZXIgPT09ICd1bmRlZmluZWQnKSB7IHBvaW50ZXIgPSB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlcjsgfQogICAgICAgIGlmICh0eXBlb2YgeFNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB4U3BlZWRNYXggPSAxMDAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHlTcGVlZE1heCA9IDEwMDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSB0aGlzLmFuZ2xlVG9Qb2ludGVyKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpOwogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5hY2NlbGVyYXRpb24uc2V0VG8oTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQsIE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkKTsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkubWF4VmVsb2NpdHkuc2V0VG8oeFNwZWVkTWF4LCB5U3BlZWRNYXgpOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYWNjZWxlcmF0aW9uLngveSBwcm9wZXJ0eSBvbiB0aGUgZGlzcGxheSBvYmplY3Qgc28gaXQgd2lsbCBtb3ZlIHRvd2FyZHMgdGhlIHgveSBjb29yZGluYXRlcyBhdCB0aGUgZ2l2ZW4gc3BlZWQgKGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLikKICAgICogWW91IG11c3QgZ2l2ZSBhIG1heGltdW0gc3BlZWQgdmFsdWUsIGJleW9uZCB3aGljaCB0aGUgZGlzcGxheSBvYmplY3Qgd29uJ3QgZ28gYW55IGZhc3Rlci4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYWNjZWxlcmF0ZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGFjY2VsZXJhdGUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGFjY2VsZXJhdGUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBhY2NlbGVyYXRlIGluIHBpeGVscyBwZXIgc2Vjb25kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geCB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3lTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geSB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB0cmFqZWN0b3J5LgogICAgKi8KICAgIGFjY2VsZXJhdGVUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSwgc3BlZWQsIHhTcGVlZE1heCwgeVNwZWVkTWF4KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIHhTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeFNwZWVkTWF4ID0gMTAwMDsgfQogICAgICAgIGlmICh0eXBlb2YgeVNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB5U3BlZWRNYXggPSAxMDAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gdGhpcy5hbmdsZVRvWFkoZGlzcGxheU9iamVjdCwgeCwgeSk7CgogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5hY2NlbGVyYXRpb24uc2V0VG8oTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQsIE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkKTsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkubWF4VmVsb2NpdHkuc2V0VG8oeFNwZWVkTWF4LCB5U3BlZWRNYXgpOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0d28gZGlzcGxheSBvYmplY3RzIChsaWtlIFNwcml0ZXMpLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjZGlzdGFuY2VCZXR3ZWVuCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge2FueX0gdGFyZ2V0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgdG8uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIHNvdXJjZSBhbmQgdGFyZ2V0IG9iamVjdHMuCiAgICAqLwogICAgZGlzdGFuY2VCZXR3ZWVuOiBmdW5jdGlvbiAoc291cmNlLCB0YXJnZXQpIHsKCiAgICAgICAgdGhpcy5fZHggPSBzb3VyY2UueCAtIHRhcmdldC54OwogICAgICAgIHRoaXMuX2R5ID0gc291cmNlLnkgLSB0YXJnZXQueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzLgogICAgKiBUaGUgY2FsY3VsYXRpb24gaXMgbWFkZSBmcm9tIHRoZSBkaXNwbGF5IG9iamVjdHMgeC95IGNvb3JkaW5hdGUuIFRoaXMgbWF5IGJlIHRoZSB0b3AtbGVmdCBpZiBpdHMgYW5jaG9yIGhhc24ndCBiZWVuIGNoYW5nZWQuCiAgICAqIElmIHlvdSBuZWVkIHRvIGNhbGN1bGF0ZSBmcm9tIHRoZSBjZW50ZXIgb2YgYSBkaXNwbGF5IG9iamVjdCBpbnN0ZWFkIHVzZSB0aGUgbWV0aG9kIGRpc3RhbmNlQmV0d2VlbkNlbnRlcnMoKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjZGlzdGFuY2VUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIG1vdmUgdG93YXJkcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgb2JqZWN0IGFuZCB0aGUgeC95IGNvb3JkaW5hdGVzLgogICAgKi8KICAgIGRpc3RhbmNlVG9YWTogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHgsIHkpIHsKCiAgICAgICAgdGhpcy5fZHggPSBkaXNwbGF5T2JqZWN0LnggLSB4OwogICAgICAgIHRoaXMuX2R5ID0gZGlzcGxheU9iamVjdC55IC0geTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCBhIFBvaW50ZXIuIElmIG5vIFBvaW50ZXIgaXMgZ2l2ZW4gdGhlIElucHV0LmFjdGl2ZVBvaW50ZXIgaXMgdXNlZC4KICAgICogVGhlIGNhbGN1bGF0aW9uIGlzIG1hZGUgZnJvbSB0aGUgZGlzcGxheSBvYmplY3RzIHgveSBjb29yZGluYXRlLiBUaGlzIG1heSBiZSB0aGUgdG9wLWxlZnQgaWYgaXRzIGFuY2hvciBoYXNuJ3QgYmVlbiBjaGFuZ2VkLgogICAgKiBJZiB5b3UgbmVlZCB0byBjYWxjdWxhdGUgZnJvbSB0aGUgY2VudGVyIG9mIGEgZGlzcGxheSBvYmplY3QgaW5zdGVhZCB1c2UgdGhlIG1ldGhvZCBkaXN0YW5jZUJldHdlZW5DZW50ZXJzKCkKICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2Rpc3RhbmNlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gW3BvaW50ZXJdIC0gVGhlIFBoYXNlci5Qb2ludGVyIHRvIHRlc3QgdG8uIElmIG5vbmUgaXMgZ2l2ZW4gdGhlbiBJbnB1dC5hY3RpdmVQb2ludGVyIGlzIHVzZWQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhlIG9iamVjdCBhbmQgdGhlIFBvaW50ZXIuCiAgICAqLwogICAgZGlzdGFuY2VUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBwb2ludGVyKSB7CgogICAgICAgIHBvaW50ZXIgPSBwb2ludGVyIHx8IHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyOwoKICAgICAgICB0aGlzLl9keCA9IGRpc3BsYXlPYmplY3QueCAtIHBvaW50ZXIueDsKICAgICAgICB0aGlzLl9keSA9IGRpc3BsYXlPYmplY3QueSAtIHBvaW50ZXIueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5zcXJ0KHRoaXMuX2R4ICogdGhpcy5fZHggKyB0aGlzLl9keSAqIHRoaXMuX2R5KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gdHdvIGRpc3BsYXkgb2JqZWN0cyAobGlrZSBTcHJpdGVzKS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FuZ2xlQmV0d2VlbgogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHthbnl9IHRhcmdldCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IHRvLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gdGhlIHNvdXJjZSBhbmQgdGFyZ2V0IGRpc3BsYXkgb2JqZWN0cy4KICAgICovCiAgICBhbmdsZUJldHdlZW46IGZ1bmN0aW9uIChzb3VyY2UsIHRhcmdldCkgewoKICAgICAgICB0aGlzLl9keCA9IHRhcmdldC54IC0gc291cmNlLng7CiAgICAgICAgdGhpcy5fZHkgPSB0YXJnZXQueSAtIHNvdXJjZS55OwoKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLl9keSwgdGhpcy5fZHgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiBhIGRpc3BsYXkgb2JqZWN0IChsaWtlIGEgU3ByaXRlKSBhbmQgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYW5nbGVUb1hZCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGdldCB0aGUgYW5nbGUgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBnZXQgdGhlIGFuZ2xlIHRvLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gZGlzcGxheU9iamVjdC54L3kgdG8gUG9pbnRlci54L3kKICAgICovCiAgICBhbmdsZVRvWFk6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCB4LCB5KSB7CgogICAgICAgIHRoaXMuX2R4ID0geCAtIGRpc3BsYXlPYmplY3QueDsKICAgICAgICB0aGlzLl9keSA9IHkgLSBkaXNwbGF5T2JqZWN0Lnk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIodGhpcy5fZHksIHRoaXMuX2R4KTsKCiAgICB9LAogICAgCiAgICAvKioKICAgICogRmluZCB0aGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCBhIFBvaW50ZXIsIHRha2luZyB0aGVpciB4L3kgYW5kIGNlbnRlciBpbnRvIGFjY291bnQuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhbmdsZVRvUG9pbnRlcgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBQaGFzZXIuUG9pbnRlciB0byB0ZXN0IHRvLiBJZiBub25lIGlzIGdpdmVuIHRoZW4gSW5wdXQuYWN0aXZlUG9pbnRlciBpcyB1c2VkLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gZGlzcGxheU9iamVjdC54L3kgdG8gUG9pbnRlci54L3kKICAgICovCiAgICBhbmdsZVRvUG9pbnRlcjogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7CgogICAgICAgIHRoaXMuX2R4ID0gcG9pbnRlci53b3JsZFggLSBkaXNwbGF5T2JqZWN0Lng7CiAgICAgICAgdGhpcy5fZHkgPSBwb2ludGVyLndvcmxkWSAtIGRpc3BsYXlPYmplY3QueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLl9keSwgdGhpcy5fZHgpOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgUGh5c2ljcyBCb2R5IGlzIGxpbmtlZCB0byBhIHNpbmdsZSBTcHJpdGUuIEFsbCBwaHlzaWNzIG9wZXJhdGlvbnMgc2hvdWxkIGJlIHBlcmZvcm1lZCBhZ2FpbnN0IHRoZSBib2R5IHJhdGhlciB0aGFuCiogdGhlIFNwcml0ZSBpdHNlbGYuIEZvciBleGFtcGxlIHlvdSBjYW4gc2V0IHRoZSB2ZWxvY2l0eSwgYWNjZWxlcmF0aW9uLCBib3VuY2UgdmFsdWVzIGV0YyBhbGwgb24gdGhlIEJvZHkuCioKKiBAY2xhc3MgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkKKiBAY2xhc3NkZXNjIEFyY2FkZSBQaHlzaWNzIEJvZHkgQ29uc3RydWN0b3IKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBTcHJpdGUgb2JqZWN0IHRoaXMgcGh5c2ljcyBib2R5IGJlbG9uZ3MgdG8uCiovClBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5ID0gZnVuY3Rpb24gKHNwcml0ZSkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFJlZmVyZW5jZSB0byB0aGUgcGFyZW50IFNwcml0ZS4KICAgICovCgl0aGlzLnNwcml0ZSA9IHNwcml0ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KCXRoaXMuZ2FtZSA9IHNwcml0ZS5nYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gb2Zmc2V0IC0gVGhlIG9mZnNldCBvZiB0aGUgUGh5c2ljcyBCb2R5IGZyb20gdGhlIFNwcml0ZSB4L3kgcG9zaXRpb24uCiAgICAqLwoJdGhpcy5vZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB4IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMueCA9IHNwcml0ZS54OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMueSA9IHNwcml0ZS55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJlWCAtIFRoZSBwcmV2aW91cyB4IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMucHJlWCA9IHNwcml0ZS54OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJlWSAtIFRoZSBwcmV2aW91cyB5IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMucHJlWSA9IHNwcml0ZS55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcHJlUm90YXRpb24gLSBUaGUgcHJldmlvdXMgcm90YXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy5wcmVSb3RhdGlvbiA9IHNwcml0ZS5hbmdsZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcmVlblggLSBUaGUgeCBwb3NpdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5IHRyYW5zbGF0ZWQgdG8gc2NyZWVuIHNwYWNlLgogICAgKiBAcmVhZG9ubHkKICAgICovCgl0aGlzLnNjcmVlblggPSBzcHJpdGUueDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcmVlblkgLSBUaGUgeSBwb3NpdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5IHRyYW5zbGF0ZWQgdG8gc2NyZWVuIHNwYWNlLgogICAgKiBAcmVhZG9ubHkKICAgICovCgl0aGlzLnNjcmVlblkgPSBzcHJpdGUueTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNvdXJjZVdpZHRoIC0gVGhlIHVuLXNjYWxlZCBvcmlnaW5hbCBzaXplLgogICAgKiBAcmVhZG9ubHkKICAgICovCgl0aGlzLnNvdXJjZVdpZHRoID0gc3ByaXRlLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplVzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNvdXJjZUhlaWdodCAtIFRoZSB1bi1zY2FsZWQgb3JpZ2luYWwgc2l6ZS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy5zb3VyY2VIZWlnaHQgPSBzcHJpdGUuY3VycmVudEZyYW1lLnNvdXJjZVNpemVIOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgY2FsY3VsYXRlZCB3aWR0aCBvZiB0aGUgcGh5c2ljcyBib2R5LgogICAgKi8KCXRoaXMud2lkdGggPSBzcHJpdGUuY3VycmVudEZyYW1lLnNvdXJjZVNpemVXOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkgLm51bUludGVybmFsIElEIGNhY2hlCiAgICAqLwoJdGhpcy5oZWlnaHQgPSBzcHJpdGUuY3VycmVudEZyYW1lLnNvdXJjZVNpemVIOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGFsZldpZHRoIC0gVGhlIGNhbGN1bGF0ZWQgd2lkdGggLyAyIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqLwoJdGhpcy5oYWxmV2lkdGggPSBNYXRoLmZsb29yKHNwcml0ZS5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcgLyAyKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhhbGZIZWlnaHQgLSBUaGUgY2FsY3VsYXRlZCBoZWlnaHQgLyAyIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqLwoJdGhpcy5oYWxmSGVpZ2h0ID0gTWF0aC5mbG9vcihzcHJpdGUuY3VycmVudEZyYW1lLnNvdXJjZVNpemVIIC8gMik7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBjZW50ZXIgLSBUaGUgY2VudGVyIGNvb3JkaW5hdGUgb2YgdGhlIFBoeXNpY3MgQm9keS4KICAgICovCiAgICB0aGlzLmNlbnRlciA9IG5ldyBQaGFzZXIuUG9pbnQodGhpcy54ICsgdGhpcy5oYWxmV2lkdGgsIHRoaXMueSArIHRoaXMuaGFsZkhlaWdodCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3ggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwoJdGhpcy5fc3ggPSBzcHJpdGUuc2NhbGUueDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zeSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCgl0aGlzLl9zeSA9IHNwcml0ZS5zY2FsZS55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gdmVsb2NpdHkgLSBUaGUgdmVsb2NpdHkgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIG9mIHRoZSBCb2R5LgogICAgKi8KICAgIHRoaXMudmVsb2NpdHkgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYWNjZWxlcmF0aW9uIC0gVGhlIHZlbG9jaXR5IGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLiBvZiB0aGUgQm9keS4KICAgICovCiAgICB0aGlzLmFjY2VsZXJhdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBkcmFnIC0gVGhlIGRyYWcgYXBwbGllZCB0byB0aGUgbW90aW9uIG9mIHRoZSBCb2R5LgogICAgKi8KICAgIHRoaXMuZHJhZyA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBncmF2aXR5IC0gQSBwcml2YXRlIEdyYXZpdHkgc2V0dGluZyBmb3IgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy5ncmF2aXR5ID0gbmV3IFBoYXNlci5Qb2ludDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGJvdW5jZSAtIFRoZSBlbGFzdGljaXRpeSBvZiB0aGUgQm9keSB3aGVuIGNvbGxpZGluZy4gYm91bmNlLngveSA9IDEgbWVhbnMgZnVsbCByZWJvdW5kLCBib3VuY2UueC95ID0gMC41IG1lYW5zIDUwJSByZWJvdW5kIHZlbG9jaXR5LgogICAgKi8KICAgIHRoaXMuYm91bmNlID0gbmV3IFBoYXNlci5Qb2ludDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1heFZlbG9jaXR5IC0gVGhlIG1heGltdW0gdmVsb2NpdHkgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIHRoYXQgdGhlIEJvZHkgY2FuIHJlYWNoLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4VmVsb2NpdHkgPSBuZXcgUGhhc2VyLlBvaW50KDEwMDAwLCAxMDAwMCk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyVmVsb2NpdHkgLSBUaGUgYW5ndWxhciB2ZWxvY2l0eSBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gb2YgdGhlIEJvZHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmd1bGFyVmVsb2NpdHkgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYW5ndWxhckFjY2VsZXJhdGlvbiAtIFRoZSBhbmd1bGFyIGFjY2VsZXJhdGlvbiBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gb2YgdGhlIEJvZHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbmd1bGFyQWNjZWxlcmF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJEcmFnIC0gVGhlIGFuZ3VsYXIgZHJhZyBhcHBsaWVkIHRvIHRoZSByb3RhdGlvbiBvZiB0aGUgQm9keS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZ3VsYXJEcmFnID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEFuZ3VsYXIgLSBUaGUgbWF4aW11bSBhbmd1bGFyIHZlbG9jaXR5IGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLiB0aGF0IHRoZSBCb2R5IGNhbiByZWFjaC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heEFuZ3VsYXIgPSAxMDAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWFzcyAtIFRoZSBtYXNzIG9mIHRoZSBCb2R5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWFzcyA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc2tpcFF1YWRUcmVlIC0gSWYgdGhlIEJvZHkgaXMgYW4gaXJyZWd1bGFyIHNoYXBlIHlvdSBjYW4gc2V0IHRoaXMgdG8gdHJ1ZSB0byBhdm9pZCBpdCBiZWluZyBhZGRlZCB0byB0aGUgV29ybGQgcXVhZCB0cmVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2tpcFF1YWRUcmVlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7QXJyYXl9IHF1YWRUcmVlSURzIC0gSW50ZXJuYWwgSUQgY2FjaGUuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLnF1YWRUcmVlSURzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBxdWFkVHJlZUluZGV4IC0gSW50ZXJuYWwgSUQgY2FjaGUuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB0aGlzLnF1YWRUcmVlSW5kZXggPSAtMTsKCiAgICAvLwlBbGxvdyBjb2xsaXNpb24KCiAgICAvKioKICAgICogU2V0IHRoZSBhbGxvd0NvbGxpc2lvbiBwcm9wZXJ0aWVzIHRvIGNvbnRyb2wgd2hpY2ggZGlyZWN0aW9ucyBjb2xsaXNpb24gaXMgcHJvY2Vzc2VkIGZvciB0aGlzIEJvZHkuCiAgICAqIEZvciBleGFtcGxlIGFsbG93Q29sbGlzaW9uLnVwID0gZmFsc2UgbWVhbnMgaXQgd29uJ3QgY29sbGlkZSB3aGVuIHRoZSBjb2xsaXNpb24gaGFwcGVuZWQgd2hpbGUgbW92aW5nIHVwLgogICAgKiBAcHJvcGVydHkge29iamVjdH0gYWxsb3dDb2xsaXNpb24gLSBBbiBvYmplY3QgY29udGFpbmluZyBhbGxvd2VkIGNvbGxpc2lvbi4KICAgICovCiAgICB0aGlzLmFsbG93Q29sbGlzaW9uID0geyBub25lOiBmYWxzZSwgYW55OiB0cnVlLCB1cDogdHJ1ZSwgZG93bjogdHJ1ZSwgbGVmdDogdHJ1ZSwgcmlnaHQ6IHRydWUgfTsKCiAgICAvKioKICAgICogVGhpcyBvYmplY3QgaXMgcG9wdWxhdGVkIHdpdGggYm9vbGVhbiB2YWx1ZXMgd2hlbiB0aGUgQm9keSBjb2xsaWRlcyB3aXRoIGFub3RoZXIuCiAgICAqIHRvdWNoaW5nLnVwID0gdHJ1ZSBtZWFucyB0aGUgY29sbGlzaW9uIGhhcHBlbmVkIHRvIHRoZSB0b3Agb2YgdGhpcyBCb2R5IGZvciBleGFtcGxlLgogICAgKiBAcHJvcGVydHkge29iamVjdH0gdG91Y2hpbmcgLSBBbiBvYmplY3QgY29udGFpbmluZyB0b3VjaGluZyByZXN1bHRzLgogICAgKi8KICAgIHRoaXMudG91Y2hpbmcgPSB7IG5vbmU6IHRydWUsIHVwOiBmYWxzZSwgZG93bjogZmFsc2UsIGxlZnQ6IGZhbHNlLCByaWdodDogZmFsc2UgfTsKCiAgICAvKioKICAgICogVGhpcyBvYmplY3QgaXMgcG9wdWxhdGVkIHdpdGggcHJldmlvdXMgdG91Y2hpbmcgdmFsdWVzIGZyb20gdGhlIGJvZGllcyBwcmV2aW91cyBjb2xsaXNpb24uCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSB3YXNUb3VjaGluZyAtIEFuIG9iamVjdCBjb250YWluaW5nIHByZXZpb3VzIHRvdWNoaW5nIHJlc3VsdHMuCiAgICAqLwogICAgdGhpcy53YXNUb3VjaGluZyA9IHsgbm9uZTogdHJ1ZSwgdXA6IGZhbHNlLCBkb3duOiBmYWxzZSwgbGVmdDogZmFsc2UsIHJpZ2h0OiBmYWxzZSB9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZmFjaW5nIC0gQSBjb25zdCByZWZlcmVuY2UgdG8gdGhlIGRpcmVjdGlvbiB0aGUgQm9keSBpcyB0cmF2ZWxpbmcgb3IgZmFjaW5nLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZmFjaW5nID0gUGhhc2VyLk5PTkU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW1tb3ZhYmxlIC0gQW4gaW1tb3ZhYmxlIEJvZHkgd2lsbCBub3QgcmVjZWl2ZSBhbnkgaW1wYWN0cyBmcm9tIG90aGVyIGJvZGllcy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmltbW92YWJsZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1vdmVzIC0gU2V0IHRvIHRydWUgdG8gYWxsb3cgdGhlIFBoeXNpY3Mgc3lzdGVtIHRvIG1vdmUgdGhpcyBCb2R5LCBvdGhlciBmYWxzZSB0byBtb3ZlIGl0IG1hbnVhbGx5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubW92ZXMgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW1vdW50IHRoZSBCb2R5IGlzIHJvdGF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5yb3RhdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxsb3dSb3RhdGlvbiAtIEFsbG93IHRoaXMgQm9keSB0byBiZSByb3RhdGVkPyAodmlhIGFuZ3VsYXJWZWxvY2l0eSwgZXRjKQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxsb3dSb3RhdGlvbiA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxsb3dHcmF2aXR5IC0gQWxsb3cgdGhpcyBCb2R5IHRvIGJlIGluZmx1ZW5jZWQgYnkgdGhlIGdsb2JhbCBHcmF2aXR5PwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYWxsb3dHcmF2aXR5ID0gdHJ1ZTsKCiAgICAvKioKICAgICogVGhpcyBmbGFnIGFsbG93cyB5b3UgdG8gZGlzYWJsZSB0aGUgY3VzdG9tIHggc2VwYXJhdGlvbiB0aGF0IHRha2VzIHBsYWNlIGJ5IFBoeXNpY3MuQXJjYWRlLnNlcGFyYXRlLgogICAgKiBVc2VkIGluIGNvbWJpbmF0aW9uIHdpdGggeW91ciBvd24gY29sbGlzaW9uIHByb2Nlc3NIYW5kbGVyIHlvdSBjYW4gY3JlYXRlIHdoYXRldmVyIHR5cGUgb2YgY29sbGlzaW9uIHJlc3BvbnNlIHlvdSBuZWVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGN1c3RvbVNlcGFyYXRlWCAtIFVzZSBhIGN1c3RvbSBzZXBhcmF0aW9uIHN5c3RlbSBvciB0aGUgYnVpbHQtaW4gb25lPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3VzdG9tU2VwYXJhdGVYID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFRoaXMgZmxhZyBhbGxvd3MgeW91IHRvIGRpc2FibGUgdGhlIGN1c3RvbSB5IHNlcGFyYXRpb24gdGhhdCB0YWtlcyBwbGFjZSBieSBQaHlzaWNzLkFyY2FkZS5zZXBhcmF0ZS4KICAgICogVXNlZCBpbiBjb21iaW5hdGlvbiB3aXRoIHlvdXIgb3duIGNvbGxpc2lvbiBwcm9jZXNzSGFuZGxlciB5b3UgY2FuIGNyZWF0ZSB3aGF0ZXZlciB0eXBlIG9mIGNvbGxpc2lvbiByZXNwb25zZSB5b3UgbmVlZC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBjdXN0b21TZXBhcmF0ZVkgLSBVc2UgYSBjdXN0b20gc2VwYXJhdGlvbiBzeXN0ZW0gb3IgdGhlIGJ1aWx0LWluIG9uZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1c3RvbVNlcGFyYXRlWSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBXaGVuIHRoaXMgYm9keSBjb2xsaWRlcyB3aXRoIGFub3RoZXIsIHRoZSBhbW91bnQgb2Ygb3ZlcmxhcCBpcyBzdG9yZWQgaGVyZS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG92ZXJsYXBYIC0gVGhlIGFtb3VudCBvZiBob3Jpem9udGFsIG92ZXJsYXAgZHVyaW5nIHRoZSBjb2xsaXNpb24uCiAgICAqLwogICAgdGhpcy5vdmVybGFwWCA9IDA7CgogICAgLyoqCiAgICAqIFdoZW4gdGhpcyBib2R5IGNvbGxpZGVzIHdpdGggYW5vdGhlciwgdGhlIGFtb3VudCBvZiBvdmVybGFwIGlzIHN0b3JlZCBoZXJlLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gb3ZlcmxhcFkgLSBUaGUgYW1vdW50IG9mIHZlcnRpY2FsIG92ZXJsYXAgZHVyaW5nIHRoZSBjb2xsaXNpb24uCiAgICAqLwogICAgdGhpcy5vdmVybGFwWSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gaHVsbFggLSBUaGUgZHluYW1pY2FsbHkgY2FsY3VsYXRlZCBodWxsIHVzZWQgZHVyaW5nIGNvbGxpc2lvbi4KICAgICovCiAgICB0aGlzLmh1bGxYID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBodWxsWSAtIFRoZSBkeW5hbWljYWxseSBjYWxjdWxhdGVkIGh1bGwgdXNlZCBkdXJpbmcgY29sbGlzaW9uLgogICAgKi8KICAgIHRoaXMuaHVsbFkgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOwoKICAgIC8qKgogICAgKiBJZiBhIGJvZHkgaXMgb3ZlcmxhcHBpbmcgd2l0aCBhbm90aGVyIGJvZHksIGJ1dCBuZWl0aGVyIG9mIHRoZW0gYXJlIG1vdmluZyAobWF5YmUgdGhleSBzcGF3bmVkIG9uLXRvcCBvZiBlYWNoIG90aGVyPykgdGhpcyBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBlbWJlZGRlZCAtIEJvZHkgZW1iZWQgdmFsdWUuCiAgICAqLwogICAgdGhpcy5lbWJlZGRlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBBIEJvZHkgY2FuIGJlIHNldCB0byBjb2xsaWRlIGFnYWluc3QgdGhlIFdvcmxkIGJvdW5kcyBhdXRvbWF0aWNhbGx5IGFuZCByZWJvdW5kIGJhY2sgaW50byB0aGUgV29ybGQgaWYgdGhpcyBpcyBzZXQgdG8gdHJ1ZS4gT3RoZXJ3aXNlIGl0IHdpbGwgbGVhdmUgdGhlIFdvcmxkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVXb3JsZEJvdW5kcyAtIFNob3VsZCB0aGUgQm9keSBjb2xsaWRlIHdpdGggdGhlIFdvcmxkIGJvdW5kcz8KICAgICovCiAgICB0aGlzLmNvbGxpZGVXb3JsZEJvdW5kcyA9IGZhbHNlOwoKfTsKClBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN1cGRhdGVCb3VuZHMKICAgICogQHByb3RlY3RlZAogICAgKi8KCXVwZGF0ZUJvdW5kczogZnVuY3Rpb24gKGNlbnRlclgsIGNlbnRlclksIHNjYWxlWCwgc2NhbGVZKSB7CgoJCWlmIChzY2FsZVggIT0gdGhpcy5fc3ggfHwgc2NhbGVZICE9IHRoaXMuX3N5KQoJCXsKCQkJdGhpcy53aWR0aCA9IHRoaXMuc291cmNlV2lkdGggKiBzY2FsZVg7CgkJCXRoaXMuaGVpZ2h0ID0gdGhpcy5zb3VyY2VIZWlnaHQgKiBzY2FsZVk7CgkJCXRoaXMuaGFsZldpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoIC8gMik7CgkJCXRoaXMuaGFsZkhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5oZWlnaHQgLyAyKTsKCQkJdGhpcy5fc3ggPSBzY2FsZVg7CgkJCXRoaXMuX3N5ID0gc2NhbGVZOwogICAgICAgICAgICB0aGlzLmNlbnRlci5zZXRUbyh0aGlzLnggKyB0aGlzLmhhbGZXaWR0aCwgdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0KTsKCQl9CgoJfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNwcmVVcGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KCXByZVVwZGF0ZTogZnVuY3Rpb24gKCkgewoKCQkvLwlTdG9yZSBhbmQgcmVzZXQgY29sbGlzaW9uIGZsYWdzCgkgICAgdGhpcy53YXNUb3VjaGluZy5ub25lID0gdGhpcy50b3VjaGluZy5ub25lOwoJICAgIHRoaXMud2FzVG91Y2hpbmcudXAgPSB0aGlzLnRvdWNoaW5nLnVwOwoJICAgIHRoaXMud2FzVG91Y2hpbmcuZG93biA9IHRoaXMudG91Y2hpbmcuZG93bjsKCSAgICB0aGlzLndhc1RvdWNoaW5nLmxlZnQgPSB0aGlzLnRvdWNoaW5nLmxlZnQ7CgkgICAgdGhpcy53YXNUb3VjaGluZy5yaWdodCA9IHRoaXMudG91Y2hpbmcucmlnaHQ7CgoJICAgIHRoaXMudG91Y2hpbmcubm9uZSA9IHRydWU7CgkgICAgdGhpcy50b3VjaGluZy51cCA9IGZhbHNlOwoJICAgIHRoaXMudG91Y2hpbmcuZG93biA9IGZhbHNlOwoJICAgIHRoaXMudG91Y2hpbmcubGVmdCA9IGZhbHNlOwoJICAgIHRoaXMudG91Y2hpbmcucmlnaHQgPSBmYWxzZTsKCgkgICAgdGhpcy5lbWJlZGRlZCA9IGZhbHNlOwoKCQl0aGlzLnNjcmVlblggPSAodGhpcy5zcHJpdGUud29ybGRUcmFuc2Zvcm1bMl0gLSAodGhpcy5zcHJpdGUuYW5jaG9yLnggKiB0aGlzLndpZHRoKSkgKyB0aGlzLm9mZnNldC54OwoJCXRoaXMuc2NyZWVuWSA9ICh0aGlzLnNwcml0ZS53b3JsZFRyYW5zZm9ybVs1XSAtICh0aGlzLnNwcml0ZS5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSkgKyB0aGlzLm9mZnNldC55OwoKICAgICAgICB0aGlzLnByZVggPSAodGhpcy5zcHJpdGUud29ybGQueCAtICh0aGlzLnNwcml0ZS5hbmNob3IueCAqIHRoaXMud2lkdGgpKSArIHRoaXMub2Zmc2V0Lng7CiAgICAgICAgdGhpcy5wcmVZID0gKHRoaXMuc3ByaXRlLndvcmxkLnkgLSAodGhpcy5zcHJpdGUuYW5jaG9yLnkgKiB0aGlzLmhlaWdodCkpICsgdGhpcy5vZmZzZXQueTsKCgkJdGhpcy5wcmVSb3RhdGlvbiA9IHRoaXMuc3ByaXRlLmFuZ2xlOwoKCQl0aGlzLnggPSB0aGlzLnByZVg7CgkJdGhpcy55ID0gdGhpcy5wcmVZOwoJCXRoaXMucm90YXRpb24gPSB0aGlzLnByZVJvdGF0aW9uOwoKCQlpZiAodGhpcy5tb3ZlcykKCQl7CgkJCXRoaXMuZ2FtZS5waHlzaWNzLnVwZGF0ZU1vdGlvbih0aGlzKTsKCgkJCWlmICh0aGlzLmNvbGxpZGVXb3JsZEJvdW5kcykKCQkJewoJCQkJdGhpcy5jaGVja1dvcmxkQm91bmRzKCk7CgkJCX0KCgkJCXRoaXMudXBkYXRlSHVsbHMoKTsKICAgICAgICB9CgoJCWlmICh0aGlzLnNraXBRdWFkVHJlZSA9PSBmYWxzZSAmJiB0aGlzLmFsbG93Q29sbGlzaW9uLm5vbmUgPT0gZmFsc2UgJiYgdGhpcy5zcHJpdGUudmlzaWJsZSAmJiB0aGlzLnNwcml0ZS5hbGl2ZSkKCQl7CgkJICAgIHRoaXMucXVhZFRyZWVJRHMgPSBbXTsKCQkgICAgdGhpcy5xdWFkVHJlZUluZGV4ID0gLTE7CgkJCXRoaXMuZ2FtZS5waHlzaWNzLnF1YWRUcmVlLmluc2VydCh0aGlzKTsKCQl9CgoJfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNwb3N0VXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCglwb3N0VXBkYXRlOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLmRlbHRhWCgpIDwgMCkKCQl7CgkJCXRoaXMuZmFjaW5nID0gUGhhc2VyLkxFRlQ7CgkJfQoJCWVsc2UgaWYgKHRoaXMuZGVsdGFYKCkgPiAwKQoJCXsKCQkJdGhpcy5mYWNpbmcgPSBQaGFzZXIuUklHSFQ7CgkJfQoKCQlpZiAodGhpcy5kZWx0YVkoKSA8IDApCgkJewoJCQl0aGlzLmZhY2luZyA9IFBoYXNlci5VUDsKCQl9CgkJZWxzZSBpZiAodGhpcy5kZWx0YVkoKSA+IDApCgkJewoJCQl0aGlzLmZhY2luZyA9IFBoYXNlci5ET1dOOwoJCX0KCiAgICAgICAgaWYgKHRoaXMuZGVsdGFYKCkgIT09IDAgfHwgdGhpcy5kZWx0YVkoKSAhPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggKz0gdGhpcy5kZWx0YVgoKTsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueSArPSB0aGlzLmRlbHRhWSgpOwogICAgICAgICAgICB0aGlzLmNlbnRlci5zZXRUbyh0aGlzLnggKyB0aGlzLmhhbGZXaWR0aCwgdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0KTsKICAgICAgICB9CgoJCWlmICh0aGlzLmFsbG93Um90YXRpb24pCgkJewoJCQl0aGlzLnNwcml0ZS5hbmdsZSArPSB0aGlzLmRlbHRhWigpOwoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3VwZGF0ZUh1bGxzCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCgl1cGRhdGVIdWxsczogZnVuY3Rpb24gKCkgewoKCQl0aGlzLmh1bGxYLnNldFRvKHRoaXMueCwgdGhpcy5wcmVZLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkJdGhpcy5odWxsWS5zZXRUbyh0aGlzLnByZVgsIHRoaXMueSwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKCX0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY2hlY2tXb3JsZEJvdW5kcwogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJY2hlY2tXb3JsZEJvdW5kczogZnVuY3Rpb24gKCkgewoKCQlpZiAodGhpcy54IDwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy54KQoJCXsKCQkJdGhpcy54ID0gdGhpcy5nYW1lLndvcmxkLmJvdW5kcy54OwoJCQl0aGlzLnZlbG9jaXR5LnggKj0gLXRoaXMuYm91bmNlLng7CgkJfQoJCWVsc2UgaWYgKHRoaXMucmlnaHQgPiB0aGlzLmdhbWUud29ybGQuYm91bmRzLnJpZ2h0KQoJCXsKCQkJdGhpcy54ID0gdGhpcy5nYW1lLndvcmxkLmJvdW5kcy5yaWdodCAtIHRoaXMud2lkdGg7CgkJCXRoaXMudmVsb2NpdHkueCAqPSAtdGhpcy5ib3VuY2UueDsKCQl9CgoJCWlmICh0aGlzLnkgPCB0aGlzLmdhbWUud29ybGQuYm91bmRzLnkpCgkJewoJCQl0aGlzLnkgPSB0aGlzLmdhbWUud29ybGQuYm91bmRzLnk7CgkJCXRoaXMudmVsb2NpdHkueSAqPSAtdGhpcy5ib3VuY2UueTsKCQl9CgkJZWxzZSBpZiAodGhpcy5ib3R0b20gPiB0aGlzLmdhbWUud29ybGQuYm91bmRzLmJvdHRvbSkKCQl7CgkJCXRoaXMueSA9IHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuYm90dG9tIC0gdGhpcy5oZWlnaHQ7CgkJCXRoaXMudmVsb2NpdHkueSAqPSAtdGhpcy5ib3VuY2UueTsKCQl9CgoJfSwKCiAgICAvKioKICAgICogWW91IGNhbiBtb2RpZnkgdGhlIHNpemUgb2YgdGhlIHBoeXNpY3MgQm9keSB0byBiZSBhbnkgZGltZW5zaW9uIHlvdSBuZWVkLgogICAgKiBTbyBpdCBjb3VsZCBiZSBzbWFsbGVyIG9yIGxhcmdlciB0aGFuIHRoZSBwYXJlbnQgU3ByaXRlLiBZb3UgY2FuIGFsc28gY29udHJvbCB0aGUgeCBhbmQgeSBvZmZzZXQsIHdoaWNoCiAgICAqIGlzIHRoZSBwb3NpdGlvbiBvZiB0aGUgQm9keSByZWxhdGl2ZSB0byB0aGUgdG9wLWxlZnQgb2YgdGhlIFNwcml0ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2V0U2l6ZQogICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIEJvZHkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBCb2R5LgogICAgKiBAcGFyYW0ge251bWJlcn0gb2Zmc2V0WCAtIFRoZSBYIG9mZnNldCBvZiB0aGUgQm9keSBmcm9tIHRoZSBTcHJpdGUgcG9zaXRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXRZIC0gVGhlIFkgb2Zmc2V0IG9mIHRoZSBCb2R5IGZyb20gdGhlIFNwcml0ZSBwb3NpdGlvbi4KICAgICovCglzZXRTaXplOiBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCwgb2Zmc2V0WCwgb2Zmc2V0WSkgewoKCQlvZmZzZXRYID0gb2Zmc2V0WCB8fCB0aGlzLm9mZnNldC54OwoJCW9mZnNldFkgPSBvZmZzZXRZIHx8IHRoaXMub2Zmc2V0Lnk7CgoJCXRoaXMuc291cmNlV2lkdGggPSB3aWR0aDsKCQl0aGlzLnNvdXJjZUhlaWdodCA9IGhlaWdodDsKCQl0aGlzLndpZHRoID0gdGhpcy5zb3VyY2VXaWR0aCAqIHRoaXMuX3N4OwoJCXRoaXMuaGVpZ2h0ID0gdGhpcy5zb3VyY2VIZWlnaHQgKiB0aGlzLl9zeTsKCQl0aGlzLmhhbGZXaWR0aCA9IE1hdGguZmxvb3IodGhpcy53aWR0aCAvIDIpOwoJCXRoaXMuaGFsZkhlaWdodCA9IE1hdGguZmxvb3IodGhpcy5oZWlnaHQgLyAyKTsKCQl0aGlzLm9mZnNldC5zZXRUbyhvZmZzZXRYLCBvZmZzZXRZKTsKCiAgICAgICAgdGhpcy5jZW50ZXIuc2V0VG8odGhpcy54ICsgdGhpcy5oYWxmV2lkdGgsIHRoaXMueSArIHRoaXMuaGFsZkhlaWdodCk7CgoJfSwKCiAgICAvKioKICAgICogUmVzZXRzIGFsbCBCb2R5IHZhbHVlcyAodmVsb2NpdHksIGFjY2VsZXJhdGlvbiwgcm90YXRpb24sIGV0YykKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjcmVzZXQKICAgICovCglyZXNldDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLnZlbG9jaXR5LnNldFRvKDAsIDApOwoJCXRoaXMuYWNjZWxlcmF0aW9uLnNldFRvKDAsIDApOwoKCSAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IDA7CgkgICAgdGhpcy5hbmd1bGFyQWNjZWxlcmF0aW9uID0gMDsKICAgICAgICB0aGlzLnByZVggPSAodGhpcy5zcHJpdGUud29ybGQueCAtICh0aGlzLnNwcml0ZS5hbmNob3IueCAqIHRoaXMud2lkdGgpKSArIHRoaXMub2Zmc2V0Lng7CiAgICAgICAgdGhpcy5wcmVZID0gKHRoaXMuc3ByaXRlLndvcmxkLnkgLSAodGhpcy5zcHJpdGUuYW5jaG9yLnkgKiB0aGlzLmhlaWdodCkpICsgdGhpcy5vZmZzZXQueTsKCQl0aGlzLnByZVJvdGF0aW9uID0gdGhpcy5zcHJpdGUuYW5nbGU7CgoJCXRoaXMueCA9IHRoaXMucHJlWDsKCQl0aGlzLnkgPSB0aGlzLnByZVk7CgkJdGhpcy5yb3RhdGlvbiA9IHRoaXMucHJlUm90YXRpb247CiAgICAgICAgCiAgICAgICAgdGhpcy5jZW50ZXIuc2V0VG8odGhpcy54ICsgdGhpcy5oYWxmV2lkdGgsIHRoaXMueSArIHRoaXMuaGFsZkhlaWdodCk7CgoJfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgYWJzb2x1dGUgZGVsdGEgeCB2YWx1ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNkZWx0YUFic1gKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYWJzb2x1dGUgZGVsdGEgdmFsdWUuCiAgICAqLwogICAgZGVsdGFBYnNYOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLmRlbHRhWCgpID4gMCA/IHRoaXMuZGVsdGFYKCkgOiAtdGhpcy5kZWx0YVgoKSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBhYnNvbHV0ZSBkZWx0YSB5IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2RlbHRhQWJzWQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhYnNvbHV0ZSBkZWx0YSB2YWx1ZS4KICAgICovCiAgICBkZWx0YUFic1k6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMuZGVsdGFZKCkgPiAwID8gdGhpcy5kZWx0YVkoKSA6IC10aGlzLmRlbHRhWSgpKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRlbHRhIHggdmFsdWUuIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gQm9keS54IG5vdyBhbmQgaW4gdGhlIHByZXZpb3VzIHN0ZXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFYCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRlbHRhIHZhbHVlLgogICAgKi8KICAgIGRlbHRhWDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggLSB0aGlzLnByZVg7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkZWx0YSB5IHZhbHVlLiBUaGUgZGlmZmVyZW5jZSBiZXR3ZWVuIEJvZHkueSBub3cgYW5kIGluIHRoZSBwcmV2aW91cyBzdGVwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2RlbHRhWQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkZWx0YSB2YWx1ZS4KICAgICovCiAgICBkZWx0YVk6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55IC0gdGhpcy5wcmVZOwogICAgfSwKCiAgICBkZWx0YVo6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5yb3RhdGlvbiAtIHRoaXMucHJlUm90YXRpb247CiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjYm90dG9tCiogQHByb3BlcnR5IHtudW1iZXJ9IGJvdHRvbSAtIFRoZSBib3R0b20gdmFsdWUgb2YgdGhpcyBCb2R5IChzYW1lIGFzIEJvZHkueSArIEJvZHkuaGVpZ2h0KQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICAvKioKICAgICogVGhlIHN1bSBvZiB0aGUgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSBib3R0b20gcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIHdpZHRoIHByb3BlcnRpZXMsIGJ1dCBkb2VzIGNoYW5nZSB0aGUgaGVpZ2h0IHByb3BlcnR5LgogICAgKiBAbWV0aG9kIGJvdHRvbQogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqKi8KICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgKyB0aGlzLmhlaWdodDsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBzdW0gb2YgdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgYm90dG9tIHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGhlaWdodCBwcm9wZXJ0eS4KICAgICogQG1ldGhvZCBib3R0b20KICAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlCiAgICAqKi8gICAgCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgPD0gdGhpcy55KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAwOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9ICh0aGlzLnkgLSB2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIAogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNyaWdodAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByaWdodCAtIFRoZSByaWdodCB2YWx1ZSBvZiB0aGlzIEJvZHkgKHNhbWUgYXMgQm9keS54ICsgQm9keS53aWR0aCkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5LnByb3RvdHlwZSwgInJpZ2h0IiwgewogICAgCiAgICAvKioKICAgICogVGhlIHN1bSBvZiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIHJpZ2h0IHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4KICAgICogSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgd2lkdGggcHJvcGVydHkuCiAgICAqIEBtZXRob2QgcmlnaHQKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKiovICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMud2lkdGg7CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgcmlnaHQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLgogICAgKiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KICAgICogQG1ldGhvZCByaWdodAogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICAgICoqLwogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlIDw9IHRoaXMueCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSAwOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy54ICsgdmFsdWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlBhcnRpY2xlcyBpcyB0aGUgUGFydGljbGUgTWFuYWdlciBmb3IgdGhlIGdhbWUuIEl0IGlzIGNhbGxlZCBkdXJpbmcgdGhlIGdhbWUgdXBkYXRlIGxvb3AgYW5kIGluIHR1cm4gdXBkYXRlcyBhbnkgRW1pdHRlcnMgYXR0YWNoZWQgdG8gaXQuCioKKiBAY2xhc3MgUGhhc2VyLlBhcnRpY2xlcwoqIEBjbGFzc2Rlc2MgUGhhc2VyIFBhcnRpY2xlcwoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlBhcnRpY2xlcyA9IGZ1bmN0aW9uIChnYW1lKSB7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGVtaXR0ZXJzIC0gRGVzY3JpcHRpb24uCgkqLwoJdGhpcy5lbWl0dGVycyA9IHt9OwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gSUQgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLklEID0gMDsKCn07CgpQaGFzZXIuUGFydGljbGVzLnByb3RvdHlwZSA9IHsKCgkvKioKCSogQWRkcyBhIG5ldyBQYXJ0aWNsZSBFbWl0dGVyIHRvIHRoZSBQYXJ0aWNsZSBNYW5hZ2VyLgoJKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMjYWRkCgkqIEBwYXJhbSB7UGhhc2VyLkVtaXR0ZXJ9IGVtaXR0ZXIgLSBEZXNjcmlwdGlvbi4KCSogQHJldHVybiB7UGhhc2VyLkVtaXR0ZXJ9IFRoZSBlbWl0dGVyIHRoYXQgd2FzIGFkZGVkLgoJKi8KCWFkZDogZnVuY3Rpb24gKGVtaXR0ZXIpIHsKCgkJdGhpcy5lbWl0dGVyc1tlbWl0dGVyLm5hbWVdID0gZW1pdHRlcjsKCgkJcmV0dXJuIGVtaXR0ZXI7CgoJfSwKCgkvKioKCSogUmVtb3ZlcyBhbiBleGlzdGluZyBQYXJ0aWNsZSBFbWl0dGVyIGZyb20gdGhlIFBhcnRpY2xlIE1hbmFnZXIuCgkqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyNyZW1vdmUKCSogQHBhcmFtIHtQaGFzZXIuRW1pdHRlcn0gZW1pdHRlciAtIFRoZSBlbWl0dGVyIHRvIHJlbW92ZS4KCSovCglyZW1vdmU6IGZ1bmN0aW9uIChlbWl0dGVyKSB7CgoJCWRlbGV0ZSB0aGlzLmVtaXR0ZXJzW2VtaXR0ZXIubmFtZV07CgoJfSwKCgkvKioKCSogQ2FsbGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4gVXBkYXRlcyBhbGwgRW1pdHRlcnMgd2hvIGhhdmUgdGhlaXIgZXhpc3RzIHZhbHVlIHNldCB0byB0cnVlLgoJKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMjdXBkYXRlCgkqIEBwcm90ZWN0ZWQKCSovCgl1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCgkJZm9yICh2YXIga2V5IGluIHRoaXMuZW1pdHRlcnMpCgkJewoJCQlpZiAodGhpcy5lbWl0dGVyc1trZXldLmV4aXN0cykKCQkJewoJCQkJdGhpcy5lbWl0dGVyc1trZXldLnVwZGF0ZSgpOwoJCQl9CgkJfQoKCX0KCn07ClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlID0ge30KLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gQXJjYWRlRW1pdHRlcgoqCiogQGNsYXNzIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIKKiBAY2xhc3NkZXNjIEVtaXR0ZXIgaXMgYSBsaWdodHdlaWdodCBwYXJ0aWNsZSBlbWl0dGVyLiBJdCBjYW4gYmUgdXNlZCBmb3Igb25lLXRpbWUgZXhwbG9zaW9ucyBvciBmb3IKKiBjb250aW51b3VzIGVmZmVjdHMgbGlrZSByYWluIGFuZCBmaXJlLiBBbGwgaXQgcmVhbGx5IGRvZXMgaXMgbGF1bmNoIFBhcnRpY2xlIG9iamVjdHMgb3V0CiogYXQgc2V0IGludGVydmFscywgYW5kIGZpeGVzIHRoZWlyIHBvc2l0aW9ucyBhbmQgdmVsb2NpdGllcyBhY2NvcmluZGdseS4KKiBAY29uc3RydWN0b3IKKiBAZXh0ZW5kcyBQaGFzZXIuR3JvdXAKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgoqIEBwYXJhbSB7bnVtYmVyfSBbeT0wXSAtIFRoZSB5IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgoqIEBwYXJhbSB7bnVtYmVyfSBbbWF4UGFydGljbGVzPTUwXSAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4uCiovCgpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIG1heFBhcnRpY2xlcykgewoKICAgIC8qKgogICAgKiBUaGUgdG90YWwgbnVtYmVyIG9mIHBhcnRpY2xlcyBpbiB0aGlzIGVtaXR0ZXIuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhQYXJ0aWNsZXMgLSBUaGUgdG90YWwgbnVtYmVyIG9mIHBhcnRpY2xlcyBpbiB0aGlzIGVtaXR0ZXIuLgogICAgKiBAZGVmYXVsdAogICAgKi8KCXRoaXMubWF4UGFydGljbGVzID0gbWF4UGFydGljbGVzIHx8IDUwOwoKCVBoYXNlci5Hcm91cC5jYWxsKHRoaXMsIGdhbWUpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMubmFtZSA9ICdlbWl0dGVyJyArIHRoaXMuZ2FtZS5wYXJ0aWNsZXMuSUQrKzsKCiAgICAvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdHlwZSAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5FTUlUVEVSOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgWCBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgY29ybmVyIG9mIHRoZSBlbWl0dGVyIGluIHdvcmxkIHNwYWNlLgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy54ID0gMDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIFkgcG9zaXRpb24gb2YgdGhlIHRvcCBsZWZ0IGNvcm5lciBvZiBlbWl0dGVyIGluIHdvcmxkIHNwYWNlLgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy55ID0gMDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZW1pdHRlci4gIFBhcnRpY2xlcyBjYW4gYmUgcmFuZG9tbHkgZ2VuZXJhdGVkIGZyb20gYW55d2hlcmUgd2l0aGluIHRoaXMgYm94LgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy53aWR0aCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBlbWl0dGVyLiAgUGFydGljbGVzIGNhbiBiZSByYW5kb21seSBnZW5lcmF0ZWQgZnJvbSBhbnl3aGVyZSB3aXRoaW4gdGhpcyBib3guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSAxOwoKICAgIC8qKgogICAgKiBUaGUgbWluaW11bSBwb3NzaWJsZSB2ZWxvY2l0eSBvZiBhIHBhcnRpY2xlLgogICAgKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAoLTEwMCwtMTAwKS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1pblBhcnRpY2xlU3BlZWQKICAgICovCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KC0xMDAsIC0xMDApOwoKICAgIC8qKgogICAgKiBUaGUgbWF4aW11bSBwb3NzaWJsZSB2ZWxvY2l0eSBvZiBhIHBhcnRpY2xlLgogICAgKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAoMTAwLDEwMCkuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBtYXhQYXJ0aWNsZVNwZWVkCiAgICAqLwogICAgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkID0gbmV3IFBoYXNlci5Qb2ludCgxMDAsIDEwMCk7CgogICAgLyoqCiAgICAqIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHNjYWxlIG9mIGEgcGFydGljbGUuCiAgICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDEuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5QYXJ0aWNsZVNjYWxlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taW5QYXJ0aWNsZVNjYWxlID0gMTsKCiAgICAvKioKICAgICAqIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHNjYWxlIG9mIGEgcGFydGljbGUuCiAgICAgKiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxLgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFBhcnRpY2xlU2NhbGUKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMubWF4UGFydGljbGVTY2FsZSA9IDE7CgogICAgLyoqCiAgICAgKiBUaGUgbWluaW11bSBwb3NzaWJsZSBhbmd1bGFyIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAtMzYwLgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1pblJvdGF0aW9uCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLm1pblJvdGF0aW9uID0gLTM2MDsKCiAgICAvKioKICAgICAqIFRoZSBtYXhpbXVtIHBvc3NpYmxlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgYSBwYXJ0aWNsZS4gIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDM2MC4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhSb3RhdGlvbgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5tYXhSb3RhdGlvbiA9IDM2MDsKCiAgICAvKioKICAgICAqIFNldHMgdGhlIDxjb2RlPmdyYXZpdHkueTwvY29kZT4gb2YgZWFjaCBwYXJ0aWNsZSB0byB0aGlzIHZhbHVlIG9uIGxhdW5jaC4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBncmF2aXR5CiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLmdyYXZpdHkgPSAyOwoKICAgIC8qKgogICAgICogU2V0IHlvdXIgb3duIHBhcnRpY2xlIGNsYXNzIHR5cGUgaGVyZS4KICAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHBhcnRpY2xlQ2xhc3MKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMucGFydGljbGVDbGFzcyA9IG51bGw7CgogICAgLyoqCiAgICAgKiBUaGUgWCBhbmQgWSBkcmFnIGNvbXBvbmVudCBvZiBwYXJ0aWNsZXMgbGF1bmNoZWQgZnJvbSB0aGUgZW1pdHRlci4KICAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBwYXJ0aWNsZURyYWcKICAgICAqLwogICAgdGhpcy5wYXJ0aWNsZURyYWcgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAgKiBUaGUgYW5ndWxhciBkcmFnIGNvbXBvbmVudCBvZiBwYXJ0aWNsZXMgbGF1bmNoZWQgZnJvbSB0aGUgZW1pdHRlciBpZiB0aGV5IGFyZSByb3RhdGluZy4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyRHJhZwogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5hbmd1bGFyRHJhZyA9IDA7CgogICAgLyoqCiAgICAgKiBIb3cgb2Z0ZW4gYSBwYXJ0aWNsZSBpcyBlbWl0dGVkIGluIG1zIChpZiBlbWl0dGVyIGlzIHN0YXJ0ZWQgd2l0aCBFeHBsb2RlID09IGZhbHNlKS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZnJlcXVlbmN5CiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLmZyZXF1ZW5jeSA9IDEwMDsKCiAgICAvKioKICAgICAqIEhvdyBsb25nIGVhY2ggcGFydGljbGUgbGl2ZXMgb25jZSBpdCBpcyBlbWl0dGVkIGluIG1zLiBEZWZhdWx0IGlzIDIgc2Vjb25kcy4KICAgICAqIFNldCBsaWZlc3BhbiB0byAnemVybycgZm9yIHBhcnRpY2xlcyB0byBsaXZlIGZvcmV2ZXIuCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gbGlmZXNwYW4KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMubGlmZXNwYW4gPSAyMDAwOwoKICAgIC8qKgogICAgICogSG93IG11Y2ggZWFjaCBwYXJ0aWNsZSBzaG91bGQgYm91bmNlIG9uIGVhY2ggYXhpcy4gIDEgPSBmdWxsIGJvdW5jZSwgMCA9IG5vIGJvdW5jZS4KICAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3VuY2UKICAgICAqLwogICAgdGhpcy5ib3VuY2UgPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBoZWxwZXIgZm9yIGRlY2lkaW5nIGhvdyBtYW55IHBhcnRpY2xlcyB0byBsYXVuY2guCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gX3F1YW50aXR5CiAgICAgKiBAcHJpdmF0ZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5fcXVhbnRpdHkgPSAwOwoKICAgLyoqCiAgICAgKiBJbnRlcm5hbCBoZWxwZXIgZm9yIGRlY2lkaW5nIHdoZW4gdG8gbGF1bmNoIHBhcnRpY2xlcyBvciBraWxsIHRoZW0uCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RpbWVyCiAgICAgKiBAcHJpdmF0ZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5fdGltZXIgPSAwOwoKICAgIC8qKgogICAgICogSW50ZXJuYWwgY291bnRlciBmb3IgZmlndXJpbmcgb3V0IGhvdyBtYW55IHBhcnRpY2xlcyB0byBsYXVuY2guCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gX2NvdW50ZXIKICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLl9jb3VudGVyID0gMDsKCiAgICAvKioKICAgICAqIEludGVybmFsIGhlbHBlciBmb3IgdGhlIHN0eWxlIG9mIHBhcnRpY2xlIGVtaXNzaW9uIChhbGwgYXQgb25jZSwgb3Igb25lIGF0IGEgdGltZSkuCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9leHBsb2RlCiAgICAgKiBAcHJpdmF0ZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5fZXhwbG9kZSA9IHRydWU7CgogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIGVtaXR0ZXIgaXMgY3VycmVudGx5IGVtaXR0aW5nIHBhcnRpY2xlcy4KICAgICAqIEl0IGlzIHRvdGFsbHkgc2FmZSB0byBkaXJlY3RseSB0b2dnbGUgdGhpcy4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gb24KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMub24gPSBmYWxzZTsKCiAgICAvKioKICAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZW1pdHRlciBpcyBiZWluZyB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhpc3RzCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CgogICAgLyoqCiAgICAgKiBUaGUgcG9pbnQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgogICAgICogRW1pdHRlci54IGFuZCBFbWl0dGVyLnkgY29udHJvbCB0aGUgY29udGFpbmVycyBsb2NhdGlvbiwgd2hpY2ggdXBkYXRlcyBhbGwgY3VycmVudCBwYXJ0aWNsZXMKICAgICAqIEVtaXR0ZXIuZW1pdFggYW5kIEVtaXR0ZXIuZW1pdFkgY29udHJvbCB0aGUgZW1pc3Npb24gbG9jYXRpb24gcmVsYXRpdmUgdG8gdGhlIHgveSBwb3NpdGlvbi4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1pdFgKICAgICAqLwogICAgdGhpcy5lbWl0WCA9IHg7CiAgICAKICAgIC8qKgogICAgICogVGhlIHBvaW50IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KICAgICAqIEVtaXR0ZXIueCBhbmQgRW1pdHRlci55IGNvbnRyb2wgdGhlIGNvbnRhaW5lcnMgbG9jYXRpb24sIHdoaWNoIHVwZGF0ZXMgYWxsIGN1cnJlbnQgcGFydGljbGVzCiAgICAgKiBFbWl0dGVyLmVtaXRYIGFuZCBFbWl0dGVyLmVtaXRZIGNvbnRyb2wgdGhlIGVtaXNzaW9uIGxvY2F0aW9uIHJlbGF0aXZlIHRvIHRoZSB4L3kgcG9zaXRpb24uCiAgICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtaXRZCiAgICAgKi8KICAgIHRoaXMuZW1pdFkgPSB5OwoJCn07CgpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSk7ClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlcjsKCi8qKgoqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBnYW1lIGxvb3AsIGRlY2lkZXMgd2hlbiB0byBsYXVuY2ggcGFydGljbGVzIGFuZCB3aGVuIHRvICJkaWUiLgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN1cGRhdGUKKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIGlmICh0aGlzLm9uKQogICAgewogICAgICAgIGlmICh0aGlzLl9leHBsb2RlKQogICAgICAgIHsKCQkJdGhpcy5fY291bnRlciA9IDA7CgogICAgICAgICAgICBkbwogICAgICAgICAgICB7CiAgICAgICAgICAgIAl0aGlzLmVtaXRQYXJ0aWNsZSgpOwogICAgICAgICAgICAJdGhpcy5fY291bnRlcisrOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlICh0aGlzLl9jb3VudGVyIDwgdGhpcy5fcXVhbnRpdHkpOwoKICAgICAgICAgICAgdGhpcy5vbiA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgIAlpZiAodGhpcy5nYW1lLnRpbWUubm93ID49IHRoaXMuX3RpbWVyKQogICAgICAgIAl7CiAgICAgICAgICAgICAgICB0aGlzLmVtaXRQYXJ0aWNsZSgpOwoJCQkJCgkJCQl0aGlzLl9jb3VudGVyKys7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3F1YW50aXR5ID4gMCkKICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICBpZiAodGhpcy5fY291bnRlciA+PSB0aGlzLl9xdWFudGl0eSkKCSAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgCXRoaXMub24gPSBmYWxzZTsKCSAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5fdGltZXIgPSB0aGlzLmdhbWUudGltZS5ub3cgKyB0aGlzLmZyZXF1ZW5jeTsKICAgICAgICAJfQogICAgICAgIH0KICAgIH0KCn0KCi8qKgoqIFRoaXMgZnVuY3Rpb24gZ2VuZXJhdGVzIGEgbmV3IGFycmF5IG9mIHBhcnRpY2xlIHNwcml0ZXMgdG8gYXR0YWNoIHRvIHRoZSBlbWl0dGVyLgoqCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI21ha2VQYXJ0aWNsZXMKKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBrZXlzIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IGZyYW1lcyAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSBxdWFudGl0eSAtIFRoZSBudW1iZXIgb2YgcGFydGljbGVzIHRvIGdlbmVyYXRlIHdoZW4gdXNpbmcgdGhlICJjcmVhdGUgZnJvbSBpbWFnZSIgb3B0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSBjb2xsaWRlIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtib29sZWFufSBjb2xsaWRlV29ybGRCb3VuZHMgLSBEZXNjcmlwdGlvbi4KKiBAcmV0dXJuIFRoaXMgRW1pdHRlciBpbnN0YW5jZSAobmljZSBmb3IgY2hhaW5pbmcgc3R1ZmYgdG9nZXRoZXIsIGlmIHlvdSdyZSBpbnRvIHRoYXQpLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5tYWtlUGFydGljbGVzID0gZnVuY3Rpb24gKGtleXMsIGZyYW1lcywgcXVhbnRpdHksIGNvbGxpZGUsIGNvbGxpZGVXb3JsZEJvdW5kcykgewoKICAgIGlmICh0eXBlb2YgZnJhbWVzID09ICd1bmRlZmluZWQnKQogICAgewogICAgICAgIGZyYW1lcyA9IDA7CiAgICB9CgoJcXVhbnRpdHkgPSBxdWFudGl0eSB8fCB0aGlzLm1heFBhcnRpY2xlczsKICAgIGNvbGxpZGUgPSBjb2xsaWRlIHx8IDA7CgogICAgaWYgKHR5cGVvZiBjb2xsaWRlV29ybGRCb3VuZHMgPT0gJ3VuZGVmaW5lZCcpCiAgICB7CiAgICAgICAgY29sbGlkZVdvcmxkQm91bmRzID0gZmFsc2U7CiAgICB9CgogICAgdmFyIHBhcnRpY2xlOwogICAgdmFyIGkgPSAwOwogICAgdmFyIHJuZEtleSA9IGtleXM7CiAgICB2YXIgcm5kRnJhbWUgPSAwOwoKICAgIHdoaWxlIChpIDwgcXVhbnRpdHkpCiAgICB7CiAgICAgICAgaWYgKHRoaXMucGFydGljbGVDbGFzcyA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBrZXlzID09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBybmRLZXkgPSB0aGlzLmdhbWUucm5kLnBpY2soa2V5cyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgZnJhbWVzID09ICdvYmplY3QnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBybmRGcmFtZSA9IHRoaXMuZ2FtZS5ybmQucGljayhmcmFtZXMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwYXJ0aWNsZSA9IG5ldyBQaGFzZXIuU3ByaXRlKHRoaXMuZ2FtZSwgMCwgMCwgcm5kS2V5LCBybmRGcmFtZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vIHBhcnRpY2xlID0gbmV3IHRoaXMucGFydGljbGVDbGFzcyh0aGlzLmdhbWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbGxpZGUgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgcGFydGljbGUuYm9keS5hbGxvd0NvbGxpc2lvbi5hbnkgPSB0cnVlOwogICAgICAgICAgICBwYXJ0aWNsZS5ib2R5LmFsbG93Q29sbGlzaW9uLm5vbmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcGFydGljbGUuYm9keS5hbGxvd0NvbGxpc2lvbi5ub25lID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHBhcnRpY2xlLmJvZHkuY29sbGlkZVdvcmxkQm91bmRzID0gY29sbGlkZVdvcmxkQm91bmRzOwoKICAgICAgICBwYXJ0aWNsZS5leGlzdHMgPSBmYWxzZTsKICAgICAgICBwYXJ0aWNsZS52aXNpYmxlID0gZmFsc2U7CgogICAgICAgIC8vICBDZW50ZXIgdGhlIG9yaWdpbiBmb3Igcm90YXRpb24gYXNzaXN0YW5jZQogICAgICAgIHBhcnRpY2xlLmFuY2hvci5zZXRUbygwLjUsIDAuNSk7CgogICAgICAgIHRoaXMuYWRkKHBhcnRpY2xlKTsKCiAgICAgICAgaSsrOwogICAgfQoKICAgIHJldHVybiB0aGlzOwp9CgovKioKICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHR1cm4gb2ZmIGFsbCB0aGUgcGFydGljbGVzIGFuZCB0aGUgZW1pdHRlci4KICogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2tpbGwKICovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmtpbGwgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5vbiA9IGZhbHNlOwogICAgdGhpcy5hbGl2ZSA9IGZhbHNlOwogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKCn0KCi8qKgogKiBIYW5keSBmb3IgYnJpbmdpbmcgZ2FtZSBvYmplY3RzICJiYWNrIHRvIGxpZmUiLiBKdXN0IHNldHMgYWxpdmUgYW5kIGV4aXN0cyBiYWNrIHRvIHRydWUuCiAqIEluIHByYWN0aWNlLCB0aGlzIGlzIG1vc3Qgb2Z0ZW4gY2FsbGVkIGJ5IDxjb2RlPk9iamVjdC5yZXNldCgpPC9jb2RlPi4KICogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3Jldml2ZQogKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUucmV2aXZlID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuYWxpdmUgPSB0cnVlOwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKfQoKLyoqCiAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byBzdGFydCBlbWl0dGluZyBwYXJ0aWNsZXMuCiAqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNzdGFydAogKiBAcGFyYW0ge2Jvb2xlYW59IGV4cGxvZGUgLSBXaGV0aGVyIHRoZSBwYXJ0aWNsZXMgc2hvdWxkIGFsbCBidXJzdCBvdXQgYXQgb25jZS4KICogQHBhcmFtIHtudW1iZXJ9IGxpZmVzcGFuIC0gSG93IGxvbmcgZWFjaCBwYXJ0aWNsZSBsaXZlcyBvbmNlIGVtaXR0ZWQuIDAgPSBmb3JldmVyLgogKiBAcGFyYW0ge251bWJlcn0gZnJlcXVlbmN5IC0gSWdub3JlZCBpZiBFeHBsb2RlIGlzIHNldCB0byB0cnVlLiBGcmVxdWVuY3kgaXMgaG93IG9mdGVuIHRvIGVtaXQgYSBwYXJ0aWNsZSBpbiBtcy4KICogQHBhcmFtIHtudW1iZXJ9IHF1YW50aXR5IC0gSG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4gMCA9ICJhbGwgb2YgdGhlIHBhcnRpY2xlcyIuCiAqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uIChleHBsb2RlLCBsaWZlc3BhbiwgZnJlcXVlbmN5LCBxdWFudGl0eSkgewoKCWlmICh0eXBlb2YgZXhwbG9kZSAhPT0gJ2Jvb2xlYW4nKQoJewoJCWV4cGxvZGUgPSB0cnVlOwoJfQoKCWxpZmVzcGFuID0gbGlmZXNwYW4gfHwgMDsKCgkvLwlIb3cgbWFueSBtcyBiZXR3ZWVuIGVtaXNzaW9ucz8KCWZyZXF1ZW5jeSA9IGZyZXF1ZW5jeSB8fCAyNTA7CgoJLy8JVG90YWwgbnVtYmVyIG9mIHBhcnRpY2xlcyB0byBlbWl0CglxdWFudGl0eSA9IHF1YW50aXR5IHx8IDA7CgogICAgdGhpcy5yZXZpdmUoKTsKCiAgICB0aGlzLnZpc2libGUgPSB0cnVlOwogICAgdGhpcy5vbiA9IHRydWU7CgogICAgdGhpcy5fZXhwbG9kZSA9IGV4cGxvZGU7CiAgICB0aGlzLmxpZmVzcGFuID0gbGlmZXNwYW47CiAgICB0aGlzLmZyZXF1ZW5jeSA9IGZyZXF1ZW5jeTsKCiAgICBpZiAoZXhwbG9kZSkKICAgIHsKICAgICAgICB0aGlzLl9xdWFudGl0eSA9IHF1YW50aXR5OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHRoaXMuX3F1YW50aXR5ICs9IHF1YW50aXR5OwogICAgfQoKICAgIHRoaXMuX2NvdW50ZXIgPSAwOwogICAgdGhpcy5fdGltZXIgPSB0aGlzLmdhbWUudGltZS5ub3cgKyBmcmVxdWVuY3k7Cgp9CgovKioKICogVGhpcyBmdW5jdGlvbiBjYW4gYmUgdXNlZCBib3RoIGludGVybmFsbHkgYW5kIGV4dGVybmFsbHkgdG8gZW1pdCB0aGUgbmV4dCBwYXJ0aWNsZS4KICogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2VtaXRQYXJ0aWNsZQogKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuZW1pdFBhcnRpY2xlID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBwYXJ0aWNsZSA9IHRoaXMuZ2V0Rmlyc3RFeGlzdHMoZmFsc2UpOwoKICAgIGlmIChwYXJ0aWNsZSA9PSBudWxsKQogICAgewogICAgCXJldHVybjsKICAgIH0KCiAgICBpZiAodGhpcy53aWR0aCA+IDEgfHwgdGhpcy5oZWlnaHQgPiAxKQogICAgewogICAgCXBhcnRpY2xlLnJlc2V0KHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5sZWZ0LCB0aGlzLnJpZ2h0KSwgdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLnRvcCwgdGhpcy5ib3R0b20pKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgIAlwYXJ0aWNsZS5yZXNldCh0aGlzLmVtaXRYLCB0aGlzLmVtaXRZKTsKICAgIH0KCiAgICBwYXJ0aWNsZS5saWZlc3BhbiA9IHRoaXMubGlmZXNwYW47CgogICAgcGFydGljbGUuYm9keS5ib3VuY2Uuc2V0VG8odGhpcy5ib3VuY2UueCwgdGhpcy5ib3VuY2UueSk7CgogICAgaWYgKHRoaXMubWluUGFydGljbGVTcGVlZC54ICE9IHRoaXMubWF4UGFydGljbGVTcGVlZC54KQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkudmVsb2NpdHkueCA9IHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5taW5QYXJ0aWNsZVNwZWVkLngsIHRoaXMubWF4UGFydGljbGVTcGVlZC54KTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LnZlbG9jaXR5LnggPSB0aGlzLm1pblBhcnRpY2xlU3BlZWQueDsKICAgIH0KCiAgICBpZiAodGhpcy5taW5QYXJ0aWNsZVNwZWVkLnkgIT0gdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLnkpCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS55ID0gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLm1pblBhcnRpY2xlU3BlZWQueSwgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLnkpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkudmVsb2NpdHkueSA9IHRoaXMubWluUGFydGljbGVTcGVlZC55OwogICAgfQoKICAgIHBhcnRpY2xlLmJvZHkuZ3Jhdml0eS55ID0gdGhpcy5ncmF2aXR5OwoKICAgIGlmICh0aGlzLm1pblJvdGF0aW9uICE9IHRoaXMubWF4Um90YXRpb24pCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS5hbmd1bGFyVmVsb2NpdHkgPSB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMubWluUm90YXRpb24sIHRoaXMubWF4Um90YXRpb24pOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkuYW5ndWxhclZlbG9jaXR5ID0gdGhpcy5taW5Sb3RhdGlvbjsKICAgIH0KCiAgICBpZiAodGhpcy5taW5QYXJ0aWNsZVNjYWxlICE9PSAxIHx8IHRoaXMubWF4UGFydGljbGVTY2FsZSAhPT0gMSkKICAgIHsKICAgICAgICB2YXIgc2NhbGUgPSB0aGlzLmdhbWUucm5kLnJlYWxJblJhbmdlKHRoaXMubWluUGFydGljbGVTY2FsZSwgdGhpcy5tYXhQYXJ0aWNsZVNjYWxlKTsKICAgICAgICBwYXJ0aWNsZS5zY2FsZS5zZXRUbyhzY2FsZSwgc2NhbGUpOwogICAgfQoKICAgIHBhcnRpY2xlLmJvZHkuZHJhZy54ID0gdGhpcy5wYXJ0aWNsZURyYWcueDsKICAgIHBhcnRpY2xlLmJvZHkuZHJhZy55ID0gdGhpcy5wYXJ0aWNsZURyYWcueTsKICAgIHBhcnRpY2xlLmJvZHkuYW5ndWxhckRyYWcgPSB0aGlzLmFuZ3VsYXJEcmFnOwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFNpemUKKiBAcGFyYW0gIHtudW1iZXJ9IHdpZHRoIC0gVGhlIGRlc2lyZWQgd2lkdGggb2YgdGhlIGVtaXR0ZXIgKHBhcnRpY2xlcyBhcmUgc3Bhd25lZCByYW5kb21seSB3aXRoaW4gdGhlc2UgZGltZW5zaW9ucykuCiogQHBhcmFtICB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgZGVzaXJlZCBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnNldFNpemUgPSBmdW5jdGlvbiAod2lkdGgsIGhlaWdodCkgewoKICAgIHRoaXMud2lkdGggPSB3aWR0aDsKICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIFggdmVsb2NpdHkgcmFuZ2Ugb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFhTcGVlZAoqIEBwYXJhbSAge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiogQHBhcmFtICB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0WFNwZWVkID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgoJbWluID0gbWluIHx8IDA7CgltYXggPSBtYXggfHwgMDsKCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQueCA9IG1pbjsKICAgIHRoaXMubWF4UGFydGljbGVTcGVlZC54ID0gbWF4OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIFkgdmVsb2NpdHkgcmFuZ2Ugb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFlTcGVlZAoqIEBwYXJhbSAge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiogQHBhcmFtICB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0WVNwZWVkID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgoJbWluID0gbWluIHx8IDA7CgltYXggPSBtYXggfHwgMDsKCiAgICB0aGlzLm1pblBhcnRpY2xlU3BlZWQueSA9IG1pbjsKICAgIHRoaXMubWF4UGFydGljbGVTcGVlZC55ID0gbWF4OwoKfQoKLyoqCiogQSBtb3JlIGNvbXBhY3Qgd2F5IG9mIHNldHRpbmcgdGhlIGFuZ3VsYXIgdmVsb2NpdHkgY29uc3RyYWludHMgb2YgdGhlIGVtaXR0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3NldFJvdGF0aW9uCiogQHBhcmFtIHtudW1iZXJ9IG1pbiAtICBUaGUgbWluaW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gIFRoZSBtYXhpbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zZXRSb3RhdGlvbiA9IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKCW1pbiA9IG1pbiB8fCAwOwoJbWF4ID0gbWF4IHx8IDA7CgogICAgdGhpcy5taW5Sb3RhdGlvbiA9IG1pbjsKICAgIHRoaXMubWF4Um90YXRpb24gPSBtYXg7Cgp9CgovKioKKiBDaGFuZ2UgdGhlIGVtaXR0ZXIncyBtaWRwb2ludCB0byBtYXRjaCB0aGUgbWlkcG9pbnQgb2YgYSA8Y29kZT5PYmplY3Q8L2NvZGU+LgoqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNhdAoqIEBwYXJhbSAge29iamVjdH0gb2JqZWN0IC0gVGhlIDxjb2RlPk9iamVjdDwvY29kZT4gdGhhdCB5b3Ugd2FudCB0byBzeW5jIHVwIHdpdGguCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLmF0ID0gZnVuY3Rpb24gKG9iamVjdCkgewoKICAgIHRoaXMuZW1pdFggPSBvYmplY3QuY2VudGVyLng7CiAgICB0aGlzLmVtaXRZID0gb2JqZWN0LmNlbnRlci55OwoKfQoKLyoqCiogVGhlIGVtaXR0ZXJzIGFscGhhIHZhbHVlLgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjYWxwaGEKKiBAcHJvcGVydHkge251bWJlcn0gYWxwaGEgLSBHZXRzIG9yIHNldHMgdGhlIGFscGhhIHZhbHVlIG9mIHRoZSBFbWl0dGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJhbHBoYSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5hbHBoYTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIuYWxwaGEgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIGVtaXR0ZXIgdmlzaWJsZSBzdGF0ZS4KKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3Zpc2libGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IHZpc2libGUgLSBHZXRzIG9yIHNldHMgdGhlIEVtaXR0ZXIgdmlzaWJsZSBzdGF0ZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAidmlzaWJsZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gR2V0cyBvciBzZXRzIHRoZSB4IHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJ4IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmVtaXRYOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuZW1pdFggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBHZXRzIG9yIHNldHMgdGhlIHkgcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgInkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdFk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5lbWl0WSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2xlZnQKKiBAcHJvcGVydHkge251bWJlcn0gbGVmdCAtIEdldHMgdGhlIGxlZnQgcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgImxlZnQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMueCAtICh0aGlzLndpZHRoIC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3JpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gR2V0cyB0aGUgcmlnaHQgcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgInJpZ2h0IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gTWF0aC5mbG9vcih0aGlzLnggKyAodGhpcy53aWR0aCAvIDIpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN0b3AKKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gR2V0cyB0aGUgdG9wIHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJ0b3AiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMueSAtICh0aGlzLmhlaWdodCAvIDIpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNib3R0b20KKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gR2V0cyB0aGUgYm90dG9tIHBvc2l0aW9uIG9mIHRoZSBFbWl0dGVyLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJib3R0b20iLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMueSArICh0aGlzLmhlaWdodCAvIDIpKTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqIEBtb2R1bGUgICAgICAgUGhhc2VyLlRpbGUKKi8KCgovKioKKiBDcmVhdGUgYSBuZXcgPGNvZGU+VGlsZTwvY29kZT4uCioKKiBAY2xhc3MgUGhhc2VyLlRpbGUKKiBAY2xhc3NkZXNjIEEgVGlsZSBpcyBhIHNpbmdsZSByZXByZXNlbnRhdGlvbiBvZiBhIHRpbGUgd2l0aGluIGEgVGlsZW1hcC4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtUaWxlbWFwfSB0aWxlbWFwIC0gVGhlIHRpbGVtYXAgdGhpcyB0aWxlIGJlbG9uZ3MgdG8uCiogQHBhcmFtIHtudW1iZXJ9ICBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgdHlwZSBpbiB0aGUgY29yZSBtYXAgZGF0YS4KKiBAcGFyYW0ge251bWJlcn0gIHdpZHRoIC0gV2lkdGggb2YgdGhlIHRpbGUuCiogQHBhcmFtIHtudW1iZXJ9ICBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIHRpbGUuCiovClBoYXNlci5UaWxlID0gZnVuY3Rpb24gKHRpbGVzZXQsIGluZGV4LCB4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB0aWxlc2V0IC0gVGhlIHRpbGVzZXQgdGhpcyB0aWxlIGJlbG9uZ3MgdG8uCiAgICAqLwogICAgdGhpcy50aWxlc2V0ID0gdGlsZXNldDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgd2l0aGluIHRoZSB0aWxlc2V0LgogICAgKi8KICAgIHRoaXMuaW5kZXggPSBpbmRleDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHRpbGUgaW4gcGl4ZWxzLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIHRpbGUgd2l0aGluIHRoZSB0aWxlc2V0LgogICAgKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB0b3AtbGVmdCBjb3JuZXIgb2YgdGhlIHRpbGUgd2l0aGluIHRoZSB0aWxlc2V0LgogICAgKi8KICAgIHRoaXMueSA9IHk7CgogICAgLy8gIEFueSBleHRyYSBtZXRhIGRhdGEgaW5mbyB3ZSBuZWVkIGhlcmUKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1hc3MgLSBUaGUgdmlydHVhbCBtYXNzIG9mIHRoZSB0aWxlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWFzcyA9IDEuMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlTm9uZSAtIEluZGljYXRpbmcgdGhpcyBUaWxlIGRvZXNuJ3QgY29sbGlkZSBhdCBhbGwuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlTm9uZSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZUxlZnQgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBsZWZ0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZUxlZnQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlUmlnaHQgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSByaWdodC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVSaWdodCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVVcCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHRvcC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVVcCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVEb3duIC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgYm90dG9tLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZURvd24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzZXBhcmF0ZVggLSBFbmFibGUgc2VwYXJhdGlvbiBhdCB4LWF4aXMuIAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2VwYXJhdGVYID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBzZXBhcmF0ZVkgLSBFbmFibGUgc2VwYXJhdGlvbiBhdCB5LWF4aXMuIAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2VwYXJhdGVZID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaXNpb25DYWxsYmFjayAtIFRpbGVtYXAgY29sbGlzaW9uIGNhbGxiYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlzaW9uQ2FsbGJhY2sgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpc2lvbkNhbGxiYWNrIC0gVGlsZW1hcCBjb2xsaXNpb24gY2FsbGJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaXNpb25DYWxsYmFja0NvbnRleHQgPSB0aGlzOwoKfTsKClBoYXNlci5UaWxlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU2V0IGNhbGxiYWNrIHRvIGJlIGNhbGxlZCB3aGVuIHRoaXMgdGlsZW1hcCBjb2xsaWRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAucHJvdG90eXBlLnNldENvbGxpc2lvbkNhbGxiYWNrCiAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIC0gQ2FsbGJhY2sgZnVuY3Rpb24uCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBjb250ZXh0IC0gQ2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgd2l0aCB0aGlzIGNvbnRleHQuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uQ2FsbGJhY2s6IGZ1bmN0aW9uIChjYWxsYmFjaywgY29udGV4dCkgewoKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrQ29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5jb2xsaXNpb25DYWxsYmFjayA9IGNhbGxiYWNrOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFuIHVwIG1lbW9yeS4KICAgICogQG1ldGhvZCBkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnRpbGVzZXQgPSBudWxsOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogU2V0IGNvbGxpc2lvbiBjb25maWdzLgogICAgKiBAbWV0aG9kIHNldENvbGxpc2lvbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59ICAgbGVmdCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIGxlZnQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICByaWdodCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHJpZ2h0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59ICAgdXAgLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSB0b3AuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICBkb3duIC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgYm90dG9tLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59ICAgcmVzZXQgLSBEZXNjcmlwdGlvbi4gCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICBzZXBhcmF0ZVggLSBTZXBhcmF0ZSBhdCB4LWF4aXMuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICBzZXBhcmF0ZVkgLSBTZXBhcmF0ZSBhdCB5LWF4aXMuCiAgICAqLwogICAgc2V0Q29sbGlzaW9uOiBmdW5jdGlvbiAobGVmdCwgcmlnaHQsIHVwLCBkb3duKSB7CgogICAgICAgIHRoaXMuY29sbGlkZUxlZnQgPSBsZWZ0OwogICAgICAgIHRoaXMuY29sbGlkZVJpZ2h0ID0gcmlnaHQ7CiAgICAgICAgdGhpcy5jb2xsaWRlVXAgPSB1cDsKICAgICAgICB0aGlzLmNvbGxpZGVEb3duID0gZG93bjsKCiAgICAgICAgaWYgKGxlZnQgfHwgcmlnaHQgfHwgdXAgfHwgZG93bikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29sbGlkZU5vbmUgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlTm9uZSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc2V0IGNvbGxpc2lvbiBzdGF0dXMgZmxhZ3MuCiAgICAqIEBtZXRob2QgcmVzZXRDb2xsaXNpb24KICAgICovCiAgICByZXNldENvbGxpc2lvbjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKICAgICAgICB0aGlzLmNvbGxpZGVMZWZ0ID0gZmFsc2U7CiAgICAgICAgdGhpcy5jb2xsaWRlUmlnaHQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbGxpZGVVcCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29sbGlkZURvd24gPSBmYWxzZTsKCiAgICB9Cgp9OwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgLyoqCiAgICAqIFRoZSBzdW0gb2YgdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgYm90dG9tIHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGhlaWdodCBwcm9wZXJ0eS4KICAgICogQG1ldGhvZCBib3R0b20KICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKiovCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZS5wcm90b3R5cGUsICJyaWdodCIsIHsKICAgIAogICAgLyoqCiAgICAqIFRoZSBzdW0gb2YgdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiAgICAqIEhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgogICAgKiBAbWV0aG9kIHJpZ2h0CiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICoqLyAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLndpZHRoOwogICAgfQoKfSk7CgpQaGFzZXIuVGlsZW1hcCA9IGZ1bmN0aW9uIChnYW1lLCBrZXkpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIERlc2NyaXB0aW9uLgoJKi8gCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2FycmF5fSBsYXllcnMgLSBEZXNjcmlwdGlvbi4KICAgICovCgl0aGlzLmxheWVyczsKCiAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAJdGhpcy5rZXkgPSBrZXk7CgoJCXRoaXMubGF5ZXJzID0gZ2FtZS5jYWNoZS5nZXRUaWxlbWFwRGF0YShrZXkpLmxheWVyczsKICAgICAgICB0aGlzLmNhbGN1bGF0ZUluZGV4ZXMoKTsKICAgIH0KICAgIGVsc2UKICAgIHsKCSAgICB0aGlzLmxheWVycyA9IFtdOwogICAgfQoKICAgIHRoaXMuY3VycmVudExheWVyID0gMDsKCiAgICB0aGlzLmRlYnVnTWFwID0gW107CgogICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwoKICAgIHRoaXMuX3Jlc3VsdHMgPSBbXTsKICAgIHRoaXMuX3RlbXBBID0gMDsKICAgIHRoaXMuX3RlbXBCID0gMDsKCn07CgpQaGFzZXIuVGlsZW1hcC5DU1YgPSAwOwpQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OID0gMTsKClBoYXNlci5UaWxlbWFwLnByb3RvdHlwZSA9IHsKCiAgICBjcmVhdGU6IGZ1bmN0aW9uIChuYW1lLCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHZhciBkYXRhID0gW107CgogICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspCiAgICAgICAgewogICAgICAgICAgICBkYXRhW3ldID0gW107CgogICAgICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHdpZHRoOyB4KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGRhdGFbeV1beF0gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRMYXllciA9IHRoaXMubGF5ZXJzLnB1c2goewoKCQkJbmFtZTogbmFtZSwgCgkJCXdpZHRoOiB3aWR0aCwgCgkJCWhlaWdodDogaGVpZ2h0LCAKCQkJYWxwaGE6IDEsIAoJCQl2aXNpYmxlOiB0cnVlLCAKCQkJdGlsZU1hcmdpbjogMCwgCgkJCXRpbGVTcGFjaW5nOiAwLAoJCQlmb3JtYXQ6IFBoYXNlci5UaWxlbWFwLkNTViwKCQkJZGF0YTogZGF0YSwKICAgICAgICAgICAgaW5kZXhlczogW10KCiAgICAgICAgfSk7CgogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIH0sCgogICAgY2FsY3VsYXRlSW5kZXhlczogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBsYXllciA9IDA7IGxheWVyIDwgdGhpcy5sYXllcnMubGVuZ3RoOyBsYXllcisrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmluZGV4ZXMgPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCA7IHkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7IHgrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaWR4ID0gdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbeV1beF07CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxheWVyc1tsYXllcl0uaW5kZXhlcy5pbmRleE9mKGlkeCkgPT09IC0xKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sYXllcnNbbGF5ZXJdLmluZGV4ZXMucHVzaChpZHgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIHNldExheWVyOiBmdW5jdGlvbiAobGF5ZXIpIHsKCiAgICAJaWYgKHRoaXMubGF5ZXJzW2xheWVyXSkKICAgIAl7CiAgICAJCXRoaXMuY3VycmVudExheWVyID0gbGF5ZXI7CiAgICAJfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldCBhIHNwZWNpZmljIHRpbGUgd2l0aCBpdHMgeCBhbmQgeSBpbiB0aWxlcy4KICAgICogQG1ldGhvZCBwdXRUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGlzIHRpbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGlzIHRpbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgdHlwZSBpbiB0aGUgY29yZSBtYXAgZGF0YS4KICAgICovCiAgICBwdXRUaWxlOiBmdW5jdGlvbiAoaW5kZXgsIHgsIHksIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAJaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgIAl7CiAgICAJCXRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdID0gaW5kZXg7CiAgICAJfQoKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB9LAoKICAgIGdldFRpbGU6IGZ1bmN0aW9uICh4LCB5LCBsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAidW5kZWZpbmVkIikgeyBsYXllciA9IHRoaXMuY3VycmVudExheWVyOyB9CgogICAgICAgIGlmICh4ID49IDAgJiYgeCA8IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aCAmJiB5ID49IDAgJiYgeSA8IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbeV1beF07CiAgICAgICAgfQoKICAgIH0sCgogICAgZ2V0VGlsZVdvcmxkWFk6IGZ1bmN0aW9uICh4LCB5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAgICAgeCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICAgICAgeSA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0IGEgc3BlY2lmaWMgdGlsZSB3aXRoIGl0cyB4IGFuZCB5IGluIHRpbGVzLgogICAgKiBAbWV0aG9kIHB1dFRpbGVXb3JsZFhZCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGlzIHRpbGUgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGlzIHRpbGUgaW4gd29ybGQgY29vcmRpbmF0ZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIHRpbGUgdHlwZSBpbiB0aGUgY29yZSBtYXAgZGF0YS4KICAgICovCiAgICBwdXRUaWxlV29ybGRYWTogZnVuY3Rpb24gKGluZGV4LCB4LCB5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIGxheWVyKSB7CgogICAgICAgIHggPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih4LCB0aWxlV2lkdGgpIC8gdGlsZVdpZHRoOwogICAgICAgIHkgPSB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih5LCB0aWxlSGVpZ2h0KSAvIHRpbGVIZWlnaHQ7CgogICAgICAgIGlmICh4ID49IDAgJiYgeCA8IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aCAmJiB5ID49IDAgJiYgeSA8IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XSA9IGluZGV4OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgfSwKCiAgICAvLyAgVmFsdWVzIGFyZSBpbiBUSUxFcywgbm90IHBpeGVscy4KICAgIGNvcHk6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAidW5kZWZpbmVkIikgeyBsYXllciA9IHRoaXMuY3VycmVudExheWVyOyB9CgogICAgICAgIGlmICghdGhpcy5sYXllcnNbbGF5ZXJdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0cy5sZW5ndGggPSAwOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHggPT09ICJ1bmRlZmluZWQiKSB7IHggPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5ID09PSAidW5kZWZpbmVkIikgeyB5ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2Ygd2lkdGggPT09ICJ1bmRlZmluZWQiKSB7IHdpZHRoID0gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoOyB9CiAgICAgICAgaWYgKHR5cGVvZiBoZWlnaHQgPT09ICJ1bmRlZmluZWQiKSB7IGhlaWdodCA9IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQ7IH0KCiAgICAgICAgaWYgKHggPCAwKQogICAgICAgIHsKICAgICAgICAgICAgeCA9IDA7CiAgICAgICAgfQoKICAgICAgICBpZiAoeSA8IDApCiAgICAgICAgewogICAgICAgICAgICB5ID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh3aWR0aCA+IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHdpZHRoID0gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKGhlaWdodCA+IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICBoZWlnaHQgPSB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fcmVzdWx0cy5sZW5ndGggPSAwOwoKICAgICAgICB0aGlzLl9yZXN1bHRzLnB1c2goIHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCwgbGF5ZXI6IGxheWVyIH0pOwoKICAgICAgICBmb3IgKHZhciB0eSA9IHk7IHR5IDwgeSArIGhlaWdodDsgdHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIHR4ID0geDsgdHggPCB4ICsgd2lkdGg7IHR4KyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCh7IHg6IHR4LCB5OiB0eSwgaW5kZXg6IHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3R5XVt0eF0gfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLl9yZXN1bHRzOwoKICAgIH0sCgogICAgcGFzdGU6IGZ1bmN0aW9uICh4LCB5LCB0aWxlYmxvY2ssIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgeCA9PT0gInVuZGVmaW5lZCIpIHsgeCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHkgPT09ICJ1bmRlZmluZWQiKSB7IHkgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gInVuZGVmaW5lZCIpIHsgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsgfQoKICAgICAgICBpZiAoIXRpbGVibG9jayB8fCB0aWxlYmxvY2subGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBGaW5kIG91dCB0aGUgZGlmZmVyZW5jZSBiZXR3ZWVuIHRpbGVibG9ja1sxXS54L3kgYW5kIHgveSBhbmQgdXNlIGl0IGFzIGFuIG9mZnNldCwgYXMgaXQncyB0aGUgdG9wIGxlZnQgb2YgdGhlIGJsb2NrIHRvIHBhc3RlCiAgICAgICAgdmFyIGRpZmZYID0gdGlsZWJsb2NrWzFdLnggLSB4OwogICAgICAgIHZhciBkaWZmWSA9IHRpbGVibG9ja1sxXS55IC0geTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aWxlYmxvY2subGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVsgZGlmZlkgKyB0aWxlYmxvY2tbaV0ueSBdWyBkaWZmWCArIHRpbGVibG9ja1tpXS54IF0gPSB0aWxlYmxvY2tbaV0uaW5kZXg7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTd2FwIHRpbGVzIHdpdGggMiBraW5kcyBvZiBpbmRleGVzLgogICAgKiBAbWV0aG9kIHN3YXBUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQSAtIEZpcnN0IHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQiAtIFNlY29uZCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeCBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB5IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB3aWR0aCBpbiB0aWxlcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHRdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgaGVpZ2h0IGluIHRpbGVzLgogICAgKi8KICAgIHN3YXA6IGZ1bmN0aW9uICh0aWxlQSwgdGlsZUIsIHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl90ZW1wQSA9IHRpbGVBOwogICAgICAgIHRoaXMuX3RlbXBCID0gdGlsZUI7CgogICAgICAgIHRoaXMuX3Jlc3VsdHMuZm9yRWFjaCh0aGlzLnN3YXBIYW5kbGVyLCB0aGlzKTsKCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzKTsKCiAgICB9LAoKICAgIHN3YXBIYW5kbGVyOiBmdW5jdGlvbiAodmFsdWUsIGluZGV4LCBhcnJheSkgewoKICAgICAgICBpZiAodmFsdWUuaW5kZXggPT09IHRoaXMuX3RlbXBBKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpbmRleF0uaW5kZXggPSB0aGlzLl90ZW1wQjsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodmFsdWUuaW5kZXggPT09IHRoaXMuX3RlbXBCKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpbmRleF0uaW5kZXggPSB0aGlzLl90ZW1wQTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3dhcCB0aWxlcyB3aXRoIDIga2luZHMgb2YgaW5kZXhlcy4KICAgICogQG1ldGhvZCBzd2FwVGlsZQogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUEgLSBGaXJzdCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUIgLSBTZWNvbmQgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHggcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeSBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgd2lkdGggaW4gdGlsZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIGhlaWdodCBpbiB0aWxlcy4KICAgICovCiAgICBmb3JFYWNoOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNvbnRleHQsIHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXN1bHRzLmZvckVhY2goY2FsbGJhY2ssIGNvbnRleHQpOwoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlcGxhY2VzIG9uZSB0eXBlIG9mIHRpbGUgd2l0aCBhbm90aGVyLgogICAgKiBAbWV0aG9kIHJlcGxhY2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVBIC0gRmlyc3QgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVCIC0gU2Vjb25kIHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB4IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHkgcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHdpZHRoIGluIHRpbGVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSBoZWlnaHQgaW4gdGlsZXMuCiAgICAqLwogICAgcmVwbGFjZTogZnVuY3Rpb24gKHRpbGVBLCB0aWxlQiwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9yZXN1bHRzW2ldLmluZGV4ID09PSB0aWxlQSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpXS5pbmRleCA9IHRpbGVCOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJhbmRvbWlzZXMgYSBzZXQgb2YgdGlsZXMgaW4gYSBnaXZlbiBhcmVhLiBJdCB3aWxsIG9ubHkgcmFuZG9taXNlIHRoZSB0aWxlcyBpbiB0aGF0IGFyZWEsIHNvIGlmIHRoZXkncmUgYWxsIHRoZSBzYW1lIG5vdGhpbmcgd2lsbCBhcHBlYXIgdG8gaGF2ZSBjaGFuZ2VkIQogICAgKiBAbWV0aG9kIHJhbmRvbQogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUEgLSBGaXJzdCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUIgLSBTZWNvbmQgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHggcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeSBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgd2lkdGggaW4gdGlsZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIGhlaWdodCBpbiB0aWxlcy4KICAgICovCiAgICByYW5kb206IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAidW5kZWZpbmVkIikgeyBsYXllciA9IHRoaXMuY3VycmVudExheWVyOyB9CgogICAgICAgIHRoaXMuY29weSh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcik7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHRzLmxlbmd0aCA8IDIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgaW5kZXhlcyA9IFtdOwoKICAgICAgICBmb3IgKHZhciB0ID0gMTsgdCA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyB0KyspCiAgICAgICAgewogICAgICAgICAgICB2YXIgaWR4ID0gdGhpcy5fcmVzdWx0c1t0XS5pbmRleDsKCiAgICAgICAgICAgIGlmIChpbmRleGVzLmluZGV4T2YoaWR4KSA9PT0gLTEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGluZGV4ZXMucHVzaChpZHgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRoaXMuX3Jlc3VsdHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2ldLmluZGV4ID0gdGhpcy5nYW1lLnJuZC5waWNrKGluZGV4ZXMpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSYW5kb21pc2VzIGEgc2V0IG9mIHRpbGVzIGluIGEgZ2l2ZW4gYXJlYS4gSXQgd2lsbCBvbmx5IHJhbmRvbWlzZSB0aGUgdGlsZXMgaW4gdGhhdCBhcmVhLCBzbyBpZiB0aGV5J3JlIGFsbCB0aGUgc2FtZSBub3RoaW5nIHdpbGwgYXBwZWFyIHRvIGhhdmUgY2hhbmdlZCEKICAgICogQG1ldGhvZCByYW5kb20KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVBIC0gRmlyc3QgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVCIC0gU2Vjb25kIHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB4IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHkgcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHdpZHRoIGluIHRpbGVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSBoZWlnaHQgaW4gdGlsZXMuCiAgICAqLwogICAgc2h1ZmZsZTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBoZWFkZXIgPSB0aGlzLl9yZXN1bHRzLnNoaWZ0KCk7CgogICAgICAgIFBoYXNlci5VdGlscy5zaHVmZmxlKHRoaXMuX3Jlc3VsdHMpOwoKICAgICAgICB0aGlzLl9yZXN1bHRzLnVuc2hpZnQoaGVhZGVyKTsKCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaWxsIGEgdGlsZSBibG9jayB3aXRoIGEgc3BlY2lmaWMgdGlsZSBpbmRleC4KICAgICogQG1ldGhvZCBmaWxsCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIEluZGV4IG9mIHRpbGVzIHlvdSB3YW50IHRvIGZpbGwgd2l0aC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIFggcG9zaXRpb24gKGluIHRpbGVzKSBvZiBibG9jaydzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSAtIFkgcG9zaXRpb24gKGluIHRpbGVzKSBvZiBibG9jaydzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aF0gLSB3aWR0aCBvZiBibG9jay4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHRdIC0gaGVpZ2h0IG9mIGJsb2NrLgogICAgKi8KICAgIGZpbGw6IGZ1bmN0aW9uIChpbmRleCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSBpbmRleDsKICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cyk7CgogICAgfSwKCiAgICByZW1vdmVBbGxMYXllcnM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5sYXllcnMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLmN1cnJlbnRMYXllciA9IDA7CgogICAgfSwKCiAgICBkdW1wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciB0eHQgPSAnJzsKICAgICAgICB2YXIgYXJncyA9IFsnJ107CgogICAgICAgIGZvciAodmFyIHkgPSAwOyB5IDwgdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmhlaWdodDsgeSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgeCA9IDA7IHggPCB0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0ud2lkdGg7IHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdHh0ICs9ICIlYyAgIjsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmRhdGFbeV1beF0gPiAxKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgCWlmICh0aGlzLmRlYnVnTWFwW3RoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS5kYXRhW3ldW3hdXSkKICAgICAgICAgICAgICAgIAl7CgkgICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgiYmFja2dyb3VuZDogIiArIHRoaXMuZGVidWdNYXBbdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmRhdGFbeV1beF1dKTsKICAgICAgICAgICAgICAgIAl9CiAgICAgICAgICAgICAgICAJZWxzZQogICAgICAgICAgICAgICAgCXsKCSAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKCJiYWNrZ3JvdW5kOiAjZmZmZmZmIik7CiAgICAgICAgICAgICAgICAJfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaCgiYmFja2dyb3VuZDogcmdiKDAsIDAsIDApIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHR4dCArPSAiXG4iOwogICAgICAgIH0KCiAgICAgICAgYXJnc1swXSA9IHR4dDsKICAgICAgICBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKCiAgICB9LAoKICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5yZW1vdmVBbGxMYXllcnMoKTsKICAgICAgICB0aGlzLmdhbWUgPSBudWxsOwoKICAgIH0KCn07CgovLyAgTWF5YmUgc2hvdWxkIGV4dGVuZCBTcHJpdGU/ClBoYXNlci5UaWxlbWFwTGF5ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgcmVuZGVyV2lkdGgsIHJlbmRlckhlaWdodCwgdGlsZXNldCwgdGlsZW1hcCwgbGF5ZXIpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIERlc2NyaXB0aW9uLgoJKi8gCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gY2FudmFzIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZShyZW5kZXJXaWR0aCwgcmVuZGVySGVpZ2h0KTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGNvbnRleHQgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmNhbnZhcy5nZXRDb250ZXh0KCcyZCcpOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gYmFzZVRleHR1cmUgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUodGhpcy5jYW52YXMpOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdGV4dHVyZSAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudGV4dHVyZSA9IG5ldyBQSVhJLlRleHR1cmUodGhpcy5iYXNlVGV4dHVyZSk7CiAgICAKICAgIHRoaXMudGV4dHVyZUZyYW1lID0gbmV3IFBoYXNlci5GcmFtZSgwLCAwLCAwLCByZW5kZXJXaWR0aCwgcmVuZGVySGVpZ2h0LCAndGlsZW1hcGxheWVyJywgZ2FtZS5ybmQudXVpZCgpKTsKCiAgICBQaGFzZXIuU3ByaXRlLmNhbGwodGhpcywgdGhpcy5nYW1lLCB4LCB5LCB0aGlzLnRleHR1cmUsIHRoaXMudGV4dHVyZUZyYW1lKTsKCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuVElMRU1BUExBWUVSOwoKICAgIHRoaXMuZml4ZWRUb0NhbWVyYSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHRpbGVzZXQgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLnRpbGVzZXQgPSBudWxsOwoKICAgIHRoaXMudGlsZVdpZHRoID0gMDsKICAgIHRoaXMudGlsZUhlaWdodCA9IDA7CiAgICB0aGlzLnRpbGVNYXJnaW4gPSAwOwogICAgdGhpcy50aWxlU3BhY2luZyA9IDA7CgogICAgLyoqCiAgICAqIFJlYWQtb25seSB2YXJpYWJsZSwgZG8gTk9UIHJlY29tbWVuZCBjaGFuZ2luZyBhZnRlciB0aGUgbWFwIGlzIGxvYWRlZCEKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoSW5QaXhlbHMKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndpZHRoSW5QaXhlbHMgPSAwOwoKICAgIC8qKgogICAgKiBSZWFkLW9ubHkgdmFyaWFibGUsIGRvIE5PVCByZWNvbW1lbmQgY2hhbmdpbmcgYWZ0ZXIgdGhlIG1hcCBpcyBsb2FkZWQhCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHRJblBpeGVscwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaGVpZ2h0SW5QaXhlbHMgPSAwOwoKCiAgICB0aGlzLnJlbmRlcldpZHRoID0gcmVuZGVyV2lkdGg7CiAgICB0aGlzLnJlbmRlckhlaWdodCA9IHJlbmRlckhlaWdodDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9nYSAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fZ2EgPSAxOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9keCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fZHggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9keSAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fZHkgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kdyAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fZHcgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kaCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fZGggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90eCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fdHggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF90eSAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fdHkgPSAwOwoKICAgIHRoaXMuX3Jlc3VsdHMgPSBbXTsKCiAgICB0aGlzLl90dyA9IDA7CiAgICB0aGlzLl90aCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RsIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90bCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX21heFggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX21heFggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9tYXhZIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9tYXhZID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfc3RhcnRYIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9zdGFydFggPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydFkgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3N0YXJ0WSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JvbGxGYWN0b3JYIC0gc3BlZWQgYXQgd2hpY2ggdGhpcyBsYXllciBzY3JvbGxzCgkqIGhvcml6b250YWxseSwgcmVsYXRpdmUgdG8gdGhlIGNhbWVyYSAoZS5nLiBzY3JvbGxGYWN0b3JYIG9mIDAuNSBzY3JvbGxzCgkqIGhhbGYgYXMgcXVpY2tseSBhcyB0aGUgJ25vcm1hbCcgY2FtZXJhLWxvY2tlZCBsYXllcnMgZG8pCgkqIEBkZWZhdWx0IDEKICAgICovCgl0aGlzLnNjcm9sbEZhY3RvclggPSAxOwogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JvbGxGYWN0b3JZIC0gc3BlZWQgYXQgd2hpY2ggdGhpcyBsYXllciBzY3JvbGxzCgkqIHZlcnRpY2FsbHksIHJlbGF0aXZlIHRvIHRoZSBjYW1lcmEgKGUuZy4gc2Nyb2xsRmFjdG9yWSBvZiAwLjUgc2Nyb2xscwoJKiBoYWxmIGFzIHF1aWNrbHkgYXMgdGhlICdub3JtYWwnIGNhbWVyYS1sb2NrZWQgbGF5ZXJzIGRvKQoJKiBAZGVmYXVsdCAxCiAgICAqLwoJdGhpcy5zY3JvbGxGYWN0b3JZID0gMTsKCiAgICB0aGlzLnRpbGVtYXAgPSBudWxsOwogICAgdGhpcy5sYXllciA9IG51bGw7CiAgICB0aGlzLmluZGV4ID0gMDsKCiAgICB0aGlzLl94ID0gMDsKICAgIHRoaXMuX3kgPSAwOwogICAgdGhpcy5fcHJldlggPSAwOwogICAgdGhpcy5fcHJldlkgPSAwOwoKICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIGlmICh0aWxlc2V0IGluc3RhbmNlb2YgUGhhc2VyLlRpbGVzZXQgfHwgdHlwZW9mIHRpbGVzZXQgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMudXBkYXRlVGlsZXNldCh0aWxlc2V0KTsKICAgIH0KCiAgICBpZiAodGlsZW1hcCBpbnN0YW5jZW9mIFBoYXNlci5UaWxlbWFwKQogICAgewogICAgICAgIHRoaXMudXBkYXRlTWFwRGF0YSh0aWxlbWFwLCBsYXllcik7CiAgICB9Cgp9OwoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUgPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKHRydWUsIFBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLCBQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSwgUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZW1hcExheWVyOwoKClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLnNjcm9sbFggPSB0aGlzLmdhbWUuY2FtZXJhLnggKiB0aGlzLnNjcm9sbEZhY3Rvclg7CiAgICB0aGlzLnNjcm9sbFkgPSB0aGlzLmdhbWUuY2FtZXJhLnkgKiB0aGlzLnNjcm9sbEZhY3Rvclk7CgogICAgdGhpcy5yZW5kZXIoKTsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnJlc2l6ZVdvcmxkID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuZ2FtZS53b3JsZC5zZXRCb3VuZHMoMCwgMCwgdGhpcy53aWR0aEluUGl4ZWxzLCB0aGlzLmhlaWdodEluUGl4ZWxzKTsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnVwZGF0ZVRpbGVzZXQgPSBmdW5jdGlvbiAodGlsZXNldCkgewoKICAgIGlmICh0aWxlc2V0IGluc3RhbmNlb2YgUGhhc2VyLlRpbGVzZXQpCiAgICB7CiAgICAgICAgdGhpcy50aWxlc2V0ID0gdGlsZXNldDsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGVvZiB0aWxlc2V0ID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLnRpbGVzZXQgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0VGlsZXNldCgndGlsZXMnKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy50aWxlV2lkdGggPSB0aGlzLnRpbGVzZXQudGlsZVdpZHRoOwogICAgdGhpcy50aWxlSGVpZ2h0ID0gdGhpcy50aWxlc2V0LnRpbGVIZWlnaHQ7CiAgICB0aGlzLnRpbGVNYXJnaW4gPSB0aGlzLnRpbGVzZXQudGlsZU1hcmdpbjsKICAgIHRoaXMudGlsZVNwYWNpbmcgPSB0aGlzLnRpbGVzZXQudGlsZVNwYWNpbmc7CgogICAgdGhpcy51cGRhdGVNYXgoKTsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnVwZGF0ZU1hcERhdGEgPSBmdW5jdGlvbiAodGlsZW1hcCwgbGF5ZXIpIHsKCiAgICBpZiAodHlwZW9mIGxheWVyID09PSAndW5kZWZpbmVkJykKICAgIHsKICAgICAgICBsYXllciA9IDA7CiAgICB9CgogICAgaWYgKHRpbGVtYXAgaW5zdGFuY2VvZiBQaGFzZXIuVGlsZW1hcCkKICAgIHsKICAgICAgICB0aGlzLnRpbGVtYXAgPSB0aWxlbWFwOwogICAgICAgIHRoaXMubGF5ZXIgPSB0aGlzLnRpbGVtYXAubGF5ZXJzW2xheWVyXTsKICAgICAgICB0aGlzLmluZGV4ID0gbGF5ZXI7CiAgICAgICAgdGhpcy51cGRhdGVNYXgoKTsKICAgICAgICB0aGlzLnRpbGVtYXAuZGlydHkgPSB0cnVlOwogICAgfQoKfQoKLyoqCiAqIFRha2UgYW4geCBjb29yZGluYXRlIHRoYXQgZG9lc24ndCBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAnZml4JyBpdCAKICogaW50byBhIHNjcm9sbGVkIGxvY2FsIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiAqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQogKiBAcmV0dXJuIHtudW1iZXJ9IHggY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwogKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX2ZpeFggPSBmdW5jdGlvbih4KSB7CgoJaWYgKHRoaXMuc2Nyb2xsRmFjdG9yWCA9PT0gMSkKICAgIHsKICAgICAgICByZXR1cm4geDsKICAgIH0KCgl2YXIgbGVmdF9lZGdlID0geCAtICh0aGlzLl94IC8gdGhpcy5zY3JvbGxGYWN0b3JYKTsKCglyZXR1cm4gdGhpcy5feCArIGxlZnRfZWRnZTsKCn0KCi8qKgogKiBUYWtlIGFuIHggY29vcmRpbmF0ZSB0aGF0IF9kb2VzXyBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAndW5maXgnIGl0IAogKiBiYWNrIHRvIGNhbWVyYSBzcGFjZS4gVXNlZCBwcmltYXJpbHkgaW50ZXJuYWxseQogKiBAcGFyYW0ge251bWJlcn0geCAtIHggY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwogKiBAcmV0dXJuIHtudW1iZXJ9IHggY29vcmRpbmF0ZSBpbiBjYW1lcmEgc3BhY2UKICovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLl91bmZpeFggPSBmdW5jdGlvbih4KSB7CgoJaWYgKHRoaXMuc2Nyb2xsRmFjdG9yWCA9PT0gMSkKICAgIHsKICAgICAgICByZXR1cm4geDsKICAgIH0KCgl2YXIgbGVmdF9lZGdlID0geCAtIHRoaXMuX3g7CgoJcmV0dXJuICh0aGlzLl94IC8gdGhpcy5zY3JvbGxGYWN0b3JYKSArIGxlZnRfZWRnZTsKCn0KCi8qKgogKiBUYWtlIGEgeSBjb29yZGluYXRlIHRoYXQgZG9lc24ndCBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAnZml4JyBpdCAKICogaW50byBhIHNjcm9sbGVkIGxvY2FsIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiAqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQogKiBAcmV0dXJuIHtudW1iZXJ9IHkgY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwogKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX2ZpeFkgPSBmdW5jdGlvbih5KSB7CgoJaWYgKHRoaXMuc2Nyb2xsRmFjdG9yWSA9PT0gMSkKICAgIHsKICAgICAgICByZXR1cm4geTsKICAgIH0KCgl2YXIgdG9wX2VkZ2UgPSB5IC0gKHRoaXMuX3kgLyB0aGlzLnNjcm9sbEZhY3RvclkpOwoKCXJldHVybiB0aGlzLl95ICsgdG9wX2VkZ2U7Cgp9CgovKioKICogVGFrZSBhIHkgY29vcmRpbmF0ZSB0aGF0IF9kb2VzXyBhY2NvdW50IGZvciBzY3JvbGxGYWN0b3JZIGFuZCAndW5maXgnIGl0IAogKiBiYWNrIHRvIGNhbWVyYSBzcGFjZS4gVXNlZCBwcmltYXJpbHkgaW50ZXJuYWxseQogKiBAcGFyYW0ge251bWJlcn0geSAtIHkgY29vcmRpbmF0ZSBpbiBzY3JvbGxGYWN0b3ItYWRqdXN0ZWQgZGltZW5zaW9ucwogKiBAcmV0dXJuIHtudW1iZXJ9IHkgY29vcmRpbmF0ZSBpbiBjYW1lcmEgc3BhY2UKICovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLl91bmZpeFkgPSBmdW5jdGlvbih5KSB7CgoJaWYgKHRoaXMuc2Nyb2xsRmFjdG9yWSA9PT0gMSkKICAgIHsKICAgICAgICByZXR1cm4geTsKICAgIH0KCgl2YXIgdG9wX2VkZ2UgPSB5IC0gdGhpcy5feTsKCglyZXR1cm4gKHRoaXMuX3kgLyB0aGlzLnNjcm9sbEZhY3RvclkpICsgdG9wX2VkZ2U7Cgp9CgovKioKKiBDb252ZXJ0IGEgcGl4ZWwgdmFsdWUgdG8gYSB0aWxlIGNvb3JkaW5hdGUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBwb2ludCBpbiB0YXJnZXQgdGlsZS4KKiBAcGFyYW0ge251bWJlcn0gW2xheWVyXSAtIGxheWVyIG9mIHRoaXMgdGlsZSBsb2NhdGVkLgoqIEByZXR1cm4ge251bWJlcn0gVGhlIHRpbGUgd2l0aCBzcGVjaWZpYyBwcm9wZXJ0aWVzLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWCA9IGZ1bmN0aW9uICh4KSB7CgogICAgdmFyIHRpbGVXaWR0aCA9IHRoaXMudGlsZVdpZHRoICogdGhpcy5zY2FsZS54OwoKCXJldHVybiB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih0aGlzLl9maXhYKHgpLCB0aWxlV2lkdGgpIC8gdGlsZVdpZHRoOwoKfQoKLyoqCiogQ29udmVydCBhIHBpeGVsIHZhbHVlIHRvIGEgdGlsZSBjb29yZGluYXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgcG9pbnQgaW4gdGFyZ2V0IHRpbGUuCiogQHBhcmFtIHtudW1iZXJ9IFtsYXllcl0gLSBsYXllciBvZiB0aGlzIHRpbGUgbG9jYXRlZC4KKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB0aWxlIHdpdGggc3BlY2lmaWMgcHJvcGVydGllcy4KKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuZ2V0VGlsZVkgPSBmdW5jdGlvbiAoeSkgewoKICAgIHZhciB0aWxlSGVpZ2h0ID0gdGhpcy50aWxlSGVpZ2h0ICogdGhpcy5zY2FsZS55OwoKCXJldHVybiB0aGlzLmdhbWUubWF0aC5zbmFwVG9GbG9vcih0aGlzLl9maXhZKHkpLCB0aWxlSGVpZ2h0KSAvIHRpbGVIZWlnaHQ7Cgp9CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWFkgPSBmdW5jdGlvbiAoeCwgeSwgcG9pbnQpIHsKCiAgICBwb2ludC54ID0gdGhpcy5nZXRUaWxlWCh4KTsKICAgIHBvaW50LnkgPSB0aGlzLmdldFRpbGVZKHkpOwoKICAgIHJldHVybiBwb2ludDsKCn0KCi8qKgoqIAoqIEBtZXRob2QgZ2V0VGlsZU92ZXJsYXBzCiogQHBhcmFtIHtHYW1lT2JqZWN0fSBvYmplY3QgLSBUaWxlcyB5b3Ugd2FudCB0byBnZXQgdGhhdCBvdmVybGFwcyB0aGlzLgoqIEByZXR1cm4ge2FycmF5fSBBcnJheSB3aXRoIHRpbGVzIGluZm9ybWF0aW9ucyAoZWFjaCBjb250YWlucyB4LCB5LCBhbmQgdGhlIHRpbGUpLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlcyA9IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBjb2xsaWRlcykgewoKICAgIGlmICh0aGlzLnRpbGVtYXAgPT09IG51bGwpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vICBTaG91bGQgd2Ugb25seSBnZXQgdGlsZXMgdGhhdCBoYXZlIGF0IGxlYXN0IG9uZSBvZiB0aGVpciBjb2xsaXNpb24gZmxhZ3Mgc2V0PyAodHJ1ZSA9IHllcywgZmFsc2UgPSBubyBqdXN0IGdldCB0aGVtIGFsbCkKICAgIGlmICh0eXBlb2YgY29sbGlkZXMgPT09ICd1bmRlZmluZWQnKSB7IGNvbGxpZGVzID0gZmFsc2U7IH0KCiAgICAvLyAgQ2FwIHRoZSB2YWx1ZXMKCiAgICBpZiAoeCA8IDApCiAgICB7CiAgICAgICAgeCA9IDA7CiAgICB9CgogICAgaWYgKHkgPCAwKQogICAgewogICAgICAgIHkgPSAwOwogICAgfQoKCS8vIGFkanVzdCB0aGUgeCx5IGNvb3JkaW5hdGVzIGZvciBzY3JvbGxGYWN0b3IKCXggPSB0aGlzLl9maXhYKCB4ICk7Cgl5ID0gdGhpcy5fZml4WSggeSApOwoKICAgIGlmICh3aWR0aCA+IHRoaXMud2lkdGhJblBpeGVscykKICAgIHsKICAgICAgICB3aWR0aCA9IHRoaXMud2lkdGhJblBpeGVsczsKICAgIH0KCiAgICBpZiAoaGVpZ2h0ID4gdGhpcy5oZWlnaHRJblBpeGVscykKICAgIHsKICAgICAgICBoZWlnaHQgPSB0aGlzLmhlaWdodEluUGl4ZWxzOwogICAgfQoKICAgIHZhciB0aWxlV2lkdGggPSB0aGlzLnRpbGVXaWR0aCAqIHRoaXMuc2NhbGUueDsKICAgIHZhciB0aWxlSGVpZ2h0ID0gdGhpcy50aWxlSGVpZ2h0ICogdGhpcy5zY2FsZS55OwoKICAgIC8vICBDb252ZXJ0IHRoZSBwaXhlbCB2YWx1ZXMgaW50byB0aWxlIGNvb3JkaW5hdGVzCiAgICB0aGlzLl90eCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICB0aGlzLl90eSA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKICAgIHRoaXMuX3R3ID0gKHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0NlaWwod2lkdGgsIHRpbGVXaWR0aCkgKyB0aWxlV2lkdGgpIC8gdGlsZVdpZHRoOwogICAgdGhpcy5fdGggPSAodGhpcy5nYW1lLm1hdGguc25hcFRvQ2VpbChoZWlnaHQsIHRpbGVIZWlnaHQpICsgdGlsZUhlaWdodCkgLyB0aWxlSGVpZ2h0OwoKICAgIC8vICBUaGlzIHNob3VsZCBhcHBseSB0aGUgbGF5ZXIgeC95IGhlcmUKCiAgICAvLyB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CiAgICB0aGlzLl9yZXN1bHRzID0gW107CgogICAgLy8gIHByZXR0eSBzdXJlIHdlIGRvbid0IHVzZSB0aGlzIGFueSBtb3JlPwogICAgLy8gdGhpcy5fcmVzdWx0cy5wdXNoKCB7IHg6IHgsIHk6IHksIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQsIHR4OiB0aGlzLl90eCwgdHk6IHRoaXMuX3R5LCB0dzogdGhpcy5fdHcsIHRoOiB0aGlzLl90aCB9KTsKCiAgICB2YXIgX2luZGV4ID0gMDsKICAgIHZhciBfdGlsZSA9IG51bGw7CiAgICB2YXIgc3ggPSAwOwogICAgdmFyIHN5ID0gMDsKCiAgICBmb3IgKHZhciB3eSA9IHRoaXMuX3R5OyB3eSA8IHRoaXMuX3R5ICsgdGhpcy5fdGg7IHd5KyspCiAgICB7CiAgICAgICAgZm9yICh2YXIgd3ggPSB0aGlzLl90eDsgd3ggPCB0aGlzLl90eCArIHRoaXMuX3R3OyB3eCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXIuZGF0YVt3eV0gJiYgdGhpcy5sYXllci5kYXRhW3d5XVt3eF0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBDb3VsZCBjb21iaW5lCiAgICAgICAgICAgICAgICBfaW5kZXggPSB0aGlzLmxheWVyLmRhdGFbd3ldW3d4XSAtIDE7CiAgICAgICAgICAgICAgICBfdGlsZSA9IHRoaXMudGlsZXNldC5nZXRUaWxlKF9pbmRleCk7CgogICAgICAgICAgICAgICAgc3ggPSBfdGlsZS53aWR0aCAqIHRoaXMuc2NhbGUueDsKICAgICAgICAgICAgICAgIHN5ID0gX3RpbGUuaGVpZ2h0ICogdGhpcy5zY2FsZS55OwoKICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlcyA9PSBmYWxzZSB8fCAoY29sbGlkZXMgJiYgX3RpbGUuY29sbGlkZU5vbmUgPT0gZmFsc2UpKQogICAgICAgICAgICAgICAgewoJCQkJCS8vIGNvbnZlcnQgdGlsZSBjb29yZGluYXRlcyBiYWNrIHRvIGNhbWVyYSBzcGFjZSBmb3IgcmV0dXJuCgkJCQkJdmFyIF93eCA9IHRoaXMuX3VuZml4WCggd3gqc3ggKSAvIHRpbGVXaWR0aDsKCQkJCQl2YXIgX3d5ID0gdGhpcy5fdW5maXhZKCB3eSpzeSApIC8gdGlsZUhlaWdodDsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZXN1bHRzLnB1c2goeyB4OiBfd3ggKiBzeCwgcmlnaHQ6IChfd3ggKiBzeCkgKyBzeCwgeTogX3d5ICogc3ksIGJvdHRvbTogKF93eSAqIHN5KSArIHN5LCB3aWR0aDogc3gsIGhlaWdodDogc3ksIHR4OiBfd3gsIHR5OiBfd3ksIHRpbGU6IF90aWxlIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHJldHVybiB0aGlzLl9yZXN1bHRzOwoKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUudXBkYXRlTWF4ID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuX21heFggPSB0aGlzLmdhbWUubWF0aC5jZWlsKHRoaXMuY2FudmFzLndpZHRoIC8gdGhpcy50aWxlV2lkdGgpICsgMTsKICAgIHRoaXMuX21heFkgPSB0aGlzLmdhbWUubWF0aC5jZWlsKHRoaXMuY2FudmFzLmhlaWdodCAvIHRoaXMudGlsZUhlaWdodCkgKyAxOwoKICAgIGlmICh0aGlzLmxheWVyKQogICAgewogICAgICAgIGlmICh0aGlzLl9tYXhYID4gdGhpcy5sYXllci53aWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX21heFggPSB0aGlzLmxheWVyLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX21heFkgPiB0aGlzLmxheWVyLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX21heFkgPSB0aGlzLmxheWVyLmhlaWdodDsKICAgICAgICB9CgogICAgICAgIHRoaXMud2lkdGhJblBpeGVscyA9IHRoaXMubGF5ZXIud2lkdGggKiB0aGlzLnRpbGVXaWR0aDsKICAgICAgICB0aGlzLmhlaWdodEluUGl4ZWxzID0gdGhpcy5sYXllci5oZWlnaHQgKiB0aGlzLnRpbGVIZWlnaHQ7CiAgICB9CgogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cgp9CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbiAoKSB7CgogICAgaWYgKHRoaXMudGlsZW1hcCAmJiB0aGlzLnRpbGVtYXAuZGlydHkpCiAgICB7CiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgaWYgKCF0aGlzLmRpcnR5IHx8ICF0aGlzLnRpbGVzZXQgfHwgIXRoaXMudGlsZW1hcCB8fCAhdGhpcy52aXNpYmxlKQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLl9wcmV2WCA9IHRoaXMuX2R4OwogICAgdGhpcy5fcHJldlkgPSB0aGlzLl9keTsKCiAgICB0aGlzLl9keCA9IC0odGhpcy5feCAtICh0aGlzLl9zdGFydFggKiB0aGlzLnRpbGVXaWR0aCkpOwogICAgdGhpcy5fZHkgPSAtKHRoaXMuX3kgLSAodGhpcy5fc3RhcnRZICogdGhpcy50aWxlSGVpZ2h0KSk7CgogICAgdGhpcy5fdHggPSB0aGlzLl9keDsKICAgIHRoaXMuX3R5ID0gdGhpcy5fZHk7CgogICAgdGhpcy5jb250ZXh0LmNsZWFyUmVjdCgwLCAwLCB0aGlzLmNhbnZhcy53aWR0aCwgdGhpcy5jYW52YXMuaGVpZ2h0KTsKCiAgICBmb3IgKHZhciB5ID0gdGhpcy5fc3RhcnRZOyB5IDwgdGhpcy5fc3RhcnRZICsgdGhpcy5fbWF4WTsgeSsrKQogICAgewogICAgICAgIHRoaXMuX2NvbHVtbiA9IHRoaXMubGF5ZXIuZGF0YVt5XTsKCiAgICAgICAgZm9yICh2YXIgeCA9IHRoaXMuX3N0YXJ0WDsgeCA8IHRoaXMuX3N0YXJ0WCArIHRoaXMuX21heFg7IHgrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBvbmx5IC0xIG9uIFRJTEVEIG1hcHMsIG5vdCBDU1YKICAgICAgICAgICAgdmFyIHRpbGUgPSB0aGlzLnRpbGVzZXQudGlsZXNbdGhpcy5fY29sdW1uW3hdLTFdOwoKICAgICAgICAgICAgaWYgKHRpbGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5kcmF3SW1hZ2UoCiAgICAgICAgICAgICAgICAgICAgdGhpcy50aWxlc2V0LmltYWdlLAogICAgICAgICAgICAgICAgICAgIHRpbGUueCwKICAgICAgICAgICAgICAgICAgICB0aWxlLnksCiAgICAgICAgICAgICAgICAgICAgdGhpcy50aWxlV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgdGhpcy50aWxlSGVpZ2h0LAogICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHgpLAogICAgICAgICAgICAgICAgICAgIE1hdGguZmxvb3IodGhpcy5fdHkpLAogICAgICAgICAgICAgICAgICAgIHRoaXMudGlsZVdpZHRoLAogICAgICAgICAgICAgICAgICAgIHRoaXMudGlsZUhlaWdodAogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fdHggKz0gdGhpcy50aWxlV2lkdGg7CgogICAgICAgIH0KCiAgICAgICAgdGhpcy5fdHggPSB0aGlzLl9keDsKICAgICAgICB0aGlzLl90eSArPSB0aGlzLnRpbGVIZWlnaHQ7CiAgICB9CgogICAgLy8gIE9ubHkgbmVlZGVkIGlmIHJ1bm5pbmcgaW4gV2ViR0wsIG90aGVyd2lzZSB0aGlzIGFycmF5IHdpbGwgbmV2ZXIgZ2V0IGNsZWFyZWQgZG93biBJIGRvbid0IHRoaW5rIQogICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09IFBoYXNlci5XRUJHTCkKICAgIHsKICAgICAgICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLmJhc2VUZXh0dXJlKTsKICAgIH0KCiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CgogICAgaWYgKHRoaXMudGlsZW1hcC5kaXJ0eSkKICAgIHsKICAgICAgICB0aGlzLnRpbGVtYXAuZGlydHkgPSBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmRlbHRhQWJzWCA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAodGhpcy5kZWx0YVgoKSA+IDAgPyB0aGlzLmRlbHRhWCgpIDogLXRoaXMuZGVsdGFYKCkpOwp9CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5kZWx0YUFic1kgPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gKHRoaXMuZGVsdGFZKCkgPiAwID8gdGhpcy5kZWx0YVkoKSA6IC10aGlzLmRlbHRhWSgpKTsKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuZGVsdGFYID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2R4IC0gdGhpcy5fcHJldlg7Cn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmRlbHRhWSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiB0aGlzLl9keSAtIHRoaXMuX3ByZXZZOwp9CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsICJzY3JvbGxYIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl94ICYmIHZhbHVlID49IDAgJiYgdGhpcy5sYXllcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3ggPSB2YWx1ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLl94ID4gKHRoaXMud2lkdGhJblBpeGVscyAtIHRoaXMucmVuZGVyV2lkdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl94ID0gdGhpcy53aWR0aEluUGl4ZWxzIC0gdGhpcy5yZW5kZXJXaWR0aDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fc3RhcnRYID0gdGhpcy5nYW1lLm1hdGguZmxvb3IodGhpcy5feCAvIHRoaXMudGlsZVdpZHRoKTsKCiAgICAgICAgICAgIGlmICh0aGlzLl9zdGFydFggPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdGFydFggPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5fc3RhcnRYICsgdGhpcy5fbWF4WCA+IHRoaXMubGF5ZXIud2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WCA9IHRoaXMubGF5ZXIud2lkdGggLSB0aGlzLl9tYXhYOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB9CgogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsICJzY3JvbGxZIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5feTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl95ICYmIHZhbHVlID49IDAgJiYgdGhpcy5sYXllcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3kgPSB2YWx1ZTsKCiAgICAgICAgICAgIGlmICh0aGlzLl95ID4gKHRoaXMuaGVpZ2h0SW5QaXhlbHMgLSB0aGlzLnJlbmRlckhlaWdodCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3kgPSB0aGlzLmhlaWdodEluUGl4ZWxzIC0gdGhpcy5yZW5kZXJIZWlnaHQ7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3N0YXJ0WSA9IHRoaXMuZ2FtZS5tYXRoLmZsb29yKHRoaXMuX3kgLyB0aGlzLnRpbGVIZWlnaHQpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WSA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9zdGFydFkgKyB0aGlzLl9tYXhZID4gdGhpcy5sYXllci5oZWlnaHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WSA9IHRoaXMubGF5ZXIuaGVpZ2h0IC0gdGhpcy5fbWF4WTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKUGhhc2VyLlRpbGVtYXBQYXJzZXIgPSB7CgoJdGlsZXNldDogZnVuY3Rpb24gKGdhbWUsIGtleSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0LCB0aWxlTWF4LCB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZykgewoKCSAgICAvLyAgSG93IGJpZyBpcyBvdXIgaW1hZ2U/CgkgICAgdmFyIGltZyA9IGdhbWUuY2FjaGUuZ2V0VGlsZXNldEltYWdlKGtleSk7CgoJICAgIGlmIChpbWcgPT0gbnVsbCkKCSAgICB7CgkgICAgICAgIHJldHVybiBudWxsOwoJICAgIH0KCgkgICAgdmFyIHdpZHRoID0gaW1nLndpZHRoOwoJICAgIHZhciBoZWlnaHQgPSBpbWcuaGVpZ2h0OwoKCSAgICAvLwlJZiBubyB0aWxlIHdpZHRoL2hlaWdodCBpcyBnaXZlbiwgdHJ5IGFuZCBmaWd1cmUgaXQgb3V0ICh3b24ndCB3b3JrIGlmIHRoZSB0aWxlc2V0IGhhcyBtYXJnaW4vc3BhY2luZykKCSAgICBpZiAodGlsZVdpZHRoIDw9IDApCgkgICAgewoJICAgICAgICB0aWxlV2lkdGggPSBNYXRoLmZsb29yKC13aWR0aCAvIE1hdGgubWluKC0xLCB0aWxlV2lkdGgpKTsKCSAgICB9CgoJICAgIGlmICh0aWxlSGVpZ2h0IDw9IDApCgkgICAgewoJICAgICAgICB0aWxlSGVpZ2h0ID0gTWF0aC5mbG9vcigtaGVpZ2h0IC8gTWF0aC5taW4oLTEsIHRpbGVIZWlnaHQpKTsKCSAgICB9CgoJICAgIHZhciByb3cgPSBNYXRoLnJvdW5kKHdpZHRoIC8gdGlsZVdpZHRoKTsKCSAgICB2YXIgY29sdW1uID0gTWF0aC5yb3VuZChoZWlnaHQgLyB0aWxlSGVpZ2h0KTsKCSAgICB2YXIgdG90YWwgPSByb3cgKiBjb2x1bW47CgkgICAgCgkgICAgaWYgKHRpbGVNYXggIT09IC0xKQoJICAgIHsKCSAgICAgICAgdG90YWwgPSB0aWxlTWF4OwoJICAgIH0KCgkgICAgLy8gIFplcm8gb3Igc21hbGxlciB0aGFuIHRpbGUgc2l6ZXM/CgkgICAgaWYgKHdpZHRoID09IDAgfHwgaGVpZ2h0ID09IDAgfHwgd2lkdGggPCB0aWxlV2lkdGggfHwgaGVpZ2h0IDwgdGlsZUhlaWdodCB8fCB0b3RhbCA9PT0gMCkKCSAgICB7CgkgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlRpbGVtYXBQYXJzZXIudGlsZVNldDogd2lkdGgvaGVpZ2h0IHplcm8gb3Igd2lkdGgvaGVpZ2h0IDwgZ2l2ZW4gdGlsZVdpZHRoL3RpbGVIZWlnaHQiKTsKCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoKCSAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgdGlsZXMKCSAgICB2YXIgeCA9IHRpbGVNYXJnaW47CgkgICAgdmFyIHkgPSB0aWxlTWFyZ2luOwoKCSAgICB2YXIgdGlsZXNldCA9IG5ldyBQaGFzZXIuVGlsZXNldChpbWcsIGtleSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0LCB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZyk7CgoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdG90YWw7IGkrKykKCSAgICB7CgkgICAgICAgIHRpbGVzZXQuYWRkVGlsZShuZXcgUGhhc2VyLlRpbGUodGlsZXNldCwgaSwgeCwgeSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0KSk7CgoJICAgICAgICB4ICs9IHRpbGVXaWR0aCArIHRpbGVTcGFjaW5nOwoKCSAgICAgICAgaWYgKHggPT09IHdpZHRoKQoJICAgICAgICB7CgkgICAgICAgICAgICB4ID0gdGlsZU1hcmdpbjsKCSAgICAgICAgICAgIHkgKz0gdGlsZUhlaWdodCArIHRpbGVTcGFjaW5nOwoJICAgICAgICB9CgkgICAgfQoKCSAgICByZXR1cm4gdGlsZXNldDsKCgl9LAoKCXBhcnNlOiBmdW5jdGlvbiAoZ2FtZSwgZGF0YSwgZm9ybWF0KSB7CgoJCWlmIChmb3JtYXQgPT09IFBoYXNlci5UaWxlbWFwLkNTVikKCQl7CgkJCXJldHVybiB0aGlzLnBhcnNlQ1NWKGRhdGEpOwoJCX0KCQllbHNlIGlmIChmb3JtYXQgPT09IFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04pCgkJewoJCQlyZXR1cm4gdGhpcy5wYXJzZVRpbGVkSlNPTihkYXRhKTsKCQl9CgoJfSwKCgkvKioKCSogUGFyc2UgY3N2IG1hcCBkYXRhIGFuZCBnZW5lcmF0ZSB0aWxlcy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAucHJvdG90eXBlLnBhcnNlQ1NWCgkqIEBwYXJhbSB7c3RyaW5nfSBkYXRhIC0gQ1NWIG1hcCBkYXRhLgoJKi8KCXBhcnNlQ1NWOiBmdW5jdGlvbiAoZGF0YSkgewoKCSAgICAvLyAgVHJpbSBhbnkgcm9ndWUgd2hpdGVzcGFjZSBmcm9tIHRoZSBkYXRhCgkgICAgZGF0YSA9IGRhdGEudHJpbSgpOwoKCSAgICB2YXIgb3V0cHV0ID0gW107CgkgICAgdmFyIHJvd3MgPSBkYXRhLnNwbGl0KCJcbiIpOwoJICAgIHZhciBoZWlnaHQgPSByb3dzLmxlbmd0aDsKCSAgICB2YXIgd2lkdGggPSAwOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJvd3MubGVuZ3RoOyBpKyspCgkgICAgewoJICAgIAlvdXRwdXRbaV0gPSBbXTsKCgkgICAgICAgIHZhciBjb2x1bW4gPSByb3dzW2ldLnNwbGl0KCIsIik7CgoJICAgICAgICBmb3IgKHZhciBjID0gMDsgYyA8IGNvbHVtbi5sZW5ndGg7IGMrKykKCSAgICAgICAgewoJICAgICAgICAgICAgb3V0cHV0W2ldW2NdID0gcGFyc2VJbnQoY29sdW1uW2NdKTsKCSAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHdpZHRoID09IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgCXdpZHRoID0gY29sdW1uLmxlbmd0aDsKICAgICAgICAgICAgfQoJICAgIH0KCgkgICAgcmV0dXJuIFt7IG5hbWU6ICdjc3YnLCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0LCBhbHBoYTogMSwgdmlzaWJsZTogdHJ1ZSwgaW5kZXhlczogW10sIHRpbGVNYXJnaW46IDAsIHRpbGVTcGFjaW5nOiAwLCBkYXRhOiBvdXRwdXQgfV07CgoJfSwKCgkvKioKCSogUGFyc2UgSlNPTiBtYXAgZGF0YSBhbmQgZ2VuZXJhdGUgdGlsZXMuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5UaWxlbWFwLnByb3RvdHlwZS5wYXJzZVRpbGVkSlNPTgoJKiBAcGFyYW0ge3N0cmluZ30gZGF0YSAtIEpTT04gbWFwIGRhdGEuCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRpbGVzZXQgaW1hZ2UuCgkqLwoJcGFyc2VUaWxlZEpTT046IGZ1bmN0aW9uIChqc29uKSB7CgoJCXZhciBsYXllcnMgPSBbXTsKCgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBqc29uLmxheWVycy5sZW5ndGg7IGkrKykKCSAgICB7CgkgICAgICAgIC8vICBDaGVjayBpdCdzIGEgZGF0YSBsYXllcgoJICAgICAgICBpZiAoIWpzb24ubGF5ZXJzW2ldLmRhdGEpCgkgICAgICAgIHsKCSAgICAgICAgICAgIGNvbnRpbnVlOwoJICAgICAgICB9CgoJCQkvLwlqc29uLnRpbGV3aWR0aAoJCQkvLwlqc29uLnRpbGVoZWlnaHQKCgkgICAgICAgIHZhciBsYXllciA9IHsKCgkJICAgICAgICBuYW1lOiBqc29uLmxheWVyc1tpXS5uYW1lLAoJCSAgICAgICAgd2lkdGg6IGpzb24ubGF5ZXJzW2ldLndpZHRoLAoJCSAgICAgICAgaGVpZ2h0OiBqc29uLmxheWVyc1tpXS5oZWlnaHQsCgkJICAgICAgICBhbHBoYToganNvbi5sYXllcnNbaV0ub3BhY2l0eSwKCQkgICAgICAgIHZpc2libGU6IGpzb24ubGF5ZXJzW2ldLnZpc2libGUsCgkJICAgICAgICBpbmRleGVzOiBbXSwKCgkJICAgICAgICB0aWxlTWFyZ2luOiBqc29uLnRpbGVzZXRzWzBdLm1hcmdpbiwKCQkgICAgICAgIHRpbGVTcGFjaW5nOiBqc29uLnRpbGVzZXRzWzBdLnNwYWNpbmcsCgoJICAgICAgICB9OwoKCSAgICAgICAgdmFyIG91dHB1dCA9IFtdOwoJICAgICAgICB2YXIgYyA9IDA7CgkgICAgICAgIHZhciByb3c7CgoJICAgICAgICBmb3IgKHZhciB0ID0gMDsgdCA8IGpzb24ubGF5ZXJzW2ldLmRhdGEubGVuZ3RoOyB0KyspCgkgICAgICAgIHsKCSAgICAgICAgICAgIGlmIChjID09IDApCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgcm93ID0gW107CgkgICAgICAgICAgICB9CgoJICAgICAgICAgICAgcm93LnB1c2goanNvbi5sYXllcnNbaV0uZGF0YVt0XSk7CgkgICAgICAgICAgICBjKys7CgoJICAgICAgICAgICAgaWYgKGMgPT0ganNvbi5sYXllcnNbaV0ud2lkdGgpCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAJb3V0cHV0LnB1c2gocm93KTsKCSAgICAgICAgICAgICAgICBjID0gMDsKCSAgICAgICAgICAgIH0KCSAgICAgICAgfQoKCSAgICAgICAgbGF5ZXIuZGF0YSA9IG91dHB1dDsKCSAgICAgICAgCgkgICAgICAgIGxheWVycy5wdXNoKGxheWVyKTsKCgkgICAgfQoKCSAgICByZXR1cm4gbGF5ZXJzOwoKCX0KCn0KCgpQaGFzZXIuVGlsZXNldCA9IGZ1bmN0aW9uIChpbWFnZSwga2V5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nKSB7CgogICAgaWYgKHR5cGVvZiB0aWxlTWFyZ2luID09PSAidW5kZWZpbmVkIikgeyB0aWxlTWFyZ2luID0gMDsgfQogICAgaWYgKHR5cGVvZiB0aWxlU3BhY2luZyA9PT0gInVuZGVmaW5lZCIpIHsgdGlsZVNwYWNpbmcgPSAwOyB9CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXkgLSBUaGUgY2FjaGUgSUQuCiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgdGhpcy5pbWFnZSA9IGltYWdlOwoKICAgIHRoaXMudGlsZVdpZHRoID0gdGlsZVdpZHRoOwogICAgdGhpcy50aWxlSGVpZ2h0ID0gdGlsZUhlaWdodDsKICAgIHRoaXMubWFyZ2luID0gdGlsZU1hcmdpbjsKICAgIHRoaXMuc3BhY2luZyA9IHRpbGVTcGFjaW5nOwoKICAgIHRoaXMudGlsZXMgPSBbXTsKCn0KClBoYXNlci5UaWxlc2V0LnByb3RvdHlwZSA9IHsKCiAgICBhZGRUaWxlOiBmdW5jdGlvbiAodGlsZSkgewoKICAgICAgICB0aGlzLnRpbGVzLnB1c2godGlsZSk7CgogICAgICAgIHJldHVybiB0aWxlOwoKICAgIH0sCgogICAgZ2V0VGlsZTogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgICAgIGlmICh0aGlzLnRpbGVzW2luZGV4XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnRpbGVzW2luZGV4XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgc2V0U3BhY2luZzogZnVuY3Rpb24gKG1hcmdpbiwgc3BhY2luZykgewoKICAgICAgICB0aGlzLnRpbGVNYXJnaW4gPSBtYXJnaW47CiAgICAgICAgdGhpcy50aWxlU3BhY2luZyA9IHNwYWNpbmc7CgogICAgfSwKCiAgICBjYW5Db2xsaWRlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMudGlsZXNbaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGlsZXNbaW5kZXhdLmNvbGxpZGVOb25lOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICBjaGVja1RpbGVJbmRleDogZnVuY3Rpb24gKGluZGV4KSB7CgogICAgCXJldHVybiAodGhpcy50aWxlc1tpbmRleF0pOwoKICAgIH0sCgogICAgc2V0Q29sbGlzaW9uUmFuZ2U6IGZ1bmN0aW9uIChzdGFydCwgc3RvcCwgbGVmdCwgcmlnaHQsIHVwLCBkb3duKSB7CgogICAgICAgIGlmICh0aGlzLnRpbGVzW3N0YXJ0XSAmJiB0aGlzLnRpbGVzW3N0b3BdICYmIHN0YXJ0IDwgc3RvcCkKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA8PSBzdG9wOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudGlsZXNbaV0uc2V0Q29sbGlzaW9uKGxlZnQsIHJpZ2h0LCB1cCwgZG93bik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICBzZXRDb2xsaXNpb246IGZ1bmN0aW9uIChpbmRleCwgbGVmdCwgcmlnaHQsIHVwLCBkb3duKSB7CgogICAgICAgIGlmICh0aGlzLnRpbGVzW2luZGV4XSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudGlsZXNbaW5kZXhdLnNldENvbGxpc2lvbihsZWZ0LCByaWdodCwgdXAsIGRvd24pOwogICAgICAgIH0KCiAgICB9LAoKfQoKLyoqCiogQG5hbWUgUGhhc2VyLlRpbGVzZXQjdG90YWwKKiBAcHJvcGVydHkge251bWJlcn0gdG90YWwgLSBUaGUgdG90YWwgbnVtYmVyIG9mIHRpbGVzIGluIHRoaXMgVGlsZXNldC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlc2V0LnByb3RvdHlwZSwgInRvdGFsIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnRpbGVzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogV2UncmUgcmVwbGFjaW5nIGEgY291cGxlIG9mIFBpeGkncyBtZXRob2RzIGhlcmUgdG8gZml4IG9yIGFkZCBzb21lIHZpdGFsIGZ1bmN0aW9uYWxpdHk6CioKKiAxKSBBZGRlZCBzdXBwb3J0IGZvciBUcmltbWVkIHNwcml0ZSBzaGVldHMKKiAyKSBTa2lwIGRpc3BsYXkgb2JqZWN0cyB3aXRoIGFuIGFscGhhIG9mIHplcm8KKiAzKSBBdm9pZCBTdHlsZSBSZWNhbGN1bGF0aW9uIGZyb20gdGhlIGluY29ycmVjdCBiZ2NvbG9yIHZhbHVlCioKKiBIb3BlZnVsbHkgd2UgY2FuIHJlbW92ZSB0aGlzIG9uY2UgUGl4aSBoYXMgYmVlbiB1cGRhdGVkIHRvIHN1cHBvcnQgdGhlc2UgdGhpbmdzLgoqLwoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyBjYW52YXMgdmlldwogKgogKiBAbWV0aG9kIHJlbmRlcgogKiBAcGFyYW0gc3RhZ2Uge1N0YWdlfSB0aGUgU3RhZ2UgZWxlbWVudCB0byBiZSByZW5kZXJlZAogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oc3RhZ2UpCnsKCVBJWEkudGV4dHVyZXNUb1VwZGF0ZS5sZW5ndGggPSAwOwoJUElYSS50ZXh0dXJlc1RvRGVzdHJveS5sZW5ndGggPSAwOwoJCglQSVhJLnZpc2libGVDb3VudCsrOwoJc3RhZ2UudXBkYXRlVHJhbnNmb3JtKCk7CgkKCS8vIHVwZGF0ZSB0aGUgYmFja2dyb3VuZCBjb2xvcgoJLy8gaWYodGhpcy52aWV3LnN0eWxlLmJhY2tncm91bmRDb2xvciE9c3RhZ2UuYmFja2dyb3VuZENvbG9yU3RyaW5nICYmICF0aGlzLnRyYW5zcGFyZW50KXRoaXMudmlldy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTdHJpbmc7CgoJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybSgxLCAwLCAwLCAxLCAwLCAwKTsgCgl0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KQogICAgdGhpcy5yZW5kZXJEaXNwbGF5T2JqZWN0KHN0YWdlKTsKICAgCgkvLwlSZW1vdmUgZnJhbWUgdXBkYXRlcwoJaWYgKFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID4gMCkKCXsKCQlQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLmxlbmd0aCA9IDA7Cgl9CgkKfQoKUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyRGlzcGxheU9iamVjdCA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIE9uY2UgdGhlIGRpc3BsYXkgb2JqZWN0IGhpdHMgdGhpcyB3ZSBjYW4gYnJlYWsgdGhlIGxvb3AJCgl2YXIgdGVzdE9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CglkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCQoJZG8JCgl7CgkJLy90cmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoJCQoJCWlmICghZGlzcGxheU9iamVjdC52aXNpYmxlKQoJCXsKCQkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QubGFzdC5faU5leHQ7CgkJCWNvbnRpbnVlOwoJCX0KCQkKCQlpZiAoIWRpc3BsYXlPYmplY3QucmVuZGVyYWJsZSB8fCBkaXNwbGF5T2JqZWN0LmFscGhhID09IDApCgkJewoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7CgkJCWNvbnRpbnVlOwoJCX0KCQkKCQlpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJCXsKCQkJLy8gdmFyIGZyYW1lID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lOwoJCQkKCQkJaWYgKGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZSkKCQkJewoJCQkJdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoJCQkJCgkJCQlpZiAoZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW1tZWQpCgkJCQl7CgkJCQkJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdICsgZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueCwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSArIGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLnkpOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVszXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSk7CgkJCQl9CgkJCQkJCgkJCQl0aGlzLmNvbnRleHQuZHJhd0ltYWdlKAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsIAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS54LAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS55LAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCwKCQkJCQlkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0LAoJCQkJCShkaXNwbGF5T2JqZWN0LmFuY2hvci54KSAqIC1kaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGgsIAoJCQkJCShkaXNwbGF5T2JqZWN0LmFuY2hvci55KSAqIC1kaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0LAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCwKCQkJCQlkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0KTsKCQkJfQkJCQkJICAgCgkgICAJfQoJICAgCWVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQoJCXsKCQkJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKQoJCQl0aGlzLnJlbmRlclN0cmlwKGRpc3BsYXlPYmplY3QpOwoJCX0KCQllbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCgkJewoJCQl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMV0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0pCgkJCXRoaXMucmVuZGVyVGlsaW5nU3ByaXRlKGRpc3BsYXlPYmplY3QpOwoJCX0KCQllbHNlIGlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5DdXN0b21SZW5kZXJhYmxlKQoJCXsKCQkJZGlzcGxheU9iamVjdC5yZW5kZXJDYW52YXModGhpcyk7CgkJfQoJCWVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJCXsKCQkJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKQoJCQlQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzKGRpc3BsYXlPYmplY3QsIHRoaXMuY29udGV4dCk7CgkJfQoJCWVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkZpbHRlckJsb2NrKQoJCXsKCQkJaWYgKGRpc3BsYXlPYmplY3Qub3BlbikKCQkJewoJCQkJdGhpcy5jb250ZXh0LnNhdmUoKTsKCQkJCQoJCQkJdmFyIGNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0Lm1hc2suYWxwaGE7CgkJCQl2YXIgbWFza1RyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3QubWFzay53b3JsZFRyYW5zZm9ybTsKCQkJCQoJCQkJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShtYXNrVHJhbnNmb3JtWzBdLCBtYXNrVHJhbnNmb3JtWzNdLCBtYXNrVHJhbnNmb3JtWzFdLCBtYXNrVHJhbnNmb3JtWzRdLCBtYXNrVHJhbnNmb3JtWzJdLCBtYXNrVHJhbnNmb3JtWzVdKQoJCQkJCgkJCQlkaXNwbGF5T2JqZWN0Lm1hc2sud29ybGRBbHBoYSA9IDAuNTsKCQkJCQoJCQkJdGhpcy5jb250ZXh0LndvcmxkQWxwaGEgPSAwOwoJCQkJCgkJCQlQSVhJLkNhbnZhc0dyYXBoaWNzLnJlbmRlckdyYXBoaWNzTWFzayhkaXNwbGF5T2JqZWN0Lm1hc2ssIHRoaXMuY29udGV4dCk7CgkJCQl0aGlzLmNvbnRleHQuY2xpcCgpOwoJCQkJCgkJCQlkaXNwbGF5T2JqZWN0Lm1hc2sud29ybGRBbHBoYSA9IGNhY2hlQWxwaGE7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl0aGlzLmNvbnRleHQucmVzdG9yZSgpOwoJCQl9CgkJfQoJCS8vCWNvdW50KysKCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5faU5leHQ7Cgl9Cgl3aGlsZShkaXNwbGF5T2JqZWN0ICE9IHRlc3RPYmplY3QpCgkKfQoKUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IHRoaXMuZ2w7Cgl2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGluZGV4LCBpbmRleDIsIGluZGV4MwoKCXZhciBhLCBiLCBjLCBkLCB0eCwgdHk7CgoJdmFyIGluZGV4UnVuID0gMDsKCgl2YXIgZGlzcGxheU9iamVjdCA9IHRoaXMuaGVhZDsKCgl3aGlsZShkaXNwbGF5T2JqZWN0KQoJewoJCWlmKGRpc3BsYXlPYmplY3QudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudCkKCQl7CgkJCXdpZHRoID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoOwoJCQloZWlnaHQgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKCQkJLy8gVE9ETyB0cmltPz8KCQkJYVggPSBkaXNwbGF5T2JqZWN0LmFuY2hvci54Oy8vIC0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueAoJCQlhWSA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLnk7IC8vLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55CgkJCXcwID0gd2lkdGggKiAoMS1hWCk7CgkJCXcxID0gd2lkdGggKiAtYVg7CgoJCQloMCA9IGhlaWdodCAqICgxLWFZKTsKCQkJaDEgPSBoZWlnaHQgKiAtYVk7CgoJCQlpbmRleCA9IGluZGV4UnVuICogODsKCgkJCXdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKCgkJCWEgPSB3b3JsZFRyYW5zZm9ybVswXTsKCQkJYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwoJCQljID0gd29ybGRUcmFuc2Zvcm1bMV07CgkJCWQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKCQkJdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKCQkJdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCgkJCWlmIChkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbW1lZCkKCQkJewoJCQkJdHggKz0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueDsKCQkJCXR5ICs9IGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLnk7CgkJCX0KCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgMCBdID0gYSAqIHcxICsgYyAqIGgxICsgdHg7IAoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDEgXSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAyIF0gPSBhICogdzAgKyBjICogaDEgKyB0eDsgCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgMyBdID0gZCAqIGgxICsgYiAqIHcwICsgdHk7IAoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA0IF0gPSBhICogdzAgKyBjICogaDAgKyB0eDsgCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgNSBdID0gZCAqIGgwICsgYiAqIHcwICsgdHk7IAoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA2XSA9ICBhICogdzEgKyBjICogaDAgKyB0eDsgCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgN10gPSAgZCAqIGgwICsgYiAqIHcxICsgdHk7IAoKCQkJaWYoZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSB8fCBkaXNwbGF5T2JqZWN0LnRleHR1cmUudXBkYXRlRnJhbWUpCgkJCXsKCQkJCXRoaXMuZGlydHlVVlMgPSB0cnVlOwoKCQkJCXZhciB0ZXh0dXJlID0gZGlzcGxheU9iamVjdC50ZXh0dXJlOwoKCQkJCXZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CgkJCQl2YXIgdHcgPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoOwoJCQkJdmFyIHRoID0gdGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgoJCQkJdGhpcy51dnNbaW5kZXggKyAwXSA9IGZyYW1lLnggLyB0dzsKCQkJCXRoaXMudXZzW2luZGV4ICsxXSA9IGZyYW1lLnkgLyB0aDsKCgkJCQl0aGlzLnV2c1tpbmRleCArMl0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwoJCQkJdGhpcy51dnNbaW5kZXggKzNdID0gZnJhbWUueSAvIHRoOwoKCQkJCXRoaXMudXZzW2luZGV4ICs0XSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CgkJCQl0aGlzLnV2c1tpbmRleCArNV0gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsgCgoJCQkJdGhpcy51dnNbaW5kZXggKzZdID0gZnJhbWUueCAvIHR3OwoJCQkJdGhpcy51dnNbaW5kZXggKzddID0gKGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQpIC8gdGg7CgoJCQkJZGlzcGxheU9iamVjdC51cGRhdGVGcmFtZSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBUT0RPIHRoaXMgcHJvYmFibHkgY291bGQgZG8gd2l0aCBzb21lIG9wdGltaXNhdGlvbi4uLi4KCQkJaWYoZGlzcGxheU9iamVjdC5jYWNoZUFscGhhICE9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYSkKCQkJewoJCQkJZGlzcGxheU9iamVjdC5jYWNoZUFscGhhID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoKCQkJCXZhciBjb2xvckluZGV4ID0gaW5kZXhSdW4gKiA0OwoJCQkJdGhpcy5jb2xvcnNbY29sb3JJbmRleF0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgMV0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgMl0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgM10gPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgkJCQl0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlpbmRleCA9IGluZGV4UnVuICogODsKCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgMCBdID0gMDsKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAxIF0gPSAwOwoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAyIF0gPSAwOwoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDMgXSA9IDA7CgoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDQgXSA9IDA7CgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgNSBdID0gMDsKCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgNl0gPSAwOwoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDddID0gMDsKCQl9CgoJCWluZGV4UnVuKys7CgkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX19uZXh0OwogICB9Cn0KICByZXR1cm4gUGhhc2VyOwp9KTs=",
                "body": "IWZ1bmN0aW9uKHJvb3QsIGZhY3RvcnkpIHsKICBpZiAodHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kKSB7CiAgICBkZWZpbmUoZmFjdG9yeSk7CiAgfSBlbHNlIGlmICh0eXBlb2YgZXhwb3J0cyA9PT0gIm9iamVjdCIpIHsKICAgICAgbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgfSBlbHNlIHsKICAgIHJvb3QuUGhhc2VyID0gZmFjdG9yeSgpOwogIH0KfSh0aGlzLCBmdW5jdGlvbigpIHsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQG92ZXJ2aWV3CioKKiBQaGFzZXIgLSBodHRwOi8vd3d3LnBoYXNlci5pbwoqCiogdjEuMS4zIC0gQnVpbHQgYXQ6IFRodSBOb3YgMjEgMjAxMyAwNToyOTo0NgoqCiogQnkgUmljaGFyZCBEYXZleSBodHRwOi8vd3d3LnBob3RvbnN0b3JtLmNvbSBAcGhvdG9uc3Rvcm0KKgoqIEEgZmVhdHVyZS1wYWNrZWQgMkQgSFRNTDUgZ2FtZSBmcmFtZXdvcmsgYm9ybiBmcm9tIHRoZSBzbW91bGRlcmluZyBwaXRzIG9mIEZsaXhlbCBhbmQKKiBjb25zdHJ1Y3RlZCB2aWEgcGxlbnR5IG9mIGJsb29kLCBzd2VhdCwgdGVhcnMgYW5kIGNvZmZlZSBieSBSaWNoYXJkIERhdmV5IChAcGhvdG9uc3Rvcm0pLgoqCiogUGhhc2VyIHVzZXMgUGl4aS5qcyBmb3IgcmVuZGVyaW5nLCBjcmVhdGVkIGJ5IE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMuCioKKiBGb2xsb3cgUGhhc2VyIGRldmVsb3BtZW50IHByb2dyZXNzIGF0IGh0dHA6Ly93d3cucGhvdG9uc3Rvcm0uY29tCioKKiBNYW55IHRoYW5rcyB0byBBZGFtIFNhbHRzbWFuIChAQURBTUFUT01JQykgZm9yIHJlbGVhc2luZyBGbGl4ZWwsIGZyb20gYm90aCB3aGljaCBQaGFzZXIKKiBhbmQgbXkgbG92ZSBvZiBnYW1lIGRldmVsb3BtZW50IG9yaWdpbmF0ZS4KKgoqICJJZiB5b3Ugd2FudCB5b3VyIGNoaWxkcmVuIHRvIGJlIGludGVsbGlnZW50LCAgcmVhZCB0aGVtIGZhaXJ5IHRhbGVzLiIKKiAiSWYgeW91IHdhbnQgdGhlbSB0byBiZSBtb3JlIGludGVsbGlnZW50LCByZWFkIHRoZW0gbW9yZSBmYWlyeSB0YWxlcy4iCiogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0tIEFsYmVydCBFaW5zdGVpbgoqLwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBAbW9kdWxlIFBJWEkKICovCnZhciBQSVhJID0gUElYSSB8fCB7fTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBuYW1lc3BhY2UgUGhhc2VyCiovCnZhciBQaGFzZXIgPSBQaGFzZXIgfHwgewoKCVZFUlNJT046ICcxLjEuMycsCglERVZfVkVSU0lPTjogJzEuMS4zJywKCUdBTUVTOiBbXSwKCUFVVE86IDAsCglDQU5WQVM6IDEsCglXRUJHTDogMiwKCglTUFJJVEU6IDAsCglCVVRUT046IDEsCglCVUxMRVQ6IDIsCglHUkFQSElDUzogMywKCVRFWFQ6IDQsCglUSUxFU1BSSVRFOiA1LAoJQklUTUFQVEVYVDogNiwKCUdST1VQOiA3LAoJUkVOREVSVEVYVFVSRTogOCwKCVRJTEVNQVA6IDksCglUSUxFTUFQTEFZRVI6IDEwLAoJRU1JVFRFUjogMTEsCglQT0xZR09OOiAxMiwKCUJJVE1BUERBVEE6IDEzLAoJQ0FOVkFTX0ZJTFRFUjogMTQsCglXRUJHTF9GSUxURVI6IDE1LAoKCU5PTkU6IDAsCglMRUZUOiAxLAoJUklHSFQ6IDIsCglVUDogMywKCURPV046IDQKCiB9OwoKUElYSS5JbnRlcmFjdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoZHVtbXkpIHsKCS8vCVdlIGRvbid0IG5lZWQgdGhpcyBpbiBQaXhpLCBzbyB3ZSd2ZSByZW1vdmVkIGl0IHRvIHNhdmUgc3BhY2UKCS8vCWhvd2V2ZXIgdGhlIFN0YWdlIG9iamVjdCBleHBlY3RzIGEgcmVmZXJlbmNlIHRvIGl0LCBzbyBoZXJlIGlzIGEgZHVtbXkgZW50cnkuCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlV0aWxzCiogQHN0YXRpYwoqLwpQaGFzZXIuVXRpbHMgPSB7CgkKCS8qKgoJKiBBIHN0YW5kYXJkIEZpc2hlci1ZYXRlcyBBcnJheSBzaHVmZmxlIGltcGxlbWVudGF0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5VdGlscy5zaHVmZmxlCgkqIEBwYXJhbSB7YXJyYXl9IGFycmF5IC0gVGhlIGFycmF5IHRvIHNodWZmbGUuCgkqIEByZXR1cm4ge2FycmF5fSBUaGUgc2h1ZmZsZWQgYXJyYXkuCgkqLwoJc2h1ZmZsZTogZnVuY3Rpb24gKGFycmF5KSB7CgoJICAgIGZvciAodmFyIGkgPSBhcnJheS5sZW5ndGggLSAxOyBpID4gMDsgaS0tKQoJICAgIHsKCSAgICAgICAgdmFyIGogPSBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaSArIDEpKTsKCSAgICAgICAgdmFyIHRlbXAgPSBhcnJheVtpXTsKCSAgICAgICAgYXJyYXlbaV0gPSBhcnJheVtqXTsKCSAgICAgICAgYXJyYXlbal0gPSB0ZW1wOwoJICAgIH0KCgkgICAgcmV0dXJuIGFycmF5OwoJICAgIAoJfSwKCgkvKioKCSogSmF2YXNjcmlwdCBzdHJpbmcgcGFkIGh0dHA6Ly93d3cud2VidG9vbGtpdC5pbmZvLy4KCSogcGFkID0gdGhlIHN0cmluZyB0byBwYWQgaXQgb3V0IHdpdGggKGRlZmF1bHRzIHRvIGEgc3BhY2UpCgkqIGRpciA9IDEgKGxlZnQpLCAyIChyaWdodCksIDMgKGJvdGgpCgkqIEBtZXRob2QgUGhhc2VyLlV0aWxzLnBhZAoJKiBAcGFyYW0ge3N0cmluZ30gc3RyIC0gVGhlIHRhcmdldCBzdHJpbmcuIAoJKiBAcGFyYW0ge251bWJlcn0gbGVuIC0gRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7bnVtYmVyfSBwYWQgLSB0aGUgc3RyaW5nIHRvIHBhZCBpdCBvdXQgd2l0aCAoZGVmYXVsdHMgdG8gYSBzcGFjZSkuCgkqIEBwYXJhbSB7bnVtYmVyfSBbZGlyPTNdIHRoZSBkaXJlY3Rpb24gZGlyID0gMSAobGVmdCksIDIgKHJpZ2h0KSwgMyAoYm90aCkuCgkqIEByZXR1cm4ge3N0cmluZ30gVGhlIHBhZGRlZCBzdHJpbmcKCSovCglwYWQ6IGZ1bmN0aW9uIChzdHIsIGxlbiwgcGFkLCBkaXIpIHsKCgkgICAgaWYgKHR5cGVvZihsZW4pID09ICJ1bmRlZmluZWQiKSB7IHZhciBsZW4gPSAwOyB9CgkgICAgaWYgKHR5cGVvZihwYWQpID09ICJ1bmRlZmluZWQiKSB7IHZhciBwYWQgPSAnICc7IH0KCSAgICBpZiAodHlwZW9mKGRpcikgPT0gInVuZGVmaW5lZCIpIHsgdmFyIGRpciA9IDM7IH0KCgkgICAgaWYgKGxlbiArIDEgPj0gc3RyLmxlbmd0aCkKCSAgICB7CgkgICAgICAgIHN3aXRjaCAoZGlyKQoJICAgICAgICB7CgkgICAgICAgICAgICBjYXNlIDE6CgkgICAgICAgICAgICAgICAgc3RyID0gQXJyYXkobGVuICsgMSAtIHN0ci5sZW5ndGgpLmpvaW4ocGFkKSArIHN0cjsKCQkgICAgICAgICAgICBicmVhazsKCgkgICAgICAgICAgICBjYXNlIDM6CgkgICAgICAgICAgICAgICAgdmFyIHJpZ2h0ID0gTWF0aC5jZWlsKChwYWRsZW4gPSBsZW4gLSBzdHIubGVuZ3RoKSAvIDIpOwoJICAgICAgICAgICAgICAgIHZhciBsZWZ0ID0gcGFkbGVuIC0gcmlnaHQ7CgkgICAgICAgICAgICAgICAgc3RyID0gQXJyYXkobGVmdCsxKS5qb2luKHBhZCkgKyBzdHIgKyBBcnJheShyaWdodCsxKS5qb2luKHBhZCk7CgkJICAgICAgICAgICAgYnJlYWs7CgoJICAgICAgICAgICAgZGVmYXVsdDoKCSAgICAgICAgICAgICAgICBzdHIgPSBzdHIgKyBBcnJheShsZW4gKyAxIC0gc3RyLmxlbmd0aCkuam9pbihwYWQpOwoJCSAgICAgICAgICAgIGJyZWFrOwoJICAgICAgICB9CgkgICAgfQoKCSAgICByZXR1cm4gc3RyOwoKCX0sCgogICAgLyoqCiAgICAqIFRoaXMgaXMgYSBzbGlnaHRseSBtb2RpZmllZCB2ZXJzaW9uIG9mIGpRdWVyeS5pc1BsYWluT2JqZWN0LiBBIHBsYWluIG9iamVjdCBpcyBhbiBvYmplY3Qgd2hvc2UgaW50ZXJuYWwgY2xhc3MgcHJvcGVydHkgaXMgW29iamVjdCBPYmplY3RdLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5pc1BsYWluT2JqZWN0CiAgICAqIEBwYXJhbSB7b2JqZWN0fSBvYmogLSBUaGUgb2JqZWN0IHRvIGluc3BlY3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IC0gdHJ1ZSBpZiB0aGUgb2JqZWN0IGlzIHBsYWluLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwoJaXNQbGFpbk9iamVjdDogZnVuY3Rpb24gKG9iaikgewoKCQkvLyBOb3QgcGxhaW4gb2JqZWN0czoKCQkvLyAtIEFueSBvYmplY3Qgb3IgdmFsdWUgd2hvc2UgaW50ZXJuYWwgW1tDbGFzc11dIHByb3BlcnR5IGlzIG5vdCAiW29iamVjdCBPYmplY3RdIgoJCS8vIC0gRE9NIG5vZGVzCgkJLy8gLSB3aW5kb3cKCQlpZiAodHlwZW9mKG9iaikgIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBvYmogPT09IG9iai53aW5kb3cpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTdXBwb3J0OiBGaXJlZm94IDwyMAoJCS8vIFRoZSB0cnkvY2F0Y2ggc3VwcHJlc3NlcyBleGNlcHRpb25zIHRocm93biB3aGVuIGF0dGVtcHRpbmcgdG8gYWNjZXNzCgkJLy8gdGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgb2YgY2VydGFpbiBob3N0IG9iamVjdHMsIGllLiB8d2luZG93LmxvY2F0aW9ufAoJCS8vIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTgxNDYyMgoJCXRyeSB7CgkJCWlmIChvYmouY29uc3RydWN0b3IgJiYgIWhhc093bi5jYWxsKG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikpCgkJCXsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gY2F0Y2ggKGUpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJLy8gSWYgdGhlIGZ1bmN0aW9uIGhhc24ndCByZXR1cm5lZCBhbHJlYWR5LCB3ZSdyZSBjb25maWRlbnQgdGhhdAoJCS8vIHxvYmp8IGlzIGEgcGxhaW4gb2JqZWN0LCBjcmVhdGVkIGJ5IHt9IG9yIGNvbnN0cnVjdGVkIHdpdGggbmV3IE9iamVjdAoJCXJldHVybiB0cnVlOwoJfSwKCgoJLy8JZGVlcCwgdGFyZ2V0LCBvYmplY3RzIHRvIGNvcHkgdG8gdGhlIHRhcmdldCBvYmplY3QKCS8vCVRoaXMgaXMgYSBzbGlnaHRseSBtb2RpZmllZCB2ZXJzaW9uIG9mIHtAbGluayBodHRwOi8vYXBpLmpxdWVyeS5jb20valF1ZXJ5LmV4dGVuZC98alF1ZXJ5LmV4dGVuZH0KCS8vCWRlZXAgKGJvb2xlYW4pCgkvLwl0YXJnZXQgKG9iamVjdCB0byBhZGQgdG8pCgkvLwlvYmplY3RzIC4uLiAob2JqZWN0cyB0byByZWN1cnNlIGFuZCBjb3B5IGZyb20pCgogICAgLyoqCiAgICAqIFRoaXMgaXMgYSBzbGlnaHRseSBtb2RpZmllZCB2ZXJzaW9uIG9mIGh0dHA6Ly9hcGkuanF1ZXJ5LmNvbS9qUXVlcnkuZXh0ZW5kLwogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5leHRlbmQKICAgICogQHBhcmFtIHtib29sZWFufSBkZWVwIC0gUGVyZm9ybSBhIGRlZXAgY29weT8KICAgICogQHBhcmFtIHtvYmplY3R9IHRhcmdldCAtIFRoZSB0YXJnZXQgb2JqZWN0IHRvIGNvcHkgdG8uCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIGV4dGVuZGVkIG9iamVjdC4KICAgICovCglleHRlbmQ6IGZ1bmN0aW9uICgpIHsKCgkJdmFyIG9wdGlvbnMsIG5hbWUsIHNyYywgY29weSwgY29weUlzQXJyYXksIGNsb25lLAoJCQl0YXJnZXQgPSBhcmd1bWVudHNbMF0gfHwge30sCgkJCWkgPSAxLAoJCQlsZW5ndGggPSBhcmd1bWVudHMubGVuZ3RoLAoJCQlkZWVwID0gZmFsc2U7CgoJCS8vIEhhbmRsZSBhIGRlZXAgY29weSBzaXR1YXRpb24KCQlpZiAodHlwZW9mIHRhcmdldCA9PT0gImJvb2xlYW4iKQoJCXsKCQkJZGVlcCA9IHRhcmdldDsKCQkJdGFyZ2V0ID0gYXJndW1lbnRzWzFdIHx8IHt9OwoJCQkvLyBza2lwIHRoZSBib29sZWFuIGFuZCB0aGUgdGFyZ2V0CgkJCWkgPSAyOwoJCX0KCgkJLy8gZXh0ZW5kIFBoYXNlciBpZiBvbmx5IG9uZSBhcmd1bWVudCBpcyBwYXNzZWQKCQlpZiAobGVuZ3RoID09PSBpKQoJCXsKCQkJdGFyZ2V0ID0gdGhpczsKCQkJLS1pOwoJCX0KCgkJZm9yICggOyBpIDwgbGVuZ3RoOyBpKysgKQoJCXsKCQkJLy8gT25seSBkZWFsIHdpdGggbm9uLW51bGwvdW5kZWZpbmVkIHZhbHVlcwoJCQlpZiAoKG9wdGlvbnMgPSBhcmd1bWVudHNbaV0pICE9IG51bGwpCgkJCXsKCQkJCS8vIEV4dGVuZCB0aGUgYmFzZSBvYmplY3QKCQkJCWZvciAobmFtZSBpbiBvcHRpb25zKQoJCQkJewoJCQkJCXNyYyA9IHRhcmdldFtuYW1lXTsKCQkJCQljb3B5ID0gb3B0aW9uc1tuYW1lXTsKCgkJCQkJLy8gUHJldmVudCBuZXZlci1lbmRpbmcgbG9vcAoJCQkJCWlmICh0YXJnZXQgPT09IGNvcHkpCgkJCQkJewoJCQkJCQljb250aW51ZTsKCQkJCQl9CgoJCQkJCS8vIFJlY3Vyc2UgaWYgd2UncmUgbWVyZ2luZyBwbGFpbiBvYmplY3RzIG9yIGFycmF5cwoJCQkJCWlmIChkZWVwICYmIGNvcHkgJiYgKFBoYXNlci5VdGlscy5pc1BsYWluT2JqZWN0KGNvcHkpIHx8IChjb3B5SXNBcnJheSA9IEFycmF5LmlzQXJyYXkoY29weSkpKSkKCQkJCQl7CgkJCQkJCWlmIChjb3B5SXNBcnJheSkKCQkJCQkJewoJCQkJCQkJY29weUlzQXJyYXkgPSBmYWxzZTsKCQkJCQkJCWNsb25lID0gc3JjICYmIEFycmF5LmlzQXJyYXkoc3JjKSA/IHNyYyA6IFtdOwoJCQkJCQl9CgkJCQkJCWVsc2UKCQkJCQkJewoJCQkJCQkJY2xvbmUgPSBzcmMgJiYgUGhhc2VyLlV0aWxzLmlzUGxhaW5PYmplY3Qoc3JjKSA/IHNyYyA6IHt9OwoJCQkJCQl9CgoJCQkJCQkvLyBOZXZlciBtb3ZlIG9yaWdpbmFsIG9iamVjdHMsIGNsb25lIHRoZW0KCQkJCQkJdGFyZ2V0W25hbWVdID0gUGhhc2VyLlV0aWxzLmV4dGVuZChkZWVwLCBjbG9uZSwgY29weSk7CgoJCQkJCS8vIERvbid0IGJyaW5nIGluIHVuZGVmaW5lZCB2YWx1ZXMKCQkJCQl9CgkJCQkJZWxzZSBpZiAoY29weSAhPT0gdW5kZWZpbmVkKQoJCQkJCXsKCQkJCQkJdGFyZ2V0W25hbWVdID0gY29weTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9CgoJCS8vIFJldHVybiB0aGUgbW9kaWZpZWQgb2JqZWN0CgkJcmV0dXJuIHRhcmdldDsKCX0KCn07CgovLwlHbG9iYWwgZnVuY3Rpb25zIHRoYXQgUElYSSBuZWVkcwoKKGZ1bmN0aW9uKCkgewogICAgdmFyIGNvbnNvbGVEaXNhYmxlZCA9IGZhbHNlOwogICAgaWYgKGNvbnNvbGVEaXNhYmxlZCkgewogICAgICAgIHdpbmRvdy5jb25zb2xlID0gdW5kZWZpbmVkOwogICAgfQogICAgaWYgKHdpbmRvdy5jb25zb2xlID09IHVuZGVmaW5lZCkgewogICAgICAgIHdpbmRvdy5jb25zb2xlID0gewogICAgICAgICAgICBkZWJ1ZzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5mbzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHdhcm46IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBsb2c6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZGVidWcgPSAoZnVuY3Rpb24oYXJncykgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmRlYnVnKGFyZ3MpOwogICAgfSk7CiAgICBpbmZvID0gKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS5pbmZvKGFyZ3MpOwogICAgfSk7CiAgICB3YXJuID0gKGZ1bmN0aW9uKGFyZ3MpIHsKICAgICAgICB3aW5kb3cuY29uc29sZS53YXJuKGFyZ3MpOwogICAgfSk7CiAgICBsb2cgPSAoZnVuY3Rpb24oYXJncykgewogICAgICAgIHdpbmRvdy5jb25zb2xlLmxvZyhhcmdzKTsKICAgIH0pOwp9KSgpOwoKLyoqCiogQ29udmVydHMgYSBoZXggY29sb3IgbnVtYmVyIHRvIGFuIFtSLCBHLCBCXSBhcnJheQoqCiogQHBhcmFtIHtudW1iZXJ9IGhleCAKKiBAcmV0dXJuIHthcnJheX0KKi8KZnVuY3Rpb24gSEVYdG9SR0IoaGV4KSB7CglyZXR1cm4gWyhoZXggPj4gMTYgJiAweEZGKSAvIDI1NSwgKCBoZXggPj4gOCAmIDB4RkYpIC8gMjU1LCAoaGV4ICYgMHhGRikvIDI1NV07Cn0KCi8qKgoqIEEgcG9seWZpbGwgZm9yIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kCiovCmlmICh0eXBlb2YgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgIT0gJ2Z1bmN0aW9uJykgewogIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID0gKGZ1bmN0aW9uICgpIHsKICAgIHZhciBzbGljZSA9IEFycmF5LnByb3RvdHlwZS5zbGljZTsKICAgIHJldHVybiBmdW5jdGlvbiAodGhpc0FyZykgewogICAgICB2YXIgdGFyZ2V0ID0gdGhpcywgYm91bmRBcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogCiAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKTsKIAogICAgICBmdW5jdGlvbiBib3VuZCgpIHsKCXZhciBhcmdzID0gYm91bmRBcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpOwoJdGFyZ2V0LmFwcGx5KHRoaXMgaW5zdGFuY2VvZiBib3VuZCA/IHRoaXMgOiB0aGlzQXJnLCBhcmdzKTsKICAgICAgfQogCiAgICAgIGJvdW5kLnByb3RvdHlwZSA9IChmdW5jdGlvbiBGKHByb3RvKSB7CiAgICAgICAgICBwcm90byAmJiAoRi5wcm90b3R5cGUgPSBwcm90byk7CiAgICAgICAgICBpZiAoISh0aGlzIGluc3RhbmNlb2YgRikpIHJldHVybiBuZXcgRjsgICAgICAgICAgCgl9KSh0YXJnZXQucHJvdG90eXBlKTsKIAogICAgICByZXR1cm4gYm91bmQ7CiAgICB9OwogIH0pKCk7Cn0KCgoKCi8qCiAqIEEgbGlnaHRlciB2ZXJzaW9uIG9mIHRoZSByYWQgZ2wtbWF0cml4IGNyZWF0ZWQgYnkgQnJhbmRvbiBKb25lcywgQ29saW4gTWFjS2VuemllIElWCiAqIHlvdSBib3RoIHJvY2shCiAqLwoKZnVuY3Rpb24gZGV0ZXJtaW5lTWF0cml4QXJyYXlUeXBlKCkgewogICAgUElYSS5NYXRyaXggPSAodHlwZW9mIEZsb2F0MzJBcnJheSAhPT0gJ3VuZGVmaW5lZCcpID8gRmxvYXQzMkFycmF5IDogQXJyYXk7CiAgICByZXR1cm4gUElYSS5NYXRyaXg7Cn0KCmRldGVybWluZU1hdHJpeEFycmF5VHlwZSgpOwoKUElYSS5tYXQzID0ge307CgpQSVhJLm1hdDMuY3JlYXRlID0gZnVuY3Rpb24oKQp7Cgl2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDkpOwoKCW1hdHJpeFswXSA9IDE7CgltYXRyaXhbMV0gPSAwOwoJbWF0cml4WzJdID0gMDsKCW1hdHJpeFszXSA9IDA7CgltYXRyaXhbNF0gPSAxOwoJbWF0cml4WzVdID0gMDsKCW1hdHJpeFs2XSA9IDA7CgltYXRyaXhbN10gPSAwOwoJbWF0cml4WzhdID0gMTsKCglyZXR1cm4gbWF0cml4Owp9CgoKUElYSS5tYXQzLmlkZW50aXR5ID0gZnVuY3Rpb24obWF0cml4KQp7CgltYXRyaXhbMF0gPSAxOwoJbWF0cml4WzFdID0gMDsKCW1hdHJpeFsyXSA9IDA7CgltYXRyaXhbM10gPSAwOwoJbWF0cml4WzRdID0gMTsKCW1hdHJpeFs1XSA9IDA7CgltYXRyaXhbNl0gPSAwOwoJbWF0cml4WzddID0gMDsKCW1hdHJpeFs4XSA9IDE7CgoJcmV0dXJuIG1hdHJpeDsKfQoKClBJWEkubWF0NCA9IHt9OwoKUElYSS5tYXQ0LmNyZWF0ZSA9IGZ1bmN0aW9uKCkKewoJdmFyIG1hdHJpeCA9IG5ldyBQSVhJLk1hdHJpeCgxNik7CgoJbWF0cml4WzBdID0gMTsKCW1hdHJpeFsxXSA9IDA7CgltYXRyaXhbMl0gPSAwOwoJbWF0cml4WzNdID0gMDsKCW1hdHJpeFs0XSA9IDA7CgltYXRyaXhbNV0gPSAxOwoJbWF0cml4WzZdID0gMDsKCW1hdHJpeFs3XSA9IDA7CgltYXRyaXhbOF0gPSAwOwoJbWF0cml4WzldID0gMDsKCW1hdHJpeFsxMF0gPSAxOwoJbWF0cml4WzExXSA9IDA7CgltYXRyaXhbMTJdID0gMDsKCW1hdHJpeFsxM10gPSAwOwoJbWF0cml4WzE0XSA9IDA7CgltYXRyaXhbMTVdID0gMTsKCglyZXR1cm4gbWF0cml4Owp9CgpQSVhJLm1hdDMubXVsdGlwbHkgPSBmdW5jdGlvbiAobWF0LCBtYXQyLCBkZXN0KQp7CglpZiAoIWRlc3QpIHsgZGVzdCA9IG1hdDsgfQoKCS8vIENhY2hlIHRoZSBtYXRyaXggdmFsdWVzIChtYWtlcyBmb3IgaHVnZSBzcGVlZCBpbmNyZWFzZXMhKQoJdmFyIGEwMCA9IG1hdFswXSwgYTAxID0gbWF0WzFdLCBhMDIgPSBtYXRbMl0sCgkgICAgYTEwID0gbWF0WzNdLCBhMTEgPSBtYXRbNF0sIGExMiA9IG1hdFs1XSwKCSAgICBhMjAgPSBtYXRbNl0sIGEyMSA9IG1hdFs3XSwgYTIyID0gbWF0WzhdLAoKCSAgICBiMDAgPSBtYXQyWzBdLCBiMDEgPSBtYXQyWzFdLCBiMDIgPSBtYXQyWzJdLAoJICAgIGIxMCA9IG1hdDJbM10sIGIxMSA9IG1hdDJbNF0sIGIxMiA9IG1hdDJbNV0sCgkgICAgYjIwID0gbWF0Mls2XSwgYjIxID0gbWF0Mls3XSwgYjIyID0gbWF0Mls4XTsKCglkZXN0WzBdID0gYjAwICogYTAwICsgYjAxICogYTEwICsgYjAyICogYTIwOwoJZGVzdFsxXSA9IGIwMCAqIGEwMSArIGIwMSAqIGExMSArIGIwMiAqIGEyMTsKCWRlc3RbMl0gPSBiMDAgKiBhMDIgKyBiMDEgKiBhMTIgKyBiMDIgKiBhMjI7CgoJZGVzdFszXSA9IGIxMCAqIGEwMCArIGIxMSAqIGExMCArIGIxMiAqIGEyMDsKCWRlc3RbNF0gPSBiMTAgKiBhMDEgKyBiMTEgKiBhMTEgKyBiMTIgKiBhMjE7CglkZXN0WzVdID0gYjEwICogYTAyICsgYjExICogYTEyICsgYjEyICogYTIyOwoKCWRlc3RbNl0gPSBiMjAgKiBhMDAgKyBiMjEgKiBhMTAgKyBiMjIgKiBhMjA7CglkZXN0WzddID0gYjIwICogYTAxICsgYjIxICogYTExICsgYjIyICogYTIxOwoJZGVzdFs4XSA9IGIyMCAqIGEwMiArIGIyMSAqIGExMiArIGIyMiAqIGEyMjsKCglyZXR1cm4gZGVzdDsKfQoKUElYSS5tYXQzLmNsb25lID0gZnVuY3Rpb24obWF0KQp7Cgl2YXIgbWF0cml4ID0gbmV3IFBJWEkuTWF0cml4KDkpOwoKCW1hdHJpeFswXSA9IG1hdFswXTsKCW1hdHJpeFsxXSA9IG1hdFsxXTsKCW1hdHJpeFsyXSA9IG1hdFsyXTsKCW1hdHJpeFszXSA9IG1hdFszXTsKCW1hdHJpeFs0XSA9IG1hdFs0XTsKCW1hdHJpeFs1XSA9IG1hdFs1XTsKCW1hdHJpeFs2XSA9IG1hdFs2XTsKCW1hdHJpeFs3XSA9IG1hdFs3XTsKCW1hdHJpeFs4XSA9IG1hdFs4XTsKCglyZXR1cm4gbWF0cml4Owp9CgpQSVhJLm1hdDMudHJhbnNwb3NlID0gZnVuY3Rpb24gKG1hdCwgZGVzdCkKewogCS8vIElmIHdlIGFyZSB0cmFuc3Bvc2luZyBvdXJzZWx2ZXMgd2UgY2FuIHNraXAgYSBmZXcgc3RlcHMgYnV0IGhhdmUgdG8gY2FjaGUgc29tZSB2YWx1ZXMKICAgIGlmICghZGVzdCB8fCBtYXQgPT09IGRlc3QpIHsKICAgICAgICB2YXIgYTAxID0gbWF0WzFdLCBhMDIgPSBtYXRbMl0sCiAgICAgICAgICAgIGExMiA9IG1hdFs1XTsKCiAgICAgICAgbWF0WzFdID0gbWF0WzNdOwogICAgICAgIG1hdFsyXSA9IG1hdFs2XTsKICAgICAgICBtYXRbM10gPSBhMDE7CiAgICAgICAgbWF0WzVdID0gbWF0WzddOwogICAgICAgIG1hdFs2XSA9IGEwMjsKICAgICAgICBtYXRbN10gPSBhMTI7CiAgICAgICAgcmV0dXJuIG1hdDsKICAgIH0KCiAgICBkZXN0WzBdID0gbWF0WzBdOwogICAgZGVzdFsxXSA9IG1hdFszXTsKICAgIGRlc3RbMl0gPSBtYXRbNl07CiAgICBkZXN0WzNdID0gbWF0WzFdOwogICAgZGVzdFs0XSA9IG1hdFs0XTsKICAgIGRlc3RbNV0gPSBtYXRbN107CiAgICBkZXN0WzZdID0gbWF0WzJdOwogICAgZGVzdFs3XSA9IG1hdFs1XTsKICAgIGRlc3RbOF0gPSBtYXRbOF07CiAgICByZXR1cm4gZGVzdDsKfQoKUElYSS5tYXQzLnRvTWF0NCA9IGZ1bmN0aW9uIChtYXQsIGRlc3QpCnsKCWlmICghZGVzdCkgeyBkZXN0ID0gUElYSS5tYXQ0LmNyZWF0ZSgpOyB9CgoJZGVzdFsxNV0gPSAxOwoJZGVzdFsxNF0gPSAwOwoJZGVzdFsxM10gPSAwOwoJZGVzdFsxMl0gPSAwOwoKCWRlc3RbMTFdID0gMDsKCWRlc3RbMTBdID0gbWF0WzhdOwoJZGVzdFs5XSA9IG1hdFs3XTsKCWRlc3RbOF0gPSBtYXRbNl07CgoJZGVzdFs3XSA9IDA7CglkZXN0WzZdID0gbWF0WzVdOwoJZGVzdFs1XSA9IG1hdFs0XTsKCWRlc3RbNF0gPSBtYXRbM107CgoJZGVzdFszXSA9IDA7CglkZXN0WzJdID0gbWF0WzJdOwoJZGVzdFsxXSA9IG1hdFsxXTsKCWRlc3RbMF0gPSBtYXRbMF07CgoJcmV0dXJuIGRlc3Q7Cn0KCgovLy8vLwoKClBJWEkubWF0NC5jcmVhdGUgPSBmdW5jdGlvbigpCnsKCXZhciBtYXRyaXggPSBuZXcgUElYSS5NYXRyaXgoMTYpOwoKCW1hdHJpeFswXSA9IDE7CgltYXRyaXhbMV0gPSAwOwoJbWF0cml4WzJdID0gMDsKCW1hdHJpeFszXSA9IDA7CgltYXRyaXhbNF0gPSAwOwoJbWF0cml4WzVdID0gMTsKCW1hdHJpeFs2XSA9IDA7CgltYXRyaXhbN10gPSAwOwoJbWF0cml4WzhdID0gMDsKCW1hdHJpeFs5XSA9IDA7CgltYXRyaXhbMTBdID0gMTsKCW1hdHJpeFsxMV0gPSAwOwoJbWF0cml4WzEyXSA9IDA7CgltYXRyaXhbMTNdID0gMDsKCW1hdHJpeFsxNF0gPSAwOwoJbWF0cml4WzE1XSA9IDE7CgoJcmV0dXJuIG1hdHJpeDsKfQoKUElYSS5tYXQ0LnRyYW5zcG9zZSA9IGZ1bmN0aW9uIChtYXQsIGRlc3QpCnsKCS8vIElmIHdlIGFyZSB0cmFuc3Bvc2luZyBvdXJzZWx2ZXMgd2UgY2FuIHNraXAgYSBmZXcgc3RlcHMgYnV0IGhhdmUgdG8gY2FjaGUgc29tZSB2YWx1ZXMKCWlmICghZGVzdCB8fCBtYXQgPT09IGRlc3QpCgl7CgkgICAgdmFyIGEwMSA9IG1hdFsxXSwgYTAyID0gbWF0WzJdLCBhMDMgPSBtYXRbM10sCgkgICAgICAgIGExMiA9IG1hdFs2XSwgYTEzID0gbWF0WzddLAoJICAgICAgICBhMjMgPSBtYXRbMTFdOwoKCSAgICBtYXRbMV0gPSBtYXRbNF07CgkgICAgbWF0WzJdID0gbWF0WzhdOwoJICAgIG1hdFszXSA9IG1hdFsxMl07CgkgICAgbWF0WzRdID0gYTAxOwoJICAgIG1hdFs2XSA9IG1hdFs5XTsKCSAgICBtYXRbN10gPSBtYXRbMTNdOwoJICAgIG1hdFs4XSA9IGEwMjsKCSAgICBtYXRbOV0gPSBhMTI7CgkgICAgbWF0WzExXSA9IG1hdFsxNF07CgkgICAgbWF0WzEyXSA9IGEwMzsKCSAgICBtYXRbMTNdID0gYTEzOwoJICAgIG1hdFsxNF0gPSBhMjM7CgkgICAgcmV0dXJuIG1hdDsKCX0KCglkZXN0WzBdID0gbWF0WzBdOwoJZGVzdFsxXSA9IG1hdFs0XTsKCWRlc3RbMl0gPSBtYXRbOF07CglkZXN0WzNdID0gbWF0WzEyXTsKCWRlc3RbNF0gPSBtYXRbMV07CglkZXN0WzVdID0gbWF0WzVdOwoJZGVzdFs2XSA9IG1hdFs5XTsKCWRlc3RbN10gPSBtYXRbMTNdOwoJZGVzdFs4XSA9IG1hdFsyXTsKCWRlc3RbOV0gPSBtYXRbNl07CglkZXN0WzEwXSA9IG1hdFsxMF07CglkZXN0WzExXSA9IG1hdFsxNF07CglkZXN0WzEyXSA9IG1hdFszXTsKCWRlc3RbMTNdID0gbWF0WzddOwoJZGVzdFsxNF0gPSBtYXRbMTFdOwoJZGVzdFsxNV0gPSBtYXRbMTVdOwoJcmV0dXJuIGRlc3Q7Cn0KClBJWEkubWF0NC5tdWx0aXBseSA9IGZ1bmN0aW9uIChtYXQsIG1hdDIsIGRlc3QpCnsKCWlmICghZGVzdCkgeyBkZXN0ID0gbWF0OyB9CgoJLy8gQ2FjaGUgdGhlIG1hdHJpeCB2YWx1ZXMgKG1ha2VzIGZvciBodWdlIHNwZWVkIGluY3JlYXNlcyEpCgl2YXIgYTAwID0gbWF0WyAwXSwgYTAxID0gbWF0WyAxXSwgYTAyID0gbWF0WyAyXSwgYTAzID0gbWF0WzNdOwoJdmFyIGExMCA9IG1hdFsgNF0sIGExMSA9IG1hdFsgNV0sIGExMiA9IG1hdFsgNl0sIGExMyA9IG1hdFs3XTsKCXZhciBhMjAgPSBtYXRbIDhdLCBhMjEgPSBtYXRbIDldLCBhMjIgPSBtYXRbMTBdLCBhMjMgPSBtYXRbMTFdOwoJdmFyIGEzMCA9IG1hdFsxMl0sIGEzMSA9IG1hdFsxM10sIGEzMiA9IG1hdFsxNF0sIGEzMyA9IG1hdFsxNV07CgoJLy8gQ2FjaGUgb25seSB0aGUgY3VycmVudCBsaW5lIG9mIHRoZSBzZWNvbmQgbWF0cml4CiAgICB2YXIgYjAgID0gbWF0MlswXSwgYjEgPSBtYXQyWzFdLCBiMiA9IG1hdDJbMl0sIGIzID0gbWF0MlszXTsKICAgIGRlc3RbMF0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzFdID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFsyXSA9IGIwKmEwMiArIGIxKmExMiArIGIyKmEyMiArIGIzKmEzMjsKICAgIGRlc3RbM10gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgYjAgPSBtYXQyWzRdOwogICAgYjEgPSBtYXQyWzVdOwogICAgYjIgPSBtYXQyWzZdOwogICAgYjMgPSBtYXQyWzddOwogICAgZGVzdFs0XSA9IGIwKmEwMCArIGIxKmExMCArIGIyKmEyMCArIGIzKmEzMDsKICAgIGRlc3RbNV0gPSBiMCphMDEgKyBiMSphMTEgKyBiMiphMjEgKyBiMyphMzE7CiAgICBkZXN0WzZdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFs3XSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICBiMCA9IG1hdDJbOF07CiAgICBiMSA9IG1hdDJbOV07CiAgICBiMiA9IG1hdDJbMTBdOwogICAgYjMgPSBtYXQyWzExXTsKICAgIGRlc3RbOF0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzldID0gYjAqYTAxICsgYjEqYTExICsgYjIqYTIxICsgYjMqYTMxOwogICAgZGVzdFsxMF0gPSBiMCphMDIgKyBiMSphMTIgKyBiMiphMjIgKyBiMyphMzI7CiAgICBkZXN0WzExXSA9IGIwKmEwMyArIGIxKmExMyArIGIyKmEyMyArIGIzKmEzMzsKCiAgICBiMCA9IG1hdDJbMTJdOwogICAgYjEgPSBtYXQyWzEzXTsKICAgIGIyID0gbWF0MlsxNF07CiAgICBiMyA9IG1hdDJbMTVdOwogICAgZGVzdFsxMl0gPSBiMCphMDAgKyBiMSphMTAgKyBiMiphMjAgKyBiMyphMzA7CiAgICBkZXN0WzEzXSA9IGIwKmEwMSArIGIxKmExMSArIGIyKmEyMSArIGIzKmEzMTsKICAgIGRlc3RbMTRdID0gYjAqYTAyICsgYjEqYTEyICsgYjIqYTIyICsgYjMqYTMyOwogICAgZGVzdFsxNV0gPSBiMCphMDMgKyBiMSphMTMgKyBiMiphMjMgKyBiMyphMzM7CgogICAgcmV0dXJuIGRlc3Q7Cn0KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogVGhlIFBvaW50IG9iamVjdCByZXByZXNlbnRzIGEgbG9jYXRpb24gaW4gYSB0d28tZGltZW5zaW9uYWwgY29vcmRpbmF0ZSBzeXN0ZW0sIHdoZXJlIHggcmVwcmVzZW50cyB0aGUgaG9yaXpvbnRhbCBheGlzIGFuZCB5IHJlcHJlc2VudHMgdGhlIHZlcnRpY2FsIGF4aXMuCiAqCiAqIEBjbGFzcyBQb2ludAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHgge051bWJlcn0gcG9zaXRpb24gb2YgdGhlIHBvaW50CiAqIEBwYXJhbSB5IHtOdW1iZXJ9IHBvc2l0aW9uIG9mIHRoZSBwb2ludAogKi8KUElYSS5Qb2ludCA9IGZ1bmN0aW9uKHgsIHkpCnsKCS8qKgoJICogQHByb3BlcnR5IHgKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgMAoJICovCgl0aGlzLnggPSB4IHx8IDA7CgoJLyoqCgkgKiBAcHJvcGVydHkgeQoJICogQHR5cGUgTnVtYmVyCgkgKiBAZGVmYXVsdCAwCgkgKi8KCXRoaXMueSA9IHkgfHwgMDsKfQoKLyoqCiAqIENyZWF0ZXMgYSBjbG9uZSBvZiB0aGlzIHBvaW50CiAqCiAqIEBtZXRob2QgY2xvbmUKICogQHJldHVybiB7UG9pbnR9IGEgY29weSBvZiB0aGUgcG9pbnQKICovClBJWEkuUG9pbnQucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKQp7CglyZXR1cm4gbmV3IFBJWEkuUG9pbnQodGhpcy54LCB0aGlzLnkpOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlBvaW50LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUG9pbnQ7CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgovKioKICogdGhlIFJlY3RhbmdsZSBvYmplY3QgaXMgYW4gYXJlYSBkZWZpbmVkIGJ5IGl0cyBwb3NpdGlvbiwgYXMgaW5kaWNhdGVkIGJ5IGl0cyB0b3AtbGVmdCBjb3JuZXIgcG9pbnQgKHgsIHkpIGFuZCBieSBpdHMgd2lkdGggYW5kIGl0cyBoZWlnaHQuCiAqCiAqIEBjbGFzcyBSZWN0YW5nbGUKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSB1cHBlci1sZWZ0IGNvcm5lciBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSB3aWR0aCB7TnVtYmVyfSBUaGUgb3ZlcmFsbCB3aWR0aCBvZiB0aGlzIHJlY3RhbmdsZQogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IFRoZSBvdmVyYWxsIGhlaWdodCBvZiB0aGlzIHJlY3RhbmdsZQogKi8KUElYSS5SZWN0YW5nbGUgPSBmdW5jdGlvbih4LCB5LCB3aWR0aCwgaGVpZ2h0KQp7CgkvKioKCSAqIEBwcm9wZXJ0eSB4CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBkZWZhdWx0IDAKCSAqLwoJdGhpcy54ID0geCB8fCAwOwoKCS8qKgoJICogQHByb3BlcnR5IHkKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgMAoJICovCgl0aGlzLnkgPSB5IHx8IDA7CgoJLyoqCgkgKiBAcHJvcGVydHkgd2lkdGgKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgMAoJICovCgl0aGlzLndpZHRoID0gd2lkdGggfHwgMDsKCgkvKioKCSAqIEBwcm9wZXJ0eSBoZWlnaHQKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgMAoJICovCgl0aGlzLmhlaWdodCA9IGhlaWdodCB8fCAwOwp9CgovKioKICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoaXMgUmVjdGFuZ2xlCiAqCiAqIEBtZXRob2QgY2xvbmUKICogQHJldHVybiB7UmVjdGFuZ2xlfSBhIGNvcHkgb2YgdGhlIHJlY3RhbmdsZQogKi8KUElYSS5SZWN0YW5nbGUucHJvdG90eXBlLmNsb25lID0gZnVuY3Rpb24oKQp7CglyZXR1cm4gbmV3IFBJWEkuUmVjdGFuZ2xlKHRoaXMueCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7Cn0KCi8qKgogKiBDaGVja3MgaWYgdGhlIHgsIGFuZCB5IGNvb3JkcyBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBhcmUgY29udGFpbmVkIHdpdGhpbiB0aGlzIFJlY3RhbmdsZQogKgogKiBAbWV0aG9kIGNvbnRhaW5zCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSBwb2ludCB0byB0ZXN0CiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSBwb2ludCB0byB0ZXN0CiAqIEByZXR1cm4ge0Jvb2xlYW59IGlmIHRoZSB4L3kgY29vcmRzIGFyZSB3aXRoaW4gdGhpcyBSZWN0YW5nbGUKICovClBJWEkuUmVjdGFuZ2xlLnByb3RvdHlwZS5jb250YWlucyA9IGZ1bmN0aW9uKHgsIHkpCnsKICAgIGlmKHRoaXMud2lkdGggPD0gMCB8fCB0aGlzLmhlaWdodCA8PSAwKQogICAgICAgIHJldHVybiBmYWxzZTsKCgl2YXIgeDEgPSB0aGlzLng7CglpZih4ID49IHgxICYmIHggPD0geDEgKyB0aGlzLndpZHRoKQoJewoJCXZhciB5MSA9IHRoaXMueTsKCgkJaWYoeSA+PSB5MSAmJiB5IDw9IHkxICsgdGhpcy5oZWlnaHQpCgkJewoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJcmV0dXJuIGZhbHNlOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlJlY3RhbmdsZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJlY3RhbmdsZTsKCgovKioKICogQGF1dGhvciBBZHJpZW4gQnJhdWx0IDxhZHJpZW4uYnJhdWx0QGdtYWlsLmNvbT4KICovCgovKioKICogQGNsYXNzIFBvbHlnb24KICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBwb2ludHMqIHtBcnJheTxQb2ludD58QXJyYXk8TnVtYmVyPnxQb2ludC4uLnxOdW1iZXIuLi59IFRoaXMgY2FuIGJlIGFuIGFycmF5IG9mIFBvaW50cyB0aGF0IGZvcm0gdGhlIHBvbHlnb24sCiAqICAgICAgYSBmbGF0IGFycmF5IG9mIG51bWJlcnMgdGhhdCB3aWxsIGJlIGludGVycHJldGVkIGFzIFt4LHksIHgseSwgLi4uXSwgb3IgdGhlIGFyZ3VtZW50cyBwYXNzZWQgY2FuIGJlCiAqICAgICAgYWxsIHRoZSBwb2ludHMgb2YgdGhlIHBvbHlnb24gZS5nLiBgbmV3IFBJWEkuUG9seWdvbihuZXcgUElYSS5Qb2ludCgpLCBuZXcgUElYSS5Qb2ludCgpLCAuLi4pYCwgb3IgdGhlCiAqICAgICAgYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUgZmxhdCB4LHkgdmFsdWVzIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24oeCx5LCB4LHksIHgseSwgLi4uKWAgd2hlcmUgYHhgIGFuZCBgeWAgYXJlCiAqICAgICAgTnVtYmVycy4KICovClBJWEkuUG9seWdvbiA9IGZ1bmN0aW9uKHBvaW50cykKewogICAgLy9pZiBwb2ludHMgaXNuJ3QgYW4gYXJyYXksIHVzZSBhcmd1bWVudHMgYXMgdGhlIGFycmF5CiAgICBpZighKHBvaW50cyBpbnN0YW5jZW9mIEFycmF5KSkKICAgICAgICBwb2ludHMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKICAgIC8vaWYgdGhpcyBpcyBhIGZsYXQgYXJyYXkgb2YgbnVtYmVycywgY29udmVydCBpdCB0byBwb2ludHMKICAgIGlmKHR5cGVvZiBwb2ludHNbMF0gPT09ICdudW1iZXInKSB7CiAgICAgICAgdmFyIHAgPSBbXTsKICAgICAgICBmb3IodmFyIGkgPSAwLCBpbCA9IHBvaW50cy5sZW5ndGg7IGkgPCBpbDsgaSs9MikgewogICAgICAgICAgICBwLnB1c2goCiAgICAgICAgICAgICAgICBuZXcgUElYSS5Qb2ludChwb2ludHNbaV0sIHBvaW50c1tpICsgMV0pCiAgICAgICAgICAgICk7CiAgICAgICAgfQoKICAgICAgICBwb2ludHMgPSBwOwogICAgfQoKCXRoaXMucG9pbnRzID0gcG9pbnRzOwp9CgovKioKICogQ3JlYXRlcyBhIGNsb25lIG9mIHRoaXMgcG9seWdvbgogKgogKiBAbWV0aG9kIGNsb25lCiAqIEByZXR1cm4ge1BvbHlnb259IGEgY29weSBvZiB0aGUgcG9seWdvbgogKi8KUElYSS5Qb2x5Z29uLnByb3RvdHlwZS5jbG9uZSA9IGZ1bmN0aW9uKCkKewoJdmFyIHBvaW50cyA9IFtdOwoJZm9yICh2YXIgaT0wOyBpPHRoaXMucG9pbnRzLmxlbmd0aDsgaSsrKSB7CgkJcG9pbnRzLnB1c2godGhpcy5wb2ludHNbaV0uY2xvbmUoKSk7Cgl9CgoJcmV0dXJuIG5ldyBQSVhJLlBvbHlnb24ocG9pbnRzKTsKfQoKLyoqCiAqIENoZWNrcyBpZiB0aGUgeCwgYW5kIHkgY29vcmRzIHBhc3NlZCB0byB0aGlzIGZ1bmN0aW9uIGFyZSBjb250YWluZWQgd2l0aGluIHRoaXMgcG9seWdvbgogKgogKiBAbWV0aG9kIGNvbnRhaW5zCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSBwb2ludCB0byB0ZXN0CiAqIEBwYXJhbSB5IHtOdW1iZXJ9IFRoZSBZIGNvb3JkIG9mIHRoZSBwb2ludCB0byB0ZXN0CiAqIEByZXR1cm4ge0Jvb2xlYW59IGlmIHRoZSB4L3kgY29vcmRzIGFyZSB3aXRoaW4gdGhpcyBwb2x5Z29uCiAqLwpQSVhJLlBvbHlnb24ucHJvdG90eXBlLmNvbnRhaW5zID0gZnVuY3Rpb24oeCwgeSkKewogICAgdmFyIGluc2lkZSA9IGZhbHNlOwoKICAgIC8vIHVzZSBzb21lIHJheWNhc3RpbmcgdG8gdGVzdCBoaXRzCiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vc3Vic3RhY2svcG9pbnQtaW4tcG9seWdvbi9ibG9iL21hc3Rlci9pbmRleC5qcwogICAgZm9yKHZhciBpID0gMCwgaiA9IHRoaXMucG9pbnRzLmxlbmd0aCAtIDE7IGkgPCB0aGlzLnBvaW50cy5sZW5ndGg7IGogPSBpKyspIHsKICAgICAgICB2YXIgeGkgPSB0aGlzLnBvaW50c1tpXS54LCB5aSA9IHRoaXMucG9pbnRzW2ldLnksCiAgICAgICAgICAgIHhqID0gdGhpcy5wb2ludHNbal0ueCwgeWogPSB0aGlzLnBvaW50c1tqXS55LAogICAgICAgICAgICBpbnRlcnNlY3QgPSAoKHlpID4geSkgIT0gKHlqID4geSkpICYmICh4IDwgKHhqIC0geGkpICogKHkgLSB5aSkgLyAoeWogLSB5aSkgKyB4aSk7CgogICAgICAgIGlmKGludGVyc2VjdCkgaW5zaWRlID0gIWluc2lkZTsKICAgIH0KCiAgICByZXR1cm4gaW5zaWRlOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlBvbHlnb24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Qb2x5Z29uOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBUaGUgYmFzZSBjbGFzcyBmb3IgYWxsIG9iamVjdHMgdGhhdCBhcmUgcmVuZGVyZWQgb24gdGhlIHNjcmVlbi4KICoKICogQGNsYXNzIERpc3BsYXlPYmplY3QKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkRpc3BsYXlPYmplY3QgPSBmdW5jdGlvbigpCnsKCXRoaXMubGFzdCA9IHRoaXM7Cgl0aGlzLmZpcnN0ID0gdGhpczsKCS8qKgoJICogVGhlIGNvb3JkaW5hdGUgb2YgdGhlIG9iamVjdCByZWxhdGl2ZSB0byB0aGUgbG9jYWwgY29vcmRpbmF0ZXMgb2YgdGhlIHBhcmVudC4KCSAqCgkgKiBAcHJvcGVydHkgcG9zaXRpb24KCSAqIEB0eXBlIFBvaW50CgkgKi8KCXRoaXMucG9zaXRpb24gPSBuZXcgUElYSS5Qb2ludCgpOwoKCS8qKgoJICogVGhlIHNjYWxlIGZhY3RvciBvZiB0aGUgb2JqZWN0LgoJICoKCSAqIEBwcm9wZXJ0eSBzY2FsZQoJICogQHR5cGUgUG9pbnQKCSAqLwoJdGhpcy5zY2FsZSA9IG5ldyBQSVhJLlBvaW50KDEsMSk7Ly97eDoxLCB5OjF9OwoKCS8qKgoJICogVGhlIHBpdm90IHBvaW50IG9mIHRoZSBkaXNwbGF5T2JqZWN0IHRoYXQgaXQgcm90YXRlcyBhcm91bmQKCSAqCgkgKiBAcHJvcGVydHkgcGl2b3QKCSAqIEB0eXBlIFBvaW50CgkgKi8KCXRoaXMucGl2b3QgPSBuZXcgUElYSS5Qb2ludCgwLDApOwoKCS8qKgoJICogVGhlIHJvdGF0aW9uIG9mIHRoZSBvYmplY3QgaW4gcmFkaWFucy4KCSAqCgkgKiBAcHJvcGVydHkgcm90YXRpb24KCSAqIEB0eXBlIE51bWJlcgoJICovCgl0aGlzLnJvdGF0aW9uID0gMDsKCgkvKioKCSAqIFRoZSBvcGFjaXR5IG9mIHRoZSBvYmplY3QuCgkgKgoJICogQHByb3BlcnR5IGFscGhhCgkgKiBAdHlwZSBOdW1iZXIKCSAqLwkKCXRoaXMuYWxwaGEgPSAxOwoKCS8qKgoJICogVGhlIHZpc2liaWxpdHkgb2YgdGhlIG9iamVjdC4KCSAqCgkgKiBAcHJvcGVydHkgdmlzaWJsZQoJICogQHR5cGUgQm9vbGVhbgoJICovCQoJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCgkvKioKCSAqIFRoaXMgaXMgdGhlIGRlZmluZWQgYXJlYSB0aGF0IHdpbGwgcGljayB1cCBtb3VzZSAvIHRvdWNoIGV2ZW50cy4gSXQgaXMgbnVsbCBieSBkZWZhdWx0LgoJICogU2V0dGluZyBpdCBpcyBhIG5lYXQgd2F5IG9mIG9wdGltaXNpbmcgdGhlIGhpdFRlc3QgZnVuY3Rpb24gdGhhdCB0aGUgaW50ZXJhY3Rpb25NYW5hZ2VyIHdpbGwgdXNlIChhcyBpdCB3aWxsIG5vdCBuZWVkIHRvIGhpdCB0ZXN0IGFsbCB0aGUgY2hpbGRyZW4pCgkgKgoJICogQHByb3BlcnR5IGhpdEFyZWEKCSAqIEB0eXBlIFJlY3RhbmdsZXxDaXJjbGV8RWxsaXBzZXxQb2x5Z29uCgkgKi8JCgl0aGlzLmhpdEFyZWEgPSBudWxsOwoKCS8qKgoJICogVGhpcyBpcyB1c2VkIHRvIGluZGljYXRlIGlmIHRoZSBkaXNwbGF5T2JqZWN0IHNob3VsZCBkaXNwbGF5IGEgbW91c2UgaGFuZCBjdXJzb3Igb24gcm9sbG92ZXIKCSAqCgkgKiBAcHJvcGVydHkgYnV0dG9uTW9kZQoJICogQHR5cGUgQm9vbGVhbgoJICovCgl0aGlzLmJ1dHRvbk1vZGUgPSBmYWxzZTsKCgkvKioKCSAqIENhbiB0aGlzIG9iamVjdCBiZSByZW5kZXJlZAoJICoKCSAqIEBwcm9wZXJ0eSByZW5kZXJhYmxlCgkgKiBAdHlwZSBCb29sZWFuCgkgKi8KCXRoaXMucmVuZGVyYWJsZSA9IGZhbHNlOwoKCS8qKgoJICogW3JlYWQtb25seV0gVGhlIGRpc3BsYXkgb2JqZWN0IGNvbnRhaW5lciB0aGF0IGNvbnRhaW5zIHRoaXMgZGlzcGxheSBvYmplY3QuCgkgKgoJICogQHByb3BlcnR5IHBhcmVudAoJICogQHR5cGUgRGlzcGxheU9iamVjdENvbnRhaW5lcgoJICogQHJlYWRPbmx5CgkgKi8JCgl0aGlzLnBhcmVudCA9IG51bGw7CgoJLyoqCgkgKiBbcmVhZC1vbmx5XSBUaGUgc3RhZ2UgdGhlIGRpc3BsYXkgb2JqZWN0IGlzIGNvbm5lY3RlZCB0bywgb3IgdW5kZWZpbmVkIGlmIGl0IGlzIG5vdCBjb25uZWN0ZWQgdG8gdGhlIHN0YWdlLgoJICoKCSAqIEBwcm9wZXJ0eSBzdGFnZQoJICogQHR5cGUgU3RhZ2UKCSAqIEByZWFkT25seQoJICovCQoJdGhpcy5zdGFnZSA9IG51bGw7CgoJLyoqCgkgKiBbcmVhZC1vbmx5XSBUaGUgbXVsdGlwbGllZCBhbHBoYSBvZiB0aGUgZGlzcGxheW9iamVjdAoJICoKCSAqIEBwcm9wZXJ0eSB3b3JsZEFscGhhCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEByZWFkT25seQoJICovCgl0aGlzLndvcmxkQWxwaGEgPSAxOwoKCS8qKgoJICogW3JlYWQtb25seV0gV2hldGhlciBvciBub3QgdGhlIG9iamVjdCBpcyBpbnRlcmFjdGl2ZSwgZG8gbm90IHRvZ2dsZSBkaXJlY3RseSEgdXNlIHRoZSBgaW50ZXJhY3RpdmVgIHByb3BlcnR5CgkgKgoJICogQHByb3BlcnR5IF9pbnRlcmFjdGl2ZQoJICogQHR5cGUgQm9vbGVhbgoJICogQHJlYWRPbmx5CgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLl9pbnRlcmFjdGl2ZSA9IGZhbHNlOwoKCS8qKgoJICogW3JlYWQtb25seV0gQ3VycmVudCB0cmFuc2Zvcm0gb2YgdGhlIG9iamVjdCBiYXNlZCBvbiB3b3JsZCAocGFyZW50KSBmYWN0b3JzCgkgKgoJICogQHByb3BlcnR5IHdvcmxkVHJhbnNmb3JtCgkgKiBAdHlwZSBNYXQzCgkgKiBAcmVhZE9ubHkKCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCkvL21hdDMuaWRlbnRpdHkoKTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIEN1cnJlbnQgdHJhbnNmb3JtIG9mIHRoZSBvYmplY3QgbG9jYWxseQoJICoKCSAqIEBwcm9wZXJ0eSBsb2NhbFRyYW5zZm9ybQoJICogQHR5cGUgTWF0MwoJICogQHJlYWRPbmx5CgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLmxvY2FsVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpLy9tYXQzLmlkZW50aXR5KCk7CgoJLyoqCgkgKiBbTllJXSBVbmtvd24KCSAqCgkgKiBAcHJvcGVydHkgY29sb3IKCSAqIEB0eXBlIEFycmF5PD4KCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMuY29sb3IgPSBbXTsKCgkvKioKCSAqIFtOWUldIEhvbGRzIHdoZXRoZXIgb3Igbm90IHRoaXMgb2JqZWN0IGlzIGR5bmFtaWMsIGZvciByZW5kZXJpbmcgb3B0aW1pemF0aW9uCgkgKgoJICogQHByb3BlcnR5IGR5bmFtaWMKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMuZHluYW1pYyA9IHRydWU7CgoJLy8gY2hhY2ggdGhhdCBwdXBweSEKCXRoaXMuX3NyID0gMDsKCXRoaXMuX2NyID0gMTsKCgoJdGhpcy5maWx0ZXJBcmVhID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwxLDEpOwoJCgkvKgoJICogTU9VU0UgQ2FsbGJhY2tzCgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIGNsaWNrcyBvbiB0aGUgZGlzcGxheU9iamVjdCB3aXRoIHRoZWlyIG1vdXNlCgkgKiBAbWV0aG9kIGNsaWNrCgkgKiBAcGFyYW0gaW50ZXJhY3Rpb25EYXRhIHtJbnRlcmFjdGlvbkRhdGF9CgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXIgY2xpY2tzIHRoZSBtb3VzZSBkb3duIG92ZXIgdGhlIHNwcml0ZQoJICogQG1ldGhvZCBtb3VzZWRvd24KCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgbW91c2UgdGhhdCB3YXMgb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogZm9yIHRoaXMgY2FsbGJhY2sgdG8gYmUgZmlyZWQgdGhlIG1vdXNlIG11c3QgaGF2ZSBiZWVuIHByZXNzZWQgZG93biBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBAbWV0aG9kIG1vdXNldXAKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciByZWxlYXNlcyB0aGUgbW91c2UgdGhhdCB3YXMgb3ZlciB0aGUgZGlzcGxheU9iamVjdCBidXQgaXMgbm8gbG9uZ2VyIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKCSAqIGZvciB0aGlzIGNhbGxiYWNrIHRvIGJlIGZpcmVkLCBUaGUgdG91Y2ggbXVzdCBoYXZlIHN0YXJ0ZWQgb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogQG1ldGhvZCBtb3VzZXVwb3V0c2lkZQoJICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyBtb3VzZSByb2xscyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBAbWV0aG9kIG1vdXNlb3ZlcgoJICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VycyBtb3VzZSBsZWF2ZXMgdGhlIGRpc3BsYXlPYmplY3QKCSAqIEBtZXRob2QgbW91c2VvdXQKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCgkvKgoJICogVE9VQ0ggQ2FsbGJhY2tzCgkgKi8KCgkvKioKCSAqIEEgY2FsbGJhY2sgdGhhdCBpcyB1c2VkIHdoZW4gdGhlIHVzZXJzIHRhcHMgb24gdGhlIHNwcml0ZSB3aXRoIHRoZWlyIGZpbmdlcgoJICogYmFzaWNhbGx5IGEgdG91Y2ggdmVyc2lvbiBvZiBjbGljawoJICogQG1ldGhvZCB0YXAKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwoKCS8qKgoJICogQSBjYWxsYmFjayB0aGF0IGlzIHVzZWQgd2hlbiB0aGUgdXNlciB0b3VjaCdzIG92ZXIgdGhlIGRpc3BsYXlPYmplY3QKCSAqIEBtZXRob2QgdG91Y2hzdGFydAoJICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIGEgdG91Y2ggb3ZlciB0aGUgZGlzcGxheU9iamVjdAoJICogQG1ldGhvZCB0b3VjaGVuZAoJICogQHBhcmFtIGludGVyYWN0aW9uRGF0YSB7SW50ZXJhY3Rpb25EYXRhfQoJICovCgoJLyoqCgkgKiBBIGNhbGxiYWNrIHRoYXQgaXMgdXNlZCB3aGVuIHRoZSB1c2VyIHJlbGVhc2VzIHRoZSB0b3VjaCB0aGF0IHdhcyBvdmVyIHRoZSBkaXNwbGF5T2JqZWN0CgkgKiBmb3IgdGhpcyBjYWxsYmFjayB0byBiZSBmaXJlZCwgVGhlIHRvdWNoIG11c3QgaGF2ZSBzdGFydGVkIG92ZXIgdGhlIHNwcml0ZQoJICogQG1ldGhvZCB0b3VjaGVuZG91dHNpZGUKCSAqIEBwYXJhbSBpbnRlcmFjdGlvbkRhdGEge0ludGVyYWN0aW9uRGF0YX0KCSAqLwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5EaXNwbGF5T2JqZWN0OwoKLyoqCiAqIFtEZXByZWNhdGVkXSBJbmRpY2F0ZXMgaWYgdGhlIHNwcml0ZSB3aWxsIGhhdmUgdG91Y2ggYW5kIG1vdXNlIGludGVyYWN0aXZpdHkuIEl0IGlzIGZhbHNlIGJ5IGRlZmF1bHQKICogSW5zdGVhZCBvZiB1c2luZyB0aGlzIGZ1bmN0aW9uIHlvdSBjYW4gbm93IHNpbXBseSBzZXQgdGhlIGludGVyYWN0aXZlIHByb3BlcnR5IHRvIHRydWUgb3IgZmFsc2UKICoKICogQG1ldGhvZCBzZXRJbnRlcmFjdGl2ZQogKiBAcGFyYW0gaW50ZXJhY3RpdmUge0Jvb2xlYW59CiAqIEBkZXByZWNhdGVkIFNpbXBseSBzZXQgdGhlIGBpbnRlcmFjdGl2ZWAgcHJvcGVydHkgZGlyZWN0bHkKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUuc2V0SW50ZXJhY3RpdmUgPSBmdW5jdGlvbihpbnRlcmFjdGl2ZSkKewoJdGhpcy5pbnRlcmFjdGl2ZSA9IGludGVyYWN0aXZlOwp9CgovKioKICogSW5kaWNhdGVzIGlmIHRoZSBzcHJpdGUgd2lsbCBoYXZlIHRvdWNoIGFuZCBtb3VzZSBpbnRlcmFjdGl2aXR5LiBJdCBpcyBmYWxzZSBieSBkZWZhdWx0CiAqCiAqIEBwcm9wZXJ0eSBpbnRlcmFjdGl2ZQogKiBAdHlwZSBCb29sZWFuCiAqIEBkZWZhdWx0IGZhbHNlCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZSwgJ2ludGVyYWN0aXZlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5faW50ZXJhY3RpdmU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuX2ludGVyYWN0aXZlID0gdmFsdWU7CiAgICAJCiAgICAJLy8gVE9ETyBtb3JlIHRvIGJlIGRvbmUgaGVyZS4uCgkJLy8gbmVlZCB0byBzb3J0IG91dCBhIHJlLWNyYXdsIQoJCWlmKHRoaXMuc3RhZ2UpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgYSBtYXNrIGZvciB0aGUgZGlzcGxheU9iamVjdC4gQSBtYXNrIGlzIGFuIG9iamVjdCB0aGF0IGxpbWl0cyB0aGUgdmlzaWJpbGl0eSBvZiBhbiBvYmplY3QgdG8gdGhlIHNoYXBlIG9mIHRoZSBtYXNrIGFwcGxpZWQgdG8gaXQuCiAqIEluIFBJWEkgYSByZWd1bGFyIG1hc2sgbXVzdCBiZSBhIFBJWEkuR2dyYXBoaWNzIG9iamVjdC4gVGhpcyBhbGxvd3MgZm9yIG11Y2ggZmFzdGVyIG1hc2tpbmcgaW4gY2FudmFzIGFzIGl0IHV0aWxpc2VzIHNoYXBlIGNsaXBwaW5nLgogKiBUbyByZW1vdmUgYSBtYXNrLCBzZXQgdGhpcyBwcm9wZXJ0eSB0byBudWxsLgogKgogKiBAcHJvcGVydHkgbWFzawogKiBAdHlwZSBHcmFwaGljcwogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUsICdtYXNrJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbWFzazsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJCiAgICAJCiAgICAgICAgaWYodmFsdWUpCiAgICAgICAgewogICAgICAgIAlpZih0aGlzLl9tYXNrKQoJICAgIAl7CgkgICAgCQl2YWx1ZS5zdGFydCA9IHRoaXMuX21hc2suc3RhcnQ7CgkgICAgCQl2YWx1ZS5lbmQgPSB0aGlzLl9tYXNrLmVuZDsKCSAgICAJfQogICAgCQllbHNlCiAgICAJCXsKCQkgICAgICAgIHRoaXMuYWRkRmlsdGVyKHZhbHVlKTsKCQkgICAgICAgIHZhbHVlLnJlbmRlcmFibGUgPSBmYWxzZTsKICAgIAkJfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgIAkgdGhpcy5yZW1vdmVGaWx0ZXIodGhpcy5fbWFzayk7CgkJCSB0aGlzLl9tYXNrLnJlbmRlcmFibGUgPSB0cnVlOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLl9tYXNrID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgdGhlIGZpbHRlcnMgZm9yIHRoZSBkaXNwbGF5T2JqZWN0LiAKICogKiBJTVBPUlRBTlQ6IFRoaXMgaXMgYSB3ZWJHTCBvbmx5IGZlYXR1cmUgYW5kIHdpbGwgYmUgaWdub3JlZCBieSB0aGUgY2FudmFzIHJlbmRlcmVyLgogKiBUbyByZW1vdmUgZmlsdGVycyBzaW1wbHkgc2V0IHRoaXMgcHJvcGVydHkgdG8gJ251bGwnCiAqIEBwcm9wZXJ0eSBmaWx0ZXJzCiAqIEB0eXBlIEFycmF5IEFuIGFycmF5IG9mIGZpbHRlcnMKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLCAnZmlsdGVycycsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlcnM7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCQogICAgICAgIGlmKHZhbHVlKQogICAgICAgIHsKICAgICAgICAJaWYodGhpcy5fZmlsdGVycyl0aGlzLnJlbW92ZUZpbHRlcih0aGlzLl9maWx0ZXJzKTsKCSAgICAgICAgdGhpcy5hZGRGaWx0ZXIodmFsdWUpOwoKCQkgICAgLy8gbm93IHB1dCBhbGwgdGhlIHBhc3NlcyBpbiBvbmUgcGxhY2UuLgoJICAgICAgICB2YXIgcGFzc2VzID0gW107CgkgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmFsdWUubGVuZ3RoOyBpKyspIAoJICAgICAgICB7CgkgICAgICAgIAl2YXIgZmlsdGVyUGFzc2VzID0gdmFsdWVbaV0ucGFzc2VzOwoJICAgICAgICAJZm9yICh2YXIgaiA9IDA7IGogPCBmaWx0ZXJQYXNzZXMubGVuZ3RoOyBqKyspIAoJICAgICAgICAJewoJICAgICAgICAJCXBhc3Nlcy5wdXNoKGZpbHRlclBhc3Nlc1tqXSk7CgkgICAgICAgIAl9OwoJICAgICAgICB9OwoKCSAgICAgICAgdmFsdWUuc3RhcnQuZmlsdGVyUGFzc2VzID0gcGFzc2VzOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgIAlpZih0aGlzLl9maWx0ZXJzKXRoaXMucmVtb3ZlRmlsdGVyKHRoaXMuX2ZpbHRlcnMpOwogICAgICAgIH0KICAgICAgICAKICAgICAgICB0aGlzLl9maWx0ZXJzID0gdmFsdWU7CgogICAgICAgCgogICAgICAgIAogICAgfQp9KTsKCi8qCiAqIEFkZHMgYSBmaWx0ZXIgdG8gdGhpcyBkaXNwbGF5T2JqZWN0CiAqCiAqIEBtZXRob2QgYWRkRmlsdGVyCiAqIEBwYXJhbSBtYXNrIHtHcmFwaGljc30gdGhlIGdyYXBoaWNzIG9iamVjdCB0byB1c2UgYXMgYSBmaWx0ZXIKICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUuYWRkRmlsdGVyID0gZnVuY3Rpb24oZGF0YSkKewoKCS8vIGluc2VydCBhIGZpbHRlciBibG9jay4uCgkvLyBUT0RPIE9uamVjdCBwb29sIHRoZWFzZSBiYWQgYm95cy4uCgl2YXIgc3RhcnQgPSBuZXcgUElYSS5GaWx0ZXJCbG9jaygpOwoJdmFyIGVuZCA9IG5ldyBQSVhJLkZpbHRlckJsb2NrKCk7CgkKCWRhdGEuc3RhcnQgPSBzdGFydDsKCWRhdGEuZW5kID0gZW5kOwoJCglzdGFydC5kYXRhID0gZGF0YTsKCWVuZC5kYXRhID0gZGF0YTsKCQoJc3RhcnQuZmlyc3QgPSBzdGFydC5sYXN0ID0gIHRoaXM7CgllbmQuZmlyc3QgPSBlbmQubGFzdCA9IHRoaXM7CgkKCXN0YXJ0Lm9wZW4gPSB0cnVlOwoJCglzdGFydC50YXJnZXQgPSB0aGlzOwoJCgkvKgoJICogaW5zZXJ0IHN0YXJ0CgkgKi8KCQoJdmFyIGNoaWxkRmlyc3QgPSBzdGFydAoJdmFyIGNoaWxkTGFzdCA9IHN0YXJ0Cgl2YXIgbmV4dE9iamVjdDsKCXZhciBwcmV2aW91c09iamVjdDsKCQkKCXByZXZpb3VzT2JqZWN0ID0gdGhpcy5maXJzdC5faVByZXY7CgkKCWlmKHByZXZpb3VzT2JqZWN0KQoJewoJCW5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CgkJY2hpbGRGaXJzdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKCQlwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwkJCgl9CgllbHNlCgl7CgkJbmV4dE9iamVjdCA9IHRoaXM7Cgl9CQoJCglpZihuZXh0T2JqZWN0KQoJewoJCW5leHRPYmplY3QuX2lQcmV2ID0gY2hpbGRMYXN0OwoJCWNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwoJfQoJCgkKCS8vIG5vdyBpbnNlcnQgdGhlIGVuZCBmaWx0ZXIgYmxvY2suLgoJCgkvKgoJICogaW5zZXJ0IGVuZCBmaWx0ZXIKCSAqLwoJdmFyIGNoaWxkRmlyc3QgPSBlbmQKCXZhciBjaGlsZExhc3QgPSBlbmQKCXZhciBuZXh0T2JqZWN0ID0gbnVsbDsKCXZhciBwcmV2aW91c09iamVjdCA9IG51bGw7CgkJCglwcmV2aW91c09iamVjdCA9IHRoaXMubGFzdDsKCW5leHRPYmplY3QgPSBwcmV2aW91c09iamVjdC5faU5leHQ7CgkKCWlmKG5leHRPYmplY3QpCgl7CgkJbmV4dE9iamVjdC5faVByZXYgPSBjaGlsZExhc3Q7CgkJY2hpbGRMYXN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7Cgl9CgkKCWNoaWxkRmlyc3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CglwcmV2aW91c09iamVjdC5faU5leHQgPSBjaGlsZEZpcnN0OwkKCQoJdmFyIHVwZGF0ZUxhc3QgPSB0aGlzOwoJCgl2YXIgcHJldkxhc3QgPSB0aGlzLmxhc3Q7Cgl3aGlsZSh1cGRhdGVMYXN0KQoJewoJCWlmKHVwZGF0ZUxhc3QubGFzdCA9PSBwcmV2TGFzdCkKCQl7CgkJCXVwZGF0ZUxhc3QubGFzdCA9IGVuZDsKCQl9CgkJdXBkYXRlTGFzdCA9IHVwZGF0ZUxhc3QucGFyZW50OwoJfQoJCgl0aGlzLmZpcnN0ID0gc3RhcnQ7CgkKCS8vIGlmIHdlYkdMLi4uCglpZih0aGlzLl9fcmVuZGVyR3JvdXApCgl7CgkJdGhpcy5fX3JlbmRlckdyb3VwLmFkZEZpbHRlckJsb2NrcyhzdGFydCwgZW5kKTsKCX0KCQp9CgovKgogKiBSZW1vdmVzIHRoZSBmaWx0ZXIgdG8gdGhpcyBkaXNwbGF5T2JqZWN0CiAqCiAqIEBtZXRob2QgcmVtb3ZlRmlsdGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLnJlbW92ZUZpbHRlciA9IGZ1bmN0aW9uKGRhdGEpCnsKCS8vaWYoIXRoaXMuZmlsdGVyKXJldHVybjsKCS8vdGhpcy5maWx0ZXIgPSBmYWxzZTsKCWNvbnNvbGUubG9nKCJZVU9JTyIpCgkvLyBtb2RpZnkgdGhlIGxpc3QuLgoJdmFyIHN0YXJ0QmxvY2sgPSBkYXRhLnN0YXJ0OwoJCgkKCXZhciBuZXh0T2JqZWN0ID0gc3RhcnRCbG9jay5faU5leHQ7Cgl2YXIgcHJldmlvdXNPYmplY3QgPSBzdGFydEJsb2NrLl9pUHJldjsKCQkKCWlmKG5leHRPYmplY3QpbmV4dE9iamVjdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKCWlmKHByZXZpb3VzT2JqZWN0KXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CQkKCQoJdGhpcy5maXJzdCA9IHN0YXJ0QmxvY2suX2lOZXh0OwoJCgkvLyByZW1vdmUgdGhlIGVuZCBmaWx0ZXIKCXZhciBsYXN0QmxvY2sgPSBkYXRhLmVuZDsKCQoJdmFyIG5leHRPYmplY3QgPSBsYXN0QmxvY2suX2lOZXh0OwoJdmFyIHByZXZpb3VzT2JqZWN0ID0gbGFzdEJsb2NrLl9pUHJldjsKCQkKCWlmKG5leHRPYmplY3QpbmV4dE9iamVjdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKCXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IG5leHRPYmplY3Q7CQkKCQoJLy8gdGhpcyBpcyBhbHdheXMgdHJ1ZSB0b28hCgl2YXIgdGVtcExhc3QgPSAgbGFzdEJsb2NrLl9pUHJldjsJCgkvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCgl2YXIgdXBkYXRlTGFzdCA9IHRoaXM7Cgl3aGlsZSh1cGRhdGVMYXN0Lmxhc3QgPT0gbGFzdEJsb2NrKQoJewoJCXVwZGF0ZUxhc3QubGFzdCA9IHRlbXBMYXN0OwoJCXVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKCQlpZighdXBkYXRlTGFzdClicmVhazsKCX0KCQoJLy8gaWYgd2ViR0wuLi4KCWlmKHRoaXMuX19yZW5kZXJHcm91cCkKCXsKCQl0aGlzLl9fcmVuZGVyR3JvdXAucmVtb3ZlRmlsdGVyQmxvY2tzKHN0YXJ0QmxvY2ssIGxhc3RCbG9jayk7Cgl9Cn0KCi8qCiAqIFVwZGF0ZXMgdGhlIG9iamVjdCB0cmFuc2Zvcm0gZm9yIHJlbmRlcmluZwogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKCS8vIFRPRE8gT1BUSU1JWkUgVEhJUyEhIHdpdGggZGlydHkKCWlmKHRoaXMucm90YXRpb24gIT09IHRoaXMucm90YXRpb25DYWNoZSkKCXsKCQl0aGlzLnJvdGF0aW9uQ2FjaGUgPSB0aGlzLnJvdGF0aW9uOwoJCXRoaXMuX3NyID0gIE1hdGguc2luKHRoaXMucm90YXRpb24pOwoJCXRoaXMuX2NyID0gIE1hdGguY29zKHRoaXMucm90YXRpb24pOwoJfQkKCQoJdmFyIGxvY2FsVHJhbnNmb3JtID0gdGhpcy5sb2NhbFRyYW5zZm9ybTsKCXZhciBwYXJlbnRUcmFuc2Zvcm0gPSB0aGlzLnBhcmVudC53b3JsZFRyYW5zZm9ybTsKCXZhciB3b3JsZFRyYW5zZm9ybSA9IHRoaXMud29ybGRUcmFuc2Zvcm07CgkvL2NvbnNvbGUubG9nKGxvY2FsVHJhbnNmb3JtKQoJbG9jYWxUcmFuc2Zvcm1bMF0gPSB0aGlzLl9jciAqIHRoaXMuc2NhbGUueDsKCWxvY2FsVHJhbnNmb3JtWzFdID0gLXRoaXMuX3NyICogdGhpcy5zY2FsZS55Cglsb2NhbFRyYW5zZm9ybVszXSA9IHRoaXMuX3NyICogdGhpcy5zY2FsZS54OwoJbG9jYWxUcmFuc2Zvcm1bNF0gPSB0aGlzLl9jciAqIHRoaXMuc2NhbGUueTsKCQoJLy8gVE9ETyAtLT4gZG8gd2UgZXZlbiBuZWVkIGEgbG9jYWwgbWF0cml4Pz8/CgkKCXZhciBweCA9IHRoaXMucGl2b3QueDsKCXZhciBweSA9IHRoaXMucGl2b3QueTsKICAgCQogICAgLy8gQ2FjaGUgdGhlIG1hdHJpeCB2YWx1ZXMgKG1ha2VzIGZvciBodWdlIHNwZWVkIGluY3JlYXNlcyEpCiAgICB2YXIgYTAwID0gbG9jYWxUcmFuc2Zvcm1bMF0sIGEwMSA9IGxvY2FsVHJhbnNmb3JtWzFdLCBhMDIgPSB0aGlzLnBvc2l0aW9uLnggLSBsb2NhbFRyYW5zZm9ybVswXSAqIHB4IC0gcHkgKiBsb2NhbFRyYW5zZm9ybVsxXSwKICAgICAgICBhMTAgPSBsb2NhbFRyYW5zZm9ybVszXSwgYTExID0gbG9jYWxUcmFuc2Zvcm1bNF0sIGExMiA9IHRoaXMucG9zaXRpb24ueSAtIGxvY2FsVHJhbnNmb3JtWzRdICogcHkgLSBweCAqIGxvY2FsVHJhbnNmb3JtWzNdLAoKICAgICAgICBiMDAgPSBwYXJlbnRUcmFuc2Zvcm1bMF0sIGIwMSA9IHBhcmVudFRyYW5zZm9ybVsxXSwgYjAyID0gcGFyZW50VHJhbnNmb3JtWzJdLAogICAgICAgIGIxMCA9IHBhcmVudFRyYW5zZm9ybVszXSwgYjExID0gcGFyZW50VHJhbnNmb3JtWzRdLCBiMTIgPSBwYXJlbnRUcmFuc2Zvcm1bNV07CgoJbG9jYWxUcmFuc2Zvcm1bMl0gPSBhMDIKCWxvY2FsVHJhbnNmb3JtWzVdID0gYTEyCgkKICAgIHdvcmxkVHJhbnNmb3JtWzBdID0gYjAwICogYTAwICsgYjAxICogYTEwOwogICAgd29ybGRUcmFuc2Zvcm1bMV0gPSBiMDAgKiBhMDEgKyBiMDEgKiBhMTE7CiAgICB3b3JsZFRyYW5zZm9ybVsyXSA9IGIwMCAqIGEwMiArIGIwMSAqIGExMiArIGIwMjsKCiAgICB3b3JsZFRyYW5zZm9ybVszXSA9IGIxMCAqIGEwMCArIGIxMSAqIGExMDsKICAgIHdvcmxkVHJhbnNmb3JtWzRdID0gYjEwICogYTAxICsgYjExICogYTExOwogICAgd29ybGRUcmFuc2Zvcm1bNV0gPSBiMTAgKiBhMDIgKyBiMTEgKiBhMTIgKyBiMTI7CgoJLy8gYmVjYXVzZSB3ZSBhcmUgdXNpbmcgYWZmaW5lIHRyYW5zZm9ybWF0aW9uLCB3ZSBjYW4gb3B0aW1pc2UgdGhlIG1hdHJpeCBjb25jYXRlbmF0aW9uIHByb2Nlc3MuLiB3b29vIQoJLy8gbWF0My5tdWx0aXBseSh0aGlzLmxvY2FsVHJhbnNmb3JtLCB0aGlzLnBhcmVudC53b3JsZFRyYW5zZm9ybSwgdGhpcy53b3JsZFRyYW5zZm9ybSk7Cgl0aGlzLndvcmxkQWxwaGEgPSB0aGlzLmFscGhhICogdGhpcy5wYXJlbnQud29ybGRBbHBoYTsKCQoJdGhpcy52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKCn0KClBJWEkudmlzaWJsZUNvdW50ID0gMDsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogQSBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHJlcHJlc2VudHMgYSBjb2xsZWN0aW9uIG9mIGRpc3BsYXkgb2JqZWN0cy4KICogSXQgaXMgdGhlIGJhc2UgY2xhc3Mgb2YgYWxsIGRpc3BsYXkgb2JqZWN0cyB0aGF0IGFjdCBhcyBhIGNvbnRhaW5lciBmb3Igb3RoZXIgb2JqZWN0cy4KICoKICogQGNsYXNzIERpc3BsYXlPYmplY3RDb250YWluZXIgCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3QKICogQGNvbnN0cnVjdG9yCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuRGlzcGxheU9iamVjdC5jYWxsKCB0aGlzICk7CgkKCS8qKgoJICogW3JlYWQtb25seV0gVGhlIG9mIGNoaWxkcmVuIG9mIHRoaXMgY29udGFpbmVyLgoJICoKCSAqIEBwcm9wZXJ0eSBjaGlsZHJlbgoJICogQHR5cGUgQXJyYXk8RGlzcGxheU9iamVjdD4KCSAqIEByZWFkT25seQoJICovCQoJdGhpcy5jaGlsZHJlbiA9IFtdOwp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0LnByb3RvdHlwZSApOwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyOwoKLyoqCiAqIEFkZHMgYSBjaGlsZCB0byB0aGUgY29udGFpbmVyLgogKgogKiBAbWV0aG9kIGFkZENoaWxkCiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0gVGhlIERpc3BsYXlPYmplY3QgdG8gYWRkIHRvIHRoZSBjb250YWluZXIKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUuYWRkQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkKewoJaWYoY2hpbGQucGFyZW50ICE9IHVuZGVmaW5lZCkKCXsKCQkKCQkvLy8vIENPVUxEIEJFIFRISVM/Pz8KCQljaGlsZC5wYXJlbnQucmVtb3ZlQ2hpbGQoY2hpbGQpOwoJLy8JcmV0dXJuOwoJfQoKCWNoaWxkLnBhcmVudCA9IHRoaXM7CgkKCXRoaXMuY2hpbGRyZW4ucHVzaChjaGlsZCk7CQoJCgkvLyB1cGRhdGUgdGhlIHN0YWdlIHJlZmZlcmVuY2UuLgoJCglpZih0aGlzLnN0YWdlKQoJewoJCXZhciB0bXBDaGlsZCA9IGNoaWxkOwoJCWRvCgkJewoJCQlpZih0bXBDaGlsZC5pbnRlcmFjdGl2ZSl0aGlzLnN0YWdlLmRpcnR5ID0gdHJ1ZTsKCQkJdG1wQ2hpbGQuc3RhZ2UgPSB0aGlzLnN0YWdlOwoJCQl0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKCQl9CQoJCXdoaWxlKHRtcENoaWxkKQoJfQoJCgkvLyBMSU5LRUQgTElTVCAvLwoJCgkvLyBtb2RpZnkgdGhlIGxpc3QuLgoJdmFyIGNoaWxkRmlyc3QgPSBjaGlsZC5maXJzdAoJdmFyIGNoaWxkTGFzdCA9IGNoaWxkLmxhc3Q7Cgl2YXIgbmV4dE9iamVjdDsKCXZhciBwcmV2aW91c09iamVjdDsKCQoJLy8gdGhpcyBjb3VsZCBiZSB3cm9uZyBpZiB0aGVyZSBpcyBhIGZpbHRlcj8/CglpZih0aGlzLl9maWx0ZXJzIHx8IHRoaXMuX21hc2spCgl7CgkJcHJldmlvdXNPYmplY3QgPSAgdGhpcy5sYXN0Ll9pUHJldjsKCX0KCWVsc2UKCXsKCQlwcmV2aW91c09iamVjdCA9IHRoaXMubGFzdDsKCX0KCgluZXh0T2JqZWN0ID0gcHJldmlvdXNPYmplY3QuX2lOZXh0OwoJCgkvLyBhbHdheXMgdHJ1ZSBpbiB0aGlzIGNhc2UKCS8vIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYXJlbnRzIGxhc3QgaXMgdXBkYXRlZCB0b28KCXZhciB1cGRhdGVMYXN0ID0gdGhpczsKCXZhciBwcmV2TGFzdCA9IHByZXZpb3VzT2JqZWN0OwoJCgl3aGlsZSh1cGRhdGVMYXN0KQoJewoJCWlmKHVwZGF0ZUxhc3QubGFzdCA9PSBwcmV2TGFzdCkKCQl7CgkJCXVwZGF0ZUxhc3QubGFzdCA9IGNoaWxkLmxhc3Q7CgkJfQoJCXVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKCX0KCQoJaWYobmV4dE9iamVjdCkKCXsKCQluZXh0T2JqZWN0Ll9pUHJldiA9IGNoaWxkTGFzdDsKCQljaGlsZExhc3QuX2lOZXh0ID0gbmV4dE9iamVjdDsKCX0KCQoJY2hpbGRGaXJzdC5faVByZXYgPSBwcmV2aW91c09iamVjdDsKCXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IGNoaWxkRmlyc3Q7CQkKCgkvLyBuZWVkIHRvIHJlbW92ZSBhbnkgcmVuZGVyIGdyb3Vwcy4uCglpZih0aGlzLl9fcmVuZGVyR3JvdXApCgl7CgkJLy8gYmVpbmcgdXNlZCBieSBhIHJlbmRlclRleHR1cmUuLiBpZiBpdCBleGlzdHMgdGhlbiBpdCBtdXN0IGJlIGZyb20gYSByZW5kZXIgdGV4dHVyZTsKCQlpZihjaGlsZC5fX3JlbmRlckdyb3VwKWNoaWxkLl9fcmVuZGVyR3JvdXAucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGNoaWxkKTsKCQkvLyBhZGQgdGhlbSB0byB0aGUgbmV3IHJlbmRlciBncm91cC4uCgkJdGhpcy5fX3JlbmRlckdyb3VwLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7Cgl9CgkKfQoKLyoqCiAqIEFkZHMgYSBjaGlsZCB0byB0aGUgY29udGFpbmVyIGF0IGEgc3BlY2lmaWVkIGluZGV4LiBJZiB0aGUgaW5kZXggaXMgb3V0IG9mIGJvdW5kcyBhbiBlcnJvciB3aWxsIGJlIHRocm93bgogKgogKiBAbWV0aG9kIGFkZENoaWxkQXQKICogQHBhcmFtIGNoaWxkIHtEaXNwbGF5T2JqZWN0fSBUaGUgY2hpbGQgdG8gYWRkCiAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfSBUaGUgaW5kZXggdG8gcGxhY2UgdGhlIGNoaWxkIGluCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmFkZENoaWxkQXQgPSBmdW5jdGlvbihjaGlsZCwgaW5kZXgpCnsKCWlmKGluZGV4ID49IDAgJiYgaW5kZXggPD0gdGhpcy5jaGlsZHJlbi5sZW5ndGgpCgl7CgkJaWYoY2hpbGQucGFyZW50ICE9IHVuZGVmaW5lZCkKCQl7CgkJCWNoaWxkLnBhcmVudC5yZW1vdmVDaGlsZChjaGlsZCk7CgkJfQoJCWNoaWxkLnBhcmVudCA9IHRoaXM7CgkJCgkJaWYodGhpcy5zdGFnZSkKCQl7CgkJCXZhciB0bXBDaGlsZCA9IGNoaWxkOwoJCQlkbwoJCQl7CgkJCQlpZih0bXBDaGlsZC5pbnRlcmFjdGl2ZSl0aGlzLnN0YWdlLmRpcnR5ID0gdHJ1ZTsKCQkJCXRtcENoaWxkLnN0YWdlID0gdGhpcy5zdGFnZTsKCQkJCXRtcENoaWxkID0gdG1wQ2hpbGQuX2lOZXh0OwoJCQl9CgkJCXdoaWxlKHRtcENoaWxkKQoJCX0KCQkKCQkvLyBtb2RpZnkgdGhlIGxpc3QuLgoJCXZhciBjaGlsZEZpcnN0ID0gY2hpbGQuZmlyc3Q7CgkJdmFyIGNoaWxkTGFzdCA9IGNoaWxkLmxhc3Q7CgkJdmFyIG5leHRPYmplY3Q7CgkJdmFyIHByZXZpb3VzT2JqZWN0OwoJCQoJCWlmKGluZGV4ID09IHRoaXMuY2hpbGRyZW4ubGVuZ3RoKQoJCXsKCQkJcHJldmlvdXNPYmplY3QgPSAgdGhpcy5sYXN0OwoJCQl2YXIgdXBkYXRlTGFzdCA9IHRoaXM7CgkJCXZhciBwcmV2TGFzdCA9IHRoaXMubGFzdDsKCQkJd2hpbGUodXBkYXRlTGFzdCkKCQkJewoJCQkJaWYodXBkYXRlTGFzdC5sYXN0ID09IHByZXZMYXN0KQoJCQkJewoJCQkJCXVwZGF0ZUxhc3QubGFzdCA9IGNoaWxkLmxhc3Q7CgkJCQl9CgkJCQl1cGRhdGVMYXN0ID0gdXBkYXRlTGFzdC5wYXJlbnQ7CgkJCX0KCQl9CgkJZWxzZSBpZihpbmRleCA9PSAwKQoJCXsKCQkJcHJldmlvdXNPYmplY3QgPSB0aGlzOwoJCX0KCQllbHNlCgkJewoJCQlwcmV2aW91c09iamVjdCA9IHRoaXMuY2hpbGRyZW5baW5kZXgtMV0ubGFzdDsKCQl9CgkJCgkJbmV4dE9iamVjdCA9IHByZXZpb3VzT2JqZWN0Ll9pTmV4dDsKCQkKCQkvLyBhbHdheXMgdHJ1ZSBpbiB0aGlzIGNhc2UKCQlpZihuZXh0T2JqZWN0KQoJCXsKCQkJbmV4dE9iamVjdC5faVByZXYgPSBjaGlsZExhc3Q7CgkJCWNoaWxkTGFzdC5faU5leHQgPSBuZXh0T2JqZWN0OwoJCX0KCQkKCQljaGlsZEZpcnN0Ll9pUHJldiA9IHByZXZpb3VzT2JqZWN0OwoJCXByZXZpb3VzT2JqZWN0Ll9pTmV4dCA9IGNoaWxkRmlyc3Q7CQkKCgkJdGhpcy5jaGlsZHJlbi5zcGxpY2UoaW5kZXgsIDAsIGNoaWxkKTsKCQkvLyBuZWVkIHRvIHJlbW92ZSBhbnkgcmVuZGVyIGdyb3Vwcy4uCgkJaWYodGhpcy5fX3JlbmRlckdyb3VwKQoJCXsKCQkJLy8gYmVpbmcgdXNlZCBieSBhIHJlbmRlclRleHR1cmUuLiBpZiBpdCBleGlzdHMgdGhlbiBpdCBtdXN0IGJlIGZyb20gYSByZW5kZXIgdGV4dHVyZTsKCQkJaWYoY2hpbGQuX19yZW5kZXJHcm91cCljaGlsZC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CgkJCS8vIGFkZCB0aGVtIHRvIHRoZSBuZXcgcmVuZGVyIGdyb3VwLi4KCQkJdGhpcy5fX3JlbmRlckdyb3VwLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CgkJfQoJCQoJfQoJZWxzZQoJewoJCXRocm93IG5ldyBFcnJvcihjaGlsZCArICIgVGhlIGluZGV4ICIrIGluZGV4ICsiIHN1cHBsaWVkIGlzIG91dCBvZiBib3VuZHMgIiArIHRoaXMuY2hpbGRyZW4ubGVuZ3RoKTsKCX0KfQoKLyoqCiAqIFtOWUldIFN3YXBzIHRoZSBkZXB0aCBvZiAyIGRpc3BsYXlPYmplY3RzCiAqCiAqIEBtZXRob2Qgc3dhcENoaWxkcmVuCiAqIEBwYXJhbSBjaGlsZCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIGNoaWxkMiB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUuc3dhcENoaWxkcmVuID0gZnVuY3Rpb24oY2hpbGQsIGNoaWxkMikKewoJLyoKCSAqIHRoaXMgZnVudGlvbiBuZWVkcyB0byBiZSByZWNvZGVkLi4gCgkgKiBjYW4gYmUgZG9uZSBhIGxvdCBmYXN0ZXIuLgoJICovCglyZXR1cm47CgkKCS8vIG5lZWQgdG8gZml4IHRoaXMgZnVuY3Rpb24gOi8KCS8qCgkvLyBUT0RPIEkgYWxyZWFkeSBrbm93IHRoaXM/PwoJdmFyIGluZGV4ID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKCBjaGlsZCApOwoJdmFyIGluZGV4MiA9IHRoaXMuY2hpbGRyZW4uaW5kZXhPZiggY2hpbGQyICk7CgkKCWlmICggaW5kZXggIT09IC0xICYmIGluZGV4MiAhPT0gLTEgKSAKCXsKCQkvLyBjb29sCgkJCgkJLyoKCQlpZih0aGlzLnN0YWdlKQoJCXsKCQkJLy8gdGhpcyBpcyB0byBzYXRpc2Z5IHRoZSB3ZWJHTCBiYXRjaGluZy4uCgkJCS8vIFRPRE8gc3VyZSB0aGVyZSBpcyBhIG5pY2VyIHdheSB0byBhY2hpZXZlIHRoaXMhCgkJCXRoaXMuc3RhZ2UuX19yZW1vdmVDaGlsZChjaGlsZCk7CgkJCXRoaXMuc3RhZ2UuX19yZW1vdmVDaGlsZChjaGlsZDIpOwoJCQkKCQkJdGhpcy5zdGFnZS5fX2FkZENoaWxkKGNoaWxkKTsKCQkJdGhpcy5zdGFnZS5fX2FkZENoaWxkKGNoaWxkMik7CgkJfQoJCQoJCS8vIHN3YXAgdGhlIHBvc2l0aW9ucy4uCgkJdGhpcy5jaGlsZHJlbltpbmRleF0gPSBjaGlsZDI7CgkJdGhpcy5jaGlsZHJlbltpbmRleDJdID0gY2hpbGQ7CgkJCgl9CgllbHNlCgl7CgkJdGhyb3cgbmV3IEVycm9yKGNoaWxkICsgIiBCb3RoIHRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0cyBtdXN0IGJlIGEgY2hpbGQgb2YgdGhlIGNhbGxlciAiICsgdGhpcyk7Cgl9Ki8KfQoKLyoqCiAqIFJldHVybnMgdGhlIENoaWxkIGF0IHRoZSBzcGVjaWZpZWQgaW5kZXgKICoKICogQG1ldGhvZCBnZXRDaGlsZEF0CiAqIEBwYXJhbSBpbmRleCB7TnVtYmVyfSBUaGUgaW5kZXggdG8gZ2V0IHRoZSBjaGlsZCBmcm9tCiAqLwpQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLmdldENoaWxkQXQgPSBmdW5jdGlvbihpbmRleCkKewoJaWYoaW5kZXggPj0gMCAmJiBpbmRleCA8IHRoaXMuY2hpbGRyZW4ubGVuZ3RoKQoJewoJCXJldHVybiB0aGlzLmNoaWxkcmVuW2luZGV4XTsKCX0KCWVsc2UKCXsKCQl0aHJvdyBuZXcgRXJyb3IoY2hpbGQgKyAiIEJvdGggdGhlIHN1cHBsaWVkIERpc3BsYXlPYmplY3RzIG11c3QgYmUgYSBjaGlsZCBvZiB0aGUgY2FsbGVyICIgKyB0aGlzKTsKCX0KfQoKLyoqCiAqIFJlbW92ZXMgYSBjaGlsZCBmcm9tIHRoZSBjb250YWluZXIuCiAqCiAqIEBtZXRob2QgcmVtb3ZlQ2hpbGQKICogQHBhcmFtIGNoaWxkIHtEaXNwbGF5T2JqZWN0fSBUaGUgRGlzcGxheU9iamVjdCB0byByZW1vdmUKICovClBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUucmVtb3ZlQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkKewoJdmFyIGluZGV4ID0gdGhpcy5jaGlsZHJlbi5pbmRleE9mKCBjaGlsZCApOwoJaWYgKCBpbmRleCAhPT0gLTEgKSAKCXsKCQkvLyB1bmxpbmsgLy8KCQkvLyBtb2RpZnkgdGhlIGxpc3QuLgoJCXZhciBjaGlsZEZpcnN0ID0gY2hpbGQuZmlyc3Q7CgkJdmFyIGNoaWxkTGFzdCA9IGNoaWxkLmxhc3Q7CgkJCgkJdmFyIG5leHRPYmplY3QgPSBjaGlsZExhc3QuX2lOZXh0OwoJCXZhciBwcmV2aW91c09iamVjdCA9IGNoaWxkRmlyc3QuX2lQcmV2OwoJCQkKCQlpZihuZXh0T2JqZWN0KW5leHRPYmplY3QuX2lQcmV2ID0gcHJldmlvdXNPYmplY3Q7CgkJcHJldmlvdXNPYmplY3QuX2lOZXh0ID0gbmV4dE9iamVjdDsJCQoJCQoJCWlmKHRoaXMubGFzdCA9PSBjaGlsZExhc3QpCgkJewoJCQl2YXIgdGVtcExhc3QgPSAgY2hpbGRGaXJzdC5faVByZXY7CQoJCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgcGFyZW50cyBsYXN0IGlzIHVwZGF0ZWQgdG9vCgkJCXZhciB1cGRhdGVMYXN0ID0gdGhpczsKCQkJd2hpbGUodXBkYXRlTGFzdC5sYXN0ID09IGNoaWxkTGFzdC5sYXN0KQoJCQl7CgkJCQl1cGRhdGVMYXN0Lmxhc3QgPSB0ZW1wTGFzdDsKCQkJCXVwZGF0ZUxhc3QgPSB1cGRhdGVMYXN0LnBhcmVudDsKCQkJCWlmKCF1cGRhdGVMYXN0KWJyZWFrOwoJCQl9CgkJfQoJCQoJCWNoaWxkTGFzdC5faU5leHQgPSBudWxsOwoJCWNoaWxkRmlyc3QuX2lQcmV2ID0gbnVsbDsKCQkgCgkJLy8gdXBkYXRlIHRoZSBzdGFnZSByZWZlcmVuY2UuLgoJCWlmKHRoaXMuc3RhZ2UpCgkJewoJCQl2YXIgdG1wQ2hpbGQgPSBjaGlsZDsKCQkJZG8KCQkJewoJCQkJaWYodG1wQ2hpbGQuaW50ZXJhY3RpdmUpdGhpcy5zdGFnZS5kaXJ0eSA9IHRydWU7CgkJCQl0bXBDaGlsZC5zdGFnZSA9IG51bGw7CgkJCQl0bXBDaGlsZCA9IHRtcENoaWxkLl9pTmV4dDsKCQkJfQkKCQkJd2hpbGUodG1wQ2hpbGQpCgkJfQoJCgkJLy8gd2ViR0wgdHJpbQoJCWlmKGNoaWxkLl9fcmVuZGVyR3JvdXApCgkJewoJCQljaGlsZC5fX3JlbmRlckdyb3VwLnJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbihjaGlsZCk7CgkJfQoJCQoJCWNoaWxkLnBhcmVudCA9IHVuZGVmaW5lZDsKCQl0aGlzLmNoaWxkcmVuLnNwbGljZSggaW5kZXgsIDEgKTsKCX0KCWVsc2UKCXsKCQl0aHJvdyBuZXcgRXJyb3IoY2hpbGQgKyAiIFRoZSBzdXBwbGllZCBEaXNwbGF5T2JqZWN0IG11c3QgYmUgYSBjaGlsZCBvZiB0aGUgY2FsbGVyICIgKyB0aGlzKTsKCX0KfQoKLyoKICogVXBkYXRlcyB0aGUgY29udGFpbmVyJ3MgY2hpbGRyZW4ncyB0cmFuc2Zvcm0gZm9yIHJlbmRlcmluZwogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKCWlmKCF0aGlzLnZpc2libGUpcmV0dXJuOwoJCglQSVhJLkRpc3BsYXlPYmplY3QucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKCB0aGlzICk7CgkKCWZvcih2YXIgaT0wLGo9dGhpcy5jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCXRoaXMuY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CQoJfQp9Ci8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLmJsZW5kTW9kZXMgPSB7fTsKUElYSS5ibGVuZE1vZGVzLk5PUk1BTCA9IDA7ClBJWEkuYmxlbmRNb2Rlcy5TQ1JFRU4gPSAxOwoKCi8qKgogKiBUaGUgU1ByaXRlIG9iamVjdCBpcyB0aGUgYmFzZSBmb3IgYWxsIHRleHR1cmVkIG9iamVjdHMgdGhhdCBhcmUgcmVuZGVyZWQgdG8gdGhlIHNjcmVlbgogKgogKiBAY2xhc3MgU3ByaXRlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgdGV4dHVyZSBmb3IgdGhpcyBzcHJpdGUKICogQHR5cGUgU3RyaW5nCiAqLwpQSVhJLlNwcml0ZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKCVBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7CgoJLyoqCgkgKiBUaGUgYW5jaG9yIHNldHMgdGhlIG9yaWdpbiBwb2ludCBvZiB0aGUgdGV4dHVyZS4KCSAqIFRoZSBkZWZhdWx0IGlzIDAsMCB0aGlzIG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgdGhlIHRvcCBsZWZ0IAoJICogU2V0dGluZyB0aGFuIGFuY2hvciB0byAwLjUsMC41IG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgY2VudGVyZWQKCSAqIFNldHRpbmcgdGhlIGFuY2hvciB0byAxLDEgd291bGQgbWVhbiB0aGUgdGV4dHVyZXMgb3JpZ2luIHBvaW50cyB3aWxsIGJlIHRoZSBib3R0b20gcmlnaHQKCSAqCiAgICAgKiBAcHJvcGVydHkgYW5jaG9yCiAgICAgKiBAdHlwZSBQb2ludAogICAgICovCgl0aGlzLmFuY2hvciA9IG5ldyBQSVhJLlBvaW50KCk7CgoJLyoqCgkgKiBUaGUgdGV4dHVyZSB0aGF0IHRoZSBzcHJpdGUgaXMgdXNpbmcKCSAqCgkgKiBAcHJvcGVydHkgdGV4dHVyZQoJICogQHR5cGUgVGV4dHVyZQoJICovCgl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoKCS8qKgoJICogVGhlIGJsZW5kIG1vZGUgb2Ygc3ByaXRlLgoJICogY3VycmVudGx5IHN1cHBvcnRzIFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUwgYW5kIFBJWEkuYmxlbmRNb2Rlcy5TQ1JFRU4KCSAqCgkgKiBAcHJvcGVydHkgYmxlbmRNb2RlCgkgKiBAdHlwZSBOdW1iZXIKCSAqLwoJdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwoKCS8qKgoJICogVGhlIHdpZHRoIG9mIHRoZSBzcHJpdGUgKHRoaXMgaXMgaW5pdGlhbGx5IHNldCBieSB0aGUgdGV4dHVyZSkKCSAqCgkgKiBAcHJvcGVydHkgX3dpZHRoCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMuX3dpZHRoID0gMDsKCgkvKioKCSAqIFRoZSBoZWlnaHQgb2YgdGhlIHNwcml0ZSAodGhpcyBpcyBpbml0aWFsbHkgc2V0IGJ5IHRoZSB0ZXh0dXJlKQoJICoKCSAqIEBwcm9wZXJ0eSBfaGVpZ2h0CgkgKiBAdHlwZSBOdW1iZXIKCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMuX2hlaWdodCA9IDA7CgoJaWYodGV4dHVyZS5iYXNlVGV4dHVyZS5oYXNMb2FkZWQpCgl7CgkJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cgl9CgllbHNlCgl7CgkJdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kID0gdGhpcy5vblRleHR1cmVVcGRhdGUuYmluZCh0aGlzKTsKCQl0aGlzLnRleHR1cmUuYWRkRXZlbnRMaXN0ZW5lciggJ3VwZGF0ZScsIHRoaXMub25UZXh0dXJlVXBkYXRlQmluZCApOwoJfQoKCXRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuU3ByaXRlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUgKTsKUElYSS5TcHJpdGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TcHJpdGU7CgovKioKICogVGhlIHdpZHRoIG9mIHRoZSBzcHJpdGUsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgc2V0CiAqCiAqIEBwcm9wZXJ0eSB3aWR0aAogKiBAdHlwZSBOdW1iZXIKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlNwcml0ZS5wcm90b3R5cGUsICd3aWR0aCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUueCAqIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5zY2FsZS54ID0gdmFsdWUgLyB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGgKICAgICAgICB0aGlzLl93aWR0aCA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBUaGUgaGVpZ2h0IG9mIHRoZSBzcHJpdGUsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgc2V0CiAqCiAqIEBwcm9wZXJ0eSBoZWlnaHQKICogQHR5cGUgTnVtYmVyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5TcHJpdGUucHJvdG90eXBlLCAnaGVpZ2h0JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gIHRoaXMuc2NhbGUueSAqIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuc2NhbGUueSA9IHZhbHVlIC8gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodAogICAgICAgIHRoaXMuX2hlaWdodCA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBTZXRzIHRoZSB0ZXh0dXJlIG9mIHRoZSBzcHJpdGUKICoKICogQG1ldGhvZCBzZXRUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgUElYSSB0ZXh0dXJlIHRoYXQgaXMgZGlzcGxheWVkIGJ5IHRoZSBzcHJpdGUKICovClBJWEkuU3ByaXRlLnByb3RvdHlwZS5zZXRUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewoJLy8gc3RvcCBjdXJyZW50IHRleHR1cmU7CglpZih0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUgIT0gdGV4dHVyZS5iYXNlVGV4dHVyZSkKCXsKCQl0aGlzLnRleHR1cmVDaGFuZ2UgPSB0cnVlOwkKCQl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoJCQoJCWlmKHRoaXMuX19yZW5kZXJHcm91cCkKCQl7CgkJCXRoaXMuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKHRoaXMpOwoJCX0KCX0KCWVsc2UKCXsKCQl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoJfQoJCgl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfQoKLyoqCiAqIFdoZW4gdGhlIHRleHR1cmUgaXMgdXBkYXRlZCwgdGhpcyBldmVudCB3aWxsIGZpcmUgdG8gdXBkYXRlIHRoZSBzY2FsZSBhbmQgZnJhbWUKICoKICogQG1ldGhvZCBvblRleHR1cmVVcGRhdGUKICogQHBhcmFtIGV2ZW50CiAqIEBwcml2YXRlCiAqLwpQSVhJLlNwcml0ZS5wcm90b3R5cGUub25UZXh0dXJlVXBkYXRlID0gZnVuY3Rpb24oZXZlbnQpCnsKCS8vdGhpcy50ZXh0dXJlLnJlbW92ZUV2ZW50TGlzdGVuZXIoICd1cGRhdGUnLCB0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgKTsKCQoJLy8gc28gaWYgX3dpZHRoIGlzIDAgdGhlbiB3aWR0aCB3YXMgbm90IHNldC4uCglpZih0aGlzLl93aWR0aCl0aGlzLnNjYWxlLnggPSB0aGlzLl93aWR0aCAvIHRoaXMudGV4dHVyZS5mcmFtZS53aWR0aDsKCWlmKHRoaXMuX2hlaWdodCl0aGlzLnNjYWxlLnkgPSB0aGlzLl9oZWlnaHQgLyB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoJCgl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfQoKLy8gc29tZSBoZWxwZXIgZnVuY3Rpb25zLi4KCi8qKgogKiAKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgY3JlYXRlcyBhIHNwcml0ZSB0aGF0IHdpbGwgY29udGFpbiBhIHRleHR1cmUgZnJvbSB0aGUgVGV4dHVyZUNhY2hlIGJhc2VkIG9uIHRoZSBmcmFtZUlkCiAqIFRoZSBmcmFtZSBpZHMgYXJlIGNyZWF0ZWQgd2hlbiBhIFRleHR1cmUgcGFja2VyIGZpbGUgaGFzIGJlZW4gbG9hZGVkCiAqCiAqIEBtZXRob2QgZnJvbUZyYW1lCiAqIEBzdGF0aWMKICogQHBhcmFtIGZyYW1lSWQge1N0cmluZ30gVGhlIGZyYW1lIElkIG9mIHRoZSB0ZXh0dXJlIGluIHRoZSBjYWNoZQogKiBAcmV0dXJuIHtTcHJpdGV9IEEgbmV3IFNwcml0ZSB1c2luZyBhIHRleHR1cmUgZnJvbSB0aGUgdGV4dHVyZSBjYWNoZSBtYXRjaGluZyB0aGUgZnJhbWVJZAogKi8KUElYSS5TcHJpdGUuZnJvbUZyYW1lID0gZnVuY3Rpb24oZnJhbWVJZCkKewoJdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtmcmFtZUlkXTsKCWlmKCF0ZXh0dXJlKXRocm93IG5ldyBFcnJvcigiVGhlIGZyYW1lSWQgJyIrIGZyYW1lSWQgKyInIGRvZXMgbm90IGV4aXN0IGluIHRoZSB0ZXh0dXJlIGNhY2hlIiArIHRoaXMpOwoJcmV0dXJuIG5ldyBQSVhJLlNwcml0ZSh0ZXh0dXJlKTsKfQoKLyoqCiAqIAogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCBjcmVhdGVzIGEgc3ByaXRlIHRoYXQgd2lsbCBjb250YWluIGEgdGV4dHVyZSBiYXNlZCBvbiBhbiBpbWFnZSB1cmwKICogSWYgdGhlIGltYWdlIGlzIG5vdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSBpdCB3aWxsIGJlIGxvYWRlZAogKgogKiBAbWV0aG9kIGZyb21JbWFnZQogKiBAc3RhdGljCiAqIEBwYXJhbSBpbWFnZUlkIHtTdHJpbmd9IFRoZSBpbWFnZSB1cmwgb2YgdGhlIHRleHR1cmUKICogQHJldHVybiB7U3ByaXRlfSBBIG5ldyBTcHJpdGUgdXNpbmcgYSB0ZXh0dXJlIGZyb20gdGhlIHRleHR1cmUgY2FjaGUgbWF0Y2hpbmcgdGhlIGltYWdlIGlkCiAqLwpQSVhJLlNwcml0ZS5mcm9tSW1hZ2UgPSBmdW5jdGlvbihpbWFnZUlkKQp7Cgl2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZS5mcm9tSW1hZ2UoaW1hZ2VJZCk7CglyZXR1cm4gbmV3IFBJWEkuU3ByaXRlKHRleHR1cmUpOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgU3RhZ2UgcmVwcmVzZW50cyB0aGUgcm9vdCBvZiB0aGUgZGlzcGxheSB0cmVlLiBFdmVyeXRoaW5nIGNvbm5lY3RlZCB0byB0aGUgc3RhZ2UgaXMgcmVuZGVyZWQKICoKICogQGNsYXNzIFN0YWdlCiAqIEBleHRlbmRzIERpc3BsYXlPYmplY3RDb250YWluZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBiYWNrZ3JvdW5kQ29sb3Ige051bWJlcn0gdGhlIGJhY2tncm91bmQgY29sb3Igb2YgdGhlIHN0YWdlLCBlYXNpZXN0IHdheSB0byBwYXNzIHRoaXMgaW4gaXMgaW4gaGV4IGZvcm1hdAogKgkJbGlrZTogMHhGRkZGRkYgZm9yIHdoaXRlCiAqLwpQSVhJLlN0YWdlID0gZnVuY3Rpb24oYmFja2dyb3VuZENvbG9yKQp7CglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIuY2FsbCggdGhpcyApOwoKCS8qKgoJICogW3JlYWQtb25seV0gQ3VycmVudCB0cmFuc2Zvcm0gb2YgdGhlIG9iamVjdCBiYXNlZCBvbiB3b3JsZCAocGFyZW50KSBmYWN0b3JzCgkgKgoJICogQHByb3BlcnR5IHdvcmxkVHJhbnNmb3JtCgkgKiBAdHlwZSBNYXQzCgkgKiBAcmVhZE9ubHkKCSAqIEBwcml2YXRlCgkgKi8KCXRoaXMud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgoJLyoqCgkgKiBXaGV0aGVyIG9yIG5vdCB0aGUgc3RhZ2UgaXMgaW50ZXJhY3RpdmUKCSAqCgkgKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKCSAqIEB0eXBlIEJvb2xlYW4KCSAqLwoJdGhpcy5pbnRlcmFjdGl2ZSA9IHRydWU7CgoJLyoqCgkgKiBUaGUgaW50ZXJhY3Rpb24gbWFuYWdlIGZvciB0aGlzIHN0YWdlLCBtYW5hZ2VzIGFsbCBpbnRlcmFjdGl2ZSBhY3Rpdml0eSBvbiB0aGUgc3RhZ2UKCSAqCgkgKiBAcHJvcGVydHkgaW50ZXJhY3RpdmUKCSAqIEB0eXBlIEludGVyYWN0aW9uTWFuYWdlcgoJICovCgl0aGlzLmludGVyYWN0aW9uTWFuYWdlciA9IG5ldyBQSVhJLkludGVyYWN0aW9uTWFuYWdlcih0aGlzKTsKCgkvKioKCSAqIFdoZXRoZXIgdGhlIHN0YWdlIGlzIGRpcnR5IGFuZCBuZWVkcyB0byBoYXZlIGludGVyYWN0aW9ucyB1cGRhdGVkCgkgKgoJICogQHByb3BlcnR5IGRpcnR5CgkgKiBAdHlwZSBCb29sZWFuCgkgKiBAcHJpdmF0ZQoJICovCgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCgl0aGlzLl9fY2hpbGRyZW5BZGRlZCA9IFtdOwoJdGhpcy5fX2NoaWxkcmVuUmVtb3ZlZCA9IFtdOwoKCS8vdGhlIHN0YWdlIGlzIGl0J3Mgb3duIHN0YWdlCgl0aGlzLnN0YWdlID0gdGhpczsKCgkvL29wdGltaXplIGhpdCBkZXRlY3Rpb24gYSBiaXQKCXRoaXMuc3RhZ2UuaGl0QXJlYSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMTAwMDAwLCAxMDAwMDApOwoKCXRoaXMuc2V0QmFja2dyb3VuZENvbG9yKGJhY2tncm91bmRDb2xvcik7Cgl0aGlzLndvcmxkVmlzaWJsZSA9IHRydWU7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuU3RhZ2UucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLnByb3RvdHlwZSApOwpQSVhJLlN0YWdlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuU3RhZ2U7CgovKioKICogU2V0cyBhbm90aGVyIERPTSBlbGVtZW50IHdoaWNoIGNhbiByZWNlaXZlIG1vdXNlL3RvdWNoIGludGVyYWN0aW9ucyBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IENhbnZhcyBlbGVtZW50LgogKiBUaGlzIGlzIHVzZWZ1bCBmb3Igd2hlbiB5b3UgaGF2ZSBvdGhlciBET00gZWxlbWVudHMgb250b3Agb2YgdGhlIENhbnZhcyBlbGVtZW50LgogKgogKiBAbWV0aG9kIHNldEludGVyYWN0aW9uRGVsZWdhdGUKICogQHBhcmFtIGRvbUVsZW1lbnQge0RPTUVsZW1lbnR9IFRoaXMgbmV3IGRvbUVsZW1lbnQgd2hpY2ggd2lsbCByZWNlaXZlIG1vdXNlL3RvdWNoIGV2ZW50cwogKi8KUElYSS5TdGFnZS5wcm90b3R5cGUuc2V0SW50ZXJhY3Rpb25EZWxlZ2F0ZSA9IGZ1bmN0aW9uKGRvbUVsZW1lbnQpCnsKCXRoaXMuaW50ZXJhY3Rpb25NYW5hZ2VyLnNldFRhcmdldERvbUVsZW1lbnQoIGRvbUVsZW1lbnQgKTsKfQoKLyoKICogVXBkYXRlcyB0aGUgb2JqZWN0IHRyYW5zZm9ybSBmb3IgcmVuZGVyaW5nCiAqCiAqIEBtZXRob2QgdXBkYXRlVHJhbnNmb3JtCiAqIEBwcml2YXRlCiAqLwpQSVhJLlN0YWdlLnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKCXRoaXMud29ybGRBbHBoYSA9IDE7CQkKCXRoaXMudmNvdW50ID0gUElYSS52aXNpYmxlQ291bnQ7CgkKCWZvcih2YXIgaT0wLGo9dGhpcy5jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCXRoaXMuY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CQoJfQoJCglpZih0aGlzLmRpcnR5KQoJewoJCXRoaXMuZGlydHkgPSBmYWxzZTsKCQkvLyB1cGRhdGUgaW50ZXJhY3RpdmUhCgkJdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIuZGlydHkgPSB0cnVlOwoJfQoJCgkKCWlmKHRoaXMuaW50ZXJhY3RpdmUpdGhpcy5pbnRlcmFjdGlvbk1hbmFnZXIudXBkYXRlKCk7Cn0KCi8qKgogKiBTZXRzIHRoZSBiYWNrZ3JvdW5kIGNvbG9yIGZvciB0aGUgc3RhZ2UKICoKICogQG1ldGhvZCBzZXRCYWNrZ3JvdW5kQ29sb3IKICogQHBhcmFtIGJhY2tncm91bmRDb2xvciB7TnVtYmVyfSB0aGUgY29sb3Igb2YgdGhlIGJhY2tncm91bmQsIGVhc2llc3Qgd2F5IHRvIHBhc3MgdGhpcyBpbiBpcyBpbiBoZXggZm9ybWF0CiAqCQlsaWtlOiAweEZGRkZGRiBmb3Igd2hpdGUKICovClBJWEkuU3RhZ2UucHJvdG90eXBlLnNldEJhY2tncm91bmRDb2xvciA9IGZ1bmN0aW9uKGJhY2tncm91bmRDb2xvcikKewoJdGhpcy5iYWNrZ3JvdW5kQ29sb3IgPSBiYWNrZ3JvdW5kQ29sb3IgfHwgMHgwMDAwMDA7Cgl0aGlzLmJhY2tncm91bmRDb2xvclNwbGl0ID0gSEVYdG9SR0IodGhpcy5iYWNrZ3JvdW5kQ29sb3IpOwoJdmFyIGhleCA9IHRoaXMuYmFja2dyb3VuZENvbG9yLnRvU3RyaW5nKDE2KTsKCWhleCA9ICIwMDAwMDAiLnN1YnN0cigwLCA2IC0gaGV4Lmxlbmd0aCkgKyBoZXg7Cgl0aGlzLmJhY2tncm91bmRDb2xvclN0cmluZyA9ICIjIiArIGhleDsKfQoKLyoqCiAqIFRoaXMgd2lsbCByZXR1cm4gdGhlIHBvaW50IGNvbnRhaW5pbmcgZ2xvYmFsIGNvb3JkcyBvZiB0aGUgbW91c2UuCiAqCiAqIEBtZXRob2QgZ2V0TW91c2VQb3NpdGlvbgogKiBAcmV0dXJuIHtQb2ludH0gVGhlIHBvaW50IGNvbnRhaW5pbmcgdGhlIGNvb3JkcyBvZiB0aGUgZ2xvYmFsIEludGVyYWN0aW9uRGF0YSBwb3NpdGlvbi4KICovClBJWEkuU3RhZ2UucHJvdG90eXBlLmdldE1vdXNlUG9zaXRpb24gPSBmdW5jdGlvbigpCnsKCXJldHVybiB0aGlzLmludGVyYWN0aW9uTWFuYWdlci5tb3VzZS5nbG9iYWw7Cn0KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIFRoaXMgb2JqZWN0IGlzIG9uZSB0aGF0IHdpbGwgYWxsb3cgeW91IHRvIHNwZWNpZnkgY3VzdG9tIHJlbmRlcmluZyBmdW5jdGlvbnMgYmFzZWQgb24gcmVuZGVyIHR5cGUKICoKICogQGNsYXNzIEN1c3RvbVJlbmRlcmFibGUKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdAogKiBAY29uc3RydWN0b3IKICovClBJWEkuQ3VzdG9tUmVuZGVyYWJsZSA9IGZ1bmN0aW9uKCkKewoJUElYSS5EaXNwbGF5T2JqZWN0LmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRGlzcGxheU9iamVjdC5wcm90b3R5cGUgKTsKUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQ3VzdG9tUmVuZGVyYWJsZTsKCi8qKgogKiBJZiB0aGlzIG9iamVjdCBpcyBiZWluZyByZW5kZXJlZCBieSBhIENhbnZhc1JlbmRlcmVyIGl0IHdpbGwgY2FsbCB0aGlzIGNhbGxiYWNrCiAqCiAqIEBtZXRob2QgcmVuZGVyQ2FudmFzCiAqIEBwYXJhbSByZW5kZXJlciB7Q2FudmFzUmVuZGVyZXJ9IFRoZSByZW5kZXJlciBpbnN0YW5jZQogKi8KUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5yZW5kZXJDYW52YXMgPSBmdW5jdGlvbihyZW5kZXJlcikKewoJLy8gb3ZlcnJpZGUhCn0KCi8qKgogKiBJZiB0aGlzIG9iamVjdCBpcyBiZWluZyByZW5kZXJlZCBieSBhIFdlYkdMUmVuZGVyZXIgaXQgd2lsbCBjYWxsIHRoaXMgY2FsbGJhY2sgdG8gaW5pdGlhbGl6ZQogKgogKiBAbWV0aG9kIGluaXRXZWJHTAogKiBAcGFyYW0gcmVuZGVyZXIge1dlYkdMUmVuZGVyZXJ9IFRoZSByZW5kZXJlciBpbnN0YW5jZQogKi8KUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5pbml0V2ViR0wgPSBmdW5jdGlvbihyZW5kZXJlcikKewoJLy8gb3ZlcnJpZGUhCn0KCi8qKgogKiBJZiB0aGlzIG9iamVjdCBpcyBiZWluZyByZW5kZXJlZCBieSBhIFdlYkdMUmVuZGVyZXIgaXQgd2lsbCBjYWxsIHRoaXMgY2FsbGJhY2sKICoKICogQG1ldGhvZCByZW5kZXJXZWJHTAogKiBAcGFyYW0gcmVuZGVyZXIge1dlYkdMUmVuZGVyZXJ9IFRoZSByZW5kZXJlciBpbnN0YW5jZQogKi8KUElYSS5DdXN0b21SZW5kZXJhYmxlLnByb3RvdHlwZS5yZW5kZXJXZWJHTCA9IGZ1bmN0aW9uKHJlbmRlckdyb3VwLCBwcm9qZWN0aW9uTWF0cml4KQp7CgkvLyBub3Qgc3VyZSBpZiBib3RoIG5lZWRlZD8gYnV0IHlhIGhhdmUgZm9yIG5vdyEKCS8vIG92ZXJyaWRlIQp9CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8KICovCgpQSVhJLlN0cmlwID0gZnVuY3Rpb24odGV4dHVyZSwgd2lkdGgsIGhlaWdodCkKewoJUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwoIHRoaXMgKTsKCXRoaXMudGV4dHVyZSA9IHRleHR1cmU7Cgl0aGlzLmJsZW5kTW9kZSA9IFBJWEkuYmxlbmRNb2Rlcy5OT1JNQUw7CgoJdHJ5Cgl7CgkJdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAxLAoJCQkJMSwgMSwKCQkJCTEsIDAsIDAsMV0pOwoKCQl0aGlzLnZlcnRpY2llcyA9IG5ldyBGbG9hdDMyQXJyYXkoWzAsIDAsCgkJCQkJCSAgMCwwLAoJCQkJCQkgIDAsMCwgMCwKCQkJCQkJICAwLCAwXSk7CgoJCXRoaXMuY29sb3JzID0gbmV3IEZsb2F0MzJBcnJheShbMSwgMSwgMSwgMV0pOwoKCQl0aGlzLmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkoWzAsIDEsIDIsIDNdKTsKCX0KCWNhdGNoKGVycm9yKQoJewoJCXRoaXMudXZzID0gWzAsIDEsCgkJCQkxLCAxLAoJCQkJMSwgMCwgMCwxXTsKCgkJdGhpcy52ZXJ0aWNpZXMgPSBbMCwgMCwKCQkJCQkJICAwLDAsCgkJCQkJCSAgMCwwLCAwLAoJCQkJCQkgIDAsIDBdOwoKCQl0aGlzLmNvbG9ycyA9IFsxLCAxLCAxLCAxXTsKCgkJdGhpcy5pbmRpY2VzID0gWzAsIDEsIDIsIDNdOwoJfQoKCgkvKgoJdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KCkKCXRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheSgpCgl0aGlzLmNvbG9ycyA9IG5ldyBGbG9hdDMyQXJyYXkoKQoJdGhpcy5pbmRpY2VzID0gbmV3IFVpbnQxNkFycmF5KCkKKi8KCXRoaXMud2lkdGggPSB3aWR0aDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCS8vIGxvYWQgdGhlIHRleHR1cmUhCglpZih0ZXh0dXJlLmJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKCXsKCQl0aGlzLndpZHRoICAgPSB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGg7CgkJdGhpcy5oZWlnaHQgID0gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCQl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCX0KCWVsc2UKCXsKCQl0aGlzLm9uVGV4dHVyZVVwZGF0ZUJpbmQgPSB0aGlzLm9uVGV4dHVyZVVwZGF0ZS5iaW5kKHRoaXMpOwoJCXRoaXMudGV4dHVyZS5hZGRFdmVudExpc3RlbmVyKCAndXBkYXRlJywgdGhpcy5vblRleHR1cmVVcGRhdGVCaW5kICk7Cgl9CgoJdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5TdHJpcC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuU3RyaXAucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TdHJpcDsKClBJWEkuU3RyaXAucHJvdG90eXBlLnNldFRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CgkvL1RPRE8gU0VUIFRIRSBURVhUVVJFUwoJLy9UT0RPIFZJU0lCSUxJVFkKCgkvLyBzdG9wIGN1cnJlbnQgdGV4dHVyZQoJdGhpcy50ZXh0dXJlID0gdGV4dHVyZTsKCXRoaXMud2lkdGggICA9IHRleHR1cmUuZnJhbWUud2lkdGg7Cgl0aGlzLmhlaWdodCAgPSB0ZXh0dXJlLmZyYW1lLmhlaWdodDsKCXRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwp9CgpQSVhJLlN0cmlwLnByb3RvdHlwZS5vblRleHR1cmVVcGRhdGUgPSBmdW5jdGlvbihldmVudCkKewoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KLy8gc29tZSBoZWxwZXIgZnVuY3Rpb25zLi4KCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLwogKi8KCgpQSVhJLlJvcGUgPSBmdW5jdGlvbih0ZXh0dXJlLCBwb2ludHMpCnsKCVBJWEkuU3RyaXAuY2FsbCggdGhpcywgdGV4dHVyZSApOwoJdGhpcy5wb2ludHMgPSBwb2ludHM7CgoJdHJ5Cgl7CgkJdGhpcy52ZXJ0aWNpZXMgPSBuZXcgRmxvYXQzMkFycmF5KCBwb2ludHMubGVuZ3RoICogNCk7CgkJdGhpcy51dnMgPSBuZXcgRmxvYXQzMkFycmF5KCBwb2ludHMubGVuZ3RoICogNCk7CgkJdGhpcy5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KCAgcG9pbnRzLmxlbmd0aCAqIDIpOwoJCXRoaXMuaW5kaWNlcyA9IG5ldyBVaW50MTZBcnJheSggcG9pbnRzLmxlbmd0aCAqIDIpOwoJfQoJY2F0Y2goZXJyb3IpCgl7CgkJdGhpcy52ZXJ0aWNpZXMgPSB2ZXJ0aWNpZXMKCgkJdGhpcy51dnMgPSB1dnMKCQl0aGlzLmNvbG9ycyA9IGNvbG9ycwoJCXRoaXMuaW5kaWNlcyA9IGluZGljZXMKCX0KCgl0aGlzLnJlZnJlc2goKTsKfQoKCi8vIGNvbnN0cnVjdG9yClBJWEkuUm9wZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLlN0cmlwLnByb3RvdHlwZSApOwpQSVhJLlJvcGUucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5Sb3BlOwoKUElYSS5Sb3BlLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKQp7Cgl2YXIgcG9pbnRzID0gdGhpcy5wb2ludHM7CglpZihwb2ludHMubGVuZ3RoIDwgMSlyZXR1cm47CgoJdmFyIHV2cyA9IHRoaXMudXZzCgl2YXIgaW5kaWNlcyA9IHRoaXMuaW5kaWNlczsKCXZhciBjb2xvcnMgPSB0aGlzLmNvbG9yczsKCgl2YXIgbGFzdFBvaW50ID0gcG9pbnRzWzBdOwoJdmFyIG5leHRQb2ludDsKCXZhciBwZXJwID0ge3g6MCwgeTowfTsKCXZhciBwb2ludCA9IHBvaW50c1swXTsKCgl0aGlzLmNvdW50LT0wLjI7CgoKCXV2c1swXSA9IDAKCXV2c1sxXSA9IDEKCXV2c1syXSA9IDAKCXV2c1szXSA9IDEKCgljb2xvcnNbMF0gPSAxOwoJY29sb3JzWzFdID0gMTsKCglpbmRpY2VzWzBdID0gMDsKCWluZGljZXNbMV0gPSAxOwoKCXZhciB0b3RhbCA9IHBvaW50cy5sZW5ndGg7CgoJZm9yICh2YXIgaSA9ICAxOyBpIDwgdG90YWw7IGkrKykKCXsKCgkJdmFyIHBvaW50ID0gcG9pbnRzW2ldOwoJCXZhciBpbmRleCA9IGkgKiA0OwoJCS8vIHRpbWUgdG8gZG8gc29tZSBzbWFydCBkcmF3aW5nIQoJCXZhciBhbW91bnQgPSBpLyh0b3RhbC0xKQoKCQlpZihpJTIpCgkJewoJCQl1dnNbaW5kZXhdID0gYW1vdW50OwoJCQl1dnNbaW5kZXgrMV0gPSAwOwoKCQkJdXZzW2luZGV4KzJdID0gYW1vdW50CgkJCXV2c1tpbmRleCszXSA9IDEKCgkJfQoJCWVsc2UKCQl7CgkJCXV2c1tpbmRleF0gPSBhbW91bnQKCQkJdXZzW2luZGV4KzFdID0gMAoKCQkJdXZzW2luZGV4KzJdID0gYW1vdW50CgkJCXV2c1tpbmRleCszXSA9IDEKCQl9CgoJCWluZGV4ID0gaSAqIDI7CgkJY29sb3JzW2luZGV4XSA9IDE7CgkJY29sb3JzW2luZGV4KzFdID0gMTsKCgkJaW5kZXggPSBpICogMjsKCQlpbmRpY2VzW2luZGV4XSA9IGluZGV4OwoJCWluZGljZXNbaW5kZXggKyAxXSA9IGluZGV4ICsgMTsKCgkJbGFzdFBvaW50ID0gcG9pbnQ7Cgl9Cn0KClBJWEkuUm9wZS5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CgoJdmFyIHBvaW50cyA9IHRoaXMucG9pbnRzOwoJaWYocG9pbnRzLmxlbmd0aCA8IDEpcmV0dXJuOwoKCXZhciB2ZXJ0aWNpZXMgPSB0aGlzLnZlcnRpY2llcwoKCXZhciBsYXN0UG9pbnQgPSBwb2ludHNbMF07Cgl2YXIgbmV4dFBvaW50OwoJdmFyIHBlcnAgPSB7eDowLCB5OjB9OwoJdmFyIHBvaW50ID0gcG9pbnRzWzBdOwoKCXRoaXMuY291bnQtPTAuMjsKCgl2ZXJ0aWNpZXNbMF0gPSBwb2ludC54ICsgcGVycC54Cgl2ZXJ0aWNpZXNbMV0gPSBwb2ludC55ICsgcGVycC55IC8vKyAyMDAKCXZlcnRpY2llc1syXSA9IHBvaW50LnggLSBwZXJwLngKCXZlcnRpY2llc1szXSA9IHBvaW50LnkgLSBwZXJwLnkvLysyMDAKCS8vIHRpbWUgdG8gZG8gc29tZSBzbWFydCBkcmF3aW5nIQoKCXZhciB0b3RhbCA9IHBvaW50cy5sZW5ndGg7CgoJZm9yICh2YXIgaSA9ICAxOyBpIDwgdG90YWw7IGkrKykKCXsKCgkJdmFyIHBvaW50ID0gcG9pbnRzW2ldOwoJCXZhciBpbmRleCA9IGkgKiA0OwoKCQlpZihpIDwgcG9pbnRzLmxlbmd0aC0xKQoJCXsKCQkJbmV4dFBvaW50ID0gcG9pbnRzW2krMV07CgkJfQoJCWVsc2UKCQl7CgkJCW5leHRQb2ludCA9IHBvaW50CgkJfQoKCQlwZXJwLnkgPSAtKG5leHRQb2ludC54IC0gbGFzdFBvaW50LngpOwoJCXBlcnAueCA9IG5leHRQb2ludC55IC0gbGFzdFBvaW50Lnk7CgoJCXZhciByYXRpbyA9ICgxIC0gKGkgLyAodG90YWwtMSkpKSAqIDEwOwoJCQkJaWYocmF0aW8gPiAxKXJhdGlvID0gMTsKCgkJdmFyIHBlcnBMZW5ndGggPSBNYXRoLnNxcnQocGVycC54ICogcGVycC54ICsgcGVycC55ICogcGVycC55KTsKCQl2YXIgbnVtID0gdGhpcy50ZXh0dXJlLmhlaWdodC8yLy8oMjAgKyBNYXRoLmFicyhNYXRoLnNpbigoaSArIHRoaXMuY291bnQpICogMC4zKSAqIDUwKSApKiByYXRpbzsKCQlwZXJwLnggLz0gcGVycExlbmd0aDsKCQlwZXJwLnkgLz0gcGVycExlbmd0aDsKCgkJcGVycC54ICo9IG51bTsKCQlwZXJwLnkgKj0gbnVtOwoKCQl2ZXJ0aWNpZXNbaW5kZXhdID0gcG9pbnQueCArIHBlcnAueAoJCXZlcnRpY2llc1tpbmRleCsxXSA9IHBvaW50LnkgKyBwZXJwLnkKCQl2ZXJ0aWNpZXNbaW5kZXgrMl0gPSBwb2ludC54IC0gcGVycC54CgkJdmVydGljaWVzW2luZGV4KzNdID0gcG9pbnQueSAtIHBlcnAueQoKCQlsYXN0UG9pbnQgPSBwb2ludDsKCX0KCglQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlLnVwZGF0ZVRyYW5zZm9ybS5jYWxsKCB0aGlzICk7Cn0KClBJWEkuUm9wZS5wcm90b3R5cGUuc2V0VGV4dHVyZSA9IGZ1bmN0aW9uKHRleHR1cmUpCnsKCS8vIHN0b3AgY3VycmVudCB0ZXh0dXJlCgl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KCgoKCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLwogKi8KCi8qKgogKiBBIHRpbGluZyBzcHJpdGUgaXMgYSBmYXN0IHdheSBvZiByZW5kZXJpbmcgYSB0aWxpbmcgaW1hZ2UKICoKICogQGNsYXNzIFRpbGluZ1Nwcml0ZQogKiBAZXh0ZW5kcyBEaXNwbGF5T2JqZWN0Q29udGFpbmVyCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gdGhlIHRleHR1cmUgb2YgdGhlIHRpbGluZyBzcHJpdGUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9ICB0aGUgd2lkdGggb2YgdGhlIHRpbGluZyBzcHJpdGUKICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSB0aGUgaGVpZ2h0IG9mIHRoZSB0aWxpbmcgc3ByaXRlCiAqLwpQSVhJLlRpbGluZ1Nwcml0ZSA9IGZ1bmN0aW9uKHRleHR1cmUsIHdpZHRoLCBoZWlnaHQpCnsKCVBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7CgoJLyoqCgkgKiBUaGUgdGV4dHVyZSB0aGF0IHRoZSBzcHJpdGUgaXMgdXNpbmcKCSAqCgkgKiBAcHJvcGVydHkgdGV4dHVyZQoJICogQHR5cGUgVGV4dHVyZQoJICovCgl0aGlzLnRleHR1cmUgPSB0ZXh0dXJlOwoKCS8qKgoJICogVGhlIHdpZHRoIG9mIHRoZSB0aWxpbmcgc3ByaXRlCgkgKgoJICogQHByb3BlcnR5IHdpZHRoCgkgKiBAdHlwZSBOdW1iZXIKCSAqLwoJdGhpcy53aWR0aCA9IHdpZHRoOwoKCS8qKgoJICogVGhlIGhlaWdodCBvZiB0aGUgdGlsaW5nIHNwcml0ZQoJICoKCSAqIEBwcm9wZXJ0eSBoZWlnaHQKCSAqIEB0eXBlIE51bWJlcgoJICovCgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkvKioKCSAqIFRoZSBzY2FsaW5nIG9mIHRoZSBpbWFnZSB0aGF0IGlzIGJlaW5nIHRpbGVkCgkgKgoJICogQHByb3BlcnR5IHRpbGVTY2FsZQoJICogQHR5cGUgUG9pbnQKCSAqLwoJdGhpcy50aWxlU2NhbGUgPSBuZXcgUElYSS5Qb2ludCgxLDEpOwoKCS8qKgoJICogVGhlIG9mZnNldCBwb3NpdGlvbiBvZiB0aGUgaW1hZ2UgdGhhdCBpcyBiZWluZyB0aWxlZAoJICoKCSAqIEBwcm9wZXJ0eSB0aWxlUG9zaXRpb24KCSAqIEB0eXBlIFBvaW50CgkgKi8KCXRoaXMudGlsZVBvc2l0aW9uID0gbmV3IFBJWEkuUG9pbnQoMCwwKTsKCgl0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwoKCXRoaXMuYmxlbmRNb2RlID0gUElYSS5ibGVuZE1vZGVzLk5PUk1BTAp9CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlRpbGluZ1Nwcml0ZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVGlsaW5nU3ByaXRlOwoKLyoqCiAqIFNldHMgdGhlIHRleHR1cmUgb2YgdGhlIHRpbGluZyBzcHJpdGUKICoKICogQG1ldGhvZCBzZXRUZXh0dXJlCiAqIEBwYXJhbSB0ZXh0dXJlIHtUZXh0dXJlfSBUaGUgUElYSSB0ZXh0dXJlIHRoYXQgaXMgZGlzcGxheWVkIGJ5IHRoZSBzcHJpdGUKICovClBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZS5zZXRUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewoJLy9UT0RPIFNFVCBUSEUgVEVYVFVSRVMKCS8vVE9ETyBWSVNJQklMSVRZCgoJLy8gc3RvcCBjdXJyZW50IHRleHR1cmUKCXRoaXMudGV4dHVyZSA9IHRleHR1cmU7Cgl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKfQoKLyoqCiAqIFdoZW4gdGhlIHRleHR1cmUgaXMgdXBkYXRlZCwgdGhpcyBldmVudCB3aWxsIGZpcmUgdG8gdXBkYXRlIHRoZSBmcmFtZQogKgogKiBAbWV0aG9kIG9uVGV4dHVyZVVwZGF0ZQogKiBAcGFyYW0gZXZlbnQKICogQHByaXZhdGUKICovClBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZS5vblRleHR1cmVVcGRhdGUgPSBmdW5jdGlvbihldmVudCkKewoJdGhpcy51cGRhdGVGcmFtZSA9IHRydWU7Cn0KCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBUaGlzIGlzIHRoZSBiYXNlIGNsYXNzIGZvciAgY3JlYXRpbmcgYSBwaXhpLmpzIGZpbHRlci4gQ3VycmVudGx5IG9ubHkgd2ViR0wgc3VwcG9ydHMgZmlsdGVycy4KICogSWYgeW91IHdhbnQgdG8gbWFrZSBhIGN1c3RvbSBmaWx0ZXIgdGhpcyBzaG91bGQgYmUgeW91ciBiYXNlIGNsYXNzLgogKiBAY2xhc3MgQWJzdHJhY3RGaWx0ZXIKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSBmcmFnbWVudFNyYwogKiBAcGFyYW0gdW5pZm9ybXMgIAogKi8KUElYSS5BYnN0cmFjdEZpbHRlciA9IGZ1bmN0aW9uKGZyYWdtZW50U3JjLCB1bmlmb3JtcykKewoJLyoqCgkqIEFuIGFycmF5IG9mIHBhc3NlcyAtIHNvbWUgZmlsdGVycyBjb250YWluIGEgZmV3IHN0ZXBzIHRoaXMgYXJyYXkgc2ltcGx5IHN0b3JlcyB0aGUgc3RlcHMgaW4gYSBsaW5pZWFyIGZhc2hpb24uCgkqIEZvciBleGFtcGxlIHRoZSBibHVyIGZpbHRlciBoYXMgdHdvIHBhc3NlcyBibHVyWCBhbmQgYmx1clkuCgkqIEBwcm9wZXJ0eSBwYXNzZXMKCSogQHR5cGUgQXJyYXkgYW4gYXJyYXkgb2YgZmlsdGVyIG9iamVjdHMKCSogQHByaXZhdGUKCSovCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCgoJdGhpcy5kaXJ0eSA9IHRydWU7Cgl0aGlzLnBhZGRpbmcgPSAwOwoKCS8qKgoJQHByb3BlcnR5IHVuaWZvcm1zCglAcHJpdmF0ZQoJKi8KCXRoaXMudW5pZm9ybXMgPSB1bmlmb3JtcyB8fCB7fTsKCQoJdGhpcy5mcmFnbWVudFNyYyA9IGZyYWdtZW50U3JjIHx8IFtdOwp9CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogCiAqIFRoZSBCbHVyRmlsdGVyIGFwcGxpZXMgYSBHYXVzc2lhbiBibHVyIHRvIGFuIG9iamVjdC4gCiAqIFRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1ciBjYW4gYmUgc2V0IGZvciB4LSBhbmQgeS1heGlzIHNlcGFyYXRlbHkgKGFsd2F5cyByZWxhdGl2ZSB0byB0aGUgc3RhZ2UpLgogKgogKiBAY2xhc3MgQmx1ckZpbHRlcgogKiBAY29udHJ1Y3RvcgogKi8KUElYSS5CbHVyRmlsdGVyID0gZnVuY3Rpb24oKQp7CiAgICAKCXRoaXMuYmx1clhGaWx0ZXIgPSBuZXcgUElYSS5CbHVyWEZpbHRlcigpOwoJdGhpcy5ibHVyWUZpbHRlciA9IG5ldyBQSVhJLkJsdXJZRmlsdGVyKCk7CgoJdGhpcy5wYXNzZXMgPVt0aGlzLmJsdXJYRmlsdGVyLCB0aGlzLmJsdXJZRmlsdGVyXTsKCQp9CgovKioKICogU2V0cyB0aGUgc3RyZW5ndGggb2YgYm90aCB0aGUgYmx1clggYW5kIGJsdXJZIHByb3BlcnRpZXMgc2ltdWx0YW5lb3VzbHkKICoKICogQHByb3BlcnR5IGJsdXIKICogQHR5cGUgTnVtYmVyIHRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1cgogKiBAZGVmYXVsdCAyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5CbHVyRmlsdGVyLnByb3RvdHlwZSwgJ2JsdXInLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLmJsdXJYRmlsdGVyLmJsdXI7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogIAkJdGhpcy5ibHVyWEZpbHRlci5ibHVyID0gdGhpcy5ibHVyWUZpbHRlci5ibHVyID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgdGhlIHN0cmVuZ3RoIG9mIHRoZSBibHVyWCBwcm9wZXJ0eSBzaW11bHRhbmVvdXNseQogKgogKiBAcHJvcGVydHkgYmx1clgKICogQHR5cGUgTnVtYmVyIHRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1clgKICogQGRlZmF1bHQgMgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuQmx1ckZpbHRlci5wcm90b3R5cGUsICdibHVyWCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYmx1clhGaWx0ZXIuYmx1cjsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5ibHVyWEZpbHRlci5ibHVyID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIFNldHMgdGhlIHN0cmVuZ3RoIG9mIHRoZSBibHVyWCBwcm9wZXJ0eSBzaW11bHRhbmVvdXNseQogKgogKiBAcHJvcGVydHkgYmx1clkKICogQHR5cGUgTnVtYmVyIHRoZSBzdHJlbmd0aCBvZiB0aGUgYmx1clkKICogQGRlZmF1bHQgMgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuQmx1ckZpbHRlci5wcm90b3R5cGUsICdibHVyWScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYmx1cllGaWx0ZXIuYmx1cjsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5ibHVyWUZpbHRlci5ibHVyID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgoKUElYSS5CbHVyWEZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJCgkvLyBzZXQgdGhlIHVuaWZvcm1zCgl0aGlzLnVuaWZvcm1zID0gewoJCWJsdXI6IHt0eXBlOiAnMWYnLCB2YWx1ZTogMS81MTJ9LAoJfTsKCQoJdGhpcy5mcmFnbWVudFNyYyA9IFsKCSAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCgkgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAoJICAidmFyeWluZyBmbG9hdCB2Q29sb3I7IiwKCSAgInVuaWZvcm0gZmxvYXQgYmx1cjsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAgICAidm9pZCBtYWluKHZvaWQpIHsiLAoJICAJInZlYzQgc3VtID0gdmVjNCgwLjApOyIsCgoJICAJInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54IC0gNC4wKmJsdXIsIHZUZXh0dXJlQ29vcmQueSkpICogMC4wNTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCAtIDMuMCpibHVyLCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMDk7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggLSAyLjAqYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjEyOyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54IC0gYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjE1OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMTY7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggKyBibHVyLCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMTU7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLnggKyAyLjAqYmx1ciwgdlRleHR1cmVDb29yZC55KSkgKiAwLjEyOyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54ICsgMy4wKmJsdXIsIHZUZXh0dXJlQ29vcmQueSkpICogMC4wOTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCArIDQuMCpibHVyLCB2VGV4dHVyZUNvb3JkLnkpKSAqIDAuMDU7IiwKCSAKCQkiZ2xfRnJhZ0NvbG9yID0gc3VtOyIsCgoJICAifSIKCV07Cn0KClBJWEkuQmx1clhGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5CbHVyWEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkJsdXJYRmlsdGVyOwoKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkJsdXJYRmlsdGVyLnByb3RvdHlwZSwgJ2JsdXInLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmJsdXIudmFsdWUgLyAoMS83MDAwKTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAKICAgIAl0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLmJsdXIudmFsdWUgPSAoMS83MDAwKSAqIHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuQmx1cllGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlibHVyOiB7dHlwZTogJzFmJywgdmFsdWU6IDEvNTEyfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IGJsdXI7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgCSJ2ZWM0IHN1bSA9IHZlYzQoMC4wKTsiLAoKCSAgCSJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55IC0gNC4wKmJsdXIpKSAqIDAuMDU7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSAtIDMuMCpibHVyKSkgKiAwLjA5OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkgLSAyLjAqYmx1cikpICogMC4xMjsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55IC0gYmx1cikpICogMC4xNTsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55KSkgKiAwLjE2OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkgKyBibHVyKSkgKiAwLjE1OyIsCgkgICAgInN1bSArPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZlYzIodlRleHR1cmVDb29yZC54LCB2VGV4dHVyZUNvb3JkLnkgKyAyLjAqYmx1cikpICogMC4xMjsiLAoJICAgICJzdW0gKz0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCwgdlRleHR1cmVDb29yZC55ICsgMy4wKmJsdXIpKSAqIDAuMDk7IiwKCSAgICAic3VtICs9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSArIDQuMCpibHVyKSkgKiAwLjA1OyIsCgkgCgkJImdsX0ZyYWdDb2xvciA9IHN1bTsiLAoKCSAgIn0iCgldOwp9CgpQSVhJLkJsdXJZRmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuQmx1cllGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5CbHVyWUZpbHRlcjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkJsdXJZRmlsdGVyLnByb3RvdHlwZSwgJ2JsdXInLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmJsdXIudmFsdWUgLyAoMS83MDAwKTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJLy90aGlzLnBhZGRpbmcgPSB2YWx1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLmJsdXIudmFsdWUgPSAoMS83MDAwKSAqIHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogCiAqIFRoZSBDb2xvck1hdHJpeEZpbHRlciBjbGFzcyBsZXRzIHlvdSBhcHBseSBhIDR4NCBtYXRyaXggdHJhbnNmb3JtYXRpb24gb24gdGhlIFJHQkEgCiAqIGNvbG9yIGFuZCBhbHBoYSB2YWx1ZXMgb2YgZXZlcnkgcGl4ZWwgb24geW91ciBkaXNwbGF5T2JqZWN0IHRvIHByb2R1Y2UgYSByZXN1bHQgCiAqIHdpdGggYSBuZXcgc2V0IG9mIFJHQkEgY29sb3IgYW5kIGFscGhhIHZhbHVlcy4gSXRzIHByZXR0eSBwb3dlcmZ1bCEKICogQGNsYXNzIENvbG9yTWF0cml4RmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLkNvbG9yTWF0cml4RmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJbWF0cml4OiB7dHlwZTogJ21hdDQnLCB2YWx1ZTogWzEsMCwwLDAsCgkJCQkJCQkJCSAgIDAsMSwwLDAsCgkJCQkJCQkJCSAgIDAsMCwxLDAsCgkJCQkJCQkJCSAgIDAsMCwwLDFdfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IGludmVydDsiLAoJICAidW5pZm9ybSBtYXQ0IG1hdHJpeDsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkKSAqIG1hdHJpeDsiLAoJICAgICJnbF9GcmFnQ29sb3IgPSBnbF9GcmFnQ29sb3IgKiB2Q29sb3I7IiwKCSAgIn0iCgldOwoJCn0KClBJWEkuQ29sb3JNYXRyaXhGaWx0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZSggUElYSS5BYnN0cmFjdEZpbHRlci5wcm90b3R5cGUgKTsKUElYSS5Db2xvck1hdHJpeEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkNvbG9yTWF0cml4RmlsdGVyOwoKLyoqCiAqIFNldHMgdGhlIG1hdHJpeCBvZiB0aGUgY29sb3IgbWF0cml4IGZpbHRlcgogKgogKiBAcHJvcGVydHkgbWF0cml4CiAqIEB0eXBlIEFycmF5IGFuZCBhcnJheSBvZiAyNiBudW1iZXJzCiAqIEBkZWZhdWx0IFsxLDAsMCwwLDAsMSwwLDAsMCwwLDEsMCwwLDAsMCwxXQogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuQ29sb3JNYXRyaXhGaWx0ZXIucHJvdG90eXBlLCAnbWF0cml4JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5tYXRyaXgudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMudW5pZm9ybXMubWF0cml4LnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCgpQSVhJLkNyb3NzSGF0Y2hGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlibHVyOiB7dHlwZTogJzFmJywgdmFsdWU6IDEvNTEyfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IGJsdXI7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgCQoJICAgIAoJCSIgICAgZmxvYXQgbHVtID0gbGVuZ3RoKHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZC54eSkucmdiKTsiLAoJCSIgICAgICIsCgkJIiAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KDEuMCwgMS4wLCAxLjAsIDEuMCk7IiwKCQkiICAgICAiLAoJCSIgICAgaWYgKGx1bSA8IDEuMDApIHsiLAoJCSIgICAgICAgIGlmIChtb2QoZ2xfRnJhZ0Nvb3JkLnggKyBnbF9GcmFnQ29vcmQueSwgMTAuMCkgPT0gMC4wKSB7IiwKCQkiICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjAsIDAuMCwgMC4wLCAxLjApOyIsCgkJIiAgICAgICAgfSIsCgkJIiAgICB9IiwKCQkiICAgICAiLAoJCSIgICAgaWYgKGx1bSA8IDAuNzUpIHsiLAoJCSIgICAgICAgIGlmIChtb2QoZ2xfRnJhZ0Nvb3JkLnggLSBnbF9GcmFnQ29vcmQueSwgMTAuMCkgPT0gMC4wKSB7IiwKCQkiICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjAsIDAuMCwgMC4wLCAxLjApOyIsCgkJIiAgICAgICAgfSIsCgkJIiAgICB9IiwKCQkiICAgICAiLAoJCSIgICAgaWYgKGx1bSA8IDAuNTApIHsiLAoJCSIgICAgICAgIGlmIChtb2QoZ2xfRnJhZ0Nvb3JkLnggKyBnbF9GcmFnQ29vcmQueSAtIDUuMCwgMTAuMCkgPT0gMC4wKSB7IiwKCQkiICAgICAgICAgICAgZ2xfRnJhZ0NvbG9yID0gdmVjNCgwLjAsIDAuMCwgMC4wLCAxLjApOyIsCgkJIiAgICAgICAgfSIsCgkJIiAgICB9IiwKCQkiICAgICAiLAoJCSIgICAgaWYgKGx1bSA8IDAuMykgeyIsCgkJIiAgICAgICAgaWYgKG1vZChnbF9GcmFnQ29vcmQueCAtIGdsX0ZyYWdDb29yZC55IC0gNS4wLCAxMC4wKSA9PSAwLjApIHsiLAoJCSIgICAgICAgICAgICBnbF9GcmFnQ29sb3IgPSB2ZWM0KDAuMCwgMC4wLCAwLjAsIDEuMCk7IiwKCQkiICAgICAgICB9IiwKCQkiICAgIH0iLAoJCSJ9IgoJXTsKfQoKUElYSS5Dcm9zc0hhdGNoRmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuQ3Jvc3NIYXRjaEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkJsdXJZRmlsdGVyOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuQ3Jvc3NIYXRjaEZpbHRlci5wcm90b3R5cGUsICdibHVyJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlIC8gKDEvNzAwMCk7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCS8vdGhpcy5wYWRkaW5nID0gdmFsdWU7CiAgICAJdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlID0gKDEvNzAwMCkgKiB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiAKICogVGhlIERpc3BsYWNlbWVudEZpbHRlciBjbGFzcyB1c2VzIHRoZSBwaXhlbCB2YWx1ZXMgZnJvbSB0aGUgc3BlY2lmaWVkIHRleHR1cmUgKGNhbGxlZCB0aGUgZGlzcGxhY2VtZW50IG1hcCkgdG8gcGVyZm9ybSBhIGRpc3BsYWNlbWVudCBvZiBhbiBvYmplY3QuIAogKiBZb3UgY2FuIHVzZSB0aGlzIGZpbHRlciB0byBhcHBseSBhbGwgbWFub3Igb2YgY3Jhenkgd2FycGluZyBlZmZlY3RzCiAqIEN1cnJlbnRseSB0aGUgciBwcm9wZXJ0eSBvZiB0aGUgdGV4dHVyZSBpcyB1c2VkIG9mZnNldCB0aGUgeCBhbmQgdGhlIGcgcHJvcGVyeSBvZiB0aGUgdGV4dHVyZSBpcyB1c2VkIHRvIG9mZnNldCB0aGUgeS4KICogQGNsYXNzIERpc3BsYWNlbWVudEZpbHRlcgogKiBAY29udHJ1Y3RvcgogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0gVGhlIHRleHR1cmUgdXNlZCBmb3IgdGhlIGRpc3BsYWNlbXRlbnQgbWFwICogbXVzdCBiZSBwb3dlciBvZiAyIHRleHR1cmUgYXQgdGhlIG1vbWVudAogKi8KUElYSS5EaXNwbGFjZW1lbnRGaWx0ZXIgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107Cgl0ZXh0dXJlLmJhc2VUZXh0dXJlLl9wb3dlck9mMiA9IHRydWU7CgoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJLy9jb25zb2xlLmxvZygpCgl0aGlzLnVuaWZvcm1zID0gewoJCWRpc3BsYWNlbWVudE1hcDoge3R5cGU6ICdzYW1wbGVyMkQnLCB2YWx1ZTp0ZXh0dXJlfSwKCQlzY2FsZToJCQkge3R5cGU6ICcyZicsIHZhbHVlOnt4OjMwLCB5OjMwfX0sCgkJb2Zmc2V0OgkJCSB7dHlwZTogJzJmJywgdmFsdWU6e3g6MCwgeTowfX0sCgkJbWFwRGltZW5zaW9uczogICB7dHlwZTogJzJmJywgdmFsdWU6e3g6MSwgeTo1MTEyfX0sCgkJZGltZW5zaW9uczogICB7dHlwZTogJzRmdicsIHZhbHVlOlswLDAsMCwwXX0KCX07CgkKCglpZih0ZXh0dXJlLmJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKCXsKCQl0aGlzLnVuaWZvcm1zLm1hcERpbWVuc2lvbnMudmFsdWUueCA9IHRleHR1cmUud2lkdGg7CgkJdGhpcy51bmlmb3Jtcy5tYXBEaW1lbnNpb25zLnZhbHVlLnkgPSB0ZXh0dXJlLmhlaWdodDsKCX0KCWVsc2UKCXsKCQl0aGlzLmJvdW5kTG9hZGVkRnVuY3Rpb24gPSB0aGlzLm9uVGV4dHVyZUxvYWRlZC5iaW5kKHRoaXMpOwoKCQl0ZXh0dXJlLmJhc2VUZXh0dXJlLm9uKCJsb2FkZWQiLCB0aGlzLmJvdW5kTG9hZGVkRnVuY3Rpb24pOwoJfQoKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCBkaXNwbGFjZW1lbnRNYXA7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgICJ1bmlmb3JtIHZlYzIgc2NhbGU7IiwKCSAgInVuaWZvcm0gdmVjMiBvZmZzZXQ7IiwKCSAgInVuaWZvcm0gdmVjNCBkaW1lbnNpb25zOyIsCgkgICJ1bmlmb3JtIHZlYzIgbWFwRGltZW5zaW9uczsiLC8vID0gdmVjMigyNTYuMCwgMjU2LjApOyIsCgkgLy8gImNvbnN0IHZlYzIgdGV4dHVyZURpbWVuc2lvbnMgPSB2ZWMyKDc1MC4wLCA3NTAuMCk7IiwKCSAgCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgIAkidmVjMiBtYXBDb3JkcyA9IHZUZXh0dXJlQ29vcmQueHk7IiwKLy8JICAJIm1hcENvcmRzIC09IDsiLAoJIAkibWFwQ29yZHMgKz0gKGRpbWVuc2lvbnMuencgKyBvZmZzZXQpLyBkaW1lbnNpb25zLnh5IDsiLAoJIAkibWFwQ29yZHMueSAqPSAtMS4wOyIsCgkgCSJtYXBDb3Jkcy55ICs9IDEuMDsiLAoJICAJInZlYzIgbWF0U2FtcGxlID0gdGV4dHVyZTJEKGRpc3BsYWNlbWVudE1hcCwgbWFwQ29yZHMpLnh5OyIsCgkJIm1hdFNhbXBsZSAtPSAwLjU7IiwJICAKCSAJIm1hdFNhbXBsZSAqPSBzY2FsZTsiLAoJIAkibWF0U2FtcGxlIC89IG1hcERpbWVuc2lvbnM7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2ZWMyKHZUZXh0dXJlQ29vcmQueCArIG1hdFNhbXBsZS54LCB2VGV4dHVyZUNvb3JkLnkgKyBtYXRTYW1wbGUueSkpOyIsCgkJImdsX0ZyYWdDb2xvci5yZ2IgPSBtaXgoIGdsX0ZyYWdDb2xvci5yZ2IsIGdsX0ZyYWdDb2xvci5yZ2IsIDEuMCk7IiwKCQkidmVjMiBjb3JkID0gdlRleHR1cmVDb29yZDsiLAoJCQoJCS8vImdsX0ZyYWdDb2xvciA9ICB0ZXh0dXJlMkQoZGlzcGxhY2VtZW50TWFwLCBjb3JkKTsiLAoJICAgICJnbF9GcmFnQ29sb3IgPSBnbF9GcmFnQ29sb3IgKiB2Q29sb3I7IiwKCSAgICAKCSAgIn0iCgldOwoJCn0KClBJWEkuRGlzcGxhY2VtZW50RmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuRGlzcGxhY2VtZW50RmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuRGlzcGxhY2VtZW50RmlsdGVyOwoKUElYSS5EaXNwbGFjZW1lbnRGaWx0ZXIucHJvdG90eXBlLm9uVGV4dHVyZUxvYWRlZCA9IGZ1bmN0aW9uKCkKewoJCgl0aGlzLnVuaWZvcm1zLm1hcERpbWVuc2lvbnMudmFsdWUueCA9IHRoaXMudW5pZm9ybXMuZGlzcGxhY2VtZW50TWFwLnZhbHVlLndpZHRoOwoJdGhpcy51bmlmb3Jtcy5tYXBEaW1lbnNpb25zLnZhbHVlLnkgPSB0aGlzLnVuaWZvcm1zLmRpc3BsYWNlbWVudE1hcC52YWx1ZS5oZWlnaHQ7CgoJdGhpcy51bmlmb3Jtcy5kaXNwbGFjZW1lbnRNYXAudmFsdWUuYmFzZVRleHR1cmUub2ZmKCJsb2FkZWQiLCB0aGlzLmJvdW5kTG9hZGVkRnVuY3Rpb24pCgp9CgovKioKICogVGhlIHRleHR1cmUgdXNlZCBmb3IgdGhlIGRpc3BsYWNlbXRlbnQgbWFwICogbXVzdCBiZSBwb3dlciBvZiAyIHRleHR1cmUgYXQgdGhlIG1vbWVudAogKgogKiBAcHJvcGVydHkgbWFwCiAqIEB0eXBlIFRleHR1cmUKICovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLkRpc3BsYWNlbWVudEZpbHRlci5wcm90b3R5cGUsICdtYXAnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmRpc3BsYWNlbWVudE1hcC52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy51bmlmb3Jtcy5kaXNwbGFjZW1lbnRNYXAudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogVGhlIG11bHRpcGxpZXIgdXNlZCB0byBzY2FsZSB0aGUgZGlzcGxhY2VtZW50IHJlc3VsdCBmcm9tIHRoZSBtYXAgY2FsY3VsYXRpb24uCiAqCiAqIEBwcm9wZXJ0eSBzY2FsZQogKiBAdHlwZSBQb2ludAogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxhY2VtZW50RmlsdGVyLnByb3RvdHlwZSwgJ3NjYWxlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5zY2FsZS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy51bmlmb3Jtcy5zY2FsZS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBUaGUgb2Zmc2V0IHVzZWQgdG8gbW92ZSB0aGUgZGlzcGxhY2VtZW50IG1hcC4KICoKICogQHByb3BlcnR5IG9mZnNldAogKiBAdHlwZSBQb2ludAogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRGlzcGxhY2VtZW50RmlsdGVyLnByb3RvdHlwZSwgJ29mZnNldCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMub2Zmc2V0LnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLnVuaWZvcm1zLm9mZnNldC52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKiBvcmlnaW5hbCBmaWx0ZXI6IGh0dHBzOi8vZ2l0aHViLmNvbS9ldmFudy9nbGZ4LmpzL2Jsb2IvbWFzdGVyL3NyYy9maWx0ZXJzL2Z1bi9kb3RzY3JlZW4uanMKICovCgovKioKICogCiAqIFRoaXMgZmlsdGVyIGFwcGxpZXMgYSBwaXhsYXRlIGVmZmVjdCBtYWtpbmcgZGlzcGxheSBvYmplY3RzIGFwcGVhciAiYmxvY2t5IgogKiBAY2xhc3MgUGl4ZWxhdGVGaWx0ZXIKICogQGNvbnRydWN0b3IKICovClBJWEkuRG90U2NyZWVuRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlzY2FsZToge3R5cGU6ICcxZicsIHZhbHVlOjF9LAoJCWFuZ2xlOiB7dHlwZTogJzFmJywgdmFsdWU6NX0sCgkJZGltZW5zaW9uczogICB7dHlwZTogJzRmdicsIHZhbHVlOlswLDAsMCwwXX0KCX07CgoJdGhpcy5mcmFnbWVudFNyYyA9IFsKCSAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCgkgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAoJICAidmFyeWluZyBmbG9hdCB2Q29sb3I7IiwKCSAgInVuaWZvcm0gdmVjNCBkaW1lbnNpb25zOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoKCSAgICAidW5pZm9ybSBmbG9hdCBhbmdsZTsiLAoJICAgICJ1bmlmb3JtIGZsb2F0IHNjYWxlOyIsCgoJICAgICJmbG9hdCBwYXR0ZXJuKCkgeyIsCgkgICAgCSJmbG9hdCBzID0gc2luKGFuZ2xlKSwgYyA9IGNvcyhhbmdsZSk7IiwKCSAgICAJInZlYzIgdGV4ID0gdlRleHR1cmVDb29yZCAqIGRpbWVuc2lvbnMueHk7IiwKCSAgICAJInZlYzIgcG9pbnQgPSB2ZWMyKCIsCgkgICAgCQkiYyAqIHRleC54IC0gcyAqIHRleC55LCIsCgkgICAgCQkicyAqIHRleC54ICsgYyAqIHRleC55IiwKCSAgICAJIikgKiBzY2FsZTsiLAoJICAgIAkicmV0dXJuIChzaW4ocG9pbnQueCkgKiBzaW4ocG9pbnQueSkpICogNC4wOyIsCgkgICAgIn0iLAoKCSAgICAidm9pZCBtYWluKCkgeyIsCiAgICAgICAgICAgICJ2ZWM0IGNvbG9yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkKTsiLAogICAgICAgICAgICAiZmxvYXQgYXZlcmFnZSA9IChjb2xvci5yICsgY29sb3IuZyArIGNvbG9yLmIpIC8gMy4wOyIsCiAgICAgICAgICAgICJnbF9GcmFnQ29sb3IgPSB2ZWM0KHZlYzMoYXZlcmFnZSAqIDEwLjAgLSA1LjAgKyBwYXR0ZXJuKCkpLCBjb2xvci5hKTsiLAogICAgICAgICJ9IiwKCV07Cn0KClBJWEkuRG90U2NyZWVuRmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuRG90U2NyZWVuRmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLkRvdFNjcmVlbkZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkRvdFNjcmVlbkZpbHRlcjsKCi8qKgogKiAKICogVGhpcyBkZXNjcmliZXMgdGhlIHRoZSBzY2FsZQogKiBAcHJvcGVydHkgc2NhbGUKICogQHR5cGUgTnVtYmVyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5Eb3RTY3JlZW5GaWx0ZXIucHJvdG90eXBlLCAnc2NhbGUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnNjYWxlLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLnNjYWxlLnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIAogKiBUaGlzIHJhZGl1cyBkZXNjcmliZXMgYW5nbGUKICogQHByb3BlcnR5IGFuZ2xlCiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuRG90U2NyZWVuRmlsdGVyLnByb3RvdHlwZSwgJ2FuZ2xlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5hbmdsZS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5hbmdsZS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgoKUElYSS5GaWx0ZXJCbG9jayA9IGZ1bmN0aW9uKCkKewoJdGhpcy52aXNpYmxlID0gdHJ1ZTsKCXRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cn0KLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiAKICogVGhpcyBpbnZlcnRzIHlvdXIgZGlzcGxheU9iamVjdHMgY29sb3JzLgogKiBAY2xhc3MgSW52ZXJ0RmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLkludmVydEZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJCgkvLyBzZXQgdGhlIHVuaWZvcm1zCgl0aGlzLnVuaWZvcm1zID0gewoJCWludmVydDoge3R5cGU6ICcxZicsIHZhbHVlOiAxfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IGludmVydDsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCB2VGV4dHVyZUNvb3JkKTsiLAoJCSJnbF9GcmFnQ29sb3IucmdiID0gbWl4KCAodmVjMygxKS1nbF9GcmFnQ29sb3IucmdiKSAqIGdsX0ZyYWdDb2xvci5hLCBnbF9GcmFnQ29sb3IucmdiLCAxLjAgLSBpbnZlcnQpOyIsCgkJLy8iZ2xfRnJhZ0NvbG9yLnJnYiA9IGdsX0ZyYWdDb2xvci5yZ2IgICogZ2xfRnJhZ0NvbG9yLmE7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gZ2xfRnJhZ0NvbG9yICogdkNvbG9yOyIsCgkgICJ9IgoJXTsKCQp9CgpQSVhJLkludmVydEZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLkludmVydEZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLkludmVydEZpbHRlcjsKCi8qKgpUaGUgc3RyZW5ndGggb2YgdGhlIGludmVydC4gMSB3aWxsIGZ1bGx5IGludmVydCB0aGUgY29sb3JzLCAwIHdpbGwgbWFrZSB0aGUgb2JqZWN0IGl0cyBub3JtYWwgY29sb3IKQHByb3BlcnR5IGludmVydAoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5JbnZlcnRGaWx0ZXIucHJvdG90eXBlLCAnaW52ZXJ0JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5pbnZlcnQudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMudW5pZm9ybXMuaW52ZXJ0LnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIAogKiBUaGlzIGZpbHRlciBhcHBsaWVzIGEgcGl4bGF0ZSBlZmZlY3QgbWFraW5nIGRpc3BsYXkgb2JqZWN0cyBhcHBlYXIgImJsb2NreSIKICogQGNsYXNzIFBpeGVsYXRlRmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLlBpeGVsYXRlRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlpbnZlcnQ6IHt0eXBlOiAnMWYnLCB2YWx1ZTogMH0sCgkJZGltZW5zaW9uczoge3R5cGU6ICc0ZnYnLCB2YWx1ZTpuZXcgRmxvYXQzMkFycmF5KFsxMDAwMCwgMTAwLCAxMCwgMTBdKX0sCgkJcGl4ZWxTaXplOiB7dHlwZTogJzJmJywgdmFsdWU6e3g6MTAsIHk6MTB9fSwKCX07CgoJdGhpcy5mcmFnbWVudFNyYyA9IFsKCSAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCgkgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAoJICAidmFyeWluZyBmbG9hdCB2Q29sb3I7IiwKCSAgInVuaWZvcm0gdmVjMiB0ZXN0RGltOyIsCgkgICJ1bmlmb3JtIHZlYzQgZGltZW5zaW9uczsiLAoJICAidW5pZm9ybSB2ZWMyIHBpeGVsU2l6ZTsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAJInZlYzIgY29vcmQgPSB2VGV4dHVyZUNvb3JkOyIsCgoJIAkidmVjMiBzaXplID0gZGltZW5zaW9ucy54eS9waXhlbFNpemU7IiwKCgkgCSJ2ZWMyIGNvbG9yID0gZmxvb3IoICggdlRleHR1cmVDb29yZCAqIHNpemUgKSApIC8gc2l6ZSArIHBpeGVsU2l6ZS9kaW1lbnNpb25zLnh5ICogMC41OyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgY29sb3IpOyIsCgkgICJ9IgoJXTsKCQoKfQoKUElYSS5QaXhlbGF0ZUZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLlBpeGVsYXRlRmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuUGl4ZWxhdGVGaWx0ZXI7CgovKioKICogCiAqIFRoaXMgYSBwb2ludCB0aGF0IGRlc2NyaWJlcyB0aGUgc2l6ZSBvZiB0aGUgYmxvY3MuIHggaXMgdGhlIHdpZHRoIG9mIHRoZSBibG9jayBhbmQgeSBpcyB0aGUgdGhlIGhlaWdodAogKiBAcHJvcGVydHkgc2l6ZQogKiBAdHlwZSBQb2ludAogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuUGl4ZWxhdGVGaWx0ZXIucHJvdG90eXBlLCAnc2l6ZScsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudW5pZm9ybXMucGl4ZWxTaXplLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLnBpeGVsU2l6ZS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgoKUElYSS5SR0JTcGxpdEZpbHRlciA9IGZ1bmN0aW9uKCkKewoJUElYSS5BYnN0cmFjdEZpbHRlci5jYWxsKCB0aGlzICk7CgkKCXRoaXMucGFzc2VzID0gW3RoaXNdOwoJCgkvLyBzZXQgdGhlIHVuaWZvcm1zCgl0aGlzLnVuaWZvcm1zID0gewoJCXJlZDoge3R5cGU6ICcyZicsIHZhbHVlOiB7eDoyMCwgeToyMH19LAoJCWdyZWVuOiB7dHlwZTogJzJmJywgdmFsdWU6IHt4Oi0yMCwgeToyMH19LAoJCWJsdWU6IHt0eXBlOiAnMmYnLCB2YWx1ZToge3g6MjAsIHk6LTIwfX0sCgkJZGltZW5zaW9uczogICB7dHlwZTogJzRmdicsIHZhbHVlOlswLDAsMCwwXX0KCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIHZlYzIgcmVkOyIsCgkgICJ1bmlmb3JtIHZlYzIgZ3JlZW47IiwKCSAgInVuaWZvcm0gdmVjMiBibHVlOyIsCgkgICJ1bmlmb3JtIHZlYzQgZGltZW5zaW9uczsiLAoJICAidW5pZm9ybSBzYW1wbGVyMkQgdVNhbXBsZXI7IiwKCSAgICAidm9pZCBtYWluKHZvaWQpIHsiLAoJICAJICAiZ2xfRnJhZ0NvbG9yLnIgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQgKyByZWQvZGltZW5zaW9ucy54eSkucjsiLAoJICAJICAiZ2xfRnJhZ0NvbG9yLmcgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQgKyBncmVlbi9kaW1lbnNpb25zLnh5KS5nOyIsCgkgIAkgICJnbF9GcmFnQ29sb3IuYiA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCArIGJsdWUvZGltZW5zaW9ucy54eSkuYjsiLAoJICAJICAiZ2xfRnJhZ0NvbG9yLmEgPSB0ZXh0dXJlMkQodVNhbXBsZXIsIHZUZXh0dXJlQ29vcmQpLmE7IiwKCSAgIn0iCgldOwp9CgpQSVhJLlJHQlNwbGl0RmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuUkdCU3BsaXRGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5SR0JTcGxpdEZpbHRlcjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlJHQlNwbGl0RmlsdGVyLnByb3RvdHlwZSwgJ2FuZ2xlJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlIC8gKDEvNzAwMCk7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCS8vdGhpcy5wYWRkaW5nID0gdmFsdWU7CiAgICAJdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlID0gKDEvNzAwMCkgKiB2YWx1ZTsKICAgIH0KfSk7CgovKioKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogCiAqIFRoaXMgYXBwbGllcyBhIHNlcGlhIGVmZmVjdCB0byB5b3VyIGRpc3BsYXlPYmplY3RzLgogKiBAY2xhc3MgU2VwaWFGaWx0ZXIKICogQGNvbnRydWN0b3IKICovClBJWEkuU2VwaWFGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCVBJWEkuQWJzdHJhY3RGaWx0ZXIuY2FsbCggdGhpcyApOwoJCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlzZXBpYToge3R5cGU6ICcxZicsIHZhbHVlOiAxfSwKCX07CgkKCXRoaXMuZnJhZ21lbnRTcmMgPSBbCgkgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAoJICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKCSAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgkgICJ1bmlmb3JtIGZsb2F0IHNlcGlhOyIsCgkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAoJIAkgICAKCSAgImNvbnN0IG1hdDMgc2VwaWFNYXRyaXggPSBtYXQzKDAuMzU4OCwgMC43MDQ0LCAwLjEzNjgsIDAuMjk5MCwgMC41ODcwLCAwLjExNDAsIDAuMjM5MiwgMC40Njk2LCAwLjA5MTIpOyIsCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCk7IiwKCQkiZ2xfRnJhZ0NvbG9yLnJnYiA9IG1peCggZ2xfRnJhZ0NvbG9yLnJnYiwgZ2xfRnJhZ0NvbG9yLnJnYiAqIHNlcGlhTWF0cml4LCBzZXBpYSk7IiwKCSAgICAiZ2xfRnJhZ0NvbG9yID0gZ2xfRnJhZ0NvbG9yICogdkNvbG9yOyIsCgkgICJ9IgoJXTsKCQp9CgpQSVhJLlNlcGlhRmlsdGVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoIFBJWEkuQWJzdHJhY3RGaWx0ZXIucHJvdG90eXBlICk7ClBJWEkuU2VwaWFGaWx0ZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5TZXBpYUZpbHRlcjsKCi8qKgpUaGUgc3RyZW5ndGggb2YgdGhlIHNlcGlhLiAxIHdpbGwgYXBwbHkgdGhlIGZ1bGwgc2VwaWEgZWZmZWN0LCAwIHdpbGwgbWFrZSB0aGUgb2JqZWN0IGl0cyBub3JtYWwgY29sb3IKQHByb3BlcnR5IHNlcGlhCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlNlcGlhRmlsdGVyLnByb3RvdHlwZSwgJ3NlcGlhJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5zZXBpYS52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy51bmlmb3Jtcy5zZXBpYS52YWx1ZSA9IHZhbHVlOwogICAgfQp9KTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKClBJWEkuU21hcnRCbHVyRmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCQoJdGhpcy5wYXNzZXMgPSBbdGhpc107CgkKCS8vIHNldCB0aGUgdW5pZm9ybXMKCXRoaXMudW5pZm9ybXMgPSB7CgkJYmx1cjoge3R5cGU6ICcxZicsIHZhbHVlOiAxLzUxMn0sCgl9OwoJCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKIAkgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAogIAkgICJ1bmlmb3JtIHNhbXBsZXIyRCB1U2FtcGxlcjsiLAogICAgLy8gICJ1bmlmb3JtIHZlYzIgZGVsdGE7IiwKICAgICAgImNvbnN0IHZlYzIgZGVsdGEgPSB2ZWMyKDEuMC8xMC4wLCAwLjApOyIsCiAgICAgLy8gInVuaWZvcm0gZmxvYXQgZGFya25lc3M7IiwKCSAgCgkgICJmbG9hdCByYW5kb20odmVjMyBzY2FsZSwgZmxvYXQgc2VlZCkgeyIsCgkgICAgICAgICJyZXR1cm4gZnJhY3Qoc2luKGRvdChnbF9GcmFnQ29vcmQueHl6ICsgc2VlZCwgc2NhbGUpKSAqIDQzNzU4LjU0NTMgKyBzZWVkKTsiLAoJICAgIn0iLAoJICAgCgkgICAKCSAgInZvaWQgbWFpbih2b2lkKSB7IiwKCSAKCSAgInZlYzQgY29sb3IgPSB2ZWM0KDAuMCk7IiwKCSAgImZsb2F0IHRvdGFsID0gMC4wOyIsCgkgIAoJICAiZmxvYXQgb2Zmc2V0ID0gcmFuZG9tKHZlYzMoMTIuOTg5OCwgNzguMjMzLCAxNTEuNzE4MiksIDAuMCk7IiwKCSAgICAgICAgICAgIAoJICAiZm9yIChmbG9hdCB0ID0gLTMwLjA7IHQgPD0gMzAuMDsgdCsrKSB7IiwKCSAgICAgICAgICAgImZsb2F0IHBlcmNlbnQgPSAodCArIG9mZnNldCAtIDAuNSkgLyAzMC4wOyIsCgkgICAgICAgICAgICAgICAgImZsb2F0IHdlaWdodCA9IDEuMCAtIGFicyhwZXJjZW50KTsiLAoJICAgICAgICAgICAgICAgICJ2ZWM0IHNhbXBsZSA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCArIGRlbHRhICogcGVyY2VudCk7IiwKCSAgICAgICAgICAgICAgICAic2FtcGxlLnJnYiAqPSBzYW1wbGUuYTsiLAoJICAgICAgICAgICAgICAgICJjb2xvciArPSBzYW1wbGUgKiB3ZWlnaHQ7IiwKCSAgICAgICAgICAgICAgICAidG90YWwgKz0gd2VpZ2h0OyIsCgkgICAgICAgICAgICAifSIsCgkgICAgICAgICAgICAKCSAgICAgICAgICAgICJnbF9GcmFnQ29sb3IgPSBjb2xvciAvIHRvdGFsOyIsCgkgICAgICAgICAgICAiZ2xfRnJhZ0NvbG9yLnJnYiAvPSBnbF9GcmFnQ29sb3IuYSArIDAuMDAwMDE7IiwKCSAgICAgICAgICAvLyAgImdsX0ZyYWdDb2xvci5yZ2IgKj0gZGFya25lc3M7IiwKCSAgIn0iCgldOwp9CgpQSVhJLlNtYXJ0Qmx1ckZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLlNtYXJ0Qmx1ckZpbHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlNtYXJ0Qmx1ckZpbHRlcjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQSVhJLlNtYXJ0Qmx1ckZpbHRlci5wcm90b3R5cGUsICdibHVyJywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5ibHVyLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLnVuaWZvcm1zLmJsdXIudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIAogKiBUaGlzIGZpbHRlciBhcHBsaWVzIGEgcGl4bGF0ZSBlZmZlY3QgbWFraW5nIGRpc3BsYXkgb2JqZWN0cyBhcHBlYXIgImJsb2NreSIKICogQGNsYXNzIFBpeGVsYXRlRmlsdGVyCiAqIEBjb250cnVjdG9yCiAqLwpQSVhJLlR3aXN0RmlsdGVyID0gZnVuY3Rpb24oKQp7CglQSVhJLkFic3RyYWN0RmlsdGVyLmNhbGwoIHRoaXMgKTsKCgl0aGlzLnBhc3NlcyA9IFt0aGlzXTsKCQoJLy8gc2V0IHRoZSB1bmlmb3JtcwoJdGhpcy51bmlmb3JtcyA9IHsKCQlyYWRpdXM6IHt0eXBlOiAnMWYnLCB2YWx1ZTowLjV9LAoJCWFuZ2xlOiB7dHlwZTogJzFmJywgdmFsdWU6NX0sCgkJb2Zmc2V0OiB7dHlwZTogJzJmJywgdmFsdWU6e3g6MC41LCB5OjAuNX19LAoJfTsKCgl0aGlzLmZyYWdtZW50U3JjID0gWwoJICAicHJlY2lzaW9uIG1lZGl1bXAgZmxvYXQ7IiwKCSAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgkgICJ2YXJ5aW5nIGZsb2F0IHZDb2xvcjsiLAoJICAidW5pZm9ybSB2ZWM0IGRpbWVuc2lvbnM7IiwKCSAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCgkgIAoJICAidW5pZm9ybSBmbG9hdCByYWRpdXM7IiwKICAgICAgInVuaWZvcm0gZmxvYXQgYW5nbGU7IiwKICAgICAgInVuaWZvcm0gdmVjMiBvZmZzZXQ7IiwKCgkgICJ2b2lkIG1haW4odm9pZCkgeyIsCgkgCSJ2ZWMyIGNvb3JkID0gdlRleHR1cmVDb29yZCAtIG9mZnNldDsiLAoJCSJmbG9hdCBkaXN0YW5jZSA9IGxlbmd0aChjb29yZCk7IiwKCSAJCgkgCSJpZiAoZGlzdGFuY2UgPCByYWRpdXMpeyIsCgoJCSAJImZsb2F0IHJhdGlvID0gKHJhZGl1cyAtIGRpc3RhbmNlKSAvIHJhZGl1czsiLAoJCSAJImZsb2F0IGFuZ2xlTW9kID0gcmF0aW8gKiByYXRpbyAqIGFuZ2xlOyIsCgkJIAkiZmxvYXQgcyA9IHNpbihhbmdsZU1vZCk7IiwKCQkgCSJmbG9hdCBjID0gY29zKGFuZ2xlTW9kKTsiLAoJCSAJImNvb3JkID0gdmVjMihjb29yZC54ICogYyAtIGNvb3JkLnkgKiBzLCBjb29yZC54ICogcyArIGNvb3JkLnkgKiBjKTsiLAoKCSAJIn0iLAoKCSAgICAiZ2xfRnJhZ0NvbG9yID0gdGV4dHVyZTJEKHVTYW1wbGVyLCBjb29yZCtvZmZzZXQpOyIsCgkgICJ9IgoJXTsKfQoKUElYSS5Ud2lzdEZpbHRlci5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkFic3RyYWN0RmlsdGVyLnByb3RvdHlwZSApOwpQSVhJLlR3aXN0RmlsdGVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuVHdpc3RGaWx0ZXI7CgovKioKICogCiAqIFRoaXMgcG9pbnQgZGVzY3JpYmVzIHRoZSB0aGUgb2Zmc2V0IG9mIHRoZSB0d2lzdAogKiBAcHJvcGVydHkgc2l6ZQogKiBAdHlwZSBQb2ludAogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuVHdpc3RGaWx0ZXIucHJvdG90eXBlLCAnb2Zmc2V0JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy51bmlmb3Jtcy5vZmZzZXQudmFsdWU7CiAgICB9LAogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgCXRoaXMuZGlydHkgPSB0cnVlOwogICAgCXRoaXMudW5pZm9ybXMub2Zmc2V0LnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwoKLyoqCiAqIAogKiBUaGlzIHJhZGl1cyBkZXNjcmliZXMgc2l6ZSBvZiB0aGUgdHdpc3QKICogQHByb3BlcnR5IHNpemUKICogQHR5cGUgTnVtYmVyCiAqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUElYSS5Ud2lzdEZpbHRlci5wcm90b3R5cGUsICdyYWRpdXMnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnJhZGl1cy52YWx1ZTsKICAgIH0sCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAJdGhpcy5kaXJ0eSA9IHRydWU7CiAgICAJdGhpcy51bmlmb3Jtcy5yYWRpdXMudmFsdWUgPSB2YWx1ZTsKICAgIH0KfSk7CgovKioKICogCiAqIFRoaXMgcmFkaXVzIGRlc2NyaWJlcyBhbmdsZSBvZiB0aGUgdHdpc3QKICogQHByb3BlcnR5IGFuZ2xlCiAqIEB0eXBlIE51bWJlcgogKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBJWEkuVHdpc3RGaWx0ZXIucHJvdG90eXBlLCAnYW5nbGUnLCB7CiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLmFuZ2xlLnZhbHVlOwogICAgfSwKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgIAl0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIAl0aGlzLnVuaWZvcm1zLmFuZ2xlLnZhbHVlID0gdmFsdWU7CiAgICB9Cn0pOwovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKCi8qKgogKiBUaGUgR3JhcGhpY3MgY2xhc3MgY29udGFpbnMgYSBzZXQgb2YgbWV0aG9kcyB0aGF0IHlvdSBjYW4gdXNlIHRvIGNyZWF0ZSBwcmltaXRpdmUgc2hhcGVzIGFuZCBsaW5lcy4KICogSXQgaXMgaW1wb3J0YW50IHRvIGtub3cgdGhhdCB3aXRoIHRoZSB3ZWJHTCByZW5kZXJlciBvbmx5IHNpbXBsZSBwb2x5cyBjYW4gYmUgZmlsbGVkIGF0IHRoaXMgc3RhZ2UKICogQ29tcGxleCBwb2x5cyB3aWxsIG5vdCBiZSBmaWxsZWQuIEhlcmVzIGFuIGV4YW1wbGUgb2YgYSBjb21wbGV4IHBvbHk6IGh0dHA6Ly93d3cuZ29vZGJveWRpZ2l0YWwuY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDEzLzA2L2NvbXBsZXhQb2x5Z29uLnBuZwogKgogKiBAY2xhc3MgR3JhcGhpY3MKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICovClBJWEkuR3JhcGhpY3MgPSBmdW5jdGlvbigpCnsKCVBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5jYWxsKCB0aGlzICk7CgoJdGhpcy5yZW5kZXJhYmxlID0gdHJ1ZTsKCiAgICAvKioKICAgICAqIFRoZSBhbHBoYSBvZiB0aGUgZmlsbCBvZiB0aGlzIGdyYXBoaWNzIG9iamVjdAogICAgICoKICAgICAqIEBwcm9wZXJ0eSBmaWxsQWxwaGEKICAgICAqIEB0eXBlIE51bWJlcgogICAgICovCgl0aGlzLmZpbGxBbHBoYSA9IDE7CgogICAgLyoqCiAgICAgKiBUaGUgd2lkdGggb2YgYW55IGxpbmVzIGRyYXduCiAgICAgKgogICAgICogQHByb3BlcnR5IGxpbmVXaWR0aAogICAgICogQHR5cGUgTnVtYmVyCiAgICAgKi8KCXRoaXMubGluZVdpZHRoID0gMDsKCiAgICAvKioKICAgICAqIFRoZSBjb2xvciBvZiBhbnkgbGluZXMgZHJhd24KICAgICAqCiAgICAgKiBAcHJvcGVydHkgbGluZUNvbG9yCiAgICAgKiBAdHlwZSBTdHJpbmcKICAgICAqLwoJdGhpcy5saW5lQ29sb3IgPSAiYmxhY2siOwoKICAgIC8qKgogICAgICogR3JhcGhpY3MgZGF0YQogICAgICoKICAgICAqIEBwcm9wZXJ0eSBncmFwaGljc0RhdGEKICAgICAqIEB0eXBlIEFycmF5CiAgICAgKiBAcHJpdmF0ZQogICAgICovCgl0aGlzLmdyYXBoaWNzRGF0YSA9IFtdOwoKICAgIC8qKgogICAgICogQ3VycmVudCBwYXRoCiAgICAgKgogICAgICogQHByb3BlcnR5IGN1cnJlbnRQYXRoCiAgICAgKiBAdHlwZSBPYmplY3QKICAgICAqIEBwcml2YXRlCiAgICAgKi8KCXRoaXMuY3VycmVudFBhdGggPSB7cG9pbnRzOltdfTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5HcmFwaGljcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIucHJvdG90eXBlICk7ClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5HcmFwaGljczsKCi8qKgogKiBTcGVjaWZpZXMgYSBsaW5lIHN0eWxlIHVzZWQgZm9yIHN1YnNlcXVlbnQgY2FsbHMgdG8gR3JhcGhpY3MgbWV0aG9kcyBzdWNoIGFzIHRoZSBsaW5lVG8oKSBtZXRob2Qgb3IgdGhlIGRyYXdDaXJjbGUoKSBtZXRob2QuCiAqCiAqIEBtZXRob2QgbGluZVN0eWxlCiAqIEBwYXJhbSBsaW5lV2lkdGgge051bWJlcn0gd2lkdGggb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKiBAcGFyYW0gY29sb3Ige051bWJlcn0gY29sb3Igb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKiBAcGFyYW0gYWxwaGEge051bWJlcn0gYWxwaGEgb2YgdGhlIGxpbmUgdG8gZHJhdywgd2lsbCB1cGRhdGUgdGhlIG9iamVjdCdzIHN0b3JlZCBzdHlsZQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUubGluZVN0eWxlID0gZnVuY3Rpb24obGluZVdpZHRoLCBjb2xvciwgYWxwaGEpCnsKCWlmKHRoaXMuY3VycmVudFBhdGgucG9pbnRzLmxlbmd0aCA9PSAwKXRoaXMuZ3JhcGhpY3NEYXRhLnBvcCgpOwoKCXRoaXMubGluZVdpZHRoID0gbGluZVdpZHRoIHx8IDA7Cgl0aGlzLmxpbmVDb2xvciA9IGNvbG9yIHx8IDA7Cgl0aGlzLmxpbmVBbHBoYSA9IChhbHBoYSA9PSB1bmRlZmluZWQpID8gMSA6IGFscGhhOwoKCXRoaXMuY3VycmVudFBhdGggPSB7bGluZVdpZHRoOnRoaXMubGluZVdpZHRoLCBsaW5lQ29sb3I6dGhpcy5saW5lQ29sb3IsIGxpbmVBbHBoYTp0aGlzLmxpbmVBbHBoYSwKCQkJCQkJZmlsbENvbG9yOnRoaXMuZmlsbENvbG9yLCBmaWxsQWxwaGE6dGhpcy5maWxsQWxwaGEsIGZpbGw6dGhpcy5maWxsaW5nLCBwb2ludHM6W10sIHR5cGU6UElYSS5HcmFwaGljcy5QT0xZfTsKCgl0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwp9CgovKioKICogTW92ZXMgdGhlIGN1cnJlbnQgZHJhd2luZyBwb3NpdGlvbiB0byAoeCwgeSkuCiAqCiAqIEBtZXRob2QgbW92ZVRvCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IHRoZSBYIGNvb3JkIHRvIG1vdmUgdG8KICogQHBhcmFtIHkge051bWJlcn0gdGhlIFkgY29vcmQgdG8gbW92ZSB0bwogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUubW92ZVRvID0gZnVuY3Rpb24oeCwgeSkKewoJaWYodGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoID09IDApdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgoJdGhpcy5jdXJyZW50UGF0aCA9IHRoaXMuY3VycmVudFBhdGggPSB7bGluZVdpZHRoOnRoaXMubGluZVdpZHRoLCBsaW5lQ29sb3I6dGhpcy5saW5lQ29sb3IsIGxpbmVBbHBoYTp0aGlzLmxpbmVBbHBoYSwKCQkJCQkJZmlsbENvbG9yOnRoaXMuZmlsbENvbG9yLCBmaWxsQWxwaGE6dGhpcy5maWxsQWxwaGEsIGZpbGw6dGhpcy5maWxsaW5nLCBwb2ludHM6W10sIHR5cGU6UElYSS5HcmFwaGljcy5QT0xZfTsKCgl0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5wdXNoKHgsIHkpOwoKCXRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7Cn0KCi8qKgogKiBEcmF3cyBhIGxpbmUgdXNpbmcgdGhlIGN1cnJlbnQgbGluZSBzdHlsZSBmcm9tIHRoZSBjdXJyZW50IGRyYXdpbmcgcG9zaXRpb24gdG8gKHgsIHkpOwogKiB0aGUgY3VycmVudCBkcmF3aW5nIHBvc2l0aW9uIGlzIHRoZW4gc2V0IHRvICh4LCB5KS4KICoKICogQG1ldGhvZCBsaW5lVG8KICogQHBhcmFtIHgge051bWJlcn0gdGhlIFggY29vcmQgdG8gZHJhdyB0bwogKiBAcGFyYW0geSB7TnVtYmVyfSB0aGUgWSBjb29yZCB0byBkcmF3IHRvCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5saW5lVG8gPSBmdW5jdGlvbih4LCB5KQp7Cgl0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5wdXNoKHgsIHkpOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cn0KCi8qKgogKiBTcGVjaWZpZXMgYSBzaW1wbGUgb25lLWNvbG9yIGZpbGwgdGhhdCBzdWJzZXF1ZW50IGNhbGxzIHRvIG90aGVyIEdyYXBoaWNzIG1ldGhvZHMKICogKHN1Y2ggYXMgbGluZVRvKCkgb3IgZHJhd0NpcmNsZSgpKSB1c2Ugd2hlbiBkcmF3aW5nLgogKgogKiBAbWV0aG9kIGJlZ2luRmlsbAogKiBAcGFyYW0gY29sb3Ige3VpbnR9IHRoZSBjb2xvciBvZiB0aGUgZmlsbAogKiBAcGFyYW0gYWxwaGEge051bWJlcn0gdGhlIGFscGhhCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5iZWdpbkZpbGwgPSBmdW5jdGlvbihjb2xvciwgYWxwaGEpCnsKCXRoaXMuZmlsbGluZyA9IHRydWU7Cgl0aGlzLmZpbGxDb2xvciA9IGNvbG9yIHx8IDA7Cgl0aGlzLmZpbGxBbHBoYSA9IChhbHBoYSA9PSB1bmRlZmluZWQpID8gMSA6IGFscGhhOwp9CgovKioKICogQXBwbGllcyBhIGZpbGwgdG8gdGhlIGxpbmVzIGFuZCBzaGFwZXMgdGhhdCB3ZXJlIGFkZGVkIHNpbmNlIHRoZSBsYXN0IGNhbGwgdG8gdGhlIGJlZ2luRmlsbCgpIG1ldGhvZC4KICoKICogQG1ldGhvZCBlbmRGaWxsCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5lbmRGaWxsID0gZnVuY3Rpb24oKQp7Cgl0aGlzLmZpbGxpbmcgPSBmYWxzZTsKCXRoaXMuZmlsbENvbG9yID0gbnVsbDsKCXRoaXMuZmlsbEFscGhhID0gMTsKfQoKLyoqCiAqIEBtZXRob2QgZHJhd1JlY3QKICoKICogQHBhcmFtIHgge051bWJlcn0gVGhlIFggY29vcmQgb2YgdGhlIHRvcC1sZWZ0IG9mIHRoZSByZWN0YW5nbGUKICogQHBhcmFtIHkge051bWJlcn0gVGhlIFkgY29vcmQgb2YgdGhlIHRvcC1sZWZ0IG9mIHRoZSByZWN0YW5nbGUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IFRoZSB3aWR0aCBvZiB0aGUgcmVjdGFuZ2xlCiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gVGhlIGhlaWdodCBvZiB0aGUgcmVjdGFuZ2xlCiAqLwpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS5kcmF3UmVjdCA9IGZ1bmN0aW9uKCB4LCB5LCB3aWR0aCwgaGVpZ2h0ICkKewoJaWYodGhpcy5jdXJyZW50UGF0aC5wb2ludHMubGVuZ3RoID09IDApdGhpcy5ncmFwaGljc0RhdGEucG9wKCk7CgoJdGhpcy5jdXJyZW50UGF0aCA9IHtsaW5lV2lkdGg6dGhpcy5saW5lV2lkdGgsIGxpbmVDb2xvcjp0aGlzLmxpbmVDb2xvciwgbGluZUFscGhhOnRoaXMubGluZUFscGhhLAoJCQkJCQlmaWxsQ29sb3I6dGhpcy5maWxsQ29sb3IsIGZpbGxBbHBoYTp0aGlzLmZpbGxBbHBoYSwgZmlsbDp0aGlzLmZpbGxpbmcsCgkJCQkJCXBvaW50czpbeCwgeSwgd2lkdGgsIGhlaWdodF0sIHR5cGU6UElYSS5HcmFwaGljcy5SRUNUfTsKCgl0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cn0KCi8qKgogKiBEcmF3cyBhIGNpcmNsZS4KICoKICogQG1ldGhvZCBkcmF3Q2lyY2xlCiAqIEBwYXJhbSB4IHtOdW1iZXJ9IFRoZSBYIGNvb3JkIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZQogKiBAcGFyYW0geSB7TnVtYmVyfSBUaGUgWSBjb29yZCBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUKICogQHBhcmFtIHJhZGl1cyB7TnVtYmVyfSBUaGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUKICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdDaXJjbGUgPSBmdW5jdGlvbiggeCwgeSwgcmFkaXVzKQp7CglpZih0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGggPT0gMCl0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCgl0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCgkJCQkJCWZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywKCQkJCQkJcG9pbnRzOlt4LCB5LCByYWRpdXMsIHJhZGl1c10sIHR5cGU6UElYSS5HcmFwaGljcy5DSVJDfTsKCgl0aGlzLmdyYXBoaWNzRGF0YS5wdXNoKHRoaXMuY3VycmVudFBhdGgpOwoJdGhpcy5kaXJ0eSA9IHRydWU7Cn0KCi8qKgogKiBEcmF3cyBhbiBlbGlwc2UuCiAqCiAqIEBtZXRob2QgZHJhd0VsaXBzZQogKiBAcGFyYW0geCB7TnVtYmVyfQogKiBAcGFyYW0geSB7TnVtYmVyfQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0KICogQHBhcmFtIGhlaWdodCB7TnVtYmVyfQogKi8KUElYSS5HcmFwaGljcy5wcm90b3R5cGUuZHJhd0VsaXBzZSA9IGZ1bmN0aW9uKCB4LCB5LCB3aWR0aCwgaGVpZ2h0KQp7CglpZih0aGlzLmN1cnJlbnRQYXRoLnBvaW50cy5sZW5ndGggPT0gMCl0aGlzLmdyYXBoaWNzRGF0YS5wb3AoKTsKCgl0aGlzLmN1cnJlbnRQYXRoID0ge2xpbmVXaWR0aDp0aGlzLmxpbmVXaWR0aCwgbGluZUNvbG9yOnRoaXMubGluZUNvbG9yLCBsaW5lQWxwaGE6dGhpcy5saW5lQWxwaGEsCgkJCQkJCWZpbGxDb2xvcjp0aGlzLmZpbGxDb2xvciwgZmlsbEFscGhhOnRoaXMuZmlsbEFscGhhLCBmaWxsOnRoaXMuZmlsbGluZywKCQkJCQkJcG9pbnRzOlt4LCB5LCB3aWR0aCwgaGVpZ2h0XSwgdHlwZTpQSVhJLkdyYXBoaWNzLkVMSVB9OwoKCXRoaXMuZ3JhcGhpY3NEYXRhLnB1c2godGhpcy5jdXJyZW50UGF0aCk7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKfQoKLyoqCiAqIENsZWFycyB0aGUgZ3JhcGhpY3MgdGhhdCB3ZXJlIGRyYXduIHRvIHRoaXMgR3JhcGhpY3Mgb2JqZWN0LCBhbmQgcmVzZXRzIGZpbGwgYW5kIGxpbmUgc3R5bGUgc2V0dGluZ3MuCiAqCiAqIEBtZXRob2QgY2xlYXIKICovClBJWEkuR3JhcGhpY3MucHJvdG90eXBlLmNsZWFyID0gZnVuY3Rpb24oKQp7Cgl0aGlzLmxpbmVXaWR0aCA9IDA7Cgl0aGlzLmZpbGxpbmcgPSBmYWxzZTsKCgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCXRoaXMuY2xlYXJEaXJ0eSA9IHRydWU7Cgl0aGlzLmdyYXBoaWNzRGF0YSA9IFtdOwoKCXRoaXMuYm91bmRzID0gbnVsbC8vbmV3IFBJWEkuUmVjdGFuZ2xlKCk7Cn0KCgpQSVhJLkdyYXBoaWNzLnByb3RvdHlwZS51cGRhdGVGaWx0ZXJCb3VuZHMgPSBmdW5jdGlvbigpCnsKCWlmKCF0aGlzLmJvdW5kcykKCXsKCQl2YXIgbWluWCA9IEluZmluaXR5OwoJCXZhciBtYXhYID0gLUluZmluaXR5OwoKCQl2YXIgbWluWSA9IEluZmluaXR5OwoJCXZhciBtYXhZID0gLUluZmluaXR5OwoKCQl2YXIgcG9pbnRzLCB4LCB5OwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZ3JhcGhpY3NEYXRhLmxlbmd0aDsgaSsrKSB7CgkJCQoKCQkJdmFyIGRhdGEgPSB0aGlzLmdyYXBoaWNzRGF0YVtpXTsKCQkJdmFyIHR5cGUgPSBkYXRhLnR5cGU7CgkJCXZhciBsaW5lV2lkdGggPSBkYXRhLmxpbmVXaWR0aDsKCgkJCXBvaW50cyA9IGRhdGEucG9pbnRzOwoKCQkJaWYodHlwZSA9PT0gUElYSS5HcmFwaGljcy5SRUNUKQoJCQl7CgkJCQl4ID0gcG9pbnRzLnggLSBsaW5lV2lkdGgvMjsKCQkJCXkgPSBwb2ludHMueSAtIGxpbmVXaWR0aC8yOwoJCQkJdmFyIHdpZHRoID0gcG9pbnRzLndpZHRoICsgbGluZVdpZHRoOwoJCQkJdmFyIGhlaWdodCA9IHBvaW50cy5oZWlnaHQgKyBsaW5lV2lkdGg7CgoJCQkJbWluWCA9IHggPCBtaW5YID8geCA6IG1pblg7CgkJCQltYXhYID0geCArIHdpZHRoID4gbWF4WCA/IHggKyB3aWR0aCA6IG1heFg7CgoJCQkJbWluWSA9IHkgPCBtaW5ZID8geCA6IG1pblk7CgkJCQltYXhZID0geSArIGhlaWdodCA+IG1heFkgPyB5ICsgaGVpZ2h0IDogbWF4WTsKCQkJfQoJCQllbHNlIGlmKHR5cGUgPT09IFBJWEkuR3JhcGhpY3MuQ0lSQyB8fCB0eXBlID09PSBQSVhJLkdyYXBoaWNzLkVMSVApCgkJCXsKCQkJCXggPSBwb2ludHMueDsKCQkJCXkgPSBwb2ludHMueTsKCQkJCXZhciByYWRpdXMgPSBwb2ludHMucmFkaXVzICsgbGluZVdpZHRoLzI7CgkJCQkKCQkJCW1pblggPSB4IC0gcmFkaXVzIDwgbWluWCA/IHggLSByYWRpdXMgOiBtaW5YOwoJCQkJbWF4WCA9IHggKyByYWRpdXMgPiBtYXhYID8geCArIHJhZGl1cyA6IG1heFg7CgoJCQkJbWluWSA9IHkgLSByYWRpdXMgPCBtaW5ZID8geSAtIHJhZGl1cyA6IG1pblk7CgkJCQltYXhZID0geSArIHJhZGl1cyA+IG1heFkgPyB5ICsgcmFkaXVzIDogbWF4WTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCS8vIFBPTFkKCQkJCWZvciAodmFyIGogPSAwOyBqIDwgcG9pbnRzLmxlbmd0aDsgais9MikgCgkJCQl7CgkJCQkJCgkJCQkJeCA9IHBvaW50c1tqXTsKCQkJCQl5ID0gcG9pbnRzW2orMV07CgoJCQkJCW1pblggPSB4LWxpbmVXaWR0aCA8IG1pblggPyB4LWxpbmVXaWR0aCA6IG1pblg7CgkJCQkJbWF4WCA9IHgrbGluZVdpZHRoID4gbWF4WCA/IHgrbGluZVdpZHRoIDogbWF4WDsKCgkJCQkJbWluWSA9IHktbGluZVdpZHRoIDwgbWluWSA/IHktbGluZVdpZHRoIDogbWluWTsKCQkJCQltYXhZID0geStsaW5lV2lkdGggPiBtYXhZID8geStsaW5lV2lkdGggOiBtYXhZOwoJCQkJfTsKCQkJfQoKCQl9OwoKCQl0aGlzLmJvdW5kcyA9IG5ldyBQSVhJLlJlY3RhbmdsZShtaW5YLCBtaW5ZLCBtYXhYIC0gbWluWCwgbWF4WSAtIG1pblkpOwoKCX0KCi8vCWNvbnNvbGUubG9nKHRoaXMuYm91bmRzKTsKfQoKLy8gU09NRSBUWVBFUzoKUElYSS5HcmFwaGljcy5QT0xZID0gMDsKUElYSS5HcmFwaGljcy5SRUNUID0gMTsKUElYSS5HcmFwaGljcy5DSVJDID0gMjsKUElYSS5HcmFwaGljcy5FTElQID0gMzsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKLyoqCiAqIEEgc2V0IG9mIGZ1bmN0aW9ucyB1c2VkIGJ5IHRoZSBjYW52YXMgcmVuZGVyZXIgdG8gZHJhdyB0aGUgcHJpbWl0aXZlIGdyYXBoaWNzIGRhdGEKICoKICogQGNsYXNzIENhbnZhc0dyYXBoaWNzCiAqLwpQSVhJLkNhbnZhc0dyYXBoaWNzID0gZnVuY3Rpb24oKQp7Cgp9CgoKLyoKICogUmVuZGVycyB0aGUgZ3JhcGhpY3Mgb2JqZWN0CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCByZW5kZXJHcmFwaGljcwogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gY29udGV4dCB7Q29udGV4dDJEfQogKi8KUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljcyA9IGZ1bmN0aW9uKGdyYXBoaWNzLCBjb250ZXh0KQp7Cgl2YXIgd29ybGRBbHBoYSA9IGdyYXBoaWNzLndvcmxkQWxwaGE7CgoJZm9yICh2YXIgaT0wOyBpIDwgZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsgaSsrKQoJewoJCXZhciBkYXRhID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhW2ldOwoJCXZhciBwb2ludHMgPSBkYXRhLnBvaW50czsKCgkJY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yID0gJyMnICsgKCcwMDAwMCcgKyAoIGRhdGEubGluZUNvbG9yIHwgMCkudG9TdHJpbmcoMTYpKS5zdWJzdHIoLTYpOwoKCQljb250ZXh0LmxpbmVXaWR0aCA9IGRhdGEubGluZVdpZHRoOwoKCQlpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5QT0xZKQoJCXsKCQkJY29udGV4dC5iZWdpblBhdGgoKTsKCgkJCWNvbnRleHQubW92ZVRvKHBvaW50c1swXSwgcG9pbnRzWzFdKTsKCgkJCWZvciAodmFyIGo9MTsgaiA8IHBvaW50cy5sZW5ndGgvMjsgaisrKQoJCQl7CgkJCQljb250ZXh0LmxpbmVUbyhwb2ludHNbaiAqIDJdLCBwb2ludHNbaiAqIDIgKyAxXSk7CgkJCX0KCgkgICAgICAJLy8gaWYgdGhlIGZpcnN0IGFuZCBsYXN0IHBvaW50IGFyZSB0aGUgc2FtZSBjbG9zZSB0aGUgcGF0aCAtIG11Y2ggbmVhdGVyIDopCgkgICAgICAJaWYocG9pbnRzWzBdID09IHBvaW50c1twb2ludHMubGVuZ3RoLTJdICYmIHBvaW50c1sxXSA9PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0xXSkKCSAgICAgIAl7CgkgICAgICAJCWNvbnRleHQuY2xvc2VQYXRoKCk7CgkgICAgICAJfQoKCQkJaWYoZGF0YS5maWxsKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5maWxsQWxwaGEgKiB3b3JsZEFscGhhOwoJCQkJY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmZpbGxDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKICAgICAgCQkJY29udGV4dC5maWxsKCk7CgkJCX0KCQkJaWYoZGF0YS5saW5lV2lkdGgpCgkJCXsKCQkJCWNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgIAkJCWNvbnRleHQuc3Ryb2tlKCk7CgkJCX0KCQl9CgkJZWxzZSBpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5SRUNUKQoJCXsKCgkJCWlmKGRhdGEuZmlsbENvbG9yIHx8IGRhdGEuZmlsbENvbG9yID09PSAwKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5maWxsQWxwaGEgKiB3b3JsZEFscGhhOwoJCQkJY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmZpbGxDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKCQkJCWNvbnRleHQuZmlsbFJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKCgkJCX0KCQkJaWYoZGF0YS5saW5lV2lkdGgpCgkJCXsKCQkJCWNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CgkJCQljb250ZXh0LnN0cm9rZVJlY3QocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwgcG9pbnRzWzNdKTsKCQkJfQoKCQl9CgkJZWxzZSBpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5DSVJDKQoJCXsKCQkJLy8gVE9ETyAtIG5lZWQgdG8gYmUgVW5kZWZpbmVkIQogICAgICAJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgkJCWNvbnRleHQuYXJjKHBvaW50c1swXSwgcG9pbnRzWzFdLCBwb2ludHNbMl0sMCwyKk1hdGguUEkpOwoJCQljb250ZXh0LmNsb3NlUGF0aCgpOwoKCQkJaWYoZGF0YS5maWxsKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5maWxsQWxwaGEgKiB3b3JsZEFscGhhOwoJCQkJY29udGV4dC5maWxsU3R5bGUgPSBjb2xvciA9ICcjJyArICgnMDAwMDAnICsgKCBkYXRhLmZpbGxDb2xvciB8IDApLnRvU3RyaW5nKDE2KSkuc3Vic3RyKC02KTsKICAgICAgCQkJY29udGV4dC5maWxsKCk7CgkJCX0KCQkJaWYoZGF0YS5saW5lV2lkdGgpCgkJCXsKCQkJCWNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkYXRhLmxpbmVBbHBoYSAqIHdvcmxkQWxwaGE7CiAgICAgIAkJCWNvbnRleHQuc3Ryb2tlKCk7CgkJCX0KCQl9CgkJZWxzZSBpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5FTElQKQoJCXsKCgkJCS8vIGVsaXBzZSBjb2RlIHRha2VuIGZyb206IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xdWVzdGlvbnMvMjE3Mjc5OC9ob3ctdG8tZHJhdy1hbi1vdmFsLWluLWh0bWw1LWNhbnZhcwoKCQkJdmFyIGVsaXBzZURhdGEgPSAgZGF0YS5wb2ludHM7CgoJCQl2YXIgdyA9IGVsaXBzZURhdGFbMl0gKiAyOwoJCQl2YXIgaCA9IGVsaXBzZURhdGFbM10gKiAyOwoKCQkJdmFyIHggPSBlbGlwc2VEYXRhWzBdIC0gdy8yOwoJCQl2YXIgeSA9IGVsaXBzZURhdGFbMV0gLSBoLzI7CgogICAgICAJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgoJCQl2YXIga2FwcGEgPSAuNTUyMjg0OCwKCQkJb3ggPSAodyAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IGhvcml6b250YWwKCQkJb3kgPSAoaCAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IHZlcnRpY2FsCgkJCXhlID0geCArIHcsICAgICAgICAgICAvLyB4LWVuZAoJCQl5ZSA9IHkgKyBoLCAgICAgICAgICAgLy8geS1lbmQKCQkJeG0gPSB4ICsgdyAvIDIsICAgICAgIC8vIHgtbWlkZGxlCgkJCXltID0geSArIGggLyAyOyAgICAgICAvLyB5LW1pZGRsZQoKCQkJY29udGV4dC5tb3ZlVG8oeCwgeW0pOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeCwgeW0gLSBveSwgeG0gLSBveCwgeSwgeG0sIHkpOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CgkJCWNvbnRleHQuYmV6aWVyQ3VydmVUbyh4ZSwgeW0gKyBveSwgeG0gKyBveCwgeWUsIHhtLCB5ZSk7CgkJCWNvbnRleHQuYmV6aWVyQ3VydmVUbyh4bSAtIG94LCB5ZSwgeCwgeW0gKyBveSwgeCwgeW0pOwoKCQkJY29udGV4dC5jbG9zZVBhdGgoKTsKCgkJCWlmKGRhdGEuZmlsbCkKCQkJewoJCQkJY29udGV4dC5nbG9iYWxBbHBoYSA9IGRhdGEuZmlsbEFscGhhICogd29ybGRBbHBoYTsKCQkJCWNvbnRleHQuZmlsbFN0eWxlID0gY29sb3IgPSAnIycgKyAoJzAwMDAwJyArICggZGF0YS5maWxsQ29sb3IgfCAwKS50b1N0cmluZygxNikpLnN1YnN0cigtNik7CiAgICAgIAkJCWNvbnRleHQuZmlsbCgpOwoJCQl9CgkJCWlmKGRhdGEubGluZVdpZHRoKQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGF0YS5saW5lQWxwaGEgKiB3b3JsZEFscGhhOwogICAgICAJCQljb250ZXh0LnN0cm9rZSgpOwoJCQl9CgkJfQoKCX07Cn0KCi8qCiAqIFJlbmRlcnMgYSBncmFwaGljcyBtYXNrCiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCByZW5kZXJHcmFwaGljc01hc2sKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIGNvbnRleHQge0NvbnRleHQyRH0KICovClBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3NNYXNrID0gZnVuY3Rpb24oZ3JhcGhpY3MsIGNvbnRleHQpCnsKCXZhciB3b3JsZEFscGhhID0gZ3JhcGhpY3Mud29ybGRBbHBoYTsKCgl2YXIgbGVuID0gZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsKCWlmKGxlbiA9PT0gMClyZXR1cm47CgoJaWYobGVuID4gMSkKCXsKCQlsZW4gPSAxOwoJCWNvbnNvbGUubG9nKCJQaXhpLmpzIHdhcm5pbmc6IG1hc2tzIGluIGNhbnZhcyBjYW4gb25seSBtYXNrIHVzaW5nIHRoZSBmaXJzdCBwYXRoIGluIHRoZSBncmFwaGljcyBvYmplY3QiKQoJfQoKCWZvciAodmFyIGk9MDsgaSA8IDE7IGkrKykKCXsKCQl2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKCQl2YXIgcG9pbnRzID0gZGF0YS5wb2ludHM7CgoJCWlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLlBPTFkpCgkJewoJCQljb250ZXh0LmJlZ2luUGF0aCgpOwoJCQljb250ZXh0Lm1vdmVUbyhwb2ludHNbMF0sIHBvaW50c1sxXSk7CgoJCQlmb3IgKHZhciBqPTE7IGogPCBwb2ludHMubGVuZ3RoLzI7IGorKykKCQkJewoJCQkJY29udGV4dC5saW5lVG8ocG9pbnRzW2ogKiAyXSwgcG9pbnRzW2ogKiAyICsgMV0pOwoJCQl9CgoJICAgICAgCS8vIGlmIHRoZSBmaXJzdCBhbmQgbGFzdCBwb2ludCBhcmUgdGhlIHNhbWUgY2xvc2UgdGhlIHBhdGggLSBtdWNoIG5lYXRlciA6KQoJICAgICAgCWlmKHBvaW50c1swXSA9PSBwb2ludHNbcG9pbnRzLmxlbmd0aC0yXSAmJiBwb2ludHNbMV0gPT0gcG9pbnRzW3BvaW50cy5sZW5ndGgtMV0pCgkgICAgICAJewoJICAgICAgCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJICAgICAgCX0KCgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuUkVDVCkKCQl7CgkJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgkJCWNvbnRleHQucmVjdChwb2ludHNbMF0sIHBvaW50c1sxXSwgcG9pbnRzWzJdLCBwb2ludHNbM10pOwoJCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJCX0KCQllbHNlIGlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLkNJUkMpCgkJewoJCQkvLyBUT0RPIC0gbmVlZCB0byBiZSBVbmRlZmluZWQhCiAgICAgIAkJY29udGV4dC5iZWdpblBhdGgoKTsKCQkJY29udGV4dC5hcmMocG9pbnRzWzBdLCBwb2ludHNbMV0sIHBvaW50c1syXSwwLDIqTWF0aC5QSSk7CgkJCWNvbnRleHQuY2xvc2VQYXRoKCk7CgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuRUxJUCkKCQl7CgoJCQkvLyBlbGlwc2UgY29kZSB0YWtlbiBmcm9tOiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vcXVlc3Rpb25zLzIxNzI3OTgvaG93LXRvLWRyYXctYW4tb3ZhbC1pbi1odG1sNS1jYW52YXMKCQkJdmFyIGVsaXBzZURhdGEgPSAgZGF0YS5wb2ludHM7CgoJCQl2YXIgdyA9IGVsaXBzZURhdGFbMl0gKiAyOwoJCQl2YXIgaCA9IGVsaXBzZURhdGFbM10gKiAyOwoKCQkJdmFyIHggPSBlbGlwc2VEYXRhWzBdIC0gdy8yOwoJCQl2YXIgeSA9IGVsaXBzZURhdGFbMV0gLSBoLzI7CgogICAgICAJCWNvbnRleHQuYmVnaW5QYXRoKCk7CgoJCQl2YXIga2FwcGEgPSAuNTUyMjg0OCwKCQkJb3ggPSAodyAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IGhvcml6b250YWwKCQkJb3kgPSAoaCAvIDIpICoga2FwcGEsIC8vIGNvbnRyb2wgcG9pbnQgb2Zmc2V0IHZlcnRpY2FsCgkJCXhlID0geCArIHcsICAgICAgICAgICAvLyB4LWVuZAoJCQl5ZSA9IHkgKyBoLCAgICAgICAgICAgLy8geS1lbmQKCQkJeG0gPSB4ICsgdyAvIDIsICAgICAgIC8vIHgtbWlkZGxlCgkJCXltID0geSArIGggLyAyOyAgICAgICAvLyB5LW1pZGRsZQoKCQkJY29udGV4dC5tb3ZlVG8oeCwgeW0pOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeCwgeW0gLSBveSwgeG0gLSBveCwgeSwgeG0sIHkpOwoJCQljb250ZXh0LmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CgkJCWNvbnRleHQuYmV6aWVyQ3VydmVUbyh4ZSwgeW0gKyBveSwgeG0gKyBveCwgeWUsIHhtLCB5ZSk7CgkJCWNvbnRleHQuYmV6aWVyQ3VydmVUbyh4bSAtIG94LCB5ZSwgeCwgeW0gKyBveSwgeCwgeW0pOwoJCQljb250ZXh0LmNsb3NlUGF0aCgpOwoJCX0KCgoJfTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgovKioKICogdGhlIENhbnZhc1JlbmRlcmVyIGRyYXdzIHRoZSBzdGFnZSBhbmQgYWxsIGl0cyBjb250ZW50IG9udG8gYSAyZCBjYW52YXMuIFRoaXMgcmVuZGVyZXIgc2hvdWxkIGJlIHVzZWQgZm9yIGJyb3dzZXJzIHRoYXQgZG8gbm90IHN1cHBvcnQgd2ViR0wuCiAqIERvbnQgZm9yZ2V0IHRvIGFkZCB0aGUgdmlldyB0byB5b3VyIERPTSBvciB5b3Ugd2lsbCBub3Qgc2VlIGFueXRoaW5nIDopCiAqCiAqIEBjbGFzcyBDYW52YXNSZW5kZXJlcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHdpZHRoPTAge051bWJlcn0gdGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gaGVpZ2h0PTAge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIHZpZXcge0NhbnZhc30gdGhlIGNhbnZhcyB0byB1c2UgYXMgYSB2aWV3LCBvcHRpb25hbAogKiBAcGFyYW0gdHJhbnNwYXJlbnQ9ZmFsc2Uge0Jvb2xlYW59IHRoZSB0cmFuc3BhcmVuY3kgb2YgdGhlIHJlbmRlciB2aWV3LCBkZWZhdWx0IGZhbHNlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgdmlldywgdHJhbnNwYXJlbnQpCnsKCXRoaXMudHJhbnNwYXJlbnQgPSB0cmFuc3BhcmVudDsKCgkvKioKCSAqIFRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIHZpZXcKCSAqCgkgKiBAcHJvcGVydHkgd2lkdGgKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgODAwCgkgKi8KCXRoaXMud2lkdGggPSB3aWR0aCB8fCA4MDA7CgoJLyoqCgkgKiBUaGUgaGVpZ2h0IG9mIHRoZSBjYW52YXMgdmlldwoJICoKCSAqIEBwcm9wZXJ0eSBoZWlnaHQKCSAqIEB0eXBlIE51bWJlcgoJICogQGRlZmF1bHQgNjAwCgkgKi8KCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDYwMDsKCgkvKioKCSAqIFRoZSBjYW52YXMgZWxlbWVudCB0aGF0IHRoZSBldmVyeXRoaW5nIGlzIGRyYXduIHRvCgkgKgoJICogQHByb3BlcnR5IHZpZXcKCSAqIEB0eXBlIENhbnZhcwoJICovCgl0aGlzLnZpZXcgPSB2aWV3IHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7CgoJLyoqCgkgKiBUaGUgY2FudmFzIGNvbnRleHQgdGhhdCB0aGUgZXZlcnl0aGluZyBpcyBkcmF3biB0bwoJICogQHByb3BlcnR5IGNvbnRleHQKCSAqIEB0eXBlIENhbnZhcyAyZCBDb250ZXh0CgkgKi8KCXRoaXMuY29udGV4dCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCIyZCIpOwoKCXRoaXMucmVmcmVzaCA9IHRydWU7CgkvLyBoYWNrIHRvIGVuYWJsZSBzb21lIGhhcmR3YXJlIGFjY2VsZXJhdGlvbiEKCS8vdGhpcy52aWV3LnN0eWxlWyJ0cmFuc2Zvcm0iXSA9ICJ0cmFuc2xhdGV6KDApIjsKCQogICAgdGhpcy52aWV3LndpZHRoID0gdGhpcy53aWR0aDsKCXRoaXMudmlldy5oZWlnaHQgPSB0aGlzLmhlaWdodDsgIAoJdGhpcy5jb3VudCA9IDA7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5DYW52YXNSZW5kZXJlcjsKCi8qKgogKiBSZW5kZXJzIHRoZSBzdGFnZSB0byBpdHMgY2FudmFzIHZpZXcKICoKICogQG1ldGhvZCByZW5kZXIKICogQHBhcmFtIHN0YWdlIHtTdGFnZX0gdGhlIFN0YWdlIGVsZW1lbnQgdG8gYmUgcmVuZGVyZWQKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YWdlKQp7CgkKCS8vc3RhZ2UuX19jaGlsZHJlbkFkZGVkID0gW107CgkvL3N0YWdlLl9fY2hpbGRyZW5SZW1vdmVkID0gW107CgkKCS8vIHVwZGF0ZSB0ZXh0dXJlcyBpZiBuZWVkIGJlCglQSVhJLnRleHR1cmVzVG9VcGRhdGUgPSBbXTsKCVBJWEkudGV4dHVyZXNUb0Rlc3Ryb3kgPSBbXTsKCQoJUElYSS52aXNpYmxlQ291bnQrKzsKCXN0YWdlLnVwZGF0ZVRyYW5zZm9ybSgpOwoJCgkvLyB1cGRhdGUgdGhlIGJhY2tncm91bmQgY29sb3IKCWlmKHRoaXMudmlldy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IhPXN0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZyAmJiAhdGhpcy50cmFuc3BhcmVudCl0aGlzLnZpZXcuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gc3RhZ2UuYmFja2dyb3VuZENvbG9yU3RyaW5nOwoKCXRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOyAKCXRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpCiAgICB0aGlzLnJlbmRlckRpc3BsYXlPYmplY3Qoc3RhZ2UpOwogICAgLy9hcwogICAKICAgIC8vIHJ1biBpbnRlcmFjdGlvbiEKCWlmKHN0YWdlLmludGVyYWN0aXZlKQoJewoJCS8vbmVlZCB0byBhZGQgc29tZSBldmVudHMhCgkJaWYoIXN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkKQoJCXsKCQkJc3RhZ2UuX2ludGVyYWN0aXZlRXZlbnRzQWRkZWQgPSB0cnVlOwoJCQlzdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMpOwoJCX0KCX0KCQoJLy8gcmVtb3ZlIGZyYW1lIHVwZGF0ZXMuLgoJaWYoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQoJewoJCVBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMgPSBbXTsKCX0KCQoJCn0KCi8qKgogKiByZXNpemVzIHRoZSBjYW52YXMgdmlldyB0byB0aGUgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQKICoKICogQG1ldGhvZCByZXNpemUKICogQHBhcmFtIHdpZHRoIHtOdW1iZXJ9IHRoZSBuZXcgd2lkdGggb2YgdGhlIGNhbnZhcyB2aWV3CiAqIEBwYXJhbSBoZWlnaHQge051bWJlcn0gdGhlIG5ldyBoZWlnaHQgb2YgdGhlIGNhbnZhcyB2aWV3CiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7Cgl0aGlzLndpZHRoID0gd2lkdGg7Cgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCQoJdGhpcy52aWV3LndpZHRoID0gd2lkdGg7Cgl0aGlzLnZpZXcuaGVpZ2h0ID0gaGVpZ2h0Owp9CgovKioKICogUmVuZGVycyBhIGRpc3BsYXkgb2JqZWN0CiAqCiAqIEBtZXRob2QgcmVuZGVyRGlzcGxheU9iamVjdAogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXlPYmplY3QgdG8gcmVuZGVyCiAqIEBwcml2YXRlCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJEaXNwbGF5T2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJLy8gbm8gbG9nZXIgcmVjdXJyc2l2ZSEKCXZhciB0cmFuc2Zvcm07Cgl2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCQoJY29udGV4dC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPSAnc291cmNlLW92ZXInOwoJCgkvLyBvbmUgdGhlIGRpc3BsYXkgb2JqZWN0IGhpdHMgdGhpcy4gd2UgY2FuIGJyZWFrIHRoZSBsb29wCQoJdmFyIHRlc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwoJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuZmlyc3Q7CgkKCWRvCQoJewoJCXRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CgkJCgkJaWYoIWRpc3BsYXlPYmplY3QudmlzaWJsZSkKCQl7CgkJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwoJCQljb250aW51ZTsKCQl9CgkJCgkJaWYoIWRpc3BsYXlPYmplY3QucmVuZGVyYWJsZSkKCQl7CgkJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCQkJY29udGludWU7CgkJfQoJCQoJCWlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCQl7CgkJCQkKCQkJdmFyIGZyYW1lID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lOwoJCQkKCQkJaWYoZnJhbWUgJiYgZnJhbWUud2lkdGggJiYgZnJhbWUuaGVpZ2h0KQoJCQl7CgkJCQljb250ZXh0Lmdsb2JhbEFscGhhID0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhOwoJCQkJCgkJCQljb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKTsKCQkJCQkKCQkJCWNvbnRleHQuZHJhd0ltYWdlKGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsIAoJCQkJCQkJCSAgIGZyYW1lLngsCgkJCQkJCQkJICAgZnJhbWUueSwKCQkJCQkJCQkgICBmcmFtZS53aWR0aCwKCQkJCQkJCQkgICBmcmFtZS5oZWlnaHQsCgkJCQkJCQkJICAgKGRpc3BsYXlPYmplY3QuYW5jaG9yLngpICogLWZyYW1lLndpZHRoLCAKCQkJCQkJCQkgICAoZGlzcGxheU9iamVjdC5hbmNob3IueSkgKiAtZnJhbWUuaGVpZ2h0LAoJCQkJCQkJCSAgIGZyYW1lLndpZHRoLAoJCQkJCQkJCSAgIGZyYW1lLmhlaWdodCk7CgkJCX0JCQkJCSAgIAoJICAgCX0KCSAgIAllbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQoJCXsKCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSkKCQkJdGhpcy5yZW5kZXJTdHJpcChkaXNwbGF5T2JqZWN0KTsKCQl9CgkJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5UaWxpbmdTcHJpdGUpCgkJewoJCQljb250ZXh0LnNldFRyYW5zZm9ybSh0cmFuc2Zvcm1bMF0sIHRyYW5zZm9ybVszXSwgdHJhbnNmb3JtWzFdLCB0cmFuc2Zvcm1bNF0sIHRyYW5zZm9ybVsyXSwgdHJhbnNmb3JtWzVdKQoJCQl0aGlzLnJlbmRlclRpbGluZ1Nwcml0ZShkaXNwbGF5T2JqZWN0KTsKCQl9CgkJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5DdXN0b21SZW5kZXJhYmxlKQoJCXsKCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSk7CgkJCWRpc3BsYXlPYmplY3QucmVuZGVyQ2FudmFzKHRoaXMpOwoJCX0KCQllbHNlIGlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkdyYXBoaWNzKQoJCXsKCQkJY29udGV4dC5zZXRUcmFuc2Zvcm0odHJhbnNmb3JtWzBdLCB0cmFuc2Zvcm1bM10sIHRyYW5zZm9ybVsxXSwgdHJhbnNmb3JtWzRdLCB0cmFuc2Zvcm1bMl0sIHRyYW5zZm9ybVs1XSkKCQkJUElYSS5DYW52YXNHcmFwaGljcy5yZW5kZXJHcmFwaGljcyhkaXNwbGF5T2JqZWN0LCBjb250ZXh0KTsKCQl9CgkJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5GaWx0ZXJCbG9jaykKCQl7CgkJCWlmKGRpc3BsYXlPYmplY3QuZGF0YSBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCiAJCQl7CgkJCQl2YXIgbWFzayA9IGRpc3BsYXlPYmplY3QuZGF0YTsKCgkJCQlpZihkaXNwbGF5T2JqZWN0Lm9wZW4pCgkJCQl7CgkJCQkJY29udGV4dC5zYXZlKCk7CgkJCQkJCgkJCQkJdmFyIGNhY2hlQWxwaGEgPSBtYXNrLmFscGhhOwoJCQkJCXZhciBtYXNrVHJhbnNmb3JtID0gbWFzay53b3JsZFRyYW5zZm9ybTsKCQkJCQkKCQkJCQljb250ZXh0LnNldFRyYW5zZm9ybShtYXNrVHJhbnNmb3JtWzBdLCBtYXNrVHJhbnNmb3JtWzNdLCBtYXNrVHJhbnNmb3JtWzFdLCBtYXNrVHJhbnNmb3JtWzRdLCBtYXNrVHJhbnNmb3JtWzJdLCBtYXNrVHJhbnNmb3JtWzVdKQoJCQkJCQoJCQkJCW1hc2sud29ybGRBbHBoYSA9IDAuNTsKCQkJCQkKCQkJCQljb250ZXh0LndvcmxkQWxwaGEgPSAwOwoJCQkJCQoJCQkJCVBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3NNYXNrKG1hc2ssIGNvbnRleHQpOwoJCQkJCWNvbnRleHQuY2xpcCgpOwoJCQkJCQoJCQkJCW1hc2sud29ybGRBbHBoYSA9IGNhY2hlQWxwaGE7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJY29udGV4dC5yZXN0b3JlKCk7CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBvbmx5IG1hc2tzIHN1cHBvcnRlZCByaWdodCBub3chCgkJCX0KCQl9CgkvLwljb3VudCsrCgkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwoJCQoJCQoJfQoJd2hpbGUoZGlzcGxheU9iamVjdCAhPSB0ZXN0T2JqZWN0KQoKCQp9CgovKioKICogUmVuZGVycyBhIGZsYXQgc3RyaXAKICoKICogQG1ldGhvZCByZW5kZXJTdHJpcEZsYXQKICogQHBhcmFtIHN0cmlwIHtTdHJpcH0gVGhlIFN0cmlwIHRvIHJlbmRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyU3RyaXBGbGF0ID0gZnVuY3Rpb24oc3RyaXApCnsKCXZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoJdmFyIHZlcnRpY2llcyA9IHN0cmlwLnZlcnRpY2llczsKCXZhciB1dnMgPSBzdHJpcC51dnM7CgkKCXZhciBsZW5ndGggPSB2ZXJ0aWNpZXMubGVuZ3RoLzI7Cgl0aGlzLmNvdW50Kys7CgkKCWNvbnRleHQuYmVnaW5QYXRoKCk7Cglmb3IgKHZhciBpPTE7IGkgPCBsZW5ndGgtMjsgaSsrKSAKCXsKCQkKCQkvLyBkcmF3IHNvbWUgdHJpYW5nbGVzIQoJCXZhciBpbmRleCA9IGkqMjsKCQkKCQkgdmFyIHgwID0gdmVydGljaWVzW2luZGV4XSwgICB4MSA9IHZlcnRpY2llc1tpbmRleCsyXSwgeDIgPSB2ZXJ0aWNpZXNbaW5kZXgrNF07CiAJCSB2YXIgeTAgPSB2ZXJ0aWNpZXNbaW5kZXgrMV0sIHkxID0gdmVydGljaWVzW2luZGV4KzNdLCB5MiA9IHZlcnRpY2llc1tpbmRleCs1XTsKIAkJIAoJCWNvbnRleHQubW92ZVRvKHgwLCB5MCk7CgkJY29udGV4dC5saW5lVG8oeDEsIHkxKTsKCQljb250ZXh0LmxpbmVUbyh4MiwgeTIpOwoJCQoJfTsJCgkKCWNvbnRleHQuZmlsbFN0eWxlID0gIiNGRjAwMDAiOwoJY29udGV4dC5maWxsKCk7Cgljb250ZXh0LmNsb3NlUGF0aCgpOwp9CgovKioKICogUmVuZGVycyBhIHRpbGluZyBzcHJpdGUKICoKICogQG1ldGhvZCByZW5kZXJUaWxpbmdTcHJpdGUKICogQHBhcmFtIHNwcml0ZSB7VGlsaW5nU3ByaXRlfSBUaGUgdGlsaW5nc3ByaXRlIHRvIHJlbmRlcgogKiBAcHJpdmF0ZQogKi8KUElYSS5DYW52YXNSZW5kZXJlci5wcm90b3R5cGUucmVuZGVyVGlsaW5nU3ByaXRlID0gZnVuY3Rpb24oc3ByaXRlKQp7Cgl2YXIgY29udGV4dCA9IHRoaXMuY29udGV4dDsKCQoJY29udGV4dC5nbG9iYWxBbHBoYSA9IHNwcml0ZS53b3JsZEFscGhhOwoJCiAJaWYoIXNwcml0ZS5fX3RpbGVQYXR0ZXJuKSBzcHJpdGUuX190aWxlUGF0dGVybiA9IGNvbnRleHQuY3JlYXRlUGF0dGVybihzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsICJyZXBlYXQiKTsKIAkKCWNvbnRleHQuYmVnaW5QYXRoKCk7CgkKCXZhciB0aWxlUG9zaXRpb24gPSBzcHJpdGUudGlsZVBvc2l0aW9uOwoJdmFyIHRpbGVTY2FsZSA9IHNwcml0ZS50aWxlU2NhbGU7CgkKICAgIC8vIG9mZnNldAogICAgY29udGV4dC5zY2FsZSh0aWxlU2NhbGUueCx0aWxlU2NhbGUueSk7CiAgICBjb250ZXh0LnRyYW5zbGF0ZSh0aWxlUG9zaXRpb24ueCwgdGlsZVBvc2l0aW9uLnkpOwogCQoJY29udGV4dC5maWxsU3R5bGUgPSBzcHJpdGUuX190aWxlUGF0dGVybjsKCWNvbnRleHQuZmlsbFJlY3QoLXRpbGVQb3NpdGlvbi54LC10aWxlUG9zaXRpb24ueSxzcHJpdGUud2lkdGggLyB0aWxlU2NhbGUueCwgc3ByaXRlLmhlaWdodCAvIHRpbGVTY2FsZS55KTsKCQoJY29udGV4dC5zY2FsZSgxL3RpbGVTY2FsZS54LCAxL3RpbGVTY2FsZS55KTsKICAgIGNvbnRleHQudHJhbnNsYXRlKC10aWxlUG9zaXRpb24ueCwgLXRpbGVQb3NpdGlvbi55KTsKICAgIAogICAgY29udGV4dC5jbG9zZVBhdGgoKTsKfQoKLyoqCiAqIFJlbmRlcnMgYSBzdHJpcAogKgogKiBAbWV0aG9kIHJlbmRlclN0cmlwCiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBTdHJpcCB0byByZW5kZXIKICogQHByaXZhdGUKICovClBJWEkuQ2FudmFzUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlclN0cmlwID0gZnVuY3Rpb24oc3RyaXApCnsKCXZhciBjb250ZXh0ID0gdGhpcy5jb250ZXh0OwoKCS8vIGRyYXcgdHJpYW5nbGVzISEKCXZhciB2ZXJ0aWNpZXMgPSBzdHJpcC52ZXJ0aWNpZXM7Cgl2YXIgdXZzID0gc3RyaXAudXZzOwoJCgl2YXIgbGVuZ3RoID0gdmVydGljaWVzLmxlbmd0aC8yOwoJdGhpcy5jb3VudCsrOwoJZm9yICh2YXIgaT0xOyBpIDwgbGVuZ3RoLTI7IGkrKykgCgl7CgkJCgkJLy8gZHJhdyBzb21lIHRyaWFuZ2xlcyEKCQl2YXIgaW5kZXggPSBpKjI7CgkJCgkJIHZhciB4MCA9IHZlcnRpY2llc1tpbmRleF0sICAgeDEgPSB2ZXJ0aWNpZXNbaW5kZXgrMl0sIHgyID0gdmVydGljaWVzW2luZGV4KzRdOwogCQkgdmFyIHkwID0gdmVydGljaWVzW2luZGV4KzFdLCB5MSA9IHZlcnRpY2llc1tpbmRleCszXSwgeTIgPSB2ZXJ0aWNpZXNbaW5kZXgrNV07CiAJCSAKICAJCSB2YXIgdTAgPSB1dnNbaW5kZXhdICogc3RyaXAudGV4dHVyZS53aWR0aCwgICB1MSA9IHV2c1tpbmRleCsyXSAqIHN0cmlwLnRleHR1cmUud2lkdGgsIHUyID0gdXZzW2luZGV4KzRdKiBzdHJpcC50ZXh0dXJlLndpZHRoOwogICAJCSB2YXIgdjAgPSB1dnNbaW5kZXgrMV0qIHN0cmlwLnRleHR1cmUuaGVpZ2h0LCB2MSA9IHV2c1tpbmRleCszXSAqIHN0cmlwLnRleHR1cmUuaGVpZ2h0LCB2MiA9IHV2c1tpbmRleCs1XSogc3RyaXAudGV4dHVyZS5oZWlnaHQ7CgoKCQljb250ZXh0LnNhdmUoKTsKCQljb250ZXh0LmJlZ2luUGF0aCgpOwoJCWNvbnRleHQubW92ZVRvKHgwLCB5MCk7CgkJY29udGV4dC5saW5lVG8oeDEsIHkxKTsKCQljb250ZXh0LmxpbmVUbyh4MiwgeTIpOwoJCWNvbnRleHQuY2xvc2VQYXRoKCk7CgkJCgkJY29udGV4dC5jbGlwKCk7CgkJCgkJCiAgICAgICAgLy8gQ29tcHV0ZSBtYXRyaXggdHJhbnNmb3JtCiAgICAgICAgdmFyIGRlbHRhID0gdTAqdjEgKyB2MCp1MiArIHUxKnYyIC0gdjEqdTIgLSB2MCp1MSAtIHUwKnYyOwogICAgICAgIHZhciBkZWx0YV9hID0geDAqdjEgKyB2MCp4MiArIHgxKnYyIC0gdjEqeDIgLSB2MCp4MSAtIHgwKnYyOwogICAgICAgIHZhciBkZWx0YV9iID0gdTAqeDEgKyB4MCp1MiArIHUxKngyIC0geDEqdTIgLSB4MCp1MSAtIHUwKngyOwogICAgICAgIHZhciBkZWx0YV9jID0gdTAqdjEqeDIgKyB2MCp4MSp1MiArIHgwKnUxKnYyIC0geDAqdjEqdTIgLSB2MCp1MSp4MiAtIHUwKngxKnYyOwogICAgICAgIHZhciBkZWx0YV9kID0geTAqdjEgKyB2MCp5MiArIHkxKnYyIC0gdjEqeTIgLSB2MCp5MSAtIHkwKnYyOwogICAgICAgIHZhciBkZWx0YV9lID0gdTAqeTEgKyB5MCp1MiArIHUxKnkyIC0geTEqdTIgLSB5MCp1MSAtIHUwKnkyOwogICAgICAgIHZhciBkZWx0YV9mID0gdTAqdjEqeTIgKyB2MCp5MSp1MiArIHkwKnUxKnYyIC0geTAqdjEqdTIgLSB2MCp1MSp5MiAtIHUwKnkxKnYyOwoJCQoJCQoJCQoJCSAgICAKICAgICAgICBjb250ZXh0LnRyYW5zZm9ybShkZWx0YV9hL2RlbHRhLCBkZWx0YV9kL2RlbHRhLAogICAgICAgICAgICAgICAgICAgICAgZGVsdGFfYi9kZWx0YSwgZGVsdGFfZS9kZWx0YSwKICAgICAgICAgICAgICAgICAgICAgIGRlbHRhX2MvZGVsdGEsIGRlbHRhX2YvZGVsdGEpOwogICAgICAgICAgICAgICAgIAoJCWNvbnRleHQuZHJhd0ltYWdlKHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuc291cmNlLCAwLCAwKTsKCSAgCWNvbnRleHQucmVzdG9yZSgpOwoJfTsKCQp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqIEBhdXRob3IgUmljaGFyZCBEYXZleSBodHRwOi8vd3d3LnBob3RvbnN0b3JtLmNvbSBAcGhvdG9uc3Rvcm0KICovCgovKioKKiBAY2xhc3MgUElYSS5QaXhpU2hhZGVyCiogQGNvbnN0cnVjdG9yCiovClBJWEkuUGl4aVNoYWRlciA9IGZ1bmN0aW9uKCkKewogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YW55fSBwcm9ncmFtIC0gVGhlIFdlYkdMIHByb2dyYW0uCiAgICAqLwogICAgdGhpcy5wcm9ncmFtOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gZnJhZ21lbnRTcmMgLSBUaGUgZnJhZ21lbnQgc2hhZGVyLgogICAgKi8KICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBbCiAgICAgICAgInByZWNpc2lvbiBsb3dwIGZsb2F0OyIsCiAgICAgICAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCiAgICAgICAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCiAgICAgICAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCiAgICAgICAgInZvaWQgbWFpbih2b2lkKSB7IiwKICAgICAgICAgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdlRleHR1cmVDb29yZCkgKiB2Q29sb3I7IiwKICAgICAgICAifSIKICAgIF07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0ZXh0dXJlQ291bnQgLSBBIGxvY2FsIHRleHR1cmUgY291bnRlciBmb3IgbXVsdGktdGV4dHVyZSBzaGFkZXJzLgogICAgKi8KICAgIHRoaXMudGV4dHVyZUNvdW50ID0gMDsKICAgIAp9CgovKioKKiBAbWV0aG9kIFBJWEkuUGl4aVNoYWRlciNpbml0CiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uKCkKewogICAgdmFyIHByb2dyYW0gPSBQSVhJLmNvbXBpbGVQcm9ncmFtKHRoaXMudmVydGV4U3JjIHx8IFBJWEkuUGl4aVNoYWRlci5kZWZhdWx0VmVydGV4U3JjLCB0aGlzLmZyYWdtZW50U3JjKQogICAgCiAgICB2YXIgZ2wgPSBQSVhJLmdsOwoKICAgIGdsLnVzZVByb2dyYW0ocHJvZ3JhbSk7CiAgICAKICAgIC8vIGdldCBhbmQgc3RvcmUgdGhlIHVuaWZvcm1zIGZvciB0aGUgc2hhZGVyCiAgICB0aGlzLnVTYW1wbGVyID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJ1U2FtcGxlciIpOwogICAgdGhpcy5wcm9qZWN0aW9uVmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJwcm9qZWN0aW9uVmVjdG9yIik7CiAgICB0aGlzLm9mZnNldFZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAib2Zmc2V0VmVjdG9yIik7CiAgICAvLyB0aGlzLmRpbWVuc2lvbnMgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgImRpbWVuc2lvbnMiKTsKICAgIAogICAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgYXR0cmlidXRlcwogICAgdGhpcy5hVmVydGV4UG9zaXRpb24gPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAiYVZlcnRleFBvc2l0aW9uIik7CiAgICB0aGlzLmNvbG9yQXR0cmlidXRlID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFDb2xvciIpOwogICAgdGhpcy5hVGV4dHVyZUNvb3JkID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFUZXh0dXJlQ29vcmQiKTsKICAgICAgCiAgICAvLyBhZGQgdGhvc2UgY3VzdG9tIHNoYWRlcnMhCiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy51bmlmb3JtcykKICAgIHsKICAgICAgICAvLyBnZXQgdGhlIHVuaWZvcm0gbG9jYXRpb25zLi4KICAgICAgICB0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sIGtleSk7CiAgICB9CiAgCiAgICB0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwp9CgovKioKKiBVcGRhdGVzIHRoZSBzaGFkZXIgdW5pZm9ybSB2YWx1ZXMuCiogVW5pZm9ybXMgYXJlIHNwZWNpZmllZCBpbiB0aGUgR0xTTF9FUyBTcGVjaWZpY2F0aW9uOiBodHRwOi8vd3d3Lmtocm9ub3Mub3JnL3JlZ2lzdHJ5L3dlYmdsL3NwZWNzL2xhdGVzdC8xLjAvCiogaHR0cDovL3d3dy5raHJvbm9zLm9yZy9yZWdpc3RyeS9nbGVzL3NwZWNzLzIuMC9HTFNMX0VTX1NwZWNpZmljYXRpb25fMS4wLjE3LnBkZgoqCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjc3luY1VuaWZvcm1zCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuc3luY1VuaWZvcm1zID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnRleHR1cmVDb3VudCA9IDE7CgogICAgdmFyIGdsID0gUElYSS5nbDsKICAgIAogICAgZm9yICh2YXIga2V5IGluIHRoaXMudW5pZm9ybXMpIAogICAgewogICAgICAgIHZhciB0eXBlID0gdGhpcy51bmlmb3Jtc1trZXldLnR5cGU7CiAgICAgICAgdmFyIHRyYW5zcG9zZSA9IGZhbHNlOwoKICAgICAgICBpZiAodGhpcy51bmlmb3Jtc1trZXldLnRyYW5zcG9zZSkKICAgICAgICB7CiAgICAgICAgICAgIHRyYW5zcG9zZSA9IHRoaXMudW5pZm9ybXNba2V5XS50cmFuc3Bvc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZSA9PSAiMWYiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMWYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGZsb2F0IHgpOwogICAgICAgICAgICBnbC51bmlmb3JtMWYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiMWZ2IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTFmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEZsb2F0MzJBcnJheSB2KTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMWZ2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgc2VxdWVuY2U8R0xmbG9hdD4gdik7CiAgICAgICAgICAgIGdsLnVuaWZvcm0xZnYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiMWkiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMWkoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGludCB4KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTFpKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjFpdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0xaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBJbnQzMkFycmF5IHYpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0xaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBzZXF1ZW5jZTxsb25nPiB2KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTFpKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjJmIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTJmKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xmbG9hdCB4LCBHTGZsb2F0IHkpOwogICAgICAgICAgICBnbC51bmlmb3JtMmYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLngsIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS55KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiMmZ2IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTJmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEZsb2F0MzJBcnJheSB2KTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMmZ2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgc2VxdWVuY2U8R0xmbG9hdD4gdik7CiAgICAgICAgICAgIGdsLnVuaWZvcm0yZnYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiMmkiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtMmkoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGludCB4LCBHTGludCB5KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTJpKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS54LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjJpdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0yaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBJbnQzMkFycmF5IHYpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0yaXYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBzZXF1ZW5jZTxsb25nPiB2KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTJpdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICIzZiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zZihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMZmxvYXQgeCwgR0xmbG9hdCB5LCBHTGZsb2F0IHopOwogICAgICAgICAgICBnbC51bmlmb3JtM2YodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLngsIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS55LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjNmdiIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm0zZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBGbG9hdDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTNmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPEdMZmxvYXQ+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtM2Z2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjNpIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTNpKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xpbnQgeCwgR0xpbnQgeSwgR0xpbnQgeik7CiAgICAgICAgICAgIGdsLnVuaWZvcm0zaSh0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueCwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnksIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS56KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiM2l2IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTNpdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEludDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTNpdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPGxvbmc+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtM2l2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIjRmIikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRmKFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xmbG9hdCB4LCBHTGZsb2F0IHksIEdMZmxvYXQgeiwgR0xmbG9hdCB3KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTRmKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS54LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueSwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnosIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS53KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiNGZ2IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEZsb2F0MzJBcnJheSB2KTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtNGZ2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgc2VxdWVuY2U8R0xmbG9hdD4gdik7CiAgICAgICAgICAgIGdsLnVuaWZvcm00ZnYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiNGkiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtNGkoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGludCB4LCBHTGludCB5LCBHTGludCB6LCBHTGludCB3KTsKICAgICAgICAgICAgZ2wudW5pZm9ybTRpKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS54LCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUueSwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLnosIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS53KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAiNGl2IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRpdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEludDMyQXJyYXkgdik7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybTRpdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIHNlcXVlbmNlPGxvbmc+IHYpOwogICAgICAgICAgICBnbC51bmlmb3JtNGl2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gIm1hdDIiKQogICAgICAgIHsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtTWF0cml4MmZ2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xib29sZWFuIHRyYW5zcG9zZSwgRmxvYXQzMkFycmF5IHZhbHVlKTsKICAgICAgICAgICAgLy8gdm9pZCB1bmlmb3JtTWF0cml4MmZ2KFdlYkdMVW5pZm9ybUxvY2F0aW9uPyBsb2NhdGlvbiwgR0xib29sZWFuIHRyYW5zcG9zZSwgc2VxdWVuY2U8R0xmbG9hdD4gdmFsdWUpOwogICAgICAgICAgICBnbC51bmlmb3JtTWF0cml4MmZ2KHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRyYW5zcG9zZSwgdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAibWF0MyIpCiAgICAgICAgewogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm1NYXRyaXgzZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGJvb2xlYW4gdHJhbnNwb3NlLCBGbG9hdDMyQXJyYXkgdmFsdWUpOwogICAgICAgICAgICAvLyB2b2lkIHVuaWZvcm1NYXRyaXgzZnYoV2ViR0xVbmlmb3JtTG9jYXRpb24/IGxvY2F0aW9uLCBHTGJvb2xlYW4gdHJhbnNwb3NlLCBzZXF1ZW5jZTxHTGZsb2F0PiB2YWx1ZSk7CiAgICAgICAgICAgIGdsLnVuaWZvcm1NYXRyaXgzZnYodGhpcy51bmlmb3Jtc1trZXldLnVuaWZvcm1Mb2NhdGlvbiwgdHJhbnNwb3NlLCB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICJtYXQ0IikKICAgICAgICB7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybU1hdHJpeDRmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMYm9vbGVhbiB0cmFuc3Bvc2UsIEZsb2F0MzJBcnJheSB2YWx1ZSk7CiAgICAgICAgICAgIC8vIHZvaWQgdW5pZm9ybU1hdHJpeDRmdihXZWJHTFVuaWZvcm1Mb2NhdGlvbj8gbG9jYXRpb24sIEdMYm9vbGVhbiB0cmFuc3Bvc2UsIHNlcXVlbmNlPEdMZmxvYXQ+IHZhbHVlKTsKICAgICAgICAgICAgZ2wudW5pZm9ybU1hdHJpeDRmdih0aGlzLnVuaWZvcm1zW2tleV0udW5pZm9ybUxvY2F0aW9uLCB0cmFuc3Bvc2UsIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZSk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gInNhbXBsZXIyRCIpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy51bmlmb3Jtc1trZXldLnZhbHVlICYmIHRoaXMudW5pZm9ybXNba2V5XS52YWx1ZS5iYXNlVGV4dHVyZS5oYXNMb2FkZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHZhciB0ZXh0dXJlID0gdGhpcy51bmlmb3Jtc1trZXldLnZhbHVlLmJhc2VUZXh0dXJlLl9nbFRleHR1cmU7CiAgICAgICAgICAgICAgICB2YXIgaW1hZ2UgPSB0aGlzLnVuaWZvcm1zW2tleV0udmFsdWUuYmFzZVRleHR1cmUuc291cmNlOwogICAgICAgICAgICAgICAgdmFyIGZvcm1hdCA9IGdsLlJHQkE7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMudW5pZm9ybXNba2V5XS5mb3JtYXQgJiYgdGhpcy51bmlmb3Jtc1trZXldLmZvcm1hdCA9PSAnbHVtaW5hbmNlJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBmb3JtYXQgPSBnbC5MVU1JTkFOQ0U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZ2wuYWN0aXZlVGV4dHVyZShnbFsnVEVYVFVSRScgKyB0aGlzLnRleHR1cmVDb3VudF0pOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVuaWZvcm1zW2tleV0ud3JhcCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy51bmlmb3Jtc1trZXldLndyYXAgPT0gJ25vLXJlcGVhdCcgfHwgdGhpcy51bmlmb3Jtc1trZXldLndyYXAgPT09IGZhbHNlKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVHTFRleHR1cmVMaW5lYXIoZ2wsIGltYWdlLCB0ZXh0dXJlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51bmlmb3Jtc1trZXldLndyYXAgPT0gJ3JlcGVhdCcgfHwgdGhpcy51bmlmb3Jtc1trZXldLndyYXAgPT09IHRydWUpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUdMVGV4dHVyZShnbCwgaW1hZ2UsIGZvcm1hdCwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICduZWFyZXN0LXJlcGVhdCcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUdMVGV4dHVyZU5lYXJlc3RSZXBlYXQoZ2wsIGltYWdlLCB0ZXh0dXJlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51bmlmb3Jtc1trZXldLndyYXAgPT0gJ25lYXJlc3QnKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVHTFRleHR1cmVOZWFyZXN0KGdsLCBpbWFnZSwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICdhdWRpbycpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUF1ZGlvVGV4dHVyZShnbCwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudW5pZm9ybXNba2V5XS53cmFwID09ICdrZXlib2FyZCcpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZUtleWJvYXJkVGV4dHVyZShnbCwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlR0xUZXh0dXJlTGluZWFyKGdsLCBpbWFnZSwgdGV4dHVyZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZ2wudW5pZm9ybTFpKHRoaXMudW5pZm9ybXNba2V5XS51bmlmb3JtTG9jYXRpb24sIHRoaXMudGV4dHVyZUNvdW50KTsKCiAgICAgICAgICAgICAgICB0aGlzLnRleHR1cmVDb3VudCsrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCn07CgovKioKKiBCaW5kcyB0aGUgZ2l2ZW4gdGV4dHVyZSBhbmQgaW1hZ2UgZGF0YS4gVGhlIHRleHR1cmUgaXMgc2V0IHRvIFJFUEVBVC4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlR0xUZXh0dXJlCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuY3JlYXRlR0xUZXh0dXJlID0gZnVuY3Rpb24oZ2wsIGltYWdlLCBmb3JtYXQsIHRleHR1cmUpCnsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUpOwogICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBmb3JtYXQsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIGltYWdlKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NQUdfRklMVEVSLCBnbC5MSU5FQVIpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUl9NSVBNQVBfTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLlJFUEVBVCk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5SRVBFQVQpOwogICAgZ2wuZ2VuZXJhdGVNaXBtYXAoZ2wuVEVYVFVSRV8yRCk7Cn0KCi8qKgoqIEJpbmRzIHRoZSBnaXZlbiB0ZXh0dXJlIGFuZCBpbWFnZSBkYXRhLiBUaGUgdGV4dHVyZSBpcyBzZXQgdG8gQ0xBTVBfVE9fRURHRS4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlR0xUZXh0dXJlTGluZWFyCiovClBJWEkuUGl4aVNoYWRlci5wcm90b3R5cGUuY3JlYXRlR0xUZXh0dXJlTGluZWFyID0gZnVuY3Rpb24oZ2wsIGltYWdlLCB0ZXh0dXJlKQp7CiAgICBnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0ZXh0dXJlKTsKICAgIGdsLnBpeGVsU3RvcmVpKGdsLlVOUEFDS19GTElQX1lfV0VCR0wsIGZhbHNlKTsKICAgIGdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgaW1hZ2UpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTElORUFSKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1MsIGdsLkNMQU1QX1RPX0VER0UpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSk7Cn0KCi8qKgoqIEJpbmRzIHRoZSBnaXZlbiB0ZXh0dXJlIGFuZCBpbWFnZSBkYXRhLiBUaGUgdGV4dHVyZSBpcyBzZXQgdG8gUkVQRUFUIHdpdGggTkVBUkVTVC4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlR0xUZXh0dXJlTmVhcmVzdFJlcGVhdAoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmNyZWF0ZUdMVGV4dHVyZU5lYXJlc3RSZXBlYXQgPSBmdW5jdGlvbihnbCwgaW1hZ2UsIHRleHR1cmUpCnsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUpOwogICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTkVBUkVTVCk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTkVBUkVTVCk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5SRVBFQVQpOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuUkVQRUFUKTsKfQoKLyoqCiogQmluZHMgdGhlIGdpdmVuIHRleHR1cmUgYW5kIGltYWdlIGRhdGEuIFRoZSB0ZXh0dXJlIGlzIHNldCB0byBDTEFNUF9UT19FREdFIHdpdGggTkVBUkVTVC4KKiBDb2RlIGJhc2VkIG9uIEVmZmVjdHMuanMgZnJvbSBTaGFkZXJUb3kuY29tCiogQG1ldGhvZCBQSVhJLlBpeGlTaGFkZXIjY3JlYXRlR0xUZXh0dXJlTmVhcmVzdAoqLwpQSVhJLlBpeGlTaGFkZXIucHJvdG90eXBlLmNyZWF0ZUdMVGV4dHVyZU5lYXJlc3QgPSBmdW5jdGlvbihnbCwgaW1hZ2UsIHRleHR1cmUpCnsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUpOwogICAgZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX0ZMSVBfWV9XRUJHTCwgZmFsc2UpOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBpbWFnZSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTkVBUkVTVCk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUlOX0ZJTFRFUiwgZ2wuTkVBUkVTVCk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5DTEFNUF9UT19FREdFKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwp9CgovKioKKiBCaW5kcyB0aGUgZ2l2ZW4gdGV4dHVyZSBkYXRhLiBUaGUgdGV4dHVyZSBpcyBzZXQgdG8gQ0xBTVBfVE9fRURHRSB3aXRoIExVTUlOQU5DRS4gRGVzaWduZWQgZm9yIHVzZSB3aXRoIHJlYWwtdGltZSBhdWRpbyBkYXRhLgoqIENvZGUgYmFzZWQgb24gRWZmZWN0cy5qcyBmcm9tIFNoYWRlclRveS5jb20KKiBAbWV0aG9kIFBJWEkuUGl4aVNoYWRlciNjcmVhdGVBdWRpb1RleHR1cmUKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5jcmVhdGVBdWRpb1RleHR1cmUgPSBmdW5jdGlvbihnbCwgdGV4dHVyZSkKewogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZSApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUiApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUiApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfVCwgZ2wuQ0xBTVBfVE9fRURHRSkgOwogICAgZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5MVU1JTkFOQ0UsIDUxMiwgMiwgMCwgZ2wuTFVNSU5BTkNFLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKfQoKLyoqCiogQmluZHMgdGhlIGdpdmVuIHRleHR1cmUgZGF0YS4gVGhlIHRleHR1cmUgaXMgc2V0IHRvIENMQU1QX1RPX0VER0Ugd2l0aCBMVU1JTkFOQ0UuIERlc2lnbmVkIGZvciB1c2Ugd2l0aCBrZXlib2FyZCBpbnB1dCBkYXRhLgoqIENvZGUgYmFzZWQgb24gRWZmZWN0cy5qcyBmcm9tIFNoYWRlclRveS5jb20KKiBAbWV0aG9kIFBJWEkuUGl4aVNoYWRlciNjcmVhdGVLZXlib2FyZFRleHR1cmUKKi8KUElYSS5QaXhpU2hhZGVyLnByb3RvdHlwZS5jcmVhdGVLZXlib2FyZFRleHR1cmUgPSBmdW5jdGlvbihnbCwgdGV4dHVyZSkKewogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZSApOwogICAgZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLk5FQVJFU1QgKTsKICAgIGdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5ORUFSRVNUICk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5DTEFNUF9UT19FREdFICk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKSA7CiAgICBnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLkxVTUlOQU5DRSwgMjU2LCAyLCAwLCBnbC5MVU1JTkFOQ0UsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwp9CgpQSVhJLlBpeGlTaGFkZXIuZGVmYXVsdFZlcnRleFNyYyA9IFsKICAgIAogICAgImF0dHJpYnV0ZSB2ZWMyIGFWZXJ0ZXhQb3NpdGlvbjsiLAogICAgImF0dHJpYnV0ZSB2ZWMyIGFUZXh0dXJlQ29vcmQ7IiwKICAgICJhdHRyaWJ1dGUgZmxvYXQgYUNvbG9yOyIsCgogICAgInVuaWZvcm0gdmVjMiBwcm9qZWN0aW9uVmVjdG9yOyIsCiAgICAidW5pZm9ybSB2ZWMyIG9mZnNldFZlY3RvcjsiLAogICAgInZhcnlpbmcgdmVjMiB2VGV4dHVyZUNvb3JkOyIsCgogICAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCgogICAgImNvbnN0IHZlYzIgY2VudGVyID0gdmVjMigtMS4wLCAxLjApOyIsCiAgICAKICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCiAgICAgICAgImdsX1Bvc2l0aW9uID0gdmVjNCggKChhVmVydGV4UG9zaXRpb24gKyBvZmZzZXRWZWN0b3IpIC8gcHJvamVjdGlvblZlY3RvcikgKyBjZW50ZXIgLCAwLjAsIDEuMCk7IiwKICAgICAgICAidlRleHR1cmVDb29yZCA9IGFUZXh0dXJlQ29vcmQ7IiwKICAgICAgICAidkNvbG9yID0gYUNvbG9yOyIsCiAgICAifSIKXTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgoKUElYSS5QcmltaXRpdmVTaGFkZXIgPSBmdW5jdGlvbigpCnsKCS8vIHRoZSB3ZWJHTCBwcm9ncmFtLi4KCXRoaXMucHJvZ3JhbTsKICAgIAkKICAgIHRoaXMuZnJhZ21lbnRTcmMgPSBbCiAgICAgICJwcmVjaXNpb24gbWVkaXVtcCBmbG9hdDsiLAogICAgICAidmFyeWluZyB2ZWM0IHZDb2xvcjsiLAogICAgICAidm9pZCBtYWluKHZvaWQpIHsiLAogICAgICAgICJnbF9GcmFnQ29sb3IgPSB2Q29sb3I7IiwKICAgICAgIn0iCiAgICBdOwoKICAgIHRoaXMudmVydGV4U3JjICA9IFsKICAgICAgImF0dHJpYnV0ZSB2ZWMyIGFWZXJ0ZXhQb3NpdGlvbjsiLAogICAgICAiYXR0cmlidXRlIHZlYzQgYUNvbG9yOyIsCiAgICAgICJ1bmlmb3JtIG1hdDMgdHJhbnNsYXRpb25NYXRyaXg7IiwKICAgICAgInVuaWZvcm0gdmVjMiBwcm9qZWN0aW9uVmVjdG9yOyIsCiAgICAgICJ1bmlmb3JtIHZlYzIgb2Zmc2V0VmVjdG9yOyIsCiAgICAgICJ1bmlmb3JtIGZsb2F0IGFscGhhOyIsCiAgICAgICJ2YXJ5aW5nIHZlYzQgdkNvbG9yOyIsCiAgICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCiAgICAgICAgInZlYzMgdiA9IHRyYW5zbGF0aW9uTWF0cml4ICogdmVjMyhhVmVydGV4UG9zaXRpb24gLCAxLjApOyIsCiAgICAgICAgInYgLT0gb2Zmc2V0VmVjdG9yLnh5eDsiLAogICAgICAgICJnbF9Qb3NpdGlvbiA9IHZlYzQoIHYueCAvIHByb2plY3Rpb25WZWN0b3IueCAtMS4wLCB2LnkgLyAtcHJvamVjdGlvblZlY3Rvci55ICsgMS4wICwgMC4wLCAxLjApOyIsCiAgICAgICAgInZDb2xvciA9IGFDb2xvciAgKiBhbHBoYTsiLAogICAgICAifSIKICAgIF07CgkKfQoKUElYSS5QcmltaXRpdmVTaGFkZXIucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpCnsKCXZhciBwcm9ncmFtID0gUElYSS5jb21waWxlUHJvZ3JhbSh0aGlzLnZlcnRleFNyYywgdGhpcy5mcmFnbWVudFNyYyk7CgkKCXZhciBnbCA9IFBJWEkuZ2w7CgkKICBnbC51c2VQcm9ncmFtKHByb2dyYW0pOwoJCgkvLyBnZXQgYW5kIHN0b3JlIHRoZSB1bmlmb3JtcyBmb3IgdGhlIHNoYWRlcgoJdGhpcy5wcm9qZWN0aW9uVmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJwcm9qZWN0aW9uVmVjdG9yIik7Cgl0aGlzLm9mZnNldFZlY3RvciA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAib2Zmc2V0VmVjdG9yIik7CiAgCiAgLy8gZ2V0IGFuZCBzdG9yZSB0aGUgYXR0cmlidXRlcwogIHRoaXMuYVZlcnRleFBvc2l0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFWZXJ0ZXhQb3NpdGlvbiIpOwoJdGhpcy5jb2xvckF0dHJpYnV0ZSA9IGdsLmdldEF0dHJpYkxvY2F0aW9uKHByb2dyYW0sICJhQ29sb3IiKTsKCQogIHRoaXMudHJhbnNsYXRpb25NYXRyaXggPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgInRyYW5zbGF0aW9uTWF0cml4Iik7CiAgdGhpcy5hbHBoYSA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAiYWxwaGEiKTsKCgl0aGlzLnByb2dyYW0gPSBwcm9ncmFtOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKClBJWEkuU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKCS8vIHRoZSB3ZWJHTCBwcm9ncmFtLi4KCXRoaXMucHJvZ3JhbTsKCQogICAgdGhpcy5mcmFnbWVudFNyYyA9IFsKICAgICAgInByZWNpc2lvbiBtZWRpdW1wIGZsb2F0OyIsCiAgICAgICJ2YXJ5aW5nIHZlYzIgdlRleHR1cmVDb29yZDsiLAogICAgICAidmFyeWluZyBmbG9hdCB2Q29sb3I7IiwKICAgICAgInVuaWZvcm0gZmxvYXQgYWxwaGE7IiwKICAgICAgInVuaWZvcm0gc2FtcGxlcjJEIHVTYW1wbGVyOyIsCiAgICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCiAgICAgICAgImdsX0ZyYWdDb2xvciA9IHRleHR1cmUyRCh1U2FtcGxlciwgdmVjMih2VGV4dHVyZUNvb3JkLngsIHZUZXh0dXJlQ29vcmQueSkpOyIsCiAgICAgICAgImdsX0ZyYWdDb2xvciA9IGdsX0ZyYWdDb2xvciAqIGFscGhhOyIsCiAgICAgICJ9IgogICAgXTsKCiAgICB0aGlzLnZlcnRleFNyYyA9IFsKICAgICAgImF0dHJpYnV0ZSB2ZWMyIGFWZXJ0ZXhQb3NpdGlvbjsiLAogICAgICAiYXR0cmlidXRlIHZlYzIgYVRleHR1cmVDb29yZDsiLAogICAgICAiYXR0cmlidXRlIGZsb2F0IGFDb2xvcjsiLAogICAgICAidW5pZm9ybSBtYXQzIHRyYW5zbGF0aW9uTWF0cml4OyIsCiAgICAgICJ1bmlmb3JtIHZlYzIgcHJvamVjdGlvblZlY3RvcjsiLAogICAgICAidmFyeWluZyB2ZWMyIHZUZXh0dXJlQ29vcmQ7IiwKICAgICAgInZhcnlpbmcgdmVjMiBvZmZzZXRWZWN0b3I7IiwKICAgICAgInZhcnlpbmcgZmxvYXQgdkNvbG9yOyIsCiAgICAgICJ2b2lkIG1haW4odm9pZCkgeyIsCiAgICAgICAgInZlYzMgdiA9IHRyYW5zbGF0aW9uTWF0cml4ICogdmVjMyhhVmVydGV4UG9zaXRpb24sIDEuMCk7IiwKICAgICAgICAidiAtPSBvZmZzZXRWZWN0b3IueHl4OyIsCiAgICAgICAgImdsX1Bvc2l0aW9uID0gdmVjNCggdi54IC8gcHJvamVjdGlvblZlY3Rvci54IC0xLjAsIHYueSAvIHByb2plY3Rpb25WZWN0b3IueSArIDEuMCAsIDAuMCwgMS4wKTsiLAogICAgICAgICJ2VGV4dHVyZUNvb3JkID0gYVRleHR1cmVDb29yZDsiLAogICAgICAgICJ2Q29sb3IgPSBhQ29sb3I7IiwKICAgICAgIn0iCiAgICBdOwp9CgpQSVhJLlN0cmlwU2hhZGVyLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKQp7Cgl2YXIgcHJvZ3JhbSA9IFBJWEkuY29tcGlsZVByb2dyYW0odGhpcy52ZXJ0ZXhTcmMsIHRoaXMuZnJhZ21lbnRTcmMpCgkKCXZhciBnbCA9IFBJWEkuZ2w7CgkKICAgIGdsLnVzZVByb2dyYW0ocHJvZ3JhbSk7CgoJLy8gZ2V0IGFuZCBzdG9yZSB0aGUgdW5pZm9ybXMgZm9yIHRoZSBzaGFkZXIKCXRoaXMudVNhbXBsZXIgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgInVTYW1wbGVyIik7Cgl0aGlzLnByb2plY3Rpb25WZWN0b3IgPSBnbC5nZXRVbmlmb3JtTG9jYXRpb24ocHJvZ3JhbSwgInByb2plY3Rpb25WZWN0b3IiKTsKCXRoaXMub2Zmc2V0VmVjdG9yID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJvZmZzZXRWZWN0b3IiKTsKCXRoaXMuY29sb3JBdHRyaWJ1dGUgPSBnbC5nZXRBdHRyaWJMb2NhdGlvbihwcm9ncmFtLCAiYUNvbG9yIik7CgkvL3RoaXMuZGltZW5zaW9ucyA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbih0aGlzLnByb2dyYW0sICJkaW1lbnNpb25zIik7CgkKCS8vIGdldCBhbmQgc3RvcmUgdGhlIGF0dHJpYnV0ZXMKCXRoaXMuYVZlcnRleFBvc2l0aW9uID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFWZXJ0ZXhQb3NpdGlvbiIpOwoJdGhpcy5hVGV4dHVyZUNvb3JkID0gZ2wuZ2V0QXR0cmliTG9jYXRpb24ocHJvZ3JhbSwgImFUZXh0dXJlQ29vcmQiKTsKCSAgCiAgICB0aGlzLnRyYW5zbGF0aW9uTWF0cml4ID0gZ2wuZ2V0VW5pZm9ybUxvY2F0aW9uKHByb2dyYW0sICJ0cmFuc2xhdGlvbk1hdHJpeCIpOwogICAgdGhpcy5hbHBoYSA9IGdsLmdldFVuaWZvcm1Mb2NhdGlvbihwcm9ncmFtLCAiYWxwaGEiKTsKICAKCXRoaXMucHJvZ3JhbSA9IHByb2dyYW07Cn0KCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgpQSVhJLl9iYXRjaHMgPSBbXTsKCi8qKgogKiBAcHJpdmF0ZQogKi8KUElYSS5fZ2V0QmF0Y2ggPSBmdW5jdGlvbihnbCkKewoJaWYoUElYSS5fYmF0Y2hzLmxlbmd0aCA9PSAwKQoJewoJCXJldHVybiBuZXcgUElYSS5XZWJHTEJhdGNoKGdsKTsKCX0KCWVsc2UKCXsKCQlyZXR1cm4gUElYSS5fYmF0Y2hzLnBvcCgpOwoJfQp9CgovKioKICogQHByaXZhdGUKICovClBJWEkuX3JldHVybkJhdGNoID0gZnVuY3Rpb24oYmF0Y2gpCnsKCWJhdGNoLmNsZWFuKCk7CQoJUElYSS5fYmF0Y2hzLnB1c2goYmF0Y2gpOwp9CgovKioKICogQHByaXZhdGUKICovClBJWEkuX3Jlc3RvcmVCYXRjaHMgPSBmdW5jdGlvbihnbCkKewoJZm9yICh2YXIgaT0wOyBpIDwgUElYSS5fYmF0Y2hzLmxlbmd0aDsgaSsrKSAKCXsKCSAgUElYSS5fYmF0Y2hzW2ldLnJlc3RvcmVMb3N0Q29udGV4dChnbCk7Cgl9Owp9CgovKioKICogQSBXZWJHTEJhdGNoIEVuYWJsZXMgYSBncm91cCBvZiBzcHJpdGVzIHRvIGJlIGRyYXduIHVzaW5nIHRoZSBzYW1lIHNldHRpbmdzLgogKiBpZiBhIGdyb3VwIG9mIHNwcml0ZXMgYWxsIGhhdmUgdGhlIHNhbWUgYmFzZVRleHR1cmUgYW5kIGJsZW5kTW9kZSB0aGVuIHRoZXkgY2FuIGJlIGdyb3VwZWQgaW50byBhIGJhdGNoLgogKiBBbGwgdGhlIHNwcml0ZXMgaW4gYSBiYXRjaCBjYW4gdGhlbiBiZSBkcmF3biBpbiBvbmUgZ28gYnkgdGhlIEdQVSB3aGljaCBpcyBodWdlbHkgZWZmaWNpZW50LiBBTEwgc3ByaXRlcwogKiBpbiB0aGUgd2ViR0wgcmVuZGVyZXIgYXJlIGFkZGVkIHRvIGEgYmF0Y2ggZXZlbiBpZiB0aGUgYmF0Y2ggb25seSBjb250YWlucyBvbmUgc3ByaXRlLiBCYXRjaGluZyBpcyBoYW5kbGVkCiAqIGF1dG9tYXRpY2FsbHkgYnkgdGhlIHdlYkdMIHJlbmRlcmVyLiBBIGdvb2QgdGlwIGlzOiB0aGUgc21hbGxlciB0aGUgbnVtYmVyIG9mIGJhdGNocyB0aGVyZSBhcmUsIHRoZSBmYXN0ZXIKICogdGhlIHdlYkdMIHJlbmRlcmVyIHdpbGwgcnVuLgogKgogKiBAY2xhc3MgV2ViR0xCYXRjaAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGdsIHtXZWJHTENvbnRleHR9IGFuIGluc3RhbmNlIG9mIHRoZSB3ZWJHTCBjb250ZXh0CiAqLwpQSVhJLldlYkdMQmF0Y2ggPSBmdW5jdGlvbihnbCkKewoJdGhpcy5nbCA9IGdsOwoJCgl0aGlzLnNpemUgPSAwOwoKCXRoaXMudmVydGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy5pbmRleEJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMudXZCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cgl0aGlzLmNvbG9yQnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy5ibGVuZE1vZGUgPSBQSVhJLmJsZW5kTW9kZXMuTk9STUFMOwoJdGhpcy5keW5hbWljU2l6ZSA9IDE7Cn0KCi8vIGNvbnN0cnVjdG9yClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLldlYkdMQmF0Y2g7CgovKioKICogQ2xlYW5zIHRoZSBiYXRjaCBzbyB0aGF0IGlzIGNhbiBiZSByZXR1cm5lZCB0byBhbiBvYmplY3QgcG9vbCBhbmQgcmV1c2VkCiAqCiAqIEBtZXRob2QgY2xlYW4KICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuY2xlYW4gPSBmdW5jdGlvbigpCnsKCXRoaXMudmVydGljaWVzID0gW107Cgl0aGlzLnV2cyA9IFtdOwoJdGhpcy5pbmRpY2VzID0gW107Cgl0aGlzLmNvbG9ycyA9IFtdOwoJdGhpcy5keW5hbWljU2l6ZSA9IDE7Cgl0aGlzLnRleHR1cmUgPSBudWxsOwoJdGhpcy5sYXN0ID0gbnVsbDsKCXRoaXMuc2l6ZSA9IDA7Cgl0aGlzLmhlYWQ7Cgl0aGlzLnRhaWw7Cn0KCi8qKgogKiBSZWNyZWF0ZXMgdGhlIGJ1ZmZlcnMgaW4gdGhlIGV2ZW50IG9mIGEgY29udGV4dCBsb3NzCiAqCiAqIEBtZXRob2QgcmVzdG9yZUxvc3RDb250ZXh0CiAqIEBwYXJhbSBnbCB7V2ViR0xDb250ZXh0fQogKi8KUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5yZXN0b3JlTG9zdENvbnRleHQgPSBmdW5jdGlvbihnbCkKewoJdGhpcy5nbCA9IGdsOwoJdGhpcy52ZXJ0ZXhCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cgl0aGlzLmluZGV4QnVmZmVyID0gIGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy51dkJ1ZmZlciA9ICBnbC5jcmVhdGVCdWZmZXIoKTsKCXRoaXMuY29sb3JCdWZmZXIgPSAgZ2wuY3JlYXRlQnVmZmVyKCk7Cn0KCi8qKgogKiBpbml0cyB0aGUgYmF0Y2gncyB0ZXh0dXJlIGFuZCBibGVuZCBtb2RlIGJhc2VkIGlmIHRoZSBzdXBwbGllZCBzcHJpdGUKICoKICogQG1ldGhvZCBpbml0CiAqIEBwYXJhbSBzcHJpdGUge1Nwcml0ZX0gdGhlIGZpcnN0IHNwcml0ZSB0byBiZSBhZGRlZCB0byB0aGUgYmF0Y2guIE9ubHkgc3ByaXRlcyB3aXRoCiAqCQl0aGUgc2FtZSBiYXNlIHRleHR1cmUgYW5kIGJsZW5kIG1vZGUgd2lsbCBiZSBhbGxvd2VkIHRvIGJlIGFkZGVkIHRvIHRoaXMgYmF0Y2gKICovCQpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbihzcHJpdGUpCnsKCXNwcml0ZS5iYXRjaCA9IHRoaXM7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCXRoaXMuYmxlbmRNb2RlID0gc3ByaXRlLmJsZW5kTW9kZTsKCXRoaXMudGV4dHVyZSA9IHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlOwoJdGhpcy5oZWFkID0gc3ByaXRlOwoJdGhpcy50YWlsID0gc3ByaXRlOwoJdGhpcy5zaXplID0gMTsKCgl0aGlzLmdyb3dCYXRjaCgpOwp9CgovKioKICogaW5zZXJ0cyBhIHNwcml0ZSBiZWZvcmUgdGhlIHNwZWNpZmllZCBzcHJpdGUKICoKICogQG1ldGhvZCBpbnNlcnRCZWZvcmUKICogQHBhcmFtIHNwcml0ZSB7U3ByaXRlfSB0aGUgc3ByaXRlIHRvIGJlIGFkZGVkCiAqIEBwYXJhbSBuZXh0U3ByaXRlIHtuZXh0U3ByaXRlfSB0aGUgZmlyc3Qgc3ByaXRlIHdpbGwgYmUgaW5zZXJ0ZWQgYmVmb3JlIHRoaXMgc3ByaXRlCiAqLwkKUElYSS5XZWJHTEJhdGNoLnByb3RvdHlwZS5pbnNlcnRCZWZvcmUgPSBmdW5jdGlvbihzcHJpdGUsIG5leHRTcHJpdGUpCnsKCXRoaXMuc2l6ZSsrOwoKCXNwcml0ZS5iYXRjaCA9IHRoaXM7Cgl0aGlzLmRpcnR5ID0gdHJ1ZTsKCXZhciB0ZW1wUHJldiA9IG5leHRTcHJpdGUuX19wcmV2OwoJbmV4dFNwcml0ZS5fX3ByZXYgPSBzcHJpdGU7CglzcHJpdGUuX19uZXh0ID0gbmV4dFNwcml0ZTsKCglpZih0ZW1wUHJldikKCXsKCQlzcHJpdGUuX19wcmV2ID0gdGVtcFByZXY7CgkJdGVtcFByZXYuX19uZXh0ID0gc3ByaXRlOwoJfQoJZWxzZQoJewoJCXRoaXMuaGVhZCA9IHNwcml0ZTsKCX0KfQoKLyoqCiAqIGluc2VydHMgYSBzcHJpdGUgYWZ0ZXIgdGhlIHNwZWNpZmllZCBzcHJpdGUKICoKICogQG1ldGhvZCBpbnNlcnRBZnRlcgogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdG8gYmUgYWRkZWQKICogQHBhcmFtICBwcmV2aW91c1Nwcml0ZSB7U3ByaXRlfSB0aGUgZmlyc3Qgc3ByaXRlIHdpbGwgYmUgaW5zZXJ0ZWQgYWZ0ZXIgdGhpcyBzcHJpdGUKICovCQpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLmluc2VydEFmdGVyID0gZnVuY3Rpb24oc3ByaXRlLCBwcmV2aW91c1Nwcml0ZSkKewoJdGhpcy5zaXplKys7CgoJc3ByaXRlLmJhdGNoID0gdGhpczsKCXRoaXMuZGlydHkgPSB0cnVlOwoKCXZhciB0ZW1wTmV4dCA9IHByZXZpb3VzU3ByaXRlLl9fbmV4dDsKCXByZXZpb3VzU3ByaXRlLl9fbmV4dCA9IHNwcml0ZTsKCXNwcml0ZS5fX3ByZXYgPSBwcmV2aW91c1Nwcml0ZTsKCglpZih0ZW1wTmV4dCkKCXsKCQlzcHJpdGUuX19uZXh0ID0gdGVtcE5leHQ7CgkJdGVtcE5leHQuX19wcmV2ID0gc3ByaXRlOwoJfQoJZWxzZQoJewoJCXRoaXMudGFpbCA9IHNwcml0ZQoJfQp9CgovKioKICogcmVtb3ZlcyBhIHNwcml0ZSBmcm9tIHRoZSBiYXRjaAogKgogKiBAbWV0aG9kIHJlbW92ZQogKiBAcGFyYW0gc3ByaXRlIHtTcHJpdGV9IHRoZSBzcHJpdGUgdG8gYmUgcmVtb3ZlZAogKi8JClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUucmVtb3ZlID0gZnVuY3Rpb24oc3ByaXRlKQp7Cgl0aGlzLnNpemUtLTsKCglpZih0aGlzLnNpemUgPT0gMCkKCXsKCQlzcHJpdGUuYmF0Y2ggPSBudWxsOwoJCXNwcml0ZS5fX3ByZXYgPSBudWxsOwoJCXNwcml0ZS5fX25leHQgPSBudWxsOwoJCXJldHVybjsKCX0KCglpZihzcHJpdGUuX19wcmV2KQoJewoJCXNwcml0ZS5fX3ByZXYuX19uZXh0ID0gc3ByaXRlLl9fbmV4dDsKCX0KCWVsc2UKCXsKCQl0aGlzLmhlYWQgPSBzcHJpdGUuX19uZXh0OwoJCXRoaXMuaGVhZC5fX3ByZXYgPSBudWxsOwoJfQoKCWlmKHNwcml0ZS5fX25leHQpCgl7CgkJc3ByaXRlLl9fbmV4dC5fX3ByZXYgPSBzcHJpdGUuX19wcmV2OwoJfQoJZWxzZQoJewoJCXRoaXMudGFpbCA9IHNwcml0ZS5fX3ByZXY7CgkJdGhpcy50YWlsLl9fbmV4dCA9IG51bGwKCX0KCglzcHJpdGUuYmF0Y2ggPSBudWxsOwoJc3ByaXRlLl9fbmV4dCA9IG51bGw7CglzcHJpdGUuX19wcmV2ID0gbnVsbDsKCXRoaXMuZGlydHkgPSB0cnVlOwp9CgovKioKICogU3BsaXRzIHRoZSBiYXRjaCBpbnRvIHR3byB3aXRoIHRoZSBzcGVjaWZpZWQgc3ByaXRlIGJlaW5nIHRoZSBzdGFydCBvZiB0aGUgbmV3IGJhdGNoLgogKgogKiBAbWV0aG9kIHNwbGl0CiAqIEBwYXJhbSBzcHJpdGUge1Nwcml0ZX0gdGhlIHNwcml0ZSB0aGF0IGluZGljYXRlcyB3aGVyZSB0aGUgYmF0Y2ggc2hvdWxkIGJlIHNwbGl0CiAqIEByZXR1cm4ge1dlYkdMQmF0Y2h9IHRoZSBuZXcgYmF0Y2gKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuc3BsaXQgPSBmdW5jdGlvbihzcHJpdGUpCnsKCXRoaXMuZGlydHkgPSB0cnVlOwoKCXZhciBiYXRjaCA9IG5ldyBQSVhJLldlYkdMQmF0Y2godGhpcy5nbCk7CgliYXRjaC5pbml0KHNwcml0ZSk7CgliYXRjaC50ZXh0dXJlID0gdGhpcy50ZXh0dXJlOwoJYmF0Y2gudGFpbCA9IHRoaXMudGFpbDsKCgl0aGlzLnRhaWwgPSBzcHJpdGUuX19wcmV2OwoJdGhpcy50YWlsLl9fbmV4dCA9IG51bGw7CgoJc3ByaXRlLl9fcHJldiA9IG51bGw7CgkvLyByZXR1cm4gYSBzcGxpdGUgYmF0Y2ghCgoJLy8gVE9ETyB0aGlzIHNpemUgaXMgd3JvbmchCgkvLyBuZWVkIHRvIHJlY2FsY3VsYXRlIDovIHByb2JsZW0gd2l0aCBhIGxpbmtlZCBsaXN0IQoJLy8gdW5sZXNzIGl0IGdldHMgY2FsY3VsYXRlZCBpbiB0aGUgImNsZWFuIj8KCgkvLyBuZWVkIHRvIGxvb3AgdGhyb3VnaCBpdGVtcyBhcyB0aGVyZSBpcyBubyB3YXkgdG8ga25vdyB0aGUgbGVuZ3RoIG9uIGEgbGlua2VkIGxpc3QgOi8KCXZhciB0ZW1wU2l6ZSA9IDA7Cgl3aGlsZShzcHJpdGUpCgl7CgkJdGVtcFNpemUrKzsKCQlzcHJpdGUuYmF0Y2ggPSBiYXRjaDsKCQlzcHJpdGUgPSBzcHJpdGUuX19uZXh0OwoJfQoKCWJhdGNoLnNpemUgPSB0ZW1wU2l6ZTsKCXRoaXMuc2l6ZSAtPSB0ZW1wU2l6ZTsKCglyZXR1cm4gYmF0Y2g7Cn0KCi8qKgogKiBNZXJnZXMgdHdvIGJhdGNocyB0b2dldGhlcgogKgogKiBAbWV0aG9kIG1lcmdlCiAqIEBwYXJhbSBiYXRjaCB7V2ViR0xCYXRjaH0gdGhlIGJhdGNoIHRoYXQgd2lsbCBiZSBtZXJnZWQgCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLm1lcmdlID0gZnVuY3Rpb24oYmF0Y2gpCnsKCXRoaXMuZGlydHkgPSB0cnVlOwoKCXRoaXMudGFpbC5fX25leHQgPSBiYXRjaC5oZWFkOwoJYmF0Y2guaGVhZC5fX3ByZXYgPSB0aGlzLnRhaWw7CgoJdGhpcy5zaXplICs9IGJhdGNoLnNpemU7CgoJdGhpcy50YWlsID0gYmF0Y2gudGFpbDsKCgl2YXIgc3ByaXRlID0gYmF0Y2guaGVhZDsKCXdoaWxlKHNwcml0ZSkKCXsKCQlzcHJpdGUuYmF0Y2ggPSB0aGlzOwoJCXNwcml0ZSA9IHNwcml0ZS5fX25leHQ7Cgl9Cn0KCi8qKgogKiBHcm93cyB0aGUgc2l6ZSBvZiB0aGUgYmF0Y2guIEFzIHRoZSBlbGVtZW50cyBpbiB0aGUgYmF0Y2ggY2Fubm90IGhhdmUgYSBkeW5hbWljIHNpemUgdGhpcwogKiBmdW5jdGlvbiBpcyB1c2VkIHRvIGluY3JlYXNlIHRoZSBzaXplIG9mIHRoZSBiYXRjaC4gSXQgYWxzbyBjcmVhdGVzIGEgbGl0dGxlIGV4dHJhIHJvb20gc28KICogdGhhdCB0aGUgYmF0Y2ggZG9lcyBub3QgbmVlZCB0byBiZSByZXNpemVkIGV2ZXJ5IHRpbWUgYSBzcHJpdGUgaXMgYWRkZWQKICoKICogQG1ldGhvZCBncm93QmF0Y2gKICovClBJWEkuV2ViR0xCYXRjaC5wcm90b3R5cGUuZ3Jvd0JhdGNoID0gZnVuY3Rpb24oKQp7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoJaWYoIHRoaXMuc2l6ZSA9PSAxKQoJewoJCXRoaXMuZHluYW1pY1NpemUgPSAxOwoJfQoJZWxzZQoJewoJCXRoaXMuZHluYW1pY1NpemUgPSB0aGlzLnNpemUgKiAxLjUKCX0KCS8vIGdyb3cgdmVydHMKCXRoaXMudmVydGljaWVzID0gbmV3IEZsb2F0MzJBcnJheSh0aGlzLmR5bmFtaWNTaXplICogOCk7CgoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLHRoaXMudmVydGljaWVzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCgl0aGlzLnV2cyAgPSBuZXcgRmxvYXQzMkFycmF5KCB0aGlzLmR5bmFtaWNTaXplICogOCApOwoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCgl0aGlzLmRpcnR5VVZTID0gdHJ1ZTsKCgl0aGlzLmNvbG9ycyAgPSBuZXcgRmxvYXQzMkFycmF5KCB0aGlzLmR5bmFtaWNTaXplICogNCApOwoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHRoaXMuY29sb3JzICwgZ2wuRFlOQU1JQ19EUkFXKTsKCgl0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKCgl0aGlzLmluZGljZXMgPSBuZXcgVWludDE2QXJyYXkodGhpcy5keW5hbWljU2l6ZSAqIDYpOyAKCXZhciBsZW5ndGggPSB0aGlzLmluZGljZXMubGVuZ3RoLzY7CgoJZm9yICh2YXIgaT0wOyBpIDwgbGVuZ3RoOyBpKyspIAoJewoJICAgIHZhciBpbmRleDIgPSBpICogNjsKCSAgICB2YXIgaW5kZXgzID0gaSAqIDQ7CgkJdGhpcy5pbmRpY2VzW2luZGV4MiArIDBdID0gaW5kZXgzICsgMDsKCQl0aGlzLmluZGljZXNbaW5kZXgyICsgMV0gPSBpbmRleDMgKyAxOwoJCXRoaXMuaW5kaWNlc1tpbmRleDIgKyAyXSA9IGluZGV4MyArIDI7CgkJdGhpcy5pbmRpY2VzW2luZGV4MiArIDNdID0gaW5kZXgzICsgMDsKCQl0aGlzLmluZGljZXNbaW5kZXgyICsgNF0gPSBpbmRleDMgKyAyOwoJCXRoaXMuaW5kaWNlc1tpbmRleDIgKyA1XSA9IGluZGV4MyArIDM7Cgl9OwoKCWdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRpY2VzLCBnbC5TVEFUSUNfRFJBVyk7Cn0KCi8qKgogKiBSZWZyZXNoJ3MgYWxsIHRoZSBkYXRhIGluIHRoZSBiYXRjaCBhbmQgc3luYydzIGl0IHdpdGggdGhlIHdlYkdMIGJ1ZmZlcnMKICoKICogQG1ldGhvZCByZWZyZXNoCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IHRoaXMuZ2w7CgoJaWYgKHRoaXMuZHluYW1pY1NpemUgPCB0aGlzLnNpemUpCgl7CgkJdGhpcy5ncm93QmF0Y2goKTsKCX0KCgl2YXIgaW5kZXhSdW4gPSAwOwoJdmFyIHdvcmxkVHJhbnNmb3JtLCB3aWR0aCwgaGVpZ2h0LCBhWCwgYVksIHcwLCB3MSwgaDAsIGgxLCBpbmRleDsKCXZhciBhLCBiLCBjLCBkLCB0eCwgdHk7CgoJdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLmhlYWQ7CgoJd2hpbGUoZGlzcGxheU9iamVjdCkKCXsKCQlpbmRleCA9IGluZGV4UnVuICogODsKCgkJdmFyIHRleHR1cmUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmU7CgoJCXZhciBmcmFtZSA9IHRleHR1cmUuZnJhbWU7CgkJdmFyIHR3ID0gdGV4dHVyZS5iYXNlVGV4dHVyZS53aWR0aDsKCQl2YXIgdGggPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCgkJdGhpcy51dnNbaW5kZXggKyAwXSA9IGZyYW1lLnggLyB0dzsKCQl0aGlzLnV2c1tpbmRleCArMV0gPSBmcmFtZS55IC8gdGg7CgoJCXRoaXMudXZzW2luZGV4ICsyXSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CgkJdGhpcy51dnNbaW5kZXggKzNdID0gZnJhbWUueSAvIHRoOwoKCQl0aGlzLnV2c1tpbmRleCArNF0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwoJCXRoaXMudXZzW2luZGV4ICs1XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOyAKCgkJdGhpcy51dnNbaW5kZXggKzZdID0gZnJhbWUueCAvIHR3OwoJCXRoaXMudXZzW2luZGV4ICs3XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKCQlkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lID0gZmFsc2U7CgoJCWNvbG9ySW5kZXggPSBpbmRleFJ1biAqIDQ7CgkJdGhpcy5jb2xvcnNbY29sb3JJbmRleF0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgMV0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgMl0gPSB0aGlzLmNvbG9yc1tjb2xvckluZGV4ICsgM10gPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9fbmV4dDsKCgkJaW5kZXhSdW4gKys7Cgl9CgoJdGhpcy5kaXJ0eVVWUyA9IHRydWU7Cgl0aGlzLmRpcnR5Q29sb3JzID0gdHJ1ZTsKfQoKLyoqCiAqIFVwZGF0ZXMgYWxsIHRoZSByZWxldmFudCBnZW9tZXRyeSBhbmQgdXBsb2FkcyB0aGUgZGF0YSB0byB0aGUgR1BVCiAqCiAqIEBtZXRob2QgdXBkYXRlCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkKewoJdmFyIGdsID0gdGhpcy5nbDsKCXZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgaW5kZXgsIGluZGV4MiwgaW5kZXgzCgoJdmFyIGEsIGIsIGMsIGQsIHR4LCB0eTsKCgl2YXIgaW5kZXhSdW4gPSAwOwoKCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5oZWFkOwoJdmFyIHZlcnRpY2llcyA9IHRoaXMudmVydGljaWVzOwoJdmFyIHV2cyA9IHRoaXMudXZzOwoJdmFyIGNvbG9ycyA9IHRoaXMuY29sb3JzOwoJCgl3aGlsZShkaXNwbGF5T2JqZWN0KQoJewoJCWlmKGRpc3BsYXlPYmplY3QudmNvdW50ID09PSBQSVhJLnZpc2libGVDb3VudCkKCQl7CgkJCXdpZHRoID0gZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoOwoJCQloZWlnaHQgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUuaGVpZ2h0OwoKCQkJLy8gVE9ETyB0cmltPz8KCQkJYVggPSBkaXNwbGF5T2JqZWN0LmFuY2hvci54Oy8vIC0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueAoJCQlhWSA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLnk7IC8vLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS55CgkJCXcwID0gd2lkdGggKiAoMS1hWCk7CgkJCXcxID0gd2lkdGggKiAtYVg7CgoJCQloMCA9IGhlaWdodCAqICgxLWFZKTsKCQkJaDEgPSBoZWlnaHQgKiAtYVk7CgoJCQlpbmRleCA9IGluZGV4UnVuICogODsKCgkJCXdvcmxkVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybTsKCgkJCWEgPSB3b3JsZFRyYW5zZm9ybVswXTsKCQkJYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwoJCQljID0gd29ybGRUcmFuc2Zvcm1bMV07CgkJCWQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKCQkJdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKCQkJdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCgkJCXZlcnRpY2llc1tpbmRleCArIDAgXSA9IGEgKiB3MSArIGMgKiBoMSArIHR4OyAKCQkJdmVydGljaWVzW2luZGV4ICsgMSBdID0gZCAqIGgxICsgYiAqIHcxICsgdHk7CgoJCQl2ZXJ0aWNpZXNbaW5kZXggKyAyIF0gPSBhICogdzAgKyBjICogaDEgKyB0eDsgCgkJCXZlcnRpY2llc1tpbmRleCArIDMgXSA9IGQgKiBoMSArIGIgKiB3MCArIHR5OyAKCgkJCXZlcnRpY2llc1tpbmRleCArIDQgXSA9IGEgKiB3MCArIGMgKiBoMCArIHR4OyAKCQkJdmVydGljaWVzW2luZGV4ICsgNSBdID0gZCAqIGgwICsgYiAqIHcwICsgdHk7IAoKCQkJdmVydGljaWVzW2luZGV4ICsgNl0gPSAgYSAqIHcxICsgYyAqIGgwICsgdHg7IAoJCQl2ZXJ0aWNpZXNbaW5kZXggKyA3XSA9ICBkICogaDAgKyBiICogdzEgKyB0eTsgCgoJCQlpZihkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lIHx8IGRpc3BsYXlPYmplY3QudGV4dHVyZS51cGRhdGVGcmFtZSkKCQkJewoJCQkJdGhpcy5kaXJ0eVVWUyA9IHRydWU7CgoJCQkJdmFyIHRleHR1cmUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmU7CgoJCQkJdmFyIGZyYW1lID0gdGV4dHVyZS5mcmFtZTsKCQkJCXZhciB0dyA9IHRleHR1cmUuYmFzZVRleHR1cmUud2lkdGg7CgkJCQl2YXIgdGggPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCgkJCQl1dnNbaW5kZXggKyAwXSA9IGZyYW1lLnggLyB0dzsKCQkJCXV2c1tpbmRleCArMV0gPSBmcmFtZS55IC8gdGg7CgoJCQkJdXZzW2luZGV4ICsyXSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CgkJCQl1dnNbaW5kZXggKzNdID0gZnJhbWUueSAvIHRoOwoKCQkJCXV2c1tpbmRleCArNF0gPSAoZnJhbWUueCArIGZyYW1lLndpZHRoKSAvIHR3OwoJCQkJdXZzW2luZGV4ICs1XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOyAKCgkJCQl1dnNbaW5kZXggKzZdID0gZnJhbWUueCAvIHR3OwoJCQkJdXZzW2luZGV4ICs3XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOwoKCQkJCWRpc3BsYXlPYmplY3QudXBkYXRlRnJhbWUgPSBmYWxzZTsKCQkJfQoKCQkJLy8gVE9ETyB0aGlzIHByb2JhYmx5IGNvdWxkIGRvIHdpdGggc29tZSBvcHRpbWlzYXRpb24uLi4uCgkJCWlmKGRpc3BsYXlPYmplY3QuY2FjaGVBbHBoYSAhPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGEpCgkJCXsKCQkJCWRpc3BsYXlPYmplY3QuY2FjaGVBbHBoYSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCgkJCQl2YXIgY29sb3JJbmRleCA9IGluZGV4UnVuICogNDsKCQkJCWNvbG9yc1tjb2xvckluZGV4XSA9IGNvbG9yc1tjb2xvckluZGV4ICsgMV0gPSBjb2xvcnNbY29sb3JJbmRleCArIDJdID0gY29sb3JzW2NvbG9ySW5kZXggKyAzXSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCQkJCXRoaXMuZGlydHlDb2xvcnMgPSB0cnVlOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCWluZGV4ID0gaW5kZXhSdW4gKiA4OwoKCQkJdmVydGljaWVzW2luZGV4ICsgMCBdID0gdmVydGljaWVzW2luZGV4ICsgMSBdID0gdmVydGljaWVzW2luZGV4ICsgMiBdID0gdmVydGljaWVzW2luZGV4ICsgMyBdID0gdmVydGljaWVzW2luZGV4ICsgNCBdID0gdmVydGljaWVzW2luZGV4ICsgNSBdID0gdmVydGljaWVzW2luZGV4ICsgNl0gPSAJdmVydGljaWVzW2luZGV4ICsgN10gPSAwOwoJCX0KCgkJaW5kZXhSdW4rKzsKCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fX25leHQ7CiAgIH0KfQoKLyoqCiAqIERyYXdzIHRoZSBiYXRjaCB0byB0aGUgZnJhbWUgYnVmZmVyCiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqLwpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQpCnsKCXN0YXJ0ID0gc3RhcnQgfHwgMDsKCglpZihlbmQgPT0gdW5kZWZpbmVkKWVuZCA9IHRoaXMuc2l6ZTsKCQoJaWYodGhpcy5kaXJ0eSkKCXsKCQl0aGlzLnJlZnJlc2goKTsKCQl0aGlzLmRpcnR5ID0gZmFsc2U7Cgl9CgoJaWYgKHRoaXMuc2l6ZSA9PSAwKXJldHVybjsKCgl0aGlzLnVwZGF0ZSgpOwoJdmFyIGdsID0gdGhpcy5nbDsKCgkvL1RPRE8gb3B0aW1pemUgdGhpcyEKCgl2YXIgc2hhZGVyUHJvZ3JhbSA9IFBJWEkuZGVmYXVsdFNoYWRlcjsKCQoJLy9nbC51c2VQcm9ncmFtKHNoYWRlclByb2dyYW0pOwoKCS8vIHVwZGF0ZSB0aGUgdmVydHMuLgoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCS8vIG9rLi4KCWdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCB0aGlzLnZlcnRpY2llcykKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyUHJvZ3JhbS5hVmVydGV4UG9zaXRpb24sIDIsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkvLyB1cGRhdGUgdGhlIHV2cwoJLy92YXIgaXNEZWZhdWx0ID0gKHNoYWRlclByb2dyYW0gPT0gUElYSS5zaGFkZXJQcm9ncmFtKQoKICAgCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKCiAgICBpZih0aGlzLmRpcnR5VVZTKQogICAgewogICAgCXRoaXMuZGlydHlVVlMgPSBmYWxzZTsKICAgIAlnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgIDAsIHRoaXMudXZzKTsKICAgIH0KCiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlclByb2dyYW0uYVRleHR1cmVDb29yZCwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCiAgICBnbC5hY3RpdmVUZXh0dXJlKGdsLlRFWFRVUkUwKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMudGV4dHVyZS5fZ2xUZXh0dXJlKTsKCgkvLyB1cGRhdGUgY29sb3IhCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy5jb2xvckJ1ZmZlcik7CgoJaWYodGhpcy5kaXJ0eUNvbG9ycykKICAgIHsKICAgIAl0aGlzLmRpcnR5Q29sb3JzID0gZmFsc2U7CiAgICAJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMuY29sb3JzKTsKCX0KCiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlclByb2dyYW0uY29sb3JBdHRyaWJ1dGUsIDEsIGdsLkZMT0FULCBmYWxzZSwgMCwgMCk7CgkvLyBkb250IG5lZWQgdG8gdXBsb2FkIQogICAgZ2wuYmluZEJ1ZmZlcihnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgdGhpcy5pbmRleEJ1ZmZlcik7CgoJdmFyIGxlbiA9IGVuZCAtIHN0YXJ0OwoKICAgIC8vIERSQVcgVEhBVCB0aGlzIQogICAgZ2wuZHJhd0VsZW1lbnRzKGdsLlRSSUFOR0xFUywgbGVuICogNiwgZ2wuVU5TSUdORURfU0hPUlQsIHN0YXJ0ICogMiAqIDYgKTsKfQoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlciA9IGZ1bmN0aW9uKHRyYW5zcGFyZW50KQp7Cgl0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQ7CgkKCXRoaXMuZmlsdGVyU3RhY2sgPSBbXTsKCXRoaXMudGV4dHVyZVBvb2wgPSBbXTsKCQoJdGhpcy5vZmZzZXRYID0gMDsKCXRoaXMub2Zmc2V0WSA9IDA7CgkKCXRoaXMuaW5pdFNoYWRlckJ1ZmZlcnMoKTsKfQoKLy8gQVBJCgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuYmVnaW4gPSBmdW5jdGlvbihwcm9qZWN0aW9uLCBidWZmZXIpCnsKCXRoaXMud2lkdGggPSBwcm9qZWN0aW9uLnggKiAyOwoJdGhpcy5oZWlnaHQgPSAtcHJvamVjdGlvbi55ICogMjsKCXRoaXMuYnVmZmVyID0gYnVmZmVyOwp9CgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUucHVzaEZpbHRlciA9IGZ1bmN0aW9uKGZpbHRlckJsb2NrKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoKCS8vIGZpbHRlciBwcm9ncmFtCgkvLyBPUFRJTUlTQVRJT04gLSB0aGUgZmlyc3QgZmlsdGVyIGlzIGZyZWUgaWYgaXRzIGEgc2ltcGxlIGNvbG9yIGNoYW5nZT8KCXRoaXMuZmlsdGVyU3RhY2sucHVzaChmaWx0ZXJCbG9jayk7CgoJdmFyIGZpbHRlciA9IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlc1swXTsKCgkKCgl0aGlzLm9mZnNldFggKz0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWEueDsKCXRoaXMub2Zmc2V0WSArPSBmaWx0ZXJCbG9jay50YXJnZXQuZmlsdGVyQXJlYS55OwoJCgkKCQoJCgkKCXZhciB0ZXh0dXJlID0gdGhpcy50ZXh0dXJlUG9vbC5wb3AoKTsKCWlmKCF0ZXh0dXJlKXRleHR1cmUgPSBuZXcgUElYSS5GaWx0ZXJUZXh0dXJlKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCQoJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgIHRleHR1cmUudGV4dHVyZSk7CgkKCXRoaXMuZ2V0Qm91bmRzKGZpbHRlckJsb2NrLnRhcmdldCk7CgkJCgkvLyBhZGRwYWRkaW5nPwoJLy9kaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEueAoKCXZhciBmaWx0ZXJBcmVhID0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWE7CgoJdmFyIHBhZGlkbmcgPSBmaWx0ZXIucGFkZGluZzsKCWZpbHRlckFyZWEueCAtPSBwYWRpZG5nOwoJZmlsdGVyQXJlYS55IC09IHBhZGlkbmc7CglmaWx0ZXJBcmVhLndpZHRoICs9IHBhZGlkbmcgKiAyOwoJZmlsdGVyQXJlYS5oZWlnaHQgKz0gcGFkaWRuZyAqIDI7CgoJLy8gY2FwIGZpbHRlciB0byBzY3JlZW4gc2l6ZS4uCglpZihmaWx0ZXJBcmVhLnggPCAwKWZpbHRlckFyZWEueCA9IDA7CQoJaWYoZmlsdGVyQXJlYS53aWR0aCA+IHRoaXMud2lkdGgpZmlsdGVyQXJlYS53aWR0aCA9IHRoaXMud2lkdGg7CglpZihmaWx0ZXJBcmVhLnkgPCAwKWZpbHRlckFyZWEueSA9IDA7CQoJaWYoZmlsdGVyQXJlYS5oZWlnaHQgPiB0aGlzLmhlaWdodClmaWx0ZXJBcmVhLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKCgkvL2dsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGV4dHVyZS5mcmFtZUJ1ZmZlcik7CiAgIAogIC8vIGNvbnNvbGUubG9nKGZpbHRlckFyZWEpCgkvLyBzZXQgdmlldyBwb3J0CglnbC52aWV3cG9ydCgwLCAwLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CQoJCglQSVhJLnByb2plY3Rpb24ueCA9IGZpbHRlckFyZWEud2lkdGgvMjsKCVBJWEkucHJvamVjdGlvbi55ID0gLWZpbHRlckFyZWEuaGVpZ2h0LzI7CgkKCVBJWEkub2Zmc2V0LnggPSAtZmlsdGVyQXJlYS54OyAKCVBJWEkub2Zmc2V0LnkgPSAtZmlsdGVyQXJlYS55OwoKCS8vY29uc29sZS5sb2coUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IpCgkvLyB1cGRhdGUgcHJvamVjdGlvbgoJZ2wudW5pZm9ybTJmKFBJWEkuZGVmYXVsdFNoYWRlci5wcm9qZWN0aW9uVmVjdG9yLCBmaWx0ZXJBcmVhLndpZHRoLzIsIC1maWx0ZXJBcmVhLmhlaWdodC8yKTsKCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIub2Zmc2V0VmVjdG9yLCAtZmlsdGVyQXJlYS54LCAtZmlsdGVyQXJlYS55KTsKCS8vUElYSS5wcmltaXRpdmVQcm9ncmFtCgoJZ2wuY29sb3JNYXNrKHRydWUsIHRydWUsIHRydWUsIHRydWUpOyAKCWdsLmNsZWFyQ29sb3IoMCwwLDAsIDApOyAgICAgCglnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCQoJLy9maWx0ZXIudGV4dHVyZSA9IHRleHR1cmU7CglmaWx0ZXJCbG9jay5fZ2xGaWx0ZXJUZXh0dXJlID0gdGV4dHVyZTsKCgkvL2NvbnNvbGUubG9nKCJQVVNIIikKfQoKClBJWEkuV2ViR0xGaWx0ZXJNYW5hZ2VyLnByb3RvdHlwZS5wb3BGaWx0ZXIgPSBmdW5jdGlvbigpCnsKCQoJdmFyIGdsID0gUElYSS5nbDsKCQoJdmFyIGZpbHRlckJsb2NrID0gdGhpcy5maWx0ZXJTdGFjay5wb3AoKTsKCgoKCXZhciBmaWx0ZXJBcmVhID0gZmlsdGVyQmxvY2sudGFyZ2V0LmZpbHRlckFyZWE7CgoJdmFyIHRleHR1cmUgPSBmaWx0ZXJCbG9jay5fZ2xGaWx0ZXJUZXh0dXJlOwoKCWlmKGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlcy5sZW5ndGggPiAxKQoJewoJCWdsLnZpZXdwb3J0KDAsIDAsIGZpbHRlckFyZWEud2lkdGgsIGZpbHRlckFyZWEuaGVpZ2h0KTsKCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCQoJCXRoaXMudmVydGV4QXJyYXlbMF0gPSAwOwoJCXRoaXMudmVydGV4QXJyYXlbMV0gPSBmaWx0ZXJBcmVhLmhlaWdodDsKCQkKCQl0aGlzLnZlcnRleEFycmF5WzJdID0gZmlsdGVyQXJlYS53aWR0aDsKCQl0aGlzLnZlcnRleEFycmF5WzNdID0gZmlsdGVyQXJlYS5oZWlnaHQ7CgkJCgkJdGhpcy52ZXJ0ZXhBcnJheVs0XSA9IDA7CgkJdGhpcy52ZXJ0ZXhBcnJheVs1XSA9IDA7CgkJCgkJdGhpcy52ZXJ0ZXhBcnJheVs2XSA9IGZpbHRlckFyZWEud2lkdGg7CgkJdGhpcy52ZXJ0ZXhBcnJheVs3XSA9IDA7CgoKCQlnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0ZXhBcnJheSk7CgoJCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudXZCdWZmZXIpOwoJCS8vIG5ub3cgc2V0IHRoZSB1dnMuLgoJCXRoaXMudXZBcnJheVsyXSA9IGZpbHRlckFyZWEud2lkdGgvdGhpcy53aWR0aDsKCQl0aGlzLnV2QXJyYXlbNV0gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKCQl0aGlzLnV2QXJyYXlbNl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7CgkJdGhpcy51dkFycmF5WzddID0gZmlsdGVyQXJlYS5oZWlnaHQvdGhpcy5oZWlnaHQ7CgkJCgkJZ2wuYnVmZmVyU3ViRGF0YShnbC5BUlJBWV9CVUZGRVIsIDAsIHRoaXMudXZBcnJheSk7CgoJCXZhciBpbnB1dFRleHR1cmUgPSB0ZXh0dXJlOwoJCXZhciBvdXRwdXRUZXh0dXJlID0gdGhpcy50ZXh0dXJlUG9vbC5wb3AoKTsKCQlpZighb3V0cHV0VGV4dHVyZSlvdXRwdXRUZXh0dXJlID0gbmV3IFBJWEkuRmlsdGVyVGV4dHVyZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkJCgkJLy8gbmVlZCB0byBjbGVhciB0aGlzIEZCTyBhcyBpdCBtYXkgaGF2ZSBzb21lIGxlZnQgb3ZlciBlbGVtZW50cyBmcm9tIGEgcHJ2aW91cyBmaWx0ZXIuCgkJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBvdXRwdXRUZXh0dXJlLmZyYW1lQnVmZmVyICk7ICAgICAKCQlnbC5jbGVhcihnbC5DT0xPUl9CVUZGRVJfQklUKTsKCSAKCQlnbC5kaXNhYmxlKGdsLkJMRU5EKTsKCQkKCQlmb3IgKHZhciBpID0gMDsgaSA8IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlcy5sZW5ndGgtMTsgaSsrKSAKCQl7CgkJCXZhciBmaWx0ZXJQYXNzID0gZmlsdGVyQmxvY2suZmlsdGVyUGFzc2VzW2ldOwoJCgkJCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgb3V0cHV0VGV4dHVyZS5mcmFtZUJ1ZmZlciApOwoJCQkKCQkJLy8gc2V0IHRleHR1cmUKCQkgICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CgkJCWdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIGlucHV0VGV4dHVyZS50ZXh0dXJlKTsKCQkJCgkJCS8vIGRyYXcgdGV4dHVyZS4uCgkJCS8vZmlsdGVyUGFzcy5hcHBseUZpbHRlclBhc3MoZmlsdGVyQXJlYS53aWR0aCwgZmlsdGVyQXJlYS5oZWlnaHQpOwoJCQl0aGlzLmFwcGx5RmlsdGVyUGFzcyhmaWx0ZXJQYXNzLCBmaWx0ZXJBcmVhLCBmaWx0ZXJBcmVhLndpZHRoLCBmaWx0ZXJBcmVhLmhlaWdodCk7CgoJCQkvLyBzd2FwIHRoZSB0ZXh0dXJlcy4uCgkJCXZhciB0ZW1wID0gaW5wdXRUZXh0dXJlOwoJCQlpbnB1dFRleHR1cmUgPSBvdXRwdXRUZXh0dXJlOwoJCQlvdXRwdXRUZXh0dXJlID0gdGVtcDsKCQkJCgkJfTsKCgkJZ2wuZW5hYmxlKGdsLkJMRU5EKTsKCgkJdGV4dHVyZSA9IGlucHV0VGV4dHVyZTsKCQl0aGlzLnRleHR1cmVQb29sLnB1c2gob3V0cHV0VGV4dHVyZSk7Cgl9CgoJdmFyIGZpbHRlciA9IGZpbHRlckJsb2NrLmZpbHRlclBhc3Nlc1tmaWx0ZXJCbG9jay5maWx0ZXJQYXNzZXMubGVuZ3RoLTFdOwoJCgl0aGlzLm9mZnNldFggLT0gZmlsdGVyQXJlYS54OwoJdGhpcy5vZmZzZXRZIC09IGZpbHRlckFyZWEueTsKCgkKCXZhciBzaXplWCA9IHRoaXMud2lkdGg7Cgl2YXIgc2l6ZVkgPSB0aGlzLmhlaWdodDsKCQoJdmFyIG9mZnNldFggPSAwOwoJdmFyIG9mZnNldFkgPSAwOwoJCgl2YXIgYnVmZmVyID0gdGhpcy5idWZmZXI7CgkKCS8vIHRpbWUgdG8gcmVuZGVyIHRoZSBmaWx0ZXJzIHRleHR1cmUgdG8gdGhlIHByZXZpb3VzIHNjZW5lCglpZih0aGlzLmZpbHRlclN0YWNrLmxlbmd0aCA9PT0gMCkKCXsKCQlnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdGhpcy50cmFuc3BhcmVudCk7IAoJfQoJZWxzZQoJewoJCXZhciBjdXJyZW50RmlsdGVyID0gdGhpcy5maWx0ZXJTdGFja1t0aGlzLmZpbHRlclN0YWNrLmxlbmd0aC0xXTsKCQl2YXIgZmlsdGVyQXJlYSA9IGN1cnJlbnRGaWx0ZXIudGFyZ2V0LmZpbHRlckFyZWE7CgkJCgkJc2l6ZVggPSBmaWx0ZXJBcmVhLndpZHRoOwoJCXNpemVZID0gZmlsdGVyQXJlYS5oZWlnaHQ7CgkJCgkJb2Zmc2V0WCA9IGZpbHRlckFyZWEueDsKCQlvZmZzZXRZID0gZmlsdGVyQXJlYS55OwoJCQoJCWJ1ZmZlciA9ICBjdXJyZW50RmlsdGVyLl9nbEZpbHRlclRleHR1cmUuZnJhbWVCdWZmZXI7Cgl9CgkKCQoKCS8vIFRPRE8gbmVlZCB0b3JlbW92ZSB0aGVhc2UgZ2xvYmFsIGVsZW1lbnRzLi4KCVBJWEkucHJvamVjdGlvbi54ID0gc2l6ZVgvMjsKCVBJWEkucHJvamVjdGlvbi55ID0gLXNpemVZLzI7CgoJUElYSS5vZmZzZXQueCA9IG9mZnNldFg7CglQSVhJLm9mZnNldC55ID0gb2Zmc2V0WTsgCgkKCgl2YXIgZmlsdGVyQXJlYSA9ICBmaWx0ZXJCbG9jay50YXJnZXQuZmlsdGVyQXJlYTsKCXZhciB4ID0gZmlsdGVyQXJlYS54LW9mZnNldFg7Cgl2YXIgeSA9IGZpbHRlckFyZWEueS1vZmZzZXRZOwoJCgkvLyB1cGRhdGUgdGhlIGJ1ZmZlcnMuLgkKCS8vIG1ha2Ugc3VyZSB0byBmbGlwIHRoZSB5IQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCQoJdGhpcy52ZXJ0ZXhBcnJheVswXSA9IHg7Cgl0aGlzLnZlcnRleEFycmF5WzFdID0geSArIGZpbHRlckFyZWEuaGVpZ2h0OwoJCgl0aGlzLnZlcnRleEFycmF5WzJdID0geCArIGZpbHRlckFyZWEud2lkdGg7Cgl0aGlzLnZlcnRleEFycmF5WzNdID0geSArIGZpbHRlckFyZWEuaGVpZ2h0OwoJCgl0aGlzLnZlcnRleEFycmF5WzRdID0geDsKCXRoaXMudmVydGV4QXJyYXlbNV0gPSB5OwoJCgl0aGlzLnZlcnRleEFycmF5WzZdID0geCArIGZpbHRlckFyZWEud2lkdGg7Cgl0aGlzLnZlcnRleEFycmF5WzddID0geTsKCglnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy52ZXJ0ZXhBcnJheSk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCB0aGlzLnV2QnVmZmVyKTsKCgl0aGlzLnV2QXJyYXlbMl0gPSBmaWx0ZXJBcmVhLndpZHRoL3RoaXMud2lkdGg7Cgl0aGlzLnV2QXJyYXlbNV0gPSBmaWx0ZXJBcmVhLmhlaWdodC90aGlzLmhlaWdodDsKCXRoaXMudXZBcnJheVs2XSA9IGZpbHRlckFyZWEud2lkdGgvdGhpcy53aWR0aDsKCXRoaXMudXZBcnJheVs3XSA9IGZpbHRlckFyZWEuaGVpZ2h0L3RoaXMuaGVpZ2h0OwoJCglnbC5idWZmZXJTdWJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgMCwgdGhpcy51dkFycmF5KTsKCglnbC52aWV3cG9ydCgwLCAwLCBzaXplWCwgc2l6ZVkpOwkKCS8vIGJpbmQgdGhlIGJ1ZmZlcgoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBidWZmZXIgKTsKCQoJLy8gc2V0IHRleHR1cmUKICAgIGdsLmFjdGl2ZVRleHR1cmUoZ2wuVEVYVFVSRTApOwoJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZS50ZXh0dXJlKTsKCQoJLy8gYXBwbHkhCgkvL2ZpbHRlci5hcHBseUZpbHRlclBhc3Moc2l6ZVgsIHNpemVZKTsKCXRoaXMuYXBwbHlGaWx0ZXJQYXNzKGZpbHRlciwgZmlsdGVyQXJlYSwgc2l6ZVgsIHNpemVZKTsKCgkvLyBub3cgcmVzdG9yZSB0aGUgcmVndWxhciBzaGFkZXIuLgogICAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHNpemVYLzIsIC1zaXplWS8yKTsKCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIub2Zmc2V0VmVjdG9yLCAtb2Zmc2V0WCwgLW9mZnNldFkpOwoKCS8vIHJldHVybiB0aGUgdGV4dHVyZSB0byB0aGUgcG9vbAoJdGhpcy50ZXh0dXJlUG9vbC5wdXNoKHRleHR1cmUpOwoJZmlsdGVyQmxvY2suX2dsRmlsdGVyVGV4dHVyZSA9IG51bGw7CQp9CgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuYXBwbHlGaWx0ZXJQYXNzID0gZnVuY3Rpb24oZmlsdGVyLCBmaWx0ZXJBcmVhLCB3aWR0aCwgaGVpZ2h0KQp7CgkvLyB1c2UgcHJvZ3JhbQoJdmFyIGdsID0gUElYSS5nbDsKCglpZighZmlsdGVyLnNoYWRlcikKCXsKCQl2YXIgc2hhZGVyID0gbmV3IFBJWEkuUGl4aVNoYWRlcigpOwoJCQkJCgkJc2hhZGVyLmZyYWdtZW50U3JjID0gZmlsdGVyLmZyYWdtZW50U3JjOwoJCXNoYWRlci51bmlmb3JtcyA9IGZpbHRlci51bmlmb3JtczsKCQlzaGFkZXIuaW5pdCgpOwoJCQoJCWZpbHRlci5zaGFkZXIgPSBzaGFkZXI7Cgl9CgoJdmFyIHNoYWRlciA9IGZpbHRlci5zaGFkZXI7CgkKCS8vIHNldCB0aGUgc2hhZGVyCglnbC51c2VQcm9ncmFtKHNoYWRlci5wcm9ncmFtKTsKCglnbC51bmlmb3JtMmYoc2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHdpZHRoLzIsIC1oZWlnaHQvMik7CglnbC51bmlmb3JtMmYoc2hhZGVyLm9mZnNldFZlY3RvciwgMCwwKQoKCWlmKGZpbHRlci51bmlmb3Jtcy5kaW1lbnNpb25zKQoJewoJCS8vY29uc29sZS5sb2coZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMpCgkJZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMudmFsdWVbMF0gPSB0aGlzLndpZHRoOy8vd2lkdGg7CgkJZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMudmFsdWVbMV0gPSB0aGlzLmhlaWdodDsvL2hlaWdodDsKCQlmaWx0ZXIudW5pZm9ybXMuZGltZW5zaW9ucy52YWx1ZVsyXSA9IHRoaXMudmVydGV4QXJyYXlbMF07CgkJZmlsdGVyLnVuaWZvcm1zLmRpbWVuc2lvbnMudmFsdWVbM10gPSB0aGlzLnZlcnRleEFycmF5WzVdOy8vZmlsdGVyQXJlYS5oZWlnaHQ7CgkvLwljb25zb2xlLmxvZyh0aGlzLnZlcnRleEFycmF5WzVdKQoJfQoKCXNoYWRlci5zeW5jVW5pZm9ybXMoKTsKCQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKICAgIGdsLnZlcnRleEF0dHJpYlBvaW50ZXIoc2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbiwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKICAgCiAgIAlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CiAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5hVGV4dHVyZUNvb3JkLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCB0aGlzLmluZGV4QnVmZmVyKTsKICAgIAoJLy8gZHJhdyB0aGUgZmlsdGVyLi4uCiAgICBnbC5kcmF3RWxlbWVudHMoZ2wuVFJJQU5HTEVTLCA2LCBnbC5VTlNJR05FRF9TSE9SVCwgMCApOwp9CgpQSVhJLldlYkdMRmlsdGVyTWFuYWdlci5wcm90b3R5cGUuaW5pdFNoYWRlckJ1ZmZlcnMgPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IFBJWEkuZ2w7CgkKCS8vIGNyZWF0ZSBzb21lIGJ1ZmZlcnMKCXRoaXMudmVydGV4QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CQoJdGhpcy51dkJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJdGhpcy5pbmRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJCgkvLyBiaW5kIGFuZCB1cGxvYWQgdGhlIHZlcnRleHMuLgoJLy8ga2VlcCBhIHJlZmZlcmFuY2UgdG8gdGhlIHZlcnRleEZsb2F0RGF0YS4uCgl0aGlzLnZlcnRleEFycmF5ID0gbmV3IEZsb2F0MzJBcnJheShbMC4wLCAwLjAsIAoJCQkJCQkJCSAgICAgICAgIDEuMCwgMC4wLCAKCQkJCQkJCQkgICAgICAgICAwLjAsIDEuMCwgCgkJCQkJCQkJICAgICAgICAgMS4wLCAxLjBdKTsKCQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHRoaXMudmVydGV4QnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoCiAgICBnbC5BUlJBWV9CVUZGRVIsIAogICAgdGhpcy52ZXJ0ZXhBcnJheSwgCiAgICBnbC5TVEFUSUNfRFJBVyk7CiAgICAKICAgIAogICAgLy8gYmluZCBhbmQgdXBsb2FkIHRoZSB1diBidWZmZXIKCXRoaXMudXZBcnJheSA9IG5ldyBGbG9hdDMyQXJyYXkoWzAuMCwgMC4wLCAKCQkJCQkJCQkgICAgIDEuMCwgMC4wLCAKCQkJCQkJCQkgICAgIDAuMCwgMS4wLCAKCQkJCQkJCQkgICAgIDEuMCwgMS4wXSk7CgkJCQkJCQkJICAgICAgICAgCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgdGhpcy51dkJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKAogICAgZ2wuQVJSQVlfQlVGRkVSLCAKICAgIHRoaXMudXZBcnJheSwgCiAgICBnbC5TVEFUSUNfRFJBVyk7CiAgICAKCS8vIGJpbmQgYW5kIHVwbG9hZCB0aGUgaW5kZXgKCWdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHRoaXMuaW5kZXhCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YSgKICAgIGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCAKICAgIG5ldyBVaW50MTZBcnJheShbMCwgMSwgMiwgMSwgMywgMl0pLCAKICAgIGdsLlNUQVRJQ19EUkFXKTsKfQoKUElYSS5XZWJHTEZpbHRlck1hbmFnZXIucHJvdG90eXBlLmdldEJvdW5kcyA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIHRpbWUgdG8gZ2V0IHRoZSB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBvYmplY3QhCgl2YXIgd29ybGRUcmFuc2Zvcm0sIHdpZHRoLCBoZWlnaHQsIGFYLCBhWSwgdzAsIHcxLCBoMCwgaDEsIGluZGV4LCBkb1Rlc3Q7Cgl2YXIgYSwgYiwgYywgZCwgdHgsIHR5LCB4MSwgeDIsIHgzLCB4NCwgeTEsIHkyLCB5MywgeTQ7CgoJdmFyIHRlbXBPYmplY3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJdmFyIHRlc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwoJCgl2YXIgbWF4WCA9IC1JbmZpbml0eTsKCXZhciBtYXhZID0gLUluZmluaXR5OwoJCgl2YXIgbWluWCA9IEluZmluaXR5OwoJdmFyIG1pblkgPSBJbmZpbml0eTsKCQoJZG8JCgl7CgkJLy8gVE9ETyBjYW4gYmUgb3B0aW1pemVkISAtIHdoYXQgaWYgdGhlcmUgaXMgbm8gc2NhbGUgLyByb3RhdGlvbj8KCQkKCQlpZih0ZW1wT2JqZWN0LnZpc2libGUpCgkJewoJCQlpZih0ZW1wT2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJCXsKCQkJCXdpZHRoID0gdGVtcE9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoOwoJCQkJaGVpZ2h0ID0gdGVtcE9iamVjdC50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCgkJCQkvLyBUT0RPIHRyaW0/PwoJCQkJYVggPSB0ZW1wT2JqZWN0LmFuY2hvci54OwoJCQkJYVkgPSB0ZW1wT2JqZWN0LmFuY2hvci55OwoJCQkJdzAgPSB3aWR0aCAqICgxLWFYKTsKCQkJCXcxID0gd2lkdGggKiAtYVg7CgoJCQkJaDAgPSBoZWlnaHQgKiAoMS1hWSk7CgkJCQloMSA9IGhlaWdodCAqIC1hWTsKCgkJCQlkb1Rlc3QgPSB0cnVlOwoJCQl9CgkJCWVsc2UgaWYodGVtcE9iamVjdCBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCgkJCXsKCQkJCXRlbXBPYmplY3QudXBkYXRlRmlsdGVyQm91bmRzKCk7CgoJCQkJdmFyIGJvdW5kcyA9IHRlbXBPYmplY3QuYm91bmRzOwoKCQkJCXdpZHRoID0gYm91bmRzLndpZHRoOwoJCQkJaGVpZ2h0ID0gYm91bmRzLmhlaWdodDsKCgkJCQl3MCA9IGJvdW5kcy54CgkJCQl3MSA9IGJvdW5kcy54ICsgYm91bmRzLndpZHRoOwoKCQkJCWgwID0gYm91bmRzLnkKCQkJCWgxID0gYm91bmRzLnkgKyBib3VuZHMuaGVpZ2h0OwoKCQkJCWRvVGVzdCA9IHRydWU7CQoJCQl9CgkJfQoJCQoJCWlmKGRvVGVzdCkKCQl7CgkJCXdvcmxkVHJhbnNmb3JtID0gdGVtcE9iamVjdC53b3JsZFRyYW5zZm9ybTsKCgkJCWEgPSB3b3JsZFRyYW5zZm9ybVswXTsKCQkJYiA9IHdvcmxkVHJhbnNmb3JtWzNdOwoJCQljID0gd29ybGRUcmFuc2Zvcm1bMV07CgkJCWQgPSB3b3JsZFRyYW5zZm9ybVs0XTsKCQkJdHggPSB3b3JsZFRyYW5zZm9ybVsyXTsKCQkJdHkgPSB3b3JsZFRyYW5zZm9ybVs1XTsKCgkJCXgxID0gYSAqIHcxICsgYyAqIGgxICsgdHg7IAoJCQl5MSA9IGQgKiBoMSArIGIgKiB3MSArIHR5OwoKCQkJeDIgPSBhICogdzAgKyBjICogaDEgKyB0eDsgCgkJCXkyID0gZCAqIGgxICsgYiAqIHcwICsgdHk7IAoKCQkJeDMgPSBhICogdzAgKyBjICogaDAgKyB0eDsgCgkJCXkzID0gZCAqIGgwICsgYiAqIHcwICsgdHk7IAoKCQkJeDQgPSAgYSAqIHcxICsgYyAqIGgwICsgdHg7IAoJCQl5NCA9ICBkICogaDAgKyBiICogdzEgKyB0eTsgCgoJCQltaW5YID0geDEgPCBtaW5YID8geDEgOiBtaW5YOwoJCQltaW5YID0geDIgPCBtaW5YID8geDIgOiBtaW5YOwoJCQltaW5YID0geDMgPCBtaW5YID8geDMgOiBtaW5YOwoJCQltaW5YID0geDQgPCBtaW5YID8geDQgOiBtaW5YOwoJCQkKCQkJbWluWSA9IHkxIDwgbWluWSA/IHkxIDogbWluWTsKCQkJbWluWSA9IHkyIDwgbWluWSA/IHkyIDogbWluWTsKCQkJbWluWSA9IHkzIDwgbWluWSA/IHkzIDogbWluWTsKCQkJbWluWSA9IHk0IDwgbWluWSA/IHk0IDogbWluWTsKCQkJCgkJCW1heFggPSB4MSA+IG1heFggPyB4MSA6IG1heFg7CgkJCW1heFggPSB4MiA+IG1heFggPyB4MiA6IG1heFg7CgkJCW1heFggPSB4MyA+IG1heFggPyB4MyA6IG1heFg7CgkJCW1heFggPSB4NCA+IG1heFggPyB4NCA6IG1heFg7CgkJCQoJCQltYXhZID0geTEgPiBtYXhZID8geTEgOiBtYXhZOwoJCQltYXhZID0geTIgPiBtYXhZID8geTIgOiBtYXhZOwoJCQltYXhZID0geTMgPiBtYXhZID8geTMgOiBtYXhZOwoJCQltYXhZID0geTQgPiBtYXhZID8geTQgOiBtYXhZOwoJCX0KCgkJZG9UZXN0ID0gZmFsc2U7CgkJdGVtcE9iamVjdCA9IHRlbXBPYmplY3QuX2lOZXh0OwoKCX0KCXdoaWxlKHRlbXBPYmplY3QgIT0gdGVzdE9iamVjdCkKCQoJLy8gbWF4aW11bSBib3VuZHMgaXMgdGhlIHNpemUgb2YgdGhlIHNjcmVlbi4uCgkvL21pblggPSBtaW5YID4gMCA/IG1pblggOiAwOwoJLy9taW5ZID0gbWluWSA+IDAgPyBtaW5ZIDogMDsKCglkaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEueCA9IG1pblg7CglkaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEueSA9IG1pblk7CgovLwljb25zb2xlLmxvZyhtYXhYKyAiIDogIiArIG1pblgpCglkaXNwbGF5T2JqZWN0LmZpbHRlckFyZWEud2lkdGggPSBtYXhYIC0gbWluWDsKCWRpc3BsYXlPYmplY3QuZmlsdGVyQXJlYS5oZWlnaHQgPSBtYXhZIC0gbWluWTsKfQoKUElYSS5GaWx0ZXJUZXh0dXJlID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoJdmFyIGdsID0gUElYSS5nbDsKCQogICAgLy8gbmV4dCB0aW1lIHRvIGNyZWF0ZSBhIGZyYW1lIGJ1ZmZlciBhbmQgdGV4dHVyZQoJdGhpcy5mcmFtZUJ1ZmZlciA9IGdsLmNyZWF0ZUZyYW1lYnVmZmVyKCk7CiAgICB0aGlzLnRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7CgogICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgIHRoaXMudGV4dHVyZSk7CiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5mcmFtZWJ1ZmZlciApOwoJCglnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZnJhbWVCdWZmZXIgKTsKCWdsLmZyYW1lYnVmZmVyVGV4dHVyZTJEKGdsLkZSQU1FQlVGRkVSLCBnbC5DT0xPUl9BVFRBQ0hNRU5UMCwgZ2wuVEVYVFVSRV8yRCwgdGhpcy50ZXh0dXJlLCAwKTsKCQoJdGhpcy5yZXNpemUod2lkdGgsIGhlaWdodCk7Cn0KClBJWEkuRmlsdGVyVGV4dHVyZS5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoJdGhpcy53aWR0aCA9IHdpZHRoOwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJdmFyIGdsID0gUElYSS5nbDsKCglnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCAgdGhpcy50ZXh0dXJlKTsKCWdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHdpZHRoLCBoZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwoJCn0KLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCi8qKgogKiBBIHNldCBvZiBmdW5jdGlvbnMgdXNlZCBieSB0aGUgd2ViR0wgcmVuZGVyZXIgdG8gZHJhdyB0aGUgcHJpbWl0aXZlIGdyYXBoaWNzIGRhdGEKICoKICogQGNsYXNzIENhbnZhc0dyYXBoaWNzCiAqLwpQSVhJLldlYkdMR3JhcGhpY3MgPSBmdW5jdGlvbigpCnsKCQp9CgovKioKICogUmVuZGVycyB0aGUgZ3JhcGhpY3Mgb2JqZWN0CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCByZW5kZXJHcmFwaGljcwogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzID0gZnVuY3Rpb24oZ3JhcGhpY3MsIHByb2plY3Rpb24pCnsKCXZhciBnbCA9IFBJWEkuZ2w7CgkKCWlmKCFncmFwaGljcy5fd2ViR0wpZ3JhcGhpY3MuX3dlYkdMID0ge3BvaW50czpbXSwgaW5kaWNlczpbXSwgbGFzdEluZGV4OjAsIAoJCQkJCQkJCQkJICAgYnVmZmVyOmdsLmNyZWF0ZUJ1ZmZlcigpLAoJCQkJCQkJCQkJICAgaW5kZXhCdWZmZXI6Z2wuY3JlYXRlQnVmZmVyKCl9OwoJCglpZihncmFwaGljcy5kaXJ0eSkKCXsKCQlncmFwaGljcy5kaXJ0eSA9IGZhbHNlOwoJCQoJCWlmKGdyYXBoaWNzLmNsZWFyRGlydHkpCgkJewoJCQlncmFwaGljcy5jbGVhckRpcnR5ID0gZmFsc2U7CgkJCQoJCQlncmFwaGljcy5fd2ViR0wubGFzdEluZGV4ID0gMDsKCQkJZ3JhcGhpY3MuX3dlYkdMLnBvaW50cyA9IFtdOwoJCQlncmFwaGljcy5fd2ViR0wuaW5kaWNlcyA9IFtdOwoJCQkKCQl9CgkJCgkJUElYSS5XZWJHTEdyYXBoaWNzLnVwZGF0ZUdyYXBoaWNzKGdyYXBoaWNzKTsKCX0KCQoJUElYSS5hY3RpdmF0ZVByaW1pdGl2ZVNoYWRlcigpOwoJCgkvLyBUaGlzICBjb3VsZCBiZSBzcGVlZGVkIHVwIGZvIHN1cmUhCgl2YXIgbSA9IFBJWEkubWF0My5jbG9uZShncmFwaGljcy53b3JsZFRyYW5zZm9ybSk7CgkKCVBJWEkubWF0My50cmFuc3Bvc2UobSk7CgkKCS8vIHNldCB0aGUgbWF0cml4IHRyYW5zZm9ybSBmb3IgdGhlIAogCWdsLmJsZW5kRnVuYyhnbC5PTkUsIGdsLk9ORV9NSU5VU19TUkNfQUxQSEEpOwoKIAlnbC51bmlmb3JtTWF0cml4M2Z2KFBJWEkucHJpbWl0aXZlU2hhZGVyLnRyYW5zbGF0aW9uTWF0cml4LCBmYWxzZSwgbSk7CiAJCglnbC51bmlmb3JtMmYoUElYSS5wcmltaXRpdmVTaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCAtcHJvamVjdGlvbi55KTsKCWdsLnVuaWZvcm0yZihQSVhJLnByaW1pdGl2ZVNoYWRlci5vZmZzZXRWZWN0b3IsIC1QSVhJLm9mZnNldC54LCAtUElYSS5vZmZzZXQueSk7CgkKCWdsLnVuaWZvcm0xZihQSVhJLnByaW1pdGl2ZVNoYWRlci5hbHBoYSwgZ3JhcGhpY3Mud29ybGRBbHBoYSk7CglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmJ1ZmZlcik7CgkKCWdsLnZlcnRleEF0dHJpYlBvaW50ZXIoUElYSS5wcmltaXRpdmVTaGFkZXIuYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDQgKiA2LCAwKTsKCWdsLnZlcnRleEF0dHJpYlBvaW50ZXIoUElYSS5wcmltaXRpdmVTaGFkZXIuY29sb3JBdHRyaWJ1dGUsIDQsIGdsLkZMT0FULCBmYWxzZSw0ICogNiwgMiAqIDQpOwoJCgkvLyBzZXQgdGhlIGluZGV4IGJ1ZmZlciEKCWdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIGdyYXBoaWNzLl93ZWJHTC5pbmRleEJ1ZmZlcik7CgkKCglnbC5kcmF3RWxlbWVudHMoZ2wuVFJJQU5HTEVfU1RSSVAsICBncmFwaGljcy5fd2ViR0wuaW5kaWNlcy5sZW5ndGgsIGdsLlVOU0lHTkVEX1NIT1JULCAwICk7CgkKCVBJWEkuZGVhY3RpdmF0ZVByaW1pdGl2ZVNoYWRlcigpOwoJCgkKCS8vIHJldHVybiB0byBkZWZhdWx0IHNoYWRlci4uLgovLwlQSVhJLmFjdGl2YXRlU2hhZGVyKFBJWEkuZGVmYXVsdFNoYWRlcik7Cn0KCi8qKgogKiBVcGRhdGVzIHRoZSBncmFwaGljcyBvYmplY3QKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIHVwZGF0ZUdyYXBoaWNzCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MudXBkYXRlR3JhcGhpY3MgPSBmdW5jdGlvbihncmFwaGljcykKewoJZm9yICh2YXIgaT1ncmFwaGljcy5fd2ViR0wubGFzdEluZGV4OyBpIDwgZ3JhcGhpY3MuZ3JhcGhpY3NEYXRhLmxlbmd0aDsgaSsrKSAKCXsKCQl2YXIgZGF0YSA9IGdyYXBoaWNzLmdyYXBoaWNzRGF0YVtpXTsKCQkKCQlpZihkYXRhLnR5cGUgPT0gUElYSS5HcmFwaGljcy5QT0xZKQoJCXsKCQkJaWYoZGF0YS5maWxsKQoJCQl7CgkJCQlpZihkYXRhLnBvaW50cy5sZW5ndGg+MykgCgkJCQlQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRQb2x5KGRhdGEsIGdyYXBoaWNzLl93ZWJHTCk7CgkJCX0KCQkJCgkJCWlmKGRhdGEubGluZVdpZHRoID4gMCkKCQkJewoJCQkJUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwoJCQl9CgkJfQoJCWVsc2UgaWYoZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuUkVDVCkKCQl7CgkJCVBJWEkuV2ViR0xHcmFwaGljcy5idWlsZFJlY3RhbmdsZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwoJCX0KCQllbHNlIGlmKGRhdGEudHlwZSA9PSBQSVhJLkdyYXBoaWNzLkNJUkMgfHwgZGF0YS50eXBlID09IFBJWEkuR3JhcGhpY3MuRUxJUCkKCQl7CgkJCVBJWEkuV2ViR0xHcmFwaGljcy5idWlsZENpcmNsZShkYXRhLCBncmFwaGljcy5fd2ViR0wpOwoJCX0KCX07CgkKCWdyYXBoaWNzLl93ZWJHTC5sYXN0SW5kZXggPSBncmFwaGljcy5ncmFwaGljc0RhdGEubGVuZ3RoOwoJCgl2YXIgZ2wgPSBQSVhJLmdsOwoKCWdyYXBoaWNzLl93ZWJHTC5nbFBvaW50cyA9IG5ldyBGbG9hdDMyQXJyYXkoZ3JhcGhpY3MuX3dlYkdMLnBvaW50cyk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuYnVmZmVyKTsKCWdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuZ2xQb2ludHMsIGdsLlNUQVRJQ19EUkFXKTsKCQoJZ3JhcGhpY3MuX3dlYkdMLmdsSW5kaWNpZXMgPSBuZXcgVWludDE2QXJyYXkoZ3JhcGhpY3MuX3dlYkdMLmluZGljZXMpOwoJCglnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBncmFwaGljcy5fd2ViR0wuaW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgZ3JhcGhpY3MuX3dlYkdMLmdsSW5kaWNpZXMsIGdsLlNUQVRJQ19EUkFXKTsKfQoKLyoqCiAqIEJ1aWxkcyBhIHJlY3RhbmdsZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZFJlY3RhbmdsZQogKiBAcGFyYW0gZ3JhcGhpY3Mge0dyYXBoaWNzfQogKiBAcGFyYW0gd2ViR0xEYXRhIHtPYmplY3R9CiAqLwpQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRSZWN0YW5nbGUgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewoJLy8gLS0tIC8vCgkvLyBuZWVkIHRvIGNvbnZlcnQgcG9pbnRzIHRvIGEgbmljZSByZWd1bGFyIGRhdGEKCS8vIAoJdmFyIHJlY3REYXRhID0gZ3JhcGhpY3NEYXRhLnBvaW50czsKCXZhciB4ID0gcmVjdERhdGFbMF07Cgl2YXIgeSA9IHJlY3REYXRhWzFdOwoJdmFyIHdpZHRoID0gcmVjdERhdGFbMl07Cgl2YXIgaGVpZ2h0ID0gcmVjdERhdGFbM107CgkKCQoJaWYoZ3JhcGhpY3NEYXRhLmZpbGwpCgl7CgkJdmFyIGNvbG9yID0gSEVYdG9SR0IoZ3JhcGhpY3NEYXRhLmZpbGxDb2xvcik7CgkJdmFyIGFscGhhID0gZ3JhcGhpY3NEYXRhLmZpbGxBbHBoYTsKCQkKCQl2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7CgkJdmFyIGcgPSBjb2xvclsxXSAqIGFscGhhOwoJCXZhciBiID0gY29sb3JbMl0gKiBhbHBoYTsKCQoJCXZhciB2ZXJ0cyA9IHdlYkdMRGF0YS5wb2ludHM7CgkJdmFyIGluZGljZXMgPSB3ZWJHTERhdGEuaW5kaWNlczsKCQoJCXZhciB2ZXJ0UG9zID0gdmVydHMubGVuZ3RoLzY7CgkJCgkJLy8gc3RhcnQKCQl2ZXJ0cy5wdXNoKHgsIHkpOwoJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCQoJCXZlcnRzLnB1c2goeCArIHdpZHRoLCB5KTsKCQl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQkKCQl2ZXJ0cy5wdXNoKHggLCB5ICsgaGVpZ2h0KTsKCQl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQkKCQl2ZXJ0cy5wdXNoKHggKyB3aWR0aCwgeSArIGhlaWdodCk7CgkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCgkJLy8gaW5zZXJ0IDIgZGVhZCB0cmlhbmdsZXMuLgoJCWluZGljZXMucHVzaCh2ZXJ0UG9zLCB2ZXJ0UG9zLCB2ZXJ0UG9zKzEsIHZlcnRQb3MrMiwgdmVydFBvcyszLCB2ZXJ0UG9zKzMpCgl9CgkKCWlmKGdyYXBoaWNzRGF0YS5saW5lV2lkdGgpCgl7CgkJZ3JhcGhpY3NEYXRhLnBvaW50cyA9IFt4LCB5LAoJCQkJICB4ICsgd2lkdGgsIHksCgkJCQkgIHggKyB3aWR0aCwgeSArIGhlaWdodCwKCQkJCSAgeCwgeSArIGhlaWdodCwKCQkJCSAgeCwgeV07CgkKCQlQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRMaW5lKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKTsKCX0KCQp9CgovKioKICogQnVpbGRzIGEgY2lyY2xlIHRvIGRyYXcKICoKICogQHN0YXRpYwogKiBAcHJpdmF0ZQogKiBAbWV0aG9kIGJ1aWxkQ2lyY2xlCiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSB3ZWJHTERhdGEge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5idWlsZENpcmNsZSA9IGZ1bmN0aW9uKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKQp7CgkvLyAtLS0gLy8KCS8vIG5lZWQgdG8gY29udmVydCBwb2ludHMgdG8gYSBuaWNlIHJlZ3VsYXIgZGF0YQoJLy8gCgl2YXIgcmVjdERhdGEgPSBncmFwaGljc0RhdGEucG9pbnRzOwoJdmFyIHggPSByZWN0RGF0YVswXTsKCXZhciB5ID0gcmVjdERhdGFbMV07Cgl2YXIgd2lkdGggPSByZWN0RGF0YVsyXTsKCXZhciBoZWlnaHQgPSByZWN0RGF0YVszXTsKCQoJdmFyIHRvdGFsU2VncyA9IDQwOwoJdmFyIHNlZyA9IChNYXRoLlBJICogMikgLyB0b3RhbFNlZ3MgOwoJCQoJaWYoZ3JhcGhpY3NEYXRhLmZpbGwpCgl7CgkJdmFyIGNvbG9yID0gSEVYdG9SR0IoZ3JhcGhpY3NEYXRhLmZpbGxDb2xvcik7CgkJdmFyIGFscGhhID0gZ3JhcGhpY3NEYXRhLmZpbGxBbHBoYTsKCgkJdmFyIHIgPSBjb2xvclswXSAqIGFscGhhOwoJCXZhciBnID0gY29sb3JbMV0gKiBhbHBoYTsKCQl2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgkKCQl2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwoJCXZhciBpbmRpY2VzID0gd2ViR0xEYXRhLmluZGljZXM7CgkKCQl2YXIgdmVjUG9zID0gdmVydHMubGVuZ3RoLzY7CgkJCgkJaW5kaWNlcy5wdXNoKHZlY1Bvcyk7CgkJCgkJZm9yICh2YXIgaT0wOyBpIDwgdG90YWxTZWdzICsgMSA7IGkrKykgCgkJewoJCQl2ZXJ0cy5wdXNoKHgseSwgciwgZywgYiwgYWxwaGEpOwoJCQkKCQkJdmVydHMucHVzaCh4ICsgTWF0aC5zaW4oc2VnICogaSkgKiB3aWR0aCwKCQkJCQkgICB5ICsgTWF0aC5jb3Moc2VnICogaSkgKiBoZWlnaHQsCgkJCQkJICAgciwgZywgYiwgYWxwaGEpOwoJCQoJCQlpbmRpY2VzLnB1c2godmVjUG9zKyssIHZlY1BvcysrKTsKCQl9OwoJCQoJCWluZGljZXMucHVzaCh2ZWNQb3MtMSk7Cgl9CgkKCWlmKGdyYXBoaWNzRGF0YS5saW5lV2lkdGgpCgl7CgkJZ3JhcGhpY3NEYXRhLnBvaW50cyA9IFtdOwoJCQoJCWZvciAodmFyIGk9MDsgaSA8IHRvdGFsU2VncyArIDE7IGkrKykgCgkJewoJCQlncmFwaGljc0RhdGEucG9pbnRzLnB1c2goeCArIE1hdGguc2luKHNlZyAqIGkpICogd2lkdGgsCgkJCQkJCQkJCSB5ICsgTWF0aC5jb3Moc2VnICogaSkgKiBoZWlnaHQpCgkJfTsKCQkKCQlQSVhJLldlYkdMR3JhcGhpY3MuYnVpbGRMaW5lKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKTsKCX0KCQp9CgovKioKICogQnVpbGRzIGEgbGluZSB0byBkcmF3CiAqCiAqIEBzdGF0aWMKICogQHByaXZhdGUKICogQG1ldGhvZCBidWlsZExpbmUKICogQHBhcmFtIGdyYXBoaWNzIHtHcmFwaGljc30KICogQHBhcmFtIHdlYkdMRGF0YSB7T2JqZWN0fQogKi8KUElYSS5XZWJHTEdyYXBoaWNzLmJ1aWxkTGluZSA9IGZ1bmN0aW9uKGdyYXBoaWNzRGF0YSwgd2ViR0xEYXRhKQp7CgkvLyBUT0RPIE9QVElNSVNFIQoJCgl2YXIgd3JhcCA9IHRydWU7Cgl2YXIgcG9pbnRzID0gZ3JhcGhpY3NEYXRhLnBvaW50czsKCWlmKHBvaW50cy5sZW5ndGggPT0gMClyZXR1cm47CgkKCS8vIGlmIHRoZSBsaW5lIHdpZHRoIGlzIGFuIG9kZCBudW1iZXIgYWRkIDAuNSB0byBhbGlnbiB0byBhIHdob2xlIHBpeGVsCglpZihncmFwaGljc0RhdGEubGluZVdpZHRoJTIpCgl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBwb2ludHMubGVuZ3RoOyBpKyspIHsKCQkJcG9pbnRzW2ldICs9IDAuNTsKCQl9OwoJfQoKCS8vIGdldCBmaXJzdCBhbmQgbGFzdCBwb2ludC4uIGZpZ3VyZSBvdXQgdGhlIG1pZGRsZSEKCXZhciBmaXJzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1swXSwgcG9pbnRzWzFdICk7Cgl2YXIgbGFzdFBvaW50ID0gbmV3IFBJWEkuUG9pbnQoIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMl0sIHBvaW50c1twb2ludHMubGVuZ3RoIC0gMV0gKTsKCQoJLy8gaWYgdGhlIGZpcnN0IHBvaW50IGlzIHRoZSBsYXN0IHBvaW50IC0gZ29vbmEgaGF2ZSBpc3N1ZXMgOikKCWlmKGZpcnN0UG9pbnQueCA9PSBsYXN0UG9pbnQueCAmJiBmaXJzdFBvaW50LnkgPT0gbGFzdFBvaW50LnkpCgl7CgkJcG9pbnRzLnBvcCgpOwoJCXBvaW50cy5wb3AoKTsKCQkKCQlsYXN0UG9pbnQgPSBuZXcgUElYSS5Qb2ludCggcG9pbnRzW3BvaW50cy5sZW5ndGggLSAyXSwgcG9pbnRzW3BvaW50cy5sZW5ndGggLSAxXSApOwoJCQoJCXZhciBtaWRQb2ludFggPSBsYXN0UG9pbnQueCArIChmaXJzdFBvaW50LnggLSBsYXN0UG9pbnQueCkgKjAuNTsKCQl2YXIgbWlkUG9pbnRZID0gbGFzdFBvaW50LnkgKyAoZmlyc3RQb2ludC55IC0gbGFzdFBvaW50LnkpICowLjU7CgkJCgkJcG9pbnRzLnVuc2hpZnQobWlkUG9pbnRYLCBtaWRQb2ludFkpOwoJCXBvaW50cy5wdXNoKG1pZFBvaW50WCwgbWlkUG9pbnRZKQoJfQoJCgl2YXIgdmVydHMgPSB3ZWJHTERhdGEucG9pbnRzOwoJdmFyIGluZGljZXMgPSB3ZWJHTERhdGEuaW5kaWNlczsKCXZhciBsZW5ndGggPSBwb2ludHMubGVuZ3RoIC8gMjsKCXZhciBpbmRleENvdW50ID0gcG9pbnRzLmxlbmd0aDsKCXZhciBpbmRleFN0YXJ0ID0gdmVydHMubGVuZ3RoLzY7CgkKCS8vIERSQVcgdGhlIExpbmUKCXZhciB3aWR0aCA9IGdyYXBoaWNzRGF0YS5saW5lV2lkdGggLyAyOwoJCgkvLyBzb3J0IGNvbG9yCgl2YXIgY29sb3IgPSBIRVh0b1JHQihncmFwaGljc0RhdGEubGluZUNvbG9yKTsKCXZhciBhbHBoYSA9IGdyYXBoaWNzRGF0YS5saW5lQWxwaGE7Cgl2YXIgciA9IGNvbG9yWzBdICogYWxwaGE7Cgl2YXIgZyA9IGNvbG9yWzFdICogYWxwaGE7Cgl2YXIgYiA9IGNvbG9yWzJdICogYWxwaGE7CgkKCXZhciBwMXgsIHAxeSwgcDJ4LCBwMnksIHAzeCwgcDN5OwoJdmFyIHBlcnB4LCBwZXJweSwgcGVycDJ4LCBwZXJwMnksIHBlcnAzeCwgcGVycDN5OwoJdmFyIGlweCwgaXB5OwoJdmFyIGExLCBiMSwgYzEsIGEyLCBiMiwgYzI7Cgl2YXIgZGVub20sIHBkaXN0LCBkaXN0OwoJCglwMXggPSBwb2ludHNbMF07CglwMXkgPSBwb2ludHNbMV07CgkKCXAyeCA9IHBvaW50c1syXTsKCXAyeSA9IHBvaW50c1szXTsKCQoJcGVycHggPSAtKHAxeSAtIHAyeSk7CglwZXJweSA9ICBwMXggLSBwMng7CgkKCWRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CgkKCXBlcnB4IC89IGRpc3Q7CglwZXJweSAvPSBkaXN0OwoJcGVycHggKj0gd2lkdGg7CglwZXJweSAqPSB3aWR0aDsKCQoJLy8gc3RhcnQKCXZlcnRzLnB1c2gocDF4IC0gcGVycHggLCBwMXkgLSBwZXJweSwKCQkJCXIsIGcsIGIsIGFscGhhKTsKCQoJdmVydHMucHVzaChwMXggKyBwZXJweCAsIHAxeSArIHBlcnB5LAoJCQkJciwgZywgYiwgYWxwaGEpOwoJCglmb3IgKHZhciBpID0gMTsgaSA8IGxlbmd0aC0xOyBpKyspIAoJewoJCXAxeCA9IHBvaW50c1soaS0xKSoyXTsKCQlwMXkgPSBwb2ludHNbKGktMSkqMiArIDFdOwoJCQoJCXAyeCA9IHBvaW50c1soaSkqMl0KCQlwMnkgPSBwb2ludHNbKGkpKjIgKyAxXQoJCQoJCXAzeCA9IHBvaW50c1soaSsxKSoyXTsKCQlwM3kgPSBwb2ludHNbKGkrMSkqMiArIDFdOwoJCQoJCXBlcnB4ID0gLShwMXkgLSBwMnkpOwoJCXBlcnB5ID0gcDF4IC0gcDJ4OwoJCQoJCWRpc3QgPSBNYXRoLnNxcnQocGVycHgqcGVycHggKyBwZXJweSpwZXJweSk7CgkJcGVycHggLz0gZGlzdDsKCQlwZXJweSAvPSBkaXN0OwoJCXBlcnB4ICo9IHdpZHRoOwoJCXBlcnB5ICo9IHdpZHRoOwoKCQlwZXJwMnggPSAtKHAyeSAtIHAzeSk7CgkJcGVycDJ5ID0gcDJ4IC0gcDN4OwoJCQoJCWRpc3QgPSBNYXRoLnNxcnQocGVycDJ4KnBlcnAyeCArIHBlcnAyeSpwZXJwMnkpOwoJCXBlcnAyeCAvPSBkaXN0OwoJCXBlcnAyeSAvPSBkaXN0OwoJCXBlcnAyeCAqPSB3aWR0aDsKCQlwZXJwMnkgKj0gd2lkdGg7CgkJCgkJYTEgPSAoLXBlcnB5ICsgcDF5KSAtICgtcGVycHkgKyBwMnkpOwoJICAgIGIxID0gKC1wZXJweCArIHAyeCkgLSAoLXBlcnB4ICsgcDF4KTsKCSAgICBjMSA9ICgtcGVycHggKyBwMXgpICogKC1wZXJweSArIHAyeSkgLSAoLXBlcnB4ICsgcDJ4KSAqICgtcGVycHkgKyBwMXkpOwoJICAgIGEyID0gKC1wZXJwMnkgKyBwM3kpIC0gKC1wZXJwMnkgKyBwMnkpOwoJICAgIGIyID0gKC1wZXJwMnggKyBwMngpIC0gKC1wZXJwMnggKyBwM3gpOwoJICAgIGMyID0gKC1wZXJwMnggKyBwM3gpICogKC1wZXJwMnkgKyBwMnkpIC0gKC1wZXJwMnggKyBwMngpICogKC1wZXJwMnkgKyBwM3kpOwoJIAoJICAgIGRlbm9tID0gYTEqYjIgLSBhMipiMTsKCgkgICBpZihNYXRoLmFicyhkZW5vbSkgPCAwLjEgKQoJCXsKCQkKCQkJZGVub20rPTEwLjE7CgkJCXZlcnRzLnB1c2gocDJ4IC0gcGVycHggLCBwMnkgLSBwZXJweSwKCQkJCXIsIGcsIGIsIGFscGhhKTsKCQoJCQl2ZXJ0cy5wdXNoKHAyeCArIHBlcnB4ICwgcDJ5ICsgcGVycHksCgkJCQlyLCBnLCBiLCBhbHBoYSk7CgkJCQoJCQljb250aW51ZTsKCQl9CgkgICAgCgkgICAgcHggPSAoYjEqYzIgLSBiMipjMSkvZGVub207CgkgICAgcHkgPSAoYTIqYzEgLSBhMSpjMikvZGVub207CgkJCgkJCQoJCXBkaXN0ID0gKHB4IC1wMngpICogKHB4IC1wMngpICsgKHB5IC1wMnkpICsgKHB5IC1wMnkpOwoJCQoKCQlpZihwZGlzdCA+IDE0MCAqIDE0MCkKCQl7CgkJCXBlcnAzeCA9IHBlcnB4IC0gcGVycDJ4OwoJCQlwZXJwM3kgPSBwZXJweSAtIHBlcnAyeTsKCQkJCgkJCWRpc3QgPSBNYXRoLnNxcnQocGVycDN4KnBlcnAzeCArIHBlcnAzeSpwZXJwM3kpOwoJCQlwZXJwM3ggLz0gZGlzdDsKCQkJcGVycDN5IC89IGRpc3Q7CgkJCXBlcnAzeCAqPSB3aWR0aDsKCQkJcGVycDN5ICo9IHdpZHRoOwoJCQkKCQkJdmVydHMucHVzaChwMnggLSBwZXJwM3gsIHAyeSAtcGVycDN5KTsKCQkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCQoJCQl2ZXJ0cy5wdXNoKHAyeCArIHBlcnAzeCwgcDJ5ICtwZXJwM3kpOwoJCQl2ZXJ0cy5wdXNoKHIsIGcsIGIsIGFscGhhKTsKCQkJCgkJCXZlcnRzLnB1c2gocDJ4IC0gcGVycDN4LCBwMnkgLXBlcnAzeSk7CgkJCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCQkKCQkJaW5kZXhDb3VudCsrOwoJCX0KCQllbHNlCgkJewoKCQkJdmVydHMucHVzaChweCAsIHB5KTsKCQkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJCQoJCQl2ZXJ0cy5wdXNoKHAyeCAtIChweC1wMngpLCBwMnkgLSAocHkgLSBwMnkpKTsKCQkJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkJfQoJfQoJCglwMXggPSBwb2ludHNbKGxlbmd0aC0yKSoyXQoJcDF5ID0gcG9pbnRzWyhsZW5ndGgtMikqMiArIDFdIAoJCglwMnggPSBwb2ludHNbKGxlbmd0aC0xKSoyXQoJcDJ5ID0gcG9pbnRzWyhsZW5ndGgtMSkqMiArIDFdCgkKCXBlcnB4ID0gLShwMXkgLSBwMnkpCglwZXJweSA9IHAxeCAtIHAyeDsKCQoJZGlzdCA9IE1hdGguc3FydChwZXJweCpwZXJweCArIHBlcnB5KnBlcnB5KTsKCXBlcnB4IC89IGRpc3Q7CglwZXJweSAvPSBkaXN0OwoJcGVycHggKj0gd2lkdGg7CglwZXJweSAqPSB3aWR0aDsKCQoJdmVydHMucHVzaChwMnggLSBwZXJweCAsIHAyeSAtIHBlcnB5KQoJdmVydHMucHVzaChyLCBnLCBiLCBhbHBoYSk7CgkKCXZlcnRzLnB1c2gocDJ4ICsgcGVycHggLCBwMnkgKyBwZXJweSkKCXZlcnRzLnB1c2gociwgZywgYiwgYWxwaGEpOwoJCglpbmRpY2VzLnB1c2goaW5kZXhTdGFydCk7CgkKCWZvciAodmFyIGk9MDsgaSA8IGluZGV4Q291bnQ7IGkrKykgCgl7CgkJaW5kaWNlcy5wdXNoKGluZGV4U3RhcnQrKyk7Cgl9OwoJCglpbmRpY2VzLnB1c2goaW5kZXhTdGFydC0xKTsKfQoKLyoqCiAqIEJ1aWxkcyBhIHBvbHlnb24gdG8gZHJhdwogKgogKiBAc3RhdGljCiAqIEBwcml2YXRlCiAqIEBtZXRob2QgYnVpbGRQb2x5CiAqIEBwYXJhbSBncmFwaGljcyB7R3JhcGhpY3N9CiAqIEBwYXJhbSB3ZWJHTERhdGEge09iamVjdH0KICovClBJWEkuV2ViR0xHcmFwaGljcy5idWlsZFBvbHkgPSBmdW5jdGlvbihncmFwaGljc0RhdGEsIHdlYkdMRGF0YSkKewoJdmFyIHBvaW50cyA9IGdyYXBoaWNzRGF0YS5wb2ludHM7CglpZihwb2ludHMubGVuZ3RoIDwgNilyZXR1cm47CgkKCS8vIGdldCBmaXJzdCBhbmQgbGFzdCBwb2ludC4uIGZpZ3VyZSBvdXQgdGhlIG1pZGRsZSEKCXZhciB2ZXJ0cyA9IHdlYkdMRGF0YS5wb2ludHM7Cgl2YXIgaW5kaWNlcyA9IHdlYkdMRGF0YS5pbmRpY2VzOwoJCgl2YXIgbGVuZ3RoID0gcG9pbnRzLmxlbmd0aCAvIDI7CgkKCS8vIHNvcnQgY29sb3IKCXZhciBjb2xvciA9IEhFWHRvUkdCKGdyYXBoaWNzRGF0YS5maWxsQ29sb3IpOwoJdmFyIGFscGhhID0gZ3JhcGhpY3NEYXRhLmZpbGxBbHBoYTsKCXZhciByID0gY29sb3JbMF0gKiBhbHBoYTsKCXZhciBnID0gY29sb3JbMV0gKiBhbHBoYTsKCXZhciBiID0gY29sb3JbMl0gKiBhbHBoYTsKCQoJdmFyIHRyaWFuZ2xlcyA9IFBJWEkuUG9seUsuVHJpYW5ndWxhdGUocG9pbnRzKTsKCQoJdmFyIHZlcnRQb3MgPSB2ZXJ0cy5sZW5ndGggLyA2OwoJCglmb3IgKHZhciBpPTA7IGkgPCB0cmlhbmdsZXMubGVuZ3RoOyBpKz0zKSAKCXsKCQlpbmRpY2VzLnB1c2godHJpYW5nbGVzW2ldICsgdmVydFBvcyk7CgkJaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpXSArIHZlcnRQb3MpOwoJCWluZGljZXMucHVzaCh0cmlhbmdsZXNbaSsxXSArIHZlcnRQb3MpOwoJCWluZGljZXMucHVzaCh0cmlhbmdsZXNbaSsyXSArdmVydFBvcyk7CgkJaW5kaWNlcy5wdXNoKHRyaWFuZ2xlc1tpKzJdICsgdmVydFBvcyk7Cgl9OwoJCglmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSAKCXsKCQl2ZXJ0cy5wdXNoKHBvaW50c1tpICogMl0sIHBvaW50c1tpICogMiArIDFdLAoJCQkJICAgciwgZywgYiwgYWxwaGEpOwoJfTsKfQoKZnVuY3Rpb24gSEVYdG9SR0IoaGV4KSB7CglyZXR1cm4gWyhoZXggPj4gMTYgJiAweEZGKSAvIDI1NSwgKCBoZXggPj4gOCAmIDB4RkYpIC8gMjU1LCAoaGV4ICYgMHhGRikvIDI1NV07Cn0KCgoKCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5fZGVmYXVsdEZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwxLDEpOwoKLy8gYW4gaW5zdGFuY2Ugb2YgdGhlIGdsIGNvbnRleHQuLgovLyBvbmx5IG9uZSBhdCB0aGUgbW9tZW50IDovClBJWEkuZ2w7CgovKioKICogdGhlIFdlYkdMUmVuZGVyZXIgaXMgZHJhd3MgdGhlIHN0YWdlIGFuZCBhbGwgaXRzIGNvbnRlbnQgb250byBhIHdlYkdMIGVuYWJsZWQgY2FudmFzLiBUaGlzIHJlbmRlcmVyCiAqIHNob3VsZCBiZSB1c2VkIGZvciBicm93c2VycyBzdXBwb3J0IHdlYkdMLiBUaGlzIFJlbmRlciB3b3JrcyBieSBhdXRvbWF0aWNhbGx5IG1hbmFnaW5nIHdlYkdMQmF0Y2hzLgogKiBTbyBubyBuZWVkIGZvciBTcHJpdGUgQmF0Y2gncyBvciBTcHJpdGUgQ2xvdWQncwogKiBEb250IGZvcmdldCB0byBhZGQgdGhlIHZpZXcgdG8geW91ciBET00gb3IgeW91IHdpbGwgbm90IHNlZSBhbnl0aGluZyA6KQogKgogKiBAY2xhc3MgV2ViR0xSZW5kZXJlcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHdpZHRoPTAge051bWJlcn0gdGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgdmlldwogKiBAcGFyYW0gaGVpZ2h0PTAge051bWJlcn0gdGhlIGhlaWdodCBvZiB0aGUgY2FudmFzIHZpZXcKICogQHBhcmFtIHZpZXcge0NhbnZhc30gdGhlIGNhbnZhcyB0byB1c2UgYXMgYSB2aWV3LCBvcHRpb25hbAogKiBAcGFyYW0gdHJhbnNwYXJlbnQ9ZmFsc2Uge0Jvb2xlYW59IHRoZSB0cmFuc3BhcmVuY3kgb2YgdGhlIHJlbmRlciB2aWV3LCBkZWZhdWx0IGZhbHNlCiAqIEBwYXJhbSBhbnRpYWxpYXM9ZmFsc2Uge0Jvb2xlYW59IHNldHMgYW50aWFsaWFzIChvbmx5IGFwcGxpY2FibGUgaW4gY2hyb21lIGF0IHRoZSBtb21lbnQpCiAqIAogKi8KUElYSS5XZWJHTFJlbmRlcmVyID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCwgdmlldywgdHJhbnNwYXJlbnQsIGFudGlhbGlhcykKewoJLy8gZG8gYSBjYXRjaC4uIG9ubHkgMSB3ZWJHTCByZW5kZXJlci4uCgoJdGhpcy50cmFuc3BhcmVudCA9ICEhdHJhbnNwYXJlbnQ7CgoJdGhpcy53aWR0aCA9IHdpZHRoIHx8IDgwMDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDYwMDsKCgl0aGlzLnZpZXcgPSB2aWV3IHx8IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICdjYW52YXMnICk7IAogICAgdGhpcy52aWV3LndpZHRoID0gdGhpcy53aWR0aDsKCXRoaXMudmlldy5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCgkvLyBkZWFsIHdpdGggbG9zaW5nIGNvbnRleHQuLgkKICAgIHZhciBzY29wZSA9IHRoaXM7Cgl0aGlzLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignd2ViZ2xjb250ZXh0bG9zdCcsIGZ1bmN0aW9uKGV2ZW50KSB7IHNjb3BlLmhhbmRsZUNvbnRleHRMb3N0KGV2ZW50KTsgfSwgZmFsc2UpCgl0aGlzLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignd2ViZ2xjb250ZXh0cmVzdG9yZWQnLCBmdW5jdGlvbihldmVudCkgeyBzY29wZS5oYW5kbGVDb250ZXh0UmVzdG9yZWQoZXZlbnQpOyB9LCBmYWxzZSkKCgl0aGlzLmJhdGNocyA9IFtdOwoKCXZhciBvcHRpb25zID0gewoJCWFscGhhOiB0aGlzLnRyYW5zcGFyZW50LAoJCWFudGlhbGlhczohIWFudGlhbGlhcywgLy8gU1BFRUQgVVA/PwoJCXByZW11bHRpcGxpZWRBbHBoYTpmYWxzZSwKCQlzdGVuY2lsOnRydWUKCX0KCgkvL3RyeSAnZXhwZXJpbWVudGFsLXdlYmdsJwoJdHJ5IHsKCQlQSVhJLmdsID0gdGhpcy5nbCA9IHRoaXMudmlldy5nZXRDb250ZXh0KCJleHBlcmltZW50YWwtd2ViZ2wiLCAgb3B0aW9ucyk7Cgl9IGNhdGNoIChlKSB7CgkJLy90cnkgJ3dlYmdsJwoJCXRyeSB7CgkJCVBJWEkuZ2wgPSB0aGlzLmdsID0gdGhpcy52aWV3LmdldENvbnRleHQoIndlYmdsIiwgIG9wdGlvbnMpOwoJCX0gY2F0Y2ggKGUpIHsKCQkJLy8gZmFpbCwgbm90IGFibGUgdG8gZ2V0IGEgY29udGV4dAoJCQl0aHJvdyBuZXcgRXJyb3IoIiBUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCB3ZWJHTC4gVHJ5IHVzaW5nIHRoZSBjYW52YXMgcmVuZGVyZXIiICsgdGhpcyk7CgkJfQoJfQoKICAgIFBJWEkuaW5pdERlZmF1bHRTaGFkZXJzKCk7CiAKCgkKCiAgIC8vIFBJWEkuYWN0aXZhdGVEZWZhdWx0U2hhZGVyKCk7CgogICAgdmFyIGdsID0gdGhpcy5nbDsKICAgIAogICAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CgoKICAgIFBJWEkuV2ViR0xSZW5kZXJlci5nbCA9IGdsOwoKICAgIHRoaXMuYmF0Y2ggPSBuZXcgUElYSS5XZWJHTEJhdGNoKGdsKTsKICAgCWdsLmRpc2FibGUoZ2wuREVQVEhfVEVTVCk7CiAgIAlnbC5kaXNhYmxlKGdsLkNVTExfRkFDRSk7CgogICAgZ2wuZW5hYmxlKGdsLkJMRU5EKTsKICAgIGdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0aGlzLnRyYW5zcGFyZW50KTsgCgogICAgUElYSS5wcm9qZWN0aW9uID0gbmV3IFBJWEkuUG9pbnQoNDAwLCAzMDApOwogICAgUElYSS5vZmZzZXQgPSBuZXcgUElYSS5Qb2ludCgwLCAwKTsKCiAgICAvLyBUT0RPIHJlbW92ZSB0aGVhc2UgZ2xvYmFscy4uCgogICAgdGhpcy5yZXNpemUodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwogICAgdGhpcy5jb250ZXh0TG9zdCA9IGZhbHNlOwoKCS8vUElYSS5wdXNoU2hhZGVyKFBJWEkuZGVmYXVsdFNoYWRlcik7CgogICAgdGhpcy5zdGFnZVJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cCh0aGlzLmdsLCB0aGlzLnRyYW5zcGFyZW50KTsKICAvLyAgdGhpcy5zdGFnZVJlbmRlckdyb3VwLiA9IHRoaXMudHJhbnNwYXJlbnQKfQoKLy8gY29uc3RydWN0b3IKUElYSS5XZWJHTFJlbmRlcmVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuV2ViR0xSZW5kZXJlcjsKCi8qKgogKiBHZXRzIGEgbmV3IFdlYkdMQmF0Y2ggZnJvbSB0aGUgcG9vbAogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgZ2V0QmF0Y2gKICogQHJldHVybiB7V2ViR0xCYXRjaH0KICogQHByaXZhdGUgCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIuZ2V0QmF0Y2ggPSBmdW5jdGlvbigpCnsKCWlmKFBJWEkuX2JhdGNocy5sZW5ndGggPT0gMCkKCXsKCQlyZXR1cm4gbmV3IFBJWEkuV2ViR0xCYXRjaChQSVhJLldlYkdMUmVuZGVyZXIuZ2wpOwoJfQoJZWxzZQoJewoJCXJldHVybiBQSVhJLl9iYXRjaHMucG9wKCk7Cgl9Cn0KCi8qKgogKiBQdXRzIGEgYmF0Y2ggYmFjayBpbnRvIHRoZSBwb29sCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCByZXR1cm5CYXRjaAogKiBAcGFyYW0gYmF0Y2gge1dlYkdMQmF0Y2h9IFRoZSBiYXRjaCB0byByZXR1cm4KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaCA9IGZ1bmN0aW9uKGJhdGNoKQp7CgliYXRjaC5jbGVhbigpOwkKCVBJWEkuX2JhdGNocy5wdXNoKGJhdGNoKTsKfQoKLyoqCiAqIFJlbmRlcnMgdGhlIHN0YWdlIHRvIGl0cyB3ZWJHTCB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBzdGFnZSB7U3RhZ2V9IHRoZSBTdGFnZSBlbGVtZW50IHRvIGJlIHJlbmRlcmVkCiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKHN0YWdlKQp7CglpZih0aGlzLmNvbnRleHRMb3N0KXJldHVybjsKCQoJCgkvLyBpZiByZW5kZXJpbmcgYSBuZXcgc3RhZ2UgY2xlYXIgdGhlIGJhdGNocy4uCglpZih0aGlzLl9fc3RhZ2UgIT09IHN0YWdlKQoJewoJCS8vIFRPRE8gbWFrZSB0aGlzIHdvcmsKCQkvLyBkb250IHRoaW5rIHRoaXMgaXMgbmVlZGVkIGFueSBtb3JlPwoJCXRoaXMuX19zdGFnZSA9IHN0YWdlOwoJCXRoaXMuc3RhZ2VSZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKHN0YWdlKTsKCX0KCgkvLyB1cGRhdGUgYW55IHRleHR1cmVzCQoJUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmVzKCk7CgkJCgkvLyB1cGRhdGUgdGhlIHNjZW5lIGdyYXBoCQoJUElYSS52aXNpYmxlQ291bnQrKzsKCXN0YWdlLnVwZGF0ZVRyYW5zZm9ybSgpOwoJCgl2YXIgZ2wgPSB0aGlzLmdsOwoJCgkvLyAtLSBEb2VzIHRoaXMgbmVlZCB0byBiZSBzZXQgZXZlcnkgZnJhbWU/IC0tIC8vCglnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdGhpcy50cmFuc3BhcmVudCk7IAoJZ2wudmlld3BvcnQoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwkKCQogICAJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCBudWxsKTsKCQkKCWdsLmNsZWFyQ29sb3Ioc3RhZ2UuYmFja2dyb3VuZENvbG9yU3BsaXRbMF0sc3RhZ2UuYmFja2dyb3VuZENvbG9yU3BsaXRbMV0sc3RhZ2UuYmFja2dyb3VuZENvbG9yU3BsaXRbMl0sICF0aGlzLnRyYW5zcGFyZW50KTsgICAgIAoJZ2wuY2xlYXIoZ2wuQ09MT1JfQlVGRkVSX0JJVCk7CgoJLy8gSEFDSyBUTyBURVNUCgkKCXRoaXMuc3RhZ2VSZW5kZXJHcm91cC5iYWNrZ3JvdW5kQ29sb3IgPSBzdGFnZS5iYWNrZ3JvdW5kQ29sb3JTcGxpdDsKCQoJUElYSS5wcm9qZWN0aW9uLnggPSAgdGhpcy53aWR0aC8yOwoJUElYSS5wcm9qZWN0aW9uLnkgPSAgLXRoaXMuaGVpZ2h0LzI7CgkKCXRoaXMuc3RhZ2VSZW5kZXJHcm91cC5yZW5kZXIoUElYSS5wcm9qZWN0aW9uKTsKCQoJLy8gaW50ZXJhY3Rpb24KCS8vIHJ1biBpbnRlcmFjdGlvbiEKCWlmKHN0YWdlLmludGVyYWN0aXZlKQoJewoJCS8vbmVlZCB0byBhZGQgc29tZSBldmVudHMhCgkJaWYoIXN0YWdlLl9pbnRlcmFjdGl2ZUV2ZW50c0FkZGVkKQoJCXsKCQkJc3RhZ2UuX2ludGVyYWN0aXZlRXZlbnRzQWRkZWQgPSB0cnVlOwoJCQlzdGFnZS5pbnRlcmFjdGlvbk1hbmFnZXIuc2V0VGFyZ2V0KHRoaXMpOwoJCX0KCX0KCQoJLy8gYWZ0ZXIgcmVuZGVyaW5nIGxldHMgY29uZmlybSBhbGwgZnJhbWVzIHRoYXQgaGF2ZSBiZWVuIHVvZGF0ZWQuLgoJaWYoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQoJewoJCWZvciAodmFyIGk9MDsgaSA8IFBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoOyBpKyspIAoJCXsKCQkgIAlQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzW2ldLnVwZGF0ZUZyYW1lID0gZmFsc2U7CgkJfTsKCQkKCQlQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzID0gW107Cgl9Cn0KCi8qKgogKiBVcGRhdGVzIHRoZSB0ZXh0dXJlcyBsb2FkZWQgaW50byB0aGlzIHdlYmdsIHJlbmRlcmVyCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCB1cGRhdGVUZXh0dXJlcwogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmVzID0gZnVuY3Rpb24oKQp7CgkvL1RPRE8gYnJlYWsgdGhpcyBvdXQgaW50byBhIHRleHR1cmUgbWFuYWdlci4uLgoJZm9yICh2YXIgaT0wOyBpIDwgUElYSS50ZXh0dXJlc1RvVXBkYXRlLmxlbmd0aDsgaSsrKSBQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZShQSVhJLnRleHR1cmVzVG9VcGRhdGVbaV0pOwoJZm9yICh2YXIgaT0wOyBpIDwgUElYSS50ZXh0dXJlc1RvRGVzdHJveS5sZW5ndGg7IGkrKykgUElYSS5XZWJHTFJlbmRlcmVyLmRlc3Ryb3lUZXh0dXJlKFBJWEkudGV4dHVyZXNUb0Rlc3Ryb3lbaV0pOwoJUElYSS50ZXh0dXJlc1RvVXBkYXRlID0gW107CglQSVhJLnRleHR1cmVzVG9EZXN0cm95ID0gW107Cn0KCi8qKgogKiBVcGRhdGVzIGEgbG9hZGVkIHdlYmdsIHRleHR1cmUKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIHVwZGF0ZVRleHR1cmUKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSB0ZXh0dXJlIHRvIHVwZGF0ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmUgPSBmdW5jdGlvbih0ZXh0dXJlKQp7CgkvL1RPRE8gYnJlYWsgdGhpcyBvdXQgaW50byBhIHRleHR1cmUgbWFuYWdlci4uLgoJdmFyIGdsID0gUElYSS5nbDsKCQoJaWYoIXRleHR1cmUuX2dsVGV4dHVyZSkKCXsKCQl0ZXh0dXJlLl9nbFRleHR1cmUgPSBnbC5jcmVhdGVUZXh0dXJlKCk7Cgl9CgoJaWYodGV4dHVyZS5oYXNMb2FkZWQpCgl7CgkJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGV4dHVyZS5fZ2xUZXh0dXJlKTsKCSAJZ2wucGl4ZWxTdG9yZWkoZ2wuVU5QQUNLX1BSRU1VTFRJUExZX0FMUEhBX1dFQkdMLCB0cnVlKTsKCgkJZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCB0ZXh0dXJlLnNvdXJjZSk7CgkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01BR19GSUxURVIsIGdsLkxJTkVBUik7CgkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX01JTl9GSUxURVIsIGdsLkxJTkVBUik7CgoJCS8vIHJlZ3VsZXIuLi4KCgkJaWYoIXRleHR1cmUuX3Bvd2VyT2YyKQoJCXsKCQkJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CgkJCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLkNMQU1QX1RPX0VER0UpOwoJCX0KCQllbHNlCgkJewoJCQlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5SRVBFQVQpOwoJCQlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5SRVBFQVQpOwoJCX0KCgkJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgbnVsbCk7Cgl9Cn0KCi8qKgogKiBEZXN0cm95cyBhIGxvYWRlZCB3ZWJnbCB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgZGVzdHJveVRleHR1cmUKICogQHBhcmFtIHRleHR1cmUge1RleHR1cmV9IFRoZSB0ZXh0dXJlIHRvIHVwZGF0ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlcmVyLmRlc3Ryb3lUZXh0dXJlID0gZnVuY3Rpb24odGV4dHVyZSkKewoJLy9UT0RPIGJyZWFrIHRoaXMgb3V0IGludG8gYSB0ZXh0dXJlIG1hbmFnZXIuLi4KCXZhciBnbCA9IFBJWEkuZ2w7CgoJaWYodGV4dHVyZS5fZ2xUZXh0dXJlKQoJewoJCXRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKCQlnbC5kZWxldGVUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRleHR1cmUuX2dsVGV4dHVyZSk7Cgl9Cn0KCi8qKgogKiByZXNpemVzIHRoZSB3ZWJHTCB2aWV3IHRvIHRoZSBzcGVjaWZpZWQgd2lkdGggYW5kIGhlaWdodAogKgogKiBAbWV0aG9kIHJlc2l6ZQogKiBAcGFyYW0gd2lkdGgge051bWJlcn0gdGhlIG5ldyB3aWR0aCBvZiB0aGUgd2ViR0wgdmlldwogKiBAcGFyYW0gaGVpZ2h0IHtOdW1iZXJ9IHRoZSBuZXcgaGVpZ2h0IG9mIHRoZSB3ZWJHTCB2aWV3CiAqLwpQSVhJLldlYkdMUmVuZGVyZXIucHJvdG90eXBlLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCnsKCXRoaXMud2lkdGggPSB3aWR0aDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCXRoaXMudmlldy53aWR0aCA9IHdpZHRoOwoJdGhpcy52aWV3LmhlaWdodCA9IGhlaWdodDsKCgl0aGlzLmdsLnZpZXdwb3J0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsJCgoJLy92YXIgcHJvamVjdGlvbk1hdHJpeCA9IHRoaXMucHJvamVjdGlvbk1hdHJpeDsKCglQSVhJLnByb2plY3Rpb24ueCA9ICB0aGlzLndpZHRoLzI7CglQSVhJLnByb2plY3Rpb24ueSA9ICAtdGhpcy5oZWlnaHQvMjsKCQoJLy9QSVhJLnNpemUueCA9ICB0aGlzLndpZHRoLzI7CgkvL1BJWEkuc2l6ZS55ID0gIC10aGlzLmhlaWdodC8yOwoKLy8JcHJvamVjdGlvbk1hdHJpeFswXSA9IDIvdGhpcy53aWR0aDsKLy8JcHJvamVjdGlvbk1hdHJpeFs1XSA9IC0yL3RoaXMuaGVpZ2h0OwovLwlwcm9qZWN0aW9uTWF0cml4WzEyXSA9IC0xOwovLwlwcm9qZWN0aW9uTWF0cml4WzEzXSA9IDE7Cn0KCi8qKgogKiBIYW5kbGVzIGEgbG9zdCB3ZWJnbCBjb250ZXh0CiAqCiAqIEBtZXRob2QgaGFuZGxlQ29udGV4dExvc3QKICogQHBhcmFtIGV2ZW50IHtFdmVudH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuaGFuZGxlQ29udGV4dExvc3QgPSBmdW5jdGlvbihldmVudCkKewoJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCXRoaXMuY29udGV4dExvc3QgPSB0cnVlOwp9CgovKioKICogSGFuZGxlcyBhIHJlc3RvcmVkIHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCBoYW5kbGVDb250ZXh0UmVzdG9yZWQKICogQHBhcmFtIGV2ZW50IHtFdmVudH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJlci5wcm90b3R5cGUuaGFuZGxlQ29udGV4dFJlc3RvcmVkID0gZnVuY3Rpb24oZXZlbnQpCnsKCXRoaXMuZ2wgPSB0aGlzLnZpZXcuZ2V0Q29udGV4dCgiZXhwZXJpbWVudGFsLXdlYmdsIiwgIHsgIAkKCQlhbHBoYTogdHJ1ZQogICAgfSk7CgoJdGhpcy5pbml0U2hhZGVycygpOwkKCglmb3IodmFyIGtleSBpbiBQSVhJLlRleHR1cmVDYWNoZSkgCgl7CiAgICAgICAgCXZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVba2V5XS5iYXNlVGV4dHVyZTsKICAgICAgICAJdGV4dHVyZS5fZ2xUZXh0dXJlID0gbnVsbDsKICAgICAgICAJUElYSS5XZWJHTFJlbmRlcmVyLnVwZGF0ZVRleHR1cmUodGV4dHVyZSk7Cgl9OwoKCWZvciAodmFyIGk9MDsgaSA8ICB0aGlzLmJhdGNocy5sZW5ndGg7IGkrKykgCgl7CgkJdGhpcy5iYXRjaHNbaV0ucmVzdG9yZUxvc3RDb250ZXh0KHRoaXMuZ2wpLy8KCQl0aGlzLmJhdGNoc1tpXS5kaXJ0eSA9IHRydWU7Cgl9OwoKCVBJWEkuX3Jlc3RvcmVCYXRjaHModGhpcy5nbCk7CgoJdGhpcy5jb250ZXh0TG9zdCA9IGZhbHNlOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgV2ViR0xCYXRjaCBFbmFibGVzIGEgZ3JvdXAgb2Ygc3ByaXRlcyB0byBiZSBkcmF3biB1c2luZyB0aGUgc2FtZSBzZXR0aW5ncy4KICogaWYgYSBncm91cCBvZiBzcHJpdGVzIGFsbCBoYXZlIHRoZSBzYW1lIGJhc2VUZXh0dXJlIGFuZCBibGVuZE1vZGUgdGhlbiB0aGV5IGNhbiBiZQogKiBncm91cGVkIGludG8gYSBiYXRjaC4gQWxsIHRoZSBzcHJpdGVzIGluIGEgYmF0Y2ggY2FuIHRoZW4gYmUgZHJhd24gaW4gb25lIGdvIGJ5IHRoZQogKiBHUFUgd2hpY2ggaXMgaHVnZWx5IGVmZmljaWVudC4gQUxMIHNwcml0ZXMgaW4gdGhlIHdlYkdMIHJlbmRlcmVyIGFyZSBhZGRlZCB0byBhIGJhdGNoCiAqIGV2ZW4gaWYgdGhlIGJhdGNoIG9ubHkgY29udGFpbnMgb25lIHNwcml0ZS4gQmF0Y2hpbmcgaXMgaGFuZGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZQogKiB3ZWJHTCByZW5kZXJlci4gQSBnb29kIHRpcCBpczogdGhlIHNtYWxsZXIgdGhlIG51bWJlciBvZiBiYXRjaHMgdGhlcmUgYXJlLCB0aGUgZmFzdGVyCiAqIHRoZSB3ZWJHTCByZW5kZXJlciB3aWxsIHJ1bi4KICoKICogQGNsYXNzIFdlYkdMQmF0Y2gKICogQGNvbnRydWN0b3IKICogQHBhcmFtIGdsIHtXZWJHTENvbnRleHR9IEFuIGluc3RhbmNlIG9mIHRoZSB3ZWJHTCBjb250ZXh0CiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAgPSBmdW5jdGlvbihnbCwgdHJhbnNwYXJlbnQpCnsKCXRoaXMuZ2wgPSBnbDsKCXRoaXMucm9vdDsKCQoJdGhpcy5iYWNrZ3JvdW5kQ29sb3I7Cgl0aGlzLnRyYW5zcGFyZW50ID0gdHJhbnNwYXJlbnQgPT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHRyYW5zcGFyZW50OwoJCgl0aGlzLmJhdGNocyA9IFtdOwoJdGhpcy50b1JlbW92ZSA9IFtdOwoJLy8gY29uc29sZS5sb2codGhpcy50cmFuc3BhcmVudCkKCXRoaXMuZmlsdGVyTWFuYWdlciA9IG5ldyBQSVhJLldlYkdMRmlsdGVyTWFuYWdlcih0aGlzLnRyYW5zcGFyZW50KTsKfQoKLy8gY29uc3RydWN0b3IKUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuV2ViR0xSZW5kZXJHcm91cDsKCi8qKgogKiBBZGQgYSBkaXNwbGF5IG9iamVjdCB0byB0aGUgd2ViZ2wgcmVuZGVyZXIKICoKICogQG1ldGhvZCBzZXRSZW5kZXJhYmxlCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZSAKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuc2V0UmVuZGVyYWJsZSA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCS8vIGhhcyB0aGlzIGNoYW5nZWQ/PwoJaWYodGhpcy5yb290KXRoaXMucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKHRoaXMucm9vdCk7CgkKCWRpc3BsYXlPYmplY3Qud29ybGRWaXNpYmxlID0gZGlzcGxheU9iamVjdC52aXNpYmxlOwoJCgkvLyBzb29vb29vIC8vCgkvLyB0byBjaGVjayBpZiBhbnkgYmF0Y2hzIGV4aXN0IGFscmVhZHk/PwoJCgkvLyBUT0RPIHdoYXQgaWYgaXRzIGFscmVhZHkgaGFzIGFuIG9iamVjdD8gc2hvdWxkIHJlbW92ZSBpdAoJdGhpcy5yb290ID0gZGlzcGxheU9iamVjdDsKCXRoaXMuYWRkRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGRpc3BsYXlPYmplY3QpOwp9CgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIHdlYmdsIHZpZXcKICoKICogQG1ldGhvZCByZW5kZXIKICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24ocHJvamVjdGlvbiwgYnVmZmVyKQp7CglQSVhJLldlYkdMUmVuZGVyZXIudXBkYXRlVGV4dHVyZXMoKTsKCQoJdmFyIGdsID0gdGhpcy5nbDsKCWdsLnVuaWZvcm0yZihQSVhJLmRlZmF1bHRTaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCBwcm9qZWN0aW9uLnkpOwoKCXRoaXMuZmlsdGVyTWFuYWdlci5iZWdpbihwcm9qZWN0aW9uLCBidWZmZXIpOwoKCQoJZ2wuYmxlbmRGdW5jKGdsLk9ORSwgZ2wuT05FX01JTlVTX1NSQ19BTFBIQSk7CgkvLyB3aWxsIHJlbmRlciBhbGwgdGhlIGVsZW1lbnRzIGluIHRoZSBncm91cAoJdmFyIHJlbmRlcmFibGU7CgoJZm9yICh2YXIgaT0wOyBpIDwgdGhpcy5iYXRjaHMubGVuZ3RoOyBpKyspIAoJewoJCQoJCXJlbmRlcmFibGUgPSB0aGlzLmJhdGNoc1tpXTsKCQlpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJdGhpcy5iYXRjaHNbaV0ucmVuZGVyKCk7CgkJCWNvbnRpbnVlOwoJCX0KCQkKCQkvLyByZW5kZXIgc3BlY2lhbAoJCXRoaXMucmVuZGVyU3BlY2lhbChyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCX0KCQp9CgovKioKICogUmVuZGVycyBhIHNwZWNpZmljIGRpc3BsYXlPYmplY3QKICoKICogQG1ldGhvZCByZW5kZXJTcGVjaWZpYwogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHBhcmFtIHByb2plY3Rpb24ge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyU3BlY2lmaWMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwcm9qZWN0aW9uLCBidWZmZXIpCnsKCVBJWEkuV2ViR0xSZW5kZXJlci51cGRhdGVUZXh0dXJlcygpOwoJdmFyIGdsID0gdGhpcy5nbDsKCglnbC51bmlmb3JtMmYoUElYSS5kZWZhdWx0U2hhZGVyLnByb2plY3Rpb25WZWN0b3IsIHByb2plY3Rpb24ueCwgcHJvamVjdGlvbi55KTsKCgl0aGlzLmZpbHRlck1hbmFnZXIuYmVnaW4ocHJvamVjdGlvbiwgYnVmZmVyKTsKCgkvLyB0byBkbyEKCS8vIHJlbmRlciBwYXJ0IG9mIHRoZSBzY2VuZS4uLgoJCgl2YXIgc3RhcnRJbmRleDsKCXZhciBzdGFydEJhdGNoSW5kZXg7CgkKCXZhciBlbmRJbmRleDsKCXZhciBlbmRCYXRjaEluZGV4OwoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgbmV4dFJlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJd2hpbGUobmV4dFJlbmRlcmFibGUuX2lOZXh0KQoJewoJCWlmKG5leHRSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbmV4dFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCQluZXh0UmVuZGVyYWJsZSA9IG5leHRSZW5kZXJhYmxlLl9pTmV4dDsKCX0KCXZhciBzdGFydEJhdGNoID0gbmV4dFJlbmRlcmFibGUuYmF0Y2g7CgkvL2NvbnNvbGUubG9nKG5leHRSZW5kZXJhYmxlKTsKCQoJLy9jb25zb2xlLmxvZyhyZW5kZXJhYmxlKQoJaWYobmV4dFJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQlzdGFydEJhdGNoID0gbmV4dFJlbmRlcmFibGUuYmF0Y2g7CgkJCgkJdmFyIGhlYWQgPSBzdGFydEJhdGNoLmhlYWQ7CgkJdmFyIG5leHQgPSBoZWFkOwoJCQoJCS8vIG9rIG5vdyB3ZSBoYXZlIHRoZSBiYXRjaC4uIG5lZWQgdG8gZmluZCB0aGUgc3RhcnQgaW5kZXghCgkJaWYoaGVhZCA9PSBuZXh0UmVuZGVyYWJsZSkKCQl7CgkJCXN0YXJ0SW5kZXggPSAwOwoJCX0KCQllbHNlCgkJewoJCQlzdGFydEluZGV4ID0gMTsKCQkJCgkJCXdoaWxlKGhlYWQuX19uZXh0ICE9IG5leHRSZW5kZXJhYmxlKQoJCQl7CgkJCQlzdGFydEluZGV4Kys7CgkJCQloZWFkID0gaGVhZC5fX25leHQ7CgkJCX0KCQl9Cgl9CgllbHNlCgl7CgkJc3RhcnRCYXRjaCA9IG5leHRSZW5kZXJhYmxlOwoJfQoJCgkvLyBHZXQgdGhlIExBU1QgcmVuZGVyYWJsZSBvYmplY3QKCXZhciBsYXN0UmVuZGVyYWJsZSA9IGRpc3BsYXlPYmplY3QubGFzdDsKCXdoaWxlKGxhc3RSZW5kZXJhYmxlLl9pUHJldikKCXsKCQlpZihsYXN0UmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIGxhc3RSZW5kZXJhYmxlLl9fcmVuZGVyR3JvdXApYnJlYWs7CgkJbGFzdFJlbmRlcmFibGUgPSBsYXN0UmVuZGVyYWJsZS5faU5leHQ7Cgl9CgkKCWlmKGxhc3RSZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJZW5kQmF0Y2ggPSBsYXN0UmVuZGVyYWJsZS5iYXRjaDsKCQkKCQl2YXIgaGVhZCA9IGVuZEJhdGNoLmhlYWQ7CgkJCgkJaWYoaGVhZCA9PSBsYXN0UmVuZGVyYWJsZSkKCQl7CgkJCWVuZEluZGV4ID0gMDsKCQl9CgkJZWxzZQoJCXsKCQkJZW5kSW5kZXggPSAxOwoJCQkKCQkJd2hpbGUoaGVhZC5fX25leHQgIT0gbGFzdFJlbmRlcmFibGUpCgkJCXsKCQkJCWVuZEluZGV4Kys7CgkJCQloZWFkID0gaGVhZC5fX25leHQ7CgkJCX0KCQl9Cgl9CgllbHNlCgl7CgkJZW5kQmF0Y2ggPSBsYXN0UmVuZGVyYWJsZTsKCX0KCQoJLy9jb25zb2xlLmxvZyhlbmRCYXRjaCk7CgkvLyBUT0RPIC0gbmVlZCB0byBmb2xkIHRoaXMgdXAgYSBiaXQhCgkKCWlmKHN0YXJ0QmF0Y2ggPT0gZW5kQmF0Y2gpCgl7CgkJaWYoc3RhcnRCYXRjaCBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaCkKCQl7CgkJCXN0YXJ0QmF0Y2gucmVuZGVyKHN0YXJ0SW5kZXgsIGVuZEluZGV4KzEpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLnJlbmRlclNwZWNpYWwoc3RhcnRCYXRjaCwgcHJvamVjdGlvbik7CgkJfQoJCXJldHVybjsKCX0KCQoJLy8gbm93IHdlIGhhdmUgZmlyc3QgYW5kIGxhc3QhCglzdGFydEJhdGNoSW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKHN0YXJ0QmF0Y2gpOwoJZW5kQmF0Y2hJbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoZW5kQmF0Y2gpOwoJCgkvLyBETyB0aGUgZmlyc3QgYmF0Y2gKCWlmKHN0YXJ0QmF0Y2ggaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgl7CgkJc3RhcnRCYXRjaC5yZW5kZXIoc3RhcnRJbmRleCk7Cgl9CgllbHNlCgl7CgkJdGhpcy5yZW5kZXJTcGVjaWFsKHN0YXJ0QmF0Y2gsIHByb2plY3Rpb24pOwoJfQoJCgkvLyBETyB0aGUgbWlkZGxlIGJhdGNocy4uCglmb3IgKHZhciBpPXN0YXJ0QmF0Y2hJbmRleCsxOyBpIDwgZW5kQmF0Y2hJbmRleDsgaSsrKSAKCXsKCQlyZW5kZXJhYmxlID0gdGhpcy5iYXRjaHNbaV07CgkKCQlpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJCXsKCQkJdGhpcy5iYXRjaHNbaV0ucmVuZGVyKCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMucmVuZGVyU3BlY2lhbChyZW5kZXJhYmxlLCBwcm9qZWN0aW9uKTsKCQl9Cgl9CgkKCS8vIERPIHRoZSBsYXN0IGJhdGNoLi4KCWlmKGVuZEJhdGNoIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKQoJewoJCWVuZEJhdGNoLnJlbmRlcigwLCBlbmRJbmRleCsxKTsKCX0KCWVsc2UKCXsKCQl0aGlzLnJlbmRlclNwZWNpYWwoZW5kQmF0Y2gsIHByb2plY3Rpb24pOwoJfQp9CgovKioKICogUmVuZGVycyBhIHNwZWNpZmljIHJlbmRlcmFibGUKICoKICogQG1ldGhvZCByZW5kZXJTcGVjaWFsCiAqIEBwYXJhbSByZW5kZXJhYmxlIHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW5kZXJTcGVjaWFsID0gZnVuY3Rpb24ocmVuZGVyYWJsZSwgcHJvamVjdGlvbikKewoJCgl2YXIgd29ybGRWaXNpYmxlID0gcmVuZGVyYWJsZS52Y291bnQgPT09IFBJWEkudmlzaWJsZUNvdW50CgoKCWlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLlRpbGluZ1Nwcml0ZSkKCXsKCQlpZih3b3JsZFZpc2libGUpdGhpcy5yZW5kZXJUaWxpbmdTcHJpdGUocmVuZGVyYWJsZSwgcHJvamVjdGlvbik7Cgl9CgllbHNlIGlmKHJlbmRlcmFibGUgaW5zdGFuY2VvZiBQSVhJLlN0cmlwKQoJewoJCWlmKHdvcmxkVmlzaWJsZSl0aGlzLnJlbmRlclN0cmlwKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQoJZWxzZSBpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5DdXN0b21SZW5kZXJhYmxlKQoJewoJCWlmKHdvcmxkVmlzaWJsZSkgcmVuZGVyYWJsZS5yZW5kZXJXZWJHTCh0aGlzLCBwcm9qZWN0aW9uKTsKCX0KCWVsc2UgaWYocmVuZGVyYWJsZSBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCgl7CgkJaWYod29ybGRWaXNpYmxlICYmIHJlbmRlcmFibGUucmVuZGVyYWJsZSkgUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQoJZWxzZSBpZihyZW5kZXJhYmxlIGluc3RhbmNlb2YgUElYSS5GaWx0ZXJCbG9jaykKCXsKCQl0aGlzLmhhbmRsZUZpbHRlckJsb2NrKHJlbmRlcmFibGUsIHByb2plY3Rpb24pOwoJfQp9CgpmbGlwID0gZmFsc2U7CnZhciBtYXNrU3RhY2sgPSBbXTsKdmFyIG1hc2tQb3NpdGlvbiA9IDA7CgovL3ZhciB1c2VkTWFza1N0YWNrID0gW107CgpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmhhbmRsZUZpbHRlckJsb2NrID0gZnVuY3Rpb24oZmlsdGVyQmxvY2ssIHByb2plY3Rpb24pCnsKCS8qCgkgKiBmb3Igbm93IG9ubHkgbWFza3MgYXJlIHN1cHBvcnRlZC4uCgkgKi8KCXZhciBnbCA9IFBJWEkuZ2w7CgkKCWlmKGZpbHRlckJsb2NrLm9wZW4pCgl7CgkJaWYoZmlsdGVyQmxvY2suZGF0YSBpbnN0YW5jZW9mIEFycmF5KQoJCXsKCQkJdGhpcy5maWx0ZXJNYW5hZ2VyLnB1c2hGaWx0ZXIoZmlsdGVyQmxvY2spOwoJCQkvLyBvayBzby4uCgkJCQoJCX0KCQllbHNlCgkJewkKCQkJbWFza1Bvc2l0aW9uKys7CgoJCQltYXNrU3RhY2sucHVzaChmaWx0ZXJCbG9jaykKCQoJCQlnbC5lbmFibGUoZ2wuU1RFTkNJTF9URVNUKTsKCQkJCgkJCWdsLmNvbG9yTWFzayhmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSk7CgkJCQoJCQlnbC5zdGVuY2lsRnVuYyhnbC5BTFdBWVMsMSwxKTsKCQkJZ2wuc3RlbmNpbE9wKGdsLktFRVAsZ2wuS0VFUCxnbC5JTkNSKTsKCQoJCQlQSVhJLldlYkdMR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MoZmlsdGVyQmxvY2suZGF0YSwgcHJvamVjdGlvbik7CgkJCQoJCQlnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7CgkJCWdsLnN0ZW5jaWxGdW5jKGdsLk5PVEVRVUFMLDAsbWFza1N0YWNrLmxlbmd0aCk7CgkJCWdsLnN0ZW5jaWxPcChnbC5LRUVQLGdsLktFRVAsZ2wuS0VFUCk7CgkJfQoJfQoJZWxzZQoJewoJCWlmKGZpbHRlckJsb2NrLmRhdGEgaW5zdGFuY2VvZiBBcnJheSkKCQl7CgkJCXRoaXMuZmlsdGVyTWFuYWdlci5wb3BGaWx0ZXIoKTsKCQl9CgkJZWxzZQoJCXsKCQkJdmFyIG1hc2tEYXRhID0gbWFza1N0YWNrLnBvcChmaWx0ZXJCbG9jaykKCgoJCQlpZihtYXNrRGF0YSkKCQkJewoJCQkJZ2wuY29sb3JNYXNrKGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlKTsKCQkJCgkJCQlnbC5zdGVuY2lsRnVuYyhnbC5BTFdBWVMsMSwxKTsKCQkJCWdsLnN0ZW5jaWxPcChnbC5LRUVQLGdsLktFRVAsZ2wuREVDUik7CgoJCQkJUElYSS5XZWJHTEdyYXBoaWNzLnJlbmRlckdyYXBoaWNzKG1hc2tEYXRhLmRhdGEsIHByb2plY3Rpb24pOwoJCQkKCQkJCWdsLmNvbG9yTWFzayh0cnVlLCB0cnVlLCB0cnVlLCB0cnVlKTsKCQkJCWdsLnN0ZW5jaWxGdW5jKGdsLk5PVEVRVUFMLDAsbWFza1N0YWNrLmxlbmd0aCk7CgkJCQlnbC5zdGVuY2lsT3AoZ2wuS0VFUCxnbC5LRUVQLGdsLktFRVApOwoJCQl9OwoKCQkJZ2wuZGlzYWJsZShnbC5TVEVOQ0lMX1RFU1QpOwoJCX0KCX0KfQoKLyoqCiAqIFVwZGF0ZXMgYSB3ZWJnbCB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZQogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUudXBkYXRlVGV4dHVyZSA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCQoJLy8gVE9ETyBkZWZpbml0ZWx5IGNhbiBvcHRpbXNlIHRoaXMgZnVuY3Rpb24uLgoJCgl0aGlzLnJlbW92ZU9iamVjdChkaXNwbGF5T2JqZWN0KTsKCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgUFJFVklPVVMgUkVOREVSQUJMRQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgcHJldmlvdXMgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIEl0IGtlZXBzIGdvaW5nIGJhY2sgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgdGhlIHN0YWdlCgkgKi8KCXZhciBwcmV2aW91c1JlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJd2hpbGUocHJldmlvdXNSZW5kZXJhYmxlICE9IHRoaXMucm9vdCkKCXsKCQlwcmV2aW91c1JlbmRlcmFibGUgPSBwcmV2aW91c1JlbmRlcmFibGUuX2lQcmV2OwoJCWlmKHByZXZpb3VzUmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIHByZXZpb3VzUmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBORVhUIFNQUklURQoJICogIFRoaXMgcGFydCBsb29rcyBmb3IgdGhlIGNsb3Nlc3QgbmV4dCBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgaXQga2VlcHMgbG9va2luZyB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciBnZXRzIHRvIHRoZSBlbmQgb2YgdGhlIGRpc3BsYXkKCSAqICBzY2VuZSBncmFwaAoJICovCgl2YXIgbmV4dFJlbmRlcmFibGUgPSBkaXNwbGF5T2JqZWN0Lmxhc3Q7Cgl3aGlsZShuZXh0UmVuZGVyYWJsZS5faU5leHQpCgl7CgkJbmV4dFJlbmRlcmFibGUgPSBuZXh0UmVuZGVyYWJsZS5faU5leHQ7CgkJaWYobmV4dFJlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBuZXh0UmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJCgl0aGlzLmluc2VydE9iamVjdChkaXNwbGF5T2JqZWN0LCBwcmV2aW91c1JlbmRlcmFibGUsIG5leHRSZW5kZXJhYmxlKTsKfQoKLyoqCiAqIEFkZHMgZmlsdGVyIGJsb2NrcwogKgogKiBAbWV0aG9kIGFkZEZpbHRlckJsb2NrcwogKiBAcGFyYW0gc3RhcnQge0ZpbHRlckJsb2NrfQogKiBAcGFyYW0gZW5kIHtGaWx0ZXJCbG9ja30KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuYWRkRmlsdGVyQmxvY2tzID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkKewoJc3RhcnQuX19yZW5kZXJHcm91cCA9IHRoaXM7CgllbmQuX19yZW5kZXJHcm91cCA9IHRoaXM7CgkvKgoJICogIExPT0sgRk9SIFRIRSBQUkVWSU9VUyBSRU5ERVJBQkxFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBwcmV2aW91cyBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgSXQga2VlcHMgZ29pbmcgYmFjayB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciB0aGUgc3RhZ2UKCSAqLwoJdmFyIHByZXZpb3VzUmVuZGVyYWJsZSA9IHN0YXJ0OwoJd2hpbGUocHJldmlvdXNSZW5kZXJhYmxlICE9IHRoaXMucm9vdC5maXJzdCkKCXsKCQlwcmV2aW91c1JlbmRlcmFibGUgPSBwcmV2aW91c1JlbmRlcmFibGUuX2lQcmV2OwoJCWlmKHByZXZpb3VzUmVuZGVyYWJsZS5yZW5kZXJhYmxlICYmIHByZXZpb3VzUmVuZGVyYWJsZS5fX3JlbmRlckdyb3VwKWJyZWFrOwoJfQoJdGhpcy5pbnNlcnRBZnRlcihzdGFydCwgcHJldmlvdXNSZW5kZXJhYmxlKTsKCQkKCS8qCgkgKiAgTE9PSyBGT1IgVEhFIE5FWFQgU1BSSVRFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBuZXh0IHNwcml0ZSB0aGF0IGNhbiBnbyBpbnRvIGEgYmF0Y2gKCSAqICBpdCBrZWVwcyBsb29raW5nIHVudGlsIGl0IGZpbmRzIGEgc3ByaXRlIG9yIGdldHMgdG8gdGhlIGVuZCBvZiB0aGUgZGlzcGxheQoJICogIHNjZW5lIGdyYXBoCgkgKi8KCXZhciBwcmV2aW91c1JlbmRlcmFibGUyID0gZW5kOwoJd2hpbGUocHJldmlvdXNSZW5kZXJhYmxlMiAhPSB0aGlzLnJvb3QuZmlyc3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlMiA9IHByZXZpb3VzUmVuZGVyYWJsZTIuX2lQcmV2OwoJCWlmKHByZXZpb3VzUmVuZGVyYWJsZTIucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUyLl9fcmVuZGVyR3JvdXApYnJlYWs7Cgl9Cgl0aGlzLmluc2VydEFmdGVyKGVuZCwgcHJldmlvdXNSZW5kZXJhYmxlMik7Cn0KCi8qKgogKiBSZW1vdmUgZmlsdGVyIGJsb2NrcwogKgogKiBAbWV0aG9kIHJlbW92ZUZpbHRlckJsb2NrcwogKiBAcGFyYW0gc3RhcnQge0ZpbHRlckJsb2NrfQogKiBAcGFyYW0gZW5kIHtGaWx0ZXJCbG9ja30KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVtb3ZlRmlsdGVyQmxvY2tzID0gZnVuY3Rpb24oc3RhcnQsIGVuZCkKewoJdGhpcy5yZW1vdmVPYmplY3Qoc3RhcnQpOwoJdGhpcy5yZW1vdmVPYmplY3QoZW5kKTsKfQoKLyoqCiAqIEFkZHMgYSBkaXNwbGF5IG9iamVjdCBhbmQgY2hpbGRyZW4gdG8gdGhlIHdlYmdsIGNvbnRleHQKICoKICogQG1ldGhvZCBhZGREaXNwbGF5T2JqZWN0QW5kQ2hpbGRyZW4KICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmFkZERpc3BsYXlPYmplY3RBbmRDaGlsZHJlbiA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QpCnsKCWlmKGRpc3BsYXlPYmplY3QuX19yZW5kZXJHcm91cClkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXAucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuKGRpc3BsYXlPYmplY3QpOwoJCgkvKgoJICogIExPT0sgRk9SIFRIRSBQUkVWSU9VUyBSRU5ERVJBQkxFCgkgKiAgVGhpcyBwYXJ0IGxvb2tzIGZvciB0aGUgY2xvc2VzdCBwcmV2aW91cyBzcHJpdGUgdGhhdCBjYW4gZ28gaW50byBhIGJhdGNoCgkgKiAgSXQga2VlcHMgZ29pbmcgYmFjayB1bnRpbCBpdCBmaW5kcyBhIHNwcml0ZSBvciB0aGUgc3RhZ2UKCSAqLwoJCgl2YXIgcHJldmlvdXNSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXdoaWxlKHByZXZpb3VzUmVuZGVyYWJsZSAhPSB0aGlzLnJvb3QuZmlyc3QpCgl7CgkJcHJldmlvdXNSZW5kZXJhYmxlID0gcHJldmlvdXNSZW5kZXJhYmxlLl9pUHJldjsKCQlpZihwcmV2aW91c1JlbmRlcmFibGUucmVuZGVyYWJsZSAmJiBwcmV2aW91c1JlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJLyoKCSAqICBMT09LIEZPUiBUSEUgTkVYVCBTUFJJVEUKCSAqICBUaGlzIHBhcnQgbG9va3MgZm9yIHRoZSBjbG9zZXN0IG5leHQgc3ByaXRlIHRoYXQgY2FuIGdvIGludG8gYSBiYXRjaAoJICogIGl0IGtlZXBzIGxvb2tpbmcgdW50aWwgaXQgZmluZHMgYSBzcHJpdGUgb3IgZ2V0cyB0byB0aGUgZW5kIG9mIHRoZSBkaXNwbGF5CgkgKiAgc2NlbmUgZ3JhcGgKCSAqLwoJdmFyIG5leHRSZW5kZXJhYmxlID0gZGlzcGxheU9iamVjdC5sYXN0OwoJd2hpbGUobmV4dFJlbmRlcmFibGUuX2lOZXh0KQoJewoJCW5leHRSZW5kZXJhYmxlID0gbmV4dFJlbmRlcmFibGUuX2lOZXh0OwoJCWlmKG5leHRSZW5kZXJhYmxlLnJlbmRlcmFibGUgJiYgbmV4dFJlbmRlcmFibGUuX19yZW5kZXJHcm91cClicmVhazsKCX0KCQoJLy8gb25lIHRoZSBkaXNwbGF5IG9iamVjdCBoaXRzIHRoaXMuIHdlIGNhbiBicmVhayB0aGUgbG9vcAkKCQoJdmFyIHRlbXBPYmplY3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJdmFyIHRlc3RPYmplY3QgPSBkaXNwbGF5T2JqZWN0Lmxhc3QuX2lOZXh0OwoJZG8JCgl7CgkJdGVtcE9iamVjdC5fX3JlbmRlckdyb3VwID0gdGhpczsKCQkKCQlpZih0ZW1wT2JqZWN0LnJlbmRlcmFibGUpCgkJewoJCQoJCQl0aGlzLmluc2VydE9iamVjdCh0ZW1wT2JqZWN0LCBwcmV2aW91c1JlbmRlcmFibGUsIG5leHRSZW5kZXJhYmxlKTsKCQkJcHJldmlvdXNSZW5kZXJhYmxlID0gdGVtcE9iamVjdDsKCQl9CgkJCgkJdGVtcE9iamVjdCA9IHRlbXBPYmplY3QuX2lOZXh0OwoJfQoJd2hpbGUodGVtcE9iamVjdCAhPSB0ZXN0T2JqZWN0KQp9CgovKioKICogUmVtb3ZlcyBhIGRpc3BsYXkgb2JqZWN0IGFuZCBjaGlsZHJlbiB0byB0aGUgd2ViZ2wgY29udGV4dAogKgogKiBAbWV0aG9kIHJlbW92ZURpc3BsYXlPYmplY3RBbmRDaGlsZHJlbgogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVtb3ZlRGlzcGxheU9iamVjdEFuZENoaWxkcmVuID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJaWYoZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwICE9IHRoaXMpcmV0dXJuOwoJCi8vCXZhciBkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5maXJzdDsKCXZhciBsYXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0OwoJZG8JCgl7CgkJZGlzcGxheU9iamVjdC5fX3JlbmRlckdyb3VwID0gbnVsbDsKCQlpZihkaXNwbGF5T2JqZWN0LnJlbmRlcmFibGUpdGhpcy5yZW1vdmVPYmplY3QoZGlzcGxheU9iamVjdCk7CgkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwoJfQoJd2hpbGUoZGlzcGxheU9iamVjdCkKfQoKLyoqCiAqIEluc2VydHMgYSBkaXNwbGF5T2JqZWN0IGludG8gdGhlIGxpbmtlZCBsaXN0CiAqCiAqIEBtZXRob2QgaW5zZXJ0T2JqZWN0CiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gcHJldmlvdXNPYmplY3Qge0Rpc3BsYXlPYmplY3R9CiAqIEBwYXJhbSBuZXh0T2JqZWN0IHtEaXNwbGF5T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5pbnNlcnRPYmplY3QgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwcmV2aW91c09iamVjdCwgbmV4dE9iamVjdCkKewoJLy8gd2hpbGUgbG9vcGluZyBiZWxvdyBUSEUgT0JKRUNUIE1BWSBOT1QgSEFWRSBCRUVOIEFEREVECgl2YXIgcHJldmlvdXNTcHJpdGUgPSBwcmV2aW91c09iamVjdDsKCXZhciBuZXh0U3ByaXRlID0gbmV4dE9iamVjdDsKCQoJLyoKCSAqIHNvIG5vdyB3ZSBoYXZlIHRoZSBuZXh0IHJlbmRlcmFibGUgYW5kIHRoZSBwcmV2aW91cyByZW5kZXJhYmxlCgkgKiAKCSAqLwoJaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3ByaXRlKQoJewoJCXZhciBwcmV2aW91c0JhdGNoCgkJdmFyIG5leHRCYXRjaAoJCQoJCWlmKHByZXZpb3VzU3ByaXRlIGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJewoJCQlwcmV2aW91c0JhdGNoID0gcHJldmlvdXNTcHJpdGUuYmF0Y2g7CgkJCWlmKHByZXZpb3VzQmF0Y2gpCgkJCXsKCQkJCWlmKHByZXZpb3VzQmF0Y2gudGV4dHVyZSA9PSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuYmFzZVRleHR1cmUgJiYgcHJldmlvdXNCYXRjaC5ibGVuZE1vZGUgPT0gZGlzcGxheU9iamVjdC5ibGVuZE1vZGUpCgkJCQl7CgkJCQkJcHJldmlvdXNCYXRjaC5pbnNlcnRBZnRlcihkaXNwbGF5T2JqZWN0LCBwcmV2aW91c1Nwcml0ZSk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCS8vIFRPRE8gcmV3b3JkIQoJCQlwcmV2aW91c0JhdGNoID0gcHJldmlvdXNTcHJpdGU7CgkJfQoJCgkJaWYobmV4dFNwcml0ZSkKCQl7CgkJCWlmKG5leHRTcHJpdGUgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCQkJewoJCQkJbmV4dEJhdGNoID0gbmV4dFNwcml0ZS5iYXRjaDsKCQkJCgkJCQkvL2JhdGNoIG1heSBub3QgZXhpc3QgaWYgaXRlbSB3YXMgYWRkZWQgdG8gdGhlIGRpc3BsYXkgbGlzdCBidXQgbm90IHRvIHRoZSB3ZWJHTAoJCQkJaWYobmV4dEJhdGNoKQoJCQkJewoJCQkJCWlmKG5leHRCYXRjaC50ZXh0dXJlID09IGRpc3BsYXlPYmplY3QudGV4dHVyZS5iYXNlVGV4dHVyZSAmJiBuZXh0QmF0Y2guYmxlbmRNb2RlID09IGRpc3BsYXlPYmplY3QuYmxlbmRNb2RlKQoJCQkJCXsKCQkJCQkJbmV4dEJhdGNoLmluc2VydEJlZm9yZShkaXNwbGF5T2JqZWN0LCBuZXh0U3ByaXRlKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCQllbHNlCgkJCQkJewoJCQkJCQlpZihuZXh0QmF0Y2ggPT0gcHJldmlvdXNCYXRjaCkKCQkJCQkJewoJCQkJCQkJLy8gVEhFUkUgSVMgQSBTUExJVCBJTiBUSElTIEJBVENIISAvLwoJCQkJCQkJdmFyIHNwbGl0QmF0Y2ggPSBwcmV2aW91c0JhdGNoLnNwbGl0KG5leHRTcHJpdGUpOwoJCQkJCQkJLy8gQ09PTCEKCQkJCQkJCS8vIGFkZCBpdCBiYWNrIGludG8gdGhlIGFycmF5CQoJCQkJCQkJLyoKCQkJCQkJCSAqIE9PUFMhCgkJCQkJCQkgKiBzZWVtcyB0aGUgbmV3IHNwcml0ZSBpcyBpbiB0aGUgbWlkZGxlIG9mIGEgYmF0Y2gKCQkJCQkJCSAqIGxldHMgc3BsaXQgaXQuLiAKCQkJCQkJCSAqLwoJCQkJCQkJdmFyIGJhdGNoID0gUElYSS5XZWJHTFJlbmRlcmVyLmdldEJhdGNoKCk7CgoJCQkJCQkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggcHJldmlvdXNCYXRjaCApOwoJCQkJCQkJYmF0Y2guaW5pdChkaXNwbGF5T2JqZWN0KTsKCQkJCQkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBiYXRjaCwgc3BsaXRCYXRjaCk7CgkJCQkJCQkKCQkJCQkJCXJldHVybjsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCQllbHNlCgkJCXsKCQkJCS8vIFRPRE8gcmUtd29yZCEKCQkJCQoJCQkJbmV4dEJhdGNoID0gbmV4dFNwcml0ZTsKCQkJfQoJCX0KCQkKCQkvKgoJCSAqIGxvb2tzIGxpa2UgaXQgZG9lcyBub3QgYmVsb25nIHRvIGFueSBiYXRjaCEKCQkgKiBidXQgaXMgYWxzbyBub3QgaW50ZXJzZWN0aW5nIG9uZS4uCgkJICogdGltZSB0byBjcmVhdGUgYW5ldyBvbmUhCgkJICovCgkJCgkJdmFyIGJhdGNoID0gIFBJWEkuV2ViR0xSZW5kZXJlci5nZXRCYXRjaCgpOwoJCWJhdGNoLmluaXQoZGlzcGxheU9iamVjdCk7CgoJCWlmKHByZXZpb3VzQmF0Y2gpIC8vIGlmIHRoaXMgaXMgaW52YWxpZCBpdCBtZWFucyAKCQl7CgkJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIHByZXZpb3VzQmF0Y2ggKTsKCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4KzEsIDAsIGJhdGNoKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5iYXRjaHMucHVzaChiYXRjaCk7CgkJfQoJCQoJCXJldHVybjsKCX0KCWVsc2UgaWYoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuVGlsaW5nU3ByaXRlKQoJewoJCQoJCS8vIGFkZCB0byBhIGJhdGNoISEKCQl0aGlzLmluaXRUaWxpbmdTcHJpdGUoZGlzcGxheU9iamVjdCk7CgkvLwl0aGlzLmJhdGNocy5wdXNoKGRpc3BsYXlPYmplY3QpOwoJCQoJfQoJZWxzZSBpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TdHJpcCkKCXsKCQkvLyBhZGQgdG8gYSBiYXRjaCEhCgkJdGhpcy5pbml0U3RyaXAoZGlzcGxheU9iamVjdCk7CgkvLwl0aGlzLmJhdGNocy5wdXNoKGRpc3BsYXlPYmplY3QpOwoJfQoJZWxzZSBpZihkaXNwbGF5T2JqZWN0KS8vIGluc3RhbmNlb2YgUElYSS5HcmFwaGljcykKCXsKCQkvL2Rpc3BsYXlPYmplY3QuaW5pdFdlYkdMKHRoaXMpOwoJCQoJCS8vIGFkZCB0byBhIGJhdGNoISEKCQkvL3RoaXMuaW5pdFN0cmlwKGRpc3BsYXlPYmplY3QpOwoJCS8vdGhpcy5iYXRjaHMucHVzaChkaXNwbGF5T2JqZWN0KTsKCX0KCQoJdGhpcy5pbnNlcnRBZnRlcihkaXNwbGF5T2JqZWN0LCBwcmV2aW91c1Nwcml0ZSk7CgkJCQoJLy8gaW5zZXJ0IGFuZCBTUExJVCEKCn0KCi8qKgogKiBJbnNlcnRzIGEgZGlzcGxheU9iamVjdCBpbnRvIHRoZSBsaW5rZWQgbGlzdAogKgogKiBAbWV0aG9kIGluc2VydEFmdGVyCiAqIEBwYXJhbSBpdGVtIHtEaXNwbGF5T2JqZWN0fQogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIG9iamVjdCB0byBpbnNlcnQKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaW5zZXJ0QWZ0ZXIgPSBmdW5jdGlvbihpdGVtLCBkaXNwbGF5T2JqZWN0KQp7CglpZihkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgl7CgkJdmFyIHByZXZpb3VzQmF0Y2ggPSBkaXNwbGF5T2JqZWN0LmJhdGNoOwoJCQoJCWlmKHByZXZpb3VzQmF0Y2gpCgkJewoJCQkvLyBzbyB0aGlzIG9iamVjdCBpcyBpbiBhIGJhdGNoIQoJCQkKCQkJLy8gaXMgaXQgbm90PyBuZWVkIHRvIHNwbGl0IHRoZSBiYXRjaAoJCQlpZihwcmV2aW91c0JhdGNoLnRhaWwgPT0gZGlzcGxheU9iamVjdCkKCQkJewoJCQkJLy8gaXMgaXQgdGFpbD8gaW5zZXJ0IGluIHRvIGJhdGNocwkKCQkJCXZhciBpbmRleCA9IHRoaXMuYmF0Y2hzLmluZGV4T2YoIHByZXZpb3VzQmF0Y2ggKTsKCQkJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBpdGVtKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCS8vIFRPRE8gTU9ESUZZIEFERCAvIFJFTU9WRSBDSElMRCBUTyBBQ0NPVU5UIEZPUiBGSUxURVJTIChhbHNvIGdldCBwcmV2IGFuZCBuZXh0KSAvLwoJCQkJCgkJCQkvLyBUSEVSRSBJUyBBIFNQTElUIElOIFRISVMgQkFUQ0ghIC8vCgkJCQl2YXIgc3BsaXRCYXRjaCA9IHByZXZpb3VzQmF0Y2guc3BsaXQoZGlzcGxheU9iamVjdC5fX25leHQpOwoJCQkJCgkJCQkvLyBDT09MIQoJCQkJLy8gYWRkIGl0IGJhY2sgaW50byB0aGUgYXJyYXkJCgkJCQkvKgoJCQkJICogT09QUyEKCQkJCSAqIHNlZW1zIHRoZSBuZXcgc3ByaXRlIGlzIGluIHRoZSBtaWRkbGUgb2YgYSBiYXRjaAoJCQkJICogbGV0cyBzcGxpdCBpdC4uIAoJCQkJICovCgkJCQl2YXIgaW5kZXggPSB0aGlzLmJhdGNocy5pbmRleE9mKCBwcmV2aW91c0JhdGNoICk7CgkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgrMSwgMCwgaXRlbSwgc3BsaXRCYXRjaCk7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5iYXRjaHMucHVzaChpdGVtKTsKCQl9Cgl9CgllbHNlCgl7CgkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggZGlzcGxheU9iamVjdCApOwoJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCsxLCAwLCBpdGVtKTsKCX0KfQoKLyoqCiAqIFJlbW92ZXMgYSBkaXNwbGF5T2JqZWN0IGZyb20gdGhlIGxpbmtlZCBsaXN0CiAqCiAqIEBtZXRob2QgcmVtb3ZlT2JqZWN0CiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgb2JqZWN0IHRvIHJlbW92ZQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW1vdmVPYmplY3QgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0KQp7CgkvLyBsb29wIHRocm91Z2ggY2hpbGRyZW4uLgoJLy8gZGlzcGxheSBvYmplY3QgLy8KCQoJLy8gYWRkIGEgY2hpbGQgZnJvbSB0aGUgcmVuZGVyIGdyb3VwLi4KCS8vIHJlbW92ZSBpdCBhbmQgYWxsIGl0cyBjaGlsZHJlbiEKCS8vZGlzcGxheU9iamVjdC5jYWNoZVZpc2libGUgPSBmYWxzZTsvL2Rpc3BsYXlPYmplY3QudmlzaWJsZTsKCgkvKgoJICogcmVtb3ZpbmcgaXMgYSBsb3QgcXVpY2tlci4uCgkgKiAKCSAqLwoJdmFyIGJhdGNoVG9SZW1vdmU7CgkKCWlmKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlNwcml0ZSkKCXsKCQkvLyBzaG91bGQgYWx3YXlzIGhhdmUgYSBiYXRjaCEKCQl2YXIgYmF0Y2ggPSBkaXNwbGF5T2JqZWN0LmJhdGNoOwoJCWlmKCFiYXRjaClyZXR1cm47IC8vIHRoaXMgbWVhbnMgdGhlIGRpc3BsYXkgbGlzdCBoYXMgYmVlbiBhbHRlcmVkIGJlZnJlIHJlbmRlcmluZwoJCQoJCWJhdGNoLnJlbW92ZShkaXNwbGF5T2JqZWN0KTsKCQkKCQlpZihiYXRjaC5zaXplPT0wKQoJCXsKCQkJYmF0Y2hUb1JlbW92ZSA9IGJhdGNoOwoJCX0KCX0KCWVsc2UKCXsKCQliYXRjaFRvUmVtb3ZlID0gZGlzcGxheU9iamVjdDsKCX0KCQoJLyoKCSAqIExvb2tzIGxpa2UgdGhlcmUgaXMgc29tdGhpbmcgdGhhdCBuZWVkcyByZW1vdmluZyEKCSAqLwoJaWYoYmF0Y2hUb1JlbW92ZSkJCgl7CgkJdmFyIGluZGV4ID0gdGhpcy5iYXRjaHMuaW5kZXhPZiggYmF0Y2hUb1JlbW92ZSApOwoJCWlmKGluZGV4ID09IC0xKXJldHVybjsvLyB0aGlzIG1lYW5zIGl0IHdhcyBhZGRlZCB0aGVuIHJlbW92ZWQgYmVmb3JlIHJlbmRlcmVkCgkJCgkJLy8gb2sgc28uLiBjaGVjayB0byBzZWUgaWYgeW91IGFkamFjZW50IGJhdGNocyBzaG91bGQgYmUgam9pbmVkLgoJCS8vIFRPRE8gbWF5IG9wdGltaXNlPwoJCWlmKGluZGV4ID09IDAgfHwgaW5kZXggPT0gdGhpcy5iYXRjaHMubGVuZ3RoLTEpCgkJewoJCQkvLyB3aGEgLSBldmEhIGp1c3QgZ2V0IG9mIHRoZSBlbXB0eSBiYXRjaCEKCQkJdGhpcy5iYXRjaHMuc3BsaWNlKGluZGV4LCAxKTsKCQkJaWYoYmF0Y2hUb1JlbW92ZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaClQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2goYmF0Y2hUb1JlbW92ZSk7CgkJCgkJCXJldHVybjsKCQl9CgkJCgkJaWYodGhpcy5iYXRjaHNbaW5kZXgtMV0gaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2ggJiYgdGhpcy5iYXRjaHNbaW5kZXgrMV0gaW5zdGFuY2VvZiBQSVhJLldlYkdMQmF0Y2gpCgkJewoJCQlpZih0aGlzLmJhdGNoc1tpbmRleC0xXS50ZXh0dXJlID09IHRoaXMuYmF0Y2hzW2luZGV4KzFdLnRleHR1cmUgJiYgdGhpcy5iYXRjaHNbaW5kZXgtMV0uYmxlbmRNb2RlID09IHRoaXMuYmF0Y2hzW2luZGV4KzFdLmJsZW5kTW9kZSkKCQkJewoJCQkJLy9jb25zb2xlLmxvZygiTUVSR0UiKQoJCQkJdGhpcy5iYXRjaHNbaW5kZXgtMV0ubWVyZ2UodGhpcy5iYXRjaHNbaW5kZXgrMV0pOwoJCQkJCgkJCQlpZihiYXRjaFRvUmVtb3ZlIGluc3RhbmNlb2YgUElYSS5XZWJHTEJhdGNoKVBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaChiYXRjaFRvUmVtb3ZlKTsKCQkJCVBJWEkuV2ViR0xSZW5kZXJlci5yZXR1cm5CYXRjaCh0aGlzLmJhdGNoc1tpbmRleCsxXSk7CgkJCQl0aGlzLmJhdGNocy5zcGxpY2UoaW5kZXgsIDIpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCQoJCXRoaXMuYmF0Y2hzLnNwbGljZShpbmRleCwgMSk7CgkJaWYoYmF0Y2hUb1JlbW92ZSBpbnN0YW5jZW9mIFBJWEkuV2ViR0xCYXRjaClQSVhJLldlYkdMUmVuZGVyZXIucmV0dXJuQmF0Y2goYmF0Y2hUb1JlbW92ZSk7Cgl9Cn0KCgovKioKICogSW5pdGlhbGl6ZXMgYSB0aWxpbmcgc3ByaXRlCiAqCiAqIEBtZXRob2QgaW5pdFRpbGluZ1Nwcml0ZQogKiBAcGFyYW0gc3ByaXRlIHtUaWxpbmdTcHJpdGV9IFRoZSB0aWxpbmcgc3ByaXRlIHRvIGluaXRpYWxpemUKICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUuaW5pdFRpbGluZ1Nwcml0ZSA9IGZ1bmN0aW9uKHNwcml0ZSkKewoJdmFyIGdsID0gdGhpcy5nbDsKCgkvLyBtYWtlIHRoZSB0ZXh0dXJlIHRpbGFibGUuLgoJCQkKCXNwcml0ZS52ZXJ0aWNpZXMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAwLAoJCQkJCQkJCQkJICBzcHJpdGUud2lkdGgsIDAsCgkJCQkJCQkJCQkgIHNwcml0ZS53aWR0aCwgIHNwcml0ZS5oZWlnaHQsCgkJCQkJCQkJCQkgMCwgIHNwcml0ZS5oZWlnaHRdKTsKCQkJCQkKCXNwcml0ZS51dnMgPSBuZXcgRmxvYXQzMkFycmF5KFswLCAwLAoJCQkJCQkJCQkxLCAwLAoJCQkJCQkJCQkxLCAxLAoJCQkJCQkJCQkwLCAxXSk7CgkJCQkKCXNwcml0ZS5jb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KFsxLDEsMSwxXSk7CgkKCXNwcml0ZS5pbmRpY2VzID0gIG5ldyBVaW50MTZBcnJheShbMCwgMSwgMywyXSkvLywgMl0pOwoJCglzcHJpdGUuX3ZlcnRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3ByaXRlLl9pbmRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3ByaXRlLl91dkJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3ByaXRlLl9jb2xvckJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJCQkJCQkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUuX3ZlcnRleEJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLnZlcnRpY2llcywgZ2wuU1RBVElDX0RSQVcpOwoKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUuX3V2QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAgc3ByaXRlLnV2cywgZ2wuRFlOQU1JQ19EUkFXKTsKCiAgICBnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLl9jb2xvckJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3ByaXRlLmNvbG9ycywgZ2wuU1RBVElDX0RSQVcpOwoKICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHNwcml0ZS5faW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3ByaXRlLmluZGljZXMsIGdsLlNUQVRJQ19EUkFXKTsKICAgIAovLyAgICByZXR1cm4gKCAoeCA+IDApICYmICgoeCAmICh4IC0gMSkpID09IDApICk7CgoJaWYoc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSkKCXsKICAgIAlnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKICAgIAlnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9TLCBnbC5SRVBFQVQpOwoJCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9XUkFQX1QsIGdsLlJFUEVBVCk7CgkJc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUuX3Bvd2VyT2YyID0gdHJ1ZTsKCX0KCWVsc2UKCXsKCQlzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5fcG93ZXJPZjIgPSB0cnVlOwoJfQp9CgovKioKICogUmVuZGVycyBhIFN0cmlwCiAqCiAqIEBtZXRob2QgcmVuZGVyU3RyaXAKICogQHBhcmFtIHN0cmlwIHtTdHJpcH0gVGhlIHN0cmlwIHRvIHJlbmRlcgogKiBAcGFyYW0gcHJvamVjdGlvbiB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5XZWJHTFJlbmRlckdyb3VwLnByb3RvdHlwZS5yZW5kZXJTdHJpcCA9IGZ1bmN0aW9uKHN0cmlwLCBwcm9qZWN0aW9uKQp7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoKCVBJWEkuYWN0aXZhdGVTdHJpcFNoYWRlcigpOwoKCXZhciBzaGFkZXIgPSBQSVhJLnN0cmlwU2hhZGVyOwoKCXZhciBwcm9ncmFtID0gc2hhZGVyLnByb2dyYW07CgkKCXZhciBtID0gUElYSS5tYXQzLmNsb25lKHN0cmlwLndvcmxkVHJhbnNmb3JtKTsKCQoJUElYSS5tYXQzLnRyYW5zcG9zZShtKTsKCQovLwljb25zb2xlLmxvZyhwcm9qZWN0aW9uKQoJLy8gc2V0IHRoZSBtYXRyaXggdHJhbnNmb3JtIGZvciB0aGUgCiAJZ2wudW5pZm9ybU1hdHJpeDNmdihzaGFkZXIudHJhbnNsYXRpb25NYXRyaXgsIGZhbHNlLCBtKTsKCWdsLnVuaWZvcm0yZihzaGFkZXIucHJvamVjdGlvblZlY3RvciwgcHJvamVjdGlvbi54LCBwcm9qZWN0aW9uLnkpOwoJZ2wudW5pZm9ybTJmKHNoYWRlci5vZmZzZXRWZWN0b3IsIC1QSVhJLm9mZnNldC54LCAtUElYSS5vZmZzZXQueSk7CgkKCWdsLnVuaWZvcm0xZihzaGFkZXIuYWxwaGEsIHN0cmlwLndvcmxkQWxwaGEpOwoKCS8qCglpZihzdHJpcC5ibGVuZE1vZGUgPT0gUElYSS5ibGVuZE1vZGVzLk5PUk1BTCkKCXsKCQlnbC5ibGVuZEZ1bmMoZ2wuT05FLCBnbC5PTkVfTUlOVVNfU1JDX0FMUEhBKTsKCX0KCWVsc2UKCXsKCQlnbC5ibGVuZEZ1bmMoZ2wuT05FLCBnbC5PTkVfTUlOVVNfU1JDX0NPTE9SKTsKCX0KCSovCgkKCS8vY29uc29sZS5sb2coIiEhIikKCWlmKCFzdHJpcC5kaXJ0eSkKCXsJCgkJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl92ZXJ0ZXhCdWZmZXIpOwoJCWdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCBzdHJpcC52ZXJ0aWNpZXMpCgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQoJCS8vIHVwZGF0ZSB0aGUgdXZzCgkgICAJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl91dkJ1ZmZlcik7CgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVRleHR1cmVDb29yZCwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkJCgkgICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CgkgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgc3RyaXAudGV4dHVyZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKCQkKCQlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX2NvbG9yQnVmZmVyKTsKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5jb2xvckF0dHJpYnV0ZSwgMSwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyBkb250IG5lZWQgdG8gdXBsb2FkIQoJICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLl9pbmRleEJ1ZmZlcik7Cgl9CgllbHNlCgl7CgkJc3RyaXAuZGlydHkgPSBmYWxzZTsKCQlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3ZlcnRleEJ1ZmZlcik7CgkJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLnZlcnRpY2llcywgZ2wuU1RBVElDX0RSQVcpCgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVZlcnRleFBvc2l0aW9uLCAyLCBnbC5GTE9BVCwgZmFsc2UsIDAsIDApOwoJCQoJCS8vIHVwZGF0ZSB0aGUgdXZzCgkgICAJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl91dkJ1ZmZlcik7CgkgICAJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLnV2cywgZ2wuU1RBVElDX0RSQVcpCgkgICAgZ2wudmVydGV4QXR0cmliUG9pbnRlcihzaGFkZXIuYVRleHR1cmVDb29yZCwgMiwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkJCgkgICAgZ2wuYWN0aXZlVGV4dHVyZShnbC5URVhUVVJFMCk7CgkgICAgZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgc3RyaXAudGV4dHVyZS5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKCS8vCWNvbnNvbGUubG9nKHN0cmlwLnRleHR1cmUuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSkKCQlnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX2NvbG9yQnVmZmVyKTsKCQlnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuY29sb3JzLCBnbC5TVEFUSUNfRFJBVykKCSAgICBnbC52ZXJ0ZXhBdHRyaWJQb2ludGVyKHNoYWRlci5jb2xvckF0dHJpYnV0ZSwgMSwgZ2wuRkxPQVQsIGZhbHNlLCAwLCAwKTsKCQkKCQkvLyBkb250IG5lZWQgdG8gdXBsb2FkIQoJICAgIGdsLmJpbmRCdWZmZXIoZ2wuRUxFTUVOVF9BUlJBWV9CVUZGRVIsIHN0cmlwLl9pbmRleEJ1ZmZlcik7CgkgICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuaW5kaWNlcywgZ2wuU1RBVElDX0RSQVcpOwoJICAgIAoJfQoJCglnbC5kcmF3RWxlbWVudHMoZ2wuVFJJQU5HTEVfU1RSSVAsIHN0cmlwLmluZGljZXMubGVuZ3RoLCBnbC5VTlNJR05FRF9TSE9SVCwgMCk7CiAgICAKICAgIFBJWEkuZGVhY3RpdmF0ZVN0cmlwU2hhZGVyKCk7CiAgCS8vZ2wudXNlUHJvZ3JhbShQSVhJLmN1cnJlbnRQcm9ncmFtKTsKfQoKLyoqCiAqIFJlbmRlcnMgYSBUaWxpbmdTcHJpdGUKICoKICogQG1ldGhvZCByZW5kZXJUaWxpbmdTcHJpdGUKICogQHBhcmFtIHNwcml0ZSB7VGlsaW5nU3ByaXRlfSBUaGUgdGlsaW5nIHNwcml0ZSB0byByZW5kZXIKICogQHBhcmFtIHByb2plY3Rpb25NYXRyaXgge09iamVjdH0KICogQHByaXZhdGUKICovClBJWEkuV2ViR0xSZW5kZXJHcm91cC5wcm90b3R5cGUucmVuZGVyVGlsaW5nU3ByaXRlID0gZnVuY3Rpb24oc3ByaXRlLCBwcm9qZWN0aW9uTWF0cml4KQp7Cgl2YXIgZ2wgPSB0aGlzLmdsOwoKCgl2YXIgc2hhZGVyUHJvZ3JhbSA9IFBJWEkuc2hhZGVyUHJvZ3JhbTsKCQoJdmFyIHRpbGVQb3NpdGlvbiA9IHNwcml0ZS50aWxlUG9zaXRpb247Cgl2YXIgdGlsZVNjYWxlID0gc3ByaXRlLnRpbGVTY2FsZTsKCQoJdmFyIG9mZnNldFggPSAgdGlsZVBvc2l0aW9uLngvc3ByaXRlLnRleHR1cmUuYmFzZVRleHR1cmUud2lkdGg7Cgl2YXIgb2Zmc2V0WSA9ICB0aWxlUG9zaXRpb24ueS9zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQ7CgkKCXZhciBzY2FsZVggPSAgKHNwcml0ZS53aWR0aCAvIHNwcml0ZS50ZXh0dXJlLmJhc2VUZXh0dXJlLndpZHRoKSAgLyB0aWxlU2NhbGUueDsKCXZhciBzY2FsZVkgPSAgKHNwcml0ZS5oZWlnaHQgLyBzcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQpIC8gdGlsZVNjYWxlLnk7CgoJc3ByaXRlLnV2c1swXSA9IDAgLSBvZmZzZXRYOwoJc3ByaXRlLnV2c1sxXSA9IDAgLSBvZmZzZXRZOwoJCglzcHJpdGUudXZzWzJdID0gKDEgKiBzY2FsZVgpICAtb2Zmc2V0WDsKCXNwcml0ZS51dnNbM10gPSAwIC0gb2Zmc2V0WTsKCQoJc3ByaXRlLnV2c1s0XSA9ICgxICpzY2FsZVgpIC0gb2Zmc2V0WDsKCXNwcml0ZS51dnNbNV0gPSAoMSAqc2NhbGVZKSAtIG9mZnNldFk7CgkKCXNwcml0ZS51dnNbNl0gPSAwIC0gb2Zmc2V0WDsKCXNwcml0ZS51dnNbN10gPSAoMSAqc2NhbGVZKSAtIG9mZnNldFk7CgkKCWdsLmJpbmRCdWZmZXIoZ2wuQVJSQVlfQlVGRkVSLCBzcHJpdGUuX3V2QnVmZmVyKTsKCWdsLmJ1ZmZlclN1YkRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAwLCBzcHJpdGUudXZzKQoJCgl0aGlzLnJlbmRlclN0cmlwKHNwcml0ZSwgcHJvamVjdGlvbk1hdHJpeCk7Cn0KCi8qKgogKiBJbml0aWFsaXplcyBhIHN0cmlwIHRvIGJlIHJlbmRlcmVkCiAqCiAqIEBtZXRob2QgaW5pdFN0cmlwCiAqIEBwYXJhbSBzdHJpcCB7U3RyaXB9IFRoZSBzdHJpcCB0byBpbml0aWFsaXplCiAqIEBwcml2YXRlCiAqLwpQSVhJLldlYkdMUmVuZGVyR3JvdXAucHJvdG90eXBlLmluaXRTdHJpcCA9IGZ1bmN0aW9uKHN0cmlwKQp7CgkvLyBidWlsZCB0aGUgc3RyaXAhCgl2YXIgZ2wgPSB0aGlzLmdsOwoJdmFyIHNoYWRlclByb2dyYW0gPSB0aGlzLnNoYWRlclByb2dyYW07CgkKCXN0cmlwLl92ZXJ0ZXhCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCXN0cmlwLl9pbmRleEJ1ZmZlciA9IGdsLmNyZWF0ZUJ1ZmZlcigpOwoJc3RyaXAuX3V2QnVmZmVyID0gZ2wuY3JlYXRlQnVmZmVyKCk7CglzdHJpcC5fY29sb3JCdWZmZXIgPSBnbC5jcmVhdGVCdWZmZXIoKTsKCQoJZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl92ZXJ0ZXhCdWZmZXIpOwoJZ2wuYnVmZmVyRGF0YShnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLnZlcnRpY2llcywgZ2wuRFlOQU1JQ19EUkFXKTsKCglnbC5iaW5kQnVmZmVyKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuX3V2QnVmZmVyKTsKICAgIGdsLmJ1ZmZlckRhdGEoZ2wuQVJSQVlfQlVGRkVSLCAgc3RyaXAudXZzLCBnbC5TVEFUSUNfRFJBVyk7CgogICAgZ2wuYmluZEJ1ZmZlcihnbC5BUlJBWV9CVUZGRVIsIHN0cmlwLl9jb2xvckJ1ZmZlcik7CglnbC5idWZmZXJEYXRhKGdsLkFSUkFZX0JVRkZFUiwgc3RyaXAuY29sb3JzLCBnbC5TVEFUSUNfRFJBVyk7CgoJCiAgICBnbC5iaW5kQnVmZmVyKGdsLkVMRU1FTlRfQVJSQVlfQlVGRkVSLCBzdHJpcC5faW5kZXhCdWZmZXIpOwogICAgZ2wuYnVmZmVyRGF0YShnbC5FTEVNRU5UX0FSUkFZX0JVRkZFUiwgc3RyaXAuaW5kaWNlcywgZ2wuU1RBVElDX0RSQVcpOwp9CgoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KCgpQSVhJLmluaXREZWZhdWx0U2hhZGVycyA9IGZ1bmN0aW9uKCkgCnsKCVBJWEkucHJpbWl0aXZlU2hhZGVyID0gbmV3IFBJWEkuUHJpbWl0aXZlU2hhZGVyKCk7CiAgUElYSS5wcmltaXRpdmVTaGFkZXIuaW5pdCgpOwoKICBQSVhJLnN0cmlwU2hhZGVyID0gbmV3IFBJWEkuU3RyaXBTaGFkZXIoKTsKICBQSVhJLnN0cmlwU2hhZGVyLmluaXQoKTsKCglQSVhJLmRlZmF1bHRTaGFkZXIgPSBuZXcgUElYSS5QaXhpU2hhZGVyKCk7CglQSVhJLmRlZmF1bHRTaGFkZXIuaW5pdCgpOwoKICB2YXIgZ2wgPSBQSVhJLmdsOyAKICB2YXIgc2hhZGVyUHJvZ3JhbSA9IFBJWEkuZGVmYXVsdFNoYWRlci5wcm9ncmFtOwogCgogIGdsLnVzZVByb2dyYW0oc2hhZGVyUHJvZ3JhbSk7CiAgCiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cn0KClBJWEkuYWN0aXZhdGVQcmltaXRpdmVTaGFkZXIgPSBmdW5jdGlvbigpCnsKICB2YXIgZ2wgPSBQSVhJLmdsOwogIAogIGdsLnVzZVByb2dyYW0oUElYSS5wcmltaXRpdmVTaGFkZXIucHJvZ3JhbSk7CiAgCiAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkuZGVmYXVsdFNoYWRlci5hVmVydGV4UG9zaXRpb24pOwogIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwogIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7CgogIGdsLmVuYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5wcmltaXRpdmVTaGFkZXIuY29sb3JBdHRyaWJ1dGUpOwp9IAoKUElYSS5kZWFjdGl2YXRlUHJpbWl0aXZlU2hhZGVyID0gZnVuY3Rpb24oKQp7CiAgdmFyIGdsID0gUElYSS5nbDsKCiAgZ2wudXNlUHJvZ3JhbShQSVhJLmRlZmF1bHRTaGFkZXIucHJvZ3JhbSk7CiAgCiAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgZ2wuZGlzYWJsZVZlcnRleEF0dHJpYkFycmF5KFBJWEkucHJpbWl0aXZlU2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKCiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFWZXJ0ZXhQb3NpdGlvbik7CiAgZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmNvbG9yQXR0cmlidXRlKTsKICBnbC5lbmFibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cgp9CgpQSVhJLmFjdGl2YXRlU3RyaXBTaGFkZXIgPSBmdW5jdGlvbigpCnsKICB2YXIgZ2wgPSBQSVhJLmdsOwogIAogIGdsLnVzZVByb2dyYW0oUElYSS5zdHJpcFNoYWRlci5wcm9ncmFtKTsKIC8vIGdsLmRpc2FibGVWZXJ0ZXhBdHRyaWJBcnJheShQSVhJLmRlZmF1bHRTaGFkZXIuYVRleHR1cmVDb29yZCk7Cn0gCgpQSVhJLmRlYWN0aXZhdGVTdHJpcFNoYWRlciA9IGZ1bmN0aW9uKCkKewogIHZhciBnbCA9IFBJWEkuZ2w7CgogIGdsLnVzZVByb2dyYW0oUElYSS5kZWZhdWx0U2hhZGVyLnByb2dyYW0pOwogIC8vZ2wuZW5hYmxlVmVydGV4QXR0cmliQXJyYXkoUElYSS5kZWZhdWx0U2hhZGVyLmFUZXh0dXJlQ29vcmQpOwp9CgovKgoKU0hBREVSIENPTVBJTEVSIEhFTFBFUlMKKi8KClBJWEkuQ29tcGlsZVZlcnRleFNoYWRlciA9IGZ1bmN0aW9uKGdsLCBzaGFkZXJTcmMpCnsKICByZXR1cm4gUElYSS5fQ29tcGlsZVNoYWRlcihnbCwgc2hhZGVyU3JjLCBnbC5WRVJURVhfU0hBREVSKTsKfQoKUElYSS5Db21waWxlRnJhZ21lbnRTaGFkZXIgPSBmdW5jdGlvbihnbCwgc2hhZGVyU3JjKQp7CiAgcmV0dXJuIFBJWEkuX0NvbXBpbGVTaGFkZXIoZ2wsIHNoYWRlclNyYywgZ2wuRlJBR01FTlRfU0hBREVSKTsKfQoKUElYSS5fQ29tcGlsZVNoYWRlciA9IGZ1bmN0aW9uKGdsLCBzaGFkZXJTcmMsIHNoYWRlclR5cGUpCnsKICB2YXIgc3JjID0gc2hhZGVyU3JjLmpvaW4oIlxuIik7CiAgdmFyIHNoYWRlciA9IGdsLmNyZWF0ZVNoYWRlcihzaGFkZXJUeXBlKTsKICBnbC5zaGFkZXJTb3VyY2Uoc2hhZGVyLCBzcmMpOwogIGdsLmNvbXBpbGVTaGFkZXIoc2hhZGVyKTsKCiAgaWYgKCFnbC5nZXRTaGFkZXJQYXJhbWV0ZXIoc2hhZGVyLCBnbC5DT01QSUxFX1NUQVRVUykpIHsKICAgIGNvbnNvbGUubG9nKGdsLmdldFNoYWRlckluZm9Mb2coc2hhZGVyKSk7CiAgICByZXR1cm4gbnVsbDsKICB9CgogIHJldHVybiBzaGFkZXI7Cn0KCgpQSVhJLmNvbXBpbGVQcm9ncmFtID0gZnVuY3Rpb24odmVydGV4U3JjLCBmcmFnbWVudFNyYykKewoJdmFyIGdsID0gUElYSS5nbDsKCXZhciBmcmFnbWVudFNoYWRlciA9IFBJWEkuQ29tcGlsZUZyYWdtZW50U2hhZGVyKGdsLCBmcmFnbWVudFNyYyk7Cgl2YXIgdmVydGV4U2hhZGVyID0gUElYSS5Db21waWxlVmVydGV4U2hhZGVyKGdsLCB2ZXJ0ZXhTcmMpOwoJCgl2YXIgc2hhZGVyUHJvZ3JhbSA9IGdsLmNyZWF0ZVByb2dyYW0oKTsKCQogICAgZ2wuYXR0YWNoU2hhZGVyKHNoYWRlclByb2dyYW0sIHZlcnRleFNoYWRlcik7CiAgICBnbC5hdHRhY2hTaGFkZXIoc2hhZGVyUHJvZ3JhbSwgZnJhZ21lbnRTaGFkZXIpOwogICAgZ2wubGlua1Byb2dyYW0oc2hhZGVyUHJvZ3JhbSk7CgogICAgaWYgKCFnbC5nZXRQcm9ncmFtUGFyYW1ldGVyKHNoYWRlclByb2dyYW0sIGdsLkxJTktfU1RBVFVTKSkgewogICAgICAgIGNvbnNvbGUubG9nKCJDb3VsZCBub3QgaW5pdGlhbGlzZSBzaGFkZXJzIik7CiAgICB9CgoJcmV0dXJuIHNoYWRlclByb2dyYW07Cn0gCgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKLyoqCiAqIEEgVGV4dCBPYmplY3Qgd2lsbCBjcmVhdGUgYSBsaW5lKHMpIG9mIHRleHQgdXNpbmcgYml0bWFwIGZvbnQuIFRvIHNwbGl0IGEgbGluZSB5b3UgY2FuIHVzZSAiXG4iLCAiXHIiIG9yICJcclxuIgogKiBZb3UgY2FuIGdlbmVyYXRlIHRoZSBmbnQgZmlsZXMgdXNpbmcKICogaHR0cDovL3d3dy5hbmdlbGNvZGUuY29tL3Byb2R1Y3RzL2JtZm9udC8gZm9yIHdpbmRvd3Mgb3IKICogaHR0cDovL3d3dy5ibWdseXBoLmNvbS8gZm9yIG1hYy4KICoKICogQGNsYXNzIEJpdG1hcFRleHQKICogQGV4dGVuZHMgRGlzcGxheU9iamVjdENvbnRhaW5lcgogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIHRleHQge1N0cmluZ30gVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqIEBwYXJhbSBzdHlsZSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gc3R5bGUuZm9udCB7U3RyaW5nfSBUaGUgc2l6ZSAob3B0aW9uYWwpIGFuZCBiaXRtYXAgZm9udCBpZCAocmVxdWlyZWQpIGVxICJBcmlhbCIgb3IgIjIwcHggQXJpYWwiIChtdXN0IGhhdmUgbG9hZGVkIHByZXZpb3VzbHkpCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249ImxlZnQiXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgibGVmdCIsICJjZW50ZXIiIG9yICJyaWdodCIpCiAqLwpQSVhJLkJpdG1hcFRleHQgPSBmdW5jdGlvbih0ZXh0LCBzdHlsZSkKewogICAgUElYSS5EaXNwbGF5T2JqZWN0Q29udGFpbmVyLmNhbGwodGhpcyk7CgogICAgdGhpcy5zZXRUZXh0KHRleHQpOwogICAgdGhpcy5zZXRTdHlsZShzdHlsZSk7CiAgICB0aGlzLnVwZGF0ZVRleHQoKTsKICAgIHRoaXMuZGlydHkgPSBmYWxzZQoKfTsKCi8vIGNvbnN0cnVjdG9yClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUpOwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5CaXRtYXBUZXh0OwoKLyoqCiAqIFNldCB0aGUgY29weSBmb3IgdGhlIHRleHQgb2JqZWN0CiAqCiAqIEBtZXRob2Qgc2V0VGV4dAogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfSBUaGUgY29weSB0aGF0IHlvdSB3b3VsZCBsaWtlIHRoZSB0ZXh0IHRvIGRpc3BsYXkKICovClBJWEkuQml0bWFwVGV4dC5wcm90b3R5cGUuc2V0VGV4dCA9IGZ1bmN0aW9uKHRleHQpCnsKICAgIHRoaXMudGV4dCA9IHRleHQgfHwgIiAiOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogU2V0IHRoZSBzdHlsZSBvZiB0aGUgdGV4dAogKgogKiBAbWV0aG9kIHNldFN0eWxlCiAqIEBwYXJhbSBzdHlsZSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gc3R5bGUuZm9udCB7U3RyaW5nfSBUaGUgc2l6ZSAob3B0aW9uYWwpIGFuZCBiaXRtYXAgZm9udCBpZCAocmVxdWlyZWQpIGVxICJBcmlhbCIgb3IgIjIwcHggQXJpYWwiIChtdXN0IGhhdmUgbG9hZGVkIHByZXZpb3VzbHkpCiAqIEBwYXJhbSBbc3R5bGUuYWxpZ249ImxlZnQiXSB7U3RyaW5nfSBBbiBhbGlnbm1lbnQgb2YgdGhlIG11bHRpbGluZSB0ZXh0ICgibGVmdCIsICJjZW50ZXIiIG9yICJyaWdodCIpCiAqLwpQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlLnNldFN0eWxlID0gZnVuY3Rpb24oc3R5bGUpCnsKICAgIHN0eWxlID0gc3R5bGUgfHwge307CiAgICBzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICJsZWZ0IjsKICAgIHRoaXMuc3R5bGUgPSBzdHlsZTsKCiAgICB2YXIgZm9udCA9IHN0eWxlLmZvbnQuc3BsaXQoIiAiKTsKICAgIHRoaXMuZm9udE5hbWUgPSBmb250W2ZvbnQubGVuZ3RoIC0gMV07CiAgICB0aGlzLmZvbnRTaXplID0gZm9udC5sZW5ndGggPj0gMiA/IHBhcnNlSW50KGZvbnRbZm9udC5sZW5ndGggLSAyXSwgMTApIDogUElYSS5CaXRtYXBUZXh0LmZvbnRzW3RoaXMuZm9udE5hbWVdLnNpemU7CgogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogUmVuZGVycyB0ZXh0CiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dAogKiBAcHJpdmF0ZQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0ID0gZnVuY3Rpb24oKQp7CiAgICB2YXIgZGF0YSA9IFBJWEkuQml0bWFwVGV4dC5mb250c1t0aGlzLmZvbnROYW1lXTsKICAgIHZhciBwb3MgPSBuZXcgUElYSS5Qb2ludCgpOwogICAgdmFyIHByZXZDaGFyQ29kZSA9IG51bGw7CiAgICB2YXIgY2hhcnMgPSBbXTsKICAgIHZhciBtYXhMaW5lV2lkdGggPSAwOwogICAgdmFyIGxpbmVXaWR0aHMgPSBbXTsKICAgIHZhciBsaW5lID0gMDsKICAgIHZhciBzY2FsZSA9IHRoaXMuZm9udFNpemUgLyBkYXRhLnNpemU7CiAgICBmb3IodmFyIGkgPSAwOyBpIDwgdGhpcy50ZXh0Lmxlbmd0aDsgaSsrKQogICAgewogICAgICAgIHZhciBjaGFyQ29kZSA9IHRoaXMudGV4dC5jaGFyQ29kZUF0KGkpOwogICAgICAgIGlmKC8oPzpcclxufFxyfFxuKS8udGVzdCh0aGlzLnRleHQuY2hhckF0KGkpKSkKICAgICAgICB7CiAgICAgICAgICAgIGxpbmVXaWR0aHMucHVzaChwb3MueCk7CiAgICAgICAgICAgIG1heExpbmVXaWR0aCA9IE1hdGgubWF4KG1heExpbmVXaWR0aCwgcG9zLngpOwogICAgICAgICAgICBsaW5lKys7CgogICAgICAgICAgICBwb3MueCA9IDA7CiAgICAgICAgICAgIHBvcy55ICs9IGRhdGEubGluZUhlaWdodDsKICAgICAgICAgICAgcHJldkNoYXJDb2RlID0gbnVsbDsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICB2YXIgY2hhckRhdGEgPSBkYXRhLmNoYXJzW2NoYXJDb2RlXTsKICAgICAgICBpZighY2hhckRhdGEpIGNvbnRpbnVlOwoKICAgICAgICBpZihwcmV2Q2hhckNvZGUgJiYgY2hhckRhdGFbcHJldkNoYXJDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgcG9zLnggKz0gY2hhckRhdGEua2VybmluZ1twcmV2Q2hhckNvZGVdOwogICAgICAgIH0KICAgICAgICBjaGFycy5wdXNoKHt0ZXh0dXJlOmNoYXJEYXRhLnRleHR1cmUsIGxpbmU6IGxpbmUsIGNoYXJDb2RlOiBjaGFyQ29kZSwgcG9zaXRpb246IG5ldyBQSVhJLlBvaW50KHBvcy54ICsgY2hhckRhdGEueE9mZnNldCwgcG9zLnkgKyBjaGFyRGF0YS55T2Zmc2V0KX0pOwogICAgICAgIHBvcy54ICs9IGNoYXJEYXRhLnhBZHZhbmNlOwoKICAgICAgICBwcmV2Q2hhckNvZGUgPSBjaGFyQ29kZTsKICAgIH0KCiAgICBsaW5lV2lkdGhzLnB1c2gocG9zLngpOwogICAgbWF4TGluZVdpZHRoID0gTWF0aC5tYXgobWF4TGluZVdpZHRoLCBwb3MueCk7CgogICAgdmFyIGxpbmVBbGlnbk9mZnNldHMgPSBbXTsKICAgIGZvcihpID0gMDsgaSA8PSBsaW5lOyBpKyspCiAgICB7CiAgICAgICAgdmFyIGFsaWduT2Zmc2V0ID0gMDsKICAgICAgICBpZih0aGlzLnN0eWxlLmFsaWduID09ICJyaWdodCIpCiAgICAgICAgewogICAgICAgICAgICBhbGlnbk9mZnNldCA9IG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV07CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYodGhpcy5zdHlsZS5hbGlnbiA9PSAiY2VudGVyIikKICAgICAgICB7CiAgICAgICAgICAgIGFsaWduT2Zmc2V0ID0gKG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV0pIC8gMjsKICAgICAgICB9CiAgICAgICAgbGluZUFsaWduT2Zmc2V0cy5wdXNoKGFsaWduT2Zmc2V0KTsKICAgIH0KCiAgICBmb3IoaSA9IDA7IGkgPCBjaGFycy5sZW5ndGg7IGkrKykKICAgIHsKICAgICAgICB2YXIgYyA9IG5ldyBQSVhJLlNwcml0ZShjaGFyc1tpXS50ZXh0dXJlKS8vUElYSS5TcHJpdGUuZnJvbUZyYW1lKGNoYXJzW2ldLmNoYXJDb2RlKTsKICAgICAgICBjLnBvc2l0aW9uLnggPSAoY2hhcnNbaV0ucG9zaXRpb24ueCArIGxpbmVBbGlnbk9mZnNldHNbY2hhcnNbaV0ubGluZV0pICogc2NhbGU7CiAgICAgICAgYy5wb3NpdGlvbi55ID0gY2hhcnNbaV0ucG9zaXRpb24ueSAqIHNjYWxlOwogICAgICAgIGMuc2NhbGUueCA9IGMuc2NhbGUueSA9IHNjYWxlOwogICAgICAgIHRoaXMuYWRkQ2hpbGQoYyk7CiAgICB9CgogICAgdGhpcy53aWR0aCA9IHBvcy54ICogc2NhbGU7CiAgICB0aGlzLmhlaWdodCA9IChwb3MueSArIGRhdGEubGluZUhlaWdodCkgKiBzY2FsZTsKfTsKCi8qKgogKiBVcGRhdGVzIHRoZSB0cmFuc2ZvciBvZiB0aGlzIG9iamVjdAogKgogKiBAbWV0aG9kIHVwZGF0ZVRyYW5zZm9ybQogKiBAcHJpdmF0ZQogKi8KUElYSS5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGVUcmFuc2Zvcm0gPSBmdW5jdGlvbigpCnsKCWlmKHRoaXMuZGlydHkpCgl7CiAgICAgICAgd2hpbGUodGhpcy5jaGlsZHJlbi5sZW5ndGggPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZCh0aGlzLmdldENoaWxkQXQoMCkpOwogICAgICAgIH0KICAgICAgICB0aGlzLnVwZGF0ZVRleHQoKTsKCiAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwoJfQoKCVBJWEkuRGlzcGxheU9iamVjdENvbnRhaW5lci5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtLmNhbGwodGhpcyk7Cn07CgpQSVhJLkJpdG1hcFRleHQuZm9udHMgPSB7fTsKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKICogQSBUZXh0IE9iamVjdCB3aWxsIGNyZWF0ZSBhIGxpbmUocykgb2YgdGV4dCB0byBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgIlxuIgogKgogKiBAY2xhc3MgVGV4dAogKiBAZXh0ZW5kcyBTcHJpdGUKICogQGNvbnN0cnVjdG9yCiAqIEBwYXJhbSB0ZXh0IHtTdHJpbmd9IFRoZSBjb3B5IHRoYXQgeW91IHdvdWxkIGxpa2UgdGhlIHRleHQgdG8gZGlzcGxheQogKiBAcGFyYW0gW3N0eWxlXSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gW3N0eWxlLmZvbnRdIHtTdHJpbmd9IGRlZmF1bHQgImJvbGQgMjBwdCBBcmlhbCIgVGhlIHN0eWxlIGFuZCBzaXplIG9mIHRoZSBmb250CiAqIEBwYXJhbSBbc3R5bGUuZmlsbD0iYmxhY2siXSB7T2JqZWN0fSBBIGNhbnZhcyBmaWxsc3R5bGUgdGhhdCB3aWxsIGJlIHVzZWQgb24gdGhlIHRleHQgZWcgInJlZCIsICIjMDBGRjAwIgogKiBAcGFyYW0gW3N0eWxlLmFsaWduPSJsZWZ0Il0ge1N0cmluZ30gQW4gYWxpZ25tZW50IG9mIHRoZSBtdWx0aWxpbmUgdGV4dCAoImxlZnQiLCAiY2VudGVyIiBvciAicmlnaHQiKQogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZV0ge1N0cmluZ30gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IHN0cm9rZSBlZyAiYmx1ZSIsICIjRkNGRjAwIgogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZVRoaWNrbmVzcz0wXSB7TnVtYmVyfSBBIG51bWJlciB0aGF0IHJlcHJlc2VudHMgdGhlIHRoaWNrbmVzcyBvZiB0aGUgc3Ryb2tlLiBEZWZhdWx0IGlzIDAgKG5vIHN0cm9rZSkKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcD1mYWxzZV0ge0Jvb2xlYW59IEluZGljYXRlcyBpZiB3b3JkIHdyYXAgc2hvdWxkIGJlIHVzZWQKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcFdpZHRoPTEwMF0ge051bWJlcn0gVGhlIHdpZHRoIGF0IHdoaWNoIHRleHQgd2lsbCB3cmFwCiAqLwpQSVhJLlRleHQgPSBmdW5jdGlvbih0ZXh0LCBzdHlsZSkKewogICAgdGhpcy5jYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJjYW52YXMiKTsKICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoIjJkIik7CiAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIFBJWEkuVGV4dHVyZS5mcm9tQ2FudmFzKHRoaXMuY2FudmFzKSk7CgogICAgdGhpcy5zZXRUZXh0KHRleHQpOwogICAgdGhpcy5zZXRTdHlsZShzdHlsZSk7CgogICAgdGhpcy51cGRhdGVUZXh0KCk7CiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7Cn07CgovLyBjb25zdHJ1Y3RvcgpQSVhJLlRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQSVhJLlRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUElYSS5UZXh0OwoKLyoqCiAqIFNldCB0aGUgc3R5bGUgb2YgdGhlIHRleHQKICoKICogQG1ldGhvZCBzZXRTdHlsZQogKiBAcGFyYW0gW3N0eWxlXSB7T2JqZWN0fSBUaGUgc3R5bGUgcGFyYW1ldGVycwogKiBAcGFyYW0gW3N0eWxlLmZvbnQ9ImJvbGQgMjBwdCBBcmlhbCJdIHtTdHJpbmd9IFRoZSBzdHlsZSBhbmQgc2l6ZSBvZiB0aGUgZm9udAogKiBAcGFyYW0gW3N0eWxlLmZpbGw9ImJsYWNrIl0ge09iamVjdH0gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IGVnICJyZWQiLCAiIzAwRkYwMCIKICogQHBhcmFtIFtzdHlsZS5hbGlnbj0ibGVmdCJdIHtTdHJpbmd9IEFuIGFsaWdubWVudCBvZiB0aGUgbXVsdGlsaW5lIHRleHQgKCJsZWZ0IiwgImNlbnRlciIgb3IgInJpZ2h0IikKICogQHBhcmFtIFtzdHlsZS5zdHJva2U9ImJsYWNrIl0ge1N0cmluZ30gQSBjYW52YXMgZmlsbHN0eWxlIHRoYXQgd2lsbCBiZSB1c2VkIG9uIHRoZSB0ZXh0IHN0cm9rZSBlZyAiYmx1ZSIsICIjRkNGRjAwIgogKiBAcGFyYW0gW3N0eWxlLnN0cm9rZVRoaWNrbmVzcz0wXSB7TnVtYmVyfSBBIG51bWJlciB0aGF0IHJlcHJlc2VudHMgdGhlIHRoaWNrbmVzcyBvZiB0aGUgc3Ryb2tlLiBEZWZhdWx0IGlzIDAgKG5vIHN0cm9rZSkKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcD1mYWxzZV0ge0Jvb2xlYW59IEluZGljYXRlcyBpZiB3b3JkIHdyYXAgc2hvdWxkIGJlIHVzZWQKICogQHBhcmFtIFtzdHlsZS53b3JkV3JhcFdpZHRoPTEwMF0ge051bWJlcn0gVGhlIHdpZHRoIGF0IHdoaWNoIHRleHQgd2lsbCB3cmFwCiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnNldFN0eWxlID0gZnVuY3Rpb24oc3R5bGUpCnsKICAgIHN0eWxlID0gc3R5bGUgfHwge307CiAgICBzdHlsZS5mb250ID0gc3R5bGUuZm9udCB8fCAiYm9sZCAyMHB0IEFyaWFsIjsKICAgIHN0eWxlLmZpbGwgPSBzdHlsZS5maWxsIHx8ICJibGFjayI7CiAgICBzdHlsZS5hbGlnbiA9IHN0eWxlLmFsaWduIHx8ICJsZWZ0IjsKICAgIHN0eWxlLnN0cm9rZSA9IHN0eWxlLnN0cm9rZSB8fCAiYmxhY2siOyAvL3Byb3ZpZGUgYSBkZWZhdWx0LCBzZWU6IGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29kQm95RGlnaXRhbC9waXhpLmpzL2lzc3Vlcy8xMzYKICAgIHN0eWxlLnN0cm9rZVRoaWNrbmVzcyA9IHN0eWxlLnN0cm9rZVRoaWNrbmVzcyB8fCAwOwogICAgc3R5bGUud29yZFdyYXAgPSBzdHlsZS53b3JkV3JhcCB8fCBmYWxzZTsKICAgIHN0eWxlLndvcmRXcmFwV2lkdGggPSBzdHlsZS53b3JkV3JhcFdpZHRoIHx8IDEwMDsKICAgIHRoaXMuc3R5bGUgPSBzdHlsZTsKICAgIHRoaXMuZGlydHkgPSB0cnVlOwp9OwoKLyoqCiAqIFNldCB0aGUgY29weSBmb3IgdGhlIHRleHQgb2JqZWN0LiBUbyBzcGxpdCBhIGxpbmUgeW91IGNhbiB1c2UgIlxuIgogKgogKiBAbWV0aG9zIHNldFRleHQKICogQHBhcmFtIHtTdHJpbmd9IHRleHQgVGhlIGNvcHkgdGhhdCB5b3Ugd291bGQgbGlrZSB0aGUgdGV4dCB0byBkaXNwbGF5CiAqLwpQSVhJLlRleHQucHJvdG90eXBlLnNldFRleHQgPSBmdW5jdGlvbih0ZXh0KQp7CiAgICB0aGlzLnRleHQgPSB0ZXh0LnRvU3RyaW5nKCkgfHwgIiAiOwogICAgdGhpcy5kaXJ0eSA9IHRydWU7Cn07CgovKioKICogUmVuZGVycyB0ZXh0CiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dAogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0ID0gZnVuY3Rpb24oKQp7Cgl0aGlzLmNvbnRleHQuZm9udCA9IHRoaXMuc3R5bGUuZm9udDsKCgl2YXIgb3V0cHV0VGV4dCA9IHRoaXMudGV4dDsKCgkvLyB3b3JkIHdyYXAKCS8vIHByZXNlcnZlIG9yaWdpbmFsIHRleHQKCWlmKHRoaXMuc3R5bGUud29yZFdyYXApb3V0cHV0VGV4dCA9IHRoaXMud29yZFdyYXAodGhpcy50ZXh0KTsKCgkvL3NwbGl0IHRleHQgaW50byBsaW5lcwoJdmFyIGxpbmVzID0gb3V0cHV0VGV4dC5zcGxpdCgvKD86XHJcbnxccnxcbikvKTsKCgkvL2NhbGN1bGF0ZSB0ZXh0IHdpZHRoCgl2YXIgbGluZVdpZHRocyA9IFtdOwoJdmFyIG1heExpbmVXaWR0aCA9IDA7Cglmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJewoJCXZhciBsaW5lV2lkdGggPSB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQobGluZXNbaV0pLndpZHRoOwoJCWxpbmVXaWR0aHNbaV0gPSBsaW5lV2lkdGg7CgkJbWF4TGluZVdpZHRoID0gTWF0aC5tYXgobWF4TGluZVdpZHRoLCBsaW5lV2lkdGgpOwoJfQoJdGhpcy5jYW52YXMud2lkdGggPSBtYXhMaW5lV2lkdGggKyB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKCgkvL2NhbGN1bGF0ZSB0ZXh0IGhlaWdodAoJdmFyIGxpbmVIZWlnaHQgPSB0aGlzLmRldGVybWluZUZvbnRIZWlnaHQoImZvbnQ6ICIgKyB0aGlzLnN0eWxlLmZvbnQgICsgIjsiKSArIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzOwoJdGhpcy5jYW52YXMuaGVpZ2h0ID0gbGluZUhlaWdodCAqIGxpbmVzLmxlbmd0aDsKCgkvL3NldCBjYW52YXMgdGV4dCBzdHlsZXMKCXRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB0aGlzLnN0eWxlLmZpbGw7Cgl0aGlzLmNvbnRleHQuZm9udCA9IHRoaXMuc3R5bGUuZm9udDsKCgl0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSB0aGlzLnN0eWxlLnN0cm9rZTsKCXRoaXMuY29udGV4dC5saW5lV2lkdGggPSB0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzczsKCgl0aGlzLmNvbnRleHQudGV4dEJhc2VsaW5lID0gInRvcCI7CgoJLy9kcmF3IGxpbmVzIGxpbmUgYnkgbGluZQoJZm9yIChpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJewoJCXZhciBsaW5lUG9zaXRpb24gPSBuZXcgUElYSS5Qb2ludCh0aGlzLnN0eWxlLnN0cm9rZVRoaWNrbmVzcyAvIDIsIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzIC8gMiArIGkgKiBsaW5lSGVpZ2h0KTsKCgkJaWYodGhpcy5zdHlsZS5hbGlnbiA9PSAicmlnaHQiKQoJCXsKCQkJbGluZVBvc2l0aW9uLnggKz0gbWF4TGluZVdpZHRoIC0gbGluZVdpZHRoc1tpXTsKCQl9CgkJZWxzZSBpZih0aGlzLnN0eWxlLmFsaWduID09ICJjZW50ZXIiKQoJCXsKCQkJbGluZVBvc2l0aW9uLnggKz0gKG1heExpbmVXaWR0aCAtIGxpbmVXaWR0aHNbaV0pIC8gMjsKCQl9CgoJCWlmKHRoaXMuc3R5bGUuc3Ryb2tlICYmIHRoaXMuc3R5bGUuc3Ryb2tlVGhpY2tuZXNzKQoJCXsKCQkJdGhpcy5jb250ZXh0LnN0cm9rZVRleHQobGluZXNbaV0sIGxpbmVQb3NpdGlvbi54LCBsaW5lUG9zaXRpb24ueSk7CgkJfQoKCQlpZih0aGlzLnN0eWxlLmZpbGwpCgkJewoJCQl0aGlzLmNvbnRleHQuZmlsbFRleHQobGluZXNbaV0sIGxpbmVQb3NpdGlvbi54LCBsaW5lUG9zaXRpb24ueSk7CgkJfQoJfQoKICAgIHRoaXMudXBkYXRlVGV4dHVyZSgpOwp9OwoKLyoqCiAqIFVwZGF0ZXMgdGV4dHVyZSBzaXplIGJhc2VkIG9uIGNhbnZhcyBzaXplCiAqCiAqIEBtZXRob2QgdXBkYXRlVGV4dHVyZQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS51cGRhdGVUZXh0dXJlID0gZnVuY3Rpb24oKQp7CiAgICB0aGlzLnRleHR1cmUuYmFzZVRleHR1cmUud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZS5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQ7CiAgICB0aGlzLnRleHR1cmUuZnJhbWUud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKICAgIHRoaXMudGV4dHVyZS5mcmFtZS5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQ7CgogIAl0aGlzLl93aWR0aCA9IHRoaXMuY2FudmFzLndpZHRoOwogICAgdGhpcy5faGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0OwoKICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMudGV4dHVyZS5iYXNlVGV4dHVyZSk7Cn07CgovKioKICogVXBkYXRlcyB0aGUgdHJhbnNmb3Igb2YgdGhpcyBvYmplY3QKICoKICogQG1ldGhvZCB1cGRhdGVUcmFuc2Zvcm0KICogQHByaXZhdGUKICovClBJWEkuVGV4dC5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtID0gZnVuY3Rpb24oKQp7CglpZih0aGlzLmRpcnR5KQoJewoJCXRoaXMudXBkYXRlVGV4dCgpOwoJCXRoaXMuZGlydHkgPSBmYWxzZTsKCX0KCglQSVhJLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlVHJhbnNmb3JtLmNhbGwodGhpcyk7Cn07CgovKgogKiBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vdXNlcnMvMzQ0NDEvZWxsaXNiYmVuCiAqIGdyZWF0IHNvbHV0aW9uIHRvIHRoZSBwcm9ibGVtIQogKgogKiBAbWV0aG9kIGRldGVybWluZUZvbnRIZWlnaHQKICogQHBhcmFtIGZvbnRTdHlsZSB7T2JqZWN0fQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS5kZXRlcm1pbmVGb250SGVpZ2h0ID0gZnVuY3Rpb24oZm9udFN0eWxlKQp7CgkvLyBidWlsZCBhIGxpdHRsZSByZWZlcmVuY2UgZGljdGlvbmFyeSBzbyBpZiB0aGUgZm9udCBzdHlsZSBoYXMgYmVlbiB1c2VkIHJldHVybiBhCgkvLyBjYWNoZWQgdmVyc2lvbi4uLgoJdmFyIHJlc3VsdCA9IFBJWEkuVGV4dC5oZWlnaHRDYWNoZVtmb250U3R5bGVdOwoKCWlmKCFyZXN1bHQpCgl7CgkJdmFyIGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdOwoJCXZhciBkdW1teSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOwoJCXZhciBkdW1teVRleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSgiTSIpOwoJCWR1bW15LmFwcGVuZENoaWxkKGR1bW15VGV4dCk7CgkJZHVtbXkuc2V0QXR0cmlidXRlKCJzdHlsZSIsIGZvbnRTdHlsZSArICc7cG9zaXRpb246YWJzb2x1dGU7dG9wOjA7bGVmdDowJyk7CgkJYm9keS5hcHBlbmRDaGlsZChkdW1teSk7CgoJCXJlc3VsdCA9IGR1bW15Lm9mZnNldEhlaWdodDsKCQlQSVhJLlRleHQuaGVpZ2h0Q2FjaGVbZm9udFN0eWxlXSA9IHJlc3VsdDsKCgkJYm9keS5yZW1vdmVDaGlsZChkdW1teSk7Cgl9CgoJcmV0dXJuIHJlc3VsdDsKfTsKCi8qKgogKiBBcHBsaWVzIG5ld2xpbmVzIHRvIGEgc3RyaW5nIHRvIGhhdmUgaXQgb3B0aW1hbGx5IGZpdCBpbnRvIHRoZSBob3Jpem9udGFsCiAqIGJvdW5kcyBzZXQgYnkgdGhlIFRleHQgb2JqZWN0J3Mgd29yZFdyYXBXaWR0aCBwcm9wZXJ0eS4KICoKICogQG1ldGhvZCB3b3JkV3JhcAogKiBAcGFyYW0gdGV4dCB7U3RyaW5nfQogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0LnByb3RvdHlwZS53b3JkV3JhcCA9IGZ1bmN0aW9uKHRleHQpCnsKCS8vIEdyZWVkeSB3cmFwcGluZyBhbGdvcml0aG0gdGhhdCB3aWxsIHdyYXAgd29yZHMgYXMgdGhlIGxpbmUgZ3Jvd3MgbG9uZ2VyCgkvLyB0aGFuIGl0cyBob3Jpem9udGFsIGJvdW5kcy4KCXZhciByZXN1bHQgPSAiIjsKCXZhciBsaW5lcyA9IHRleHQuc3BsaXQoIlxuIik7Cglmb3IgKHZhciBpID0gMDsgaSA8IGxpbmVzLmxlbmd0aDsgaSsrKQoJewoJCXZhciBzcGFjZUxlZnQgPSB0aGlzLnN0eWxlLndvcmRXcmFwV2lkdGg7CgkJdmFyIHdvcmRzID0gbGluZXNbaV0uc3BsaXQoIiAiKTsKCQlmb3IgKHZhciBqID0gMDsgaiA8IHdvcmRzLmxlbmd0aDsgaisrKQoJCXsKCQkJdmFyIHdvcmRXaWR0aCA9IHRoaXMuY29udGV4dC5tZWFzdXJlVGV4dCh3b3Jkc1tqXSkud2lkdGg7CgkJCXZhciB3b3JkV2lkdGhXaXRoU3BhY2UgPSB3b3JkV2lkdGggKyB0aGlzLmNvbnRleHQubWVhc3VyZVRleHQoIiAiKS53aWR0aDsKCQkJaWYod29yZFdpZHRoV2l0aFNwYWNlID4gc3BhY2VMZWZ0KQoJCQl7CgkJCQkvLyBTa2lwIHByaW50aW5nIHRoZSBuZXdsaW5lIGlmIGl0J3MgdGhlIGZpcnN0IHdvcmQgb2YgdGhlIGxpbmUgdGhhdCBpcwoJCQkJLy8gZ3JlYXRlciB0aGFuIHRoZSB3b3JkIHdyYXAgd2lkdGguCgkJCQlpZihqID4gMCkKCQkJCXsKCQkJCQlyZXN1bHQgKz0gIlxuIjsKCQkJCX0KCQkJCXJlc3VsdCArPSB3b3Jkc1tqXSArICIgIjsKCQkJCXNwYWNlTGVmdCA9IHRoaXMuc3R5bGUud29yZFdyYXBXaWR0aCAtIHdvcmRXaWR0aDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXNwYWNlTGVmdCAtPSB3b3JkV2lkdGhXaXRoU3BhY2U7CgkJCQlyZXN1bHQgKz0gd29yZHNbal0gKyAiICI7CgkJCX0KCQl9CgkJcmVzdWx0ICs9ICJcbiI7Cgl9CglyZXR1cm4gcmVzdWx0Owp9OwoKLyoqCiAqIERlc3Ryb3lzIHRoaXMgdGV4dCBvYmplY3QKICoKICogQG1ldGhvZCBkZXN0cm95CiAqIEBwYXJhbSBkZXN0cm95VGV4dHVyZSB7Qm9vbGVhbn0KICovClBJWEkuVGV4dC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGRlc3Ryb3lUZXh0dXJlKQp7CglpZihkZXN0cm95VGV4dHVyZSkKCXsKCQl0aGlzLnRleHR1cmUuZGVzdHJveSgpOwoJfQoKfTsKClBJWEkuVGV4dC5oZWlnaHRDYWNoZSA9IHt9OwoKLyoqCiAqIEBhdXRob3IgTWF0IEdyb3ZlcyBodHRwOi8vbWF0Z3JvdmVzLmNvbS8gQERvb3JtYXQyMwogKi8KClBJWEkuQmFzZVRleHR1cmVDYWNoZSA9IHt9OwpQSVhJLnRleHR1cmVzVG9VcGRhdGUgPSBbXTsKUElYSS50ZXh0dXJlc1RvRGVzdHJveSA9IFtdOwoKLyoqCiAqIEEgdGV4dHVyZSBzdG9yZXMgdGhlIGluZm9ybWF0aW9uIHRoYXQgcmVwcmVzZW50cyBhbiBpbWFnZS4gQWxsIHRleHR1cmVzIGhhdmUgYSBiYXNlIHRleHR1cmUKICoKICogQGNsYXNzIEJhc2VUZXh0dXJlCiAqIEB1c2VzIEV2ZW50VGFyZ2V0CiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0gc291cmNlIHtTdHJpbmd9IHRoZSBzb3VyY2Ugb2JqZWN0IChpbWFnZSBvciBjYW52YXMpCiAqLwpQSVhJLkJhc2VUZXh0dXJlID0gZnVuY3Rpb24oc291cmNlKQp7CglQSVhJLkV2ZW50VGFyZ2V0LmNhbGwoIHRoaXMgKTsKCgkvKioKCSAqIFtyZWFkLW9ubHldIFRoZSB3aWR0aCBvZiB0aGUgYmFzZSB0ZXh0dXJlIHNldCB3aGVuIHRoZSBpbWFnZSBoYXMgbG9hZGVkCgkgKgoJICogQHByb3BlcnR5IHdpZHRoCgkgKiBAdHlwZSBOdW1iZXIKCSAqIEByZWFkT25seQoJICovCgl0aGlzLndpZHRoID0gMTAwOwoKCS8qKgoJICogW3JlYWQtb25seV0gVGhlIGhlaWdodCBvZiB0aGUgYmFzZSB0ZXh0dXJlIHNldCB3aGVuIHRoZSBpbWFnZSBoYXMgbG9hZGVkCgkgKgoJICogQHByb3BlcnR5IGhlaWdodAoJICogQHR5cGUgTnVtYmVyCgkgKiBAcmVhZE9ubHkKCSAqLwoJdGhpcy5oZWlnaHQgPSAxMDA7CgoJLyoqCgkgKiBbcmVhZC1vbmx5XSBEZXNjcmliZXMgaWYgdGhlIGJhc2UgdGV4dHVyZSBoYXMgbG9hZGVkIG9yIG5vdAoJICoKCSAqIEBwcm9wZXJ0eSBoYXNMb2FkZWQKCSAqIEB0eXBlIEJvb2xlYW4KCSAqIEByZWFkT25seQoJICovCgl0aGlzLmhhc0xvYWRlZCA9IGZhbHNlOwoKCS8qKgoJICogVGhlIHNvdXJjZSB0aGF0IGlzIGxvYWRlZCB0byBjcmVhdGUgdGhlIHRleHR1cmUKCSAqCgkgKiBAcHJvcGVydHkgc291cmNlCgkgKiBAdHlwZSBJbWFnZQoJICovCgl0aGlzLnNvdXJjZSA9IHNvdXJjZTsKCglpZighc291cmNlKXJldHVybjsKCglpZih0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIEltYWdlIHx8IHRoaXMuc291cmNlIGluc3RhbmNlb2YgSFRNTEltYWdlRWxlbWVudCkKCXsKCQlpZih0aGlzLnNvdXJjZS5jb21wbGV0ZSkKCQl7CgkJCXRoaXMuaGFzTG9hZGVkID0gdHJ1ZTsKCQkJdGhpcy53aWR0aCA9IHRoaXMuc291cmNlLndpZHRoOwoJCQl0aGlzLmhlaWdodCA9IHRoaXMuc291cmNlLmhlaWdodDsKCgkJCVBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMpOwoJCX0KCQllbHNlCgkJewoKCQkJdmFyIHNjb3BlID0gdGhpczsKCQkJdGhpcy5zb3VyY2Uub25sb2FkID0gZnVuY3Rpb24oKXsKCgkJCQlzY29wZS5oYXNMb2FkZWQgPSB0cnVlOwoJCQkJc2NvcGUud2lkdGggPSBzY29wZS5zb3VyY2Uud2lkdGg7CgkJCQlzY29wZS5oZWlnaHQgPSBzY29wZS5zb3VyY2UuaGVpZ2h0OwoKCQkJCS8vIGFkZCBpdCB0byBzb21ld2hlcmUuLi4KCQkJCVBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHNjb3BlKTsKCQkJCXNjb3BlLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ2xvYWRlZCcsIGNvbnRlbnQ6IHNjb3BlIH0gKTsKCQkJfQoJCQkvLwl0aGlzLmltYWdlLnNyYyA9IGltYWdlVXJsOwoJCX0KCX0KCWVsc2UKCXsKCQl0aGlzLmhhc0xvYWRlZCA9IHRydWU7CgkJdGhpcy53aWR0aCA9IHRoaXMuc291cmNlLndpZHRoOwoJCXRoaXMuaGVpZ2h0ID0gdGhpcy5zb3VyY2UuaGVpZ2h0OwoKCQlQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzKTsKCX0KCgl0aGlzLl9wb3dlck9mMiA9IGZhbHNlOwp9CgpQSVhJLkJhc2VUZXh0dXJlLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBJWEkuQmFzZVRleHR1cmU7CgovKioKICogRGVzdHJveXMgdGhpcyBiYXNlIHRleHR1cmUKICoKICogQG1ldGhvZCBkZXN0cm95CiAqLwpQSVhJLkJhc2VUZXh0dXJlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKQp7CglpZih0aGlzLnNvdXJjZSBpbnN0YW5jZW9mIEltYWdlKQoJewoJCXRoaXMuc291cmNlLnNyYyA9IG51bGw7Cgl9Cgl0aGlzLnNvdXJjZSA9IG51bGw7CglQSVhJLnRleHR1cmVzVG9EZXN0cm95LnB1c2godGhpcyk7Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgYmFzZSB0ZXh0dXJlIGJhc2VkIG9uIGFuIGltYWdlIHVybAogKiBJZiB0aGUgaW1hZ2UgaXMgbm90IGluIHRoZSBiYXNlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tSW1hZ2UKICogQHBhcmFtIGltYWdlVXJsIHtTdHJpbmd9IFRoZSBpbWFnZSB1cmwgb2YgdGhlIHRleHR1cmUKICogQHJldHVybiBCYXNlVGV4dHVyZQogKi8KUElYSS5CYXNlVGV4dHVyZS5mcm9tSW1hZ2UgPSBmdW5jdGlvbihpbWFnZVVybCwgY3Jvc3NvcmlnaW4pCnsKCXZhciBiYXNlVGV4dHVyZSA9IFBJWEkuQmFzZVRleHR1cmVDYWNoZVtpbWFnZVVybF07CglpZighYmFzZVRleHR1cmUpCgl7CgkJLy8gbmV3IEltYWdlKCkgYnJlYWtzIHRleCBsb2FkaW5nIGluIHNvbWUgdmVyc2lvbnMgb2YgQ2hyb21lLgoJCS8vIFNlZSBodHRwczovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9MjM4MDcxCgkJdmFyIGltYWdlID0gbmV3IEltYWdlKCk7Ly9kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKCQlpZiAoY3Jvc3NvcmlnaW4pCgkJewoJCQlpbWFnZS5jcm9zc09yaWdpbiA9ICcnOwoJCX0KCQlpbWFnZS5zcmMgPSBpbWFnZVVybDsKCQliYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGltYWdlKTsKCQlQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbaW1hZ2VVcmxdID0gYmFzZVRleHR1cmU7Cgl9CgoJcmV0dXJuIGJhc2VUZXh0dXJlOwp9CgovKioKICogQGF1dGhvciBNYXQgR3JvdmVzIGh0dHA6Ly9tYXRncm92ZXMuY29tLyBARG9vcm1hdDIzCiAqLwoKUElYSS5UZXh0dXJlQ2FjaGUgPSB7fTsKUElYSS5GcmFtZUNhY2hlID0ge307CgovKioKICogQSB0ZXh0dXJlIHN0b3JlcyB0aGUgaW5mb3JtYXRpb24gdGhhdCByZXByZXNlbnRzIGFuIGltYWdlIG9yIHBhcnQgb2YgYW4gaW1hZ2UuIEl0IGNhbm5vdCBiZSBhZGRlZAogKiB0byB0aGUgZGlzcGxheSBsaXN0IGRpcmVjdGx5LiBUbyBkbyB0aGlzIHVzZSBQSVhJLlNwcml0ZS4gSWYgbm8gZnJhbWUgaXMgcHJvdmlkZWQgdGhlbiB0aGUgd2hvbGUgaW1hZ2UgaXMgdXNlZAogKgogKiBAY2xhc3MgVGV4dHVyZQogKiBAdXNlcyBFdmVudFRhcmdldAogKiBAY29uc3RydWN0b3IKICogQHBhcmFtIGJhc2VUZXh0dXJlIHtCYXNlVGV4dHVyZX0gVGhlIGJhc2UgdGV4dHVyZSBzb3VyY2UgdG8gY3JlYXRlIHRoZSB0ZXh0dXJlIGZyb20KICogQHBhcmFtIGZyYW1lIHtSZWN0YW5nbGV9IFRoZSByZWN0YW5nbGUgZnJhbWUgb2YgdGhlIHRleHR1cmUgdG8gc2hvdwogKi8KUElYSS5UZXh0dXJlID0gZnVuY3Rpb24oYmFzZVRleHR1cmUsIGZyYW1lKQp7CglQSVhJLkV2ZW50VGFyZ2V0LmNhbGwoIHRoaXMgKTsKCglpZighZnJhbWUpCgl7CgkJdGhpcy5ub0ZyYW1lID0gdHJ1ZTsKCQlmcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLDAsMSwxKTsKCX0KCglpZihiYXNlVGV4dHVyZSBpbnN0YW5jZW9mIFBJWEkuVGV4dHVyZSkKCQliYXNlVGV4dHVyZSA9IGJhc2VUZXh0dXJlLmJhc2VUZXh0dXJlOwoKCS8qKgoJICogVGhlIGJhc2UgdGV4dHVyZSBvZiB0aGlzIHRleHR1cmUKCSAqCgkgKiBAcHJvcGVydHkgYmFzZVRleHR1cmUKCSAqIEB0eXBlIEJhc2VUZXh0dXJlCgkgKi8KCXRoaXMuYmFzZVRleHR1cmUgPSBiYXNlVGV4dHVyZTsKCgkvKioKCSAqIFRoZSBmcmFtZSBzcGVjaWZpZXMgdGhlIHJlZ2lvbiBvZiB0aGUgYmFzZSB0ZXh0dXJlIHRoYXQgdGhpcyB0ZXh0dXJlIHVzZXMKCSAqCgkgKiBAcHJvcGVydHkgZnJhbWUKCSAqIEB0eXBlIFJlY3RhbmdsZQoJICovCgl0aGlzLmZyYW1lID0gZnJhbWU7CgoJLyoqCgkgKiBUaGUgdHJpbSBwb2ludAoJICoKCSAqIEBwcm9wZXJ0eSB0cmltCgkgKiBAdHlwZSBQb2ludAoJICovCgl0aGlzLnRyaW0gPSBuZXcgUElYSS5Qb2ludCgpOwoKCXRoaXMuc2NvcGUgPSB0aGlzOwoKCWlmKGJhc2VUZXh0dXJlLmhhc0xvYWRlZCkKCXsKCQlpZih0aGlzLm5vRnJhbWUpZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwwLCBiYXNlVGV4dHVyZS53aWR0aCwgYmFzZVRleHR1cmUuaGVpZ2h0KTsKCQkvL2NvbnNvbGUubG9nKGZyYW1lKQoKCQl0aGlzLnNldEZyYW1lKGZyYW1lKTsKCX0KCWVsc2UKCXsKCQl2YXIgc2NvcGUgPSB0aGlzOwoJCWJhc2VUZXh0dXJlLmFkZEV2ZW50TGlzdGVuZXIoICdsb2FkZWQnLCBmdW5jdGlvbigpeyBzY29wZS5vbkJhc2VUZXh0dXJlTG9hZGVkKCl9ICk7Cgl9Cn0KClBJWEkuVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlRleHR1cmU7CgovKioKICogQ2FsbGVkIHdoZW4gdGhlIGJhc2UgdGV4dHVyZSBpcyBsb2FkZWQKICoKICogQG1ldGhvZCBvbkJhc2VUZXh0dXJlTG9hZGVkCiAqIEBwYXJhbSBldmVudAogKiBAcHJpdmF0ZQogKi8KUElYSS5UZXh0dXJlLnByb3RvdHlwZS5vbkJhc2VUZXh0dXJlTG9hZGVkID0gZnVuY3Rpb24oZXZlbnQpCnsKCXZhciBiYXNlVGV4dHVyZSA9IHRoaXMuYmFzZVRleHR1cmU7CgliYXNlVGV4dHVyZS5yZW1vdmVFdmVudExpc3RlbmVyKCAnbG9hZGVkJywgdGhpcy5vbkxvYWRlZCApOwoKCWlmKHRoaXMubm9GcmFtZSl0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsMCwgYmFzZVRleHR1cmUud2lkdGgsIGJhc2VUZXh0dXJlLmhlaWdodCk7Cgl0aGlzLm5vRnJhbWUgPSBmYWxzZTsKCXRoaXMud2lkdGggPSB0aGlzLmZyYW1lLndpZHRoOwoJdGhpcy5oZWlnaHQgPSB0aGlzLmZyYW1lLmhlaWdodDsKCgl0aGlzLnNjb3BlLmRpc3BhdGNoRXZlbnQoIHsgdHlwZTogJ3VwZGF0ZScsIGNvbnRlbnQ6IHRoaXMgfSApOwp9CgovKioKICogRGVzdHJveXMgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgZGVzdHJveQogKiBAcGFyYW0gZGVzdHJveUJhc2Uge0Jvb2xlYW59IFdoZXRoZXIgdG8gZGVzdHJveSB0aGUgYmFzZSB0ZXh0dXJlIGFzIHdlbGwKICovClBJWEkuVGV4dHVyZS5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uKGRlc3Ryb3lCYXNlKQp7CglpZihkZXN0cm95QmFzZSl0aGlzLmJhc2VUZXh0dXJlLmRlc3Ryb3koKTsKfQoKLyoqCiAqIFNwZWNpZmllcyB0aGUgcmVjdGFuZ2xlIHJlZ2lvbiBvZiB0aGUgYmFzZVRleHR1cmUKICoKICogQG1ldGhvZCBzZXRGcmFtZQogKiBAcGFyYW0gZnJhbWUge1JlY3RhbmdsZX0gVGhlIGZyYW1lIG9mIHRoZSB0ZXh0dXJlIHRvIHNldCBpdCB0bwogKi8KUElYSS5UZXh0dXJlLnByb3RvdHlwZS5zZXRGcmFtZSA9IGZ1bmN0aW9uKGZyYW1lKQp7Cgl0aGlzLmZyYW1lID0gZnJhbWU7Cgl0aGlzLndpZHRoID0gZnJhbWUud2lkdGg7Cgl0aGlzLmhlaWdodCA9IGZyYW1lLmhlaWdodDsKCglpZihmcmFtZS54ICsgZnJhbWUud2lkdGggPiB0aGlzLmJhc2VUZXh0dXJlLndpZHRoIHx8IGZyYW1lLnkgKyBmcmFtZS5oZWlnaHQgPiB0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCkKCXsKCQl0aHJvdyBuZXcgRXJyb3IoIlRleHR1cmUgRXJyb3I6IGZyYW1lIGRvZXMgbm90IGZpdCBpbnNpZGUgdGhlIGJhc2UgVGV4dHVyZSBkaW1lbnNpb25zICIgKyB0aGlzKTsKCX0KCgl0aGlzLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCglQSVhJLlRleHR1cmUuZnJhbWVVcGRhdGVzLnB1c2godGhpcyk7CgkvL3RoaXMuZGlzcGF0Y2hFdmVudCggeyB0eXBlOiAndXBkYXRlJywgY29udGVudDogdGhpcyB9ICk7Cn0KCi8qKgogKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgdGV4dHVyZSBiYXNlZCBvbiBhbiBpbWFnZSB1cmwKICogSWYgdGhlIGltYWdlIGlzIG5vdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSBpdCB3aWxsIGJlICBjcmVhdGVkIGFuZCBsb2FkZWQKICoKICogQHN0YXRpYwogKiBAbWV0aG9kIGZyb21JbWFnZQogKiBAcGFyYW0gaW1hZ2VVcmwge1N0cmluZ30gVGhlIGltYWdlIHVybCBvZiB0aGUgdGV4dHVyZQogKiBAcGFyYW0gY3Jvc3NvcmlnaW4ge0Jvb2xlYW59IFdoZXRoZXIgcmVxdWVzdHMgc2hvdWxkIGJlIHRyZWF0ZWQgYXMgY3Jvc3NvcmlnaW4KICogQHJldHVybiBUZXh0dXJlCiAqLwpQSVhJLlRleHR1cmUuZnJvbUltYWdlID0gZnVuY3Rpb24oaW1hZ2VVcmwsIGNyb3Nzb3JpZ2luKQp7Cgl2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2ltYWdlVXJsXTsKCglpZighdGV4dHVyZSkKCXsKCQl0ZXh0dXJlID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlLmZyb21JbWFnZShpbWFnZVVybCwgY3Jvc3NvcmlnaW4pKTsKCQlQSVhJLlRleHR1cmVDYWNoZVtpbWFnZVVybF0gPSB0ZXh0dXJlOwoJfQoKCXJldHVybiB0ZXh0dXJlOwp9CgovKioKICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIHRleHR1cmUgYmFzZWQgb24gYSBmcmFtZSBpZAogKiBJZiB0aGUgZnJhbWUgaWQgaXMgbm90IGluIHRoZSB0ZXh0dXJlIGNhY2hlIGFuIGVycm9yIHdpbGwgYmUgdGhyb3duCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tRnJhbWUKICogQHBhcmFtIGZyYW1lSWQge1N0cmluZ30gVGhlIGZyYW1lIGlkIG9mIHRoZSB0ZXh0dXJlCiAqIEByZXR1cm4gVGV4dHVyZQogKi8KUElYSS5UZXh0dXJlLmZyb21GcmFtZSA9IGZ1bmN0aW9uKGZyYW1lSWQpCnsKCXZhciB0ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVbZnJhbWVJZF07CglpZighdGV4dHVyZSl0aHJvdyBuZXcgRXJyb3IoIlRoZSBmcmFtZUlkICciKyBmcmFtZUlkICsiJyBkb2VzIG5vdCBleGlzdCBpbiB0aGUgdGV4dHVyZSBjYWNoZSAiICsgdGhpcyk7CglyZXR1cm4gdGV4dHVyZTsKfQoKLyoqCiAqIEhlbHBlciBmdW5jdGlvbiB0aGF0IHJldHVybnMgYSB0ZXh0dXJlIGJhc2VkIG9uIGEgY2FudmFzIGVsZW1lbnQKICogSWYgdGhlIGNhbnZhcyBpcyBub3QgaW4gdGhlIHRleHR1cmUgY2FjaGUgaXQgd2lsbCBiZSAgY3JlYXRlZCBhbmQgbG9hZGVkCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBmcm9tQ2FudmFzCiAqIEBwYXJhbSBjYW52YXMge0NhbnZhc30gVGhlIGNhbnZhcyBlbGVtZW50IHNvdXJjZSBvZiB0aGUgdGV4dHVyZQogKiBAcmV0dXJuIFRleHR1cmUKICovClBJWEkuVGV4dHVyZS5mcm9tQ2FudmFzID0gZnVuY3Rpb24oY2FudmFzKQp7Cgl2YXIJYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZShjYW52YXMpOwoJcmV0dXJuIG5ldyBQSVhJLlRleHR1cmUoYmFzZVRleHR1cmUpOwp9CgoKLyoqCiAqIEFkZHMgYSB0ZXh0dXJlIHRvIHRoZSB0ZXh0dXJlQ2FjaGUuCiAqCiAqIEBzdGF0aWMKICogQG1ldGhvZCBhZGRUZXh0dXJlVG9DYWNoZQogKiBAcGFyYW0gdGV4dHVyZSB7VGV4dHVyZX0KICogQHBhcmFtIGlkIHtTdHJpbmd9IHRoZSBpZCB0aGF0IHRoZSB0ZXh0dXJlIHdpbGwgYmUgc3RvcmVkIGFnYWluc3QuCiAqLwpQSVhJLlRleHR1cmUuYWRkVGV4dHVyZVRvQ2FjaGUgPSBmdW5jdGlvbih0ZXh0dXJlLCBpZCkKewoJUElYSS5UZXh0dXJlQ2FjaGVbaWRdID0gdGV4dHVyZTsKfQoKLyoqCiAqIFJlbW92ZSBhIHRleHR1cmUgZnJvbSB0aGUgdGV4dHVyZUNhY2hlLgogKgogKiBAc3RhdGljCiAqIEBtZXRob2QgcmVtb3ZlVGV4dHVyZUZyb21DYWNoZQogKiBAcGFyYW0gaWQge1N0cmluZ30gdGhlIGlkIG9mIHRoZSB0ZXh0dXJlIHRvIGJlIHJlbW92ZWQKICogQHJldHVybiB7VGV4dHVyZX0gdGhlIHRleHR1cmUgdGhhdCB3YXMgcmVtb3ZlZAogKi8KUElYSS5UZXh0dXJlLnJlbW92ZVRleHR1cmVGcm9tQ2FjaGUgPSBmdW5jdGlvbihpZCkKewoJdmFyIHRleHR1cmUgPSBQSVhJLlRleHR1cmVDYWNoZVtpZF0KCVBJWEkuVGV4dHVyZUNhY2hlW2lkXSA9IG51bGw7CglyZXR1cm4gdGV4dHVyZTsKfQoKLy8gdGhpcyBpcyBtb3JlIGZvciB3ZWJHTC4uIGl0IGNvbnRhaW5zIHVwZGF0ZWQgZnJhbWVzLi4KUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcyA9IFtdOwoKCi8qKgogKiBAYXV0aG9yIE1hdCBHcm92ZXMgaHR0cDovL21hdGdyb3Zlcy5jb20vIEBEb29ybWF0MjMKICovCgovKioKIEEgUmVuZGVyVGV4dHVyZSBpcyBhIHNwZWNpYWwgdGV4dHVyZSB0aGF0IGFsbG93cyBhbnkgcGl4aSBkaXNwbGF5T2JqZWN0IHRvIGJlIHJlbmRlcmVkIHRvIGl0LgoKIF9fSGludF9fOiBBbGwgRGlzcGxheU9iamVjdHMgKGV4bXBsLiBTcHJpdGVzKSB0aGF0IHJlbmRlcnMgb24gUmVuZGVyVGV4dHVyZSBzaG91bGQgYmUgcHJlbG9hZGVkLiAKIE90aGVyd2lzZSBibGFjayByZWN0YW5nbGVzIHdpbGwgYmUgZHJhd24gaW5zdGVhZC4gIAogCiBSZW5kZXJUZXh0dXJlIHRha2VzIHNuYXBzaG90IG9mIERpc3BsYXlPYmplY3QgcGFzc2VkIHRvIHJlbmRlciBtZXRob2QuIElmIERpc3BsYXlPYmplY3QgaXMgcGFzc2VkIHRvIHJlbmRlciBtZXRob2QsIHBvc2l0aW9uIGFuZCByb3RhdGlvbiBvZiBpdCB3aWxsIGJlIGlnbm9yZWQuIEZvciBleGFtcGxlOgogCgl2YXIgcmVuZGVyVGV4dHVyZSA9IG5ldyBQSVhJLlJlbmRlclRleHR1cmUoODAwLCA2MDApOwoJdmFyIHNwcml0ZSA9IFBJWEkuU3ByaXRlLmZyb21JbWFnZSgic3Bpbk9ial8wMS5wbmciKTsKCXNwcml0ZS5wb3NpdGlvbi54ID0gODAwLzI7CglzcHJpdGUucG9zaXRpb24ueSA9IDYwMC8yOwoJc3ByaXRlLmFuY2hvci54ID0gMC41OwoJc3ByaXRlLmFuY2hvci55ID0gMC41OwoJcmVuZGVyVGV4dHVyZS5yZW5kZXIoc3ByaXRlKTsKCiBTcHJpdGUgaW4gdGhpcyBjYXNlIHdpbGwgYmUgcmVuZGVyZWQgdG8gMCwwIHBvc2l0aW9uLiBUbyByZW5kZXIgdGhpcyBzcHJpdGUgYXQgY2VudGVyIERpc3BsYXlPYmplY3RDb250YWluZXIgc2hvdWxkIGJlIHVzZWQ6CgoJdmFyIGRvYyA9IG5ldyBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIoKTsKCWRvYy5hZGRDaGlsZChzcHJpdGUpOwoJcmVuZGVyVGV4dHVyZS5yZW5kZXIoZG9jKTsgIC8vIFJlbmRlcnMgdG8gY2VudGVyIG9mIHJlbmRlclRleHR1cmUKCiBAY2xhc3MgUmVuZGVyVGV4dHVyZQogQGV4dGVuZHMgVGV4dHVyZQogQGNvbnN0cnVjdG9yCiBAcGFyYW0gd2lkdGgge051bWJlcn0gVGhlIHdpZHRoIG9mIHRoZSByZW5kZXIgdGV4dHVyZQogQHBhcmFtIGhlaWdodCB7TnVtYmVyfSBUaGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGV4dHVyZQogKi8KUElYSS5SZW5kZXJUZXh0dXJlID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoJUElYSS5FdmVudFRhcmdldC5jYWxsKCB0aGlzICk7CgoJdGhpcy53aWR0aCA9IHdpZHRoIHx8IDEwMDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0IHx8IDEwMDsKCgl0aGlzLmluZGV0aXR5TWF0cml4ID0gUElYSS5tYXQzLmNyZWF0ZSgpOwoKCXRoaXMuZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwkKCglpZihQSVhJLmdsKQoJewoJCXRoaXMuaW5pdFdlYkdMKCk7Cgl9CgllbHNlCgl7CgkJdGhpcy5pbml0Q2FudmFzKCk7Cgl9Cn0KClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKCBQSVhJLlRleHR1cmUucHJvdG90eXBlICk7ClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJlbmRlclRleHR1cmU7CgovKioKICogSW5pdGlhbGl6ZXMgdGhlIHdlYmdsIGRhdGEgZm9yIHRoaXMgdGV4dHVyZQogKgogKiBAbWV0aG9kIGluaXRXZWJHTAogKiBAcHJpdmF0ZQogKi8KUElYSS5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0V2ViR0wgPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IFBJWEkuZ2w7Cgl0aGlzLmdsRnJhbWVidWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwoKICAgCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgogICAgdGhpcy5nbEZyYW1lYnVmZmVyLndpZHRoID0gdGhpcy53aWR0aDsKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci5oZWlnaHQgPSB0aGlzLmhlaWdodDsJCgoJdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKCk7CgoJdGhpcy5iYXNlVGV4dHVyZS53aWR0aCA9IHRoaXMud2lkdGg7Cgl0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgoJZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCgl0aGlzLmJhc2VUZXh0dXJlLmlzUmVuZGVyID0gdHJ1ZTsKCglnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoJZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUsIDApOwoKCS8vIGNyZWF0ZSBhIHByb2plY3Rpb24gbWF0cml4Li4KCXRoaXMucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KHRoaXMud2lkdGgvMiAsIC10aGlzLmhlaWdodC8yKTsKCgkvLyBzZXQgdGhlIGNvcnJlY3QgcmVuZGVyIGZ1bmN0aW9uLi4KCXRoaXMucmVuZGVyID0gdGhpcy5yZW5kZXJXZWJHTDsKfQoKClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVzaXplID0gZnVuY3Rpb24od2lkdGgsIGhlaWdodCkKewoKCXRoaXMud2lkdGggPSB3aWR0aDsKCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoJCglpZihQSVhJLmdsKQoJewoJCXRoaXMucHJvamVjdGlvbi54ID0gdGhpcy53aWR0aC8yCgkJdGhpcy5wcm9qZWN0aW9uLnkgPSAtdGhpcy5oZWlnaHQvMjsKCQoJCXZhciBnbCA9IFBJWEkuZ2w7CgkJZ2wuYmluZFRleHR1cmUoZ2wuVEVYVFVSRV8yRCwgdGhpcy5iYXNlVGV4dHVyZS5fZ2xUZXh0dXJlKTsKCQlnbC50ZXhJbWFnZTJEKGdsLlRFWFRVUkVfMkQsIDAsIGdsLlJHQkEsICB0aGlzLndpZHRoLCAgdGhpcy5oZWlnaHQsIDAsIGdsLlJHQkEsIGdsLlVOU0lHTkVEX0JZVEUsIG51bGwpOwoJfQoJZWxzZQoJewoJCQoJCXRoaXMuZnJhbWUud2lkdGggPSB0aGlzLndpZHRoCgkJdGhpcy5mcmFtZS5oZWlnaHQgPSB0aGlzLmhlaWdodDsKCQl0aGlzLnJlbmRlcmVyLnJlc2l6ZSh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7Cgl9Cn0KCi8qKgogKiBJbml0aWFsaXplcyB0aGUgY2FudmFzIGRhdGEgZm9yIHRoaXMgdGV4dHVyZQogKgogKiBAbWV0aG9kIGluaXRDYW52YXMKICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuaW5pdENhbnZhcyA9IGZ1bmN0aW9uKCkKewoJdGhpcy5yZW5kZXJlciA9IG5ldyBQSVhJLkNhbnZhc1JlbmRlcmVyKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCBudWxsLCAwKTsKCgl0aGlzLmJhc2VUZXh0dXJlID0gbmV3IFBJWEkuQmFzZVRleHR1cmUodGhpcy5yZW5kZXJlci52aWV3KTsKCXRoaXMuZnJhbWUgPSBuZXcgUElYSS5SZWN0YW5nbGUoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoKCXRoaXMucmVuZGVyID0gdGhpcy5yZW5kZXJDYW52YXM7Cn0KCi8qKgogKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuCiAqCiAqIEBtZXRob2QgcmVuZGVyV2ViR0wKICogQHBhcmFtIGRpc3BsYXlPYmplY3Qge0Rpc3BsYXlPYmplY3R9IFRoZSBkaXNwbGF5IG9iamVjdCB0byByZW5kZXIgdGhpcyB0ZXh0dXJlIG9uCiAqIEBwYXJhbSBjbGVhciB7Qm9vbGVhbn0gSWYgdHJ1ZSB0aGUgdGV4dHVyZSB3aWxsIGJlIGNsZWFyZWQgYmVmb3JlIHRoZSBkaXNwbGF5T2JqZWN0IGlzIGRyYXduCiAqIEBwcml2YXRlCiAqLwpQSVhJLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlcldlYkdMID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoKCS8vIGVuYWJsZSB0aGUgYWxwaGEgY29sb3IgbWFzay4uCglnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7IAoKCWdsLnZpZXdwb3J0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsJCgoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCglpZihjbGVhcikKCXsKCQlnbC5jbGVhckNvbG9yKDAsMCwwLCAwKTsgICAgIAoJCWdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwoJfQoKCS8vIFRISVMgV0lMTCBNRVNTIFdJVEggSElUIFRFU1RJTkchCgl2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKCS8vVE9ETyAtPyBjcmVhdGUgYSBuZXcgb25lPz8/IGRvbnQgdGhpbmsgc28hCgl2YXIgb3JpZ2luYWxXb3JsZFRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CglkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOy8vc3RoaXMuaW5kZXRpdHlNYXRyaXg7CgkvLyBtb2RpZnkgdG8gZmxpcC4uLgoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSA9IC0xOwoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHRoaXMucHJvamVjdGlvbi55ICogLTI7CgoJaWYocG9zaXRpb24pCgl7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSAtPSBwb3NpdGlvbi55OwoJfQoJCglQSVhJLnZpc2libGVDb3VudCsrOwoJZGlzcGxheU9iamVjdC52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKCQoJZm9yKHZhciBpPTAsaj1jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCWNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KCgl2YXIgcmVuZGVyR3JvdXAgPSBkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXA7CgoJaWYocmVuZGVyR3JvdXApCgl7CgkJaWYoZGlzcGxheU9iamVjdCA9PSByZW5kZXJHcm91cC5yb290KQoJCXsKCQkJcmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCQl9CgkJZWxzZQoJCXsKCQkJcmVuZGVyR3JvdXAucmVuZGVyU3BlY2lmaWMoZGlzcGxheU9iamVjdCwgdGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwoJCX0KCX0KCWVsc2UKCXsKCQlpZighdGhpcy5yZW5kZXJHcm91cCl0aGlzLnJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cChnbCk7CgkJdGhpcy5yZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKGRpc3BsYXlPYmplY3QpOwoJCXRoaXMucmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCX0KCQoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IG9yaWdpbmFsV29ybGRUcmFuc2Zvcm07Cn0KCgovKioKICogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgogKgogKiBAbWV0aG9kIHJlbmRlckNhbnZhcwogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24KICogQHBhcmFtIGNsZWFyIHtCb29sZWFufSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24KICogQHByaXZhdGUKICovClBJWEkuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUucmVuZGVyQ2FudmFzID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7Cgl2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm0gPSBQSVhJLm1hdDMuY3JlYXRlKCk7CgkKCWlmKHBvc2l0aW9uKQoJewoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gPSBwb3NpdGlvbi54OwoJCWRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0gPSBwb3NpdGlvbi55OwoJfQoJCgoJZm9yKHZhciBpPTAsaj1jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCWNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KCglpZihjbGVhcil0aGlzLnJlbmRlcmVyLmNvbnRleHQuY2xlYXJSZWN0KDAsMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpOwoJCiAgICB0aGlzLnJlbmRlcmVyLnJlbmRlckRpc3BsYXlPYmplY3QoZGlzcGxheU9iamVjdCk7CiAgICAKICAgIHRoaXMucmVuZGVyZXIuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwwLDAsMSwwLDApOyAKICAgIAoKICAvLyAgUElYSS50ZXh0dXJlc1RvVXBkYXRlLnB1c2godGhpcy5iYXNlVGV4dHVyZSk7Cn0KCi8qKgogKiBodHRwczovL2dpdGh1Yi5jb20vbXJkb29iL2V2ZW50dGFyZ2V0LmpzLwogKiBUSGFua1MgbXIgRE9vYiEKICovCgovKioKICogQWRkcyBldmVudCBlbWl0dGVyIGZ1bmN0aW9uYWxpdHkgdG8gYSBjbGFzcwogKgogKiBAY2xhc3MgRXZlbnRUYXJnZXQKICogQGV4YW1wbGUKICoJCWZ1bmN0aW9uIE15RW1pdHRlcigpIHsKICoJCQlQSVhJLkV2ZW50VGFyZ2V0LmNhbGwodGhpcyk7IC8vbWl4ZXMgaW4gZXZlbnQgdGFyZ2V0IHN0dWZmCiAqCQl9CiAqCiAqCQl2YXIgZW0gPSBuZXcgTXlFbWl0dGVyKCk7CiAqCQllbS5lbWl0KHsgdHlwZTogJ2V2ZW50TmFtZScsIGRhdGE6ICdzb21lIGRhdGEnIH0pOwogKi8KUElYSS5FdmVudFRhcmdldCA9IGZ1bmN0aW9uICgpIHsKCgl2YXIgbGlzdGVuZXJzID0ge307CgoJdGhpcy5hZGRFdmVudExpc3RlbmVyID0gdGhpcy5vbiA9IGZ1bmN0aW9uICggdHlwZSwgbGlzdGVuZXIgKSB7CgoKCQlpZiAoIGxpc3RlbmVyc1sgdHlwZSBdID09PSB1bmRlZmluZWQgKSB7CgoJCQlsaXN0ZW5lcnNbIHR5cGUgXSA9IFtdOwoKCQl9CgoJCWlmICggbGlzdGVuZXJzWyB0eXBlIF0uaW5kZXhPZiggbGlzdGVuZXIgKSA9PT0gLSAxICkgewoKCQkJbGlzdGVuZXJzWyB0eXBlIF0ucHVzaCggbGlzdGVuZXIgKTsKCQl9CgoJfTsKCgl0aGlzLmRpc3BhdGNoRXZlbnQgPSB0aGlzLmVtaXQgPSBmdW5jdGlvbiAoIGV2ZW50ICkgewoKCQlpZiAoICFsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXSB8fCAhbGlzdGVuZXJzWyBldmVudC50eXBlIF0ubGVuZ3RoICkgewoKCQkJcmV0dXJuOwoKCQl9CgoJCWZvcih2YXIgaSA9IDAsIGwgPSBsaXN0ZW5lcnNbIGV2ZW50LnR5cGUgXS5sZW5ndGg7IGkgPCBsOyBpKyspIHsKCgkJCWxpc3RlbmVyc1sgZXZlbnQudHlwZSBdWyBpIF0oIGV2ZW50ICk7CgoJCX0KCgl9OwoKCXRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lciA9IHRoaXMub2ZmID0gZnVuY3Rpb24gKCB0eXBlLCBsaXN0ZW5lciApIHsKCgkJdmFyIGluZGV4ID0gbGlzdGVuZXJzWyB0eXBlIF0uaW5kZXhPZiggbGlzdGVuZXIgKTsKCgkJaWYgKCBpbmRleCAhPT0gLSAxICkgewoKCQkJbGlzdGVuZXJzWyB0eXBlIF0uc3BsaWNlKCBpbmRleCwgMSApOwoKCQl9CgoJfTsKCn07CgovKgoJUG9seUsgbGlicmFyeQoJdXJsOiBodHRwOi8vcG9seWsuaXZhbmsubmV0CglSZWxlYXNlZCB1bmRlciBNSVQgbGljZW5jZS4KCglDb3B5cmlnaHQgKGMpIDIwMTIgSXZhbiBLdWNraXIKCglQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbgoJb2J0YWluaW5nIGEgY29weSBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24KCWZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQKCXJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLAoJY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwKCWNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZQoJU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcKCWNvbmRpdGlvbnM6CgoJVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUKCWluY2x1ZGVkIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgoKCVRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELAoJRVhQUkVTUyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTCglPRiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoJTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKCUhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLAoJV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HCglGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SCglPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgoJVGhpcyBpcyBhbiBhbWF6aW5nIGxpYiEKCglzbGlnaHRseSBtb2RpZmllZCBieSBtYXQgZ3JvdmVzIChtYXRncm92ZXMuY29tKTsKKi8KClBJWEkuUG9seUsgPSB7fTsKCi8qKgogKiBUcmlhbmd1bGF0ZXMgc2hhcGVzIGZvciB3ZWJHTCBncmFwaGljIGZpbGxzCiAqCiAqIEBtZXRob2QgVHJpYW5ndWxhdGUKICogQG5hbWVzcGFjZSBQb2x5SwogKiBAY29uc3RydWN0b3IKICovClBJWEkuUG9seUsuVHJpYW5ndWxhdGUgPSBmdW5jdGlvbihwKQp7Cgl2YXIgc2lnbiA9IHRydWU7CgoJdmFyIG4gPSBwLmxlbmd0aD4+MTsKCWlmKG48MykgcmV0dXJuIFtdOwoJdmFyIHRncyA9IFtdOwoJdmFyIGF2bCA9IFtdOwoJZm9yKHZhciBpPTA7IGk8bjsgaSsrKSBhdmwucHVzaChpKTsKCgl2YXIgaSA9IDA7Cgl2YXIgYWwgPSBuOwoJd2hpbGUoYWwgPiAzKQoJewoJCXZhciBpMCA9IGF2bFsoaSswKSVhbF07CgkJdmFyIGkxID0gYXZsWyhpKzEpJWFsXTsKCQl2YXIgaTIgPSBhdmxbKGkrMiklYWxdOwoKCQl2YXIgYXggPSBwWzIqaTBdLCAgYXkgPSBwWzIqaTArMV07CgkJdmFyIGJ4ID0gcFsyKmkxXSwgIGJ5ID0gcFsyKmkxKzFdOwoJCXZhciBjeCA9IHBbMippMl0sICBjeSA9IHBbMippMisxXTsKCgkJdmFyIGVhckZvdW5kID0gZmFsc2U7CgkJaWYoUElYSS5Qb2x5Sy5fY29udmV4KGF4LCBheSwgYngsIGJ5LCBjeCwgY3ksIHNpZ24pKQoJCXsKCQkJZWFyRm91bmQgPSB0cnVlOwoJCQlmb3IodmFyIGo9MDsgajxhbDsgaisrKQoJCQl7CgkJCQl2YXIgdmkgPSBhdmxbal07CgkJCQlpZih2aT09aTAgfHwgdmk9PWkxIHx8IHZpPT1pMikgY29udGludWU7CgkJCQlpZihQSVhJLlBvbHlLLl9Qb2ludEluVHJpYW5nbGUocFsyKnZpXSwgcFsyKnZpKzFdLCBheCwgYXksIGJ4LCBieSwgY3gsIGN5KSkge2VhckZvdW5kID0gZmFsc2U7IGJyZWFrO30KCQkJfQoJCX0KCQlpZihlYXJGb3VuZCkKCQl7CgkJCXRncy5wdXNoKGkwLCBpMSwgaTIpOwoJCQlhdmwuc3BsaWNlKChpKzEpJWFsLCAxKTsKCQkJYWwtLTsKCQkJaSA9IDA7CgkJfQoJCWVsc2UgaWYoaSsrID4gMyphbCkKCQl7CgkJCS8vIG5lZWQgdG8gZmxpcCBmbGlwIHJldmVyc2UgaXQhCgkJCS8vIHJlc2V0IQoJCQlpZihzaWduKQoJCQl7CgkJCQl2YXIgdGdzID0gW107CgkJCQlhdmwgPSBbXTsKCQkJCWZvcih2YXIgaT0wOyBpPG47IGkrKykgYXZsLnB1c2goaSk7CgoJCQkJaSA9IDA7CgkJCQlhbCA9IG47CgoJCQkJc2lnbiA9IGZhbHNlOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJY29uc29sZS5sb2coIlBJWEkgV2FybmluZzogc2hhcGUgdG9vIGNvbXBsZXggdG8gZmlsbCIpCgkJCQlyZXR1cm4gW107CgkJCX0KCQl9Cgl9Cgl0Z3MucHVzaChhdmxbMF0sIGF2bFsxXSwgYXZsWzJdKTsKCXJldHVybiB0Z3M7Cn0KCi8qKgogKiBDaGVja3MgaWYgYSBwb2ludCBpcyB3aXRoaW4gYSB0cmlhbmdsZQogKgogKiBAY2xhc3MgX1BvaW50SW5UcmlhbmdsZQogKiBAbmFtZXNwYWNlIFBvbHlLCiAqIEBwcml2YXRlCiAqLwpQSVhJLlBvbHlLLl9Qb2ludEluVHJpYW5nbGUgPSBmdW5jdGlvbihweCwgcHksIGF4LCBheSwgYngsIGJ5LCBjeCwgY3kpCnsKCXZhciB2MHggPSBjeC1heDsKCXZhciB2MHkgPSBjeS1heTsKCXZhciB2MXggPSBieC1heDsKCXZhciB2MXkgPSBieS1heTsKCXZhciB2MnggPSBweC1heDsKCXZhciB2MnkgPSBweS1heTsKCgl2YXIgZG90MDAgPSB2MHgqdjB4K3YweSp2MHk7Cgl2YXIgZG90MDEgPSB2MHgqdjF4K3YweSp2MXk7Cgl2YXIgZG90MDIgPSB2MHgqdjJ4K3YweSp2Mnk7Cgl2YXIgZG90MTEgPSB2MXgqdjF4K3YxeSp2MXk7Cgl2YXIgZG90MTIgPSB2MXgqdjJ4K3YxeSp2Mnk7CgoJdmFyIGludkRlbm9tID0gMSAvIChkb3QwMCAqIGRvdDExIC0gZG90MDEgKiBkb3QwMSk7Cgl2YXIgdSA9IChkb3QxMSAqIGRvdDAyIC0gZG90MDEgKiBkb3QxMikgKiBpbnZEZW5vbTsKCXZhciB2ID0gKGRvdDAwICogZG90MTIgLSBkb3QwMSAqIGRvdDAyKSAqIGludkRlbm9tOwoKCS8vIENoZWNrIGlmIHBvaW50IGlzIGluIHRyaWFuZ2xlCglyZXR1cm4gKHUgPj0gMCkgJiYgKHYgPj0gMCkgJiYgKHUgKyB2IDwgMSk7Cn0KCi8qKgogKiBDaGVja3MgaWYgYSBzaGFwZSBpcyBjb252ZXgKICoKICogQGNsYXNzIF9jb252ZXgKICogQG5hbWVzcGFjZSBQb2x5SwogKiBAcHJpdmF0ZQogKi8KUElYSS5Qb2x5Sy5fY29udmV4ID0gZnVuY3Rpb24oYXgsIGF5LCBieCwgYnksIGN4LCBjeSwgc2lnbikKewoJcmV0dXJuICgoYXktYnkpKihjeC1ieCkgKyAoYngtYXgpKihjeS1ieSkgPj0gMCkgPT0gc2lnbjsKfQoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQSBDYW1lcmEgaXMgeW91ciB2aWV3IGludG8gdGhlIGdhbWUgd29ybGQuIEl0IGhhcyBhIHBvc2l0aW9uIGFuZCBzaXplIGFuZCByZW5kZXJzIG9ubHkgdGhvc2Ugb2JqZWN0cyB3aXRoaW4gaXRzIGZpZWxkIG9mIHZpZXcuCiogVGhlIGdhbWUgYXV0b21hdGljYWxseSBjcmVhdGVzIGEgc2luZ2xlIFN0YWdlIHNpemVkIGNhbWVyYSBvbiBib290LiBNb3ZlIHRoZSBjYW1lcmEgYXJvdW5kIHRoZSB3b3JsZCB3aXRoIFBoYXNlci5DYW1lcmEueC95CioKKiBAY2xhc3MgUGhhc2VyLkNhbWVyYQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBHYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge251bWJlcn0gaWQgLSBOb3QgYmVpbmcgdXNlZCBhdCB0aGUgbW9tZW50LCB3aWxsIGJlIHdoZW4gUGhhc2VyIHN1cHBvcnRzIG11bHRpcGxlIGNhbWVyYQoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gUG9zaXRpb24gb2YgdGhlIGNhbWVyYSBvbiB0aGUgWCBheGlzCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBQb3NpdGlvbiBvZiB0aGUgY2FtZXJhIG9uIHRoZSBZIGF4aXMKKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBUaGUgd2lkdGggb2YgdGhlIHZpZXcgcmVjdGFuZ2xlCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIHZpZXcgcmVjdGFuZ2xlCiovClBoYXNlci5DYW1lcmEgPSBmdW5jdGlvbiAoZ2FtZSwgaWQsIHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Xb3JsZH0gd29ybGQgLSBBIHJlZmVyZW5jZSB0byB0aGUgZ2FtZSB3b3JsZC4KCSovCgl0aGlzLndvcmxkID0gZ2FtZS53b3JsZDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGlkIC0gUmVzZXJ2ZWQgZm9yIGZ1dHVyZSBtdWx0aXBsZSBjYW1lcmEgc2V0LXVwcy4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmlkID0gMDsgCgoJLyoqCgkqIENhbWVyYSB2aWV3LiAKCSogVGhlIHZpZXcgaW50byB0aGUgd29ybGQgd2Ugd2lzaCB0byByZW5kZXIgKGJ5IGRlZmF1bHQgdGhlIGdhbWUgZGltZW5zaW9ucykuCiAgICAqIFRoZSB4L3kgdmFsdWVzIGFyZSBpbiB3b3JsZCBjb29yZGluYXRlcywgbm90IHNjcmVlbiBjb29yZGluYXRlcywgdGhlIHdpZHRoL2hlaWdodCBpcyBob3cgbWFueSBwaXhlbHMgdG8gcmVuZGVyLgogICAgKiBPYmplY3RzIG91dHNpZGUgb2YgdGhpcyB2aWV3IGFyZSBub3QgcmVuZGVyZWQgKHVubGVzcyBzZXQgdG8gaWdub3JlIHRoZSBDYW1lcmEsIGkuZS4gVUk/KS4KCSogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSB2aWV3CgkqLwogICAgdGhpcy52aWV3ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gc2NyZWVuVmlldyAtIFVzZWQgYnkgU3ByaXRlcyB0byB3b3JrIG91dCBDYW1lcmEgY3VsbGluZy4KCSovCgl0aGlzLnNjcmVlblZpZXcgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAvKioKICAgICogVGhlIENhbWVyYSBpcyBib3VuZCB0byB0aGlzIFJlY3RhbmdsZSBhbmQgY2Fubm90IG1vdmUgb3V0c2lkZSBvZiBpdC4gQnkgZGVmYXVsdCBpdCBpcyBlbmFibGVkIGFuZCBzZXQgdG8gdGhlIHNpemUgb2YgdGhlIFdvcmxkLgogICAgKiBUaGUgUmVjdGFuZ2xlIGNhbiBiZSBsb2NhdGVkIGFueXdoZXJlIGluIHRoZSB3b3JsZCBhbmQgdXBkYXRlZCBhcyBvZnRlbiBhcyB5b3UgbGlrZS4gSWYgeW91IGRvbid0IHdpc2ggdGhlIENhbWVyYSB0byBiZSBib3VuZAogICAgKiBhdCBhbGwgdGhlbiBzZXQgdGhpcyB0byBudWxsLiBUaGUgdmFsdWVzIGNhbiBiZSBhbnl0aGluZyBhbmQgYXJlIGluIFdvcmxkIGNvb3JkaW5hdGVzLCB3aXRoIDAsMCBiZWluZyB0aGUgY2VudGVyIG9mIHRoZSB3b3JsZC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHMgLSBUaGUgUmVjdGFuZ2xlIGluIHdoaWNoIHRoZSBDYW1lcmEgaXMgYm91bmRlZC4gU2V0IHRvIG51bGwgdG8gYWxsb3cgZm9yIG1vdmVtZW50IGFueXdoZXJlLgogICAgKi8KICAgIHRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gZGVhZHpvbmUgLSBNb3ZpbmcgaW5zaWRlIHRoaXMgUmVjdGFuZ2xlIHdpbGwgbm90IGNhdXNlIGNhbWVyYSBtb3ZpbmcuCgkqLwogICAgdGhpcy5kZWFkem9uZSA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIFdoZXRoZXIgdGhpcyBjYW1lcmEgaXMgdmlzaWJsZSBvciBub3QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhdExpbWl0IC0gV2hldGhlciB0aGlzIGNhbWVyYSBpcyBmbHVzaCB3aXRoIHRoZSBXb3JsZCBCb3VuZHMgb3Igbm90LgogICAgKi8KICAgIHRoaXMuYXRMaW1pdCA9IHsgeDogZmFsc2UsIHk6IGZhbHNlIH07CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gdGFyZ2V0IC0gSWYgdGhlIGNhbWVyYSBpcyB0cmFja2luZyBhIFNwcml0ZSwgdGhpcyBpcyBhIHJlZmVyZW5jZSB0byBpdCwgb3RoZXJ3aXNlIG51bGwuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50YXJnZXQgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gZWRnZSAtIEVkZ2UgcHJvcGVydHkuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZWRnZSA9IDA7CgogICAgdGhpcy5kaXNwbGF5T2JqZWN0ID0gbnVsbDsKCQp9OwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkNhbWVyYS5GT0xMT1dfTE9DS09OID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5DYW1lcmEuRk9MTE9XX1BMQVRGT1JNRVIgPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkNhbWVyYS5GT0xMT1dfVE9QRE9XTiA9IDI7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuQ2FtZXJhLkZPTExPV19UT1BET1dOX1RJR0hUID0gMzsKClBoYXNlci5DYW1lcmEucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBUZWxscyB0aGlzIGNhbWVyYSB3aGljaCBzcHJpdGUgdG8gZm9sbG93LgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjZm9sbG93CiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gdGFyZ2V0IC0gVGhlIG9iamVjdCB5b3Ugd2FudCB0aGUgY2FtZXJhIHRvIHRyYWNrLiBTZXQgdG8gbnVsbCB0byBub3QgZm9sbG93IGFueXRoaW5nLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0eWxlXSBMZXZlcmFnZSBvbmUgb2YgdGhlIGV4aXN0aW5nICJkZWFkem9uZSIgcHJlc2V0cy4gSWYgeW91IHVzZSBhIGN1c3RvbSBkZWFkem9uZSwgaWdub3JlIHRoaXMgcGFyYW1ldGVyIGFuZCBtYW51YWxseSBzcGVjaWZ5IHRoZSBkZWFkem9uZSBhZnRlciBjYWxsaW5nIGZvbGxvdygpLgogICAgKi8KICAgIGZvbGxvdzogZnVuY3Rpb24gKHRhcmdldCwgc3R5bGUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdHlsZSA9PT0gInVuZGVmaW5lZCIpIHsgc3R5bGUgPSBQaGFzZXIuQ2FtZXJhLkZPTExPV19MT0NLT047IH0KCiAgICAgICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CgogICAgICAgIHZhciBoZWxwZXI7CgogICAgICAgIHN3aXRjaCAoc3R5bGUpIHsKCiAgICAgICAgICAgIGNhc2UgUGhhc2VyLkNhbWVyYS5GT0xMT1dfUExBVEZPUk1FUjoKICAgICAgICAgICAgICAgIHZhciB3ID0gdGhpcy53aWR0aCAvIDg7CiAgICAgICAgICAgICAgICB2YXIgaCA9IHRoaXMuaGVpZ2h0IC8gMzsKICAgICAgICAgICAgICAgIHRoaXMuZGVhZHpvbmUgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgodGhpcy53aWR0aCAtIHcpIC8gMiwgKHRoaXMuaGVpZ2h0IC0gaCkgLyAyIC0gaCAqIDAuMjUsIHcsIGgpOwogICAgICAgICAgICAgICAgYnJlYWs7CgogICAgICAgICAgICBjYXNlIFBoYXNlci5DYW1lcmEuRk9MTE9XX1RPUERPV046CiAgICAgICAgICAgICAgICBoZWxwZXIgPSBNYXRoLm1heCh0aGlzLndpZHRoLCB0aGlzLmhlaWdodCkgLyA0OwogICAgICAgICAgICAgICAgdGhpcy5kZWFkem9uZSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCh0aGlzLndpZHRoIC0gaGVscGVyKSAvIDIsICh0aGlzLmhlaWdodCAtIGhlbHBlcikgLyAyLCBoZWxwZXIsIGhlbHBlcik7CiAgICAgICAgICAgICAgICBicmVhazsKCiAgICAgICAgICAgIGNhc2UgUGhhc2VyLkNhbWVyYS5GT0xMT1dfVE9QRE9XTl9USUdIVDoKICAgICAgICAgICAgICAgIGhlbHBlciA9IE1hdGgubWF4KHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KSAvIDg7CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKHRoaXMud2lkdGggLSBoZWxwZXIpIC8gMiwgKHRoaXMuaGVpZ2h0IC0gaGVscGVyKSAvIDIsIGhlbHBlciwgaGVscGVyKTsKICAgICAgICAgICAgICAgIGJyZWFrOwoKICAgICAgICAgICAgY2FzZSBQaGFzZXIuQ2FtZXJhLkZPTExPV19MT0NLT046CiAgICAgICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgICAgICB0aGlzLmRlYWR6b25lID0gbnVsbDsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBjYW1lcmEgZm9jdXMgb24gYSBkaXNwbGF5IG9iamVjdCBpbnN0YW50bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNmb2N1c09uCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIGZvY3VzIHRoZSBjYW1lcmEgb24uIE11c3QgaGF2ZSB2aXNpYmxlIHgveSBwcm9wZXJ0aWVzLgogICAgKi8KICAgIGZvY3VzT246IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0KSB7CgogICAgICAgIHRoaXMuc2V0UG9zaXRpb24oTWF0aC5yb3VuZChkaXNwbGF5T2JqZWN0LnggLSB0aGlzLnZpZXcuaGFsZldpZHRoKSwgTWF0aC5yb3VuZChkaXNwbGF5T2JqZWN0LnkgLSB0aGlzLnZpZXcuaGFsZkhlaWdodCkpOwoKICAgIH0sCgoJLyoqCiAgICAqIE1vdmUgdGhlIGNhbWVyYSBmb2N1cyBvbiBhIGxvY2F0aW9uIGluc3RhbnRseS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FtZXJhI2ZvY3VzT25YWQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbi4KICAgICovCiAgICBmb2N1c09uWFk6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMuc2V0UG9zaXRpb24oTWF0aC5yb3VuZCh4IC0gdGhpcy52aWV3LmhhbGZXaWR0aCksIE1hdGgucm91bmQoeSAtIHRoaXMudmlldy5oYWxmSGVpZ2h0KSk7CgogICAgfSwKCgkvKioKICAgICogVXBkYXRlIGZvY3VzaW5nIGFuZCBzY3JvbGxpbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy51cGRhdGVUYXJnZXQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZGlzcGxheU9iamVjdC5wb3NpdGlvbi54ID0gLXRoaXMudmlldy54OwogICAgICAgIHRoaXMuZGlzcGxheU9iamVjdC5wb3NpdGlvbi55ID0gLXRoaXMudmlldy55OwoKICAgIH0sCgogICAgdXBkYXRlVGFyZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmRlYWR6b25lKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnggLSB0aGlzLmRlYWR6b25lLng7CgogICAgICAgICAgICBpZiAodGhpcy52aWV3LnggPiB0aGlzLl9lZGdlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnZpZXcueCA9IHRoaXMuX2VkZ2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX2VkZ2UgPSB0aGlzLnRhcmdldC54ICsgdGhpcy50YXJnZXQud2lkdGggLSB0aGlzLmRlYWR6b25lLnggLSB0aGlzLmRlYWR6b25lLndpZHRoOwoKICAgICAgICAgICAgaWYgKHRoaXMudmlldy54IDwgdGhpcy5fZWRnZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy52aWV3LnggPSB0aGlzLl9lZGdlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9lZGdlID0gdGhpcy50YXJnZXQueSAtIHRoaXMuZGVhZHpvbmUueTsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueSA+IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy55ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fZWRnZSA9IHRoaXMudGFyZ2V0LnkgKyB0aGlzLnRhcmdldC5oZWlnaHQgLSB0aGlzLmRlYWR6b25lLnkgLSB0aGlzLmRlYWR6b25lLmhlaWdodDsKCiAgICAgICAgICAgIGlmICh0aGlzLnZpZXcueSA8IHRoaXMuX2VkZ2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMudmlldy55ID0gdGhpcy5fZWRnZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZvY3VzT25YWSh0aGlzLnRhcmdldC54LCB0aGlzLnRhcmdldC55KTsKICAgICAgICB9CgogICAgfSwKCiAgICBzZXRCb3VuZHNUb1dvcmxkOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuYm91bmRzLnNldFRvKHRoaXMuZ2FtZS53b3JsZC54LCB0aGlzLmdhbWUud29ybGQueSwgdGhpcy5nYW1lLndvcmxkLndpZHRoLCB0aGlzLmdhbWUud29ybGQuaGVpZ2h0KTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBNZXRob2QgY2FsbGVkIHRvIGVuc3VyZSB0aGUgY2FtZXJhIGRvZXNuJ3QgdmVudHVyZSBvdXRzaWRlIG9mIHRoZSBnYW1lIHdvcmxkLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjY2hlY2tXb3JsZEJvdW5kcwogICAgKi8KICAgIGNoZWNrQm91bmRzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuYXRMaW1pdC54ID0gZmFsc2U7CiAgICAgICAgdGhpcy5hdExpbWl0LnkgPSBmYWxzZTsKCiAgICAgICAgLy8gIE1ha2Ugc3VyZSB3ZSBkaWRuJ3QgZ28gb3V0c2lkZSB0aGUgY2FtZXJhcyBib3VuZHMKICAgICAgICBpZiAodGhpcy52aWV3LnggPCB0aGlzLmJvdW5kcy54KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnggPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueCA9IHRoaXMuYm91bmRzLng7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy52aWV3LnggPiB0aGlzLmJvdW5kcy5yaWdodCAtIHRoaXMud2lkdGgpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmF0TGltaXQueCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMudmlldy54ID0gKHRoaXMuYm91bmRzLnJpZ2h0IC0gdGhpcy53aWR0aCkgKyAxOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudmlldy55IDwgdGhpcy5ib3VuZHMudG9wKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueSA9IHRoaXMuYm91bmRzLnRvcDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnZpZXcueSA+IHRoaXMuYm91bmRzLmJvdHRvbSAtIHRoaXMuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hdExpbWl0LnkgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnZpZXcueSA9ICh0aGlzLmJvdW5kcy5ib3R0b20gLSB0aGlzLmhlaWdodCkgKyAxOwogICAgICAgIH0KCiAgICAgICAgdGhpcy52aWV3LmZsb29yKCk7CgogICAgfSwKCiAgICAvKioKICAgICogQSBoZWxwZXIgZnVuY3Rpb24gdG8gc2V0IGJvdGggdGhlIFggYW5kIFkgcHJvcGVydGllcyBvZiB0aGUgY2FtZXJhIGF0IG9uY2UKICAgICogd2l0aG91dCBoYXZpbmcgdG8gdXNlIGdhbWUuY2FtZXJhLnggYW5kIGdhbWUuY2FtZXJhLnkuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5DYW1lcmEjc2V0UG9zaXRpb24KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24uCiAgICAqLwogICAgc2V0UG9zaXRpb246IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMudmlldy54ID0geDsKICAgICAgICB0aGlzLnZpZXcueSA9IHk7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHMoKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgc2l6ZSBvZiB0aGUgdmlldyByZWN0YW5nbGUgZ2l2ZW4gdGhlIHdpZHRoIGFuZCBoZWlnaHQgaW4gcGFyYW1ldGVycy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbWVyYSNzZXRTaXplCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBkZXNpcmVkIHdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGRlc2lyZWQgaGVpZ2h0LgogICAgKi8KICAgIHNldFNpemU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMudmlldy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMudmlldy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgfQoKfTsKCi8qKgoqIFRoZSBDYW1lcmFzIHggY29vcmRpbmF0ZS4gVGhpcyB2YWx1ZSBpcyBhdXRvbWF0aWNhbGx5IGNsYW1wZWQgaWYgaXQgZmFsbHMgb3V0c2lkZSBvZiB0aGUgV29ybGQgYm91bmRzLgoqIEBuYW1lIFBoYXNlci5DYW1lcmEjeAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHggcG9zaXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2FtZXJhLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy54OwogICAgfSwKIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy52aWV3LnggPSB2YWx1ZTsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jaGVja0JvdW5kcygpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIENhbWVyYXMgeSBjb29yZGluYXRlLiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgY2xhbXBlZCBpZiBpdCBmYWxscyBvdXRzaWRlIG9mIHRoZSBXb3JsZCBib3VuZHMuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBHZXRzIG9yIHNldHMgdGhlIGNhbWVyYXMgeSBwb3NpdGlvbi4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAieSIsIHsKCQogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudmlldy55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLnZpZXcueSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy5ib3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzKCk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgQ2FtZXJhcyB3aWR0aC4gQnkgZGVmYXVsdCB0aGlzIGlzIHRoZSBzYW1lIGFzIHRoZSBHYW1lIHNpemUgYW5kIHNob3VsZCBub3QgYmUgYWRqdXN0ZWQgZm9yIG5vdy4KKiBAbmFtZSBQaGFzZXIuQ2FtZXJhI3dpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIHdpZHRoLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNhbWVyYS5wcm90b3R5cGUsICJ3aWR0aCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy52aWV3LndpZHRoOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMudmlldy53aWR0aCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgQ2FtZXJhcyBoZWlnaHQuIEJ5IGRlZmF1bHQgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgR2FtZSBzaXplIGFuZCBzaG91bGQgbm90IGJlIGFkanVzdGVkIGZvciBub3cuCiogQG5hbWUgUGhhc2VyLkNhbWVyYSNoZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gR2V0cyBvciBzZXRzIHRoZSBjYW1lcmFzIGhlaWdodC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DYW1lcmEucHJvdG90eXBlLCAiaGVpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnZpZXcuaGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMudmlldy5oZWlnaHQgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhpcyBpcyBhIGJhc2UgU3RhdGUgY2xhc3Mgd2hpY2ggY2FuIGJlIGV4dGVuZGVkIGlmIHlvdSBhcmUgY3JlYXRpbmcgeW91ciBvd24gZ2FtZS4KKiBJdCBwcm92aWRlcyBxdWljayBhY2Nlc3MgdG8gY29tbW9uIGZ1bmN0aW9ucyBzdWNoIGFzIHRoZSBjYW1lcmEsIGNhY2hlLCBpbnB1dCwgbWF0Y2gsIHNvdW5kIGFuZCBtb3JlLgoqCiogQGNsYXNzIFBoYXNlci5TdGF0ZQoqIEBjb25zdHJ1Y3RvcgoqLwoKUGhhc2VyLlN0YXRlID0gZnVuY3Rpb24gKCkgewoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCgkqLwogICAgdGhpcy5nYW1lID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5fSBhZGQgLSBSZWZlcmVuY2UgdG8gdGhlIEdhbWVPYmplY3RGYWN0b3J5LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYWRkID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBoeXNpY3MuUGh5c2ljc01hbmFnZXJ9IGNhbWVyYSAtIEEgaGFuZHkgcmVmZXJlbmNlIHRvIHdvcmxkLmNhbWVyYS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNhbWVyYSA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5DYWNoZX0gY2FjaGUgLSBSZWZlcmVuY2UgdG8gdGhlIGFzc2V0cyBjYWNoZS4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNhY2hlID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLklucHV0fSBpbnB1dCAtIFJlZmVyZW5jZSB0byB0aGUgaW5wdXQgbWFuYWdlcgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuaW5wdXQgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuTG9hZGVyfSBsb2FkIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgbG9hZGVyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubG9hZCA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5NYXRofSBtYXRoIC0gUmVmZXJlbmNlIHRvIHRoZSBtYXRoIGhlbHBlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLm1hdGggPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU291bmRNYW5hZ2VyfSBzb3VuZCAtIFJlZmVyZW5jZSB0byB0aGUgc291bmQgbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnNvdW5kID0gbnVsbDsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YWdlfSBzdGFnZSAtIFJlZmVyZW5jZSB0byB0aGUgc3RhZ2UuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zdGFnZSA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5UaW1lTWFuYWdlcn0gdGltZSAtIFJlZmVyZW5jZSB0byBnYW1lIGNsb2NrLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudGltZSA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Ud2Vlbk1hbmFnZXJ9IHR3ZWVucyAtIFJlZmVyZW5jZSB0byB0aGUgdHdlZW4gbWFuYWdlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnR3ZWVucyA9IG51bGw7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Xb3JsZH0gd29ybGQgLSBSZWZlcmVuY2UgdG8gdGhlIHdvcmxkLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMud29ybGQgPSBudWxsOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gYWRkIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5wYXJ0aWNsZXMgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5QaHlzaWNzTWFuYWdlcn0gcGh5c2ljcyAtIFJlZmVyZW5jZSB0byB0aGUgcGh5c2ljcyBtYW5hZ2VyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucGh5c2ljcyA9IG51bGw7Cgp9OwoKUGhhc2VyLlN0YXRlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogT3ZlcnJpZGUgdGhpcyBtZXRob2QgdG8gYWRkIHNvbWUgbG9hZCBvcGVyYXRpb25zLgogICAgKiBJZiB5b3UgbmVlZCB0byB1c2UgdGhlIGxvYWRlciwgeW91IG1heSBuZWVkIHRvIHVzZSB0aGVtIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNwcmVsb2FkCiAgICAqLwogICAgcHJlbG9hZDogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHVwZGF0ZSBsb2dpYyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjbG9hZFVwZGF0ZQogICAgKi8KICAgIGxvYWRVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCByZW5kZXIgb3BlcmF0aW9ucyBoZXJlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjbG9hZFJlbmRlcgogICAgKi8KICAgIGxvYWRSZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBhZnRlciB0aGUgZ2FtZSBlbmdpbmUgc3VjY2Vzc2Z1bGx5IHN3aXRjaGVzIHN0YXRlcy4KICAgICogRmVlbCBmcmVlIHRvIGFkZCBhbnkgc2V0dXAgY29kZSBoZXJlIChkbyBub3QgbG9hZCBhbnl0aGluZyBoZXJlLCBvdmVycmlkZSBwcmVsb2FkKCkgaW5zdGVhZCkuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNjcmVhdGUKICAgICovCiAgICBjcmVhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFB1dCB1cGRhdGUgbG9naWMgaGVyZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUHV0IHJlbmRlciBvcGVyYXRpb25zIGhlcmUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNyZW5kZXIKICAgICovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHdoZW4gZ2FtZSBwYXVzZWQuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZSNwYXVzZWQKICAgICovCiAgICBwYXVzZWQ6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoaXMgbWV0aG9kIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIHN0YXRlIGlzIGRlc3Ryb3llZC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGUjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUaGUgU3RhdGUgTWFuYWdlciBpcyByZXNwb25zaWJsZSBmb3IgbG9hZGluZywgc2V0dGluZyB1cCBhbmQgc3dpdGNoaW5nIGdhbWUgc3RhdGVzLgoqIAoqIEBjbGFzcyBQaGFzZXIuU3RhdGVNYW5hZ2VyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7UGhhc2VyLlN0YXRlfE9iamVjdH0gW3BlbmRpbmdTdGF0ZT1udWxsXSAtIEEgU3RhdGUgb2JqZWN0IHRvIHNlZWQgdGhlIG1hbmFnZXIgd2l0aC4KKi8KUGhhc2VyLlN0YXRlTWFuYWdlciA9IGZ1bmN0aW9uIChnYW1lLCBwZW5kaW5nU3RhdGUpIHsKCgkvKioKCSogQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHN0YXRlcy4KCSovCgl0aGlzLnN0YXRlcyA9IHt9OwoKCWlmIChwZW5kaW5nU3RhdGUgIT09IG51bGwpCgl7CgkJdGhpcy5fcGVuZGluZ1N0YXRlID0gcGVuZGluZ1N0YXRlOwoJfQoKfTsKClBoYXNlci5TdGF0ZU1hbmFnZXIucHJvdG90eXBlID0gewoJCgkvKioKCSogQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUuCgkqLwoJZ2FtZTogbnVsbCwKCgkvKioKCSogVGhlIHN0YXRlIHRvIGJlIHN3aXRjaGVkIHRvIGluIHRoZSBuZXh0IGZyYW1lLgoJKiBAcHJvcGVydHkge1N0YXRlfSBfcGVuZGluZ1N0YXRlIAoJKiBAcHJpdmF0ZQoJKi8KCV9wZW5kaW5nU3RhdGU6IG51bGwsCgoJLyoqCgkqIEZsYWcgdGhhdCBzZXRzIGlmIHRoZSBTdGF0ZSBoYXMgYmVlbiBjcmVhdGVkIG9yIG5vdC4KCSogQHByb3BlcnR5IHtib29sZWFufV9jcmVhdGVkCgkqIEBwcml2YXRlCgkqLwoJX2NyZWF0ZWQ6IGZhbHNlLAoKCS8qKgoJKiBUaGUgc3RhdGUgdG8gYmUgc3dpdGNoZWQgdG8gaW4gdGhlIG5leHQgZnJhbWUuCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHN0YXRlcwoJKi8KCXN0YXRlczoge30sCgoJLyoqCgkqIFRoZSBjdXJyZW50IGFjdGl2ZSBTdGF0ZSBvYmplY3QgKGRlZmF1bHRzIHRvIG51bGwpLgoJKiBAcHJvcGVydHkge3N0cmluZ30gY3VycmVudAoJKi8KCWN1cnJlbnQ6ICcnLAoJCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBzdGF0ZSBpcyBzdGFydGVkIChpLmUuIHNldCBhcyB0aGUgY3VycmVudCBhY3RpdmUgc3RhdGUpLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkluaXRDYWxsYmFjawoJKi8KCW9uSW5pdENhbGxiYWNrOiBudWxsLAoKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gaW5pdCBzdGF0ZXMgKGxvYWRpbmcgYXNzZXRzLi4uKS4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25QcmVsb2FkQ2FsbGJhY2sKCSovCglvblByZWxvYWRDYWxsYmFjazogbnVsbCwKCQoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiBjcmVhdGUgc3RhdGVzIChzZXR1cCBzdGF0ZXMuLi4pLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkNyZWF0ZUNhbGxiYWNrCgkqLwoJb25DcmVhdGVDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIFN0YXRlIGlzIHVwZGF0ZWQsIHRoaXMgZG9lc24ndCBoYXBwZW4gZHVyaW5nIGxvYWQgKEBzZWUgb25Mb2FkVXBkYXRlQ2FsbGJhY2spLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblVwZGF0ZUNhbGxiYWNrCgkqLwoJb25VcGRhdGVDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBTdGF0ZSBpcyByZW5kZXJlZCwgdGhpcyBkb2Vzbid0IGhhcHBlbiBkdXJpbmcgbG9hZCAoc2VlIG9uTG9hZFJlbmRlckNhbGxiYWNrKS4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25SZW5kZXJDYWxsYmFjawoJKi8KCW9uUmVuZGVyQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgYmVmb3JlIHRoZSBTdGF0ZSBpcyByZW5kZXJlZCBhbmQgYmVmb3JlIHRoZSBzdGFnZSBpcyBjbGVhcmVkLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvblByZVJlbmRlckNhbGxiYWNrCgkqLwoJb25QcmVSZW5kZXJDYWxsYmFjazogbnVsbCwKCgkvKioKCSogVGhpcyB3aWxsIGJlIGNhbGxlZCB3aGVuIHRoZSBTdGF0ZSBpcyB1cGRhdGVkIGJ1dCBvbmx5IGR1cmluZyB0aGUgbG9hZCBwcm9jZXNzLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkxvYWRVcGRhdGVDYWxsYmFjawoJKi8KCW9uTG9hZFVwZGF0ZUNhbGxiYWNrOiBudWxsLAoKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gdGhlIFN0YXRlIGlzIHJlbmRlcmVkIGJ1dCBvbmx5IGR1cmluZyB0aGUgbG9hZCBwcm9jZXNzLgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBvbkxvYWRSZW5kZXJDYWxsYmFjawoJKi8KCW9uTG9hZFJlbmRlckNhbGxiYWNrOiBudWxsLAoKCS8qKgoJKiBUaGlzIHdpbGwgYmUgY2FsbGVkIHdoZW4gc3RhdGVzIHBhdXNlZC4KCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25QYXVzZWRDYWxsYmFjawoJKi8KCW9uUGF1c2VkQ2FsbGJhY2s6IG51bGwsCgoJLyoqCgkqIFRoaXMgd2lsbCBiZSBjYWxsZWQgd2hlbiB0aGUgc3RhdGUgaXMgc2h1dCBkb3duIChpLmUuIHN3YXBwZWQgdG8gYW5vdGhlciBzdGF0ZSkuCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uU2h1dERvd25DYWxsYmFjawoJKi8KCW9uU2h1dERvd25DYWxsYmFjazogbnVsbCwKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNib290CgkqIEBwcml2YXRlCgkqLwoJYm9vdDogZnVuY3Rpb24gKCkgewoKCQkvLyBjb25zb2xlLmxvZygnUGhhc2VyLlN0YXRlTWFuYWdlci5ib290Jyk7CgoJCWlmICh0aGlzLl9wZW5kaW5nU3RhdGUgIT09IG51bGwpCgkJewoJCQkvLyBjb25zb2xlLmxvZygnX3BlbmRpbmdTdGF0ZSBmb3VuZCcpOwoJCQkvLyBjb25zb2xlLmxvZyh0eXBlb2YgdGhpcy5fcGVuZGluZ1N0YXRlKTsKCgkJCWlmICh0eXBlb2YgdGhpcy5fcGVuZGluZ1N0YXRlID09PSAnc3RyaW5nJykKCQkJewoJCQkJLy8JU3RhdGUgd2FzIGFscmVhZHkgYWRkZWQsIHNvIGp1c3Qgc3RhcnQgaXQKCQkJCXRoaXMuc3RhcnQodGhpcy5fcGVuZGluZ1N0YXRlLCBmYWxzZSwgZmFsc2UpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5hZGQoJ2RlZmF1bHQnLCB0aGlzLl9wZW5kaW5nU3RhdGUsIHRydWUpOwoJCQl9CgoJCX0KCgl9LAoKCS8qKgogICAgKiBBZGQgYSBuZXcgU3RhdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNhZGQKICAgICogQHBhcmFtIGtleSB7c3RyaW5nfSAtIEEgdW5pcXVlIGtleSB5b3UgdXNlIHRvIHJlZmVyZW5jZSB0aGlzIHN0YXRlLCBpLmUuICJNYWluTWVudSIsICJMZXZlbDEiLgogICAgKiBAcGFyYW0gc3RhdGUge1N0YXRlfSAtIFRoZSBzdGF0ZSB5b3Ugd2FudCB0byBzd2l0Y2ggdG8uCiAgICAqIEBwYXJhbSBhdXRvU3RhcnQge2Jvb2xlYW59IC0gU3RhcnQgdGhlIHN0YXRlIGltbWVkaWF0ZWx5IGFmdGVyIGNyZWF0aW5nIGl0PyAoZGVmYXVsdCB0cnVlKQogICAgKi8KICAgIGFkZDogZnVuY3Rpb24gKGtleSwgc3RhdGUsIGF1dG9TdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIGF1dG9TdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgYXV0b1N0YXJ0ID0gZmFsc2U7IH0KCgkJLy8gY29uc29sZS5sb2coJ1BoYXNlci5TdGF0ZU1hbmFnZXIuYWRkU3RhdGUnLCBrZXkpOwoJCS8vIGNvbnNvbGUubG9nKHR5cGVvZiBzdGF0ZSk7CgkJLy8gY29uc29sZS5sb2coJ2F1dG9TdGFydD8nLCBhdXRvU3RhcnQpOwoKCQl2YXIgbmV3U3RhdGU7CgoJCWlmIChzdGF0ZSBpbnN0YW5jZW9mIFBoYXNlci5TdGF0ZSkKCQl7CgkJCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLmFkZFN0YXRlOiBQaGFzZXIuU3RhdGUgZ2l2ZW4nKTsKCQkJbmV3U3RhdGUgPSBzdGF0ZTsKCQl9CgkJZWxzZSBpZiAodHlwZW9mIHN0YXRlID09PSAnb2JqZWN0JykKCQl7CgkJCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLmFkZFN0YXRlOiBPYmplY3QgZ2l2ZW4nKTsKCQkJbmV3U3RhdGUgPSBzdGF0ZTsKCQkJbmV3U3RhdGUuZ2FtZSA9IHRoaXMuZ2FtZTsKCQl9CgkJZWxzZSBpZiAodHlwZW9mIHN0YXRlID09PSAnZnVuY3Rpb24nKQoJCXsKCQkJLy8gY29uc29sZS5sb2coJ1BoYXNlci5TdGF0ZU1hbmFnZXIuYWRkU3RhdGU6IEZ1bmN0aW9uIGdpdmVuJyk7CgkJCW5ld1N0YXRlID0gbmV3IHN0YXRlKHRoaXMuZ2FtZSk7CgkJfQoKCQl0aGlzLnN0YXRlc1trZXldID0gbmV3U3RhdGU7CgoJCWlmIChhdXRvU3RhcnQpCgkJewoJCQlpZiAodGhpcy5nYW1lLmlzQm9vdGVkKQoJCQl7CgkJCQkvLyBjb25zb2xlLmxvZygnR2FtZSBpcyBib290ZWQsIHNvIHdlIGNhbiBzdGFydCB0aGUgc3RhdGUgbm93Jyk7CgkJCQl0aGlzLnN0YXJ0KGtleSk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkvLyBjb25zb2xlLmxvZygnR2FtZSBpcyBOT1QgYm9vdGVkLCBzbyBzZXQgdGhlIGN1cnJlbnQgc3RhdGUgYXMgcGVuZGluZycpOwoJCQkJdGhpcy5fcGVuZGluZ1N0YXRlID0ga2V5OwoJCQl9CgkJfQoKCQlyZXR1cm4gbmV3U3RhdGU7CgogICAgfSwKCgkvKioKICAgICAqIERlbGV0ZSB0aGUgZ2l2ZW4gc3RhdGUuCiAgICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcmVtb3ZlCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQSB1bmlxdWUga2V5IHlvdSB1c2UgdG8gcmVmZXJlbmNlIHRoaXMgc3RhdGUsIGkuZS4gIk1haW5NZW51IiwgIkxldmVsMSIuCiAgICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGtleSkgewoKICAgIAlpZiAodGhpcy5jdXJyZW50ID09IGtleSkKICAgIAl7CgkgICAgICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKCgkgICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uU2h1dERvd25DYWxsYmFjayA9IG51bGw7CgoJICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrID0gbnVsbDsKCSAgICAgICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjayA9IG51bGw7CgkgICAgICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uUGF1c2VkQ2FsbGJhY2sgPSBudWxsOwoJICAgICAgICB0aGlzLm9uRGVzdHJveUNhbGxiYWNrID0gbnVsbDsKICAgIAl9CgogICAgCWRlbGV0ZSB0aGlzLnN0YXRlc1trZXldOwoKICAgIH0sCgoJLyoqCiAgICAqIFN0YXJ0IHRoZSBnaXZlbiBzdGF0ZQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjc3RhcnQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBrZXkgb2YgdGhlIHN0YXRlIHlvdSB3YW50IHRvIHN0YXJ0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcldvcmxkXSAtIGNsZWFyIGV2ZXJ5dGhpbmcgaW4gdGhlIHdvcmxkPyAoRGVmYXVsdCB0byB0cnVlKQogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhckNhY2hlXSAtIGNsZWFyIGFzc2V0IGNhY2hlPyAoRGVmYXVsdCB0byBmYWxzZSBhbmQgT05MWSBhdmFpbGFibGUgd2hlbiBjbGVhcldvcmxkPXRydWUpCiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uIChrZXksIGNsZWFyV29ybGQsIGNsZWFyQ2FjaGUpIHsKCiAgICAJLy8gY29uc29sZS5sb2coJ1BoYXNlci5TdGF0ZU1hbmFnZXIuc3RhcnQnLCBrZXkpOwogICAgCS8vIGNvbnNvbGUubG9nKHRoaXMpOwogICAgCS8vIGNvbnNvbGUubG9nKHRoaXMuY2FsbGJhY2tDb250ZXh0KTsKCiAgICAgICAgaWYgKHR5cGVvZiBjbGVhcldvcmxkID09PSAidW5kZWZpbmVkIikgeyBjbGVhcldvcmxkID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2YgY2xlYXJDYWNoZSA9PT0gInVuZGVmaW5lZCIpIHsgY2xlYXJDYWNoZSA9IGZhbHNlOyB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaXNCb290ZWQgPT0gZmFsc2UpCiAgICAgICAgewoJCQkvLyBjb25zb2xlLmxvZygnR2FtZSBpcyBOT1QgYm9vdGVkLCBzbyBzZXQgdGhlIHJlcXVlc3RlZCBzdGF0ZSBhcyBwZW5kaW5nJyk7CgkJCXRoaXMuX3BlbmRpbmdTdGF0ZSA9IGtleTsKCQkJcmV0dXJuOwogICAgICAgIH0KCgkJaWYgKHRoaXMuY2hlY2tTdGF0ZShrZXkpID09IGZhbHNlKQoJCXsKCQkJcmV0dXJuOwoJCX0KCQllbHNlCgkJewoJCQkvLwlBbHJlYWR5IGdvdCBhIHN0YXRlIHJ1bm5pbmc/CgkJCWlmICh0aGlzLmN1cnJlbnQpCgkJCXsKCQkJCXRoaXMub25TaHV0RG93bkNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgkJCX0KCgkgICAgICAgIGlmIChjbGVhcldvcmxkKQoJICAgICAgICB7CgkJCQl0aGlzLmdhbWUudHdlZW5zLnJlbW92ZUFsbCgpOwoKCSAgICAgICAgICAgIHRoaXMuZ2FtZS53b3JsZC5kZXN0cm95KCk7CgoJICAgICAgICAgICAgaWYgKGNsZWFyQ2FjaGUgPT0gdHJ1ZSkKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FjaGUuZGVzdHJveSgpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJCQl0aGlzLnNldEN1cnJlbnRTdGF0ZShrZXkpOwoJCX0KCiAgICAgICAgaWYgKHRoaXMub25QcmVsb2FkQ2FsbGJhY2spCiAgICAgICAgewoJICAgIAkvLyBjb25zb2xlLmxvZygnUHJlbG9hZCBDYWxsYmFjayBmb3VuZCcpOwogICAgICAgICAgICB0aGlzLmdhbWUubG9hZC5yZXNldCgpOwogICAgICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgogICAgICAgICAgICAvLyAgSXMgdGhlIGxvYWRlciBlbXB0eT8KICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5sb2FkLnF1ZXVlU2l6ZSA9PSAwKQogICAgICAgICAgICB7CgkJICAgIAkvLyBjb25zb2xlLmxvZygnTG9hZGVyIHF1ZXVlIGVtcHR5Jyk7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUubG9hZENvbXBsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CgkJICAgIAkvLyBjb25zb2xlLmxvZygnTG9hZGVyIHN0YXJ0ZWQnKTsKICAgICAgICAgICAgICAgIC8vICBTdGFydCB0aGUgbG9hZGVyIGdvaW5nIGFzIHdlIGhhdmUgc29tZXRoaW5nIGluIHRoZSBxdWV1ZQogICAgICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWQuc3RhcnQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewoJCQkvLyBjb25zb2xlLmxvZygnUHJlbG9hZCBjYWxsYmFjayBub3QgZm91bmQnKTsKICAgICAgICAgICAgLy8gIE5vIGluaXQ/IFRoZW4gdGhlcmUgd2FzIG5vdGhpbmcgdG8gbG9hZCBlaXRoZXIKICAgICAgICAgICAgdGhpcy5nYW1lLmxvYWRDb21wbGV0ZSgpOwogICAgICAgIH0KCiAgICB9LAoJCgkvKioKCSogVXNlZCBieSBvbkluaXQgYW5kIG9uU2h1dGRvd24gd2hlbiB0aG9zZSBmdW5jdGlvbnMgZG9uJ3QgZXhpc3Qgb24gdGhlIHN0YXRlCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNkdW1teQogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGR1bW15OiBmdW5jdGlvbiAoKSB7CiAgICB9LAoKCS8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2NoZWNrU3RhdGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBrZXkgb2YgdGhlIHN0YXRlIHlvdSB3YW50IHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBEZXNjcmlwdGlvbi4KICAgICovCiAgICBjaGVja1N0YXRlOiBmdW5jdGlvbiAoa2V5KSB7CgoJCWlmICh0aGlzLnN0YXRlc1trZXldKQoJCXsKCQkJdmFyIHZhbGlkID0gZmFsc2U7CgoJCQlpZiAodGhpcy5zdGF0ZXNba2V5XVsncHJlbG9hZCddKSB7IHZhbGlkID0gdHJ1ZTsgfQoKCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRSZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRVcGRhdGUnXSkgeyB2YWxpZCA9IHRydWU7IH0KCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ2NyZWF0ZSddKSB7IHZhbGlkID0gdHJ1ZTsgfQoJCQlpZiAodmFsaWQgPT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsndXBkYXRlJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgkJCWlmICh2YWxpZCA9PSBmYWxzZSAmJiB0aGlzLnN0YXRlc1trZXldWydwcmVSZW5kZXInXSkgeyB2YWxpZCA9IHRydWU7IH0KCQkJaWYgKHZhbGlkID09IGZhbHNlICYmIHRoaXMuc3RhdGVzW2tleV1bJ3JlbmRlciddKSB7IHZhbGlkID0gdHJ1ZTsgfQoJCQlpZiAodmFsaWQgPT0gZmFsc2UgJiYgdGhpcy5zdGF0ZXNba2V5XVsncGF1c2VkJ10pIHsgdmFsaWQgPSB0cnVlOyB9CgogICAgICAgIAlpZiAodmFsaWQgPT0gZmFsc2UpCiAgICAgICAgCXsKCSAgICAgICAgICAgIGNvbnNvbGUud2FybigiSW52YWxpZCBQaGFzZXIgU3RhdGUgb2JqZWN0IGdpdmVuLiBNdXN0IGNvbnRhaW4gYXQgbGVhc3QgYSBvbmUgb2YgdGhlIHJlcXVpcmVkIGZ1bmN0aW9ucy4iKTsKCSAgICAgICAgICAgIHJldHVybiBmYWxzZTsKCSAgICAgICAgfQoKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWVsc2UKCQl7CgkJCWNvbnNvbGUud2FybigiUGhhc2VyLlN0YXRlTWFuYWdlciAtIE5vIHN0YXRlIGZvdW5kIHdpdGggdGhlIGtleTogIiArIGtleSk7CgkJCXJldHVybiBmYWxzZTsKCQl9CgogICAgfSwKCgkvKioKICAgICogTGlua3MgZ2FtZSBwcm9wZXJ0aWVzIHRvIHRoZSBTdGF0ZSBnaXZlbiBieSB0aGUga2V5LgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjbGluawogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gU3RhdGUga2V5LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgbGluazogZnVuY3Rpb24gKGtleSkgewoKCQkvLyBjb25zb2xlLmxvZygnbGlua2VkJyk7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5nYW1lID0gdGhpcy5nYW1lOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uYWRkID0gdGhpcy5nYW1lLmFkZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmNhbWVyYSA9IHRoaXMuZ2FtZS5jYW1lcmE7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5jYWNoZSA9IHRoaXMuZ2FtZS5jYWNoZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLmlucHV0ID0gdGhpcy5nYW1lLmlucHV0OwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ubG9hZCA9IHRoaXMuZ2FtZS5sb2FkOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0ubWF0aCA9IHRoaXMuZ2FtZS5tYXRoOwogICAgICAgIHRoaXMuc3RhdGVzW2tleV0uc291bmQgPSB0aGlzLmdhbWUuc291bmQ7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5zdGFnZSA9IHRoaXMuZ2FtZS5zdGFnZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnRpbWUgPSB0aGlzLmdhbWUudGltZTsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnR3ZWVucyA9IHRoaXMuZ2FtZS50d2VlbnM7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS53b3JsZCA9IHRoaXMuZ2FtZS53b3JsZDsKICAgICAgICB0aGlzLnN0YXRlc1trZXldLnBhcnRpY2xlcyA9IHRoaXMuZ2FtZS5wYXJ0aWNsZXM7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5waHlzaWNzID0gdGhpcy5nYW1lLnBoeXNpY3M7CiAgICAgICAgdGhpcy5zdGF0ZXNba2V5XS5ybmQgPSB0aGlzLmdhbWUucm5kOwoKICAgIH0sCgoJLyoqCiAgICAqIFNldHMgdGhlIGN1cnJlbnQgU3RhdGUuIFNob3VsZCBub3QgYmUgY2FsbGVkIGRpcmVjdGx5ICh1c2UgU3RhdGVNYW5hZ2VyLnN0YXJ0KQogICAgKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjc2V0Q3VycmVudFN0YXRlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBTdGF0ZSBrZXkuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCglzZXRDdXJyZW50U3RhdGU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzLnN0YXRlc1trZXldOwoKICAgICAgICB0aGlzLmxpbmsoa2V5KTsKCiAgICAgICAgLy8JVXNlZCB3aGVuIHRoZSBzdGF0ZSBpcyBzZXQgYXMgYmVpbmcgdGhlIGN1cnJlbnQgYWN0aXZlIHN0YXRlCiAgICAgICAgdGhpcy5vbkluaXRDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ2luaXQnXSB8fCB0aGlzLmR1bW15OwoKICAgICAgICB0aGlzLm9uUHJlbG9hZENhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsncHJlbG9hZCddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ2xvYWRSZW5kZXInXSB8fCBudWxsOwogICAgICAgIHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydsb2FkVXBkYXRlJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydjcmVhdGUnXSB8fCBudWxsOwogICAgICAgIHRoaXMub25VcGRhdGVDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3VwZGF0ZSddIHx8IG51bGw7CiAgICAgICAgdGhpcy5vblByZVJlbmRlckNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsncHJlUmVuZGVyJ10gfHwgbnVsbDsKICAgICAgICB0aGlzLm9uUmVuZGVyQ2FsbGJhY2sgPSB0aGlzLnN0YXRlc1trZXldWydyZW5kZXInXSB8fCBudWxsOwogICAgICAgIHRoaXMub25QYXVzZWRDYWxsYmFjayA9IHRoaXMuc3RhdGVzW2tleV1bJ3BhdXNlZCddIHx8IG51bGw7CgogICAgICAgIC8vCVVzZWQgd2hlbiB0aGUgc3RhdGUgaXMgbm8gbG9uZ2VyIHRoZSBjdXJyZW50IGFjdGl2ZSBzdGF0ZQogICAgICAgIHRoaXMub25TaHV0RG93bkNhbGxiYWNrID0gdGhpcy5zdGF0ZXNba2V5XVsnc2h1dGRvd24nXSB8fCB0aGlzLmR1bW15OwoKCQl0aGlzLmN1cnJlbnQgPSBrZXk7CgkJdGhpcy5fY3JlYXRlZCA9IGZhbHNlOwoKCQl0aGlzLm9uSW5pdENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIHRoaXMuZ2FtZSk7CgoJfSwKCgkvKioKCSogQG1ldGhvZCBQaGFzZXIuU3RhdGVNYW5hZ2VyI2xvYWRDb21wbGV0ZQogICAgKiBAcHJvdGVjdGVkCgkqLwogICAgbG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoKSB7CgoJCS8vIGNvbnNvbGUubG9nKCdQaGFzZXIuU3RhdGVNYW5hZ2VyLmxvYWRDb21wbGV0ZScpOwoKICAgICAgICBpZiAodGhpcy5fY3JlYXRlZCA9PSBmYWxzZSAmJiB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2spCiAgICAgICAgewoJCQkvLyBjb25zb2xlLmxvZygnQ3JlYXRlIGNhbGxiYWNrIGZvdW5kJyk7CgkgICAgICAgIHRoaXMuX2NyZWF0ZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uQ3JlYXRlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKCSAgICAgICAgdGhpcy5fY3JlYXRlZCA9IHRydWU7CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCgkqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciN1cGRhdGUKICAgICogQHByb3RlY3RlZAoJKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgIAlpZiAodGhpcy5fY3JlYXRlZCAmJiB0aGlzLm9uVXBkYXRlQ2FsbGJhY2spCiAgICAJewoJCQl0aGlzLm9uVXBkYXRlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKICAgIAl9CiAgICAJZWxzZQogICAgCXsKCQkgICAgaWYgKHRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2spCgkJICAgIHsKCQkgICAgCXRoaXMub25Mb2FkVXBkYXRlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCQkJfQoJCX0KCiAgICB9LAoKCS8qKgoJKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcHJlUmVuZGVyCiAgICAqIEBwcm90ZWN0ZWQKCSovCiAgICBwcmVSZW5kZXI6IGZ1bmN0aW9uICgpIHsKCgkgICAgaWYgKHRoaXMub25QcmVSZW5kZXJDYWxsYmFjaykKCSAgICB7CgkgICAgCXRoaXMub25QcmVSZW5kZXJDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwoJCX0KCiAgICB9LAoKCS8qKgoJKiBAbWV0aG9kIFBoYXNlci5TdGF0ZU1hbmFnZXIjcmVuZGVyCiAgICAqIEBwcm90ZWN0ZWQKCSovCiAgICByZW5kZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAJaWYgKHRoaXMuX2NyZWF0ZWQgJiYgdGhpcy5vblJlbmRlckNhbGxiYWNrKQogICAgCXsKICAgIAkJaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09PSBQaGFzZXIuQ0FOVkFTKQogICAgCQl7CgkJICAgICAgICB0aGlzLmdhbWUuY29udGV4dC5zYXZlKCk7CgkJICAgICAgICB0aGlzLmdhbWUuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICAJCX0KCgkJCXRoaXMub25SZW5kZXJDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCB0aGlzLmdhbWUpOwoKICAgIAkJaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09PSBQaGFzZXIuQ0FOVkFTKQogICAgCQl7CgkJICAgICAgICB0aGlzLmdhbWUuY29udGV4dC5yZXN0b3JlKCk7CiAgICAJCX0JCQkKICAgIAl9CiAgICAJZWxzZQogICAgCXsKCQkgICAgaWYgKHRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2spCgkJICAgIHsKCQkgICAgCXRoaXMub25Mb2FkUmVuZGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgdGhpcy5nYW1lKTsKCQkJfQoJCX0KCiAgICB9LAoKCS8qKgogICAgKiBOdWtlIHRoZSBlbnRpcmUgZ2FtZSBmcm9tIG9yYml0CiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YXRlTWFuYWdlciNkZXN0cm95CiAgICAqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmNhbGxiYWNrQ29udGV4dCA9IG51bGw7CgogICAgICAgIHRoaXMub25Jbml0Q2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25TaHV0RG93bkNhbGxiYWNrID0gbnVsbDsKCiAgICAgICAgdGhpcy5vblByZWxvYWRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vbkxvYWRSZW5kZXJDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vbkxvYWRVcGRhdGVDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vbkNyZWF0ZUNhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uVXBkYXRlQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIHRoaXMub25SZW5kZXJDYWxsYmFjayA9IG51bGw7CiAgICAgICAgdGhpcy5vblBhdXNlZENhbGxiYWNrID0gbnVsbDsKICAgICAgICB0aGlzLm9uRGVzdHJveUNhbGxiYWNrID0gbnVsbDsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICB0aGlzLnN0YXRlcyA9IHt9OwogICAgICAgIHRoaXMuX3BlbmRpbmdTdGF0ZSA9IG51bGw7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgYmFzaWMgbGlua2VkIGxpc3QgZGF0YSBzdHJ1Y3R1cmUuCioKKiBAY2xhc3MgUGhhc2VyLkxpbmtlZExpc3QKKiBAY29uc3RydWN0b3IKKi8KUGhhc2VyLkxpbmtlZExpc3QgPSBmdW5jdGlvbiAoKSB7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBuZXh0IC0gTmV4dCBlbGVtZW50IGluIHRoZSBsaXN0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubmV4dCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBwcmV2IC0gUHJldmlvdXMgZWxlbWVudCBpbiB0aGUgbGlzdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnByZXYgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gZmlyc3QgLSBGaXJzdCBlbGVtZW50IGluIHRoZSBsaXN0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuZmlyc3QgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gbGFzdCAtIExhc3QgZWxlbWVudCBpbiB0aGUgbGlzdC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmxhc3QgPSBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IGdhbWUgLSBOdW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIGxpc3QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50b3RhbCA9IDA7Cgp9OwoKUGhhc2VyLkxpbmtlZExpc3QucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBBZGRzIGEgbmV3IGVsZW1lbnQgdG8gdGhpcyBsaW5rZWQgbGlzdC4KCSogCgkqIEBtZXRob2QgUGhhc2VyLkxpbmtlZExpc3QjYWRkCgkqIEBwYXJhbSB7b2JqZWN0fSBjaGlsZCAtIFRoZSBlbGVtZW50IHRvIGFkZCB0byB0aGlzIGxpc3QuIENhbiBiZSBhIFBoYXNlci5TcHJpdGUgb3IgYW55IG90aGVyIG9iamVjdCB5b3UgbmVlZCB0byBxdWlja2x5IGl0ZXJhdGUgdGhyb3VnaC4KCSogQHJldHVybiB7b2JqZWN0fSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoY2hpbGQpIHsKCiAgICAJLy8JSWYgdGhlIGxpc3QgaXMgZW1wdHkKICAgIAlpZiAodGhpcy50b3RhbCA9PSAwICYmIHRoaXMuZmlyc3QgPT0gbnVsbCAmJiB0aGlzLmxhc3QgPT0gbnVsbCkKICAgIAl7CiAgICAJCXRoaXMuZmlyc3QgPSBjaGlsZDsKICAgIAkJdGhpcy5sYXN0ID0gY2hpbGQ7CgkgICAgCXRoaXMubmV4dCA9IGNoaWxkOwoJICAgIAljaGlsZC5wcmV2ID0gdGhpczsKCSAgICAJdGhpcy50b3RhbCsrOwogICAgCQlyZXR1cm4gY2hpbGQ7CiAgICAJfQoKICAgIAkvLwlHZXQgZ2V0cyBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoZSBsaXN0LCByZWdhcmRsZXNzIG9mIGFueXRoaW5nLCBhbmQgaXQgd29uJ3QgaGF2ZSBhbnkgY2hpbGRyZW4gb2YgaXRzIG93biAobm9uLW5lc3RlZCBsaXN0KQogICAgCXRoaXMubGFzdC5uZXh0ID0gY2hpbGQ7CgogICAgCWNoaWxkLnByZXYgPSB0aGlzLmxhc3Q7CgogICAgCXRoaXMubGFzdCA9IGNoaWxkOwoKCQl0aGlzLnRvdGFsKys7CgoJCXJldHVybiBjaGlsZDsKCiAgICB9LAoKCS8qKgogICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBlbGVtZW50IGZyb20gdGhpcyBsaW5rZWQgbGlzdCBpZiBpdCBleGlzdHMuCiAJKiAKIAkqIEBtZXRob2QgUGhhc2VyLkxpbmtlZExpc3QjcmVtb3ZlCiAJKiBAcGFyYW0ge29iamVjdH0gY2hpbGQgLSBUaGUgY2hpbGQgdG8gYmUgcmVtb3ZlZCBmcm9tIHRoZSBsaXN0LgogICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKGNoaWxkKSB7CgogICAgCWlmIChjaGlsZCA9PSB0aGlzLmZpcnN0KQogICAgCXsKCQkJLy8gSXQgd2FzICdmaXJzdCcsIG1ha2UgJ2ZpcnN0JyBwb2ludCB0byBmaXJzdC5uZXh0CiAgICAJCXRoaXMuZmlyc3QgPSB0aGlzLmZpcnN0Lm5leHQ7CiAgICAJfSAgICAgIAoJCWVsc2UgaWYgKGNoaWxkID09IHRoaXMubGFzdCkKCQl7CgkJCS8vIEl0IHdhcyAnbGFzdCcsIG1ha2UgJ2xhc3QnIHBvaW50IHRvIGxhc3QucHJldgoJCQl0aGlzLmxhc3QgPSB0aGlzLmxhc3QucHJldjsKCQl9IAoKCQlpZiAoY2hpbGQucHJldikKCQl7CgkJCS8vIG1ha2UgY2hpbGQucHJldi5uZXh0IHBvaW50IHRvIGNoaWxkcy5uZXh0IGluc3RlYWQgb2YgY2hpbGQKCQkJY2hpbGQucHJldi5uZXh0ID0gY2hpbGQubmV4dDsgCgkJfSAKCgkJaWYgKGNoaWxkLm5leHQpCgkJewoJCQkvLyBtYWtlIGNoaWxkLm5leHQucHJldiBwb2ludCB0byBjaGlsZC5wcmV2IGluc3RlYWQgb2YgY2hpbGQKCQkJY2hpbGQubmV4dC5wcmV2ID0gY2hpbGQucHJldjsKCQl9CgoJCWNoaWxkLm5leHQgPSBjaGlsZC5wcmV2ID0gbnVsbDsKCgkJaWYgKHRoaXMuZmlyc3QgPT0gbnVsbCApCgkJewoJCQl0aGlzLmxhc3QgPSBudWxsOwoJCX0KCgkJdGhpcy50b3RhbC0tOwoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxzIGEgZnVuY3Rpb24gb24gYWxsIG1lbWJlcnMgb2YgdGhpcyBsaXN0LCB1c2luZyB0aGUgbWVtYmVyIGFzIHRoZSBjb250ZXh0IGZvciB0aGUgY2FsbGJhY2suCiAgICAqIFRoZSBmdW5jdGlvbiBtdXN0IGV4aXN0IG9uIHRoZSBtZW1iZXIuCiAgCSogCiAgCSogQG1ldGhvZCBQaGFzZXIuTGlua2VkTGlzdCNjYWxsQWxsCiAgCSogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdG8gY2FsbC4KICAgICovCiAgICBjYWxsQWxsOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKCiAgICAJaWYgKCF0aGlzLmZpcnN0IHx8ICF0aGlzLmxhc3QpCiAgICAJewogICAgCQlyZXR1cm47CiAgICAJfQoKCQl2YXIgZW50aXR5ID0gdGhpcy5maXJzdDsKCQkKCQlkbwkKCQl7CgkJCWlmIChlbnRpdHkgJiYgZW50aXR5W2NhbGxiYWNrXSkKCQkJewoJCQkJZW50aXR5W2NhbGxiYWNrXS5jYWxsKGVudGl0eSk7CgkJCX0KCgkJCWVudGl0eSA9IGVudGl0eS5uZXh0OwoKCQl9CgkJd2hpbGUoZW50aXR5ICE9IHRoaXMubGFzdC5uZXh0KQkJCQoKICAgIH0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEBjbGFzcyBQaGFzZXIuU2lnbmFsCiogQGNsYXNzZGVzYyBBIFNpZ25hbCBpcyB1c2VkIGZvciBvYmplY3QgY29tbXVuaWNhdGlvbiB2aWEgYSBjdXN0b20gYnJvYWRjYXN0ZXIgaW5zdGVhZCBvZiBFdmVudHMuCiogQGF1dGhvciBNaWxsZXIgTWVkZWlyb3MgaHR0cDovL21pbGxlcm1lZGVpcm9zLmdpdGh1Yi5jb20vanMtc2lnbmFscy8KKiBAY29uc3RydWN0b3IKKi8KUGhhc2VyLlNpZ25hbCA9IGZ1bmN0aW9uICgpIHsKCgkvKioKCSogQHByb3BlcnR5IHtBcnJheS48UGhhc2VyLlNpZ25hbEJpbmRpbmc+fSBfYmluZGluZ3MgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9iaW5kaW5ncyA9IFtdOwoJCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX3ByZXZQYXJhbXMgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9wcmV2UGFyYW1zID0gbnVsbDsKCgkvLyBlbmZvcmNlIGRpc3BhdGNoIHRvIGF3YXlzIHdvcmsgb24gc2FtZSBjb250ZXh0ICgjNDcpCgl2YXIgc2VsZiA9IHRoaXM7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGRpc3BhdGNoIC0gRGVzY3JpcHRpb24uCgkqLwoJdGhpcy5kaXNwYXRjaCA9IGZ1bmN0aW9uKCl7CgkJUGhhc2VyLlNpZ25hbC5wcm90b3R5cGUuZGlzcGF0Y2guYXBwbHkoc2VsZiwgYXJndW1lbnRzKTsKCX07Cgp9OwoKUGhhc2VyLlNpZ25hbC5wcm90b3R5cGUgPSB7CgoJLyoqCiAgICAqIElmIFNpZ25hbCBzaG91bGQga2VlcCByZWNvcmQgb2YgcHJldmlvdXNseSBkaXNwYXRjaGVkIHBhcmFtZXRlcnMgYW5kCgkqIGF1dG9tYXRpY2FsbHkgZXhlY3V0ZSBsaXN0ZW5lciBkdXJpbmcgYGFkZCgpYC9gYWRkT25jZSgpYCBpZiBTaWduYWwgd2FzCgkqIGFscmVhZHkgZGlzcGF0Y2hlZCBiZWZvcmUuCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbWVtb3JpemUKCSovCgltZW1vcml6ZTogZmFsc2UsCgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3Nob3VsZFByb3BhZ2F0ZSAKCSogQHByaXZhdGUKCSovCglfc2hvdWxkUHJvcGFnYXRlOiB0cnVlLAoKCS8qKgoJKiBJZiBTaWduYWwgaXMgYWN0aXZlIGFuZCBzaG91bGQgYnJvYWRjYXN0IGV2ZW50cy4KCSogPHA+PHN0cm9uZz5JTVBPUlRBTlQ6PC9zdHJvbmc+IFNldHRpbmcgdGhpcyBwcm9wZXJ0eSBkdXJpbmcgYSBkaXNwYXRjaCB3aWxsIG9ubHkgYWZmZWN0IHRoZSBuZXh0IGRpc3BhdGNoLCBpZiB5b3Ugd2FudCB0byBzdG9wIHRoZSBwcm9wYWdhdGlvbiBvZiBhIHNpZ25hbCB1c2UgYGhhbHQoKWAgaW5zdGVhZC48L3A+CgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWN0aXZlCiAgICAqIEBkZWZhdWx0CiAgICAqLwoJYWN0aXZlOiB0cnVlLAoKCS8qKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjdmFsaWRhdGVMaXN0ZW5lcgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBmbk5hbWUgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKICAgICovCgl2YWxpZGF0ZUxpc3RlbmVyOiBmdW5jdGlvbiAobGlzdGVuZXIsIGZuTmFtZSkgewoJCWlmICh0eXBlb2YgbGlzdGVuZXIgIT09ICdmdW5jdGlvbicpIHsKCQkJdGhyb3cgbmV3IEVycm9yKCAnbGlzdGVuZXIgaXMgYSByZXF1aXJlZCBwYXJhbSBvZiB7Zm59KCkgYW5kIHNob3VsZCBiZSBhIEZ1bmN0aW9uLicucmVwbGFjZSgne2ZufScsIGZuTmFtZSkgKTsKCQl9Cgl9LAoKCS8qKgoJICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI19yZWdpc3Rlckxpc3RlbmVyCgkgKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIFNpZ25hbCBoYW5kbGVyIGZ1bmN0aW9uLgoJICogQHBhcmFtIHtib29sZWFufSBpc09uY2UgLSBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSAtIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eV0gLSBUaGUgcHJpb3JpdHkgbGV2ZWwgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBMaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBleGVjdXRlZCBiZWZvcmUgbGlzdGVuZXJzIHdpdGggbG93ZXIgcHJpb3JpdHkuIExpc3RlbmVycyB3aXRoIHNhbWUgcHJpb3JpdHkgbGV2ZWwgd2lsbCBiZSBleGVjdXRlZCBhdCB0aGUgc2FtZSBvcmRlciBhcyB0aGV5IHdlcmUgYWRkZWQuIChkZWZhdWx0ID0gMCkuCgkgKiBAcmV0dXJuIHtQaGFzZXIuU2lnbmFsQmluZGluZ30gQW4gT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYmluZGluZyBiZXR3ZWVuIHRoZSBTaWduYWwgYW5kIGxpc3RlbmVyLgoJICogQHByaXZhdGUKCSAqLwoJX3JlZ2lzdGVyTGlzdGVuZXI6IGZ1bmN0aW9uIChsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgoJCXZhciBwcmV2SW5kZXggPSB0aGlzLl9pbmRleE9mTGlzdGVuZXIobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCksCgkJCWJpbmRpbmc7CgoJCWlmIChwcmV2SW5kZXggIT09IC0xKSB7CgkJCWJpbmRpbmcgPSB0aGlzLl9iaW5kaW5nc1twcmV2SW5kZXhdOwoJCQlpZiAoYmluZGluZy5pc09uY2UoKSAhPT0gaXNPbmNlKSB7CgkJCQl0aHJvdyBuZXcgRXJyb3IoJ1lvdSBjYW5ub3QgYWRkJysgKGlzT25jZT8gJycgOiAnT25jZScpICsnKCkgdGhlbiBhZGQnKyAoIWlzT25jZT8gJycgOiAnT25jZScpICsnKCkgdGhlIHNhbWUgbGlzdGVuZXIgd2l0aG91dCByZW1vdmluZyB0aGUgcmVsYXRpb25zaGlwIGZpcnN0LicpOwoJCQl9CgkJfSBlbHNlIHsKCQkJYmluZGluZyA9IG5ldyBQaGFzZXIuU2lnbmFsQmluZGluZyh0aGlzLCBsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KTsKCQkJdGhpcy5fYWRkQmluZGluZyhiaW5kaW5nKTsKCQl9CgoJCWlmICh0aGlzLm1lbW9yaXplICYmIHRoaXMuX3ByZXZQYXJhbXMpewoJCQliaW5kaW5nLmV4ZWN1dGUodGhpcy5fcHJldlBhcmFtcyk7CgkJfQoKCQlyZXR1cm4gYmluZGluZzsKCX0sCgoJLyoqCgkgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjX2FkZEJpbmRpbmcgCgkgKiBAcGFyYW0ge1BoYXNlci5TaWduYWxCaW5kaW5nfSBiaW5kaW5nIC0gQW4gT2JqZWN0IHJlcHJlc2VudGluZyB0aGUgYmluZGluZyBiZXR3ZWVuIHRoZSBTaWduYWwgYW5kIGxpc3RlbmVyLgoJICogQHByaXZhdGUKCSAqLwoJX2FkZEJpbmRpbmc6IGZ1bmN0aW9uIChiaW5kaW5nKSB7CgkJLy9zaW1wbGlmaWVkIGluc2VydGlvbiBzb3J0CgkJdmFyIG4gPSB0aGlzLl9iaW5kaW5ncy5sZW5ndGg7CgkJZG8geyAtLW47IH0gd2hpbGUgKHRoaXMuX2JpbmRpbmdzW25dICYmIGJpbmRpbmcuX3ByaW9yaXR5IDw9IHRoaXMuX2JpbmRpbmdzW25dLl9wcmlvcml0eSk7CgkJdGhpcy5fYmluZGluZ3Muc3BsaWNlKG4gKyAxLCAwLCBiaW5kaW5nKTsKCX0sCgoJLyoqCgkgKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjX2luZGV4T2ZMaXN0ZW5lcgoJICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KCSAqIEByZXR1cm4ge251bWJlcn0gRGVzY3JpcHRpb24uCgkgKiBAcHJpdmF0ZQoJICovCglfaW5kZXhPZkxpc3RlbmVyOiBmdW5jdGlvbiAobGlzdGVuZXIsIGNvbnRleHQpIHsKCQl2YXIgbiA9IHRoaXMuX2JpbmRpbmdzLmxlbmd0aCwKCQkJY3VyOwoJCXdoaWxlIChuLS0pIHsKCQkJY3VyID0gdGhpcy5fYmluZGluZ3Nbbl07CgkJCWlmIChjdXIuX2xpc3RlbmVyID09PSBsaXN0ZW5lciAmJiBjdXIuY29udGV4dCA9PT0gY29udGV4dCkgewoJCQkJcmV0dXJuIG47CgkJCX0KCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgkvKioKCSAqIENoZWNrIGlmIGxpc3RlbmVyIHdhcyBhdHRhY2hlZCB0byBTaWduYWwuCgkgKiAKCSAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNoYXMKCSAqIEBwYXJhbSB7RnVuY3Rpb259IGxpc3RlbmVyIC0gU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCgkgKiBAcGFyYW0ge09iamVjdH0gW2NvbnRleHRdIC0gQ29udGV4dCBvbiB3aGljaCBsaXN0ZW5lciB3aWxsIGJlIGV4ZWN1dGVkIChvYmplY3QgdGhhdCBzaG91bGQgcmVwcmVzZW50IHRoZSBgdGhpc2AgdmFyaWFibGUgaW5zaWRlIGxpc3RlbmVyIGZ1bmN0aW9uKS4KCSAqIEByZXR1cm4ge2Jvb2xlYW59IElmIFNpZ25hbCBoYXMgdGhlIHNwZWNpZmllZCBsaXN0ZW5lci4KCSAqLwoJaGFzOiBmdW5jdGlvbiAobGlzdGVuZXIsIGNvbnRleHQpIHsKCQlyZXR1cm4gdGhpcy5faW5kZXhPZkxpc3RlbmVyKGxpc3RlbmVyLCBjb250ZXh0KSAhPT0gLTE7Cgl9LAoKCS8qKgoJICogQWRkIGEgbGlzdGVuZXIgdG8gdGhlIHNpZ25hbC4KCSAqIAoJICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2FkZAoJICogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgLSBTaWduYWwgaGFuZGxlciBmdW5jdGlvbi4KCSAqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgoJICogQHBhcmFtIHtudW1iZXJ9IFtwcmlvcml0eV0gVGhlIHByaW9yaXR5IGxldmVsIG9mIHRoZSBldmVudCBsaXN0ZW5lci4gTGlzdGVuZXJzIHdpdGggaGlnaGVyIHByaW9yaXR5IHdpbGwgYmUgZXhlY3V0ZWQgYmVmb3JlIGxpc3RlbmVycyB3aXRoIGxvd2VyIHByaW9yaXR5LiBMaXN0ZW5lcnMgd2l0aCBzYW1lIHByaW9yaXR5IGxldmVsIHdpbGwgYmUgZXhlY3V0ZWQgYXQgdGhlIHNhbWUgb3JkZXIgYXMgdGhleSB3ZXJlIGFkZGVkLiAoZGVmYXVsdCA9IDApLgoJICogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KCSAqLwoJYWRkOiBmdW5jdGlvbiAobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpIHsKCQl0aGlzLnZhbGlkYXRlTGlzdGVuZXIobGlzdGVuZXIsICdhZGQnKTsKCQlyZXR1cm4gdGhpcy5fcmVnaXN0ZXJMaXN0ZW5lcihsaXN0ZW5lciwgZmFsc2UsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpOwoJfSwKCgkvKioKCSogQWRkIGxpc3RlbmVyIHRvIHRoZSBzaWduYWwgdGhhdCBzaG91bGQgYmUgcmVtb3ZlZCBhZnRlciBmaXJzdCBleGVjdXRpb24gKHdpbGwgYmUgZXhlY3V0ZWQgb25seSBvbmNlKS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2FkZE9uY2UKCSogQHBhcmFtIHtmdW5jdGlvbn0gbGlzdGVuZXIgU2lnbmFsIGhhbmRsZXIgZnVuY3Rpb24uCgkqIEBwYXJhbSB7b2JqZWN0fSBbbGlzdGVuZXJDb250ZXh0XSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgoJKiBAcGFyYW0ge251bWJlcn0gW3ByaW9yaXR5XSBUaGUgcHJpb3JpdHkgbGV2ZWwgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBMaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBleGVjdXRlZCBiZWZvcmUgbGlzdGVuZXJzIHdpdGggbG93ZXIgcHJpb3JpdHkuIExpc3RlbmVycyB3aXRoIHNhbWUgcHJpb3JpdHkgbGV2ZWwgd2lsbCBiZSBleGVjdXRlZCBhdCB0aGUgc2FtZSBvcmRlciBhcyB0aGV5IHdlcmUgYWRkZWQuIChkZWZhdWx0ID0gMCkKCSogQHJldHVybiB7UGhhc2VyLlNpZ25hbEJpbmRpbmd9IEFuIE9iamVjdCByZXByZXNlbnRpbmcgdGhlIGJpbmRpbmcgYmV0d2VlbiB0aGUgU2lnbmFsIGFuZCBsaXN0ZW5lci4KCSovCglhZGRPbmNlOiBmdW5jdGlvbiAobGlzdGVuZXIsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpIHsKCQl0aGlzLnZhbGlkYXRlTGlzdGVuZXIobGlzdGVuZXIsICdhZGRPbmNlJyk7CgkJcmV0dXJuIHRoaXMuX3JlZ2lzdGVyTGlzdGVuZXIobGlzdGVuZXIsIHRydWUsIGxpc3RlbmVyQ29udGV4dCwgcHJpb3JpdHkpOwoJfSwKCgkvKioKCSogUmVtb3ZlIGEgc2luZ2xlIGxpc3RlbmVyIGZyb20gdGhlIGRpc3BhdGNoIHF1ZXVlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjcmVtb3ZlCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGxpc3RlbmVyIEhhbmRsZXIgZnVuY3Rpb24gdGhhdCBzaG91bGQgYmUgcmVtb3ZlZC4KCSogQHBhcmFtIHtvYmplY3R9IFtjb250ZXh0XSBFeGVjdXRpb24gY29udGV4dCAoc2luY2UgeW91IGNhbiBhZGQgdGhlIHNhbWUgaGFuZGxlciBtdWx0aXBsZSB0aW1lcyBpZiBleGVjdXRpbmcgaW4gYSBkaWZmZXJlbnQgY29udGV4dCkuCgkqIEByZXR1cm4ge2Z1bmN0aW9ufSBMaXN0ZW5lciBoYW5kbGVyIGZ1bmN0aW9uLgoJKi8KCXJlbW92ZTogZnVuY3Rpb24gKGxpc3RlbmVyLCBjb250ZXh0KSB7CgoJCXRoaXMudmFsaWRhdGVMaXN0ZW5lcihsaXN0ZW5lciwgJ3JlbW92ZScpOwoKCQl2YXIgaSA9IHRoaXMuX2luZGV4T2ZMaXN0ZW5lcihsaXN0ZW5lciwgY29udGV4dCk7CgoJCWlmIChpICE9PSAtMSkKCQl7CgkJCXRoaXMuX2JpbmRpbmdzW2ldLl9kZXN0cm95KCk7IC8vbm8gcmVhc29uIHRvIGEgUGhhc2VyLlNpZ25hbEJpbmRpbmcgZXhpc3QgaWYgaXQgaXNuJ3QgYXR0YWNoZWQgdG8gYSBzaWduYWwKCQkJdGhpcy5fYmluZGluZ3Muc3BsaWNlKGksIDEpOwoJCX0KCgkJcmV0dXJuIGxpc3RlbmVyOwoKCX0sCgoJLyoqCgkqIFJlbW92ZSBhbGwgbGlzdGVuZXJzIGZyb20gdGhlIFNpZ25hbC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI3JlbW92ZUFsbAoJKi8KCXJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoJCXZhciBuID0gdGhpcy5fYmluZGluZ3MubGVuZ3RoOwoJCXdoaWxlIChuLS0pIHsKCQkJdGhpcy5fYmluZGluZ3Nbbl0uX2Rlc3Ryb3koKTsKCQl9CgkJdGhpcy5fYmluZGluZ3MubGVuZ3RoID0gMDsKCX0sCgoJLyoqCgkqIEdldHMgdGhlIHRvdGFsIG51bWJlciBvZiBsaXN0ZW5lcmVzIGF0dGFjaGVkIHRvIHRocyBTaWduYWwuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlNpZ25hbCNnZXROdW1MaXN0ZW5lcnMKCSogQHJldHVybiB7bnVtYmVyfSBOdW1iZXIgb2YgbGlzdGVuZXJzIGF0dGFjaGVkIHRvIHRoZSBTaWduYWwuCgkqLwoJZ2V0TnVtTGlzdGVuZXJzOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuIHRoaXMuX2JpbmRpbmdzLmxlbmd0aDsKCX0sCgoJLyoqCgkqIFN0b3AgcHJvcGFnYXRpb24gb2YgdGhlIGV2ZW50LCBibG9ja2luZyB0aGUgZGlzcGF0Y2ggdG8gbmV4dCBsaXN0ZW5lcnMgb24gdGhlIHF1ZXVlLgoJKiA8cD48c3Ryb25nPklNUE9SVEFOVDo8L3N0cm9uZz4gc2hvdWxkIGJlIGNhbGxlZCBvbmx5IGR1cmluZyBzaWduYWwgZGlzcGF0Y2gsIGNhbGxpbmcgaXQgYmVmb3JlL2FmdGVyIGRpc3BhdGNoIHdvbid0IGFmZmVjdCBzaWduYWwgYnJvYWRjYXN0LjwvcD4KCSogQHNlZSBTaWduYWwucHJvdG90eXBlLmRpc2FibGUKCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2hhbHQKCSovCgloYWx0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fc2hvdWxkUHJvcGFnYXRlID0gZmFsc2U7Cgl9LAoKCS8qKgoJKiBEaXNwYXRjaC9Ccm9hZGNhc3QgU2lnbmFsIHRvIGFsbCBsaXN0ZW5lcnMgYWRkZWQgdG8gdGhlIHF1ZXVlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZGlzcGF0Y2gKCSogQHBhcmFtIHthbnl9IFtwYXJhbXNdIC0gUGFyYW1ldGVycyB0aGF0IHNob3VsZCBiZSBwYXNzZWQgdG8gZWFjaCBoYW5kbGVyLgoJKi8KCWRpc3BhdGNoOiBmdW5jdGlvbiAocGFyYW1zKSB7CgkJaWYgKCEgdGhpcy5hY3RpdmUpIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHBhcmFtc0FyciA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cyksCgkJCW4gPSB0aGlzLl9iaW5kaW5ncy5sZW5ndGgsCgkJCWJpbmRpbmdzOwoKCQlpZiAodGhpcy5tZW1vcml6ZSkgewoJCQl0aGlzLl9wcmV2UGFyYW1zID0gcGFyYW1zQXJyOwoJCX0KCgkJaWYgKCEgbikgewoJCQkvL3Nob3VsZCBjb21lIGFmdGVyIG1lbW9yaXplCgkJCXJldHVybjsKCQl9CgoJCWJpbmRpbmdzID0gdGhpcy5fYmluZGluZ3Muc2xpY2UoKTsgLy9jbG9uZSBhcnJheSBpbiBjYXNlIGFkZC9yZW1vdmUgaXRlbXMgZHVyaW5nIGRpc3BhdGNoCgkJdGhpcy5fc2hvdWxkUHJvcGFnYXRlID0gdHJ1ZTsgLy9pbiBjYXNlIGBoYWx0YCB3YXMgY2FsbGVkIGJlZm9yZSBkaXNwYXRjaCBvciBkdXJpbmcgdGhlIHByZXZpb3VzIGRpc3BhdGNoLgoKCQkvL2V4ZWN1dGUgYWxsIGNhbGxiYWNrcyB1bnRpbCBlbmQgb2YgdGhlIGxpc3Qgb3IgdW50aWwgYSBjYWxsYmFjayByZXR1cm5zIGBmYWxzZWAgb3Igc3RvcHMgcHJvcGFnYXRpb24KCQkvL3JldmVyc2UgbG9vcCBzaW5jZSBsaXN0ZW5lcnMgd2l0aCBoaWdoZXIgcHJpb3JpdHkgd2lsbCBiZSBhZGRlZCBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0CgkJZG8geyBuLS07IH0gd2hpbGUgKGJpbmRpbmdzW25dICYmIHRoaXMuX3Nob3VsZFByb3BhZ2F0ZSAmJiBiaW5kaW5nc1tuXS5leGVjdXRlKHBhcmFtc0FycikgIT09IGZhbHNlKTsKCX0sCgoJLyoqCgkqIEZvcmdldCBtZW1vcml6ZWQgYXJndW1lbnRzLgoJKiBAc2VlIFNpZ25hbC5tZW1vcml6ZQoJKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjZm9yZ2V0CiAJKi8KCWZvcmdldDogZnVuY3Rpb24oKXsKCQl0aGlzLl9wcmV2UGFyYW1zID0gbnVsbDsKCX0sCgoJLyoqCgkqIFJlbW92ZSBhbGwgYmluZGluZ3MgZnJvbSBzaWduYWwgYW5kIGRlc3Ryb3kgYW55IHJlZmVyZW5jZSB0byBleHRlcm5hbCBvYmplY3RzIChkZXN0cm95IFNpZ25hbCBvYmplY3QpLgoJKiA8cD48c3Ryb25nPklNUE9SVEFOVDo8L3N0cm9uZz4gY2FsbGluZyBhbnkgbWV0aG9kIG9uIHRoZSBzaWduYWwgaW5zdGFuY2UgYWZ0ZXIgY2FsbGluZyBkaXNwb3NlIHdpbGwgdGhyb3cgZXJyb3JzLjwvcD4KCSoKCSogQG1ldGhvZCBQaGFzZXIuU2lnbmFsI2Rpc3Bvc2UKCSovCglkaXNwb3NlOiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5yZW1vdmVBbGwoKTsKCQlkZWxldGUgdGhpcy5fYmluZGluZ3M7CgkJZGVsZXRlIHRoaXMuX3ByZXZQYXJhbXM7Cgl9LAoKCS8qKgoJKgoJKiBAbWV0aG9kIFBoYXNlci5TaWduYWwjdG9TdHJpbmcKCSogQHJldHVybiB7c3RyaW5nfSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG9iamVjdC4KCSovCgl0b1N0cmluZzogZnVuY3Rpb24gKCkgewoJCXJldHVybiAnW1BoYXNlci5TaWduYWwgYWN0aXZlOicrIHRoaXMuYWN0aXZlICsnIG51bUxpc3RlbmVyczonKyB0aGlzLmdldE51bUxpc3RlbmVycygpICsnXSc7Cgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLlNpZ25hbEJpbmRpbmcKKgoqIE9iamVjdCB0aGF0IHJlcHJlc2VudHMgYSBiaW5kaW5nIGJldHdlZW4gYSBTaWduYWwgYW5kIGEgbGlzdGVuZXIgZnVuY3Rpb24uCiogPGJyIC8+LSA8c3Ryb25nPlRoaXMgaXMgYW4gaW50ZXJuYWwgY29uc3RydWN0b3IgYW5kIHNob3VsZG4ndCBiZSBjYWxsZWQgYnkgcmVndWxhciB1c2Vycy48L3N0cm9uZz4KKiA8YnIgLz4tIGluc3BpcmVkIGJ5IEpvYSBFYmVydCBBUzMgU2lnbmFsQmluZGluZyBhbmQgUm9iZXJ0IFBlbm5lcidzIFNsb3QgY2xhc3Nlcy4KKgoqIEBjbGFzcyBQaGFzZXIuU2lnbmFsQmluZGluZwoqIEBuYW1lIFNpZ25hbEJpbmRpbmcKKiBAYXV0aG9yIE1pbGxlciBNZWRlaXJvcyBodHRwOi8vbWlsbGVybWVkZWlyb3MuZ2l0aHViLmNvbS9qcy1zaWduYWxzLwoqIEBjb25zdHJ1Y3RvcgoqIEBpbm5lcgoqIEBwYXJhbSB7U2lnbmFsfSBzaWduYWwgLSBSZWZlcmVuY2UgdG8gU2lnbmFsIG9iamVjdCB0aGF0IGxpc3RlbmVyIGlzIGN1cnJlbnRseSBib3VuZCB0by4KKiBAcGFyYW0ge2Z1bmN0aW9ufSBsaXN0ZW5lciAtIEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbC4KKiBAcGFyYW0ge2Jvb2xlYW59IGlzT25jZSAtIElmIGJpbmRpbmcgc2hvdWxkIGJlIGV4ZWN1dGVkIGp1c3Qgb25jZS4KKiBAcGFyYW0ge29iamVjdH0gW2xpc3RlbmVyQ29udGV4dF0gLSBDb250ZXh0IG9uIHdoaWNoIGxpc3RlbmVyIHdpbGwgYmUgZXhlY3V0ZWQgKG9iamVjdCB0aGF0IHNob3VsZCByZXByZXNlbnQgdGhlIGB0aGlzYCB2YXJpYWJsZSBpbnNpZGUgbGlzdGVuZXIgZnVuY3Rpb24pLgoqIEBwYXJhbSB7bnVtYmVyfSBbcHJpb3JpdHldIC0gVGhlIHByaW9yaXR5IGxldmVsIG9mIHRoZSBldmVudCBsaXN0ZW5lci4gKGRlZmF1bHQgPSAwKS4KKi8KUGhhc2VyLlNpZ25hbEJpbmRpbmcgPSBmdW5jdGlvbiAoc2lnbmFsLCBsaXN0ZW5lciwgaXNPbmNlLCBsaXN0ZW5lckNvbnRleHQsIHByaW9yaXR5KSB7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IF9saXN0ZW5lciAtIEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbC4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9saXN0ZW5lciA9IGxpc3RlbmVyOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IF9pc09uY2UgLSBJZiBiaW5kaW5nIHNob3VsZCBiZSBleGVjdXRlZCBqdXN0IG9uY2UuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5faXNPbmNlID0gaXNPbmNlOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdHx1bmRlZmluZWR8bnVsbH0gY29udGV4dCAtIENvbnRleHQgb24gd2hpY2ggbGlzdGVuZXIgd2lsbCBiZSBleGVjdXRlZCAob2JqZWN0IHRoYXQgc2hvdWxkIHJlcHJlc2VudCB0aGUgYHRoaXNgIHZhcmlhYmxlIGluc2lkZSBsaXN0ZW5lciBmdW5jdGlvbikuCgkqIEBtZW1iZXJvZiBTaWduYWxCaW5kaW5nLnByb3RvdHlwZQoJKi8KICAgIHRoaXMuY29udGV4dCA9IGxpc3RlbmVyQ29udGV4dDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtTaWduYWx9IF9zaWduYWwgLSBSZWZlcmVuY2UgdG8gU2lnbmFsIG9iamVjdCB0aGF0IGxpc3RlbmVyIGlzIGN1cnJlbnRseSBib3VuZCB0by4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9zaWduYWwgPSBzaWduYWw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcHJpb3JpdHkgLSBMaXN0ZW5lciBwcmlvcml0eS4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9wcmlvcml0eSA9IHByaW9yaXR5IHx8IDA7Cgp9OwoKUGhhc2VyLlNpZ25hbEJpbmRpbmcucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJZiBiaW5kaW5nIGlzIGFjdGl2ZSBhbmQgc2hvdWxkIGJlIGV4ZWN1dGVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZQogICAgKiBAZGVmYXVsdAogICAgKi8gCiAgICBhY3RpdmU6IHRydWUsCgogICAgLyoqCiAgICAqIERlZmF1bHQgcGFyYW1ldGVycyBwYXNzZWQgdG8gbGlzdGVuZXIgZHVyaW5nIGBTaWduYWwuZGlzcGF0Y2hgIGFuZCBgU2lnbmFsQmluZGluZy5leGVjdXRlYCAoY3VycmllZCBwYXJhbWV0ZXJzKS4KICAgICogQHByb3BlcnR5IHthcnJheXxudWxsfSBwYXJhbXMgCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHBhcmFtczogbnVsbCwKCiAgICAvKioKICAgICogQ2FsbCBsaXN0ZW5lciBwYXNzaW5nIGFyYml0cmFyeSBwYXJhbWV0ZXJzLgogICAgKiA8cD5JZiBiaW5kaW5nIHdhcyBhZGRlZCB1c2luZyBgU2lnbmFsLmFkZE9uY2UoKWAgaXQgd2lsbCBiZSBhdXRvbWF0aWNhbGx5IHJlbW92ZWQgZnJvbSBzaWduYWwgZGlzcGF0Y2ggcXVldWUsIHRoaXMgbWV0aG9kIGlzIHVzZWQgaW50ZXJuYWxseSBmb3IgdGhlIHNpZ25hbCBkaXNwYXRjaC48L3A+CiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjZXhlY3V0ZQogICAgKiBAcGFyYW0ge2FycmF5fSBbcGFyYW1zQXJyXSAtIEFycmF5IG9mIHBhcmFtZXRlcnMgdGhhdCBzaG91bGQgYmUgcGFzc2VkIHRvIHRoZSBsaXN0ZW5lci4KICAgICogQHJldHVybiB7RGVzY3JpcHRpb259IFZhbHVlIHJldHVybmVkIGJ5IHRoZSBsaXN0ZW5lci4KICAgICovCiAgICBleGVjdXRlOiBmdW5jdGlvbiAocGFyYW1zQXJyKSB7CgogICAgICAgIHZhciBoYW5kbGVyUmV0dXJuLCBwYXJhbXM7CgogICAgICAgIGlmICh0aGlzLmFjdGl2ZSAmJiAhIXRoaXMuX2xpc3RlbmVyKQogICAgICAgIHsKICAgICAgICAgICAgcGFyYW1zID0gdGhpcy5wYXJhbXM/IHRoaXMucGFyYW1zLmNvbmNhdChwYXJhbXNBcnIpIDogcGFyYW1zQXJyOwogICAgICAgICAgICBoYW5kbGVyUmV0dXJuID0gdGhpcy5fbGlzdGVuZXIuYXBwbHkodGhpcy5jb250ZXh0LCBwYXJhbXMpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX2lzT25jZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5kZXRhY2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGhhbmRsZXJSZXR1cm47CgogICAgfSwKCiAgICAvKioKICAgICogRGV0YWNoIGJpbmRpbmcgZnJvbSBzaWduYWwuCiAgICAqIDxwPmFsaWFzIHRvOiBAc2VlIG15U2lnbmFsLnJlbW92ZShteUJpbmRpbmcuZ2V0TGlzdGVuZXIoKSk7CiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjZGV0YWNoCiAgICAqIEByZXR1cm4ge2Z1bmN0aW9ufG51bGx9IEhhbmRsZXIgZnVuY3Rpb24gYm91bmQgdG8gdGhlIHNpZ25hbCBvciBgbnVsbGAgaWYgYmluZGluZyB3YXMgcHJldmlvdXNseSBkZXRhY2hlZC4KICAgICovCiAgICBkZXRhY2g6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5pc0JvdW5kKCkgPyB0aGlzLl9zaWduYWwucmVtb3ZlKHRoaXMuX2xpc3RlbmVyLCB0aGlzLmNvbnRleHQpIDogbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjaXNCb3VuZAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGJpbmRpbmcgaXMgc3RpbGwgYm91bmQgdG8gdGhlIHNpZ25hbCBhbmQgaGFzIGEgbGlzdGVuZXIuCiAgICAqLwogICAgaXNCb3VuZDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAoISF0aGlzLl9zaWduYWwgJiYgISF0aGlzLl9saXN0ZW5lcik7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2lzT25jZQogICAgKiBAcmV0dXJuIHtib29sZWFufSBJZiBTaWduYWxCaW5kaW5nIHdpbGwgb25seSBiZSBleGVjdXRlZCBvbmNlLgogICAgKi8KICAgIGlzT25jZTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9pc09uY2U7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2dldExpc3RlbmVyCiAgICAqIEByZXR1cm4ge0Z1bmN0aW9ufSBIYW5kbGVyIGZ1bmN0aW9uIGJvdW5kIHRvIHRoZSBzaWduYWwuCiAgICAqLwogICAgZ2V0TGlzdGVuZXI6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fbGlzdGVuZXI7CiAgICB9LAoKICAgIC8qKgogICAgKiBAbWV0aG9kIFBoYXNlci5TaWduYWxCaW5kaW5nI2dldFNpZ25hbAogICAgKiBAcmV0dXJuIHtTaWduYWx9IFNpZ25hbCB0aGF0IGxpc3RlbmVyIGlzIGN1cnJlbnRseSBib3VuZCB0by4KICAgICovCiAgICBnZXRTaWduYWw6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc2lnbmFsOwogICAgfSwKCiAgICAvKioKICAgICogQG1ldGhvZCBQaGFzZXIuU2lnbmFsQmluZGluZyNfZGVzdHJveQogICAgKiBEZWxldGUgaW5zdGFuY2UgcHJvcGVydGllcwogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIF9kZXN0cm95OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3NpZ25hbDsKICAgICAgICBkZWxldGUgdGhpcy5fbGlzdGVuZXI7CiAgICAgICAgZGVsZXRlIHRoaXMuY29udGV4dDsKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNpZ25hbEJpbmRpbmcjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBTdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIG9iamVjdC4KICAgICovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAnW1BoYXNlci5TaWduYWxCaW5kaW5nIGlzT25jZTonICsgdGhpcy5faXNPbmNlICsnLCBpc0JvdW5kOicrIHRoaXMuaXNCb3VuZCgpICsnLCBhY3RpdmU6JyArIHRoaXMuYWN0aXZlICsgJ10nOwogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKiAKKiBUaGlzIGlzIGEgYmFzZSBGaWx0ZXIgdGVtcGxhdGUgdG8gdXNlIGZvciBhbnkgUGhhc2VyIGZpbHRlciBkZXZlbG9wbWVudC4KKiAKKiBAY2xhc3MgUGhhc2VyLkZpbHRlcgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gRmlsdGVyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7T2JqZWN0fSB1bmlmb3JtcyAtIFVuaWZvcm0gbWFwcGluZ3Mgb2JqZWN0CiogQHBhcmFtIHtBcnJheX0gZnJhZ21lbnRTcmMgLSBUaGUgZnJhZ21lbnQgc2hhZGVyIGNvZGUuCiovClBoYXNlci5GaWx0ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgdW5pZm9ybXMsIGZyYWdtZW50U3JjKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KCSovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LCBlaXRoZXIgUGhhc2VyLldFQkdMX0ZJTFRFUiBvciBQaGFzZXIuQ0FOVkFTX0ZJTFRFUi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGUgPSAgUGhhc2VyLldFQkdMX0ZJTFRFUjsKICAgIAogICAgLyoqCiAgICAqIEFuIGFycmF5IG9mIHBhc3NlcyAtIHNvbWUgZmlsdGVycyBjb250YWluIGEgZmV3IHN0ZXBzIHRoaXMgYXJyYXkgc2ltcGx5IHN0b3JlcyB0aGUgc3RlcHMgaW4gYSBsaW5lYXIgZmFzaGlvbi4KICAgICogRm9yIGV4YW1wbGUgdGhlIGJsdXIgZmlsdGVyIGhhcyB0d28gcGFzc2VzIGJsdXJYIGFuZCBibHVyWS4KICAgICogQHByb3BlcnR5IHthcnJheX0gcGFzc2VzIC0gQW4gYXJyYXkgb2YgZmlsdGVyIG9iamVjdHMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5wYXNzZXMgPSBbdGhpc107CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpcnR5IC0gSW50ZXJuYWwgUElYSSB2YXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYWRkaW5nIC0gSW50ZXJuYWwgUElYSSB2YXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWRkaW5nID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IHVuaWZvcm1zIC0gRGVmYXVsdCB1bmlmb3JtIG1hcHBpbmdzLgogICAgKi8KICAgIHRoaXMudW5pZm9ybXMgPSB7CgogICAgICAgIHJlc29sdXRpb246IHsgdHlwZTogJzNmJywgdmFsdWU6IHsgeDogMjU2LCB5OiAyNTYsIHo6IDAgfX0sCiAgICAgICAgdGltZTogeyB0eXBlOiAnMWYnLCB2YWx1ZTogMCB9LAogICAgICAgIG1vdXNlOiB7IHR5cGU6ICc0ZicsIHZhbHVlOiB7IHg6IDAsIHk6IDAsIHo6IDAsIHc6IDAgfX0KCiAgICB9OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHthcnJheX0gZnJhZ21lbnRTcmMgLSBUaGUgZnJhZ21lbnQgc2hhZGVyIGNvZGUuCiAgICAqLwogICAgdGhpcy5mcmFnbWVudFNyYyA9IGZyYWdtZW50U3JjIHx8IFtdOwoKfTsKClBoYXNlci5GaWx0ZXIucHJvdG90eXBlID0gewoKICAgIGluaXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyAgVGhpcyBzaG91bGQgYmUgb3Zlci1yaWRkZW4uIFdpbGwgcmVjZWl2ZSBhIHZhcmlhYmxlIG51bWJlciBvZiBhcmd1bWVudHMuCiAgICB9LAoKICAgIHNldFJlc29sdXRpb246IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS54ID0gd2lkdGg7CiAgICAgICAgdGhpcy51bmlmb3Jtcy5yZXNvbHV0aW9uLnZhbHVlLnkgPSBoZWlnaHQ7CgogICAgfSwKCiAgICB1cGRhdGU6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgcG9pbnRlciAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnVuaWZvcm1zLm1vdXNlLnggPSBwb2ludGVyLng7CiAgICAgICAgICAgIHRoaXMudW5pZm9ybXMubW91c2UueSA9IHBvaW50ZXIueTsKICAgICAgICB9CgogICAgICAgIHRoaXMudW5pZm9ybXMudGltZS52YWx1ZSA9IHRoaXMuZ2FtZS50aW1lLnRvdGFsRWxhcHNlZFNlY29uZHMoKTsgCgogICAgfSwKCiAgICAvKioKICAgICogQ2xlYXIgZG93biB0aGlzIEZpbHRlciBhbmQgbnVsbCBvdXQgcmVmZXJlbmNlcwogICAgKiBAbWV0aG9kIFBoYXNlci5GaWx0ZXIjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICAKICAgIH0KCn07CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkZpbHRlci5wcm90b3R5cGUsICd3aWR0aCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuRmlsdGVyLnByb3RvdHlwZSwgJ2hlaWdodCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnVuaWZvcm1zLnJlc29sdXRpb24udmFsdWUueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMudW5pZm9ybXMucmVzb2x1dGlvbi52YWx1ZS55ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKiAKKiBUaGlzIGlzIGEgYmFzZSBQbHVnaW4gdGVtcGxhdGUgdG8gdXNlIGZvciBhbnkgUGhhc2VyIHBsdWdpbiBkZXZlbG9wbWVudC4KKiAKKiBAY2xhc3MgUGhhc2VyLlBsdWdpbgoqIEBjbGFzc2Rlc2MgUGhhc2VyIC0gUGx1Z2luCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7QW55fSBwYXJlbnQgLSBUaGUgb2JqZWN0IHRoYXQgb3ducyB0aGlzIHBsdWdpbiwgdXN1YWxseSBQaGFzZXIuUGx1Z2luTWFuYWdlci4KKi8KUGhhc2VyLlBsdWdpbiA9IGZ1bmN0aW9uIChnYW1lLCBwYXJlbnQpIHsKCiAgICBpZiAodHlwZW9mIHBhcmVudCA9PT0gJ3VuZGVmaW5lZCcpIHsgcGFyZW50ID0gbnVsbDsgfQoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7QW55fSBwYXJlbnQgLSBUaGUgcGFyZW50IG9mIHRoaXMgcGx1Z2luLiBJZiBhZGRlZCB0byB0aGUgUGx1Z2luTWFuYWdlciB0aGUgcGFyZW50IHdpbGwgYmUgc2V0IHRvIHRoYXQsIG90aGVyd2lzZSBpdCB3aWxsIGJlIG51bGwuCgkqLwogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGFjdGl2ZSAtIEEgUGx1Z2luIHdpdGggYWN0aXZlPXRydWUgaGFzIGl0cyBwcmVVcGRhdGUgYW5kIHVwZGF0ZSBtZXRob2RzIGNhbGxlZCBieSB0aGUgcGFyZW50LCBvdGhlcndpc2UgdGhleSBhcmUgc2tpcHBlZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFjdGl2ZSA9IGZhbHNlOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB2aXNpYmxlIC0gQSBQbHVnaW4gd2l0aCB2aXNpYmxlPXRydWUgaGFzIGl0cyByZW5kZXIgYW5kIHBvc3RSZW5kZXIgbWV0aG9kcyBjYWxsZWQgYnkgdGhlIHBhcmVudCwgb3RoZXJ3aXNlIHRoZXkgYXJlIHNraXBwZWQuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy52aXNpYmxlID0gZmFsc2U7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1ByZVVwZGF0ZSAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSBwcmVVcGRhdGUgbWV0aG9kLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuaGFzUHJlVXBkYXRlID0gZmFsc2U7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1VwZGF0ZSAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYW4gdXBkYXRlIG1ldGhvZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmhhc1VwZGF0ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1Bvc3RVcGRhdGUgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcG9zdFVwZGF0ZSBtZXRob2QuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oYXNQb3N0VXBkYXRlID0gZmFsc2U7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1JlbmRlciAtIEEgZmxhZyB0byBpbmRpY2F0ZSBpZiB0aGlzIHBsdWdpbiBoYXMgYSByZW5kZXIgbWV0aG9kLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuaGFzUmVuZGVyID0gZmFsc2U7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc1Bvc3RSZW5kZXIgLSBBIGZsYWcgdG8gaW5kaWNhdGUgaWYgdGhpcyBwbHVnaW4gaGFzIGEgcG9zdFJlbmRlciBtZXRob2QuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5oYXNQb3N0UmVuZGVyID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlBsdWdpbi5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIFByZS11cGRhdGUgaXMgY2FsbGVkIGF0IHRoZSB2ZXJ5IHN0YXJ0IG9mIHRoZSB1cGRhdGUgY3ljbGUsIGJlZm9yZSBhbnkgb3RoZXIgc3Vic3lzdGVtcyBoYXZlIGJlZW4gdXBkYXRlZCAoaW5jbHVkaW5nIFBoeXNpY3MpLgogICAgKiBJdCBpcyBvbmx5IGNhbGxlZCBpZiBhY3RpdmUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNwcmVVcGRhdGUKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZSBpcyBjYWxsZWQgYWZ0ZXIgYWxsIHRoZSBjb3JlIHN1YnN5c3RlbXMgKElucHV0LCBUd2VlbnMsIFNvdW5kLCBldGMpIGFuZCB0aGUgU3RhdGUgaGF2ZSB1cGRhdGVkLCBidXQgYmVmb3JlIHRoZSByZW5kZXIuCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIGFjdGl2ZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGlzIGNhbGxlZCByaWdodCBhZnRlciB0aGUgR2FtZSBSZW5kZXJlciBjb21wbGV0ZXMsIGJ1dCBiZWZvcmUgdGhlIFN0YXRlLnJlbmRlci4KICAgICogSXQgaXMgb25seSBjYWxsZWQgaWYgdmlzaWJsZSBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUGx1Z2luI3JlbmRlcgogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogUG9zdC1yZW5kZXIgaXMgY2FsbGVkIGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGFuZCBTdGF0ZS5yZW5kZXIgaGF2ZSBydW4uCiAgICAqIEl0IGlzIG9ubHkgY2FsbGVkIGlmIHZpc2libGUgaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbiNwb3N0UmVuZGVyCiAgICAqLwogICAgcG9zdFJlbmRlcjogZnVuY3Rpb24gKCkgewogICAgfSwKCiAgICAvKioKICAgICogQ2xlYXIgZG93biB0aGlzIFBsdWdpbiBhbmQgbnVsbCBvdXQgcmVmZXJlbmNlcwogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW4jZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICB0aGlzLnBhcmVudCA9IG51bGw7CiAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKICAgICAgICAKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKiogCiogRGVzY3JpcHRpb24uCiogCiogQGNsYXNzIFBoYXNlci5QbHVnaW5NYW5hZ2VyCiogQGNsYXNzZGVzYyBQaGFzZXIgLSBQbHVnaW5NYW5hZ2VyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7RGVzY3JpcHRpb259IHBhcmVudCAtIERlc2NyaXB0aW9uLgoqLwpQaGFzZXIuUGx1Z2luTWFuYWdlciA9IGZ1bmN0aW9uKGdhbWUsIHBhcmVudCkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCgkqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAgIAogICAgLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9wYXJlbnQgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9wYXJlbnQgPSBwYXJlbnQ7CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2FycmF5fSBwbHVnaW5zIC0gRGVzY3JpcHRpb24uCgkqLwogICAgdGhpcy5wbHVnaW5zID0gW107CiAgICAKICAgIC8qKgoJKiBAcHJvcGVydHkge2FycmF5fSBfcGx1Z2luc0xlbmd0aCAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX3BsdWdpbnNMZW5ndGggPSAwOwoKfTsKClBoYXNlci5QbHVnaW5NYW5hZ2VyLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGEgbmV3IFBsdWdpbiB0byB0aGUgUGx1Z2luTWFuYWdlci4KICAgICogVGhlIHBsdWdpbidzIGdhbWUgYW5kIHBhcmVudCByZWZlcmVuY2UgYXJlIHNldCB0byB0aGlzIGdhbWUgYW5kIHBsdWdpbm1hbmFnZXIgcGFyZW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI2FkZAogICAgKiBAcGFyYW0ge1BoYXNlci5QbHVnaW59IHBsdWdpbiAtIERlc2NyaXB0aW9uLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUGx1Z2lufSBEZXNjcmlwdGlvbi4KICAgICovCiAgICBhZGQ6IGZ1bmN0aW9uIChwbHVnaW4pIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IGZhbHNlOwoKICAgICAgICAvLyAgUHJvdG90eXBlPwogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luID0gbmV3IHBsdWdpbih0aGlzLmdhbWUsIHRoaXMuX3BhcmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHBsdWdpbi5nYW1lID0gdGhpcy5nYW1lOwogICAgICAgICAgICBwbHVnaW4ucGFyZW50ID0gdGhpcy5fcGFyZW50OwogICAgICAgIH0KCiAgICAgICAgLy8gIENoZWNrIGZvciBtZXRob2RzIG5vdyB0byBhdm9pZCBoYXZpbmcgdG8gZG8gdGhpcyBldmVyeSBsb29wCiAgICAgICAgaWYgKHR5cGVvZiBwbHVnaW5bJ3ByZVVwZGF0ZSddID09PSAnZnVuY3Rpb24nKQogICAgICAgIHsKICAgICAgICAgICAgcGx1Z2luLmhhc1ByZVVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsndXBkYXRlJ10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uaGFzVXBkYXRlID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydwb3N0VXBkYXRlJ10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uaGFzUG9zdFVwZGF0ZSA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsncmVuZGVyJ10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uaGFzUmVuZGVyID0gdHJ1ZTsKICAgICAgICAgICAgcmVzdWx0ID0gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgcGx1Z2luWydwb3N0UmVuZGVyJ10gPT09ICdmdW5jdGlvbicpCiAgICAgICAgewogICAgICAgICAgICBwbHVnaW4uaGFzUG9zdFJlbmRlciA9IHRydWU7CiAgICAgICAgICAgIHJlc3VsdCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyAgVGhlIHBsdWdpbiBtdXN0IGhhdmUgYXQgbGVhc3Qgb25lIG9mIHRoZSBhYm92ZSBmdW5jdGlvbnMgdG8gYmUgYWRkZWQgdG8gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAgICAgaWYgKHJlc3VsdCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChwbHVnaW4uaGFzUHJlVXBkYXRlIHx8IHBsdWdpbi5oYXNVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHBsdWdpbi5hY3RpdmUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocGx1Z2luLmhhc1JlbmRlciB8fCBwbHVnaW4uaGFzUG9zdFJlbmRlcikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcGx1Z2luLnZpc2libGUgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gdGhpcy5wbHVnaW5zLnB1c2gocGx1Z2luKTsKCiAgICAgICAgICAgIC8vIEFsbG93cyBwbHVnaW5zIHRvIHJ1biBwb3RlbnRpYWxseSBkZXN0cnVjdGl2ZSBjb2RlIG91dHNpZGUgb2YgdGhlIGNvbnN0cnVjdG9yLCBhbmQgb25seSBpZiBiZWluZyBhZGRlZCB0byB0aGUgUGx1Z2luTWFuYWdlcgogICAgICAgICAgICBpZiAodHlwZW9mIHBsdWdpblsnaW5pdCddID09PSAnZnVuY3Rpb24nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwbHVnaW4uaW5pdCgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcGx1Z2luOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgICogUmVtb3ZlIGEgUGx1Z2luIGZyb20gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3JlbW92ZQogICAgICogQHBhcmFtIHtQaGFzZXIuUGx1Z2lufSBwbHVnaW4gLSBUaGUgcGx1Z2luIHRvIGJlIHJlbW92ZWQuCiAgICAgKi8KICAgIHJlbW92ZTogZnVuY3Rpb24gKHBsdWdpbikgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXSA9PT0gcGx1Z2luKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBwbHVnaW4uZGVzdHJveSgpOwogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zLnNwbGljZSh0aGlzLl9wLCAxKTsKICAgICAgICAgICAgICAgIHRoaXMuX3BsdWdpbnNMZW5ndGgtLTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0sCgogICAgLyoqCiAgICAgKiBSZW1vdmVzIGFsbCBQbHVnaW5zIGZyb20gdGhlIFBsdWdpbk1hbmFnZXIuCiAgICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3JlbW92ZUFsbAogICAgICovCiAgICByZW1vdmVBbGw6IGZ1bmN0aW9uKCkgewogICAgICAgIAogICAgICAgIGZvciAodGhpcy5fcCA9IDA7IHRoaXMuX3AgPCB0aGlzLl9wbHVnaW5zTGVuZ3RoOyB0aGlzLl9wKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uZGVzdHJveSgpOwogICAgICAgIH0KICAgICAgICB0aGlzLnBsdWdpbnMubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9wbHVnaW5zTGVuZ3RoID0gMDsKICAgIH0sCgogICAgLyoqCiAgICAqIFByZS11cGRhdGUgaXMgY2FsbGVkIGF0IHRoZSB2ZXJ5IHN0YXJ0IG9mIHRoZSB1cGRhdGUgY3ljbGUsIGJlZm9yZSBhbnkgb3RoZXIgc3Vic3lzdGVtcyBoYXZlIGJlZW4gdXBkYXRlZCAoaW5jbHVkaW5nIFBoeXNpY3MpLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgYWN0aXZlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3ByZVVwZGF0ZQogICAgKi8KICAgIHByZVVwZGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0uYWN0aXZlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNQcmVVcGRhdGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5wcmVVcGRhdGUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGUgaXMgY2FsbGVkIGFmdGVyIGFsbCB0aGUgY29yZSBzdWJzeXN0ZW1zIChJbnB1dCwgVHdlZW5zLCBTb3VuZCwgZXRjKSBhbmQgdGhlIFN0YXRlIGhhdmUgdXBkYXRlZCwgYnV0IGJlZm9yZSB0aGUgcmVuZGVyLgogICAgKiBJdCBvbmx5IGNhbGxzIHBsdWdpbnMgd2hvIGhhdmUgYWN0aXZlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3VwZGF0ZQogICAgKi8KICAgIHVwZGF0ZTogZnVuY3Rpb24gKCkgewogICAgICAgIAogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS5hY3RpdmUgJiYgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLmhhc1VwZGF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5wbHVnaW5zW3RoaXMuX3BdLnVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFBvc3RVcGRhdGUgaXMgdGhlIGxhc3QgdGhpbmcgdG8gYmUgY2FsbGVkIGJlZm9yZSB0aGUgd29ybGQgcmVuZGVyLgogICAgKiBJbiBwYXJ0aWN1bGFyLCBpdCBpcyBjYWxsZWQgYWZ0ZXIgdGhlIHdvcmxkIHBvc3RVcGRhdGUsIHdoaWNoIG1lYW5zIHRoZSBjYW1lcmEgaGFzIGJlZW4gYWRqdXN0ZWQuCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSBhY3RpdmU9dHJ1ZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBsdWdpbk1hbmFnZXIjcG9zdFVwZGF0ZQogICAgKi8KICAgIHBvc3RVcGRhdGU6IGZ1bmN0aW9uICgpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0uYWN0aXZlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNQb3N0VXBkYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucG9zdFVwZGF0ZSgpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBpcyBjYWxsZWQgcmlnaHQgYWZ0ZXIgdGhlIEdhbWUgUmVuZGVyZXIgY29tcGxldGVzLCBidXQgYmVmb3JlIHRoZSBTdGF0ZS5yZW5kZXIuCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSB2aXNpYmxlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3JlbmRlcgogICAgKi8KICAgIHJlbmRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcGx1Z2luc0xlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh0aGlzLl9wID0gMDsgdGhpcy5fcCA8IHRoaXMuX3BsdWdpbnNMZW5ndGg7IHRoaXMuX3ArKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLnBsdWdpbnNbdGhpcy5fcF0udmlzaWJsZSAmJiB0aGlzLnBsdWdpbnNbdGhpcy5fcF0uaGFzUmVuZGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucmVuZGVyKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUG9zdC1yZW5kZXIgaXMgY2FsbGVkIGFmdGVyIHRoZSBHYW1lIFJlbmRlcmVyIGFuZCBTdGF0ZS5yZW5kZXIgaGF2ZSBydW4uCiAgICAqIEl0IG9ubHkgY2FsbHMgcGx1Z2lucyB3aG8gaGF2ZSB2aXNpYmxlPXRydWUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI3Bvc3RSZW5kZXIKICAgICovCiAgICBwb3N0UmVuZGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9wbHVnaW5zTGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBmb3IgKHRoaXMuX3AgPSAwOyB0aGlzLl9wIDwgdGhpcy5fcGx1Z2luc0xlbmd0aDsgdGhpcy5fcCsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMucGx1Z2luc1t0aGlzLl9wXS52aXNpYmxlICYmIHRoaXMucGx1Z2luc1t0aGlzLl9wXS5oYXNQb3N0UmVuZGVyKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBsdWdpbnNbdGhpcy5fcF0ucG9zdFJlbmRlcigpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENsZWFyIGRvd24gdGhpcyBQbHVnaW5NYW5hZ2VyIGFuZCBudWxsIG91dCByZWZlcmVuY2VzCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QbHVnaW5NYW5hZ2VyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMucGx1Z2lucy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuX3BsdWdpbnNMZW5ndGggPSAwOwogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CiAgICAgICAgdGhpcy5fcGFyZW50ID0gbnVsbDsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFN0YWdlIGNvbnRyb2xzIHRoZSBjYW52YXMgb24gd2hpY2ggZXZlcnl0aGluZyBpcyBkaXNwbGF5ZWQuIEl0IGhhbmRsZXMgZGlzcGxheSB3aXRoaW4gdGhlIGJyb3dzZXIsCiogZm9jdXMgaGFuZGxpbmcsIGdhbWUgcmVzaXppbmcsIHNjYWxpbmcgYW5kIHRoZSBwYXVzZSwgYm9vdCBhbmQgb3JpZW50YXRpb24gc2NyZWVucy4KKgoqIEBjbGFzcyBQaGFzZXIuU3RhZ2UKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gR2FtZSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIGNhbnZhcyBlbGVtZW50LgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBIZWlnaHQgb2YgdGhlIGNhbnZhcyBlbGVtZW50LgogKi8KUGhhc2VyLlN0YWdlID0gZnVuY3Rpb24gKGdhbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBnYW1lIC0gQmFja2dyb3VuZCBjb2xvciBvZiB0aGUgc3RhZ2UgKGRlZmF1bHRzIHRvIGJsYWNrKS4gU2V0IHZpYSB0aGUgcHVibGljIGJhY2tncm91bmRDb2xvciBwcm9wZXJ0eS4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQgJ3JnYigwLDAsMCknCgkqLwogICAgdGhpcy5fYmFja2dyb3VuZENvbG9yID0gJ3JnYigwLDAsMCknOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gb2Zmc2V0IC0gR2V0IHRoZSBvZmZzZXQgdmFsdWVzIChmb3IgaW5wdXQgYW5kIG90aGVyIHRoaW5ncykuCgkqLwoJdGhpcy5vZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gUmVmZXJlbmNlIHRvIHRoZSBuZXdseSBjcmVhdGVkICZsdDtjYW52YXMmZ3Q7IGVsZW1lbnQuCiAgICAqLwogICAgdGhpcy5jYW52YXMgPSBQaGFzZXIuQ2FudmFzLmNyZWF0ZSh3aWR0aCwgaGVpZ2h0KTsgCiAgICB0aGlzLmNhbnZhcy5zdHlsZVsnLXdlYmtpdC1mdWxsLXNjcmVlbiddID0gJ3dpZHRoOiAxMDAlOyBoZWlnaHQ6IDEwMCUnOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQSVhJLlN0YWdlfSBfc3RhZ2UgLSBUaGUgUGl4aSBTdGFnZSB3aGljaCBpcyBob29rZWQgdG8gdGhlIHJlbmRlcmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3N0YWdlID0gbmV3IFBJWEkuU3RhZ2UoMHgwMDAwMDAsIGZhbHNlKTsKICAgIHRoaXMuX3N0YWdlLm5hbWUgPSAnX3N0YWdlX3Jvb3QnOwogICAgdGhpcy5fc3RhZ2UuaW50ZXJhY3RpdmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjYWxlTW9kZSAtIFRoZSBjdXJyZW50IHNjYWxlTW9kZS4KICAgICovICAgIAogICAgdGhpcy5zY2FsZU1vZGUgPSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlN0YWdlU2NhbGVNb2RlfSBzY2FsZSAtIFRoZSBzY2FsZSBvZiB0aGUgY3VycmVudCBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUodGhpcy5nYW1lLCB3aWR0aCwgaGVpZ2h0KTsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhc3BlY3RSYXRpbyAtIEFzcGVjdCByYXRpby4KICAgICAqLwogICAgdGhpcy5hc3BlY3RSYXRpbyA9IHdpZHRoIC8gaGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX25leHRPZmZzZXRDaGVjayAtIFRoZSB0aW1lIHRvIHJ1biB0aGUgbmV4dCBvZmZzZXQgY2hlY2suCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbmV4dE9mZnNldENoZWNrID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ8ZmFsc2V9IGNoZWNrT2Zmc2V0SW50ZXJ2YWwgLSBUaGUgdGltZSAoaW4gbXMpIGJldHdlZW4gd2hpY2ggdGhlIHN0YWdlIHNob3VsZCBjaGVjayB0byBzZWUgaWYgaXQgaGFzIG1vdmVkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY2hlY2tPZmZzZXRJbnRlcnZhbCA9IDI1MDA7Cgp9OwoKUGhhc2VyLlN0YWdlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogSW5pdGlhbGlzZXMgdGhlIHN0YWdlIGFuZCBhZGRzIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlI2Jvb3QKICAgICogQHByaXZhdGUKICAgICovCiAgICBib290OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIFBoYXNlci5DYW52YXMuZ2V0T2Zmc2V0KHRoaXMuY2FudmFzLCB0aGlzLm9mZnNldCk7CgogICAgICAgIHRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUodGhpcy5vZmZzZXQueCwgdGhpcy5vZmZzZXQueSwgdGhpcy5nYW1lLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0KTsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgdGhpcy5fb25DaGFuZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLnZpc2liaWxpdHlDaGFuZ2UoZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRVc2VyU2VsZWN0KHRoaXMuY2FudmFzLCAnbm9uZScpOwogICAgICAgIFBoYXNlci5DYW52YXMuc2V0VG91Y2hBY3Rpb24odGhpcy5jYW52YXMsICdub25lJyk7CgogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3Zpc2liaWxpdHljaGFuZ2UnLCB0aGlzLl9vbkNoYW5nZSwgZmFsc2UpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdHZpc2liaWxpdHljaGFuZ2UnLCB0aGlzLl9vbkNoYW5nZSwgZmFsc2UpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3BhZ2VoaWRlJywgdGhpcy5fb25DaGFuZ2UsIGZhbHNlKTsKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwYWdlc2hvdycsIHRoaXMuX29uQ2hhbmdlLCBmYWxzZSk7CgogICAgICAgIHdpbmRvdy5vbmJsdXIgPSB0aGlzLl9vbkNoYW5nZTsKICAgICAgICB3aW5kb3cub25mb2N1cyA9IHRoaXMuX29uQ2hhbmdlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJ1bnMgU3RhZ2UgcHJvY2Vzc2VzIHRoYXQgbmVlZCBwZXJpb2RpYyB1cGRhdGVzLCBzdWNoIGFzIHRoZSBvZmZzZXQgY2hlY2tzLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZSN1cGRhdGUKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuY2hlY2tPZmZzZXRJbnRlcnZhbCAhPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5nYW1lLnRpbWUubm93ID4gdGhpcy5fbmV4dE9mZnNldENoZWNrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBQaGFzZXIuQ2FudmFzLmdldE9mZnNldCh0aGlzLmNhbnZhcywgdGhpcy5vZmZzZXQpOwogICAgICAgICAgICAgICAgdGhpcy5fbmV4dE9mZnNldENoZWNrID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5jaGVja09mZnNldEludGVydmFsOwogICAgICAgICAgICB9CgogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgd2hlbiB0aGUgZG9jdW1lbnQgdmlzaWJpbGl0eSBpcyBjaGFuZ2VkLgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZSN2aXNpYmlsaXR5Q2hhbmdlCiAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gSXRzIHR5cGUgd2lsbCBiZSB1c2VkIHRvIGRlY2lkZSB3aGV0aGVyIHRoZSBnYW1lIHNob3VsZCBiZSBwYXVzZWQgb3Igbm90LgogICAgKi8KICAgIHZpc2liaWxpdHlDaGFuZ2U6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5kaXNhYmxlVmlzaWJpbGl0eUNoYW5nZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmIChldmVudC50eXBlID09ICdwYWdlaGlkZScgfHwgZXZlbnQudHlwZSA9PSAnYmx1cicgfHwgZG9jdW1lbnRbJ2hpZGRlbiddID09IHRydWUgfHwgZG9jdW1lbnRbJ3dlYmtpdEhpZGRlbiddID09IHRydWUpCiAgICAgICAgewoJICAgICAgICB0aGlzLmdhbWUucGF1c2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKCSAgICAgICAgdGhpcy5nYW1lLnBhdXNlZCA9IGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TdGFnZSNiYWNrZ3JvdW5kQ29sb3IKKiBAcHJvcGVydHkge251bWJlcnxzdHJpbmd9IGJhY2tncm91bmRDb2xvciAtIEdldHMgYW5kIHNldHMgdGhlIGJhY2tncm91bmQgY29sb3Igb2YgdGhlIHN0YWdlLiBUaGUgY29sb3IgY2FuIGJlIGdpdmVuIGFzIGEgbnVtYmVyOiAweGZmMDAwMCBvciBhIGhleCBzdHJpbmc6ICcjZmYwMDAwJwoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlN0YWdlLnByb3RvdHlwZSwgImJhY2tncm91bmRDb2xvciIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fYmFja2dyb3VuZENvbG9yOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB0aGlzLl9iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5yZW5kZXJUeXBlID09IFBoYXNlci5DQU5WQVMpCiAgICAgICAgewogICAgICAgICAgICAvLyAgU2V0IGl0IGRpcmVjdGx5LCB0aGlzIGFsbG93cyB1cyB0byB1c2UgcmdiIGFscGhhIHZhbHVlcyBpbiBDYW52YXMgbW9kZS4KICAgICAgICAgICAgdGhpcy5fc3RhZ2UuYmFja2dyb3VuZENvbG9yU3RyaW5nID0gY29sb3I7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29sb3IgPT09ICdzdHJpbmcnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb2xvciA9IFBoYXNlci5Db2xvci5oZXhUb1JHQihjb2xvcik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuX3N0YWdlLnNldEJhY2tncm91bmRDb2xvcihjb2xvcik7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIEdyb3VwIGNvbnN0cnVjdG9yLgoqIEBjbGFzcyBQaGFzZXIuR3JvdXAKKiBAY2xhc3NkZXNjIEEgR3JvdXAgaXMgYSBjb250YWluZXIgZm9yIGRpc3BsYXkgb2JqZWN0cyB0aGF0IGFsbG93cyBmb3IgZmFzdCBwb29saW5nLCByZWN5Y2xpbmcgYW5kIGNvbGxpc2lvbiBjaGVja3MuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7Kn0gcGFyZW50IC0gVGhlIHBhcmVudCBHcm91cCBvciBEaXNwbGF5T2JqZWN0Q29udGFpbmVyIHRoYXQgd2lsbCBob2xkIHRoaXMgZ3JvdXAsIGlmIGFueS4KKiBAcGFyYW0ge3N0cmluZ30gW25hbWU9Z3JvdXBdIC0gQSBuYW1lIGZvciB0aGlzIEdyb3VwLiBOb3QgdXNlZCBpbnRlcm5hbGx5IGJ1dCB1c2VmdWwgZm9yIGRlYnVnZ2luZy4KKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VTdGFnZT1mYWxzZV0gLSBTaG91bGQgdGhlIERpc3BsYXlPYmplY3RDb250YWluZXIgdGhpcyBHcm91cCBjcmVhdGVzIGJlIGFkZGVkIHRvIHRoZSBXb3JsZCAoZGVmYXVsdCwgZmFsc2UpIG9yIGRpcmVjdCB0byB0aGUgU3RhZ2UgKHRydWUpLgoqLwpQaGFzZXIuR3JvdXAgPSBmdW5jdGlvbiAoZ2FtZSwgcGFyZW50LCBuYW1lLCB1c2VTdGFnZSkgewoKCWlmICh0eXBlb2YgcGFyZW50ID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YgcGFyZW50ID09PSBudWxsKQoJewoJCXBhcmVudCA9IGdhbWUud29ybGQ7Cgl9CgoJaWYgKHR5cGVvZiB1c2VTdGFnZSA9PT0gJ3VuZGVmaW5lZCcpCgl7CgkJdXNlU3RhZ2UgPSBmYWxzZTsKCX0KCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgkKICAgIC8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIEEgbmFtZSBmb3IgdGhpcyBHcm91cC4gTm90IHVzZWQgaW50ZXJuYWxseSBidXQgdXNlZnVsIGZvciBkZWJ1Z2dpbmcuCgkqLwoJdGhpcy5uYW1lID0gbmFtZSB8fCAnZ3JvdXAnOwoKCWlmICh1c2VTdGFnZSkKCXsKCQl0aGlzLl9jb250YWluZXIgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwoJfQoJZWxzZQoJewoJCXRoaXMuX2NvbnRhaW5lciA9IG5ldyBQSVhJLkRpc3BsYXlPYmplY3RDb250YWluZXIoKTsKCQl0aGlzLl9jb250YWluZXIubmFtZSA9IHRoaXMubmFtZTsKCgkJaWYgKHBhcmVudCkKCQl7CgkJCWlmIChwYXJlbnQgaW5zdGFuY2VvZiBQaGFzZXIuR3JvdXApCgkJCXsKCQkJCXBhcmVudC5fY29udGFpbmVyLmFkZENoaWxkKHRoaXMuX2NvbnRhaW5lcik7CgkJCQlwYXJlbnQuX2NvbnRhaW5lci51cGRhdGVUcmFuc2Zvcm0oKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXBhcmVudC5hZGRDaGlsZCh0aGlzLl9jb250YWluZXIpOwoJCQkJcGFyZW50LnVwZGF0ZVRyYW5zZm9ybSgpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuYWRkQ2hpbGQodGhpcy5fY29udGFpbmVyKTsKCQkJdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCQl9Cgl9CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0eXBlIC0gSW50ZXJuYWwgUGhhc2VyIFR5cGUgdmFsdWUuCgkqIEBwcm90ZWN0ZWQKCSovCgl0aGlzLnR5cGUgPSBQaGFzZXIuR1JPVVA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhpc3RzIC0gSWYgZXhpc3RzIGlzIHRydWUgdGhlIHRoZSBHcm91cCBpcyB1cGRhdGVkLCBvdGhlcndpc2UgaXQgaXMgc2tpcHBlZC4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmV4aXN0cyA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIFJlcGxhY2VzIHRoZSBQSVhJLlBvaW50IHdpdGggYSBzbGlnaHRseSBtb3JlIGZsZXhpYmxlIG9uZS4KICAgICovIAogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIFRoZSBjdXJzb3IgaXMgYSBzaW1wbGUgd2F5IHRvIGl0ZXJhdGUgdGhyb3VnaCB0aGUgb2JqZWN0cyBpbiBhIEdyb3VwIHVzaW5nIHRoZSBHcm91cC5uZXh0IGFuZCBHcm91cC5wcmV2aW91cyBmdW5jdGlvbnMuCiAgICAqIFRoZSBjdXJzb3IgaXMgc2V0IHRvIHRoZSBmaXJzdCBjaGlsZCBhZGRlZCB0byB0aGUgR3JvdXAgYW5kIGRvZXNuJ3QgY2hhbmdlIHVubGVzcyB5b3UgY2FsbCBuZXh0LCBwcmV2aW91cyBvciBzZXQgaXQgZGlyZWN0bHkgd2l0aCBHcm91cC5jdXJzb3IuCiAgICAqIEBwcm9wZXJ0eSB7YW55fSBjdXJzb3IgLSBUaGUgY3VycmVudCBkaXNwbGF5IG9iamVjdCB0aGF0IHRoZSBHcm91cCBjdXJzb3IgaXMgcG9pbnRpbmcgdG8uCiAgICAqLyAKICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuUkVUVVJOX05PTkUgPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEID0gMjsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORyA9IC0xOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkdyb3VwLlNPUlRfREVTQ0VORElORyA9IDE7CgpQaGFzZXIuR3JvdXAucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGlzIEdyb3VwLiBUaGUgb2JqZWN0IGNhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4KICAgICogVGhlIGNoaWxkIGlzIGF1dG9tYXRpY2FsbHkgYWRkZWQgdG8gdGhlIHRvcCBvZiB0aGUgR3JvdXAsIHNvIHJlbmRlcnMgb24tdG9wIG9mIGV2ZXJ5dGhpbmcgZWxzZSB3aXRoaW4gdGhlIEdyb3VwLiBJZiB5b3UgbmVlZCB0byBjb250cm9sCiAgICAqIHRoYXQgdGhlbiBzZWUgdGhlIGFkZEF0IG1ldGhvZC4KICAgICoKICAgICogQHNlZSBQaGFzZXIuR3JvdXAjY3JlYXRlCiAgICAqIEBzZWUgUGhhc2VyLkdyb3VwI2FkZEF0CiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2FkZAoJKiBAcGFyYW0geyp9IGNoaWxkIC0gQW4gaW5zdGFuY2Ugb2YgUGhhc2VyLlNwcml0ZSwgUGhhc2VyLkJ1dHRvbiBvciBhbnkgb3RoZXIgZGlzcGxheSBvYmplY3QuLgoJKiBAcmV0dXJuIHsqfSBUaGUgY2hpbGQgdGhhdCB3YXMgYWRkZWQgdG8gdGhlIEdyb3VwLgogICAgKi8KCWFkZDogZnVuY3Rpb24gKGNoaWxkKSB7CgoJCWlmIChjaGlsZC5ncm91cCAhPT0gdGhpcykKCQl7CgkJCWNoaWxkLmdyb3VwID0gdGhpczsKCgkJCWlmIChjaGlsZC5ldmVudHMpCgkJCXsKCQkJCWNoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CgkJCX0KCgkJCXRoaXMuX2NvbnRhaW5lci5hZGRDaGlsZChjaGlsZCk7CgoJCQljaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCgkJCWlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSBjaGlsZDsKCQkJfQoJCX0KCgkJcmV0dXJuIGNoaWxkOwoKCX0sCgogICAgLyoqCiAgICAqIEFkZHMgYW4gZXhpc3Rpbmcgb2JqZWN0IHRvIHRoaXMgR3JvdXAuIFRoZSBvYmplY3QgY2FuIGJlIGFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5CdXR0b24gb3IgYW55IG90aGVyIGRpc3BsYXkgb2JqZWN0LgogICAgKiBUaGUgY2hpbGQgaXMgYWRkZWQgdG8gdGhlIEdyb3VwIGF0IHRoZSBsb2NhdGlvbiBzcGVjaWZpZWQgYnkgdGhlIGluZGV4IHZhbHVlLCB0aGlzIGFsbG93cyB5b3UgdG8gY29udHJvbCBjaGlsZCBvcmRlcmluZy4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjYWRkQXQKCSogQHBhcmFtIHsqfSBjaGlsZCAtIEFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5CdXR0b24gb3IgYW55IG90aGVyIGRpc3BsYXkgb2JqZWN0Li4KCSogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IHdpdGhpbiB0aGUgR3JvdXAgdG8gaW5zZXJ0IHRoZSBjaGlsZCB0by4KCSogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIGFkZGVkIHRvIHRoZSBHcm91cC4KCSovCglhZGRBdDogZnVuY3Rpb24gKGNoaWxkLCBpbmRleCkgewoKCQlpZiAoY2hpbGQuZ3JvdXAgIT09IHRoaXMpCgkJewoJCQljaGlsZC5ncm91cCA9IHRoaXM7CgoJCQlpZiAoY2hpbGQuZXZlbnRzKQoJCQl7CgkJCQljaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwoJCQl9CgoJCQl0aGlzLl9jb250YWluZXIuYWRkQ2hpbGRBdChjaGlsZCwgaW5kZXgpOwoKCQkJY2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgoJCQlpZiAodGhpcy5jdXJzb3IgPT09IG51bGwpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gY2hpbGQ7CgkJCX0KCQl9CgoJCXJldHVybiBjaGlsZDsKCgl9LAoKICAgIC8qKgoJKiBSZXR1cm5zIHRoZSBjaGlsZCBmb3VuZCBhdCB0aGUgZ2l2ZW4gaW5kZXggd2l0aGluIHRoaXMgR3JvdXAuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEF0CiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuR3JvdXAKCSogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IHRvIHJldHVybiB0aGUgY2hpbGQgZnJvbS4KCSogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIGZvdW5kIGF0IHRoZSBnaXZlbiBpbmRleC4KCSovCglnZXRBdDogZnVuY3Rpb24gKGluZGV4KSB7CgoJCXJldHVybiB0aGlzLl9jb250YWluZXIuZ2V0Q2hpbGRBdChpbmRleCk7CgoJfSwKCiAgICAvKioKCSogQXV0b21hdGljYWxseSBjcmVhdGVzIGEgbmV3IFBoYXNlci5TcHJpdGUgb2JqZWN0IGFuZCBhZGRzIGl0IHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KCSogVXNlZnVsIGlmIHlvdSBkb24ndCBuZWVkIHRvIGNyZWF0ZSB0aGUgU3ByaXRlIGluc3RhbmNlcyBiZWZvcmUtaGFuZC4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY3JlYXRlCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSB0byBkaXNwbGF5IHRoZSBuZXdseSBjcmVhdGVkIFNwcml0ZSBhdC4gVGhlIHZhbHVlIGlzIGluIHJlbGF0aW9uIHRvIHRoZSBHcm91cC54IHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gZGlzcGxheSB0aGUgbmV3bHkgY3JlYXRlZCBTcHJpdGUgYXQuIFRoZSB2YWx1ZSBpcyBpbiByZWxhdGlvbiB0byB0aGUgR3JvdXAueSBwb2ludC4KCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgaW1hZ2UgdGhhdCB0aGlzIFNwcml0ZSB3aWxsIHVzZS4KCSogQHBhcmFtIHtudW1iZXJ8c3RyaW5nfSBbZnJhbWVdIC0gSWYgdGhlIFNwcml0ZSBpbWFnZSBjb250YWlucyBtdWx0aXBsZSBmcmFtZXMgeW91IGNhbiBzcGVjaWZ5IHdoaWNoIG9uZSB0byB1c2UgaGVyZS4KCSogQHBhcmFtIHtib29sZWFufSBbZXhpc3RzPXRydWVdIC0gVGhlIGRlZmF1bHQgZXhpc3RzIHN0YXRlIG9mIHRoZSBTcHJpdGUuCgkqIEByZXR1cm4ge1BoYXNlci5TcHJpdGV9IFRoZSBjaGlsZCB0aGF0IHdhcyBjcmVhdGVkLgoJKi8KCWNyZWF0ZTogZnVuY3Rpb24gKHgsIHksIGtleSwgZnJhbWUsIGV4aXN0cykgewoKCQlpZiAodHlwZW9mIGV4aXN0cyA9PSAndW5kZWZpbmVkJykgeyBleGlzdHMgPSB0cnVlOyB9CgoJCXZhciBjaGlsZCA9IG5ldyBQaGFzZXIuU3ByaXRlKHRoaXMuZ2FtZSwgeCwgeSwga2V5LCBmcmFtZSk7CgoJCWNoaWxkLmdyb3VwID0gdGhpczsKCQljaGlsZC5leGlzdHMgPSBleGlzdHM7CgkJY2hpbGQudmlzaWJsZSA9IGV4aXN0czsKCQljaGlsZC5hbGl2ZSA9IGV4aXN0czsKCgkJaWYgKGNoaWxkLmV2ZW50cykKCQl7CgkJCWNoaWxkLmV2ZW50cy5vbkFkZGVkVG9Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CgkJfQoKCQl0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwoJCQkKCQljaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCgkJaWYgKHRoaXMuY3Vyc29yID09PSBudWxsKQoJCXsKCQkJdGhpcy5jdXJzb3IgPSBjaGlsZDsKCQl9CgoJCXJldHVybiBjaGlsZDsKCgl9LAoKICAgIC8qKgoJKiBBdXRvbWF0aWNhbGx5IGNyZWF0ZXMgbXVsdGlwbGUgUGhhc2VyLlNwcml0ZSBvYmplY3RzIGFuZCBhZGRzIHRoZW0gdG8gdGhlIHRvcCBvZiB0aGlzIEdyb3VwLgoJKiBVc2VmdWwgaWYgeW91IG5lZWQgdG8gcXVpY2tseSBnZW5lcmF0ZSBhIHBvb2wgb2YgaWRlbnRpY2FsIHNwcml0ZXMsIHN1Y2ggYXMgYnVsbGV0cy4gQnkgZGVmYXVsdCB0aGUgc3ByaXRlcyB3aWxsIGJlIHNldCB0byBub3QgZXhpc3QKCSogYW5kIHdpbGwgYmUgcG9zaXRpb25lZCBhdCAwLCAwIChyZWxhdGl2ZSB0byB0aGUgR3JvdXAueC95KQoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNjcmVhdGVNdWx0aXBsZQoJKiBAcGFyYW0ge251bWJlcn0gcXVhbnRpdHkgLSBUaGUgbnVtYmVyIG9mIFNwcml0ZXMgdG8gY3JlYXRlLgoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIEdhbWUuY2FjaGUga2V5IG9mIHRoZSBpbWFnZSB0aGF0IHRoaXMgU3ByaXRlIHdpbGwgdXNlLgoJKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IFtmcmFtZV0gLSBJZiB0aGUgU3ByaXRlIGltYWdlIGNvbnRhaW5zIG11bHRpcGxlIGZyYW1lcyB5b3UgY2FuIHNwZWNpZnkgd2hpY2ggb25lIHRvIHVzZSBoZXJlLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFtleGlzdHM9ZmFsc2VdIC0gVGhlIGRlZmF1bHQgZXhpc3RzIHN0YXRlIG9mIHRoZSBTcHJpdGUuCgkqLwoJY3JlYXRlTXVsdGlwbGU6IGZ1bmN0aW9uIChxdWFudGl0eSwga2V5LCBmcmFtZSwgZXhpc3RzKSB7CgoJCWlmICh0eXBlb2YgZXhpc3RzID09ICd1bmRlZmluZWQnKSB7IGV4aXN0cyA9IGZhbHNlOyB9CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgcXVhbnRpdHk7IGkrKykKCQl7CgkJCXZhciBjaGlsZCA9IG5ldyBQaGFzZXIuU3ByaXRlKHRoaXMuZ2FtZSwgMCwgMCwga2V5LCBmcmFtZSk7CgoJCQljaGlsZC5ncm91cCA9IHRoaXM7CgkJCWNoaWxkLmV4aXN0cyA9IGV4aXN0czsKCQkJY2hpbGQudmlzaWJsZSA9IGV4aXN0czsKCQkJY2hpbGQuYWxpdmUgPSBleGlzdHM7CgoJCQlpZiAoY2hpbGQuZXZlbnRzKQoJCQl7CgkJCQljaGlsZC5ldmVudHMub25BZGRlZFRvR3JvdXAuZGlzcGF0Y2goY2hpbGQsIHRoaXMpOwoJCQl9CgoJCQl0aGlzLl9jb250YWluZXIuYWRkQ2hpbGQoY2hpbGQpOwoJCQljaGlsZC51cGRhdGVUcmFuc2Zvcm0oKTsKCgkJCWlmICh0aGlzLmN1cnNvciA9PT0gbnVsbCkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSBjaGlsZDsKCQkJfQoKCQl9CgoJfSwKCiAgICAvKioKCSogQWR2YW5jZXMgdGhlIEdyb3VwIGN1cnNvciB0byB0aGUgbmV4dCBvYmplY3QgaW4gdGhlIEdyb3VwLiBJZiBpdCdzIGF0IHRoZSBlbmQgb2YgdGhlIEdyb3VwIGl0IHdyYXBzIGFyb3VuZCB0byB0aGUgZmlyc3Qgb2JqZWN0LgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNuZXh0CgkqLwoJbmV4dDogZnVuY3Rpb24gKCkgewoKCQlpZiAodGhpcy5jdXJzb3IpCgkJewoJCQkvLwlXcmFwIHRoZSBjdXJzb3I/CgkJCWlmICh0aGlzLmN1cnNvciA9PSB0aGlzLl9jb250YWluZXIubGFzdCkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSB0aGlzLl9jb250YWluZXIuX2lOZXh0OwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSB0aGlzLmN1cnNvci5faU5leHQ7CgkJCX0KCQl9CgoJfSwKCiAgICAvKioKCSogTW92ZXMgdGhlIEdyb3VwIGN1cnNvciB0byB0aGUgcHJldmlvdXMgb2JqZWN0IGluIHRoZSBHcm91cC4gSWYgaXQncyBhdCB0aGUgc3RhcnQgb2YgdGhlIEdyb3VwIGl0IHdyYXBzIGFyb3VuZCB0byB0aGUgbGFzdCBvYmplY3QuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3ByZXZpb3VzCgkqLwoJcHJldmlvdXM6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuY3Vyc29yKQoJCXsKCQkJLy8JV3JhcCB0aGUgY3Vyc29yPwoJCQlpZiAodGhpcy5jdXJzb3IgPT0gdGhpcy5fY29udGFpbmVyLl9pTmV4dCkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSB0aGlzLl9jb250YWluZXIubGFzdDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5jdXJzb3IuX2lQcmV2OwoJCQl9CgkJfQoKCX0sCgoJY2hpbGRUZXN0OiBmdW5jdGlvbiAocHJlZml4LCBjaGlsZCkgewoKCQl2YXIgcyA9IHByZWZpeCArICcgbmV4dDogJzsKCgkJaWYgKGNoaWxkLl9pTmV4dCkKCQl7CgkJCXMgPSBzICsgY2hpbGQuX2lOZXh0Lm5hbWU7CgkJfQoJCWVsc2UKCQl7CgkJCXMgPSBzICsgJy1udWxsLSc7CgkJfQoKCQlzID0gcyArICcgJyArIHByZWZpeCArICcgcHJldjogJzsKCgkJaWYgKGNoaWxkLl9pUHJldikKCQl7CgkJCXMgPSBzICsgY2hpbGQuX2lQcmV2Lm5hbWU7CgkJfQoJCWVsc2UKCQl7CgkJCXMgPSBzICsgJy1udWxsLSc7CgkJfQoKCQljb25zb2xlLmxvZyhzKTsKCgl9LAoKCXN3YXBJbmRleDogZnVuY3Rpb24gKGluZGV4MSwgaW5kZXgyKSB7CgoJCXZhciBjaGlsZDEgPSB0aGlzLmdldEF0KGluZGV4MSk7CgkJdmFyIGNoaWxkMiA9IHRoaXMuZ2V0QXQoaW5kZXgyKTsKCgkJY29uc29sZS5sb2coJ3N3YXBJbmRleCAnLCBpbmRleDEsICcgd2l0aCAnLCBpbmRleDIpOwoKCQl0aGlzLnN3YXAoY2hpbGQxLCBjaGlsZDIpOwoKCX0sCgoJLyoqCgkqIFN3YXBzIHRoZSBwb3NpdGlvbiBvZiB0d28gY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4gQm90aCBjaGlsZHJlbiBtdXN0IGJlIGluIHRoaXMgR3JvdXAuCgkqIFlvdSBjYW5ub3Qgc3dhcCBhIGNoaWxkIHdpdGggaXRzZWxmLCBvciBzd2FwIHVuLXBhcmVudGVkIGNoaWxkcmVuLCBkb2luZyBzbyB3aWxsIHJldHVybiBmYWxzZS4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc3dhcAoJKiBAcGFyYW0geyp9IGNoaWxkMSAtIFRoZSBmaXJzdCBjaGlsZCB0byBzd2FwLgoJKiBAcGFyYW0geyp9IGNoaWxkMiAtIFRoZSBzZWNvbmQgY2hpbGQgdG8gc3dhcC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgc3dhcCB3YXMgc3VjY2Vzc2Z1bCwgb3RoZXJ3aXNlIGZhbHNlLgoJKi8KCXN3YXA6IGZ1bmN0aW9uIChjaGlsZDEsIGNoaWxkMikgewoKCQlpZiAoY2hpbGQxID09PSBjaGlsZDIgfHwgIWNoaWxkMS5wYXJlbnQgfHwgIWNoaWxkMi5wYXJlbnQgfHwgY2hpbGQxLmdyb3VwICE9PSB0aGlzIHx8IGNoaWxkMi5ncm91cCAhPT0gdGhpcykKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vCUNhY2hlIHRoZSB2YWx1ZXMKCQl2YXIgY2hpbGQxUHJldiA9IGNoaWxkMS5faVByZXY7CgkJdmFyIGNoaWxkMU5leHQgPSBjaGlsZDEuX2lOZXh0OwoJCXZhciBjaGlsZDJQcmV2ID0gY2hpbGQyLl9pUHJldjsKCQl2YXIgY2hpbGQyTmV4dCA9IGNoaWxkMi5faU5leHQ7CgoJCXZhciBlbmROb2RlID0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0OwoJCXZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2U7CgkJCQoJCWRvCgkJewoJCQlpZiAoY3VycmVudE5vZGUgIT09IGNoaWxkMSAmJiBjdXJyZW50Tm9kZSAhPT0gY2hpbGQyKQoJCQl7CgkJCQlpZiAoY3VycmVudE5vZGUuZmlyc3QgPT09IGNoaWxkMSkKCQkJCXsKCQkJCQljdXJyZW50Tm9kZS5maXJzdCA9IGNoaWxkMjsKCQkJCX0KCQkJCWVsc2UgaWYgKGN1cnJlbnROb2RlLmZpcnN0ID09PSBjaGlsZDIpCgkJCQl7CgkJCQkJY3VycmVudE5vZGUuZmlyc3QgPSBjaGlsZDE7CgkJCQl9CgoJCQkJaWYgKGN1cnJlbnROb2RlLmxhc3QgPT09IGNoaWxkMSkKCQkJCXsKCQkJCQljdXJyZW50Tm9kZS5sYXN0ID0gY2hpbGQyOwoJCQkJfQoJCQkJZWxzZSBpZiAoY3VycmVudE5vZGUubGFzdCA9PT0gY2hpbGQyKQoJCQkJewoJCQkJCWN1cnJlbnROb2RlLmxhc3QgPSBjaGlsZDE7CgkJCQl9CgkJCX0KCgkJCWN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwoJCX0KCQl3aGlsZSAoY3VycmVudE5vZGUgIT0gZW5kTm9kZSkKCgkJaWYgKGNoaWxkMS5faU5leHQgPT0gY2hpbGQyKQoJCXsKCQkJLy8JVGhpcyBpcyBhIGRvd253YXJkIChBIHRvIEIpIG5laWdoYm91ciBzd2FwCgkJCWNoaWxkMS5faU5leHQgPSBjaGlsZDJOZXh0OwoJCQljaGlsZDEuX2lQcmV2ID0gY2hpbGQyOwoJCQljaGlsZDIuX2lOZXh0ID0gY2hpbGQxOwoJCQljaGlsZDIuX2lQcmV2ID0gY2hpbGQxUHJldjsKCgkJCWlmIChjaGlsZDFQcmV2KSB7IGNoaWxkMVByZXYuX2lOZXh0ID0gY2hpbGQyOyB9CgkJCWlmIChjaGlsZDJOZXh0KSB7IGNoaWxkMk5leHQuX2lQcmV2ID0gY2hpbGQxOyB9CgoJCQlpZiAoY2hpbGQxLl9fcmVuZGVyR3JvdXApCgkJCXsKCQkJCWNoaWxkMS5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQxKTsKCQkJfQoKCQkJaWYgKGNoaWxkMi5fX3JlbmRlckdyb3VwKQoJCQl7CgkJCQljaGlsZDIuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMik7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlIGlmIChjaGlsZDIuX2lOZXh0ID09IGNoaWxkMSkKCQl7CgkJCS8vCVRoaXMgaXMgYW4gdXB3YXJkIChCIHRvIEEpIG5laWdoYm91ciBzd2FwCgkJCWNoaWxkMS5faU5leHQgPSBjaGlsZDI7CgkJCWNoaWxkMS5faVByZXYgPSBjaGlsZDJQcmV2OwoJCQljaGlsZDIuX2lOZXh0ID0gY2hpbGQxTmV4dDsKCQkJY2hpbGQyLl9pUHJldiA9IGNoaWxkMTsKCgkJCWlmIChjaGlsZDJQcmV2KSB7IGNoaWxkMlByZXYuX2lOZXh0ID0gY2hpbGQxOyB9CgkJCWlmIChjaGlsZDFOZXh0KSB7IGNoaWxkMU5leHQuX2lQcmV2ID0gY2hpbGQyOyB9CgoJCQlpZiAoY2hpbGQxLl9fcmVuZGVyR3JvdXApCgkJCXsKCQkJCWNoaWxkMS5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQxKTsKCQkJfQoKCQkJaWYgKGNoaWxkMi5fX3JlbmRlckdyb3VwKQoJCQl7CgkJCQljaGlsZDIuX19yZW5kZXJHcm91cC51cGRhdGVUZXh0dXJlKGNoaWxkMik7CgkJCX0KCgkJCXJldHVybiB0cnVlOwoJCX0KCQllbHNlCgkJewoJCQkvLwlDaGlsZHJlbiBhcmUgZmFyIGFwYXJ0CgkJCWNoaWxkMS5faU5leHQgPSBjaGlsZDJOZXh0OwoJCQljaGlsZDEuX2lQcmV2ID0gY2hpbGQyUHJldjsKCQkJY2hpbGQyLl9pTmV4dCA9IGNoaWxkMU5leHQ7CgkJCWNoaWxkMi5faVByZXYgPSBjaGlsZDFQcmV2OwoKCQkJaWYgKGNoaWxkMVByZXYpIHsgY2hpbGQxUHJldi5faU5leHQgPSBjaGlsZDI7IH0KCQkJaWYgKGNoaWxkMU5leHQpIHsgY2hpbGQxTmV4dC5faVByZXYgPSBjaGlsZDI7IH0KCQkJaWYgKGNoaWxkMlByZXYpIHsgY2hpbGQyUHJldi5faU5leHQgPSBjaGlsZDE7IH0KCQkJaWYgKGNoaWxkMk5leHQpIHsgY2hpbGQyTmV4dC5faVByZXYgPSBjaGlsZDE7IH0KCgkJCWlmIChjaGlsZDEuX19yZW5kZXJHcm91cCkKCQkJewoJCQkJY2hpbGQxLl9fcmVuZGVyR3JvdXAudXBkYXRlVGV4dHVyZShjaGlsZDEpOwoJCQl9CgoJCQlpZiAoY2hpbGQyLl9fcmVuZGVyR3JvdXApCgkJCXsKCQkJCWNoaWxkMi5fX3JlbmRlckdyb3VwLnVwZGF0ZVRleHR1cmUoY2hpbGQyKTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgkJCgl9LAoKCS8qKgoJKiBCcmluZ3MgdGhlIGdpdmVuIGNoaWxkIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cCBzbyBpdCByZW5kZXJzIGFib3ZlIGFsbCBvdGhlciBjaGlsZHJlbi4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjYnJpbmdUb1RvcAoJKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGJyaW5nIHRvIHRoZSB0b3Agb2YgdGhpcyBHcm91cC4KICAgICogQHJldHVybiB7Kn0gVGhlIGNoaWxkIHRoYXQgd2FzIG1vdmVkLgoJKi8KCWJyaW5nVG9Ub3A6IGZ1bmN0aW9uIChjaGlsZCkgewoKCQlpZiAoY2hpbGQuZ3JvdXAgPT09IHRoaXMpCgkJewoJCQl0aGlzLnJlbW92ZShjaGlsZCk7CgkJCXRoaXMuYWRkKGNoaWxkKTsKCQl9CgoJCXJldHVybiBjaGlsZDsKCgl9LAoKCS8qKgoJKiBHZXQgdGhlIGluZGV4IHBvc2l0aW9uIG9mIHRoZSBnaXZlbiBjaGlsZCBpbiB0aGlzIEdyb3VwLgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRJbmRleAoJKiBAcGFyYW0geyp9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIGdldCB0aGUgaW5kZXggZm9yLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBpbmRleCBvZiB0aGUgY2hpbGQgb3IgLTEgaWYgaXQncyBub3QgYSBtZW1iZXIgb2YgdGhpcyBHcm91cC4KCSovCglnZXRJbmRleDogZnVuY3Rpb24gKGNoaWxkKSB7CgoJCXJldHVybiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4uaW5kZXhPZihjaGlsZCk7CgoJfSwKCgkvKioKCSogUmVwbGFjZXMgYSBjaGlsZCBvZiB0aGlzIEdyb3VwIHdpdGggdGhlIGdpdmVuIG5ld0NoaWxkLiBUaGUgbmV3Q2hpbGQgY2Fubm90IGJlIGEgbWVtYmVyIG9mIHRoaXMgR3JvdXAuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI3JlcGxhY2UKCSogQHBhcmFtIHsqfSBvbGRDaGlsZCAtIFRoZSBjaGlsZCBpbiB0aGlzIEdyb3VwIHRoYXQgd2lsbCBiZSByZXBsYWNlZC4KCSogQHBhcmFtIHsqfSBuZXdDaGlsZCAtIFRoZSBjaGlsZCB0byBiZSBpbnNlcnRlZCBpbnRvIHRoaXMgZ3JvdXAuCgkqLwoJcmVwbGFjZTogZnVuY3Rpb24gKG9sZENoaWxkLCBuZXdDaGlsZCkgewoKCQlpZiAoIXRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCgkJewoJCQlyZXR1cm47CgkJfQoKCQl2YXIgaW5kZXggPSB0aGlzLmdldEluZGV4KG9sZENoaWxkKTsKCQkKCQlpZiAoaW5kZXggIT0gLTEpCgkJewoJCQlpZiAobmV3Q2hpbGQucGFyZW50ICE9IHVuZGVmaW5lZCkKCQkJewoJCQkJbmV3Q2hpbGQuZXZlbnRzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwYXRjaChuZXdDaGlsZCwgdGhpcyk7CgkJCQluZXdDaGlsZC5wYXJlbnQucmVtb3ZlQ2hpbGQobmV3Q2hpbGQpOwoJCQl9CgoJCQl0aGlzLl9jb250YWluZXIucmVtb3ZlQ2hpbGQob2xkQ2hpbGQpOwoJCQl0aGlzLl9jb250YWluZXIuYWRkQ2hpbGRBdChuZXdDaGlsZCwgaW5kZXgpOwoKCQkJbmV3Q2hpbGQuZXZlbnRzLm9uQWRkZWRUb0dyb3VwLmRpc3BhdGNoKG5ld0NoaWxkLCB0aGlzKTsKCQkJbmV3Q2hpbGQudXBkYXRlVHJhbnNmb3JtKCk7CgoJCQlpZiAodGhpcy5jdXJzb3IgPT0gb2xkQ2hpbGQpCgkJCXsKCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKCQkJfQoJCX0KCgl9LAoKCS8qKgogICAgICogU2V0cyB0aGUgZ2l2ZW4gcHJvcGVydHkgdG8gdGhlIGdpdmVuIHZhbHVlIG9uIHRoZSBjaGlsZC4gVGhlIG9wZXJhdGlvbiBjb250cm9scyB0aGUgYXNzaWdubWVudCBvZiB0aGUgdmFsdWUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc2V0UHJvcGVydHkKICAgICAqIEBwYXJhbSB7Kn0gY2hpbGQgLSBUaGUgY2hpbGQgdG8gc2V0IHRoZSBwcm9wZXJ0eSB2YWx1ZSBvbi4KICAgICAqIEBwYXJhbSB7YXJyYXl9IGtleSAtIEFuIGFycmF5IG9mIHN0cmluZ3MgdGhhdCBtYWtlIHVwIHRoZSBwcm9wZXJ0eSB0aGF0IHdpbGwgYmUgc2V0LgogICAgICogQHBhcmFtIHsqfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0aGF0IHdpbGwgYmUgc2V0LgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcGVyYXRpb249MF0gLSBDb250cm9scyBob3cgdGhlIHZhbHVlIGlzIGFzc2lnbmVkLiBBIHZhbHVlIG9mIDAgcmVwbGFjZXMgdGhlIHZhbHVlIHdpdGggdGhlIG5ldyBvbmUuIEEgdmFsdWUgb2YgMSBhZGRzIGl0LCAyIHN1YnRyYWN0cyBpdCwgMyBtdWx0aXBsaWVzIGl0IGFuZCA0IGRpdmlkZXMgaXQuCiAgICAgKi8KCXNldFByb3BlcnR5OiBmdW5jdGlvbiAoY2hpbGQsIGtleSwgdmFsdWUsIG9wZXJhdGlvbikgewoKCQlvcGVyYXRpb24gPSBvcGVyYXRpb24gfHwgMDsKCgkJLy8JQXMgdWdseSBhcyB0aGlzIGFwcHJvYWNoIGxvb2tzLCBhbmQgYWx0aG91Z2ggaXQncyBsaW1pdGVkIHRvIGEgZGVwdGggb2Ygb25seSA0LCBpdCdzIGV4dHJlbWVseSBmYXN0LgoJCS8vCU11Y2ggZmFzdGVyIHRoYW4gYSBmb3IgbG9vcCBvciBvYmplY3QgaXRlcmF0aW9uLiBUaGVyZSBhcmUgbm8gY2hlY2tzLCBzbyBpZiB0aGUga2V5IGlzbid0IHZhbGlkIHRoZW4gaXQnbGwgZmFpbAoJCS8vCWJ1dCBhcyB5b3UgYXJlIGxpa2VseSB0byBjYWxsIHRoaXMgZnJvbSBpbm5lciBsb29wcyB0aGF0IGhhdmUgdG8gcGVyZm9ybSB3ZWxsLCBJJ2xsIHRha2UgdGhhdCB0cmFkZSBvZmYuCgoJCS8vCTAgPSBFcXVhbHMKCQkvLwkxID0gQWRkCgkJLy8JMiA9IFN1YnRyYWN0CgkJLy8JMyA9IE11bHRpcGx5CgkJLy8JNCA9IERpdmlkZQoKCQl2YXIgbGVuID0ga2V5Lmxlbmd0aDsKCgkJaWYgKGxlbiA9PSAxKQoJCXsKCQkJaWYgKG9wZXJhdGlvbiA9PSAwKSB7IGNoaWxkW2tleVswXV0gPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dICs9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAyKSB7IGNoaWxkW2tleVswXV0gLT0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXSAqPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dIC89IHZhbHVlOyB9CgkJfQoJCWVsc2UgaWYgKGxlbiA9PSAyKQoJCXsKCQkJaWYgKG9wZXJhdGlvbiA9PSAwKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSA9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAxKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSArPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMikgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV0gLT0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dICo9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSA0KSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXSAvPSB2YWx1ZTsgfQoJCX0KCQllbHNlIGlmIChsZW4gPT0gMykKCQl7CgkJCWlmIChvcGVyYXRpb24gPT0gMCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXSA9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAxKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dICs9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAyKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dIC09IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAzKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dICo9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSA0KSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dIC89IHZhbHVlOyB9CgkJfQoJCWVsc2UgaWYgKGxlbiA9PSA0KQoJCXsKCQkJaWYgKG9wZXJhdGlvbiA9PSAwKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gMSkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dICs9IHZhbHVlOyB9CgkJCWVsc2UgaWYgKG9wZXJhdGlvbiA9PSAyKSB7IGNoaWxkW2tleVswXV1ba2V5WzFdXVtrZXlbMl1dW2tleVszXV0gLT0gdmFsdWU7IH0KCQkJZWxzZSBpZiAob3BlcmF0aW9uID09IDMpIHsgY2hpbGRba2V5WzBdXVtrZXlbMV1dW2tleVsyXV1ba2V5WzNdXSAqPSB2YWx1ZTsgfQoJCQllbHNlIGlmIChvcGVyYXRpb24gPT0gNCkgeyBjaGlsZFtrZXlbMF1dW2tleVsxXV1ba2V5WzJdXVtrZXlbM11dIC89IHZhbHVlOyB9CgkJfQoJCWVsc2UKCQl7CgkJCS8vCVRPRE8gLSBEZWVwIHByb3BlcnR5IHNjYW5lCgkJfQoKCX0sCgoJLyoqCiAgICAgKiBUaGlzIGZ1bmN0aW9uIGFsbG93cyB5b3UgdG8gcXVpY2tseSBzZXQgdGhlIHNhbWUgcHJvcGVydHkgYWNyb3NzIGFsbCBjaGlsZHJlbiBvZiB0aGlzIEdyb3VwIHRvIGEgbmV3IHZhbHVlLgogICAgICogVGhlIG9wZXJhdGlvbiBwYXJhbWV0ZXIgY29udHJvbHMgaG93IHRoZSBuZXcgdmFsdWUgaXMgYXNzaWduZWQgdG8gdGhlIHByb3BlcnR5LCBmcm9tIHNpbXBsZSByZXBsYWNlbWVudCB0byBhZGRpdGlvbiBhbmQgbXVsdGlwbGljYXRpb24uCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjc2V0QWxsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHByb3BlcnR5LCBhcyBhIHN0cmluZywgdG8gYmUgc2V0LiBGb3IgZXhhbXBsZTogJ2JvZHkudmVsb2NpdHkueCcKICAgICAqIEBwYXJhbSB7Kn0gdmFsdWUgLSBUaGUgdmFsdWUgdGhhdCB3aWxsIGJlIHNldC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2NoZWNrQWxpdmU9ZmFsc2VdIC0gSWYgc2V0IHRoZW4gb25seSBjaGlsZHJlbiB3aXRoIGFsaXZlPXRydWUgd2lsbCBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIHtib29sZWFufSBbY2hlY2tWaXNpYmxlPWZhbHNlXSAtIElmIHNldCB0aGVuIG9ubHkgY2hpbGRyZW4gd2l0aCB2aXNpYmxlPXRydWUgd2lsbCBiZSB1cGRhdGVkLgogICAgICogQHBhcmFtIHtudW1iZXJ9IFtvcGVyYXRpb249MF0gLSBDb250cm9scyBob3cgdGhlIHZhbHVlIGlzIGFzc2lnbmVkLiBBIHZhbHVlIG9mIDAgcmVwbGFjZXMgdGhlIHZhbHVlIHdpdGggdGhlIG5ldyBvbmUuIEEgdmFsdWUgb2YgMSBhZGRzIGl0LCAyIHN1YnRyYWN0cyBpdCwgMyBtdWx0aXBsaWVzIGl0IGFuZCA0IGRpdmlkZXMgaXQuCiAgICAgKi8KCXNldEFsbDogZnVuY3Rpb24gKGtleSwgdmFsdWUsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgb3BlcmF0aW9uKSB7CgoJCWtleSA9IGtleS5zcGxpdCgnLicpOwoKCQlpZiAodHlwZW9mIGNoZWNrQWxpdmUgPT09ICd1bmRlZmluZWQnKSB7IGNoZWNrQWxpdmUgPSBmYWxzZTsgfQoJCWlmICh0eXBlb2YgY2hlY2tWaXNpYmxlID09PSAndW5kZWZpbmVkJykgeyBjaGVja1Zpc2libGUgPSBmYWxzZTsgfQoKCQlvcGVyYXRpb24gPSBvcGVyYXRpb24gfHwgMDsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCgkJewoJCQl2YXIgY3VycmVudE5vZGUgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwoJCQkJCgkJCWRvCQoJCQl7CgkJCQlpZiAoKGNoZWNrQWxpdmUgPT0gZmFsc2UgfHwgKGNoZWNrQWxpdmUgJiYgY3VycmVudE5vZGUuYWxpdmUpKSAmJiAoY2hlY2tWaXNpYmxlID09IGZhbHNlIHx8IChjaGVja1Zpc2libGUgJiYgY3VycmVudE5vZGUudmlzaWJsZSkpKQoJCQkJewoJCQkJCXRoaXMuc2V0UHJvcGVydHkoY3VycmVudE5vZGUsIGtleSwgdmFsdWUsIG9wZXJhdGlvbik7CgkJCQl9CgoJCQkJY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CgkJCX0KCQkJd2hpbGUgKGN1cnJlbnROb2RlICE9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dCkKCQl9CgoJfSwKCgkvKioKICAgICAqIEFkZHMgdGhlIGFtb3VudCB0byB0aGUgZ2l2ZW4gcHJvcGVydHkgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAgKiBHcm91cC5hZGRBbGwoJ3gnLCAxMCkgd2lsbCBhZGQgMTAgdG8gdGhlIGNoaWxkLnggdmFsdWUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjYWRkQWxsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gaW5jcmVtZW50LCBmb3IgZXhhbXBsZSAnYm9keS52ZWxvY2l0eS54JyBvciAnYW5nbGUnLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gaW5jcmVtZW50IHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwIHRoZW4gYWRkQWxsKCd4JywgNDApIHdvdWxkIG1ha2UgY2hpbGQueCA9IDUwLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja1Zpc2libGUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgdmlzaWJsZS4KICAgICAqLwoJYWRkQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgoJCXRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMSk7CgoJfSwKCgkvKioKICAgICAqIFN1YnRyYWN0cyB0aGUgYW1vdW50IGZyb20gdGhlIGdpdmVuIHByb3BlcnR5IG9uIGFsbCBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLgogICAgICogR3JvdXAuc3ViQWxsKCd4JywgMTApIHdpbGwgbWludXMgMTAgZnJvbSB0aGUgY2hpbGQueCB2YWx1ZS4KICAgICAqCiAgICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzdWJBbGwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSAtIFRoZSBwcm9wZXJ0eSB0byBkZWNyZW1lbnQsIGZvciBleGFtcGxlICdib2R5LnZlbG9jaXR5LngnIG9yICdhbmdsZScuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBzdWJ0cmFjdCBmcm9tIHRoZSBwcm9wZXJ0eS4gSWYgY2hpbGQueCA9IDUwIHRoZW4gc3ViQWxsKCd4JywgNDApIHdvdWxkIG1ha2UgY2hpbGQueCA9IDEwLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja1Zpc2libGUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgdmlzaWJsZS4KICAgICAqLwoJc3ViQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgoJCXRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMik7CgoJfSwKCgkvKioKICAgICAqIE11bHRpcGxpZXMgdGhlIGdpdmVuIHByb3BlcnR5IGJ5IHRoZSBhbW91bnQgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAgKiBHcm91cC5tdWx0aXBseUFsbCgneCcsIDIpIHdpbGwgeDIgdGhlIGNoaWxkLnggdmFsdWUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjbXVsdGlwbHlBbGwKICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSAtIFRoZSBwcm9wZXJ0eSB0byBtdWx0aXBseSwgZm9yIGV4YW1wbGUgJ2JvZHkudmVsb2NpdHkueCcgb3IgJ2FuZ2xlJy4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIG11bHRpcGx5IHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwIHRoZW4gbXVsdGlwbHlBbGwoJ3gnLCAyKSB3b3VsZCBtYWtlIGNoaWxkLnggPSAyMC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tBbGl2ZSAtIElmIHRydWUgdGhlIHByb3BlcnR5IHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBjaGlsZCBpcyBhbGl2ZS4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gY2hlY2tWaXNpYmxlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIHZpc2libGUuCiAgICAgKi8KCW11bHRpcGx5QWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgoJCXRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgMyk7CgoJfSwKCgkvKioKICAgICAqIERpdmlkZXMgdGhlIGdpdmVuIHByb3BlcnR5IGJ5IHRoZSBhbW91bnQgb24gYWxsIGNoaWxkcmVuIGluIHRoaXMgR3JvdXAuCiAgICAgKiBHcm91cC5kaXZpZGVBbGwoJ3gnLCAyKSB3aWxsIGhhbGYgdGhlIGNoaWxkLnggdmFsdWUuCiAgICAgKgogICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZGl2aWRlQWxsCiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgLSBUaGUgcHJvcGVydHkgdG8gZGl2aWRlLCBmb3IgZXhhbXBsZSAnYm9keS52ZWxvY2l0eS54JyBvciAnYW5nbGUnLgogICAgICogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gZGl2aWRlIHRoZSBwcm9wZXJ0eSBieS4gSWYgY2hpbGQueCA9IDEwMCB0aGVuIGRpdmlkZUFsbCgneCcsIDIpIHdvdWxkIG1ha2UgY2hpbGQueCA9IDUwLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja0FsaXZlIC0gSWYgdHJ1ZSB0aGUgcHJvcGVydHkgd2lsbCBvbmx5IGJlIGNoYW5nZWQgaWYgdGhlIGNoaWxkIGlzIGFsaXZlLgogICAgICogQHBhcmFtIHtib29sZWFufSBjaGVja1Zpc2libGUgLSBJZiB0cnVlIHRoZSBwcm9wZXJ0eSB3aWxsIG9ubHkgYmUgY2hhbmdlZCBpZiB0aGUgY2hpbGQgaXMgdmlzaWJsZS4KICAgICAqLwoJZGl2aWRlQWxsOiBmdW5jdGlvbiAocHJvcGVydHksIGFtb3VudCwgY2hlY2tBbGl2ZSwgY2hlY2tWaXNpYmxlKSB7CgoJCXRoaXMuc2V0QWxsKHByb3BlcnR5LCBhbW91bnQsIGNoZWNrQWxpdmUsIGNoZWNrVmlzaWJsZSwgNCk7CgoJfSwKCgkvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgb2YgdGhlIGNoaWxkcmVuIHRoYXQgaGF2ZSBleGlzdHM9dHJ1ZSBpbiB0aGlzIEdyb3VwLgogICAgKiBBZnRlciB0aGUgZXhpc3RzVmFsdWUgcGFyYW1ldGVyIHlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjaGlsZCBjYWxsYmFjay4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NhbGxBbGxFeGlzdHMKICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgZnVuY3Rpb24gdGhhdCBleGlzdHMgb24gdGhlIGNoaWxkcmVuIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZXhpc3RzVmFsdWUgLSBPbmx5IGNoaWxkcmVuIHdpdGggZXhpc3RzPWV4aXN0c1ZhbHVlIHdpbGwgYmUgY2FsbGVkLgogICAgKiBAcGFyYW0gey4uLip9IHBhcmFtZXRlciAtIEFkZGl0aW9uYWwgcGFyYW1ldGVycyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjay4KICAgICovCgljYWxsQWxsRXhpc3RzOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGV4aXN0c1ZhbHVlKSB7CgoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgoJCWlmICh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID4gMCAmJiB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQoJCXsKCQkJdmFyIGN1cnJlbnROb2RlID0gdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dDsKCQkJCQoJCQlkbwkKCQkJewoJCQkJaWYgKGN1cnJlbnROb2RlLmV4aXN0cyA9PSBleGlzdHNWYWx1ZSAmJiBjdXJyZW50Tm9kZVtjYWxsYmFja10pCgkJCQl7CgkJCQkJY3VycmVudE5vZGVbY2FsbGJhY2tdLmFwcGx5KGN1cnJlbnROb2RlLCBhcmdzKTsKCQkJCX0KCgkJCQljdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKCQkJfQoJCQl3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KQoKCQl9CgoJfSwKCgkvKioKICAgICogQ2FsbHMgYSBmdW5jdGlvbiBvbiBhbGwgb2YgdGhlIGNoaWxkcmVuIHRoYXQgaGF2ZSBleGlzdHM9dHJ1ZSBpbiB0aGlzIEdyb3VwLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY2FsbGJhY2tGcm9tQXJyYXkKICAgICogQHBhcmFtIHtvYmplY3R9IGNoaWxkIC0gVGhlIG9iamVjdCB0byBpbnNwZWN0LgogICAgKiBAcGFyYW0ge2FycmF5fSBjYWxsYmFjayAtIFRoZSBhcnJheSBvZiBmdW5jdGlvbiBuYW1lcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBzaXplIG9mIHRoZSBhcnJheSAocHJlLWNhbGN1bGF0ZWQgaW4gY2FsbEFsbCkuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCgljYWxsYmFja0Zyb21BcnJheTogZnVuY3Rpb24gKGNoaWxkLCBjYWxsYmFjaywgbGVuZ3RoKSB7CgoJCS8vCUtpbmRhIGxvb2tzIGxpa2UgYSBDaHJpc3RtYXMgdHJlZQoKCQlpZiAobGVuZ3RoID09IDEpCgkJewoJCQlpZiAoY2hpbGRbY2FsbGJhY2tbMF1dKQoJCQl7CgkJCQlyZXR1cm4gY2hpbGRbY2FsbGJhY2tbMF1dOwoJCQl9CgkJfQoJCWVsc2UgaWYgKGxlbmd0aCA9PSAyKQoJCXsKCQkJaWYgKGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV0pCgkJCXsKCQkJCXJldHVybiBjaGlsZFtjYWxsYmFja1swXV1bY2FsbGJhY2tbMV1dOwoJCQl9CgkJfQoJCWVsc2UgaWYgKGxlbmd0aCA9PSAzKQoJCXsKCQkJaWYgKGNoaWxkW2NhbGxiYWNrWzBdXVtjYWxsYmFja1sxXV1bY2FsbGJhY2tbMl1dKQoJCQl7CgkJCQlyZXR1cm4gY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXVtjYWxsYmFja1syXV07CgkJCX0KCQl9CgkJZWxzZSBpZiAobGVuZ3RoID09IDQpCgkJewoJCQlpZiAoY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXVtjYWxsYmFja1syXV1bY2FsbGJhY2tbM11dKQoJCQl7CgkJCQlyZXR1cm4gY2hpbGRbY2FsbGJhY2tbMF1dW2NhbGxiYWNrWzFdXVtjYWxsYmFja1syXV1bY2FsbGJhY2tbM11dOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCWlmIChjaGlsZFtjYWxsYmFja10pCgkJCXsKCQkJCXJldHVybiBjaGlsZFtjYWxsYmFja107CgkJCX0KCQl9CgoJCXJldHVybiBmYWxzZTsKCgl9LAoKCS8qKgogICAgKiBDYWxscyBhIGZ1bmN0aW9uIG9uIGFsbCBvZiB0aGUgY2hpbGRyZW4gcmVnYXJkbGVzcyBpZiB0aGV5IGFyZSBkZWFkIG9yIGFsaXZlIChzZWUgY2FsbEFsbEV4aXN0cyBpZiB5b3UgbmVlZCBjb250cm9sIG92ZXIgdGhhdCkKICAgICogQWZ0ZXIgdGhlIG1ldGhvZCBwYXJhbWV0ZXIgYW5kIGNvbnRleHQgeW91IGNhbiBhZGQgYXMgbWFueSBleHRyYSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNoaWxkLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY2FsbEFsbAogICAgKiBAcGFyYW0ge3N0cmluZ30gbWV0aG9kIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgbmFtZSBvZiB0aGUgZnVuY3Rpb24gdGhhdCB3aWxsIGJlIGNhbGxlZC4gVGhlIGZ1bmN0aW9uIG11c3QgZXhpc3Qgb24gdGhlIGNoaWxkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbnRleHQ9JyddIC0gQSBzdHJpbmcgY29udGFpbmluZyB0aGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgbWV0aG9kIHdpbGwgYmUgZXhlY3V0ZWQuIExlYXZlIHRvICcnIHRvIGRlZmF1bHQgdG8gdGhlIGNoaWxkLgogICAgKiBAcGFyYW0gey4uLip9IHBhcmFtZXRlciAtIEFkZGl0aW9uYWwgcGFyYW1ldGVycyB0aGF0IHdpbGwgYmUgcGFzc2VkIHRvIHRoZSBtZXRob2QuCiAgICAqLwoJY2FsbEFsbDogZnVuY3Rpb24gKG1ldGhvZCwgY29udGV4dCkgewoKCQlpZiAodHlwZW9mIG1ldGhvZCA9PT0gJ3VuZGVmaW5lZCcpCgkJewoJCQlyZXR1cm47CgkJfQoKCQkvLwlFeHRyYWN0IHRoZSBtZXRob2QgaW50byBhbiBhcnJheQoJCW1ldGhvZCA9IG1ldGhvZC5zcGxpdCgnLicpOwoKCQl2YXIgbWV0aG9kTGVuZ3RoID0gbWV0aG9kLmxlbmd0aDsKCgkJaWYgKHR5cGVvZiBjb250ZXh0ID09PSAndW5kZWZpbmVkJykKCQl7CgkJCWNvbnRleHQgPSBudWxsOwoJCX0KCQllbHNlCgkJewoJCQkvLwlFeHRyYWN0IHRoZSBjb250ZXh0IGludG8gYW4gYXJyYXkKCQkJaWYgKHR5cGVvZiBjb250ZXh0ID09PSAnc3RyaW5nJykKCQkJewoJCQkJY29udGV4dCA9IGNvbnRleHQuc3BsaXQoJy4nKTsKCQkJCXZhciBjb250ZXh0TGVuZ3RoID0gY29udGV4dC5sZW5ndGg7CgkJCX0KCQl9CgoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkJdmFyIGNhbGxiYWNrID0gbnVsbDsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwICYmIHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQpCgkJewoJCQl2YXIgY2hpbGQgPSB0aGlzLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwoJCQkJCgkJCWRvCQoJCQl7CgkJCQljYWxsYmFjayA9IHRoaXMuY2FsbGJhY2tGcm9tQXJyYXkoY2hpbGQsIG1ldGhvZCwgbWV0aG9kTGVuZ3RoKTsKCgkJCQlpZiAoY29udGV4dCAmJiBjYWxsYmFjaykKCQkJCXsKCQkJCQljYWxsYmFja0NvbnRleHQgPSB0aGlzLmNhbGxiYWNrRnJvbUFycmF5KGNoaWxkLCBjb250ZXh0LCBjb250ZXh0TGVuZ3RoKTsKCQoJCQkJCWlmIChjYWxsYmFjaykKCQkJCQl7CgkJCQkJCWNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgkJCQkJfQoJCQkJfQoJCQkJZWxzZSBpZiAoY2FsbGJhY2spCgkJCQl7CgkJCQkJY2FsbGJhY2suYXBwbHkoY2hpbGQsIGFyZ3MpOwoJCQkJfQoKCQkJCWNoaWxkID0gY2hpbGQuX2lOZXh0OwoJCQl9CgkJCXdoaWxlIChjaGlsZCAhPSB0aGlzLl9jb250YWluZXIubGFzdC5faU5leHQpCgoJCX0KCgl9LAoKCS8qKgoJKiBBbGxvd3MgeW91IHRvIGNhbGwgeW91ciBvd24gZnVuY3Rpb24gb24gZWFjaCBtZW1iZXIgb2YgdGhpcyBHcm91cC4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgIAkqIEFmdGVyIHRoZSBjaGVja0V4aXN0cyBwYXJhbWV0ZXIgeW91IGNhbiBhZGQgYXMgbWFueSBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLgogICAJKiBGb3IgZXhhbXBsZTogR3JvdXAuZm9yRWFjaChhd2FyZEJvbnVzR29sZCwgdGhpcywgdHJ1ZSwgMTAwLCA1MDApCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNmb3JFYWNoCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGNoZWNrRXhpc3RzIC0gSWYgc2V0IG9ubHkgY2hpbGRyZW4gd2l0aCBleGlzdHM9dHJ1ZSB3aWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2ssIG90aGVyd2lzZSBhbGwgY2hpbGRyZW4gd2lsbCBiZSBwYXNzZWQuCgkqLwoJZm9yRWFjaDogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGNoZWNrRXhpc3RzKSB7CgoJCWlmICh0eXBlb2YgY2hlY2tFeGlzdHMgPT09ICd1bmRlZmluZWQnKQoJCXsKCQkJY2hlY2tFeGlzdHMgPSBmYWxzZTsKCQl9CgoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMyk7CgkJYXJncy51bnNoaWZ0KG51bGwpOwoKCQlpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKCQl7CgkJCXZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CgkJCQkKCQkJZG8JCgkJCXsKCQkJCWlmIChjaGVja0V4aXN0cyA9PSBmYWxzZSB8fCAoY2hlY2tFeGlzdHMgJiYgY3VycmVudE5vZGUuZXhpc3RzKSkKCQkJCXsKCQkJCQlhcmdzWzBdID0gY3VycmVudE5vZGU7CgkJCQkJY2FsbGJhY2suYXBwbHkoY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCQkJCX0KCgkJCQljdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKCQkJfQoJCQl3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKCgkJfQoKCX0sCgoJLyoqCgkqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIGFsaXZlIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBjaGlsZC5hbGl2ZT10cnVlKS4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgIAkqIFlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgCSogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2hBbGl2ZShjYXVzZURhbWFnZSwgdGhpcywgNTAwKQoJKiAKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaEFsaXZlCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgoJKi8KCWZvckVhY2hFeGlzdHM6IGZ1bmN0aW9uIChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgoJCXZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNwbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgkJYXJncy51bnNoaWZ0KG51bGwpOwoKCQl0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpOwoKCX0sCgoJLyoqCgkqIEFsbG93cyB5b3UgdG8gY2FsbCB5b3VyIG93biBmdW5jdGlvbiBvbiBlYWNoIGFsaXZlIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBjaGlsZC5hbGl2ZT10cnVlKS4gWW91IG11c3QgcGFzcyB0aGUgY2FsbGJhY2sgYW5kIGNvbnRleHQgaW4gd2hpY2ggaXQgd2lsbCBydW4uCiAgIAkqIFlvdSBjYW4gYWRkIGFzIG1hbnkgcGFyYW1ldGVycyBhcyB5b3UgbGlrZSwgd2hpY2ggd2lsbCBhbGwgYmUgcGFzc2VkIHRvIHRoZSBjYWxsYmFjayBhbG9uZyB3aXRoIHRoZSBjaGlsZC4KICAgCSogRm9yIGV4YW1wbGU6IEdyb3VwLmZvckVhY2hBbGl2ZShjYXVzZURhbWFnZSwgdGhpcywgNTAwKQoJKiAKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZm9yRWFjaEFsaXZlCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgoJKi8KCWZvckVhY2hBbGl2ZTogZnVuY3Rpb24gKGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCgkJdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc3BsaWNlLmNhbGwoYXJndW1lbnRzLCAyKTsKCQlhcmdzLnVuc2hpZnQobnVsbCk7CgoJCXRoaXMuaXRlcmF0ZSgnYWxpdmUnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCgl9LAoKCS8qKgoJKiBBbGxvd3MgeW91IHRvIGNhbGwgeW91ciBvd24gZnVuY3Rpb24gb24gZWFjaCBkZWFkIG1lbWJlciBvZiB0aGlzIEdyb3VwICh3aGVyZSBhbGl2ZT1mYWxzZSkuIFlvdSBtdXN0IHBhc3MgdGhlIGNhbGxiYWNrIGFuZCBjb250ZXh0IGluIHdoaWNoIGl0IHdpbGwgcnVuLgogICAJKiBZb3UgY2FuIGFkZCBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UsIHdoaWNoIHdpbGwgYWxsIGJlIHBhc3NlZCB0byB0aGUgY2FsbGJhY2sgYWxvbmcgd2l0aCB0aGUgY2hpbGQuCiAgIAkqIEZvciBleGFtcGxlOiBHcm91cC5mb3JFYWNoRGVhZChicmluZ1RvTGlmZSwgdGhpcykKCSogCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2ZvckVhY2hEZWFkCgkqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIC0gVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBjYWxsZWQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgZnVuY3Rpb24gc2hvdWxkIGJlIGNhbGxlZCAodXN1YWxseSAndGhpcycpLgoJKi8KCWZvckVhY2hEZWFkOiBmdW5jdGlvbiAoY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKCQl2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDIpOwoJCWFyZ3MudW5zaGlmdChudWxsKTsKCgkJdGhpcy5pdGVyYXRlKCdhbGl2ZScsIGZhbHNlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMLCBjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0LCBhcmdzKTsKCgl9LAoKCS8qKgoJKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gc29ydCB0aGUgZ3JvdXAgYWNjb3JkaW5nIHRvIGEgcGFydGljdWxhciB2YWx1ZSBhbmQgb3JkZXIuCgkqIEZvciBleGFtcGxlIHRvIGRlcHRoIHNvcnQgU3ByaXRlcyBmb3IgWmVsZGEtc3R5bGUgZ2FtZSB5b3UgbWlnaHQgY2FsbCBgZ3JvdXAuc29ydCgneScsIFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORylgIGF0IHRoZSBib3R0b20gb2YgeW91ciBgU3RhdGUudXBkYXRlKClgLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNzb3J0CgkqIEBwYXJhbSB7c3RyaW5nfSBbaW5kZXg9J3knXSAtIFRoZSBgc3RyaW5nYCBuYW1lIG9mIHRoZSBwcm9wZXJ0eSB5b3Ugd2FudCB0byBzb3J0IG9uLgoJKiBAcGFyYW0ge251bWJlcn0gW29yZGVyPVBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElOR10gLSBUaGUgYEdyb3VwYCBjb25zdGFudCB0aGF0IGRlZmluZXMgdGhlIHNvcnQgb3JkZXIuIFBvc3NpYmxlIHZhbHVlcyBhcmUgUGhhc2VyLkdyb3VwLlNPUlRfQVNDRU5ESU5HIGFuZCBQaGFzZXIuR3JvdXAuU09SVF9ERVNDRU5ESU5HLgoJKi8KCXNvcnQ6IGZ1bmN0aW9uIChpbmRleCwgb3JkZXIpIHsKCgkJaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpIHsgaW5kZXggPSAneSc7IH0KCQlpZiAodHlwZW9mIG9yZGVyID09PSAndW5kZWZpbmVkJykgeyBvcmRlciA9IFBoYXNlci5Hcm91cC5TT1JUX0FTQ0VORElORzsgfQoKCQl2YXIgc3dhcHBlZDsKCQl2YXIgdGVtcDsKCgkgICAgZG8gewoKCSAgICAgICAgc3dhcHBlZCA9IGZhbHNlOwoKCSAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggLSAxOyBpIDwgbGVuOyBpKyspCgkgICAgICAgIHsKCSAgICAgICAgCWlmIChvcmRlciA9PSBQaGFzZXIuR3JvdXAuU09SVF9BU0NFTkRJTkcpCgkgICAgICAgIAl7CgkJICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXVtpbmRleF0gPiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdW2luZGV4XSkKCQkgICAgICAgICAgICB7CgkJICAgICAgICAgICAgCXRoaXMuc3dhcCh0aGlzLmdldEF0KGkpLCB0aGlzLmdldEF0KGkgKyAxKSk7CgkJICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV07CgkJICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXSA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV07CgkJICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV0gPSB0ZW1wOwoJCSAgICAgICAgICAgICAgICBzd2FwcGVkID0gdHJ1ZTsKCQkgICAgICAgICAgICB9CgkgICAgICAgIAl9CgkgICAgICAgIAllbHNlCgkgICAgICAgIAl7CgkJICAgICAgICAgICAgaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXVtpbmRleF0gPCB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baSArIDFdW2luZGV4XSkKCQkgICAgICAgICAgICB7CgkJICAgICAgICAgICAgCXRoaXMuc3dhcCh0aGlzLmdldEF0KGkpLCB0aGlzLmdldEF0KGkgKyAxKSk7CgkJICAgICAgICAgICAgICAgIHRlbXAgPSB0aGlzLl9jb250YWluZXIuY2hpbGRyZW5baV07CgkJICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpXSA9IHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV07CgkJICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbltpICsgMV0gPSB0ZW1wOwoJCSAgICAgICAgICAgICAgICBzd2FwcGVkID0gdHJ1ZTsKCQkgICAgICAgICAgICB9CgkgICAgICAgIAl9CgkgICAgICAgIH0KCSAgICB9IHdoaWxlIChzd2FwcGVkKTsKCgl9LAoKCS8qKgoJKiBJdGVyYXRlcyBvdmVyIHRoZSBjaGlsZHJlbiBvZiB0aGUgR3JvdXAuIFdoZW4gYSBjaGlsZCBoYXMgYSBwcm9wZXJ0eSBtYXRjaGluZyBrZXkgdGhhdCBlcXVhbHMgdGhlIGdpdmVuIHZhbHVlLCBpdCBpcyBjb25zaWRlcmVkIGFzIGEgbWF0Y2guCgkqIE1hdGNoZWQgY2hpbGRyZW4gY2FuIGJlIHNlbnQgdG8gdGhlIG9wdGlvbmFsIGNhbGxiYWNrLCBvciBzaW1wbHkgcmV0dXJuZWQgb3IgY291bnRlZC4KICAgCSogWW91IGNhbiBhZGQgYXMgbWFueSBjYWxsYmFjayBwYXJhbWV0ZXJzIGFzIHlvdSBsaWtlLCB3aGljaCB3aWxsIGFsbCBiZSBwYXNzZWQgdG8gdGhlIGNhbGxiYWNrIGFsb25nIHdpdGggdGhlIGNoaWxkLCBhZnRlciB0aGUgY2FsbGJhY2tDb250ZXh0IHBhcmFtZXRlci4KCSogCgkqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2l0ZXJhdGUKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBjaGlsZCBwcm9wZXJ0eSB0byBjaGVjaywgaS5lLiAnZXhpc3RzJywgJ2FsaXZlJywgJ2hlYWx0aCcKCSogQHBhcmFtIHthbnl9IHZhbHVlIC0gSWYgY2hpbGQua2V5ID09PSB0aGlzIHZhbHVlIGl0IHdpbGwgYmUgY29uc2lkZXJlZCBhIG1hdGNoLiBOb3RlIHRoYXQgYSBzdHJpY3QgY29tcGFyaXNvbiBpcyB1c2VkLgoJKiBAcGFyYW0ge251bWJlcn0gcmV0dXJuVHlwZSAtIEhvdyB0byByZXR1cm4gdGhlIGRhdGEgZnJvbSB0aGlzIG1ldGhvZC4gRWl0aGVyIFBoYXNlci5Hcm91cC5SRVRVUk5fTk9ORSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCBvciBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxELgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBbY2FsbGJhY2s9bnVsbF0gLSBPcHRpb25hbCBmdW5jdGlvbiB0aGF0IHdpbGwgYmUgY2FsbGVkIG9uIGVhY2ggbWF0Y2hpbmcgY2hpbGQuIEVhY2ggY2hpbGQgb2YgdGhlIEdyb3VwIHdpbGwgYmUgcGFzc2VkIHRvIGl0IGFzIGl0cyBmaXJzdCBwYXJhbWV0ZXIuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSAtIFRoZSBjb250ZXh0IGluIHdoaWNoIHRoZSBmdW5jdGlvbiBzaG91bGQgYmUgY2FsbGVkICh1c3VhbGx5ICd0aGlzJykuCgkqLwoJaXRlcmF0ZTogZnVuY3Rpb24gKGtleSwgdmFsdWUsIHJldHVyblR5cGUsIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIGFyZ3MpIHsKCgkJaWYgKHJldHVyblR5cGUgPT0gUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCAmJiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoID09IDApCgkJewoJCQlyZXR1cm4gLTE7CgkJfQoKCQlpZiAodHlwZW9mIGNhbGxiYWNrID09PSAndW5kZWZpbmVkJykKCQl7CgkJCWNhbGxiYWNrID0gZmFsc2U7CgkJfQoKCQl2YXIgdG90YWwgPSAwOwoKCQlpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aCA+IDAgJiYgdGhpcy5fY29udGFpbmVyLmZpcnN0Ll9pTmV4dCkKCQl7CgkJCXZhciBjdXJyZW50Tm9kZSA9IHRoaXMuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CgkJCQkKCQkJZG8JCgkJCXsKCQkJCWlmIChjdXJyZW50Tm9kZVtrZXldID09PSB2YWx1ZSkKCQkJCXsKCQkJCQl0b3RhbCsrOwoKCQkJCQlpZiAoY2FsbGJhY2spCgkJCQkJewoJCQkJCQlhcmdzWzBdID0gY3VycmVudE5vZGU7CgkJCQkJCWNhbGxiYWNrLmFwcGx5KGNhbGxiYWNrQ29udGV4dCwgYXJncyk7CgkJCQkJfQoKCQkJCQlpZiAocmV0dXJuVHlwZSA9PSBQaGFzZXIuR3JvdXAuUkVUVVJOX0NISUxEKQoJCQkJCXsKCQkJCQkJcmV0dXJuIGN1cnJlbnROb2RlOwoJCQkJCX0KCQkJCX0KCgkJCQljdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLl9pTmV4dDsKCQkJfQoJCQl3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKCQl9CgoJCWlmIChyZXR1cm5UeXBlID09IFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwpCgkJewoJCQlyZXR1cm4gdG90YWw7CgkJfQoJCWVsc2UgaWYgKHJldHVyblR5cGUgPT0gUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCkKCQl7CgkJCXJldHVybiBudWxsOwoJCX0KCgl9LAoKCS8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gcmV0cmlldmUgdGhlIGZpcnN0IG9iamVjdCB3aXRoIGV4aXN0cyA9PSAodGhlIGdpdmVuIHN0YXRlKSBpbiB0aGUgR3JvdXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2dldEZpcnN0RXhpc3RzCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gc3RhdGUgLSBUcnVlIG9yIGZhbHNlLgogICAgKiBAcmV0dXJuIHtBbnl9IFRoZSBmaXJzdCBjaGlsZCwgb3IgbnVsbCBpZiBub25lIGZvdW5kLgogICAgKi8KCWdldEZpcnN0RXhpc3RzOiBmdW5jdGlvbiAoc3RhdGUpIHsKCgkJaWYgKHR5cGVvZiBzdGF0ZSAhPT0gJ2Jvb2xlYW4nKQoJCXsKCQkJc3RhdGUgPSB0cnVlOwoJCX0KCgkJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnZXhpc3RzJywgc3RhdGUsIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpOwoKCX0sCgoJLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgZmlyc3Qgb2JqZWN0IHdpdGggYWxpdmUgPT0gdHJ1ZSBpbiB0aGUgZ3JvdXAuCiAgICAqIFRoaXMgaXMgaGFuZHkgZm9yIGNoZWNraW5nIGlmIGV2ZXJ5dGhpbmcgaGFzIGJlZW4gd2lwZWQgb3V0LCBvciBjaG9vc2luZyBhIHNxdWFkIGxlYWRlciwgZXRjLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNnZXRGaXJzdEFsaXZlCiAgICAqIEByZXR1cm4ge0FueX0gVGhlIGZpcnN0IGFsaXZlIGNoaWxkLCBvciBudWxsIGlmIG5vbmUgZm91bmQuCiAgICAqLwoJZ2V0Rmlyc3RBbGl2ZTogZnVuY3Rpb24gKCkgewoKCQlyZXR1cm4gdGhpcy5pdGVyYXRlKCdhbGl2ZScsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fQ0hJTEQpOwoKCX0sCgoJLyoqCiAgICAqIENhbGwgdGhpcyBmdW5jdGlvbiB0byByZXRyaWV2ZSB0aGUgZmlyc3Qgb2JqZWN0IHdpdGggYWxpdmUgPT0gZmFsc2UgaW4gdGhlIGdyb3VwLgogICAgKiBUaGlzIGlzIGhhbmR5IGZvciBjaGVja2luZyBpZiBldmVyeXRoaW5nIGhhcyBiZWVuIHdpcGVkIG91dCwgb3IgY2hvb3NpbmcgYSBzcXVhZCBsZWFkZXIsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0Rmlyc3REZWFkCiAgICAqIEByZXR1cm4ge0FueX0gVGhlIGZpcnN0IGRlYWQgY2hpbGQsIG9yIG51bGwgaWYgbm9uZSBmb3VuZC4KICAgICovCglnZXRGaXJzdERlYWQ6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCBmYWxzZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9DSElMRCk7CgoJfSwKCgkvKioKICAgICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIGZpbmQgb3V0IGhvdyBtYW55IG1lbWJlcnMgb2YgdGhlIGdyb3VwIGFyZSBhbGl2ZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjY291bnRMaXZpbmcKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIGNoaWxkcmVuIGZsYWdnZWQgYXMgYWxpdmUuIFJldHVybnMgLTEgaWYgR3JvdXAgaXMgZW1wdHkuCiAgICAqLwoJY291bnRMaXZpbmc6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnYWxpdmUnLCB0cnVlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKCgl9LAoKCS8qKgogICAgKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gZmluZCBvdXQgaG93IG1hbnkgbWVtYmVycyBvZiB0aGUgZ3JvdXAgYXJlIGRlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdyb3VwI2NvdW50RGVhZAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgY2hpbGRyZW4gZmxhZ2dlZCBhcyBkZWFkLiBSZXR1cm5zIC0xIGlmIEdyb3VwIGlzIGVtcHR5LgogICAgKi8KCWNvdW50RGVhZDogZnVuY3Rpb24gKCkgewoKCQlyZXR1cm4gdGhpcy5pdGVyYXRlKCdhbGl2ZScsIGZhbHNlLCBQaGFzZXIuR3JvdXAuUkVUVVJOX1RPVEFMKTsKCgl9LAoKCS8qKgogICAgKiBSZXR1cm5zIGEgbWVtYmVyIGF0IHJhbmRvbSBmcm9tIHRoZSBncm91cC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZ2V0UmFuZG9tCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gT3B0aW9uYWwgb2Zmc2V0IG9mZiB0aGUgZnJvbnQgb2YgdGhlIGFycmF5LiBEZWZhdWx0IHZhbHVlIGlzIDAsIG9yIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5LgogICAgKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gT3B0aW9uYWwgcmVzdHJpY3Rpb24gb24gdGhlIG51bWJlciBvZiB2YWx1ZXMgeW91IHdhbnQgdG8gcmFuZG9tbHkgc2VsZWN0IGZyb20uCiAgICAqIEByZXR1cm4ge0FueX0gQSByYW5kb20gY2hpbGQgb2YgdGhpcyBHcm91cC4KICAgICovCglnZXRSYW5kb206IGZ1bmN0aW9uIChzdGFydEluZGV4LCBsZW5ndGgpIHsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT0gMCkKCQl7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJc3RhcnRJbmRleCA9IHN0YXJ0SW5kZXggfHwgMDsKCQlsZW5ndGggPSBsZW5ndGggfHwgdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuLmxlbmd0aDsKCiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5tYXRoLmdldFJhbmRvbSh0aGlzLl9jb250YWluZXIuY2hpbGRyZW4sIHN0YXJ0SW5kZXgsIGxlbmd0aCk7CgoJfSwKCgkvKioKCSogUmVtb3ZlcyB0aGUgZ2l2ZW4gY2hpbGQgZnJvbSB0aGlzIEdyb3VwIGFuZCBzZXRzIGl0cyBncm91cCBwcm9wZXJ0eSB0byBudWxsLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZW1vdmUKCSogQHBhcmFtIHtBbnl9IGNoaWxkIC0gVGhlIGNoaWxkIHRvIHJlbW92ZS4KCSovCglyZW1vdmU6IGZ1bmN0aW9uIChjaGlsZCkgewoKCQlpZiAoY2hpbGQuZXZlbnRzKQoJCXsKCQkJY2hpbGQuZXZlbnRzLm9uUmVtb3ZlZEZyb21Hcm91cC5kaXNwYXRjaChjaGlsZCwgdGhpcyk7CgkJfQoKCQl0aGlzLl9jb250YWluZXIucmVtb3ZlQ2hpbGQoY2hpbGQpOwoKCQlpZiAodGhpcy5jdXJzb3IgPT0gY2hpbGQpCgkJewoJCQlpZiAodGhpcy5fY29udGFpbmVyLl9pTmV4dCkKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSB0aGlzLl9jb250YWluZXIuX2lOZXh0OwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5jdXJzb3IgPSBudWxsOwoJCQl9CgkJfQoKCQljaGlsZC5ncm91cCA9IG51bGw7CgoJfSwKCgkvKioKCSogUmVtb3ZlcyBhbGwgY2hpbGRyZW4gZnJvbSB0aGlzIEdyb3VwLCBzZXR0aW5nIGFsbCBncm91cCBwcm9wZXJ0aWVzIHRvIG51bGwuCgkqIFRoZSBHcm91cCBjb250YWluZXIgcmVtYWlucyBvbiB0aGUgZGlzcGxheSBsaXN0LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZW1vdmVBbGwKCSovCglyZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT0gMCkKCQl7CgkJCXJldHVybjsKCQl9CgoJCWRvCgkJewoJCQlpZiAodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLmV2ZW50cykKCQkJewoJCQkJdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLmV2ZW50cy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcGF0Y2godGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdLCB0aGlzKTsKCQkJfQoJCQl0aGlzLl9jb250YWluZXIucmVtb3ZlQ2hpbGQodGhpcy5fY29udGFpbmVyLmNoaWxkcmVuWzBdKTsKCQl9CgkJd2hpbGUgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPiAwKTsKCgkJdGhpcy5jdXJzb3IgPSBudWxsOwoKCX0sCgoJLyoqCgkqIFJlbW92ZXMgYWxsIGNoaWxkcmVuIGZyb20gdGhpcyBHcm91cCB3aG9zIGluZGV4IGZhbGxzIGJldGVlbiB0aGUgZ2l2ZW4gc3RhcnRJbmRleCBhbmQgZW5kSW5kZXggdmFsdWVzLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Hcm91cCNyZW1vdmVCZXR3ZWVuCgkqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gVGhlIGluZGV4IHRvIHN0YXJ0IHJlbW92aW5nIGNoaWxkcmVuIGZyb20uCgkqIEBwYXJhbSB7bnVtYmVyfSBlbmRJbmRleCAtIFRoZSBpbmRleCB0byBzdG9wIHJlbW92aW5nIGNoaWxkcmVuIGZyb20uIE11c3QgYmUgaGlnaGVyIHRoYW4gc3RhcnRJbmRleCBhbmQgbGVzcyB0aGFuIHRoZSBsZW5ndGggb2YgdGhlIEdyb3VwLgoJKi8JCglyZW1vdmVCZXR3ZWVuOiBmdW5jdGlvbiAoc3RhcnRJbmRleCwgZW5kSW5kZXgpIHsKCgkJaWYgKHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGggPT0gMCkKCQl7CgkJCXJldHVybjsKCQl9CgoJCWlmIChzdGFydEluZGV4ID4gZW5kSW5kZXggfHwgc3RhcnRJbmRleCA8IDAgfHwgZW5kSW5kZXggPiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJZm9yICh2YXIgaSA9IHN0YXJ0SW5kZXg7IGkgPCBlbmRJbmRleDsgaSsrKQoJCXsKCQkJdmFyIGNoaWxkID0gdGhpcy5fY29udGFpbmVyLmNoaWxkcmVuW2ldOwoJCQljaGlsZC5ldmVudHMub25SZW1vdmVkRnJvbUdyb3VwLmRpc3BhdGNoKGNoaWxkLCB0aGlzKTsKCQkJdGhpcy5fY29udGFpbmVyLnJlbW92ZUNoaWxkKGNoaWxkKTsKCQoJCQlpZiAodGhpcy5jdXJzb3IgPT0gY2hpbGQpCgkJCXsKCQkJCWlmICh0aGlzLl9jb250YWluZXIuX2lOZXh0KQoJCQkJewoJCQkJCXRoaXMuY3Vyc29yID0gdGhpcy5fY29udGFpbmVyLl9pTmV4dDsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQl0aGlzLmN1cnNvciA9IG51bGw7CgkJCQl9CgkJCX0KCQl9CgoJfSwKCgkvKioKCSogRGVzdHJveXMgdGhpcyBHcm91cC4gUmVtb3ZlcyBhbGwgY2hpbGRyZW4sIHRoZW4gcmVtb3ZlcyB0aGUgY29udGFpbmVyIGZyb20gdGhlIGRpc3BsYXkgbGlzdCBhbmQgbnVsbHMgcmVmZXJlbmNlcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZGVzdHJveQoJKi8KCWRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5yZW1vdmVBbGwoKTsKCgkJdGhpcy5fY29udGFpbmVyLnBhcmVudC5yZW1vdmVDaGlsZCh0aGlzLl9jb250YWluZXIpOwoKCQl0aGlzLl9jb250YWluZXIgPSBudWxsOwoKCQl0aGlzLmdhbWUgPSBudWxsOwoKCQl0aGlzLmV4aXN0cyA9IGZhbHNlOwoKCQl0aGlzLmN1cnNvciA9IG51bGw7CgoJfSwKCgl2YWxpZGF0ZTogZnVuY3Rpb24gKCkgewoKCQl2YXIgdGVzdE9iamVjdCA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UubGFzdC5faU5leHQ7CgkJdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwoJCXZhciBuZXh0T2JqZWN0ID0gbnVsbDsKCQl2YXIgcHJldk9iamVjdCA9IG51bGw7CgkJdmFyIGNvdW50ID0gMDsKCgkJZG8JCgkJewoJCQlpZiAoY291bnQgPiAwKQoJCQl7CgkJCQkvLwljaGVjayBuZXh0CgkJCQlpZiAoZGlzcGxheU9iamVjdCAhPT0gbmV4dE9iamVjdCkKCQkJCXsKCQkJCQljb25zb2xlLmxvZygnY2hlY2sgbmV4dCBmYWlsJyk7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCS8vCWNoZWNrIHByZXZpb3VzCgkJCQlpZiAoZGlzcGxheU9iamVjdC5faVByZXYgIT09IHByZXZPYmplY3QpCgkJCQl7CgkJCQkJY29uc29sZS5sb2coJ2NoZWNrIHByZXZpb3VzIGZhaWwnKTsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCgkJCS8vCVNldCB0aGUgbmV4dCBvYmplY3QKCQkJbmV4dE9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2lOZXh0OwoJCQlwcmV2T2JqZWN0ID0gZGlzcGxheU9iamVjdDsKCgkJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCgkJCWNvdW50Kys7CgoJCX0KCQl3aGlsZShkaXNwbGF5T2JqZWN0ICE9IHRlc3RPYmplY3QpCgoJCXJldHVybiB0cnVlOwoKCX0sCgoJLyoqCgkqIER1bXBzIG91dCBhIGxpc3Qgb2YgR3JvdXAgY2hpbGRyZW4gYW5kIHRoZWlyIGluZGV4IHBvc2l0aW9ucyB0byB0aGUgYnJvd3NlciBjb25zb2xlLiBVc2VmdWwgZm9yIGdyb3VwIGRlYnVnZ2luZy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuR3JvdXAjZHVtcAoJKiBAcGFyYW0ge2Jvb2xlYW59IFtmdWxsPWZhbHNlXSAtIElmIGZ1bGwgdGhlIGR1bXAgd2lsbCBpbmNsdWRlIHRoZSBlbnRpcmUgZGlzcGxheSBsaXN0LCBzdGFydCBmcm9tIHRoZSBTdGFnZS4gT3RoZXJ3aXNlIGl0IHdpbGwgb25seSBpbmNsdWRlIHRoaXMgY29udGFpbmVyLgoJKi8KCWR1bXA6IGZ1bmN0aW9uIChmdWxsKSB7CgoJCWlmICh0eXBlb2YgZnVsbCA9PSAndW5kZWZpbmVkJykKCQl7CgkJCWZ1bGwgPSBmYWxzZTsKCQl9CgoJCXZhciBzcGFjaW5nID0gMjA7CgkJdmFyIG91dHB1dCA9ICJcbiIgKyBQaGFzZXIuVXRpbHMucGFkKCdOb2RlJywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCdOZXh0Jywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCdQcmV2aW91cycsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnRmlyc3QnLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJ0xhc3QnLCBzcGFjaW5nKTsKCgkJY29uc29sZS5sb2cob3V0cHV0KTsKCgkJdmFyIG91dHB1dCA9IFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKTsKCQljb25zb2xlLmxvZyhvdXRwdXQpOwoKCQlpZiAoZnVsbCkKCQl7CgkJCXZhciB0ZXN0T2JqZWN0ID0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dDsKCQkJdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLmdhbWUuc3RhZ2UuX3N0YWdlOwoJCX0KCQllbHNlCgkJewoJCQl2YXIgdGVzdE9iamVjdCA9IHRoaXMuX2NvbnRhaW5lci5sYXN0Ll9pTmV4dDsKCQkJdmFyIGRpc3BsYXlPYmplY3QgPSB0aGlzLl9jb250YWluZXI7CgkJfQoJCQoJCWRvCQoJCXsKCQkJdmFyIG5hbWUgPSBkaXNwbGF5T2JqZWN0Lm5hbWUgfHwgJyonOwoKCQkJaWYgKHRoaXMuY3Vyc29yID09IGRpc3BsYXlPYmplY3QpCgkJCXsKCQkJCXZhciBuYW1lID0gJz4gJyArIG5hbWU7CgkJCX0KCgkJCXZhciBuYW1lTmV4dCA9ICctJzsKCQkJdmFyIG5hbWVQcmV2ID0gJy0nOwoJCQl2YXIgbmFtZUZpcnN0ID0gJy0nOwoJCQl2YXIgbmFtZUxhc3QgPSAnLSc7CgoJCQlpZiAoZGlzcGxheU9iamVjdC5faU5leHQpCgkJCXsKCQkJCW5hbWVOZXh0ID0gZGlzcGxheU9iamVjdC5faU5leHQubmFtZTsKCQkJfQoKCQkJaWYgKGRpc3BsYXlPYmplY3QuX2lQcmV2KQoJCQl7CgkJCQluYW1lUHJldiA9IGRpc3BsYXlPYmplY3QuX2lQcmV2Lm5hbWU7CgkJCX0KCgkJCWlmIChkaXNwbGF5T2JqZWN0LmZpcnN0KQoJCQl7CgkJCQluYW1lRmlyc3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0Lm5hbWU7CgkJCX0KCgkJCWlmIChkaXNwbGF5T2JqZWN0Lmxhc3QpCgkJCXsKCQkJCW5hbWVMYXN0ID0gZGlzcGxheU9iamVjdC5sYXN0Lm5hbWU7CgkJCX0KCgkJCWlmICh0eXBlb2YgbmFtZU5leHQgPT09ICd1bmRlZmluZWQnKQoJCQl7CgkJCQluYW1lTmV4dCA9ICctJzsKCQkJfQoKCQkJaWYgKHR5cGVvZiBuYW1lUHJldiA9PT0gJ3VuZGVmaW5lZCcpCgkJCXsKCQkJCW5hbWVQcmV2ID0gJy0nOwoJCQl9CgoJCQlpZiAodHlwZW9mIG5hbWVGaXJzdCA9PT0gJ3VuZGVmaW5lZCcpCgkJCXsKCQkJCW5hbWVGaXJzdCA9ICctJzsKCQkJfQoKCQkJaWYgKHR5cGVvZiBuYW1lTGFzdCA9PT0gJ3VuZGVmaW5lZCcpCgkJCXsKCQkJCW5hbWVMYXN0ID0gJy0nOwoJCQl9CgoJCQl2YXIgb3V0cHV0ID0gUGhhc2VyLlV0aWxzLnBhZChuYW1lLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQobmFtZU5leHQsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lUHJldiwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVGaXJzdCwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVMYXN0LCBzcGFjaW5nKTsKCQkJY29uc29sZS5sb2cob3V0cHV0KTsKCgkJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCgkJfQoJCXdoaWxlKGRpc3BsYXlPYmplY3QgIT0gdGVzdE9iamVjdCkKCgl9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLkdyb3VwI3RvdGFsCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBjaGlsZHJlbiBpbiB0aGlzIEdyb3VwLCByZWdhcmRsZXNzIG9mIHRoZWlyIGFsaXZlIHN0YXRlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgInRvdGFsIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgCXJldHVybiB0aGlzLml0ZXJhdGUoJ2V4aXN0cycsIHRydWUsIFBoYXNlci5Hcm91cC5SRVRVUk5fVE9UQUwpOwogICAgICAgIC8vIHJldHVybiB0aGlzLl9jb250YWluZXIuY2hpbGRyZW4ubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuR3JvdXAjbGVuZ3RoCiogQHByb3BlcnR5IHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBudW1iZXIgb2YgY2hpbGRyZW4gaW4gdGhpcyBHcm91cC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJsZW5ndGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAJcmV0dXJuIHRoaXMuaXRlcmF0ZSgnZXhpc3RzJywgdHJ1ZSwgUGhhc2VyLkdyb3VwLlJFVFVSTl9UT1RBTCk7CiAgICAgICAgLy8gcmV0dXJuIHRoaXMuX2NvbnRhaW5lci5jaGlsZHJlbi5sZW5ndGg7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gWW91IGNhbiBhZGp1c3QgdGhlIEdyb3VwIGNvbnRhaW5lciBpdHNlbGYgYnkgbW9kaWZ5aW5nIGl0cyBjb29yZGluYXRlcy4KKiBUaGlzIHdpbGwgaGF2ZSBubyBpbXBhY3Qgb24gdGhlIHgveSBjb29yZGluYXRlcyBvZiBpdHMgY2hpbGRyZW4sIGJ1dCBpdCB3aWxsIHVwZGF0ZSB0aGVpciB3b3JsZFRyYW5zZm9ybSBhbmQgb24tc2NyZWVuIHBvc2l0aW9uLgoqIEBuYW1lIFBoYXNlci5Hcm91cCN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBHcm91cCBjb250YWluZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JvdXAucHJvdG90eXBlLCAieCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnBvc2l0aW9uLnggPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLiBZb3UgY2FuIGFkanVzdCB0aGUgR3JvdXAgY29udGFpbmVyIGl0c2VsZiBieSBtb2RpZnlpbmcgaXRzIGNvb3JkaW5hdGVzLgoqIFRoaXMgd2lsbCBoYXZlIG5vIGltcGFjdCBvbiB0aGUgeC95IGNvb3JkaW5hdGVzIG9mIGl0cyBjaGlsZHJlbiwgYnV0IGl0IHdpbGwgdXBkYXRlIHRoZWlyIHdvcmxkVHJhbnNmb3JtIGFuZCBvbi1zY3JlZW4gcG9zaXRpb24uCiogQG5hbWUgUGhhc2VyLkdyb3VwI3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Hcm91cC5wcm90b3R5cGUsICJ5IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIucG9zaXRpb24ueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIucG9zaXRpb24ueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgYW5nbGUgb2Ygcm90YXRpb24gb2YgdGhlIEdyb3VwIGNvbnRhaW5lci4gVGhpcyB3aWxsIGFkanVzdCB0aGUgR3JvdXAgY29udGFpbmVyIGl0c2VsZiBieSBtb2RpZnlpbmcgaXRzIHJvdGF0aW9uLgoqIFRoaXMgd2lsbCBoYXZlIG5vIGltcGFjdCBvbiB0aGUgcm90YXRpb24gdmFsdWUgb2YgaXRzIGNoaWxkcmVuLCBidXQgaXQgd2lsbCB1cGRhdGUgdGhlaXIgd29ybGRUcmFuc2Zvcm0gYW5kIG9uLXNjcmVlbiBwb3NpdGlvbi4KKiBAbmFtZSBQaGFzZXIuR3JvdXAjYW5nbGUKKiBAcHJvcGVydHkge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgb2Ygcm90YXRpb24gZ2l2ZW4gaW4gZGVncmVlcywgd2hlcmUgMCBkZWdyZWVzID0gdG8gdGhlIHJpZ2h0LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgImFuZ2xlIiwgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMuX2NvbnRhaW5lci5yb3RhdGlvbik7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZCh2YWx1ZSk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBvZiB0aGUgR3JvdXAgY29udGFpbmVyLiBUaGlzIHdpbGwgYWRqdXN0IHRoZSBHcm91cCBjb250YWluZXIgaXRzZWxmIGJ5IG1vZGlmeWluZyBpdHMgcm90YXRpb24uCiogVGhpcyB3aWxsIGhhdmUgbm8gaW1wYWN0IG9uIHRoZSByb3RhdGlvbiB2YWx1ZSBvZiBpdHMgY2hpbGRyZW4sIGJ1dCBpdCB3aWxsIHVwZGF0ZSB0aGVpciB3b3JsZFRyYW5zZm9ybSBhbmQgb24tc2NyZWVuIHBvc2l0aW9uLgoqIEBuYW1lIFBoYXNlci5Hcm91cCNyb3RhdGlvbgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbmdsZSBvZiByb3RhdGlvbiBnaXZlbiBpbiByYWRpYW5zLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgInJvdGF0aW9uIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIucm90YXRpb247CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJvdGF0aW9uID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Hcm91cCN2aXNpYmxlCiogQHByb3BlcnR5IHtib29sZWFufSB2aXNpYmxlIC0gVGhlIHZpc2libGUgc3RhdGUgb2YgdGhlIEdyb3VwLiBOb24tdmlzaWJsZSBHcm91cHMgYW5kIGFsbCBvZiB0aGVpciBjaGlsZHJlbiBhcmUgbm90IHJlbmRlcmVkLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgInZpc2libGUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci52aXNpYmxlID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Hcm91cCNhbHBoYQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBhbHBoYSB2YWx1ZSBvZiB0aGUgR3JvdXAgY29udGFpbmVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyb3VwLnByb3RvdHlwZSwgImFscGhhIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIuYWxwaGE7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLmFscGhhID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqICJUaGlzIHdvcmxkIGlzIGJ1dCBhIGNhbnZhcyB0byBvdXIgaW1hZ2luYXRpb24uIiAtIEhlbnJ5IERhdmlkIFRob3JlYXUKKgoqIEEgZ2FtZSBoYXMgb25seSBvbmUgd29ybGQuIFRoZSB3b3JsZCBpcyBhbiBhYnN0cmFjdCBwbGFjZSBpbiB3aGljaCBhbGwgZ2FtZSBvYmplY3RzIGxpdmUuIEl0IGlzIG5vdCBib3VuZAoqIGJ5IHN0YWdlIGxpbWl0cyBhbmQgY2FuIGJlIGFueSBzaXplLiBZb3UgbG9vayBpbnRvIHRoZSB3b3JsZCB2aWEgY2FtZXJhcy4gQWxsIGdhbWUgb2JqZWN0cyBsaXZlIHdpdGhpbgoqIHRoZSB3b3JsZCBhdCB3b3JsZC1iYXNlZCBjb29yZGluYXRlcy4gQnkgZGVmYXVsdCBhIHdvcmxkIGlzIGNyZWF0ZWQgdGhlIHNhbWUgc2l6ZSBhcyB5b3VyIFN0YWdlLgoqCiogQGNsYXNzIFBoYXNlci5Xb3JsZAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBSZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKi8KUGhhc2VyLldvcmxkID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICBQaGFzZXIuR3JvdXAuY2FsbCh0aGlzLCBnYW1lLCBudWxsLCAnX193b3JsZCcsIGZhbHNlKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlIC0gUmVwbGFjZXMgdGhlIFBJWEkuUG9pbnQgd2l0aCBhIHNsaWdodGx5IG1vcmUgZmxleGlibGUgb25lLgogICAgKi8gCiAgICB0aGlzLnNjYWxlID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogVGhlIFdvcmxkIGhhcyBubyBmaXhlZCBzaXplLCBidXQgaXQgZG9lcyBoYXZlIGEgYm91bmRzIG91dHNpZGUgb2Ygd2hpY2ggb2JqZWN0cyBhcmUgbm8gbG9uZ2VyIGNvbnNpZGVyZWQgYXMgYmVpbmcgImluIHdvcmxkIiBhbmQgeW91IHNob3VsZCB1c2UgdGhpcyB0byBjbGVhbi11cCB0aGUgZGlzcGxheSBsaXN0IGFuZCBwdXJnZSBkZWFkIG9iamVjdHMuCiAgICAqIEJ5IGRlZmF1bHQgd2Ugc2V0IHRoZSBCb3VuZHMgdG8gYmUgZnJvbSAwLDAgdG8gR2FtZS53aWR0aCxHYW1lLmhlaWdodC4gSS5lLiBpdCB3aWxsIG1hdGNoIHRoZSBzaXplIGdpdmVuIHRvIHRoZSBnYW1lIGNvbnN0cnVjdG9yIHdpdGggMCwwIHJlcHJlc2VudGluZyB0aGUgdG9wLWxlZnQgb2YgdGhlIGRpc3BsYXkuCiAgICAqIEhvd2V2ZXIgMCwwIGlzIGFjdHVhbGx5IHRoZSBjZW50ZXIgb2YgdGhlIHdvcmxkLCBhbmQgaWYgeW91IHJvdGF0ZSBvciBzY2FsZSB0aGUgd29ybGQgYWxsIG9mIHRoYXQgd2lsbCBoYXBwZW4gZnJvbSAwLDAuCiAgICAqIFNvIGlmIHlvdSB3YW50IHRvIG1ha2UgYSBnYW1lIGluIHdoaWNoIHRoZSB3b3JsZCBpdHNlbGYgd2lsbCByb3RhdGUgeW91IHNob3VsZCBhZGp1c3QgdGhlIGJvdW5kcyBzbyB0aGF0IDAsMCBpcyB0aGUgY2VudGVyIHBvaW50LCBpLmUuIHNldCB0aGVtIHRvIC0xMDAwLC0xMDAwLDIwMDAsMjAwMCBmb3IgYSAyMDAweDIwMDAgc2l6ZWQgd29ybGQgY2VudGVyZWQgYXJvdW5kIDAsMC4KCSogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHMgLSBCb3VuZCBvZiB0aGlzIHdvcmxkIHRoYXQgb2JqZWN0cyBjYW4gbm90IGVzY2FwZSBmcm9tLgoJKi8KCXRoaXMuYm91bmRzID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgZ2FtZS53aWR0aCwgZ2FtZS5oZWlnaHQpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5DYW1lcmF9IGNhbWVyYSAtIENhbWVyYSBpbnN0YW5jZS4KCSovCgl0aGlzLmNhbWVyYSA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50UmVuZGVyT3JkZXJJRCAtIFJlc2V0IGVhY2ggZnJhbWUsIGtlZXBzIGEgY291bnQgb2YgdGhlIHRvdGFsIG51bWJlciBvZiBvYmplY3RzIHVwZGF0ZWQuCgkqLwoJdGhpcy5jdXJyZW50UmVuZGVyT3JkZXJJRCA9IDA7CgkKfTsKClBoYXNlci5Xb3JsZC5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBoYXNlci5Hcm91cC5wcm90b3R5cGUpOwpQaGFzZXIuV29ybGQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLldvcmxkOwoKLyoqCiogSW5pdGlhbGlzZXMgdGhlIGdhbWUgd29ybGQuCioKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCNib290CiogQHByb3RlY3RlZAoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLmJvb3QgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5jYW1lcmEgPSBuZXcgUGhhc2VyLkNhbWVyYSh0aGlzLmdhbWUsIDAsIDAsIDAsIHRoaXMuZ2FtZS53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCk7CgogICAgdGhpcy5jYW1lcmEuZGlzcGxheU9iamVjdCA9IHRoaXMuX2NvbnRhaW5lcjsKCiAgICB0aGlzLmdhbWUuY2FtZXJhID0gdGhpcy5jYW1lcmE7Cgp9CgovKioKKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGV2ZXJ5IGZyYW1lLCBhbmQgaXMgd2hlcmUgbWFpbiBsb2dpYyBoYXBwZW5zLgoqIAoqIEBtZXRob2QgUGhhc2VyLldvcmxkI3VwZGF0ZQoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uICgpIHsKCgl0aGlzLmN1cnJlbnRSZW5kZXJPcmRlcklEID0gMDsKICAgIAoJaWYgKHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0KQoJewoJCXZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0OwogICAgICAgIHZhciBza2lwQ2hpbGRyZW47CgkJCgkJZG8KCQl7CiAgICAgICAgICAgIHNraXBDaGlsZHJlbiA9IGZhbHNlOwoKCQkJaWYgKGN1cnJlbnROb2RlWydwcmVVcGRhdGUnXSkKCQkJewoJCQkJc2tpcENoaWxkcmVuID0gKGN1cnJlbnROb2RlLnByZVVwZGF0ZSgpID09PSBmYWxzZSk7CgkJCX0KCgkJCWlmIChjdXJyZW50Tm9kZVsndXBkYXRlJ10pCgkJCXsKCQkJCXNraXBDaGlsZHJlbiA9IChjdXJyZW50Tm9kZS51cGRhdGUoKSA9PT0gZmFsc2UpIHx8IHNraXBDaGlsZHJlbjsKCQkJfQoJCQkKICAgICAgICAgICAgaWYgKHNraXBDaGlsZHJlbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5sYXN0Ll9pTmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgICAgICB9CgkJCQoJCX0KCQl3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKCX0KCn0KCi8qKgoqIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgZXZlcnkgZnJhbWUsIGFuZCBpcyB3aGVyZSBtYWluIGxvZ2ljIGhhcHBlbnMuCiogQG1ldGhvZCBQaGFzZXIuV29ybGQjcG9zdFVwZGF0ZQoqLwpQaGFzZXIuV29ybGQucHJvdG90eXBlLnBvc3RVcGRhdGUgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5jYW1lcmEudXBkYXRlKCk7CgogICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0KQogICAgewogICAgICAgIHZhciBjdXJyZW50Tm9kZSA9IHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuZmlyc3QuX2lOZXh0OwogICAgICAgIAogICAgICAgIGRvICAKICAgICAgICB7CiAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZVsncG9zdFVwZGF0ZSddKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5wb3N0VXBkYXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUuX2lOZXh0OwogICAgICAgIH0KICAgICAgICB3aGlsZSAoY3VycmVudE5vZGUgIT0gdGhpcy5nYW1lLnN0YWdlLl9zdGFnZS5sYXN0Ll9pTmV4dCkKICAgIH0KCn0KCi8qKgoqIFVwZGF0ZXMgdGhlIHNpemUgb2YgdGhpcyB3b3JsZC4gTm90ZSB0aGF0IHRoaXMgZG9lc24ndCBtb2RpZnkgdGhlIHdvcmxkIHgveSBjb29yZGluYXRlcywganVzdCB0aGUgd2lkdGggYW5kIGhlaWdodC4KKiBJZiB5b3UgbmVlZCB0byBhZGp1c3QgdGhlIGJvdW5kcyBvZiB0aGUgd29ybGQKKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCNzZXRCb3VuZHMKKiBAcGFyYW0ge251bWJlcn0geCAtIFRvcCBsZWZ0IG1vc3QgY29ybmVyIG9mIHRoZSB3b3JsZC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRvcCBsZWZ0IG1vc3QgY29ybmVyIG9mIHRoZSB3b3JsZC4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBOZXcgd2lkdGggb2YgdGhlIHdvcmxkLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBOZXcgaGVpZ2h0IG9mIHRoZSB3b3JsZC4KKi8KUGhhc2VyLldvcmxkLnByb3RvdHlwZS5zZXRCb3VuZHMgPSBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgIHRoaXMuYm91bmRzLnNldFRvKHgsIHksIHdpZHRoLCBoZWlnaHQpOwoKICAgIGlmICh0aGlzLmNhbWVyYS5ib3VuZHMpCiAgICB7CiAgICAgICAgdGhpcy5jYW1lcmEuYm91bmRzLnNldFRvKHgsIHksIHdpZHRoLCBoZWlnaHQpOwogICAgfQoKfQoKLyoqCiogRGVzdHJveWVyIG9mIHdvcmxkcy4KKiBAbWV0aG9kIFBoYXNlci5Xb3JsZCNkZXN0cm95CiovClBoYXNlci5Xb3JsZC5wcm90b3R5cGUuZGVzdHJveSA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLmNhbWVyYS54ID0gMDsKICAgIHRoaXMuY2FtZXJhLnkgPSAwOwoKICAgIHRoaXMuZ2FtZS5pbnB1dC5yZXNldCh0cnVlKTsKCiAgICB0aGlzLnJlbW92ZUFsbCgpOwoKfQoKLyoqCiogQG5hbWUgUGhhc2VyLldvcmxkI3dpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IHdpZHRoIG9mIHRoZSBnYW1lIHdvcmxkLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgIndpZHRoIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy53aWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmJvdW5kcy53aWR0aCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjaGVpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBoZWlnaHQgb2YgdGhlIGdhbWUgd29ybGQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAiaGVpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmJvdW5kcy5oZWlnaHQ7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5ib3VuZHMuaGVpZ2h0ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCNjZW50ZXJYCiogQHByb3BlcnR5IHtudW1iZXJ9IGNlbnRlclggLSBHZXRzIHRoZSBYIHBvc2l0aW9uIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGNlbnRlciBwb2ludCBvZiB0aGUgd29ybGQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAiY2VudGVyWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5ib3VuZHMuaGFsZldpZHRoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuV29ybGQjY2VudGVyWQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjZW50ZXJZIC0gR2V0cyB0aGUgWSBwb3NpdGlvbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBjZW50ZXIgcG9pbnQgb2YgdGhlIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgImNlbnRlclkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYm91bmRzLmhhbGZIZWlnaHQ7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCNyYW5kb21YCiogQHByb3BlcnR5IHtudW1iZXJ9IHJhbmRvbVggLSBHZXRzIGEgcmFuZG9tIGludGVnZXIgd2hpY2ggaXMgbGVzc2VyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIGN1cnJlbnQgd2lkdGggb2YgdGhlIGdhbWUgd29ybGQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuV29ybGQucHJvdG90eXBlLCAicmFuZG9tWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuYm91bmRzLnggPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5ib3VuZHMueCwgKHRoaXMuYm91bmRzLndpZHRoIC0gTWF0aC5hYnModGhpcy5ib3VuZHMueCkpKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5ib3VuZHMueCwgdGhpcy5ib3VuZHMud2lkdGgpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCNyYW5kb21ZCiogQHByb3BlcnR5IHtudW1iZXJ9IHJhbmRvbVkgLSBHZXRzIGEgcmFuZG9tIGludGVnZXIgd2hpY2ggaXMgbGVzc2VyIHRoYW4gb3IgZXF1YWwgdG8gdGhlIGN1cnJlbnQgaGVpZ2h0IG9mIHRoZSBnYW1lIHdvcmxkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLldvcmxkLnByb3RvdHlwZSwgInJhbmRvbVkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmJvdW5kcy55IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMuYm91bmRzLnksICh0aGlzLmJvdW5kcy5oZWlnaHQgLSBNYXRoLmFicyh0aGlzLmJvdW5kcy55KSkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmJvdW5kcy55LCB0aGlzLmJvdW5kcy5oZWlnaHQpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Xb3JsZCN2aXNpYmxlCiogQHByb3BlcnR5IHtib29sZWFufSB2aXNpYmxlIC0gR2V0cyBvciBzZXRzIHRoZSB2aXNpYmxlIHN0YXRlIG9mIHRoZSBXb3JsZC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Xb3JsZC5wcm90b3R5cGUsICJ2aXNpYmxlIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9jb250YWluZXIudmlzaWJsZTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLl9jb250YWluZXIudmlzaWJsZSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBHYW1lIGNvbnN0cnVjdG9yCioKKiBJbnN0YW50aWF0ZSBhIG5ldyA8Y29kZT5QaGFzZXIuR2FtZTwvY29kZT4gb2JqZWN0LgoqIEBjbGFzcyBQaGFzZXIuR2FtZQoqIEBjbGFzc2Rlc2MgVGhpcyBpcyB3aGVyZSB0aGUgbWFnaWMgaGFwcGVucy4gVGhlIEdhbWUgb2JqZWN0IGlzIHRoZSBoZWFydCBvZiB5b3VyIGdhbWUsCiogcHJvdmlkaW5nIHF1aWNrIGFjY2VzcyB0byBjb21tb24gZnVuY3Rpb25zIGFuZCBoYW5kbGluZyB0aGUgYm9vdCBwcm9jZXNzLgoqICJIZWxsLCB0aGVyZSBhcmUgbm8gcnVsZXMgaGVyZSAtIHdlJ3JlIHRyeWluZyB0byBhY2NvbXBsaXNoIHNvbWV0aGluZy4iCiogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhvbWFzIEEuIEVkaXNvbgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGg9ODAwXSAtIFRoZSB3aWR0aCBvZiB5b3VyIGdhbWUgaW4gZ2FtZSBwaXhlbHMuCiogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9NjAwXSAtIFRoZSBoZWlnaHQgb2YgeW91ciBnYW1lIGluIGdhbWUgcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBbcmVuZGVyZXI9UGhhc2VyLkFVVE9dIC0gV2hpY2ggcmVuZGVyZXIgdG8gdXNlIChjYW52YXMgb3Igd2ViZ2wpCiogQHBhcmFtIHtIVE1MRWxlbWVudH0gW3BhcmVudD0nJ10gLSBUaGUgR2FtZXMgRE9NIHBhcmVudC4KKiBAcGFyYW0ge2FueX0gW3N0YXRlPW51bGxdIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtib29sZWFufSBbdHJhbnNwYXJlbnQ9ZmFsc2VdIC0gVXNlIGEgdHJhbnNwYXJlbnQgY2FudmFzIGJhY2tncm91bmQgb3Igbm90LgoqIEBwYXJhbSAge2Jvb2xlYW59IFthbnRpYWxpYXM9dHJ1ZV0gLSBBbnRpLWFsaWFzIGdyYXBoaWNzLgoqLwpQaGFzZXIuR2FtZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0LCByZW5kZXJlciwgcGFyZW50LCBzdGF0ZSwgdHJhbnNwYXJlbnQsIGFudGlhbGlhcykgewoKCXdpZHRoID0gd2lkdGggfHwgODAwOwoJaGVpZ2h0ID0gaGVpZ2h0IHx8IDYwMDsKCXJlbmRlcmVyID0gcmVuZGVyZXIgfHwgUGhhc2VyLkFVVE87CglwYXJlbnQgPSBwYXJlbnQgfHwgJyc7CglzdGF0ZSA9IHN0YXRlIHx8IG51bGw7CgoJaWYgKHR5cGVvZiB0cmFuc3BhcmVudCA9PSAndW5kZWZpbmVkJykgeyB0cmFuc3BhcmVudCA9IGZhbHNlOyB9CglpZiAodHlwZW9mIGFudGlhbGlhcyA9PSAndW5kZWZpbmVkJykgeyBhbnRpYWxpYXMgPSB0cnVlOyB9CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpZCAtIFBoYXNlciBHYW1lIElEIChmb3Igd2hlbiBQaXhpIHN1cHBvcnRzIG11bHRpcGxlIGluc3RhbmNlcykuCgkqLwoJdGhpcy5pZCA9IFBoYXNlci5HQU1FUy5wdXNoKHRoaXMpIC0gMTsKCgkvKioKCSogQHByb3BlcnR5IHtIVE1MRWxlbWVudH0gcGFyZW50IC0gVGhlIEdhbWVzIERPTSBwYXJlbnQuCgkqLwoJdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CgoJLy8JRG8gc29tZSBtb3JlIGludGVsbGlnZW50IHNpemUgcGFyc2luZyBoZXJlLCBzbyB0aGV5IGNhbiBzZXQgIjEwMCUiIGZvciBleGFtcGxlLCBtYXliZSBwYXNzIHRoZSBzY2FsZSBtb2RlIGluIGhlcmUgdG9vPwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBUaGUgR2FtZSB3aWR0aCAoaW4gcGl4ZWxzKS4KCSovCgl0aGlzLndpZHRoID0gd2lkdGg7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgR2FtZSBoZWlnaHQgKGluIHBpeGVscykuCgkqLwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHJhbnNwYXJlbnQgLSBVc2UgYSB0cmFuc3BhcmVudCBjYW52YXMgYmFja2dyb3VuZCBvciBub3QuCgkqLwoJdGhpcy50cmFuc3BhcmVudCA9IHRyYW5zcGFyZW50OwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGFudGlhbGlhcyAtIEFudGktYWxpYXMgZ3JhcGhpY3MgKGluIFdlYkdMIHRoaXMgaGVscHMgd2l0aCBlZGdlcywgaW4gQ2FudmFzMkQgaXQgcmV0YWlucyBwaXhlbC1hcnQgcXVhbGl0eSkuCgkqLwoJdGhpcy5hbnRpYWxpYXMgPSBhbnRpYWxpYXM7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZW5kZXJlciAtIFRoZSBQaXhpIFJlbmRlcmVyCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5yZW5kZXJlciA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzdGF0ZSAtIFRoZSBTdGF0ZU1hbmFnZXIuCgkqLwoJdGhpcy5zdGF0ZSA9IG5ldyBQaGFzZXIuU3RhdGVNYW5hZ2VyKHRoaXMsIHN0YXRlKTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBfcGF1c2VkIC0gSXMgZ2FtZSBwYXVzZWQ/CgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fcGF1c2VkID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZW5kZXJUeXBlIC0gVGhlIFJlbmRlcmVyIHRoaXMgUGhhc2VyLkdhbWUgd2lsbCB1c2UuIEVpdGhlciBQaGFzZXIuUkVOREVSRVJfQVVUTywgUGhhc2VyLlJFTkRFUkVSX0NBTlZBUyBvciBQaGFzZXIuUkVOREVSRVJfV0VCR0wuCgkqLwoJdGhpcy5yZW5kZXJUeXBlID0gcmVuZGVyZXI7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2xvYWRDb21wbGV0ZSAtIFdoZXRoZXIgbG9hZCBjb21wbGV0ZSBsb2FkaW5nIG9yIG5vdC4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCgl0aGlzLl9sb2FkQ29tcGxldGUgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc0Jvb3RlZCAtIFdoZXRoZXIgdGhlIGdhbWUgZW5naW5lIGlzIGJvb3RlZCwgYWthIGF2YWlsYWJsZS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmlzQm9vdGVkID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaWQgLUlzIGdhbWUgcnVubmluZyBvciBwYXVzZWQ/CgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc1J1bm5pbmcgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lfSByYWYgLSBBdXRvbWF0aWNhbGx5IGhhbmRsZXMgdGhlIGNvcmUgZ2FtZSBsb29wIHZpYSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgb3Igc2V0VGltZW91dAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucmFmID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZU9iamVjdEZhY3Rvcnl9IGFkZCAtIFJlZmVyZW5jZSB0byB0aGUgR2FtZU9iamVjdCBGYWN0b3J5LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYWRkID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuQ2FjaGV9IGNhY2hlIC0gUmVmZXJlbmNlIHRvIHRoZSBhc3NldHMgY2FjaGUuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jYWNoZSA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLklucHV0fSBpbnB1dCAtIFJlZmVyZW5jZSB0byB0aGUgaW5wdXQgbWFuYWdlcgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuaW5wdXQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Mb2FkZXJ9IGxvYWQgLSBSZWZlcmVuY2UgdG8gdGhlIGFzc2V0cyBsb2FkZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5sb2FkID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuTWF0aH0gbWF0aCAtIFJlZmVyZW5jZSB0byB0aGUgbWF0aCBoZWxwZXIuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5tYXRoID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuTmV0fSBuZXQgLSBSZWZlcmVuY2UgdG8gdGhlIG5ldHdvcmsgY2xhc3MuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5uZXQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZE1hbmFnZXJ9IHNvdW5kIC0gUmVmZXJlbmNlIHRvIHRoZSBzb3VuZCBtYW5hZ2VyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc291bmQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TdGFnZX0gc3RhZ2UgLSBSZWZlcmVuY2UgdG8gdGhlIHN0YWdlLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc3RhZ2UgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5UaW1lTWFuYWdlcn0gdGltZSAtIFJlZmVyZW5jZSB0byBnYW1lIGNsb2NrLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudGltZSA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlR3ZWVuTWFuYWdlcn0gdHdlZW5zIC0gUmVmZXJlbmNlIHRvIHRoZSB0d2VlbiBtYW5hZ2VyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudHdlZW5zID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuV29ybGR9IHdvcmxkIC0gUmVmZXJlbmNlIHRvIHRoZSB3b3JsZC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLndvcmxkID0gbnVsbDsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5QaHlzaWNzTWFuYWdlcn0gcGh5c2ljcyAtIFJlZmVyZW5jZSB0byB0aGUgcGh5c2ljcyBtYW5hZ2VyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucGh5c2ljcyA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3J9IHJuZCAtIEluc3RhbmNlIG9mIHJlcGVhdGFibGUgcmFuZG9tIGRhdGEgZ2VuZXJhdG9yIGhlbHBlci4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnJuZCA9IG51bGw7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkRldmljZX0gZGV2aWNlIC0gQ29udGFpbnMgZGV2aWNlIGluZm9ybWF0aW9uIGFuZCBjYXBhYmlsaXRpZXMuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5kZXZpY2UgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5QaHlzaWNzLlBoeXNpY3NNYW5hZ2VyfSBjYW1lcmEgLSBBIGhhbmR5IHJlZmVyZW5jZSB0byB3b3JsZC5jYW1lcmEuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5jYW1lcmEgPSBudWxsOwoKCSAgIC8qKgoJKiBAcHJvcGVydHkge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBBIGhhbmR5IHJlZmVyZW5jZSB0byByZW5kZXJlci52aWV3LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuY2FudmFzID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtDb250ZXh0fSBjb250ZXh0IC0gQSBoYW5keSByZWZlcmVuY2UgdG8gcmVuZGVyZXIuY29udGV4dCAob25seSBzZXQgZm9yIENBTlZBUyBnYW1lcykKCSogQGRlZmF1bHQKCSovCgl0aGlzLmNvbnRleHQgPSBudWxsOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5VdGlscy5EZWJ1Z30gZGVidWcgLSBBIHNldCBvZiB1c2VmdWwgZGVidWcgdXRpbGl0aWUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5kZWJ1ZyA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBhcnRpY2xlc30gcGFydGljbGVzIC0gVGhlIFBhcnRpY2xlIE1hbmFnZXIuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5wYXJ0aWNsZXMgPSBudWxsOwoKCXZhciBfdGhpcyA9IHRoaXM7CgogICAgdGhpcy5fb25Cb290ID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBfdGhpcy5ib290KCk7CiAgICB9CgoJaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2ludGVyYWN0aXZlJykKCXsKCQl3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkJvb3QsIDApOwoJfQoJZWxzZQoJewoJCWRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCB0aGlzLl9vbkJvb3QsIGZhbHNlKTsKCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsIHRoaXMuX29uQm9vdCwgZmFsc2UpOwoJfQoKCXJldHVybiB0aGlzOwoKfTsKClBoYXNlci5HYW1lLnByb3RvdHlwZSA9IHsKCgkvKioKCSogSW5pdGlhbGl6ZSBlbmdpbmUgc3ViIG1vZHVsZXMgYW5kIHN0YXJ0IHRoZSBnYW1lLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5HYW1lI2Jvb3QKCSogQHByb3RlY3RlZAoJKi8KCWJvb3Q6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuaXNCb290ZWQpCgkJewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIWRvY3VtZW50LmJvZHkpCgkJewoJCQl3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkJvb3QsIDIwKTsKCQl9CgkJZWxzZQoJCXsKCQkJZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIHRoaXMuX29uQm9vdCk7CgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdsb2FkJywgdGhpcy5fb25Cb290KTsKCgkJCXRoaXMub25QYXVzZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJCQl0aGlzLm9uUmVzdW1lID0gbmV3IFBoYXNlci5TaWduYWw7CgoJCQl0aGlzLmlzQm9vdGVkID0gdHJ1ZTsKCgkJCXRoaXMuZGV2aWNlID0gbmV3IFBoYXNlci5EZXZpY2UoKTsKCQkJdGhpcy5tYXRoID0gUGhhc2VyLk1hdGg7CgkJCXRoaXMucm5kID0gbmV3IFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yKFsoRGF0ZS5ub3coKSAqIE1hdGgucmFuZG9tKCkpLnRvU3RyaW5nKCldKTsKCgkJCXRoaXMuc3RhZ2UgPSBuZXcgUGhhc2VyLlN0YWdlKHRoaXMsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCgkJCXRoaXMuc2V0VXBSZW5kZXJlcigpOwoKCQkJdGhpcy53b3JsZCA9IG5ldyBQaGFzZXIuV29ybGQodGhpcyk7CgkJCXRoaXMuYWRkID0gbmV3IFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSh0aGlzKTsKCQkJdGhpcy5jYWNoZSA9IG5ldyBQaGFzZXIuQ2FjaGUodGhpcyk7CgkJCXRoaXMubG9hZCA9IG5ldyBQaGFzZXIuTG9hZGVyKHRoaXMpOwoJCQl0aGlzLnRpbWUgPSBuZXcgUGhhc2VyLlRpbWUodGhpcyk7CgkJCXRoaXMudHdlZW5zID0gbmV3IFBoYXNlci5Ud2Vlbk1hbmFnZXIodGhpcyk7CgkJCXRoaXMuaW5wdXQgPSBuZXcgUGhhc2VyLklucHV0KHRoaXMpOwoJCQl0aGlzLnNvdW5kID0gbmV3IFBoYXNlci5Tb3VuZE1hbmFnZXIodGhpcyk7CgkJCXRoaXMucGh5c2ljcyA9IG5ldyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUodGhpcyk7CgkJCXRoaXMucGFydGljbGVzID0gbmV3IFBoYXNlci5QYXJ0aWNsZXModGhpcyk7CgkJCXRoaXMucGx1Z2lucyA9IG5ldyBQaGFzZXIuUGx1Z2luTWFuYWdlcih0aGlzLCB0aGlzKTsKCQkJdGhpcy5uZXQgPSBuZXcgUGhhc2VyLk5ldCh0aGlzKTsKCQkJdGhpcy5kZWJ1ZyA9IG5ldyBQaGFzZXIuVXRpbHMuRGVidWcodGhpcyk7CgoJCQl0aGlzLnN0YWdlLmJvb3QoKTsKCQkJdGhpcy53b3JsZC5ib290KCk7CgkJCXRoaXMuaW5wdXQuYm9vdCgpOwoJCQl0aGlzLnNvdW5kLmJvb3QoKTsKCQkJdGhpcy5zdGF0ZS5ib290KCk7CgoJCQl0aGlzLmxvYWQub25Mb2FkQ29tcGxldGUuYWRkKHRoaXMubG9hZENvbXBsZXRlLCB0aGlzKTsKCgkJCXRoaXMuc2hvd0RlYnVnSGVhZGVyKCk7CgoJICAgICAgICB0aGlzLmlzUnVubmluZyA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZSA9IGZhbHNlOwoKCQkJdGhpcy5yYWYgPSBuZXcgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzKTsKCQkJdGhpcy5yYWYuc3RhcnQoKTsKCgkJfQoKCX0sCgoJLyoqCiAgICAqIERpc3BsYXlzIGEgUGhhc2VyIHZlcnNpb24gZGVidWcgaGVhZGVyIGluIHRoZSBjb25zb2xlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3Nob3dEZWJ1Z0hlYWRlcgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJc2hvd0RlYnVnSGVhZGVyOiBmdW5jdGlvbiAoKSB7CgoJCXZhciB2ID0gUGhhc2VyLkRFVl9WRVJTSU9OOwoJCXZhciByID0gJ0NhbnZhcyc7CgkJdmFyIGEgPSAnSFRNTCBBdWRpbyc7CgoJCWlmICh0aGlzLnJlbmRlclR5cGUgPT0gUGhhc2VyLldFQkdMKQoJCXsKCQkJciA9ICdXZWJHTCc7CgkJfQoKCQlpZiAodGhpcy5kZXZpY2Uud2ViQXVkaW8pCgkJewoJCQlhID0gJ1dlYkF1ZGlvJzsKCQl9CgoJCWlmICh0aGlzLmRldmljZS5jaHJvbWUpCgkJewoJCQl2YXIgYXJncyA9IFsgCgkJCQknJWMgJWMgJWMgIFBoYXNlciB2JyArIHYgKyAnIC0gUmVuZGVyZXI6ICcgKyByICsgJyAtIEF1ZGlvOiAnICsgYSArICcgICVjICVjICcsCgkJCQknYmFja2dyb3VuZDogIzAwYmZmMycsCgkJCQknYmFja2dyb3VuZDogIzAwNzJiYycsCgkJCQknY29sb3I6ICNmZmZmZmY7IGJhY2tncm91bmQ6ICMwMDM0NzEnLAoJCQkJJ2JhY2tncm91bmQ6ICMwMDcyYmMnLAoJCQkJJ2JhY2tncm91bmQ6ICMwMGJmZjMnCgkJCV07CgoJCQljb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBhcmdzKTsKCQl9CgkJZWxzZQoJCXsKCQkJY29uc29sZS5sb2coJ1BoYXNlciB2JyArIHYgKyAnIC0gUmVuZGVyZXI6ICcgKyByICsgJyAtIEF1ZGlvOiAnICsgYSk7CgkJfQoKCX0sCgoJLyoqCgkqIENoZWNrcyBpZiB0aGUgZGV2aWNlIGlzIGNhcGFibGUgb2YgdXNpbmcgdGhlIHJlcXVlc3RlZCByZW5kZXJlciBhbmQgc2V0cyBpdCB1cCBvciBhbiBhbHRlcm5hdGl2ZSBpZiBub3QuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkdhbWUjc2V0VXBSZW5kZXJlcgoJKiBAcHJvdGVjdGVkCgkqLwoJc2V0VXBSZW5kZXJlcjogZnVuY3Rpb24gKCkgewoKCQlpZiAodGhpcy5yZW5kZXJUeXBlID09PSBQaGFzZXIuQ0FOVkFTIHx8ICh0aGlzLnJlbmRlclR5cGUgPT09IFBoYXNlci5BVVRPICYmIHRoaXMuZGV2aWNlLndlYkdMID09IGZhbHNlKSkKCQl7CgkJCWlmICh0aGlzLmRldmljZS5jYW52YXMpCgkJCXsKCQkJCXRoaXMucmVuZGVyVHlwZSA9IFBoYXNlci5DQU5WQVM7CgkJCQl0aGlzLnJlbmRlcmVyID0gbmV3IFBJWEkuQ2FudmFzUmVuZGVyZXIodGhpcy53aWR0aCwgdGhpcy5oZWlnaHQsIHRoaXMuc3RhZ2UuY2FudmFzLCB0aGlzLnRyYW5zcGFyZW50KTsKCQkJCVBoYXNlci5DYW52YXMuc2V0U21vb3RoaW5nRW5hYmxlZCh0aGlzLnJlbmRlcmVyLmNvbnRleHQsIHRoaXMuYW50aWFsaWFzKTsKCQkJCXRoaXMuY2FudmFzID0gdGhpcy5yZW5kZXJlci52aWV3OwoJCQkJdGhpcy5jb250ZXh0ID0gdGhpcy5yZW5kZXJlci5jb250ZXh0OwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhyb3cgbmV3IEVycm9yKCdQaGFzZXIuR2FtZSAtIGNhbm5vdCBjcmVhdGUgQ2FudmFzIG9yIFdlYkdMIGNvbnRleHQsIGFib3J0aW5nLicpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCS8vCVRoZXkgcmVxdWVzdGVkIFdlYkdMLCBhbmQgdGhlaXIgYnJvd3NlciBzdXBwb3J0cyBpdAoJCQl0aGlzLnJlbmRlclR5cGUgPSBQaGFzZXIuV0VCR0w7CgkJCXRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5XZWJHTFJlbmRlcmVyKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0LCB0aGlzLnN0YWdlLmNhbnZhcywgdGhpcy50cmFuc3BhcmVudCwgdGhpcy5hbnRpYWxpYXMpOwoJCQl0aGlzLmNhbnZhcyA9IHRoaXMucmVuZGVyZXIudmlldzsKCQkJdGhpcy5jb250ZXh0ID0gbnVsbDsKCQl9CgogICAgICAgIFBoYXNlci5DYW52YXMuYWRkVG9ET00odGhpcy5yZW5kZXJlci52aWV3LCB0aGlzLnBhcmVudCwgdHJ1ZSk7CiAgICAgICAgUGhhc2VyLkNhbnZhcy5zZXRUb3VjaEFjdGlvbih0aGlzLnJlbmRlcmVyLnZpZXcpOwoKCX0sCgoJLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBsb2FkIGhhcyBmaW5pc2hlZCwgYWZ0ZXIgcHJlbG9hZCB3YXMgcnVuLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2xvYWRDb21wbGV0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgbG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2xvYWRDb21wbGV0ZSA9IHRydWU7CgogICAgICAgIHRoaXMuc3RhdGUubG9hZENvbXBsZXRlKCk7CgogICAgfSwKCgkvKioKICAgICogVGhlIGNvcmUgZ2FtZSBsb29wLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCgkqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gVGhlIGN1cnJlbnQgdGltZSBhcyBwcm92aWRlZCBieSBSZXF1ZXN0QW5pbWF0aW9uRnJhbWUuCiAgICAqLwoJdXBkYXRlOiBmdW5jdGlvbiAodGltZSkgewoKCQl0aGlzLnRpbWUudXBkYXRlKHRpbWUpOwoKCQlpZiAodGhpcy5fcGF1c2VkKQoJCXsKCQkJdGhpcy5yZW5kZXJlci5yZW5kZXIodGhpcy5zdGFnZS5fc3RhZ2UpOwoJCQl0aGlzLnBsdWdpbnMucmVuZGVyKCk7CgkJCXRoaXMuc3RhdGUucmVuZGVyKCk7CgkJfQoJCWVsc2UKCQl7CgkgICAgICAgIHRoaXMucGx1Z2lucy5wcmVVcGRhdGUoKTsKCSAgICAgICAgdGhpcy5waHlzaWNzLnByZVVwZGF0ZSgpOwoKCSAgICAgICAgdGhpcy5zdGFnZS51cGRhdGUoKTsKCSAgICAgICAgdGhpcy5pbnB1dC51cGRhdGUoKTsKCSAgICAgICAgdGhpcy50d2VlbnMudXBkYXRlKCk7CgkgICAgICAgIHRoaXMuc291bmQudXBkYXRlKCk7CgkJCXRoaXMud29ybGQudXBkYXRlKCk7CgkJCXRoaXMucGFydGljbGVzLnVwZGF0ZSgpOwoJCQl0aGlzLnN0YXRlLnVwZGF0ZSgpOwoJICAgICAgICB0aGlzLnBsdWdpbnMudXBkYXRlKCk7CgoJCQl0aGlzLndvcmxkLnBvc3RVcGRhdGUoKTsKICAgICAgICAgICAgdGhpcy5wbHVnaW5zLnBvc3RVcGRhdGUoKTsKCgkJCXRoaXMucmVuZGVyZXIucmVuZGVyKHRoaXMuc3RhZ2UuX3N0YWdlKTsKCQkJdGhpcy5wbHVnaW5zLnJlbmRlcigpOwoJCQl0aGlzLnN0YXRlLnJlbmRlcigpOwoKCQkJdGhpcy5wbHVnaW5zLnBvc3RSZW5kZXIoKTsKCQl9CgoJfSwKCgkvKioKICAgICogTnVrZSB0aGUgZW50aXJlIGdhbWUgZnJvbSBvcmJpdAogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMucmFmLnN0b3AoKTsKCiAgICAJdGhpcy5pbnB1dC5kZXN0cm95KCk7CgogICAgCXRoaXMuc3RhdGUuZGVzdHJveSgpOwoKICAgICAgICB0aGlzLnN0YXRlID0gbnVsbDsKICAgICAgICB0aGlzLmNhY2hlID0gbnVsbDsKICAgICAgICB0aGlzLmlucHV0ID0gbnVsbDsKICAgICAgICB0aGlzLmxvYWQgPSBudWxsOwogICAgICAgIHRoaXMuc291bmQgPSBudWxsOwogICAgICAgIHRoaXMuc3RhZ2UgPSBudWxsOwogICAgICAgIHRoaXMudGltZSA9IG51bGw7CiAgICAgICAgdGhpcy53b3JsZCA9IG51bGw7CiAgICAgICAgdGhpcy5pc0Jvb3RlZCA9IGZhbHNlOwoKICAgIH0KCn07CgovKioKKiBUaGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBHYW1lLiBBIHBhdXNlZCBnYW1lIGRvZXNuJ3QgdXBkYXRlIGFueSBvZiBpdHMgc3Vic3lzdGVtcy4KKiBXaGVuIGEgZ2FtZSBpcyBwYXVzZWQgdGhlIG9uUGF1c2UgZXZlbnQgaXMgZGlzcGF0Y2hlZC4gV2hlbiBpdCBpcyByZXN1bWVkIHRoZSBvblJlc3VtZSBldmVudCBpcyBkaXNwYXRjaGVkLgoqIEBuYW1lIFBoYXNlci5HYW1lI3BhdXNlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF1c2VkIC0gR2V0cyBhbmQgc2V0cyB0aGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBHYW1lLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdhbWUucHJvdG90eXBlLCAicGF1c2VkIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9wYXVzZWQ7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgCWlmICh2YWx1ZSA9PT0gdHJ1ZSkKICAgIAl7CiAgICAJCWlmICh0aGlzLl9wYXVzZWQgPT0gZmFsc2UpCiAgICAJCXsKCSAgICAJCXRoaXMuX3BhdXNlZCA9IHRydWU7CgkgICAgCQl0aGlzLm9uUGF1c2UuZGlzcGF0Y2godGhpcyk7CiAgICAJCX0KICAgIAl9CiAgICAJZWxzZQogICAgCXsKICAgIAkJaWYgKHRoaXMuX3BhdXNlZCkKICAgIAkJewoJICAgIAkJdGhpcy5fcGF1c2VkID0gZmFsc2U7CgkgICAgCQl0aGlzLm9uUmVzdW1lLmRpc3BhdGNoKHRoaXMpOwogICAgCQl9CiAgICAJfQoKICAgIH0KCn0pOwoKLyoqCiogIkRlbGV0ZWQgY29kZSBpcyBkZWJ1Z2dlZCBjb2RlLiIgLSBKZWZmIFNpY2tlbAoqLwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ29uc3RydWN0b3IgZm9yIFBoYXNlciBJbnB1dC4KKiBAY2xhc3MgUGhhc2VyLklucHV0CiogQGNsYXNzZGVzYyBBIGdhbWUgc3BlY2lmaWMgSW5wdXQgbWFuYWdlciB0aGF0IGxvb2tzIGFmdGVyIHRoZSBtb3VzZSwga2V5Ym9hcmQgYW5kIHRvdWNoIG9iamVjdHMuCiogVGhpcyBpcyB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuSW5wdXQgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGhpdENhbnZhcyAtIERlc2NyaXB0aW9uLiAKICAgICogQGRlZmF1bHQKCSovCiAgICB0aGlzLmhpdENhbnZhcyA9IG51bGw7CiAgICAKCS8qKgogICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gaGl0Q29udGV4dCAtIERlc2NyaXB0aW9uLiAKICAgICAqIEBkZWZhdWx0CiAJKi8KICAgIHRoaXMuaGl0Q29udGV4dCA9IG51bGw7CgkKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5JbnB1dC5NT1VTRV9PVkVSUklERVNfVE9VQ0ggPSAwOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLklucHV0LlRPVUNIX09WRVJSSURFU19NT1VTRSA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuSW5wdXQuTU9VU0VfVE9VQ0hfQ09NQklORSA9IDI7CgpQaGFzZXIuSW5wdXQucHJvdG90eXBlID0gewoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZQogICAgKi8JCiAgICBnYW1lOiBudWxsLAoKICAgIC8qKgogICAgKiBIb3cgb2Z0ZW4gc2hvdWxkIHRoZSBpbnB1dCBwb2ludGVycyBiZSBjaGVja2VkIGZvciB1cGRhdGVzPwogICAgKiBBIHZhbHVlIG9mIDAgbWVhbnMgZXZlcnkgc2luZ2xlIGZyYW1lICg2MGZwcyksIGEgdmFsdWUgb2YgMSBtZWFucyBldmVyeSBvdGhlciBmcmFtZSAoMzBmcHMpIGFuZCBzbyBvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBvbGxSYXRlIAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHBvbGxSYXRlOiAwLAogICAgCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcG9sbENvdW50ZXIgLSBEZXNjcmlwdGlvbi4KICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICBfcG9sbENvdW50ZXI6IDAsCgogICAgLyoqCiAgICAqIEEgdmVjdG9yIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHByZXZpb3VzIHBvc2l0aW9uIG9mIHRoZSBQb2ludGVyLgogICAgKiBAcHJvcGVydHkge1ZlYzJ9IHZlY3RvcgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICBfb2xkUG9zaXRpb246IG51bGwsCgogICAgLyoqCiAgICAqIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnQgUG9pbnRlciBldmVudAogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3gKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBfeDogMCwKCiAgICAvKioKICAgICogWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudCBQb2ludGVyIGV2ZW50CiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfeQogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIF95OiAwLAoKICAgIC8qKgogICAgKiBZb3UgY2FuIGRpc2FibGUgYWxsIElucHV0IGJ5IHNldHRpbmcgSW5wdXQuZGlzYWJsZWQ6IHRydWUuIFdoaWxlIHNldCBhbGwgbmV3IGlucHV0IHJlbGF0ZWQgZXZlbnRzIHdpbGwgYmUgaWdub3JlZC4KICAgICogSWYgeW91IG5lZWQgdG8gZGlzYWJsZSBqdXN0IG9uZSB0eXBlIG9mIGlucHV0LCBmb3IgZXhhbXBsZSBtb3VzZSwgdXNlIElucHV0Lm1vdXNlLmRpc2FibGVkOiB0cnVlIGluc3RlYWQKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkaXNhYmxlZAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGRpc2FibGVkOiBmYWxzZSwKCiAgICAvKioKICAgICogQ29udHJvbHMgdGhlIGV4cGVjdGVkIGJlaGF2aW91ciB3aGVuIHVzaW5nIGEgbW91c2UgYW5kIHRvdWNoIHRvZ2V0aGVyIG9uIGEgbXVsdGktaW5wdXQgZGV2aWNlLgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBtdWx0aUlucHV0T3ZlcnJpZGUKICAgICovCiAgICBtdWx0aUlucHV0T3ZlcnJpZGU6IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FLAoKICAgIC8qKgogICAgKiBBIHZlY3RvciBvYmplY3QgcmVwcmVzZW50aW5nIHRoZSBjdXJyZW50IHBvc2l0aW9uIG9mIHRoZSBQb2ludGVyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gcG9zaXRpb24KICAgICogQGRlZmF1bHQgCiAgICAqLwogICAgcG9zaXRpb246IG51bGwsCgogICAgLyoqCiAgICAqIEEgdmVjdG9yIG9iamVjdCByZXByZXNlbnRpbmcgdGhlIHNwZWVkIG9mIHRoZSBQb2ludGVyLiBPbmx5IHJlYWxseSB1c2VmdWwgaW4gc2luZ2xlIFBvaW50ZXIgZ2FtZXMsCiAgICAqIG90aGVyd2lzZSBzZWUgdGhlIFBvaW50ZXIgb2JqZWN0cyBkaXJlY3RseS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNwZWVkCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHNwZWVkOiBudWxsLAoKICAgIC8qKgogICAgKiBBIENpcmNsZSBvYmplY3QgY2VudGVyZWQgb24gdGhlIHgveSBzY3JlZW4gY29vcmRpbmF0ZXMgb2YgdGhlIElucHV0LgogICAgKiBEZWZhdWx0IHNpemUgb2YgNDRweCAoQXBwbGVzIHJlY29tbWVuZGVkICJmaW5nZXIgdGlwIiBzaXplKSBidXQgY2FuIGJlIGNoYW5nZWQgdG8gYW55dGhpbmcuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkNpcmNsZX0gY2lyY2xlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgY2lyY2xlOiBudWxsLAoKICAgIC8qKgogICAgKiBUaGUgc2NhbGUgYnkgd2hpY2ggYWxsIGlucHV0IGNvb3JkaW5hdGVzIGFyZSBtdWx0aXBsaWVkLCBjYWxjdWxhdGVkIGJ5IHRoZSBTdGFnZVNjYWxlTW9kZS4KICAgICogSW4gYW4gdW4tc2NhbGVkIGdhbWUgdGhlIHZhbHVlcyB3aWxsIGJlIHg6IDEgYW5kIHk6IDEuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHNjYWxlOiBudWxsLAoKICAgIC8qKgogICAgKiBUaGUgbWF4aW11bSBudW1iZXIgb2YgUG9pbnRlcnMgYWxsb3dlZCB0byBiZSBhY3RpdmUgYXQgYW55IG9uZSB0aW1lLgogICAgKiBGb3IgbG90cyBvZiBnYW1lcyBpdCdzIHVzZWZ1bCB0byBzZXQgdGhpcyB0byAxLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4UG9pbnRlcnMKICAgICogQGRlZmF1bHQKICAgICovCiAgICBtYXhQb2ludGVyczogMTAsCgogICAgLyoqCiAgICAqIFRoZSBjdXJyZW50IG51bWJlciBvZiBhY3RpdmUgUG9pbnRlcnMuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjdXJyZW50UG9pbnRlcnMKICAgICogQGRlZmF1bHQKICAgICovCiAgICBjdXJyZW50UG9pbnRlcnM6IDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgdGhlIFBvaW50ZXIgaGFzIHRvIGJlIHByZXNzZWQgZG93biBhbmQgdGhlbiByZWxlYXNlZCB0byBiZSBjb25zaWRlcmVkIGEgdGFwIG9yIGNsaWNrZQogICAgKiBAcHJvcGVydHkge251bWJlcn0gdGFwUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRhcFJhdGU6IDIwMCwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgYmV0d2VlbiB0YXBzIG9mIHRoZSBzYW1lIFBvaW50ZXIgZm9yIGl0IHRvIGJlIGNvbnNpZGVyZWQgYSBkb3VibGUgdGFwIC8gY2xpY2sKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGRvdWJsZVRhcFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBkb3VibGVUYXBSYXRlOiAzMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRoYXQgdGhlIFBvaW50ZXIgaGFzIHRvIGJlIHByZXNzZWQgZG93biBmb3IgaXQgdG8gZmlyZSBhIG9uSG9sZCBldmVudAogICAgKiBAcHJvcGVydHkge251bWJlcn0gaG9sZFJhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICBob2xkUmF0ZTogMjAwMCwKCiAgICAvKioKICAgICogVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgYmVsb3cgd2hpY2ggdGhlIFBvaW50ZXIgaXMgY29uc2lkZXJlZCBqdXN0UHJlc3NlZAogICAgKiBAcHJvcGVydHkge251bWJlcn0ganVzdFByZXNzZWRSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAganVzdFByZXNzZWRSYXRlOiAyMDAsCgogICAgLyoqCiAgICAqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGJlbG93IHdoaWNoIHRoZSBQb2ludGVyIGlzIGNvbnNpZGVyZWQganVzdFJlbGVhc2VkIAogICAgKiBAcHJvcGVydHkge251bWJlcn0ganVzdFJlbGVhc2VkUmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIGp1c3RSZWxlYXNlZFJhdGU6IDIwMCwKCiAgICAvKioKICAgICogU2V0cyBpZiB0aGUgUG9pbnRlciBvYmplY3RzIHNob3VsZCByZWNvcmQgYSBoaXN0b3J5IG9mIHgveSBjb29yZGluYXRlcyB0aGV5IGhhdmUgcGFzc2VkIHRocm91Z2guCiAgICAqIFRoZSBoaXN0b3J5IGlzIGNsZWFyZWQgZWFjaCB0aW1lIHRoZSBQb2ludGVyIGlzIHByZXNzZWQgZG93bi4KICAgICogVGhlIGhpc3RvcnkgaXMgdXBkYXRlZCBhdCB0aGUgcmF0ZSBzcGVjaWZpZWQgaW4gSW5wdXQucG9sbFJhdGUKICAgICogQHByb3BlcnR5IHtib29sZWFufSByZWNvcmRQb2ludGVySGlzdG9yeQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHJlY29yZFBvaW50ZXJIaXN0b3J5OiBmYWxzZSwKCiAgICAvKioKICAgICogVGhlIHJhdGUgaW4gbWlsbGlzZWNvbmRzIGF0IHdoaWNoIHRoZSBQb2ludGVyIG9iamVjdHMgc2hvdWxkIHVwZGF0ZSB0aGVpciB0cmFja2luZyBoaXN0b3J5CiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZWNvcmRSYXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgcmVjb3JkUmF0ZTogMTAwLAoKICAgIC8qKgogICAgKiBUaGUgdG90YWwgbnVtYmVyIG9mIGVudHJpZXMgdGhhdCBjYW4gYmUgcmVjb3JkZWQgaW50byB0aGUgUG9pbnRlciBvYmplY3RzIHRyYWNraW5nIGhpc3RvcnkuCiAgICAqIElmIHRoZSBQb2ludGVyIGlzIHRyYWNraW5nIG9uZSBldmVudCBldmVyeSAxMDBtcywgdGhlbiBhIHRyYWNrTGltaXQgb2YgMTAwIHdvdWxkIHN0b3JlIHRoZSBsYXN0IDEwIHNlY29uZHMgd29ydGggb2YgaGlzdG9yeS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHJlY29yZExpbWl0CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgcmVjb3JkTGltaXQ6IDEwMCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMQogICAgKi8KICAgIHBvaW50ZXIxOiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIyCiAgICAqLwogICAgcG9pbnRlcjI6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QgIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMwogICAgKi8KICAgIHBvaW50ZXIzOiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI0CiAgICAqLwogICAgcG9pbnRlcjQ6IG51bGwsCgogICAgLyoqCiAgICAqIEEgUG9pbnRlciBvYmplY3QKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjUKICAgICovCiAgICBwb2ludGVyNTogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyNgogICAgKi8KICAgIHBvaW50ZXI2OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0ICAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlcjcKICAgICovCiAgICBwb2ludGVyNzogbnVsbCwKCiAgICAvKioKICAgICogQSBQb2ludGVyIG9iamVjdAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyOAogICAgKi8KICAgIHBvaW50ZXI4OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0CiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXI5CiAgICAqLyAKICAgIHBvaW50ZXI5OiBudWxsLAoKICAgIC8qKgogICAgKiBBIFBvaW50ZXIgb2JqZWN0LgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBwb2ludGVyMTAKICAgICovCiAgICBwb2ludGVyMTA6IG51bGwsCgogICAgLyoqCiAgICAqIFRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBQb2ludGVyIG9iamVjdC4KICAgICogV2hlbiB5b3UndmUgbGltaXRlZCBtYXggcG9pbnRlcnMgdG8gMSB0aGlzIHdpbGwgYWNjdXJhdGVseSBiZSBlaXRoZXIgdGhlIGZpcnN0IGZpbmdlciB0b3VjaGVkIG9yIG1vdXNlLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludGVyfSBhY3RpdmVQb2ludGVyCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgYWN0aXZlUG9pbnRlcjogbnVsbCwKCiAgICAvKioKICAgICogVGhlIG1vdXNlIGhhcyBpdHMgb3duIHVuaXF1ZSBQaGFzZXIuUG9pbnRlciBvYmplY3Qgd2hpY2ggeW91IGNhbiB1c2UgaWYgbWFraW5nIGEgZGVza3RvcCBzcGVjaWZpYyBnYW1lLgogICAgKiBAcHJvcGVydHkge1BvaW50ZXJ9IG1vdXNlUG9pbnRlcgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG1vdXNlUG9pbnRlcjogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBNb3VzZSBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Nb3VzZX0gbW91c2UgLSBUaGUgTW91c2UgSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICBtb3VzZTogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBLZXlib2FyZCBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5LZXlib2FyZH0ga2V5Ym9hcmQgLSBUaGUgS2V5Ym9hcmQgSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICBrZXlib2FyZDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBUb3VjaCBJbnB1dCBtYW5hZ2VyLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Ub3VjaH0gdG91Y2ggLSB0aGUgVG91Y2ggSW5wdXQgbWFuYWdlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0b3VjaDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIFRoZSBNU1BvaW50ZXIgSW5wdXQgbWFuYWdlci4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuTVNQb2ludGVyfSBtc3BvaW50ZXIgLSBUaGUgTVNQb2ludGVyIElucHV0IG1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgbXNwb2ludGVyOiBudWxsLAoKICAgIC8qKgogICAgKiBBIFNpZ25hbCB0aGF0IGlzIGRpc3BhdGNoZWQgZWFjaCB0aW1lIGEgcG9pbnRlciBpcyBwcmVzc2VkIGRvd24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Eb3duCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgb25Eb3duOiBudWxsLAogICAgCiAgICAvKioKICAgICogQSBTaWduYWwgdGhhdCBpcyBkaXNwYXRjaGVkIGVhY2ggdGltZSBhIHBvaW50ZXIgaXMgcmVsZWFzZWQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25VcAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIG9uVXA6IG51bGwsCiAgICAKICAgIC8qKgogICAgKiBBIFNpZ25hbCB0aGF0IGlzIGRpc3BhdGNoZWQgZWFjaCB0aW1lIGEgcG9pbnRlciBpcyB0YXBwZWQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25UYXAKICAgICogQGRlZmF1bHQKICAgICovCiAgICBvblRhcDogbnVsbCwKICAgIAogICAgLyoqCiAgICAqIEEgU2lnbmFsIHRoYXQgaXMgZGlzcGF0Y2hlZCBlYWNoIHRpbWUgYSBwb2ludGVyIGlzIGhlbGQgZG93bi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkhvbGQKICAgICogQGRlZmF1bHQKICAgICovCiAgICBvbkhvbGQ6IG51bGwsCgogICAgLyoqCiAgICAqIEEgbGlua2VkIGxpc3Qgb2YgaW50ZXJhY3RpdmUgb2JqZWN0cywgdGhlIElucHV0SGFuZGxlciBjb21wb25lbnRzIChiZWxvbmdpbmcgdG8gU3ByaXRlcykgcmVnaXN0ZXIgdGhlbXNlbHZlcyB3aXRoIHRoaXMuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkxpbmtlZExpc3R9IGludGVyYWN0aXZlSXRlbXMKICAgICovCiAgICBpbnRlcmFjdGl2ZUl0ZW1zOiBuZXcgUGhhc2VyLkxpbmtlZExpc3QoKSwKCgkvKioKICAgICogU3RhcnRzIHRoZSBJbnB1dCBNYW5hZ2VyIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I2Jvb3QKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCgkgICAgdGhpcy5tb3VzZVBvaW50ZXIgPSBuZXcgUGhhc2VyLlBvaW50ZXIodGhpcy5nYW1lLCAwKTsKCSAgICB0aGlzLnBvaW50ZXIxID0gbmV3IFBoYXNlci5Qb2ludGVyKHRoaXMuZ2FtZSwgMSk7CgkgICAgdGhpcy5wb2ludGVyMiA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIDIpOwoKCSAgICB0aGlzLm1vdXNlID0gbmV3IFBoYXNlci5Nb3VzZSh0aGlzLmdhbWUpOwoJICAgIHRoaXMua2V5Ym9hcmQgPSBuZXcgUGhhc2VyLktleWJvYXJkKHRoaXMuZ2FtZSk7CgkgICAgdGhpcy50b3VjaCA9IG5ldyBQaGFzZXIuVG91Y2godGhpcy5nYW1lKTsKCSAgICB0aGlzLm1zcG9pbnRlciA9IG5ldyBQaGFzZXIuTVNQb2ludGVyKHRoaXMuZ2FtZSk7CgoJICAgIHRoaXMub25Eb3duID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCSAgICB0aGlzLm9uVXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoJICAgIHRoaXMub25UYXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoJICAgIHRoaXMub25Ib2xkID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCgkgICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgkgICAgdGhpcy5zcGVlZCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCSAgICB0aGlzLnBvc2l0aW9uID0gbmV3IFBoYXNlci5Qb2ludCgpOwoJICAgIHRoaXMuX29sZFBvc2l0aW9uID0gbmV3IFBoYXNlci5Qb2ludCgpOwoKCSAgICB0aGlzLmNpcmNsZSA9IG5ldyBQaGFzZXIuQ2lyY2xlKDAsIDAsIDQ0KTsKCgkgICAgdGhpcy5hY3RpdmVQb2ludGVyID0gdGhpcy5tb3VzZVBvaW50ZXI7CgkgICAgdGhpcy5jdXJyZW50UG9pbnRlcnMgPSAwOwoKCSAgICB0aGlzLmhpdENhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwoJICAgIHRoaXMuaGl0Q2FudmFzLndpZHRoID0gMTsKCSAgICB0aGlzLmhpdENhbnZhcy5oZWlnaHQgPSAxOwogICAgICAgIHRoaXMuaGl0Q29udGV4dCA9IHRoaXMuaGl0Q2FudmFzLmdldENvbnRleHQoJzJkJyk7CgogICAgICAgIHRoaXMubW91c2Uuc3RhcnQoKTsKICAgICAgICB0aGlzLmtleWJvYXJkLnN0YXJ0KCk7CiAgICAgICAgdGhpcy50b3VjaC5zdGFydCgpOwogICAgICAgIHRoaXMubXNwb2ludGVyLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5tb3VzZVBvaW50ZXIuYWN0aXZlID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyBhbGwgb2YgdGhlIElucHV0IE1hbmFnZXJzIGZyb20gcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjZGVzdHJveQogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5tb3VzZS5zdG9wKCk7CiAgICAgICAgdGhpcy5rZXlib2FyZC5zdG9wKCk7CiAgICAgICAgdGhpcy50b3VjaC5zdG9wKCk7CiAgICAgICAgdGhpcy5tc3BvaW50ZXIuc3RvcCgpOwoKICAgIH0sCgoJLyoqCiAgICAqIEFkZCBhIG5ldyBQb2ludGVyIG9iamVjdCB0byB0aGUgSW5wdXQgTWFuYWdlci4gQnkgZGVmYXVsdCBJbnB1dCBjcmVhdGVzIDMgcG9pbnRlciBvYmplY3RzOiBtb3VzZVBvaW50ZXIsIHBvaW50ZXIxIGFuZCBwb2ludGVyMi4KICAgICogSWYgeW91IG5lZWQgbW9yZSB0aGVuIHVzZSB0aGlzIHRvIGNyZWF0ZSBhIG5ldyBvbmUsIHVwIHRvIGEgbWF4aW11bSBvZiAxMC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjYWRkUG9pbnRlcgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gQSByZWZlcmVuY2UgdG8gdGhlIG5ldyBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyBjcmVhdGVkLgogICAgKi8KICAgIGFkZFBvaW50ZXI6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIG5leHQgPSAwOwoKICAgICAgICBmb3IgKHZhciBpID0gMTA7IGkgPiAwOyBpLS0pCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSA9PT0gbnVsbCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV4dCA9IGk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChuZXh0ID09IDApCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIllvdSBjYW4gb25seSBoYXZlIDEwIFBvaW50ZXIgb2JqZWN0cyIpOwogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpc1sncG9pbnRlcicgKyBuZXh0XSA9IG5ldyBQaGFzZXIuUG9pbnRlcih0aGlzLmdhbWUsIG5leHQpOwogICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBuZXh0XTsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogVXBkYXRlcyB0aGUgSW5wdXQgTWFuYWdlci4gQ2FsbGVkIGJ5IHRoZSBjb3JlIEdhbWUgbG9vcC4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjdXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMucG9sbFJhdGUgPiAwICYmIHRoaXMuX3BvbGxDb3VudGVyIDwgdGhpcy5wb2xsUmF0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvbGxDb3VudGVyKys7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3BlZWQueCA9IHRoaXMucG9zaXRpb24ueCAtIHRoaXMuX29sZFBvc2l0aW9uLng7CiAgICAgICAgdGhpcy5zcGVlZC55ID0gdGhpcy5wb3NpdGlvbi55IC0gdGhpcy5fb2xkUG9zaXRpb24ueTsKCiAgICAgICAgdGhpcy5fb2xkUG9zaXRpb24uY29weUZyb20odGhpcy5wb3NpdGlvbik7CiAgICAgICAgdGhpcy5tb3VzZVBvaW50ZXIudXBkYXRlKCk7CgogICAgICAgIHRoaXMucG9pbnRlcjEudXBkYXRlKCk7CiAgICAgICAgdGhpcy5wb2ludGVyMi51cGRhdGUoKTsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjMpIHsgdGhpcy5wb2ludGVyMy51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI0KSB7IHRoaXMucG9pbnRlcjQudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyNSkgeyB0aGlzLnBvaW50ZXI1LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjYpIHsgdGhpcy5wb2ludGVyNi51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXI3KSB7IHRoaXMucG9pbnRlcjcudXBkYXRlKCk7IH0KICAgICAgICBpZiAodGhpcy5wb2ludGVyOCkgeyB0aGlzLnBvaW50ZXI4LnVwZGF0ZSgpOyB9CiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjkpIHsgdGhpcy5wb2ludGVyOS51cGRhdGUoKTsgfQogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxMCkgeyB0aGlzLnBvaW50ZXIxMC51cGRhdGUoKTsgfQoKICAgICAgICB0aGlzLl9wb2xsQ291bnRlciA9IDA7CiAgICB9LAoKCS8qKgogICAgKiBSZXNldCBhbGwgb2YgdGhlIFBvaW50ZXJzIGFuZCBJbnB1dCBzdGF0ZXMKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjcmVzZXQKICAgICogQHBhcmFtIHtib29sZWFufSBoYXJkIC0gQSBzb2Z0IHJlc2V0IChoYXJkID0gZmFsc2UpIHdvbid0IHJlc2V0IGFueSBTaWduYWxzIHRoYXQgbWlnaHQgYmUgYm91bmQuIEEgaGFyZCByZXNldCB3aWxsLgogICAgKi8KICAgIHJlc2V0OiBmdW5jdGlvbiAoaGFyZCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlzQm9vdGVkID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBoYXJkID09ICd1bmRlZmluZWQnKSB7IGhhcmQgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLmtleWJvYXJkLnJlc2V0KCk7CiAgICAgICAgdGhpcy5tb3VzZVBvaW50ZXIucmVzZXQoKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPD0gMTA7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzWydwb2ludGVyJyArIGldLnJlc2V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuY3VycmVudFBvaW50ZXJzID0gMDsKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlLmN1cnNvciA9ICJkZWZhdWx0IjsKCiAgICAgICAgaWYgKGhhcmQgPT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Eb3duLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vblVwLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vblRhcC5kaXNwb3NlKCk7CiAgICAgICAgICAgIHRoaXMub25Ib2xkLmRpc3Bvc2UoKTsKICAgICAgICAgICAgdGhpcy5vbkRvd24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB0aGlzLm9uVXAgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwogICAgICAgICAgICB0aGlzLm9uVGFwID0gbmV3IFBoYXNlci5TaWduYWwoKTsKICAgICAgICAgICAgdGhpcy5vbkhvbGQgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgICAgICAgICAgdGhpcy5pbnRlcmFjdGl2ZUl0ZW1zLmNhbGxBbGwoJ3Jlc2V0Jyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9wb2xsQ291bnRlciA9IDA7CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXRzIHRoZSBzcGVlZCBhbmQgb2xkIHBvc2l0aW9uIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3Jlc2V0U3BlZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBTZXRzIHRoZSBvbGRQb3NpdGlvbi54IHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFNldHMgdGhlIG9sZFBvc2l0aW9uLnkgdmFsdWUuCiAgICAqLwogICAgcmVzZXRTcGVlZDogZnVuY3Rpb24gKHgsIHkpIHsKCiAgICAgICAgdGhpcy5fb2xkUG9zaXRpb24uc2V0VG8oeCwgeSk7CiAgICAgICAgdGhpcy5zcGVlZC5zZXRUbygwLCAwKTsKCiAgICB9LAoKCS8qKgogICAgKiBGaW5kIHRoZSBmaXJzdCBmcmVlIFBvaW50ZXIgb2JqZWN0IGFuZCBzdGFydCBpdCwgcGFzc2luZyBpbiB0aGUgZXZlbnQgZGF0YS4gVGhpcyBpcyBjYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuVG91Y2ggYW5kIFBoYXNlci5NU1BvaW50ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0I3N0YXJ0UG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyBzdGFydGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHN0YXJ0UG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLm1heFBvaW50ZXJzIDwgMTAgJiYgdGhpcy50b3RhbEFjdGl2ZVBvaW50ZXJzID09IHRoaXMubWF4UG9pbnRlcnMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxLnN0YXJ0KGV2ZW50KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5wb2ludGVyMi5hY3RpdmUgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMi5zdGFydChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldLnN0YXJ0KGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKICAgICogVXBkYXRlcyB0aGUgbWF0Y2hpbmcgUG9pbnRlciBvYmplY3QsIHBhc3NpbmcgaW4gdGhlIGV2ZW50IGRhdGEuIFRoaXMgaXMgY2FsbGVkIGF1dG9tYXRpY2FsbHkgYW5kIHNob3VsZCBub3Qgbm9ybWFsbHkgbmVlZCB0byBiZSBpbnZva2VkLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCN1cGRhdGVQb2ludGVyCiAgICAqIEBwYXJhbSB7QW55fSBldmVudCAtIFRoZSBldmVudCBkYXRhIGZyb20gdGhlIFRvdWNoIGV2ZW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gVGhlIFBvaW50ZXIgb2JqZWN0IHRoYXQgd2FzIHVwZGF0ZWQgb3IgbnVsbCBpZiBubyBQb2ludGVyIG9iamVjdCBpcyBhdmFpbGFibGUuCiAgICAqLwogICAgdXBkYXRlUG9pbnRlcjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnBvaW50ZXIxLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIxLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIxLm1vdmUoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnBvaW50ZXIyLmFjdGl2ZSAmJiB0aGlzLnBvaW50ZXIyLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBvaW50ZXIyLm1vdmUoZXZlbnQpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMzsgaSA8PSAxMDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSAmJiB0aGlzWydwb2ludGVyJyArIGldLmlkZW50aWZpZXIgPT0gZXZlbnQuaWRlbnRpZmllcikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1sncG9pbnRlcicgKyBpXS5tb3ZlKGV2ZW50KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKICAgICogU3RvcHMgdGhlIG1hdGNoaW5nIFBvaW50ZXIgb2JqZWN0LCBwYXNzaW5nIGluIHRoZSBldmVudCBkYXRhLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNzdG9wUG9pbnRlcgogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQgLSBUaGUgZXZlbnQgZGF0YSBmcm9tIHRoZSBUb3VjaCBldmVudC4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50ZXJ9IFRoZSBQb2ludGVyIG9iamVjdCB0aGF0IHdhcyBzdG9wcGVkIG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgaXMgYXZhaWxhYmxlLgogICAgKi8KICAgIHN0b3BQb2ludGVyOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuYWN0aXZlICYmIHRoaXMucG9pbnRlcjEuaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjEuc3RvcChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlICYmIHRoaXMucG9pbnRlcjIuaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjIuc3RvcChldmVudCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uaWRlbnRpZmllciA9PSBldmVudC5pZGVudGlmaWVyKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldLnN0b3AoZXZlbnQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKCS8qKgogICAgKiBHZXQgdGhlIG5leHQgUG9pbnRlciBvYmplY3Qgd2hvcyBhY3RpdmUgcHJvcGVydHkgbWF0Y2hlcyB0aGUgZ2l2ZW4gc3RhdGUKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXQjZ2V0UG9pbnRlcgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IHN0YXRlIC0gVGhlIHN0YXRlIHRoZSBQb2ludGVyIHNob3VsZCBiZSBpbiAoZmFsc2UgZm9yIGluYWN0aXZlLCB0cnVlIGZvciBhY3RpdmUpLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnRlcn0gQSBQb2ludGVyIG9iamVjdCBvciBudWxsIGlmIG5vIFBvaW50ZXIgb2JqZWN0IG1hdGNoZXMgdGhlIHJlcXVlc3RlZCBzdGF0ZS4KICAgICovCiAgICBnZXRQb2ludGVyOiBmdW5jdGlvbiAoc3RhdGUpIHsKCiAgICAgICAgc3RhdGUgPSBzdGF0ZSB8fCBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMucG9pbnRlcjEuYWN0aXZlID09IHN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjE7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMucG9pbnRlcjIuYWN0aXZlID09IHN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9pbnRlcjI7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGZvciAodmFyIGkgPSAzOyBpIDw9IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzWydwb2ludGVyJyArIGldICYmIHRoaXNbJ3BvaW50ZXInICsgaV0uYWN0aXZlID09IHN0YXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzWydwb2ludGVyJyArIGldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKCS8qKgogICAgKiBHZXQgdGhlIFBvaW50ZXIgb2JqZWN0IHdob3MgaWRlbnRpZmllZCBwcm9wZXJ0eSBtYXRjaGVzIHRoZSBnaXZlbiBpZGVudGlmaWVyIHZhbHVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dCNnZXRQb2ludGVyRnJvbUlkZW50aWZpZXIKICAgICogQHBhcmFtIHtudW1iZXJ9IGlkZW50aWZpZXIgLSBUaGUgUG9pbnRlci5pZGVudGlmaWVyIHZhbHVlIHRvIHNlYXJjaCBmb3IuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludGVyfSBBIFBvaW50ZXIgb2JqZWN0IG9yIG51bGwgaWYgbm8gUG9pbnRlciBvYmplY3QgbWF0Y2hlcyB0aGUgcmVxdWVzdGVkIGlkZW50aWZpZXIuCiAgICAqLwogICAgZ2V0UG9pbnRlckZyb21JZGVudGlmaWVyOiBmdW5jdGlvbiAoaWRlbnRpZmllcikgewoKICAgICAgICBpZiAodGhpcy5wb2ludGVyMS5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5wb2ludGVyMi5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wb2ludGVyMjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDM7IGkgPD0gMTA7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXNbJ3BvaW50ZXInICsgaV0gJiYgdGhpc1sncG9pbnRlcicgKyBpXS5pZGVudGlmaWVyID09IGlkZW50aWZpZXIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNbJ3BvaW50ZXInICsgaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0KCn07CgovKioKKiBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLiBUaGlzIHZhbHVlIHRha2VzIGdhbWUgc2NhbGluZyBpbnRvIGFjY291bnQgYXV0b21hdGljYWxseS4gU2VlIFBvaW50ZXIuc2NyZWVuWC9jbGllbnRYIGZvciBzb3VyY2UgdmFsdWVzLgoqIEBuYW1lIFBoYXNlci5JbnB1dCN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3g7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5feCA9IE1hdGguZmxvb3IodmFsdWUpOwogICAgfQoKfSk7CgovKioKKiBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLiBUaGlzIHZhbHVlIHRha2VzIGdhbWUgc2NhbGluZyBpbnRvIGFjY291bnQgYXV0b21hdGljYWxseS4gU2VlIFBvaW50ZXIuc2NyZWVuWS9jbGllbnRZIGZvciBzb3VyY2UgdmFsdWVzLgoqIEBuYW1lIFBoYXNlci5JbnB1dCN5CiogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBtb3N0IHJlY2VudGx5IGFjdGl2ZSBwb2ludGVyLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgInkiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl95OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX3kgPSBNYXRoLmZsb29yKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLklucHV0I3BvbGxMb2NrZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBvbGxMb2NrZWQgLSBUcnVlIGlmIHRoZSBJbnB1dCBpcyBjdXJyZW50bHkgcG9sbCByYXRlIGxvY2tlZC4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJwb2xsTG9ja2VkIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy5wb2xsUmF0ZSA+IDAgJiYgdGhpcy5fcG9sbENvdW50ZXIgPCB0aGlzLnBvbGxSYXRlKTsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHRvdGFsIG51bWJlciBvZiBpbmFjdGl2ZSBQb2ludGVycwoqIEBuYW1lIFBoYXNlci5JbnB1dCN0b3RhbEluYWN0aXZlUG9pbnRlcnMKKiBAcHJvcGVydHkge251bWJlcn0gdG90YWxJbmFjdGl2ZVBvaW50ZXJzIC0gVGhlIHRvdGFsIG51bWJlciBvZiBpbmFjdGl2ZSBQb2ludGVycy4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5JbnB1dC5wcm90b3R5cGUsICJ0b3RhbEluYWN0aXZlUG9pbnRlcnMiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIDEwIC0gdGhpcy5jdXJyZW50UG9pbnRlcnM7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB0b3RhbCBudW1iZXIgb2YgYWN0aXZlIFBvaW50ZXJzCiogQG5hbWUgUGhhc2VyLklucHV0I3RvdGFsQWN0aXZlUG9pbnRlcnMKKiBAcHJvcGVydHkge251bWJlcn0gdG90YWxBY3RpdmVQb2ludGVycyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgYWN0aXZlIFBvaW50ZXJzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLklucHV0LnByb3RvdHlwZSwgInRvdGFsQWN0aXZlUG9pbnRlcnMiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmN1cnJlbnRQb2ludGVycyA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDw9IDEwOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpc1sncG9pbnRlcicgKyBpXSAmJiB0aGlzWydwb2ludGVyJyArIGldLmFjdGl2ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50UG9pbnRlcnMrKzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFBvaW50ZXJzOwoKICAgIH0KCn0pOwoKLyoqCiogVGhlIHdvcmxkIFggY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjd29ybGRYCiogQHByb3BlcnR5IHtudW1iZXJ9IHdvcmxkWCAtIFRoZSB3b3JsZCBYIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAid29ybGRYIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueCArIHRoaXMueDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHdvcmxkIFkgY29vcmRpbmF0ZSBvZiB0aGUgbW9zdCByZWNlbnRseSBhY3RpdmUgcG9pbnRlci4KKiBAbmFtZSBQaGFzZXIuSW5wdXQjd29ybGRZCiogQHByb3BlcnR5IHtudW1iZXJ9IHdvcmxkWSAtIFRoZSB3b3JsZCBZIGNvb3JkaW5hdGUgb2YgdGhlIG1vc3QgcmVjZW50bHkgYWN0aXZlIHBvaW50ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuSW5wdXQucHJvdG90eXBlLCAid29ybGRZIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLmdhbWUuY2FtZXJhLnZpZXcueSArIHRoaXMueTsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQGNsYXNzIFBoYXNlci5LZXkKKiBAY2xhc3NkZXNjIElmIHlvdSBuZWVkIG1vcmUgZmluZS1ncmFpbmVkIGNvbnRyb2wgb3ZlciB0aGUgaGFuZGxpbmcgb2Ygc3BlY2lmaWMga2V5cyB5b3UgY2FuIGNyZWF0ZSBhbmQgdXNlIFBoYXNlci5LZXkgb2JqZWN0cy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleSBjb2RlIHRoaXMgS2V5IGlzIHJlc3BvbnNpYmxlIGZvci4KKi8KUGhhc2VyLktleSA9IGZ1bmN0aW9uIChnYW1lLCBrZXljb2RlKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc0Rvd24gLSBUaGUgImRvd24iIHN0YXRlIG9mIHRoZSBrZXkuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc0Rvd24gPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBpc1VwIC0gVGhlICJ1cCIgc3RhdGUgb2YgdGhlIGtleS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmlzVXAgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhbHRLZXkgLSBUaGUgZG93biBzdGF0ZSBvZiB0aGUgQUxUIGtleSwgaWYgcHJlc3NlZCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoaXMga2V5LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuYWx0S2V5ID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3RybEtleSAtIFRoZSBkb3duIHN0YXRlIG9mIHRoZSBDVFJMIGtleSwgaWYgcHJlc3NlZCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoaXMga2V5LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuY3RybEtleSA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHNoaWZ0S2V5IC0gVGhlIGRvd24gc3RhdGUgb2YgdGhlIFNISUZUIGtleSwgaWYgcHJlc3NlZCBhdCB0aGUgc2FtZSB0aW1lIGFzIHRoaXMga2V5LgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuc2hpZnRLZXkgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVEb3duIC0gVGhlIHRpbWVzdGFtcCB3aGVuIHRoZSBrZXkgd2FzIGxhc3QgcHJlc3NlZCBkb3duLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudGltZURvd24gPSAwOwoKCS8qKgoJKiBJZiB0aGUga2V5IGlzIGRvd24gdGhpcyB2YWx1ZSBob2xkcyB0aGUgZHVyYXRpb24gb2YgdGhhdCBrZXkgcHJlc3MgYW5kIGlzIGNvbnN0YW50bHkgdXBkYXRlZC4KCSogSWYgdGhlIGtleSBpcyB1cCBpdCBob2xkcyB0aGUgZHVyYXRpb24gb2YgdGhlIHByZXZpb3VzIGRvd24gc2Vzc2lvbi4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdGhpcyBrZXkgaGFzIGJlZW4gaGVsZCBkb3duIGZvci4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmR1cmF0aW9uID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVVcCAtIFRoZSB0aW1lc3RhbXAgd2hlbiB0aGUga2V5IHdhcyBsYXN0IHJlbGVhc2VkLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudGltZVVwID0gMDsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHJlcGVhdHMgLSBJZiBhIGtleSBpcyBoZWxkIGRvd24gdGhpcyBob2xkcyBkb3duIHRoZSBudW1iZXIgb2YgdGltZXMgdGhlIGtleSBoYXMgJ3JlcGVhdGVkJy4KCSogQGRlZmF1bHQKCSovCgl0aGlzLnJlcGVhdHMgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0ga2V5Q29kZSAtIFRoZSBrZXljb2RlIG9mIHRoaXMga2V5LgoJKi8KCXRoaXMua2V5Q29kZSA9IGtleWNvZGU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Eb3duIC0gVGhpcyBTaWduYWwgaXMgZGlzcGF0Y2hlZCBldmVyeSB0aW1lIHRoaXMgS2V5IGlzIHByZXNzZWQgZG93bi4gSXQgaXMgb25seSBkaXNwYXRjaGVkIG9uY2UgKHVudGlsIHRoZSBrZXkgaXMgcmVsZWFzZWQgYWdhaW4pLgoJKi8KICAgIHRoaXMub25Eb3duID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblVwIC0gVGhpcyBTaWduYWwgaXMgZGlzcGF0Y2hlZCBldmVyeSB0aW1lIHRoaXMgS2V5IGlzIHByZXNzZWQgZG93bi4gSXQgaXMgb25seSBkaXNwYXRjaGVkIG9uY2UgKHVudGlsIHRoZSBrZXkgaXMgcmVsZWFzZWQgYWdhaW4pLgoJKi8KICAgIHRoaXMub25VcCA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgkKfTsKClBoYXNlci5LZXkucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBQaGFzZXIuS2V5Ym9hcmQuCiAgICAqIEBtZXRob2QgUGhhc2VyLktleSNwcm9jZXNzS2V5RG93bgogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50LgogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgcHJvY2Vzc0tleURvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmFsdEtleSA9IGV2ZW50LmFsdEtleTsKICAgICAgICB0aGlzLmN0cmxLZXkgPSBldmVudC5jdHJsS2V5OwogICAgICAgIHRoaXMuc2hpZnRLZXkgPSBldmVudC5zaGlmdEtleTsKCiAgICAgICAgaWYgKHRoaXMuaXNEb3duKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIEtleSB3YXMgYWxyZWFkeSBoZWxkIGRvd24sIHRoaXMgbXVzdCBiZSBhIHJlcGVhdCByYXRlIGJhc2VkIGV2ZW50CiAgICAgICAgICAgIHRoaXMuZHVyYXRpb24gPSBldmVudC50aW1lU3RhbXAgLSB0aGlzLnRpbWVEb3duOwogICAgICAgICAgICB0aGlzLnJlcGVhdHMrKzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICB0aGlzLmlzVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy50aW1lRG93biA9IGV2ZW50LnRpbWVTdGFtcDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbiA9IDA7CiAgICAgICAgICAgIHRoaXMucmVwZWF0cyA9IDA7CgogICAgICAgICAgICB0aGlzLm9uRG93bi5kaXNwYXRjaCh0aGlzKTsKICAgICAgICB9CgogICAgfSwKCgkvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgUGhhc2VyLktleWJvYXJkLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXkjcHJvY2Vzc0tleVVwCiAgICAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQuCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcm9jZXNzS2V5VXA6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmlzRG93biA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNVcCA9IHRydWU7CiAgICAgICAgdGhpcy50aW1lVXAgPSBldmVudC50aW1lU3RhbXA7CgogICAgICAgIHRoaXMub25VcC5kaXNwYXRjaCh0aGlzKTsKCiAgICB9LAoKCS8qKgoJKiBSZXR1cm5zIHRoZSAianVzdCBwcmVzc2VkIiBzdGF0ZSBvZiB0aGUgS2V5LiBKdXN0IHByZXNzZWQgaXMgY29uc2lkZXJlZCB0cnVlIGlmIHRoZSBrZXkgd2FzIHByZXNzZWQgZG93biB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKQogICAgKiBAbWV0aG9kIFBoYXNlci5LZXkjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHByZXNzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgcmV0dXJuICh0aGlzLmlzRG93biAmJiB0aGlzLmR1cmF0aW9uIDwgZHVyYXRpb24pOwoKICAgIH0sCgoJLyoqCgkqIFJldHVybnMgdGhlICJqdXN0IHJlbGVhc2VkIiBzdGF0ZSBvZiB0aGUgS2V5LiBKdXN0IHJlbGVhc2VkIGlzIGNvbnNpZGVyZWQgYXMgYmVpbmcgdHJ1ZSBpZiB0aGUga2V5IHdhcyByZWxlYXNlZCB3aXRoaW4gdGhlIGR1cmF0aW9uIGdpdmVuIChkZWZhdWx0IDI1MG1zKQogICAgKiBAbWV0aG9kIFBoYXNlci5LZXkjanVzdFByZXNzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHJlbGVhc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCByZWxlYXNlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgcmV0dXJuICh0aGlzLmlzRG93biA9PSBmYWxzZSAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy50aW1lVXAgPCBkdXJhdGlvbikpOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBLZXlib2FyZCBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuS2V5Ym9hcmQKKiBAY2xhc3NkZXNjIEEgS2V5Ym9hcmQgb2JqZWN0IERlc2NyaXB0aW9uLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLktleWJvYXJkID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgkKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfa2V5cyAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2tleXMgPSB7fTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9ob3RrZXlzIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faG90a2V5cyA9IHt9OwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfY2FwdHVyZSAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2NhcHR1cmUgPSB7fTsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBLZXlib2FyZCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkIHRvIHRydWUuIFdoaWxlIHRydWUgYWxsIG5ldyBpbnB1dCByZWxhdGVkIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQgLSBUaGUgZGlzYWJsZWQgc3RhdGUgb2YgdGhlIEtleWJvYXJkLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uS2V5RG93bgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uS2V5RG93biA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25LZXlVcAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uS2V5VXAgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge09iamVjdH0gY2FsbGJhY2tDb250ZXh0IC0gVGhlIGNvbnRleHQgdW5kZXIgd2hpY2ggdGhlIGNhbGxiYWNrcyBhcmUgcnVuLgogICAgKi8KICAgIHRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpczsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gb25Eb3duQ2FsbGJhY2sgLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyBwcmVzc2VkIGRvd24uCiAgICAqLwogICAgdGhpcy5vbkRvd25DYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG9uVXBDYWxsYmFjayAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHJlbGVhc2VkLgogICAgKi8KICAgIHRoaXMub25VcENhbGxiYWNrID0gbnVsbDsKCQp9OwoKUGhhc2VyLktleWJvYXJkLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGNhbGxiYWNrcyB0byB0aGUgS2V5Ym9hcmQgaGFuZGxlciBzbyB0aGF0IGVhY2ggdGltZSBhIGtleSBpcyBwcmVzc2VkIGRvd24gb3IgcmVsZWFzZXMgdGhlIGNhbGxiYWNrcyBhcmUgYWN0aXZhdGVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNhZGRDYWxsYmFja3MKICAgICogQHBhcmFtIHtPYmplY3R9IGNvbnRleHQgLSBUaGUgY29udGV4dCB1bmRlciB3aGljaCB0aGUgY2FsbGJhY2tzIGFyZSBydW4uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IG9uRG93biAtIFRoaXMgY2FsbGJhY2sgaXMgaW52b2tlZCBldmVyeSB0aW1lIGEga2V5IGlzIHByZXNzZWQgZG93bi4KICAgICogQHBhcmFtIHtmdW5jdGlvbn0gW29uVXA9bnVsbF0gLSBUaGlzIGNhbGxiYWNrIGlzIGludm9rZWQgZXZlcnkgdGltZSBhIGtleSBpcyByZWxlYXNlZC4KICAgICovCiAgICBhZGRDYWxsYmFja3M6IGZ1bmN0aW9uIChjb250ZXh0LCBvbkRvd24sIG9uVXApIHsKCiAgICAgICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSBjb250ZXh0OwogICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2sgPSBvbkRvd247CgogICAgICAgIGlmICh0eXBlb2Ygb25VcCAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9uVXBDYWxsYmFjayA9IG9uVXA7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHlvdSBuZWVkIG1vcmUgZmluZS1ncmFpbmVkIGNvbnRyb2wgb3ZlciBhIEtleSB5b3UgY2FuIGNyZWF0ZSBhIG5ldyBQaGFzZXIuS2V5IG9iamVjdCB2aWEgdGhpcyBtZXRob2QuCiAgICAqIFRoZSBLZXkgb2JqZWN0IGNhbiB0aGVuIGJlIHBvbGxlZCwgaGF2ZSBldmVudHMgYXR0YWNoZWQgdG8gaXQsIGV0Yy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjYWRkS2V5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFX0JBUgogICAgKiBAcmV0dXJuIHtQaGFzZXIuS2V5fSBUaGUgS2V5IG9iamVjdCB3aGljaCB5b3UgY2FuIHN0b3JlIGxvY2FsbHkgYW5kIHJlZmVyZW5jZSBkaXJlY3RseS4KICAgICovCiAgICBhZGRLZXk6IGZ1bmN0aW9uIChrZXljb2RlKSB7CgogICAgICAgIHRoaXMuX2hvdGtleXNba2V5Y29kZV0gPSBuZXcgUGhhc2VyLktleSh0aGlzLmdhbWUsIGtleWNvZGUpOwoKICAgICAgICB0aGlzLmFkZEtleUNhcHR1cmUoa2V5Y29kZSk7CgogICAgICAgIHJldHVybiB0aGlzLl9ob3RrZXlzW2tleWNvZGVdOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSBLZXkgb2JqZWN0IGZyb20gdGhlIEtleWJvYXJkIG1hbmFnZXIuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3JlbW92ZUtleQogICAgKiBAcGFyYW0ge251bWJlcn0ga2V5Y29kZSAtIFRoZSBrZXljb2RlIG9mIHRoZSBrZXkgdG8gcmVtb3ZlLCBpLmUuIFBoYXNlci5LZXlib2FyZC5VUCBvciBQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VfQkFSCiAgICAqLwogICAgcmVtb3ZlS2V5OiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBkZWxldGUgKHRoaXMuX2hvdGtleXNba2V5Y29kZV0pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYW5kIHJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgNCBob3RrZXlzIGZvciBVcCwgRG93biwgTGVmdCBhbmQgUmlnaHQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2NyZWF0ZUN1cnNvcktleXMKICAgICogQHJldHVybiB7b2JqZWN0fSBBbiBvYmplY3QgY29udGFpbmluZyBwcm9wZXJ0aWVzOiB1cCwgZG93biwgbGVmdCBhbmQgcmlnaHQuIFdoaWNoIGNhbiBiZSBwb2xsZWQgbGlrZSBhbnkgb3RoZXIgUGhhc2VyLktleSBvYmplY3QuCiAgICAqLwogICAgY3JlYXRlQ3Vyc29yS2V5czogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4geyAKICAgICAgICAgICAgdXA6IHRoaXMuYWRkS2V5KFBoYXNlci5LZXlib2FyZC5VUCksIAogICAgICAgICAgICBkb3duOiB0aGlzLmFkZEtleShQaGFzZXIuS2V5Ym9hcmQuRE9XTiksIAogICAgICAgICAgICBsZWZ0OiB0aGlzLmFkZEtleShQaGFzZXIuS2V5Ym9hcmQuTEVGVCksIAogICAgICAgICAgICByaWdodDogdGhpcy5hZGRLZXkoUGhhc2VyLktleWJvYXJkLlJJR0hUKQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdGFydHMgdGhlIEtleWJvYXJkIGV2ZW50IGxpc3RlbmVycyBydW5uaW5nIChrZXlkb3duIGFuZCBrZXl1cCkuIFRoZXkgYXJlIGF0dGFjaGVkIHRvIHRoZSBkb2N1bWVudC5ib2R5LgogICAgKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5JbnB1dCBhbmQgc2hvdWxkIG5vdCBub3JtYWxseSBiZSBpbnZva2VkIGRpcmVjdGx5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNzdGFydAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgIHRoaXMuX29uS2V5RG93biA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMucHJvY2Vzc0tleURvd24oZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX29uS2V5VXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLnByb2Nlc3NLZXlVcChldmVudCk7CiAgICAgICAgfTsKCiAgICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5fb25LZXlEb3duLCBmYWxzZSk7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hZGRFdmVudExpc3RlbmVyKCdrZXl1cCcsIHRoaXMuX29uS2V5VXAsIGZhbHNlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyB0aGUgS2V5Ym9hcmQgZXZlbnQgbGlzdGVuZXJzIGZyb20gcnVubmluZyAoa2V5ZG93biBhbmQga2V5dXApLiBUaGV5IGFyZSByZW1vdmVkIGZyb20gdGhlIGRvY3VtZW50LmJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuX29uS2V5RG93bik7CiAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXl1cCcsIHRoaXMuX29uS2V5VXApOwoKICAgIH0sCgoJLyoqCiAgICAqIEJ5IGRlZmF1bHQgd2hlbiBhIGtleSBpcyBwcmVzc2VkIFBoYXNlciB3aWxsIG5vdCBzdG9wIHRoZSBldmVudCBmcm9tIHByb3BhZ2F0aW5nIHVwIHRvIHRoZSBicm93c2VyLgogICAgKiBUaGVyZSBhcmUgc29tZSBrZXlzIHRoaXMgY2FuIGJlIGFubm95aW5nIGZvciwgbGlrZSB0aGUgYXJyb3cga2V5cyBvciBzcGFjZSBiYXIsIHdoaWNoIG1ha2UgdGhlIGJyb3dzZXIgd2luZG93IHNjcm9sbC4KICAgICogWW91IGNhbiB1c2UgYWRkS2V5Q2FwdHVyZSB0byBjb25zdW1lIHRoZSBrZXlib2FyZCBldmVudCBmb3Igc3BlY2lmaWMga2V5cyBzbyBpdCBkb2Vzbid0IGJ1YmJsZSB1cCB0byB0aGUgdGhlIGJyb3dzZXIuCiAgICAqIFBhc3MgaW4gZWl0aGVyIGEgc2luZ2xlIGtleWNvZGUgb3IgYW4gYXJyYXkvaGFzaCBvZiBrZXljb2Rlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjYWRkS2V5Q2FwdHVyZQogICAgKiBAcGFyYW0ge0FueX0ga2V5Y29kZQogICAgKi8KICAgIGFkZEtleUNhcHR1cmU6IGZ1bmN0aW9uIChrZXljb2RlKSB7CgogICAgICAgIGlmICh0eXBlb2Yga2V5Y29kZSA9PT0gJ29iamVjdCcpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4ga2V5Y29kZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fY2FwdHVyZVtrZXljb2RlW2tleV1dID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYXB0dXJlW2tleWNvZGVdID0gdHJ1ZTsKICAgICAgICB9CiAgICB9LAoKCS8qKgoJKiBSZW1vdmVzIGFuIGV4aXN0aW5nIGtleSBjYXB0dXJlLgoJKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNyZW1vdmVLZXlDYXB0dXJlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlCiAgICAqLwogICAgcmVtb3ZlS2V5Q2FwdHVyZTogZnVuY3Rpb24gKGtleWNvZGUpIHsKCiAgICAgICAgZGVsZXRlIHRoaXMuX2NhcHR1cmVba2V5Y29kZV07CgogICAgfSwKCgkvKioKCSogQ2xlYXIgYWxsIHNldCBrZXkgY2FwdHVyZXMuCgkqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2NsZWFyQ2FwdHVyZXMKICAgICovCiAgICBjbGVhckNhcHR1cmVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2NhcHR1cmUgPSB7fTsKCiAgICB9LAoKCS8qKgoJKiBQcm9jZXNzIHRoZSBrZXlkb3duIGV2ZW50LgoJKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNwcm9jZXNzS2V5RG93bgogICAgKiBAcGFyYW0ge0tleWJvYXJkRXZlbnR9IGV2ZW50CiAgICAqIEBwcm90ZWN0ZWQKICAgICovICAgIAogICAgcHJvY2Vzc0tleURvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fY2FwdHVyZVtldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5vbkRvd25DYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25Eb3duQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0gJiYgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24pCiAgICAgICAgewogICAgICAgICAgICAvLyAgS2V5IGFscmVhZHkgZG93biBhbmQgc3RpbGwgZG93biwgc28gdXBkYXRlCiAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uZHVyYXRpb24gPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLnRpbWVEb3duOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoIXRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBOb3QgdXNlZCB0aGlzIGtleSBiZWZvcmUsIHNvIHJlZ2lzdGVyIGl0CiAgICAgICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdID0gewogICAgICAgICAgICAgICAgICAgIGlzRG93bjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICB0aW1lRG93bjogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgICAgIHRpbWVVcDogMCwKICAgICAgICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBLZXkgdXNlZCBiZWZvcmUgYnV0IGZyZXNobHkgZG93bgogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS5pc0Rvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXS50aW1lRG93biA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgICAgIHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0uZHVyYXRpb24gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2hvdGtleXNbZXZlbnQua2V5Q29kZV0ucHJvY2Vzc0tleURvd24oZXZlbnQpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBQcm9jZXNzIHRoZSBrZXl1cCBldmVudC4KCSogQG1ldGhvZCBQaGFzZXIuS2V5Ym9hcmQjcHJvY2Vzc0tleVVwCiAgICAqIEBwYXJhbSB7S2V5Ym9hcmRFdmVudH0gZXZlbnQKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHByb2Nlc3NLZXlVcDogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9jYXB0dXJlW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLm9uVXBDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub25VcENhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLl9ob3RrZXlzW2V2ZW50LmtleUNvZGVdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5faG90a2V5c1tldmVudC5rZXlDb2RlXS5wcm9jZXNzS2V5VXAoZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNbZXZlbnQua2V5Q29kZV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLmlzRG93biA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9rZXlzW2V2ZW50LmtleUNvZGVdLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vdCB1c2VkIHRoaXMga2V5IGJlZm9yZSwgc28gcmVnaXN0ZXIgaXQKICAgICAgICAgICAgdGhpcy5fa2V5c1tldmVudC5rZXlDb2RlXSA9IHsKICAgICAgICAgICAgICAgIGlzRG93bjogZmFsc2UsCiAgICAgICAgICAgICAgICB0aW1lRG93bjogdGhpcy5nYW1lLnRpbWUubm93LAogICAgICAgICAgICAgICAgdGltZVVwOiB0aGlzLmdhbWUudGltZS5ub3csCiAgICAgICAgICAgICAgICBkdXJhdGlvbjogMAogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBSZXNldCB0aGUgImlzRG93biIgc3RhdGUgb2YgYWxsIGtleXMuCgkqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI3Jlc2V0CiAgICAqLwogICAgcmVzZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuX2tleXMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9rZXlzW2tleV0uaXNEb3duID0gZmFsc2U7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlICJqdXN0IHByZXNzZWQiIHN0YXRlIG9mIHRoZSBrZXkuIEp1c3QgcHJlc3NlZCBpcyBjb25zaWRlcmVkIHRydWUgaWYgdGhlIGtleSB3YXMgcHJlc3NlZCBkb3duIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRV9CQVIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHByZXNzZWQuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGtleSBpcyBqdXN0IHByZXNzZWQgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoa2V5Y29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd24gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5kdXJhdGlvbiA8IGR1cmF0aW9uKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgImp1c3QgcmVsZWFzZWQiIHN0YXRlIG9mIHRoZSBLZXkuIEp1c3QgcmVsZWFzZWQgaXMgY29uc2lkZXJlZCBhcyBiZWluZyB0cnVlIGlmIHRoZSBrZXkgd2FzIHJlbGVhc2VkIHdpdGhpbiB0aGUgZHVyYXRpb24gZ2l2ZW4gKGRlZmF1bHQgMjUwbXMpCiAgICAqIEBtZXRob2QgUGhhc2VyLktleWJvYXJkI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBrZXljb2RlIC0gVGhlIGtleWNvZGUgb2YgdGhlIGtleSB0byByZW1vdmUsIGkuZS4gUGhhc2VyLktleWJvYXJkLlVQIG9yIFBoYXNlci5LZXlib2FyZC5TUEFDRV9CQVIKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbj0yNTBdIC0gVGhlIGR1cmF0aW9uIGJlbG93IHdoaWNoIHRoZSBrZXkgaXMgY29uc2lkZXJlZCBhcyBiZWluZyBqdXN0IHJlbGVhc2VkLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMganVzdCByZWxlYXNlZCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAganVzdFJlbGVhc2VkOiBmdW5jdGlvbiAoa2V5Y29kZSwgZHVyYXRpb24pIHsKCiAgICAgICAgaWYgKHR5cGVvZiBkdXJhdGlvbiA9PT0gInVuZGVmaW5lZCIpIHsgZHVyYXRpb24gPSAyNTA7IH0KCiAgICAgICAgaWYgKHRoaXMuX2tleXNba2V5Y29kZV0gJiYgdGhpcy5fa2V5c1trZXljb2RlXS5pc0Rvd24gPT09IGZhbHNlICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9rZXlzW2tleWNvZGVdLnRpbWVVcCA8IGR1cmF0aW9uKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBvZiB0aGUga2V5IGlzIGN1cnJlbnRseSBwcmVzc2VkIGRvd24uIE5vdGUgdGhhdCBpdCBjYW4gb25seSBkZXRlY3Qga2V5IHByZXNzZXMgb24gdGhlIHdlYiBicm93c2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5LZXlib2FyZCNpc0Rvd24KICAgICogQHBhcmFtIHtudW1iZXJ9IGtleWNvZGUgLSBUaGUga2V5Y29kZSBvZiB0aGUga2V5IHRvIHJlbW92ZSwgaS5lLiBQaGFzZXIuS2V5Ym9hcmQuVVAgb3IgUGhhc2VyLktleWJvYXJkLlNQQUNFX0JBUgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBrZXkgaXMgY3VycmVudGx5IGRvd24uCiAgICAqLwogICAgaXNEb3duOiBmdW5jdGlvbiAoa2V5Y29kZSkgewoKICAgICAgICBpZiAodGhpcy5fa2V5c1trZXljb2RlXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9rZXlzW2tleWNvZGVdLmlzRG93bjsKICAgICAgICB9CgoJCXJldHVybiBmYWxzZTsKCiAgICB9Cgp9OwoKUGhhc2VyLktleWJvYXJkLkEgPSAiQSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkIgPSAiQiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkMgPSAiQyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkQgPSAiRCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkUgPSAiRSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkYgPSAiRiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkcgPSAiRyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkggPSAiSCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkkgPSAiSSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkogPSAiSiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLksgPSAiSyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLkwgPSAiTCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk0gPSAiTSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk4gPSAiTiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk8gPSAiTyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlAgPSAiUCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlEgPSAiUSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlIgPSAiUiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlMgPSAiUyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlQgPSAiVCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlUgPSAiVSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlYgPSAiViIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlcgPSAiVyIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlggPSAiWCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlkgPSAiWSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlogPSAiWiIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLlpFUk8gPSAiMCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk9ORSA9ICIxIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuVFdPID0gIjIiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5USFJFRSA9ICIzIi5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRk9VUiA9ICI0Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRklWRSA9ICI1Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuU0lYID0gIjYiLmNoYXJDb2RlQXQoMCk7ClBoYXNlci5LZXlib2FyZC5TRVZFTiA9ICI3Ii5jaGFyQ29kZUF0KDApOwpQaGFzZXIuS2V5Ym9hcmQuRUlHSFQgPSAiOCIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk5JTkUgPSAiOSIuY2hhckNvZGVBdCgwKTsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8wID0gOTY7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfMSA9IDk3OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzIgPSA5ODsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF8zID0gOTk7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNCA9IDEwMDsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF81ID0gMTAxOwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzYgPSAxMDI7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfNyA9IDEwMzsKUGhhc2VyLktleWJvYXJkLk5VTVBBRF84ID0gMTA0OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEXzkgPSAxMDU7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfTVVMVElQTFkgPSAxMDY7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfQUREID0gMTA3OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0VOVEVSID0gMTA4OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX1NVQlRSQUNUID0gMTA5OwpQaGFzZXIuS2V5Ym9hcmQuTlVNUEFEX0RFQ0lNQUwgPSAxMTA7ClBoYXNlci5LZXlib2FyZC5OVU1QQURfRElWSURFID0gMTExOwpQaGFzZXIuS2V5Ym9hcmQuRjEgPSAxMTI7ClBoYXNlci5LZXlib2FyZC5GMiA9IDExMzsKUGhhc2VyLktleWJvYXJkLkYzID0gMTE0OwpQaGFzZXIuS2V5Ym9hcmQuRjQgPSAxMTU7ClBoYXNlci5LZXlib2FyZC5GNSA9IDExNjsKUGhhc2VyLktleWJvYXJkLkY2ID0gMTE3OwpQaGFzZXIuS2V5Ym9hcmQuRjcgPSAxMTg7ClBoYXNlci5LZXlib2FyZC5GOCA9IDExOTsKUGhhc2VyLktleWJvYXJkLkY5ID0gMTIwOwpQaGFzZXIuS2V5Ym9hcmQuRjEwID0gMTIxOwpQaGFzZXIuS2V5Ym9hcmQuRjExID0gMTIyOwpQaGFzZXIuS2V5Ym9hcmQuRjEyID0gMTIzOwpQaGFzZXIuS2V5Ym9hcmQuRjEzID0gMTI0OwpQaGFzZXIuS2V5Ym9hcmQuRjE0ID0gMTI1OwpQaGFzZXIuS2V5Ym9hcmQuRjE1ID0gMTI2OwpQaGFzZXIuS2V5Ym9hcmQuQ09MT04gPSAxODY7ClBoYXNlci5LZXlib2FyZC5FUVVBTFMgPSAxODc7ClBoYXNlci5LZXlib2FyZC5VTkRFUlNDT1JFID0gMTg5OwpQaGFzZXIuS2V5Ym9hcmQuUVVFU1RJT05fTUFSSyA9IDE5MTsKUGhhc2VyLktleWJvYXJkLlRJTERFID0gMTkyOwpQaGFzZXIuS2V5Ym9hcmQuT1BFTl9CUkFDS0VUID0gMjE5OwpQaGFzZXIuS2V5Ym9hcmQuQkFDS1dBUkRfU0xBU0ggPSAyMjA7ClBoYXNlci5LZXlib2FyZC5DTE9TRURfQlJBQ0tFVCA9IDIyMTsKUGhhc2VyLktleWJvYXJkLlFVT1RFUyA9IDIyMjsKUGhhc2VyLktleWJvYXJkLkJBQ0tTUEFDRSA9IDg7ClBoYXNlci5LZXlib2FyZC5UQUIgPSA5OwpQaGFzZXIuS2V5Ym9hcmQuQ0xFQVIgPSAxMjsKUGhhc2VyLktleWJvYXJkLkVOVEVSID0gMTM7ClBoYXNlci5LZXlib2FyZC5TSElGVCA9IDE2OwpQaGFzZXIuS2V5Ym9hcmQuQ09OVFJPTCA9IDE3OwpQaGFzZXIuS2V5Ym9hcmQuQUxUID0gMTg7ClBoYXNlci5LZXlib2FyZC5DQVBTX0xPQ0sgPSAyMDsKUGhhc2VyLktleWJvYXJkLkVTQyA9IDI3OwpQaGFzZXIuS2V5Ym9hcmQuU1BBQ0VCQVIgPSAzMjsKUGhhc2VyLktleWJvYXJkLlBBR0VfVVAgPSAzMzsKUGhhc2VyLktleWJvYXJkLlBBR0VfRE9XTiA9IDM0OwpQaGFzZXIuS2V5Ym9hcmQuRU5EID0gMzU7ClBoYXNlci5LZXlib2FyZC5IT01FID0gMzY7ClBoYXNlci5LZXlib2FyZC5MRUZUID0gMzc7ClBoYXNlci5LZXlib2FyZC5VUCA9IDM4OwpQaGFzZXIuS2V5Ym9hcmQuUklHSFQgPSAzOTsKUGhhc2VyLktleWJvYXJkLkRPV04gPSA0MDsKUGhhc2VyLktleWJvYXJkLklOU0VSVCA9IDQ1OwpQaGFzZXIuS2V5Ym9hcmQuREVMRVRFID0gNDY7ClBoYXNlci5LZXlib2FyZC5IRUxQID0gNDc7ClBoYXNlci5LZXlib2FyZC5OVU1fTE9DSyA9IDE0NDsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIE1vdXNlIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5Nb3VzZQoqIEBjbGFzc2Rlc2MgVGhlIE1vdXNlIGNsYXNzCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuTW91c2UgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7T2JqZWN0fSBjYWxsYmFja0NvbnRleHQgLSBEZXNjcmlwdGlvbi4KCSovCgl0aGlzLmNhbGxiYWNrQ29udGV4dCA9IHRoaXMuZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gbW91c2VEb3duQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLm1vdXNlRG93bkNhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IG1vdXNlTW92ZUNhbGxiYWNrIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5tb3VzZU1vdmVDYWxsYmFjayA9IG51bGw7CgkKCS8qKgoJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBtb3VzZVVwQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLm1vdXNlVXBDYWxsYmFjayA9IG51bGw7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBidXR0b24tIFRoZSB0eXBlIG9mIGNsaWNrLCBlaXRoZXI6IFBoYXNlci5Nb3VzZS5OT19CVVRUT04sIFBoYXNlci5Nb3VzZS5MRUZUX0JVVFRPTiwgUGhhc2VyLk1vdXNlLk1JRERMRV9CVVRUT04gb3IgUGhhc2VyLk1vdXNlLlJJR0hUX0JVVFRPTi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmJ1dHRvbiA9IC0xOwoKICAgIC8qKgogICAgKiBZb3UgY2FuIGRpc2FibGUgYWxsIElucHV0IGJ5IHNldHRpbmcgZGlzYWJsZWQgPSB0cnVlLiBXaGlsZSBzZXQgYWxsIG5ldyBpbnB1dCByZWxhdGVkIGV2ZW50cyB3aWxsIGJlIGlnbm9yZWQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZGlzYWJsZWQKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIElmIHRoZSBtb3VzZSBoYXMgYmVlbiBQb2ludGVyIExvY2tlZCBzdWNjZXNzZnVsbHkgdGhpcyB3aWxsIGJlIHNldCB0byB0cnVlLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvY2tlZAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFRoaXMgZXZlbnQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGVudGVycyBvciBsZWF2ZXMgcG9pbnRlciBsb2NrIHN0YXRlLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IHBvaW50ZXJMb2NrCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wb2ludGVyTG9jayA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKICAgIC8qKgogICAgKiBUaGUgYnJvd3NlciBtb3VzZSBldmVudC4KICAgICogQHByb3BlcnR5IHtNb3VzZUV2ZW50fSBldmVudAogICAgKi8KICAgIHRoaXMuZXZlbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9vbk1vdXNlRG93bgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTW91c2VEb3duOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Nb3VzZU1vdmUKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9vbk1vdXNlTW92ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTW91c2VVcAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX29uTW91c2VVcDsKCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuTk9fQlVUVE9OID0gLTE7Ci8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Nb3VzZS5MRUZUX0JVVFRPTiA9IDA7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuTUlERExFX0JVVFRPTiA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuTW91c2UuUklHSFRfQlVUVE9OID0gMjsKClBoYXNlci5Nb3VzZS5wcm90b3R5cGUgPSB7CgoJLyoqCiAgICAqIFN0YXJ0cyB0aGUgZXZlbnQgbGlzdGVuZXJzIHJ1bm5pbmcuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuYW5kcm9pZCAmJiB0aGlzLmdhbWUuZGV2aWNlLmNocm9tZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBBbmRyb2lkIHN0b2NrIGJyb3dzZXIgZmlyZXMgbW91c2UgZXZlbnRzIGV2ZW4gaWYgeW91IHByZXZlbnREZWZhdWx0IG9uIHRoZSB0b3VjaFN0YXJ0LCBzbyAuLi4KICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fb25Nb3VzZURvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uTW91c2VEb3duKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICB0aGlzLl9vbk1vdXNlTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMub25Nb3VzZU1vdmUoZXZlbnQpOwogICAgICAgIH07CgogICAgICAgIHRoaXMuX29uTW91c2VVcCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICByZXR1cm4gX3RoaXMub25Nb3VzZVVwKGV2ZW50KTsKICAgICAgICB9OwoKICAgICAgICAvLyB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93biwgdHJ1ZSk7CiAgICAgICAgLy8gdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIC8vIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCB0aGlzLl9vbk1vdXNlRG93biwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLl9vbk1vdXNlVXAsIHRydWUpOwoKICAgIH0sCgoJLyoqCgkqIFRoZSBpbnRlcm5hbCBtZXRob2QgdGhhdCBoYW5kbGVzIHRoZSBtb3VzZSBkb3duIGV2ZW50IGZyb20gdGhlIGJyb3dzZXIuCgkqIEBtZXRob2QgUGhhc2VyLk1vdXNlI29uTW91c2VEb3duCiAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQKICAgICovCiAgICBvbk1vdXNlRG93bjogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMuZXZlbnQgPSBldmVudDsKCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKCiAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC53aGljaDsKCiAgICAgICAgaWYgKHRoaXMubW91c2VEb3duQ2FsbGJhY2spCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm1vdXNlRG93bkNhbGxiYWNrLmNhbGwodGhpcy5jYWxsYmFja0NvbnRleHQsIGV2ZW50KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50WydpZGVudGlmaWVyJ10gPSAwOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2VQb2ludGVyLnN0YXJ0KGV2ZW50KTsKCiAgICB9LAoKCS8qKgogICAgKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgbW92ZSBldmVudCBmcm9tIHRoZSBicm93c2VyLgoJKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNvbk1vdXNlTW92ZQogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50CiAgICAqLwogICAgb25Nb3VzZU1vdmU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgICAgIGlmICh0aGlzLm1vdXNlTW92ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZU1vdmVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudFsnaWRlbnRpZmllciddID0gMDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlUG9pbnRlci5tb3ZlKGV2ZW50KTsKCiAgICB9LAoKCS8qKgogICAgKiBUaGUgaW50ZXJuYWwgbWV0aG9kIHRoYXQgaGFuZGxlcyB0aGUgbW91c2UgdXAgZXZlbnQgZnJvbSB0aGUgYnJvd3Nlci4KCSogQG1ldGhvZCBQaGFzZXIuTW91c2Ujb25Nb3VzZVVwCiAgICAqIEBwYXJhbSB7TW91c2VFdmVudH0gZXZlbnQKICAgICovCiAgICBvbk1vdXNlVXA6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLmV2ZW50ID0gZXZlbnQ7CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgogICAgCXRoaXMuYnV0dG9uID0gUGhhc2VyLk1vdXNlLk5PX0JVVFRPTjsKCiAgICAgICAgaWYgKHRoaXMubW91c2VVcENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tb3VzZVVwQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnRbJ2lkZW50aWZpZXInXSA9IDA7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZVBvaW50ZXIuc3RvcChldmVudCk7CgogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgaXQgeW91IGNhbiByZXF1ZXN0IHRoYXQgdGhlIHBvaW50ZXIgYmUgbG9ja2VkIHRvIHRoZSBicm93c2VyIHdpbmRvdy4KICAgICogVGhpcyBpcyBjbGFzc2ljYWxseSBrbm93biBhcyAnRlBTIGNvbnRyb2xzJywgd2hlcmUgdGhlIHBvaW50ZXIgY2FuJ3QgbGVhdmUgdGhlIGJyb3dzZXIgdW50aWwgdGhlIHVzZXIgcHJlc3NlcyBhbiBleGl0IGtleS4KICAgICogSWYgdGhlIGJyb3dzZXIgc3VjY2Vzc2Z1bGx5IGVudGVycyBhIGxvY2tlZCBzdGF0ZSB0aGUgZXZlbnQgUGhhc2VyLk1vdXNlLnBvaW50ZXJMb2NrIHdpbGwgYmUgZGlzcGF0Y2hlZCBhbmQgdGhlIGZpcnN0IHBhcmFtZXRlciB3aWxsIGJlICd0cnVlJy4KCSogQG1ldGhvZCBQaGFzZXIuTW91c2UjcmVxdWVzdFBvaW50ZXJMb2NrCiAgICAqLwogICAgcmVxdWVzdFBvaW50ZXJMb2NrOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLnBvaW50ZXJMb2NrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzOwoKICAgICAgICAgICAgZWxlbWVudC5yZXF1ZXN0UG9pbnRlckxvY2sgPSBlbGVtZW50LnJlcXVlc3RQb2ludGVyTG9jayB8fCBlbGVtZW50Lm1velJlcXVlc3RQb2ludGVyTG9jayB8fCBlbGVtZW50LndlYmtpdFJlcXVlc3RQb2ludGVyTG9jazsKCiAgICAgICAgICAgIGVsZW1lbnQucmVxdWVzdFBvaW50ZXJMb2NrKCk7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5wb2ludGVyTG9ja0NoYW5nZShldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW96cG9pbnRlcmxvY2tjaGFuZ2UnLCB0aGlzLl9wb2ludGVyTG9ja0NoYW5nZSwgdHJ1ZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdHBvaW50ZXJsb2NrY2hhbmdlJywgdGhpcy5fcG9pbnRlckxvY2tDaGFuZ2UsIHRydWUpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBJbnRlcm5hbCBwb2ludGVyTG9ja0NoYW5nZSBoYW5kbGVyLgoJKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNwb2ludGVyTG9ja0NoYW5nZQogICAgKiBAcGFyYW0ge01vdXNlRXZlbnR9IGV2ZW50CiAgICAqLwogICAgcG9pbnRlckxvY2tDaGFuZ2U6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZ2FtZS5zdGFnZS5jYW52YXM7CgogICAgICAgIGlmIChkb2N1bWVudC5wb2ludGVyTG9ja0VsZW1lbnQgPT09IGVsZW1lbnQgfHwgZG9jdW1lbnQubW96UG9pbnRlckxvY2tFbGVtZW50ID09PSBlbGVtZW50IHx8IGRvY3VtZW50LndlYmtpdFBvaW50ZXJMb2NrRWxlbWVudCA9PT0gZWxlbWVudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQb2ludGVyIHdhcyBzdWNjZXNzZnVsbHkgbG9ja2VkCiAgICAgICAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wb2ludGVyTG9jay5kaXNwYXRjaCh0cnVlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFBvaW50ZXIgd2FzIHVubG9ja2VkCiAgICAgICAgICAgIHRoaXMubG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucG9pbnRlckxvY2suZGlzcGF0Y2goZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBJbnRlcm5hbCByZWxlYXNlIHBvaW50ZXIgbG9jayBoYW5kbGVyLgoJKiBAbWV0aG9kIFBoYXNlci5Nb3VzZSNyZWxlYXNlUG9pbnRlckxvY2sKICAgICovCiAgICByZWxlYXNlUG9pbnRlckxvY2s6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgZG9jdW1lbnQuZXhpdFBvaW50ZXJMb2NrID0gZG9jdW1lbnQuZXhpdFBvaW50ZXJMb2NrIHx8IGRvY3VtZW50Lm1vekV4aXRQb2ludGVyTG9jayB8fCBkb2N1bWVudC53ZWJraXRFeGl0UG9pbnRlckxvY2s7CgogICAgICAgIGRvY3VtZW50LmV4aXRQb2ludGVyTG9jaygpOwoKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3pwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd3ZWJraXRwb2ludGVybG9ja2NoYW5nZScsIHRoaXMuX3BvaW50ZXJMb2NrQ2hhbmdlLCB0cnVlKTsKCiAgICB9LAoKCS8qKgogICAgKiBTdG9wIHRoZSBldmVudCBsaXN0ZW5lcnMuCiAgICAqIEBtZXRob2QgUGhhc2VyLk1vdXNlI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgdGhpcy5fb25Nb3VzZURvd24sIHRydWUpOwogICAgICAgIC8vIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5fb25Nb3VzZU1vdmUsIHRydWUpOwogICAgICAgIC8vIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuX29uTW91c2VVcCwgdHJ1ZSk7CgogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlZG93bicsIHRoaXMuX29uTW91c2VEb3duLCB0cnVlKTsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLl9vbk1vdXNlTW92ZSwgdHJ1ZSk7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuX29uTW91c2VVcCwgdHJ1ZSk7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlciAtIE1TUG9pbnRlciBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuTVNQb2ludGVyCiogQGNsYXNzZGVzYyBUaGUgTVNQb2ludGVyIGNsYXNzIGhhbmRsZXMgdG91Y2ggaW50ZXJhY3Rpb25zIHdpdGggdGhlIGdhbWUgYW5kIHRoZSByZXN1bHRpbmcgUG9pbnRlciBvYmplY3RzLgoqIEl0IHdpbGwgd29yayBvbmx5IGluIEludGVybmV0IEV4cGxvcmVyIDEwIGFuZCBXaW5kb3dzIFN0b3JlIG9yIFdpbmRvd3MgUGhvbmUgOCBhcHBzIHVzaW5nIEphdmFTY3JpcHQuCiogaHR0cDovL21zZG4ubWljcm9zb2Z0LmNvbS9lbi11cy9saWJyYXJ5L2llL2hoNjczNTU3KHY9dnMuODUpLmFzcHgKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5NU1BvaW50ZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGNhbGxiYWNrQ29udGV4dCAtIERlc2NyaXB0aW9uLgoJKi8KCXRoaXMuY2FsbGJhY2tDb250ZXh0ID0gdGhpcy5nYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBtb3VzZURvd25DYWxsYmFjayAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubW91c2VEb3duQ2FsbGJhY2sgPSBudWxsOwoJCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gbW91c2VNb3ZlQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCgl0aGlzLm1vdXNlTW92ZUNhbGxiYWNrID0gbnVsbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IG1vdXNlVXBDYWxsYmFjayAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubW91c2VVcENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRpc2FibGVkCiAgICAqLwogICAgdGhpcy5kaXNhYmxlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX29uTVNQb2ludGVyRG93bgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uTVNQb2ludGVyRG93biA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX29uTVNQb2ludGVyTW92ZQogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX29uTVNQb2ludGVyTW92ZSA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX29uTVNQb2ludGVyVXAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vbk1TUG9pbnRlclVwID0gbnVsbDsKCn07CgpQaGFzZXIuTVNQb2ludGVyLnByb3RvdHlwZSA9IHsKCgkvKioKICAgICogU3RhcnRzIHRoZSBldmVudCBsaXN0ZW5lcnMgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI3N0YXJ0CiAgICAqLwogICAgc3RhcnQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UubXNwb2ludGVyID09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbk1TUG9pbnRlckRvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblBvaW50ZXJEb3duKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uTVNQb2ludGVyTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uUG9pbnRlck1vdmUoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25NU1BvaW50ZXJVcCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uUG9pbnRlclVwKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlckRvd24nLCB0aGlzLl9vbk1TUG9pbnRlckRvd24sIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyTW92ZScsIHRoaXMuX29uTVNQb2ludGVyTW92ZSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJVcCcsIHRoaXMuX29uTVNQb2ludGVyVXAsIGZhbHNlKTsKCiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LnN0eWxlWyctbXMtY29udGVudC16b29taW5nJ10gPSAnbm9uZSc7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LnN0eWxlWyctbXMtdG91Y2gtYWN0aW9uJ10gPSAnbm9uZSc7CgogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI29uUG9pbnRlckRvd24KICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqKi8KICAgIG9uUG9pbnRlckRvd246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGV2ZW50LmlkZW50aWZpZXIgPSBldmVudC5wb2ludGVySWQ7CgogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zdGFydFBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5NU1BvaW50ZXIjb25Qb2ludGVyTW92ZQogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICoqLwogICAgb25Qb2ludGVyTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuZGlzYWJsZWQgfHwgdGhpcy5kaXNhYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgZXZlbnQuaWRlbnRpZmllciA9IGV2ZW50LnBvaW50ZXJJZDsKCiAgICAgICAgdGhpcy5nYW1lLmlucHV0LnVwZGF0ZVBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5NU1BvaW50ZXIjb25Qb2ludGVyVXAKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqKi8KICAgIG9uUG9pbnRlclVwOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICBldmVudC5pZGVudGlmaWVyID0gZXZlbnQucG9pbnRlcklkOwoKICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQpOwoKICAgIH0sCgoJLyoqCiAgICAqIFN0b3AgdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICogQG1ldGhvZCBQaGFzZXIuTVNQb2ludGVyI3N0b3AKICAgICovCiAgICBzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignTVNQb2ludGVyRG93bicsIHRoaXMuX29uTVNQb2ludGVyRG93bik7CiAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCdNU1BvaW50ZXJNb3ZlJywgdGhpcy5fb25NU1BvaW50ZXJNb3ZlKTsKICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ01TUG9pbnRlclVwJywgdGhpcy5fb25NU1BvaW50ZXJVcCk7CgogICAgfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyIC0gUG9pbnRlciBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuUG9pbnRlcgoqIEBjbGFzc2Rlc2MgQSBQb2ludGVyIG9iamVjdCBpcyB1c2VkIGJ5IHRoZSBNb3VzZSwgVG91Y2ggYW5kIE1TUG9pbnQgbWFuYWdlcnMgYW5kIHJlcHJlc2VudHMgYSBzaW5nbGUgZmluZ2VyIG9uIHRoZSB0b3VjaCBzY3JlZW4uCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7RGVzY3JpcHRpb259IGlkIC0gRGVzY3JpcHRpb24uCiovClBoYXNlci5Qb2ludGVyID0gZnVuY3Rpb24gKGdhbWUsIGlkKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBpZCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMuaWQgPSBpZDsKCiAgICAvKioKICAgICogTG9jYWwgcHJpdmF0ZSB2YXJpYWJsZSB0byBzdG9yZSB0aGUgc3RhdHVzIG9mIGRpc3BhdGNoaW5nIGEgaG9sZCBldmVudC4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBfaG9sZFNlbnQKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9ob2xkU2VudCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBMb2NhbCBwcml2YXRlIHZhcmlhYmxlIHN0b3JpbmcgdGhlIHNob3J0LXRlcm0gaGlzdG9yeSBvZiBwb2ludGVyIG1vdmVtZW50cy4KICAgICogQHByb3BlcnR5IHthcnJheX0gX2hpc3RvcnkKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9oaXN0b3J5ID0gW107CgogICAgLyoqCiAgICAqIExvY2FsIHByaXZhdGUgdmFyaWFibGUgc3RvcmluZyB0aGUgdGltZSBhdCB3aGljaCB0aGUgbmV4dCBoaXN0b3J5IGRyb3Agc2hvdWxkIG9jY3VyCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbGFzdERyb3AKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9uZXh0RHJvcCA9IDA7CgogICAgLyoqCiAgICAgKiBNb25pdG9yIGV2ZW50cyBvdXRzaWRlIG9mIGEgc3RhdGUgcmVzZXQgbG9vcC4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX3N0YXRlUmVzZXQKICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLl9zdGF0ZVJlc2V0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdpdGhpbkdhbWUKICAgICovCiAgICB0aGlzLndpdGhpbkdhbWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBleGNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjbGllbnRYCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jbGllbnRYID0gLTE7CgogICAgLyoqCiAgICAqIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSB2aWV3cG9ydCBpbiBwaXhlbHMsIGV4Y2x1ZGluZyBhbnkgc2Nyb2xsIG9mZnNldC4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGNsaWVudFkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNsaWVudFkgPSAtMTsKCiAgICAvKioKICAgICogVGhlIGhvcml6b250YWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgdmlld3BvcnQgaW4gcGl4ZWxzLCBpbmNsdWRpbmcgYW55IHNjcm9sbCBvZmZzZXQuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwYWdlWAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFnZVggPSAtMTsKCiAgICAvKioKICAgICogVGhlIHZlcnRpY2FsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHZpZXdwb3J0IGluIHBpeGVscywgaW5jbHVkaW5nIGFueSBzY3JvbGwgb2Zmc2V0LgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGFnZVkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBhZ2VZID0gLTE7CgogICAgLyoqCiAgICAqIFRoZSBob3Jpem9udGFsIGNvb3JkaW5hdGUgb2YgcG9pbnQgcmVsYXRpdmUgdG8gdGhlIHNjcmVlbiBpbiBwaXhlbHMuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzY3JlZW5YCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zY3JlZW5YID0gLTE7CgogICAgLyoqCiAgICAqIFRoZSB2ZXJ0aWNhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBzY3JlZW4gaW4gcGl4ZWxzLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2NyZWVuWQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc2NyZWVuWSA9IC0xOwoKICAgIC8qKgogICAgKiBUaGUgaG9yaXpvbnRhbCBjb29yZGluYXRlIG9mIHBvaW50IHJlbGF0aXZlIHRvIHRoZSBnYW1lIGVsZW1lbnQuIFRoaXMgdmFsdWUgaXMgYXV0b21hdGljYWxseSBzY2FsZWQgYmFzZWQgb24gZ2FtZSBzaXplLgogICAgKiBAcHJvcGVydHkge251bWJlcn0geAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMueCA9IC0xOwoKICAgIC8qKgogICAgKiBUaGUgdmVydGljYWwgY29vcmRpbmF0ZSBvZiBwb2ludCByZWxhdGl2ZSB0byB0aGUgZ2FtZSBlbGVtZW50LiBUaGlzIHZhbHVlIGlzIGF1dG9tYXRpY2FsbHkgc2NhbGVkIGJhc2VkIG9uIGdhbWUgc2l6ZS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnkgPSAtMTsKCiAgICAvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgYSBtb3VzZSB0aGlzIGlzIHRydWUsIG90aGVyd2lzZSBmYWxzZS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc01vdXNlCiAgICAqIEB0eXBlIHtib29sZWFufQogICAgKi8KICAgIHRoaXMuaXNNb3VzZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgaGVsZCBkb3duLCBpc0Rvd24gaXMgc2V0IHRvIHRydWUuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEb3duCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKCiAgICAvKioKICAgICogSWYgdGhlIFBvaW50ZXIgaXMgbm90IHRvdWNoaW5nIHRoZSB0b3VjaHNjcmVlbiwgb3IgdGhlIG1vdXNlIGJ1dHRvbiBpcyB1cCwgaXNVcCBpcyBzZXQgdG8gdHJ1ZS4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1VwCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1VwID0gdHJ1ZTsKCiAgICAvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgZmlyc3QgdG91Y2hlZCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lRG93bgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZURvd24gPSAwOwoKICAgIC8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBsZWZ0IHRoZSB0b3VjaHNjcmVlbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVVcAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudGltZVVwID0gMDsKCiAgICAvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgd2FzIGxhc3QgdGFwcGVkIG9yIGNsaWNrZWQuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmV2aW91c1RhcFRpbWUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnByZXZpb3VzVGFwVGltZSA9IDA7CgogICAgLyoqCiAgICAqIFRoZSB0b3RhbCBudW1iZXIgb2YgdGltZXMgdGhpcyBQb2ludGVyIGhhcyBiZWVuIHRvdWNoZWQgdG8gdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gdG90YWxUb3VjaGVzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3RhbFRvdWNoZXMgPSAwOwoKICAgIC8qKgogICAgKiBUaGUgbnVtYmVyIG9mIG1pbGlzZWNvbmRzIHNpbmNlIHRoZSBsYXN0IGNsaWNrLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbXNTaW5jZUxhc3RDbGljawogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubXNTaW5jZUxhc3RDbGljayA9IE51bWJlci5NQVhfVkFMVUU7CgogICAgLyoqCiAgICAqIFRoZSBHYW1lIE9iamVjdCB0aGlzIFBvaW50ZXIgaXMgY3VycmVudGx5IG92ZXIgLyB0b3VjaGluZyAvIGRyYWdnaW5nLgogICAgKiBAcHJvcGVydHkge0FueX0gdGFyZ2V0T2JqZWN0CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50YXJnZXRPYmplY3QgPSBudWxsOwoKICAgIC8qKgogICAgKiBBbiBhY3RpdmUgcG9pbnRlciBpcyBvbmUgdGhhdCBpcyBjdXJyZW50bHkgcHJlc3NlZCBkb3duIG9uIHRoZSBkaXNwbGF5LiBBIE1vdXNlIGlzIGFsd2F5cyBhY3RpdmUuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWN0aXZlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQSBQaGFzZXIuUG9pbnQgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGN1cnJlbnQgeC95IHZhbHVlcyBvZiB0aGUgcG9pbnRlciBvbiB0aGUgZGlzcGxheS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBvc2l0aW9uCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAogICAgLyoqCiAgICAqIEEgUGhhc2VyLlBvaW50IG9iamVjdCBjb250YWluaW5nIHRoZSB4L3kgdmFsdWVzIG9mIHRoZSBwb2ludGVyIHdoZW4gaXQgd2FzIGxhc3QgaW4gYSBkb3duIHN0YXRlIG9uIHRoZSBkaXNwbGF5LgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gcG9zaXRpb25Eb3duCiAgICAqLwogICAgdGhpcy5wb3NpdGlvbkRvd24gPSBuZXcgUGhhc2VyLlBvaW50KCk7CgogICAgLyoqCiAgICAqIEEgUGhhc2VyLkNpcmNsZSB0aGF0IGlzIGNlbnRlcmVkIG9uIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgdGhpcyBwb2ludGVyLCB1c2VmdWwgZm9yIGhpdCBkZXRlY3Rpb24uCiAgICAqIFRoZSBDaXJjbGUgc2l6ZSBpcyA0NHB4IChBcHBsZXMgcmVjb21tZW5kZWQgImZpbmdlciB0aXAiIHNpemUpLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5DaXJjbGV9IGNpcmNsZQogICAgKi8KICAgIHRoaXMuY2lyY2xlID0gbmV3IFBoYXNlci5DaXJjbGUoMCwgMCwgNDQpOwoKICAgIGlmIChpZCA9PSAwKQogICAgewogICAgICAgIHRoaXMuaXNNb3VzZSA9IHRydWU7CiAgICB9Cgp9OwoKUGhhc2VyLlBvaW50ZXIucHJvdG90eXBlID0gewoKCS8qKgogICAgKiBDYWxsZWQgd2hlbiB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIG9udG8gdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3N0YXJ0CiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKi8KICAgIHN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgdGhpcy5pZGVudGlmaWVyID0gZXZlbnQuaWRlbnRpZmllcjsKICAgICAgICB0aGlzLnRhcmdldCA9IGV2ZW50LnRhcmdldDsKCiAgICAgICAgaWYgKHR5cGVvZiBldmVudC5idXR0b24gIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247CiAgICAgICAgfQoKICAgICAgICAvLyAgRml4IHRvIHN0b3Agcm9ndWUgYnJvd3NlciBwbHVnaW5zIGZyb20gYmxvY2tpbmcgdGhlIHZpc2liaWxpdHkgc3RhdGUgZXZlbnQKICAgICAgICBpZiAodGhpcy5nYW1lLnBhdXNlZCA9PSB0cnVlICYmIHRoaXMuZ2FtZS5zdGFnZS5zY2FsZS5pbmNvcnJlY3RPcmllbnRhdGlvbiA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9oaXN0b3J5Lmxlbmd0aCA9IDA7CiAgICAgICAgdGhpcy5hY3RpdmUgPSB0cnVlOwogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IHRydWU7CiAgICAgICAgdGhpcy5pc0Rvd24gPSB0cnVlOwogICAgICAgIHRoaXMuaXNVcCA9IGZhbHNlOwoKICAgICAgICAvLyAgV29yayBvdXQgaG93IGxvbmcgaXQgaGFzIGJlZW4gc2luY2UgdGhlIGxhc3QgY2xpY2sKICAgICAgICB0aGlzLm1zU2luY2VMYXN0Q2xpY2sgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVEb3duOwogICAgICAgIHRoaXMudGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy5faG9sZFNlbnQgPSBmYWxzZTsKCiAgICAgICAgLy8gIFRoaXMgc2V0cyB0aGUgeC95IGFuZCBvdGhlciBsb2NhbCB2YWx1ZXMKICAgICAgICB0aGlzLm1vdmUoZXZlbnQpOwoKICAgICAgICAvLyB4IGFuZCB5IGFyZSB0aGUgb2xkIHZhbHVlcyBoZXJlPwogICAgICAgIHRoaXMucG9zaXRpb25Eb3duLnNldFRvKHRoaXMueCwgdGhpcy55KTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC54ID0gdGhpcy54OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQueSA9IHRoaXMueTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnBvc2l0aW9uLnNldFRvKHRoaXMueCwgdGhpcy55KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uRG93bi5kaXNwYXRjaCh0aGlzLCBldmVudCk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5yZXNldFNwZWVkKHRoaXMueCwgdGhpcy55KTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3N0YXRlUmVzZXQgPSBmYWxzZTsKICAgICAgICB0aGlzLnRvdGFsVG91Y2hlcysrOwoKICAgICAgICBpZiAodGhpcy5pc01vdXNlID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycysrOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3RvdWNoZWRIYW5kbGVyKHRoaXMpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCgkvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmFjdGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9ob2xkU2VudCA9PSBmYWxzZSAmJiB0aGlzLmR1cmF0aW9uID49IHRoaXMuZ2FtZS5pbnB1dC5ob2xkUmF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PSAwKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25Ib2xkLmRpc3BhdGNoKHRoaXMpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMuX2hvbGRTZW50ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIFVwZGF0ZSB0aGUgZHJvcHBpbmdzIGhpc3RvcnkKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5yZWNvcmRQb2ludGVySGlzdG9yeSAmJiB0aGlzLmdhbWUudGltZS5ub3cgPj0gdGhpcy5fbmV4dERyb3ApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX25leHREcm9wID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5nYW1lLmlucHV0LnJlY29yZFJhdGU7CgogICAgICAgICAgICAgICAgdGhpcy5faGlzdG9yeS5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB4OiB0aGlzLnBvc2l0aW9uLngsCiAgICAgICAgICAgICAgICAgICAgeTogdGhpcy5wb3NpdGlvbi55CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiAodGhpcy5faGlzdG9yeS5sZW5ndGggPiB0aGlzLmdhbWUuaW5wdXQucmVjb3JkTGltaXQpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlzdG9yeS5zaGlmdCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCB3aGVuIHRoZSBQb2ludGVyIGlzIG1vdmVkCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjbW92ZQogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBtb3ZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5wb2xsTG9ja2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBldmVudC5idXR0b24gIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5idXR0b24gPSBldmVudC5idXR0b247CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNsaWVudFggPSBldmVudC5jbGllbnRYOwogICAgICAgIHRoaXMuY2xpZW50WSA9IGV2ZW50LmNsaWVudFk7CgogICAgICAgIHRoaXMucGFnZVggPSBldmVudC5wYWdlWDsKICAgICAgICB0aGlzLnBhZ2VZID0gZXZlbnQucGFnZVk7CgogICAgICAgIHRoaXMuc2NyZWVuWCA9IGV2ZW50LnNjcmVlblg7CiAgICAgICAgdGhpcy5zY3JlZW5ZID0gZXZlbnQuc2NyZWVuWTsKCiAgICAgICAgdGhpcy54ID0gKHRoaXMucGFnZVggLSB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0LngpICogdGhpcy5nYW1lLmlucHV0LnNjYWxlLng7CiAgICAgICAgdGhpcy55ID0gKHRoaXMucGFnZVkgLSB0aGlzLmdhbWUuc3RhZ2Uub2Zmc2V0LnkpICogdGhpcy5nYW1lLmlucHV0LnNjYWxlLnk7CgogICAgICAgIHRoaXMucG9zaXRpb24uc2V0VG8odGhpcy54LCB0aGlzLnkpOwogICAgICAgIHRoaXMuY2lyY2xlLnggPSB0aGlzLng7CiAgICAgICAgdGhpcy5jaXJjbGUueSA9IHRoaXMueTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX09WRVJSSURFU19UT1VDSCB8fCB0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5NT1VTRV9UT1VDSF9DT01CSU5FIHx8ICh0aGlzLmdhbWUuaW5wdXQubXVsdGlJbnB1dE92ZXJyaWRlID09IFBoYXNlci5JbnB1dC5UT1VDSF9PVkVSUklERVNfTU9VU0UgJiYgdGhpcy5nYW1lLmlucHV0LmN1cnJlbnRQb2ludGVycyA9PSAwKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyID0gdGhpczsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnggPSB0aGlzLng7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC55ID0gdGhpcy55OwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQucG9zaXRpb24uc2V0VG8odGhpcy5nYW1lLmlucHV0LngsIHRoaXMuZ2FtZS5pbnB1dC55KTsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmNpcmNsZS54ID0gdGhpcy5nYW1lLmlucHV0Lng7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jaXJjbGUueSA9IHRoaXMuZ2FtZS5pbnB1dC55OwogICAgICAgIH0KCiAgICAgICAgLy8gIElmIHRoZSBnYW1lIGlzIHBhdXNlZCB3ZSBkb24ndCBwcm9jZXNzIGFueSB0YXJnZXQgb2JqZWN0cwogICAgICAgIGlmICh0aGlzLmdhbWUucGF1c2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgfQoKICAgICAgICAvLyAgRWFzeSBvdXQgaWYgd2UncmUgZHJhZ2dpbmcgc29tZXRoaW5nIGFuZCBpdCBzdGlsbCBleGlzdHMKICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgIT09IG51bGwgJiYgdGhpcy50YXJnZXRPYmplY3QuaXNEcmFnZ2VkID09IHRydWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QudXBkYXRlKHRoaXMpID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCiAgICAgICAgLy8gIFdvcmsgb3V0IHdoaWNoIG9iamVjdCBpcyBvbiB0aGUgdG9wCiAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9yZGVySUQgPSAtMTsKICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0ID0gbnVsbDsKICAgICAgICB0aGlzLl9oaWdoZXN0SW5wdXRQcmlvcml0eUlEID0gLTE7CgogICAgICAgIC8vICBKdXN0IHJ1biB0aHJvdWdoIHRoZSBsaW5rZWQgbGlzdAogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy50b3RhbCA+IDApCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5uZXh0OwoKICAgICAgICAgICAgZG8gIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgSWYgdGhlIG9iamVjdCBpcyB1c2luZyBwaXhlbFBlcmZlY3QgY2hlY2tzLCBvciBoYXMgYSBoaWdoZXIgSW5wdXRNYW5hZ2VyLlByaW9yaXR5SUQgT1IgaWYgdGhlIHByaW9yaXR5IElEIGlzIHRoZSBzYW1lIGFzIHRoZSBjdXJyZW50IGhpZ2hlc3QgQU5EIGl0IGhhcyBhIGhpZ2hlciByZW5kZXJPcmRlcklELCB0aGVuIHNldCBpdCB0byB0aGUgdG9wCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUucGl4ZWxQZXJmZWN0IHx8IGN1cnJlbnROb2RlLnByaW9yaXR5SUQgPiB0aGlzLl9oaWdoZXN0SW5wdXRQcmlvcml0eUlEIHx8IChjdXJyZW50Tm9kZS5wcmlvcml0eUlEID09IHRoaXMuX2hpZ2hlc3RJbnB1dFByaW9yaXR5SUQgJiYgY3VycmVudE5vZGUuc3ByaXRlLnJlbmRlck9yZGVySUQgPiB0aGlzLl9oaWdoZXN0UmVuZGVyT3JkZXJJRCkpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmNoZWNrUG9pbnRlck92ZXIodGhpcykpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnSFJPIHNldCcsIGN1cnJlbnROb2RlLnNwcml0ZS5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdFJlbmRlck9yZGVySUQgPSBjdXJyZW50Tm9kZS5zcHJpdGUucmVuZGVyT3JkZXJJRDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5faGlnaGVzdElucHV0UHJpb3JpdHlJRCA9IGN1cnJlbnROb2RlLnByaW9yaXR5SUQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3QgPSBjdXJyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IG51bGwpCiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFRoZSBwb2ludGVyIGlzbid0IGN1cnJlbnRseSBvdmVyIGFueXRoaW5nLCBjaGVjayBpZiB3ZSd2ZSBnb3QgYSBsaW5nZXJpbmcgcHJldmlvdXMgdGFyZ2V0CiAgICAgICAgICAgIGlmICh0aGlzLnRhcmdldE9iamVjdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coIlRoZSBwb2ludGVyIGlzbid0IGN1cnJlbnRseSBvdmVyIGFueXRoaW5nLCBjaGVjayBpZiB3ZSd2ZSBnb3QgYSBsaW5nZXJpbmcgcHJldmlvdXMgdGFyZ2V0Iik7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdC5fcG9pbnRlck91dEhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0ID09IG51bGwpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBBbmQgbm93IHNldCB0aGUgbmV3IG9uZQogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ0FuZCBub3cgc2V0IHRoZSBuZXcgb25lJyk7CiAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3Q7CiAgICAgICAgICAgICAgICB0aGlzLl9oaWdoZXN0UmVuZGVyT2JqZWN0Ll9wb2ludGVyT3ZlckhhbmRsZXIodGhpcyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2UndmUgZ290IGEgdGFyZ2V0IGZyb20gdGhlIGxhc3QgdXBkYXRlCiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiV2UndmUgZ290IGEgdGFyZ2V0IGZyb20gdGhlIGxhc3QgdXBkYXRlIik7CiAgICAgICAgICAgICAgICBpZiAodGhpcy50YXJnZXRPYmplY3QgPT0gdGhpcy5faGlnaGVzdFJlbmRlck9iamVjdCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgU2FtZSB0YXJnZXQgYXMgYmVmb3JlLCBzbyB1cGRhdGUgaXQKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiU2FtZSB0YXJnZXQgYXMgYmVmb3JlLCBzbyB1cGRhdGUgaXQiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5faGlnaGVzdFJlbmRlck9iamVjdC51cGRhdGUodGhpcykgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBUaGUgdGFyZ2V0IGhhcyBjaGFuZ2VkLCBzbyB0ZWxsIHRoZSBvbGQgb25lIHdlJ3ZlIGxlZnQgaXQKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygiVGhlIHRhcmdldCBoYXMgY2hhbmdlZCwgc28gdGVsbCB0aGUgb2xkIG9uZSB3ZSd2ZSBsZWZ0IGl0Iik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3BvaW50ZXJPdXRIYW5kbGVyKHRoaXMpOwoKICAgICAgICAgICAgICAgICAgICAvLyAgQW5kIG5vdyBzZXQgdGhlIG5ldyBvbmUKICAgICAgICAgICAgICAgICAgICB0aGlzLnRhcmdldE9iamVjdCA9IHRoaXMuX2hpZ2hlc3RSZW5kZXJPYmplY3Q7CiAgICAgICAgICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3BvaW50ZXJPdmVySGFuZGxlcih0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCgkvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgbGVhdmVzIHRoZSB0YXJnZXQgYXJlYS4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNsZWF2ZQogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBsZWF2ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IGZhbHNlOwogICAgICAgIHRoaXMubW92ZShldmVudCk7CgogICAgfSwKCgkvKioKICAgICogQ2FsbGVkIHdoZW4gdGhlIFBvaW50ZXIgbGVhdmVzIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNzdG9wCiAgICAqIEBwYXJhbSB7QW55fSBldmVudAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAodGhpcy5fc3RhdGVSZXNldCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMudGltZVVwID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0Lm11bHRpSW5wdXRPdmVycmlkZSA9PSBQaGFzZXIuSW5wdXQuTU9VU0VfT1ZFUlJJREVTX1RPVUNIIHx8IHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0Lk1PVVNFX1RPVUNIX0NPTUJJTkUgfHwgKHRoaXMuZ2FtZS5pbnB1dC5tdWx0aUlucHV0T3ZlcnJpZGUgPT0gUGhhc2VyLklucHV0LlRPVUNIX09WRVJSSURFU19NT1VTRSAmJiB0aGlzLmdhbWUuaW5wdXQuY3VycmVudFBvaW50ZXJzID09IDApKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm9uVXAuZGlzcGF0Y2godGhpcywgZXZlbnQpOwoKICAgICAgICAgICAgLy8gIFdhcyBpdCBhIHRhcD8KICAgICAgICAgICAgaWYgKHRoaXMuZHVyYXRpb24gPj0gMCAmJiB0aGlzLmR1cmF0aW9uIDw9IHRoaXMuZ2FtZS5pbnB1dC50YXBSYXRlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgV2FzIGl0IGEgZG91YmxlLXRhcD8KICAgICAgICAgICAgICAgIGlmICh0aGlzLnRpbWVVcCAtIHRoaXMucHJldmlvdXNUYXBUaW1lIDwgdGhpcy5nYW1lLmlucHV0LmRvdWJsZVRhcFJhdGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFllcywgbGV0J3MgZGlzcGF0Y2ggdGhlIHNpZ25hbCB0aGVuIHdpdGggdGhlIDJuZCBwYXJhbWV0ZXIgc2V0IHRvIHRydWUKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25UYXAuZGlzcGF0Y2godGhpcywgdHJ1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgLy8gIFdhc24ndCBhIGRvdWJsZS10YXAsIHNvIGRpc3BhdGNoIGEgc2luZ2xlIHRhcCBzaWduYWwKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQub25UYXAuZGlzcGF0Y2godGhpcywgZmFsc2UpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucHJldmlvdXNUYXBUaW1lID0gdGhpcy50aW1lVXA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vICBNb3VzZSBpcyBhbHdheXMgYWN0aXZlCiAgICAgICAgaWYgKHRoaXMuaWQgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMud2l0aGluR2FtZSA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNEb3duID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc1VwID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMuaXNNb3VzZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5jdXJyZW50UG9pbnRlcnMtLTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy50b3RhbCA+IDApCiAgICAgICAgewogICAgICAgICAgICB2YXIgY3VycmVudE5vZGUgPSB0aGlzLmdhbWUuaW5wdXQuaW50ZXJhY3RpdmVJdGVtcy5uZXh0OwogICAgICAgICAgICAKICAgICAgICAgICAgZG8gIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuX3JlbGVhc2VkSGFuZGxlcih0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50Tm9kZSAhPSBudWxsKQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3JlbGVhc2VkSGFuZGxlcih0aGlzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKCS8qKgogICAgKiBUaGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RQcmVzc2VkIGlmIHRoZSB0aW1lIGl0IHdhcyBwcmVzc2VkIG9udG8gdGhlIHRvdWNoc2NyZWVuIG9yIGNsaWNrZWQgaXMgbGVzcyB0aGFuIGp1c3RQcmVzc2VkUmF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNqdXN0UHJlc3NlZAogICAgKiBAcGFyYW0ge251bWJlcn0gW2R1cmF0aW9uXQogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RQcmVzc2VkOiBmdW5jdGlvbiAoZHVyYXRpb24pIHsKCiAgICAgICAgZHVyYXRpb24gPSBkdXJhdGlvbiB8fCB0aGlzLmdhbWUuaW5wdXQuanVzdFByZXNzZWRSYXRlOwoKICAgICAgICByZXR1cm4gKHRoaXMuaXNEb3duID09PSB0cnVlICYmICh0aGlzLnRpbWVEb3duICsgZHVyYXRpb24pID4gdGhpcy5nYW1lLnRpbWUubm93KTsKCiAgICB9LAoKCS8qKgogICAgKiBUaGUgUG9pbnRlciBpcyBjb25zaWRlcmVkIGp1c3RSZWxlYXNlZCBpZiB0aGUgdGltZSBpdCBsZWZ0IHRoZSB0b3VjaHNjcmVlbiBpcyBsZXNzIHRoYW4ganVzdFJlbGVhc2VkUmF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnRlciNqdXN0UmVsZWFzZWQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtkdXJhdGlvbl0KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0UmVsZWFzZWQ6IGZ1bmN0aW9uIChkdXJhdGlvbikgewoKICAgICAgICBkdXJhdGlvbiA9IGR1cmF0aW9uIHx8IHRoaXMuZ2FtZS5pbnB1dC5qdXN0UmVsZWFzZWRSYXRlOwoKICAgICAgICByZXR1cm4gKHRoaXMuaXNVcCA9PT0gdHJ1ZSAmJiAodGhpcy50aW1lVXAgKyBkdXJhdGlvbikgPiB0aGlzLmdhbWUudGltZS5ub3cpOwoKICAgIH0sCgoJLyoqCiAgICAqIFJlc2V0cyB0aGUgUG9pbnRlciBwcm9wZXJ0aWVzLiBDYWxsZWQgYnkgSW5wdXRNYW5hZ2VyLnJlc2V0IHdoZW4geW91IHBlcmZvcm0gYSBTdGF0ZSBjaGFuZ2UuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50ZXIjcmVzZXQKICAgICovCiAgICByZXNldDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc01vdXNlID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5hY3RpdmUgPSBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuaWRlbnRpZmllciA9IG51bGw7CiAgICAgICAgdGhpcy5pc0Rvd24gPSBmYWxzZTsKICAgICAgICB0aGlzLmlzVXAgPSB0cnVlOwogICAgICAgIHRoaXMudG90YWxUb3VjaGVzID0gMDsKICAgICAgICB0aGlzLl9ob2xkU2VudCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2hpc3RvcnkubGVuZ3RoID0gMDsKICAgICAgICB0aGlzLl9zdGF0ZVJlc2V0ID0gdHJ1ZTsKCiAgICAgICAgaWYgKHRoaXMudGFyZ2V0T2JqZWN0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50YXJnZXRPYmplY3QuX3JlbGVhc2VkSGFuZGxlcih0aGlzKTsKICAgICAgICB9CgogICAgICAgIHRoaXMudGFyZ2V0T2JqZWN0ID0gbnVsbDsKCiAgICB9LAoKCS8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludGVyI3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLgogICAgKiovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAiW3tQb2ludGVyIChpZD0iICsgdGhpcy5pZCArICIgaWRlbnRpZmVyPSIgKyB0aGlzLmlkZW50aWZpZXIgKyAiIGFjdGl2ZT0iICsgdGhpcy5hY3RpdmUgKyAiIGR1cmF0aW9uPSIgKyB0aGlzLmR1cmF0aW9uICsgIiB3aXRoaW5HYW1lPSIgKyB0aGlzLndpdGhpbkdhbWUgKyAiIHg9IiArIHRoaXMueCArICIgeT0iICsgdGhpcy55ICsgIiBjbGllbnRYPSIgKyB0aGlzLmNsaWVudFggKyAiIGNsaWVudFk9IiArIHRoaXMuY2xpZW50WSArICIgc2NyZWVuWD0iICsgdGhpcy5zY3JlZW5YICsgIiBzY3JlZW5ZPSIgKyB0aGlzLnNjcmVlblkgKyAiIHBhZ2VYPSIgKyB0aGlzLnBhZ2VYICsgIiBwYWdlWT0iICsgdGhpcy5wYWdlWSArICIpfV0iOwogICAgfQoKfTsKCi8qKgoqIEhvdyBsb25nIHRoZSBQb2ludGVyIGhhcyBiZWVuIGRlcHJlc3NlZCBvbiB0aGUgdG91Y2hzY3JlZW4uIElmIG5vdCBjdXJyZW50bHkgZG93biBpdCByZXR1cm5zIC0xLgoqIEBuYW1lIFBoYXNlci5Qb2ludGVyI2R1cmF0aW9uCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gSG93IGxvbmcgdGhlIFBvaW50ZXIgaGFzIGJlZW4gZGVwcmVzc2VkIG9uIHRoZSB0b3VjaHNjcmVlbi4gSWYgbm90IGN1cnJlbnRseSBkb3duIGl0IHJldHVybnMgLTEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJkdXJhdGlvbiIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuaXNVcCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnRpbWVEb3duOwoKICAgIH0KCn0pOwoKLyoqCiogR2V0cyB0aGUgWCB2YWx1ZSBvZiB0aGlzIFBvaW50ZXIgaW4gd29ybGQgY29vcmRpbmF0ZXMgYmFzZWQgb24gdGhlIHdvcmxkIGNhbWVyYS4KKiBAbmFtZSBQaGFzZXIuUG9pbnRlciN3b3JsZFgKKiBAcHJvcGVydHkge251bWJlcn0gZHVyYXRpb24gLSBUaGUgWCB2YWx1ZSBvZiB0aGlzIFBvaW50ZXIgaW4gd29ybGQgY29vcmRpbmF0ZXMgYmFzZWQgb24gdGhlIHdvcmxkIGNhbWVyYS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Qb2ludGVyLnByb3RvdHlwZSwgIndvcmxkWCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCgkJcmV0dXJuIHRoaXMuZ2FtZS53b3JsZC5jYW1lcmEueCArIHRoaXMueDsKCiAgICB9Cgp9KTsKCi8qKgoqIEdldHMgdGhlIFkgdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQG5hbWUgUGhhc2VyLlBvaW50ZXIjd29ybGRZCiogQHByb3BlcnR5IHtudW1iZXJ9IGR1cmF0aW9uIC0gVGhlIFkgdmFsdWUgb2YgdGhpcyBQb2ludGVyIGluIHdvcmxkIGNvb3JkaW5hdGVzIGJhc2VkIG9uIHRoZSB3b3JsZCBjYW1lcmEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUG9pbnRlci5wcm90b3R5cGUsICJ3b3JsZFkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgoJCXJldHVybiB0aGlzLmdhbWUud29ybGQuY2FtZXJhLnkgKyB0aGlzLnk7CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuVG91Y2ggaGFuZGxlcyB0b3VjaCBldmVudHMgd2l0aCB5b3VyIGdhbWUuIE5vdGU6IEFuZHJvaWQgMi54IG9ubHkgc3VwcG9ydHMgMSB0b3VjaCBldmVudCBhdCBvbmNlLCBubyBtdWx0aS10b3VjaC4KKgoqIEBjbGFzcyBQaGFzZXIuVG91Y2gKKiBAY2xhc3NkZXNjIFRoZSBUb3VjaCBjbGFzcyBoYW5kbGVzIHRvdWNoIGludGVyYWN0aW9ucyB3aXRoIHRoZSBnYW1lIGFuZCB0aGUgcmVzdWx0aW5nIFBvaW50ZXIgb2JqZWN0cy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Ub3VjaCA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwogICAgCiAgICAvKioKICAgICogWW91IGNhbiBkaXNhYmxlIGFsbCBJbnB1dCBieSBzZXR0aW5nIGRpc2FibGVkID0gdHJ1ZS4gV2hpbGUgc2V0IGFsbCBuZXcgaW5wdXQgcmVsYXRlZCBldmVudHMgd2lsbCBiZSBpZ25vcmVkLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNkaXNhYmxlZAogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHRoaXMuZGlzYWJsZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gY2FsbGJhY2tDb250ZXh0IC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy5jYWxsYmFja0NvbnRleHQgPSB0aGlzLmdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IHRvdWNoU3RhcnRDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hTdGFydENhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IHRvdWNoTW92ZUNhbGxiYWNrIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3VjaE1vdmVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSB0b3VjaEVuZENhbGxiYWNrIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3VjaEVuZENhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IHRvdWNoRW50ZXJDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hFbnRlckNhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IHRvdWNoTGVhdmVDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMudG91Y2hMZWF2ZUNhbGxiYWNrID0gbnVsbDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHRvdWNoQ2FuY2VsQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdWNoQ2FuY2VsQ2FsbGJhY2sgPSBudWxsOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwcmV2ZW50RGVmYXVsdCAtIERlc2NyaXB0aW9uLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucHJldmVudERlZmF1bHQgPSB0cnVlOwoKICAgIHRoaXMuX29uVG91Y2hTdGFydCA9IG51bGw7CiAgICB0aGlzLl9vblRvdWNoTW92ZSA9IG51bGw7CiAgICB0aGlzLl9vblRvdWNoRW5kID0gbnVsbDsKICAgIHRoaXMuX29uVG91Y2hFbnRlciA9IG51bGw7CiAgICB0aGlzLl9vblRvdWNoTGVhdmUgPSBudWxsOwogICAgdGhpcy5fb25Ub3VjaENhbmNlbCA9IG51bGw7CiAgICB0aGlzLl9vblRvdWNoTW92ZSA9IG51bGw7Cgp9OwoKUGhhc2VyLlRvdWNoLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogU3RhcnRzIHRoZSBldmVudCBsaXN0ZW5lcnMgcnVubmluZy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjc3RhcnQKICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBpZiAodGhpcy5nYW1lLmRldmljZS50b3VjaCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hTdGFydCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hTdGFydChldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoTW92ZSA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hNb3ZlKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hFbmQgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoRW5kKGV2ZW50KTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIHRoaXMuX29uVG91Y2hFbnRlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hFbnRlcihldmVudCk7CiAgICAgICAgICAgIH07CgogICAgICAgICAgICB0aGlzLl9vblRvdWNoTGVhdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5vblRvdWNoTGVhdmUoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5fb25Ub3VjaENhbmNlbCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm9uVG91Y2hDYW5jZWwoZXZlbnQpOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hzdGFydCcsIHRoaXMuX29uVG91Y2hTdGFydCwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9vblRvdWNoTW92ZSwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMuX29uVG91Y2hFbmQsIGZhbHNlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnJlbmRlcmVyLnZpZXcuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2hlbnRlcicsIHRoaXMuX29uVG91Y2hFbnRlciwgZmFsc2UpOwogICAgICAgICAgICB0aGlzLmdhbWUucmVuZGVyZXIudmlldy5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGxlYXZlJywgdGhpcy5fb25Ub3VjaExlYXZlLCBmYWxzZSk7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5yZW5kZXJlci52aWV3LmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGhpcy5fb25Ub3VjaENhbmNlbCwgZmFsc2UpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDb25zdW1lcyBhbGwgdG91Y2htb3ZlIGV2ZW50cyBvbiB0aGUgZG9jdW1lbnQgKG9ubHkgZW5hYmxlIHRoaXMgaWYgeW91IGtub3cgeW91IG5lZWQgaXQhKS4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjY29uc3VtZVRvdWNoTW92ZQogICAgKi8KICAgIGNvbnN1bWVEb2N1bWVudFRvdWNoZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5fZG9jdW1lbnRUb3VjaE1vdmUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICB9OwoKICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLl9kb2N1bWVudFRvdWNoTW92ZSwgZmFsc2UpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoU3RhcnQKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgb25Ub3VjaFN0YXJ0OiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hTdGFydENhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaFN0YXJ0Q2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gIGV2ZW50LnRhcmdldFRvdWNoZXMgPSBsaXN0IG9mIGFsbCB0b3VjaGVzIG9uIHRoZSBUQVJHRVQgRUxFTUVOVCAoaS5lLiBnYW1lIGRvbSBlbGVtZW50KQogICAgICAgIC8vICBldmVudC50b3VjaGVzID0gbGlzdCBvZiBhbGwgdG91Y2hlcyBvbiB0aGUgRU5USVJFIERPQ1VNRU5ULCBub3QganVzdCB0aGUgdGFyZ2V0IGVsZW1lbnQKICAgICAgICAvLyAgZXZlbnQuY2hhbmdlZFRvdWNoZXMgPSB0aGUgdG91Y2hlcyB0aGF0IENIQU5HRUQgaW4gdGhpcyBldmVudCwgbm90IHRoZSB0b3RhbCBudW1iZXIgb2YgdGhlbQogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RhcnRQb2ludGVyKGV2ZW50LmNoYW5nZWRUb3VjaGVzW2ldKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVG91Y2ggY2FuY2VsIC0gdG91Y2hlcyB0aGF0IHdlcmUgZGlzcnVwdGVkIChwZXJoYXBzIGJ5IG1vdmluZyBpbnRvIGEgcGx1Z2luIG9yIGJyb3dzZXIgY2hyb21lKS4KICAgICogT2NjdXJzIGZvciBleGFtcGxlIG9uIGlPUyB3aGVuIHlvdSBwdXQgZG93biA0IGZpbmdlcnMgYW5kIHRoZSBhcHAgc2VsZWN0b3IgVUkgYXBwZWFycy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaENhbmNlbAogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBvblRvdWNoQ2FuY2VsOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hDYW5jZWxDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hDYW5jZWxDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmlucHV0LmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyAgVG91Y2ggY2FuY2VsIC0gdG91Y2hlcyB0aGF0IHdlcmUgZGlzcnVwdGVkIChwZXJoYXBzIGJ5IG1vdmluZyBpbnRvIGEgcGx1Z2luIG9yIGJyb3dzZXIgY2hyb21lKQogICAgICAgIC8vICBodHRwOi8vd3d3LnczLm9yZy9UUi90b3VjaC1ldmVudHMvI2Rmbi10b3VjaGNhbmNlbAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc3RvcFBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBGb3IgdG91Y2ggZW50ZXIgYW5kIGxlYXZlIGl0cyBhIGxpc3Qgb2YgdGhlIHRvdWNoIHBvaW50cyB0aGF0IGhhdmUgZW50ZXJlZCBvciBsZWZ0IHRoZSB0YXJnZXQuCiAgICAqIERvZXNuJ3QgYXBwZWFyIHRvIGJlIHN1cHBvcnRlZCBieSBtb3N0IGJyb3dzZXJzIG9uIGEgY2FudmFzIGVsZW1lbnQgeWV0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoRW50ZXIKICAgICogQHBhcmFtIHtBbnl9IGV2ZW50CiAgICAqLwogICAgb25Ub3VjaEVudGVyOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hFbnRlckNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaEVudGVyQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5pbnB1dC5kaXNhYmxlZCB8fCB0aGlzLmRpc2FibGVkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3RvdWNoIGVudGVyJyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEZvciB0b3VjaCBlbnRlciBhbmQgbGVhdmUgaXRzIGEgbGlzdCBvZiB0aGUgdG91Y2ggcG9pbnRzIHRoYXQgaGF2ZSBlbnRlcmVkIG9yIGxlZnQgdGhlIHRhcmdldC4KICAgICogRG9lc24ndCBhcHBlYXIgdG8gYmUgc3VwcG9ydGVkIGJ5IG1vc3QgYnJvd3NlcnMgb24gYSBjYW52YXMgZWxlbWVudCB5ZXQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlRvdWNoI29uVG91Y2hMZWF2ZQogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovICAgIAogICAgb25Ub3VjaExlYXZlOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hMZWF2ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaExlYXZlQ2FsbGJhY2suY2FsbCh0aGlzLmNhbGxiYWNrQ29udGV4dCwgZXZlbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucHJldmVudERlZmF1bHQpCiAgICAgICAgewogICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3RvdWNoIGxlYXZlJyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAbWV0aG9kIFBoYXNlci5Ub3VjaCNvblRvdWNoTW92ZQogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBvblRvdWNoTW92ZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoTW92ZUNhbGxiYWNrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50b3VjaE1vdmVDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGV2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnVwZGF0ZVBvaW50ZXIoZXZlbnQuY2hhbmdlZFRvdWNoZXNbaV0pOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjb25Ub3VjaEVuZAogICAgKiBAcGFyYW0ge0FueX0gZXZlbnQKICAgICovCiAgICBvblRvdWNoRW5kOiBmdW5jdGlvbiAoZXZlbnQpIHsKCiAgICAgICAgaWYgKHRoaXMudG91Y2hFbmRDYWxsYmFjaykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudG91Y2hFbmRDYWxsYmFjay5jYWxsKHRoaXMuY2FsbGJhY2tDb250ZXh0LCBldmVudCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5wcmV2ZW50RGVmYXVsdCkKICAgICAgICB7CiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgfQoKICAgICAgICAvLyAgRm9yIHRvdWNoIGVuZCBpdHMgYSBsaXN0IG9mIHRoZSB0b3VjaCBwb2ludHMgdGhhdCBoYXZlIGJlZW4gcmVtb3ZlZCBmcm9tIHRoZSBzdXJmYWNlCiAgICAgICAgLy8gIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvRE9NL1RvdWNoTGlzdAogICAgICAgIC8vICBldmVudC5jaGFuZ2VkVG91Y2hlcyA9IHRoZSB0b3VjaGVzIHRoYXQgQ0hBTkdFRCBpbiB0aGlzIGV2ZW50LCBub3QgdGhlIHRvdGFsIG51bWJlciBvZiB0aGVtCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zdG9wUG9pbnRlcihldmVudC5jaGFuZ2VkVG91Y2hlc1tpXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFN0b3AgdGhlIGV2ZW50IGxpc3RlbmVycy4KICAgICogQG1ldGhvZCBQaGFzZXIuVG91Y2gjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UudG91Y2gpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCB0aGlzLl9vblRvdWNoU3RhcnQpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuX29uVG91Y2hNb3ZlKTsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMuX29uVG91Y2hFbmQpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoZW50ZXInLCB0aGlzLl9vblRvdWNoRW50ZXIpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobGVhdmUnLCB0aGlzLl9vblRvdWNoTGVhdmUpOwogICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNoY2FuY2VsJywgdGhpcy5fb25Ub3VjaENhbmNlbCk7CiAgICAgICAgfQoKICAgIH0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENvbnN0cnVjdG9yIGZvciBQaGFzZXIgSW5wdXRIYW5kbGVyLgoqIEBjbGFzcyBQaGFzZXIuSW5wdXRIYW5kbGVyCiogQGNsYXNzZGVzYyBEZXNjcmlwdGlvbi4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IGdhbWUgLSBEZXNjcmlwdGlvbi4KKi8KUGhhc2VyLklucHV0SGFuZGxlciA9IGZ1bmN0aW9uIChzcHJpdGUpIHsKCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4gCgkqLwoJdGhpcy5zcHJpdGUgPSBzcHJpdGU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCiAgICAqLwogICAgdGhpcy5nYW1lID0gc3ByaXRlLmdhbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW5hYmxlZCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCiAgICAvLwlMaW5rZWQgbGlzdCByZWZlcmVuY2VzCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gcGFyZW50IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucGFyZW50ID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IG5leHQgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5uZXh0ID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHByZXYgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5wcmV2ID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGxhc3QgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5sYXN0ID0gdGhpczsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGZpcnN0IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZmlyc3QgPSB0aGlzOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcHJpb3JpdHlJRCAtIFRoZSBQcmlvcml0eUlEIGNvbnRyb2xzIHdoaWNoIFNwcml0ZSByZWNlaXZlcyBhbiBJbnB1dCBldmVudCBmaXJzdCBpZiB0aGV5IHNob3VsZCBvdmVybGFwLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucHJpb3JpdHlJRCA9IDA7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzZUhhbmRDdXJzb3IgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy51c2VIYW5kQ3Vyc29yID0gZmFsc2U7CgkKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRHJhZ2dlZCAtIERlc2NyaXB0aW9uLiAKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd0hvcml6b250YWxEcmFnIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYWxsb3dIb3Jpem9udGFsRHJhZyA9IHRydWU7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsbG93VmVydGljYWxEcmFnIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcgPSB0cnVlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBicmluZ1RvVG9wIC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYnJpbmdUb1RvcCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBzbmFwT2Zmc2V0IC0gRGVzY3JpcHRpb24uIAoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuc25hcE9mZnNldCA9IG51bGw7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHNuYXBPbkRyYWcgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zbmFwT25EcmFnID0gZmFsc2U7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHNuYXBPblJlbGVhc2UgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zbmFwT25SZWxlYXNlID0gZmFsc2U7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc25hcFggLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zbmFwWCA9IDA7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc25hcFkgLSBEZXNjcmlwdGlvbi4gCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5zbmFwWSA9IDA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwaXhlbFBlcmZlY3QgLSBTaG91bGQgd2UgdXNlIHBpeGVsIHBlcmZlY3QgaGl0IGRldGVjdGlvbj8gV2FybmluZzogZXhwZW5zaXZlLiBPbmx5IGVuYWJsZSBpZiB5b3UgcmVhbGx5IG5lZWQgaXQhCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5waXhlbFBlcmZlY3QgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBpeGVsUGVyZmVjdEFscGhhIC0gVGhlIGFscGhhIHRvbGVyYW5jZSB0aHJlc2hvbGQuIElmIHRoZSBhbHBoYSB2YWx1ZSBvZiB0aGUgcGl4ZWwgbWF0Y2hlcyBvciBpcyBhYm92ZSB0aGlzIHZhbHVlLCBpdCdzIGNvbnNpZGVyZWQgYSBoaXQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5waXhlbFBlcmZlY3RBbHBoYSA9IDI1NTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBkcmFnZ2FibGUgLSBJcyB0aGlzIHNwcml0ZSBhbGxvd2VkIHRvIGJlIGRyYWdnZWQgYnkgdGhlIG1vdXNlPyB0cnVlID0geWVzLCBmYWxzZSA9IG5vCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHRoaXMuZHJhZ2dhYmxlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGJvdW5kc1JlY3QgLSBBIHJlZ2lvbiBvZiB0aGUgZ2FtZSB3b3JsZCB3aXRoaW4gd2hpY2ggdGhlIHNwcml0ZSBpcyByZXN0cmljdGVkIGR1cmluZyBkcmFnLgogICAgKiBAZGVmYXVsdCAKICAgICovCiAgICB0aGlzLmJvdW5kc1JlY3QgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBib3VuZHNTcHJpdGUgLSBBIFNwcml0ZSB0aGUgYm91bmRzIG9mIHdoaWNoIHRoaXMgc3ByaXRlIGlzIHJlc3RyaWN0ZWQgZHVyaW5nIGRyYWcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5ib3VuZHNTcHJpdGUgPSBudWxsOwoKICAgIC8qKgogICAgKiBJZiB0aGlzIG9iamVjdCBpcyBzZXQgdG8gY29uc3VtZSB0aGUgcG9pbnRlciBldmVudCB0aGVuIGl0IHdpbGwgc3RvcCBhbGwgcHJvcG9nYXRpb24gZnJvbSB0aGlzIG9iamVjdCBvbi4KICAgICogRm9yIGV4YW1wbGUgaWYgeW91IGhhZCBhIHN0YWNrIG9mIDYgc3ByaXRlcyB3aXRoIHRoZSBzYW1lIHByaW9yaXR5IElEcyBhbmQgb25lIGNvbnN1bWVkIHRoZSBldmVudCwgbm9uZSBvZiB0aGUgb3RoZXJzIHdvdWxkIHJlY2VpdmUgaXQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29uc3VtZVBvaW50ZXJFdmVudAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29uc3VtZVBvaW50ZXJFdmVudCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gX3RlbXBQb2ludCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RlbXBQb2ludCA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgdGhpcy5fcG9pbnRlckRhdGEgPSBbXTsKCiAgICB0aGlzLl9wb2ludGVyRGF0YS5wdXNoKHsKICAgICAgICBpZDogMCwKICAgICAgICB4OiAwLAogICAgICAgIHk6IDAsCiAgICAgICAgaXNEb3duOiBmYWxzZSwKICAgICAgICBpc1VwOiBmYWxzZSwKICAgICAgICBpc092ZXI6IGZhbHNlLAogICAgICAgIGlzT3V0OiBmYWxzZSwKICAgICAgICB0aW1lT3ZlcjogMCwKICAgICAgICB0aW1lT3V0OiAwLAogICAgICAgIHRpbWVEb3duOiAwLAogICAgICAgIHRpbWVVcDogMCwKICAgICAgICBkb3duRHVyYXRpb246IDAsCiAgICAgICAgaXNEcmFnZ2VkOiBmYWxzZQogICAgfSk7Cgp9OwoKUGhhc2VyLklucHV0SGFuZGxlci5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RhcnQKCSogQHBhcmFtIHtudW1iZXJ9IHByaW9yaXR5IC0gRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7Ym9vbGVhbn0gdXNlSGFuZEN1cnNvciAtIERlc2NyaXB0aW9uLgoJKiBAcmV0dXJuIHtQaGFzZXIuU3ByaXRlfSBEZXNjcmlwdGlvbi4KCSovCglzdGFydDogZnVuY3Rpb24gKHByaW9yaXR5LCB1c2VIYW5kQ3Vyc29yKSB7CgoJCXByaW9yaXR5ID0gcHJpb3JpdHkgfHwgMDsKCQlpZiAodHlwZW9mIHVzZUhhbmRDdXJzb3IgPT0gJ3VuZGVmaW5lZCcpIHsgdXNlSGFuZEN1cnNvciA9IGZhbHNlOyB9CgogICAgICAgIC8vICBUdXJuaW5nIG9uCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBSZWdpc3RlciwgZXRjCgkJCXRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLmFkZCh0aGlzKTsKICAgICAgICAgICAgdGhpcy51c2VIYW5kQ3Vyc29yID0gdXNlSGFuZEN1cnNvcjsKICAgICAgICAgICAgdGhpcy5wcmlvcml0eUlEID0gcHJpb3JpdHk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldID0gewogICAgICAgICAgICAgICAgICAgIGlkOiBpLAogICAgICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICAgICAgeTogMCwKICAgICAgICAgICAgICAgICAgICBpc0Rvd246IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzVXA6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGlzT3ZlcjogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgaXNPdXQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIHRpbWVPdmVyOiAwLAogICAgICAgICAgICAgICAgICAgIHRpbWVPdXQ6IDAsCiAgICAgICAgICAgICAgICAgICAgdGltZURvd246IDAsCiAgICAgICAgICAgICAgICAgICAgdGltZVVwOiAwLAogICAgICAgICAgICAgICAgICAgIGRvd25EdXJhdGlvbjogMCwKICAgICAgICAgICAgICAgICAgICBpc0RyYWdnZWQ6IGZhbHNlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnNuYXBPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50OwogICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gIENyZWF0ZSB0aGUgc2lnbmFscyB0aGUgSW5wdXQgY29tcG9uZW50IHdpbGwgZW1pdAogICAgICAgICAgICBpZiAodGhpcy5zcHJpdGUuZXZlbnRzICYmIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3ZlciA9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dE92ZXIgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0T3V0ID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dERvd24gPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0VXAgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgICAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdGFydCA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uRHJhZ1N0b3AgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuc3ByaXRlOwoKCX0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcmVzZXQKCSovCiAgICByZXNldDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCAxMDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbaV0gPSB7CiAgICAgICAgICAgICAgICBpZDogaSwKICAgICAgICAgICAgICAgIHg6IDAsCiAgICAgICAgICAgICAgICB5OiAwLAogICAgICAgICAgICAgICAgaXNEb3duOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzVXA6IGZhbHNlLAogICAgICAgICAgICAgICAgaXNPdmVyOiBmYWxzZSwKICAgICAgICAgICAgICAgIGlzT3V0OiBmYWxzZSwKICAgICAgICAgICAgICAgIHRpbWVPdmVyOiAwLAogICAgICAgICAgICAgICAgdGltZU91dDogMCwKICAgICAgICAgICAgICAgIHRpbWVEb3duOiAwLAogICAgICAgICAgICAgICAgdGltZVVwOiAwLAogICAgICAgICAgICAgICAgZG93bkR1cmF0aW9uOiAwLAogICAgICAgICAgICAgICAgaXNEcmFnZ2VkOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgIH0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjc3RvcAoJKi8KCXN0b3A6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIFR1cm5pbmcgb2ZmCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIERlLXJlZ2lzdGVyLCBldGMKICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CgkJCXRoaXMuZ2FtZS5pbnB1dC5pbnRlcmFjdGl2ZUl0ZW1zLnJlbW92ZSh0aGlzKTsKICAgICAgICB9CgoJfSwKCgkvKioKCSogQ2xlYW4gdXAgbWVtb3J5LgoJKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZGVzdHJveQoJKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlOwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LmludGVyYWN0aXZlSXRlbXMucmVtb3ZlKHRoaXMpOwoKICAgICAgICAJdGhpcy5zdG9wKCk7CgogICAgICAgIAl0aGlzLnNwcml0ZSA9IG51bGw7CiAgICAgICAgfQogICAgfSwKCgkvKioKICAgICogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgSW5wdXQgcG9pbnRlciwgcmVsYXRpdmUgdG8gdGhlIHRvcC1sZWZ0IG9mIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKiBUaGlzIHZhbHVlIGlzIG9ubHkgc2V0IHdoZW4gdGhlIHBvaW50ZXIgaXMgb3ZlciB0aGlzIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJYCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIElucHV0IHBvaW50ZXIuCiAgICAqLyAgICAKICAgIHBvaW50ZXJYOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0ueDsKCiAgICB9LAoKCS8qKgogICAgKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLCByZWxhdGl2ZSB0byB0aGUgdG9wLWxlZnQgb2YgdGhlIHBhcmVudCBTcHJpdGUKICAgICogVGhpcyB2YWx1ZSBpcyBvbmx5IHNldCB3aGVuIHRoZSBwb2ludGVyIGlzIG92ZXIgdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyWQogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBJbnB1dCBwb2ludGVyLgogICAgKi8KICAgIHBvaW50ZXJZOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0ueTsKCiAgICB9LAoKCS8qKgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyB0b3VjaGluZyB0aGUgdG91Y2hzY3JlZW4sIG9yIHRoZSBtb3VzZSBidXR0b24gaXMgaGVsZCBkb3duLCBpc0Rvd24gaXMgc2V0IHRvIHRydWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyRG93bgogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBwb2ludGVyRG93bjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzRG93bjsKCiAgICB9LAoKCS8qKgogICAgKiBJZiB0aGUgUG9pbnRlciBpcyBub3QgdG91Y2hpbmcgdGhlIHRvdWNoc2NyZWVuLCBvciB0aGUgbW91c2UgYnV0dG9uIGlzIHVwLCBpc1VwIGlzIHNldCB0byB0cnVlCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVXAKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59CiAgICAqLwogICAgcG9pbnRlclVwOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNVcDsKCiAgICB9LAoKCS8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBmaXJzdCB0b3VjaGVkIHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lRG93bgogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJUaW1lRG93bjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVEb3duOwoKICAgIH0sCgoJLyoqCiAgICAqIEEgdGltZXN0YW1wIHJlcHJlc2VudGluZyB3aGVuIHRoZSBQb2ludGVyIGxlZnQgdGhlIHRvdWNoc2NyZWVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjcG9pbnRlclRpbWVVcAogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKi8KICAgIHBvaW50ZXJUaW1lVXA6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lVXA7CgogICAgfSwKCgkvKioKICAgICogSXMgdGhlIFBvaW50ZXIgb3ZlciB0aGlzIFNwcml0ZT8KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJPdmVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaW5kZXhdIC0gVGhlIElEIG51bWJlciBvZiBhIFBvaW50ZXIgdG8gY2hlY2suIElmIHlvdSBkb24ndCBwcm92aWRlIGEgbnVtYmVyIGl0IHdpbGwgY2hlY2sgYWxsIFBvaW50ZXJzLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBnaXZlbiBwb2ludGVyIChpZiBhIGluZGV4IHdhcyBnaXZlbiwgb3IgYW55IHBvaW50ZXIgaWYgbm90KSBpcyBvdmVyIHRoaXMgb2JqZWN0LgogICAgKi8KICAgIHBvaW50ZXJPdmVyOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMuZW5hYmxlZCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaW5kZXggPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW2ldLmlzT3ZlcikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtpbmRleF0uaXNPdmVyOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCgkvKioKICAgICogSXMgdGhlIFBvaW50ZXIgb3V0c2lkZSBvZiB0aGlzIFNwcml0ZT8KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJPdXQKICAgICogQHBhcmFtIHtudW1iZXJ9IFtpbmRleF0gLSBUaGUgSUQgbnVtYmVyIG9mIGEgUG9pbnRlciB0byBjaGVjay4gSWYgeW91IGRvbid0IHByb3ZpZGUgYSBudW1iZXIgaXQgd2lsbCBjaGVjayBhbGwgUG9pbnRlcnMuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBvaW50ZXIgKGlmIGEgaW5kZXggd2FzIGdpdmVuLCBvciBhbnkgcG9pbnRlciBpZiBub3QpIGlzIG91dCBvZiB0aGlzIG9iamVjdC4KICAgICovCiAgICBwb2ludGVyT3V0OiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5lbmFibGVkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpbmRleCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgMTA7IGkrKykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbaV0uaXNPdXQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcG9pbnRlckRhdGFbaW5kZXhdLmlzT3V0OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCgkvKioKICAgICogQSB0aW1lc3RhbXAgcmVwcmVzZW50aW5nIHdoZW4gdGhlIFBvaW50ZXIgZmlyc3QgdG91Y2hlZCB0aGUgdG91Y2hzY3JlZW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNwb2ludGVyVGltZU92ZXIKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICovCiAgICBwb2ludGVyVGltZU92ZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3ZlcjsKCiAgICB9LAoKCS8qKgogICAgKiBBIHRpbWVzdGFtcCByZXByZXNlbnRpbmcgd2hlbiB0aGUgUG9pbnRlciBsZWZ0IHRoZSB0b3VjaHNjcmVlbi4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lT3V0CiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlclRpbWVPdXQ6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3V0OwoKICAgIH0sCgoJLyoqCiAgICAqIElzIHRoaXMgc3ByaXRlIGJlaW5nIGRyYWdnZWQgYnkgdGhlIG1vdXNlIG9yIG5vdD8KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3BvaW50ZXJUaW1lT3V0CiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgcG9pbnRlckRyYWdnZWQ6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CgogICAgICAgIHJldHVybiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc0RyYWdnZWQ7CgogICAgfSwKCgkvKioKICAgICogQ2hlY2tzIGlmIHRoZSBnaXZlbiBwb2ludGVyIGlzIG92ZXIgdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNjaGVja1BvaW50ZXJPdmVyCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGNoZWNrUG9pbnRlck92ZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgJiYgdGhpcy5zcHJpdGUudmlzaWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmdldExvY2FsVW5tb2RpZmllZFBvc2l0aW9uKHRoaXMuX3RlbXBQb2ludCwgcG9pbnRlci54LCBwb2ludGVyLnkpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3RlbXBQb2ludC54ID49IDAgJiYgdGhpcy5fdGVtcFBvaW50LnggPD0gdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lLndpZHRoICYmIHRoaXMuX3RlbXBQb2ludC55ID49IDAgJiYgdGhpcy5fdGVtcFBvaW50LnkgPD0gdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lLmhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMucGl4ZWxQZXJmZWN0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNoZWNrUGl4ZWwodGhpcy5fdGVtcFBvaW50LngsIHRoaXMuX3RlbXBQb2ludC55KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCiAgICAqIFJ1bnMgYSBwaXhlbCBwZXJmZWN0IGNoZWNrIGFnYWluc3QgdGhlIGdpdmVuIHgveSBjb29yZGluYXRlcyBvZiB0aGUgU3ByaXRlIHRoaXMgSW5wdXRIYW5kbGVyIGlzIGJvdW5kIHRvLgogICAgKiBJdCBjb21wYXJlcyB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIHBpeGVsIGFuZCBpZiA+PSBJbnB1dEhhbmRsZXIucGl4ZWxQZXJmZWN0QWxwaGEgaXQgcmV0dXJucyB0cnVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tQaXhlbAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gY2hlY2suCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBjaGVjay4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGVyZSBpcyB0aGUgYWxwaGEgb2YgdGhlIHBpeGVsIGlzID49IElucHV0SGFuZGxlci5waXhlbFBlcmZlY3RBbHBoYQogICAgKi8KICAgIGNoZWNrUGl4ZWw6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIC8vICBHcmFiIGEgcGl4ZWwgZnJvbSBvdXIgaW1hZ2UgaW50byB0aGUgaGl0Q2FudmFzIGFuZCB0aGVuIHRlc3QgaXQKICAgICAgICBpZiAodGhpcy5zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuaGl0Q29udGV4dC5jbGVhclJlY3QoMCwgMCwgMSwgMSk7CgogICAgICAgICAgICB4ICs9IHRoaXMuc3ByaXRlLnRleHR1cmUuZnJhbWUueDsKICAgICAgICAgICAgeSArPSB0aGlzLnNwcml0ZS50ZXh0dXJlLmZyYW1lLnk7CgogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuaGl0Q29udGV4dC5kcmF3SW1hZ2UodGhpcy5zcHJpdGUudGV4dHVyZS5iYXNlVGV4dHVyZS5zb3VyY2UsIHgsIHksIDEsIDEsIDAsIDAsIDEsIDEpOwogICAgICAgICAgICAKICAgICAgICAgICAgdmFyIHJnYiA9IHRoaXMuZ2FtZS5pbnB1dC5oaXRDb250ZXh0LmdldEltYWdlRGF0YSgwLCAwLCAxLCAxKTsKCiAgICAgICAgICAgIGlmIChyZ2IuZGF0YVszXSA+PSB0aGlzLnBpeGVsUGVyZmVjdEFscGhhKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCiAgICAqIFVwZGF0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI3VwZGF0ZQogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICovCiAgICB1cGRhdGU6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgPT0gZmFsc2UgfHwgdGhpcy5zcHJpdGUudmlzaWJsZSA9PSBmYWxzZSB8fCAodGhpcy5zcHJpdGUuZ3JvdXAgJiYgdGhpcy5zcHJpdGUuZ3JvdXAudmlzaWJsZSA9PSBmYWxzZSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyT3V0SGFuZGxlcihwb2ludGVyKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPT0gcG9pbnRlci5pZCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZURyYWcocG9pbnRlcik7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzT3ZlciA9PSB0cnVlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuY2hlY2tQb2ludGVyT3Zlcihwb2ludGVyKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0ueCA9IHBvaW50ZXIueCAtIHRoaXMuc3ByaXRlLng7CiAgICAgICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS55ID0gcG9pbnRlci55IC0gdGhpcy5zcHJpdGUueTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcG9pbnRlck91dEhhbmRsZXIocG9pbnRlcik7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKCS8qKgogICAgICogRGVzY3JpcHRpb24uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3BvaW50ZXJPdmVySGFuZGxlcgogICAgICogQHByaXZhdGUKICAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgICovCiAgICBfcG9pbnRlck92ZXJIYW5kbGVyOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdXQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZU92ZXIgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnggPSBwb2ludGVyLnggLSB0aGlzLnNwcml0ZS54OwogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS55ID0gcG9pbnRlci55IC0gdGhpcy5zcHJpdGUueTsKCiAgICAgICAgICAgIGlmICh0aGlzLnVzZUhhbmRDdXJzb3IgJiYgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc3RhZ2UuY2FudmFzLnN0eWxlLmN1cnNvciA9ICJwb2ludGVyIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdmVyLmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKICAgICAgICB9CiAgICB9LAoKCS8qKgogICAgICogRGVzY3JpcHRpb24uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3BvaW50ZXJPdXRIYW5kbGVyCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAgKi8KICAgIF9wb2ludGVyT3V0SGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdmVyID0gZmFsc2U7CiAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNPdXQgPSB0cnVlOwogICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVPdXQgPSB0aGlzLmdhbWUudGltZS5ub3c7CgogICAgICAgIGlmICh0aGlzLnVzZUhhbmRDdXJzb3IgJiYgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNEcmFnZ2VkID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zcHJpdGUgJiYgdGhpcy5zcHJpdGUuZXZlbnRzKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRPdXQuZGlzcGF0Y2godGhpcy5zcHJpdGUsIHBvaW50ZXIpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgICogRGVzY3JpcHRpb24uCiAgICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjX3RvdWNoZWRIYW5kbGVyCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAgKi8KICAgIF90b3VjaGVkSGFuZGxlcjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRG93biA9PSBmYWxzZSAmJiB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc092ZXIgPT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRG93biA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzVXAgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZURvd24gPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbklucHV0RG93bi5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgICAgICAgICAvLyAgU3RhcnQgZHJhZwogICAgICAgICAgICBpZiAodGhpcy5kcmFnZ2FibGUgJiYgdGhpcy5pc0RyYWdnZWQgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc3RhcnREcmFnKHBvaW50ZXIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5icmluZ1RvVG9wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNwcml0ZS5icmluZ1RvVG9wKCk7CgkJCX0KICAgICAgICB9CgogICAgICAgIC8vICBDb25zdW1lIHRoZSBldmVudD8KICAgICAgICByZXR1cm4gdGhpcy5jb25zdW1lUG9pbnRlckV2ZW50OwoKICAgIH0sCgoJLyoqCiAgICAgKiBEZXNjcmlwdGlvbi4KICAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNfcmVsZWFzZWRIYW5kbGVyCiAgICAgKiBAcHJpdmF0ZQogICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAgKi8KICAgIF9yZWxlYXNlZEhhbmRsZXI6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIC8vICBJZiB3YXMgcHJldmlvdXNseSB0b3VjaGVkIGJ5IHRoaXMgUG9pbnRlciwgY2hlY2sgaWYgc3RpbGwgaXMgQU5EIHN0aWxsIG92ZXIgdGhpcyBpdGVtCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLmlzRG93biAmJiBwb2ludGVyLmlzVXApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0Rvd24gPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uaXNVcCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXIuaWRdLnRpbWVVcCA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICAgICAgdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0uZG93bkR1cmF0aW9uID0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZVVwIC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlci5pZF0udGltZURvd247CgogICAgICAgICAgICAvLyAgT25seSByZWxlYXNlIHRoZSBJbnB1dFVwIHNpZ25hbCBpZiB0aGUgcG9pbnRlciBpcyBzdGlsbCBvdmVyIHRoaXMgc3ByaXRlCiAgICAgICAgICAgIGlmICh0aGlzLmNoZWNrUG9pbnRlck92ZXIocG9pbnRlcikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ3JlbGVhc2VkSGFuZGxlcjogJyArIERhdGUubm93KCkpOwogICAgICAgICAgICAgICAgdGhpcy5zcHJpdGUuZXZlbnRzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgUG9pbnRlciBvdXRzaWRlIHRoZSBzcHJpdGU/IFJlc2V0IHRoZSBjdXJzb3IKICAgICAgICAgICAgICAgIGlmICh0aGlzLnVzZUhhbmRDdXJzb3IpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZS5jdXJzb3IgPSAiZGVmYXVsdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vICBTdG9wIGRyYWcKICAgICAgICAgICAgaWYgKHRoaXMuZHJhZ2dhYmxlICYmIHRoaXMuaXNEcmFnZ2VkICYmIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPT0gcG9pbnRlci5pZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zdG9wRHJhZyhwb2ludGVyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBVcGRhdGVzIHRoZSBQb2ludGVyIGRyYWcgb24gdGhpcyBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciN1cGRhdGVEcmFnCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIHVwZGF0ZURyYWc6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIGlmIChwb2ludGVyLmlzVXApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnN0b3BEcmFnKHBvaW50ZXIpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5hbGxvd0hvcml6b250YWxEcmFnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IHBvaW50ZXIueCArIHRoaXMuX2RyYWdQb2ludC54ICsgdGhpcy5kcmFnT2Zmc2V0Lng7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5hbGxvd1ZlcnRpY2FsRHJhZykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSBwb2ludGVyLnkgKyB0aGlzLl9kcmFnUG9pbnQueSArIHRoaXMuZHJhZ09mZnNldC55OwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYm91bmRzUmVjdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY2hlY2tCb3VuZHNSZWN0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5ib3VuZHNTcHJpdGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoZWNrQm91bmRzU3ByaXRlKCk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zbmFwT25EcmFnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IE1hdGgucm91bmQodGhpcy5zcHJpdGUueCAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWDsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IE1hdGgucm91bmQodGhpcy5zcHJpdGUueSAvIHRoaXMuc25hcFkpICogdGhpcy5zbmFwWTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0cnVlOwoKICAgIH0sCgoJLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcG9pbnRlciBoYXMgZW50ZXJlZCB0aGUgU3ByaXRlIHdpdGhpbiB0aGUgc3BlY2lmaWVkIGRlbGF5IHRpbWUgKGRlZmF1bHRzIHRvIDUwMG1zLCBoYWxmIGEgc2Vjb25kKQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjanVzdE92ZXIKICAgICogQHBhcmFtIHtQb2ludGVyfSBwb2ludGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkZWxheSAtIFRoZSB0aW1lIGJlbG93IHdoaWNoIHRoZSBwb2ludGVyIGlzIGNvbnNpZGVyZWQgYXMganVzdCBvdmVyLgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RPdmVyOiBmdW5jdGlvbiAocG9pbnRlciwgZGVsYXkpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKICAgIAlkZWxheSA9IGRlbGF5IHx8IDUwMDsKCiAgICAgICAgcmV0dXJuICh0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS5pc092ZXIgJiYgdGhpcy5vdmVyRHVyYXRpb24ocG9pbnRlcikgPCBkZWxheSk7CgogICAgfSwKCgkvKioKICAgICogUmV0dXJucyB0cnVlIGlmIHRoZSBwb2ludGVyIGhhcyBsZWZ0IHRoZSBTcHJpdGUgd2l0aGluIHRoZSBzcGVjaWZpZWQgZGVsYXkgdGltZSAoZGVmYXVsdHMgdG8gNTAwbXMsIGhhbGYgYSBzZWNvbmQpCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNqdXN0T3V0CiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3V0LgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RPdXQ6IGZ1bmN0aW9uIChwb2ludGVyLCBkZWxheSkgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwogICAgCWRlbGF5ID0gZGVsYXkgfHwgNTAwOwoKICAgICAgICByZXR1cm4gKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzT3V0ICYmICh0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3V0IDwgZGVsYXkpKTsKCiAgICB9LAoKCS8qKgogICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHBvaW50ZXIgaGFzIGVudGVyZWQgdGhlIFNwcml0ZSB3aXRoaW4gdGhlIHNwZWNpZmllZCBkZWxheSB0aW1lIChkZWZhdWx0cyB0byA1MDBtcywgaGFsZiBhIHNlY29uZCkKICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2p1c3RQcmVzc2VkCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3Zlci4KICAgICogQHJldHVybiB7Ym9vbGVhbn0KICAgICovCiAgICBqdXN0UHJlc3NlZDogZnVuY3Rpb24gKHBvaW50ZXIsIGRlbGF5KSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CiAgICAJZGVsYXkgPSBkZWxheSB8fCA1MDA7CgogICAgICAgIHJldHVybiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNEb3duICYmIHRoaXMuZG93bkR1cmF0aW9uKHBvaW50ZXIpIDwgZGVsYXkpOwoKICAgIH0sCgoJLyoqCiAgICAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgcG9pbnRlciBoYXMgbGVmdCB0aGUgU3ByaXRlIHdpdGhpbiB0aGUgc3BlY2lmaWVkIGRlbGF5IHRpbWUgKGRlZmF1bHRzIHRvIDUwMG1zLCBoYWxmIGEgc2Vjb25kKQogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjanVzdFJlbGVhc2VkCiAgICAqIEBwYXJhbSB7UG9pbnRlcn0gcG9pbnRlcgogICAgKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBUaGUgdGltZSBiZWxvdyB3aGljaCB0aGUgcG9pbnRlciBpcyBjb25zaWRlcmVkIGFzIGp1c3Qgb3V0LgogICAgKiBAcmV0dXJuIHtib29sZWFufQogICAgKi8KICAgIGp1c3RSZWxlYXNlZDogZnVuY3Rpb24gKHBvaW50ZXIsIGRlbGF5KSB7CgogICAgCXBvaW50ZXIgPSBwb2ludGVyIHx8IDA7CiAgICAJZGVsYXkgPSBkZWxheSB8fCA1MDA7CgogICAgICAgIHJldHVybiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNVcCAmJiAodGhpcy5nYW1lLnRpbWUubm93IC0gdGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0udGltZVVwIDwgZGVsYXkpKTsKCiAgICB9LAoKCS8qKgogICAgKiBJZiB0aGUgcG9pbnRlciBpcyBjdXJyZW50bHkgb3ZlciB0aGlzIFNwcml0ZSB0aGlzIHJldHVybnMgaG93IGxvbmcgaXQgaGFzIGJlZW4gdGhlcmUgZm9yIGluIG1pbGxpc2Vjb25kcy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI292ZXJEdXJhdGlvbgogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGUgcG9pbnRlciBoYXMgYmVlbiBvdmVyIHRoZSBTcHJpdGUsIG9yIC0xIGlmIG5vdCBvdmVyLgogICAgKi8KICAgIG92ZXJEdXJhdGlvbjogZnVuY3Rpb24gKHBvaW50ZXIpIHsKCiAgICAJcG9pbnRlciA9IHBvaW50ZXIgfHwgMDsKCiAgICAgICAgaWYgKHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLmlzT3ZlcikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyXS50aW1lT3ZlcjsKICAgICAgICB9CgogICAgICAgIHJldHVybiAtMTsKCiAgICB9LAoKCS8qKgogICAgKiBJZiB0aGUgcG9pbnRlciBpcyBjdXJyZW50bHkgb3ZlciB0aGlzIFNwcml0ZSB0aGlzIHJldHVybnMgaG93IGxvbmcgaXQgaGFzIGJlZW4gdGhlcmUgZm9yIGluIG1pbGxpc2Vjb25kcy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2Rvd25EdXJhdGlvbgogICAgKiBAcGFyYW0ge1BvaW50ZXJ9IHBvaW50ZXIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0aGUgcG9pbnRlciBoYXMgYmVlbiBwcmVzc2VkIGRvd24gb24gdGhlIFNwcml0ZSwgb3IgLTEgaWYgbm90IG92ZXIuCiAgICAqLwogICAgZG93bkR1cmF0aW9uOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIAlwb2ludGVyID0gcG9pbnRlciB8fCAwOwoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGFbcG9pbnRlcl0uaXNEb3duKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3BvaW50ZXJEYXRhW3BvaW50ZXJdLnRpbWVEb3duOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIC0xOwoKICAgIH0sCgoJLyoqCiAgICAqIE1ha2UgdGhpcyBTcHJpdGUgZHJhZ2dhYmxlIGJ5IHRoZSBtb3VzZS4gWW91IGNhbiBhbHNvIG9wdGlvbmFsbHkgc2V0IG1vdXNlU3RhcnREcmFnQ2FsbGJhY2sgYW5kIG1vdXNlU3RvcERyYWdDYWxsYmFjawogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZW5hYmxlRHJhZwogICAgKiBAcGFyYW0JbG9ja0NlbnRlcgkJCUlmIGZhbHNlIHRoZSBTcHJpdGUgd2lsbCBkcmFnIGZyb20gd2hlcmUgeW91IGNsaWNrIGl0IG1pbnVzIHRoZSBkcmFnT2Zmc2V0LiBJZiB0cnVlIGl0IHdpbGwgY2VudGVyIGl0c2VsZiB0byB0aGUgdGlwIG9mIHRoZSBtb3VzZSBwb2ludGVyLgogICAgKiBAcGFyYW0JYnJpbmdUb1RvcAkJCUlmIHRydWUgdGhlIFNwcml0ZSB3aWxsIGJlIGJvdWdodCB0byB0aGUgdG9wIG9mIHRoZSByZW5kZXJpbmcgbGlzdCBpbiBpdHMgY3VycmVudCBHcm91cC4KICAgICogQHBhcmFtCXBpeGVsUGVyZmVjdAkJSWYgdHJ1ZSBpdCB3aWxsIHVzZSBhIHBpeGVsIHBlcmZlY3QgdGVzdCB0byBzZWUgaWYgeW91IGNsaWNrZWQgdGhlIFNwcml0ZS4gRmFsc2UgdXNlcyB0aGUgYm91bmRpbmcgYm94LgogICAgKiBAcGFyYW0JYWxwaGFUaHJlc2hvbGQJCUlmIHVzaW5nIHBpeGVsIHBlcmZlY3QgY29sbGlzaW9uIHRoaXMgc3BlY2lmaWVzIHRoZSBhbHBoYSBsZXZlbCBmcm9tIDAgdG8gMjU1IGFib3ZlIHdoaWNoIGEgY29sbGlzaW9uIGlzIHByb2Nlc3NlZCAoZGVmYXVsdCAyNTUpCiAgICAqIEBwYXJhbQlib3VuZHNSZWN0CQkJSWYgeW91IHdhbnQgdG8gcmVzdHJpY3QgdGhlIGRyYWcgb2YgdGhpcyBzcHJpdGUgdG8gYSBzcGVjaWZpYyBGbHhSZWN0LCBwYXNzIHRoZSBGbHhSZWN0IGhlcmUsIG90aGVyd2lzZSBpdCdzIGZyZWUgdG8gZHJhZyBhbnl3aGVyZQogICAgKiBAcGFyYW0JYm91bmRzU3ByaXRlCQlJZiB5b3Ugd2FudCB0byByZXN0cmljdCB0aGUgZHJhZyBvZiB0aGlzIHNwcml0ZSB0byB3aXRoaW4gdGhlIGJvdW5kaW5nIGJveCBvZiBhbm90aGVyIHNwcml0ZSwgcGFzcyBpdCBoZXJlCiAgICAqLwogICAgZW5hYmxlRHJhZzogZnVuY3Rpb24gKGxvY2tDZW50ZXIsIGJyaW5nVG9Ub3AsIHBpeGVsUGVyZmVjdCwgYWxwaGFUaHJlc2hvbGQsIGJvdW5kc1JlY3QsIGJvdW5kc1Nwcml0ZSkgewoKICAgICAgICBpZiAodHlwZW9mIGxvY2tDZW50ZXIgPT0gJ3VuZGVmaW5lZCcpIHsgbG9ja0NlbnRlciA9IGZhbHNlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBicmluZ1RvVG9wID09ICd1bmRlZmluZWQnKSB7IGJyaW5nVG9Ub3AgPSBmYWxzZTsgfQogICAgICAgIGlmICh0eXBlb2YgcGl4ZWxQZXJmZWN0ID09ICd1bmRlZmluZWQnKSB7IHBpeGVsUGVyZmVjdCA9IGZhbHNlOyB9CgogICAgICAgIGFscGhhVGhyZXNob2xkID0gYWxwaGFUaHJlc2hvbGQgfHwgMjU1OwogICAgICAgIGJvdW5kc1JlY3QgPSBib3VuZHNSZWN0IHx8IG51bGw7CiAgICAgICAgYm91bmRzU3ByaXRlID0gYm91bmRzU3ByaXRlIHx8IG51bGw7CgogICAgICAgIHRoaXMuX2RyYWdQb2ludCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgICAgICB0aGlzLmRyYWdnYWJsZSA9IHRydWU7CiAgICAgICAgdGhpcy5icmluZ1RvVG9wID0gYnJpbmdUb1RvcDsKICAgICAgICB0aGlzLmRyYWdPZmZzZXQgPSBuZXcgUGhhc2VyLlBvaW50KCk7CiAgICAgICAgdGhpcy5kcmFnRnJvbUNlbnRlciA9IGxvY2tDZW50ZXI7CgogICAgICAgIHRoaXMucGl4ZWxQZXJmZWN0ID0gcGl4ZWxQZXJmZWN0OwogICAgICAgIHRoaXMucGl4ZWxQZXJmZWN0QWxwaGEgPSBhbHBoYVRocmVzaG9sZDsKCiAgICAgICAgaWYgKGJvdW5kc1JlY3QpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmJvdW5kc1JlY3QgPSBib3VuZHNSZWN0OwogICAgICAgIH0KCiAgICAgICAgaWYgKGJvdW5kc1Nwcml0ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYm91bmRzU3ByaXRlID0gYm91bmRzU3ByaXRlOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBTdG9wcyB0aGlzIHNwcml0ZSBmcm9tIGJlaW5nIGFibGUgdG8gYmUgZHJhZ2dlZC4gSWYgaXQgaXMgY3VycmVudGx5IHRoZSB0YXJnZXQgb2YgYW4gYWN0aXZlIGRyYWcgaXQgd2lsbCBiZSBzdG9wcGVkIGltbWVkaWF0ZWx5LiBBbHNvIGRpc2FibGVzIGFueSBzZXQgY2FsbGJhY2tzLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZGlzYWJsZURyYWcKICAgICovCiAgICBkaXNhYmxlRHJhZzogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5fcG9pbnRlckRhdGEpCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IDEwOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJEYXRhW2ldLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRyYWdnYWJsZSA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNEcmFnZ2VkID0gZmFsc2U7CiAgICAgICAgdGhpcy5fZHJhZ2dlZFBvaW50ZXJJRCA9IC0xOwoKICAgIH0sCgoJLyoqCiAgICAqIENhbGxlZCBieSBQb2ludGVyIHdoZW4gZHJhZyBzdGFydHMgb24gdGhpcyBTcHJpdGUuIFNob3VsZCBub3QgdXN1YWxseSBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdGFydERyYWcKICAgICovCiAgICBzdGFydERyYWc6IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgICAgIHRoaXMuaXNEcmFnZ2VkID0gdHJ1ZTsKICAgICAgICB0aGlzLl9kcmFnZ2VkUG9pbnRlcklEID0gcG9pbnRlci5pZDsKICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0RyYWdnZWQgPSB0cnVlOwoKICAgICAgICBpZiAodGhpcy5kcmFnRnJvbUNlbnRlcikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmNlbnRlck9uKHBvaW50ZXIueCwgcG9pbnRlci55KTsKICAgICAgICAgICAgdGhpcy5fZHJhZ1BvaW50LnNldFRvKHRoaXMuc3ByaXRlLnggLSBwb2ludGVyLngsIHRoaXMuc3ByaXRlLnkgLSBwb2ludGVyLnkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9kcmFnUG9pbnQuc2V0VG8odGhpcy5zcHJpdGUueCAtIHBvaW50ZXIueCwgdGhpcy5zcHJpdGUueSAtIHBvaW50ZXIueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnVwZGF0ZURyYWcocG9pbnRlcik7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuYnJpbmdUb1RvcCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLmJyaW5nVG9Ub3AoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdGFydC5kaXNwYXRjaCh0aGlzLnNwcml0ZSwgcG9pbnRlcik7CgogICAgfSwKCgkvKioKICAgICogQ2FsbGVkIGJ5IFBvaW50ZXIgd2hlbiBkcmFnIGlzIHN0b3BwZWQgb24gdGhpcyBTcHJpdGUuIFNob3VsZCBub3QgdXN1YWxseSBiZSBjYWxsZWQgZGlyZWN0bHkuCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzdG9wRHJhZwogICAgKi8KICAgIHN0b3BEcmFnOiBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgICAgICB0aGlzLmlzRHJhZ2dlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuX2RyYWdnZWRQb2ludGVySUQgPSAtMTsKICAgICAgICB0aGlzLl9wb2ludGVyRGF0YVtwb2ludGVyLmlkXS5pc0RyYWdnZWQgPSBmYWxzZTsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5zbmFwT25SZWxlYXNlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCA9IE1hdGgucm91bmQodGhpcy5zcHJpdGUueCAvIHRoaXMuc25hcFgpICogdGhpcy5zbmFwWDsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IE1hdGgucm91bmQodGhpcy5zcHJpdGUueSAvIHRoaXMuc25hcFkpICogdGhpcy5zbmFwWTsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3ByaXRlLmV2ZW50cy5vbkRyYWdTdG9wLmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKICAgICAgICB0aGlzLnNwcml0ZS5ldmVudHMub25JbnB1dFVwLmRpc3BhdGNoKHRoaXMuc3ByaXRlLCBwb2ludGVyKTsKCiAgICAgICAgaWYgKHRoaXMuY2hlY2tQb2ludGVyT3Zlcihwb2ludGVyKSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3BvaW50ZXJPdXRIYW5kbGVyKHBvaW50ZXIpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBSZXN0cmljdHMgdGhpcyBzcHJpdGUgdG8gZHJhZyBtb3ZlbWVudCBvbmx5IG9uIHRoZSBnaXZlbiBheGlzLiBOb3RlOiBJZiBib3RoIGFyZSBzZXQgdG8gZmFsc2UgdGhlIHNwcml0ZSB3aWxsIG5ldmVyIG1vdmUhCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNzZXREcmFnTG9jawogICAgKiBAcGFyYW0JYWxsb3dIb3Jpem9udGFsCQlUbyBlbmFibGUgdGhlIHNwcml0ZSB0byBiZSBkcmFnZ2VkIGhvcml6b250YWxseSBzZXQgdG8gdHJ1ZSwgb3RoZXJ3aXNlIGZhbHNlCiAgICAqIEBwYXJhbQlhbGxvd1ZlcnRpY2FsCQlUbyBlbmFibGUgdGhlIHNwcml0ZSB0byBiZSBkcmFnZ2VkIHZlcnRpY2FsbHkgc2V0IHRvIHRydWUsIG90aGVyd2lzZSBmYWxzZQogICAgKi8KICAgIHNldERyYWdMb2NrOiBmdW5jdGlvbiAoYWxsb3dIb3Jpem9udGFsLCBhbGxvd1ZlcnRpY2FsKSB7CgogICAgICAgIGlmICh0eXBlb2YgYWxsb3dIb3Jpem9udGFsID09ICd1bmRlZmluZWQnKSB7IGFsbG93SG9yaXpvbnRhbCA9IHRydWU7IH0KICAgIAlpZiAodHlwZW9mIGFsbG93VmVydGljYWwgPT0gJ3VuZGVmaW5lZCcpIHsgYWxsb3dWZXJ0aWNhbCA9IHRydWU7IH0KCiAgICAgICAgdGhpcy5hbGxvd0hvcml6b250YWxEcmFnID0gYWxsb3dIb3Jpem9udGFsOwogICAgICAgIHRoaXMuYWxsb3dWZXJ0aWNhbERyYWcgPSBhbGxvd1ZlcnRpY2FsOwoKICAgIH0sCgoJLyoqCiAgICAqIE1ha2UgdGhpcyBTcHJpdGUgc25hcCB0byB0aGUgZ2l2ZW4gZ3JpZCBlaXRoZXIgZHVyaW5nIGRyYWcgb3Igd2hlbiBpdCdzIHJlbGVhc2VkLgogICAgKiBGb3IgZXhhbXBsZSAxNngxNiBhcyB0aGUgc25hcFggYW5kIHNuYXBZIHdvdWxkIG1ha2UgdGhlIHNwcml0ZSBzbmFwIHRvIGV2ZXJ5IDE2IHBpeGVscy4KICAgICogQG1ldGhvZCBQaGFzZXIuSW5wdXRIYW5kbGVyI2VuYWJsZVNuYXAKICAgICogQHBhcmFtCXNuYXBYCQlUaGUgd2lkdGggb2YgdGhlIGdyaWQgY2VsbCBpbiBwaXhlbHMKICAgICogQHBhcmFtCXNuYXBZCQlUaGUgaGVpZ2h0IG9mIHRoZSBncmlkIGNlbGwgaW4gcGl4ZWxzCiAgICAqIEBwYXJhbQlvbkRyYWcJCUlmIHRydWUgdGhlIHNwcml0ZSB3aWxsIHNuYXAgdG8gdGhlIGdyaWQgd2hpbGUgYmVpbmcgZHJhZ2dlZAogICAgKiBAcGFyYW0Jb25SZWxlYXNlCUlmIHRydWUgdGhlIHNwcml0ZSB3aWxsIHNuYXAgdG8gdGhlIGdyaWQgd2hlbiByZWxlYXNlZAogICAgKi8KICAgIGVuYWJsZVNuYXA6IGZ1bmN0aW9uIChzbmFwWCwgc25hcFksIG9uRHJhZywgb25SZWxlYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2Ygb25EcmFnID09ICd1bmRlZmluZWQnKSB7IG9uRHJhZyA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIG9uUmVsZWFzZSA9PSAndW5kZWZpbmVkJykgeyBvblJlbGVhc2UgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLnNuYXBYID0gc25hcFg7CiAgICAgICAgdGhpcy5zbmFwWSA9IHNuYXBZOwogICAgICAgIHRoaXMuc25hcE9uRHJhZyA9IG9uRHJhZzsKICAgICAgICB0aGlzLnNuYXBPblJlbGVhc2UgPSBvblJlbGVhc2U7CgogICAgfSwKCgkvKioKICAgICogU3RvcHMgdGhlIHNwcml0ZSBmcm9tIHNuYXBwaW5nIHRvIGEgZ3JpZCBkdXJpbmcgZHJhZyBvciByZWxlYXNlLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjZGlzYWJsZVNuYXAKICAgICovCiAgICBkaXNhYmxlU25hcDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnNuYXBPbkRyYWcgPSBmYWxzZTsKICAgICAgICB0aGlzLnNuYXBPblJlbGVhc2UgPSBmYWxzZTsKCiAgICB9LAoKCS8qKgogICAgKiBCb3VuZHMgUmVjdCBjaGVjayBmb3IgdGhlIHNwcml0ZSBkcmFnCiAgICAqIEBtZXRob2QgUGhhc2VyLklucHV0SGFuZGxlciNjaGVja0JvdW5kc1JlY3QKICAgICovCiAgICBjaGVja0JvdW5kc1JlY3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnggPCB0aGlzLmJvdW5kc1JlY3QubGVmdCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSB0aGlzLmJvdW5kc1JlY3QueDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnggKyB0aGlzLnNwcml0ZS53aWR0aCkgPiB0aGlzLmJvdW5kc1JlY3QucmlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gdGhpcy5ib3VuZHNSZWN0LnJpZ2h0IC0gdGhpcy5zcHJpdGUud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5zcHJpdGUueSA8IHRoaXMuYm91bmRzUmVjdC50b3ApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS55ID0gdGhpcy5ib3VuZHNSZWN0LnRvcDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnkgKyB0aGlzLnNwcml0ZS5oZWlnaHQpID4gdGhpcy5ib3VuZHNSZWN0LmJvdHRvbSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSB0aGlzLmJvdW5kc1JlY3QuYm90dG9tIC0gdGhpcy5zcHJpdGUuaGVpZ2h0OwogICAgICAgIH0KCiAgICB9LAoKCS8qKgogICAgKiBQYXJlbnQgU3ByaXRlIEJvdW5kcyBjaGVjayBmb3IgdGhlIHNwcml0ZSBkcmFnLgogICAgKiBAbWV0aG9kIFBoYXNlci5JbnB1dEhhbmRsZXIjY2hlY2tCb3VuZHNTcHJpdGUKICAgICovCiAgICBjaGVja0JvdW5kc1Nwcml0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5zcHJpdGUueCA8IHRoaXMuYm91bmRzU3ByaXRlLngpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnNwcml0ZS54ID0gdGhpcy5ib3VuZHNTcHJpdGUueDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoKHRoaXMuc3ByaXRlLnggKyB0aGlzLnNwcml0ZS53aWR0aCkgPiAodGhpcy5ib3VuZHNTcHJpdGUueCArIHRoaXMuYm91bmRzU3ByaXRlLndpZHRoKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnggPSAodGhpcy5ib3VuZHNTcHJpdGUueCArIHRoaXMuYm91bmRzU3ByaXRlLndpZHRoKSAtIHRoaXMuc3ByaXRlLndpZHRoOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuc3ByaXRlLnkgPCB0aGlzLmJvdW5kc1Nwcml0ZS55KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueSA9IHRoaXMuYm91bmRzU3ByaXRlLnk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCh0aGlzLnNwcml0ZS55ICsgdGhpcy5zcHJpdGUuaGVpZ2h0KSA+ICh0aGlzLmJvdW5kc1Nwcml0ZS55ICsgdGhpcy5ib3VuZHNTcHJpdGUuaGVpZ2h0KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlLnkgPSAodGhpcy5ib3VuZHNTcHJpdGUueSArIHRoaXMuYm91bmRzU3ByaXRlLmhlaWdodCkgLSB0aGlzLnNwcml0ZS5oZWlnaHQ7CiAgICAgICAgfQoKICAgIH0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCgovKioKKiBUaGUgRXZlbnRzIGNvbXBvbmVudCBpcyBhIGNvbGxlY3Rpb24gb2YgZXZlbnRzIGZpcmVkIGJ5IHRoZSBwYXJlbnQgZ2FtZSBvYmplY3QgYW5kIGl0cyBjb21wb25lbnRzLgoqIAoqIEBjbGFzcyBQaGFzZXIuRXZlbnRzCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIEEgcmVmZXJlbmNlIHRvIERlc2NyaXB0aW9uLgoqLwpQaGFzZXIuRXZlbnRzID0gZnVuY3Rpb24gKHNwcml0ZSkgewoJCgl0aGlzLnBhcmVudCA9IHNwcml0ZTsKCXRoaXMub25BZGRlZFRvR3JvdXAgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCXRoaXMub25SZW1vdmVkRnJvbUdyb3VwID0gbmV3IFBoYXNlci5TaWduYWw7Cgl0aGlzLm9uS2lsbGVkID0gbmV3IFBoYXNlci5TaWduYWw7Cgl0aGlzLm9uUmV2aXZlZCA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJdGhpcy5vbk91dE9mQm91bmRzID0gbmV3IFBoYXNlci5TaWduYWw7CgogICAgdGhpcy5vbklucHV0T3ZlciA9IG51bGw7CiAgICB0aGlzLm9uSW5wdXRPdXQgPSBudWxsOwogICAgdGhpcy5vbklucHV0RG93biA9IG51bGw7CiAgICB0aGlzLm9uSW5wdXRVcCA9IG51bGw7CiAgICB0aGlzLm9uRHJhZ1N0YXJ0ID0gbnVsbDsKICAgIHRoaXMub25EcmFnU3RvcCA9IG51bGw7CgoJdGhpcy5vbkFuaW1hdGlvblN0YXJ0ID0gbnVsbDsKCXRoaXMub25BbmltYXRpb25Db21wbGV0ZSA9IG51bGw7Cgl0aGlzLm9uQW5pbWF0aW9uTG9vcCA9IG51bGw7Cgp9OwoKUGhhc2VyLkV2ZW50cy5wcm90b3R5cGUgPSB7CgoJZGVzdHJveTogZnVuY3Rpb24gKCkgewoKCQl0aGlzLnBhcmVudCA9IG51bGw7CgkJdGhpcy5vbkFkZGVkVG9Hcm91cC5kaXNwb3NlKCk7CgkJdGhpcy5vblJlbW92ZWRGcm9tR3JvdXAuZGlzcG9zZSgpOwoJCXRoaXMub25LaWxsZWQuZGlzcG9zZSgpOwoJCXRoaXMub25SZXZpdmVkLmRpc3Bvc2UoKTsKCQl0aGlzLm9uT3V0T2ZCb3VuZHMuZGlzcG9zZSgpOwoKCQlpZiAodGhpcy5vbklucHV0T3ZlcikKCQl7CgkJICAgIHRoaXMub25JbnB1dE92ZXIuZGlzcG9zZSgpOwoJCSAgICB0aGlzLm9uSW5wdXRPdXQuZGlzcG9zZSgpOwoJCSAgICB0aGlzLm9uSW5wdXREb3duLmRpc3Bvc2UoKTsKCQkgICAgdGhpcy5vbklucHV0VXAuZGlzcG9zZSgpOwoJCSAgICB0aGlzLm9uRHJhZ1N0YXJ0LmRpc3Bvc2UoKTsKCQkgICAgdGhpcy5vbkRyYWdTdG9wLmRpc3Bvc2UoKTsKCQl9CgoJCWlmICh0aGlzLm9uQW5pbWF0aW9uU3RhcnQpCgkJewoJCQl0aGlzLm9uQW5pbWF0aW9uU3RhcnQuZGlzcG9zZSgpOwoJCQl0aGlzLm9uQW5pbWF0aW9uQ29tcGxldGUuZGlzcG9zZSgpOwoJCQl0aGlzLm9uQW5pbWF0aW9uTG9vcC5kaXNwb3NlKCk7CgkJfQoKCX0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBHYW1lIE9iamVjdCBGYWN0b3J5IGlzIGEgcXVpY2sgd2F5IHRvIGNyZWF0ZSBhbGwgb2YgdGhlIGRpZmZlcmVudCBzb3J0cyBvZiBjb3JlIG9iamVjdHMgdGhhdCBQaGFzZXIgdXNlcy4KKgoqIEBjbGFzcyBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSA9IGZ1bmN0aW9uIChnYW1lKSB7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoJCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuV29ybGR9IHdvcmxkIC0gQSByZWZlcmVuY2UgdG8gdGhlIGdhbWUgd29ybGQuCgkqLwoJdGhpcy53b3JsZCA9IHRoaXMuZ2FtZS53b3JsZDsKCn07CgpQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGRzIGFuIGV4aXN0aW5nIG9iamVjdCB0byB0aGUgZ2FtZSB3b3JsZC4KICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjZXhpc3RpbmcKICAgICogQHBhcmFtIHsqfSBvYmplY3QgLSBBbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuQnV0dG9uIG9yIGFueSBvdGhlciBkaXNwbGF5IG9iamVjdC4uCiAgICAqIEByZXR1cm4geyp9IFRoZSBjaGlsZCB0aGF0IHdhcyBhZGRlZCB0byB0aGUgR3JvdXAuCiAgICAqLwogICAgZXhpc3Rpbmc6IGZ1bmN0aW9uIChvYmplY3QpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQuYWRkKG9iamVjdCk7CgogICAgfSwKCgkvKioKICAgICogQ3JlYXRlIGEgbmV3IFNwcml0ZSB3aXRoIHNwZWNpZmljIHBvc2l0aW9uIGFuZCBzcHJpdGUgc2hlZXQga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNzcHJpdGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBzcHJpdGUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbZnJhbWVdIC0gSWYgdGhlIHNwcml0ZSB1c2VzIGFuIGltYWdlIGZyb20gYSB0ZXh0dXJlIGF0bGFzIG9yIHNwcml0ZSBzaGVldCB5b3UgY2FuIHBhc3MgdGhlIGZyYW1lIGhlcmUuIEVpdGhlciBhIG51bWJlciBmb3IgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcmV0dXJucyB7UGhhc2VyLlNwcml0ZX0gdGhlIG5ld2x5IGNyZWF0ZWQgc3ByaXRlIG9iamVjdC4KICAgICovCiAgICBzcHJpdGU6IGZ1bmN0aW9uICh4LCB5LCBrZXksIGZyYW1lKSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmNyZWF0ZSh4LCB5LCBrZXksIGZyYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGUgYSBuZXcgU3ByaXRlIHdpdGggc3BlY2lmaWMgcG9zaXRpb24gYW5kIHNwcml0ZSBzaGVldCBrZXkgdGhhdCB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgYWRkZWQgYXMgYSBjaGlsZCBvZiB0aGUgZ2l2ZW4gcGFyZW50LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNjaGlsZAogICAgKiBAcGFyYW0ge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgR3JvdXAgdG8gYWRkIHRoaXMgY2hpbGQgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IHNwcml0ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgc3ByaXRlLgogICAgKiBAcGFyYW0ge3N0cmluZ3xSZW5kZXJUZXh0dXJlfSBba2V5XSAtIFRoZSBpbWFnZSBrZXkgYXMgZGVmaW5lZCBpbiB0aGUgR2FtZS5DYWNoZSB0byB1c2UgYXMgdGhlIHRleHR1cmUgZm9yIHRoaXMgc3ByaXRlIE9SIGEgUmVuZGVyVGV4dHVyZS4KICAgICogQHBhcmFtICB7c3RyaW5nfG51bWJlcn0gW2ZyYW1lXSAtIElmIHRoZSBzcHJpdGUgdXNlcyBhbiBpbWFnZSBmcm9tIGEgdGV4dHVyZSBhdGxhcyBvciBzcHJpdGUgc2hlZXQgeW91IGNhbiBwYXNzIHRoZSBmcmFtZSBoZXJlLiBFaXRoZXIgYSBudW1iZXIgZm9yIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHJldHVybnMge1BoYXNlci5TcHJpdGV9IHRoZSBuZXdseSBjcmVhdGVkIHNwcml0ZSBvYmplY3QuCiAgICAqLwogICAgY2hpbGQ6IGZ1bmN0aW9uIChncm91cCwgeCwgeSwga2V5LCBmcmFtZSkgewoKICAgICAgICByZXR1cm4gZ3JvdXAuY3JlYXRlKHgsIHksIGtleSwgZnJhbWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZSBhIHR3ZWVuIG9iamVjdCBmb3IgYSBzcGVjaWZpYyBvYmplY3QuIFRoZSBvYmplY3QgY2FuIGJlIGFueSBKYXZhU2NyaXB0IG9iamVjdCBvciBQaGFzZXIgb2JqZWN0IHN1Y2ggYXMgU3ByaXRlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0d2VlbgogICAgKiBAcGFyYW0ge29iamVjdH0gb2JqIC0gT2JqZWN0IHRoZSB0d2VlbiB3aWxsIGJlIHJ1biBvbi4KICAgICogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0d2VlbjogZnVuY3Rpb24gKG9iaikgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnR3ZWVucy5jcmVhdGUob2JqKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIEdyb3VwIGlzIGEgY29udGFpbmVyIGZvciBkaXNwbGF5IG9iamVjdHMgdGhhdCBhbGxvd3MgZm9yIGZhc3QgcG9vbGluZywgcmVjeWNsaW5nIGFuZCBjb2xsaXNpb24gY2hlY2tzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNncm91cAogICAgKiBAcGFyYW0geyp9IHBhcmVudCAtIFRoZSBwYXJlbnQgR3JvdXAgb3IgRGlzcGxheU9iamVjdENvbnRhaW5lciB0aGF0IHdpbGwgaG9sZCB0aGlzIGdyb3VwLCBpZiBhbnkuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbmFtZT1ncm91cF0gLSBBIG5hbWUgZm9yIHRoaXMgR3JvdXAuIE5vdCB1c2VkIGludGVybmFsbHkgYnV0IHVzZWZ1bCBmb3IgZGVidWdnaW5nLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuR3JvdXB9IFRoZSBuZXdseSBjcmVhdGVkIGdyb3VwLgogICAgKi8KICAgIGdyb3VwOiBmdW5jdGlvbiAocGFyZW50LCBuYW1lKSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLkdyb3VwKHRoaXMuZ2FtZSwgcGFyZW50LCBuYW1lKTsKCiAgICB9LAoKICAgIC8qKgogICAgICogQ3JlYXRlcyBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgU291bmQgY2xhc3MuCiAgICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNhdWRpbwogICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBHYW1lLmNhY2hlIGtleSBvZiB0aGUgc291bmQgdGhhdCB0aGlzIG9iamVjdCB3aWxsIHVzZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB2b2x1bWUgLSBUaGUgdm9sdW1lIGF0IHdoaWNoIHRoZSBzb3VuZCB3aWxsIGJlIHBsYXllZC4KICAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gbG9vcCAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAgKiBAcmV0dXJuIHtQaGFzZXIuU291bmR9IFRoZSBuZXdseSBjcmVhdGVkIHRleHQgb2JqZWN0LgogICAgICovCiAgICBhdWRpbzogZnVuY3Rpb24gKGtleSwgdm9sdW1lLCBsb29wKSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUuc291bmQuYWRkKGtleSwgdm9sdW1lLCBsb29wKTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAgKiBDcmVhdGVzIGEgbmV3IDxjb2RlPlRpbGVTcHJpdGU8L2NvZGU+LgogICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjdGlsZVNwcml0ZQogICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGlsZVNwcml0ZS4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVTcHJpdGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggb2YgdGhlIHRpbGVzcHJpdGUuCiAgICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodCBvZiB0aGUgdGlsZXNwcml0ZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gZnJhbWUgLSBJZiB0aGlzIFNwcml0ZSBpcyB1c2luZyBwYXJ0IG9mIGEgc3ByaXRlIHNoZWV0IG9yIHRleHR1cmUgYXRsYXMgeW91IGNhbiBzcGVjaWZ5IHRoZSBleGFjdCBmcmFtZSB0byB1c2UgYnkgZ2l2aW5nIGEgc3RyaW5nIG9yIG51bWVyaWMgaW5kZXguCiAgICAgKiBAcmV0dXJuIHtQaGFzZXIuVGlsZVNwcml0ZX0gVGhlIG5ld2x5IGNyZWF0ZWQgdGlsZVNwcml0ZSBvYmplY3QuCiAgICAgKi8KICAgIHRpbGVTcHJpdGU6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0LCBrZXksIGZyYW1lKSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChuZXcgUGhhc2VyLlRpbGVTcHJpdGUodGhpcy5nYW1lLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBrZXksIGZyYW1lKSk7CgogICAgfSwKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgPGNvZGU+VGV4dDwvY29kZT4uCiAgICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0ZXh0CiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0ZXh0IG9iamVjdC4KICAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRleHQgb2JqZWN0LgogICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgYWN0dWFsIHRleHQgdGhhdCB3aWxsIGJlIHdyaXR0ZW4uCiAgICAgKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsIGV0Yy4KICAgICAqIEByZXR1cm4ge1BoYXNlci5UZXh0fSBUaGUgbmV3bHkgY3JlYXRlZCB0ZXh0IG9iamVjdC4KICAgICAqLwogICAgdGV4dDogZnVuY3Rpb24gKHgsIHksIHRleHQsIHN0eWxlKSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChuZXcgUGhhc2VyLlRleHQodGhpcy5nYW1lLCB4LCB5LCB0ZXh0LCBzdHlsZSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgPGNvZGU+QnV0dG9uPC9jb2RlPiBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2J1dHRvbgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIFggcG9zaXRpb24gb2YgdGhlIG5ldyBidXR0b24gb2JqZWN0LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBidXR0b24gb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2tleV0gVGhlIGltYWdlIGtleSBhcyBkZWZpbmVkIGluIHRoZSBHYW1lLkNhY2hlIHRvIHVzZSBhcyB0aGUgdGV4dHVyZSBmb3IgdGhpcyBidXR0b24uCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGlzIGJ1dHRvbiBpcyBwcmVzc2VkCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBbY2FsbGJhY2tDb250ZXh0XSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKQogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdmVyRnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3ZlciBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KICAgICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3V0RnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3V0IHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtkb3duRnJhbWVdIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYSBkb3duIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQnV0dG9ufSBUaGUgbmV3bHkgY3JlYXRlZCBidXR0b24gb2JqZWN0LgogICAgKi8KICAgIGJ1dHRvbjogZnVuY3Rpb24gKHgsIHksIGtleSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lKSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChuZXcgUGhhc2VyLkJ1dHRvbih0aGlzLmdhbWUsIHgsIHksIGtleSwgY2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCwgb3ZlckZyYW1lLCBvdXRGcmFtZSwgZG93bkZyYW1lKSk7CgogICAgfSwKCiAgICAvKioKICAgICAqIENyZWF0ZXMgYSBuZXcgPGNvZGU+R3JhcGhpY3M8L2NvZGU+IG9iamVjdC4KICAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2dyYXBoaWNzCiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiAgICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIG5ldyBncmFwaGljcyBvYmplY3QuCiAgICAgKiBAcmV0dXJuIHtQaGFzZXIuR3JhcGhpY3N9IFRoZSBuZXdseSBjcmVhdGVkIGdyYXBoaWNzIG9iamVjdC4KICAgICAqLwogICAgZ3JhcGhpY3M6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHJldHVybiB0aGlzLndvcmxkLmFkZChuZXcgUGhhc2VyLkdyYXBoaWNzKHRoaXMuZ2FtZSwgeCwgeSkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEVtaXR0ZXIgaXMgYSBsaWdodHdlaWdodCBwYXJ0aWNsZSBlbWl0dGVyLiBJdCBjYW4gYmUgdXNlZCBmb3Igb25lLXRpbWUgZXhwbG9zaW9ucyBvciBmb3IKICAgICogY29udGludW91cyBlZmZlY3RzIGxpa2UgcmFpbiBhbmQgZmlyZS4gQWxsIGl0IHJlYWxseSBkb2VzIGlzIGxhdW5jaCBQYXJ0aWNsZSBvYmplY3RzIG91dAogICAgKiBhdCBzZXQgaW50ZXJ2YWxzLCBhbmQgZml4ZXMgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yaW5kZ2x5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNlbWl0dGVyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeD0wXSAtIFRoZSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBFbWl0dGVyIHRoYXQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3k9MF0gLSBUaGUgeSBjb29yZGluYXRlIHdpdGhpbiB0aGUgRW1pdHRlciB0aGF0IHRoZSBwYXJ0aWNsZXMgYXJlIGVtaXR0ZWQgZnJvbS4KICAgICogQHBhcmFtIHtudW1iZXJ9IFttYXhQYXJ0aWNsZXM9NTBdIC0gVGhlIHRvdGFsIG51bWJlciBvZiBwYXJ0aWNsZXMgaW4gdGhpcyBlbWl0dGVyLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRW1pdHRlcn0gVGhlIG5ld2x5IGNyZWF0ZWQgZW1pdHRlciBvYmplY3QuCiAgICAqLwogICAgZW1pdHRlcjogZnVuY3Rpb24gKHgsIHksIG1heFBhcnRpY2xlcykgewoKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLnBhcnRpY2xlcy5hZGQobmV3IFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIodGhpcy5nYW1lLCB4LCB5LCBtYXhQYXJ0aWNsZXMpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiAqIENyZWF0ZSBhIG5ldyA8Y29kZT5CaXRtYXBUZXh0PC9jb2RlPi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuR2FtZU9iamVjdEZhY3RvcnkjYml0bWFwVGV4dAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyBiaXRtYXBUZXh0IG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgYml0bWFwVGV4dCBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgogICAgKiBAcGFyYW0ge29iamVjdH0gc3R5bGUgLSBUaGUgc3R5bGUgb2JqZWN0IGNvbnRhaW5pbmcgc3R5bGUgYXR0cmlidXRlcyBsaWtlIGZvbnQsIGZvbnQgc2l6ZSAsIGV0Yy4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcFRleHR9IFRoZSBuZXdseSBjcmVhdGVkIGJpdG1hcFRleHQgb2JqZWN0LgogICAgKi8KICAgIGJpdG1hcFRleHQ6IGZ1bmN0aW9uICh4LCB5LCB0ZXh0LCBzdHlsZSkgewoKICAgICAgICByZXR1cm4gdGhpcy53b3JsZC5hZGQobmV3IFBoYXNlci5CaXRtYXBUZXh0KHRoaXMuZ2FtZSwgeCwgeSwgdGV4dCwgc3R5bGUpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDcmVhdGVzIGEgbmV3IFRpbGVtYXAgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSN0aWxlbWFwCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBKU09OIGZpbGUuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlbWFwfSBUaGUgbmV3bHkgY3JlYXRlZCB0aWxlbWFwIG9iamVjdC4KICAgICovCiAgICB0aWxlbWFwOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlRpbGVtYXAodGhpcy5nYW1lLCBrZXkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgVGlsZXNldCBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3RpbGVzZXQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSBpbWFnZSBrZXkgYXMgZGVmaW5lZCBpbiB0aGUgR2FtZS5DYWNoZSB0byB1c2UgYXMgdGhlIHRpbGVzZXQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlc2V0fSBUaGUgbmV3bHkgY3JlYXRlZCB0aWxlc2V0IG9iamVjdC4KICAgICovCiAgICB0aWxlc2V0OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHJldHVybiB0aGlzLmdhbWUuY2FjaGUuZ2V0VGlsZXNldChrZXkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBuZXcgVGlsZW1hcCBMYXllciBvYmplY3QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I3RpbGVtYXBMYXllcgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlbWFwTGF5ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVtYXBMYXllci4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSB0aWxlbWFwTGF5ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSB0aWxlbWFwTGF5ZXIuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlbWFwTGF5ZXJ9IFRoZSBuZXdseSBjcmVhdGVkIHRpbGVtYXBsYXllciBvYmplY3QuCiAgICAqLwogICAgdGlsZW1hcExheWVyOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgdGlsZXNldCwgdGlsZW1hcCwgbGF5ZXIpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMud29ybGQuYWRkKG5ldyBQaGFzZXIuVGlsZW1hcExheWVyKHRoaXMuZ2FtZSwgeCwgeSwgd2lkdGgsIGhlaWdodCwgdGlsZXNldCwgdGlsZW1hcCwgbGF5ZXIpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIGR5bmFtaWMgaW5pdGlhbGx5IGJsYW5rIGNhbnZhcyB0byB3aGljaCBpbWFnZXMgY2FuIGJlIGRyYXduLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5HYW1lT2JqZWN0RmFjdG9yeSNyZW5kZXJUZXh0dXJlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIHRoZSBoZWlnaHQgb2YgdGhlIHJlbmRlciB0ZXh0dXJlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVuZGVyVGV4dHVyZX0gVGhlIG5ld2x5IGNyZWF0ZWQgcmVuZGVyVGV4dHVyZSBvYmplY3QuCiAgICAqLwogICAgcmVuZGVyVGV4dHVyZTogZnVuY3Rpb24gKGtleSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB2YXIgdGV4dHVyZSA9IG5ldyBQaGFzZXIuUmVuZGVyVGV4dHVyZSh0aGlzLmdhbWUsIGtleSwgd2lkdGgsIGhlaWdodCk7CgogICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5hZGRSZW5kZXJUZXh0dXJlKGtleSwgdGV4dHVyZSk7CgogICAgICAgIHJldHVybiB0ZXh0dXJlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgQml0bWFwRGF0YSBvYmplY3Qgd2hpY2ggY2FuIGJlIG1hbmlwdWxhdGVkIGFuZCBkcmF3biB0byBsaWtlIGEgdHJhZGl0aW9uYWwgQ2FudmFzIG9iamVjdCBhbmQgdXNlZCB0byB0ZXh0dXJlIFNwcml0ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2JpdG1hcERhdGEKICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0yNTZdIC0gVGhlIHdpZHRoIG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHQ9MjU2XSAtIFRoZSBoZWlnaHQgb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIG5ld2x5IGNyZWF0ZWQgQml0bWFwRGF0YSBvYmplY3QuCiAgICAqLwogICAgYml0bWFwRGF0YTogZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgcmV0dXJuIG5ldyBQaGFzZXIuQml0bWFwRGF0YSh0aGlzLmdhbWUsIHdpZHRoLCBoZWlnaHQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEEgV2ViR0wgc2hhZGVyL2ZpbHRlciB0aGF0IGNhbiBiZSBhcHBsaWVkIHRvIFNwcml0ZXMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkdhbWVPYmplY3RGYWN0b3J5I2ZpbHRlcgogICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsdGVyIC0gVGhlIG5hbWUgb2YgdGhlIGZpbHRlciB5b3Ugd2lzaCB0byBjcmVhdGUsIGZvciBleGFtcGxlICJIdWVSb3RhdGUiIG9yICJTaW5lV2F2ZSIKICAgICogQHBhcmFtIHsuLi59IC0gV2hhdGV2ZXIgcGFyYW1ldGVycyBhcmUgbmVlZGVkIHRvIGJlIHBhc3NlZCB0byB0aGUgZmlsdGVyIGluaXQgZnVuY3Rpb24uCiAgICAqIEByZXR1cm4ge1BoYXNlci5GaWx0ZXJ9IFRoZSBuZXdseSBjcmVhdGVkIFBoYXNlci5GaWx0ZXIgb2JqZWN0LgogICAgKi8KICAgIGZpbHRlcjogZnVuY3Rpb24gKGZpbHRlcikgewoKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zcGxpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoKICAgICAgICB2YXIgZiA9IG5ldyBQaGFzZXIuRmlsdGVyW2ZpbHRlcl0odGhpcy5nYW1lKTsKCiAgICAgICAgZi5pbml0LmFwcGx5KGYsIGFyZ3MpOwoKICAgICAgICByZXR1cm4gZjsKCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IGBCaXRtYXBEYXRhYCBvYmplY3QuCioKKiBAY2xhc3MgUGhhc2VyLkJpdG1hcERhdGEKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aD0yNTZdIC0gVGhlIHdpZHRoIG9mIHRoZSBCaXRtYXBEYXRhIGluIHBpeGVscy4KKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodD0yNTZdIC0gVGhlIGhlaWdodCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiovClBoYXNlci5CaXRtYXBEYXRhID0gZnVuY3Rpb24gKGdhbWUsIHdpZHRoLCBoZWlnaHQpIHsKCglpZiAodHlwZW9mIHdpZHRoID09PSAndW5kZWZpbmVkJykgeyB3aWR0aCA9IDI1NjsgfQoJaWYgKHR5cGVvZiBoZWlnaHQgPT09ICd1bmRlZmluZWQnKSB7IGhlaWdodCA9IDI1NjsgfQoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuIAoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIEJpdG1hcERhdGEuCgkqLwogICAgdGhpcy5uYW1lID0gJyc7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgQml0bWFwRGF0YSBpbiBwaXhlbHMuCiAgICAqLwoJdGhpcy53aWR0aCA9IHdpZHRoOwoJCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIEJpdG1hcERhdGEgaW4gcGl4ZWxzLgogICAgKi8KCXRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKCS8qKgoJKiBAcHJvcGVydHkge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHdoaWNoIHRoaXMgQml0bWFwRGF0YSBkcmF3cy4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNhbnZhcyA9IFBoYXNlci5DYW52YXMuY3JlYXRlKHdpZHRoLCBoZWlnaHQpOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBUaGUgMmQgY29udGV4dCBvZiB0aGUgY2FudmFzLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7YXJyYXl9IGltYWdlRGF0YSAtIFRoZSBjYW52YXMgaW1hZ2UgZGF0YS4KCSovCgl0aGlzLmltYWdlRGF0YSA9IHRoaXMuY29udGV4dC5nZXRJbWFnZURhdGEoMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7VUludDhDbGFtcGVkfSBwaXhlbHMgLSBBIHJlZmVyZW5jZSB0byB0aGUgY29udGV4dCBpbWFnZURhdGEgYnVmZmVyLgoJKi8KCWlmICh0aGlzLmltYWdlRGF0YS5kYXRhLmJ1ZmZlcikKCXsKCQl0aGlzLnBpeGVscyA9IHRoaXMuaW1hZ2VEYXRhLmRhdGEuYnVmZmVyOwoJfQoJZWxzZQoJewoJCXRoaXMucGl4ZWxzID0gdGhpcy5pbWFnZURhdGEuZGF0YTsKCX0KCgkvKioKCSogQHByb3BlcnR5IHtQSVhJLkJhc2VUZXh0dXJlfSBiYXNlVGV4dHVyZSAtIFRoZSBQSVhJLkJhc2VUZXh0dXJlLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSh0aGlzLmNhbnZhcyk7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge1BJWEkuVGV4dHVyZX0gdGV4dHVyZSAtIFRoZSBQSVhJLlRleHR1cmUuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50ZXh0dXJlID0gbmV3IFBJWEkuVGV4dHVyZSh0aGlzLmJhc2VUZXh0dXJlKTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lfSB0ZXh0dXJlRnJhbWUgLSBUaGUgRnJhbWUgdGhpcyBCaXRtYXBEYXRhIHVzZXMgZm9yIHJlbmRlcmluZy4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnRleHR1cmVGcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgd2lkdGgsIGhlaWdodCwgJ2JpdG1hcERhdGEnLCBnYW1lLnJuZC51dWlkKCkpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5CSVRNQVBEQVRBOwoKCXRoaXMuX2RpcnR5ID0gZmFsc2U7Cgp9CgpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIFVwZGF0ZXMgdGhlIGdpdmVuIFNwcml0ZSBzbyB0aGF0IGl0IHVzZXMgdGhpcyBCaXRtYXBEYXRhIGFzIGl0cyB0ZXh0dXJlLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmFkZAoJKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYXBwbHkgdGhpcyB0ZXh0dXJlIHRvLgoJKi8KCWFkZDogZnVuY3Rpb24gKHNwcml0ZSkgewoKCQlzcHJpdGUubG9hZFRleHR1cmUodGhpcyk7CgoJfSwKCgkvKioKCSogR2l2ZW4gYW4gYXJyYXkgb2YgU3ByaXRlcyBpdCB3aWxsIHVwZGF0ZSBlYWNoIG9mIHRoZW0gc28gdGhhdCB0aGVpciBUZXh0dXJlcyByZWZlcmVuY2UgdGhpcyBCaXRtYXBEYXRhLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmFkZFRvCgkqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZVtdfSBzcHJpdGVzIC0gQW4gYXJyYXkgb2YgU3ByaXRlcyB0byBhcHBseSB0aGlzIHRleHR1cmUgdG8uCgkqLwoJYWRkVG86IGZ1bmN0aW9uIChzcHJpdGVzKSB7CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykKCQl7CgkJICAgIGlmIChvYmplY3RzW2ldLnRleHR1cmUpCgkJICAgIHsKCQkgICAgfQoJCX0KCgl9LAoKCS8qKgoJKiBDbGVhcnMgdGhlIEJpdG1hcERhdGEuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuY2xlYXIKCSovCgljbGVhcjogZnVuY3Rpb24gKCkgewoKCSAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCQoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCgl9LAoKCXJlZnJlc2hCdWZmZXI6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5pbWFnZURhdGEgPSB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCQl0aGlzLnBpeGVscyA9IG5ldyBJbnQzMkFycmF5KHRoaXMuaW1hZ2VEYXRhLmRhdGEuYnVmZmVyKTsKCgkJLy8gdGhpcy5kYXRhOCA9IG5ldyBVaW50OENsYW1wZWRBcnJheSh0aGlzLmltYWdlRGF0YS5idWZmZXIpOwoJCS8vIHRoaXMuZGF0YTMyID0gbmV3IFVpbnQzMkFycmF5KHRoaXMuaW1hZ2VEYXRhLmJ1ZmZlcik7CgoJfSwKCgkvKioKCSogU2V0cyB0aGUgY29sb3Igb2YgdGhlIGdpdmVuIHBpeGVsIHRvIHRoZSBzcGVjaWZpZWQgcmVkLCBncmVlbiwgYmx1ZSBhbmQgYWxwaGEgdmFsdWVzLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnNldFBpeGVsMzIKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gYmUgc2V0LgoJKiBAcGFyYW0ge251bWJlcn0gcmVkIC0gVGhlIHJlZCBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgoJKiBAcGFyYW0ge251bWJlcn0gZ3JlZW4gLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KCSogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgoJKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KCSovCiAgICBzZXRQaXhlbDMyOiBmdW5jdGlvbiAoeCwgeSwgcmVkLCBncmVlbiwgYmx1ZSwgYWxwaGEpIHsKCiAgICAJaWYgKHggPj0gMCAmJiB4IDw9IHRoaXMud2lkdGggJiYgeSA+PSAwICYmIHkgPD0gdGhpcy5oZWlnaHQpCiAgICAJewoJCQl0aGlzLnBpeGVsc1t5ICogdGhpcy53aWR0aCArIHhdID0gKGFscGhhIDw8IDI0KSB8IChibHVlIDw8IDE2KSB8IChncmVlbiA8PCA4KSB8IHJlZDsKCiAgICAJCS8qCiAgICAJCWlmICh0aGlzLmlzTGl0dGxlRW5kaWFuKQogICAgCQl7CgkJCQl0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdID0gKGFscGhhIDw8IDI0KSB8IChibHVlIDw8IDE2KSB8IChncmVlbiA8PCA4KSB8IHJlZDsKICAgIAkJfQogICAgCQllbHNlCiAgICAJCXsKCQkJCXRoaXMuZGF0YTMyW3kgKiB0aGlzLndpZHRoICsgeF0gPSAocmVkIDw8IDI0KSB8IChncmVlbiA8PCAxNikgfCAoYmx1ZSA8PCA4KSB8IGFscGhhOwogICAgCQl9CiAgICAJCSovCgogICAgCQkvLyB0aGlzLmltYWdlRGF0YS5kYXRhLnNldCh0aGlzLmRhdGE4KTsKCiAgICAJCXRoaXMuY29udGV4dC5wdXRJbWFnZURhdGEodGhpcy5pbWFnZURhdGEsIDAsIDApOwoKCQkJdGhpcy5fZGlydHkgPSB0cnVlOwogICAgCX0KCiAgICB9LAoKCS8qKgoJKiBTZXRzIHRoZSBjb2xvciBvZiB0aGUgZ2l2ZW4gcGl4ZWwgdG8gdGhlIHNwZWNpZmllZCByZWQsIGdyZWVuIGFuZCBibHVlIHZhbHVlcy4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zZXRQaXhlbAoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGJlIHNldC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBiZSBzZXQuCgkqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgcmVkIGNvbG9yIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkKCSogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIGdyZWVuIGNvbG9yIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkKCSogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpCgkqLwogICAgc2V0UGl4ZWw6IGZ1bmN0aW9uICh4LCB5LCByZWQsIGdyZWVuLCBibHVlKSB7CgogICAgCXRoaXMuc2V0UGl4ZWwzMih4LCB5LCByZWQsIGdyZWVuLCBibHVlLCAyNTUpOwoKICAgIH0sCgoJLyoqCgkqIEdldCBhIGNvbG9yIG9mIGEgc3BlY2lmaWMgcGl4ZWwuCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggY29vcmRpbmF0ZSBvZiB0aGUgcGl4ZWwgdG8gZ2V0LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGdldC4KCSogQHJldHVybiB7bnVtYmVyfSBBIG5hdGl2ZSBjb2xvciB2YWx1ZSBpbnRlZ2VyIChmb3JtYXQ6IDB4UlJHR0JCKQoJKi8KICAgIGdldFBpeGVsOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgIAlpZiAoeCA+PSAwICYmIHggPD0gdGhpcy53aWR0aCAmJiB5ID49IDAgJiYgeSA8PSB0aGlzLmhlaWdodCkKICAgIAl7CgkJCXJldHVybiB0aGlzLmRhdGEzMlt5ICogdGhpcy53aWR0aCArIHhdOwogICAgCX0KCiAgICB9LAoKCS8qKgoJKiBHZXQgYSBjb2xvciBvZiBhIHNwZWNpZmljIHBpeGVsIChpbmNsdWRpbmcgYWxwaGEgdmFsdWUpLgoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSBYIGNvb3JkaW5hdGUgb2YgdGhlIHBpeGVsIHRvIGdldC4KCSogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgWSBjb29yZGluYXRlIG9mIHRoZSBwaXhlbCB0byBnZXQuCgkqIEByZXR1cm4ge251bWJlcn0gQSBuYXRpdmUgY29sb3IgdmFsdWUgaW50ZWdlciAoZm9ybWF0OiAweEFBUlJHR0JCKQoJKi8KICAgIGdldFBpeGVsMzI6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgCWlmICh4ID49IDAgJiYgeCA8PSB0aGlzLndpZHRoICYmIHkgPj0gMCAmJiB5IDw9IHRoaXMuaGVpZ2h0KQogICAgCXsKCQkJcmV0dXJuIHRoaXMuZGF0YTMyW3kgKiB0aGlzLndpZHRoICsgeF07CiAgICAJfQoKICAgIH0sCgogICAgLyoqCiAgICAgKiBHZXQgcGl4ZWxzIGluIGFycmF5IGluIGEgc3BlY2lmaWMgUmVjdGFuZ2xlLgogICAgICogQHBhcmFtIHJlY3Qge1JlY3RhbmdsZX0gVGhlIHNwZWNpZmljIFJlY3RhbmdsZS4KICAgICAqIEByZXR1cm4ge2FycmF5fSBDYW52YXNQaXhlbEFycmF5LgogICAgICovCiAgICBnZXRQaXhlbHM6IGZ1bmN0aW9uIChyZWN0KSB7CgogICAgICAgIC8vIHJldHVybiB0aGlzLmNvbnRleHQuZ2V0SW1hZ2VEYXRhKHJlY3QueCwgcmVjdC55LCByZWN0LndpZHRoLCByZWN0LmhlaWdodCk7CgogICAgfSwKCgkvKioKCSogQWRkcyBhbiBhcmMgdG8gdGhlIHBhdGggd2hpY2ggaXMgY2VudGVyZWQgYXQgKHgsIHkpIHBvc2l0aW9uIHdpdGggcmFkaXVzIHIgc3RhcnRpbmcgYXQgc3RhcnRBbmdsZSBhbmQgZW5kaW5nIGF0IGVuZEFuZ2xlIAoJKiBnb2luZyBpbiB0aGUgZ2l2ZW4gZGlyZWN0aW9uIGJ5IGFudGljbG9ja3dpc2UgKGRlZmF1bHRpbmcgdG8gY2xvY2t3aXNlKS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5hcmMKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgYXJjJ3MgY2VudGVyCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIGFyYydzIGNlbnRlcgoJKiBAcGFyYW0ge251bWJlcn0gcmFkaXVzIC0gVGhlIGFyYydzIHJhZGl1cwoJKiBAcGFyYW0ge251bWJlcn0gc3RhcnRBbmdsZSAtIFRoZSBzdGFydGluZyBwb2ludCwgbWVhc3VyZWQgZnJvbSB0aGUgeCBheGlzLCBmcm9tIHdoaWNoIGl0IHdpbGwgYmUgZHJhd24sIGV4cHJlc3NlZCBpbiByYWRpYW5zLgoJKiBAcGFyYW0ge251bWJlcn0gZW5kQW5nbGUgLSBUaGUgZW5kIGFyYydzIGFuZ2xlIHRvIHdoaWNoIGl0IHdpbGwgYmUgZHJhd24sIGV4cHJlc3NlZCBpbiByYWRpYW5zLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFthbnRpY2xvY2t3aXNlPXRydWVdIC0gdHJ1ZSBkcmF3cyB0aGUgYXJjIGFudGljbG9ja3dpc2UsIG90aGVyd2lzZSBpbiBhIGNsb2Nrd2lzZSBkaXJlY3Rpb24uCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWFyYzogZnVuY3Rpb24gKHgsIHksIHJhZGl1cywgc3RhcnRBbmdsZSwgZW5kQW5nbGUsIGFudGljbG9ja3dpc2UpIHsKCgkJaWYgKHR5cGVvZiBhbnRpY2xvY2t3aXNlID09PSAndW5kZWZpbmVkJykgeyBhbnRpY2xvY2t3aXNlID0gZmFsc2U7IH0KCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5hcmMoeCwgeSwgcmFkaXVzLCBzdGFydEFuZ2xlLCBlbmRBbmdsZSwgYW50aWNsb2Nrd2lzZSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkcyBhbiBhcmMgd2l0aCB0aGUgZ2l2ZW4gY29udHJvbCBwb2ludHMgYW5kIHJhZGl1cywgY29ubmVjdGVkIHRvIHRoZSBwcmV2aW91cyBwb2ludCBieSBhIHN0cmFpZ2h0IGxpbmUuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuYXJjVG8KCSogQHBhcmFtIHtudW1iZXJ9IHgxCgkqIEBwYXJhbSB7bnVtYmVyfSB5MQoJKiBAcGFyYW0ge251bWJlcn0geDIKCSogQHBhcmFtIHtudW1iZXJ9IHkyCgkqIEBwYXJhbSB7bnVtYmVyfSByYWRpdXMKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYXJjVG86IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MiwgcmFkaXVzKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuYXJjVG8oeDEsIHkxLCB4MiwgeTIsIHJhZGl1cyk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQmVnaW5zIGEgZmlsbCB3aXRoIHRoZSBzcGVjaWZpZWQgY29sb3IuIFRoaXMgZW5kcyB0aGUgY3VycmVudCBzdWItcGF0aC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZWdpbkZpbGwKCSogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gQSBDU1MgY29tcGF0aWJsZSBjb2xvciB2YWx1ZSAoZXguICJyZWQiLCAiI0ZGMDAwMCIsIG9yICJyZ2JhKDI1NSwwLDAsMC41KSIpLiBTZXR0aW5nIHRvIG51bGwgd2lsbCByZXN1bHQgaW4gbm8gZmlsbC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5GaWxsOiBmdW5jdGlvbiAoY29sb3IpIHsKCgkJdGhpcy5maWxsU3R5bGUoY29sb3IpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBCZWdpbnMgYSBsaW5lYXIgZ3JhZGllbnQgZmlsbCBkZWZpbmVkIGJ5IHRoZSBsaW5lICh4MCwgeTApIHRvICh4MSwgeTEpLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvcgoJKiBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIGJsYWNrIHRvIHdoaXRlIHZlcnRpY2FsIGdyYWRpZW50IHJhbmdpbmcgZnJvbSAyMHB4IHRvIDEyMHB4LCBhbmQgZHJhd3MgYSBzcXVhcmUgdG8gZGlzcGxheSBpdDoKCSoKCSogICAgICBgYGBteUdyYXBoaWNzLmJlZ2luTGluZWFyR3JhZGllbnRGaWxsKFsiIzAwMCIsIiNGRkYiXSwgWzAsIDFdLCAwLCAyMCwgMCwgMTIwKS5yZWN0KDIwLCAyMCwgMTIwLCAxMjApO2BgYAoJKgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmJlZ2luTGluZWFyR3JhZGllbnRGaWxsCgkqIEBwYXJhbSB7QXJyYXl9IGNvbG9ycyAtIEFuIGFycmF5IG9mIENTUyBjb21wYXRpYmxlIGNvbG9yIHZhbHVlcy4gRm9yIGV4YW1wbGUsIFsiI0YwMCIsIiMwMEYiXSB3b3VsZCBkZWZpbmUgYSBncmFkaWVudCBkcmF3aW5nIGZyb20gcmVkIHRvIGJsdWUuCgkqIEBwYXJhbSB7QXJyYXl9IHJhdGlvcyAtIEFuIGFycmF5IG9mIGdyYWRpZW50IHBvc2l0aW9ucyB3aGljaCBjb3JyZXNwb25kIHRvIHRoZSBjb2xvcnMuIEZvciBleGFtcGxlLCBbMC4xLCAwLjldIHdvdWxkIGRyYXcgdGhlIGZpcnN0IGNvbG9yIHRvIDEwJSB0aGVuIGludGVycG9sYXRpbmcgdG8gdGhlIHNlY29uZCBjb2xvciBhdCA5MCUuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEBwYXJhbSB7bnVtYmVyfSB5MCAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgZmlyc3QgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEBwYXJhbSB7bnVtYmVyfSB4MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgoJKiBAcGFyYW0ge251bWJlcn0geTEgLSBUaGUgcG9zaXRpb24gb2YgdGhlIHNlY29uZCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5MaW5lYXJHcmFkaWVudEZpbGw6IGZ1bmN0aW9uIChjb2xvcnMsIHJhdGlvcywgeDAsIHkwLCB4MSwgeTEpIHsKCgkJdmFyIGdyYWRpZW50ID0gdGhpcy5jcmVhdGVMaW5lYXJHcmFkaWVudCh4MCwgeTAsIHgxLCB5MSk7CgoJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2xvcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCgkJewoJCQlncmFkaWVudC5hZGRDb2xvclN0b3AocmF0aW9zW2ldLCBjb2xvcnNbaV0pOwoJCX0KCgkJdGhpcy5maWxsU3R5bGUoZ3JhZGllbnQpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBCZWdpbnMgYSBsaW5lYXIgZ3JhZGllbnQgc3Ryb2tlIGRlZmluZWQgYnkgdGhlIGxpbmUgKHgwLCB5MCkgdG8gKHgxLCB5MSkuIFRoaXMgZW5kcyB0aGUgY3VycmVudCBzdWItcGF0aC4gRm9yCgkqIGV4YW1wbGUsIHRoZSBmb2xsb3dpbmcgY29kZSBkZWZpbmVzIGEgYmxhY2sgdG8gd2hpdGUgdmVydGljYWwgZ3JhZGllbnQgcmFuZ2luZyBmcm9tIDIwcHggdG8gMTIwcHgsIGFuZCBkcmF3cyBhCgkqIHNxdWFyZSB0byBkaXNwbGF5IGl0OgoJKgoJKiAgICAgIGBgYG15R3JhcGhpY3Muc2V0U3Ryb2tlU3R5bGUoMTApLmJlZ2luTGluZWFyR3JhZGllbnRTdHJva2UoWyIjMDAwIiwiI0ZGRiJdLCBbMCwgMV0sIDAsIDIwLCAwLCAxMjApLmRyYXdSZWN0KDIwLCAyMCwgMTIwLCAxMjApO2BgYAoJKgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmJlZ2luTGluZWFyR3JhZGllbnRTdHJva2UKCSogQHBhcmFtIHtBcnJheX0gY29sb3JzIC0gQW4gYXJyYXkgb2YgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWVzLiBGb3IgZXhhbXBsZSwgWyIjRjAwIiwiIzAwRiJdIHdvdWxkIGRlZmluZSBhIGdyYWRpZW50IGRyYXdpbmcgZnJvbSByZWQgdG8gYmx1ZS4KCSogQHBhcmFtIHtBcnJheX0gcmF0aW9zIC0gQW4gYXJyYXkgb2YgZ3JhZGllbnQgcG9zaXRpb25zIHdoaWNoIGNvcnJlc3BvbmQgdG8gdGhlIGNvbG9ycy4gRm9yIGV4YW1wbGUsIFswLjEsIDAuOV0gd291bGQgZHJhdyB0aGUgZmlyc3QgY29sb3IgdG8gMTAlIHRoZW4gaW50ZXJwb2xhdGluZyB0byB0aGUgc2Vjb25kIGNvbG9yIGF0IDkwJS4KCSogQHBhcmFtIHtudW1iZXJ9IHgwIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KCSogQHBhcmFtIHtudW1iZXJ9IHkwIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBwb2ludCBkZWZpbmluZyB0aGUgbGluZSB0aGF0IGRlZmluZXMgdGhlIGdyYWRpZW50IGRpcmVjdGlvbiBhbmQgc2l6ZS4KCSogQHBhcmFtIHtudW1iZXJ9IHgxIC0gVGhlIHBvc2l0aW9uIG9mIHRoZSBzZWNvbmQgcG9pbnQgZGVmaW5pbmcgdGhlIGxpbmUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudCBkaXJlY3Rpb24gYW5kIHNpemUuCgkqIEBwYXJhbSB7bnVtYmVyfSB5MSAtIFRoZSBwb3NpdGlvbiBvZiB0aGUgc2Vjb25kIHBvaW50IGRlZmluaW5nIHRoZSBsaW5lIHRoYXQgZGVmaW5lcyB0aGUgZ3JhZGllbnQgZGlyZWN0aW9uIGFuZCBzaXplLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgliZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlOiBmdW5jdGlvbiAoY29sb3JzLCByYXRpb3MsIHgwLCB5MCwgeDEsIHkxKSB7CgoJCXZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlTGluZWFyR3JhZGllbnQoeDAsIHkwLCB4MSwgeTEpOwoKCQlmb3IgKHZhciBpID0gMCwgbGVuID0gY29sb3JzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQoJCXsKCQkJZ3JhZGllbnQuYWRkQ29sb3JTdG9wKHJhdGlvc1tpXSwgY29sb3JzW2ldKTsKCQl9CgoJCXRoaXMuc3Ryb2tlU3R5bGUoZ3JhZGllbnQpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBCZWdpbnMgYSByYWRpYWwgZ3JhZGllbnQgc3Ryb2tlLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguIEZvciBleGFtcGxlLCB0aGUgZm9sbG93aW5nIGNvZGUgZGVmaW5lcyBhIHJlZCB0bwoJKiBibHVlIHJhZGlhbCBncmFkaWVudCBjZW50ZXJlZCBhdCAoMTAwLCAxMDApLCB3aXRoIGEgcmFkaXVzIG9mIDUwLCBhbmQgZHJhd3MgYSByZWN0YW5nbGUgdG8gZGlzcGxheSBpdDoKCSoKCSogICAgICBteUdyYXBoaWNzLnNldFN0cm9rZVN0eWxlKDEwKQoJKiAgICAgICAgICAuYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZShbIiNGMDAiLCIjMDBGIl0sIFswLCAxXSwgMTAwLCAxMDAsIDAsIDEwMCwgMTAwLCA1MCkKCSogICAgICAgICAgLmRyYXdSZWN0KDUwLCA5MCwgMTUwLCAxMTApOwoJKgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmJlZ2luUmFkaWFsR3JhZGllbnRTdHJva2UKCSogQHBhcmFtIHtBcnJheX0gY29sb3JzIC0gQW4gYXJyYXkgb2YgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWVzLiBGb3IgZXhhbXBsZSwgWyIjRjAwIiwiIzAwRiJdIHdvdWxkIGRlZmluZSBhIGdyYWRpZW50IGRyYXdpbmcgZnJvbSByZWQgdG8gYmx1ZS4KCSogQHBhcmFtIHtBcnJheX0gcmF0aW9zIC0gQW4gYXJyYXkgb2YgZ3JhZGllbnQgcG9zaXRpb25zIHdoaWNoIGNvcnJlc3BvbmQgdG8gdGhlIGNvbG9ycy4gRm9yIGV4YW1wbGUsIFswLjEsIDAuOV0gd291bGQgZHJhdyB0aGUgZmlyc3QgY29sb3IgdG8gMTAlIHRoZW4gaW50ZXJwb2xhdGluZyB0byB0aGUgc2Vjb25kIGNvbG9yIGF0IDkwJS4KCSogQHBhcmFtIHtudW1iZXJ9IHgwIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHBhcmFtIHtudW1iZXJ9IHkwIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHBhcmFtIHtudW1iZXJ9IHIwIC0gUmFkaXVzIG9mIHRoZSBpbm5lciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHBhcmFtIHtudW1iZXJ9IHgxIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHBhcmFtIHtudW1iZXJ9IHkxIC0gQ2VudGVyIHBvc2l0aW9uIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHBhcmFtIHtudW1iZXJ9IHIxIC0gUmFkaXVzIG9mIHRoZSBvdXRlciBjaXJjbGUgdGhhdCBkZWZpbmVzIHRoZSBncmFkaWVudC4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZTogZnVuY3Rpb24gKGNvbG9ycywgcmF0aW9zLCB4MCwgeTAsIHIwLCB4MSwgeTEsIHIxKSB7CgoJCXZhciBncmFkaWVudCA9IHRoaXMuY3JlYXRlUmFkaWFsR3JhZGllbnQoeDAsIHkwLCByMCwgeDEsIHkxLCByMSk7CgoJCWZvciAodmFyIGkgPSAwLCBsZW4gPSBjb2xvcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCgkJewoJCQlncmFkaWVudC5hZGRDb2xvclN0b3AocmF0aW9zW2ldLCBjb2xvcnNbaV0pOwoJCX0KCgkJdGhpcy5zdHJva2VTdHlsZShncmFkaWVudCk7CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFN0YXJ0cyBhIG5ldyBwYXRoIGJ5IHJlc2V0dGluZyB0aGUgbGlzdCBvZiBzdWItcGF0aHMuIENhbGwgdGhpcyBtZXRob2Qgd2hlbiB5b3Ugd2FudCB0byBjcmVhdGUgYSBuZXcgcGF0aC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5iZWdpblBhdGgKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5QYXRoOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBCZWdpbnMgYSBzdHJva2Ugd2l0aCB0aGUgc3BlY2lmaWVkIGNvbG9yLiBUaGlzIGVuZHMgdGhlIGN1cnJlbnQgc3ViLXBhdGguCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuYmVnaW5TdHJva2UKCSogQHBhcmFtIHtTdHJpbmd9IGNvbG9yIEEgQ1NTIGNvbXBhdGlibGUgY29sb3IgdmFsdWUgKGV4LiAiI0ZGMDAwMCIsICJyZWQiLCBvciAicmdiYSgyNTUsMCwwLDAuNSkiKS4gU2V0dGluZyB0byBudWxsIHdpbGwgcmVzdWx0IGluIG5vIHN0cm9rZS4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJYmVnaW5TdHJva2U6IGZ1bmN0aW9uIChjb2xvcikgewoKCQl0aGlzLnN0cm9rZVN0eWxlKGNvbG9yKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBBZGRzIGEgYmV6aWVyIGN1cnZlIGZyb20gdGhlIGN1cnJlbnQgY29udGV4dCBwb2ludCB0byAoeCwgeSkgdXNpbmcgdGhlIGNvbnRyb2wgcG9pbnRzIChjcDF4LCBjcDF5KSBhbmQgKGNwMngsIGNwMnkpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmJlemllckN1cnZlVG8KCSogQHBhcmFtIHtudW1iZXJ9IGNwMXggLSBUaGUgeCBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMS4KCSogQHBhcmFtIHtudW1iZXJ9IGNwMXkgLSBUaGUgeSBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMS4KCSogQHBhcmFtIHtudW1iZXJ9IGNwMnggLSBUaGUgeCBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMi4KCSogQHBhcmFtIHtudW1iZXJ9IGNwMnkgLSBUaGUgeSBheGlzIG9mIGNvbnRyb2wgcG9pbnQgMi4KCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgZW5kaW5nIHBvaW50LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgliZXppZXJDdXJ2ZVRvOiBmdW5jdGlvbiAoY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LmJlemllckN1cnZlVG8oY3AxeCwgY3AxeSwgY3AyeCwgY3AyeSwgeCwgeSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogRHJhd3MgYSBjaXJjbGUgd2l0aCB0aGUgc3BlY2lmaWVkIHJhZGl1cyBhdCAoeCwgeSkuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuY2lyY2xlCgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBjaXJjbGUuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBjaXJjbGUuCgkqIEBwYXJhbSB7bnVtYmVyfSByYWRpdXMgLSBSYWRpdXMgb2YgY2lyY2xlIGluIHJhZGlhbnMuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWNpcmNsZTogZnVuY3Rpb24gKHgsIHksIHJhZGl1cykgewoKCQl0aGlzLmFyYyh4LCB5LCByYWRpdXMsIDAsIE1hdGguUEkqMik7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0cyBhbGwgcGl4ZWxzIGluIHRoZSByZWN0YW5nbGUgZGVmaW5lZCBieSBzdGFydGluZyBwb2ludCAoeCwgeSkgYW5kIHNpemUgKHdpZHRoLCBoZWlnaHQpIHRvIHRyYW5zcGFyZW50IGJsYWNrLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNsZWFyUmVjdAoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHJlY3RhbmdsZXMgd2lkdGguCgkqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgcmVjdGFuZ2xlcyBoZWlnaHQuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWNsZWFyUmVjdDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5jbGVhclJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQ3JlYXRlcyBhIGNsaXBwaW5nIHBhdGggZnJvbSB0aGUgY3VycmVudCBzdWItcGF0aHMuIEV2ZXJ5dGhpbmcgZHJhd24gYWZ0ZXIgY2xpcCgpIGlzIGNhbGxlZCBhcHBlYXJzIGluc2lkZSB0aGUgY2xpcHBpbmcgcGF0aCBvbmx5LgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNsaXAKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJY2xpcDogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5jbGlwKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogVHJpZXMgdG8gZHJhdyBhIHN0cmFpZ2h0IGxpbmUgZnJvbSB0aGUgY3VycmVudCBwb2ludCB0byB0aGUgc3RhcnQuIElmIHRoZSBzaGFwZSBoYXMgYWxyZWFkeSBiZWVuIGNsb3NlZCBvciBoYXMgb25seSBvbmUgcG9pbnQsIHRoaXMgZnVuY3Rpb24gZG9lcyBub3RoaW5nLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmNsb3NlUGF0aAoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgljbG9zZVBhdGg6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBDcmVhdGVzIGEgbGluZWFyIGdyYWRpZW50IHdpdGggZGVmaW5lZCBieSBhbiBpbWFnaW5hcnkgbGluZSB3aGljaCBpbXBsaWVzIHRoZSBkaXJlY3Rpb24gb2YgdGhlIGdyYWRpZW50LgoJKiBPbmNlIHRoZSBncmFkaWVudCBpcyBjcmVhdGVkIGNvbG9ycyBjYW4gYmUgaW5zZXJ0ZWQgdXNpbmcgdGhlIGFkZENvbG9yU3RvcCBtZXRob2QuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuY3JlYXRlTGluZWFyR3JhZGllbnQKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZ3JhZGllbnRzIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBncmFkaWVudHMgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgZ3JhZGllbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBncmFkaWVudC4KCSogQHJldHVybiB7Q2FudmFzR3JhZGllbnR9IFRoZSBMaW5lYXIgR3JhZGllbnQuCgkqLwoJY3JlYXRlTGluZWFyR3JhZGllbnQ6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgoJCXJldHVybiB0aGlzLmNvbnRleHQuY3JlYXRlTGluZWFyR3JhZGllbnQoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgoJfSwKCgkvLwljcmVhdGVQYXR0ZXJuCgoJLyoqCgkqIENyZWF0ZXMgYSByYWRpYWwgZ3JhZGllbnQuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuY3JlYXRlUmFkaWFsR3JhZGllbnQKCSogQHBhcmFtIHtudW1iZXJ9IHgwCgkqIEBwYXJhbSB7bnVtYmVyfSB5MAoJKiBAcGFyYW0ge251bWJlcn0gcjAKCSogQHBhcmFtIHtudW1iZXJ9IHgxCgkqIEBwYXJhbSB7bnVtYmVyfSB5MQoJKiBAcGFyYW0ge251bWJlcn0gcjEKCSogQHJldHVybiB7Q2FudmFzR3JhZGllbnR9IFRoZSBSYWRpYWwgR3JhZGllbnQuCgkqLwoJY3JlYXRlUmFkaWFsR3JhZGllbnQ6IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgoJCXJldHVybiB0aGlzLmNvbnRleHQuY3JlYXRlUmFkaWFsR3JhZGllbnQoeDAsIHkwLCByMCwgeDEsIHkxLCByMSk7CgoJfSwKCgkvLwlkcmF3SW1hZ2UKCS8vCWRyYXdTeXN0ZW1Gb2N1c1JpbmcgKD8pCgoJLyoqCgkqIERyYXdzIGFuIGVsbGlwc2UgKG92YWwpIHdpdGggYSBzcGVjaWZpZWQgd2lkdGggKHcpIGFuZCBoZWlnaHQgKGgpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmVsbGlwc2UKCSogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgY2VudGVyIHBvaW50IG9mIGVsbGlwc2UuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGNlbnRlciBwb2ludCBvZiBlbGxpcHNlLgoJKiBAcGFyYW0ge251bWJlcn0gdyAtIGhlaWdodCAoaG9yaXpvbnRhbCBkaWFtZXRlcikgb2YgZWxsaXBzZS4gVGhlIGhvcml6b250YWwgcmFkaXVzIHdpbGwgYmUgaGFsZiBvZiB0aGlzIG51bWJlci4KCSogQHBhcmFtIHtudW1iZXJ9IGggLSB3aWR0aCAodmVydGljYWwgZGlhbWV0ZXIpIG9mIGVsbGlwc2UuIFRoZSB2ZXJ0aWNhbCByYWRpdXMgd2lsbCBiZSBoYWxmIG9mIHRoaXMgbnVtYmVyLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgllbGxpcHNlOiBmdW5jdGlvbiAoeCwgeSwgdywgaCkgewoKCQl2YXIgayA9IDAuNTUyMjg0ODsKCQl2YXIgb3ggPSAodyAvIDIpICogazsKCQl2YXIgb3kgPSAoaCAvIDIpICogazsKCQl2YXIgeGUgPSB4ICsgdzsKCQl2YXIgeWUgPSB5ICsgaDsKCQl2YXIgeG0gPSB4ICsgdyAvIDI7CgkJdmFyIHltID0geSArIGggLyAyOwoJCQkKCQl0aGlzLm1vdmVUbyh4LCB5bSk7CgkJdGhpcy5iZXppZXJDdXJ2ZVRvKHgsIHltIC0gb3ksIHhtIC0gb3gsIHksIHhtLCB5KTsKCQl0aGlzLmJlemllckN1cnZlVG8oeG0gKyBveCwgeSwgeGUsIHltIC0gb3ksIHhlLCB5bSk7CgkJdGhpcy5iZXppZXJDdXJ2ZVRvKHhlLCB5bSArIG95LCB4bSArIG94LCB5ZSwgeG0sIHllKTsKCQl0aGlzLmJlemllckN1cnZlVG8oeG0gLSBveCwgeWUsIHgsIHltICsgb3ksIHgsIHltKTsKCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogRmlsbHMgdGhlIHN1YnBhdGhzIHdpdGggdGhlIGN1cnJlbnQgZmlsbCBzdHlsZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5maWxsCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWZpbGw6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5maWxsKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogRHJhd3MgYSBmaWxsZWQgcmVjdGFuZ2xlIGF0ICh4LCB5KSBwb3NpdGlvbiB3aG9zZSBzaXplIGlzIGRldGVybWluZWQgYnkgd2lkdGggYW5kIGhlaWdodC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5maWxsUmVjdAoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBvZiB0aGUgY29vcmRpbmF0ZSBmb3IgdGhlIHJlY3RhbmdsZSBzdGFydGluZyBwb2ludC4KCSogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHJlY3RhbmdsZXMgd2lkdGguCgkqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgcmVjdGFuZ2xlcyBoZWlnaHQuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWZpbGxSZWN0OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LmZpbGxSZWN0KHgsIHksIHdpZHRoLCBoZWlnaHQpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldHMgdGhlIGZpbGwgc3R5bGUuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuZmlsbFN0eWxlCgkqIEBwYXJhbSB7c3RyaW5nfSBjb2xvciAtIFRoZSBmaWxsIGNvbG9yIHZhbHVlIGluIENTUyBmb3JtYXQ6ICNSUkdHQkIgb3IgcmdiYShyLGcsYixhKQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglmaWxsU3R5bGU6IGZ1bmN0aW9uIChjb2xvcikgewoKCQl0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwlmaWxsVGV4dAoKCS8qKgoJKiBTZXRzIHRoZSBmb250LgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmZvbnQKCSogQHBhcmFtIHtET01TdHJpbmd9IGZvbnQgLSBUaGUgZm9udCB0byBiZSB1c2VkIGZvciBhbnkgdGV4dCByZW5kZXJpbmcuIERlZmF1bHQgdmFsdWUgMTBweCBzYW5zLXNlcmlmLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglmb250OiBmdW5jdGlvbiAoZm9udCkgewoKCQl0aGlzLmNvbnRleHQuZm9udCA9IGZvbnQ7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWxwaGEgdmFsdWUgdGhhdCBpcyBhcHBsaWVkIHRvIHNoYXBlcyBhbmQgaW1hZ2VzIGJlZm9yZSB0aGV5IGFyZSBjb21wb3NpdGVkIG9udG8gdGhlIGNhbnZhcy4gRGVmYXVsdCAxLjAgKG9wYXF1ZSkuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEuZ2xvYmFsQWxwaGEKCSogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gQWxwaGEgdmFsdWUgdGhhdCBpcyBhcHBsaWVkIHRvIHNoYXBlcyBhbmQgaW1hZ2VzIGJlZm9yZSB0aGV5IGFyZSBjb21wb3NpdGVkIG9udG8gdGhlIGNhbnZhcy4gRGVmYXVsdCAxLjAgKG9wYXF1ZSkuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWdsb2JhbEFscGhhOiBmdW5jdGlvbiAoYWxwaGEpIHsKCgkJdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gYWxwaGE7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogV2l0aCBnbG9iYWxBbHBoYSBhcHBsaWVkIHRoaXMgc2V0cyBob3cgc2hhcGVzIGFuZCBpbWFnZXMgYXJlIGRyYXduIG9udG8gdGhlIGV4aXN0aW5nIGJpdG1hcC4gUG9zc2libGUgdmFsdWVzOiBzb3VyY2UtYXRvcCwgc291cmNlLWluLCBzb3VyY2Utb3V0LAoJKiBzb3VyY2Utb3ZlciAoZGVmYXVsdCksIGRlc3RpbmF0aW9uLWF0b3AsIGRlc3RpbmF0aW9uLWluLCBkZXN0aW5hdGlvbi1vdXQsIGRlc3RpbmF0aW9uLW92ZXIsIGxpZ2h0ZXIsIGRhcmtlciwgY29weSBhbmQgeG9yLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbgoJKiBAcGFyYW0ge0RPTVN0cmluZ30gb3BlcmF0aW9uIC0gVGhlIGNvbXBvc2l0ZSBvcGVyYXRpb24gdG8gYXBwbHkuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbjogZnVuY3Rpb24gKG9wZXJhdGlvbikgewoKCQl0aGlzLmNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID0gb3BlcmF0aW9uOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFR5cGUgb2YgZW5kaW5ncyBvbiB0aGUgZW5kIG9mIGxpbmVzLiBQb3NzaWJsZSB2YWx1ZXM6IGJ1dHQgKGRlZmF1bHQpLCByb3VuZCwgc3F1YXJlLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmxpbmVDYXAKCSogQHBhcmFtIHtET01TdHJpbmd9IHN0eWxlIC0gUG9zc2libGUgdmFsdWVzOiBidXR0IChkZWZhdWx0KSwgcm91bmQsIHNxdWFyZQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglsaW5lQ2FwOiBmdW5jdGlvbiAoc3R5bGUpIHsKCgkJdGhpcy5jb250ZXh0LmxpbmVDYXAgPSBzdHlsZTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTcGVjaWZpZXMgd2hlcmUgdG8gc3RhcnQgYSBkYXNoYXJyYXkgb24gYSBsaW5lLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmxpbmVEYXNoT2Zmc2V0CgkqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXQgLSBTcGVjaWZpZXMgd2hlcmUgdG8gc3RhcnQgYSBkYXNoYXJyYXkgb24gYSBsaW5lLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglsaW5lRGFzaE9mZnNldDogZnVuY3Rpb24gKG9mZnNldCkgewoKCQl0aGlzLmNvbnRleHQubGluZURhc2hPZmZzZXQgPSBvZmZzZXQ7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogRGVmaW5lcyB0aGUgdHlwZSBvZiBjb3JuZXJzIHdoZXJlIHR3byBsaW5lcyBtZWV0LiBQb3NzaWJsZSB2YWx1ZXM6IHJvdW5kLCBiZXZlbCwgbWl0ZXIgKGRlZmF1bHQpCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEubGluZUpvaW4KCSogQHBhcmFtIHtET01TdHJpbmd9IGpvaW4gLSBQb3NzaWJsZSB2YWx1ZXM6IHJvdW5kLCBiZXZlbCwgbWl0ZXIgKGRlZmF1bHQpCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWxpbmVKb2luOiBmdW5jdGlvbiAoam9pbikgewoKCQl0aGlzLmNvbnRleHQubGluZUpvaW4gPSBqb2luOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFdpZHRoIG9mIGxpbmVzLiBEZWZhdWx0IDEuMAoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLmxpbmVXaWR0aAoJKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiBsaW5lcy4gRGVmYXVsdCAxLjAKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJbGluZVdpZHRoOiBmdW5jdGlvbiAod2lkdGgpIHsKCgkJdGhpcy5jb250ZXh0LmxpbmVXaWR0aCA9IHdpZHRoOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIERlZmF1bHQgMTAuCgkqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEubWl0ZXJMaW1pdAoJKiBAcGFyYW0ge251bWJlcn0gbGltaXQgLSBEZWZhdWx0IDEwLgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgltaXRlckxpbWl0OiBmdW5jdGlvbiAobGltaXQpIHsKCgkJdGhpcy5jb250ZXh0Lm1pdGVyTGltaXQgPSBsaW1pdDsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8vCWdldEltYWdlRGF0YQoJLy8JZ2V0TGluZURhc2gKCS8vCWlzUG9pbnRJblBhdGgKCS8vCWlzUG9pbnRJblN0cm9rZQoKCS8qKgoJKiBDb25uZWN0cyB0aGUgbGFzdCBwb2ludCBpbiB0aGUgc3VicGF0aCB0byB0aGUgeCwgeSBjb29yZGluYXRlcyB3aXRoIGEgc3RyYWlnaHQgbGluZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5saW5lVG8KCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgZW5kIG9mIHRoZSBsaW5lLgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSBlbmQgb2YgdGhlIGxpbmUuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCWxpbmVUbzogZnVuY3Rpb24gKHgsIHkpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5saW5lVG8oeCwgeSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwltZWFzdXJlVGV4dAoKCS8qKgoJKiBNb3ZlcyB0aGUgc3RhcnRpbmcgcG9pbnQgb2YgYSBuZXcgc3VicGF0aCB0byB0aGUgKHgsIHkpIGNvb3JkaW5hdGVzLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLm1vdmVUbwoJKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIHBvaW50LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCgltb3ZlVG86IGZ1bmN0aW9uICh4LCB5KSB7CgoJCXRoaXMuY29udGV4dC5tb3ZlVG8oeCwgeSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwlwdXRJbWFnZURhdGEKCgkvKioKCSogRHJhd3MgYSBxdWFkcmF0aWMgY3VydmUgZnJvbSB0aGUgY3VycmVudCBkcmF3aW5nIHBvaW50IHRvICh4LCB5KSB1c2luZyB0aGUgY29udHJvbCBwb2ludCAoY3B4LCBjcHkpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnF1YWRyYXRpY0N1cnZlVG8KCSogQHBhcmFtIHtOdW1iZXJ9IGNweCAtIFRoZSB4IGF4aXMgb2YgdGhlIGNvbnRyb2wgcG9pbnQuCgkqIEBwYXJhbSB7TnVtYmVyfSBjcHkgLSBUaGUgeSBheGlzIG9mIHRoZSBjb250cm9sIHBvaW50LgoJKiBAcGFyYW0ge051bWJlcn0geCAtIFRoZSB4IGF4aXMgb2YgdGhlIGVuZGluZyBwb2ludC4KCSogQHBhcmFtIHtOdW1iZXJ9IHkgLSBUaGUgeSBheGlzIG9mIHRoZSBlbmRpbmcgcG9pbnQuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXF1YWRyYXRpY0N1cnZlVG86IGZ1bmN0aW9uKGNweCwgY3B5LCB4LCB5KSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQucXVhZHJhdGljQ3VydmVUbyhjcHgsIGNweSwgeCwgeSk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogRHJhd3MgYSByZWN0YW5nbGUgYXQgKHgsIHkpIHBvc2l0aW9uIHdob3NlIHNpemUgaXMgZGV0ZXJtaW5lZCBieSB3aWR0aCBhbmQgaGVpZ2h0LgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnJlY3QKCSogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBheGlzIG9mIHRoZSBjb29yZGluYXRlIGZvciB0aGUgcmVjdGFuZ2xlIHN0YXJ0aW5nIHBvaW50LgoJKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGF4aXMgb2YgdGhlIGNvb3JkaW5hdGUgZm9yIHRoZSByZWN0YW5nbGUgc3RhcnRpbmcgcG9pbnQuCgkqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgoJKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglyZWN0OiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnJlY3QoeCwgeSwgd2lkdGgsIGhlaWdodCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCQoJLyoqCgkqIFJlc3RvcmVzIHRoZSBkcmF3aW5nIHN0eWxlIHN0YXRlIHRvIHRoZSBsYXN0IGVsZW1lbnQgb24gdGhlICdzdGF0ZSBzdGFjaycgc2F2ZWQgYnkgc2F2ZSgpLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnJlc3RvcmUKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJcmVzdG9yZTogZnVuY3Rpb24gKCkgewoKCQl0aGlzLl9kaXJ0eSA9IHRydWU7CgkJdGhpcy5jb250ZXh0LnJlc3RvcmUoKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBSb3RhdGVzIHRoZSBkcmF3aW5nIGNvbnRleHQgdmFsdWVzIGJ5IHIgcmFkaWFucy4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5yb3RhdGUKCSogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIG9mIHJvdGF0aW9uIGdpdmVuIGluIHJhZGlhbnMuCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXJvdGF0ZTogZnVuY3Rpb24gKGFuZ2xlKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQucm90YXRlKGFuZ2xlKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIHRoZSBzdHJva2Ugc3R5bGUgZm9yIHRoZSBjdXJyZW50IHN1Yi1wYXRoLiBMaWtlIGFsbCBkcmF3aW5nIG1ldGhvZHMsIHRoaXMgY2FuIGJlIGNoYWluZWQsIHNvIHlvdSBjYW4gZGVmaW5lCgkqIHRoZSBzdHJva2Ugc3R5bGUgYW5kIGNvbG9yIGluIGEgc2luZ2xlIGxpbmUgb2YgY29kZSBsaWtlIHNvOgoJKgoJKiAgICAgIGBgYG15R3JhcGhpY3Muc2V0U3Ryb2tlU3R5bGUoOCwicm91bmQiKS5iZWdpblN0cm9rZSgiI0YwMCIpO2BgYAoJKgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnNldFN0cm9rZVN0eWxlCgkqIEBwYXJhbSB7bnVtYmVyfSB0aGlja25lc3MgLSBUaGUgd2lkdGggb2YgdGhlIHN0cm9rZS4KCSogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbY2Fwcz0wXSAtIEluZGljYXRlcyB0aGUgdHlwZSBvZiBjYXBzIHRvIHVzZSBhdCB0aGUgZW5kIG9mIGxpbmVzLiBPbmUgb2YgYnV0dCwgcm91bmQsIG9yIHNxdWFyZS4gRGVmYXVsdHMgdG8gImJ1dHQiLiBBbHNvIGFjY2VwdHMgdGhlIHZhbHVlcyAwIChidXR0KSwgMSAocm91bmQpLCBhbmQgMiAoc3F1YXJlKSBmb3IgdXNlIHdpdGggaGUgdGlueSBBUEkuCgkqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2pvaW50cz0wXSBTcGVjaWZpZXMgdGhlIHR5cGUgb2Ygam9pbnRzIHRoYXQgc2hvdWxkIGJlIHVzZWQgd2hlcmUgdHdvIGxpbmVzIG1lZXQuIE9uZSBvZiBiZXZlbCwgcm91bmQsIG9yIG1pdGVyLiBEZWZhdWx0cyB0byAibWl0ZXIiLiBBbHNvIGFjY2VwdHMgdGhlIHZhbHVlcyAwIChtaXRlciksIDEgKHJvdW5kKSwgYW5kIDIgKGJldmVsKSBmb3IgdXNlIHdpdGggdGhlIHRpbnkgQVBJLgoJKiBAcGFyYW0ge251bWJlcn0gW21pdGVyTGltaXQ9MTBdIC0gSWYgam9pbnRzIGlzIHNldCB0byAibWl0ZXIiLCB0aGVuIHlvdSBjYW4gc3BlY2lmeSBhIG1pdGVyIGxpbWl0IHJhdGlvIHdoaWNoIGNvbnRyb2xzIGF0IHdoYXQgcG9pbnQgYSBtaXRlcmVkIGpvaW50IHdpbGwgYmUgY2xpcHBlZC4KCSogQHBhcmFtIHtib29sZWFufSBbaWdub3JlU2NhbGU9ZmFsc2VdIC0gSWYgdHJ1ZSwgdGhlIHN0cm9rZSB3aWxsIGJlIGRyYXduIGF0IHRoZSBzcGVjaWZpZWQgdGhpY2tuZXNzIHJlZ2FyZGxlc3Mgb2YgYWN0aXZlIHRyYW5zZm9ybWF0aW9ucy4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc2V0U3Ryb2tlU3R5bGU6IGZ1bmN0aW9uICh0aGlja25lc3MsIGNhcHMsIGpvaW50cywgbWl0ZXJMaW1pdCwgaWdub3JlU2NhbGUpIHsKCgkJaWYgKHR5cGVvZiB0aGlja25lc3MgPT09ICd1bmRlZmluZWQnKSB7IHRoaWNrbmVzcyA9IDE7IH0KCQlpZiAodHlwZW9mIGNhcHMgPT09ICd1bmRlZmluZWQnKSB7IGNhcHMgPSAnYnV0dCc7IH0KCQlpZiAodHlwZW9mIGpvaW50cyA9PT0gJ3VuZGVmaW5lZCcpIHsgam9pbnRzID0gJ21pdGVyJzsgfQoJCWlmICh0eXBlb2YgbWl0ZXJMaW1pdCA9PT0gJ3VuZGVmaW5lZCcpIHsgbWl0ZXJMaW1pdCA9IDEwOyB9CgoJCXRoaXMubGluZVdpZHRoKHRoaWNrbmVzcyk7CgkJdGhpcy5saW5lQ2FwKGNhcHMpOwoJCXRoaXMubGluZUpvaW4oam9pbnRzKTsKCQl0aGlzLm1pdGVyTGltaXQobWl0ZXJMaW1pdCk7CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNhdmVzIHRoZSBjdXJyZW50IGRyYXdpbmcgc3R5bGUgc3RhdGUgdXNpbmcgYSBzdGFjayBzbyB5b3UgY2FuIHJldmVydCBhbnkgY2hhbmdlIHlvdSBtYWtlIHRvIGl0IHVzaW5nIHJlc3RvcmUoKS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zYXZlCgkqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgQml0bWFwRGF0YSBpbnN0YW5jZSB0aGlzIG1ldGhvZCB3YXMgY2FsbGVkIG9uLgoJKi8KCXNhdmU6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5zYXZlKCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2NhbGVzIHRoZSBjdXJyZW50IGRyYXdpbmcgY29udGV4dC4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zY2FsZQoJKiBAcGFyYW0ge251bWJlcn0geAoJKiBAcGFyYW0ge251bWJlcn0geQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglzY2FsZTogZnVuY3Rpb24gKHgsIHkpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5zY2FsZSh4LCB5KTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zY3JvbGxQYXRoSW50b1ZpZXcKCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc2Nyb2xsUGF0aEludG9WaWV3OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuc2Nyb2xsUGF0aEludG9WaWV3KCk7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvLwlzZXRMaW5lRGFzaAoJLy8Jc2V0VHJhbnNmb3JtCgoJLyoqCgkqIFN0cm9rZXMgdGhlIHN1YnBhdGhzIHdpdGggdGhlIGN1cnJlbnQgc3Ryb2tlIHN0eWxlLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnN0cm9rZQoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglzdHJva2U6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZGlydHkgPSB0cnVlOwoJCXRoaXMuY29udGV4dC5zdHJva2UoKTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBQYWludHMgYSByZWN0YW5nbGUgd2hpY2ggaGFzIGEgc3RhcnRpbmcgcG9pbnQgYXQgKHgsIHkpIGFuZCBoYXMgYSB3IHdpZHRoIGFuZCBhbiBoIGhlaWdodCBvbnRvIHRoZSBjYW52YXMsIHVzaW5nIHRoZSBjdXJyZW50IHN0cm9rZSBzdHlsZS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zdHJva2VSZWN0CgkqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggYXhpcyBmb3IgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSByZWN0YW5nbGUuCgkqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgYXhpcyBmb3IgdGhlIHN0YXJ0aW5nIHBvaW50IG9mIHRoZSByZWN0YW5nbGUuCgkqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSByZWN0YW5nbGVzIHdpZHRoLgoJKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIHJlY3RhbmdsZXMgaGVpZ2h0LgoJKiBAcmV0dXJuIHtQaGFzZXIuQml0bWFwRGF0YX0gVGhlIEJpdG1hcERhdGEgaW5zdGFuY2UgdGhpcyBtZXRob2Qgd2FzIGNhbGxlZCBvbi4KCSovCglzdHJva2VSZWN0OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2RpcnR5ID0gdHJ1ZTsKCQl0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdCh4LCB5LCB3aWR0aCwgaGVpZ2h0KTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBDb2xvciBvciBzdHlsZSB0byB1c2UgZm9yIHRoZSBsaW5lcyBhcm91bmQgc2hhcGVzLiBEZWZhdWx0ICMwMDAgKGJsYWNrKS4KCSogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5zdHJva2VTdHlsZQoJKiBAcGFyYW0ge3N0cmluZ30gc3R5bGUgLSBDb2xvciBvciBzdHlsZSB0byB1c2UgZm9yIHRoZSBsaW5lcyBhcm91bmQgc2hhcGVzLiBEZWZhdWx0ICMwMDAgKGJsYWNrKS4KCSogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIGluc3RhbmNlIHRoaXMgbWV0aG9kIHdhcyBjYWxsZWQgb24uCgkqLwoJc3Ryb2tlU3R5bGU6IGZ1bmN0aW9uIChzdHlsZSkgewoKCQl0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBzdHlsZTsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8vCXN0cm9rZVRleHQKCS8vCXRyYW5zZm9ybQoJLy8JdHJhbnNsYXRlCgoJLyoqCgkqIElmIHRoZSBnYW1lIGlzIHJ1bm5pbmcgaW4gV2ViR0wgdGhpcyB3aWxsIHB1c2ggdGhlIHRleHR1cmUgdXAgdG8gdGhlIEdQVSBpZiBpdCdzIGRpcnR5LgoJKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGlmIHRoZSBCaXRtYXBEYXRhIGlzIGJlaW5nIHVzZWQgYnkgYSBTcHJpdGUsIG90aGVyd2lzZSB5b3UgbmVlZCB0byByZW1lbWJlciB0byBjYWxsIGl0IGluIHlvdXIgcmVuZGVyIGZ1bmN0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnJlbmRlcgoJKi8KCXJlbmRlcjogZnVuY3Rpb24gKCkgewoKCQlpZiAodGhpcy5fZGlydHkpCgkJewoJCSAgICAvLyAgT25seSBuZWVkZWQgaWYgcnVubmluZyBpbiBXZWJHTCwgb3RoZXJ3aXNlIHRoaXMgYXJyYXkgd2lsbCBuZXZlciBnZXQgY2xlYXJlZCBkb3duCgkJICAgIGlmICh0aGlzLmdhbWUucmVuZGVyVHlwZSA9PSBQaGFzZXIuV0VCR0wpCgkJICAgIHsKCQkgICAgICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMuYmFzZVRleHR1cmUpOwoJCSAgICB9CgoJCQl0aGlzLl9kaXJ0eSA9IGZhbHNlOwoJCX0KCgl9Cgp9CgovLwlFYXNlbEpTIFRpbnkgQVBJIGVtdWxhdGlvbgoKLyoqCiogU2hvcnRjdXQgdG8gbW92ZVRvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLm10CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5tb3ZlVG87CgovKioKKiBTaG9ydGN1dCB0byBsaW5lVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubXQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmx0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxpbmVUbzsKCi8qKgoqIFNob3J0Y3V0IHRvIGFyY1RvLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmF0CiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hdCA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hcmNUbzsKCi8qKgoqIFNob3J0Y3V0IHRvIGJlemllckN1cnZlVG8uCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnQKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJ0ID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlemllckN1cnZlVG87CgkKLyoqCiogU2hvcnRjdXQgdG8gcXVhZHJhdGljQ3VydmVUby4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5xdAoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXQgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucXVhZHJhdGljQ3VydmVUbzsKCQovKioKKiBTaG9ydGN1dCB0byBhcmMuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYQoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYSA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5hcmM7CgovKioKKiBTaG9ydGN1dCB0byByZWN0LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnIKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmVjdDsKCQovKioKKiBTaG9ydGN1dCB0byBjbG9zZVBhdGguCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuY3AKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNwID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNsb3NlUGF0aDsKCi8qKgoqIFNob3J0Y3V0IHRvIGNsZWFyLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuY2xlYXI7CgkKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5GaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5GaWxsOwoKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5MaW5lYXJHcmFkaWVudEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUubGYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmJlZ2luTGluZWFyR3JhZGllbnRGaWxsOwoJCi8qKgoqIFNob3J0Y3V0IHRvIGJlZ2luUmFkaWFsR3JhZGllbnRGaWxsLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJmCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yZiA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpblJhZGlhbEdyYWRpZW50RmlsbDsKCQovKioKKiBTaG9ydGN1dCB0byBiZWdpbkJpdG1hcEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmYKKi8KLy9QaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmYgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5CaXRtYXBGaWxsOwoJCi8qKgoqIFNob3J0Y3V0IHRvIGVuZEZpbGwuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZWYKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVmID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVuZEZpbGw7CgovKioKKiBTaG9ydGN1dCB0byBzZXRTdHJva2VTdHlsZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5zcwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc3MgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuc2V0U3Ryb2tlU3R5bGU7CgkKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5TdHJva2UuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpblN0cm9rZTsKCQovKioKKiBTaG9ydGN1dCB0byBiZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmxzCiovClBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5scyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5iZWdpbkxpbmVhckdyYWRpZW50U3Ryb2tlOwoKLyoqCiogU2hvcnRjdXQgdG8gYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5ycwoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5SYWRpYWxHcmFkaWVudFN0cm9rZTsKCQovKioKKiBTaG9ydGN1dCB0byBiZWdpbkJpdG1hcFN0cm9rZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5icwoqLwovLyBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYnMgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuYmVnaW5CaXRtYXBTdHJva2U7CgkKLyoqCiogU2hvcnRjdXQgdG8gZW5kU3Ryb2tlLgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmVzCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lcyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5lbmRTdHJva2U7CgkKLyoqCiogU2hvcnRjdXQgdG8gcmVjdC4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcgoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHIgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUucmVjdDsKCQovKioKKiBTaG9ydGN1dCB0byBkcmF3Um91bmRSZWN0LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJyCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yciA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3Um91bmRSZWN0OwoJCi8qKgoqIFNob3J0Y3V0IHRvIGRyYXdSb3VuZFJlY3RDb21wbGV4LgoqIEBtZXRob2QgUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLnJjCiovCi8vIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5yYyA9IFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kcmF3Um91bmRSZWN0Q29tcGxleDsKCi8qKgoqIFNob3J0Y3V0IHRvIGRyYXdDaXJjbGUuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGMKKi8KUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRjID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmNpcmNsZTsKCQovKioKKiBTaG9ydGN1dCB0byBkcmF3RWxsaXBzZS4KKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBEYXRhLnByb3RvdHlwZS5kZQoqLwpQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZGUgPSBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZWxsaXBzZTsKCQovKioKKiBTaG9ydGN1dCB0byBkcmF3UG9seVN0YXIuCiogQG1ldGhvZCBQaGFzZXIuQml0bWFwRGF0YS5wcm90b3R5cGUuZHAKKi8KLy8gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRwID0gUGhhc2VyLkJpdG1hcERhdGEucHJvdG90eXBlLmRyYXdQb2x5U3RhcjsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIENyZWF0ZSBhIG5ldyBgU3ByaXRlYCBvYmplY3QuIFNwcml0ZXMgYXJlIHRoZSBsaWZlYmxvb2Qgb2YgeW91ciBnYW1lLCB1c2VkIGZvciBuZWFybHkgZXZlcnl0aGluZyB2aXN1YWwuCiogQXQgaXRzIG1vc3QgYmFzaWMgYSBTcHJpdGUgY29uc2lzdHMgb2YgYSBzZXQgb2YgY29vcmRpbmF0ZXMgYW5kIGEgdGV4dHVyZSB0aGF0IGlzIHJlbmRlcmVkIHRvIHRoZSBjYW52YXMuCiogVGhleSBhbHNvIGNvbnRhaW4gYWRkaXRpb25hbCBwcm9wZXJ0aWVzIGFsbG93aW5nIGZvciBwaHlzaWNzIG1vdGlvbiAodmlhIFNwcml0ZS5ib2R5KSwgaW5wdXQgaGFuZGxpbmcgKHZpYSBTcHJpdGUuaW5wdXQpLAoqIGV2ZW50cyAodmlhIFNwcml0ZS5ldmVudHMpLCBhbmltYXRpb24gKHZpYSBTcHJpdGUuYW5pbWF0aW9ucyksIGNhbWVyYSBjdWxsaW5nIGFuZCBtb3JlLiBQbGVhc2Ugc2VlIHRoZSBFeGFtcGxlcyBmb3IgdXNlIGNhc2VzLgoqCiogQGNsYXNzIFBoYXNlci5TcHJpdGUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgdG8gcG9zaXRpb24gdGhlIFNwcml0ZSBhdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBoYXNlci5CaXRtYXBEYXRhfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGZyYW1lIC0gSWYgdGhpcyBTcHJpdGUgaXMgdXNpbmcgcGFydCBvZiBhIHNwcml0ZSBzaGVldCBvciB0ZXh0dXJlIGF0bGFzIHlvdSBjYW4gc3BlY2lmeSB0aGUgZXhhY3QgZnJhbWUgdG8gdXNlIGJ5IGdpdmluZyBhIHN0cmluZyBvciBudW1lcmljIGluZGV4LgoqLwpQaGFzZXIuU3ByaXRlID0gZnVuY3Rpb24gKGdhbWUsIHgsIHksIGtleSwgZnJhbWUpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIGtleSA9IGtleSB8fCBudWxsOwogICAgZnJhbWUgPSBmcmFtZSB8fCBudWxsOwogICAgCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CiAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGV4aXN0cyAtIElmIGV4aXN0cyA9IGZhbHNlIHRoZW4gdGhlIFNwcml0ZSBpc24ndCB1cGRhdGVkIGJ5IHRoZSBjb3JlIGdhbWUgbG9vcCBvciBwaHlzaWNzIHN1YnN5c3RlbSBhdCBhbGwuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwoKCS8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFsaXZlIC0gVGhpcyBpcyBhIGhhbmR5IGxpdHRsZSB2YXIgeW91ciBnYW1lIGNhbiB1c2UgdG8gZGV0ZXJtaW5lIGlmIGEgc3ByaXRlIGlzIGFsaXZlIG9yIG5vdCwgaXQgZG9lc24ndCBlZmZlY3QgcmVuZGVyaW5nLgogICAJKiBAZGVmYXVsdAogICAJKi8KICAgIHRoaXMuYWxpdmUgPSB0cnVlOwoKCS8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Hcm91cH0gZ3JvdXAgLSBUaGUgcGFyZW50IEdyb3VwIG9mIHRoaXMgU3ByaXRlLiBUaGlzIGlzIHVzdWFsbHkgc2V0IGFmdGVyIFNwcml0ZSBpbnN0YW50aWF0aW9uIGJ5IHRoZSBwYXJlbnQuCiAgIAkqLwogICAgdGhpcy5ncm91cCA9IG51bGw7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSB1c2VyIGRlZmluZWQgbmFtZSBnaXZlbiB0byB0aGlzIFNwcml0ZS4KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMubmFtZSA9ICcnOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBjb25zdCB0eXBlIG9mIHRoaXMgb2JqZWN0LgogICAgKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5TUFJJVEU7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSByZW5kZXJPcmRlcklEIC0gVXNlZCBieSB0aGUgUmVuZGVyZXIgYW5kIElucHV0IE1hbmFnZXIgdG8gY29udHJvbCBwaWNraW5nIG9yZGVyLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMucmVuZGVyT3JkZXJJRCA9IC0xOwoKICAgIC8qKgogICAgKiBJZiB5b3Ugd291bGQgbGlrZSB0aGUgU3ByaXRlIHRvIGhhdmUgYSBsaWZlc3BhbiBvbmNlICdib3JuJyB5b3UgY2FuIHNldCB0aGlzIHRvIGEgcG9zaXRpdmUgdmFsdWUuIEhhbmR5IGZvciBwYXJ0aWNsZXMsIGJ1bGxldHMsIGV0Yy4KCSogVGhlIGxpZmVzcGFuIGlzIGRlY3JlbWVudGVkIGJ5IGdhbWUudGltZS5lbGFwc2VkIGVhY2ggdXBkYXRlLCBvbmNlIGl0IHJlYWNoZXMgemVybyB0aGUga2lsbCgpIGZ1bmN0aW9uIGlzIGNhbGxlZC4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGxpZmVzcGFuIC0gVGhlIGxpZmVzcGFuIG9mIHRoZSBTcHJpdGUgKGluIG1zKSBiZWZvcmUgaXQgd2lsbCBiZSBraWxsZWQuCgkqIEBkZWZhdWx0CgkqLyAgICAKICAgIHRoaXMubGlmZXNwYW4gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0V2ZW50c30gZXZlbnRzIC0gVGhlIEV2ZW50cyB5b3UgY2FuIHN1YnNjcmliZSB0byB0aGF0IGFyZSBkaXNwYXRjaGVkIHdoZW4gY2VydGFpbiB0aGluZ3MgaGFwcGVuIG9uIHRoaXMgU3ByaXRlIG9yIGl0cyBjb21wb25lbnRzLgogICAgKi8KICAgIHRoaXMuZXZlbnRzID0gbmV3IFBoYXNlci5FdmVudHModGhpcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkFuaW1hdGlvbk1hbmFnZXJ9IGFuaW1hdGlvbnMgLSBUaGlzIG1hbmFnZXMgYW5pbWF0aW9ucyBvZiB0aGUgc3ByaXRlLiBZb3UgY2FuIG1vZGlmeSBhbmltYXRpb25zIHRocm91Z2ggaXQgKHNlZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlcikKICAgICovCiAgICB0aGlzLmFuaW1hdGlvbnMgPSBuZXcgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIodGhpcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7SW5wdXRIYW5kbGVyfSBpbnB1dCAtIFRoZSBJbnB1dCBIYW5kbGVyIENvbXBvbmVudC4KICAgICovCiAgICB0aGlzLmlucHV0ID0gbmV3IFBoYXNlci5JbnB1dEhhbmRsZXIodGhpcyk7CgogICAgLyoqCiAgICAqICBAcHJvcGVydHkge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSwgQml0bWFwRGF0YSBvciBQSVhJLlRleHR1cmUuCiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgLyoqCiAgICAqICBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgZnJhbWUuCiAgICAqLwogICAgdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwoKICAgIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZSkKICAgIHsKICAgICAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIGtleSk7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5nYW1lLmNhY2hlLmdldFRleHR1cmVGcmFtZShrZXkubmFtZSk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuQml0bWFwRGF0YSkKICAgIHsKICAgICAgICBQSVhJLlNwcml0ZS5jYWxsKHRoaXMsIGtleS50ZXh0dXJlLCBrZXkudGV4dHVyZUZyYW1lKTsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBrZXkudGV4dHVyZUZyYW1lOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUElYSS5UZXh0dXJlKQogICAgewogICAgICAgIFBJWEkuU3ByaXRlLmNhbGwodGhpcywga2V5KTsKCiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBmcmFtZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAoa2V5ID09PSBudWxsIHx8IHR5cGVvZiBrZXkgPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAga2V5ID0gJ19fZGVmYXVsdCc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJyAmJiB0aGlzLmdhbWUuY2FjaGUuY2hlY2tJbWFnZUtleShrZXkpID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAga2V5ID0gJ19fbWlzc2luZyc7CiAgICAgICAgICAgIHRoaXMua2V5ID0ga2V5OwogICAgICAgIH0KCiAgICAgICAgUElYSS5TcHJpdGUuY2FsbCh0aGlzLCBQSVhJLlRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5jYWNoZS5pc1Nwcml0ZVNoZWV0KGtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmFuaW1hdGlvbnMubG9hZEZyYW1lRGF0YSh0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWVEYXRhKGtleSkpOwoKICAgICAgICAgICAgaWYgKGZyYW1lICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IGZyYW1lOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuZnJhbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRGcmFtZShrZXkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogVGhlIHJlY3Rhbmd1bGFyIGFyZWEgZnJvbSB0aGUgdGV4dHVyZSB0aGF0IHdpbGwgYmUgcmVuZGVyZWQuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gdGV4dHVyZVJlZ2lvbgogICAgKi8KICAgIHRoaXMudGV4dHVyZVJlZ2lvbiA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHRoaXMudGV4dHVyZS5mcmFtZS54LCB0aGlzLnRleHR1cmUuZnJhbWUueSwgdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoLCB0aGlzLnRleHR1cmUuZnJhbWUuaGVpZ2h0KTsKCiAgICAvKioKICAgICogVGhlIGFuY2hvciBzZXRzIHRoZSBvcmlnaW4gcG9pbnQgb2YgdGhlIHRleHR1cmUuCiAgICAqIFRoZSBkZWZhdWx0IGlzIDAsMCB0aGlzIG1lYW5zIHRoZSB0ZXh0dXJlcyBvcmlnaW4gaXMgdGhlIHRvcCBsZWZ0IAogICAgKiBTZXR0aW5nIHRoYW4gYW5jaG9yIHRvIDAuNSwwLjUgbWVhbnMgdGhlIHRleHR1cmVzIG9yaWdpbiBpcyBjZW50ZXJlZAogICAgKiBTZXR0aW5nIHRoZSBhbmNob3IgdG8gMSwxIHdvdWxkIG1lYW4gdGhlIHRleHR1cmVzIG9yaWdpbiBwb2ludHMgd2lsbCBiZSB0aGUgYm90dG9tIHJpZ2h0CiAgICAqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhbmNob3IgLSBUaGUgYW5jaG9yIGFyb3VuZCB3aXRoIFNwcml0ZSByb3RhdGlvbiBhbmQgc2NhbGluZyB0YWtlcyBwbGFjZS4KICAgICovCiAgICB0aGlzLmFuY2hvciA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIChpbiB3b3JsZCBzcGFjZSkgb2YgdGhpcyBTcHJpdGUuCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIG9mIHRoaXMgU3ByaXRlLgogICAgKi8KICAgIHRoaXMueSA9IHk7CgoJdGhpcy5wb3NpdGlvbi54ID0geDsKCXRoaXMucG9zaXRpb24ueSA9IHk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB3b3JsZCAtIFRoZSB3b3JsZCBjb29yZGluYXRlcyBvZiB0aGlzIFNwcml0ZS4gVGhpcyBkaWZmZXJzIGZyb20gdGhlIHgveSBjb29yZGluYXRlcyB3aGljaCBhcmUgcmVsYXRpdmUgdG8gdGhlIFNwcml0ZXMgY29udGFpbmVyLgogICAgKi8KICAgIHRoaXMud29ybGQgPSBuZXcgUGhhc2VyLlBvaW50KHgsIHkpOwoKICAgIC8qKgogICAgKiBTaG91bGQgdGhpcyBTcHJpdGUgYmUgYXV0b21hdGljYWxseSBjdWxsZWQgaWYgb3V0IG9mIHJhbmdlIG9mIHRoZSBjYW1lcmE/CiAgICAqIEEgY3VsbGVkIHNwcml0ZSBoYXMgaXRzIHJlbmRlcmFibGUgcHJvcGVydHkgc2V0IHRvICdmYWxzZScuCiAgICAqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYXV0b0N1bGwgLSBBIGZsYWcgaW5kaWNhdGluZyBpZiB0aGUgU3ByaXRlIHNob3VsZCBiZSBhdXRvbWF0aWNhbGx5IGNhbWVyYSBjdWxsZWQgb3Igbm90LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYXV0b0N1bGwgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHNjYWxlIC0gVGhlIHNjYWxlIG9mIHRoZSBTcHJpdGUgd2hlbiByZW5kZXJlZC4gQnkgZGVmYXVsdCBpdCdzIHNldCB0byAxIChubyBzY2FsZSkuIFlvdSBjYW4gbW9kaWZ5IGl0IHZpYSBzY2FsZS54IG9yIHNjYWxlLnkgb3Igc2NhbGUuc2V0VG8oeCwgeSkuIEEgdmFsdWUgb2YgMSBtZWFucyBubyBjaGFuZ2UgdG8gdGhlIHNjYWxlLCAwLjUgbWVhbnMgImhhbGYgdGhlIHNpemUiLCAyIG1lYW5zICJ0d2ljZSB0aGUgc2l6ZSIsIGV0Yy4KICAgICovIAogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBfY2FjaGUgLSBBIG1pbmkgY2FjaGUgZm9yIHN0b3JpbmcgYWxsIG9mIHRoZSBjYWxjdWxhdGVkIHZhbHVlcy4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9jYWNoZSA9IHsgCgogICAgICAgIGRpcnR5OiBmYWxzZSwKCiAgICAgICAgLy8gIFRyYW5zZm9ybSBjYWNoZQogICAgICAgIGEwMDogLTEsIGEwMTogLTEsIGEwMjogLTEsIGExMDogLTEsIGExMTogLTEsIGExMjogLTEsIGlkOiAtMSwgCgogICAgICAgIC8vICBJbnB1dCBzcGVjaWZpYyB0cmFuc2Zvcm0gY2FjaGUKICAgICAgICBpMDE6IC0xLCBpMTA6IC0xLCBpZGk6IC0xLAoKICAgICAgICAvLyAgQm91bmRzIGNoZWNrCiAgICAgICAgbGVmdDogbnVsbCwgcmlnaHQ6IG51bGwsIHRvcDogbnVsbCwgYm90dG9tOiBudWxsLCAKCiAgICAgICAgLy8gIGRlbHRhIGNhY2hlCiAgICAgICAgcHJldlg6IHgsIHByZXZZOiB5LAoKICAgICAgICAvLyAgVGhlIHByZXZpb3VzIGNhbGN1bGF0ZWQgcG9zaXRpb24KICAgICAgICB4OiAtMSwgeTogLTEsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHNjYWxlIHZhbHVlcyBiYXNlZCBvbiB0aGUgd29ybGRUcmFuc2Zvcm0KICAgICAgICBzY2FsZVg6IDEsIHNjYWxlWTogMSwKCiAgICAgICAgLy8gIFRoZSB3aWR0aC9oZWlnaHQgb2YgdGhlIGltYWdlLCBiYXNlZCBvbiB0aGUgdW4tbW9kaWZpZWQgZnJhbWUgc2l6ZSBtdWx0aXBsaWVkIGJ5IHRoZSBmaW5hbCBjYWxjdWxhdGVkIHNjYWxlIHNpemUKICAgICAgICB3aWR0aDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVcsIGhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUgsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHdpZHRoL2hlaWdodCBvZiB0aGUgaW1hZ2UgaWYgZnJvbSBhIHRyaW1tZWQgYXRsYXMsIG11bHRpcGxpZWQgYnkgdGhlIGZpbmFsIGNhbGN1bGF0ZWQgc2NhbGUgc2l6ZQogICAgICAgIGhhbGZXaWR0aDogTWF0aC5mbG9vcih0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplVyAvIDIpLCBoYWxmSGVpZ2h0OiBNYXRoLmZsb29yKHRoaXMuY3VycmVudEZyYW1lLnNvdXJjZVNpemVIIC8gMiksCgogICAgICAgIC8vICBUaGUgd2lkdGgvaGVpZ2h0IG9mIHRoZSBpbWFnZSwgYmFzZWQgb24gdGhlIHVuLW1vZGlmaWVkIGZyYW1lIHNpemUgbXVsdGlwbGllZCBieSB0aGUgZmluYWwgY2FsY3VsYXRlZCBzY2FsZSBzaXplCiAgICAgICAgY2FsY1dpZHRoOiAtMSwgY2FsY0hlaWdodDogLTEsCgogICAgICAgIC8vICBUaGUgY3VycmVudCBmcmFtZSBkZXRhaWxzCiAgICAgICAgLy8gZnJhbWVJRDogdGhpcy5jdXJyZW50RnJhbWUudXVpZCwgZnJhbWVXaWR0aDogdGhpcy5jdXJyZW50RnJhbWUud2lkdGgsIGZyYW1lSGVpZ2h0OiB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQsCiAgICAgICAgZnJhbWVJRDogLTEsIGZyYW1lV2lkdGg6IHRoaXMuY3VycmVudEZyYW1lLndpZHRoLCBmcmFtZUhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuaGVpZ2h0LAoKICAgICAgICAvLyAgSWYgdGhpcyBzcHJpdGUgdmlzaWJsZSB0byB0aGUgY2FtZXJhIChyZWdhcmRsZXNzIG9mIGJlaW5nIHNldCB0byB2aXNpYmxlIG9yIG5vdCkKICAgICAgICBjYW1lcmFWaXNpYmxlOiB0cnVlLAoKICAgICAgICAvLyAgQ3JvcCBjYWNoZQogICAgICAgIGNyb3BYOiAwLCBjcm9wWTogMCwgY3JvcFdpZHRoOiB0aGlzLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplVywgY3JvcEhlaWdodDogdGhpcy5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUgKCiAgICB9OwogIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBvZmZzZXQgLSBDb3JuZXIgcG9pbnQgZGVmYXVsdHMuIFNob3VsZCBub3QgdHlwaWNhbGx5IGJlIG1vZGlmaWVkLgogICAgKi8gICAgCiAgICB0aGlzLm9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQ7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gY2VudGVyIC0gQSBQb2ludCBjb250YWluaW5nIHRoZSBjZW50ZXIgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMuY2VudGVyID0gbmV3IFBoYXNlci5Qb2ludCh4ICsgTWF0aC5mbG9vcih0aGlzLl9jYWNoZS53aWR0aCAvIDIpLCB5ICsgTWF0aC5mbG9vcih0aGlzLl9jYWNoZS5oZWlnaHQgLyAyKSk7CiAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB0b3BMZWZ0IC0gQSBQb2ludCBjb250YWluaW5nIHRoZSB0b3AgbGVmdCBjb29yZGluYXRlIG9mIHRoZSBTcHJpdGUuIFRha2VzIHJvdGF0aW9uIGFuZCBzY2FsZSBpbnRvIGFjY291bnQuCiAgICAqLwogICAgdGhpcy50b3BMZWZ0ID0gbmV3IFBoYXNlci5Qb2ludCh4LCB5KTsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB0b3BSaWdodCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgdG9wIHJpZ2h0IGNvb3JkaW5hdGUgb2YgdGhlIFNwcml0ZS4gVGFrZXMgcm90YXRpb24gYW5kIHNjYWxlIGludG8gYWNjb3VudC4KICAgICovCiAgICB0aGlzLnRvcFJpZ2h0ID0gbmV3IFBoYXNlci5Qb2ludCh4ICsgdGhpcy5fY2FjaGUud2lkdGgsIHkpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGJvdHRvbVJpZ2h0IC0gQSBQb2ludCBjb250YWluaW5nIHRoZSBib3R0b20gcmlnaHQgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMuYm90dG9tUmlnaHQgPSBuZXcgUGhhc2VyLlBvaW50KHggKyB0aGlzLl9jYWNoZS53aWR0aCwgeSArIHRoaXMuX2NhY2hlLmhlaWdodCk7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm90dG9tTGVmdCAtIEEgUG9pbnQgY29udGFpbmluZyB0aGUgYm90dG9tIGxlZnQgY29vcmRpbmF0ZSBvZiB0aGUgU3ByaXRlLiBUYWtlcyByb3RhdGlvbiBhbmQgc2NhbGUgaW50byBhY2NvdW50LgogICAgKi8KICAgIHRoaXMuYm90dG9tTGVmdCA9IG5ldyBQaGFzZXIuUG9pbnQoeCwgeSArIHRoaXMuX2NhY2hlLmhlaWdodCk7CiAgICAKICAgIC8qKgogICAgKiBUaGlzIFJlY3RhbmdsZSBvYmplY3QgZnVsbHkgZW5jb21wYXNzZXMgdGhlIFNwcml0ZSBhbmQgaXMgdXBkYXRlZCBpbiByZWFsLXRpbWUuCiAgICAqIFRoZSBib3VuZHMgaXMgdGhlIGZ1bGwgYm91bmRpbmcgYXJlYSBhZnRlciByb3RhdGlvbiBhbmQgc2NhbGUgaGF2ZSBiZWVuIHRha2VuIGludG8gYWNjb3VudC4gSXQgc2hvdWxkIG5vdCBiZSBtb2RpZmllZCBkaXJlY3RseS4KICAgICogSXQncyB1c2VkIGZvciBDYW1lcmEgY3VsbGluZyBhbmQgcGh5c2ljcyBib2R5IGFsaWdubWVudC4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBib3VuZHMKICAgICovCiAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKHgsIHksIHRoaXMuX2NhY2hlLndpZHRoLCB0aGlzLl9jYWNoZS5oZWlnaHQpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keSAtIEJ5IGRlZmF1bHQgU3ByaXRlcyBoYXZlIGEgUGhhc2VyLlBoeXNpY3MgQm9keSBhdHRhY2hlZCB0byB0aGVtLiBZb3UgY2FuIG9wZXJhdGUgcGh5c2ljcyBhY3Rpb25zIHZpYSB0aGlzIHByb3BlcnR5LCBvciBudWxsIGl0IHRvIHNraXAgYWxsIHBoeXNpY3MgdXBkYXRlcy4KICAgICovCiAgICB0aGlzLmJvZHkgPSBuZXcgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkodGhpcyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoZWFsdGggLSBIZWFsdGggdmFsdWUuIFVzZWQgaW4gY29tYmluYXRpb24gd2l0aCBkYW1hZ2UoKSB0byBhbGxvdyBmb3IgcXVpY2sga2lsbGluZyBvZiBTcHJpdGVzLgogICAgKi8gICAgCiAgICB0aGlzLmhlYWx0aCA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5Xb3JsZCAtIFRoaXMgdmFsdWUgaXMgc2V0IHRvIHRydWUgaWYgdGhlIFNwcml0ZSBpcyBwb3NpdGlvbmVkIHdpdGhpbiB0aGUgV29ybGQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICB0aGlzLmluV29ybGQgPSBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHModGhpcy5ib3VuZHMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMpOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGluV29ybGRUaHJlc2hvbGQgLSBBIHRocmVzaG9sZCB2YWx1ZSBhcHBsaWVkIHRvIHRoZSBpbldvcmxkIGNoZWNrLiBJZiB5b3UgZG9uJ3Qgd2FudCBhIFNwcml0ZSB0byBiZSBjb25zaWRlcmVkICJvdXQgb2YgdGhlIHdvcmxkIiB1bnRpbCBhdCBsZWFzdCAxMDBweCBhd2F5IGZvciBleGFtcGxlIHRoZW4gc2V0IGl0IHRvIDEwMC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmluV29ybGRUaHJlc2hvbGQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG91dE9mQm91bmRzS2lsbCAtIElmIHRydWUgdGhlIFNwcml0ZSBpcyBraWxsZWQgYXMgc29vbiBhcyBTcHJpdGUuaW5Xb3JsZCBpcyBmYWxzZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm91dE9mQm91bmRzS2lsbCA9IGZhbHNlOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfb3V0T2ZCb3VuZHNGaXJlZCAtIEludGVybmFsIGZsYWcuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBBIFNwcml0ZSB0aGF0IGlzIGZpeGVkIHRvIHRoZSBjYW1lcmEgaWdub3JlcyB0aGUgcG9zaXRpb24gb2YgYW55IGFuY2VzdG9ycyBpbiB0aGUgZGlzcGxheSBsaXN0IGFuZCB1c2VzIGl0cyB4L3kgY29vcmRpbmF0ZXMgYXMgb2Zmc2V0cyBmcm9tIHRoZSB0b3AgbGVmdCBvZiB0aGUgY2FtZXJhLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpeGVkVG9DYW1lcmEgLSBGaXhlcyB0aGlzIFNwcml0ZSB0byB0aGUgQ2FtZXJhLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZml4ZWRUb0NhbWVyYSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gY2FtZXJhT2Zmc2V0IC0gSWYgdGhpcyBTcHJpdGUgaXMgZml4ZWQgdG8gdGhlIGNhbWVyYSB0aGVuIHVzZSB0aGlzIFBvaW50IHRvIHNwZWNpZnkgaG93IGZhciBhd2F5IGZyb20gdGhlIENhbWVyYSB4L3kgaXQncyByZW5kZXJlZC4KICAgICovCiAgICB0aGlzLmNhbWVyYU9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgLyoqCiAgICAqIFlvdSBjYW4gY3JvcCB0aGUgU3ByaXRlcyB0ZXh0dXJlIGJ5IG1vZGlmeWluZyB0aGUgY3JvcCBwcm9wZXJ0aWVzLiBGb3IgZXhhbXBsZSBjcm9wLndpZHRoID0gNTAgd291bGQgc2V0IHRoZSBTcHJpdGUgdG8gb25seSByZW5kZXIgNTBweCB3aWRlLgogICAgKiBUaGUgY3JvcCBpcyBvbmx5IGFwcGxpZWQgaWYgeW91IGhhdmUgc2V0IFNwcml0ZS5jcm9wRW5hYmxlZCB0byB0cnVlLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGNyb3AgLSBUaGUgY3JvcCBSZWN0YW5nbGUgYXBwbGllZCB0byB0aGUgU3ByaXRlIHRleHR1cmUgYmVmb3JlIHJlbmRlcmluZy4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNyb3AgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgwLCAwLCB0aGlzLl9jYWNoZS53aWR0aCwgdGhpcy5fY2FjaGUuaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjcm9wRW5hYmxlZCAtIElmIHRydWUgdGhlIFNwcml0ZS5jcm9wIHByb3BlcnR5IGlzIHVzZWQgdG8gY3JvcCB0aGUgdGV4dHVyZSBiZWZvcmUgcmVuZGVyLiBTZXQgdG8gZmFsc2UgdG8gZGlzYWJsZS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNyb3BFbmFibGVkID0gZmFsc2U7CgogICAgdGhpcy51cGRhdGVDYWNoZSgpOwogICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKCn07CgovLyAgTmVlZGVkIHRvIGtlZXAgdGhlIFBJWEkuU3ByaXRlIGNvbnN0cnVjdG9yIGluIHRoZSBwcm90b3R5cGUgY2hhaW4gKGFzIHRoZSBjb3JlIHBpeGkgcmVuZGVyZXIgdXNlcyBhbiBpbnN0YW5jZW9mIGNoZWNrIHNhZGx5KQpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5TcHJpdGUucHJvdG90eXBlKTsKUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuU3ByaXRlOwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQucHJlVXBkYXRlLiBIYW5kbGVzIGNhY2hlIHVwZGF0ZXMsIGxpZmVzcGFuIGNoZWNrcywgYW5pbWF0aW9uIHVwZGF0ZXMgYW5kIHBoeXNpY3MgdXBkYXRlcy4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNwcmVVcGRhdGUKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5wcmVVcGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAoIXRoaXMuZXhpc3RzIHx8ICh0aGlzLmdyb3VwICYmICF0aGlzLmdyb3VwLmV4aXN0cykpCiAgICB7CiAgICAgICAgdGhpcy5yZW5kZXJPcmRlcklEID0gLTE7CiAgICAgICAgCiAgICAgICAgLy8gU2tpcCBjaGlsZHJlbiBpZiBub3QgZXhpc3RzCiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIGlmICh0aGlzLmxpZmVzcGFuID4gMCkKICAgIHsKICAgICAgICB0aGlzLmxpZmVzcGFuIC09IHRoaXMuZ2FtZS50aW1lLmVsYXBzZWQ7CgogICAgICAgIGlmICh0aGlzLmxpZmVzcGFuIDw9IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmtpbGwoKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IGZhbHNlOwoKICAgIGlmICh0aGlzLnZpc2libGUpCiAgICB7CiAgICAgICAgdGhpcy5yZW5kZXJPcmRlcklEID0gdGhpcy5nYW1lLndvcmxkLmN1cnJlbnRSZW5kZXJPcmRlcklEKys7CiAgICB9CgogICAgdGhpcy51cGRhdGVDYWNoZSgpOwoKICAgIHRoaXMudXBkYXRlQW5pbWF0aW9uKCk7CgogICAgdGhpcy51cGRhdGVDcm9wKCk7CgogICAgLy8gIFJlLXJ1biB0aGUgY2FtZXJhIHZpc2liaWxpdHkgY2hlY2sKICAgIGlmICh0aGlzLl9jYWNoZS5kaXJ0eSB8fCB0aGlzLndvcmxkLnggIT09IHRoaXMuX2NhY2hlLnByZXZYIHx8IHRoaXMud29ybGQueSAhPT0gdGhpcy5fY2FjaGUucHJldlkpCiAgICB7CiAgICAgICAgdGhpcy51cGRhdGVCb3VuZHMoKTsKICAgIH0KCiAgICBpZiAodGhpcy5ib2R5KQogICAgewogICAgICAgIHRoaXMuYm9keS5wcmVVcGRhdGUoKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgcHJlVXBkYXRlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3VwZGF0ZUNhY2hlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUudXBkYXRlQ2FjaGUgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLl9jYWNoZS5wcmV2WCA9IHRoaXMud29ybGQueDsKICAgIHRoaXMuX2NhY2hlLnByZXZZID0gdGhpcy53b3JsZC55OwoKICAgIGlmICh0aGlzLmZpeGVkVG9DYW1lcmEpCiAgICB7CiAgICAgICAgdGhpcy54ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLmNhbWVyYU9mZnNldC54OwogICAgICAgIHRoaXMueSA9IHRoaXMuZ2FtZS5jYW1lcmEudmlldy55ICsgdGhpcy5jYW1lcmFPZmZzZXQueTsKICAgIH0KCiAgICB0aGlzLndvcmxkLnNldFRvKHRoaXMuZ2FtZS5jYW1lcmEueCArIHRoaXMud29ybGRUcmFuc2Zvcm1bMl0sIHRoaXMuZ2FtZS5jYW1lcmEueSArIHRoaXMud29ybGRUcmFuc2Zvcm1bNV0pOwoKICAgIGlmICh0aGlzLndvcmxkVHJhbnNmb3JtWzFdICE9IHRoaXMuX2NhY2hlLmkwMSB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzNdICE9IHRoaXMuX2NhY2hlLmkxMCB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzBdICE9IHRoaXMuX2NhY2hlLmEwMCB8fCB0aGlzLndvcmxkVHJhbnNmb3JtWzQxXSAhPSB0aGlzLl9jYWNoZS5hMTEpCiAgICB7CiAgICAgICAgdGhpcy5fY2FjaGUuYTAwID0gdGhpcy53b3JsZFRyYW5zZm9ybVswXTsgIC8vICBzY2FsZVggICAgICAgICBhICAgICB8YSBjIHR4fAogICAgICAgIHRoaXMuX2NhY2hlLmEwMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMV07ICAvLyAgc2tld1kgICAgICAgICAgYyAgICAgfGIgZCB0eXwKICAgICAgICB0aGlzLl9jYWNoZS5hMTAgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzNdOyAgLy8gIHNrZXdYICAgICAgICAgIGIgICAgIHwwIDAgIDF8CiAgICAgICAgdGhpcy5fY2FjaGUuYTExID0gdGhpcy53b3JsZFRyYW5zZm9ybVs0XTsgIC8vICBzY2FsZVkgICAgICAgICBkCgogICAgICAgIHRoaXMuX2NhY2hlLmkwMSA9IHRoaXMud29ybGRUcmFuc2Zvcm1bMV07ICAvLyAgc2tld1kgICAgICAgICAgYyAocmVtYWlucyBub24tbW9kaWZpZWQgZm9yIGlucHV0IGNoZWNrcykKICAgICAgICB0aGlzLl9jYWNoZS5pMTAgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzNdOyAgLy8gIHNrZXdYICAgICAgICAgIGIgKHJlbWFpbnMgbm9uLW1vZGlmaWVkIGZvciBpbnB1dCBjaGVja3MpCgogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWCA9IE1hdGguc3FydCgodGhpcy5fY2FjaGUuYTAwICogdGhpcy5fY2FjaGUuYTAwKSArICh0aGlzLl9jYWNoZS5hMDEgKiB0aGlzLl9jYWNoZS5hMDEpKTsgLy8gcm91bmQgdGhpcyBvZmYgYSBiaXQ/CiAgICAgICAgdGhpcy5fY2FjaGUuc2NhbGVZID0gTWF0aC5zcXJ0KCh0aGlzLl9jYWNoZS5hMTAgKiB0aGlzLl9jYWNoZS5hMTApICsgKHRoaXMuX2NhY2hlLmExMSAqIHRoaXMuX2NhY2hlLmExMSkpOyAvLyByb3VuZCB0aGlzIG9mZiBhIGJpdD8KCiAgICAgICAgdGhpcy5fY2FjaGUuYTAxICo9IC0xOwogICAgICAgIHRoaXMuX2NhY2hlLmExMCAqPSAtMTsKCiAgICAgICAgdGhpcy5fY2FjaGUuaWQgPSAxIC8gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmExMSArIHRoaXMuX2NhY2hlLmEwMSAqIC10aGlzLl9jYWNoZS5hMTApOwogICAgICAgIHRoaXMuX2NhY2hlLmlkaSA9IDEgLyAodGhpcy5fY2FjaGUuYTAwICogdGhpcy5fY2FjaGUuYTExICsgdGhpcy5fY2FjaGUuaTAxICogLXRoaXMuX2NhY2hlLmkxMCk7CgogICAgICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLl9jYWNoZS5hMDIgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzJdOyAgLy8gIHRyYW5zbGF0ZVggICAgIHR4CiAgICB0aGlzLl9jYWNoZS5hMTIgPSB0aGlzLndvcmxkVHJhbnNmb3JtWzVdOyAgLy8gIHRyYW5zbGF0ZVkgICAgIHR5Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVBbmltYXRpb24KKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVBbmltYXRpb24gPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5hbmltYXRpb25zLnVwZGF0ZSgpIHx8ICh0aGlzLmN1cnJlbnRGcmFtZSAmJiB0aGlzLmN1cnJlbnRGcmFtZS51dWlkICE9IHRoaXMuX2NhY2hlLmZyYW1lSUQpKQogICAgewogICAgICAgIHRoaXMuX2NhY2hlLmZyYW1lSUQgPSB0aGlzLmN1cnJlbnRGcmFtZS51dWlkOwoKICAgICAgICB0aGlzLl9jYWNoZS5mcmFtZVdpZHRoID0gdGhpcy50ZXh0dXJlLmZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuX2NhY2hlLmZyYW1lSGVpZ2h0ID0gdGhpcy50ZXh0dXJlLmZyYW1lLmhlaWdodDsKCiAgICAgICAgdGhpcy5fY2FjaGUud2lkdGggPSB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5oZWlnaHQgPSB0aGlzLmN1cnJlbnRGcmFtZS5oZWlnaHQ7CgogICAgICAgIHRoaXMuX2NhY2hlLmhhbGZXaWR0aCA9IE1hdGguZmxvb3IodGhpcy5fY2FjaGUud2lkdGggLyAyKTsKICAgICAgICB0aGlzLl9jYWNoZS5oYWxmSGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLl9jYWNoZS5oZWlnaHQgLyAyKTsKCiAgICAgICAgdGhpcy5fY2FjaGUuZGlydHkgPSB0cnVlOwoKICAgIH0KCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgcHJlVXBkYXRlLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3VwZGF0ZUNyb3AKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVDcm9wID0gZnVuY3Rpb24oKSB7CgogICAgLy8gIFRoaXMgb25seSBydW5zIGlmIGNyb3AgaXMgZW5hYmxlZAogICAgaWYgKHRoaXMuY3JvcEVuYWJsZWQgJiYgKHRoaXMuY3JvcC53aWR0aCAhPSB0aGlzLl9jYWNoZS5jcm9wV2lkdGggfHwgdGhpcy5jcm9wLmhlaWdodCAhPSB0aGlzLl9jYWNoZS5jcm9wSGVpZ2h0IHx8IHRoaXMuY3JvcC54ICE9IHRoaXMuX2NhY2hlLmNyb3BYIHx8IHRoaXMuY3JvcC55ICE9IHRoaXMuX2NhY2hlLmNyb3BZKSkKICAgIHsKICAgICAgICB0aGlzLmNyb3AuZmxvb3JBbGwoKTsKCiAgICAgICAgdGhpcy5fY2FjaGUuY3JvcFggPSB0aGlzLmNyb3AueDsKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wWSA9IHRoaXMuY3JvcC55OwogICAgICAgIHRoaXMuX2NhY2hlLmNyb3BXaWR0aCA9IHRoaXMuY3JvcC53aWR0aDsKICAgICAgICB0aGlzLl9jYWNoZS5jcm9wSGVpZ2h0ID0gdGhpcy5jcm9wLmhlaWdodDsKCiAgICAgICAgdGhpcy50ZXh0dXJlLmZyYW1lID0gdGhpcy5jcm9wOwogICAgICAgIHRoaXMudGV4dHVyZS53aWR0aCA9IHRoaXMuY3JvcC53aWR0aDsKICAgICAgICB0aGlzLnRleHR1cmUuaGVpZ2h0ID0gdGhpcy5jcm9wLmhlaWdodDsKCiAgICAgICAgdGhpcy50ZXh0dXJlLnVwZGF0ZUZyYW1lID0gdHJ1ZTsKCiAgICAgICAgUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5wdXNoKHRoaXMudGV4dHVyZSk7CiAgICB9Cgp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gY2FsbGVkIGJ5IHByZVVwZGF0ZS4KKgoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSN1cGRhdGVCb3VuZHMKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS51cGRhdGVCb3VuZHMgPSBmdW5jdGlvbigpIHsKCiAgICB0aGlzLm9mZnNldC5zZXRUbyh0aGlzLl9jYWNoZS5hMDIgLSAodGhpcy5hbmNob3IueCAqIHRoaXMud2lkdGgpLCB0aGlzLl9jYWNoZS5hMTIgLSAodGhpcy5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSk7CgogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMuY2VudGVyLCB0aGlzLm9mZnNldC54ICsgKHRoaXMud2lkdGggLyAyKSwgdGhpcy5vZmZzZXQueSArICh0aGlzLmhlaWdodCAvIDIpKTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLnRvcExlZnQsIHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnkpOwogICAgdGhpcy5nZXRMb2NhbFBvc2l0aW9uKHRoaXMudG9wUmlnaHQsIHRoaXMub2Zmc2V0LnggKyB0aGlzLndpZHRoLCB0aGlzLm9mZnNldC55KTsKICAgIHRoaXMuZ2V0TG9jYWxQb3NpdGlvbih0aGlzLmJvdHRvbUxlZnQsIHRoaXMub2Zmc2V0LngsIHRoaXMub2Zmc2V0LnkgKyB0aGlzLmhlaWdodCk7CiAgICB0aGlzLmdldExvY2FsUG9zaXRpb24odGhpcy5ib3R0b21SaWdodCwgdGhpcy5vZmZzZXQueCArIHRoaXMud2lkdGgsIHRoaXMub2Zmc2V0LnkgKyB0aGlzLmhlaWdodCk7CgogICAgdGhpcy5fY2FjaGUubGVmdCA9IFBoYXNlci5NYXRoLm1pbih0aGlzLnRvcExlZnQueCwgdGhpcy50b3BSaWdodC54LCB0aGlzLmJvdHRvbUxlZnQueCwgdGhpcy5ib3R0b21SaWdodC54KTsKICAgIHRoaXMuX2NhY2hlLnJpZ2h0ID0gUGhhc2VyLk1hdGgubWF4KHRoaXMudG9wTGVmdC54LCB0aGlzLnRvcFJpZ2h0LngsIHRoaXMuYm90dG9tTGVmdC54LCB0aGlzLmJvdHRvbVJpZ2h0LngpOwogICAgdGhpcy5fY2FjaGUudG9wID0gUGhhc2VyLk1hdGgubWluKHRoaXMudG9wTGVmdC55LCB0aGlzLnRvcFJpZ2h0LnksIHRoaXMuYm90dG9tTGVmdC55LCB0aGlzLmJvdHRvbVJpZ2h0LnkpOwogICAgdGhpcy5fY2FjaGUuYm90dG9tID0gUGhhc2VyLk1hdGgubWF4KHRoaXMudG9wTGVmdC55LCB0aGlzLnRvcFJpZ2h0LnksIHRoaXMuYm90dG9tTGVmdC55LCB0aGlzLmJvdHRvbVJpZ2h0LnkpOwoKICAgIHRoaXMuYm91bmRzLnNldFRvKHRoaXMuX2NhY2hlLmxlZnQsIHRoaXMuX2NhY2hlLnRvcCwgdGhpcy5fY2FjaGUucmlnaHQgLSB0aGlzLl9jYWNoZS5sZWZ0LCB0aGlzLl9jYWNoZS5ib3R0b20gLSB0aGlzLl9jYWNoZS50b3ApOwoKICAgIHRoaXMudXBkYXRlRnJhbWUgPSB0cnVlOwoKICAgIGlmICh0aGlzLmluV29ybGQgPT0gZmFsc2UpCiAgICB7CiAgICAgICAgLy8gIFNwcml0ZSBXQVMgb3V0IG9mIHRoZSBzY3JlZW4sIGlzIGl0IHN0aWxsPwogICAgICAgIHRoaXMuaW5Xb3JsZCA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmJvdW5kcywgdGhpcy5nYW1lLndvcmxkLmJvdW5kcywgdGhpcy5pbldvcmxkVGhyZXNob2xkKTsKCiAgICAgICAgaWYgKHRoaXMuaW5Xb3JsZCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJdCdzIGJhY2sgYWdhaW4sIHJlc2V0IHRoZSBPT0IgY2hlY2sKICAgICAgICAgICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICAvLyAgIFNwcml0ZSBXQVMgaW4gdGhlIHNjcmVlbiwgaGFzIGl0IG5vdyBsZWZ0PwogICAgICAgIHRoaXMuaW5Xb3JsZCA9IFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLmJvdW5kcywgdGhpcy5nYW1lLndvcmxkLmJvdW5kcywgdGhpcy5pbldvcmxkVGhyZXNob2xkKTsKCiAgICAgICAgaWYgKHRoaXMuaW5Xb3JsZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZXZlbnRzLm9uT3V0T2ZCb3VuZHMuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgIHRoaXMuX291dE9mQm91bmRzRmlyZWQgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKHRoaXMub3V0T2ZCb3VuZHNLaWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmtpbGwoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB0aGlzLl9jYWNoZS5jYW1lcmFWaXNpYmxlID0gUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKHRoaXMuZ2FtZS53b3JsZC5jYW1lcmEuc2NyZWVuVmlldywgdGhpcy5ib3VuZHMsIDApOwoKICAgIGlmICh0aGlzLmF1dG9DdWxsKQogICAgewogICAgICAgIC8vICBXb24ndCBnZXQgcmVuZGVyZWQgYnV0IHdpbGwgc3RpbGwgZ2V0IGl0cyB0cmFuc2Zvcm0gdXBkYXRlZAogICAgICAgIHRoaXMucmVuZGVyYWJsZSA9IHRoaXMuX2NhY2hlLmNhbWVyYVZpc2libGU7CiAgICB9CgogICAgLy8gIFVwZGF0ZSBvdXIgcGh5c2ljcyBib3VuZHMKICAgIGlmICh0aGlzLmJvZHkpCiAgICB7CiAgICAgICAgdGhpcy5ib2R5LnVwZGF0ZUJvdW5kcyh0aGlzLmNlbnRlci54LCB0aGlzLmNlbnRlci55LCB0aGlzLl9jYWNoZS5zY2FsZVgsIHRoaXMuX2NhY2hlLnNjYWxlWSk7CiAgICB9Cgp9OwoKLyoqCiogR2V0cyB0aGUgbG9jYWwgcG9zaXRpb24gb2YgYSBjb29yZGluYXRlIHJlbGF0aXZlIHRvIHRoZSBTcHJpdGUsIGZhY3RvcmluZyBpbiByb3RhdGlvbiBhbmQgc2NhbGUuCiogTW9zdGx5IG9ubHkgdXNlZCBpbnRlcm5hbGx5LgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNnZXRMb2NhbFBvc2l0aW9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcCAtIFRoZSBQb2ludCBvYmplY3QgdG8gc3RvcmUgdGhlIHJlc3VsdHMgaW4uCiogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBTcHJpdGUgdG8gdHJhbnNsYXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0geCBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcGFyYW0ge251bWJlcn0gc3ggLSBTY2FsZSBmYWN0b3IgdG8gYmUgYXBwbGllZC4KKiBAcGFyYW0ge251bWJlcn0gc3kgLSBTY2FsZSBmYWN0b3IgdG8gYmUgYXBwbGllZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSB0cmFuc2xhdGVkIHBvaW50LgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5nZXRMb2NhbFBvc2l0aW9uID0gZnVuY3Rpb24ocCwgeCwgeSkgewoKICAgIHAueCA9ICgodGhpcy5fY2FjaGUuYTExICogdGhpcy5fY2FjaGUuaWQgKiB4ICsgLXRoaXMuX2NhY2hlLmEwMSAqIHRoaXMuX2NhY2hlLmlkICogeSArICh0aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5hMDEgLSB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5hMTEpICogdGhpcy5fY2FjaGUuaWQpICogdGhpcy5zY2FsZS54KSArIHRoaXMuX2NhY2hlLmEwMjsKICAgIHAueSA9ICgodGhpcy5fY2FjaGUuYTAwICogdGhpcy5fY2FjaGUuaWQgKiB5ICsgLXRoaXMuX2NhY2hlLmExMCAqIHRoaXMuX2NhY2hlLmlkICogeCArICgtdGhpcy5fY2FjaGUuYTEyICogdGhpcy5fY2FjaGUuYTAwICsgdGhpcy5fY2FjaGUuYTAyICogdGhpcy5fY2FjaGUuYTEwKSAqIHRoaXMuX2NhY2hlLmlkKSAqIHRoaXMuc2NhbGUueSkgKyB0aGlzLl9jYWNoZS5hMTI7CgogICAgcmV0dXJuIHA7Cgp9OwoKLyoqCiogR2V0cyB0aGUgbG9jYWwgdW5tb2RpZmllZCBwb3NpdGlvbiBvZiBhIGNvb3JkaW5hdGUgcmVsYXRpdmUgdG8gdGhlIFNwcml0ZSwgZmFjdG9yaW5nIGluIHJvdGF0aW9uIGFuZCBzY2FsZS4KKiBNb3N0bHkgb25seSB1c2VkIGludGVybmFsbHkgYnkgdGhlIElucHV0IE1hbmFnZXIsIGJ1dCBhbHNvIHVzZWZ1bCBmb3IgY3VzdG9tIGhpdCBkZXRlY3Rpb24uCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2dldExvY2FsVW5tb2RpZmllZFBvc2l0aW9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcCAtIFRoZSBQb2ludCBvYmplY3QgdG8gc3RvcmUgdGhlIHJlc3VsdHMgaW4uCiogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgd2l0aGluIHRoZSBTcHJpdGUgdG8gdHJhbnNsYXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0geCBjb29yZGluYXRlIHdpdGhpbiB0aGUgU3ByaXRlIHRvIHRyYW5zbGF0ZS4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSB0cmFuc2xhdGVkIHBvaW50LgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5nZXRMb2NhbFVubW9kaWZpZWRQb3NpdGlvbiA9IGZ1bmN0aW9uKHAsIGd4LCBneSkgewoKICAgIHAueCA9ICh0aGlzLl9jYWNoZS5hMTEgKiB0aGlzLl9jYWNoZS5pZGkgKiBneCArIC10aGlzLl9jYWNoZS5pMDEgKiB0aGlzLl9jYWNoZS5pZGkgKiBneSArICh0aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5pMDEgLSB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5hMTEpICogdGhpcy5fY2FjaGUuaWRpKSArICh0aGlzLmFuY2hvci54ICogdGhpcy5fY2FjaGUud2lkdGgpOwogICAgcC55ID0gKHRoaXMuX2NhY2hlLmEwMCAqIHRoaXMuX2NhY2hlLmlkaSAqIGd5ICsgLXRoaXMuX2NhY2hlLmkxMCAqIHRoaXMuX2NhY2hlLmlkaSAqIGd4ICsgKC10aGlzLl9jYWNoZS5hMTIgKiB0aGlzLl9jYWNoZS5hMDAgKyB0aGlzLl9jYWNoZS5hMDIgKiB0aGlzLl9jYWNoZS5pMTApICogdGhpcy5fY2FjaGUuaWRpKSArICh0aGlzLmFuY2hvci55ICogdGhpcy5fY2FjaGUuaGVpZ2h0KTsKCiAgICByZXR1cm4gcDsKCn07CgovKioKKiBSZXNldHMgdGhlIFNwcml0ZS5jcm9wIHZhbHVlIGJhY2sgdG8gdGhlIGZyYW1lIGRpbWVuc2lvbnMuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcmVzZXRDcm9wCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUucmVzZXRDcm9wID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgdGhpcy5fY2FjaGUud2lkdGgsIHRoaXMuX2NhY2hlLmhlaWdodCk7CiAgICB0aGlzLnRleHR1cmUuc2V0RnJhbWUodGhpcy5jcm9wKTsKICAgIHRoaXMuY3JvcEVuYWJsZWQgPSBmYWxzZTsKCn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIFdvcmxkIHBvc3RVcGRhdGUgY3ljbGUuCioKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjcG9zdFVwZGF0ZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLnBvc3RVcGRhdGUgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5rZXkgaW5zdGFuY2VvZiBQaGFzZXIuQml0bWFwRGF0YSAmJiB0aGlzLmtleS5fZGlydHkpCiAgICB7CiAgICAgICAgdGhpcy5rZXkucmVuZGVyKCk7CiAgICB9CgogICAgaWYgKHRoaXMuZXhpc3RzKQogICAgewogICAgICAgIC8vICBUaGUgc3ByaXRlIGlzIHBvc2l0aW9uZWQgaW4gdGhpcyBjYWxsLCBhZnRlciB0YWtpbmcgaW50byBjb25zaWRlcmF0aW9uIG1vdGlvbiB1cGRhdGVzIGFuZCBjb2xsaXNpb24KICAgICAgICBpZiAodGhpcy5ib2R5KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5ib2R5LnBvc3RVcGRhdGUoKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmZpeGVkVG9DYW1lcmEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnggKyB0aGlzLmNhbWVyYU9mZnNldC54OwogICAgICAgICAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy5nYW1lLmNhbWVyYS52aWV3LnkgKyB0aGlzLmNhbWVyYU9mZnNldC55OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy54OwogICAgICAgICAgICB0aGlzLl9jYWNoZS55ID0gdGhpcy55OwogICAgICAgIH0KCiAgICAgICAgdGhpcy53b3JsZC5zZXRUbyh0aGlzLmdhbWUuY2FtZXJhLnggKyB0aGlzLndvcmxkVHJhbnNmb3JtWzJdLCB0aGlzLmdhbWUuY2FtZXJhLnkgKyB0aGlzLndvcmxkVHJhbnNmb3JtWzVdKTsKCiAgICAgICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy5fY2FjaGUueDsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLl9jYWNoZS55OwogICAgfQoKfTsKCi8qKgoqIENoYW5nZXMgdGhlIFRleHR1cmUgdGhlIFNwcml0ZSBpcyB1c2luZyBlbnRpcmVseS4gVGhlIG9sZCB0ZXh0dXJlIGlzIHJlbW92ZWQgYW5kIHRoZSBuZXcgb25lIGlzIHJlZmVyZW5jZWQgb3IgZmV0Y2hlZCBmcm9tIHRoZSBDYWNoZS4KKiBUaGlzIGNhdXNlcyBhIFdlYkdMIHRleHR1cmUgdXBkYXRlLCBzbyB1c2Ugc3BhcmluZ2x5IG9yIGluIGxvdy1pbnRlbnNpdHkgcG9ydGlvbnMgb2YgeW91ciBnYW1lLgoqCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2xvYWRUZXh0dXJlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge3N0cmluZ3xQaGFzZXIuUmVuZGVyVGV4dHVyZXxQaGFzZXIuQml0bWFwRGF0YXxQSVhJLlRleHR1cmV9IGtleSAtIFRoaXMgaXMgdGhlIGltYWdlIG9yIHRleHR1cmUgdXNlZCBieSB0aGUgU3ByaXRlIGR1cmluZyByZW5kZXJpbmcuIEl0IGNhbiBiZSBhIHN0cmluZyB3aGljaCBpcyBhIHJlZmVyZW5jZSB0byB0aGUgQ2FjaGUgZW50cnksIG9yIGFuIGluc3RhbmNlIG9mIGEgUmVuZGVyVGV4dHVyZSwgQml0bWFwRGF0YSBvciBQSVhJLlRleHR1cmUuCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBmcmFtZSAtIElmIHRoaXMgU3ByaXRlIGlzIHVzaW5nIHBhcnQgb2YgYSBzcHJpdGUgc2hlZXQgb3IgdGV4dHVyZSBhdGxhcyB5b3UgY2FuIHNwZWNpZnkgdGhlIGV4YWN0IGZyYW1lIHRvIHVzZSBieSBnaXZpbmcgYSBzdHJpbmcgb3IgbnVtZXJpYyBpbmRleC4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUubG9hZFRleHR1cmUgPSBmdW5jdGlvbiAoa2V5LCBmcmFtZSkgewoKICAgIHRoaXMua2V5ID0ga2V5OwoKICAgIGlmIChrZXkgaW5zdGFuY2VvZiBQaGFzZXIuUmVuZGVyVGV4dHVyZSkKICAgIHsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRUZXh0dXJlRnJhbWUoa2V5Lm5hbWUpOwogICAgfQogICAgZWxzZSBpZiAoa2V5IGluc3RhbmNlb2YgUGhhc2VyLkJpdG1hcERhdGEpCiAgICB7CiAgICAgICAgdGhpcy5zZXRUZXh0dXJlKGtleS50ZXh0dXJlKTsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IGtleS50ZXh0dXJlRnJhbWU7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgaW5zdGFuY2VvZiBQSVhJLlRleHR1cmUpCiAgICB7CiAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSBmcmFtZTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3VuZGVmaW5lZCcgfHwgdGhpcy5nYW1lLmNhY2hlLmNoZWNrSW1hZ2VLZXkoa2V5KSA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICBrZXkgPSAnX19kZWZhdWx0JzsKICAgICAgICAgICAgdGhpcy5rZXkgPSBrZXk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmlzU3ByaXRlU2hlZXQoa2V5KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuYW5pbWF0aW9ucy5sb2FkRnJhbWVEYXRhKHRoaXMuZ2FtZS5jYWNoZS5nZXRGcmFtZURhdGEoa2V5KSk7CgogICAgICAgICAgICBpZiAodHlwZW9mIGZyYW1lICE9PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSBmcmFtZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gZnJhbWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0RnJhbWUoa2V5KTsKICAgICAgICAgICAgdGhpcy5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW2tleV0pOwogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBNb3ZlcyB0aGUgc3ByaXRlIHNvIGl0cyBjZW50ZXIgaXMgbG9jYXRlZCBvbiB0aGUgZ2l2ZW4geCBhbmQgeSBjb29yZGluYXRlcy4KKiBEb2Vzbid0IGNoYW5nZSB0aGUgYW5jaG9yIHBvaW50IG9mIHRoZSBzcHJpdGUuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2NlbnRlck9uCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUuY2VudGVyT24gPSBmdW5jdGlvbih4LCB5KSB7CgogICAgdGhpcy54ID0geCArICh0aGlzLnggLSB0aGlzLmNlbnRlci54KTsKICAgIHRoaXMueSA9IHkgKyAodGhpcy55IC0gdGhpcy5jZW50ZXIueSk7CiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBCcmluZ3MgYSAnZGVhZCcgU3ByaXRlIGJhY2sgdG8gbGlmZSwgb3B0aW9uYWxseSBnaXZpbmcgaXQgdGhlIGhlYWx0aCB2YWx1ZSBzcGVjaWZpZWQuCiogQSByZXN1cnJlY3RlZCBTcHJpdGUgaGFzIGl0cyBhbGl2ZSwgZXhpc3RzIGFuZCB2aXNpYmxlIHByb3BlcnRpZXMgYWxsIHNldCB0byB0cnVlLgoqIEl0IHdpbGwgZGlzcGF0Y2ggdGhlIG9uUmV2aXZlZCBldmVudCwgeW91IGNhbiBsaXN0ZW4gdG8gU3ByaXRlLmV2ZW50cy5vblJldml2ZWQgZm9yIHRoZSBzaWduYWwuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Jldml2ZQoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHBhcmFtIHtudW1iZXJ9IFtoZWFsdGg9MV0gLSBUaGUgaGVhbHRoIHRvIGdpdmUgdGhlIFNwcml0ZS4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5yZXZpdmUgPSBmdW5jdGlvbihoZWFsdGgpIHsKCiAgICBpZiAodHlwZW9mIGhlYWx0aCA9PT0gJ3VuZGVmaW5lZCcpIHsgaGVhbHRoID0gMTsgfQoKICAgIHRoaXMuYWxpdmUgPSB0cnVlOwogICAgdGhpcy5leGlzdHMgPSB0cnVlOwogICAgdGhpcy52aXNpYmxlID0gdHJ1ZTsKICAgIHRoaXMuaGVhbHRoID0gaGVhbHRoOwoKICAgIGlmICh0aGlzLmV2ZW50cykKICAgIHsKICAgICAgICB0aGlzLmV2ZW50cy5vblJldml2ZWQuZGlzcGF0Y2godGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogS2lsbHMgYSBTcHJpdGUuIEEga2lsbGVkIFNwcml0ZSBoYXMgaXRzIGFsaXZlLCBleGlzdHMgYW5kIHZpc2libGUgcHJvcGVydGllcyBhbGwgc2V0IHRvIGZhbHNlLgoqIEl0IHdpbGwgZGlzcGF0Y2ggdGhlIG9uS2lsbGVkIGV2ZW50LCB5b3UgY2FuIGxpc3RlbiB0byBTcHJpdGUuZXZlbnRzLm9uS2lsbGVkIGZvciB0aGUgc2lnbmFsLgoqIE5vdGUgdGhhdCBraWxsaW5nIGEgU3ByaXRlIGlzIGEgd2F5IGZvciB5b3UgdG8gcXVpY2tseSByZWN5Y2xlIGl0IGluIGEgU3ByaXRlIHBvb2wsIGl0IGRvZXNuJ3QgZnJlZSBpdCB1cCBmcm9tIG1lbW9yeS4KKiBJZiB5b3UgZG9uJ3QgbmVlZCB0aGlzIFNwcml0ZSBhbnkgbW9yZSB5b3Ugc2hvdWxkIGNhbGwgU3ByaXRlLmRlc3Ryb3kgaW5zdGVhZC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUja2lsbAoqIEBtZW1iZXJvZiBQaGFzZXIuU3ByaXRlCiogQHJldHVybiAoUGhhc2VyLlNwcml0ZSkgVGhpcyBpbnN0YW5jZS4KKi8KUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUua2lsbCA9IGZ1bmN0aW9uKCkgewoKICAgIHRoaXMuYWxpdmUgPSBmYWxzZTsKICAgIHRoaXMuZXhpc3RzID0gZmFsc2U7CiAgICB0aGlzLnZpc2libGUgPSBmYWxzZTsKCiAgICBpZiAodGhpcy5ldmVudHMpCiAgICB7CiAgICAgICAgdGhpcy5ldmVudHMub25LaWxsZWQuZGlzcGF0Y2godGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogRGVzdHJveXMgdGhlIFNwcml0ZS4gVGhpcyByZW1vdmVzIGl0IGZyb20gaXRzIHBhcmVudCBncm91cCwgZGVzdHJveXMgdGhlIGlucHV0LCBldmVudCBhbmQgYW5pbWF0aW9uIGhhbmRsZXJzIGlmIHByZXNlbnQKKiBhbmQgbnVsbHMgaXRzIHJlZmVyZW5jZSB0byBnYW1lLCBmcmVlaW5nIGl0IHVwIGZvciBnYXJiYWdlIGNvbGxlY3Rpb24uCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2Rlc3Ryb3kKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKHRoaXMuZ3JvdXApCiAgICB7CiAgICAgICAgdGhpcy5ncm91cC5yZW1vdmUodGhpcyk7CiAgICB9CgogICAgaWYgKHRoaXMuaW5wdXQpCiAgICB7CiAgICAgICAgdGhpcy5pbnB1dC5kZXN0cm95KCk7CiAgICB9CgogICAgaWYgKHRoaXMuZXZlbnRzKQogICAgewogICAgICAgIHRoaXMuZXZlbnRzLmRlc3Ryb3koKTsKICAgIH0KCiAgICBpZiAodGhpcy5hbmltYXRpb25zKQogICAgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5kZXN0cm95KCk7CiAgICB9CgogICAgdGhpcy5hbGl2ZSA9IGZhbHNlOwogICAgdGhpcy5leGlzdHMgPSBmYWxzZTsKICAgIHRoaXMudmlzaWJsZSA9IGZhbHNlOwoKICAgIHRoaXMuZ2FtZSA9IG51bGw7Cgp9OwoKLyoqCiogRGFtYWdlcyB0aGUgU3ByaXRlLCB0aGlzIHJlbW92ZXMgdGhlIGdpdmVuIGFtb3VudCBmcm9tIHRoZSBTcHJpdGVzIGhlYWx0aCBwcm9wZXJ0eS4KKiBJZiBoZWFsdGggaXMgdGhlbiB0YWtlbiBiZWxvdyB6ZXJvIFNwcml0ZS5raWxsIGlzIGNhbGxlZC4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUjZGFtYWdlCiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBzdWJ0cmFjdCBmcm9tIHRoZSBTcHJpdGUuaGVhbHRoIHZhbHVlLgoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmRhbWFnZSA9IGZ1bmN0aW9uKGFtb3VudCkgewoKICAgIGlmICh0aGlzLmFsaXZlKQogICAgewogICAgICAgIHRoaXMuaGVhbHRoIC09IGFtb3VudDsKCiAgICAgICAgaWYgKHRoaXMuaGVhbHRoIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMua2lsbCgpOwogICAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdGhpczsKCn07CgovKioKKiBSZXNldHMgdGhlIFNwcml0ZS4gVGhpcyBwbGFjZXMgdGhlIFNwcml0ZSBhdCB0aGUgZ2l2ZW4geC95IHdvcmxkIGNvb3JkaW5hdGVzIGFuZCB0aGVuCiogc2V0cyBhbGl2ZSwgZXhpc3RzLCB2aXNpYmxlIGFuZCByZW5kZXJhYmxlIGFsbCB0byB0cnVlLiBBbHNvIHJlc2V0cyB0aGUgb3V0T2ZCb3VuZHMgc3RhdGUgYW5kIGhlYWx0aCB2YWx1ZXMuCiogSWYgdGhlIFNwcml0ZSBoYXMgYSBwaHlzaWNzIGJvZHkgdGhhdCB0b28gaXMgcmVzZXQuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI3Jlc2V0CiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgKGluIHdvcmxkIHNwYWNlKSB0byBwb3NpdGlvbiB0aGUgU3ByaXRlIGF0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSAoaW4gd29ybGQgc3BhY2UpIHRvIHBvc2l0aW9uIHRoZSBTcHJpdGUgYXQuCiogQHBhcmFtIHtudW1iZXJ9IFtoZWFsdGg9MV0gLSBUaGUgaGVhbHRoIHRvIGdpdmUgdGhlIFNwcml0ZS4KKiBAcmV0dXJuIChQaGFzZXIuU3ByaXRlKSBUaGlzIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKHgsIHksIGhlYWx0aCkgewoKICAgIGlmICh0eXBlb2YgaGVhbHRoID09PSAndW5kZWZpbmVkJykgeyBoZWFsdGggPSAxOyB9CgogICAgdGhpcy54ID0geDsKICAgIHRoaXMueSA9IHk7CiAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLng7CiAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLnk7CiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwogICAgdGhpcy5fb3V0T2ZCb3VuZHNGaXJlZCA9IGZhbHNlOwoKICAgIHRoaXMuaGVhbHRoID0gaGVhbHRoOwoKICAgIGlmICh0aGlzLmJvZHkpCiAgICB7CiAgICAgICAgdGhpcy5ib2R5LnJlc2V0KCk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7CiAgICAKfTsKCi8qKgoqIEJyaW5ncyB0aGUgU3ByaXRlIHRvIHRoZSB0b3Agb2YgdGhlIGRpc3BsYXkgbGlzdCBpdCBpcyBhIGNoaWxkIG9mLiBTcHJpdGVzIHRoYXQgYXJlIG1lbWJlcnMgb2YgYSBQaGFzZXIuR3JvdXAgYXJlIG9ubHkKKiBib3VnaHQgdG8gdGhlIHRvcCBvZiB0aGF0IEdyb3VwLCBub3QgdGhlIGVudGlyZSBkaXNwbGF5IGxpc3QuCiogCiogQG1ldGhvZCBQaGFzZXIuU3ByaXRlI2JyaW5nVG9Ub3AKKiBAbWVtYmVyb2YgUGhhc2VyLlNwcml0ZQoqIEByZXR1cm4gKFBoYXNlci5TcHJpdGUpIFRoaXMgaW5zdGFuY2UuCiovClBoYXNlci5TcHJpdGUucHJvdG90eXBlLmJyaW5nVG9Ub3AgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5ncm91cCkKICAgIHsKICAgICAgICB0aGlzLmdyb3VwLmJyaW5nVG9Ub3AodGhpcyk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5nYW1lLndvcmxkLmJyaW5nVG9Ub3AodGhpcyk7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cgp9OwoKLyoqCiogUGxheSBhbiBhbmltYXRpb24gYmFzZWQgb24gdGhlIGdpdmVuIGtleS4gVGhlIGFuaW1hdGlvbiBzaG91bGQgcHJldmlvdXNseSBoYXZlIGJlZW4gYWRkZWQgdmlhIHNwcml0ZS5hbmltYXRpb25zLmFkZCgpCiogSWYgdGhlIHJlcXVlc3RlZCBhbmltYXRpb24gaXMgYWxyZWFkeSBwbGF5aW5nIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQuIElmIHlvdSBuZWVkIHRvIHJlc2V0IGFuIGFscmVhZHkgcnVubmluZyBhbmltYXRpb24gZG8gc28gZGlyZWN0bHkgb24gdGhlIEFuaW1hdGlvbiBvYmplY3QgaXRzZWxmLgoqIAoqIEBtZXRob2QgUGhhc2VyLlNwcml0ZSNwbGF5CiogQG1lbWJlcm9mIFBoYXNlci5TcHJpdGUKKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgcGxheWVkLCBlLmcuICJmaXJlIiwgIndhbGsiLCAianVtcCIuCiogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZVJhdGU9bnVsbF0gLSBUaGUgZnJhbWVyYXRlIHRvIHBsYXkgdGhlIGFuaW1hdGlvbiBhdC4gVGhlIHNwZWVkIGlzIGdpdmVuIGluIGZyYW1lcyBwZXIgc2Vjb25kLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGZyYW1lUmF0ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiogQHBhcmFtIHtib29sZWFufSBbbG9vcD1mYWxzZV0gLSBTaG91bGQgdGhlIGFuaW1hdGlvbiBiZSBsb29wZWQgYWZ0ZXIgcGxheWJhY2suIElmIG5vdCBwcm92aWRlZCB0aGUgcHJldmlvdXNseSBzZXQgbG9vcCB2YWx1ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiogQHBhcmFtIHtib29sZWFufSBba2lsbE9uQ29tcGxldGU9ZmFsc2VdIC0gSWYgc2V0IHRvIHRydWUgd2hlbiB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlcyAob25seSBoYXBwZW5zIGlmIGxvb3A9ZmFsc2UpIHRoZSBwYXJlbnQgU3ByaXRlIHdpbGwgYmUga2lsbGVkLgoqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IEEgcmVmZXJlbmNlIHRvIHBsYXlpbmcgQW5pbWF0aW9uIGluc3RhbmNlLgoqLwpQaGFzZXIuU3ByaXRlLnByb3RvdHlwZS5wbGF5ID0gZnVuY3Rpb24gKG5hbWUsIGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpIHsKCiAgICBpZiAodGhpcy5hbmltYXRpb25zKQogICAgewogICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbnMucGxheShuYW1lLCBmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKTsKICAgIH0KCn07CgovKioKKiBJbmRpY2F0ZXMgdGhlIHJvdGF0aW9uIG9mIHRoZSBTcHJpdGUsIGluIGRlZ3JlZXMsIGZyb20gaXRzIG9yaWdpbmFsIG9yaWVudGF0aW9uLiBWYWx1ZXMgZnJvbSAwIHRvIDE4MCByZXByZXNlbnQgY2xvY2t3aXNlIHJvdGF0aW9uOyB2YWx1ZXMgZnJvbSAwIHRvIC0xODAgcmVwcmVzZW50IGNvdW50ZXJjbG9ja3dpc2Ugcm90YXRpb24uCiogVmFsdWVzIG91dHNpZGUgdGhpcyByYW5nZSBhcmUgYWRkZWQgdG8gb3Igc3VidHJhY3RlZCBmcm9tIDM2MCB0byBvYnRhaW4gYSB2YWx1ZSB3aXRoaW4gdGhlIHJhbmdlLiBGb3IgZXhhbXBsZSwgdGhlIHN0YXRlbWVudCBwbGF5ZXIuYW5nbGUgPSA0NTAgaXMgdGhlIHNhbWUgYXMgcGxheWVyLmFuZ2xlID0gOTAuCiogSWYgeW91IHdpc2ggdG8gd29yayBpbiByYWRpYW5zIGluc3RlYWQgb2YgZGVncmVlcyB1c2UgdGhlIHByb3BlcnR5IFNwcml0ZS5yb3RhdGlvbiBpbnN0ZWFkLgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjYW5nbGUKKiBAcHJvcGVydHkge251bWJlcn0gYW5nbGUgLSBHZXRzIG9yIHNldHMgdGhlIFNwcml0ZXMgYW5nbGUgb2Ygcm90YXRpb24gaW4gZGVncmVlcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgud3JhcEFuZ2xlKFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZChQaGFzZXIuTWF0aC53cmFwQW5nbGUodmFsdWUpKTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNmcmFtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBpbmRleCBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAiZnJhbWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbnMuZnJhbWU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5hbmltYXRpb25zLmZyYW1lID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjZnJhbWVOYW1lCiogQHByb3BlcnR5IHtzdHJpbmd9IGZyYW1lTmFtZSAtIEdldHMgb3Igc2V0cyB0aGUgY3VycmVudCBmcmFtZSBuYW1lIGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJmcmFtZU5hbWUiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmFuaW1hdGlvbnMuZnJhbWVOYW1lOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuYW5pbWF0aW9ucy5mcmFtZU5hbWUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNpbkNhbWVyYQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaW5DYW1lcmEgLSBJcyB0aGlzIHNwcml0ZSB2aXNpYmxlIHRvIHRoZSBjYW1lcmEgb3Igbm90PwoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJpbkNhbWVyYSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NhY2hlLmNhbWVyYVZpc2libGU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB3aWR0aCBvZiB0aGUgc3ByaXRlIGluIHBpeGVscywgc2V0dGluZyB0aGlzIHdpbGwgYWN0dWFsbHkgbW9kaWZ5IHRoZSBzY2FsZSB0byBhY2hlaXZlIHRoZSB2YWx1ZSBkZXNpcmVkLgoqIElmIHlvdSB3aXNoIHRvIGNyb3AgdGhlIFNwcml0ZSBpbnN0ZWFkIHNlZSB0aGUgU3ByaXRlLmNyb3AgdmFsdWUuCioKKiBAbmFtZSBQaGFzZXIuU3ByaXRlI3dpZHRoCiogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBTcHJpdGUgaW4gcGl4ZWxzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICd3aWR0aCcsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnNjYWxlLnggKiB0aGlzLmN1cnJlbnRGcmFtZS53aWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICB0aGlzLnNjYWxlLnggPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLndpZHRoOwogICAgICAgIHRoaXMuX2NhY2hlLnNjYWxlWCA9IHZhbHVlIC8gdGhpcy5jdXJyZW50RnJhbWUud2lkdGg7CiAgICAgICAgdGhpcy5fd2lkdGggPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBoZWlnaHQgb2YgdGhlIHNwcml0ZSBpbiBwaXhlbHMsIHNldHRpbmcgdGhpcyB3aWxsIGFjdHVhbGx5IG1vZGlmeSB0aGUgc2NhbGUgdG8gYWNoZWl2ZSB0aGUgdmFsdWUgZGVzaXJlZC4KKiBJZiB5b3Ugd2lzaCB0byBjcm9wIHRoZSBTcHJpdGUgaW5zdGVhZCBzZWUgdGhlIFNwcml0ZS5jcm9wIHZhbHVlLgoqCiogQG5hbWUgUGhhc2VyLlNwcml0ZSNoZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgU3ByaXRlIGluIHBpeGVscy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCAnaGVpZ2h0JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc2NhbGUueSAqIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICB0aGlzLnNjYWxlLnkgPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgICAgICB0aGlzLl9jYWNoZS5zY2FsZVkgPSB2YWx1ZSAvIHRoaXMuY3VycmVudEZyYW1lLmhlaWdodDsKICAgICAgICB0aGlzLl9oZWlnaHQgPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIEJ5IGRlZmF1bHQgYSBTcHJpdGUgd29uJ3QgcHJvY2VzcyBhbnkgaW5wdXQgZXZlbnRzIGF0IGFsbC4gQnkgc2V0dGluZyBpbnB1dEVuYWJsZWQgdG8gdHJ1ZSB0aGUgUGhhc2VyLklucHV0SGFuZGxlciBpcwoqIGFjdGl2YXRlZCBmb3IgdGhpcyBTcHJpdGUgaW5zdGFuY2UgYW5kIGl0IHdpbGwgdGhlbiBzdGFydCB0byBwcm9jZXNzIGNsaWNrL3RvdWNoIGV2ZW50cyBhbmQgbW9yZS4KKgoqIEBuYW1lIFBoYXNlci5TcHJpdGUjaW5wdXRFbmFibGVkCiogQHByb3BlcnR5IHtib29sZWFufSBpbnB1dEVuYWJsZWQgLSBTZXQgdG8gdHJ1ZSB0byBhbGxvdyB0aGlzIFNwcml0ZSB0byByZWNlaXZlIGlucHV0IGV2ZW50cywgb3RoZXJ3aXNlIGZhbHNlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsICJpbnB1dEVuYWJsZWQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gKHRoaXMuaW5wdXQuZW5hYmxlZCk7CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5lbmFibGVkID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmlucHV0LnN0YXJ0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQuZW5hYmxlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5pbnB1dC5zdG9wKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGUgYSBuZXcgPGNvZGU+VGlsZVNwcml0ZTwvY29kZT4uCiogQGNsYXNzIFBoYXNlci5UaWxlbWFwCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIG5ldyB0aWxlU3ByaXRlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IHRpbGVTcHJpdGUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gdGhlIHdpZHRoIG9mIHRoZSB0aWxlc3ByaXRlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSB0aWxlc3ByaXRlLgoqIEBwYXJhbSB7c3RyaW5nfFBoYXNlci5SZW5kZXJUZXh0dXJlfFBJWEkuVGV4dHVyZX0ga2V5IC0gVGhpcyBpcyB0aGUgaW1hZ2Ugb3IgdGV4dHVyZSB1c2VkIGJ5IHRoZSBTcHJpdGUgZHVyaW5nIHJlbmRlcmluZy4gSXQgY2FuIGJlIGEgc3RyaW5nIHdoaWNoIGlzIGEgcmVmZXJlbmNlIHRvIHRoZSBDYWNoZSBlbnRyeSwgb3IgYW4gaW5zdGFuY2Ugb2YgYSBSZW5kZXJUZXh0dXJlIG9yIFBJWEkuVGV4dHVyZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGZyYW1lIC0gSWYgdGhpcyBTcHJpdGUgaXMgdXNpbmcgcGFydCBvZiBhIHNwcml0ZSBzaGVldCBvciB0ZXh0dXJlIGF0bGFzIHlvdSBjYW4gc3BlY2lmeSB0aGUgZXhhY3QgZnJhbWUgdG8gdXNlIGJ5IGdpdmluZyBhIHN0cmluZyBvciBudW1lcmljIGluZGV4LgoqLwpQaGFzZXIuVGlsZVNwcml0ZSA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBrZXksIGZyYW1lKSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICB3aWR0aCA9IHdpZHRoIHx8IDI1NjsKICAgIGhlaWdodCA9IGhlaWdodCB8fCAyNTY7CiAgICBrZXkgPSBrZXkgfHwgbnVsbDsKICAgIGZyYW1lID0gZnJhbWUgfHwgbnVsbDsKCglQaGFzZXIuU3ByaXRlLmNhbGwodGhpcywgZ2FtZSwgeCwgeSwga2V5LCBmcmFtZSk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHRleHR1cmUgLSBEZXNjcmlwdGlvbi4gCiAgICAqLwogICAgdGhpcy50ZXh0dXJlID0gUElYSS5UZXh0dXJlQ2FjaGVba2V5XTsKCglQSVhJLlRpbGluZ1Nwcml0ZS5jYWxsKHRoaXMsIHRoaXMudGV4dHVyZSwgd2lkdGgsIGhlaWdodCk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHR5cGUgLSBEZXNjcmlwdGlvbi4gCiAgICAqLwoJdGhpcy50eXBlID0gUGhhc2VyLlRJTEVTUFJJVEU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UG9pbnR9IHRpbGVTY2FsZSAtIFRoZSBzY2FsaW5nIG9mIHRoZSBpbWFnZSB0aGF0IGlzIGJlaW5nIHRpbGVkLgoJKi8JCgl0aGlzLnRpbGVTY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UG9pbnR9IHRpbGVQb3NpdGlvbiAtIFRoZSBvZmZzZXQgcG9zaXRpb24gb2YgdGhlIGltYWdlIHRoYXQgaXMgYmVpbmcgdGlsZWQuCgkqLwkKCXRoaXMudGlsZVBvc2l0aW9uID0gbmV3IFBoYXNlci5Qb2ludCgwLCAwKTsKCn07CgpQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUgPSBQaGFzZXIuVXRpbHMuZXh0ZW5kKHRydWUsIFBJWEkuVGlsaW5nU3ByaXRlLnByb3RvdHlwZSwgUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZVNwcml0ZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuVGlsZVNwcml0ZTsKCi8vICBBZGQgb3VyIG93biBjdXN0b20gbWV0aG9kcwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlIGEgbmV3IDxjb2RlPlRleHQ8L2NvZGU+LgoqIEBjbGFzcyBQaGFzZXIuVGV4dAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGV4dCBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBuZXcgdGV4dCBvYmplY3QuCiogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgYWN0dWFsIHRleHQgdGhhdCB3aWxsIGJlIHdyaXR0ZW4uCiogQHBhcmFtIHtvYmplY3R9IHN0eWxlIC0gVGhlIHN0eWxlIG9iamVjdCBjb250YWluaW5nIHN0eWxlIGF0dHJpYnV0ZXMgbGlrZSBmb250LCBmb250IHNpemUgLAoqLwpQaGFzZXIuVGV4dCA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCB0ZXh0LCBzdHlsZSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAgdGV4dCA9IHRleHQgfHwgJyc7CiAgICBzdHlsZSA9IHN0eWxlIHx8ICcnOwoKICAgIC8vICBJZiBleGlzdHMgPSBmYWxzZSB0aGVuIHRoZSBTcHJpdGUgaXNuJ3QgdXBkYXRlZCBieSB0aGUgY29yZSBnYW1lIGxvb3Agb3IgcGh5c2ljcyBzdWJzeXN0ZW0gYXQgYWxsCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CgogICAgLy8gIFRoaXMgaXMgYSBoYW5keSBsaXR0bGUgdmFyIHlvdXIgZ2FtZSBjYW4gdXNlIHRvIGRldGVybWluZSBpZiBhIHNwcml0ZSBpcyBhbGl2ZSBvciBub3QsIGl0IGRvZXNuJ3QgZWZmZWN0IHJlbmRlcmluZwoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxpdmUgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmFsaXZlID0gdHJ1ZTsKCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gZ3JvdXAgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLm5hbWUgPSAnJzsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLiAKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIHRoaXMuX3RleHQgPSB0ZXh0OwogICAgdGhpcy5fc3R5bGUgPSBzdHlsZTsKCiAgICBQSVhJLlRleHQuY2FsbCh0aGlzLCB0ZXh0LCBzdHlsZSk7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0eXBlIC0gRGVzY3JpcHRpb24uIAogICAgICovCiAgICB0aGlzLnR5cGUgPSBQaGFzZXIuVEVYVDsKCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHBvc2l0aW9uIC0gRGVzY3JpcHRpb24uIAogICAgICovCiAgICB0aGlzLnBvc2l0aW9uLnggPSB0aGlzLnggPSB4OwogICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy55ID0geTsKCiAgICAvLyAgUmVwbGFjZXMgdGhlIFBJWEkuUG9pbnQgd2l0aCBhIHNsaWdodGx5IG1vcmUgZmxleGlibGUgb25lCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhbmNob3IgLSBEZXNjcmlwdGlvbi4gCiAgICAgKi8KICAgIHRoaXMuYW5jaG9yID0gbmV3IFBoYXNlci5Qb2ludCgpOwogICAgCiAgICAvKioKICAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIERlc2NyaXB0aW9uLiAKICAgICAqLwogICAgdGhpcy5zY2FsZSA9IG5ldyBQaGFzZXIuUG9pbnQoMSwgMSk7CgogICAgLy8gIEEgbWluaSBjYWNoZSBmb3Igc3RvcmluZyBhbGwgb2YgdGhlIGNhbGN1bGF0ZWQgdmFsdWVzCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2NhY2hlIC0gRGVzY3JpcHRpb24uIAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2NhY2hlID0geyAKCiAgICAgICAgZGlydHk6IGZhbHNlLAoKICAgICAgICAvLyAgVHJhbnNmb3JtIGNhY2hlCiAgICAgICAgYTAwOiAxLCBhMDE6IDAsIGEwMjogeCwgYTEwOiAwLCBhMTE6IDEsIGExMjogeSwgaWQ6IDEsIAoKICAgICAgICAvLyAgVGhlIHByZXZpb3VzIGNhbGN1bGF0ZWQgcG9zaXRpb24KICAgICAgICB4OiAtMSwgeTogLTEsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHNjYWxlIHZhbHVlcyBiYXNlZCBvbiB0aGUgd29ybGRUcmFuc2Zvcm0KICAgICAgICBzY2FsZVg6IDEsIHNjYWxlWTogMQoKICAgIH07CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVuZGVyYWJsZSAtIERlc2NyaXB0aW9uLiAKICAgICovCiAgICB0aGlzLnJlbmRlcmFibGUgPSB0cnVlOwoKfTsKClBoYXNlci5UZXh0LnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5UZXh0LnByb3RvdHlwZSk7ClBoYXNlci5UZXh0LnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UZXh0OwoKLyoqCiogQXV0b21hdGljYWxseSBjYWxsZWQgYnkgV29ybGQudXBkYXRlLgoqIEBtZXRob2QgUGhhc2VyLlRleHQucHJvdG90eXBlLnVwZGF0ZQoqLwpQaGFzZXIuVGV4dC5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oKSB7CgogICAgaWYgKCF0aGlzLmV4aXN0cykKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5fY2FjaGUuZGlydHkgPSBmYWxzZTsKCiAgICB0aGlzLl9jYWNoZS54ID0gdGhpcy54OwogICAgdGhpcy5fY2FjaGUueSA9IHRoaXMueTsKCiAgICBpZiAodGhpcy5wb3NpdGlvbi54ICE9IHRoaXMuX2NhY2hlLnggfHwgdGhpcy5wb3NpdGlvbi55ICE9IHRoaXMuX2NhY2hlLnkpCiAgICB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi54ID0gdGhpcy5fY2FjaGUueDsKICAgICAgICB0aGlzLnBvc2l0aW9uLnkgPSB0aGlzLl9jYWNoZS55OwogICAgICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCn0KCi8qKgoqIEBtZXRob2QgUGhhc2VyLlRleHQucHJvdG90eXBlLmRlc3Ryb3kKKi8KUGhhc2VyLlRleHQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5ncm91cCkKICAgIHsKICAgICAgICB0aGlzLmdyb3VwLnJlbW92ZSh0aGlzKTsKICAgIH0KCiAgICBpZiAodGhpcy5jYW52YXMucGFyZW50Tm9kZSkKICAgIHsKICAgICAgICB0aGlzLmNhbnZhcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuY2FudmFzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmNhbnZhcyA9IG51bGw7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgIH0KCiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwoKICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKfQoKLyoqCiogR2V0CiogQHJldHVybnMge0Rlc2NyaXB0aW9ufQoqLy8qKgoqIFNldAoqIEBwYXJhbSB7RGVzY3JpcHRpb259IHZhbHVlIC0gRGVzY3JpcHRpb24KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UZXh0LnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKHZhbHVlKTsKICAgIH0KCn0pOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UZXh0LnByb3RvdHlwZSwgJ2NvbnRlbnQnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdGV4dDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewoKICAgICAgICAvLyAgTGV0J3Mgbm90IHVwZGF0ZSB1bmxlc3MgbmVlZGVkLCB0aGlzIHdheSB3ZSBjYW4gc2FmZWx5IHVwZGF0ZSB0aGUgdGV4dCBpbiBhIGNvcmUgbG9vcCB3aXRob3V0IGNvbnN0YW50IHJlLWRyYXdzCiAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLl90ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdGV4dCA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLnNldFRleHQodmFsdWUpOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGV4dC5wcm90b3R5cGUsICdmb250JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3N0eWxlOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CgogICAgICAgIC8vICBMZXQncyBub3QgdXBkYXRlIHVubGVzcyBuZWVkZWQsIHRoaXMgd2F5IHdlIGNhbiBzYWZlbHkgdXBkYXRlIHRoZSB0ZXh0IGluIGEgY29yZSBsb29wIHdpdGhvdXQgY29uc3RhbnQgcmUtZHJhd3MKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3N0eWxlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGUgPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5zZXRTdHlsZSh2YWx1ZSk7CiAgICAgICAgfQoKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBgQml0bWFwVGV4dGAgb2JqZWN0LiBCaXRtYXBUZXh0IHdvcmsgYnkgdGFraW5nIGEgdGV4dHVyZSBmaWxlIGFuZCBhbiBYTUwgZmlsZSB0aGF0IGRlc2NyaWJlcyB0aGUgZm9udCBsYXlvdXQuCiogT24gV2luZG93cyB5b3UgY2FuIHVzZSB0aGUgZnJlZSBhcHAgQk1Gb250OiBodHRwOi8vd3d3LmFuZ2VsY29kZS5jb20vcHJvZHVjdHMvYm1mb250LwoqIE9uIE9TIFggd2UgcmVjb21tZW5kIEdseXBoIERlc2lnbmVyOiBodHRwOi8vd3d3Ljcxc3F1YXJlZC5jb20vZW4vZ2x5cGhkZXNpZ25lcgoqCiogQGNsYXNzIFBoYXNlci5CaXRtYXBUZXh0CiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgbmV3IGJpdG1hcFRleHQgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IGJpdG1hcFRleHQgb2JqZWN0LgoqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGFjdHVhbCB0ZXh0IHRoYXQgd2lsbCBiZSB3cml0dGVuLgoqIEBwYXJhbSB7b2JqZWN0fSBzdHlsZSAtIFRoZSBzdHlsZSBvYmplY3QgY29udGFpbmluZyBzdHlsZSBhdHRyaWJ1dGVzIGxpa2UgZm9udCwgZm9udCBzaXplICwgZXRjLgoqLwpQaGFzZXIuQml0bWFwVGV4dCA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCB0ZXh0LCBzdHlsZSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwoKICAgIHRleHQgPSB0ZXh0IHx8ICcnOwogICAgc3R5bGUgPSBzdHlsZSB8fCAnJzsKCgkvKiogCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZXhpc3RzIC0gSWYgZXhpc3RzID0gZmFsc2UgdGhlbiB0aGUgU3ByaXRlIGlzbid0IHVwZGF0ZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wIG9yIHBoeXNpY3Mgc3Vic3lzdGVtIGF0IGFsbC4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmV4aXN0cyA9IHRydWU7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxpdmUgLSBUaGlzIGlzIGEgaGFuZHkgbGl0dGxlIHZhciB5b3VyIGdhbWUgY2FuIHVzZSB0byBkZXRlcm1pbmUgaWYgYSBzcHJpdGUgaXMgYWxpdmUgb3Igbm90LCBpdCBkb2Vzbid0IGVmZmVjdCByZW5kZXJpbmcuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5hbGl2ZSA9IHRydWU7CgoJLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGdyb3VwIC0gRGVzY3JpcHRpb24uCiAJKiBAZGVmYXVsdAogCSovCiAgICB0aGlzLmdyb3VwID0gbnVsbDsKCgkvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBEZXNjcmlwdGlvbi4KICAJKiBAZGVmYXVsdAogIAkqLwogICAgdGhpcy5uYW1lID0gJyc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgR2FtZS4KICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIFBJWEkuQml0bWFwVGV4dC5jYWxsKHRoaXMsIHRleHQsIHN0eWxlKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdHlwZSAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5CSVRNQVBURVhUOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcG9zaXRpb24ueCAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMucG9zaXRpb24ueCA9IHg7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gcG9zaXRpb24ueSAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMucG9zaXRpb24ueSA9IHk7CgogICAgLy8gIFJlcGxhY2VzIHRoZSBQSVhJLlBvaW50IHdpdGggYSBzbGlnaHRseSBtb3JlIGZsZXhpYmxlIG9uZQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhbmNob3IgLSBEZXNjcmlwdGlvbi4KCSovCiAgICB0aGlzLmFuY2hvciA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBzY2FsZSAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMuc2NhbGUgPSBuZXcgUGhhc2VyLlBvaW50KDEsIDEpOwoKICAgIC8vICBBIG1pbmkgY2FjaGUgZm9yIHN0b3JpbmcgYWxsIG9mIHRoZSBjYWxjdWxhdGVkIHZhbHVlcwoJLyoqCgkqIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9jYWNoZSAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2NhY2hlID0geyAKCiAgICAgICAgZGlydHk6IGZhbHNlLAoKICAgICAgICAvLyAgVHJhbnNmb3JtIGNhY2hlCiAgICAgICAgYTAwOiAxLCBhMDE6IDAsIGEwMjogeCwgYTEwOiAwLCBhMTE6IDEsIGExMjogeSwgaWQ6IDEsIAoKICAgICAgICAvLyAgVGhlIHByZXZpb3VzIGNhbGN1bGF0ZWQgcG9zaXRpb24KICAgICAgICB4OiAtMSwgeTogLTEsCgogICAgICAgIC8vICBUaGUgYWN0dWFsIHNjYWxlIHZhbHVlcyBiYXNlZCBvbiB0aGUgd29ybGRUcmFuc2Zvcm0KICAgICAgICBzY2FsZVg6IDEsIHNjYWxlWTogMQoKICAgIH07CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcmVuZGVyYWJsZSAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMucmVuZGVyYWJsZSA9IHRydWU7Cgp9OwoKUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlKTsKLy8gUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlID0gUGhhc2VyLlV0aWxzLmV4dGVuZCh0cnVlLCBQSVhJLkJpdG1hcFRleHQucHJvdG90eXBlKTsKUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkJpdG1hcFRleHQ7CgovKioKKiBBdXRvbWF0aWNhbGx5IGNhbGxlZCBieSBXb3JsZC51cGRhdGUKKiBAbWV0aG9kIFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZS51cGRhdGUKKi8KUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkgewoKICAgIGlmICghdGhpcy5leGlzdHMpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX2NhY2hlLmRpcnR5ID0gZmFsc2U7CgogICAgdGhpcy5fY2FjaGUueCA9IHRoaXMueDsKICAgIHRoaXMuX2NhY2hlLnkgPSB0aGlzLnk7CgogICAgaWYgKHRoaXMucG9zaXRpb24ueCAhPSB0aGlzLl9jYWNoZS54IHx8IHRoaXMucG9zaXRpb24ueSAhPSB0aGlzLl9jYWNoZS55KQogICAgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHRoaXMuX2NhY2hlLng7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdGhpcy5fY2FjaGUueTsKICAgICAgICB0aGlzLl9jYWNoZS5kaXJ0eSA9IHRydWU7CiAgICB9CgogICAgdGhpcy5waXZvdC54ID0gdGhpcy5hbmNob3IueCp0aGlzLndpZHRoOwogICAgdGhpcy5waXZvdC55ID0gdGhpcy5hbmNob3IueSp0aGlzLmhlaWdodDsKCn0KCi8qKgoqIEBtZXRob2QgUGhhc2VyLlRleHQucHJvdG90eXBlLmRlc3Ryb3kKKi8KUGhhc2VyLkJpdG1hcFRleHQucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKCiAgICBpZiAodGhpcy5ncm91cCkKICAgIHsKICAgICAgICB0aGlzLmdyb3VwLnJlbW92ZSh0aGlzKTsKICAgIH0KCiAgICBpZiAodGhpcy5jYW52YXMgJiYgdGhpcy5jYW52YXMucGFyZW50Tm9kZSkKICAgIHsKICAgICAgICB0aGlzLmNhbnZhcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMuY2FudmFzKTsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0aGlzLmNhbnZhcyA9IG51bGw7CiAgICAgICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgIH0KCiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwoKICAgIHRoaXMuZ3JvdXAgPSBudWxsOwoKfQoKLyoqCiogR2V0CiogQHJldHVybnMge0Rlc2NyaXB0aW9ufQoqLy8qKgoqIFNldAoqIEBwYXJhbSB7RGVzY3JpcHRpb259IHZhbHVlIC0gRGVzY3JpcHRpb24KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSwgJ2FuZ2xlJywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5yb3RhdGlvbiA9IFBoYXNlci5NYXRoLmRlZ1RvUmFkKHZhbHVlKTsKICAgIH0KCn0pOwoKLyoqCiogR2V0CiogQHJldHVybnMge0Rlc2NyaXB0aW9ufQoqLy8qKgoqIFNldAoqIEBwYXJhbSB7RGVzY3JpcHRpb259IHZhbHVlIC0gRGVzY3JpcHRpb24KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5CaXRtYXBUZXh0LnByb3RvdHlwZSwgJ3gnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi54OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEdldAoqIEByZXR1cm5zIHtEZXNjcmlwdGlvbn0KKi8vKioKKiBTZXQKKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2YWx1ZSAtIERlc2NyaXB0aW9uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQml0bWFwVGV4dC5wcm90b3R5cGUsICd5JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGUgYSBuZXcgYEJ1dHRvbmAgb2JqZWN0LiBBIEJ1dHRvbiBpcyBhIHNwZWNpYWwgdHlwZSBvZiBTcHJpdGUgdGhhdCBpcyBzZXQtdXAgdG8gaGFuZGxlIFBvaW50ZXIgZXZlbnRzIGF1dG9tYXRpY2FsbHkuIFRoZSBmb3VyIHN0YXRlcyBhIEJ1dHRvbiByZXNwb25kcyB0byBhcmU6CiogJ092ZXInIC0gd2hlbiB0aGUgUG9pbnRlciBtb3ZlcyBvdmVyIHRoZSBCdXR0b24uIFRoaXMgaXMgYWxzbyBjb21tb25seSBrbm93biBhcyAnaG92ZXInLgoqICdPdXQnIC0gd2hlbiB0aGUgUG9pbnRlciB0aGF0IHdhcyBwcmV2aW91c2x5IG92ZXIgdGhlIEJ1dHRvbiBtb3ZlcyBvdXQgb2YgaXQuCiogJ0Rvd24nIC0gd2hlbiB0aGUgUG9pbnRlciBpcyBwcmVzc2VkIGRvd24gb24gdGhlIEJ1dHRvbi4gSS5lLiB0b3VjaGVkIG9uIGEgdG91Y2ggZW5hYmxlZCBkZXZpY2Ugb3IgY2xpY2tlZCB3aXRoIHRoZSBtb3VzZS4KKiAnVXAnIC0gd2hlbiB0aGUgUG9pbnRlciB0aGF0IHdhcyBwcmVzc2VkIGRvd24gb24gdGhlIEJ1dHRvbiBpcyByZWxlYXNlZCBhZ2Fpbi4KKiBZb3UgY2FuIHNldCBhIHVuaXF1ZSB0ZXh0dXJlIGZyYW1lIGFuZCBTb3VuZCBmb3IgYW55IG9mIHRoZXNlIHN0YXRlcy4KKgoqIEBjbGFzcyBQaGFzZXIuQnV0dG9uCiogQGNvbnN0cnVjdG9yCioKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIEN1cnJlbnQgZ2FtZSBpbnN0YW5jZS4KKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gWCBwb3NpdGlvbiBvZiB0aGUgQnV0dG9uLgoqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBZIHBvc2l0aW9uIG9mIHRoZSBCdXR0b24uCiogQHBhcmFtIHtzdHJpbmd9IFtrZXldIC0gVGhlIGltYWdlIGtleSBhcyBkZWZpbmVkIGluIHRoZSBHYW1lLkNhY2hlIHRvIHVzZSBhcyB0aGUgdGV4dHVyZSBmb3IgdGhpcyBCdXR0b24uCiogQHBhcmFtIHtmdW5jdGlvbn0gW2NhbGxiYWNrXSAtIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhpcyBCdXR0b24gaXMgcHJlc3NlZC4KKiBAcGFyYW0ge29iamVjdH0gW2NhbGxiYWNrQ29udGV4dF0gLSBUaGUgY29udGV4dCBpbiB3aGljaCB0aGUgY2FsbGJhY2sgd2lsbCBiZSBjYWxsZWQgKHVzdWFsbHkgJ3RoaXMnKS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdmVyRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhbiBvdmVyIHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW291dEZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3V0IHN0YXRlLiBHaXZlIGVpdGhlciBhIG51bWJlciB0byB1c2UgYSBmcmFtZSBJRCBvciBhIHN0cmluZyBmb3IgYSBmcmFtZSBuYW1lLgoqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gW2Rvd25GcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGEgZG93biBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKi8KUGhhc2VyLkJ1dHRvbiA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCBrZXksIGNhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQsIG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwogICAga2V5ID0ga2V5IHx8IG51bGw7CiAgICBjYWxsYmFjayA9IGNhbGxiYWNrIHx8IG51bGw7CiAgICBjYWxsYmFja0NvbnRleHQgPSBjYWxsYmFja0NvbnRleHQgfHwgdGhpczsKCglQaGFzZXIuU3ByaXRlLmNhbGwodGhpcywgZ2FtZSwgeCwgeSwga2V5LCBvdXRGcmFtZSk7CgoJLyoqIAoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBQaGFzZXIgT2JqZWN0IFR5cGUuCgkqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkJVVFRPTjsKCgkvKiogCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfb25PdmVyRnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25PdmVyRnJhbWVOYW1lID0gbnVsbDsKICAgIAoJLyoqIAoJKiBAcHJvcGVydHkge3N0cmluZ30gX29uT3V0RnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25PdXRGcmFtZU5hbWUgPSBudWxsOwogICAgCgkvKiogCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBfb25Eb3duRnJhbWVOYW1lIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25Eb3duRnJhbWVOYW1lID0gbnVsbDsKICAgIAoJLyoqIAoJKiBAcHJvcGVydHkge3N0cmluZ30gX29uVXBGcmFtZU5hbWUgLSBJbnRlcm5hbCB2YXJpYWJsZS4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9vblVwRnJhbWVOYW1lID0gbnVsbDsKICAgIAoJLyoqIAoJKiBAcHJvcGVydHkge251bWJlcn0gX29uT3ZlckZyYW1lSUQgLSBJbnRlcm5hbCB2YXJpYWJsZS4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9vbk92ZXJGcmFtZUlEID0gbnVsbDsKICAgIAoJLyoqIAoJKiBAcHJvcGVydHkge251bWJlcn0gX29uT3V0RnJhbWVJRCAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uT3V0RnJhbWVJRCA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtudW1iZXJ9IF9vbkRvd25GcmFtZUlEIC0gSW50ZXJuYWwgdmFyaWFibGUuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fb25Eb3duRnJhbWVJRCA9IG51bGw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtudW1iZXJ9IF9vblVwRnJhbWVJRCAtIEludGVybmFsIHZhcmlhYmxlLgoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuX29uVXBGcmFtZUlEID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kfSBvbk92ZXJTb3VuZCAtIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiB0aGlzIEJ1dHRvbnMgT3ZlciBzdGF0ZSBpcyBhY3RpdmF0ZWQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk92ZXJTb3VuZCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge1BoYXNlci5Tb3VuZH0gb25PdXRTb3VuZCAtIFRoZSBTb3VuZCB0byBiZSBwbGF5ZWQgd2hlbiB0aGlzIEJ1dHRvbnMgT3V0IHN0YXRlIGlzIGFjdGl2YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uT3V0U291bmQgPSBudWxsOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU291bmR9IG9uRG93blNvdW5kIC0gVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIHRoaXMgQnV0dG9ucyBEb3duIHN0YXRlIGlzIGFjdGl2YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uRG93blNvdW5kID0gbnVsbDsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNvdW5kfSBvblVwU291bmQgLSBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gdGhpcyBCdXR0b25zIFVwIHN0YXRlIGlzIGFjdGl2YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uVXBTb3VuZCA9IG51bGw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb25PdmVyU291bmRNYXJrZXIgLSBUaGUgU291bmQgTWFya2VyIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgb25PdmVyU291bmQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5vbk92ZXJTb3VuZE1hcmtlciA9ICcnOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG9uT3V0U291bmRNYXJrZXIgLSBUaGUgU291bmQgTWFya2VyIHVzZWQgaW4gY29uanVuY3Rpb24gd2l0aCB0aGUgb25PdXRTb3VuZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uT3V0U291bmRNYXJrZXIgPSAnJzsKCiAgICAvKiogCiAgICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBvbkRvd25Tb3VuZE1hcmtlciAtIFRoZSBTb3VuZCBNYXJrZXIgdXNlZCBpbiBjb25qdW5jdGlvbiB3aXRoIHRoZSBvbkRvd25Tb3VuZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uRG93blNvdW5kTWFya2VyID0gJyc7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge3N0cmluZ30gb25VcFNvdW5kTWFya2VyIC0gVGhlIFNvdW5kIE1hcmtlciB1c2VkIGluIGNvbmp1bmN0aW9uIHdpdGggdGhlIG9uVXBTb3VuZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9uVXBTb3VuZE1hcmtlciA9ICcnOwoKCS8qKiAKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0T3ZlciAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gT3ZlciBzdGF0ZS4KCSovCiAgICB0aGlzLm9uSW5wdXRPdmVyID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0T3V0IC0gVGhlIFNpZ25hbCAob3IgZXZlbnQpIGRpc3BhdGNoZWQgd2hlbiB0aGlzIEJ1dHRvbiBpcyBpbiBhbiBPdXQgc3RhdGUuCgkqLwogICAgdGhpcy5vbklucHV0T3V0ID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0RG93biAtIFRoZSBTaWduYWwgKG9yIGV2ZW50KSBkaXNwYXRjaGVkIHdoZW4gdGhpcyBCdXR0b24gaXMgaW4gYW4gRG93biBzdGF0ZS4KCSovCiAgICB0aGlzLm9uSW5wdXREb3duID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKCS8qKiAKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbklucHV0VXAgLSBUaGUgU2lnbmFsIChvciBldmVudCkgZGlzcGF0Y2hlZCB3aGVuIHRoaXMgQnV0dG9uIGlzIGluIGFuIFVwIHN0YXRlLgoJKi8KICAgIHRoaXMub25JbnB1dFVwID0gbmV3IFBoYXNlci5TaWduYWw7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZyZWV6ZUZyYW1lcyAtIFdoZW4gdHJ1ZSB0aGUgQnV0dG9uIHdpbGwgY2Vhc2UgdG8gY2hhbmdlIHRleHR1cmUgZnJhbWUgb24gYWxsIGV2ZW50cyAob3Zlciwgb3V0LCB1cCwgZG93bikuCiAgICAqLwogICAgdGhpcy5mcmVlemVGcmFtZXMgPSBmYWxzZTsKCiAgICAvKioKICAgICogV2hlbiB0aGUgQnV0dG9uIGlzIGNsaWNrZWQgeW91IGNhbiBvcHRpb25hbGx5IGZvcmNlIHRoZSBzdGF0ZSB0byAib3V0Ii4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZU91dAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZm9yY2VPdXQgPSB0cnVlOwoKICAgIHRoaXMuc2V0RnJhbWVzKG92ZXJGcmFtZSwgb3V0RnJhbWUsIGRvd25GcmFtZSk7CgogICAgaWYgKGNhbGxiYWNrICE9PSBudWxsKQogICAgewogICAgICAgIHRoaXMub25JbnB1dFVwLmFkZChjYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgIH0KCiAgICB0aGlzLmlucHV0LnN0YXJ0KDAsIHRydWUpOwoKICAgIC8vICBSZWRpcmVjdCB0aGUgaW5wdXQgZXZlbnRzIHRvIGhlcmUgc28gd2UgY2FuIGhhbmRsZSBhbmltYXRpb24gdXBkYXRlcywgZXRjCiAgICB0aGlzLmV2ZW50cy5vbklucHV0T3Zlci5hZGQodGhpcy5vbklucHV0T3ZlckhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5ldmVudHMub25JbnB1dE91dC5hZGQodGhpcy5vbklucHV0T3V0SGFuZGxlciwgdGhpcyk7CiAgICB0aGlzLmV2ZW50cy5vbklucHV0RG93bi5hZGQodGhpcy5vbklucHV0RG93bkhhbmRsZXIsIHRoaXMpOwogICAgdGhpcy5ldmVudHMub25JbnB1dFVwLmFkZCh0aGlzLm9uSW5wdXRVcEhhbmRsZXIsIHRoaXMpOwoKfTsKClBoYXNlci5CdXR0b24ucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5CdXR0b24ucHJvdG90eXBlID0gUGhhc2VyLlV0aWxzLmV4dGVuZCh0cnVlLCBQaGFzZXIuQnV0dG9uLnByb3RvdHlwZSwgUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUsIFBJWEkuU3ByaXRlLnByb3RvdHlwZSk7ClBoYXNlci5CdXR0b24ucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkJ1dHRvbjsKCi8qKgoqIFVzZWQgdG8gbWFudWFsbHkgc2V0IHRoZSBmcmFtZXMgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIHRoZSBkaWZmZXJlbnQgc3RhdGVzIG9mIHRoZSBidXR0b24KKiBleGFjdGx5IGxpa2Ugc2V0dGluZyB0aGVtIGluIHRoZSBjb25zdHJ1Y3Rvci4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RnJhbWVzCiogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBbb3ZlckZyYW1lXSAtIFRoaXMgaXMgdGhlIGZyYW1lIG9yIGZyYW1lTmFtZSB0aGF0IHdpbGwgYmUgc2V0IHdoZW4gdGhpcyBidXR0b24gaXMgaW4gYW4gb3ZlciBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtvdXRGcmFtZV0gLSBUaGlzIGlzIHRoZSBmcmFtZSBvciBmcmFtZU5hbWUgdGhhdCB3aWxsIGJlIHNldCB3aGVuIHRoaXMgYnV0dG9uIGlzIGluIGFuIG91dCBzdGF0ZS4gR2l2ZSBlaXRoZXIgYSBudW1iZXIgdG8gdXNlIGEgZnJhbWUgSUQgb3IgYSBzdHJpbmcgZm9yIGEgZnJhbWUgbmFtZS4KKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IFtkb3duRnJhbWVdIC0gVGhpcyBpcyB0aGUgZnJhbWUgb3IgZnJhbWVOYW1lIHRoYXQgd2lsbCBiZSBzZXQgd2hlbiB0aGlzIGJ1dHRvbiBpcyBpbiBhIGRvd24gc3RhdGUuIEdpdmUgZWl0aGVyIGEgbnVtYmVyIHRvIHVzZSBhIGZyYW1lIElEIG9yIGEgc3RyaW5nIGZvciBhIGZyYW1lIG5hbWUuCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldEZyYW1lcyA9IGZ1bmN0aW9uIChvdmVyRnJhbWUsIG91dEZyYW1lLCBkb3duRnJhbWUpIHsKCiAgICBpZiAob3ZlckZyYW1lICE9PSBudWxsKQogICAgewogICAgICAgIGlmICh0eXBlb2Ygb3ZlckZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3ZlckZyYW1lTmFtZSA9IG92ZXJGcmFtZTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gb3ZlckZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3ZlckZyYW1lSUQgPSBvdmVyRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gb3ZlckZyYW1lOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGlmIChvdXRGcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIG91dEZyYW1lID09PSAnc3RyaW5nJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX29uT3V0RnJhbWVOYW1lID0gb3V0RnJhbWU7CiAgICAgICAgICAgIHRoaXMuX29uVXBGcmFtZU5hbWUgPSBvdXRGcmFtZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmlucHV0LnBvaW50ZXJPdmVyKCkgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gb3V0RnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fb25PdXRGcmFtZUlEID0gb3V0RnJhbWU7CiAgICAgICAgICAgIHRoaXMuX29uVXBGcmFtZUlEID0gb3V0RnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyT3ZlcigpID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lID0gb3V0RnJhbWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKGRvd25GcmFtZSAhPT0gbnVsbCkKICAgIHsKICAgICAgICBpZiAodHlwZW9mIGRvd25GcmFtZSA9PT0gJ3N0cmluZycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbkRvd25GcmFtZU5hbWUgPSBkb3duRnJhbWU7CgogICAgICAgICAgICBpZiAodGhpcy5pbnB1dC5wb2ludGVyRG93bigpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IGRvd25GcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9vbkRvd25GcmFtZUlEID0gZG93bkZyYW1lOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5wdXQucG9pbnRlckRvd24oKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5mcmFtZSA9IGRvd25GcmFtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBTZXRzIHRoZSBzb3VuZHMgdG8gYmUgcGxheWVkIHdoZW5ldmVyIHRoaXMgQnV0dG9uIGlzIGludGVyYWN0ZWQgd2l0aC4gU291bmRzIGNhbiBiZSBlaXRoZXIgZnVsbCBTb3VuZCBvYmplY3RzLCBvciBtYXJrZXJzIHBvaW50aW5nIHRvIGEgc2VjdGlvbiBvZiBhIFNvdW5kIG9iamVjdC4KKiBUaGUgbW9zdCBjb21tb24gZm9ybXMgb2Ygc291bmRzIGFyZSAnaG92ZXInIGVmZmVjdHMgYW5kICdjbGljaycgZWZmZWN0cywgd2hpY2ggaXMgd2h5IHRoZSBvcmRlciBvZiB0aGUgcGFyYW1ldGVycyBpcyBvdmVyU291bmQgdGhlbiBkb3duU291bmQuCiogQ2FsbCB0aGlzIGZ1bmN0aW9uIHdpdGggbm8gcGFyYW1ldGVycyBhdCBhbGwgdG8gcmVzZXQgYWxsIHNvdW5kcyBvbiB0aGlzIEJ1dHRvbi4KKgoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0U291bmRzCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtvdmVyU291bmRdIC0gT3ZlciBCdXR0b24gU291bmQuCiogQHBhcmFtIHtzdHJpbmd9IFtvdmVyTWFya2VyXSAtIE92ZXIgQnV0dG9uIFNvdW5kIE1hcmtlci4KKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW2Rvd25Tb3VuZF0gLSBEb3duIEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW2Rvd25NYXJrZXJdIC0gRG93biBCdXR0b24gU291bmQgTWFya2VyLgoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBbb3V0U291bmRdIC0gT3V0IEJ1dHRvbiBTb3VuZC4KKiBAcGFyYW0ge3N0cmluZ30gW291dE1hcmtlcl0gLSBPdXQgQnV0dG9uIFNvdW5kIE1hcmtlci4KKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gW3VwU291bmRdIC0gVXAgQnV0dG9uIFNvdW5kLgoqIEBwYXJhbSB7c3RyaW5nfSBbdXBNYXJrZXJdIC0gVXAgQnV0dG9uIFNvdW5kIE1hcmtlci4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0U291bmRzID0gZnVuY3Rpb24gKG92ZXJTb3VuZCwgb3Zlck1hcmtlciwgZG93blNvdW5kLCBkb3duTWFya2VyLCBvdXRTb3VuZCwgb3V0TWFya2VyLCB1cFNvdW5kLCB1cE1hcmtlcikgewoKICAgIHRoaXMuc2V0T3ZlclNvdW5kKG92ZXJTb3VuZCwgb3Zlck1hcmtlcik7CiAgICB0aGlzLnNldE91dFNvdW5kKG91dFNvdW5kLCBvdXRNYXJrZXIpOwogICAgdGhpcy5zZXRVcFNvdW5kKHVwU291bmQsIHVwTWFya2VyKTsKICAgIHRoaXMuc2V0RG93blNvdW5kKGRvd25Tb3VuZCwgZG93bk1hcmtlcik7Cgp9CgovKioKKiBUaGUgU291bmQgdG8gYmUgcGxheWVkIHdoZW4gYSBQb2ludGVyIG1vdmVzIG92ZXIgdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE92ZXJTb3VuZAoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCB0aGF0IHdpbGwgYmUgcGxheWVkLgoqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyXSAtIEEgU291bmQgTWFya2VyIHRoYXQgd2lsbCBiZSB1c2VkIGluIHRoZSBwbGF5YmFjay4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0T3ZlclNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uT3ZlclNvdW5kID0gbnVsbDsKICAgIHRoaXMub25PdmVyU291bmRNYXJrZXIgPSAnJzsKCiAgICBpZiAoc291bmQgaW5zdGFuY2VvZiBQaGFzZXIuU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbk92ZXJTb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uT3ZlclNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBtb3ZlcyBvdXQgb2YgdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldE91dFNvdW5kCiogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIFNvdW5kIHRoYXQgd2lsbCBiZSBwbGF5ZWQuCiogQHBhcmFtIHtzdHJpbmd9IFttYXJrZXJdIC0gQSBTb3VuZCBNYXJrZXIgdGhhdCB3aWxsIGJlIHVzZWQgaW4gdGhlIHBsYXliYWNrLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5zZXRPdXRTb3VuZCA9IGZ1bmN0aW9uIChzb3VuZCwgbWFya2VyKSB7CgogICAgdGhpcy5vbk91dFNvdW5kID0gbnVsbDsKICAgIHRoaXMub25PdXRTb3VuZE1hcmtlciA9ICcnOwoKICAgIGlmIChzb3VuZCBpbnN0YW5jZW9mIFBoYXNlci5Tb3VuZCkKICAgIHsKICAgICAgICB0aGlzLm9uT3V0U291bmQgPSBzb3VuZDsKICAgIH0KCiAgICBpZiAodHlwZW9mIG1hcmtlciA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAgICAgdGhpcy5vbk91dFNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBjbGlja3Mgb24gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFVwU291bmQKKiBAcGFyYW0ge1BoYXNlci5Tb3VuZH0gc291bmQgLSBUaGUgU291bmQgdGhhdCB3aWxsIGJlIHBsYXllZC4KKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcl0gLSBBIFNvdW5kIE1hcmtlciB0aGF0IHdpbGwgYmUgdXNlZCBpbiB0aGUgcGxheWJhY2suCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldFVwU291bmQgPSBmdW5jdGlvbiAoc291bmQsIG1hcmtlcikgewoKICAgIHRoaXMub25VcFNvdW5kID0gbnVsbDsKICAgIHRoaXMub25VcFNvdW5kTWFya2VyID0gJyc7CgogICAgaWYgKHNvdW5kIGluc3RhbmNlb2YgUGhhc2VyLlNvdW5kKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kID0gc291bmQ7CiAgICB9CgogICAgaWYgKHR5cGVvZiBtYXJrZXIgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMub25VcFNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogVGhlIFNvdW5kIHRvIGJlIHBsYXllZCB3aGVuIGEgUG9pbnRlciBjbGlja3Mgb24gdGhpcyBCdXR0b24uCioKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLnNldERvd25Tb3VuZAoqIEBwYXJhbSB7UGhhc2VyLlNvdW5kfSBzb3VuZCAtIFRoZSBTb3VuZCB0aGF0IHdpbGwgYmUgcGxheWVkLgoqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyXSAtIEEgU291bmQgTWFya2VyIHRoYXQgd2lsbCBiZSB1c2VkIGluIHRoZSBwbGF5YmFjay4KKi8KUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUuc2V0RG93blNvdW5kID0gZnVuY3Rpb24gKHNvdW5kLCBtYXJrZXIpIHsKCiAgICB0aGlzLm9uRG93blNvdW5kID0gbnVsbDsKICAgIHRoaXMub25Eb3duU291bmRNYXJrZXIgPSAnJzsKCiAgICBpZiAoc291bmQgaW5zdGFuY2VvZiBQaGFzZXIuU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbkRvd25Tb3VuZCA9IHNvdW5kOwogICAgfQoKICAgIGlmICh0eXBlb2YgbWFya2VyID09PSAnc3RyaW5nJykKICAgIHsKICAgICAgICB0aGlzLm9uRG93blNvdW5kTWFya2VyID0gbWFya2VyOwogICAgfQoKfQoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3ZlckhhbmRsZXIgPSBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PSBmYWxzZSkKICAgIHsKICAgICAgICBpZiAodGhpcy5fb25PdmVyRnJhbWVOYW1lICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHRoaXMuX29uT3ZlckZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25PdmVyRnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uT3ZlckZyYW1lSUQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLm9uT3ZlclNvdW5kKQogICAgewogICAgICAgIHRoaXMub25PdmVyU291bmQucGxheSh0aGlzLm9uT3ZlclNvdW5kTWFya2VyKTsKICAgIH0KCiAgICBpZiAodGhpcy5vbklucHV0T3ZlcikKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRPdmVyLmRpc3BhdGNoKHRoaXMsIHBvaW50ZXIpOwogICAgfQp9OwoKLyoqCiogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBoYW5kbGVzIGlucHV0IGV2ZW50cy4KKgoqIEBwcm90ZWN0ZWQKKiBAbWV0aG9kIFBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRPdmVySGFuZGxlcgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IHBvaW50ZXIgLSBUaGUgUG9pbnRlciB0aGF0IGFjdGl2YXRlZCB0aGUgQnV0dG9uLgoqLwpQaGFzZXIuQnV0dG9uLnByb3RvdHlwZS5vbklucHV0T3V0SGFuZGxlciA9IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgaWYgKHRoaXMuZnJlZXplRnJhbWVzID09IGZhbHNlKQogICAgewogICAgICAgIGlmICh0aGlzLl9vbk91dEZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vbk91dEZyYW1lTmFtZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodGhpcy5fb25PdXRGcmFtZUlEICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lID0gdGhpcy5fb25PdXRGcmFtZUlEOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5vbk91dFNvdW5kKQogICAgewogICAgICAgIHRoaXMub25PdXRTb3VuZC5wbGF5KHRoaXMub25PdXRTb3VuZE1hcmtlcik7CiAgICB9CgogICAgaWYgKHRoaXMub25JbnB1dE91dCkKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRPdXQuZGlzcGF0Y2godGhpcywgcG9pbnRlcik7CiAgICB9Cn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgaW5wdXQgZXZlbnRzLgoqCiogQHByb3RlY3RlZAoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE92ZXJIYW5kbGVyCiogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlciAtIFRoZSBQb2ludGVyIHRoYXQgYWN0aXZhdGVkIHRoZSBCdXR0b24uCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXREb3duSGFuZGxlciA9IGZ1bmN0aW9uIChwb2ludGVyKSB7CgogICAgaWYgKHRoaXMuZnJlZXplRnJhbWVzID09IGZhbHNlKQogICAgewogICAgICAgIGlmICh0aGlzLl9vbkRvd25GcmFtZU5hbWUgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWVOYW1lID0gdGhpcy5fb25Eb3duRnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vbkRvd25GcmFtZUlEICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lID0gdGhpcy5fb25Eb3duRnJhbWVJRDsKICAgICAgICB9CiAgICB9CgogICAgaWYgKHRoaXMub25Eb3duU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vbkRvd25Tb3VuZC5wbGF5KHRoaXMub25Eb3duU291bmRNYXJrZXIpOwogICAgfQoKICAgIGlmICh0aGlzLm9uSW5wdXREb3duKQogICAgewogICAgICAgIHRoaXMub25JbnB1dERvd24uZGlzcGF0Y2godGhpcywgcG9pbnRlcik7CiAgICB9Cn07CgovKioKKiBJbnRlcm5hbCBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgaW5wdXQgZXZlbnRzLgoqCiogQHByb3RlY3RlZAoqIEBtZXRob2QgUGhhc2VyLkJ1dHRvbi5wcm90b3R5cGUub25JbnB1dE92ZXJIYW5kbGVyCiogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlciAtIFRoZSBQb2ludGVyIHRoYXQgYWN0aXZhdGVkIHRoZSBCdXR0b24uCiovClBoYXNlci5CdXR0b24ucHJvdG90eXBlLm9uSW5wdXRVcEhhbmRsZXIgPSBmdW5jdGlvbiAocG9pbnRlcikgewoKICAgIGlmICh0aGlzLmZyZWV6ZUZyYW1lcyA9PSBmYWxzZSkKICAgIHsKICAgICAgICBpZiAodGhpcy5fb25VcEZyYW1lTmFtZSAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZU5hbWUgPSB0aGlzLl9vblVwRnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vblVwRnJhbWVJRCAhPSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5mcmFtZSA9IHRoaXMuX29uVXBGcmFtZUlEOwogICAgICAgIH0KICAgIH0KCiAgICBpZiAodGhpcy5vblVwU291bmQpCiAgICB7CiAgICAgICAgdGhpcy5vblVwU291bmQucGxheSh0aGlzLm9uVXBTb3VuZE1hcmtlcik7CiAgICB9CgogICAgaWYgKHRoaXMuZm9yY2VPdXQgJiYgdGhpcy5mcmVlemVGcmFtZXMgPT0gZmFsc2UpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX29uT3V0RnJhbWVOYW1lICE9IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmZyYW1lTmFtZSA9IHRoaXMuX29uT3V0RnJhbWVOYW1lOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLl9vbk91dEZyYW1lSUQgIT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZnJhbWUgPSB0aGlzLl9vbk91dEZyYW1lSUQ7CiAgICAgICAgfQogICAgfQoKICAgIGlmICh0aGlzLm9uSW5wdXRVcCkKICAgIHsKICAgICAgICB0aGlzLm9uSW5wdXRVcC5kaXNwYXRjaCh0aGlzLCBwb2ludGVyKTsKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IDxjb2RlPkdyYXBoaWNzPC9jb2RlPiBvYmplY3QuCiogCiogQGNsYXNzIFBoYXNlci5HcmFwaGljcwoqIEBjb25zdHJ1Y3RvcgoqCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBuZXcgZ3JhcGhpY3Mgb2JqZWN0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgbmV3IGdyYXBoaWNzIG9iamVjdC4KKi8KUGhhc2VyLkdyYXBoaWNzID0gZnVuY3Rpb24gKGdhbWUsIHgsIHkpIHsKCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIFBJWEkuR3JhcGhpY3MuY2FsbCh0aGlzKTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdHlwZSAtIERlc2NyaXB0aW9uLgoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5HUkFQSElDUzsKCiAgICB0aGlzLnBvc2l0aW9uLnggPSB4OwogICAgdGhpcy5wb3NpdGlvbi55ID0geTsgICAgCgp9OwoKUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5HcmFwaGljcy5wcm90b3R5cGUpOwpQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLmNvbnN0cnVjdG9yID0gUGhhc2VyLkdyYXBoaWNzOwoKLy8gIEFkZCBvdXIgb3duIGN1c3RvbSBtZXRob2RzCgovKioKKiBEZXNjcmlwdGlvbi4KKiAKKiBAbWV0aG9kIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLmRlc3Ryb3kKKi8KUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CgogICAgdGhpcy5jbGVhcigpOwoKICAgIGlmICh0aGlzLmdyb3VwKQogICAgewogICAgICAgIHRoaXMuZ3JvdXAucmVtb3ZlKHRoaXMpOwogICAgfQoKICAgIHRoaXMuZ2FtZSA9IG51bGw7Cgp9CgovKgoqIERyYXdzIGEge1BoYXNlci5Qb2x5Z29ufSBvciBhIHtQSVhJLlBvbHlnb259IGZpbGxlZAoqLwpQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLmRyYXdQb2x5Z29uID0gZnVuY3Rpb24gKHBvbHkpIHsKCiAgICBncmFwaGljcy5tb3ZlVG8ocG9seS5wb2ludHNbMF0ueCwgcG9seS5wb2ludHNbMF0ueSk7CgogICAgZm9yICh2YXIgaSA9IDE7IGkgPCBwb2x5LnBvaW50cy5sZW5ndGg7IGkgKz0gMSkKICAgIHsKICAgICAgICBncmFwaGljcy5saW5lVG8ocG9seS5wb2ludHNbaV0ueCwgcG9seS5wb2ludHNbaV0ueSk7CiAgICB9CgogICAgZ3JhcGhpY3MubGluZVRvKHBvbHkucG9pbnRzWzBdLngsIHBvbHkucG9pbnRzWzBdLnkpOwogICAgCn0KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuR3JhcGhpY3MucHJvdG90eXBlLCAnYW5nbGUnLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGgud3JhcEFuZ2xlKFBoYXNlci5NYXRoLnJhZFRvRGVnKHRoaXMucm90YXRpb24pKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucm90YXRpb24gPSBQaGFzZXIuTWF0aC5kZWdUb1JhZChQaGFzZXIuTWF0aC53cmFwQW5nbGUodmFsdWUpKTsKICAgIH0KCn0pOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5HcmFwaGljcy5wcm90b3R5cGUsICd4JywgewoKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucG9zaXRpb24ueDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbih2YWx1ZSkgewogICAgICAgIHRoaXMucG9zaXRpb24ueCA9IHZhbHVlOwogICAgfQoKfSk7CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkdyYXBoaWNzLnByb3RvdHlwZSwgJ3knLCB7CgogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gdGhpcy5wb3NpdGlvbi55OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgdGhpcy5wb3NpdGlvbi55ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgUmVuZGVyVGV4dHVyZSBpcyBhIHNwZWNpYWwgdGV4dHVyZSB0aGF0IGFsbG93cyBhbnkgZGlzcGxheU9iamVjdCB0byBiZSByZW5kZXJlZCB0byBpdC4KKiBAY2xhc3MgUGhhc2VyLlJlbmRlclRleHR1cmUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQ3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSByZW5kZXIgdGV4dHVyZS4KKiBAcGFyYW0ge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGggb2YgdGhlIHJlbmRlciB0ZXh0dXJlLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSB0aGUgaGVpZ2h0IG9mIHRoZSByZW5kZXIgdGV4dHVyZS4KKi8KUGhhc2VyLlJlbmRlclRleHR1cmUgPSBmdW5jdGlvbiAoZ2FtZSwga2V5LCB3aWR0aCwgaGVpZ2h0KSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4gCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSB0aGUgbmFtZSBvZiB0aGUgb2JqZWN0LiAKCSovCiAgICB0aGlzLm5hbWUgPSBrZXk7CgoJUElYSS5FdmVudFRhcmdldC5jYWxsKHRoaXMpOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSB0aGUgd2lkdGguIAogICAgKi8KCXRoaXMud2lkdGggPSB3aWR0aCB8fCAxMDA7CgkKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gdGhlIGhlaWdodC4gCiAgICAqLwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQgfHwgMTAwOwoKCS8qKgogICAgKiBAcHJvcGVydHkge1BJWEkubWF0M30gaW5kZXRpdHlNYXRyaXggLSBNYXRyaXggb2JqZWN0LiAKIAkqLwoJdGhpcy5pbmRldGl0eU1hdHJpeCA9IFBJWEkubWF0My5jcmVhdGUoKTsKCgkvKioKCSogQHByb3BlcnR5IHtQSVhJLlJlY3RhbmdsZX0gZnJhbWUgLSBUaGUgZnJhbWUgZm9yIHRoaXMgdGV4dHVyZS4gCiAgICAqLwoJdGhpcy5mcmFtZSA9IG5ldyBQSVhJLlJlY3RhbmdsZSgwLCAwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CQoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIEJhc2UgUGhhc2VyIG9iamVjdCB0eXBlLiAKICAgICovCgl0aGlzLnR5cGUgPSBQaGFzZXIuUkVOREVSVEVYVFVSRTsKCgl0aGlzLl90ZW1wUG9pbnQgPSB7IHg6IDAsIHk6IDAgfTsKCglpZiAoUElYSS5nbCkKCXsKCQl0aGlzLmluaXRXZWJHTCgpOwoJfQoJZWxzZQoJewoJCXRoaXMuaW5pdENhbnZhcygpOwoJfQoJCn07CgpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKFBJWEkuVGV4dHVyZS5wcm90b3R5cGUpOwpQaGFzZXIuUmVuZGVyVGV4dHVyZS5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQSVhJLlJlbmRlclRleHR1cmU7CgovKioKKiBUaGlzIGZ1bmN0aW9uIHdpbGwgZHJhdyB0aGUgZGlzcGxheSBvYmplY3QgdG8gdGhlIHRleHR1cmUuIElmIHRoZSBkaXNwbGF5IG9iamVjdCBpcyBhIEdyb3VwIG9yIGhhcyBjaGlsZHJlbiBpdCB3aWxsCiogZHJhdyBhbGwgY2hpbGRyZW4gYXMgd2VsbC4KKgoqIEBtZXRob2QgcmVuZGVyCiogQHBhcmFtIHtEaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24uCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtwb3NpdGlvbl0gLSBXaGVyZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcj1mYWxzZV0gLSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24uCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIpIHsKCglpZiAodHlwZW9mIHBvc2l0aW9uID09PSAndW5kZWZpbmVkJykgeyBwb3NpdGlvbiA9IGZhbHNlOyB9CglpZiAodHlwZW9mIGNsZWFyID09PSAndW5kZWZpbmVkJykgeyBjbGVhciA9IGZhbHNlOyB9CgoJaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQaGFzZXIuR3JvdXApCgl7CgkJZGlzcGxheU9iamVjdCA9IGRpc3BsYXlPYmplY3QuX2NvbnRhaW5lcjsKCX0KCglpZiAoUElYSS5nbCkKCXsKCQl0aGlzLnJlbmRlcldlYkdMKGRpc3BsYXlPYmplY3QsIHBvc2l0aW9uLCBjbGVhcik7Cgl9CgllbHNlCgl7CgkJdGhpcy5yZW5kZXJDYW52YXMoZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKTsKCX0KCn0KCi8qKgoqIFRoaXMgZnVuY3Rpb24gd2lsbCBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCB0byB0aGUgdGV4dHVyZSBhdCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzLgoqIElmIHRoZSBkaXNwbGF5IG9iamVjdCBpcyBhIEdyb3VwIG9yIGhhcyBjaGlsZHJlbiBpdCB3aWxsIGRyYXcgYWxsIGNoaWxkcmVuIGFzIHdlbGwuCioKKiBAbWV0aG9kIHJlbmRlclhZCiogQHBhcmFtIHtEaXNwbGF5T2JqZWN0fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24uCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIHRvIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IGF0LgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSB0byBkcmF3IHRoZSBkaXNwbGF5IG9iamVjdCBhdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtjbGVhcj1mYWxzZV0gLSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24uCiovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJYWSA9IGZ1bmN0aW9uKGRpc3BsYXlPYmplY3QsIHgsIHksIGNsZWFyKSB7CgoJdGhpcy5fdGVtcFBvaW50LnggPSB4OwoJdGhpcy5fdGVtcFBvaW50LnkgPSB5OwoKCXRoaXMucmVuZGVyKGRpc3BsYXlPYmplY3QsIHRoaXMuX3RlbXBQb2ludCwgY2xlYXIpOwoKfQoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSB3ZWJnbCBkYXRhIGZvciB0aGlzIHRleHR1cmUKICoKICogQG1ldGhvZCBpbml0V2ViR0wKICogQHByaXZhdGUKICovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5pbml0V2ViR0wgPSBmdW5jdGlvbigpCnsKCXZhciBnbCA9IFBJWEkuZ2w7Cgl0aGlzLmdsRnJhbWVidWZmZXIgPSBnbC5jcmVhdGVGcmFtZWJ1ZmZlcigpOwoKICAgCWdsLmJpbmRGcmFtZWJ1ZmZlcihnbC5GUkFNRUJVRkZFUiwgdGhpcy5nbEZyYW1lYnVmZmVyICk7CgogICAgdGhpcy5nbEZyYW1lYnVmZmVyLndpZHRoID0gdGhpcy53aWR0aDsKICAgIHRoaXMuZ2xGcmFtZWJ1ZmZlci5oZWlnaHQgPSB0aGlzLmhlaWdodDsJCgoJdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKCk7CgoJdGhpcy5iYXNlVGV4dHVyZS53aWR0aCA9IHRoaXMud2lkdGg7Cgl0aGlzLmJhc2VUZXh0dXJlLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSA9IGdsLmNyZWF0ZVRleHR1cmUoKTsKICAgIGdsLmJpbmRUZXh0dXJlKGdsLlRFWFRVUkVfMkQsIHRoaXMuYmFzZVRleHR1cmUuX2dsVGV4dHVyZSk7CgoJZ2wudGV4SW1hZ2UyRChnbC5URVhUVVJFXzJELCAwLCBnbC5SR0JBLCAgdGhpcy53aWR0aCwgIHRoaXMuaGVpZ2h0LCAwLCBnbC5SR0JBLCBnbC5VTlNJR05FRF9CWVRFLCBudWxsKTsKCiAgICBnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfTUFHX0ZJTFRFUiwgZ2wuTElORUFSKTsKCWdsLnRleFBhcmFtZXRlcmkoZ2wuVEVYVFVSRV8yRCwgZ2wuVEVYVFVSRV9NSU5fRklMVEVSLCBnbC5MSU5FQVIpOwoJZ2wudGV4UGFyYW1ldGVyaShnbC5URVhUVVJFXzJELCBnbC5URVhUVVJFX1dSQVBfUywgZ2wuQ0xBTVBfVE9fRURHRSk7CglnbC50ZXhQYXJhbWV0ZXJpKGdsLlRFWFRVUkVfMkQsIGdsLlRFWFRVUkVfV1JBUF9ULCBnbC5DTEFNUF9UT19FREdFKTsKCgl0aGlzLmJhc2VUZXh0dXJlLmlzUmVuZGVyID0gdHJ1ZTsKCglnbC5iaW5kRnJhbWVidWZmZXIoZ2wuRlJBTUVCVUZGRVIsIHRoaXMuZ2xGcmFtZWJ1ZmZlciApOwoJZ2wuZnJhbWVidWZmZXJUZXh0dXJlMkQoZ2wuRlJBTUVCVUZGRVIsIGdsLkNPTE9SX0FUVEFDSE1FTlQwLCBnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUsIDApOwoKCS8vIGNyZWF0ZSBhIHByb2plY3Rpb24gbWF0cml4Li4KCXRoaXMucHJvamVjdGlvbiA9IG5ldyBQSVhJLlBvaW50KHRoaXMud2lkdGgvMiAsIC10aGlzLmhlaWdodC8yKTsKCgkvLyBzZXQgdGhlIGNvcnJlY3QgcmVuZGVyIGZ1bmN0aW9uLi4KCS8vIHRoaXMucmVuZGVyID0gdGhpcy5yZW5kZXJXZWJHTDsKfQoKClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQp7CgoJdGhpcy53aWR0aCA9IHdpZHRoOwoJdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgkKCWlmKFBJWEkuZ2wpCgl7CgkJdGhpcy5wcm9qZWN0aW9uLnggPSB0aGlzLndpZHRoLzIKCQl0aGlzLnByb2plY3Rpb24ueSA9IC10aGlzLmhlaWdodC8yOwoJCgkJdmFyIGdsID0gUElYSS5nbDsKCQlnbC5iaW5kVGV4dHVyZShnbC5URVhUVVJFXzJELCB0aGlzLmJhc2VUZXh0dXJlLl9nbFRleHR1cmUpOwoJCWdsLnRleEltYWdlMkQoZ2wuVEVYVFVSRV8yRCwgMCwgZ2wuUkdCQSwgIHRoaXMud2lkdGgsICB0aGlzLmhlaWdodCwgMCwgZ2wuUkdCQSwgZ2wuVU5TSUdORURfQllURSwgbnVsbCk7Cgl9CgllbHNlCgl7CgkJCgkJdGhpcy5mcmFtZS53aWR0aCA9IHRoaXMud2lkdGgKCQl0aGlzLmZyYW1lLmhlaWdodCA9IHRoaXMuaGVpZ2h0OwoJCXRoaXMucmVuZGVyZXIucmVzaXplKHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCX0KfQoKLyoqCiAqIEluaXRpYWxpemVzIHRoZSBjYW52YXMgZGF0YSBmb3IgdGhpcyB0ZXh0dXJlCiAqCiAqIEBtZXRob2QgaW5pdENhbnZhcwogKiBAcHJpdmF0ZQogKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLmluaXRDYW52YXMgPSBmdW5jdGlvbigpCnsKCXRoaXMucmVuZGVyZXIgPSBuZXcgUElYSS5DYW52YXNSZW5kZXJlcih0aGlzLndpZHRoLCB0aGlzLmhlaWdodCwgbnVsbCwgMCk7CgoJdGhpcy5iYXNlVGV4dHVyZSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKHRoaXMucmVuZGVyZXIudmlldyk7Cgl0aGlzLmZyYW1lID0gbmV3IFBJWEkuUmVjdGFuZ2xlKDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCgkvLyB0aGlzLnJlbmRlciA9IHRoaXMucmVuZGVyQ2FudmFzOwp9CgovKioKICogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgogKgogKiBAbWV0aG9kIHJlbmRlcldlYkdMCiAqIEBwYXJhbSBkaXNwbGF5T2JqZWN0IHtEaXNwbGF5T2JqZWN0fSBUaGUgZGlzcGxheSBvYmplY3QgdG8gcmVuZGVyIHRoaXMgdGV4dHVyZSBvbgogKiBAcGFyYW0gY2xlYXIge0Jvb2xlYW59IElmIHRydWUgdGhlIHRleHR1cmUgd2lsbCBiZSBjbGVhcmVkIGJlZm9yZSB0aGUgZGlzcGxheU9iamVjdCBpcyBkcmF3bgogKiBAcHJpdmF0ZQogKi8KUGhhc2VyLlJlbmRlclRleHR1cmUucHJvdG90eXBlLnJlbmRlcldlYkdMID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCwgcG9zaXRpb24sIGNsZWFyKQp7Cgl2YXIgZ2wgPSBQSVhJLmdsOwoKCS8vIGVuYWJsZSB0aGUgYWxwaGEgY29sb3IgbWFzay4uCglnbC5jb2xvck1hc2sodHJ1ZSwgdHJ1ZSwgdHJ1ZSwgdHJ1ZSk7IAoKCWdsLnZpZXdwb3J0KDAsIDAsIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsJCgoJZ2wuYmluZEZyYW1lYnVmZmVyKGdsLkZSQU1FQlVGRkVSLCB0aGlzLmdsRnJhbWVidWZmZXIgKTsKCglpZihjbGVhcikKCXsKCQlnbC5jbGVhckNvbG9yKDAsMCwwLCAwKTsgICAgIAoJCWdsLmNsZWFyKGdsLkNPTE9SX0JVRkZFUl9CSVQpOwoJfQoKCS8vIFRISVMgV0lMTCBNRVNTIFdJVEggSElUIFRFU1RJTkchCgl2YXIgY2hpbGRyZW4gPSBkaXNwbGF5T2JqZWN0LmNoaWxkcmVuOwoKCS8vVE9ETyAtPyBjcmVhdGUgYSBuZXcgb25lPz8/IGRvbnQgdGhpbmsgc28hCgl2YXIgb3JpZ2luYWxXb3JsZFRyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CglkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtID0gUElYSS5tYXQzLmNyZWF0ZSgpOy8vc3RoaXMuaW5kZXRpdHlNYXRyaXg7CgkvLyBtb2RpZnkgdG8gZmxpcC4uLgoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSA9IC0xOwoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHRoaXMucHJvamVjdGlvbi55ICogLTI7CgoJaWYocG9zaXRpb24pCgl7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSAtPSBwb3NpdGlvbi55OwoJfQoJCglQSVhJLnZpc2libGVDb3VudCsrOwoJZGlzcGxheU9iamVjdC52Y291bnQgPSBQSVhJLnZpc2libGVDb3VudDsKCQoJZm9yKHZhciBpPTAsaj1jaGlsZHJlbi5sZW5ndGg7IGk8ajsgaSsrKQoJewoJCWNoaWxkcmVuW2ldLnVwZGF0ZVRyYW5zZm9ybSgpOwkKCX0KCgl2YXIgcmVuZGVyR3JvdXAgPSBkaXNwbGF5T2JqZWN0Ll9fcmVuZGVyR3JvdXA7CgoJaWYocmVuZGVyR3JvdXApCgl7CgkJaWYoZGlzcGxheU9iamVjdCA9PSByZW5kZXJHcm91cC5yb290KQoJCXsKCQkJcmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCQl9CgkJZWxzZQoJCXsKCQkJcmVuZGVyR3JvdXAucmVuZGVyU3BlY2lmaWMoZGlzcGxheU9iamVjdCwgdGhpcy5wcm9qZWN0aW9uLCB0aGlzLmdsRnJhbWVidWZmZXIpOwoJCX0KCX0KCWVsc2UKCXsKCQlpZighdGhpcy5yZW5kZXJHcm91cCl0aGlzLnJlbmRlckdyb3VwID0gbmV3IFBJWEkuV2ViR0xSZW5kZXJHcm91cChnbCk7CgkJdGhpcy5yZW5kZXJHcm91cC5zZXRSZW5kZXJhYmxlKGRpc3BsYXlPYmplY3QpOwoJCXRoaXMucmVuZGVyR3JvdXAucmVuZGVyKHRoaXMucHJvamVjdGlvbiwgdGhpcy5nbEZyYW1lYnVmZmVyKTsKCX0KCQoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IG9yaWdpbmFsV29ybGRUcmFuc2Zvcm07Cn0KCgovKioKICogVGhpcyBmdW5jdGlvbiB3aWxsIGRyYXcgdGhlIGRpc3BsYXkgb2JqZWN0IHRvIHRoZSB0ZXh0dXJlLgogKgogKiBAbWV0aG9kIHJlbmRlckNhbnZhcwogKiBAcGFyYW0gZGlzcGxheU9iamVjdCB7RGlzcGxheU9iamVjdH0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIHJlbmRlciB0aGlzIHRleHR1cmUgb24KICogQHBhcmFtIGNsZWFyIHtCb29sZWFufSBJZiB0cnVlIHRoZSB0ZXh0dXJlIHdpbGwgYmUgY2xlYXJlZCBiZWZvcmUgdGhlIGRpc3BsYXlPYmplY3QgaXMgZHJhd24KICogQHByaXZhdGUKICovClBoYXNlci5SZW5kZXJUZXh0dXJlLnByb3RvdHlwZS5yZW5kZXJDYW52YXMgPSBmdW5jdGlvbihkaXNwbGF5T2JqZWN0LCBwb3NpdGlvbiwgY2xlYXIpCnsKCXZhciBjaGlsZHJlbiA9IGRpc3BsYXlPYmplY3QuY2hpbGRyZW47CgoJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybSA9IFBJWEkubWF0My5jcmVhdGUoKTsKCQoJaWYocG9zaXRpb24pCgl7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSA9IHBvc2l0aW9uLng7CgkJZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSA9IHBvc2l0aW9uLnk7Cgl9CgkKCglmb3IodmFyIGk9MCxqPWNoaWxkcmVuLmxlbmd0aDsgaTxqOyBpKyspCgl7CgkJY2hpbGRyZW5baV0udXBkYXRlVHJhbnNmb3JtKCk7CQoJfQoKCWlmKGNsZWFyKXRoaXMucmVuZGVyZXIuY29udGV4dC5jbGVhclJlY3QoMCwwLCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgkKICAgIHRoaXMucmVuZGVyZXIucmVuZGVyRGlzcGxheU9iamVjdChkaXNwbGF5T2JqZWN0KTsKICAgIAogICAgdGhpcy5yZW5kZXJlci5jb250ZXh0LnNldFRyYW5zZm9ybSgxLDAsMCwxLDAsMCk7IAogICAgCgogIC8vICBQSVhJLnRleHR1cmVzVG9VcGRhdGUucHVzaCh0aGlzLmJhc2VUZXh0dXJlKTsKfQoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIENhbnZhcyBjbGFzcyBoYW5kbGVzIGV2ZXJ5dGhpbmcgcmVsYXRlZCB0byB0aGUgJmx0O2NhbnZhcyZndDsgdGFnIGFzIGEgRE9NIEVsZW1lbnQsIGxpa2Ugc3R5bGVzLCBvZmZzZXQsIGFzcGVjdCByYXRpbwoqCiogQGNsYXNzIFBoYXNlci5DYW52YXMKKiBAc3RhdGljCiovClBoYXNlci5DYW52YXMgPSB7CgogICAgLyoqCiAgICAqIENyZWF0ZXMgdGhlICZsdDtjYW52YXMmZ3Q7IHRhZwogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuY3JlYXRlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBkZXNpcmVkIHdpZHRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gaGVpZ2h0IC0gVGhlIGRlc2lyZWQgaGVpZ2h0LgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gVGhlIG5ld2x5IGNyZWF0ZWQgJmx0O2NhbnZhcyZndDsgdGFnLgogICAgKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgd2lkdGggPSB3aWR0aCB8fCAyNTY7CiAgICAgICAgaGVpZ2h0ID0gaGVpZ2h0IHx8IDI1NjsKCiAgICAgICAgdmFyIGNhbnZhcyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpOwogICAgICAgIGNhbnZhcy53aWR0aCA9IHdpZHRoOwogICAgICAgIGNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgY2FudmFzLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCB0aGUgRE9NIG9mZnNldCB2YWx1ZXMgb2YgYW55IGdpdmVuIGVsZW1lbnQKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLmdldE9mZnNldAogICAgKiBAcGFyYW0ge0hUTUxFbGVtZW50fSBlbGVtZW50IC0gVGhlIHRhcmdldGVkIGVsZW1lbnQgdGhhdCB3ZSB3YW50IHRvIHJldHJpZXZlIHRoZSBvZmZzZXQuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbcG9pbnRdIC0gVGhlIHBvaW50IHdlIHdhbnQgdG8gdGFrZSB0aGUgeC95IHZhbHVlcyBvZiB0aGUgb2Zmc2V0LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IC0gQSBwb2ludCBvYmpldCB3aXRoIHRoZSBvZmZzZXRYIGFuZCBZIGFzIGl0cyBwcm9wZXJ0aWVzLgogICAgKi8gICAgCiAgICBnZXRPZmZzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBwb2ludCkgewoKICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgICAgIHZhciBib3ggPSBlbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOwogICAgICAgIHZhciBjbGllbnRUb3AgPSBlbGVtZW50LmNsaWVudFRvcCB8fCBkb2N1bWVudC5ib2R5LmNsaWVudFRvcCB8fCAwOwogICAgICAgIHZhciBjbGllbnRMZWZ0ID0gZWxlbWVudC5jbGllbnRMZWZ0IHx8IGRvY3VtZW50LmJvZHkuY2xpZW50TGVmdCB8fCAwOwogICAgICAgIHZhciBzY3JvbGxUb3AgPSB3aW5kb3cucGFnZVlPZmZzZXQgfHwgZWxlbWVudC5zY3JvbGxUb3AgfHwgZG9jdW1lbnQuYm9keS5zY3JvbGxUb3A7CiAgICAgICAgdmFyIHNjcm9sbExlZnQgPSB3aW5kb3cucGFnZVhPZmZzZXQgfHwgZWxlbWVudC5zY3JvbGxMZWZ0IHx8IGRvY3VtZW50LmJvZHkuc2Nyb2xsTGVmdDsKCiAgICAgICAgcG9pbnQueCA9IGJveC5sZWZ0ICsgc2Nyb2xsTGVmdCAtIGNsaWVudExlZnQ7CiAgICAgICAgcG9pbnQueSA9IGJveC50b3AgKyBzY3JvbGxUb3AgLSBjbGllbnRUb3A7CgogICAgICAgIHJldHVybiBwb2ludDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBhc3BlY3QgcmF0aW8gb2YgdGhlIGdpdmVuIGNhbnZhcy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLmdldEFzcGVjdFJhdGlvCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gZ2V0IHRoZSBhc3BlY3QgcmF0aW8gZnJvbS4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgcmF0aW8gYmV0d2VlbiBjYW52YXMnIHdpZHRoIGFuZCBoZWlnaHQuCiAgICAqLyAgICAgICAgCiAgICBnZXRBc3BlY3RSYXRpbzogZnVuY3Rpb24gKGNhbnZhcykgewogICAgICAgIHJldHVybiBjYW52YXMud2lkdGggLyBjYW52YXMuaGVpZ2h0OwogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgYmFja2dyb3VuZCBjb2xvciBiZWhpbmQgdGhlIGNhbnZhcy4gVGhpcyBjaGFuZ2VzIHRoZSBjYW52YXMgc3R5bGUgcHJvcGVydHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRCYWNrZ3JvdW5kQ29sb3IKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIGJhY2tncm91bmQgY29sb3Igb24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3JdIC0gVGhlIGNvbG9yIHRvIHNldC4gQ2FuIGJlIGluIHRoZSBmb3JtYXQgJ3JnYihyLGcsYiknLCBvciAnI1JSR0dCQicgb3IgYW55IHZhbGlkIENTUyBjb2xvci4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFJldHVybnMgdGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0QmFja2dyb3VuZENvbG9yOiBmdW5jdGlvbiAoY2FudmFzLCBjb2xvcikgewoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMCwwLDApJzsKCiAgICAgICAgY2FudmFzLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yOwogICAgICAgIAogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgdG91Y2gtYWN0aW9uIHByb3BlcnR5IG9uIHRoZSBjYW52YXMgc3R5bGUuIENhbiBiZSB1c2VkIHRvIGRpc2FibGUgZGVmYXVsdCBicm93c2VyIHRvdWNoIGFjdGlvbnMuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRUb3VjaEFjdGlvbgogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgdG91Y2ggYWN0aW9uIG9uLgogICAgKiBAcGFyYW0ge1N0cmluZ30gW3ZhbHVlXSAtIFRoZSB0b3VjaCBhY3Rpb24gdG8gc2V0LiBEZWZhdWx0cyB0byAnbm9uZScuCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBUaGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBzZXRUb3VjaEFjdGlvbjogZnVuY3Rpb24gKGNhbnZhcywgdmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAnbm9uZSc7CgogICAgICAgIGNhbnZhcy5zdHlsZS5tc1RvdWNoQWN0aW9uID0gdmFsdWU7CiAgICAgICAgY2FudmFzLnN0eWxlWydtcy10b3VjaC1hY3Rpb24nXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsndG91Y2gtYWN0aW9uJ10gPSB2YWx1ZTsKCiAgICAgICAgcmV0dXJuIGNhbnZhczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSB1c2VyLXNlbGVjdCBwcm9wZXJ0eSBvbiB0aGUgY2FudmFzIHN0eWxlLiBDYW4gYmUgdXNlZCB0byBkaXNhYmxlIGRlZmF1bHQgYnJvd3NlciBzZWxlY3Rpb24gYWN0aW9ucy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldFVzZXJTZWxlY3QKICAgICogQHBhcmFtIHtIVE1MQ2FudmFzRWxlbWVudH0gY2FudmFzIC0gVGhlIGNhbnZhcyB0byBzZXQgdGhlIHRvdWNoIGFjdGlvbiBvbi4KICAgICogQHBhcmFtIHtTdHJpbmd9IFt2YWx1ZV0gLSBUaGUgdG91Y2ggYWN0aW9uIHRvIHNldC4gRGVmYXVsdHMgdG8gJ25vbmUnLgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gVGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0VXNlclNlbGVjdDogZnVuY3Rpb24gKGNhbnZhcywgdmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCAnbm9uZSc7CgogICAgICAgIGNhbnZhcy5zdHlsZVsnLXdlYmtpdC10b3VjaC1jYWxsb3V0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLWtodG1sLXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy1tb3otdXNlci1zZWxlY3QnXSA9IHZhbHVlOwogICAgICAgIGNhbnZhcy5zdHlsZVsnLW1zLXVzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJ3VzZXItc2VsZWN0J10gPSB2YWx1ZTsKICAgICAgICBjYW52YXMuc3R5bGVbJy13ZWJraXQtdGFwLWhpZ2hsaWdodC1jb2xvciddID0gJ3JnYmEoMCwgMCwgMCwgMCknOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgdGhlIGdpdmVuIGNhbnZhcyBlbGVtZW50IHRvIHRoZSBET00uIFRoZSBjYW52YXMgd2lsbCBiZSBhZGRlZCBhcyBhIGNoaWxkIG9mIHRoZSBnaXZlbiBwYXJlbnQuCiAgICAqIElmIG5vIHBhcmVudCBpcyBnaXZlbiBpdCB3aWxsIGJlIGFkZGVkIGFzIGEgY2hpbGQgb2YgdGhlIGRvY3VtZW50LmJvZHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5hZGRUb0RPTQogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgLSBUaGUgY2FudmFzIHRvIHNldCB0aGUgdG91Y2ggYWN0aW9uIG9uLgogICAgKiBAcGFyYW0ge3N0cmluZ3xIVE1MRWxlbWVudH0gcGFyZW50IC0gVGhlIERPTSBlbGVtZW50IHRvIGFkZCB0aGUgY2FudmFzIHRvLiBEZWZhdWx0cyB0byAnJy4KICAgICogQHBhcmFtIHtib29sZWFufSBvdmVyZmxvd0hpZGRlbiAtIElmIHNldCB0byB0cnVlIGl0IHdpbGwgYWRkIHRoZSBvdmVyZmxvdz0naGlkZGVuJyBzdHlsZSB0byB0aGUgcGFyZW50IERPTSBlbGVtZW50LgogICAgKiBAcmV0dXJuIHtIVE1MQ2FudmFzRWxlbWVudH0gUmV0dXJucyB0aGUgc291cmNlIGNhbnZhcy4KICAgICovCiAgICBhZGRUb0RPTTogZnVuY3Rpb24gKGNhbnZhcywgcGFyZW50LCBvdmVyZmxvd0hpZGRlbikgewoKICAgICAgICB2YXIgdGFyZ2V0OwoKICAgICAgICBpZiAodHlwZW9mIG92ZXJmbG93SGlkZGVuID09PSAndW5kZWZpbmVkJykgeyBvdmVyZmxvd0hpZGRlbiA9IHRydWU7IH0KCiAgICAgICAgaWYgKHBhcmVudCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIGhvcGVmdWxseSBhbiBlbGVtZW50IElECiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyZW50ID09PSAnc3RyaW5nJykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocGFyZW50KTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBxdWljayB0ZXN0IGZvciBhIEhUTUxlbGVtZW50CiAgICAgICAgICAgIGVsc2UgaWYgKHR5cGVvZiBwYXJlbnQgPT09ICdvYmplY3QnICYmIHBhcmVudC5ub2RlVHlwZSA9PT0gMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gcGFyZW50OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAob3ZlcmZsb3dIaWRkZW4pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRhcmdldC5zdHlsZS5vdmVyZmxvdyA9ICdoaWRkZW4nOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyBmYWxsYmFjaywgY292ZXJzIGFuIGludmFsaWQgSUQgYW5kIGEgbm9uZSBIVE1MZWxlbWVudCBvYmplY3QKICAgICAgICBpZighdGFyZ2V0KQogICAgICAgIHsKICAgICAgICAgICAgdGFyZ2V0ID0gZG9jdW1lbnQuYm9keTsKICAgICAgICB9CgogICAgICAgIHRhcmdldC5hcHBlbmRDaGlsZChjYW52YXMpOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHRyYW5zZm9ybSBvZiB0aGUgZ2l2ZW4gY2FudmFzIHRvIHRoZSBtYXRyaXggdmFsdWVzIHByb3ZpZGVkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0VHJhbnNmb3JtCiAgICAqIEBwYXJhbSB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBjb250ZXh0IC0gVGhlIGNvbnRleHQgdG8gc2V0IHRoZSB0cmFuc2Zvcm0gb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0cmFuc2xhdGVYIC0gVGhlIHZhbHVlIHRvIHRyYW5zbGF0ZSBob3Jpem9udGFsbHkgYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0cmFuc2xhdGVZIC0gVGhlIHZhbHVlIHRvIHRyYW5zbGF0ZSB2ZXJ0aWNhbGx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gc2NhbGVYIC0gVGhlIHZhbHVlIHRvIHNjYWxlIGhvcml6b250YWxseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNjYWxlWSAtIFRoZSB2YWx1ZSB0byBzY2FsZSB2ZXJ0aWNhbGx5IGJ5LgogICAgKiBAcGFyYW0ge251bWJlcn0gc2tld1ggLSBUaGUgdmFsdWUgdG8gc2tldyBob3Jpem9udGFseSBieS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHNrZXdZIC0gVGhlIHZhbHVlIHRvIHNrZXcgdmVydGljYWxseSBieS4KICAgICogQHJldHVybiB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBSZXR1cm5zIHRoZSBzb3VyY2UgY29udGV4dC4KICAgICovCiAgICBzZXRUcmFuc2Zvcm06IGZ1bmN0aW9uIChjb250ZXh0LCB0cmFuc2xhdGVYLCB0cmFuc2xhdGVZLCBzY2FsZVgsIHNjYWxlWSwgc2tld1gsIHNrZXdZKSB7CgogICAgICAgIGNvbnRleHQuc2V0VHJhbnNmb3JtKHNjYWxlWCwgc2tld1gsIHNrZXdZLCBzY2FsZVksIHRyYW5zbGF0ZVgsIHRyYW5zbGF0ZVkpOwoKICAgICAgICByZXR1cm4gY29udGV4dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBJbWFnZSBTbW9vdGhpbmcgcHJvcGVydHkgb24gdGhlIGdpdmVuIGNvbnRleHQuIFNldCB0byBmYWxzZSB0byBkaXNhYmxlIGltYWdlIHNtb290aGluZy4KICAgICogQnkgZGVmYXVsdCBicm93c2VycyBoYXZlIGltYWdlIHNtb290aGluZyBlbmFibGVkLCB3aGljaCBpc24ndCBhbHdheXMgd2hhdCB5b3UgdmlzdWFsbHkgd2FudCwgZXNwZWNpYWxseQogICAgKiB3aGVuIHVzaW5nIHBpeGVsIGFydCBpbiBhIGdhbWUuIE5vdGUgdGhhdCB0aGlzIHNldHMgdGhlIHByb3BlcnR5IG9uIHRoZSBjb250ZXh0IGl0c2VsZiwgc28gdGhhdCBhbnkgaW1hZ2UKICAgICogZHJhd24gdG8gdGhlIGNvbnRleHQgd2lsbCBiZSBhZmZlY3RlZC4gVGhpcyBzZXRzIHRoZSBwcm9wZXJ0eSBhY3Jvc3MgYWxsIGN1cnJlbnQgYnJvd3NlcnMgYnV0IHN1cHBvcnQgaXMKICAgICogcGF0Y2h5IG9uIGVhcmxpZXIgYnJvd3NlcnMsIGVzcGVjaWFsbHkgb24gbW9iaWxlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYW52YXMuc2V0U21vb3RoaW5nRW5hYmxlZAogICAgKiBAcGFyYW0ge0NhbnZhc1JlbmRlcmluZ0NvbnRleHQyRH0gY29udGV4dCAtIFRoZSBjb250ZXh0IHRvIGVuYWJsZSBvciBkaXNhYmxlIHRoZSBpbWFnZSBzbW9vdGhpbmcgb24uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gdmFsdWUgLSBJZiBzZXQgdG8gdHJ1ZSBpdCB3aWxsIGVuYWJsZSBpbWFnZSBzbW9vdGhpbmcsIGZhbHNlIHdpbGwgZGlzYWJsZSBpdC4KICAgICogQHJldHVybiB7Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEfSBSZXR1cm5zIHRoZSBzb3VyY2UgY29udGV4dC4KICAgICovCiAgICBzZXRTbW9vdGhpbmdFbmFibGVkOiBmdW5jdGlvbiAoY29udGV4dCwgdmFsdWUpIHsKCiAgICAgICAgY29udGV4dFsnaW1hZ2VTbW9vdGhpbmdFbmFibGVkJ10gPSB2YWx1ZTsKICAgICAgICBjb250ZXh0Wydtb3pJbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwogICAgICAgIGNvbnRleHRbJ29JbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwogICAgICAgIGNvbnRleHRbJ3dlYmtpdEltYWdlU21vb3RoaW5nRW5hYmxlZCddID0gdmFsdWU7CiAgICAgICAgY29udGV4dFsnbXNJbWFnZVNtb290aGluZ0VuYWJsZWQnXSA9IHZhbHVlOwoKICAgICAgICByZXR1cm4gY29udGV4dDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBDU1MgaW1hZ2UtcmVuZGVyaW5nIHByb3BlcnR5IG9uIHRoZSBnaXZlbiBjYW52YXMgdG8gYmUgJ2NyaXNwJyAoYWthICdvcHRpbWl6ZSBjb250cmFzdCBvbiB3ZWJraXQnKS4KICAgICogTm90ZSB0aGF0IGlmIHRoaXMgZG9lc24ndCBnaXZlbiB0aGUgZGVzaXJlZCByZXN1bHQgdGhlbiBzZWUgdGhlIHNldFNtb290aGluZ0VuYWJsZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhbnZhcy5zZXRJbWFnZVJlbmRlcmluZ0NyaXNwCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIFRoZSBjYW52YXMgdG8gc2V0IGltYWdlLXJlbmRlcmluZyBjcmlzcCBvbi4KICAgICogQHJldHVybiB7SFRNTENhbnZhc0VsZW1lbnR9IFJldHVybnMgdGhlIHNvdXJjZSBjYW52YXMuCiAgICAqLwogICAgc2V0SW1hZ2VSZW5kZXJpbmdDcmlzcDogZnVuY3Rpb24gKGNhbnZhcykgewoKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJ2NyaXNwLWVkZ2VzJzsKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJy1tb3otY3Jpc3AtZWRnZXMnOwogICAgICAgIGNhbnZhcy5zdHlsZVsnaW1hZ2UtcmVuZGVyaW5nJ10gPSAnLXdlYmtpdC1vcHRpbWl6ZS1jb250cmFzdCc7CiAgICAgICAgY2FudmFzLnN0eWxlLm1zSW50ZXJwb2xhdGlvbk1vZGUgPSAnbmVhcmVzdC1uZWlnaGJvcic7CgogICAgICAgIHJldHVybiBjYW52YXM7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgQ1NTIGltYWdlLXJlbmRlcmluZyBwcm9wZXJ0eSBvbiB0aGUgZ2l2ZW4gY2FudmFzIHRvIGJlICdiaWN1YmljJyAoYWthICdhdXRvJykuCiAgICAqIE5vdGUgdGhhdCBpZiB0aGlzIGRvZXNuJ3QgZ2l2ZW4gdGhlIGRlc2lyZWQgcmVzdWx0IHRoZW4gc2VlIHRoZSBDYW52YXNVdGlscy5zZXRTbW9vdGhpbmdFbmFibGVkIG1ldGhvZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FudmFzLnNldEltYWdlUmVuZGVyaW5nQmljdWJpYwogICAgKiBAcGFyYW0ge0hUTUxDYW52YXNFbGVtZW50fSBjYW52YXMgVGhlIGNhbnZhcyB0byBzZXQgaW1hZ2UtcmVuZGVyaW5nIGJpY3ViaWMgb24uCiAgICAqIEByZXR1cm4ge0hUTUxDYW52YXNFbGVtZW50fSBSZXR1cm5zIHRoZSBzb3VyY2UgY2FudmFzLgogICAgKi8KICAgIHNldEltYWdlUmVuZGVyaW5nQmljdWJpYzogZnVuY3Rpb24gKGNhbnZhcykgewoKICAgICAgICBjYW52YXMuc3R5bGVbJ2ltYWdlLXJlbmRlcmluZyddID0gJ2F1dG8nOwogICAgICAgIGNhbnZhcy5zdHlsZS5tc0ludGVycG9sYXRpb25Nb2RlID0gJ2JpY3ViaWMnOwoKICAgICAgICByZXR1cm4gY2FudmFzOwoKICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBbiBBbmltYXRpb24gaW5zdGFuY2UgY29udGFpbnMgYSBzaW5nbGUgYW5pbWF0aW9uIGFuZCB0aGUgY29udHJvbHMgdG8gcGxheSBpdC4KKiBJdCBpcyBjcmVhdGVkIGJ5IHRoZSBBbmltYXRpb25NYW5hZ2VyLCBjb25zaXN0cyBvZiBBbmltYXRpb24uRnJhbWUgb2JqZWN0cyBhbmQgYmVsb25ncyB0byBhIHNpbmdsZSBHYW1lIE9iamVjdCBzdWNoIGFzIGEgU3ByaXRlLgoqCiogQGNsYXNzIFBoYXNlci5TdGFnZVNjYWxlTW9kZSAKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIERlc2NyaXB0aW9uLgoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUgPSBmdW5jdGlvbiAoZ2FtZSwgd2lkdGgsIGhlaWdodCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gV2lkdGggb2YgdGhlIHN0YWdlIGFmdGVyIGNhbGN1bGF0aW9uLgogICAgKi8KICAgIHRoaXMud2lkdGggPSB3aWR0aDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgc3RhZ2UgYWZ0ZXIgY2FsY3VsYXRpb24uCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5XaWR0aCAtIE1pbmltdW0gd2lkdGggdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWluV2lkdGggPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4V2lkdGggLSBNYXhpbXVtIHdpZHRoIHRoZSBjYW52YXMgc2hvdWxkIGJlIHNjYWxlZCB0byAoaW4gcGl4ZWxzKS4KICAgICogSWYgbnVsbCBpdCB3aWxsIHNjYWxlIHRvIHdoYXRldmVyIHdpZHRoIHRoZSBicm93c2VyIGNhbiBoYW5kbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhXaWR0aCA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtaW5IZWlnaHQgLSBNaW5pbXVtIGhlaWdodCB0aGUgY2FudmFzIHNob3VsZCBiZSBzY2FsZWQgdG8gKGluIHBpeGVscykuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5taW5IZWlnaHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4SGVpZ2h0IC0gTWF4aW11bSBoZWlnaHQgdGhlIGNhbnZhcyBzaG91bGQgYmUgc2NhbGVkIHRvIChpbiBwaXhlbHMpLgogICAgKiBJZiBudWxsIGl0IHdpbGwgc2NhbGUgdG8gd2hhdGV2ZXIgaGVpZ2h0IHRoZSBicm93c2VyIGNhbiBoYW5kbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhIZWlnaHQgPSBudWxsOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0SGVpZ2h0IC0gU3RhZ2UgaGVpZ2h0IHdoZW4gc3RhcnRpbmcgdGhlIGdhbWUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fc3RhcnRIZWlnaHQgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZvcmNlTGFuZHNjYXBlIC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgTGFuZHNjYXBlIG1vZGUsIHRoaXMgaXMgc2V0IHRvIHRydWUgYnkgR2FtZS5TdGFnZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuZm9yY2VMYW5kc2NhcGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmb3JjZVBvcnRyYWl0IC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgUG9ydHJhaXQgbW9kZSwgdGhpcyBpcyBzZXQgdG8gdHJ1ZSBieSBHYW1lLlN0YWdlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgIHRoaXMuZm9yY2VQb3J0cmFpdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGluY29ycmVjdE9yaWVudGF0aW9uIC0gSWYgdGhlIGdhbWUgc2hvdWxkIGJlIGZvcmNlZCB0byB1c2UgYSBzcGVjaWZpYyBvcmllbnRhdGlvbiBhbmQgdGhlIGRldmljZSBjdXJyZW50bHkgaXNuJ3QgaW4gdGhhdCBvcmllbnRhdGlvbiB0aGlzIGlzIHNldCB0byB0cnVlLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwYWdlQWxpZ25Ib3Jpem9udGFsbHkgLSBJZiB5b3Ugd2lzaCB0byBhbGlnbiB5b3VyIGdhbWUgaW4gdGhlIG1pZGRsZSBvZiB0aGUgcGFnZSB0aGVuIHlvdSBjYW4gc2V0IHRoaXMgdmFsdWUgdG8gdHJ1ZS4KICAgICogSXQgd2lsbCBwbGFjZSBhIHJlLWNhbGN1bGF0ZWQgbWFyZ2luLWxlZnQgcGl4ZWwgdmFsdWUgb250byB0aGUgY2FudmFzIGVsZW1lbnQgd2hpY2ggaXMgdXBkYXRlZCBvbiBvcmllbnRhdGlvbi9yZXNpemluZy4KICAgICogSXQgZG9lc24ndCBjYXJlIGFib3V0IGFueSBvdGhlciBET00gZWxlbWVudCB0aGF0IG1heSBiZSBvbiB0aGUgcGFnZSwgaXQgbGl0ZXJhbGx5IGp1c3Qgc2V0cyB0aGUgbWFyZ2luLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGFnZUFsaWduSG9yaXpvbnRhbGx5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGFnZUFsaWduVmVydGljYWxseSAtIElmIHlvdSB3aXNoIHRvIGFsaWduIHlvdXIgZ2FtZSBpbiB0aGUgbWlkZGxlIG9mIHRoZSBwYWdlIHRoZW4geW91IGNhbiBzZXQgdGhpcyB2YWx1ZSB0byB0cnVlLgogICAgKiBJdCB3aWxsIHBsYWNlIGEgcmUtY2FsY3VsYXRlZCBtYXJnaW4tbGVmdCBwaXhlbCB2YWx1ZSBvbnRvIHRoZSBjYW52YXMgZWxlbWVudCB3aGljaCBpcyB1cGRhdGVkIG9uIG9yaWVudGF0aW9uL3Jlc2l6aW5nLgogICAgKiBJdCBkb2Vzbid0IGNhcmUgYWJvdXQgYW55IG90aGVyIERPTSBlbGVtZW50IHRoYXQgbWF5IGJlIG9uIHRoZSBwYWdlLCBpdCBsaXRlcmFsbHkganVzdCBzZXRzIHRoZSBtYXJnaW4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYWdlQWxpZ25WZXJ0aWNhbGx5ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfd2lkdGggLSBDYWNoZWQgc3RhZ2Ugd2lkdGggZm9yIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fd2lkdGggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2hlaWdodCAtIENhY2hlZCBzdGFnZSBoZWlnaHQgZm9yIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBkZWZhdWx0CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5faGVpZ2h0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heEl0ZXJhdGlvbnMgLSBUaGUgbWF4aW11bSBudW1iZXIgb2YgdGltZXMgaXQgd2lsbCB0cnkgdG8gcmVzaXplIHRoZSBjYW52YXMgdG8gZmlsbCB0aGUgYnJvd3Nlci4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1heEl0ZXJhdGlvbnMgPSA1OwogICAgCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UElYSS5TcHJpdGV9IG9yaWVudGF0aW9uU3ByaXRlIC0gVGhlIFNwcml0ZSB0aGF0IGlzIG9wdGlvbmFsbHkgZGlzcGxheWVkIGlmIHRoZSBicm93c2VyIGVudGVycyBhbiB1bnN1cHBvcnRlZCBvcmllbnRhdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlckxhbmRzY2FwZSAtIFRoZSBldmVudCB0aGF0IGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgbGFuZHNjYXBlIG9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMuZW50ZXJMYW5kc2NhcGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IGVudGVyUG9ydHJhaXQgLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgZW50ZXJzIGhvcml6b250YWwgb3JpZW50YXRpb24uCiAgICAqLwogICAgdGhpcy5lbnRlclBvcnRyYWl0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBlbnRlckluY29ycmVjdE9yaWVudGF0aW9uIC0gVGhlIGV2ZW50IHRoYXQgaXMgZGlzcGF0Y2hlZCB3aGVuIHRoZSBicm93c2VyIGVudGVycyBhbiBpbmNvcnJlY3Qgb3JpZW50YXRpb24sIGFzIGRlZmluZWQgYnkgZm9yY2VPcmllbnRhdGlvbi4KICAgICovCiAgICB0aGlzLmVudGVySW5jb3JyZWN0T3JpZW50YXRpb24gPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IGxlYXZlSW5jb3JyZWN0T3JpZW50YXRpb24gLSBUaGUgZXZlbnQgdGhhdCBpcyBkaXNwYXRjaGVkIHdoZW4gdGhlIGJyb3dzZXIgbGVhdmVzIGFuIGluY29ycmVjdCBvcmllbnRhdGlvbiwgYXMgZGVmaW5lZCBieSBmb3JjZU9yaWVudGF0aW9uLgogICAgKi8KICAgIHRoaXMubGVhdmVJbmNvcnJlY3RPcmllbnRhdGlvbiA9IG5ldyBQaGFzZXIuU2lnbmFsKCk7CgogICAgaWYgKHdpbmRvd1snb3JpZW50YXRpb24nXSkKICAgIHsKICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gd2luZG93WydvcmllbnRhdGlvbiddOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh3aW5kb3cub3V0ZXJXaWR0aCA+IHdpbmRvdy5vdXRlckhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSA5MDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvbiA9IDA7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gc2NhbGVGYWN0b3IgLSBUaGUgc2NhbGUgZmFjdG9yIGJhc2VkIG9uIHRoZSBnYW1lIGRpbWVuc2lvbnMgdnMuIHRoZSBzY2FsZWQgZGltZW5zaW9ucy4KICAgICovCiAgICB0aGlzLnNjYWxlRmFjdG9yID0gbmV3IFBoYXNlci5Qb2ludCgxLCAxKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFzcGVjdFJhdGlvIC0gQXNwZWN0IHJhdGlvLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYXNwZWN0UmF0aW8gPSAwOwoKICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmNoZWNrT3JpZW50YXRpb24oZXZlbnQpOwogICAgfSwgZmFsc2UpOwoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuY2hlY2tSZXNpemUoZXZlbnQpOwogICAgfSwgZmFsc2UpOwoKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnLCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICByZXR1cm4gX3RoaXMuZnVsbFNjcmVlbkNoYW5nZShldmVudCk7CiAgICB9LCBmYWxzZSk7CgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW96ZnVsbHNjcmVlbmNoYW5nZScsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgIHJldHVybiBfdGhpcy5mdWxsU2NyZWVuQ2hhbmdlKGV2ZW50KTsKICAgIH0sIGZhbHNlKTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmdWxsc2NyZWVuY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIF90aGlzLmZ1bGxTY3JlZW5DaGFuZ2UoZXZlbnQpOwogICAgfSwgZmFsc2UpOwoJCn07CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuRVhBQ1RfRklUID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5TdGFnZVNjYWxlTW9kZS5OT19TQ0FMRSA9IDE7CgovKioKKiBAY29uc3RhbnQKKiBAdHlwZSB7bnVtYmVyfQoqLwpQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuU0hPV19BTEwgPSAyOwoKUGhhc2VyLlN0YWdlU2NhbGVNb2RlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogVHJpZXMgdG8gZW50ZXIgdGhlIGJyb3dzZXIgaW50byBmdWxsIHNjcmVlbiBtb2RlLgogICAgKiBQbGVhc2Ugbm90ZSB0aGF0IHRoaXMgbmVlZHMgdG8gYmUgc3VwcG9ydGVkIGJ5IHRoZSB3ZWIgYnJvd3NlciBhbmQgaXNuJ3QgdGhlIHNhbWUgdGhpbmcgYXMgc2V0dGluZyB5b3VyIGdhbWUgdG8gZmlsbCB0aGUgYnJvd3Nlci4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc3RhcnRGdWxsU2NyZWVuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYW50aWFsaWFzIC0gWW91IGNhbiB0b2dnbGUgdGhlIGFudGktYWxpYXMgZmVhdHVyZSBvZiB0aGUgY2FudmFzIGJlZm9yZSBqdW1waW5nIGluIHRvIGZ1bGwgc2NyZWVuIChmYWxzZSA9IHJldGFpbiBwaXhlbCBhcnQsIHRydWUgPSBzbW9vdGggYXJ0KQogICAgKi8KICAgIHN0YXJ0RnVsbFNjcmVlbjogZnVuY3Rpb24gKGFudGlhbGlhcykgewoKICAgICAgICBpZiAodGhpcy5pc0Z1bGxTY3JlZW4pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGFudGlhbGlhcyAhPT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgewogICAgICAgICAgICBQaGFzZXIuQ2FudmFzLnNldFNtb290aGluZ0VuYWJsZWQodGhpcy5nYW1lLmNvbnRleHQsIGFudGlhbGlhcyk7CiAgICAgICAgfQoKICAgICAgICB2YXIgZWxlbWVudCA9IHRoaXMuZ2FtZS5jYW52YXM7CiAgICAgICAgCiAgICAgICAgdGhpcy5fd2lkdGggPSB0aGlzLndpZHRoOwogICAgICAgIHRoaXMuX2hlaWdodCA9IHRoaXMuaGVpZ2h0OwoKICAgICAgICBjb25zb2xlLmxvZygnc3RhcnRGdWxsU2NyZWVuJywgdGhpcy5fd2lkdGgsIHRoaXMuX2hlaWdodCk7CgogICAgICAgIGlmIChlbGVtZW50WydyZXF1ZXN0RnVsbFNjcmVlbiddKQogICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudFsncmVxdWVzdEZ1bGxTY3JlZW4nXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbGVtZW50Wydtb3pSZXF1ZXN0RnVsbFNjcmVlbiddKQogICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudFsnbW96UmVxdWVzdEZ1bGxTY3JlZW4nXSgpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChlbGVtZW50Wyd3ZWJraXRSZXF1ZXN0RnVsbFNjcmVlbiddKQogICAgICAgIHsKICAgICAgICAgICAgZWxlbWVudFsnd2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4nXShFbGVtZW50LkFMTE9XX0tFWUJPQVJEX0lOUFVUKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgZnVsbCBzY3JlZW4gbW9kZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBpdC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc3RvcEZ1bGxTY3JlZW4KICAgICovCiAgICBzdG9wRnVsbFNjcmVlbjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAoZG9jdW1lbnRbJ2NhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50WydjYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnRbJ21vekNhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50Wydtb3pDYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZG9jdW1lbnRbJ3dlYmtpdENhbmNlbEZ1bGxTY3JlZW4nXSkKICAgICAgICB7CiAgICAgICAgICAgIGRvY3VtZW50Wyd3ZWJraXRDYW5jZWxGdWxsU2NyZWVuJ10oKTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgd2hlbiB0aGUgYnJvd3NlciBlbnRlcnMgb2YgbGVhdmVzIGZ1bGwgc2NyZWVuIG1vZGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2Z1bGxTY3JlZW5DaGFuZ2UKICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBUaGUgZnVsbHNjcmVlbmNoYW5nZSBldmVudAogICAgKiBAcHJvdGVjdGVkCiAgICAqLwogICAgZnVsbFNjcmVlbkNoYW5nZTogZnVuY3Rpb24gKGV2ZW50KSB7CgogICAgICAgIGlmICh0aGlzLmlzRnVsbFNjcmVlbikKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ3dpZHRoJ10gPSAnMTAwJSc7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ2hlaWdodCddID0gJzEwMCUnOwoKICAgICAgICAgICAgdGhpcy5zZXRNYXhpbXVtKCk7CgogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQuc2NhbGUuc2V0VG8odGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aCwgdGhpcy5nYW1lLmhlaWdodCAvIHRoaXMuaGVpZ2h0KTsKCiAgICAgICAgICAgIHRoaXMuYXNwZWN0UmF0aW8gPSB0aGlzLndpZHRoIC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueCA9IHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGg7CiAgICAgICAgICAgIHRoaXMuc2NhbGVGYWN0b3IueSA9IHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodDsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLnN0YWdlLmNhbnZhcy5zdHlsZVsnd2lkdGgnXSA9IHRoaXMuZ2FtZS53aWR0aCArICdweCc7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5jYW52YXMuc3R5bGVbJ2hlaWdodCddID0gdGhpcy5nYW1lLmhlaWdodCArICdweCc7CgogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy5fd2lkdGg7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gdGhpcy5faGVpZ2h0OwoKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnNjYWxlLnNldFRvKHRoaXMuZ2FtZS53aWR0aCAvIHRoaXMud2lkdGgsIHRoaXMuZ2FtZS5oZWlnaHQgLyB0aGlzLmhlaWdodCk7CgogICAgICAgICAgICB0aGlzLmFzcGVjdFJhdGlvID0gdGhpcy53aWR0aCAvIHRoaXMuaGVpZ2h0OwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnggPSB0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoOwogICAgICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIElmIHlvdSBuZWVkIHlvdXIgZ2FtZSB0byBydW4gaW4gb25seSBvbmUgb3JpZW50YXRpb24geW91IGNhbiBmb3JjZSB0aGF0IHRvIGhhcHBlbi4KICAgICogVGhlIG9wdGlvbmFsIG9yaWVudGF0aW9uSW1hZ2UgaXMgZGlzcGxheWVkIHdoZW4gdGhlIGdhbWUgaXMgaW4gdGhlIGluY29ycmVjdCBvcmllbnRhdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjZm9yY2VPcmllbnRhdGlvbgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvcmNlTGFuZHNjYXBlIC0gdHJ1ZSBpZiB0aGUgZ2FtZSBzaG91bGQgcnVuIGluIGxhbmRzY2FwZSBtb2RlIG9ubHkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZvcmNlUG9ydHJhaXQ9ZmFsc2VdIC0gdHJ1ZSBpZiB0aGUgZ2FtZSBzaG91bGQgcnVuIGluIHBvcnRyYWl0IG1vZGUgb25seS4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtvcmllbnRhdGlvbkltYWdlPScnXSAtIFRoZSBzdHJpbmcgb2YgYW4gaW1hZ2UgaW4gdGhlIFBoYXNlci5DYWNoZSB0byBkaXNwbGF5IHdoZW4gdGhpcyBnYW1lIGlzIGluIHRoZSBpbmNvcnJlY3Qgb3JpZW50YXRpb24uCiAgICAqLwogICAgZm9yY2VPcmllbnRhdGlvbjogZnVuY3Rpb24gKGZvcmNlTGFuZHNjYXBlLCBmb3JjZVBvcnRyYWl0LCBvcmllbnRhdGlvbkltYWdlKSB7CgogICAgICAgIGlmICh0eXBlb2YgZm9yY2VQb3J0cmFpdCA9PT0gJ3VuZGVmaW5lZCcpIHsgZm9yY2VQb3J0cmFpdCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuZm9yY2VMYW5kc2NhcGUgPSBmb3JjZUxhbmRzY2FwZTsKICAgICAgICB0aGlzLmZvcmNlUG9ydHJhaXQgPSBmb3JjZVBvcnRyYWl0OwoKICAgICAgICBpZiAodHlwZW9mIG9yaWVudGF0aW9uSW1hZ2UgIT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKG9yaWVudGF0aW9uSW1hZ2UgPT0gbnVsbCB8fCB0aGlzLmdhbWUuY2FjaGUuY2hlY2tJbWFnZUtleShvcmllbnRhdGlvbkltYWdlKSA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3JpZW50YXRpb25JbWFnZSA9ICdfX2RlZmF1bHQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uU3ByaXRlID0gbmV3IFBJWEkuU3ByaXRlKFBJWEkuVGV4dHVyZUNhY2hlW29yaWVudGF0aW9uSW1hZ2VdKTsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS5hbmNob3IueCA9IDAuNTsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS5hbmNob3IueSA9IDAuNTsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS5wb3NpdGlvbi54ID0gdGhpcy5nYW1lLndpZHRoIC8gMjsKICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS5wb3NpdGlvbi55ID0gdGhpcy5nYW1lLmhlaWdodCAvIDI7CgogICAgICAgICAgICB0aGlzLmNoZWNrT3JpZW50YXRpb25TdGF0ZSgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZ2FtZS5zdGFnZS5fc3RhZ2UuYWRkQ2hpbGQodGhpcy5vcmllbnRhdGlvblNwcml0ZSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrcyBpZiB0aGUgYnJvd3NlciBpcyBpbiB0aGUgY29ycmVjdCBvcmllbnRhdGlvbiBmb3IgeW91ciBnYW1lIChpZiBmb3JjZUxhbmRzY2FwZSBvciBmb3JjZVBvcnRyYWl0IGhhdmUgYmVlbiBzZXQpCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2NoZWNrT3JpZW50YXRpb25TdGF0ZQogICAgKi8KICAgIGNoZWNrT3JpZW50YXRpb25TdGF0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyAgVGhleSBhcmUgaW4gdGhlIHdyb25nIG9yaWVudGF0aW9uCiAgICAgICAgaWYgKHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24pCiAgICAgICAgewogICAgICAgICAgICBpZiAoKHRoaXMuZm9yY2VMYW5kc2NhcGUgJiYgd2luZG93LmlubmVyV2lkdGggPiB3aW5kb3cuaW5uZXJIZWlnaHQpIHx8ICh0aGlzLmZvcmNlUG9ydHJhaXQgJiYgd2luZG93LmlubmVySGVpZ2h0ID4gd2luZG93LmlubmVyV2lkdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQmFjayB0byBub3JtYWwKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMubGVhdmVJbmNvcnJlY3RPcmllbnRhdGlvbi5kaXNwYXRjaCgpOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLm9yaWVudGF0aW9uU3ByaXRlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb25TcHJpdGUudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS53b3JsZC52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoKHRoaXMuZm9yY2VMYW5kc2NhcGUgJiYgd2luZG93LmlubmVyV2lkdGggPCB3aW5kb3cuaW5uZXJIZWlnaHQpIHx8ICh0aGlzLmZvcmNlUG9ydHJhaXQgJiYgd2luZG93LmlubmVySGVpZ2h0IDwgd2luZG93LmlubmVyV2lkdGgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgU2hvdyBvcmllbnRhdGlvbiBzY3JlZW4KICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5wYXVzZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLmVudGVySW5jb3JyZWN0T3JpZW50YXRpb24uZGlzcGF0Y2goKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5vcmllbnRhdGlvblNwcml0ZSAmJiB0aGlzLm9yaWVudGF0aW9uU3ByaXRlLnZpc2libGUgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmllbnRhdGlvblNwcml0ZS52aXNpYmxlID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUud29ybGQudmlzaWJsZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogSGFuZGxlIHdpbmRvdy5vcmllbnRhdGlvbmNoYW5nZSBldmVudHMKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjY2hlY2tPcmllbnRhdGlvbgogICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIFRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudCBkYXRhLgogICAgKi8KICAgIGNoZWNrT3JpZW50YXRpb246IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gd2luZG93WydvcmllbnRhdGlvbiddOwoKICAgICAgICBpZiAodGhpcy5pc0xhbmRzY2FwZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuZW50ZXJMYW5kc2NhcGUuZGlzcGF0Y2godGhpcy5vcmllbnRhdGlvbiwgdHJ1ZSwgZmFsc2UpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVudGVyUG9ydHJhaXQuZGlzcGF0Y2godGhpcy5vcmllbnRhdGlvbiwgZmFsc2UsIHRydWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5zdGFnZS5zY2FsZU1vZGUgIT09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5OT19TQ0FMRSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBIYW5kbGUgd2luZG93LnJlc2l6ZSBldmVudHMKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjY2hlY2tSZXNpemUKICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBUaGUgcmVzaXplIGV2ZW50IGRhdGEuCiAgICAqLwogICAgY2hlY2tSZXNpemU6IGZ1bmN0aW9uIChldmVudCkgewoKICAgICAgICBpZiAod2luZG93Lm91dGVyV2lkdGggPiB3aW5kb3cub3V0ZXJIZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLm9yaWVudGF0aW9uID0gOTA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMub3JpZW50YXRpb24gPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuaXNMYW5kc2NhcGUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmVudGVyTGFuZHNjYXBlLmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIHRydWUsIGZhbHNlKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5lbnRlclBvcnRyYWl0LmRpc3BhdGNoKHRoaXMub3JpZW50YXRpb24sIGZhbHNlLCB0cnVlKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlICE9PSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUuTk9fU0NBTEUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY2hlY2tPcmllbnRhdGlvblN0YXRlKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmUtY2FsY3VsYXRlIHNjYWxlIG1vZGUgYW5kIHVwZGF0ZSBzY3JlZW4gc2l6ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjcmVmcmVzaAogICAgKi8KICAgIHJlZnJlc2g6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKICAgICAgICAKICAgICAgICAvLyAgV2UgY2FuJ3QgZG8gYW55dGhpbmcgYWJvdXQgdGhlIHN0YXR1cyBiYXJzIGluIGlQYWRzLCB3ZWIgYXBwcyBvciBkZXNrdG9wcwogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlQYWQgPT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS53ZWJBcHAgPT0gZmFsc2UgJiYgdGhpcy5nYW1lLmRldmljZS5kZXNrdG9wID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydzdHlsZSddLm1pbkhlaWdodCA9ICcyMDAwcHgnOwogICAgICAgICAgICAvLyB0aGlzLl9zdGFydEhlaWdodCA9IHdpbmRvdy5pbm5lckhlaWdodDsKCiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmFuZHJvaWQgJiYgdGhpcy5nYW1lLmRldmljZS5jaHJvbWUgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zY3JvbGxUbygwLCAwKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuX2NoZWNrID09IG51bGwgJiYgdGhpcy5tYXhJdGVyYXRpb25zID4gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2l0ZXJhdGlvbnMgPSB0aGlzLm1heEl0ZXJhdGlvbnM7CiAgICAgICAgICAgIHRoaXMuX2NoZWNrID0gd2luZG93LnNldEludGVydmFsKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5zZXRTY3JlZW5TaXplKCk7CiAgICAgICAgICAgIH0sIDEwKTsKICAgICAgICAgICAgdGhpcy5zZXRTY3JlZW5TaXplKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldCBzY3JlZW4gc2l6ZSBhdXRvbWF0aWNhbGx5IGJhc2VkIG9uIHRoZSBzY2FsZU1vZGUuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gZm9yY2UgLSBJZiBmb3JjZSBpcyB0cnVlIGl0IHdpbGwgdHJ5IHRvIHJlc2l6ZSB0aGUgZ2FtZSByZWdhcmRsZXNzIG9mIHRoZSBkb2N1bWVudCBkaW1lbnNpb25zLgogICAgKi8KICAgIHNldFNjcmVlblNpemU6IGZ1bmN0aW9uIChmb3JjZSkgewoKICAgICAgICBpZiAodHlwZW9mIGZvcmNlID09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgZm9yY2UgPSBmYWxzZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuaVBhZCA9PSBmYWxzZSAmJiB0aGlzLmdhbWUuZGV2aWNlLndlYkFwcCA9PSBmYWxzZSAmJiB0aGlzLmdhbWUuZGV2aWNlLmRlc2t0b3AgPT0gZmFsc2UpIAogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuYW5kcm9pZCAmJiB0aGlzLmdhbWUuZGV2aWNlLmNocm9tZSA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgd2luZG93LnNjcm9sbFRvKDAsIDApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9pdGVyYXRpb25zLS07CgogICAgICAgIGlmIChmb3JjZSB8fCB3aW5kb3cuaW5uZXJIZWlnaHQgPiB0aGlzLl9zdGFydEhlaWdodCB8fCB0aGlzLl9pdGVyYXRpb25zIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vIFNldCBtaW5pbXVtIGhlaWdodCBvZiBjb250ZW50IHRvIG5ldyB3aW5kb3cgaGVpZ2h0CiAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudFsnc3R5bGUnXS5taW5IZWlnaHQgPSB3aW5kb3cuaW5uZXJIZWlnaHQgKyAncHgnOwogICAgICAgIAogICAgICAgICAgICBpZiAodGhpcy5pbmNvcnJlY3RPcmllbnRhdGlvbiA9PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnNldE1heGltdW0oKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlID09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5FWEFDVF9GSVQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuc2V0RXhhY3RGaXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLmdhbWUuc3RhZ2Uuc2NhbGVNb2RlID09IFBoYXNlci5TdGFnZVNjYWxlTW9kZS5TSE9XX0FMTCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXRTaG93QWxsKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuc2V0U2l6ZSgpOwogICAgICAgICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrKTsKICAgICAgICAgICAgdGhpcy5fY2hlY2sgPSBudWxsOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBjYW52YXMgc3R5bGUgd2lkdGggYW5kIGhlaWdodCB2YWx1ZXMgYmFzZWQgb24gbWluV2lkdGgvSGVpZ2h0IGFuZCBtYXhXaWR0aC9IZWlnaHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI3NldFNpemUKICAgICovCiAgICBzZXRTaXplOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubWF4V2lkdGggJiYgdGhpcy53aWR0aCA+IHRoaXMubWF4V2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1heFdpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5tYXhIZWlnaHQgJiYgdGhpcy5oZWlnaHQgPiB0aGlzLm1heEhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1heEhlaWdodDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMubWluV2lkdGggJiYgdGhpcy53aWR0aCA8IHRoaXMubWluV2lkdGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1pbldpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodGhpcy5taW5IZWlnaHQgJiYgdGhpcy5oZWlnaHQgPCB0aGlzLm1pbkhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSB0aGlzLm1pbkhlaWdodDsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5nYW1lLmNhbnZhcy5zdHlsZS53aWR0aCA9IHRoaXMud2lkdGggKyAncHgnOwogICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUuaGVpZ2h0ID0gdGhpcy5oZWlnaHQgKyAncHgnOwogICAgICAgIAogICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5zY2FsZS5zZXRUbyh0aGlzLmdhbWUud2lkdGggLyB0aGlzLndpZHRoLCB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQpOwoKICAgICAgICBpZiAodGhpcy5wYWdlQWxpZ25Ib3Jpem9udGFsbHkpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy53aWR0aCA8IHdpbmRvdy5pbm5lcldpZHRoICYmIHRoaXMuaW5jb3JyZWN0T3JpZW50YXRpb24gPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUubWFyZ2luTGVmdCA9IE1hdGgucm91bmQoKHdpbmRvdy5pbm5lcldpZHRoIC0gdGhpcy53aWR0aCkgLyAyKSArICdweCc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpbkxlZnQgPSAnMHB4JzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMucGFnZUFsaWduVmVydGljYWxseSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmhlaWdodCA8IHdpbmRvdy5pbm5lckhlaWdodCAmJiB0aGlzLmluY29ycmVjdE9yaWVudGF0aW9uID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhbWUuY2FudmFzLnN0eWxlLm1hcmdpblRvcCA9IE1hdGgucm91bmQoKHdpbmRvdy5pbm5lckhlaWdodCAtIHRoaXMuaGVpZ2h0KSAvIDIpICsgJ3B4JzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYW52YXMuc3R5bGUubWFyZ2luVG9wID0gJzBweCc7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIFBoYXNlci5DYW52YXMuZ2V0T2Zmc2V0KHRoaXMuZ2FtZS5jYW52YXMsIHRoaXMuZ2FtZS5zdGFnZS5vZmZzZXQpOwogICAgICAgIAogICAgICAgIHRoaXMuYXNwZWN0UmF0aW8gPSB0aGlzLndpZHRoIC8gdGhpcy5oZWlnaHQ7CiAgICAgICAgCiAgICAgICAgdGhpcy5zY2FsZUZhY3Rvci54ID0gdGhpcy5nYW1lLndpZHRoIC8gdGhpcy53aWR0aDsKICAgICAgICB0aGlzLnNjYWxlRmFjdG9yLnkgPSB0aGlzLmdhbWUuaGVpZ2h0IC8gdGhpcy5oZWlnaHQ7CgogICAgICAgIHRoaXMuY2hlY2tPcmllbnRhdGlvblN0YXRlKCk7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGlzLndpZHRoIGVxdWFsIHRvIHdpbmRvdy5pbm5lcldpZHRoIGFuZCB0aGlzLmhlaWdodCBlcXVhbCB0byB3aW5kb3cuaW5uZXJIZWlnaHQKICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0TWF4aW11bQogICAgKi8KICAgIHNldE1heGltdW06IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy53aWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGN1bGF0ZXMgdGhlIG11bHRpcGxpZXIgbmVlZGVkIHRvIHNjYWxlIHRoZSBnYW1lIHByb3BvcnRpb25hbGx5LgogICAgKiBAbWV0aG9kIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNzZXRTaG93QWxsCiAgICAqLwogICAgc2V0U2hvd0FsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgbXVsdGlwbGllciA9IE1hdGgubWluKCh3aW5kb3cuaW5uZXJIZWlnaHQgLyB0aGlzLmdhbWUuaGVpZ2h0KSwgKHdpbmRvdy5pbm5lcldpZHRoIC8gdGhpcy5nYW1lLndpZHRoKSk7CgogICAgICAgIHRoaXMud2lkdGggPSBNYXRoLnJvdW5kKHRoaXMuZ2FtZS53aWR0aCAqIG11bHRpcGxpZXIpOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gTWF0aC5yb3VuZCh0aGlzLmdhbWUuaGVpZ2h0ICogbXVsdGlwbGllcik7CgogICAgfSwKCiAgICAvKioKICAgICogU2V0cyB0aGUgd2lkdGggYW5kIGhlaWdodCB2YWx1ZXMgb2YgdGhlIGNhbnZhcywgbm8gbGFyZ2VyIHRoYW4gdGhlIG1heFdpZHRoL0hlaWdodC4KICAgICogQG1ldGhvZCBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjc2V0RXhhY3RGaXQKICAgICovCiAgICBzZXRFeGFjdEZpdDogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYXZhaWxhYmxlV2lkdGggPSB3aW5kb3cuaW5uZXJXaWR0aDsKICAgICAgICB2YXIgYXZhaWxhYmxlSGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OwoKICAgICAgICAvLyBjb25zb2xlLmxvZygnYXZhaWxhYmxlJywgYXZhaWxhYmxlV2lkdGgsIGF2YWlsYWJsZUhlaWdodCk7CgogICAgICAgIGlmICh0aGlzLm1heFdpZHRoICYmIGF2YWlsYWJsZVdpZHRoID4gdGhpcy5tYXhXaWR0aCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLm1heFdpZHRoOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gYXZhaWxhYmxlV2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5tYXhIZWlnaHQgJiYgYXZhaWxhYmxlSGVpZ2h0ID4gdGhpcy5tYXhIZWlnaHQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IHRoaXMubWF4SGVpZ2h0OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IGF2YWlsYWJsZUhlaWdodDsKICAgICAgICB9CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5TdGFnZVNjYWxlTW9kZSNpc0Z1bGxTY3JlZW4KKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRnVsbFNjcmVlbiAtIFJldHVybnMgdHJ1ZSBpZiB0aGUgYnJvd3NlciBpcyBpbiBmdWxsIHNjcmVlbiBtb2RlLCBvdGhlcndpc2UgZmFsc2UuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNGdWxsU2NyZWVuIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewoKICAgICAgICByZXR1cm4gKGRvY3VtZW50WydmdWxsc2NyZWVuRWxlbWVudCddIHx8IGRvY3VtZW50Wydtb3pGdWxsU2NyZWVuRWxlbWVudCddIHx8IGRvY3VtZW50Wyd3ZWJraXRGdWxsc2NyZWVuRWxlbWVudCddKQoKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlN0YWdlU2NhbGVNb2RlI2lzUG9ydHJhaXQKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUG9ydHJhaXQgLSBSZXR1cm5zIHRydWUgaWYgdGhlIGJyb3dzZXIgZGltZW5zaW9ucyBtYXRjaCBhIHBvcnRyYWl0IGRpc3BsYXkuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU3RhZ2VTY2FsZU1vZGUucHJvdG90eXBlLCAiaXNQb3J0cmFpdCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PSAwIHx8IHRoaXMub3JpZW50YXRpb24gPT0gMTgwOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU3RhZ2VTY2FsZU1vZGUjaXNMYW5kc2NhcGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTGFuZHNjYXBlIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBicm93c2VyIGRpbWVuc2lvbnMgbWF0Y2ggYSBsYW5kc2NhcGUgZGlzcGxheS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5TdGFnZVNjYWxlTW9kZS5wcm90b3R5cGUsICJpc0xhbmRzY2FwZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5vcmllbnRhdGlvbiA9PT0gOTAgfHwgdGhpcy5vcmllbnRhdGlvbiA9PT0gLTkwOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBEZXRlY3RzIGRldmljZSBzdXBwb3J0IGNhcGFiaWxpdGllcy4gVXNpbmcgc29tZSBlbGVtZW50cyBmcm9tIFN5c3RlbS5qcyBieSBNckRvb2IgYW5kIE1vZGVybml6cgoqCiogQGNsYXNzIFBoYXNlci5EZXZpY2UKKiBAY29uc3RydWN0b3IKKi8KClBoYXNlci5EZXZpY2UgPSBmdW5jdGlvbiAoKSB7CgogICAgLyoqCiAgICAqIEFuIG9wdGlvbmFsICdmaXgnIGZvciB0aGUgaG9ycmVuZG91cyBBbmRyb2lkIHN0b2NrIGJyb3dzZXIgYnVnIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvYW5kcm9pZC9pc3N1ZXMvZGV0YWlsP2lkPTM5MjQ3CiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcGF0Y2hBbmRyb2lkQ2xlYXJSZWN0QnVnIC0gRGVzY3JpcHRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wYXRjaEFuZHJvaWRDbGVhclJlY3RCdWcgPSBmYWxzZTsKCiAgICAvLyAgT3BlcmF0aW5nIFN5c3RlbQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGRlc2t0b3AgLSBJcyBydW5uaW5nIGRlc2t0b3A/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5kZXNrdG9wID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaU9TIC0gSXMgcnVubmluZyBvbiBpT1M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pT1MgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbmRyb2lkIC0gSXMgcnVubmluZyBvbiBhbmRyb2lkPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW5kcm9pZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNocm9tZU9TIC0gSXMgcnVubmluZyBvbiBjaHJvbWVPUz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNocm9tZU9TID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbGludXggLSBJcyBydW5uaW5nIG9uIGxpbnV4PwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubGludXggPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtYWNPUyAtIElzIHJ1bm5pbmcgb24gbWFjT1M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYWNPUyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdpbmRvd3MgLSBJcyBydW5uaW5nIG9uIHdpbmRvd3M/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53aW5kb3dzID0gZmFsc2U7CgogICAgLy8gIEZlYXR1cmVzCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2FudmFzIC0gSXMgY2FudmFzIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNhbnZhcyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpbGUgLSBJcyBmaWxlIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmZpbGUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBmaWxlU3lzdGVtIC0gSXMgZmlsZVN5c3RlbSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maWxlU3lzdGVtID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9jYWxTdG9yYWdlIC0gSXMgbG9jYWxTdG9yYWdlIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmxvY2FsU3RvcmFnZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdlYkdMIC0gSXMgd2ViR0wgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2ViR0wgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3b3JrZXIgLSBJcyB3b3JrZXIgYXZhaWxhYmxlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud29ya2VyID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdG91Y2ggLSBJcyB0b3VjaCBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy50b3VjaCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1zcG9pbnRlciAtIElzIG1zcG9pbnRlciBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tc3BvaW50ZXIgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjc3MzRCAtIElzIGNzczNEIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNzczNEID0gZmFsc2U7CgogICAgLyoqIAogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBvaW50ZXJMb2NrIC0gSXMgUG9pbnRlciBMb2NrIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnBvaW50ZXJMb2NrID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdHlwZWRBcnJheSAtIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCBUeXBlZEFycmF5cz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnR5cGVkQXJyYXkgPSBmYWxzZTsKCiAgICAvLyAgQnJvd3NlcgoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGFyb3JhIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBBcm9yYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFyb3JhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY2hyb21lIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBDaHJvbWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jaHJvbWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBlcGlwaGFueSAtIFNldCB0byB0cnVlIGlmIHJ1bm5pbmcgaW4gRXBpcGhhbnkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5lcGlwaGFueSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGZpcmVmb3ggLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEZpcmVmb3guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5maXJlZm94ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaWUgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIEludGVybmV0IEV4cGxvcmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGllVmVyc2lvbiAtIElmIHJ1bm5pbmcgaW4gSW50ZXJuZXQgRXhwbG9yZXIgdGhpcyB3aWxsIGNvbnRhaW4gdGhlIG1ham9yIHZlcnNpb24gbnVtYmVyLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaWVWZXJzaW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtb2JpbGVTYWZhcmkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIE1vYmlsZSBTYWZhcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tb2JpbGVTYWZhcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBtaWRvcmkgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGluIE1pZG9yaS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pZG9yaSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9wZXJhIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBPcGVyYS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9wZXJhID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gc2FmYXJpIC0gU2V0IHRvIHRydWUgaWYgcnVubmluZyBpbiBTYWZhcmkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zYWZhcmkgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJBcHAgLSBTZXQgdG8gdHJ1ZSBpZiBydW5uaW5nIGFzIGEgV2ViQXBwLCBpLmUuIHdpdGhpbiBhIFdlYlZpZXcKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYkFwcCA9IGZhbHNlOwoKICAgIC8vICBBdWRpbwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1ZGlvRGF0YSAtIEFyZSBBdWRpbyB0YWdzIGF2YWlsYWJsZT8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmF1ZGlvRGF0YSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdlYkF1ZGlvIC0gSXMgdGhlIFdlYkF1ZGlvIEFQSSBhdmFpbGFibGU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy53ZWJBdWRpbyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9nZyAtIENhbiB0aGlzIGRldmljZSBwbGF5IG9nZyBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm9nZyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG9wdXMgLSBDYW4gdGhpcyBkZXZpY2UgcGxheSBvcHVzIGZpbGVzPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub3B1cyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IG1wMyAtIENhbiB0aGlzIGRldmljZSBwbGF5IG1wMyBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1wMyA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHdhdiAtIENhbiB0aGlzIGRldmljZSBwbGF5IHdhdiBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndhdiA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBDYW4gdGhpcyBkZXZpY2UgcGxheSBtNGEgZmlsZXM/CiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbTRhIC0gVHJ1ZSBpZiB0aGlzIGRldmljZSBjYW4gcGxheSBtNGEgZmlsZXMuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tNGEgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSB3ZWJtIC0gQ2FuIHRoaXMgZGV2aWNlIHBsYXkgd2VibSBmaWxlcz8KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLndlYm0gPSBmYWxzZTsKCiAgICAvLyAgRGV2aWNlCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaVBob25lIC0gSXMgcnVubmluZyBvbiBpUGhvbmU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pUGhvbmUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpUGhvbmU0IC0gSXMgcnVubmluZyBvbiBpUGhvbmU0PwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaVBob25lNCA9IGZhbHNlOwoKICAgIC8qKiAKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpUGFkIC0gSXMgcnVubmluZyBvbiBpUGFkPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaVBhZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGl4ZWxSYXRpbyAtIFBpeGVsUmF0aW8gb2YgdGhlIGhvc3QgZGV2aWNlPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGl4ZWxSYXRpbyA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbGl0dGxlRW5kaWFuIC0gSXMgdGhlIGRldmljZSBiaWcgb3IgbGl0dGxlIGVuZGlhbj8gKG9ubHkgZGV0ZWN0ZWQgaWYgdGhlIGJyb3dzZXIgc3VwcG9ydHMgVHlwZWRBcnJheXMpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5saXR0bGVFbmRpYW4gPSBmYWxzZTsKCiAgICAvLyAgUnVuIHRoZSBjaGVja3MKICAgIHRoaXMuX2NoZWNrQXVkaW8oKTsKICAgIHRoaXMuX2NoZWNrQnJvd3NlcigpOwogICAgdGhpcy5fY2hlY2tDU1MzRCgpOwogICAgdGhpcy5fY2hlY2tEZXZpY2UoKTsKICAgIHRoaXMuX2NoZWNrRmVhdHVyZXMoKTsKICAgIHRoaXMuX2NoZWNrT1MoKTsKICAgIAp9OwoKUGhhc2VyLkRldmljZS5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIENoZWNrIHdoaWNoIE9TIGlzIGdhbWUgcnVubmluZyBvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja09TCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrT1M6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCiAgICAgICAgaWYgKC9BbmRyb2lkLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLmFuZHJvaWQgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL0NyT1MvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuY2hyb21lT1MgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL2lQW2FvXWR8aVBob25lL2kudGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5pT1MgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL0xpbnV4Ly50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLmxpbnV4ID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9NYWMgT1MvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMubWFjT1MgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAoL1dpbmRvd3MvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMud2luZG93cyA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy53aW5kb3dzIHx8IHRoaXMubWFjT1MgfHwgdGhpcy5saW51eCkgewogICAgICAgICAgICB0aGlzLmRlc2t0b3AgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBIVE1MNSBmZWF0dXJlcyBvZiB0aGUgaG9zdCBlbnZpcm9ubWVudC4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0ZlYXR1cmVzCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrRmVhdHVyZXM6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5jYW52YXMgPSAhIXdpbmRvd1snQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEJ107CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRoaXMubG9jYWxTdG9yYWdlID0gISFsb2NhbFN0b3JhZ2UuZ2V0SXRlbTsKICAgICAgICB9IGNhdGNoIChlcnJvcikgewogICAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZSA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5maWxlID0gISF3aW5kb3dbJ0ZpbGUnXSAmJiAhIXdpbmRvd1snRmlsZVJlYWRlciddICYmICEhd2luZG93WydGaWxlTGlzdCddICYmICEhd2luZG93WydCbG9iJ107CiAgICAgICAgdGhpcy5maWxlU3lzdGVtID0gISF3aW5kb3dbJ3JlcXVlc3RGaWxlU3lzdGVtJ107CiAgICAgICAgdGhpcy53ZWJHTCA9ICggZnVuY3Rpb24gKCkgeyB0cnkgeyB2YXIgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggJ2NhbnZhcycgKTsgcmV0dXJuICEhIHdpbmRvdy5XZWJHTFJlbmRlcmluZ0NvbnRleHQgJiYgKCBjYW52YXMuZ2V0Q29udGV4dCggJ3dlYmdsJyApIHx8IGNhbnZhcy5nZXRDb250ZXh0KCAnZXhwZXJpbWVudGFsLXdlYmdsJyApICk7IH0gY2F0Y2goIGUgKSB7IHJldHVybiBmYWxzZTsgfSB9ICkoKTsKCiAgICAgICAgaWYgKHRoaXMud2ViR0wgPT09IG51bGwgfHwgdGhpcy53ZWJHTCA9PT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndlYkdMID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2ViR0wgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy53b3JrZXIgPSAhIXdpbmRvd1snV29ya2VyJ107CiAgICAgICAgCiAgICAgICAgaWYgKCdvbnRvdWNoc3RhcnQnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCB8fCB3aW5kb3cubmF2aWdhdG9yLm1zUG9pbnRlckVuYWJsZWQpIHsKICAgICAgICAgICAgdGhpcy50b3VjaCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICBpZiAod2luZG93Lm5hdmlnYXRvci5tc1BvaW50ZXJFbmFibGVkKSB7CiAgICAgICAgICAgIHRoaXMubXNwb2ludGVyID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgdGhpcy5wb2ludGVyTG9jayA9ICdwb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50IHx8ICdtb3pQb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50IHx8ICd3ZWJraXRQb2ludGVyTG9ja0VsZW1lbnQnIGluIGRvY3VtZW50OwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIHdoYXQgYnJvd3NlciBpcyBnYW1lIHJ1bm5pbmcgaW4uCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tCcm93c2VyCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrQnJvd3NlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoKICAgICAgICBpZiAoL0Fyb3JhLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLmFyb3JhID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9DaHJvbWUvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMuY2hyb21lID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9FcGlwaGFueS8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5lcGlwaGFueSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvRmlyZWZveC8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5maXJlZm94ID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9Nb2JpbGUgU2FmYXJpLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLm1vYmlsZVNhZmFyaSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvTVNJRSAoXGQrXC5cZCspOy8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5pZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuaWVWZXJzaW9uID0gcGFyc2VJbnQoUmVnRXhwLiQxKTsKICAgICAgICB9IGVsc2UgaWYgKC9NaWRvcmkvLnRlc3QodWEpKSB7CiAgICAgICAgICAgIHRoaXMubWlkb3JpID0gdHJ1ZTsKICAgICAgICB9IGVsc2UgaWYgKC9PcGVyYS8udGVzdCh1YSkpIHsKICAgICAgICAgICAgdGhpcy5vcGVyYSA9IHRydWU7CiAgICAgICAgfSBlbHNlIGlmICgvU2FmYXJpLy50ZXN0KHVhKSkgewogICAgICAgICAgICB0aGlzLnNhZmFyaSA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICAvLyBXZWJBcHAgbW9kZSBpbiBpT1MKICAgICAgICBpZiAobmF2aWdhdG9yWydzdGFuZGFsb25lJ10pIHsKICAgICAgICAgICAgdGhpcy53ZWJBcHAgPSB0cnVlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBhdWRpbyBzdXBwb3J0LgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjX2NoZWNrQXVkaW8KICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tBdWRpbzogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmF1ZGlvRGF0YSA9ICEhKHdpbmRvd1snQXVkaW8nXSk7CiAgICAgICAgdGhpcy53ZWJBdWRpbyA9ICEhKHdpbmRvd1snd2Via2l0QXVkaW9Db250ZXh0J10gfHwgd2luZG93WydBdWRpb0NvbnRleHQnXSk7CiAgICAgICAgdmFyIGF1ZGlvRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7CiAgICAgICAgdmFyIHJlc3VsdCA9IGZhbHNlOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZiAocmVzdWx0ID0gISFhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUpIHsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8vb2dnOyBjb2RlY3M9InZvcmJpcyInKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vZ2cgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL29nZzsgY29kZWNzPSJvcHVzIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdXMgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL21wZWc7JykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMubXAzID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBNaW1ldHlwZXMgYWNjZXB0ZWQ6CiAgICAgICAgICAgICAgICAvLyAgIGRldmVsb3Blci5tb3ppbGxhLm9yZy9Fbi9NZWRpYV9mb3JtYXRzX3N1cHBvcnRlZF9ieV90aGVfYXVkaW9fYW5kX3ZpZGVvX2VsZW1lbnRzCiAgICAgICAgICAgICAgICAvLyAgIGJpdC5seS9pcGhvbmVvc2NvZGVjcwogICAgICAgICAgICAgICAgaWYgKGF1ZGlvRWxlbWVudC5jYW5QbGF5VHlwZSgnYXVkaW8vd2F2OyBjb2RlY3M9IjEiJykucmVwbGFjZSgvXm5vJC8sICcnKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMud2F2ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYXVkaW9FbGVtZW50LmNhblBsYXlUeXBlKCdhdWRpby94LW00YTsnKSB8fCBhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL2FhYzsnKS5yZXBsYWNlKC9ebm8kLywgJycpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5tNGEgPSB0cnVlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmIChhdWRpb0VsZW1lbnQuY2FuUGxheVR5cGUoJ2F1ZGlvL3dlYm07IGNvZGVjcz0idm9yYmlzIicpLnJlcGxhY2UoL15ubyQvLCAnJykpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLndlYm0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayBQaXhlbFJhdGlvIG9mIGRldmljZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkRldmljZSNfY2hlY2tEZXZpY2UKICAgICogQHByaXZhdGUKICAgICovCiAgICBfY2hlY2tEZXZpY2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5waXhlbFJhdGlvID0gd2luZG93WydkZXZpY2VQaXhlbFJhdGlvJ10gfHwgMTsKICAgICAgICB0aGlzLmlQaG9uZSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpcGhvbmUnKSAhPSAtMTsKICAgICAgICB0aGlzLmlQaG9uZTQgPSAodGhpcy5waXhlbFJhdGlvID09IDIgJiYgdGhpcy5pUGhvbmUpOwogICAgICAgIHRoaXMuaVBhZCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCdpcGFkJykgIT0gLTE7CgogICAgICAgIGlmICh0eXBlb2YgSW50OEFycmF5ICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGl0dGxlRW5kaWFuID0gbmV3IEludDhBcnJheShuZXcgSW50MTZBcnJheShbMV0pLmJ1ZmZlcilbMF0gPiAwOwogICAgICAgICAgICB0aGlzLnR5cGVkQXJyYXkgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpdHRsZUVuZGlhbiA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLnR5cGVkQXJyYXkgPSBmYWxzZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgaG9zdCBlbnZpcm9ubWVudCBzdXBwb3J0IDNEIENTUy4KICAgICogQG1ldGhvZCBQaGFzZXIuRGV2aWNlI19jaGVja0NTUzNECiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgX2NoZWNrQ1NTM0Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncCcpOwogICAgICAgIHZhciBoYXMzZDsKICAgICAgICB2YXIgdHJhbnNmb3JtcyA9IHsKICAgICAgICAgICAgJ3dlYmtpdFRyYW5zZm9ybSc6ICctd2Via2l0LXRyYW5zZm9ybScsCiAgICAgICAgICAgICdPVHJhbnNmb3JtJzogJy1vLXRyYW5zZm9ybScsCiAgICAgICAgICAgICdtc1RyYW5zZm9ybSc6ICctbXMtdHJhbnNmb3JtJywKICAgICAgICAgICAgJ01velRyYW5zZm9ybSc6ICctbW96LXRyYW5zZm9ybScsCiAgICAgICAgICAgICd0cmFuc2Zvcm0nOiAndHJhbnNmb3JtJwogICAgICAgIH07CgogICAgICAgIC8vIEFkZCBpdCB0byB0aGUgYm9keSB0byBnZXQgdGhlIGNvbXB1dGVkIHN0eWxlLgogICAgICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKGVsLCBudWxsKTsKCiAgICAgICAgZm9yICh2YXIgdCBpbiB0cmFuc2Zvcm1zKSB7CiAgICAgICAgICAgIGlmIChlbC5zdHlsZVt0XSAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICBlbC5zdHlsZVt0XSA9ICJ0cmFuc2xhdGUzZCgxcHgsMXB4LDFweCkiOwogICAgICAgICAgICAgICAgaGFzM2QgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbCkuZ2V0UHJvcGVydHlWYWx1ZSh0cmFuc2Zvcm1zW3RdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGVsKTsKICAgICAgICB0aGlzLmNzczNEID0gKGhhczNkICE9PSB1bmRlZmluZWQgJiYgaGFzM2QubGVuZ3RoID4gMCAmJiBoYXMzZCAhPT0gIm5vbmUiKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVjayB3aGV0aGVyIHRoZSBob3N0IGVudmlyb25tZW50IGNhbiBwbGF5IGF1ZGlvLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjY2FuUGxheUF1ZGlvCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0eXBlIC0gT25lIG9mICdtcDMsICdvZ2cnLCAnbTRhJywgJ3dhdicsICd3ZWJtJy4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gZmlsZSB0eXBlIGlzIHN1cHBvcnRlZCBieSB0aGUgYnJvd3Nlciwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNhblBsYXlBdWRpbzogZnVuY3Rpb24gKHR5cGUpIHsKCiAgICAgICAgaWYgKHR5cGUgPT0gJ21wMycgJiYgdGhpcy5tcDMpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnb2dnJyAmJiAodGhpcy5vZ2cgfHwgdGhpcy5vcHVzKSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0eXBlID09ICdtNGEnICYmIHRoaXMubTRhKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3dhdicgJiYgdGhpcy53YXYpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodHlwZSA9PSAnd2VibScgJiYgdGhpcy53ZWJtKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2sgd2hldGhlciB0aGUgY29uc29sZSBpcyBvcGVuLgogICAgKiBAbWV0aG9kIFBoYXNlci5EZXZpY2UjaXNDb25zb2xlT3BlbgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBicm93c2VyIGRldiBjb25zb2xlIGlzIG9wZW4uCiAgICAqLwogICAgaXNDb25zb2xlT3BlbjogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAod2luZG93LmNvbnNvbGUgJiYgd2luZG93LmNvbnNvbGVbJ2ZpcmVidWcnXSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvdy5jb25zb2xlKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS5wcm9maWxlKCk7CiAgICAgICAgICAgIGNvbnNvbGUucHJvZmlsZUVuZCgpOwoKICAgICAgICAgICAgaWYgKGNvbnNvbGUuY2xlYXIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuY2xlYXIoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIGNvbnNvbGVbJ3Byb2ZpbGVzJ10ubGVuZ3RoID4gMDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQWJzdHJhY3RzIGF3YXkgdGhlIHVzZSBvZiBSQUYgb3Igc2V0VGltZU91dCBmb3IgdGhlIGNvcmUgZ2FtZSB1cGRhdGUgbG9vcC4KKgoqIEBjbGFzcyBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lIAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGdhbWUpIHsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBUaGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUnVubmluZyAtIHRydWUgaWYgUmVxdWVzdEFuaW1hdGlvbkZyYW1lIGlzIHJ1bm5pbmcsIG90aGVyd2lzZSBmYWxzZS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmlzUnVubmluZyA9IGZhbHNlOwoKCXZhciB2ZW5kb3JzID0gWwoJCSdtcycsIAoJCSdtb3onLCAKCQknd2Via2l0JywgCgkJJ28nCgldOwoKCWZvciAodmFyIHggPSAwOyB4IDwgdmVuZG9ycy5sZW5ndGggJiYgIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7IHgrKykKCXsKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0gKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ107CgkJd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0gKyAnQ2FuY2VsQW5pbWF0aW9uRnJhbWUnXTsKCX0KCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBfaXNTZXRUaW1lT3V0ICAtIHRydWUgaWYgdGhlIGJyb3dzZXIgaXMgdXNpbmcgc2V0VGltZW91dCBpbnN0ZWFkIG9mIHJhZi4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9pc1NldFRpbWVPdXQgPSBmYWxzZTsKCgkvKioKCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uTG9vcCAtIFRoZSBmdW5jdGlvbiBjYWxsZWQgYnkgdGhlIHVwZGF0ZS4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9vbkxvb3AgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gX3RpbWVPdXRJRCAtIFRoZSBjYWxsYmFjayBJRCB1c2VkIHdoZW4gY2FsbGluZyBjYW5jZWwuCgkqIEBwcml2YXRlCgkqLwoJdGhpcy5fdGltZU91dElEID0gbnVsbDsKCn07CgpQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lLnByb3RvdHlwZSA9IHsKCgkvKioKCSogU3RhcnRzIHRoZSByZXF1ZXN0QW5pbWF0aW9GcmFtZSBydW5uaW5nIG9yIHNldFRpbWVvdXQgaWYgdW5hdmFpbGFibGUgaW4gYnJvd3NlcgoJKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjc3RhcnQKCSovCglzdGFydDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLmlzUnVubmluZyA9IHRydWU7CgoJCXZhciBfdGhpcyA9IHRoaXM7CgoJCWlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkKCQl7CgkJCXRoaXMuX2lzU2V0VGltZU91dCA9IHRydWU7CgogICAgICAgICAgICB0aGlzLl9vbkxvb3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudXBkYXRlU2V0VGltZW91dCgpOwogICAgICAgICAgICB9OwoKCQkJdGhpcy5fdGltZU91dElEID0gd2luZG93LnNldFRpbWVvdXQodGhpcy5fb25Mb29wLCAwKTsKCQl9CgkJZWxzZQoJCXsKCQkJdGhpcy5faXNTZXRUaW1lT3V0ID0gZmFsc2U7CgogICAgICAgICAgICB0aGlzLl9vbkxvb3AgPSBmdW5jdGlvbiAodGltZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnVwZGF0ZVJBRih0aW1lKTsKICAgICAgICAgICAgfTsKCgkJCXRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25Mb29wKTsKCQl9CgoJfSwKCgkvKioKCSogVGhlIHVwZGF0ZSBtZXRob2QgZm9yIHRoZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKCSogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI3VwZGF0ZVJBRgkKCSogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBBIHRpbWVzdGFtcCwgZWl0aGVyIGZyb20gUkFGIG9yIHNldFRpbWVPdXQKCSovCgl1cGRhdGVSQUY6IGZ1bmN0aW9uICh0aW1lKSB7CgoJCXRoaXMuZ2FtZS51cGRhdGUodGltZSk7CgoJCXRoaXMuX3RpbWVPdXRJRCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUodGhpcy5fb25Mb29wKTsKCgl9LAoKCS8qKgoJKiBUaGUgdXBkYXRlIG1ldGhvZCBmb3IgdGhlIHNldFRpbWVvdXQuCgkqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSN1cGRhdGVTZXRUaW1lb3V0CgkqLwoJdXBkYXRlU2V0VGltZW91dDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLmdhbWUudXBkYXRlKERhdGUubm93KCkpOwoKCQl0aGlzLl90aW1lT3V0SUQgPSB3aW5kb3cuc2V0VGltZW91dCh0aGlzLl9vbkxvb3AsIHRoaXMuZ2FtZS50aW1lLnRpbWVUb0NhbGwpOwoKCX0sCgoJLyoqCgkqIFN0b3BzIHRoZSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgZnJvbSBydW5uaW5nLgoJKiBAbWV0aG9kIFBoYXNlci5SZXF1ZXN0QW5pbWF0aW9uRnJhbWUjc3RvcAoJKi8KCXN0b3A6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuX2lzU2V0VGltZU91dCkKCQl7CgkJCWNsZWFyVGltZW91dCh0aGlzLl90aW1lT3V0SUQpOwoJCX0KCQllbHNlCgkJewoJCQl3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUodGhpcy5fdGltZU91dElEKTsKCQl9CgoJCXRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgoJfSwKCgkvKioKCSogSXMgdGhlIGJyb3dzZXIgdXNpbmcgc2V0VGltZW91dD8KCSogQG1ldGhvZCBQaGFzZXIuUmVxdWVzdEFuaW1hdGlvbkZyYW1lI2lzU2V0VGltZU91dAoJKiBAcmV0dXJuIHtib29sZWFufQoJKi8KCWlzU2V0VGltZU91dDogZnVuY3Rpb24gKCkgewoJCXJldHVybiB0aGlzLl9pc1NldFRpbWVPdXQ7Cgl9LAoKCS8qKgoJKiBJcyB0aGUgYnJvd3NlciB1c2luZyByZXF1ZXN0QW5pbWF0aW9uRnJhbWU/CgkqIEBtZXRob2QgUGhhc2VyLlJlcXVlc3RBbmltYXRpb25GcmFtZSNpc1JBRgoJKiBAcmV0dXJuIHtib29sZWFufQoJKi8KCWlzUkFGOiBmdW5jdGlvbiAoKSB7CgkJcmV0dXJuICh0aGlzLl9pc1NldFRpbWVPdXQgPT09IGZhbHNlKTsKCX0KCn07Ci8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yIGNvbnN0cnVjdG9yLgoqIAoqIEBjbGFzcyBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvcgoqIEBjbGFzc2Rlc2MgQW4gZXh0cmVtZWx5IHVzZWZ1bCByZXBlYXRhYmxlIHJhbmRvbSBkYXRhIGdlbmVyYXRvci4gQWNjZXNzIGl0IHZpYSBQaGFzZXIuR2FtZS5ybmQKKiBCYXNlZCBvbiBOb25zZW5zZSBieSBKb3NoIEZhdWwgaHR0cHM6Ly9naXRodWIuY29tL2pvY2FmYS9Ob25zZW5zZS4KKiBSYW5kb20gbnVtYmVyIGdlbmVyYXRvciBmcm9tIGh0dHA6Ly9iYWFnb2Uub3JnL2VuL3dpa2kvQmV0dGVyX3JhbmRvbV9udW1iZXJzX2Zvcl9qYXZhc2NyaXB0CiogCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHthcnJheX0gc2VlZHMKKi8KUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IgPSBmdW5jdGlvbiAoc2VlZHMpIHsKCQoJaWYgKHR5cGVvZiBzZWVkcyA9PT0gInVuZGVmaW5lZCIpIHsgc2VlZHMgPSBbXTsgfQoKCXRoaXMuc293KHNlZWRzKTsKCn07CgpQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvci5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjCgkqIEBwcml2YXRlCgkqLwoJYzogMSwKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IHMwCgkqIEBwcml2YXRlCgkqLwoJczA6IDAsCgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzMQoJKiBAcHJpdmF0ZQoJKi8KCXMxOiAwLAoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gczIKCSogQHByaXZhdGUKCSovCglzMjogMCwKCgkvKioKCSogUHJpdmF0ZSByYW5kb20gaGVscGVyLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3JuZAoJKiBAcHJpdmF0ZQoJKiBAcmV0dXJuIHtudW1iZXJ9IERlc2NyaXB0aW9uLgoJKi8KCXJuZDogZnVuY3Rpb24gKCkgewoKCQl2YXIgdCA9IDIwOTE2MzkgKiB0aGlzLnMwICsgdGhpcy5jICogMi4zMjgzMDY0MzY1Mzg2OTYzZS0xMDsgLy8gMl4tMzIKCgkJdGhpcy5jID0gdCB8IDA7CgkJdGhpcy5zMCA9IHRoaXMuczE7CgkJdGhpcy5zMSA9IHRoaXMuczI7CgkJdGhpcy5zMiA9IHQgLSB0aGlzLmM7CgoJCXJldHVybiB0aGlzLnMyOwoJfSwKCgkvKioKCSogUmVzZXQgdGhlIHNlZWQgb2YgdGhlIHJhbmRvbSBkYXRhIGdlbmVyYXRvci4KCSogCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3Ijc293CgkqIEBwYXJhbSB7YXJyYXl9IHNlZWRzCgkqLwoJc293OiBmdW5jdGlvbiAoc2VlZHMpIHsKCgkJaWYgKHR5cGVvZiBzZWVkcyA9PT0gInVuZGVmaW5lZCIpIHsgc2VlZHMgPSBbXTsgfQoKCQl0aGlzLnMwID0gdGhpcy5oYXNoKCcgJyk7CgkJdGhpcy5zMSA9IHRoaXMuaGFzaCh0aGlzLnMwKTsKCQl0aGlzLnMyID0gdGhpcy5oYXNoKHRoaXMuczEpOwoJCXRoaXMuYyA9IDE7CgoJCXZhciBzZWVkOwoKCQlmb3IgKHZhciBpID0gMDsgc2VlZCA9IHNlZWRzW2krK107ICkKCQl7CgkJCXRoaXMuczAgLT0gdGhpcy5oYXNoKHNlZWQpOwoJCQl0aGlzLnMwICs9IH5+KHRoaXMuczAgPCAwKTsKCQkJdGhpcy5zMSAtPSB0aGlzLmhhc2goc2VlZCk7CgkJCXRoaXMuczEgKz0gfn4odGhpcy5zMSA8IDApOwoJCQl0aGlzLnMyIC09IHRoaXMuaGFzaChzZWVkKTsKCQkJdGhpcy5zMiArPSB+fih0aGlzLnMyIDwgMCk7CgkJfQoJCQoJfSwKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjaGFzaAoJKiBAcGFyYW0ge0FueX0gZGF0YQoJKiBAcHJpdmF0ZQoJKiBAcmV0dXJuIHtudW1iZXJ9IERlc2NyaXB0aW9uLgoJKi8KCWhhc2g6IGZ1bmN0aW9uIChkYXRhKSB7CgoJCXZhciBoLCBpLCBuOwoJCW4gPSAweGVmYzgyNDlkOwoJCWRhdGEgPSBkYXRhLnRvU3RyaW5nKCk7CgoJCWZvciAoaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgaSsrKSB7CgkJCW4gKz0gZGF0YS5jaGFyQ29kZUF0KGkpOwoJCQloID0gMC4wMjUxOTYwMzI4MjQxNjkzOCAqIG47CgkJCW4gPSBoID4+PiAwOwoJCQloIC09IG47CgkJCWggKj0gbjsKCQkJbiA9IGggPj4+IDA7CgkJCWggLT0gbjsKCQkJbiArPSBoICogMHgxMDAwMDAwMDA7Ly8gMl4zMgoJCX0KCgkJcmV0dXJuIChuID4+PiAwKSAqIDIuMzI4MzA2NDM2NTM4Njk2M2UtMTA7Ly8gMl4tMzIKCgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiAwIGFuZCAyXjMyLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2ludGVnZXIKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCWludGVnZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLnJuZC5hcHBseSh0aGlzKSAqIDB4MTAwMDAwMDAwOy8vIDJeMzIKCX0sCgoJLyoqCgkqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAwIGFuZCAxLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2ZyYWMKCSogQHJldHVybiB7bnVtYmVyfQoJKi8JCglmcmFjOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5ybmQuYXBwbHkodGhpcykgKyAodGhpcy5ybmQuYXBwbHkodGhpcykgKiAweDIwMDAwMCB8IDApICogMS4xMTAyMjMwMjQ2MjUxNTY1ZS0xNjsvLyAyXi01MwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHJhbmRvbSByZWFsIG51bWJlciBiZXR3ZWVuIDAgYW5kIDJeMzIuCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjcmVhbAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJcmVhbDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuaW50ZWdlcigpICsgdGhpcy5mcmFjKCk7Cgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIGludGVnZXIgYmV0d2VlbiBtaW4gYW5kIG1heC4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNpbnRlZ2VySW5SYW5nZQoJKiBAcGFyYW0ge251bWJlcn0gbWluCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXgKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCWludGVnZXJJblJhbmdlOiBmdW5jdGlvbiAobWluLCBtYXgpIHsKCQlyZXR1cm4gTWF0aC5mbG9vcih0aGlzLnJlYWxJblJhbmdlKG1pbiwgbWF4KSk7Cgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIHJlYWwgbnVtYmVyIGJldHdlZW4gbWluIGFuZCBtYXguCgkqIEBtZXRob2QgUGhhc2VyLlJhbmRvbURhdGFHZW5lcmF0b3IjcmVhbEluUmFuZ2UKCSogQHBhcmFtIHtudW1iZXJ9IG1pbgoJKiBAcGFyYW0ge251bWJlcn0gbWF4CgkqIEByZXR1cm4ge251bWJlcn0KCSovCglyZWFsSW5SYW5nZTogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgoJCXJldHVybiB0aGlzLmZyYWMoKSAqIChtYXggLSBtaW4pICsgbWluOwoKCX0sCgoJLyoqCgkqIFJldHVybnMgYSByYW5kb20gcmVhbCBudW1iZXIgYmV0d2VlbiAtMSBhbmQgMS4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciNub3JtYWwKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCW5vcm1hbDogZnVuY3Rpb24gKCkgewoJCXJldHVybiAxIC0gMiAqIHRoaXMuZnJhYygpOwoJfSwKCgkvKioKCSogUmV0dXJucyBhIHZhbGlkIFJGQzQxMjIgdmVyc2lvbjQgSUQgaGV4IHN0cmluZyBmcm9tIGh0dHBzOi8vZ2lzdC5naXRodWIuY29tLzEzMDgzNjgKCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN1dWlkCgkqIEByZXR1cm4ge3N0cmluZ30KCSovCgl1dWlkOiBmdW5jdGlvbiAoKSB7CgoJCXZhciBhLCBiOwoKCQlmb3IgKAoJCQliPWE9Jyc7CgkJCWErKzwzNjsKCQkJYis9fmElNXxhKjMmND8oYV4xNT84XnRoaXMuZnJhYygpKihhXjIwPzE2OjQpOjQpLnRvU3RyaW5nKDE2KTonLScKCQkpOwoKCQlyZXR1cm4gYjsKCgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIG1lbWJlciBvZiBgYXJyYXlgLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3BpY2sKCSogQHBhcmFtIHtBbnl9IGFyeQoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJcGljazogZnVuY3Rpb24gKGFyeSkgewoJCXJldHVybiBhcnlbdGhpcy5pbnRlZ2VySW5SYW5nZSgwLCBhcnkubGVuZ3RoKV07Cgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIG1lbWJlciBvZiBgYXJyYXlgLCBmYXZvcmluZyB0aGUgZWFybGllciBlbnRyaWVzLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI3dlaWdodGVkUGljawoJKiBAcGFyYW0ge0FueX0gYXJ5CgkqIEByZXR1cm4ge251bWJlcn0KCSovCgl3ZWlnaHRlZFBpY2s6IGZ1bmN0aW9uIChhcnkpIHsKCQlyZXR1cm4gYXJ5W35+KE1hdGgucG93KHRoaXMuZnJhYygpLCAyKSAqIGFyeS5sZW5ndGgpXTsKCX0sCgoJLyoqCgkqIFJldHVybnMgYSByYW5kb20gdGltZXN0YW1wIGJldHdlZW4gbWluIGFuZCBtYXgsIG9yIGJldHdlZW4gdGhlIGJlZ2lubmluZyBvZiAyMDAwIGFuZCB0aGUgZW5kIG9mIDIwMjAgaWYgbWluIGFuZCBtYXggYXJlbid0IHNwZWNpZmllZC4KCSogQG1ldGhvZCBQaGFzZXIuUmFuZG9tRGF0YUdlbmVyYXRvciN0aW1lc3RhbXAKCSogQHBhcmFtIHtudW1iZXJ9IG1pbgoJKiBAcGFyYW0ge251bWJlcn0gbWF4CgkqIEByZXR1cm4ge251bWJlcn0KCSovCgl0aW1lc3RhbXA6IGZ1bmN0aW9uIChhLCBiKSB7CgkJcmV0dXJuIHRoaXMucmVhbEluUmFuZ2UoYSB8fCA5NDY2ODQ4MDAwMDAsIGIgfHwgMTU3Nzg2MjAwMDAwMCk7Cgl9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZG9tIGFuZ2xlIGJldHdlZW4gLTE4MCBhbmQgMTgwLgoJKiBAbWV0aG9kIFBoYXNlci5SYW5kb21EYXRhR2VuZXJhdG9yI2FuZ2xlCgkqIEByZXR1cm4ge251bWJlcn0KCSovCglhbmdsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuaW50ZWdlckluUmFuZ2UoLTE4MCwgMTgwKTsKCX0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWF0aGVtYXRpY2FsIG1ldGhvZHMuCioKKiBAY2xhc3MgUGhhc2VyLk1hdGgKKi8KUGhhc2VyLk1hdGggPSB7CgoJLyoqCgkqID0gMiAmcGk7CgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjUEkyCgkqLwoJUEkyOiBNYXRoLlBJICogMiwKCgkvKioKCSogVHdvIG51bWJlciBhcmUgZnV6enlFcXVhbCBpZiB0aGVpciBkaWZmZXJlbmNlIGlzIGxlc3MgdGhhbiAmZXBzaWxvbjsuIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5RXF1YWwKCSogQHBhcmFtIHtudW1iZXJ9IGEKCSogQHBhcmFtIHtudW1iZXJ9IGIKCSogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgfGEtYnw8JmVwc2lsb247CgkqLwogICAgZnV6enlFcXVhbDogZnVuY3Rpb24gKGEsIGIsIGVwc2lsb24pIHsKICAgICAgICBpZiAodHlwZW9mIGVwc2lsb24gPT09ICJ1bmRlZmluZWQiKSB7IGVwc2lsb24gPSAwLjAwMDE7IH0KICAgICAgICByZXR1cm4gTWF0aC5hYnMoYSAtIGIpIDwgZXBzaWxvbjsKICAgIH0sCgoJLyoqCgkqIGEgaXMgZnV6enlMZXNzVGhhbiBiIGlmIGl0IGlzIGxlc3MgdGhhbiBiICsgJmVwc2lsb247LiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmdXp6eUVxdWFsCgkqIEBwYXJhbSB7bnVtYmVyfSBhCgkqIEBwYXJhbSB7bnVtYmVyfSBiCgkqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGE8YismZXBzaWxvbjsKCSovCiAgICBmdXp6eUxlc3NUaGFuOiBmdW5jdGlvbiAoYSwgYiwgZXBzaWxvbikgewogICAgICAgIGlmICh0eXBlb2YgZXBzaWxvbiA9PT0gInVuZGVmaW5lZCIpIHsgZXBzaWxvbiA9IDAuMDAwMTsgfQogICAgICAgIHJldHVybiBhIDwgYiArIGVwc2lsb247CiAgICB9LAoKCS8qKgoJKiBhIGlzIGZ1enp5R3JlYXRlclRoYW4gYiBpZiBpdCBpcyBtb3JlIHRoYW4gYiAtICZlcHNpbG9uOy4gIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5R3JlYXRlclRoYW4KCSogQHBhcmFtIHtudW1iZXJ9IGEKCSogQHBhcmFtIHtudW1iZXJ9IGIKCSogQHBhcmFtIHtudW1iZXJ9IGVwc2lsb24gCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgYT5iKyZlcHNpbG9uOwoJKi8KICAgIGZ1enp5R3JlYXRlclRoYW46IGZ1bmN0aW9uIChhLCBiLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIGEgPiBiIC0gZXBzaWxvbjsKICAgIH0sCgoJLyoqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5Q2VpbAoJKiBAcGFyYW0ge251bWJlcn0gdmFsCgkqIEBwYXJhbSB7bnVtYmVyfSBlcHNpbG9uIAoJKiBAcmV0dXJuIHtib29sZWFufSBjZWlsaW5nKHZhbC0mZXBzaWxvbjspCgkqLwogICAgZnV6enlDZWlsOiBmdW5jdGlvbiAodmFsLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIE1hdGguY2VpbCh2YWwgLSBlcHNpbG9uKTsKICAgIH0sCgoJLyoqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2Z1enp5Rmxvb3IKCSogQHBhcmFtIHtudW1iZXJ9IHZhbAoJKiBAcGFyYW0ge251bWJlcn0gZXBzaWxvbiAKCSogQHJldHVybiB7Ym9vbGVhbn0gZmxvb3IodmFsLSZlcHNpbG9uOykKCSovCiAgICBmdXp6eUZsb29yOiBmdW5jdGlvbiAodmFsLCBlcHNpbG9uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBlcHNpbG9uID09PSAidW5kZWZpbmVkIikgeyBlcHNpbG9uID0gMC4wMDAxOyB9CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodmFsICsgZXBzaWxvbik7CiAgICB9LAoKCS8qKiAKICAgICogQXZlcmFnZXMgYWxsIHZhbHVlcyBwYXNzZWQgdG8gdGhlIGZ1bmN0aW9uIGFuZCByZXR1cm5zIHRoZSByZXN1bHQuIFlvdSBjYW4gcGFzcyBhcyBtYW55IHBhcmFtZXRlcnMgYXMgeW91IGxpa2UuCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjYXZlcmFnZQogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhdmVyYWdlIG9mIGFsbCBnaXZlbiB2YWx1ZXMuCgkqLwogICAgYXZlcmFnZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgYXJncyA9IFtdOwoKICAgICAgICBmb3IgKHZhciBfaSA9IDA7IF9pIDwgKGFyZ3VtZW50cy5sZW5ndGggLSAwKTsgX2krKykgewogICAgICAgICAgICBhcmdzW19pXSA9IGFyZ3VtZW50c1tfaSArIDBdOwogICAgICAgIH0KCiAgICAgICAgdmFyIGF2ZyA9IDA7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgYXJncy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBhdmcgKz0gYXJnc1tpXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhdmcgLyBhcmdzLmxlbmd0aDsKCiAgICB9LAoKCS8qKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCN0cnVuY2F0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gbgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgdHJ1bmNhdGU6IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcmV0dXJuIChuID4gMCkgPyBNYXRoLmZsb29yKG4pIDogTWF0aC5jZWlsKG4pOwogICAgfSwKCgkvKiogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2hlYXIKCSogQHBhcmFtIHtudW1iZXJ9IG4KCSogQHJldHVybiB7bnVtYmVyfSBuIG1vZCAxCgkqLwogICAgc2hlYXI6IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgcmV0dXJuIG4gJSAxOwogICAgfSwKCgkvKioKCSogU25hcCBhIHZhbHVlIHRvIG5lYXJlc3QgZ3JpZCBzbGljZSwgdXNpbmcgcm91bmRpbmcuCgkqCgkqIEV4YW1wbGU6IGlmIHlvdSBoYXZlIGFuIGludGVydmFsIGdhcCBvZiA1IGFuZCBhIHBvc2l0aW9uIG9mIDEyLi4uIHlvdSB3aWxsIHNuYXAgdG8gMTAgd2hlcmVhcyAxNCB3aWxsIHNuYXAgdG8gMTUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvCgkqIEBwYXJhbSB7bnVtYmVyfSBpbnB1dCAtIFRoZSB2YWx1ZSB0byBzbmFwLgoJKiBAcGFyYW0ge251bWJlcn0gZ2FwIC0gVGhlIGludGVydmFsIGdhcCBvZiB0aGUgZ3JpZC4KCSogQHBhcmFtIHtudW1iZXJ9IFtzdGFydF0gLSBPcHRpb25hbCBzdGFydGluZyBvZmZzZXQgZm9yIGdhcC4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIHNuYXBUbzogZnVuY3Rpb24gKGlucHV0LCBnYXAsIHN0YXJ0KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnQgPT09ICJ1bmRlZmluZWQiKSB7IHN0YXJ0ID0gMDsgfQoKICAgICAgICBpZiAoZ2FwID09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGlucHV0OwogICAgICAgIH0KCiAgICAgICAgaW5wdXQgLT0gc3RhcnQ7CiAgICAgICAgaW5wdXQgPSBnYXAgKiBNYXRoLnJvdW5kKGlucHV0IC8gZ2FwKTsKCiAgICAgICAgcmV0dXJuIHN0YXJ0ICsgaW5wdXQ7CgogICAgfSwKCgkvKioKICAgICogU25hcCBhIHZhbHVlIHRvIG5lYXJlc3QgZ3JpZCBzbGljZSwgdXNpbmcgZmxvb3IuCiAgICAqCiAgICAqIEV4YW1wbGU6IGlmIHlvdSBoYXZlIGFuIGludGVydmFsIGdhcCBvZiA1IGFuZCBhIHBvc2l0aW9uIG9mIDEyLi4uIHlvdSB3aWxsIHNuYXAgdG8gMTAuIEFzIHdpbGwgMTQgc25hcCB0byAxMC4uLiBidXQgMTYgd2lsbCBzbmFwIHRvIDE1CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvRmxvb3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGlucHV0IC0gVGhlIHZhbHVlIHRvIHNuYXAuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnYXAgLSBUaGUgaW50ZXJ2YWwgZ2FwIG9mIHRoZSBncmlkLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3N0YXJ0XSAtIE9wdGlvbmFsIHN0YXJ0aW5nIG9mZnNldCBmb3IgZ2FwLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgc25hcFRvRmxvb3I6IGZ1bmN0aW9uIChpbnB1dCwgZ2FwLCBzdGFydCkgewoKICAgICAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAidW5kZWZpbmVkIikgeyBzdGFydCA9IDA7IH0KCiAgICAgICAgaWYgKGdhcCA9PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBpbnB1dDsKICAgICAgICB9CgogICAgICAgIGlucHV0IC09IHN0YXJ0OwogICAgICAgIGlucHV0ID0gZ2FwICogTWF0aC5mbG9vcihpbnB1dCAvIGdhcCk7CgogICAgICAgIHJldHVybiBzdGFydCArIGlucHV0OwoKICAgIH0sCgoJLyoqCgkqIFNuYXAgYSB2YWx1ZSB0byBuZWFyZXN0IGdyaWQgc2xpY2UsIHVzaW5nIGNlaWwuCgkqCgkqIEV4YW1wbGU6IGlmIHlvdSBoYXZlIGFuIGludGVydmFsIGdhcCBvZiA1IGFuZCBhIHBvc2l0aW9uIG9mIDEyLi4uIHlvdSB3aWxsIHNuYXAgdG8gMTUuIEFzIHdpbGwgMTQgd2lsbCBzbmFwIHRvIDE1Li4uIGJ1dCAxNiB3aWxsIHNuYXAgdG8gMjAuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc25hcFRvQ2VpbAogICAgKiBAcGFyYW0ge251bWJlcn0gaW5wdXQgLSBUaGUgdmFsdWUgdG8gc25hcC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdhcCAtIFRoZSBpbnRlcnZhbCBnYXAgb2YgdGhlIGdyaWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3RhcnRdIC0gT3B0aW9uYWwgc3RhcnRpbmcgb2Zmc2V0IGZvciBnYXAuCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBzbmFwVG9DZWlsOiBmdW5jdGlvbiAoaW5wdXQsIGdhcCwgc3RhcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzdGFydCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnQgPSAwOyB9CgogICAgICAgIGlmIChnYXAgPT0gMCkgewogICAgICAgICAgICByZXR1cm4gaW5wdXQ7CiAgICAgICAgfQoKICAgICAgICBpbnB1dCAtPSBzdGFydDsKICAgICAgICBpbnB1dCA9IGdhcCAqIE1hdGguY2VpbChpbnB1dCAvIGdhcCk7CgogICAgICAgIHJldHVybiBzdGFydCArIGlucHV0OwoKICAgIH0sCgoKCS8qKgoJKiBTbmFwcyBhIHZhbHVlIHRvIHRoZSBuZWFyZXN0IHZhbHVlIGluIGFuIGFycmF5LgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NuYXBUb0luQXJyYXkKCSogQHBhcmFtIHtudW1iZXJ9IGlucHV0CgkqIEBwYXJhbSB7YXJyYXl9IGFyciAKCSogQHBhcmFtIHtib29sZWFufSBzb3J0IC0gVHJ1ZSBpZiB0aGUgYXJyYXkgbmVlZHMgdG8gYmUgc29ydGVkLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgc25hcFRvSW5BcnJheTogZnVuY3Rpb24gKGlucHV0LCBhcnIsIHNvcnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzb3J0ID09PSAidW5kZWZpbmVkIikgeyBzb3J0ID0gdHJ1ZTsgfQoKICAgICAgICBpZiAoc29ydCkgewogICAgICAgICAgICBhcnIuc29ydCgpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGlucHV0IDwgYXJyWzBdKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJbMF07CiAgICAgICAgfQoKICAgICAgICB2YXIgaSA9IDE7CiAgICAgICAgCiAgICAgICAgd2hpbGUgKGFycltpXSA8IGlucHV0KSB7CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CgogICAgICAgIHZhciBsb3cgPSBhcnJbaSAtIDFdOwogICAgICAgIHZhciBoaWdoID0gKGkgPCBhcnIubGVuZ3RoKSA/IGFycltpXSA6IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTsKICAgICAgICAKICAgICAgICByZXR1cm4gKChoaWdoIC0gaW5wdXQpIDw9IChpbnB1dCAtIGxvdykpID8gaGlnaCA6IGxvdzsKCiAgICB9LAoKCS8qKgoJKiBSb3VuZCB0byBzb21lIHBsYWNlIGNvbXBhcmF0aXZlIHRvIGEgJ2Jhc2UnLCBkZWZhdWx0IGlzIDEwIGZvciBkZWNpbWFsIHBsYWNlLgoJKgoJKiAncGxhY2UnIGlzIHJlcHJlc2VudGVkIGJ5IHRoZSBwb3dlciBhcHBsaWVkIHRvICdiYXNlJyB0byBnZXQgdGhhdCBwbGFjZQoJKiBlLmcuCgkqIDIwMDAvNyB+PSAyODUuNzE0Mjg1NzE0Mjg1NzE0Mjg1NzE0IH49IChiaW4pMTAwMDExMTAxLjEwMTEwMTEwMTEwMTEwMTEKCSoKCSogcm91bmRUbygyMDAwLzcsMykgPT0gMAoJKiByb3VuZFRvKDIwMDAvNywyKSA9PSAzMDAKCSogcm91bmRUbygyMDAwLzcsMSkgPT0gMjkwCgkqIHJvdW5kVG8oMjAwMC83LDApID09IDI4NgoJKiByb3VuZFRvKDIwMDAvNywtMSkgPT0gMjg1LjcKCSogcm91bmRUbygyMDAwLzcsLTIpID09IDI4NS43MQoJKiByb3VuZFRvKDIwMDAvNywtMykgPT0gMjg1LjcxNAoJKiByb3VuZFRvKDIwMDAvNywtNCkgPT0gMjg1LjcxNDMKCSogcm91bmRUbygyMDAwLzcsLTUpID09IDI4NS43MTQyOQoJKgoJKiByb3VuZFRvKDIwMDAvNywzLDIpICA9PSAyODggICAgICAgLS0gMTAwMTAwMDAwCgkqIHJvdW5kVG8oMjAwMC83LDIsMikgID09IDI4NCAgICAgICAtLSAxMDAwMTExMDAKCSogcm91bmRUbygyMDAwLzcsMSwyKSAgPT0gMjg2ICAgICAgIC0tIDEwMDAxMTExMAoJKiByb3VuZFRvKDIwMDAvNywwLDIpICA9PSAyODYgICAgICAgLS0gMTAwMDExMTEwCgkqIHJvdW5kVG8oMjAwMC83LC0xLDIpID09IDI4NS41ICAgICAtLSAxMDAwMTExMDEuMQoJKiByb3VuZFRvKDIwMDAvNywtMiwyKSA9PSAyODUuNzUgICAgLS0gMTAwMDExMTAxLjExCgkqIHJvdW5kVG8oMjAwMC83LC0zLDIpID09IDI4NS43NSAgICAtLSAxMDAwMTExMDEuMTEKCSogcm91bmRUbygyMDAwLzcsLTQsMikgPT0gMjg1LjY4NzUgIC0tIDEwMDAxMTEwMS4xMDExCgkqIHJvdW5kVG8oMjAwMC83LC01LDIpID09IDI4NS43MTg3NSAtLSAxMDAwMTExMDEuMTAxMTEKCSoKCSogTm90ZSB3aGF0IG9jY3VycyB3aGVuIHdlIHJvdW5kIHRvIHRoZSAzcmQgc3BhY2UgKDh0aHMgcGxhY2UpLCAxMDAxMDAwMDAsIHRoaXMgaXMgdG8gYmUgYXNzdW1lZAoJKiBiZWNhdXNlIHdlIGFyZSByb3VuZGluZyAxMDAwMTEuMTAxMTAxMTAxMTAxMTAxMSB3aGljaCByb3VuZHMgdXAuCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3JvdW5kVG8KCSogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJvdW5kLgoJKiBAcGFyYW0ge251bWJlcn0gcGxhY2UgLSBUaGUgcGxhY2UgdG8gcm91bmQgdG8uCgkqIEBwYXJhbSB7bnVtYmVyfSBiYXNlIC0gVGhlIGJhc2UgdG8gcm91bmQgaW4uLi4gZGVmYXVsdCBpcyAxMCBmb3IgZGVjaW1hbC4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIHJvdW5kVG86IGZ1bmN0aW9uICh2YWx1ZSwgcGxhY2UsIGJhc2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBwbGFjZSA9PT0gInVuZGVmaW5lZCIpIHsgcGxhY2UgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBiYXNlID09PSAidW5kZWZpbmVkIikgeyBiYXNlID0gMTA7IH0KICAgICAgICAKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CiAgICAgICAgCiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCiAgICAvKioKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmbG9vclRvCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byByb3VuZC4KCSogQHBhcmFtIHtudW1iZXJ9IHBsYWNlIC0gVGhlIHBsYWNlIHRvIHJvdW5kIHRvLgoJKiBAcGFyYW0ge251bWJlcn0gYmFzZSAtIFRoZSBiYXNlIHRvIHJvdW5kIGluLi4uIGRlZmF1bHQgaXMgMTAgZm9yIGRlY2ltYWwuCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBmbG9vclRvOiBmdW5jdGlvbiAodmFsdWUsIHBsYWNlLCBiYXNlKSB7CgogICAgICAgIGlmICh0eXBlb2YgcGxhY2UgPT09ICJ1bmRlZmluZWQiKSB7IHBsYWNlID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgYmFzZSA9PT0gInVuZGVmaW5lZCIpIHsgYmFzZSA9IDEwOyB9CgogICAgICAgIHZhciBwID0gTWF0aC5wb3coYmFzZSwgLXBsYWNlKTsKCiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCiAgICAvKioKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjZWlsVG8KCSogQHBhcmFtIHtudW1iZXJ9IHZhbHVlIC0gVGhlIHZhbHVlIHRvIHJvdW5kLgoJKiBAcGFyYW0ge251bWJlcn0gcGxhY2UgLSBUaGUgcGxhY2UgdG8gcm91bmQgdG8uCgkqIEBwYXJhbSB7bnVtYmVyfSBiYXNlIC0gVGhlIGJhc2UgdG8gcm91bmQgaW4uLi4gZGVmYXVsdCBpcyAxMCBmb3IgZGVjaW1hbC4KICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIGNlaWxUbzogZnVuY3Rpb24gKHZhbHVlLCBwbGFjZSwgYmFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIHBsYWNlID09PSAidW5kZWZpbmVkIikgeyBwbGFjZSA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGJhc2UgPT09ICJ1bmRlZmluZWQiKSB7IGJhc2UgPSAxMDsgfQoKICAgICAgICB2YXIgcCA9IE1hdGgucG93KGJhc2UsIC1wbGFjZSk7CgogICAgICAgIHJldHVybiBNYXRoLmNlaWwodmFsdWUgKiBwKSAvIHA7CgogICAgfSwKCgkvKioKCSogQSBvbmUgZGltZW5zaW9uYWwgbGluZWFyIGludGVycG9sYXRpb24gb2YgYSB2YWx1ZS4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNpbnRlcnBvbGF0ZUZsb2F0CgkqIEBwYXJhbSB7bnVtYmVyfSBhCgkqIEBwYXJhbSB7bnVtYmVyfSBiCgkqIEBwYXJhbSB7bnVtYmVyfSB3ZWlnaHQgCiAgICAqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBpbnRlcnBvbGF0ZUZsb2F0OiBmdW5jdGlvbiAoYSwgYiwgd2VpZ2h0KSB7CiAgICAgICAgcmV0dXJuIChiIC0gYSkgKiB3ZWlnaHQgKyBhOwogICAgfSwKCgkvKioKCSogRmluZCB0aGUgYW5nbGUgb2YgYSBzZWdtZW50IGZyb20gKHgxLCB5MSkgLT4gKHgyLCB5MiApLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2FuZ2xlQmV0d2VlbgoJKiBAcGFyYW0ge251bWJlcn0geDEKCSogQHBhcmFtIHtudW1iZXJ9IHkxCgkqIEBwYXJhbSB7bnVtYmVyfSB4MgoJKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfQoJKi8KICAgIGFuZ2xlQmV0d2VlbjogZnVuY3Rpb24gKHgxLCB5MSwgeDIsIHkyKSB7CiAgICAgICAgcmV0dXJuIE1hdGguYXRhbjIoeTIgLSB5MSwgeDIgLSB4MSk7CiAgICB9LAoKCS8qKgoJKiBTZXQgYW4gYW5nbGUgIHdpdGhpbiB0aGUgYm91bmRzIG9mIC0mcGk7IHRvJnBpOy4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNub3JtYWxpemVBbmdsZQoJKiBAcGFyYW0ge251bWJlcn0gYW5nbGUKCSogQHBhcmFtIHtib29sZWFufSByYWRpYW5zIC0gVHJ1ZSBpZiBhbmdsZSBzaXplIGlzIGV4cHJlc3NlZCBpbiByYWRpYW5zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgbm9ybWFsaXplQW5nbGU6IGZ1bmN0aW9uIChhbmdsZSwgcmFkaWFucykgewoKICAgICAgICBpZiAodHlwZW9mIHJhZGlhbnMgPT09ICJ1bmRlZmluZWQiKSB7IHJhZGlhbnMgPSB0cnVlOyB9CgogICAgICAgIHZhciByZCA9IChyYWRpYW5zKSA/IE1hdGguUEkgOiAxODA7CiAgICAgICAgcmV0dXJuIHRoaXMud3JhcChhbmdsZSwgcmQsIC1yZCk7CiAgICAgICAgCiAgICB9LAoKCS8qKgoJKiBDbG9zZXN0IGFuZ2xlIGJldHdlZW4gdHdvIGFuZ2xlcyBmcm9tIGExIHRvIGEyCgkqIGFic29sdXRlIHZhbHVlIHRoZSByZXR1cm4gZm9yIGV4YWN0IGFuZ2xlCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjbmVhcmVzdEFuZ2xlQmV0d2VlbgoJKiBAcGFyYW0ge251bWJlcn0gYTEKCSogQHBhcmFtIHtudW1iZXJ9IGEyCgkqIEBwYXJhbSB7Ym9vbGVhbn0gcmFkaWFucyAtIFRydWUgaWYgYW5nbGUgc2l6ZXMgYXJlIGV4cHJlc3NlZCBpbiByYWRpYW5zLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgbmVhcmVzdEFuZ2xlQmV0d2VlbjogZnVuY3Rpb24gKGExLCBhMiwgcmFkaWFucykgewoKICAgICAgICBpZiAodHlwZW9mIHJhZGlhbnMgPT09ICJ1bmRlZmluZWQiKSB7IHJhZGlhbnMgPSB0cnVlOyB9CgogICAgICAgIHZhciByZCA9IChyYWRpYW5zKSA/IE1hdGguUEkgOiAxODA7CiAgICAgICAgYTEgPSB0aGlzLm5vcm1hbGl6ZUFuZ2xlKGExLCByYWRpYW5zKTsKICAgICAgICBhMiA9IHRoaXMubm9ybWFsaXplQW5nbGUoYTIsIHJhZGlhbnMpOwogICAgICAgIAogICAgICAgIGlmIChhMSA8IC1yZCAvIDIgJiYgYTIgPiByZCAvIDIpCiAgICAgICAgewogICAgICAgICAgICBhMSArPSByZCAqIDI7CiAgICAgICAgfQoKICAgICAgICBpZiAoYTIgPCAtcmQgLyAyICYmIGExID4gcmQgLyAyKQogICAgICAgIHsKICAgICAgICAgICAgYTIgKz0gcmQgKiAyOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGEyIC0gYTE7CgogICAgfSwKCgkvKioKCSogSW50ZXJwb2xhdGUgYWNyb3NzIHRoZSBzaG9ydGVzdCBhcmMgYmV0d2VlbiB0d28gYW5nbGVzLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2ludGVycG9sYXRlQW5nbGVzCgkqIEBwYXJhbSB7bnVtYmVyfSBhMSAtIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge251bWJlcn0gYTIgLSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtudW1iZXJ9IHdlaWdodCAtIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge2Jvb2xlYW59IHJhZGlhbnMgLSBUcnVlIGlmIGFuZ2xlIHNpemVzIGFyZSBleHByZXNzZWQgaW4gcmFkaWFucy4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gZWFzZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgaW50ZXJwb2xhdGVBbmdsZXM6IGZ1bmN0aW9uIChhMSwgYTIsIHdlaWdodCwgcmFkaWFucywgZWFzZSkgewoKICAgICAgICBpZiAodHlwZW9mIHJhZGlhbnMgPT09ICJ1bmRlZmluZWQiKSB7IHJhZGlhbnMgPSB0cnVlOyB9CiAgICAgICAgaWYgKHR5cGVvZiBlYXNlID09PSAidW5kZWZpbmVkIikgeyBlYXNlID0gbnVsbDsgfQoKICAgICAgICBhMSA9IHRoaXMubm9ybWFsaXplQW5nbGUoYTEsIHJhZGlhbnMpOwogICAgICAgIGEyID0gdGhpcy5ub3JtYWxpemVBbmdsZVRvQW5vdGhlcihhMiwgYTEsIHJhZGlhbnMpOwoKICAgICAgICByZXR1cm4gKHR5cGVvZiBlYXNlID09PSAnZnVuY3Rpb24nKSA/IGVhc2Uod2VpZ2h0LCBhMSwgYTIgLSBhMSwgMSkgOiB0aGlzLmludGVycG9sYXRlRmxvYXQoYTEsIGEyLCB3ZWlnaHQpOwoKICAgIH0sCgoJLyoqCgkqIEdlbmVyYXRlIGEgcmFuZG9tIGJvb2wgcmVzdWx0IGJhc2VkIG9uIHRoZSBjaGFuY2UgdmFsdWUuCgkqIDxwPgoJKiBSZXR1cm5zIHRydWUgb3IgZmFsc2UgYmFzZWQgb24gdGhlIGNoYW5jZSB2YWx1ZSAoZGVmYXVsdCA1MCUpLiBGb3IgZXhhbXBsZSBpZiB5b3Ugd2FudGVkIGEgcGxheWVyIHRvIGhhdmUgYSAzMCUgY2hhbmNlCgkqIG9mIGdldHRpbmcgYSBib251cywgY2FsbCBjaGFuY2VSb2xsKDMwKSAtIHRydWUgbWVhbnMgdGhlIGNoYW5jZSBwYXNzZWQsIGZhbHNlIG1lYW5zIGl0IGZhaWxlZC4KCSogPC9wPgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NoYW5jZVJvbGwKCSogQHBhcmFtIHtudW1iZXJ9IGNoYW5jZSAtIFRoZSBjaGFuY2Ugb2YgcmVjZWl2aW5nIHRoZSB2YWx1ZS4gQSBudW1iZXIgYmV0d2VlbiAwIGFuZCAxMDAgKGVmZmVjdGl2ZWx5IDAlIHRvIDEwMCUpLgoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSByb2xsIHBhc3NlZCwgb3IgZmFsc2Ugb3RoZXJ3aXNlLgoJKi8KICAgIGNoYW5jZVJvbGw6IGZ1bmN0aW9uIChjaGFuY2UpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBjaGFuY2UgPT09ICJ1bmRlZmluZWQiKSB7IGNoYW5jZSA9IDUwOyB9CiAgICAgICAgCiAgICAgICAgaWYgKGNoYW5jZSA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChjaGFuY2UgPj0gMTAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIGlmIChNYXRoLnJhbmRvbSgpICogMTAwID49IGNoYW5jZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhbiBBcnJheSBjb250YWluaW5nIHRoZSBudW1iZXJzIGZyb20gbWluIHRvIG1heCAoaW5jbHVzaXZlKS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNudW1iZXJBcnJheQogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdmFsdWUgdGhlIGFycmF5IHN0YXJ0cyB3aXRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdGhlIGFycmF5IGNvbnRhaW5zLgogICAgKiBAcmV0dXJuIHthcnJheX0gVGhlIGFycmF5IG9mIG51bWJlciB2YWx1ZXMuCiAgICAqLwogICAgbnVtYmVyQXJyYXk6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB2YXIgcmVzdWx0ID0gW107CgogICAgICAgIGZvciAodmFyIGkgPSBtaW47IGkgPD0gbWF4OyBpKyspCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQucHVzaChpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiByZXN1bHQ7CgogICAgfSwKCgkvKioKCSogQWRkcyB0aGUgZ2l2ZW4gYW1vdW50IHRvIHRoZSB2YWx1ZSwgYnV0IG5ldmVyIGxldHMgdGhlIHZhbHVlIGdvIG92ZXIgdGhlIHNwZWNpZmllZCBtYXhpbXVtLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI21heEFkZAoJKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBUaGUgdmFsdWUgdG8gYWRkIHRoZSBhbW91bnQgdG8uCgkqIEBwYXJhbSB7bnVtYmVyfSBhbW91bnQgLSBUaGUgYW1vdW50IHRvIGFkZCB0byB0aGUgdmFsdWUuCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXgtIFRoZSBtYXhpbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgbWF4QWRkOiBmdW5jdGlvbiAodmFsdWUsIGFtb3VudCwgbWF4KSB7CgogICAgICAgIHZhbHVlICs9IGFtb3VudDsKCiAgICAgICAgaWYgKHZhbHVlID4gbWF4KQogICAgICAgIHsKICAgICAgICAgICAgdmFsdWUgPSBtYXg7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdmFsdWU7CgogICAgfSwKCgkvKioKCSogU3VidHJhY3RzIHRoZSBnaXZlbiBhbW91bnQgZnJvbSB0aGUgdmFsdWUsIGJ1dCBuZXZlciBsZXRzIHRoZSB2YWx1ZSBnbyBiZWxvdyB0aGUgc3BlY2lmaWVkIG1pbmltdW0uCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWluU3ViCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSBiYXNlIHZhbHVlLgoJKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCB0byBzdWJ0cmFjdCBmcm9tIHRoZSBiYXNlIHZhbHVlLgoJKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gdGhlIHZhbHVlIGlzIGFsbG93ZWQgdG8gYmUuCgkqIEByZXR1cm4ge251bWJlcn0gVGhlIG5ldyB2YWx1ZS4KCSovCiAgICBtaW5TdWI6IGZ1bmN0aW9uICh2YWx1ZSwgYW1vdW50LCBtaW4pIHsKCiAgICAgICAgdmFsdWUgLT0gYW1vdW50OwogICAgICAgIAogICAgICAgIGlmICh2YWx1ZSA8IG1pbikKICAgICAgICB7CiAgICAgICAgICAgIHZhbHVlID0gbWluOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZhbHVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEVuc3VyZXMgdGhhdCB0aGUgdmFsdWUgYWx3YXlzIHN0YXlzIGJldHdlZW4gbWluIGFuZCBtYXgsIGJ5IHdyYXBwaW5nIHRoZSB2YWx1ZSBhcm91bmQuCiAgICAqIDxwPm1heCBzaG91bGQgYmUgbGFyZ2VyIHRoYW4gbWluLCBvciB0aGUgZnVuY3Rpb24gd2lsbCByZXR1cm4gMDwvcD4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCN3cmFwCiAgICAqIEBwYXJhbSB2YWx1ZSBUaGUgdmFsdWUgdG8gd3JhcAogICAgKiBAcGFyYW0gbWluIFRoZSBtaW5pbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlCiAgICAqIEBwYXJhbSBtYXggVGhlIG1heGltdW0gdGhlIHZhbHVlIGlzIGFsbG93ZWQgdG8gYmUKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgd3JhcHBlZCB2YWx1ZQogICAgKi8KICAgIHdyYXA6IGZ1bmN0aW9uICh2YWx1ZSwgbWluLCBtYXgpIHsKCiAgICAgICAgdmFyIHJhbmdlID0gbWF4IC0gbWluOwoKICAgICAgICBpZiAocmFuZ2UgPD0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlc3VsdCA9ICh2YWx1ZSAtIG1pbikgJSByYW5nZTsKCiAgICAgICAgaWYgKHJlc3VsdCA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgKz0gcmFuZ2U7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQgKyBtaW47CgogICAgfSwKCiAgICAvKioKICAgICogQWRkcyB2YWx1ZSB0byBhbW91bnQgYW5kIGVuc3VyZXMgdGhhdCB0aGUgcmVzdWx0IGFsd2F5cyBzdGF5cyBiZXR3ZWVuIDAgYW5kIG1heCwgYnkgd3JhcHBpbmcgdGhlIHZhbHVlIGFyb3VuZC4KICAgICogPHA+VmFsdWVzIG11c3QgYmUgcG9zaXRpdmUgaW50ZWdlcnMsIGFuZCBhcmUgcGFzc2VkIHRocm91Z2ggTWF0aC5hYnM8L3A+CiAgICAqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjd3JhcFZhbHVlCgkqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZSAtIFRoZSB2YWx1ZSB0byBhZGQgdGhlIGFtb3VudCB0by4KCSogQHBhcmFtIHtudW1iZXJ9IGFtb3VudCAtIFRoZSBhbW91bnQgdG8gYWRkIHRvIHRoZSB2YWx1ZS4KCSogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHRoZSB2YWx1ZSBpcyBhbGxvd2VkIHRvIGJlLgoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSB3cmFwcGVkIHZhbHVlLgogICAgKi8KICAgIHdyYXBWYWx1ZTogZnVuY3Rpb24gKHZhbHVlLCBhbW91bnQsIG1heCkgewoKICAgICAgICB2YXIgZGlmZjsKICAgICAgICB2YWx1ZSA9IE1hdGguYWJzKHZhbHVlKTsKICAgICAgICBhbW91bnQgPSBNYXRoLmFicyhhbW91bnQpOwogICAgICAgIG1heCA9IE1hdGguYWJzKG1heCk7CiAgICAgICAgZGlmZiA9ICh2YWx1ZSArIGFtb3VudCkgJSBtYXg7CgogICAgICAgIHJldHVybiBkaWZmOwoKICAgIH0sCgoJLyoqCgkqIFJhbmRvbWx5IHJldHVybnMgZWl0aGVyIGEgMSBvciAtMS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNyYW5kb21TaWduCgkqIEByZXR1cm4ge251bWJlcn0JMSBvciAtMQoJKi8KICAgIHJhbmRvbVNpZ246IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKE1hdGgucmFuZG9tKCkgPiAwLjUpID8gMSA6IC0xOwogICAgfSwKCgkvKioKCSogUmV0dXJucyB0cnVlIGlmIHRoZSBudW1iZXIgZ2l2ZW4gaXMgb2RkLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2lzT2RkCgkqIEBwYXJhbSB7bnVtYmVyfSBuIC0gVGhlIG51bWJlciB0byBjaGVjay4KCSogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIG9kZC4gRmFsc2UgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBldmVuLgoJKi8KICAgIGlzT2RkOiBmdW5jdGlvbiAobikgewoKICAgICAgICByZXR1cm4gKG4gJiAxKTsKCiAgICB9LAoKCS8qKgoJKiBSZXR1cm5zIHRydWUgaWYgdGhlIG51bWJlciBnaXZlbiBpcyBldmVuLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2lzRXZlbgoJKiBAcGFyYW0ge251bWJlcn0gbiAtIFRoZSBudW1iZXIgdG8gY2hlY2suCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIG51bWJlciBpcyBldmVuLiBGYWxzZSBpZiB0aGUgZ2l2ZW4gbnVtYmVyIGlzIG9kZC4KCSovCiAgICBpc0V2ZW46IGZ1bmN0aW9uIChuKSB7CgogICAgICAgIGlmIChuICYgMSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFNpZ25pZmljYW50bHkgZmFzdGVyIHZlcnNpb24gb2YgTWF0aC5tYXgKICAgICogU2VlIGh0dHA6Ly9qc3BlcmYuY29tL21hdGgtcy1taW4tbWF4LXZzLWhvbWVtYWRlLzUKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXgKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgaGlnaGVzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1heDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMSwgbWF4ID0gMCwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50c1ttYXhdIDwgYXJndW1lbnRzW2ldKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtYXggPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBhcmd1bWVudHNbbWF4XTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTaWduaWZpY2FudGx5IGZhc3RlciB2ZXJzaW9uIG9mIE1hdGgubWluCiAgICAqIFNlZSBodHRwOi8vanNwZXJmLmNvbS9tYXRoLXMtbWluLW1heC12cy1ob21lbWFkZS81CiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjbWluCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGxvd2VzdCB2YWx1ZSBmcm9tIHRob3NlIGdpdmVuLgogICAgKi8KICAgIG1pbjogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0xICwgbWluID0gMCwgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50c1tpXSA8IGFyZ3VtZW50c1ttaW5dKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBtaW4gPSBpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYXJndW1lbnRzW21pbl07CgogICAgfSwKCgkvKioKCSogS2VlcHMgYW4gYW5nbGUgdmFsdWUgYmV0d2VlbiAtMTgwIGFuZCArMTgwPGJyPgoJKiBTaG91bGQgYmUgY2FsbGVkIHdoZW5ldmVyIHRoZSBhbmdsZSBpcyB1cGRhdGVkIG9uIHRoZSBTcHJpdGUgdG8gc3RvcCBpdCBmcm9tIGdvaW5nIGluc2FuZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCN3cmFwQW5nbGUKCSogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIHZhbHVlIHRvIGNoZWNrCgkqIEByZXR1cm4ge251bWJlcn0gVGhlIG5ldyBhbmdsZSB2YWx1ZSwgcmV0dXJucyB0aGUgc2FtZSBhcyB0aGUgaW5wdXQgYW5nbGUgaWYgaXQgd2FzIHdpdGhpbiBib3VuZHMuCgkqLwogICAgd3JhcEFuZ2xlOiBmdW5jdGlvbiAoYW5nbGUpIHsKCiAgICAgICAgdmFyIHJlc3VsdCA9IGFuZ2xlOwoKICAgICAgICAvLyAgTm90aGluZyBuZWVkcyB0byBjaGFuZ2UKICAgICAgICBpZiAoYW5nbGUgPj0gLTE4MCAmJiBhbmdsZSA8PSAxODApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gYW5nbGU7CiAgICAgICAgfQoKICAgICAgICAvLyAgRWxzZSBub3JtYWxpc2UgaXQgdG8gLTE4MCwgMTgwCiAgICAgICAgcmVzdWx0ID0gKGFuZ2xlICsgMTgwKSAlIDM2MDsKCiAgICAgICAgaWYgKHJlc3VsdCA8IDApCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgKz0gMzYwOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJlc3VsdCAtIDE4MDsKCiAgICB9LAoKCS8qKgoJKiBLZWVwcyBhbiBhbmdsZSB2YWx1ZSBiZXR3ZWVuIHRoZSBnaXZlbiBtaW4gYW5kIG1heCB2YWx1ZXMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjYW5nbGVMaW1pdAoJKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgdmFsdWUgdG8gY2hlY2suIE11c3QgYmUgYmV0d2VlbiAtMTgwIGFuZCArMTgwLgoJKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIG1pbmltdW0gYW5nbGUgdGhhdCBpcyBhbGxvd2VkIChtdXN0IGJlIC0xODAgb3IgZ3JlYXRlcikuCgkqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSBhbmdsZSB0aGF0IGlzIGFsbG93ZWQgKG11c3QgYmUgMTgwIG9yIGxlc3MpLgoJKgoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBuZXcgYW5nbGUgdmFsdWUsIHJldHVybnMgdGhlIHNhbWUgYXMgdGhlIGlucHV0IGFuZ2xlIGlmIGl0IHdhcyB3aXRoaW4gYm91bmRzCgkqLwogICAgYW5nbGVMaW1pdDogZnVuY3Rpb24gKGFuZ2xlLCBtaW4sIG1heCkgewoKICAgICAgICB2YXIgcmVzdWx0ID0gYW5nbGU7CgogICAgICAgIGlmIChhbmdsZSA+IG1heCkKICAgICAgICB7CiAgICAgICAgICAgIHJlc3VsdCA9IG1heDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYW5nbGUgPCBtaW4pCiAgICAgICAgewogICAgICAgICAgICByZXN1bHQgPSBtaW47CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzdWx0OwoKICAgIH0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2xpbmVhckludGVycG9sYXRpb24KCSogQHBhcmFtIHtudW1iZXJ9IHYKCSogQHBhcmFtIHtudW1iZXJ9IGsKCSogQHJldHVybiB7bnVtYmVyfSAKCSovCiAgICBsaW5lYXJJbnRlcnBvbGF0aW9uOiBmdW5jdGlvbiAodiwgaykgewoKICAgICAgICB2YXIgbSA9IHYubGVuZ3RoIC0gMTsKICAgICAgICB2YXIgZiA9IG0gKiBrOwogICAgICAgIHZhciBpID0gTWF0aC5mbG9vcihmKTsKCiAgICAgICAgaWYgKGsgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGluZWFyKHZbMF0sIHZbMV0sIGYpOwogICAgICAgIH0KCiAgICAgICAgaWYgKGsgPiAxKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGluZWFyKHZbbV0sIHZbbSAtIDFdLCBtIC0gZik7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gdGhpcy5saW5lYXIodltpXSwgdltpICsgMSA+IG0gPyBtIDogaSArIDFdLCBmIC0gaSk7CgogICAgfSwKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjYmV6aWVySW50ZXJwb2xhdGlvbgoJKiBAcGFyYW0ge251bWJlcn0gdgoJKiBAcGFyYW0ge251bWJlcn0gawoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgYmV6aWVySW50ZXJwb2xhdGlvbjogZnVuY3Rpb24gKHYsIGspIHsKCiAgICAgICAgdmFyIGIgPSAwOwogICAgICAgIHZhciBuID0gdi5sZW5ndGggLSAxOwoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8PSBuOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBiICs9IE1hdGgucG93KDEgLSBrLCBuIC0gaSkgKiBNYXRoLnBvdyhrLCBpKSAqIHZbaV0gKiB0aGlzLmJlcm5zdGVpbihuLCBpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBiOwoKICAgIH0sCgoJLyoqCgkqIERlc2NyaXB0aW9uLgoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI2NhdG11bGxSb21JbnRlcnBvbGF0aW9uCgkqIEBwYXJhbSB7bnVtYmVyfSB2CgkqIEBwYXJhbSB7bnVtYmVyfSBrCgkqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBjYXRtdWxsUm9tSW50ZXJwb2xhdGlvbjogZnVuY3Rpb24gKHYsIGspIHsKCiAgICAgICAgdmFyIG0gPSB2Lmxlbmd0aCAtIDE7CiAgICAgICAgdmFyIGYgPSBtICogazsKICAgICAgICB2YXIgaSA9IE1hdGguZmxvb3IoZik7CgogICAgICAgIGlmICh2WzBdID09PSB2W21dKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKGsgPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpID0gTWF0aC5mbG9vcihmID0gbSAqICgxICsgaykpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdGhpcy5jYXRtdWxsUm9tKHZbKGkgLSAxICsgbSkgJSBtXSwgdltpXSwgdlsoaSArIDEpICUgbV0sIHZbKGkgKyAyKSAlIG1dLCBmIC0gaSk7CgogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAoayA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybiB2WzBdIC0gKHRoaXMuY2F0bXVsbFJvbSh2WzBdLCB2WzBdLCB2WzFdLCB2WzFdLCAtZikgLSB2WzBdKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGsgPiAxKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gdlttXSAtICh0aGlzLmNhdG11bGxSb20odlttXSwgdlttXSwgdlttIC0gMV0sIHZbbSAtIDFdLCBmIC0gbSkgLSB2W21dKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY2F0bXVsbFJvbSh2W2kgPyBpIC0gMSA6IDBdLCB2W2ldLCB2W20gPCBpICsgMSA/IG0gOiBpICsgMV0sIHZbbSA8IGkgKyAyID8gbSA6IGkgKyAyXSwgZiAtIGkpOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNMaW5lYXIKCSogQHBhcmFtIHtudW1iZXJ9IHAwCgkqIEBwYXJhbSB7bnVtYmVyfSBwMQoJKiBAcGFyYW0ge251bWJlcn0gdAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwogICAgbGluZWFyOiBmdW5jdGlvbiAocDAsIHAxLCB0KSB7CiAgICAgICAgcmV0dXJuIChwMSAtIHAwKSAqIHQgKyBwMDsKICAgIH0sCgoJLyoqCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjYmVybnN0ZWluCgkqIEBwYXJhbSB7bnVtYmVyfSBuCgkqIEBwYXJhbSB7bnVtYmVyfSBpCgkqIEByZXR1cm4ge251bWJlcn0KCSovCiAgICBiZXJuc3RlaW46IGZ1bmN0aW9uIChuLCBpKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZmFjdG9yaWFsKG4pIC8gdGhpcy5mYWN0b3JpYWwoaSkgLyB0aGlzLmZhY3RvcmlhbChuIC0gaSk7CiAgICB9LAoKCS8qKgoJKiBEZXNjcmlwdGlvbi4KCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjYXRtdWxsUm9tCgkqIEBwYXJhbSB7bnVtYmVyfSBwMAoJKiBAcGFyYW0ge251bWJlcn0gcDEKCSogQHBhcmFtIHtudW1iZXJ9IHAyCgkqIEBwYXJhbSB7bnVtYmVyfSBwMwoJKiBAcGFyYW0ge251bWJlcn0gdAoJKiBAcmV0dXJuIHtudW1iZXJ9IAoJKi8KICAgIGNhdG11bGxSb206IGZ1bmN0aW9uIChwMCwgcDEsIHAyLCBwMywgdCkgewoKICAgICAgICB2YXIgdjAgPSAocDIgLSBwMCkgKiAwLjUsIHYxID0gKHAzIC0gcDEpICogMC41LCB0MiA9IHQgKiB0LCB0MyA9IHQgKiB0MjsKCiAgICAgICAgcmV0dXJuICgyICogcDEgLSAyICogcDIgKyB2MCArIHYxKSAqIHQzICsgKC0zICogcDEgKyAzICogcDIgLSAyICogdjAgLSB2MSkgKiB0MiArIHYwICogdCArIHAxOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlmZmVyZW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqLwogICAgZGlmZmVyZW5jZTogZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gTWF0aC5hYnMoYSAtIGIpOwogICAgfSwKCgkvKioKCSogRmV0Y2ggYSByYW5kb20gZW50cnkgZnJvbSB0aGUgZ2l2ZW4gYXJyYXkuCgkqIFdpbGwgcmV0dXJuIG51bGwgaWYgcmFuZG9tIHNlbGVjdGlvbiBpcyBtaXNzaW5nLCBvciBhcnJheSBoYXMgbm8gZW50cmllcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNnZXRSYW5kb20KCSogQHBhcmFtIHthcnJheX0gb2JqZWN0cyAtIEFuIGFycmF5IG9mIG9iamVjdHMuCgkqIEBwYXJhbSB7bnVtYmVyfSBzdGFydEluZGV4IC0gT3B0aW9uYWwgb2Zmc2V0IG9mZiB0aGUgZnJvbnQgb2YgdGhlIGFycmF5LiBEZWZhdWx0IHZhbHVlIGlzIDAsIG9yIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGFycmF5LgoJKiBAcGFyYW0ge251bWJlcn0gbGVuZ3RoIC0gT3B0aW9uYWwgcmVzdHJpY3Rpb24gb24gdGhlIG51bWJlciBvZiB2YWx1ZXMgeW91IHdhbnQgdG8gcmFuZG9tbHkgc2VsZWN0IGZyb20uCgkqIEByZXR1cm4ge29iamVjdH0gVGhlIHJhbmRvbSBvYmplY3QgdGhhdCB3YXMgc2VsZWN0ZWQuCgkqLwogICAgZ2V0UmFuZG9tOiBmdW5jdGlvbiAob2JqZWN0cywgc3RhcnRJbmRleCwgbGVuZ3RoKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3RhcnRJbmRleCA9PT0gInVuZGVmaW5lZCIpIHsgc3RhcnRJbmRleCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGxlbmd0aCA9PT0gInVuZGVmaW5lZCIpIHsgbGVuZ3RoID0gMDsgfQogICAgICAgIAogICAgICAgIGlmIChvYmplY3RzICE9IG51bGwpIHsKCiAgICAgICAgICAgIHZhciBsID0gbGVuZ3RoOwoKICAgICAgICAgICAgaWYgKChsID09IDApIHx8IChsID4gb2JqZWN0cy5sZW5ndGggLSBzdGFydEluZGV4KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbCA9IG9iamVjdHMubGVuZ3RoIC0gc3RhcnRJbmRleDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGwgPiAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICByZXR1cm4gb2JqZWN0c1tzdGFydEluZGV4ICsgTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogbCldOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKCS8qKgoJKiBSb3VuZCBkb3duIHRvIHRoZSBuZXh0IHdob2xlIG51bWJlci4gRS5nLiBmbG9vcigxLjcpID09IDEsIGFuZCBmbG9vcigtMi43KSA9PSAtMi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNmbG9vcgoJKiBAcGFyYW0ge251bWJlcn0gVmFsdWUJQW55IG51bWJlci4KCSogQHJldHVybiB7bnVtYmVyfSBUaGUgcm91bmRlZCB2YWx1ZSBvZiB0aGF0IG51bWJlci4KCSovCiAgICBmbG9vcjogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIHZhciBuID0gdmFsdWUgfCAwOwoKICAgICAgICByZXR1cm4gKHZhbHVlID4gMCkgPyAobikgOiAoKG4gIT0gdmFsdWUpID8gKG4gLSAxKSA6IChuKSk7CgogICAgfSwKCgkvKioKCSogUm91bmQgdXAgdG8gdGhlIG5leHQgd2hvbGUgbnVtYmVyLiAgRS5nLiBjZWlsKDEuMykgPT0gMiwgYW5kIGNlaWwoLTIuMykgPT0gLTMuCgkqCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjY2VpbAoJKiBAcGFyYW0ge251bWJlcn0gdmFsdWUgLSBBbnkgbnVtYmVyLgoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSByb3VuZGVkIHZhbHVlIG9mIHRoYXQgbnVtYmVyLgoJKi8KICAgIGNlaWw6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZhciBuID0gdmFsdWUgfCAwOwogICAgICAgIHJldHVybiAodmFsdWUgPiAwKSA/ICgobiAhPSB2YWx1ZSkgPyAobiArIDEpIDogKG4pKSA6IChuKTsKICAgIH0sCgoJLyoqCiAgICAqIEdlbmVyYXRlIGEgc2luZSBhbmQgY29zaW5lIHRhYmxlIHNpbXVsdGFuZW91c2x5IGFuZCBleHRyZW1lbHkgcXVpY2tseS4gQmFzZWQgb24gcmVzZWFyY2ggYnkgRnJhbmt5IG9mIHNjZW5lLmF0CiAgICAqIDxwPgogICAgKiBUaGUgcGFyYW1ldGVycyBhbGxvdyB5b3UgdG8gc3BlY2lmeSB0aGUgbGVuZ3RoLCBhbXBsaXR1ZGUgYW5kIGZyZXF1ZW5jeSBvZiB0aGUgd2F2ZS4gT25jZSB5b3UgaGF2ZSBjYWxsZWQgdGhpcyBmdW5jdGlvbgogICAgKiB5b3Ugc2hvdWxkIGdldCB0aGUgcmVzdWx0cyB2aWEgZ2V0U2luVGFibGUoKSBhbmQgZ2V0Q29zVGFibGUoKS4gVGhpcyBnZW5lcmF0b3IgaXMgZmFzdCBlbm91Z2ggdG8gYmUgdXNlZCBpbiByZWFsLXRpbWUuCiAgICAqIDwvcD4KICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaW5Db3NHZW5lcmF0b3IKICAgICogQHBhcmFtIHtudW1iZXJ9IGxlbmd0aCAtIFRoZSBsZW5ndGggb2YgdGhlIHdhdmUKICAgICogQHBhcmFtIHtudW1iZXJ9IHNpbkFtcGxpdHVkZSAtIFRoZSBhbXBsaXR1ZGUgdG8gYXBwbHkgdG8gdGhlIHNpbmUgdGFibGUgKGRlZmF1bHQgMS4wKSBpZiB5b3UgbmVlZCB2YWx1ZXMgYmV0d2VlbiBzYXkgLSsgMTI1IHRoZW4gZ2l2ZSAxMjUgYXMgdGhlIHZhbHVlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb3NBbXBsaXR1ZGUgLSBUaGUgYW1wbGl0dWRlIHRvIGFwcGx5IHRvIHRoZSBjb3NpbmUgdGFibGUgKGRlZmF1bHQgMS4wKSBpZiB5b3UgbmVlZCB2YWx1ZXMgYmV0d2VlbiBzYXkgLSsgMTI1IHRoZW4gZ2l2ZSAxMjUgYXMgdGhlIHZhbHVlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmVxdWVuY3kgIC0gVGhlIGZyZXF1ZW5jeSBvZiB0aGUgc2luZSBhbmQgY29zaW5lIHRhYmxlIGRhdGEKICAgICogQHJldHVybiB7QXJyYXl9IFJldHVybnMgdGhlIHNpbmUgdGFibGUKICAgICovCiAgICBzaW5Db3NHZW5lcmF0b3I6IGZ1bmN0aW9uIChsZW5ndGgsIHNpbkFtcGxpdHVkZSwgY29zQW1wbGl0dWRlLCBmcmVxdWVuY3kpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzaW5BbXBsaXR1ZGUgPT09ICJ1bmRlZmluZWQiKSB7IHNpbkFtcGxpdHVkZSA9IDEuMDsgfQogICAgICAgIGlmICh0eXBlb2YgY29zQW1wbGl0dWRlID09PSAidW5kZWZpbmVkIikgeyBjb3NBbXBsaXR1ZGUgPSAxLjA7IH0KICAgICAgICBpZiAodHlwZW9mIGZyZXF1ZW5jeSA9PT0gInVuZGVmaW5lZCIpIHsgZnJlcXVlbmN5ID0gMS4wOyB9CiAgICAgICAgCiAgICAgICAgdmFyIHNpbiA9IHNpbkFtcGxpdHVkZTsKICAgICAgICB2YXIgY29zID0gY29zQW1wbGl0dWRlOwogICAgICAgIHZhciBmcnEgPSBmcmVxdWVuY3kgKiBNYXRoLlBJIC8gbGVuZ3RoOwogICAgICAgIAogICAgICAgIHZhciBjb3NUYWJsZSA9IFtdOwogICAgICAgIHZhciBzaW5UYWJsZSA9IFtdOwogICAgICAgIAogICAgICAgIGZvciAodmFyIGMgPSAwOyBjIDwgbGVuZ3RoOyBjKyspIHsKCiAgICAgICAgICAgIGNvcyAtPSBzaW4gKiBmcnE7CiAgICAgICAgICAgIHNpbiArPSBjb3MgKiBmcnE7CgogICAgICAgICAgICBjb3NUYWJsZVtjXSA9IGNvczsKICAgICAgICAgICAgc2luVGFibGVbY10gPSBzaW47CgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsgc2luOiBzaW5UYWJsZSwgY29zOiBjb3NUYWJsZSwgbGVuZ3RoOiBsZW5ndGggfTsKCiAgICB9LAoKCS8qKgoJKiBSZW1vdmVzIHRoZSB0b3AgZWxlbWVudCBmcm9tIHRoZSBzdGFjayBhbmQgcmUtaW5zZXJ0cyBpdCBvbnRvIHRoZSBib3R0b20sIHRoZW4gcmV0dXJucyBpdC4KCSogVGhlIG9yaWdpbmFsIHN0YWNrIGlzIG1vZGlmaWVkIGluIHRoZSBwcm9jZXNzLiBUaGlzIGVmZmVjdGl2ZWx5IG1vdmVzIHRoZSBwb3NpdGlvbiBvZiB0aGUgZGF0YSBmcm9tIHRoZSBzdGFydCB0byB0aGUgZW5kIG9mIHRoZSB0YWJsZS4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjc2hpZnQKICAgICogQHBhcmFtIHthcnJheX0gc3RhY2sgLSBUaGUgYXJyYXkgdG8gc2hpZnQuCiAgICAqIEByZXR1cm4ge2FueX0gVGhlIHNoaWZ0ZWQgdmFsdWUuCiAgICAqLwogICAgc2hpZnQ6IGZ1bmN0aW9uIChzdGFjaykgewoKICAgIAl2YXIgcyA9IHN0YWNrLnNoaWZ0KCk7CiAgICAJc3RhY2sucHVzaChzKTsKCiAgICAJcmV0dXJuIHM7CgogICAgfSwKCgkvKioKICAgICogU2h1ZmZsZXMgdGhlIGRhdGEgaW4gdGhlIGdpdmVuIGFycmF5IGludG8gYSBuZXcgb3JkZXIKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNzaHVmZmxlQXJyYXkKICAgICogQHBhcmFtIHthcnJheX0gYXJyYXkgLSBUaGUgYXJyYXkgdG8gc2h1ZmZsZQogICAgKiBAcmV0dXJuIHthcnJheX0gVGhlIGFycmF5CiAgICAqLwogICAgc2h1ZmZsZUFycmF5OiBmdW5jdGlvbiAoYXJyYXkpIHsKCiAgICAgICAgZm9yICh2YXIgaSA9IGFycmF5Lmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKCiAgICAgICAgICAgIHZhciBqID0gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogKGkgKyAxKSk7CiAgICAgICAgICAgIHZhciB0ZW1wID0gYXJyYXlbaV07CiAgICAgICAgICAgIGFycmF5W2ldID0gYXJyYXlbal07CiAgICAgICAgICAgIGFycmF5W2pdID0gdGVtcDsKICAgICAgICB9CgogICAgICAgIHJldHVybiBhcnJheTsKCiAgICB9LAoKCS8qKgogICAgKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSB0d28gZ2l2ZW4gc2V0IG9mIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuTWF0aCNkaXN0YW5jZQogICAgKiBAcGFyYW0ge251bWJlcn0geDEKICAgICogQHBhcmFtIHtudW1iZXJ9IHkxCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MgogICAgKiBAcGFyYW0ge251bWJlcn0geTIKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KICAgICoqLwogICAgZGlzdGFuY2U6IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewoKICAgICAgICB2YXIgZHggPSB4MSAtIHgyOwogICAgICAgIHZhciBkeSA9IHkxIC0geTI7CgogICAgICAgIHJldHVybiBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIHJvdW5kZWQgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdHdvIGdpdmVuIHNldCBvZiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLk1hdGgjZGlzdGFuY2VSb3VuZGVkCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4MQogICAgKiBAcGFyYW0ge251bWJlcn0geTEKICAgICogQHBhcmFtIHtudW1iZXJ9IHgyCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5MgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoaXMgUG9pbnQgb2JqZWN0IGFuZCB0aGUgZGVzdGluYXRpb24gUG9pbnQgb2JqZWN0LgogICAgKiovCiAgICBkaXN0YW5jZVJvdW5kZWQ6IGZ1bmN0aW9uICh4MSwgeTEsIHgyLCB5MikgewoKICAgIAlyZXR1cm4gTWF0aC5yb3VuZChQaGFzZXIuTWF0aC5kaXN0YW5jZSh4MSwgeTEsIHgyLCB5MikpOwoKICAgIH0sCgoJLyoqCgkqIEZvcmNlIGEgdmFsdWUgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHR3byB2YWx1ZXMuCgkqIENsYW1wIHZhbHVlIHRvIHJhbmdlIDxhLCBiPgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjbGFtcAoJKiBAcGFyYW0ge251bWJlcn0geAoJKiBAcGFyYW0ge251bWJlcn0gYQoJKiBAcGFyYW0ge251bWJlcn0gYgogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJY2xhbXA6IGZ1bmN0aW9uICggeCwgYSwgYiApIHsKCgkJcmV0dXJuICggeCA8IGEgKSA/IGEgOiAoICggeCA+IGIgKSA/IGIgOiB4ICk7CgoJfSwKIAoJLyoqCgkqIENsYW1wIHZhbHVlIHRvIHJhbmdlIDxhLCBpbmYpLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNjbGFtcEJvdHRvbQoJKiBAcGFyYW0ge251bWJlcn0geAoJKiBAcGFyYW0ge251bWJlcn0gYQogICAgKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJY2xhbXBCb3R0b206IGZ1bmN0aW9uICggeCwgYSApIHsKCgkJcmV0dXJuIHggPCBhID8gYSA6IHg7CgoJfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHR3byB2YWx1ZXMgYXJlIHdpdGhpbiB0aGUgZ2l2ZW4gdG9sZXJhbmNlIG9mIGVhY2ggb3RoZXIuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5NYXRoI3dpdGhpbgogICAgKiBAcGFyYW0ge251bWJlcn0gYSAtIFRoZSBmaXJzdCBudW1iZXIgdG8gY2hlY2sKICAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBUaGUgc2Vjb25kIG51bWJlciB0byBjaGVjawogICAgKiBAcGFyYW0ge251bWJlcn0gdG9sZXJhbmNlIC0gVGhlIHRvbGVyYW5jZS4gQW55dGhpbmcgZXF1YWwgdG8gb3IgbGVzcyB0aGFuIHRoaXMgaXMgY29uc2lkZXJlZCB3aXRoaW4gdGhlIHJhbmdlLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGEgaXMgPD0gdG9sZXJhbmNlIG9mIGIuCiAgICAqLwogICAgd2l0aGluOiBmdW5jdGlvbiAoIGEsIGIsIHRvbGVyYW5jZSApIHsKCiAgICAgICAgcmV0dXJuIChNYXRoLmFicyhhIC0gYikgPD0gdG9sZXJhbmNlKTsKCiAgICB9LAogCgkvKioKCSogTGluZWFyIG1hcHBpbmcgZnJvbSByYW5nZSA8YTEsIGEyPiB0byByYW5nZSA8YjEsIGIyPgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNtYXBMaW5lYXIKCSogQHBhcmFtIHtudW1iZXJ9IHgKCSogQHBhcmFtIHtudW1iZXJ9IGExCgkqIEBwYXJhbSB7bnVtYmVyfSBhMQoJKiBAcGFyYW0ge251bWJlcn0gYTIKCSogQHBhcmFtIHtudW1iZXJ9IGIxCgkqIEBwYXJhbSB7bnVtYmVyfSBiMgoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJbWFwTGluZWFyOiBmdW5jdGlvbiAoIHgsIGExLCBhMiwgYjEsIGIyICkgewoKCQlyZXR1cm4gYjEgKyAoIHggLSBhMSApICogKCBiMiAtIGIxICkgLyAoIGEyIC0gYTEgKTsKCgl9LAoKCS8qKgoJKiBTbW9vdGhzdGVwIGZ1bmN0aW9uIGFzIGRldGFpbGVkIGF0IGh0dHA6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvU21vb3Roc3RlcAoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNzbW9vdGhzdGVwCgkqIEBwYXJhbSB7bnVtYmVyfSB4CgkqIEBwYXJhbSB7bnVtYmVyfSBtaW4KCSogQHBhcmFtIHtudW1iZXJ9IG1heAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJc21vb3Roc3RlcDogZnVuY3Rpb24gKCB4LCBtaW4sIG1heCApIHsKCgkJaWYgKCB4IDw9IG1pbiApIHJldHVybiAwOwoJCWlmICggeCA+PSBtYXggKSByZXR1cm4gMTsKCgkJeCA9ICggeCAtIG1pbiApLyggbWF4IC0gbWluICk7CgoJCXJldHVybiB4KngqKDMgLSAyKngpOwoKCX0sCgoJLyoqCiAgICAqIFNtb290aGVyc3RlcCBmdW5jdGlvbiBhcyBkZXRhaWxlZCBhdCBodHRwOi8vZW4ud2lraXBlZGlhLm9yZy93aWtpL1Ntb290aHN0ZXAKCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjc21vb3RoZXJzdGVwCgkqIEBwYXJhbSB7bnVtYmVyfSB4CgkqIEBwYXJhbSB7bnVtYmVyfSBtaW4KCSogQHBhcmFtIHtudW1iZXJ9IG1heAoJKiBAcmV0dXJuIHtudW1iZXJ9CgkqLwoJc21vb3RoZXJzdGVwOiBmdW5jdGlvbiAoIHgsIG1pbiwgbWF4ICkgewoKCQlpZiAoIHggPD0gbWluICkgcmV0dXJuIDA7CgkJaWYgKCB4ID49IG1heCApIHJldHVybiAxOwoKCQl4ID0gKCB4IC0gbWluICkvKCBtYXggLSBtaW4gKTsKCgkJcmV0dXJuIHgqeCp4Kih4Kih4KjYgLSAxNSkgKyAxMCk7CgoJfSwKCgkvKioKCSogQSB2YWx1ZSByZXByZXNlbnRpbmcgdGhlIHNpZ24gb2YgdGhlIHZhbHVlLgoJKiAtMSBmb3IgbmVnYXRpdmUsICsxIGZvciBwb3NpdGl2ZSwgMCBpZiB2YWx1ZSBpcyAwCgkqIAoJKiBAbWV0aG9kIFBoYXNlci5NYXRoI3NpZ24KCSogQHBhcmFtIHtudW1iZXJ9IHgKCSogQHJldHVybiB7bnVtYmVyfQoJKi8KCXNpZ246IGZ1bmN0aW9uICggeCApIHsKCgkJcmV0dXJuICggeCA8IDAgKSA/IC0xIDogKCAoIHggPiAwICkgPyAxIDogMCApOwoKCX0sCgoJLyoqCgkqIENvbnZlcnQgZGVncmVlcyB0byByYWRpYW5zLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTWF0aCNkZWdUb1JhZAoJKiBAcmV0dXJuIHtmdW5jdGlvbn0KCSovCglkZWdUb1JhZDogZnVuY3Rpb24oKSB7CgoJCXZhciBkZWdyZWVUb1JhZGlhbnNGYWN0b3IgPSBNYXRoLlBJIC8gMTgwOwoKCQlyZXR1cm4gZnVuY3Rpb24gKCBkZWdyZWVzICkgewoKCQkJcmV0dXJuIGRlZ3JlZXMgKiBkZWdyZWVUb1JhZGlhbnNGYWN0b3I7CgoJCX07CgoJfSgpLAoKCS8qKgoJKiBDb252ZXJ0IGRlZ3JlZXMgdG8gcmFkaWFucy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLk1hdGgjcmFkVG9EZWcKCSogQHJldHVybiB7ZnVuY3Rpb259CgkqLwoJcmFkVG9EZWc6IGZ1bmN0aW9uKCkgewoKCQl2YXIgcmFkaWFuVG9EZWdyZWVzRmFjdG9yID0gMTgwIC8gTWF0aC5QSTsKCgkJcmV0dXJuIGZ1bmN0aW9uICggcmFkaWFucyApIHsKCgkJCXJldHVybiByYWRpYW5zICogcmFkaWFuVG9EZWdyZWVzRmFjdG9yOwoKCQl9OwoKCX0oKQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgogKiBKYXZhc2NyaXB0IFF1YWRUcmVlIAogKiBAdmVyc2lvbiAxLjAKICogQGF1dGhvciBUaW1vIEhhdXNtYW5uCiAqCiAqIEB2ZXJzaW9uIDEuMiwgU2VwdGVtYmVyIDR0aCAyMDEzCiAqIEBhdXRob3IgUmljaGFyZCBEYXZleQogKiBUaGUgb3JpZ2luYWwgY29kZSB3YXMgYSBjb252ZXJzaW9uIG9mIHRoZSBKYXZhIGNvZGUgcG9zdGVkIHRvIEdhbWVEZXZUdXRzLiBIb3dldmVyIEkndmUgdHdlYWtlZAogKiBpdCBtYXNzaXZlbHkgdG8gYWRkIG5vZGUgaW5kZXhpbmcsIHJlbW92ZWQgbG90cyBvZiB0ZW1wLiB2YXIgY3JlYXRpb24gYW5kIHNpZ25pZmljYW50bHkKICogaW5jcmVhc2VkIHBlcmZvcm1hbmNlIGFzIGEgcmVzdWx0LgogKgogKiBPcmlnaW5hbCB2ZXJzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS90aW1vaGF1c21hbm4vcXVhZHRyZWUtanMvCiAqLwogCi8qKgoqIEBjb3B5cmlnaHQgwqkgMjAxMiBUaW1vIEhhdXNtYW5uCioKKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcKKiBhIGNvcHkgb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUKKiAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCiogd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMgdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLAoqIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0bwoqIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0bwoqIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKKgoqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlCiogaW5jbHVkZWQgaW4gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCioKKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwKKiBFWFBSRVNTIE9SIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YKKiBNRVJDSEFOVEFCSUxJVFksIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORAoqIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUKKiBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OCiogT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OCiogV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgovKioKICogUXVhZFRyZWUgQ29uc3RydWN0b3IKICogCiAqIEBjbGFzcyBQaGFzZXIuUXVhZFRyZWUKICogQGNsYXNzZGVzYyBBIFF1YWRUcmVlIGltcGxlbWVudGF0aW9uLiBUaGUgb3JpZ2luYWwgY29kZSB3YXMgYSBjb252ZXJzaW9uIG9mIHRoZSBKYXZhIGNvZGUgcG9zdGVkIHRvIEdhbWVEZXZUdXRzLiBIb3dldmVyIEkndmUgdHdlYWtlZAogKiBpdCBtYXNzaXZlbHkgdG8gYWRkIG5vZGUgaW5kZXhpbmcsIHJlbW92ZWQgbG90cyBvZiB0ZW1wLiB2YXIgY3JlYXRpb24gYW5kIHNpZ25pZmljYW50bHkgaW5jcmVhc2VkIHBlcmZvcm1hbmNlIGFzIGEgcmVzdWx0LiBPcmlnaW5hbCB2ZXJzaW9uIGF0IGh0dHBzOi8vZ2l0aHViLmNvbS90aW1vaGF1c21hbm4vcXVhZHRyZWUtanMvCiAqIEBjb25zdHJ1Y3RvcgogKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBwaHlzaWNzTWFuYWdlciAtIERlc2NyaXB0aW9uLgogKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB4IC0gRGVzY3JpcHRpb24uCiAqIEBwYXJhbSB7RGVzY3JpcHRpb259IHkgLSBEZXNjcmlwdGlvbi4KICogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHlvdXIgZ2FtZSBpbiBnYW1lIHBpeGVscy4KICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgeW91ciBnYW1lIGluIGdhbWUgcGl4ZWxzLgogKiBAcGFyYW0ge251bWJlcn0gbWF4T2JqZWN0cyAtIERlc2NyaXB0aW9uLgogKiBAcGFyYW0ge251bWJlcn0gbWF4TGV2ZWxzIC0gRGVzY3JpcHRpb24uCiAqIEBwYXJhbSB7bnVtYmVyfSBsZXZlbCAtIERlc2NyaXB0aW9uLgogKi8KUGhhc2VyLlF1YWRUcmVlID0gZnVuY3Rpb24gKHBoeXNpY3NNYW5hZ2VyLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBtYXhPYmplY3RzLCBtYXhMZXZlbHMsIGxldmVsKSB7CgkJCgl0aGlzLnBoeXNpY3NNYW5hZ2VyID0gcGh5c2ljc01hbmFnZXI7Cgl0aGlzLklEID0gcGh5c2ljc01hbmFnZXIucXVhZFRyZWVJRDsKCXBoeXNpY3NNYW5hZ2VyLnF1YWRUcmVlSUQrKzsKCgl0aGlzLm1heE9iamVjdHMgPSBtYXhPYmplY3RzIHx8IDEwOwoJdGhpcy5tYXhMZXZlbHMgPSBtYXhMZXZlbHMgfHwgNDsKCXRoaXMubGV2ZWwgPSBsZXZlbCB8fCAwOwoKCXRoaXMuYm91bmRzID0geyAKCQl4OiBNYXRoLnJvdW5kKHgpLCAKCQl5OiBNYXRoLnJvdW5kKHkpLCAKCQl3aWR0aDogd2lkdGgsIAoJCWhlaWdodDogaGVpZ2h0LCAKCQlzdWJXaWR0aDogTWF0aC5mbG9vcih3aWR0aCAvIDIpLAoJCXN1YkhlaWdodDogTWF0aC5mbG9vcihoZWlnaHQgLyAyKSwKCQlyaWdodDogTWF0aC5yb3VuZCh4KSArIE1hdGguZmxvb3Iod2lkdGggLyAyKSwKCQlib3R0b206IE1hdGgucm91bmQoeSkgKyBNYXRoLmZsb29yKGhlaWdodCAvIDIpCgl9OwoJCgl0aGlzLm9iamVjdHMgPSBbXTsKCXRoaXMubm9kZXMgPSBbXTsKCn07CgpQaGFzZXIuUXVhZFRyZWUucHJvdG90eXBlID0gewoKCS8qCgkqIFNwbGl0IHRoZSBub2RlIGludG8gNCBzdWJub2RlcwoJKiAKCSogQG1ldGhvZCBQaGFzZXIuUXVhZFRyZWUjc3BsaXQKCSovCglzcGxpdDogZnVuY3Rpb24oKSB7CgoJCXRoaXMubGV2ZWwrKzsKCQkKCSAJLy8JdG9wIHJpZ2h0IG5vZGUKCQl0aGlzLm5vZGVzWzBdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLnBoeXNpY3NNYW5hZ2VyLCB0aGlzLmJvdW5kcy5yaWdodCwgdGhpcy5ib3VuZHMueSwgdGhpcy5ib3VuZHMuc3ViV2lkdGgsIHRoaXMuYm91bmRzLnN1YkhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscywgdGhpcy5sZXZlbCk7CgkJCgkJLy8JdG9wIGxlZnQgbm9kZQoJCXRoaXMubm9kZXNbMV0gPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMucGh5c2ljc01hbmFnZXIsIHRoaXMuYm91bmRzLngsIHRoaXMuYm91bmRzLnksIHRoaXMuYm91bmRzLnN1YldpZHRoLCB0aGlzLmJvdW5kcy5zdWJIZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMsIHRoaXMubGV2ZWwpOwoJCQoJCS8vCWJvdHRvbSBsZWZ0IG5vZGUKCQl0aGlzLm5vZGVzWzJdID0gbmV3IFBoYXNlci5RdWFkVHJlZSh0aGlzLnBoeXNpY3NNYW5hZ2VyLCB0aGlzLmJvdW5kcy54LCB0aGlzLmJvdW5kcy5ib3R0b20sIHRoaXMuYm91bmRzLnN1YldpZHRoLCB0aGlzLmJvdW5kcy5zdWJIZWlnaHQsIHRoaXMubWF4T2JqZWN0cywgdGhpcy5tYXhMZXZlbHMsIHRoaXMubGV2ZWwpOwoJCQoJCS8vCWJvdHRvbSByaWdodCBub2RlCgkJdGhpcy5ub2Rlc1szXSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcy5waHlzaWNzTWFuYWdlciwgdGhpcy5ib3VuZHMucmlnaHQsIHRoaXMuYm91bmRzLmJvdHRvbSwgdGhpcy5ib3VuZHMuc3ViV2lkdGgsIHRoaXMuYm91bmRzLnN1YkhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscywgdGhpcy5sZXZlbCk7CgoJfSwKCgkvKgoJICogSW5zZXJ0IHRoZSBvYmplY3QgaW50byB0aGUgbm9kZS4gSWYgdGhlIG5vZGUKCSAqIGV4Y2VlZHMgdGhlIGNhcGFjaXR5LCBpdCB3aWxsIHNwbGl0IGFuZCBhZGQgYWxsCgkgKiBvYmplY3RzIHRvIHRoZWlyIGNvcnJlc3BvbmRpbmcgc3Vibm9kZXMuCgkgKiAKCSAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI2luc2VydAoJICogQHBhcmFtIHtvYmplY3R9IGJvZHkgLSBEZXNjcmlwdGlvbi4KCSAqLwoJaW5zZXJ0OiBmdW5jdGlvbiAoYm9keSkgewoJCQoJCXZhciBpID0gMDsKCQl2YXIgaW5kZXg7CgkgCQoJIAkvLwlpZiB3ZSBoYXZlIHN1Ym5vZGVzIC4uLgoJCWlmICh0aGlzLm5vZGVzWzBdICE9IG51bGwpCgkJewoJCQlpbmRleCA9IHRoaXMuZ2V0SW5kZXgoYm9keSk7CgkgCgkJICAJaWYgKGluZGV4ICE9PSAtMSkKCQkgIAl7CgkJCQl0aGlzLm5vZGVzW2luZGV4XS5pbnNlcnQoYm9keSk7CgkJCSAJcmV0dXJuOwoJCQl9CgkJfQoJIAoJIAl0aGlzLm9iamVjdHMucHVzaChib2R5KTsKCQkKCQlpZiAodGhpcy5vYmplY3RzLmxlbmd0aCA+IHRoaXMubWF4T2JqZWN0cyAmJiB0aGlzLmxldmVsIDwgdGhpcy5tYXhMZXZlbHMpCgkJewoJCQkvLwlTcGxpdCBpZiB3ZSBkb24ndCBhbHJlYWR5IGhhdmUgc3Vibm9kZXMKCQkJaWYgKHRoaXMubm9kZXNbMF0gPT0gbnVsbCkKCQkJewoJCQkJdGhpcy5zcGxpdCgpOwoJCQl9CgkJCQoJCQkvLwlBZGQgb2JqZWN0cyB0byBzdWJub2RlcwoJCQl3aGlsZSAoaSA8IHRoaXMub2JqZWN0cy5sZW5ndGgpCgkJCXsKCQkJCWluZGV4ID0gdGhpcy5nZXRJbmRleCh0aGlzLm9iamVjdHNbaV0pOwoJCQkJCgkJCQlpZiAoaW5kZXggIT09IC0xKQoJCQkJewoJCQkJCS8vCXRoaXMgaXMgZXhwZW5zaXZlIC0gc2VlIHdoYXQgd2UgY2FuIGRvIGFib3V0IGl0CgkJCQkJdGhpcy5ub2Rlc1tpbmRleF0uaW5zZXJ0KHRoaXMub2JqZWN0cy5zcGxpY2UoaSwgMSlbMF0pOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWkrKzsKCQkJIAl9CgkJIAl9CgkJfQoJIH0sCgkgCgkvKgoJICogRGV0ZXJtaW5lIHdoaWNoIG5vZGUgdGhlIG9iamVjdCBiZWxvbmdzIHRvLgoJICogCgkgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNnZXRJbmRleAoJICogQHBhcmFtIHtvYmplY3R9IHJlY3QJLSBEZXNjcmlwdGlvbi4KCSAqIEByZXR1cm4ge251bWJlcn0gaW5kZXggLQlJbmRleCBvZiB0aGUgc3Vibm9kZSAoMC0zKSwgb3IgLTEgaWYgcmVjdCBjYW5ub3QgY29tcGxldGVseSBmaXQgd2l0aGluIGEgc3Vibm9kZSBhbmQgaXMgcGFydCBvZiB0aGUgcGFyZW50IG5vZGUuCgkgKi8KCWdldEluZGV4OiBmdW5jdGlvbiAocmVjdCkgewoJCQoJCS8vCWRlZmF1bHQgaXMgdGhhdCByZWN0IGRvZXNuJ3QgZml0LCBpLmUuIGl0IHN0cmFkZGxlcyB0aGUgaW50ZXJuYWwgcXVhZHJhbnRzCgkJdmFyIGluZGV4ID0gLTE7CgoJCWlmIChyZWN0LnggPCB0aGlzLmJvdW5kcy5yaWdodCAmJiByZWN0LnJpZ2h0IDwgdGhpcy5ib3VuZHMucmlnaHQpCgkJewoJCQlpZiAoKHJlY3QueSA8IHRoaXMuYm91bmRzLmJvdHRvbSAmJiByZWN0LmJvdHRvbSA8IHRoaXMuYm91bmRzLmJvdHRvbSkpCgkJCXsKCQkJCS8vCXJlY3QgZml0cyB3aXRoaW4gdGhlIHRvcC1sZWZ0IHF1YWRyYW50IG9mIHRoaXMgcXVhZHRyZWUKCQkJCWluZGV4ID0gMTsKCQkJfQoJCQllbHNlIGlmICgocmVjdC55ID4gdGhpcy5ib3VuZHMuYm90dG9tKSkKCQkJewoJCQkJLy8JcmVjdCBmaXRzIHdpdGhpbiB0aGUgYm90dG9tLWxlZnQgcXVhZHJhbnQgb2YgdGhpcyBxdWFkdHJlZQoJCQkJaW5kZXggPSAyOwoJCQl9CgkJfQoJCWVsc2UgaWYgKHJlY3QueCA+IHRoaXMuYm91bmRzLnJpZ2h0KQoJCXsKCQkJLy8JcmVjdCBjYW4gY29tcGxldGVseSBmaXQgd2l0aGluIHRoZSByaWdodCBxdWFkcmFudHMKCQkJaWYgKChyZWN0LnkgPCB0aGlzLmJvdW5kcy5ib3R0b20gJiYgcmVjdC5ib3R0b20gPCB0aGlzLmJvdW5kcy5ib3R0b20pKQoJCQl7CgkJCQkvLwlyZWN0IGZpdHMgd2l0aGluIHRoZSB0b3AtcmlnaHQgcXVhZHJhbnQgb2YgdGhpcyBxdWFkdHJlZQoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWVsc2UgaWYgKChyZWN0LnkgPiB0aGlzLmJvdW5kcy5ib3R0b20pKQoJCQl7CgkJCQkvLwlyZWN0IGZpdHMgd2l0aGluIHRoZSBib3R0b20tcmlnaHQgcXVhZHJhbnQgb2YgdGhpcyBxdWFkdHJlZQoJCQkJaW5kZXggPSAzOwoJCQl9CgkJfQoJIAoJCXJldHVybiBpbmRleDsKCgl9LAoKCSAvKgoJICogUmV0dXJuIGFsbCBvYmplY3RzIHRoYXQgY291bGQgY29sbGlkZSB3aXRoIHRoZSBnaXZlbiBvYmplY3QuCgkgKiAKCSAqIEBtZXRob2QgUGhhc2VyLlF1YWRUcmVlI3JldHJpZXZlCgkgKiBAcGFyYW0ge29iamVjdH0gcmVjdAktIERlc2NyaXB0aW9uLgoJICogQFJldHVybiB7YXJyYXl9IC0gQXJyYXkgd2l0aCBhbGwgZGV0ZWN0ZWQgb2JqZWN0cy4KCSAqLwoJcmV0cmlldmU6IGZ1bmN0aW9uIChzcHJpdGUpIHsKCSAJCgkJdmFyIHJldHVybk9iamVjdHMgPSB0aGlzLm9iamVjdHM7CgoJCXNwcml0ZS5ib2R5LnF1YWRUcmVlSW5kZXggPSB0aGlzLmdldEluZGV4KHNwcml0ZS5ib2R5KTsKCgkJLy8JVGVtcCBzdG9yZSBmb3IgdGhlIG5vZGUgSURzIHRoaXMgc3ByaXRlIGlzIGluLCB3ZSBjYW4gdXNlIHRoaXMgZm9yIGZhc3QgZWxpbWluYXRpb24gbGF0ZXIKCQlzcHJpdGUuYm9keS5xdWFkVHJlZUlEcy5wdXNoKHRoaXMuSUQpOwoKCQlpZiAodGhpcy5ub2Rlc1swXSkKCQl7CgkJCS8vCWlmIHJlY3QgZml0cyBpbnRvIGEgc3Vibm9kZSAuLgoJCQlpZiAoc3ByaXRlLmJvZHkucXVhZFRyZWVJbmRleCAhPT0gLTEpCgkJCXsKCQkJCXJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzW3Nwcml0ZS5ib2R5LnF1YWRUcmVlSW5kZXhdLnJldHJpZXZlKHNwcml0ZSkpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8JaWYgcmVjdCBkb2VzIG5vdCBmaXQgaW50byBhIHN1Ym5vZGUsIGNoZWNrIGl0IGFnYWluc3QgYWxsIHN1Ym5vZGVzICh1bnJvbGxlZCBmb3Igc3BlZWQpCgkJCQlyZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1swXS5yZXRyaWV2ZShzcHJpdGUpKTsKCQkJCXJldHVybk9iamVjdHMgPSByZXR1cm5PYmplY3RzLmNvbmNhdCh0aGlzLm5vZGVzWzFdLnJldHJpZXZlKHNwcml0ZSkpOwoJCQkJcmV0dXJuT2JqZWN0cyA9IHJldHVybk9iamVjdHMuY29uY2F0KHRoaXMubm9kZXNbMl0ucmV0cmlldmUoc3ByaXRlKSk7CgkJCQlyZXR1cm5PYmplY3RzID0gcmV0dXJuT2JqZWN0cy5jb25jYXQodGhpcy5ub2Rlc1szXS5yZXRyaWV2ZShzcHJpdGUpKTsKCQkJfQoJCX0KCSAKCQlyZXR1cm4gcmV0dXJuT2JqZWN0czsKCgl9LAoKCS8qCgkgKiBDbGVhciB0aGUgcXVhZHRyZWUuCgkgKiBAbWV0aG9kIFBoYXNlci5RdWFkVHJlZSNjbGVhcgoJICovCgljbGVhcjogZnVuY3Rpb24gKCkgewoJCQoJCXRoaXMub2JqZWN0cyA9IFtdOwoJIAoJCWZvciAodmFyIGkgPSAwLCBsZW4gPSB0aGlzLm5vZGVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQoJCXsKCQkJLy8gaWYgKHR5cGVvZiB0aGlzLm5vZGVzW2ldICE9PSAndW5kZWZpbmVkJykKCQkJaWYgKHRoaXMubm9kZXNbaV0pCgkJCXsKCQkJCXRoaXMubm9kZXNbaV0uY2xlYXIoKTsKCQkJCWRlbGV0ZSB0aGlzLm5vZGVzW2ldOwoJCSAgCX0KCQl9Cgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBDaXJjbGUgb2JqZWN0IHdpdGggdGhlIGNlbnRlciBjb29yZGluYXRlIHNwZWNpZmllZCBieSB0aGUgeCBhbmQgeSBwYXJhbWV0ZXJzIGFuZCB0aGUgZGlhbWV0ZXIgc3BlY2lmaWVkIGJ5IHRoZSBkaWFtZXRlciBwYXJhbWV0ZXIuIElmIHlvdSBjYWxsIHRoaXMgZnVuY3Rpb24gd2l0aG91dCBwYXJhbWV0ZXJzLCBhIGNpcmNsZSB3aXRoIHgsIHksIGRpYW1ldGVyIGFuZCByYWRpdXMgcHJvcGVydGllcyBzZXQgdG8gMCBpcyBjcmVhdGVkLgoqIEBjbGFzcyBDaXJjbGUKKiBAY2xhc3NkZXNjIFBoYXNlciAtIENpcmNsZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7bnVtYmVyfSBbeF0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiogQHBhcmFtIHtudW1iZXJ9IFt5XSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KKiBAcGFyYW0ge251bWJlcn0gW2RpYW1ldGVyXSBUaGUgZGlhbWV0ZXIgb2YgdGhlIGNpcmNsZS4KKiBAcmV0dXJuIHtQaGFzZXIuQ2lyY2xlfSBUaGlzIGNpcmNsZSBvYmplY3QKKiovClBoYXNlci5DaXJjbGUgPSBmdW5jdGlvbiAoeCwgeSwgZGlhbWV0ZXIpIHsKCiAgICB4ID0geCB8fCAwOwogICAgeSA9IHkgfHwgMDsKICAgIGRpYW1ldGVyID0gZGlhbWV0ZXIgfHwgMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KICAgICoqLwogICAgdGhpcy54ID0geDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZS4KICAgICoqLwogICAgdGhpcy55ID0geTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9kaWFtZXRlciAtIFRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlLgogICAgKiBAcHJpdmF0ZQogICAgKiovCiAgICB0aGlzLl9kaWFtZXRlciA9IGRpYW1ldGVyOwoKICAgIGlmIChkaWFtZXRlciA+IDApCiAgICB7CiAgICAJLyoqCiAgICAJKiBAcHJvcGVydHkge251bWJlcn0gX3JhZGl1cyAtIFRoZSByYWRpdXMgb2YgdGhlIGNpcmNsZS4KICAgIAkqIEBwcml2YXRlCiAgICAgICAgKiovCiAgICAgICAgdGhpcy5fcmFkaXVzID0gZGlhbWV0ZXIgKiAwLjU7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgIH0KCn07CgpQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogVGhlIGNpcmN1bWZlcmVuY2Ugb2YgdGhlIGNpcmNsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NpcmN1bWZlcmVuY2UKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKiovCiAgICBjaXJjdW1mZXJlbmNlOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIDIgKiAoTWF0aC5QSSAqIHRoaXMuX3JhZGl1cyk7CiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBtZW1iZXJzIG9mIENpcmNsZSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBjaXJjbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkaWFtZXRlciAtIFRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlIGluIHBpeGVscy4KICAgICogQHJldHVybiB7Q2lyY2xlfSBUaGlzIGNpcmNsZSBvYmplY3QuCiAgICAqKi8KICAgIHNldFRvOiBmdW5jdGlvbiAoeCwgeSwgZGlhbWV0ZXIpIHsKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSBkaWFtZXRlcjsKICAgICAgICB0aGlzLl9yYWRpdXMgPSBkaWFtZXRlciAqIDAuNTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSBhbmQgZGlhbWV0ZXIgcHJvcGVydGllcyBmcm9tIGFueSBnaXZlbiBvYmplY3QgdG8gdGhpcyBDaXJjbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjb3B5RnJvbQogICAgKiBAcGFyYW0ge2FueX0gc291cmNlIC0gVGhlIG9iamVjdCB0byBjb3B5IGZyb20uCiAgICAqIEByZXR1cm4ge0NpcmNsZX0gVGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKiovCiAgICBjb3B5RnJvbTogZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHNvdXJjZS54LCBzb3VyY2UueSwgc291cmNlLmRpYW1ldGVyKTsKICAgIH0sCgogICAgLyoqCiAgICAqIENvcGllcyB0aGUgeCwgeSBhbmQgZGlhbWV0ZXIgcHJvcGVydGllcyBmcm9tIHRoaXMgQ2lyY2xlIHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjb3B5VG8KICAgICogQHBhcmFtIHthbnl9IGRlc3QgLSBUaGUgb2JqZWN0IHRvIGNvcHkgdG8uCiAgICAqIEByZXR1cm4ge09iamVjdH0gVGhpcyBkZXN0IG9iamVjdC4KICAgICoqLwogICAgY29weVRvOiBmdW5jdGlvbihkZXN0KSB7CiAgICAgICAgZGVzdFt4XSA9IHRoaXMueDsKICAgICAgICBkZXN0W3ldID0gdGhpcy55OwogICAgICAgIGRlc3RbZGlhbWV0ZXJdID0gdGhpcy5fZGlhbWV0ZXI7CiAgICAgICAgcmV0dXJuIGRlc3Q7CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBkaXN0YW5jZSBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIENpcmNsZSBvYmplY3QgdG8gdGhlIGdpdmVuIG9iamVjdAogICAgKiAoY2FuIGJlIENpcmNsZSwgUG9pbnQgb3IgYW55dGhpbmcgd2l0aCB4L3kgcHJvcGVydGllcykKICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2Rpc3RhbmNlCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkZXN0IC0gVGhlIHRhcmdldCBvYmplY3QuIE11c3QgaGF2ZSB2aXNpYmxlIHggYW5kIHkgcHJvcGVydGllcyB0aGF0IHJlcHJlc2VudCB0aGUgY2VudGVyIG9mIHRoZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3JvdW5kXSAtIFJvdW5kIHRoZSBkaXN0YW5jZSB0byB0aGUgbmVhcmVzdCBpbnRlZ2VyIChkZWZhdWx0IGZhbHNlKS4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KICAgICovCiAgICBkaXN0YW5jZTogZnVuY3Rpb24gKGRlc3QsIHJvdW5kKSB7CgogICAgICAgIGlmICh0eXBlb2Ygcm91bmQgPT09ICJ1bmRlZmluZWQiKSB7IHJvdW5kID0gZmFsc2UgfQoKICAgICAgICBpZiAocm91bmQpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2VSb3VuZCh0aGlzLngsIHRoaXMueSwgZGVzdC54LCBkZXN0LnkpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLk1hdGguZGlzdGFuY2UodGhpcy54LCB0aGlzLnksIGRlc3QueCwgZGVzdC55KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIG5ldyBDaXJjbGUgb2JqZWN0IHdpdGggdGhlIHNhbWUgdmFsdWVzIGZvciB0aGUgeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBhcyB0aGlzIENpcmNsZSBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNjbG9uZQogICAgKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IG91dCAtIE9wdGlvbmFsIENpcmNsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgQ2lyY2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQ2lyY2xlfSBUaGUgY2xvbmVkIENpcmNsZSBvYmplY3QuCiAgICAqLwogICAgY2xvbmU6IGZ1bmN0aW9uKG91dCkgewoKICAgICAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5DaXJjbGUoKTsgfQoKICAgICAgICByZXR1cm4gb3V0LnNldFRvKGEueCwgYS55LCBhLmRpYW1ldGVyKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBDaXJjbGUgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUjY29udGFpbnMKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCB2YWx1ZSBvZiB0aGUgY29vcmRpbmF0ZSB0byB0ZXN0LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhpcyBjaXJjbGUsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjb250YWluczogZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLkNpcmNsZS5jb250YWlucyh0aGlzLCB4LCB5KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBQb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgY29vcmRpbmF0ZXMgb2YgYSBwb2ludCBvbiB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgQ2lyY2xlIGJhc2VkIG9uIHRoZSBnaXZlbiBhbmdsZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI2NpcmN1bWZlcmVuY2VQb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByZXR1cm4gdGhlIHBvaW50IGZyb20uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIGFuZ2xlIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gQW4gb3B0aW9uYWwgUG9pbnQgb2JqZWN0IHRvIHB1dCB0aGUgcmVzdWx0IGluIHRvLiBJZiBub25lIHNwZWNpZmllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBQb2ludCBvYmplY3QgaG9sZGluZyB0aGUgcmVzdWx0LgogICAgKi8KICAgIGNpcmN1bWZlcmVuY2VQb2ludDogZnVuY3Rpb24gKGFuZ2xlLCBhc0RlZ3JlZXMsIG91dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuQ2lyY2xlLmNpcmN1bWZlcmVuY2VQb2ludCh0aGlzLCBhbmdsZSwgYXNEZWdyZWVzLCBvdXQpOwogICAgfSwKCiAgICAvKioKICAgICogQWRqdXN0cyB0aGUgbG9jYXRpb24gb2YgdGhlIENpcmNsZSBvYmplY3QsIGFzIGRldGVybWluZWQgYnkgaXRzIGNlbnRlciBjb29yZGluYXRlLCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSNvZmZzZXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gTW92ZXMgdGhlIHggdmFsdWUgb2YgdGhlIENpcmNsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIE1vdmVzIHRoZSB5IHZhbHVlIG9mIHRoZSBDaXJjbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICoqLwogICAgb2Zmc2V0OiBmdW5jdGlvbiAoZHgsIGR5KSB7CiAgICAgICAgdGhpcy54ICs9IGR4OwogICAgICAgIHRoaXMueSArPSBkeTsKICAgICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLyoqCiAgICAqIEFkanVzdHMgdGhlIGxvY2F0aW9uIG9mIHRoZSBDaXJjbGUgb2JqZWN0IHVzaW5nIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLiBUaGlzIG1ldGhvZCBpcyBzaW1pbGFyIHRvIHRoZSBDaXJjbGUub2Zmc2V0KCkgbWV0aG9kLCBleGNlcHQgdGhhdCBpdCB0YWtlcyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlI29mZnNldFBvaW50CiAgICAqIEBwYXJhbSB7UG9pbnR9IHBvaW50IEEgUG9pbnQgb2JqZWN0IHRvIHVzZSB0byBvZmZzZXQgdGhpcyBDaXJjbGUgb2JqZWN0IChvciBhbnkgdmFsaWQgb2JqZWN0IHdpdGggZXhwb3NlZCB4IGFuZCB5IHByb3BlcnRpZXMpLgogICAgKiBAcmV0dXJuIHtDaXJjbGV9IFRoaXMgQ2lyY2xlIG9iamVjdC4KICAgICoqLwogICAgb2Zmc2V0UG9pbnQ6IGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgIHJldHVybiB0aGlzLm9mZnNldChwb2ludC54LCBwb2ludC55KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNpcmNsZSN0b1N0cmluZwogICAgKiBAcmV0dXJuIHtzdHJpbmd9IGEgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoZSBpbnN0YW5jZS4KICAgICoqLwogICAgdG9TdHJpbmc6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gIlt7UGhhc2VyLkNpcmNsZSAoeD0iICsgdGhpcy54ICsgIiB5PSIgKyB0aGlzLnkgKyAiIGRpYW1ldGVyPSIgKyB0aGlzLmRpYW1ldGVyICsgIiByYWRpdXM9IiArIHRoaXMucmFkaXVzICsgIil9XSI7CiAgICB9Cgp9OwoKLyoqCiogVGhlIGxhcmdlc3QgZGlzdGFuY2UgYmV0d2VlbiBhbnkgdHdvIHBvaW50cyBvbiB0aGUgY2lyY2xlLiBUaGUgc2FtZSBhcyB0aGUgcmFkaXVzICogMi4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2RpYW1ldGVyCiogQHByb3BlcnR5IHtudW1iZXJ9IGRpYW1ldGVyIC0gR2V0cyBvciBzZXRzIHRoZSBkaWFtZXRlciBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJkaWFtZXRlciIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZGlhbWV0ZXI7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gMCkgewogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLl9yYWRpdXMgPSB2YWx1ZSAqIDAuNTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBsZW5ndGggb2YgYSBsaW5lIGV4dGVuZGluZyBmcm9tIHRoZSBjZW50ZXIgb2YgdGhlIGNpcmNsZSB0byBhbnkgcG9pbnQgb24gdGhlIGNpcmNsZSBpdHNlbGYuIFRoZSBzYW1lIGFzIGhhbGYgdGhlIGRpYW1ldGVyLgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjcmFkaXVzCiogQHByb3BlcnR5IHtudW1iZXJ9IHJhZGl1cyAtIEdldHMgb3Igc2V0cyB0aGUgcmFkaXVzIG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgInJhZGl1cyIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IHZhbHVlOwogICAgICAgICAgICB0aGlzLl9kaWFtZXRlciA9IHZhbHVlICogMjsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuIENoYW5naW5nIHRoZSBsZWZ0IHByb3BlcnR5IG9mIGEgQ2lyY2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMuIEhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIGRpYW1ldGVyLCB3aGVyZWFzIGNoYW5naW5nIHRoZSB4IHZhbHVlIGRvZXMgbm90IGFmZmVjdCB0aGUgZGlhbWV0ZXIgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNsZWZ0CiogQHByb3BldHkge251bWJlcn0gbGVmdCAtIEdldHMgb3Igc2V0cyB0aGUgdmFsdWUgb2YgdGhlIGxlZnRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQ2lyY2xlLnByb3RvdHlwZSwgImxlZnQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggLSB0aGlzLl9yYWRpdXM7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gdGhpcy54KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHRoaXMueCAtIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgcmlnaHRtb3N0IHBvaW50IG9mIHRoZSBjaXJjbGUuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIENpcmNsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzLiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSBkaWFtZXRlciwgd2hlcmVhcyBjaGFuZ2luZyB0aGUgeCB2YWx1ZSBkb2VzIG5vdCBhZmZlY3QgdGhlIGRpYW1ldGVyIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5DaXJjbGUjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBHZXRzIG9yIHNldHMgdGhlIHZhbHVlIG9mIHRoZSByaWdodG1vc3QgcG9pbnQgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAicmlnaHQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPCB0aGlzLngpIHsKICAgICAgICAgICAgdGhpcy5fcmFkaXVzID0gMDsKICAgICAgICAgICAgdGhpcy5fZGlhbWV0ZXIgPSAwOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMucmFkaXVzID0gdmFsdWUgLSB0aGlzLng7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgc3VtIG9mIHRoZSB5IG1pbnVzIHRoZSByYWRpdXMgcHJvcGVydHkuIENoYW5naW5nIHRoZSB0b3AgcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBkaWFtZXRlci4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI3RvcAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3AgLSBHZXRzIG9yIHNldHMgdGhlIHRvcCBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJ0b3AiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSAtIHRoaXMuX3JhZGl1czsKICAgIH0sCiAgICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID4gdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHRoaXMueSAtIHZhbHVlOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIHN1bSBvZiB0aGUgeSBhbmQgcmFkaXVzIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSBib3R0b20gcHJvcGVydHkgb2YgYSBDaXJjbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHggYW5kIHkgcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBkaWFtZXRlci4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBHZXRzIG9yIHNldHMgdGhlIGJvdHRvbSBvZiB0aGUgY2lyY2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkNpcmNsZS5wcm90b3R5cGUsICJib3R0b20iLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuX3JhZGl1czsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHZhbHVlIDwgdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuX3JhZGl1cyA9IDA7CiAgICAgICAgICAgIHRoaXMuX2RpYW1ldGVyID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnJhZGl1cyA9IHZhbHVlIC0gdGhpcy55OwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogVGhlIGFyZWEgb2YgdGhpcyBDaXJjbGUuCiogQG5hbWUgUGhhc2VyLkNpcmNsZSNhcmVhCiogQHByb3BlcnR5IHtudW1iZXJ9IGFyZWEgLSBUaGUgYXJlYSBvZiB0aGlzIGNpcmNsZS4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiYXJlYSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICBpZiAodGhpcy5fcmFkaXVzID4gMCkgewogICAgICAgICAgICByZXR1cm4gTWF0aC5QSSAqIHRoaXMuX3JhZGl1cyAqIHRoaXMuX3JhZGl1czsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciBvciBub3QgdGhpcyBDaXJjbGUgb2JqZWN0IGlzIGVtcHR5LiBXaWxsIHJldHVybiBhIHZhbHVlIG9mIHRydWUgaWYgdGhlIENpcmNsZSBvYmplY3RzIGRpYW1ldGVyIGlzIGxlc3MgdGhhbiBvciBlcXVhbCB0byAwOyBvdGhlcndpc2UgZmFsc2UuCiogSWYgc2V0IHRvIHRydWUgaXQgd2lsbCByZXNldCBhbGwgb2YgdGhlIENpcmNsZSBvYmplY3RzIHByb3BlcnRpZXMgdG8gMC4gQSBDaXJjbGUgb2JqZWN0IGlzIGVtcHR5IGlmIGl0cyBkaWFtZXRlciBpcyBsZXNzIHRoYW4gb3IgZXF1YWwgdG8gMC4KKiBAbmFtZSBQaGFzZXIuQ2lyY2xlI2VtcHR5CiogQHByb3BlcnR5IHtib29sZWFufSBlbXB0eSAtIEdldHMgb3Igc2V0cyB0aGUgZW1wdHkgc3RhdGUgb2YgdGhlIGNpcmNsZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5DaXJjbGUucHJvdG90eXBlLCAiZW1wdHkiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICh0aGlzLl9kaWFtZXRlciA9PSAwKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnNldFRvKDAsIDAsIDApOwogICAgfQoKfSk7CgovKioKKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGVzIGFyZSB3aXRoaW4gdGhlIENpcmNsZSBvYmplY3QuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmNvbnRhaW5zCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIENpcmNsZSB0byBiZSBjaGVja2VkLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggdmFsdWUgb2YgdGhlIGNvb3JkaW5hdGUgdG8gdGVzdC4KKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIG9mIHRoZSBjb29yZGluYXRlIHRvIHRlc3QuCiogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgY29vcmRpbmF0ZXMgYXJlIHdpdGhpbiB0aGlzIGNpcmNsZSwgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmNvbnRhaW5zID0gZnVuY3Rpb24gKGEsIHgsIHkpIHsKCiAgICAvLyAgQ2hlY2sgaWYgeC95IGFyZSB3aXRoaW4gdGhlIGJvdW5kcyBmaXJzdAogICAgaWYgKHggPj0gYS5sZWZ0ICYmIHggPD0gYS5yaWdodCAmJiB5ID49IGEudG9wICYmIHkgPD0gYS5ib3R0b20pIHsKCiAgICAgICAgdmFyIGR4ID0gKGEueCAtIHgpICogKGEueCAtIHgpOwogICAgICAgIHZhciBkeSA9IChhLnkgLSB5KSAqIChhLnkgLSB5KTsKCiAgICAgICAgcmV0dXJuIChkeCArIGR5KSA8PSAoYS5yYWRpdXMgKiBhLnJhZGl1cyk7CgogICAgfQoKICAgIHJldHVybiBmYWxzZTsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBDaXJjbGUgb2JqZWN0cyBtYXRjaC4gVGhpcyBtZXRob2QgY29tcGFyZXMgdGhlIHgsIHkgYW5kIGRpYW1ldGVyIHByb3BlcnRpZXMuCiogQG1ldGhvZCBQaGFzZXIuQ2lyY2xlLmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYSAtIFRoZSBmaXJzdCBDaXJjbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYiAtIFRoZSBzZWNvbmQgQ2lyY2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIG9iamVjdCBoYXMgZXhhY3RseSB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5IGFuZCBkaWFtZXRlciBwcm9wZXJ0aWVzIGFzIHRoaXMgQ2lyY2xlIG9iamVjdDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuQ2lyY2xlLmVxdWFscyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKGEueCA9PSBiLnggJiYgYS55ID09IGIueSAmJiBhLmRpYW1ldGVyID09IGIuZGlhbWV0ZXIpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgaW50ZXJzZWN0LgoqIFRoaXMgbWV0aG9kIGNoZWNrcyB0aGUgcmFkaXVzIGRpc3RhbmNlcyBiZXR3ZWVuIHRoZSB0d28gQ2lyY2xlIG9iamVjdHMgdG8gc2VlIGlmIHRoZXkgaW50ZXJzZWN0LgoqIEBtZXRob2QgUGhhc2VyLkNpcmNsZS5pbnRlcnNlY3RzCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIGZpcnN0IENpcmNsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBiIC0gVGhlIHNlY29uZCBDaXJjbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhpcyBDaXJjbGUgb2JqZWN0OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5DaXJjbGUuaW50ZXJzZWN0cyA9IGZ1bmN0aW9uIChhLCBiKSB7CiAgICByZXR1cm4gKFBoYXNlci5NYXRoLmRpc3RhbmNlKGEueCwgYS55LCBiLngsIGIueSkgPD0gKGEucmFkaXVzICsgYi5yYWRpdXMpKTsKfTsKCi8qKgoqIFJldHVybnMgYSBQb2ludCBvYmplY3QgY29udGFpbmluZyB0aGUgY29vcmRpbmF0ZXMgb2YgYSBwb2ludCBvbiB0aGUgY2lyY3VtZmVyZW5jZSBvZiB0aGUgQ2lyY2xlIGJhc2VkIG9uIHRoZSBnaXZlbiBhbmdsZS4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuY2lyY3VtZmVyZW5jZVBvaW50CiogQHBhcmFtIHtQaGFzZXIuQ2lyY2xlfSBhIC0gVGhlIGZpcnN0IENpcmNsZSBvYmplY3QuCiogQHBhcmFtIHtudW1iZXJ9IGFuZ2xlIC0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgKHVubGVzcyBhc0RlZ3JlZXMgaXMgdHJ1ZSkgdG8gcmV0dXJuIHRoZSBwb2ludCBmcm9tLgoqIEBwYXJhbSB7Ym9vbGVhbn0gYXNEZWdyZWVzIC0gSXMgdGhlIGdpdmVuIGFuZ2xlIGluIHJhZGlhbnMgKGZhbHNlKSBvciBkZWdyZWVzICh0cnVlKT8KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBBbiBvcHRpb25hbCBQb2ludCBvYmplY3QgdG8gcHV0IHRoZSByZXN1bHQgaW4gdG8uIElmIG5vbmUgc3BlY2lmaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgUG9pbnQgb2JqZWN0IGhvbGRpbmcgdGhlIHJlc3VsdC4KKi8KUGhhc2VyLkNpcmNsZS5jaXJjdW1mZXJlbmNlUG9pbnQgPSBmdW5jdGlvbiAoYSwgYW5nbGUsIGFzRGVncmVlcywgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBhc0RlZ3JlZXMgPT09ICJ1bmRlZmluZWQiKSB7IGFzRGVncmVlcyA9IGZhbHNlOyB9CiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgaWYgKGFzRGVncmVlcyA9PT0gdHJ1ZSkgewogICAgICAgIGFuZ2xlID0gUGhhc2VyLk1hdGgucmFkVG9EZWcoYW5nbGUpOwogICAgfQoKICAgIG91dC54ID0gYS54ICsgYS5yYWRpdXMgKiBNYXRoLmNvcyhhbmdsZSk7CiAgICBvdXQueSA9IGEueSArIGEucmFkaXVzICogTWF0aC5zaW4oYW5nbGUpOwoKICAgIHJldHVybiBvdXQ7Cgp9OwoKLyoqCiogQ2hlY2tzIGlmIHRoZSBnaXZlbiBDaXJjbGUgYW5kIFJlY3RhbmdsZSBvYmplY3RzIGludGVyc2VjdC4KKiBAbWV0aG9kIFBoYXNlci5DaXJjbGUuaW50ZXJzZWN0c1JlY3RhbmdsZQoqIEBwYXJhbSB7UGhhc2VyLkNpcmNsZX0gYyAtIFRoZSBDaXJjbGUgb2JqZWN0IHRvIHRlc3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSByIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QgdG8gdGVzdC4KKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSB0d28gb2JqZWN0cyBpbnRlcnNlY3QsIG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLkNpcmNsZS5pbnRlcnNlY3RzUmVjdGFuZ2xlID0gZnVuY3Rpb24gKGMsIHIpIHsKCiAgICB2YXIgY3ggPSBNYXRoLmFicyhjLnggLSByLnggLSByLmhhbGZXaWR0aCk7CiAgICB2YXIgeERpc3QgPSByLmhhbGZXaWR0aCArIGMucmFkaXVzOwoKICAgIGlmIChjeCA+IHhEaXN0KSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHZhciBjeSA9IE1hdGguYWJzKGMueSAtIHIueSAtIHIuaGFsZkhlaWdodCk7CiAgICB2YXIgeURpc3QgPSByLmhhbGZIZWlnaHQgKyBjLnJhZGl1czsKCiAgICBpZiAoY3kgPiB5RGlzdCkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICBpZiAoY3ggPD0gci5oYWxmV2lkdGggfHwgY3kgPD0gci5oYWxmSGVpZ2h0KSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CgogICAgdmFyIHhDb3JuZXJEaXN0ID0gY3ggLSByLmhhbGZXaWR0aDsKICAgIHZhciB5Q29ybmVyRGlzdCA9IGN5IC0gci5oYWxmSGVpZ2h0OwogICAgdmFyIHhDb3JuZXJEaXN0U3EgPSB4Q29ybmVyRGlzdCAqIHhDb3JuZXJEaXN0OwogICAgdmFyIHlDb3JuZXJEaXN0U3EgPSB5Q29ybmVyRGlzdCAqIHlDb3JuZXJEaXN0OwogICAgdmFyIG1heENvcm5lckRpc3RTcSA9IGMucmFkaXVzICogYy5yYWRpdXM7CgogICAgcmV0dXJuIHhDb3JuZXJEaXN0U3EgKyB5Q29ybmVyRGlzdFNxIDw9IG1heENvcm5lckRpc3RTcTsKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IFBvaW50LiBJZiB5b3UgcGFzcyBubyBwYXJhbWV0ZXJzIGEgUG9pbnQgaXMgY3JlYXRlZCBzZXQgdG8gKDAsMCkuCiogQGNsYXNzIFBoYXNlci5Qb2ludAoqIEBjbGFzc2Rlc2MgVGhlIFBvaW50IG9iamVjdCByZXByZXNlbnRzIGEgbG9jYXRpb24gaW4gYSB0d28tZGltZW5zaW9uYWwgY29vcmRpbmF0ZSBzeXN0ZW0sIHdoZXJlIHggcmVwcmVzZW50cyB0aGUgaG9yaXpvbnRhbCBheGlzIGFuZCB5IHJlcHJlc2VudHMgdGhlIHZlcnRpY2FsIGF4aXMuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IHggVGhlIGhvcml6b250YWwgcG9zaXRpb24gb2YgdGhpcyBQb2ludCAoZGVmYXVsdCAwKQoqIEBwYXJhbSB7bnVtYmVyfSB5IFRoZSB2ZXJ0aWNhbCBwb3NpdGlvbiBvZiB0aGlzIFBvaW50IChkZWZhdWx0IDApCioqLwpQaGFzZXIuUG9pbnQgPSBmdW5jdGlvbiAoeCwgeSkgewoKICAgIHggPSB4IHx8IDA7CiAgICB5ID0geSB8fCAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBwb2ludC4KICAgICAqKi8KICAgIHRoaXMueCA9IHg7CiAgICAKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBwb2ludC4KICAgICAqKi8KICAgIHRoaXMueSA9IHk7Cgp9OwoKUGhhc2VyLlBvaW50LnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgUG9pbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKiovCiAgICBjb3B5RnJvbTogZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHNvdXJjZS54LCBzb3VyY2UueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBJbnZlcnRzIHRoZSB4IGFuZCB5IHZhbHVlcyBvZiB0aGlzIFBvaW50CiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2ludmVydAogICAgKiBAcmV0dXJuIHtQb2ludH0gVGhpcyBQb2ludCBvYmplY3QuCiAgICAqKi8KICAgIGludmVydDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHRoaXMueSwgdGhpcy54KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIHggYW5kIHkgdmFsdWVzIG9mIHRoaXMgUG9pbnQgb2JqZWN0IHRvIHRoZSBnaXZlbiBjb29yZGluYXRlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjc2V0VG8KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgaG9yaXpvbnRhbCBwb3NpdGlvbiBvZiB0aGlzIHBvaW50LgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB2ZXJ0aWNhbCBwb3NpdGlvbiBvZiB0aGlzIHBvaW50LgogICAgKiBAcmV0dXJuIHtQb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKiovICAgICAgICAKICAgIHNldFRvOiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHRoZSBnaXZlbiB4IGFuZCB5IHZhbHVlcyB0byB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNhZGQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gYWRkIHRvIFBvaW50LnguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIGFkZCB0byBQb2ludC55LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICoqLyAgICAgICAgCiAgICBhZGQ6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCArPSB4OwogICAgICAgIHRoaXMueSArPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN1YnRyYWN0cyB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMgZnJvbSB0aGlzIFBvaW50LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNzdWJ0cmFjdAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB2YWx1ZSB0byBzdWJ0cmFjdCBmcm9tIFBvaW50LnguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIHN1YnRyYWN0IGZyb20gUG9pbnQueS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4gVXNlZnVsIGZvciBjaGFpbmluZyBtZXRob2QgY2FsbHMuCiAgICAqKi8gICAgICAgIAogICAgc3VidHJhY3Q6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCAtPSB4OwogICAgICAgIHRoaXMueSAtPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE11bHRpcGxpZXMgUG9pbnQueCBhbmQgUG9pbnQueSBieSB0aGUgZ2l2ZW4geCBhbmQgeSB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I211bHRpcGx5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHZhbHVlIHRvIG11bHRpcGx5IFBvaW50LnggYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIG11bHRpcGx5IFBvaW50LnggYnkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhpcyBQb2ludCBvYmplY3QuIFVzZWZ1bCBmb3IgY2hhaW5pbmcgbWV0aG9kIGNhbGxzLgogICAgKiovICAgICAgICAKICAgIG11bHRpcGx5OiBmdW5jdGlvbiAoeCwgeSkgewoKICAgICAgICB0aGlzLnggKj0geDsKICAgICAgICB0aGlzLnkgKj0geTsKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAoKICAgIC8qKgogICAgKiBEaXZpZGVzIFBvaW50LnggYW5kIFBvaW50LnkgYnkgdGhlIGdpdmVuIHggYW5kIHkgdmFsdWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNkaXZpZGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgdmFsdWUgdG8gZGl2aWRlIFBvaW50LnggYnkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHZhbHVlIHRvIGRpdmlkZSBQb2ludC54IGJ5LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LiBVc2VmdWwgZm9yIGNoYWluaW5nIG1ldGhvZCBjYWxscy4KICAgICoqLyAgICAgICAgCiAgICBkaXZpZGU6IGZ1bmN0aW9uICh4LCB5KSB7CgogICAgICAgIHRoaXMueCAvPSB4OwogICAgICAgIHRoaXMueSAvPSB5OwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGUgeCB2YWx1ZSBvZiB0aGlzIFBvaW50IHRvIGJlIGJldHdlZW4gdGhlIGdpdmVuIG1pbiBhbmQgbWF4LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNjbGFtcFgKICAgICogQHBhcmFtIHtudW1iZXJ9IG1pbiAtIFRoZSBtaW5pbXVtIHZhbHVlIHRvIGNsYW1wIHRoaXMgUG9pbnQgdG8uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSBUaGUgbWF4aW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKi8KICAgIGNsYW1wWDogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHRoaXMueCA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueCwgbWluLCBtYXgpOwogICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogQ2xhbXBzIHRoZSB5IHZhbHVlIG9mIHRoaXMgUG9pbnQgdG8gYmUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXgKICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xhbXBZCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcFk6IGZ1bmN0aW9uIChtaW4sIG1heCkgewoKICAgICAgICB0aGlzLnkgPSBQaGFzZXIuTWF0aC5jbGFtcCh0aGlzLnksIG1pbiwgbWF4KTsKICAgICAgICByZXR1cm4gdGhpczsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIENsYW1wcyB0aGlzIFBvaW50IG9iamVjdCB2YWx1ZXMgdG8gYmUgYmV0d2VlbiB0aGUgZ2l2ZW4gbWluIGFuZCBtYXguCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NsYW1wCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSB0byBjbGFtcCB0aGlzIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge251bWJlcn0gbWF4IC0gVGhlIG1heGltdW0gdmFsdWUgdG8gY2xhbXAgdGhpcyBQb2ludCB0by4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGlzIFBvaW50IG9iamVjdC4KICAgICovCiAgICBjbGFtcDogZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgogICAgICAgIHRoaXMueCA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueCwgbWluLCBtYXgpOwogICAgICAgIHRoaXMueSA9IFBoYXNlci5NYXRoLmNsYW1wKHRoaXMueSwgbWluLCBtYXgpOwogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENyZWF0ZXMgYSBjb3B5IG9mIHRoZSBnaXZlbiBQb2ludC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY2xvbmUKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRwdXRdIE9wdGlvbmFsIFBvaW50IG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiAgICAqLwogICAgY2xvbmU6IGZ1bmN0aW9uIChvdXRwdXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBvdXRwdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dHB1dCA9IG5ldyBQaGFzZXIuUG9pbnQ7IH0KCiAgICAgICAgcmV0dXJuIG91dHB1dC5zZXRUbyh0aGlzLngsIHRoaXMueSk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgUG9pbnQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I2NvcHlGcm9tCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgb2JqZWN0IHRvIGNvcHkgZnJvbS4KICAgICogQHJldHVybiB7UG9pbnR9IFRoaXMgUG9pbnQgb2JqZWN0LgogICAgKiovCiAgICBjb3B5RnJvbTogZnVuY3Rpb24gKHNvdXJjZSkgewogICAgICAgIHJldHVybiB0aGlzLnNldFRvKHNvdXJjZS54LCBzb3VyY2UueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHggYW5kIHkgcHJvcGVydGllcyBmcm9tIHRoaXMgUG9pbnQgdG8gYW55IGdpdmVuIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjY29weVRvCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0IC0gVGhlIG9iamVjdCB0byBjb3B5IHRvLgogICAgKiBAcmV0dXJuIHtPYmplY3R9IFRoZSBkZXN0IG9iamVjdC4KICAgICoqLwogICAgY29weVRvOiBmdW5jdGlvbihkZXN0KSB7CgogICAgICAgIGRlc3RbeF0gPSB0aGlzLng7CiAgICAgICAgZGVzdFt5XSA9IHRoaXMueTsKCiAgICAgICAgcmV0dXJuIGRlc3Q7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGlzdGFuY2Ugb2YgdGhpcyBQb2ludCBvYmplY3QgdG8gdGhlIGdpdmVuIG9iamVjdCAoY2FuIGJlIGEgQ2lyY2xlLCBQb2ludCBvciBhbnl0aGluZyB3aXRoIHgveSBwcm9wZXJ0aWVzKQogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNkaXN0YW5jZQogICAgKiBAcGFyYW0ge29iamVjdH0gZGVzdCAtIFRoZSB0YXJnZXQgb2JqZWN0LiBNdXN0IGhhdmUgdmlzaWJsZSB4IGFuZCB5IHByb3BlcnRpZXMgdGhhdCByZXByZXNlbnQgdGhlIGNlbnRlciBvZiB0aGUgb2JqZWN0LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtyb3VuZF0gLSBSb3VuZCB0aGUgZGlzdGFuY2UgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciAoZGVmYXVsdCBmYWxzZSkuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRpc3RhbmNlIGJldHdlZW4gdGhpcyBQb2ludCBvYmplY3QgYW5kIHRoZSBkZXN0aW5hdGlvbiBQb2ludCBvYmplY3QuCiAgICAqLwogICAgZGlzdGFuY2U6IGZ1bmN0aW9uIChkZXN0LCByb3VuZCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUG9pbnQuZGlzdGFuY2UodGhpcywgZGVzdCwgcm91bmQpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBnaXZlbiBvYmplY3RzIHgveSB2YWx1ZXMgYXJlIGVxdWFsIHRvIHRoaXMgUG9pbnQgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNlcXVhbHMKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3Qgb2JqZWN0IHRvIGNvbXBhcmUuCiAgICAqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUG9pbnRzIGFyZSBlcXVhbCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGVxdWFsczogZnVuY3Rpb24gKGEpIHsKICAgICAgICByZXR1cm4gKGEueCA9PSB0aGlzLnggJiYgYS55ID09IHRoaXMueSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBSb3RhdGVzIHRoaXMgUG9pbnQgYXJvdW5kIHRoZSB4L3kgY29vcmRpbmF0ZXMgZ2l2ZW4gdG8gdGhlIGRlc2lyZWQgYW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I3JvdGF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAogICAgKiBAcGFyYW0ge251bWJlcn0gYW5nbGUgLSBUaGUgYW5nbGUgaW4gcmFkaWFucyAodW5sZXNzIGFzRGVncmVlcyBpcyB0cnVlKSB0byByb3RhdGUgdGhlIFBvaW50IHRvLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGFzRGVncmVlcyAtIElzIHRoZSBnaXZlbiByb3RhdGlvbiBpbiByYWRpYW5zIChmYWxzZSkgb3IgZGVncmVlcyAodHJ1ZSk/CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZGlzdGFuY2VdIC0gQW4gb3B0aW9uYWwgZGlzdGFuY2UgY29uc3RyYWludCBiZXR3ZWVuIHRoZSBQb2ludCBhbmQgdGhlIGFuY2hvci4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbW9kaWZpZWQgcG9pbnQgb2JqZWN0LgogICAgKi8KICAgIHJvdGF0ZTogZnVuY3Rpb24gKHgsIHksIGFuZ2xlLCBhc0RlZ3JlZXMsIGRpc3RhbmNlKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5Qb2ludC5yb3RhdGUodGhpcywgeCwgeSwgYW5nbGUsIGFzRGVncmVlcywgZGlzdGFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICAqIENhbGN1bGF0ZXMgdGhlIGxlbmd0aCBvZiB0aGUgdmVjdG9yCiAgICAgKiBAbWV0aG9kIFBoYXNlci5Qb2ludCNnZXRNYWduaXR1ZGUKICAgICAqIEByZXR1cm4ge251bWJlcn0gdGhlIGxlbmd0aCBvZiB0aGUgdmVjdG9yCiAgICAgKi8KICAgIGdldE1hZ25pdHVkZTogZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIE1hdGguc3FydCgodGhpcy54ICogdGhpcy54KSArICh0aGlzLnkgKiB0aGlzLnkpKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBbHRlcnMgdGhlIGxlbmd0aCBvZiB0aGUgdmVjdG9yIHdpdGhvdXQgY2hhbmdpbmcgdGhlIGRpcmVjdGlvbgogICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjZ2V0TWFnbml0dWRlCiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWFnbml0dWRlIHRoZSBkZXNpcmVkIG1hZ25pdHVkZSBvZiB0aGUgcmVzdWx0aW5nIHZlY3RvcgogICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSB0aGUgbW9kaWZpZWQgb3JpZ2luYWwgdmVjdG9yCiAgICAgKi8KICAgIHNldE1hZ25pdHVkZTogZnVuY3Rpb24obWFnbml0dWRlKSB7CiAgICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplKCkubXVsdGlwbHkobWFnbml0dWRlLCBtYWduaXR1ZGUpOwogICAgfSwKCiAgICAvKioKICAgICAqIEFsdGVycyB0aGUgdmVjdG9yIHNvIHRoYXQgaXRzIGxlbmd0aCBpcyAxLCBidXQgaXQgcmV0YWlucyB0aGUgc2FtZSBkaXJlY3Rpb24KICAgICAqIEBtZXRob2QgUGhhc2VyLlBvaW50I25vcm1hbGl6ZQogICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSB0aGUgbW9kaWZpZWQgb3JpZ2luYWwgdmVjdG9yCiAgICAgKi8KICAgIG5vcm1hbGl6ZTogZnVuY3Rpb24oKSB7CgogICAgICAgIGlmKCF0aGlzLmlzWmVybygpKSB7CiAgICAgICAgICAgIHZhciBtID0gdGhpcy5nZXRNYWduaXR1ZGUoKTsKICAgICAgICAgICAgdGhpcy54IC89IG07CiAgICAgICAgICAgIHRoaXMueSAvPSBtOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXM7CgogICAgfSwKCiAgICAvKioKICAgICAqIERldGVybWluZSBpZiB0aGlzIHBvaW50IGlzIGF0IDAsMAogICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjaXNaZXJvCiAgICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoaXMgUG9pbnQgaXMgMCwwLCBvdGhlcndpc2UgZmFsc2UKICAgICAqLwogICAgaXNaZXJvOiBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gKHRoaXMueCA9PT0gMCAmJiB0aGlzLnkgPT09IDApOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUG9pbnQjdG9TdHJpbmcKICAgICogQHJldHVybiB7c3RyaW5nfSBBIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGUgaW5zdGFuY2UuCiAgICAqKi8KICAgIHRvU3RyaW5nOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuICdbe1BvaW50ICh4PScgKyB0aGlzLnggKyAnIHk9JyArIHRoaXMueSArICcpfV0nOwogICAgfQoKfTsKCi8qKgoqIEFkZHMgdGhlIGNvb3JkaW5hdGVzIG9mIHR3byBwb2ludHMgdG9nZXRoZXIgdG8gY3JlYXRlIGEgbmV3IHBvaW50LgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LmFkZAoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIGZpcnN0IFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYiAtIFRoZSBzZWNvbmQgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBbb3V0XSAtIE9wdGlvbmFsIFBvaW50IHRvIHN0b3JlIHRoZSB2YWx1ZSBpbiwgaWYgbm90IHN1cHBsaWVkIGEgbmV3IFBvaW50IG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbmV3IFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LmFkZCA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgb3V0LnggPSBhLnggKyBiLng7CiAgICBvdXQueSA9IGEueSArIGIueTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIFN1YnRyYWN0cyB0aGUgY29vcmRpbmF0ZXMgb2YgdHdvIHBvaW50cyB0byBjcmVhdGUgYSBuZXcgcG9pbnQuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuc3VidHJhY3QKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBPcHRpb25hbCBQb2ludCB0byBzdG9yZSB0aGUgdmFsdWUgaW4sIGlmIG5vdCBzdXBwbGllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5zdWJ0cmFjdCA9IGZ1bmN0aW9uIChhLCBiLCBvdXQpIHsKCiAgICBpZiAodHlwZW9mIG91dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CgogICAgb3V0LnggPSBhLnggLSBiLng7CiAgICBvdXQueSA9IGEueSAtIGIueTsKCiAgICByZXR1cm4gb3V0OwoKfTsKCi8qKgoqIE11bHRpcGxpZXMgdGhlIGNvb3JkaW5hdGVzIG9mIHR3byBwb2ludHMgdG8gY3JlYXRlIGEgbmV3IHBvaW50LgoqIEBtZXRob2QgUGhhc2VyLlBvaW50Lm11bHRpcGx5CiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IFtvdXRdIC0gT3B0aW9uYWwgUG9pbnQgdG8gc3RvcmUgdGhlIHZhbHVlIGluLCBpZiBub3Qgc3VwcGxpZWQgYSBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZC4KKiBAcmV0dXJuIHtQaGFzZXIuUG9pbnR9IFRoZSBuZXcgUG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQubXVsdGlwbHkgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54ICogYi54OwogICAgb3V0LnkgPSBhLnkgKiBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBEaXZpZGVzIHRoZSBjb29yZGluYXRlcyBvZiB0d28gcG9pbnRzIHRvIGNyZWF0ZSBhIG5ldyBwb2ludC4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5kaXZpZGUKKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gYSAtIFRoZSBmaXJzdCBQb2ludCBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGIgLSBUaGUgc2Vjb25kIFBvaW50IG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dF0gLSBPcHRpb25hbCBQb2ludCB0byBzdG9yZSB0aGUgdmFsdWUgaW4sIGlmIG5vdCBzdXBwbGllZCBhIG5ldyBQb2ludCBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkLgoqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIG5ldyBQb2ludCBvYmplY3QuCiovClBoYXNlci5Qb2ludC5kaXZpZGUgPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUG9pbnQoKTsgfQoKICAgIG91dC54ID0gYS54IC8gYi54OwogICAgb3V0LnkgPSBhLnkgLyBiLnk7CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBnaXZlbiBQb2ludCBvYmplY3RzIGFyZSBlcXVhbC4gVGhleSBhcmUgY29uc2lkZXJlZCBlcXVhbCBpZiB0aGV5IGhhdmUgdGhlIHNhbWUgeCBhbmQgeSB2YWx1ZXMuCiogQG1ldGhvZCBQaGFzZXIuUG9pbnQuZXF1YWxzCiogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IGEgLSBUaGUgZmlyc3QgUG9pbnQgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBiIC0gVGhlIHNlY29uZCBQb2ludCBvYmplY3QuCiogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBQb2ludHMgYXJlIGVxdWFsLCBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5Qb2ludC5lcXVhbHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChhLnggPT0gYi54ICYmIGEueSA9PSBiLnkpOwp9OwoKLyoqCiogUmV0dXJucyB0aGUgZGlzdGFuY2Ugb2YgdGhpcyBQb2ludCBvYmplY3QgdG8gdGhlIGdpdmVuIG9iamVjdCAoY2FuIGJlIGEgQ2lyY2xlLCBQb2ludCBvciBhbnl0aGluZyB3aXRoIHgveSBwcm9wZXJ0aWVzKS4KKiBAbWV0aG9kIFBoYXNlci5Qb2ludC5kaXN0YW5jZQoqIEBwYXJhbSB7b2JqZWN0fSBhIC0gVGhlIHRhcmdldCBvYmplY3QuIE11c3QgaGF2ZSB2aXNpYmxlIHggYW5kIHkgcHJvcGVydGllcyB0aGF0IHJlcHJlc2VudCB0aGUgY2VudGVyIG9mIHRoZSBvYmplY3QuCiogQHBhcmFtIHtvYmplY3R9IGIgLSBUaGUgdGFyZ2V0IG9iamVjdC4gTXVzdCBoYXZlIHZpc2libGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHRoYXQgcmVwcmVzZW50IHRoZSBjZW50ZXIgb2YgdGhlIG9iamVjdC4KKiBAcGFyYW0ge2Jvb2xlYW59IFtyb3VuZF0gLSBSb3VuZCB0aGUgZGlzdGFuY2UgdG8gdGhlIG5lYXJlc3QgaW50ZWdlciAoZGVmYXVsdCBmYWxzZSkuCiogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGlzIFBvaW50IG9iamVjdCBhbmQgdGhlIGRlc3RpbmF0aW9uIFBvaW50IG9iamVjdC4KKi8KUGhhc2VyLlBvaW50LmRpc3RhbmNlID0gZnVuY3Rpb24gKGEsIGIsIHJvdW5kKSB7CgogICAgaWYgKHR5cGVvZiByb3VuZCA9PT0gInVuZGVmaW5lZCIpIHsgcm91bmQgPSBmYWxzZSB9CgogICAgaWYgKHJvdW5kKQogICAgewogICAgICAgIHJldHVybiBQaGFzZXIuTWF0aC5kaXN0YW5jZVJvdW5kKGEueCwgYS55LCBiLngsIGIueSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5NYXRoLmRpc3RhbmNlKGEueCwgYS55LCBiLngsIGIueSk7CiAgICB9Cgp9LAoKLyoqCiogUm90YXRlcyBhIFBvaW50IGFyb3VuZCB0aGUgeC95IGNvb3JkaW5hdGVzIGdpdmVuIHRvIHRoZSBkZXNpcmVkIGFuZ2xlLgoqIEBtZXRob2QgUGhhc2VyLlBvaW50LnJvdGF0ZQoqIEBwYXJhbSB7UGhhc2VyLlBvaW50fSBhIC0gVGhlIFBvaW50IG9iamVjdCB0byByb3RhdGUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgeCBjb29yZGluYXRlIG9mIHRoZSBhbmNob3IgcG9pbnQKKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGFuY2hvciBwb2ludAoqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiByYWRpYW5zICh1bmxlc3MgYXNEZWdyZWVzIGlzIHRydWUpIHRvIHJvdGF0ZSB0aGUgUG9pbnQgdG8uCiogQHBhcmFtIHtib29sZWFufSBhc0RlZ3JlZXMgLSBJcyB0aGUgZ2l2ZW4gcm90YXRpb24gaW4gcmFkaWFucyAoZmFsc2UpIG9yIGRlZ3JlZXMgKHRydWUpPwoqIEBwYXJhbSB7bnVtYmVyfSBkaXN0YW5jZSAtIEFuIG9wdGlvbmFsIGRpc3RhbmNlIGNvbnN0cmFpbnQgYmV0d2VlbiB0aGUgUG9pbnQgYW5kIHRoZSBhbmNob3IuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgbW9kaWZpZWQgcG9pbnQgb2JqZWN0LgoqLwpQaGFzZXIuUG9pbnQucm90YXRlID0gZnVuY3Rpb24gKGEsIHgsIHksIGFuZ2xlLCBhc0RlZ3JlZXMsIGRpc3RhbmNlKSB7CgogICAgYXNEZWdyZWVzID0gYXNEZWdyZWVzIHx8IGZhbHNlOwogICAgZGlzdGFuY2UgPSBkaXN0YW5jZSB8fCBudWxsOwoKICAgIGlmIChhc0RlZ3JlZXMpCiAgICB7CiAgICAgICAgYW5nbGUgPSBQaGFzZXIuTWF0aC5kZWdUb1JhZChhbmdsZSk7CiAgICB9CgogICAgLy8gIEdldCBkaXN0YW5jZSBmcm9tIG9yaWdpbiAoY3gvY3kpIHRvIHRoaXMgcG9pbnQKICAgIGlmIChkaXN0YW5jZSA9PT0gbnVsbCkKICAgIHsKICAgICAgICBkaXN0YW5jZSA9IE1hdGguc3FydCgoKHggLSBhLngpICogKHggLSBhLngpKSArICgoeSAtIGEueSkgKiAoeSAtIGEueSkpKTsKICAgIH0KCiAgICByZXR1cm4gYS5zZXRUbyh4ICsgZGlzdGFuY2UgKiBNYXRoLmNvcyhhbmdsZSksIHkgKyBkaXN0YW5jZSAqIE1hdGguc2luKGFuZ2xlKSk7Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQ3JlYXRlcyBhIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpdGggdGhlIHRvcC1sZWZ0IGNvcm5lciBzcGVjaWZpZWQgYnkgdGhlIHggYW5kIHkgcGFyYW1ldGVycyBhbmQgd2l0aCB0aGUgc3BlY2lmaWVkIHdpZHRoIGFuZCBoZWlnaHQgcGFyYW1ldGVycy4gSWYgeW91IGNhbGwgdGhpcyBmdW5jdGlvbiB3aXRob3V0IHBhcmFtZXRlcnMsIGEgUmVjdGFuZ2xlIHdpdGggeCwgeSwgd2lkdGgsIGFuZCBoZWlnaHQgcHJvcGVydGllcyBzZXQgdG8gMCBpcyBjcmVhdGVkLgoqCiogQGNsYXNzIFBoYXNlci5SZWN0YW5nbGUKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiogQHBhcmFtIHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBSZWN0YW5nbGUgaW4gcGl4ZWxzLgoqIEBwYXJhbSB7bnVtYmVyfSBoZWlnaHQgLSBUaGUgaGVpZ2h0IG9mIHRoZSBSZWN0YW5nbGUgaW4gcGl4ZWxzLgoqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgoqKi8KUGhhc2VyLlJlY3RhbmdsZSA9IGZ1bmN0aW9uICh4LCB5LCB3aWR0aCwgaGVpZ2h0KSB7CgogICAgeCA9IHggfHwgMDsKICAgIHkgPSB5IHx8IDA7CiAgICB3aWR0aCA9IHdpZHRoIHx8IDA7CiAgICBoZWlnaHQgPSBoZWlnaHQgfHwgMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLnggPSB4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBEZXNjcmlwdGlvbi4KICAgICovCiAgICB0aGlzLnkgPSB5OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKfTsKClBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCwgYXMgZGV0ZXJtaW5lZCBieSBpdHMgdG9wLWxlZnQgY29ybmVyLCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNvZmZzZXQKICAgICogQHBhcmFtIHtudW1iZXJ9IGR4IC0gTW92ZXMgdGhlIHggdmFsdWUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QgYnkgdGhpcyBhbW91bnQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkeSAtIE1vdmVzIHRoZSB5IHZhbHVlIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoaXMgYW1vdW50LgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICoqLwogICAgb2Zmc2V0OiBmdW5jdGlvbiAoZHgsIGR5KSB7CgogICAgICAgIHRoaXMueCArPSBkeDsKICAgICAgICB0aGlzLnkgKz0gZHk7CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCiAKICAgIC8qKgogICAgKiBBZGp1c3RzIHRoZSBsb2NhdGlvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCB1c2luZyBhIFBvaW50IG9iamVjdCBhcyBhIHBhcmFtZXRlci4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgUmVjdGFuZ2xlLm9mZnNldCgpIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNvZmZzZXRQb2ludAogICAgKiBAcGFyYW0ge1BvaW50fSBwb2ludCAtIEEgUG9pbnQgb2JqZWN0IHRvIHVzZSB0byBvZmZzZXQgdGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICoqLwogICAgb2Zmc2V0UG9pbnQ6IGZ1bmN0aW9uIChwb2ludCkgewogICAgICAgIHJldHVybiB0aGlzLm9mZnNldChwb2ludC54LCBwb2ludC55KTsKICAgIH0sCiAKICAgIC8qKgogICAgKiBTZXRzIHRoZSBtZW1iZXJzIG9mIFJlY3RhbmdsZSB0byB0aGUgc3BlY2lmaWVkIHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3NldFRvCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wLWxlZnQgY29ybmVyIG9mIHRoZSBSZWN0YW5nbGUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlIGluIHBpeGVscy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIFJlY3RhbmdsZSBpbiBwaXhlbHMuCiAgICAqIEByZXR1cm4ge1JlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0CiAgICAqKi8KICAgIHNldFRvOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCkgewoKICAgICAgICB0aGlzLnggPSB4OwogICAgICAgIHRoaXMueSA9IHk7CiAgICAgICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gaGVpZ2h0OwoKICAgICAgICByZXR1cm4gdGhpczsKCiAgICB9LAogCiAgICAvKioKICAgICogUnVucyBNYXRoLmZsb29yKCkgb24gYm90aCB0aGUgeCBhbmQgeSB2YWx1ZXMgb2YgdGhpcyBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNmbG9vcgogICAgKiovCiAgICBmbG9vcjogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICAgICAgdGhpcy55ID0gTWF0aC5mbG9vcih0aGlzLnkpOwoKICAgIH0sCiAKICAgIC8qKgogICAgKiBSdW5zIE1hdGguZmxvb3IoKSBvbiB0aGUgeCwgeSwgd2lkdGggYW5kIGhlaWdodCB2YWx1ZXMgb2YgdGhpcyBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNmbG9vckFsbAogICAgKiovCiAgICBmbG9vckFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnggPSBNYXRoLmZsb29yKHRoaXMueCk7CiAgICAgICAgdGhpcy55ID0gTWF0aC5mbG9vcih0aGlzLnkpOwogICAgICAgIHRoaXMud2lkdGggPSBNYXRoLmZsb29yKHRoaXMud2lkdGgpOwogICAgICAgIHRoaXMuaGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLmhlaWdodCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ29waWVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgZnJvbSBhbnkgZ2l2ZW4gb2JqZWN0IHRvIHRoaXMgUmVjdGFuZ2xlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29weUZyb20KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSBmcm9tLgogICAgKiBAcmV0dXJuIHtSZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KICAgICoqLwogICAgY29weUZyb206IGZ1bmN0aW9uIChzb3VyY2UpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXRUbyhzb3VyY2UueCwgc291cmNlLnksIHNvdXJjZS53aWR0aCwgc291cmNlLmhlaWdodCk7CiAgICB9LAoKICAgIC8qKgogICAgKiBDb3BpZXMgdGhlIHgsIHksIHdpZHRoIGFuZCBoZWlnaHQgcHJvcGVydGllcyBmcm9tIHRoaXMgUmVjdGFuZ2xlIHRvIGFueSBnaXZlbiBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNjb3B5VG8KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBvYmplY3QgdG8gY29weSB0by4KICAgICogQHJldHVybiB7b2JqZWN0fSBUaGlzIG9iamVjdC4KICAgICoqLwogICAgY29weVRvOiBmdW5jdGlvbiAoZGVzdCkgewoKICAgICAgICBkZXN0LnggPSB0aGlzLng7CiAgICAgICAgZGVzdC55ID0gdGhpcy55OwogICAgICAgIGRlc3Qud2lkdGggPSB0aGlzLndpZHRoOwogICAgICAgIGRlc3QuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7CgogICAgICAgIHJldHVybiBkZXN0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEluY3JlYXNlcyB0aGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBieSB0aGUgc3BlY2lmaWVkIGFtb3VudHMuIFRoZSBjZW50ZXIgcG9pbnQgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3Qgc3RheXMgdGhlIHNhbWUsIGFuZCBpdHMgc2l6ZSBpbmNyZWFzZXMgdG8gdGhlIGxlZnQgYW5kIHJpZ2h0IGJ5IHRoZSBkeCB2YWx1ZSwgYW5kIHRvIHRoZSB0b3AgYW5kIHRoZSBib3R0b20gYnkgdGhlIGR5IHZhbHVlLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjaW5mbGF0ZQogICAgKiBAcGFyYW0ge251bWJlcn0gZHggLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIFJlY3RhbmdsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGR5IC0gVGhlIGFtb3VudCB0byBiZSBhZGRlZCB0byB0aGUgYm90dG9tIHNpZGUgb2YgdGhlIFJlY3RhbmdsZS4KICAgICogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gVGhpcyBSZWN0YW5nbGUgb2JqZWN0LgogICAgKi8KICAgIGluZmxhdGU6IGZ1bmN0aW9uIChkeCwgZHkpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlKHRoaXMsIGR4LCBkeSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCwgZXhwcmVzc2VkIGFzIGEgUG9pbnQgb2JqZWN0IHdpdGggdGhlIHZhbHVlcyBvZiB0aGUgd2lkdGggYW5kIGhlaWdodCBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjc2l6ZQogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dHB1dF0gLSBPcHRpb25hbCBQb2ludCBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gVGhlIHNpemUgb2YgdGhlIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqLwogICAgc2l6ZTogZnVuY3Rpb24gKG91dHB1dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLnNpemUodGhpcywgb3V0cHV0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgYXMgdGhlIG9yaWdpbmFsIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNjbG9uZQogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRwdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoZSBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IAogICAgKi8KICAgIGNsb25lOiBmdW5jdGlvbiAob3V0cHV0KSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuY2xvbmUodGhpcywgb3V0cHV0KTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgc3BlY2lmaWVkIGNvb3JkaW5hdGVzIGFyZSBjb250YWluZWQgd2l0aGluIHRoZSByZWdpb24gZGVmaW5lZCBieSB0aGlzIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNjb250YWlucwogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgcG9pbnQgdG8gdGVzdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGNvbnRhaW5zIHRoZSBzcGVjaWZpZWQgcG9pbnQ7IG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjb250YWluczogZnVuY3Rpb24gKHgsIHkpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS5jb250YWlucyh0aGlzLCB4LCB5KTsKICAgIH0sCgogICAgLyoqCiAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZmlyc3QgUmVjdGFuZ2xlIG9iamVjdCBpcyBmdWxseSBjb250YWluZWQgd2l0aGluIHRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQSBSZWN0YW5nbGUgb2JqZWN0IGlzIHNhaWQgdG8gY29udGFpbiBhbm90aGVyIGlmIHRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdCBmYWxscyBlbnRpcmVseSB3aXRoaW4gdGhlIGJvdW5kYXJpZXMgb2YgdGhlIGZpcnN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUjY29udGFpbnNSZWN0CiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGNvbnRhaW5zIHRoZSBzcGVjaWZpZWQgcG9pbnQ7IG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBjb250YWluc1JlY3Q6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSZWN0KHRoaXMsIGIpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gUmVjdGFuZ2xlcyBhcmUgZXF1YWwuCiAgICAqIFRoaXMgbWV0aG9kIGNvbXBhcmVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgb2YgZWFjaCBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNlcXVhbHMKICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgogICAgKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHR3byBSZWN0YW5nbGVzIGhhdmUgZXhhY3RseSB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXM7IG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBlcXVhbHM6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuZXF1YWxzKHRoaXMsIGIpOwogICAgfSwKCiAgICAvKioKICAgICogSWYgdGhlIFJlY3RhbmdsZSBvYmplY3Qgc3BlY2lmaWVkIGluIHRoZSB0b0ludGVyc2VjdCBwYXJhbWV0ZXIgaW50ZXJzZWN0cyB3aXRoIHRoaXMgUmVjdGFuZ2xlIG9iamVjdCwgcmV0dXJucyB0aGUgYXJlYSBvZiBpbnRlcnNlY3Rpb24gYXMgYSBSZWN0YW5nbGUgb2JqZWN0LiBJZiB0aGUgUmVjdGFuZ2xlcyBkbyBub3QgaW50ZXJzZWN0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IFJlY3RhbmdsZSBvYmplY3Qgd2l0aCBpdHMgcHJvcGVydGllcyBzZXQgdG8gMC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI2ludGVyc2VjdGlvbgogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGIgLSBUaGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gb3V0IC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIGludGVyc2VjdGlvbiB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KICAgICogQHJldHVybiB7UGhhc2VyLlJlY3RhbmdsZX0gQSBSZWN0YW5nbGUgb2JqZWN0IHRoYXQgZXF1YWxzIHRoZSBhcmVhIG9mIGludGVyc2VjdGlvbi4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0OyB0aGF0IGlzLCBhIFJlY3RhbmdsZSB3aXRoIGl0cyB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIHNldCB0byAwLgogICAgKi8KICAgIGludGVyc2VjdGlvbjogZnVuY3Rpb24gKGIsIG91dCkgewogICAgICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdGlvbih0aGlzLCBiLCBvdXRwdXQpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSB0d28gUmVjdGFuZ2xlcyBpbnRlcnNlY3Qgd2l0aCBlYWNoIG90aGVyLgogICAgKiBUaGlzIG1ldGhvZCBjaGVja3MgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgb2YgdGhlIFJlY3RhbmdsZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNpbnRlcnNlY3RzCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRvbGVyYW5jZSAtIEEgdG9sZXJhbmNlIHZhbHVlIHRvIGFsbG93IGZvciBhbiBpbnRlcnNlY3Rpb24gdGVzdCB3aXRoIHBhZGRpbmcsIGRlZmF1bHQgdG8gMC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3Q7IG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBpbnRlcnNlY3RzOiBmdW5jdGlvbiAoYiwgdG9sZXJhbmNlKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyh0aGlzLCBiLCB0b2xlcmFuY2UpOwogICAgfSwKCiAgICAvKioKICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBvYmplY3Qgc3BlY2lmaWVkIGludGVyc2VjdHMgKG92ZXJsYXBzKSB3aXRoIHRoZSBnaXZlbiB2YWx1ZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZSNpbnRlcnNlY3RzUmF3CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBsZWZ0IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByaWdodCAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gdG9wIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBib3R0b210IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBBIHRvbGVyYW5jZSB2YWx1ZSB0byBhbGxvdyBmb3IgYW4gaW50ZXJzZWN0aW9uIHRlc3Qgd2l0aCBwYWRkaW5nLCBkZWZhdWx0IHRvIDAKICAgICogQHJldHVybiB7Ym9vbGVhbn0gQSB2YWx1ZSBvZiB0cnVlIGlmIHRoZSBzcGVjaWZpZWQgb2JqZWN0IGludGVyc2VjdHMgd2l0aCB0aGUgUmVjdGFuZ2xlOyBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgaW50ZXJzZWN0c1JhdzogZnVuY3Rpb24gKGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbSwgdG9sZXJhbmNlKSB7CiAgICAgICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0c1Jhdyh0aGlzLCBsZWZ0LCByaWdodCwgdG9wLCBib3R0b20sIHRvbGVyYW5jZSk7CiAgICB9LAoKICAgIC8qKgogICAgKiBBZGRzIHR3byBSZWN0YW5nbGVzIHRvZ2V0aGVyIHRvIGNyZWF0ZSBhIG5ldyBSZWN0YW5nbGUgb2JqZWN0LCBieSBmaWxsaW5nIGluIHRoZSBob3Jpem9udGFsIGFuZCB2ZXJ0aWNhbCBzcGFjZSBiZXR3ZWVuIHRoZSB0d28gUmVjdGFuZ2xlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3VuaW9uCiAgICAqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KICAgICogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSBuZXcgdmFsdWVzIHdpbGwgYmUgc2V0IGludG8gdGhpcyBvYmplY3QsIG90aGVyd2lzZSBhIGJyYW5kIG5ldyBSZWN0YW5nbGUgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IEEgUmVjdGFuZ2xlIG9iamVjdCB0aGF0IGlzIHRoZSB1bmlvbiBvZiB0aGUgdHdvIFJlY3RhbmdsZXMuCiAgICAqLwogICAgdW5pb246IGZ1bmN0aW9uIChiLCBvdXQpIHsKICAgICAgICByZXR1cm4gUGhhc2VyLlJlY3RhbmdsZS51bmlvbih0aGlzLCBiLCBvdXQpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhIHN0cmluZyByZXByZXNlbnRhdGlvbiBvZiB0aGlzIG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlI3RvU3RyaW5nCiAgICAqIEByZXR1cm4ge3N0cmluZ30gQSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGluc3RhbmNlLgogICAgKiovCiAgICB0b1N0cmluZzogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAiW3tSZWN0YW5nbGUgKHg9IiArIHRoaXMueCArICIgeT0iICsgdGhpcy55ICsgIiB3aWR0aD0iICsgdGhpcy53aWR0aCArICIgaGVpZ2h0PSIgKyB0aGlzLmhlaWdodCArICIgZW1wdHk9IiArIHRoaXMuZW1wdHkgKyAiKX1dIjsKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2hhbGZXaWR0aAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoYWxmV2lkdGggLSBIYWxmIG9mIHRoZSB3aWR0aCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJoYWxmV2lkdGgiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQodGhpcy53aWR0aCAvIDIpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2hhbGZIZWlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gaGFsZkhlaWdodCAtIEhhbGYgb2YgdGhlIGhlaWdodCBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJoYWxmSGVpZ2h0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLnJvdW5kKHRoaXMuaGVpZ2h0IC8gMik7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgYm90dG9tIHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLCBidXQgZG9lcyBjaGFuZ2UgdGhlIGhlaWdodCBwcm9wZXJ0eS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oZWlnaHQ7CiAgICB9LAogIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPD0gdGhpcy55KSB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9ICh0aGlzLnkgLSB2YWx1ZSk7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgYm90dG9tIHJpZ2h0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2JvdHRvbQoqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBib3R0b21SaWdodCAtIEdldHMgb3Igc2V0cyB0aGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgYm90dG9tIHJpZ2h0IGNvcm5lciBhcyBhIFBvaW50IG9iamVjdC4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5SZWN0YW5nbGUucHJvdG90eXBlLCAiYm90dG9tUmlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlBvaW50KHRoaXMucmlnaHQsIHRoaXMuYm90dG9tKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnJpZ2h0ID0gdmFsdWUueDsKICAgICAgICB0aGlzLmJvdHRvbSA9IHZhbHVlLnk7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGxlZnQgb2YgdGhlIFJlY3RhbmdsZS4gQ2hhbmdpbmcgdGhlIGxlZnQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eSwgd2hlcmVhcyBjaGFuZ2luZyB0aGUgeCB2YWx1ZSBkb2VzIG5vdCBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjbGVmdAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZWZ0IC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgbGVmdCBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJsZWZ0IiwgewogICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLng7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlID49IHRoaXMucmlnaHQpIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IHRoaXMucmlnaHQgLSB2YWx1ZTsKICAgICAgICB9CiAgICAgICAgdGhpcy54ID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBzdW0gb2YgdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMsIGhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJyaWdodCIsIHsKICAgICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMud2lkdGg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlIDw9IHRoaXMueCkgewogICAgICAgICAgICB0aGlzLndpZHRoID0gMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLndpZHRoID0gdGhpcy54ICsgdmFsdWU7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBUaGUgdm9sdW1lIG9mIHRoZSBSZWN0YW5nbGUgZGVyaXZlZCBmcm9tIHdpZHRoICogaGVpZ2h0LgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjdm9sdW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IHZvbHVtZSAtIFRoZSB2b2x1bWUgb2YgdGhlIFJlY3RhbmdsZSBkZXJpdmVkIGZyb20gd2lkdGggKiBoZWlnaHQuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgInZvbHVtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMud2lkdGggKiB0aGlzLmhlaWdodDsKICAgIH0KCn0pOwoKLyoqCiogVGhlIHBlcmltZXRlciBzaXplIG9mIHRoZSBSZWN0YW5nbGUuIFRoaXMgaXMgdGhlIHN1bSBvZiBhbGwgNCBzaWRlcy4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI3BlcmltZXRlcgoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwZXJpbWV0ZXIgLSBUaGUgcGVyaW1ldGVyIHNpemUgb2YgdGhlIFJlY3RhbmdsZS4gVGhpcyBpcyB0aGUgc3VtIG9mIGFsbCA0IHNpZGVzLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJwZXJpbWV0ZXIiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy53aWR0aCAqIDIpICsgKHRoaXMuaGVpZ2h0ICogMik7CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqIEBuYW1lIFBoYXNlci5SZWN0YW5nbGUjY2VudGVyWAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBjZW50ZXJYIC0gVGhlIHggY29vcmRpbmF0ZSBvZiB0aGUgY2VudGVyIG9mIHRoZSBSZWN0YW5nbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImNlbnRlclgiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnggKyB0aGlzLmhhbGZXaWR0aDsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLnggPSB2YWx1ZSAtIHRoaXMuaGFsZldpZHRoOwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBjZW50ZXIgb2YgdGhlIFJlY3RhbmdsZS4KKiBAbmFtZSBQaGFzZXIuUmVjdGFuZ2xlI2NlbnRlclkKKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIFRoZSB5IGNvb3JkaW5hdGUgb2YgdGhlIGNlbnRlciBvZiB0aGUgUmVjdGFuZ2xlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJjZW50ZXJZIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMueSA9IHZhbHVlIC0gdGhpcy5oYWxmSGVpZ2h0OwogICAgfQoKfSk7CgovKioKKiBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSB0b3Agb2YgdGhlIFJlY3RhbmdsZS4gQ2hhbmdpbmcgdGhlIHRvcCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4KKiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSBoZWlnaHQgcHJvcGVydHksIHdoZXJlYXMgY2hhbmdpbmcgdGhlIHkgdmFsdWUgZG9lcyBub3QgYWZmZWN0IHRoZSBoZWlnaHQgcHJvcGVydHkuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSN0b3AKKiBAcHJvcGVydHkge251bWJlcn0gdG9wIC0gVGhlIHkgY29vcmRpbmF0ZSBvZiB0aGUgdG9wIG9mIHRoZSBSZWN0YW5nbGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgInRvcCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgPj0gdGhpcy5ib3R0b20pIHsKICAgICAgICAgICAgdGhpcy5oZWlnaHQgPSAwOwogICAgICAgICAgICB0aGlzLnkgPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9ICh0aGlzLmJvdHRvbSAtIHZhbHVlKTsKICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIFRoZSBsb2NhdGlvbiBvZiB0aGUgUmVjdGFuZ2xlcyB0b3AgbGVmdCBjb3JuZXIgYXMgYSBQb2ludCBvYmplY3QuCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSN0b3BMZWZ0CiogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHRvcExlZnQgLSBUaGUgbG9jYXRpb24gb2YgdGhlIFJlY3RhbmdsZXMgdG9wIGxlZnQgY29ybmVyIGFzIGEgUG9pbnQgb2JqZWN0LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlJlY3RhbmdsZS5wcm90b3R5cGUsICJ0b3BMZWZ0IiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUGhhc2VyLlBvaW50KHRoaXMueCwgdGhpcy55KTsKICAgIH0sCiAgICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy54ID0gdmFsdWUueDsKICAgICAgICB0aGlzLnkgPSB2YWx1ZS55OwogICAgfQoKfSk7CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgb3Igbm90IHRoaXMgUmVjdGFuZ2xlIG9iamVjdCBpcyBlbXB0eS4gQSBSZWN0YW5nbGUgb2JqZWN0IGlzIGVtcHR5IGlmIGl0cyB3aWR0aCBvciBoZWlnaHQgaXMgbGVzcyB0aGFuIG9yIGVxdWFsIHRvIDAuCiogSWYgc2V0IHRvIHRydWUgdGhlbiBhbGwgb2YgdGhlIFJlY3RhbmdsZSBwcm9wZXJ0aWVzIGFyZSBzZXQgdG8gMC4gCiogQG5hbWUgUGhhc2VyLlJlY3RhbmdsZSNlbXB0eQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1wdHkgLSBHZXRzIG9yIHNldHMgdGhlIFJlY3RhbmdsZXMgZW1wdHkgc3RhdGUuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUmVjdGFuZ2xlLnByb3RvdHlwZSwgImVtcHR5IiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKCF0aGlzLndpZHRoIHx8ICF0aGlzLmhlaWdodCk7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5zZXRUbygwLCAwLCAwLCAwKTsKICAgIH0KCn0pOwoKLyoqCiogSW5jcmVhc2VzIHRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0IGJ5IHRoZSBzcGVjaWZpZWQgYW1vdW50cy4gVGhlIGNlbnRlciBwb2ludCBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBzdGF5cyB0aGUgc2FtZSwgYW5kIGl0cyBzaXplIGluY3JlYXNlcyB0byB0aGUgbGVmdCBhbmQgcmlnaHQgYnkgdGhlIGR4IHZhbHVlLCBhbmQgdG8gdGhlIHRvcCBhbmQgdGhlIGJvdHRvbSBieSB0aGUgZHkgdmFsdWUuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGUKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0gZHggLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBsZWZ0IHNpZGUgb2YgdGhlIFJlY3RhbmdsZS4KKiBAcGFyYW0ge251bWJlcn0gZHkgLSBUaGUgYW1vdW50IHRvIGJlIGFkZGVkIHRvIHRoZSBib3R0b20gc2lkZSBvZiB0aGUgUmVjdGFuZ2xlLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlID0gZnVuY3Rpb24gKGEsIGR4LCBkeSkgewogICAgYS54IC09IGR4OwogICAgYS53aWR0aCArPSAyICogZHg7CiAgICBhLnkgLT0gZHk7CiAgICBhLmhlaWdodCArPSAyICogZHk7CiAgICByZXR1cm4gYTsKfTsKCi8qKgoqIEluY3JlYXNlcyB0aGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4gVGhpcyBtZXRob2QgaXMgc2ltaWxhciB0byB0aGUgUmVjdGFuZ2xlLmluZmxhdGUoKSBtZXRob2QgZXhjZXB0IGl0IHRha2VzIGEgUG9pbnQgb2JqZWN0IGFzIGEgcGFyYW1ldGVyLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbmZsYXRlUG9pbnQKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcG9pbnQgLSBUaGUgeCBwcm9wZXJ0eSBvZiB0aGlzIFBvaW50IG9iamVjdCBpcyB1c2VkIHRvIGluY3JlYXNlIHRoZSBob3Jpem9udGFsIGRpbWVuc2lvbiBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdC4gVGhlIHkgcHJvcGVydHkgaXMgdXNlZCB0byBpbmNyZWFzZSB0aGUgdmVydGljYWwgZGltZW5zaW9uIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IFRoZSBSZWN0YW5nbGUgb2JqZWN0LgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmluZmxhdGVQb2ludCA9IGZ1bmN0aW9uIChhLCBwb2ludCkgewogICAgcmV0dXJuIFBoYXNlci5SZWN0YW5nbGUuaW5mbGF0ZShhLCBwb2ludC54LCBwb2ludC55KTsKfTsKCi8qKgoqIFRoZSBzaXplIG9mIHRoZSBSZWN0YW5nbGUgb2JqZWN0LCBleHByZXNzZWQgYXMgYSBQb2ludCBvYmplY3Qgd2l0aCB0aGUgdmFsdWVzIG9mIHRoZSB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLnNpemUKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gW291dHB1dF0gLSBPcHRpb25hbCBQb2ludCBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUG9pbnQgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgcmV0dXJuZWQuCiogQHJldHVybiB7UGhhc2VyLlBvaW50fSBUaGUgc2l6ZSBvZiB0aGUgUmVjdGFuZ2xlIG9iamVjdAoqLwpQaGFzZXIuUmVjdGFuZ2xlLnNpemUgPSBmdW5jdGlvbiAoYSwgb3V0cHV0KSB7CiAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gbmV3IFBoYXNlci5Qb2ludCgpOyB9CiAgICByZXR1cm4gb3V0cHV0LnNldFRvKGEud2lkdGgsIGEuaGVpZ2h0KTsKfTsKCi8qKgoqIFJldHVybnMgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aXRoIHRoZSBzYW1lIHZhbHVlcyBmb3IgdGhlIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgYXMgdGhlIG9yaWdpbmFsIFJlY3RhbmdsZSBvYmplY3QuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNsb25lCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBbb3V0cHV0XSAtIE9wdGlvbmFsIFJlY3RhbmdsZSBvYmplY3QuIElmIGdpdmVuIHRoZSB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGUgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9CiovClBoYXNlci5SZWN0YW5nbGUuY2xvbmUgPSBmdW5jdGlvbiAoYSwgb3V0cHV0KSB7CiAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoKTsgfQogICAgcmV0dXJuIG91dHB1dC5zZXRUbyhhLngsIGEueSwgYS53aWR0aCwgYS5oZWlnaHQpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBzcGVjaWZpZWQgY29vcmRpbmF0ZXMgYXJlIGNvbnRhaW5lZCB3aXRoaW4gdGhlIHJlZ2lvbiBkZWZpbmVkIGJ5IHRoaXMgUmVjdGFuZ2xlIG9iamVjdC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnMKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgb2YgdGhlIHBvaW50IHRvIHRlc3QuCiogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIG9mIHRoZSBwb2ludCB0byB0ZXN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnMgPSBmdW5jdGlvbiAoYSwgeCwgeSkgewogICAgcmV0dXJuICh4ID49IGEueCAmJiB4IDw9IGEucmlnaHQgJiYgeSA+PSBhLnkgJiYgeSA8PSBhLmJvdHRvbSk7Cn07CgpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUmF3ID0gZnVuY3Rpb24gKHJ4LCByeSwgcncsIHJoLCB4LCB5KSB7CiAgICByZXR1cm4gKHggPj0gcnggJiYgeCA8PSAocnggKyBydykgJiYgeSA+PSByeSAmJiB5IDw9IChyeSArIHJoKSk7Cn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHNwZWNpZmllZCBwb2ludCBpcyBjb250YWluZWQgd2l0aGluIHRoZSByZWN0YW5ndWxhciByZWdpb24gZGVmaW5lZCBieSB0aGlzIFJlY3RhbmdsZSBvYmplY3QuIFRoaXMgbWV0aG9kIGlzIHNpbWlsYXIgdG8gdGhlIFJlY3RhbmdsZS5jb250YWlucygpIG1ldGhvZCwgZXhjZXB0IHRoYXQgaXQgdGFrZXMgYSBQb2ludCBvYmplY3QgYXMgYSBwYXJhbWV0ZXIuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUG9pbnQKKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IGEgLSBUaGUgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5Qb2ludH0gcG9pbnQgLSBUaGUgcG9pbnQgb2JqZWN0IGJlaW5nIGNoZWNrZWQuIENhbiBiZSBQb2ludCBvciBhbnkgb2JqZWN0IHdpdGggLnggYW5kIC55IHZhbHVlcy4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIFJlY3RhbmdsZSBvYmplY3QgY29udGFpbnMgdGhlIHNwZWNpZmllZCBwb2ludDsgb3RoZXJ3aXNlIGZhbHNlLgoqLwpQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zUG9pbnQgPSBmdW5jdGlvbiAoYSwgcG9pbnQpIHsKICAgIHJldHVybiBQaGFzZXIuUmVjdGFuZ2xlLmNvbnRhaW5zKGEsIHBvaW50LngsIHBvaW50LnkpOwp9OwoKLyoqCiogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0IGlzIGZ1bGx5IGNvbnRhaW5lZCB3aXRoaW4gdGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEEgUmVjdGFuZ2xlIG9iamVjdCBpcyBzYWlkIHRvIGNvbnRhaW4gYW5vdGhlciBpZiB0aGUgc2Vjb25kIFJlY3RhbmdsZSBvYmplY3QgZmFsbHMgZW50aXJlbHkgd2l0aGluIHRoZSBib3VuZGFyaWVzIG9mIHRoZSBmaXJzdC4KKiBAbWV0aG9kIFBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSZWN0CiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgUmVjdGFuZ2xlIG9iamVjdCBjb250YWlucyB0aGUgc3BlY2lmaWVkIHBvaW50OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuY29udGFpbnNSZWN0ID0gZnVuY3Rpb24gKGEsIGIpIHsKCiAgICAvLyAgSWYgdGhlIGdpdmVuIHJlY3QgaGFzIGEgbGFyZ2VyIHZvbHVtZSB0aGFuIHRoaXMgb25lIHRoZW4gaXQgY2FuIG5ldmVyIGNvbnRhaW4gaXQKICAgIGlmIChhLnZvbHVtZSA+IGIudm9sdW1lKQogICAgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gKGEueCA+PSBiLnggJiYgYS55ID49IGIueSAmJiBhLnJpZ2h0IDw9IGIucmlnaHQgJiYgYS5ib3R0b20gPD0gYi5ib3R0b20pOwoKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgdHdvIFJlY3RhbmdsZXMgYXJlIGVxdWFsLgoqIFRoaXMgbWV0aG9kIGNvbXBhcmVzIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgb2YgZWFjaCBSZWN0YW5nbGUuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmVxdWFscwoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHR3byBSZWN0YW5nbGVzIGhhdmUgZXhhY3RseSB0aGUgc2FtZSB2YWx1ZXMgZm9yIHRoZSB4LCB5LCB3aWR0aCBhbmQgaGVpZ2h0IHByb3BlcnRpZXM7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5lcXVhbHMgPSBmdW5jdGlvbiAoYSwgYikgewogICAgcmV0dXJuIChhLnggPT0gYi54ICYmIGEueSA9PSBiLnkgJiYgYS53aWR0aCA9PSBiLndpZHRoICYmIGEuaGVpZ2h0ID09IGIuaGVpZ2h0KTsKfTsKCi8qKgoqIElmIHRoZSBSZWN0YW5nbGUgb2JqZWN0IHNwZWNpZmllZCBpbiB0aGUgdG9JbnRlcnNlY3QgcGFyYW1ldGVyIGludGVyc2VjdHMgd2l0aCB0aGlzIFJlY3RhbmdsZSBvYmplY3QsIHJldHVybnMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uIGFzIGEgUmVjdGFuZ2xlIG9iamVjdC4gSWYgdGhlIFJlY3RhbmdsZXMgZG8gbm90IGludGVyc2VjdCwgdGhpcyBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBSZWN0YW5nbGUgb2JqZWN0IHdpdGggaXRzIHByb3BlcnRpZXMgc2V0IHRvIDAuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdGlvbgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYSAtIFRoZSBmaXJzdCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gYiAtIFRoZSBzZWNvbmQgUmVjdGFuZ2xlIG9iamVjdC4KKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IFtvdXRdIC0gT3B0aW9uYWwgUmVjdGFuZ2xlIG9iamVjdC4gSWYgZ2l2ZW4gdGhlIGludGVyc2VjdGlvbiB2YWx1ZXMgd2lsbCBiZSBzZXQgaW50byB0aGlzIG9iamVjdCwgb3RoZXJ3aXNlIGEgYnJhbmQgbmV3IFJlY3RhbmdsZSBvYmplY3Qgd2lsbCBiZSBjcmVhdGVkIGFuZCByZXR1cm5lZC4KKiBAcmV0dXJuIHtQaGFzZXIuUmVjdGFuZ2xlfSBBIFJlY3RhbmdsZSBvYmplY3QgdGhhdCBlcXVhbHMgdGhlIGFyZWEgb2YgaW50ZXJzZWN0aW9uLiBJZiB0aGUgUmVjdGFuZ2xlcyBkbyBub3QgaW50ZXJzZWN0LCB0aGlzIG1ldGhvZCByZXR1cm5zIGFuIGVtcHR5IFJlY3RhbmdsZSBvYmplY3Q7IHRoYXQgaXMsIGEgUmVjdGFuZ2xlIHdpdGggaXRzIHgsIHksIHdpZHRoLCBhbmQgaGVpZ2h0IHByb3BlcnRpZXMgc2V0IHRvIDAuCiovClBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24gKGEsIGIsIG91dCkgewoKICAgIG91dCAgPSBvdXQgfHwgbmV3IFBoYXNlci5SZWN0YW5nbGU7CgogICAgaWYgKFBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyhhLCBiKSkKICAgIHsKICAgICAgICBvdXQueCA9IE1hdGgubWF4KGEueCwgYi54KTsKICAgICAgICBvdXQueSA9IE1hdGgubWF4KGEueSwgYi55KTsKICAgICAgICBvdXQud2lkdGggPSBNYXRoLm1pbihhLnJpZ2h0LCBiLnJpZ2h0KSAtIG91dC54OwogICAgICAgIG91dC5oZWlnaHQgPSBNYXRoLm1pbihhLmJvdHRvbSwgYi5ib3R0b20pIC0gb3V0Lnk7CiAgICB9CgogICAgcmV0dXJuIG91dDsKCn07CgovKioKKiBEZXRlcm1pbmVzIHdoZXRoZXIgdGhlIHR3byBSZWN0YW5nbGVzIGludGVyc2VjdCB3aXRoIGVhY2ggb3RoZXIuCiogVGhpcyBtZXRob2QgY2hlY2tzIHRoZSB4LCB5LCB3aWR0aCwgYW5kIGhlaWdodCBwcm9wZXJ0aWVzIG9mIHRoZSBSZWN0YW5nbGVzLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEByZXR1cm4ge2Jvb2xlYW59IEEgdmFsdWUgb2YgdHJ1ZSBpZiB0aGUgc3BlY2lmaWVkIG9iamVjdCBpbnRlcnNlY3RzIHdpdGggdGhpcyBSZWN0YW5nbGUgb2JqZWN0OyBvdGhlcndpc2UgZmFsc2UuCiovClBoYXNlci5SZWN0YW5nbGUuaW50ZXJzZWN0cyA9IGZ1bmN0aW9uIChhLCBiKSB7CgogICAgcmV0dXJuIChhLnggPCBiLnJpZ2h0ICYmIGIueCA8IGEucmlnaHQgJiYgYS55IDwgYi5ib3R0b20gJiYgYi55IDwgYS5ib3R0b20pOwoKICAgIC8vIHJldHVybiAoYS54IDw9IGIucmlnaHQgJiYgYi54IDw9IGEucmlnaHQgJiYgYS55IDw9IGIuYm90dG9tICYmIGIueSA8PSBhLmJvdHRvbSk7CgogICAgLy8gcmV0dXJuIChhLmxlZnQgPD0gYi5yaWdodCAmJiBiLmxlZnQgPD0gYS5yaWdodCAmJiBhLnRvcCA8PSBiLmJvdHRvbSAmJiBiLnRvcCA8PSBhLmJvdHRvbSk7CiAgICAvLyByZXR1cm4gIShhLnggPiBiLnJpZ2h0ICsgdG9sZXJhbmNlIHx8IGEucmlnaHQgPCBiLnggLSB0b2xlcmFuY2UgfHwgYS55ID4gYi5ib3R0b20gKyB0b2xlcmFuY2UgfHwgYS5ib3R0b20gPCBiLnkgLSB0b2xlcmFuY2UpOwoKfTsKCi8qKgoqIERldGVybWluZXMgd2hldGhlciB0aGUgb2JqZWN0IHNwZWNpZmllZCBpbnRlcnNlY3RzIChvdmVybGFwcykgd2l0aCB0aGUgZ2l2ZW4gdmFsdWVzLgoqIEBtZXRob2QgUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzUmF3CiogQHBhcmFtIHtudW1iZXJ9IGxlZnQgLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gcmlnaHQgLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gdG9wIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IGJvdHRvbSAtIERlc2NyaXB0aW9uLgoqIEBwYXJhbSB7bnVtYmVyfSB0b2xlcmFuY2UgLSBBIHRvbGVyYW5jZSB2YWx1ZSB0byBhbGxvdyBmb3IgYW4gaW50ZXJzZWN0aW9uIHRlc3Qgd2l0aCBwYWRkaW5nLCBkZWZhdWx0IHRvIDAKKiBAcmV0dXJuIHtib29sZWFufSBBIHZhbHVlIG9mIHRydWUgaWYgdGhlIHNwZWNpZmllZCBvYmplY3QgaW50ZXJzZWN0cyB3aXRoIHRoZSBSZWN0YW5nbGU7IG90aGVyd2lzZSBmYWxzZS4KKi8KUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzUmF3ID0gZnVuY3Rpb24gKGEsIGxlZnQsIHJpZ2h0LCB0b3AsIGJvdHRvbSwgdG9sZXJhbmNlKSB7CgogICAgaWYgKHR5cGVvZiB0b2xlcmFuY2UgPT09ICJ1bmRlZmluZWQiKSB7IHRvbGVyYW5jZSA9IDA7IH0KCiAgICByZXR1cm4gIShsZWZ0ID4gYS5yaWdodCArIHRvbGVyYW5jZSB8fCByaWdodCA8IGEubGVmdCAtIHRvbGVyYW5jZSB8fCB0b3AgPiBhLmJvdHRvbSArIHRvbGVyYW5jZSB8fCBib3R0b20gPCBhLnRvcCAtIHRvbGVyYW5jZSk7Cgp9OwoKLyoqCiogQWRkcyB0d28gUmVjdGFuZ2xlcyB0b2dldGhlciB0byBjcmVhdGUgYSBuZXcgUmVjdGFuZ2xlIG9iamVjdCwgYnkgZmlsbGluZyBpbiB0aGUgaG9yaXpvbnRhbCBhbmQgdmVydGljYWwgc3BhY2UgYmV0d2VlbiB0aGUgdHdvIFJlY3RhbmdsZXMuCiogQG1ldGhvZCBQaGFzZXIuUmVjdGFuZ2xlLnVuaW9uCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBhIC0gVGhlIGZpcnN0IFJlY3RhbmdsZSBvYmplY3QuCiogQHBhcmFtIHtQaGFzZXIuUmVjdGFuZ2xlfSBiIC0gVGhlIHNlY29uZCBSZWN0YW5nbGUgb2JqZWN0LgoqIEBwYXJhbSB7UGhhc2VyLlJlY3RhbmdsZX0gW291dF0gLSBPcHRpb25hbCBSZWN0YW5nbGUgb2JqZWN0LiBJZiBnaXZlbiB0aGUgbmV3IHZhbHVlcyB3aWxsIGJlIHNldCBpbnRvIHRoaXMgb2JqZWN0LCBvdGhlcndpc2UgYSBicmFuZCBuZXcgUmVjdGFuZ2xlIG9iamVjdCB3aWxsIGJlIGNyZWF0ZWQgYW5kIHJldHVybmVkLgoqIEByZXR1cm4ge1BoYXNlci5SZWN0YW5nbGV9IEEgUmVjdGFuZ2xlIG9iamVjdCB0aGF0IGlzIHRoZSB1bmlvbiBvZiB0aGUgdHdvIFJlY3RhbmdsZXMuCiovClBoYXNlci5SZWN0YW5nbGUudW5pb24gPSBmdW5jdGlvbiAoYSwgYiwgb3V0KSB7CgogICAgaWYgKHR5cGVvZiBvdXQgPT09ICJ1bmRlZmluZWQiKSB7IG91dCA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCk7IH0KCiAgICByZXR1cm4gb3V0LnNldFRvKE1hdGgubWluKGEueCwgYi54KSwgTWF0aC5taW4oYS55LCBiLnkpLCBNYXRoLm1heChhLnJpZ2h0LCBiLnJpZ2h0KSAtIE1hdGgubWluKGEubGVmdCwgYi5sZWZ0KSwgTWF0aC5tYXgoYS5ib3R0b20sIGIuYm90dG9tKSAtIE1hdGgubWluKGEudG9wLCBiLnRvcCkpOwogICAgCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBDcmVhdGVzIGEgbmV3IFBvbHlnb24uIFlvdSBoYXZlIHRvIHByb3ZpZGUgYSBsaXN0IG9mIHBvaW50cy4KKiBUaGlzIGNhbiBiZSBhbiBhcnJheSBvZiBQb2ludHMgdGhhdCBmb3JtIHRoZSBwb2x5Z29uLCBhIGZsYXQgYXJyYXkgb2YgbnVtYmVycyB0aGF0IHdpbGwgYmUgaW50ZXJwcmV0ZWQgYXMgW3gseSwgeCx5LCAuLi5dLCAKKiBvciB0aGUgYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUgYWxsIHRoZSBwb2ludHMgb2YgdGhlIHBvbHlnb24gZS5nLiBgbmV3IFBJWEkuUG9seWdvbihuZXcgUElYSS5Qb2ludCgpLCBuZXcgUElYSS5Qb2ludCgpLCAuLi4pYCwgb3IgdGhlCiogYXJndW1lbnRzIHBhc3NlZCBjYW4gYmUgZmxhdCB4LHkgdmFsdWVzIGUuZy4gYG5ldyBQSVhJLlBvbHlnb24oeCx5LCB4LHksIHgseSwgLi4uKWAgd2hlcmUgYHhgIGFuZCBgeWAgYXJlIG51bWJlcnMuCioKKiBAY2xhc3MgUGhhc2VyLlBvbHlnb24KKiBAY2xhc3NkZXNjIFRoZSBwb2x5Z29uIHJlcHJlc2VudHMgYSBsaXN0IG9mIG9yZGVyZGVkIHBvaW50cyBpbiBzcGFjZQoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7QXJyYXk8UGhhc2VyLlBvaW50PnxBcnJheTxudW1iZXI+fSBwb2ludHMgLSBUaGUgYXJyYXkgb2YgUG9pbnRzLgoqLwpQaGFzZXIuUG9seWdvbiA9IGZ1bmN0aW9uIChwb2ludHMpIHsKCiAgICBQSVhJLlBvbHlnb24uY2FsbCh0aGlzLCBwb2ludHMpOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gdHlwZSAtIFRoZSBiYXNlIG9iamVjdCB0eXBlLgoJKi8KICAgIHRoaXMudHlwZSA9IFBoYXNlci5QT0xZR09OOwoKfTsKClBoYXNlci5Qb2x5Z29uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUElYSS5Qb2x5Z29uLnByb3RvdHlwZSk7ClBoYXNlci5Qb2x5Z29uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5Qb2x5Z29uOwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBEZXNjcmlwdGlvbiBvZiBQaGFzZXIuTmV0CioKKiBAY2xhc3MgUGhhc2VyLk5ldAoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLk5ldCA9IGZ1bmN0aW9uIChnYW1lKSB7CgkKCXRoaXMuZ2FtZSA9IGdhbWU7Cgp9OwoKUGhhc2VyLk5ldC5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIFJldHVybnMgdGhlIGhvc3RuYW1lIGdpdmVuIGJ5IHRoZSBicm93c2VyLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTmV0I2dldEhvc3ROYW1lCgkqIEByZXR1cm4ge3N0cmluZ30KCSovICAgICAgICAKCWdldEhvc3ROYW1lOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh3aW5kb3cubG9jYXRpb24gJiYgd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lKSB7CgkJCXJldHVybiB3aW5kb3cubG9jYXRpb24uaG9zdG5hbWU7CgkJfQoKCQlyZXR1cm4gbnVsbDsKCgl9LAoKCS8qKgoJKiBDb21wYXJlcyB0aGUgZ2l2ZW4gZG9tYWluIG5hbWUgYWdhaW5zdCB0aGUgaG9zdG5hbWUgb2YgdGhlIGJyb3dzZXIgY29udGFpbmluZyB0aGUgZ2FtZS4KCSogSWYgdGhlIGRvbWFpbiBuYW1lIGlzIGZvdW5kIGl0IHJldHVybnMgdHJ1ZS4KCSogWW91IGNhbiBzcGVjaWZ5IGEgcGFydCBvZiBhIGRvbWFpbiwgZm9yIGV4YW1wbGUgJ2dvb2dsZScgd291bGQgbWF0Y2ggJ2dvb2dsZS5jb20nLCAnZ29vZ2xlLmNvLnVrJywgZXRjLgoJKiBEbyBub3QgaW5jbHVkZSAnaHR0cDovLycgYXQgdGhlIHN0YXJ0LgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTmV0I2NoZWNrRG9tYWluTmFtZQoJKiBAcGFyYW0ge3N0cmluZ30gZG9tYWluCgkqIEByZXR1cm4ge2Jvb2xlYW59CgkqLyAgICAgICAgCgljaGVja0RvbWFpbk5hbWU6IGZ1bmN0aW9uIChkb21haW4pIHsKCQlyZXR1cm4gd2luZG93LmxvY2F0aW9uLmhvc3RuYW1lLmluZGV4T2YoZG9tYWluKSAhPT0gLTE7Cgl9LAoKCS8qKgoJKiBVcGRhdGVzIGEgdmFsdWUgb24gdGhlIFF1ZXJ5IFN0cmluZyBhbmQgcmV0dXJucyBpdCBpbiBmdWxsLgoJKiBJZiB0aGUgdmFsdWUgZG9lc24ndCBhbHJlYWR5IGV4aXN0IGl0IGlzIHNldC4KCSogSWYgdGhlIHZhbHVlIGV4aXN0cyBpdCBpcyByZXBsYWNlZCB3aXRoIHRoZSBuZXcgdmFsdWUgZ2l2ZW4uIElmIHlvdSBkb24ndCBwcm92aWRlIGEgbmV3IHZhbHVlIGl0IGlzIHJlbW92ZWQgZnJvbSB0aGUgcXVlcnkgc3RyaW5nLgoJKiBPcHRpb25hbGx5IHlvdSBjYW4gcmVkaXJlY3QgdG8gdGhlIG5ldyB1cmwsIG9yIGp1c3QgcmV0dXJuIGl0IGFzIGEgc3RyaW5nLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTmV0I3VwZGF0ZVF1ZXJ5U3RyaW5nCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgcXVlcnlzdHJpbmcga2V5IHRvIHVwZGF0ZS4KCSogQHBhcmFtIHtzdHJpbmd9IHZhbHVlIC0gVGhlIG5ldyB2YWx1ZSB0byBiZSBzZXQuIElmIGl0IGFscmVhZHkgZXhpc3RzIGl0IHdpbGwgYmUgcmVwbGFjZWQuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gcmVkaXJlY3QgLSBJZiB0cnVlIHRoZSBicm93c2VyIHdpbGwgaXNzdWUgYSByZWRpcmVjdCB0byB0aGUgdXJsIHdpdGggdGhlIG5ldyBxdWVyeXN0cmluZy4KCSogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFRoZSBVUkwgdG8gbW9kaWZ5LiBJZiBub25lIGlzIGdpdmVuIGl0IHVzZXMgd2luZG93LmxvY2F0aW9uLmhyZWYuCgkqIEByZXR1cm4ge3N0cmluZ30gSWYgcmVkaXJlY3QgaXMgZmFsc2UgdGhlbiB0aGUgbW9kaWZpZWQgdXJsIGFuZCBxdWVyeSBzdHJpbmcgaXMgcmV0dXJuZWQuCgkqLwoJdXBkYXRlUXVlcnlTdHJpbmc6IGZ1bmN0aW9uIChrZXksIHZhbHVlLCByZWRpcmVjdCwgdXJsKSB7CgoJCWlmICh0eXBlb2YgcmVkaXJlY3QgPT09ICJ1bmRlZmluZWQiKSB7IHJlZGlyZWN0ID0gZmFsc2U7IH0KCQlpZiAodHlwZW9mIHVybCA9PT0gInVuZGVmaW5lZCIpIHsgdXJsID0gJyc7IH0KCgkJaWYgKHVybCA9PSAnJykgewoJCQl1cmwgPSB3aW5kb3cubG9jYXRpb24uaHJlZjsKCQl9CgoJCXZhciBvdXRwdXQgPSAnJzsKCQl2YXIgcmUgPSBuZXcgUmVnRXhwKCIoWz98Jl0pIiArIGtleSArICI9Lio/KCZ8I3wkKSguKikiLCAiZ2kiKTsKCQkKCQlpZiAocmUudGVzdCh1cmwpKQoJCXsKCQkJaWYgKHR5cGVvZiB2YWx1ZSAhPT0gJ3VuZGVmaW5lZCcgJiYgdmFsdWUgIT09IG51bGwpCgkJCXsKCQkJCW91dHB1dCA9IHVybC5yZXBsYWNlKHJlLCAnJDEnICsga2V5ICsgIj0iICsgdmFsdWUgKyAnJDIkMycpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJb3V0cHV0ID0gdXJsLnJlcGxhY2UocmUsICckMSQzJykucmVwbGFjZSgvKCZ8XD8pJC8sICcnKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlpZiAodHlwZW9mIHZhbHVlICE9PSAndW5kZWZpbmVkJyAmJiB2YWx1ZSAhPT0gbnVsbCkKCQkJewoJCQkJdmFyIHNlcGFyYXRvciA9IHVybC5pbmRleE9mKCc/JykgIT09IC0xID8gJyYnIDogJz8nOwoJCQkJdmFyIGhhc2ggPSB1cmwuc3BsaXQoJyMnKTsKCQkJCXVybCA9IGhhc2hbMF0gKyBzZXBhcmF0b3IgKyBrZXkgKyAnPScgKyB2YWx1ZTsKCgkJCQlpZiAoaGFzaFsxXSkgewoJCQkJCXVybCArPSAnIycgKyBoYXNoWzFdOwoJCQkJfQoKCQkJCW91dHB1dCA9IHVybDsKCgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlvdXRwdXQgPSB1cmw7CgkJCX0KCQl9CgoJCWlmIChyZWRpcmVjdCkKCQl7CgkJCXdpbmRvdy5sb2NhdGlvbi5ocmVmID0gb3V0cHV0OwoJCX0KCQllbHNlCgkJewoJCQlyZXR1cm4gb3V0cHV0OwoJCX0KCgl9LAoKCS8qKgoJKiBSZXR1cm5zIHRoZSBRdWVyeSBTdHJpbmcgYXMgYW4gb2JqZWN0LgoJKiBJZiB5b3Ugc3BlY2lmeSBhIHBhcmFtZXRlciBpdCB3aWxsIHJldHVybiBqdXN0IHRoZSB2YWx1ZSBvZiB0aGF0IHBhcmFtZXRlciwgc2hvdWxkIGl0IGV4aXN0LgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTmV0I2dldFF1ZXJ5U3RyaW5nCgkqIEBwYXJhbSB7c3RyaW5nfSBbcGFyYW1ldGVyPScnXSAtIElmIHNwZWNpZmllZCB0aGlzIHdpbGwgcmV0dXJuIGp1c3QgdGhlIHZhbHVlIGZvciB0aGF0IGtleS4KCSogQHJldHVybiB7c3RyaW5nfG9iamVjdH0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGtleSB2YWx1ZSBwYWlycyBmb3VuZCBpbiB0aGUgcXVlcnkgc3RyaW5nIG9yIGp1c3QgdGhlIHZhbHVlIGlmIGEgcGFyYW1ldGVyIHdhcyBnaXZlbi4KCSovCglnZXRRdWVyeVN0cmluZzogZnVuY3Rpb24gKHBhcmFtZXRlcikgewoKCQlpZiAodHlwZW9mIHBhcmFtZXRlciA9PT0gInVuZGVmaW5lZCIpIHsgcGFyYW1ldGVyID0gJyc7IH0KCgkJdmFyIG91dHB1dCA9IHt9OwoJCXZhciBrZXlWYWx1ZXMgPSBsb2NhdGlvbi5zZWFyY2guc3Vic3RyaW5nKDEpLnNwbGl0KCcmJyk7CgoJCWZvciAodmFyIGkgaW4ga2V5VmFsdWVzKSB7CgoJCQl2YXIga2V5ID0ga2V5VmFsdWVzW2ldLnNwbGl0KCc9Jyk7CgoJCQlpZiAoa2V5Lmxlbmd0aCA+IDEpCgkJCXsKCQkJCWlmIChwYXJhbWV0ZXIgJiYgcGFyYW1ldGVyID09IHRoaXMuZGVjb2RlVVJJKGtleVswXSkpCgkJCQl7CgkJCQkJcmV0dXJuIHRoaXMuZGVjb2RlVVJJKGtleVsxXSk7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJb3V0cHV0W3RoaXMuZGVjb2RlVVJJKGtleVswXSldID0gdGhpcy5kZWNvZGVVUkkoa2V5WzFdKTsKCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIG91dHB1dDsKCgl9LAoKCS8qKgoJKiBSZXR1cm5zIHRoZSBRdWVyeSBTdHJpbmcgYXMgYW4gb2JqZWN0LgoJKiBJZiB5b3Ugc3BlY2lmeSBhIHBhcmFtZXRlciBpdCB3aWxsIHJldHVybiBqdXN0IHRoZSB2YWx1ZSBvZiB0aGF0IHBhcmFtZXRlciwgc2hvdWxkIGl0IGV4aXN0LgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuTmV0I2RlY29kZVVSSQoJKiBAcGFyYW0ge3N0cmluZ30gdmFsdWUgLSBUaGUgVVJJIGNvbXBvbmVudCB0byBiZSBkZWNvZGVkLgoJKiBAcmV0dXJuIHtzdHJpbmd9IFRoZSBkZWNvZGVkIHZhbHVlLgoJKi8KCWRlY29kZVVSSTogZnVuY3Rpb24gKHZhbHVlKSB7CgkJcmV0dXJuIGRlY29kZVVSSUNvbXBvbmVudCh2YWx1ZS5yZXBsYWNlKC9cKy9nLCAiICIpKTsKCX0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBUd2Vlbk1hbmFnZXIKKiAKKiBAY2xhc3MgUGhhc2VyLlR3ZWVuTWFuYWdlcgoqIEBjbGFzc2Rlc2MgCiogUGhhc2VyLkdhbWUgaGFzIGEgc2luZ2xlIGluc3RhbmNlIG9mIHRoZSBUd2Vlbk1hbmFnZXIgdGhyb3VnaCB3aGljaCBhbGwgVHdlZW4gb2JqZWN0cyBhcmUgY3JlYXRlZCBhbmQgdXBkYXRlZC4KKiBUd2VlbnMgYXJlIGhvb2tlZCBpbnRvIHRoZSBnYW1lIGNsb2NrIGFuZCBwYXVzZSBzeXN0ZW0sIGFkanVzdGluZyBiYXNlZCBvbiB0aGUgZ2FtZSBzdGF0ZS4KKgoqIFR3ZWVuTWFuYWdlciBpcyBiYXNlZCBoZWF2aWx5IG9uIHR3ZWVuLmpzIGJ5IGh0dHA6Ly9zb2xlZGFkcGVuYWRlcy5jb20uCiogVGhlIGRpZmZlcmVuY2UgYmVpbmcgdGhhdCB0d2VlbnMgYmVsb25nIHRvIGEgZ2FtZXMgaW5zdGFuY2Ugb2YgVHdlZW5NYW5hZ2VyLCByYXRoZXIgdGhhbiB0byBhIGdsb2JhbCBUV0VFTiBvYmplY3QuCiogSXQgYWxzbyBoYXMgY2FsbGJhY2tzIHN3YXBwZWQgZm9yIFNpZ25hbHMgYW5kIGEgZmV3IGlzc3VlcyBwYXRjaGVkIHdpdGggcmVnYXJkIHRvIHByb3BlcnRpZXMgYW5kIGNvbXBsZXRpb24gZXJyb3JzLgoqIFBsZWFzZSBzZWUgaHR0cHM6Ly9naXRodWIuY29tL3NvbGUvdHdlZW4uanMgZm9yIGEgZnVsbCBsaXN0IG9mIGNvbnRyaWJ1dG9ycy4KKiBAY29uc3RydWN0b3IKKgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLlR3ZWVuTWFuYWdlciA9IGZ1bmN0aW9uIChnYW1lKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoJCgkvKioKCSogQHByb3BlcnR5IHthcnJheX0gX3R3ZWVucyAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KCXRoaXMuX3R3ZWVucyA9IFtdOwoJCgkvKioKCSogQHByb3BlcnR5IHthcnJheX0gX2FkZCAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KCXRoaXMuX2FkZCA9IFtdOwoKCXRoaXMuZ2FtZS5vblBhdXNlLmFkZCh0aGlzLnBhdXNlQWxsLCB0aGlzKTsKCXRoaXMuZ2FtZS5vblJlc3VtZS5hZGQodGhpcy5yZXN1bWVBbGwsIHRoaXMpOwoKfTsKClBoYXNlci5Ud2Vlbk1hbmFnZXIucHJvdG90eXBlID0gewoKCS8qKgoJKiBWZXJzaW9uIG51bWJlciBvZiB0aGlzIGxpYnJhcnkuCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBSRVZJU0lPTgoJKiBAZGVmYXVsdCAKCSovCQoJUkVWSVNJT046ICcxMWRldicsCgoJLyoqCgkqIEdldCBhbGwgdGhlIHR3ZWVuIG9iamVjdHMgaW4gYW4gYXJyYXkuCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNnZXRBbGwKCSogQHJldHVybnMge1BoYXNlci5Ud2VlbltdfSBBcnJheSB3aXRoIGFsbCB0d2VlbiBvYmplY3RzLgoJKi8KCWdldEFsbDogZnVuY3Rpb24gKCkgewoKCQlyZXR1cm4gdGhpcy5fdHdlZW5zOwoKCX0sCgoJLyoqCgkqIFJlbW92ZSBhbGwgdHdlZW4gb2JqZWN0cy4KCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI3JlbW92ZUFsbAoJKi8KCXJlbW92ZUFsbDogZnVuY3Rpb24gKCkgewoKCQl0aGlzLl90d2VlbnMgPSBbXTsKCgl9LAoKCS8qKgoJKiBBZGQgYSBuZXcgdHdlZW4gaW50byB0aGUgVHdlZW5NYW5hZ2VyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjYWRkCgkqIEBwYXJhbSB7UGhhc2VyLlR3ZWVufSB0d2VlbiAtIFRoZSB0d2VlbiBvYmplY3QgeW91IHdhbnQgdG8gYWRkLgoJKiBAcmV0dXJucyB7UGhhc2VyLlR3ZWVufSBUaGUgdHdlZW4gb2JqZWN0IHlvdSBhZGRlZCB0byB0aGUgbWFuYWdlci4KCSovCglhZGQ6IGZ1bmN0aW9uICggdHdlZW4gKSB7CgoJCXRoaXMuX2FkZC5wdXNoKCB0d2VlbiApOwoKCX0sCgoJLyoqCgkqIENyZWF0ZSBhIHR3ZWVuIG9iamVjdCBmb3IgYSBzcGVjaWZpYyBvYmplY3QuIFRoZSBvYmplY3QgY2FuIGJlIGFueSBKYXZhU2NyaXB0IG9iamVjdCBvciBQaGFzZXIgb2JqZWN0IHN1Y2ggYXMgU3ByaXRlLiAKCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI2NyZWF0ZQoJKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IC0gT2JqZWN0IHRoZSB0d2VlbiB3aWxsIGJlIHJ1biBvbi4KCSogQHJldHVybnMge1BoYXNlci5Ud2Vlbn0gVGhlIG5ld2x5IGNyZWF0ZWQgdHdlZW4gb2JqZWN0LgoJKi8KICAgIGNyZWF0ZTogZnVuY3Rpb24gKG9iamVjdCkgewoKICAgICAgICByZXR1cm4gbmV3IFBoYXNlci5Ud2VlbihvYmplY3QsIHRoaXMuZ2FtZSk7CgogICAgfSwKCgkvKioKCSogUmVtb3ZlIGEgdHdlZW4gZnJvbSB0aGlzIG1hbmFnZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNyZW1vdmUKCSogQHBhcmFtIHtQaGFzZXIuVHdlZW59IHR3ZWVuIC0gVGhlIHR3ZWVuIG9iamVjdCB5b3Ugd2FudCB0byByZW1vdmUuCgkqLwoJcmVtb3ZlOiBmdW5jdGlvbiAoIHR3ZWVuICkgewoKCQl2YXIgaSA9IHRoaXMuX3R3ZWVucy5pbmRleE9mKCB0d2VlbiApOwoKCQlpZiAoIGkgIT09IC0xICkgewoKCQkJdGhpcy5fdHdlZW5zW2ldLnBlbmRpbmdEZWxldGUgPSB0cnVlOwoKCQl9CgoJfSwKCgkvKioKCSogVXBkYXRlIGFsbCB0aGUgdHdlZW4gb2JqZWN0cyB5b3UgYWRkZWQgdG8gdGhpcyBtYW5hZ2VyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjdXBkYXRlCgkqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm4gZmFsc2UgaWYgdGhlcmUncyBubyB0d2VlbiB0byB1cGRhdGUsIG90aGVyd2lzZSByZXR1cm4gdHJ1ZS4KCSovCgl1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKCB0aGlzLl90d2VlbnMubGVuZ3RoID09PSAwICYmIHRoaXMuX2FkZC5sZW5ndGggPT09IDAgKSByZXR1cm4gZmFsc2U7CgoJCXZhciBpID0gMDsKCQl2YXIgbnVtVHdlZW5zID0gdGhpcy5fdHdlZW5zLmxlbmd0aDsKCgkJd2hpbGUgKCBpIDwgbnVtVHdlZW5zICkgewoKCQkJaWYgKCB0aGlzLl90d2VlbnNbIGkgXS51cGRhdGUoIHRoaXMuZ2FtZS50aW1lLm5vdyApICkgewoKCQkJCWkrKzsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcy5fdHdlZW5zLnNwbGljZSggaSwgMSApOwoKCQkJCW51bVR3ZWVucy0tOwoKCQkJfQoKCQl9CgoJCS8vCUlmIHRoZXJlIGFyZSBhbnkgbmV3IHR3ZWVucyB0byBiZSBhZGRlZCwgZG8gc28gbm93IC0gb3RoZXJ3aXNlIHRoZXkgY2FuIGJlIHNwbGljZWQgb3V0IG9mIHRoZSBhcnJheSBiZWZvcmUgZXZlciBydW5uaW5nCgkJaWYgKHRoaXMuX2FkZC5sZW5ndGggPiAwKQoJCXsKCQkJdGhpcy5fdHdlZW5zID0gdGhpcy5fdHdlZW5zLmNvbmNhdCh0aGlzLl9hZGQpOwoJCQl0aGlzLl9hZGQubGVuZ3RoID0gMDsKCQl9CgoJCXJldHVybiB0cnVlOwoKCX0sCgoJLyoqCgkqIENoZWNrcyB0byBzZWUgaWYgYSBwYXJ0aWN1bGFyIFNwcml0ZSBpcyBjdXJyZW50bHkgYmVpbmcgdHdlZW5lZC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW5NYW5hZ2VyI2lzVHdlZW5pbmcKCSogQHBhcmFtIHtvYmplY3R9IG9iamVjdCAtIFRoZSBvYmplY3QgdG8gY2hlY2sgZm9yIHR3ZWVucyBhZ2FpbnN0LgoJKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBvYmplY3QgaXMgY3VycmVudGx5IGJlaW5nIHR3ZWVuZWQsIGZhbHNlIGlmIG5vdC4KCSovCglpc1R3ZWVuaW5nOiBmdW5jdGlvbihvYmplY3QpIHsJCgoJCXJldHVybiB0aGlzLl90d2VlbnMuc29tZShmdW5jdGlvbih0d2VlbikgewoJCQlyZXR1cm4gdHdlZW4uX29iamVjdCA9PT0gb2JqZWN0OwoJCX0pOwoKCX0sCgoJLyoqCgkqIFBhdXNlcyBhbGwgY3VycmVudGx5IHJ1bm5pbmcgdHdlZW5zLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2Vlbk1hbmFnZXIjdXBkYXRlCgkqLwoJcGF1c2VBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAJZm9yICh2YXIgaSA9IHRoaXMuX3R3ZWVucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgCQl0aGlzLl90d2VlbnNbaV0ucGF1c2UoKTsKICAgIAl9OwoKICAgIH0sCgoJLyoqCgkqIFBhdXNlcyBhbGwgY3VycmVudGx5IHBhdXNlZCB0d2VlbnMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuTWFuYWdlciNyZXN1bWVBbGwKCSovCiAgIAlyZXN1bWVBbGw6IGZ1bmN0aW9uICgpIHsKCiAgICAJZm9yICh2YXIgaSA9IHRoaXMuX3R3ZWVucy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgCQl0aGlzLl90d2VlbnNbaV0ucmVzdW1lKCk7CiAgICAJfTsKCiAgICB9Cgp9OwovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBUd2VlbiBjb25zdHJ1Y3RvcgoqIENyZWF0ZSBhIG5ldyA8Y29kZT5Ud2VlbjwvY29kZT4uCioKKiBAY2xhc3MgUGhhc2VyLlR3ZWVuCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtvYmplY3R9IG9iamVjdCAtIFRhcmdldCBvYmplY3Qgd2lsbCBiZSBhZmZlY3RlZCBieSB0aGlzIHR3ZWVuLgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Ud2VlbiA9IGZ1bmN0aW9uIChvYmplY3QsIGdhbWUpIHsKCiAgICAvKioKICAgICogUmVmZXJlbmNlIHRvIHRoZSB0YXJnZXQgb2JqZWN0LgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX29iamVjdAogICAgKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX29iamVjdCA9IG9iamVjdDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfbWFuYWdlciAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21hbmFnZXIgPSB0aGlzLmdhbWUudHdlZW5zOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX3ZhbHVlc1N0YXJ0IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fdmFsdWVzU3RhcnQgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNFbmQgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92YWx1ZXNFbmQgPSB7fTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtvYmplY3R9IF92YWx1ZXNTdGFydFJlcGVhdCAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0ID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHVyYXRpb24gLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9kdXJhdGlvbiA9IDEwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcmVwZWF0IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fcmVwZWF0ID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfeW95byAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3lveW8gPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfcmV2ZXJzZWQgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9yZXZlcnNlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2RlbGF5VGltZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX2RlbGF5VGltZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9zdGFydFRpbWUgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgbnVsbAogICAgKi8KICAgIHRoaXMuX3N0YXJ0VGltZSA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9lYXNpbmdGdW5jdGlvbiAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2Vhc2luZ0Z1bmN0aW9uID0gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2ludGVycG9sYXRpb25GdW5jdGlvbiAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2ludGVycG9sYXRpb25GdW5jdGlvbiA9IFBoYXNlci5NYXRoLmxpbmVhckludGVycG9sYXRpb247CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9jaGFpbmVkVHdlZW5zIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fY2hhaW5lZFR3ZWVucyA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfb25TdGFydENhbGxiYWNrIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fb25TdGFydENhbGxiYWNrID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfb25TdGFydENhbGxiYWNrRmlyZWQgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9vblN0YXJ0Q2FsbGJhY2tGaXJlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfb25VcGRhdGVDYWxsYmFjayAtIERlc2NyaXB0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCBudWxsCiAgICAqLwogICAgdGhpcy5fb25VcGRhdGVDYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IF9vbkNvbXBsZXRlQ2FsbGJhY2sgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQgbnVsbAogICAgKi8KICAgIHRoaXMuX29uQ29tcGxldGVDYWxsYmFjayA9IG51bGw7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3BhdXNlZFRpbWUgLSBEZXNjcmlwdGlvbi4KICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9wYXVzZWRUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBwZW5kaW5nRGVsZXRlIC0gSWYgdGhpcyB0d2VlbiBpcyByZWFkeSB0byBiZSBkZWxldGVkIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5wZW5kaW5nRGVsZXRlID0gZmFsc2U7CgogICAgLy8gU2V0IGFsbCBzdGFydGluZyB2YWx1ZXMgcHJlc2VudCBvbiB0aGUgdGFyZ2V0IG9iamVjdAogICAgZm9yICggdmFyIGZpZWxkIGluIG9iamVjdCApIHsKICAgIAl0aGlzLl92YWx1ZXNTdGFydFsgZmllbGQgXSA9IHBhcnNlRmxvYXQob2JqZWN0W2ZpZWxkXSwgMTApOwogICAgfQogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblN0YXJ0IC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy5vblN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkNvbXBsZXRlIC0gRGVzY3JpcHRpb24uCiAgICAqLwogICAgdGhpcy5vbkNvbXBsZXRlID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1J1bm5pbmcgLSBEZXNjcmlwdGlvbi4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmlzUnVubmluZyA9IGZhbHNlOwoKfTsKClBoYXNlci5Ud2Vlbi5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIENvbmZpZ3VyZSB0aGUgVHdlZW4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jdG8KCSogQHBhcmFtIHtvYmplY3R9IHByb3BlcnRpZXMgLSBQcm9wZXJ0aWVzIHlvdSB3YW50IHRvIHR3ZWVuLgoJKiBAcGFyYW0ge251bWJlcn0gZHVyYXRpb24gLSBEdXJhdGlvbiBvZiB0aGlzIHR3ZWVuLgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBlYXNlIC0gRWFzaW5nIGZ1bmN0aW9uLgoJKiBAcGFyYW0ge2Jvb2xlYW59IGF1dG9TdGFydCAtIFdoZXRoZXIgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0IGF1dG9tYXRpY2FsbHkgb3Igbm90LgoJKiBAcGFyYW0ge251bWJlcn0gZGVsYXkgLSBEZWxheSBiZWZvcmUgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0LCBkZWZhdWx0cyB0byAwIChubyBkZWxheSkuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gcmVwZWF0IC0gU2hvdWxkIHRoZSB0d2VlbiBhdXRvbWF0aWNhbGx5IHJlc3RhcnQgb25jZSBjb21wbGV0ZT8gKGlnbm9yZXMgYW55IGNoYWluZWQgdHdlZW5zKS4KCSogQHBhcmFtIHtQaGFzZXIuVHdlZW59IHlveW8gLSBEZXNjcmlwdGlvbi4KCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJdG86IGZ1bmN0aW9uICggcHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGF1dG9TdGFydCwgZGVsYXksIHJlcGVhdCwgeW95byApIHsKCgkJZHVyYXRpb24gPSBkdXJhdGlvbiB8fCAxMDAwOwoJCWVhc2UgPSBlYXNlIHx8IG51bGw7CgkJYXV0b1N0YXJ0ID0gYXV0b1N0YXJ0IHx8IGZhbHNlOwoJCWRlbGF5ID0gZGVsYXkgfHwgMDsKCQlyZXBlYXQgPSByZXBlYXQgfHwgMDsKCQl5b3lvID0geW95byB8fCBmYWxzZTsKCgkJdmFyIHNlbGY7CgkJaWYgKHRoaXMuX3BhcmVudCkKCQl7CgkJCXNlbGYgPSB0aGlzLl9tYW5hZ2VyLmNyZWF0ZSh0aGlzLl9vYmplY3QpOwoJCQl0aGlzLl9sYXN0Q2hpbGQuY2hhaW4oc2VsZik7CgkJCXRoaXMuX2xhc3RDaGlsZCA9IHNlbGY7CgkJfQoJCWVsc2UKCQl7CgkJCXNlbGYgPSB0aGlzOwoJCQl0aGlzLl9wYXJlbnQgPSB0aGlzOwoJCQl0aGlzLl9sYXN0Q2hpbGQgPSB0aGlzOwoJCX0KCgkJc2VsZi5fcmVwZWF0ID0gcmVwZWF0OwogICAgICAgIHNlbGYuX2R1cmF0aW9uID0gZHVyYXRpb247CgkJc2VsZi5fdmFsdWVzRW5kID0gcHJvcGVydGllczsKCiAgICAgICAgaWYgKGVhc2UgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBzZWxmLl9lYXNpbmdGdW5jdGlvbiA9IGVhc2U7CiAgICAgICAgfQoKICAgICAgICBpZiAoZGVsYXkgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgc2VsZi5fZGVsYXlUaW1lID0gZGVsYXk7CiAgICAgICAgfQoKICAgICAgICBzZWxmLl95b3lvID0geW95bzsKCiAgICAgICAgaWYgKGF1dG9TdGFydCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5zdGFydCgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwogICAgICAgIH0KCgl9LAoKCS8qKgoJKiBTdGFydHMgdGhlIHR3ZWVuIHJ1bm5pbmcuIENhbiBhbHNvIGJlIGNhbGxlZCBieSB0aGUgYXV0b1N0YXJ0IHBhcmFtZXRlciBvZiBUd2Vlbi50by4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jc3RhcnQKCSogQHBhcmFtIHtudW1iZXJ9IHRpbWUgLSBEZXNjcmlwdGlvbi4KCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJc3RhcnQ6IGZ1bmN0aW9uICggdGltZSApIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZSA9PT0gbnVsbCB8fCB0aGlzLl9vYmplY3QgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCgkJdGhpcy5fbWFuYWdlci5hZGQodGhpcyk7CgoJCXRoaXMub25TdGFydC5kaXNwYXRjaCh0aGlzLl9vYmplY3QpOwoKICAgICAgICB0aGlzLmlzUnVubmluZyA9IHRydWU7CgoJCXRoaXMuX29uU3RhcnRDYWxsYmFja0ZpcmVkID0gZmFsc2U7CgogICAgICAgIHRoaXMuX3N0YXJ0VGltZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuX2RlbGF5VGltZTsKCgkJZm9yICggdmFyIHByb3BlcnR5IGluIHRoaXMuX3ZhbHVlc0VuZCApIHsKCgkJCS8vIGNoZWNrIGlmIGFuIEFycmF5IHdhcyBwcm92aWRlZCBhcyBwcm9wZXJ0eSB2YWx1ZQoJCQlpZiAoIHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXSBpbnN0YW5jZW9mIEFycmF5ICkgewoKCQkJCWlmICggdGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdLmxlbmd0aCA9PT0gMCApIHsKCgkJCQkJY29udGludWU7CgoJCQkJfQoKCQkJCS8vIGNyZWF0ZSBhIGxvY2FsIGNvcHkgb2YgdGhlIEFycmF5IHdpdGggdGhlIHN0YXJ0IHZhbHVlIGF0IHRoZSBmcm9udAoJCQkJdGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdID0gWyB0aGlzLl9vYmplY3RbIHByb3BlcnR5IF0gXS5jb25jYXQoIHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXSApOwoKCQkJfQoKCQkJdGhpcy5fdmFsdWVzU3RhcnRbIHByb3BlcnR5IF0gPSB0aGlzLl9vYmplY3RbIHByb3BlcnR5IF07CgoJCQlpZiAoICggdGhpcy5fdmFsdWVzU3RhcnRbIHByb3BlcnR5IF0gaW5zdGFuY2VvZiBBcnJheSApID09PSBmYWxzZSApIHsKCQkJCXRoaXMuX3ZhbHVlc1N0YXJ0WyBwcm9wZXJ0eSBdICo9IDEuMDsgLy8gRW5zdXJlcyB3ZSdyZSB1c2luZyBudW1iZXJzLCBub3Qgc3RyaW5ncwoJCQl9CgoJCQl0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFsgcHJvcGVydHkgXSA9IHRoaXMuX3ZhbHVlc1N0YXJ0WyBwcm9wZXJ0eSBdIHx8IDA7CgoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU3RvcHMgdGhlIHR3ZWVuIGlmIHJ1bm5pbmcgYW5kIHJlbW92ZXMgaXQgZnJvbSB0aGUgVHdlZW5NYW5hZ2VyLiBJZiB0aGVyZSBhcmUgYW55IG9uQ29tcGxldGUgY2FsbGJhY2tzIG9yIGV2ZW50cyB0aGV5IGFyZSBub3QgZGlzcGF0Y2hlZC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jc3RvcAoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglzdG9wOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuaXNSdW5uaW5nID0gZmFsc2U7CgoJCXRoaXMuX21hbmFnZXIucmVtb3ZlKHRoaXMpOwoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIGEgZGVsYXkgdGltZSBiZWZvcmUgdGhpcyB0d2VlbiB3aWxsIHN0YXJ0LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNkZWxheQoJKiBAcGFyYW0ge251bWJlcn0gYW1vdW50IC0gVGhlIGFtb3VudCBvZiB0aGUgZGVsYXkgaW4gbXMuCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCWRlbGF5OiBmdW5jdGlvbiAoIGFtb3VudCApIHsKCgkJdGhpcy5fZGVsYXlUaW1lID0gYW1vdW50OwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldHMgdGhlIG51bWJlciBvZiB0aW1lcyB0aGlzIHR3ZWVuIHdpbGwgcmVwZWF0LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNyZXBlYXQKCSogQHBhcmFtIHtudW1iZXJ9IHRpbWVzIC0gSG93IG1hbnkgdGltZXMgdG8gcmVwZWF0LgoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglyZXBlYXQ6IGZ1bmN0aW9uICggdGltZXMgKSB7CgoJCXRoaXMuX3JlcGVhdCA9IHRpbWVzOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEEgdHdlZW4gdGhhdCBoYXMgeW95byBzZXQgdG8gdHJ1ZSB3aWxsIHJ1biB0aHJvdWdoIGZyb20gc3RhcnQgdG8gZmluaXNoLCB0aGVuIHJldmVyc2UgZnJvbSBmaW5pc2ggdG8gc3RhcnQuCgkqIFVzZWQgaW4gY29tYmluYXRpb24gd2l0aCByZXBlYXQgeW91IGNhbiBjcmVhdGUgZW5kbGVzcyBsb29wcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jeW95bwoJKiBAcGFyYW0ge2Jvb2xlYW59IHlveW8gLSBTZXQgdG8gdHJ1ZSB0byB5b3lvIHRoaXMgdHdlZW4uCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCXlveW86IGZ1bmN0aW9uKCB5b3lvICkgewoKCQl0aGlzLl95b3lvID0geW95bzsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXQgZWFzaW5nIGZ1bmN0aW9uIHRoaXMgdHdlZW4gd2lsbCB1c2UsIGkuZS4gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZS4gCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2Vhc2luZwoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBlYXNpbmcgLSBUaGUgZWFzaW5nIGZ1bmN0aW9uIHRoaXMgdHdlZW4gd2lsbCB1c2UsIGkuZS4gUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZS4KCSogQHJldHVybiB7UGhhc2VyLlR3ZWVufSBJdHNlbGYuCgkqLwoJZWFzaW5nOiBmdW5jdGlvbiAoIGVhc2luZyApIHsKCgkJdGhpcy5fZWFzaW5nRnVuY3Rpb24gPSBlYXNpbmc7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0IGludGVycG9sYXRpb24gZnVuY3Rpb24gdGhlIHR3ZWVuIHdpbGwgdXNlLCBieSBkZWZhdWx0IGl0IHVzZXMgUGhhc2VyLk1hdGgubGluZWFySW50ZXJwb2xhdGlvbi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jaW50ZXJwb2xhdGlvbgoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBpbnRlcnBvbGF0aW9uIC0gVGhlIGludGVycG9sYXRpb24gZnVuY3Rpb24gdG8gdXNlIChQaGFzZXIuTWF0aC5saW5lYXJJbnRlcnBvbGF0aW9uIGJ5IGRlZmF1bHQpCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCWludGVycG9sYXRpb246IGZ1bmN0aW9uICggaW50ZXJwb2xhdGlvbiApIHsKCgkJdGhpcy5faW50ZXJwb2xhdGlvbkZ1bmN0aW9uID0gaW50ZXJwb2xhdGlvbjsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBZb3UgY2FuIGNoYWluIHR3ZWVucyB0b2dldGhlciBieSBwYXNzaW5nIGEgcmVmZXJlbmNlIHRvIHRoZSBjaGFpbiBmdW5jdGlvbi4gVGhpcyBlbmFibGVzIG9uZSB0d2VlbiB0byBjYWxsIGFub3RoZXIgb24gY29tcGxldGlvbi4KCSogWW91IGNhbiBwYXNzIGFzIG1hbnkgdHdlZW5zIGFzIHlvdSBsaWtlIHRvIHRoaXMgZnVuY3Rpb24sIHRoZXkgd2lsbCBlYWNoIGJlIGNoYWluZWQgaW4gc2VxdWVuY2UuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI2NoYWluCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCWNoYWluOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuX2NoYWluZWRUd2VlbnMgPSBhcmd1bWVudHM7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogTG9vcCBhIGNoYWluIG9mIHR3ZWVucwoJKiAKCSogVXNhZ2U6CgkqIGdhbWUuYWRkLnR3ZWVuKHApLnRvKHsgeDogNzAwIH0sIDEwMDAsIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUsIHRydWUpCgkqIC50byh7IHk6IDMwMCB9LCAxMDAwLCBQaGFzZXIuRWFzaW5nLkxpbmVhci5Ob25lKQoJKiAudG8oeyB4OiAwIH0sIDEwMDAsIFBoYXNlci5FYXNpbmcuTGluZWFyLk5vbmUpCgkqIC50byh7IHk6IDAgfSwgMTAwMCwgUGhhc2VyLkVhc2luZy5MaW5lYXIuTm9uZSkKCSogLmxvb3AoKTsKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jbG9vcAoJKiBAcmV0dXJuIHtQaGFzZXIuVHdlZW59IEl0c2VsZi4KCSovCglsb29wOiBmdW5jdGlvbigpIHsKCgkJdGhpcy5fbGFzdENoaWxkLmNoYWluKHRoaXMpOwoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIFNldHMgYSBjYWxsYmFjayB0byBiZSBmaXJlZCB3aGVuIHRoZSB0d2VlbiBzdGFydHMuIE5vdGU6IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGluIHRoZSBjb250ZXh0IG9mIHRoZSBnbG9iYWwgc2NvcGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI29uU3RhcnRDYWxsYmFjawoJKiBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayAtIFRoZSBjYWxsYmFjayB0byBpbnZva2Ugb24gc3RhcnQuCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCW9uU3RhcnRDYWxsYmFjazogZnVuY3Rpb24gKCBjYWxsYmFjayApIHsKCgkJdGhpcy5fb25TdGFydENhbGxiYWNrID0gY2FsbGJhY2s7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogU2V0cyBhIGNhbGxiYWNrIHRvIGJlIGZpcmVkIGVhY2ggdGltZSB0aGlzIHR3ZWVuIHVwZGF0ZXMuIE5vdGU6IGNhbGxiYWNrIHdpbGwgYmUgY2FsbGVkIGluIHRoZSBjb250ZXh0IG9mIHRoZSBnbG9iYWwgc2NvcGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI29uVXBkYXRlQ2FsbGJhY2sKCSogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdG8gaW52b2tlIGVhY2ggdGltZSB0aGlzIHR3ZWVuIGlzIHVwZGF0ZWQuCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCW9uVXBkYXRlQ2FsbGJhY2s6IGZ1bmN0aW9uICggY2FsbGJhY2sgKSB7CgoJCXRoaXMuX29uVXBkYXRlQ2FsbGJhY2sgPSBjYWxsYmFjazsKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBTZXRzIGEgY2FsbGJhY2sgdG8gYmUgZmlyZWQgd2hlbiB0aGUgdHdlZW4gY29tcGxldGVzLiBOb3RlOiBjYWxsYmFjayB3aWxsIGJlIGNhbGxlZCBpbiB0aGUgY29udGV4dCBvZiB0aGUgZ2xvYmFsIHNjb3BlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNvbkNvbXBsZXRlQ2FsbGJhY2sKCSogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgLSBUaGUgY2FsbGJhY2sgdG8gaW52b2tlIG9uIGNvbXBsZXRpb24uCgkqIEByZXR1cm4ge1BoYXNlci5Ud2Vlbn0gSXRzZWxmLgoJKi8KCW9uQ29tcGxldGVDYWxsYmFjazogZnVuY3Rpb24gKCBjYWxsYmFjayApIHsKCgkJdGhpcy5fb25Db21wbGV0ZUNhbGxiYWNrID0gY2FsbGJhY2s7CgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogUGF1c2VzIHRoZSB0d2Vlbi4gCgkqCgkqIEBtZXRob2QgUGhhc2VyLlR3ZWVuI3BhdXNlCgkqLwogICAgcGF1c2U6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9wYXVzZWQgPSB0cnVlOwogICAgICAgIHRoaXMuX3BhdXNlZFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICB9LAoKCS8qKgoJKiBSZXN1bWVzIGEgcGF1c2VkIHR3ZWVuLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Ud2VlbiNyZXN1bWUKCSovCiAgICByZXN1bWU6IGZ1bmN0aW9uICgpIHsKICAgICAgICB0aGlzLl9wYXVzZWQgPSBmYWxzZTsKICAgICAgICB0aGlzLl9zdGFydFRpbWUgKz0gKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3BhdXNlZFRpbWUpOwogICAgfSwKCgkvKioKCSogQ29yZSB0d2VlbiB1cGRhdGUgZnVuY3Rpb24gY2FsbGVkIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuIERvZXMgbm90IG5lZWQgdG8gYmUgaW52b2tlZCBkaXJlY3RseS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuVHdlZW4jdXBkYXRlCgkqIEBwYXJhbSB7bnVtYmVyfSB0aW1lIC0gQSB0aW1lc3RhbXAgcGFzc2VkIGluIGJ5IHRoZSBUd2Vlbk1hbmFnZXIuCgkqIEByZXR1cm4ge2Jvb2xlYW59IGZhbHNlIGlmIHRoZSB0d2VlbiBoYXMgY29tcGxldGVkIGFuZCBzaG91bGQgYmUgZGVsZXRlZCBmcm9tIHRoZSBtYW5hZ2VyLCBvdGhlcndpc2UgdHJ1ZSAoc3RpbGwgYWN0aXZlKS4KCSovCgl1cGRhdGU6IGZ1bmN0aW9uICggdGltZSApIHsKCgkJaWYgKHRoaXMucGVuZGluZ0RlbGV0ZSkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgogICAgICAgIGlmICh0aGlzLl9wYXVzZWQgfHwgdGltZSA8IHRoaXMuX3N0YXJ0VGltZSkgewoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAgIH0KCgkJdmFyIHByb3BlcnR5OwoKCQlpZiAoIHRpbWUgPCB0aGlzLl9zdGFydFRpbWUgKSB7CgoJCQlyZXR1cm4gdHJ1ZTsKCgkJfQoKCQlpZiAoIHRoaXMuX29uU3RhcnRDYWxsYmFja0ZpcmVkID09PSBmYWxzZSApIHsKCgkJCWlmICggdGhpcy5fb25TdGFydENhbGxiYWNrICE9PSBudWxsICkgewoKCQkJCXRoaXMuX29uU3RhcnRDYWxsYmFjay5jYWxsKCB0aGlzLl9vYmplY3QgKTsKCgkJCX0KCgkJCXRoaXMuX29uU3RhcnRDYWxsYmFja0ZpcmVkID0gdHJ1ZTsKCgkJfQoKCQl2YXIgZWxhcHNlZCA9ICggdGltZSAtIHRoaXMuX3N0YXJ0VGltZSApIC8gdGhpcy5fZHVyYXRpb247CgkJZWxhcHNlZCA9IGVsYXBzZWQgPiAxID8gMSA6IGVsYXBzZWQ7CgoJCXZhciB2YWx1ZSA9IHRoaXMuX2Vhc2luZ0Z1bmN0aW9uKCBlbGFwc2VkICk7CgoJCWZvciAoIHByb3BlcnR5IGluIHRoaXMuX3ZhbHVlc0VuZCApIHsKCgkJCXZhciBzdGFydCA9IHRoaXMuX3ZhbHVlc1N0YXJ0WyBwcm9wZXJ0eSBdIHx8IDA7CgkJCXZhciBlbmQgPSB0aGlzLl92YWx1ZXNFbmRbIHByb3BlcnR5IF07CgoJCQlpZiAoIGVuZCBpbnN0YW5jZW9mIEFycmF5ICkgewoKCQkJCXRoaXMuX29iamVjdFsgcHJvcGVydHkgXSA9IHRoaXMuX2ludGVycG9sYXRpb25GdW5jdGlvbiggZW5kLCB2YWx1ZSApOwoKCQkJfSBlbHNlIHsKCiAgICAgICAgICAgICAgICAvLyBQYXJzZXMgcmVsYXRpdmUgZW5kIHZhbHVlcyB3aXRoIHN0YXJ0IGFzIGJhc2UgKGUuZy46ICsxMCwgLTMpCgkJCQlpZiAoIHR5cGVvZihlbmQpID09PSAic3RyaW5nIiApIHsKCQkJCQllbmQgPSBzdGFydCArIHBhcnNlRmxvYXQoZW5kLCAxMCk7CgkJCQl9CgoJCQkJLy8gcHJvdGVjdCBhZ2FpbnN0IG5vbiBudW1lcmljIHByb3BlcnRpZXMuCiAgICAgICAgICAgICAgICBpZiAoIHR5cGVvZihlbmQpID09PSAibnVtYmVyIiApIHsKCQkJCQl0aGlzLl9vYmplY3RbIHByb3BlcnR5IF0gPSBzdGFydCArICggZW5kIC0gc3RhcnQgKSAqIHZhbHVlOwoJCQkJfQoKCQkJfQoKCQl9CgoJCWlmICggdGhpcy5fb25VcGRhdGVDYWxsYmFjayAhPT0gbnVsbCApIHsKCgkJCXRoaXMuX29uVXBkYXRlQ2FsbGJhY2suY2FsbCggdGhpcy5fb2JqZWN0LCB2YWx1ZSApOwoKCQl9CgoJCWlmICggZWxhcHNlZCA9PSAxICkgewoKCQkJaWYgKCB0aGlzLl9yZXBlYXQgPiAwICkgewoKCQkJCWlmICggaXNGaW5pdGUoIHRoaXMuX3JlcGVhdCApICkgewoJCQkJCXRoaXMuX3JlcGVhdC0tOwoJCQkJfQoKCQkJCS8vIHJlYXNzaWduIHN0YXJ0aW5nIHZhbHVlcywgcmVzdGFydCBieSBtYWtpbmcgc3RhcnRUaW1lID0gbm93CgkJCQlmb3IgKCBwcm9wZXJ0eSBpbiB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdCApIHsKCgkJCQkJaWYgKCB0eXBlb2YoIHRoaXMuX3ZhbHVlc0VuZFsgcHJvcGVydHkgXSApID09PSAic3RyaW5nIiApIHsKCQkJCQkJdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbIHByb3BlcnR5IF0gPSB0aGlzLl92YWx1ZXNTdGFydFJlcGVhdFsgcHJvcGVydHkgXSArIHBhcnNlRmxvYXQodGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdLCAxMCk7CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5feW95bykgewoJCQkJCQl2YXIgdG1wID0gdGhpcy5fdmFsdWVzU3RhcnRSZXBlYXRbIHByb3BlcnR5IF07CgkJCQkJCXRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0WyBwcm9wZXJ0eSBdID0gdGhpcy5fdmFsdWVzRW5kWyBwcm9wZXJ0eSBdOwoJCQkJCQl0aGlzLl92YWx1ZXNFbmRbIHByb3BlcnR5IF0gPSB0bXA7CgkJCQkJCXRoaXMuX3JldmVyc2VkID0gIXRoaXMuX3JldmVyc2VkOwoJCQkJCX0KCQkJCQl0aGlzLl92YWx1ZXNTdGFydFsgcHJvcGVydHkgXSA9IHRoaXMuX3ZhbHVlc1N0YXJ0UmVwZWF0WyBwcm9wZXJ0eSBdOwoKCQkJCX0KCgkJCQl0aGlzLl9zdGFydFRpbWUgPSB0aW1lICsgdGhpcy5fZGVsYXlUaW1lOwoKCQkJCXRoaXMub25Db21wbGV0ZS5kaXNwYXRjaCh0aGlzLl9vYmplY3QpOwoKCQkJCWlmICggdGhpcy5fb25Db21wbGV0ZUNhbGxiYWNrICE9PSBudWxsICkgewoJCQkJCXRoaXMuX29uQ29tcGxldGVDYWxsYmFjay5jYWxsKCB0aGlzLl9vYmplY3QgKTsKCQkJCX0KCgkJCQlyZXR1cm4gdHJ1ZTsKCgkJCX0gZWxzZSB7CgoJCQkJdGhpcy5vbkNvbXBsZXRlLmRpc3BhdGNoKHRoaXMuX29iamVjdCk7CgoJCQkJaWYgKCB0aGlzLl9vbkNvbXBsZXRlQ2FsbGJhY2sgIT09IG51bGwgKSB7CgkJCQkJdGhpcy5fb25Db21wbGV0ZUNhbGxiYWNrLmNhbGwoIHRoaXMuX29iamVjdCApOwoJCQkJfQoKCQkJCWZvciAoIHZhciBpID0gMCwgbnVtQ2hhaW5lZFR3ZWVucyA9IHRoaXMuX2NoYWluZWRUd2VlbnMubGVuZ3RoOyBpIDwgbnVtQ2hhaW5lZFR3ZWVuczsgaSArKyApIHsKCgkJCQkJdGhpcy5fY2hhaW5lZFR3ZWVuc1sgaSBdLnN0YXJ0KCB0aW1lICk7CgoJCQkJfQoKCQkJCXJldHVybiBmYWxzZTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCgl9CgkKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgY29sbGVjdGlvbiBvZiBlYXNpbmcgbWV0aG9kcyBkZWZpbmluZyBlYXNlLWluIGVhc2Utb3V0IGN1cnZlcy4KKgoqIEBjbGFzcyBQaGFzZXIuRWFzaW5nCiovClBoYXNlci5FYXNpbmcgPSB7CgogICAgLyoqCiAgICAqIExpbmVhciBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkxpbmVhcgogICAgKi8KCUxpbmVhcjogewoKCQkvKioKCQkqIEVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkxpbmVhciNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBrXjIuCgkJKi8KCQlOb25lOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gazsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIFF1YWRyYXRpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYwogICAgKi8KCVF1YWRyYXRpYzogewoKCQkvKioKCQkqIEVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YWRyYXRpYyNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0ga14yLgoJCSovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiBrICogazsKCgkJfSwKCgkJLyoqCgkJKiBFYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVhZHJhdGljI091dCAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gayogKDItaykuCgkJKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiBrICogKCAyIC0gayApOwoKCQl9LAoKCQkvKioKCQkqIEVhc2UtaW4vb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFkcmF0aWMjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBrICogazsKCQkJcmV0dXJuIC0gMC41ICogKCAtLWsgKiAoIGsgLSAyICkgLSAxICk7CgoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBDdWJpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkN1YmljCiAgICAqLwoJQ3ViaWM6IHsKCgkJLyoqCgkJKiBDdWJpYyBlYXNlLWluLgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DdWJpYyNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGsgKiBrICogazsKCgkJfSwKCgkJLyoqCgkJKiBDdWJpYyBlYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ3ViaWMjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gLS1rICogayAqIGsgKyAxOwoKCQl9LAoKCQkvKioKCQkqIEN1YmljIGVhc2UtaW4vb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5DdWJpYyNJbk91dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIGsgKiBrICogazsKCQkJcmV0dXJuIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiBrICsgMiApOwoKCQl9CgoJfSwKCiAgICAvKioKICAgICogUXVhcnRpYyBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMKICAgICovCglRdWFydGljOiB7CgoJCS8qKgoJCSogUXVhcnRpYyBlYXNlLWluLgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFydGljI0luIAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gayAqIGsgKiBrICogazsKCgkJfSwKCgkJLyoqCgkJKiBRdWFydGljIGVhc2Utb3V0LgoJCSoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5RdWFydGljI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIDEgLSAoIC0tayAqIGsgKiBrICogayApOwoKCQl9LAoKCQkvKioKCQkqIFF1YXJ0aWMgZWFzZS1pbi9vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1YXJ0aWMjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSkgcmV0dXJuIDAuNSAqIGsgKiBrICogayAqIGs7CgkJCXJldHVybiAtIDAuNSAqICggKCBrIC09IDIgKSAqIGsgKiBrICogayAtIDIgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIFF1aW50aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5RdWludGljCiAgICAqLwoJUXVpbnRpYzogewoKCQkvKioKCQkqIFF1aW50aWMgZWFzZS1pbi4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVpbnRpYyNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIGsgKiBrICogayAqIGsgKiBrOwoKCQl9LAoKCQkvKioKCQkqIFF1aW50aWMgZWFzZS1vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLlF1aW50aWMjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gLS1rICogayAqIGsgKiBrICogayArIDE7CgoJCX0sCgoJCS8qKgoJCSogUXVpbnRpYyBlYXNlLWluL291dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuUXVpbnRpYyNJbk91dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIDAuNSAqIGsgKiBrICogayAqIGsgKiBrOwoJCQlyZXR1cm4gMC41ICogKCAoIGsgLT0gMiApICogayAqIGsgKiBrICogayArIDIgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIFNpbnVzb2lkYWwgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5TaW51c29pZGFsCiAgICAqLwoJU2ludXNvaWRhbDogewoKCQkvKioKCQkqIFNpbnVzb2lkYWwgZWFzZS1pbi4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJcmV0dXJuIDEgLSBNYXRoLmNvcyggayAqIE1hdGguUEkgLyAyICk7CgoJCX0sCgoJCS8qKgoJCSogU2ludXNvaWRhbCBlYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNPdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCgkJKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiBNYXRoLnNpbiggayAqIE1hdGguUEkgLyAyICk7CgoJCX0sCgoJCS8qKgoJCSogU2ludXNvaWRhbCBlYXNlLWluL291dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuU2ludXNvaWRhbCNJbk91dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gMC41ICogKCAxIC0gTWF0aC5jb3MoIE1hdGguUEkgKiBrICkgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIEV4cG9uZW50aWFsIGVhc2luZy4KICAgICoKICAgICogQGNsYXNzIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwKICAgICovCglFeHBvbmVudGlhbDogewoKCQkvKioKCQkqIEV4cG9uZW50aWFsIGVhc2UtaW4uCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsI0luIAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KCQkqLwoJCUluOiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gayA9PT0gMCA/IDAgOiBNYXRoLnBvdyggMTAyNCwgayAtIDEgKTsKCgkJfSwKCgkJLyoqCgkJKiBFeHBvbmVudGlhbCBlYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRXhwb25lbnRpYWwjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gayA9PT0gMSA/IDEgOiAxIC0gTWF0aC5wb3coIDIsIC0gMTAgKiBrICk7CgoJCX0sCgoJCS8qKgoJCSogRXhwb25lbnRpYWwgZWFzZS1pbi9vdXQuCgkJKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkV4cG9uZW50aWFsI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggayA9PT0gMCApIHJldHVybiAwOwoJCQlpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSApIHJldHVybiAwLjUgKiBNYXRoLnBvdyggMTAyNCwgayAtIDEgKTsKCQkJcmV0dXJuIDAuNSAqICggLSBNYXRoLnBvdyggMiwgLSAxMCAqICggayAtIDEgKSApICsgMiApOwoKCQl9CgoJfSwKCiAgICAvKioKICAgICogQ2lyY3VsYXIgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5DaXJjdWxhcgogICAgKi8KCUNpcmN1bGFyOiB7CgoJCS8qKgoJCSogQ2lyY3VsYXIgZWFzZS1pbi4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiAxIC0gTWF0aC5zcXJ0KCAxIC0gayAqIGsgKTsKCgkJfSwKCgkJLyoqCgkJKiBDaXJjdWxhciBlYXNlLW91dC4KCQkqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIjT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgoJCSovCgkJT3V0OiBmdW5jdGlvbiAoIGsgKSB7CgoJCQlyZXR1cm4gTWF0aC5zcXJ0KCAxIC0gKCAtLWsgKiBrICkgKTsKCgkJfSwKCgkJLyoqCgkJKiBDaXJjdWxhciBlYXNlLWluL291dC4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQ2lyY3VsYXIjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCAoIGsgKj0gMiApIDwgMSkgcmV0dXJuIC0gMC41ICogKCBNYXRoLnNxcnQoIDEgLSBrICogaykgLSAxKTsKCQkJcmV0dXJuIDAuNSAqICggTWF0aC5zcXJ0KCAxIC0gKCBrIC09IDIpICogaykgKyAxKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIEVsYXN0aWMgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5FbGFzdGljCiAgICAqLwoJRWxhc3RpYzogewoKCQkvKioKCQkqIEVsYXN0aWMgZWFzZS1pbi4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRWxhc3RpYyNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJdmFyIHMsIGEgPSAwLjEsIHAgPSAwLjQ7CgkJCWlmICggayA9PT0gMCApIHJldHVybiAwOwoJCQlpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKCQkJaWYgKCAhYSB8fCBhIDwgMSApIHsgYSA9IDE7IHMgPSBwIC8gNDsgfQoJCQllbHNlIHMgPSBwICogTWF0aC5hc2luKCAxIC8gYSApIC8gKCAyICogTWF0aC5QSSApOwoJCQlyZXR1cm4gLSAoIGEgKiBNYXRoLnBvdyggMiwgMTAgKiAoIGsgLT0gMSApICkgKiBNYXRoLnNpbiggKCBrIC0gcyApICogKCAyICogTWF0aC5QSSApIC8gcCApICk7CgoJCX0sCgoJCS8qKgoJCSogRWxhc3RpYyBlYXNlLW91dC4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuRWxhc3RpYyNPdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzLCBhID0gMC4xLCBwID0gMC40OwoJCQlpZiAoIGsgPT09IDAgKSByZXR1cm4gMDsKCQkJaWYgKCBrID09PSAxICkgcmV0dXJuIDE7CgkJCWlmICggIWEgfHwgYSA8IDEgKSB7IGEgPSAxOyBzID0gcCAvIDQ7IH0KCQkJZWxzZSBzID0gcCAqIE1hdGguYXNpbiggMSAvIGEgKSAvICggMiAqIE1hdGguUEkgKTsKCQkJcmV0dXJuICggYSAqIE1hdGgucG93KCAyLCAtIDEwICogaykgKiBNYXRoLnNpbiggKCBrIC0gcyApICogKCAyICogTWF0aC5QSSApIC8gcCApICsgMSApOwoKCQl9LAoKCQkvKioKCQkqIEVsYXN0aWMgZWFzZS1pbi9vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkVsYXN0aWMjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJdmFyIHMsIGEgPSAwLjEsIHAgPSAwLjQ7CgkJCWlmICggayA9PT0gMCApIHJldHVybiAwOwoJCQlpZiAoIGsgPT09IDEgKSByZXR1cm4gMTsKCQkJaWYgKCAhYSB8fCBhIDwgMSApIHsgYSA9IDE7IHMgPSBwIC8gNDsgfQoJCQllbHNlIHMgPSBwICogTWF0aC5hc2luKCAxIC8gYSApIC8gKCAyICogTWF0aC5QSSApOwoJCQlpZiAoICggayAqPSAyICkgPCAxICkgcmV0dXJuIC0gMC41ICogKCBhICogTWF0aC5wb3coIDIsIDEwICogKCBrIC09IDEgKSApICogTWF0aC5zaW4oICggayAtIHMgKSAqICggMiAqIE1hdGguUEkgKSAvIHAgKSApOwoJCQlyZXR1cm4gYSAqIE1hdGgucG93KCAyLCAtMTAgKiAoIGsgLT0gMSApICkgKiBNYXRoLnNpbiggKCBrIC0gcyApICogKCAyICogTWF0aC5QSSApIC8gcCApICogMC41ICsgMTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIEJhY2sgZWFzaW5nLgogICAgKgogICAgKiBAY2xhc3MgUGhhc2VyLkVhc2luZy5CYWNrCiAgICAqLwoJQmFjazogewoKCQkvKioKCQkqIEJhY2sgZWFzZS1pbi4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQmFjayNJbiAKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlJbjogZnVuY3Rpb24gKCBrICkgewoKCQkJdmFyIHMgPSAxLjcwMTU4OwoJCQlyZXR1cm4gayAqIGsgKiAoICggcyArIDEgKSAqIGsgLSBzICk7CgoJCX0sCgoJCS8qKgoJCSogQmFjayBlYXNlLW91dC4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQmFjayNPdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlPdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCXZhciBzID0gMS43MDE1ODsKCQkJcmV0dXJuIC0tayAqIGsgKiAoICggcyArIDEgKSAqIGsgKyBzICkgKyAxOwoKCQl9LAoKCQkvKioKCQkqIEJhY2sgZWFzZS1pbi9vdXQuCiAgICAgICAgKgoJCSogQG1ldGhvZCBQaGFzZXIuRWFzaW5nLkJhY2sjSW5PdXQKCQkqIEBwYXJhbSB7bnVtYmVyfSBrIC0gVGhlIHZhbHVlIHRvIGJlIHR3ZWVuZWQuIAoJCSogQHJldHVybnMge251bWJlcn0gVGhlIHR3ZWVuZWQgdmFsdWUuCiAgICAgICAgKi8KCQlJbk91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJdmFyIHMgPSAxLjcwMTU4ICogMS41MjU7CgkJCWlmICggKCBrICo9IDIgKSA8IDEgKSByZXR1cm4gMC41ICogKCBrICogayAqICggKCBzICsgMSApICogayAtIHMgKSApOwoJCQlyZXR1cm4gMC41ICogKCAoIGsgLT0gMiApICogayAqICggKCBzICsgMSApICogayArIHMgKSArIDIgKTsKCgkJfQoKCX0sCgogICAgLyoqCiAgICAqIEJvdW5jZSBlYXNpbmcuCiAgICAqCiAgICAqIEBjbGFzcyBQaGFzZXIuRWFzaW5nLkJvdW5jZQogICAgKi8KCUJvdW5jZTogewoKCQkvKioKCQkqIEJvdW5jZSBlYXNlLWluLgogICAgICAgICoKCQkqIEBtZXRob2QgUGhhc2VyLkVhc2luZy5Cb3VuY2UjSW4gCgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW46IGZ1bmN0aW9uICggayApIHsKCgkJCXJldHVybiAxIC0gUGhhc2VyLkVhc2luZy5Cb3VuY2UuT3V0KCAxIC0gayApOwoKCQl9LAoKCQkvKioKCQkqIEJvdW5jZSBlYXNlLW91dC4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQm91bmNlI091dAoJCSogQHBhcmFtIHtudW1iZXJ9IGsgLSBUaGUgdmFsdWUgdG8gYmUgdHdlZW5lZC4gCgkJKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgdHdlZW5lZCB2YWx1ZS4KICAgICAgICAqLwoJCU91dDogZnVuY3Rpb24gKCBrICkgewoKCQkJaWYgKCBrIDwgKCAxIC8gMi43NSApICkgewoKCQkJCXJldHVybiA3LjU2MjUgKiBrICogazsKCgkJCX0gZWxzZSBpZiAoIGsgPCAoIDIgLyAyLjc1ICkgKSB7CgoJCQkJcmV0dXJuIDcuNTYyNSAqICggayAtPSAoIDEuNSAvIDIuNzUgKSApICogayArIDAuNzU7CgoJCQl9IGVsc2UgaWYgKCBrIDwgKCAyLjUgLyAyLjc1ICkgKSB7CgoJCQkJcmV0dXJuIDcuNTYyNSAqICggayAtPSAoIDIuMjUgLyAyLjc1ICkgKSAqIGsgKyAwLjkzNzU7CgoJCQl9IGVsc2UgewoKCQkJCXJldHVybiA3LjU2MjUgKiAoIGsgLT0gKCAyLjYyNSAvIDIuNzUgKSApICogayArIDAuOTg0Mzc1OwoKCQkJfQoKCQl9LAoKCQkvKioKCQkqIEJvdW5jZSBlYXNlLWluL291dC4KICAgICAgICAqCgkJKiBAbWV0aG9kIFBoYXNlci5FYXNpbmcuQm91bmNlI0luT3V0CgkJKiBAcGFyYW0ge251bWJlcn0gayAtIFRoZSB2YWx1ZSB0byBiZSB0d2VlbmVkLiAKCQkqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSB0d2VlbmVkIHZhbHVlLgogICAgICAgICovCgkJSW5PdXQ6IGZ1bmN0aW9uICggayApIHsKCgkJCWlmICggayA8IDAuNSApIHJldHVybiBQaGFzZXIuRWFzaW5nLkJvdW5jZS5JbiggayAqIDIgKSAqIDAuNTsKCQkJcmV0dXJuIFBoYXNlci5FYXNpbmcuQm91bmNlLk91dCggayAqIDIgLSAxICkgKiAwLjUgKyAwLjU7CgoJCX0KCgl9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGltZSBjb25zdHJ1Y3Rvci4KKgoqIEBjbGFzcyBQaGFzZXIuVGltZQoqIEBjbGFzc2Rlc2MgVGhpcyBpcyB0aGUgY29yZSBpbnRlcm5hbCBnYW1lIGNsb2NrLiBJdCBtYW5hZ2VzIHRoZSBlbGFwc2VkIHRpbWUgYW5kIGNhbGN1bGF0aW9uIG9mIGVsYXBzZWQgdmFsdWVzLCB1c2VkIGZvciBnYW1lIG9iamVjdCBtb3Rpb24gYW5kIHR3ZWVucy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVGltZSA9IGZ1bmN0aW9uIChnYW1lKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBMb2NhbCByZWZlcmVuY2UgdG8gZ2FtZS4KCSovCgl0aGlzLmdhbWUgPSBnYW1lOwoKCS8qKgoJKiBUaGUgdGltZSBhdCB3aGljaCB0aGUgR2FtZSBpbnN0YW5jZSBzdGFydGVkLgoJKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0ZWQKCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCgl0aGlzLl9zdGFydGVkID0gMDsKCgkvKioKCSogVGhlIHRpbWUgKGluIG1zKSB0aGF0IHRoZSBsYXN0IHNlY29uZCBjb3VudGVyIHRpY2tlZCBvdmVyLgoJKiBAcHJvcGVydHkge251bWJlcn0gX3RpbWVMYXN0U2Vjb25kCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fdGltZUxhc3RTZWNvbmQgPSAwOwoKCS8qKgoJKiBUaGUgdGltZSB0aGUgZ2FtZSBzdGFydGVkIGJlaW5nIHBhdXNlZC4KCSogQHByb3BlcnR5IHtudW1iZXJ9IF9wYXVzZVN0YXJ0ZWQKCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCgl0aGlzLl9wYXVzZVN0YXJ0ZWQgPSAwOwoKCS8qKgoJKiBUaGUgZWxhcHNlZCB0aW1lIGNhbGN1bGF0ZWQgZm9yIHRoZSBwaHlzaWNzIG1vdGlvbiB1cGRhdGVzLgoJKiBAcHJvcGVydHkge251bWJlcn0gcGh5c2ljc0VsYXBzZWQKCSogQGRlZmF1bHQKCSovCgl0aGlzLnBoeXNpY3NFbGFwc2VkID0gMDsKCgkvKioKCSogR2FtZSB0aW1lIGNvdW50ZXIuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy50aW1lID0gMDsKCgkvKioKCSogUmVjb3JkcyBob3cgbG9uZyB0aGUgZ2FtZSBoYXMgYmVlbiBwYXVzZWQgZm9yLiBJcyByZXNldCBlYWNoIHRpbWUgdGhlIGdhbWUgcGF1c2VzLgoJKiBAcHJvcGVydHkge251bWJlcn0gcGF1c2VkVGltZQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucGF1c2VkVGltZSA9IDA7CgoJLyoqCgkqIFRoZSB0aW1lIHJpZ2h0IG5vdy4KCSogQHByb3BlcnR5IHtudW1iZXJ9IG5vdwogICAgKiBAZGVmYXVsdAoJKi8KCXRoaXMubm93ID0gMDsKCgkvKioKCSogRWxhcHNlZCB0aW1lIHNpbmNlIHRoZSBsYXN0IGZyYW1lLgoJKiBAcHJvcGVydHkge251bWJlcn0gZWxhcHNlZAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZWxhcHNlZCA9IDA7CgoJLyoqCgkqIEZyYW1lcyBwZXIgc2Vjb25kLgoJKiBAcHJvcGVydHkge251bWJlcn0gZnBzCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5mcHMgPSAwOwoKCS8qKgoJKiBUaGUgbG93ZXN0IHJhdGUgdGhlIGZwcyBoYXMgZHJvcHBlZCB0by4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGZwc01pbgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZnBzTWluID0gMTAwMDsKCgkvKioKCSogVGhlIGhpZ2hlc3QgcmF0ZSB0aGUgZnBzIGhhcyByZWFjaGVkICh1c3VhbGx5IG5vIGhpZ2hlciB0aGFuIDYwZnBzKS4KCSogQHByb3BlcnR5IHtudW1iZXJ9IGZwc01heAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuZnBzTWF4ID0gMDsKCgkvKioKCSogVGhlIG1pbmltdW0gYW1vdW50IG9mIHRpbWUgdGhlIGdhbWUgaGFzIHRha2VuIGJldHdlZW4gdHdvIGZyYW1lcy4KCSogQHByb3BlcnR5IHtudW1iZXJ9IG1zTWluCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5tc01pbiA9IDEwMDA7CgoJLyoqCgkqIFRoZSBtYXhpbXVtIGFtb3VudCBvZiB0aW1lIHRoZSBnYW1lIGhhcyB0YWtlbiBiZXR3ZWVuIHR3byBmcmFtZXMuCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtc01heAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMubXNNYXggPSAwOwoKCS8qKgoJKiBUaGUgbnVtYmVyIG9mIGZyYW1lcyByZWNvcmQgaW4gdGhlIGxhc3Qgc2Vjb25kLgoJKiBAcHJvcGVydHkge251bWJlcn0gZnJhbWVzCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5mcmFtZXMgPSAwOwoKCS8qKgoJKiBSZWNvcmRzIGhvdyBsb25nIHRoZSBnYW1lIHdhcyBwYXVzZWQgZm9yIGluIG1pbGlzZWNvbmRzLgoJKiBAcHJvcGVydHkge251bWJlcn0gcGF1c2VEdXJhdGlvbgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucGF1c2VEdXJhdGlvbiA9IDA7CgoJLyoqCgkqIFRoZSB2YWx1ZSB0aGF0IHNldFRpbWVvdXQgbmVlZHMgdG8gd29yayBvdXQgd2hlbiB0byBuZXh0IHVwZGF0ZQoJKiBAcHJvcGVydHkge251bWJlcn0gdGltZVRvQ2FsbAoJKiBAZGVmYXVsdAoJKi8KCXRoaXMudGltZVRvQ2FsbCA9IDA7CgoJLyoqCgkqIEludGVybmFsIHZhbHVlIHVzZWQgYnkgdGltZVRvQ2FsbCBhcyBwYXJ0IG9mIHRoZSBzZXRUaW1lb3V0IGxvb3AKCSogQHByb3BlcnR5IHtudW1iZXJ9IGxhc3RUaW1lCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5sYXN0VGltZSA9IDA7CgoJLy8JTGlzdGVuIGZvciBnYW1lIHBhdXNlL3Jlc3VtZSBldmVudHMKCXRoaXMuZ2FtZS5vblBhdXNlLmFkZCh0aGlzLmdhbWVQYXVzZWQsIHRoaXMpOwoJdGhpcy5nYW1lLm9uUmVzdW1lLmFkZCh0aGlzLmdhbWVSZXN1bWVkLCB0aGlzKTsKCgkvKioKCSogRGVzY3JpcHRpb24uCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2p1c3RSZXN1bWVkCiAgICAqIEBkZWZhdWx0CgkqLwoJdGhpcy5fanVzdFJlc3VtZWQgPSBmYWxzZTsKCn07CgpQaGFzZXIuVGltZS5wcm90b3R5cGUgPSB7CgoJLyoqCgkqIFRoZSBudW1iZXIgb2Ygc2Vjb25kcyB0aGF0IGhhdmUgZWxhcHNlZCBzaW5jZSB0aGUgZ2FtZSB3YXMgc3RhcnRlZC4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSN0b3RhbEVsYXBzZWRTZWNvbmRzCgkqIEByZXR1cm4ge251bWJlcn0KCSovCgl0b3RhbEVsYXBzZWRTZWNvbmRzOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKHRoaXMubm93IC0gdGhpcy5fc3RhcnRlZCkgKiAwLjAwMTsKCX0sCgoJLyoqCgkqIFVwZGF0ZXMgdGhlIGdhbWUgY2xvY2sgYW5kIGNhbGN1bGF0ZSB0aGUgZnBzLiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5HYW1lLgoJKiBAbWV0aG9kIFBoYXNlci5UaW1lI3VwZGF0ZQoJKiBAcGFyYW0ge251bWJlcn0gdGltZSAtIFRoZSBjdXJyZW50IHRpbWVzdGFtcCwgZWl0aGVyIHBlcmZvcm1hbmNlLm5vdyBvciBEYXRlLm5vdyBkZXBlbmRpbmcgb24gdGhlIGJyb3dzZXIuCgkqLwoJdXBkYXRlOiBmdW5jdGlvbiAodGltZSkgewoKCQl0aGlzLm5vdyA9IHRpbWU7CgoJCWlmICh0aGlzLl9qdXN0UmVzdW1lZCkKCQl7CgkJCXRoaXMudGltZSA9IHRoaXMubm93OwoJCQl0aGlzLl9qdXN0UmVzdW1lZCA9IGZhbHNlOwoJCX0KCgkJdGhpcy50aW1lVG9DYWxsID0gdGhpcy5nYW1lLm1hdGgubWF4KDAsIDE2IC0gKHRpbWUgLSB0aGlzLmxhc3RUaW1lKSk7CgoJCXRoaXMuZWxhcHNlZCA9IHRoaXMubm93IC0gdGhpcy50aW1lOwoKCQl0aGlzLm1zTWluID0gdGhpcy5nYW1lLm1hdGgubWluKHRoaXMubXNNaW4sIHRoaXMuZWxhcHNlZCk7CgkJdGhpcy5tc01heCA9IHRoaXMuZ2FtZS5tYXRoLm1heCh0aGlzLm1zTWF4LCB0aGlzLmVsYXBzZWQpOwoKCQl0aGlzLmZyYW1lcysrOwoKCQlpZiAodGhpcy5ub3cgPiB0aGlzLl90aW1lTGFzdFNlY29uZCArIDEwMDApCgkJewoJCQl0aGlzLmZwcyA9IE1hdGgucm91bmQoKHRoaXMuZnJhbWVzICogMTAwMCkgLyAodGhpcy5ub3cgLSB0aGlzLl90aW1lTGFzdFNlY29uZCkpOwoJCQl0aGlzLmZwc01pbiA9IHRoaXMuZ2FtZS5tYXRoLm1pbih0aGlzLmZwc01pbiwgdGhpcy5mcHMpOwoJCQl0aGlzLmZwc01heCA9IHRoaXMuZ2FtZS5tYXRoLm1heCh0aGlzLmZwc01heCwgdGhpcy5mcHMpOwoJCQl0aGlzLl90aW1lTGFzdFNlY29uZCA9IHRoaXMubm93OwoJCQl0aGlzLmZyYW1lcyA9IDA7CgkJfQoKCQl0aGlzLnRpbWUgPSB0aGlzLm5vdzsKICAgICAgICB0aGlzLmxhc3RUaW1lID0gdGltZSArIHRoaXMudGltZVRvQ2FsbDsKCQl0aGlzLnBoeXNpY3NFbGFwc2VkID0gMS4wICogKHRoaXMuZWxhcHNlZCAvIDEwMDApOwoKCQkvLwlDbGFtcCB0aGUgZGVsdGEKCQlpZiAodGhpcy5waHlzaWNzRWxhcHNlZCA+IDEpCgkJewoJCQl0aGlzLnBoeXNpY3NFbGFwc2VkID0gMTsKCQl9CgoJCS8vICBQYXVzZWQ/CgkJaWYgKHRoaXMuZ2FtZS5wYXVzZWQpCgkJewoJCQl0aGlzLnBhdXNlZFRpbWUgPSB0aGlzLm5vdyAtIHRoaXMuX3BhdXNlU3RhcnRlZDsKCQl9CgoJfSwKCgkvKioKCSogQ2FsbGVkIHdoZW4gdGhlIGdhbWUgZW50ZXJzIGEgcGF1c2VkIHN0YXRlLgoJKiBAbWV0aG9kIFBoYXNlci5UaW1lI2dhbWVQYXVzZWQKCSogQHByaXZhdGUKCSovCglnYW1lUGF1c2VkOiBmdW5jdGlvbiAoKSB7CgkJCgkJdGhpcy5fcGF1c2VTdGFydGVkID0gdGhpcy5ub3c7CgoJfSwKCgkvKioKCSogQ2FsbGVkIHdoZW4gdGhlIGdhbWUgcmVzdW1lcyBmcm9tIGEgcGF1c2VkIHN0YXRlLgoJKiBAbWV0aG9kIFBoYXNlci5UaW1lI2dhbWVSZXN1bWVkCgkqIEBwcml2YXRlCgkqLwoJZ2FtZVJlc3VtZWQ6IGZ1bmN0aW9uICgpIHsKCgkJLy8gIExldmVsIG91dCB0aGUgZWxhcHNlZCB0aW1lciB0byBhdm9pZCBzcGlrZXMKCQl0aGlzLnRpbWUgPSBEYXRlLm5vdygpOwoJCXRoaXMucGF1c2VEdXJhdGlvbiA9IHRoaXMucGF1c2VkVGltZTsKCQl0aGlzLl9qdXN0UmVzdW1lZCA9IHRydWU7CgoJfSwKCgkvKioKCSogSG93IGxvbmcgaGFzIHBhc3NlZCBzaW5jZSB0aGUgZ2l2ZW4gdGltZS4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSNlbGFwc2VkU2luY2UKCSogQHBhcmFtIHtudW1iZXJ9IHNpbmNlIC0gVGhlIHRpbWUgeW91IHdhbnQgdG8gbWVhc3VyZSBhZ2FpbnN0LgoJKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGhlIGdpdmVuIHRpbWUgYW5kIG5vdy4KCSovCgllbGFwc2VkU2luY2U6IGZ1bmN0aW9uIChzaW5jZSkgewoJCXJldHVybiB0aGlzLm5vdyAtIHNpbmNlOwoJfSwKCgkvKioKCSogSG93IGxvbmcgaGFzIHBhc3NlZCBzaW5jZSB0aGUgZ2l2ZW4gdGltZSAoaW4gc2Vjb25kcykuCgkqIEBtZXRob2QgUGhhc2VyLlRpbWUjZWxhcHNlZFNlY29uZHNTaW5jZQoJKiBAcGFyYW0ge251bWJlcn0gc2luY2UgLSBUaGUgdGltZSB5b3Ugd2FudCB0byBtZWFzdXJlIChpbiBzZWNvbmRzKS4KCSogQHJldHVybiB7bnVtYmVyfSBEdXJhdGlvbiBiZXR3ZWVuIGdpdmVuIHRpbWUgYW5kIG5vdyAoaW4gc2Vjb25kcykuCgkqLwoJZWxhcHNlZFNlY29uZHNTaW5jZTogZnVuY3Rpb24gKHNpbmNlKSB7CgkJcmV0dXJuICh0aGlzLm5vdyAtIHNpbmNlKSAqIDAuMDAxOwoJfSwKCgkvKioKCSogUmVzZXRzIHRoZSBwcml2YXRlIF9zdGFydGVkIHZhbHVlIHRvIG5vdy4KCSogQG1ldGhvZCBQaGFzZXIuVGltZSNyZXNldAoJKi8KCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgkJdGhpcy5fc3RhcnRlZCA9IHRoaXMubm93OwoJfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIEFuaW1hdGlvbiBNYW5hZ2VyIGlzIHVzZWQgdG8gYWRkLCBwbGF5IGFuZCB1cGRhdGUgUGhhc2VyIEFuaW1hdGlvbnMuCiogQW55IEdhbWUgT2JqZWN0IHN1Y2ggYXMgUGhhc2VyLlNwcml0ZSB0aGF0IHN1cHBvcnRzIGFuaW1hdGlvbiBjb250YWlucyBhIHNpbmdsZSBBbmltYXRpb25NYW5hZ2VyIGluc3RhbmNlLgoqCiogQGNsYXNzIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBBIHJlZmVyZW5jZSB0byB0aGUgR2FtZSBPYmplY3QgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uTWFuYWdlci4KKi8KUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gQSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBTcHJpdGUgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uTWFuYWdlci4KICAgICovCgl0aGlzLnNwcml0ZSA9IHNwcml0ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBHYW1lLgogICAgKi8KCXRoaXMuZ2FtZSA9IHNwcml0ZS5nYW1lOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gVGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgRnJhbWUgb2YgYW5pbWF0aW9uLCBpZiBhbnkuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5jdXJyZW50RnJhbWUgPSBudWxsOwoJCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB1cGRhdGVJZlZpc2libGUgLSBTaG91bGQgdGhlIGFuaW1hdGlvbiBkYXRhIGNvbnRpbnVlIHRvIHVwZGF0ZSBldmVuIGlmIHRoZSBTcHJpdGUudmlzaWJsZSBpcyBzZXQgdG8gZmFsc2UuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy51cGRhdGVJZlZpc2libGUgPSB0cnVlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTG9hZGVkIC0gU2V0IHRvIHRydWUgb25jZSBhbmltYXRpb24gZGF0YSBoYXMgYmVlbiBsb2FkZWQuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5pc0xvYWRlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZURhdGF9IF9mcmFtZURhdGEgLSBBIHRlbXAuIHZhciBmb3IgaG9sZGluZyB0aGUgY3VycmVudGx5IHBsYXlpbmcgQW5pbWF0aW9ucyBGcmFtZURhdGEuCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fZnJhbWVEYXRhID0gbnVsbDsKCgkvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF9hbmltcyAtIEFuIGludGVybmFsIG9iamVjdCB0aGF0IHN0b3JlcyBhbGwgb2YgdGhlIEFuaW1hdGlvbiBpbnN0YW5jZXMuCgkqIEBwcml2YXRlCgkqLyAgIAoJdGhpcy5fYW5pbXMgPSB7fTsKCgkvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF9vdXRwdXRGcmFtZXMgLSBBbiBpbnRlcm5hbCBvYmplY3QgdG8gaGVscCBhdm9pZCBnYy4KCSogQHByaXZhdGUKCSovCgl0aGlzLl9vdXRwdXRGcmFtZXMgPSBbXTsKCn07CgpQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUgPSB7CgogICAgLyoqCiAgICAqIExvYWRzIEZyYW1lRGF0YSBpbnRvIHRoZSBpbnRlcm5hbCB0ZW1wb3JhcnkgdmFycyBhbmQgcmVzZXRzIHRoZSBmcmFtZSBpbmRleCB0byB6ZXJvLgogICAgKiBUaGlzIGlzIGNhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gYSBuZXcgU3ByaXRlIGlzIGNyZWF0ZWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjbG9hZEZyYW1lRGF0YQogICAgKiBAcHJpdmF0ZQogICAgKiBAcGFyYW0ge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgc2V0IHRvIGxvYWQuCiAgICAqLwoJbG9hZEZyYW1lRGF0YTogZnVuY3Rpb24gKGZyYW1lRGF0YSkgewoKCQl0aGlzLl9mcmFtZURhdGEgPSBmcmFtZURhdGE7CgkJdGhpcy5mcmFtZSA9IDA7CgkJdGhpcy5pc0xvYWRlZCA9IHRydWU7CgoJfSwKCgkvKioKCSogQWRkcyBhIG5ldyBhbmltYXRpb24gdW5kZXIgdGhlIGdpdmVuIGtleS4gT3B0aW9uYWxseSBzZXQgdGhlIGZyYW1lcywgZnJhbWUgcmF0ZSBhbmQgbG9vcC4KCSogQW5pbWF0aW9ucyBhZGRlZCBpbiB0aGlzIHdheSBhcmUgcGxheWVkIGJhY2sgd2l0aCB0aGUgcGxheSBmdW5jdGlvbi4KCSoKICAgICogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNhZGQKCSogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBUaGUgdW5pcXVlICh3aXRoaW4gdGhpcyBTcHJpdGUpIG5hbWUgZm9yIHRoZSBhbmltYXRpb24sIGkuZS4gInJ1biIsICJmaXJlIiwgIndhbGsiLgoJKiBAcGFyYW0ge0FycmF5fSBbZnJhbWVzPW51bGxdIC0gQW4gYXJyYXkgb2YgbnVtYmVycy9zdHJpbmdzIHRoYXQgY29ycmVzcG9uZCB0byB0aGUgZnJhbWVzIHRvIGFkZCB0byB0aGlzIGFuaW1hdGlvbiBhbmQgaW4gd2hpY2ggb3JkZXIuIGUuZy4gWzEsIDIsIDNdIG9yIFsncnVuMCcsICdydW4xJywgcnVuMl0pLiBJZiBudWxsIHRoZW4gYWxsIGZyYW1lcyB3aWxsIGJlIHVzZWQuCgkqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPTYwXSAtIFRoZSBzcGVlZCBhdCB3aGljaCB0aGUgYW5pbWF0aW9uIHNob3VsZCBwbGF5LiBUaGUgc3BlZWQgaXMgZ2l2ZW4gaW4gZnJhbWVzIHBlciBzZWNvbmQuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gV2hldGhlciBvciBub3QgdGhlIGFuaW1hdGlvbiBpcyBsb29wZWQgb3IganVzdCBwbGF5cyBvbmNlLgoJKiBAcGFyYW0ge2Jvb2xlYW59IFt1c2VOdW1lcmljSW5kZXg9dHJ1ZV0gLSBBcmUgdGhlIGdpdmVuIGZyYW1lcyB1c2luZyBudW1lcmljIGluZGV4ZXMgKGRlZmF1bHQpIG9yIHN0cmluZ3M/CgkqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IFRoZSBBbmltYXRpb24gb2JqZWN0IHRoYXQgd2FzIGNyZWF0ZWQuCgkqLwoJYWRkOiBmdW5jdGlvbiAobmFtZSwgZnJhbWVzLCBmcmFtZVJhdGUsIGxvb3AsIHVzZU51bWVyaWNJbmRleCkgewoKCQlpZiAodGhpcy5fZnJhbWVEYXRhID09IG51bGwpCgkJewoJCQljb25zb2xlLndhcm4oJ05vIEZyYW1lRGF0YSBhdmFpbGFibGUgZm9yIFBoYXNlci5BbmltYXRpb24gJyArIG5hbWUpOwoJCQlyZXR1cm47CgkJfQoKCQlmcmFtZVJhdGUgPSBmcmFtZVJhdGUgfHwgNjA7CgoJCWlmICh0eXBlb2YgbG9vcCA9PT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgoJCS8vCUlmIHRoZXkgZGlkbid0IHNldCB0aGUgdXNlTnVtZXJpY0luZGV4IHRoZW4gbGV0J3MgYXQgbGVhc3QgdHJ5IGFuZCBndWVzcyBpdAoJCWlmICh0eXBlb2YgdXNlTnVtZXJpY0luZGV4ID09PSAndW5kZWZpbmVkJykKCQl7CgkJCWlmIChmcmFtZXMgJiYgdHlwZW9mIGZyYW1lc1swXSA9PT0gJ251bWJlcicpCgkJCXsKCQkJCXVzZU51bWVyaWNJbmRleCA9IHRydWU7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQl1c2VOdW1lcmljSW5kZXggPSBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gIENyZWF0ZSB0aGUgc2lnbmFscyB0aGUgQW5pbWF0aW9uTWFuYWdlciB3aWxsIGVtaXQKCQlpZiAodGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uU3RhcnQgPT0gbnVsbCkKCQl7CgkJCXRoaXMuc3ByaXRlLmV2ZW50cy5vbkFuaW1hdGlvblN0YXJ0ID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCQkJdGhpcy5zcHJpdGUuZXZlbnRzLm9uQW5pbWF0aW9uQ29tcGxldGUgPSBuZXcgUGhhc2VyLlNpZ25hbCgpOwoJCQl0aGlzLnNwcml0ZS5ldmVudHMub25BbmltYXRpb25Mb29wID0gbmV3IFBoYXNlci5TaWduYWwoKTsKCQl9CgogICAgCXRoaXMuX291dHB1dEZyYW1lcy5sZW5ndGggPSAwOwoKCQl0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWVJbmRleGVzKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4LCB0aGlzLl9vdXRwdXRGcmFtZXMpOwoKCQl0aGlzLl9hbmltc1tuYW1lXSA9IG5ldyBQaGFzZXIuQW5pbWF0aW9uKHRoaXMuZ2FtZSwgdGhpcy5zcHJpdGUsIG5hbWUsIHRoaXMuX2ZyYW1lRGF0YSwgdGhpcy5fb3V0cHV0RnJhbWVzLCBmcmFtZVJhdGUsIGxvb3ApOwoJCXRoaXMuY3VycmVudEFuaW0gPSB0aGlzLl9hbmltc1tuYW1lXTsKCQl0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEFuaW0uY3VycmVudEZyYW1lOwoJCXRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwoKCQlyZXR1cm4gdGhpcy5fYW5pbXNbbmFtZV07CgoJfSwKCgkvKioKCSogQ2hlY2sgd2hldGhlciB0aGUgZnJhbWVzIGluIHRoZSBnaXZlbiBhcnJheSBhcmUgdmFsaWQgYW5kIGV4aXN0LgoJKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3ZhbGlkYXRlRnJhbWVzCgkqIEBwYXJhbSB7QXJyYXl9IGZyYW1lcyAtIEFuIGFycmF5IG9mIGZyYW1lcyB0byBiZSB2YWxpZGF0ZWQuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZU51bWVyaWNJbmRleD10cnVlXSAtIFZhbGlkYXRlIHRoZSBmcmFtZXMgYmFzZWQgb24gdGhlaXIgbnVtZXJpYyBpbmRleCAodHJ1ZSkgb3Igc3RyaW5nIGluZGV4IChmYWxzZSkKCSogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBhbGwgZ2l2ZW4gRnJhbWVzIGFyZSB2YWxpZCwgb3RoZXJ3aXNlIGZhbHNlLgoJKi8KCXZhbGlkYXRlRnJhbWVzOiBmdW5jdGlvbiAoZnJhbWVzLCB1c2VOdW1lcmljSW5kZXgpIHsKCgkJaWYgKHR5cGVvZiB1c2VOdW1lcmljSW5kZXggPT0gJ3VuZGVmaW5lZCcpIHsgdXNlTnVtZXJpY0luZGV4ID0gdHJ1ZTsgfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKCQl7CgkJCWlmICh1c2VOdW1lcmljSW5kZXggPT0gdHJ1ZSkKCQkJewoJCQkJaWYgKGZyYW1lc1tpXSA+IHRoaXMuX2ZyYW1lRGF0YS50b3RhbCkKCQkJCXsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlpZiAodGhpcy5fZnJhbWVEYXRhLmNoZWNrRnJhbWVOYW1lKGZyYW1lc1tpXSkgPT0gZmFsc2UpCgkJCQl7CgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gdHJ1ZTsKCgl9LAoKCS8qKgoJKiBQbGF5IGFuIGFuaW1hdGlvbiBiYXNlZCBvbiB0aGUgZ2l2ZW4ga2V5LiBUaGUgYW5pbWF0aW9uIHNob3VsZCBwcmV2aW91c2x5IGhhdmUgYmVlbiBhZGRlZCB2aWEgc3ByaXRlLmFuaW1hdGlvbnMuYWRkKCkKCSogSWYgdGhlIHJlcXVlc3RlZCBhbmltYXRpb24gaXMgYWxyZWFkeSBwbGF5aW5nIHRoaXMgcmVxdWVzdCB3aWxsIGJlIGlnbm9yZWQuIElmIHlvdSBuZWVkIHRvIHJlc2V0IGFuIGFscmVhZHkgcnVubmluZyBhbmltYXRpb24gZG8gc28gZGlyZWN0bHkgb24gdGhlIEFuaW1hdGlvbiBvYmplY3QgaXRzZWxmLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNwbGF5CgkqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSBwbGF5ZWQsIGUuZy4gImZpcmUiLCAid2FsayIsICJqdW1wIi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZVJhdGU9bnVsbF0gLSBUaGUgZnJhbWVyYXRlIHRvIHBsYXkgdGhlIGFuaW1hdGlvbiBhdC4gVGhlIHNwZWVkIGlzIGdpdmVuIGluIGZyYW1lcyBwZXIgc2Vjb25kLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGZyYW1lUmF0ZSBvZiB0aGUgQW5pbWF0aW9uIGlzIHVzZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2hvdWxkIHRoZSBhbmltYXRpb24gYmUgbG9vcGVkIGFmdGVyIHBsYXliYWNrLiBJZiBub3QgcHJvdmlkZWQgdGhlIHByZXZpb3VzbHkgc2V0IGxvb3AgdmFsdWUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtraWxsT25Db21wbGV0ZT1mYWxzZV0gLSBJZiBzZXQgdG8gdHJ1ZSB3aGVuIHRoZSBhbmltYXRpb24gY29tcGxldGVzIChvbmx5IGhhcHBlbnMgaWYgbG9vcD1mYWxzZSkgdGhlIHBhcmVudCBTcHJpdGUgd2lsbCBiZSBraWxsZWQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5BbmltYXRpb259IEEgcmVmZXJlbmNlIHRvIHBsYXlpbmcgQW5pbWF0aW9uIGluc3RhbmNlLgoJKi8KCXBsYXk6IGZ1bmN0aW9uIChuYW1lLCBmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgoJCWlmICh0aGlzLl9hbmltc1tuYW1lXSkKCQl7CgkJCWlmICh0aGlzLmN1cnJlbnRBbmltID09IHRoaXMuX2FuaW1zW25hbWVdKQoJCQl7CgkJCQlpZiAodGhpcy5jdXJyZW50QW5pbS5pc1BsYXlpbmcgPT0gZmFsc2UpCgkJCQl7CgkJCSAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSBmYWxzZTsKCQkJCQlyZXR1cm4gdGhpcy5jdXJyZW50QW5pbS5wbGF5KGZyYW1lUmF0ZSwgbG9vcCwga2lsbE9uQ29tcGxldGUpOwoJCQkJfQoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5jdXJyZW50QW5pbSA9IHRoaXMuX2FuaW1zW25hbWVdOwoJCQkgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSBmYWxzZTsKCQkJCXJldHVybiB0aGlzLmN1cnJlbnRBbmltLnBsYXkoZnJhbWVSYXRlLCBsb29wLCBraWxsT25Db21wbGV0ZSk7CgkJCX0KCQl9CgoJfSwKCgkvKioKCSogU3RvcCBwbGF5YmFjayBvZiBhbiBhbmltYXRpb24uIElmIGEgbmFtZSBpcyBnaXZlbiB0aGF0IHNwZWNpZmljIGFuaW1hdGlvbiBpcyBzdG9wcGVkLCBvdGhlcndpc2UgdGhlIGN1cnJlbnQgYW5pbWF0aW9uIGlzIHN0b3BwZWQuCgkqIFRoZSBjdXJyZW50QW5pbSBwcm9wZXJ0eSBvZiB0aGUgQW5pbWF0aW9uTWFuYWdlciBpcyBhdXRvbWF0aWNhbGx5IHNldCB0byB0aGUgYW5pbWF0aW9uIGdpdmVuLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI3N0b3AKCSogQHBhcmFtIHtzdHJpbmd9IFtuYW1lPW51bGxdIC0gVGhlIG5hbWUgb2YgdGhlIGFuaW1hdGlvbiB0byBiZSBzdG9wcGVkLCBlLmcuICJmaXJlIi4gSWYgbm9uZSBpcyBnaXZlbiB0aGUgY3VycmVudGx5IHJ1bm5pbmcgYW5pbWF0aW9uIGlzIHN0b3BwZWQuCgkqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0RnJhbWU9ZmFsc2VdIC0gV2hlbiB0aGUgYW5pbWF0aW9uIGlzIHN0b3BwZWQgc2hvdWxkIHRoZSBjdXJyZW50RnJhbWUgYmUgc2V0IHRvIHRoZSBmaXJzdCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uICh0cnVlKSBvciBwYXVzZWQgb24gdGhlIGxhc3QgZnJhbWUgZGlzcGxheWVkIChmYWxzZSkKCSovCglzdG9wOiBmdW5jdGlvbiAobmFtZSwgcmVzZXRGcmFtZSkgewoKCQlpZiAodHlwZW9mIHJlc2V0RnJhbWUgPT0gJ3VuZGVmaW5lZCcpIHsgcmVzZXRGcmFtZSA9IGZhbHNlOyB9CgoJCWlmICh0eXBlb2YgbmFtZSA9PSAnc3RyaW5nJykKCQl7CgkJCWlmICh0aGlzLl9hbmltc1tuYW1lXSkKCQkJewoJCQkJdGhpcy5jdXJyZW50QW5pbSA9IHRoaXMuX2FuaW1zW25hbWVdOwoJCQkJdGhpcy5jdXJyZW50QW5pbS5zdG9wKHJlc2V0RnJhbWUpOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCWlmICh0aGlzLmN1cnJlbnRBbmltKQoJCQl7CgkJCQl0aGlzLmN1cnJlbnRBbmltLnN0b3AocmVzZXRGcmFtZSk7CgkJCX0KCQl9CgoJfSwKCgkvKioKCSogVGhlIG1haW4gdXBkYXRlIGZ1bmN0aW9uIGlzIGNhbGxlZCBieSB0aGUgU3ByaXRlcyB1cGRhdGUgbG9vcC4gSXQncyByZXNwb25zaWJsZSBmb3IgdXBkYXRpbmcgYW5pbWF0aW9uIGZyYW1lcyBhbmQgZmlyaW5nIHJlbGF0ZWQgZXZlbnRzLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciN1cGRhdGUKCSogQHByb3RlY3RlZAogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGEgbmV3IGFuaW1hdGlvbiBmcmFtZSBoYXMgYmVlbiBzZXQsIG90aGVyd2lzZSBmYWxzZS4KCSovCgl1cGRhdGU6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMudXBkYXRlSWZWaXNpYmxlICYmIHRoaXMuc3ByaXRlLnZpc2libGUgPT0gZmFsc2UpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAodGhpcy5jdXJyZW50QW5pbSAmJiB0aGlzLmN1cnJlbnRBbmltLnVwZGF0ZSgpID09IHRydWUpCgkJewoJCQl0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEFuaW0uY3VycmVudEZyYW1lOwoJCQl0aGlzLnNwcml0ZS5jdXJyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTsKCQkJcmV0dXJuIHRydWU7CgkJfQoKCQlyZXR1cm4gZmFsc2U7CgoJfSwKCgkvKioKCSogUmV0dXJucyBhbiBhbmltYXRpb24gdGhhdCB3YXMgcHJldmlvdXNseSBhZGRlZCBieSBuYW1lLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2dldEFuaW1hdGlvbgoJKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBuYW1lIG9mIHRoZSBhbmltYXRpb24gdG8gYmUgcmV0dXJuZWQsIGUuZy4gImZpcmUiLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufGJvb2xlYW59IFRoZSBBbmltYXRpb24gaW5zdGFuY2UsIGlmIGZvdW5kLCBvdGhlcndpc2UgZmFsc2UuCgkqLwoJZ2V0QW5pbWF0aW9uOiBmdW5jdGlvbiAobmFtZSkgewoKCQlpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpCgkJewoJCQlpZiAodGhpcy5fYW5pbXNbbmFtZV0pCgkJCXsKCQkJCXJldHVybiB0aGlzLl9hbmltc1tuYW1lXTsKCQkJfQoJCX0KCgkJcmV0dXJuIGZhbHNlOwoKCX0sCgogICAgLyoqCiAgICAqIFJlZnJlc2hlcyB0aGUgY3VycmVudCBmcmFtZSBkYXRhIGJhY2sgdG8gdGhlIHBhcmVudCBTcHJpdGUgYW5kIGFsc28gcmVzZXRzIHRoZSB0ZXh0dXJlIGRhdGEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjcmVmcmVzaEZyYW1lCiAgICAqLwoJcmVmcmVzaEZyYW1lOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuc3ByaXRlLmN1cnJlbnRGcmFtZSA9IHRoaXMuY3VycmVudEZyYW1lOwoJCXRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwoKCX0sCgogICAgLyoqCiAgICAqIERlc3Ryb3lzIGFsbCByZWZlcmVuY2VzIHRoaXMgQW5pbWF0aW9uTWFuYWdlciBjb250YWlucy4gU2V0cyB0aGUgX2FuaW1zIHRvIGEgbmV3IG9iamVjdCBhbmQgbnVsbHMgdGhlIGN1cnJlbnQgYW5pbWF0aW9uLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2Rlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuX2FuaW1zID0ge307CiAgICAgICAgdGhpcy5fZnJhbWVEYXRhID0gbnVsbDsKICAgICAgICB0aGlzLl9mcmFtZUluZGV4ID0gMDsKICAgICAgICB0aGlzLmN1cnJlbnRBbmltID0gbnVsbDsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IG51bGw7CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lRGF0YQoqIEBwcm9wZXJ0eSB7UGhhc2VyLkZyYW1lRGF0YX0gZnJhbWVEYXRhIC0gVGhlIGN1cnJlbnQgYW5pbWF0aW9ucyBGcmFtZURhdGEuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICJmcmFtZURhdGEiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lRGF0YTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIjZnJhbWVUb3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZVRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhlIGN1cnJlbnRseSBsb2FkZWQgRnJhbWVEYXRhLCBvciAtMSBpZiBubyBGcmFtZURhdGEgaXMgbG9hZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAiZnJhbWVUb3RhbCIsIHsKIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLl9mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVEYXRhLnRvdGFsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uTWFuYWdlciNwYXVzZWQKKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZCAtIEdldHMgYW5kIHNldHMgdGhlIHBhdXNlZCBzdGF0ZSBvZiB0aGUgY3VycmVudCBhbmltYXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uTWFuYWdlci5wcm90b3R5cGUsICJwYXVzZWQiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRBbmltLmlzUGF1c2VkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdGhpcy5jdXJyZW50QW5pbS5wYXVzZWQgPSB2YWx1ZTsKCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbk1hbmFnZXIucHJvdG90eXBlLCAiZnJhbWUiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgCWlmICh0aGlzLmN1cnJlbnRGcmFtZSkKICAgIAl7CgkgICAgICAgIHJldHVybiB0aGlzLl9mcmFtZUluZGV4OwoJICAgIH0KCSAgICAKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgdGhpcy5fZnJhbWVEYXRhICYmIHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSkgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB2YWx1ZTsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CgkJCXRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb25NYW5hZ2VyI2ZyYW1lTmFtZQoqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmcmFtZU5hbWUgLSBHZXRzIG9yIHNldHMgdGhlIGN1cnJlbnQgZnJhbWUgbmFtZSBhbmQgdXBkYXRlcyB0aGUgVGV4dHVyZSBDYWNoZSBmb3IgZGlzcGxheS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5BbmltYXRpb25NYW5hZ2VyLnByb3RvdHlwZSwgImZyYW1lTmFtZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAJaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgCXsKCSAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLm5hbWU7CiAgICAJfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdGhpcy5fZnJhbWVEYXRhICYmIHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZSh2YWx1ZSkgIT09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZUJ5TmFtZSh2YWx1ZSk7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB0aGlzLmN1cnJlbnRGcmFtZS5pbmRleDsKICAgICAgICAgICAgdGhpcy5zcHJpdGUuY3VycmVudEZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7CgkJCXRoaXMuc3ByaXRlLnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIkNhbm5vdCBzZXQgZnJhbWVOYW1lOiAiICsgdmFsdWUpOwogICAgICAgIH0KICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogQW4gQW5pbWF0aW9uIGluc3RhbmNlIGNvbnRhaW5zIGEgc2luZ2xlIGFuaW1hdGlvbiBhbmQgdGhlIGNvbnRyb2xzIHRvIHBsYXkgaXQuCiogSXQgaXMgY3JlYXRlZCBieSB0aGUgQW5pbWF0aW9uTWFuYWdlciwgY29uc2lzdHMgb2YgQW5pbWF0aW9uLkZyYW1lIG9iamVjdHMgYW5kIGJlbG9uZ3MgdG8gYSBzaW5nbGUgR2FtZSBPYmplY3Qgc3VjaCBhcyBhIFNwcml0ZS4KKgoqIEBjbGFzcyBQaGFzZXIuQW5pbWF0aW9uCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gcGFyZW50IC0gQSByZWZlcmVuY2UgdG8gdGhlIG93bmVyIG9mIHRoaXMgQW5pbWF0aW9uLgoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIHVuaXF1ZSBuYW1lIGZvciB0aGlzIGFuaW1hdGlvbiwgdXNlZCBpbiBwbGF5YmFjayBjb21tYW5kcy4KKiBAcGFyYW0ge1BoYXNlci5GcmFtZURhdGF9IGZyYW1lRGF0YSAtIFRoZSBGcmFtZURhdGEgb2JqZWN0IHRoYXQgY29udGFpbnMgYWxsIGZyYW1lcyB1c2VkIGJ5IHRoaXMgQW5pbWF0aW9uLgoqIEBwYXJhbSB7KEFycmF5LjxudW1iZXI+fEFycmF5LjxzdHJpbmc+KX0gZnJhbWVzIC0gQW4gYXJyYXkgb2YgbnVtYmVycyBvciBzdHJpbmdzIGluZGljYXRpbmcgd2hpY2ggZnJhbWVzIHRvIHBsYXkgaW4gd2hpY2ggb3JkZXIuCiogQHBhcmFtIHtudW1iZXJ9IGRlbGF5IC0gVGhlIHRpbWUgYmV0d2VlbiBlYWNoIGZyYW1lIG9mIHRoZSBhbmltYXRpb24sIGdpdmVuIGluIG1zLgoqIEBwYXJhbSB7Ym9vbGVhbn0gbG9vcGVkIC0gU2hvdWxkIHRoaXMgYW5pbWF0aW9uIGxvb3Agb3IgcGxheSB0aHJvdWdoIG9uY2UuCiovClBoYXNlci5BbmltYXRpb24gPSBmdW5jdGlvbiAoZ2FtZSwgcGFyZW50LCBuYW1lLCBmcmFtZURhdGEsIGZyYW1lcywgZGVsYXksIGxvb3BlZCkgewoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuU3ByaXRlfSBfcGFyZW50IC0gQSByZWZlcmVuY2UgdG8gdGhlIHBhcmVudCBTcHJpdGUgdGhhdCBvd25zIHRoaXMgQW5pbWF0aW9uLgogICAgKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX3BhcmVudCA9IHBhcmVudDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuRnJhbWVEYXRhfSBfZnJhbWVEYXRhIC0gVGhlIEZyYW1lRGF0YSB0aGUgQW5pbWF0aW9uIHVzZXMuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZnJhbWVEYXRhID0gZnJhbWVEYXRhOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge3N0cmluZ30gbmFtZSAtIFRoZSB1c2VyIGRlZmluZWQgbmFtZSBnaXZlbiB0byB0aGlzIEFuaW1hdGlvbi4KICAgICovCiAgICB0aGlzLm5hbWUgPSBuYW1lOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX2ZyYW1lcwogICAgKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX2ZyYW1lcyA9IFtdOwogICAgdGhpcy5fZnJhbWVzID0gdGhpcy5fZnJhbWVzLmNvbmNhdChmcmFtZXMpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZGVsYXkgLSBUaGUgZGVsYXkgaW4gbXMgYmV0d2VlbiBlYWNoIGZyYW1lIG9mIHRoZSBBbmltYXRpb24uCiAgICAqLwoJdGhpcy5kZWxheSA9IDEwMDAgLyBkZWxheTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBsb29wZWQgLSBUaGUgbG9vcCBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLgogICAgKi8KCXRoaXMubG9vcGVkID0gbG9vcGVkOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGxvb3BlZCAtIFRoZSBsb29wIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uCiAgICAqLwogICAgdGhpcy5raWxsT25Db21wbGV0ZSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzRmluaXNoZWQgLSBUaGUgZmluaXNoZWQgc3RhdGUgb2YgdGhlIEFuaW1hdGlvbi4gU2V0IHRvIHRydWUgb25jZSBwbGF5YmFjayBjb21wbGV0ZXMsIGZhbHNlIGR1cmluZyBwbGF5YmFjay4KICAgICogQGRlZmF1bHQKICAgICovCgl0aGlzLmlzRmluaXNoZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpc1BsYXlpbmcgLSBUaGUgcGxheWluZyBzdGF0ZSBvZiB0aGUgQW5pbWF0aW9uLiBTZXQgdG8gZmFsc2Ugb25jZSBwbGF5YmFjayBjb21wbGV0ZXMsIHRydWUgZHVyaW5nIHBsYXliYWNrLgogICAgKiBAZGVmYXVsdAogICAgKi8KCXRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNQYXVzZWQgLSBUaGUgcGF1c2VkIHN0YXRlIG9mIHRoZSBBbmltYXRpb24uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5pc1BhdXNlZCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IF9wYXVzZVN0YXJ0VGltZSAtIFRoZSB0aW1lIHRoZSBhbmltYXRpb24gcGF1c2VkLgogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuX3BhdXNlU3RhcnRUaW1lID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9mcmFtZUluZGV4CiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwoJdGhpcy5fZnJhbWVJbmRleCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZnJhbWVEaWZmCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fZnJhbWVEaWZmID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9mcmFtZVNraXAKICAgICogQHByaXZhdGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLl9mcmFtZVNraXAgPSAxOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5GcmFtZX0gY3VycmVudEZyYW1lIC0gVGhlIGN1cnJlbnRseSBkaXNwbGF5ZWQgZnJhbWUgb2YgdGhlIEFuaW1hdGlvbi4KICAgICovCgl0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVJbmRleF0pOwoJCn07CgpQaGFzZXIuQW5pbWF0aW9uLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogUGxheXMgdGhpcyBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNwbGF5CiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbZnJhbWVSYXRlPW51bGxdIC0gVGhlIGZyYW1lcmF0ZSB0byBwbGF5IHRoZSBhbmltYXRpb24gYXQuIFRoZSBzcGVlZCBpcyBnaXZlbiBpbiBmcmFtZXMgcGVyIHNlY29uZC4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBmcmFtZVJhdGUgb2YgdGhlIEFuaW1hdGlvbiBpcyB1c2VkLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFNob3VsZCB0aGUgYW5pbWF0aW9uIGJlIGxvb3BlZCBhZnRlciBwbGF5YmFjay4gSWYgbm90IHByb3ZpZGVkIHRoZSBwcmV2aW91c2x5IHNldCBsb29wIHZhbHVlIG9mIHRoZSBBbmltYXRpb24gaXMgdXNlZC4KICAgICogQHBhcmFtIHtib29sZWFufSBba2lsbE9uQ29tcGxldGU9ZmFsc2VdIC0gSWYgc2V0IHRvIHRydWUgd2hlbiB0aGUgYW5pbWF0aW9uIGNvbXBsZXRlcyAob25seSBoYXBwZW5zIGlmIGxvb3A9ZmFsc2UpIHRoZSBwYXJlbnQgU3ByaXRlIHdpbGwgYmUga2lsbGVkLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuQW5pbWF0aW9ufSAtIEEgcmVmZXJlbmNlIHRvIHRoaXMgQW5pbWF0aW9uIGluc3RhbmNlLgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChmcmFtZVJhdGUsIGxvb3AsIGtpbGxPbkNvbXBsZXRlKSB7CgogICAgICAgIGlmICh0eXBlb2YgZnJhbWVSYXRlID09PSAnbnVtYmVyJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBJZiB0aGV5IHNldCBhIG5ldyBmcmFtZSByYXRlIHRoZW4gdXNlIGl0LCBvdGhlcndpc2UgdXNlIHRoZSBvbmUgc2V0IG9uIGNyZWF0aW9uCiAgICAgICAgICAgIHRoaXMuZGVsYXkgPSAxMDAwIC8gZnJhbWVSYXRlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHR5cGVvZiBsb29wID09PSAnYm9vbGVhbicpCiAgICAgICAgewogICAgICAgICAgICAvLyAgSWYgdGhleSBzZXQgYSBuZXcgbG9vcCB2YWx1ZSB0aGVuIHVzZSBpdCwgb3RoZXJ3aXNlIHVzZSB0aGUgb25lIHNldCBvbiBjcmVhdGlvbgogICAgICAgICAgICB0aGlzLmxvb3BlZCA9IGxvb3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodHlwZW9mIGtpbGxPbkNvbXBsZXRlICE9PSAndW5kZWZpbmVkJykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBSZW1vdmUgdGhlIHBhcmVudCBzcHJpdGUgb25jZSB0aGUgYW5pbWF0aW9uIGhhcyBmaW5pc2hlZD8KICAgICAgICAgICAgdGhpcy5raWxsT25Db21wbGV0ZSA9IGtpbGxPbkNvbXBsZXRlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IGZhbHNlOwogICAgICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CgogICAgICAgIHRoaXMuX3RpbWVMYXN0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgdGhpcy5fdGltZU5leHRGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZGVsYXk7CgogICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSAwOwoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh0aGlzLl9mcmFtZXNbdGhpcy5fZnJhbWVJbmRleF0pOwoJCXRoaXMuX3BhcmVudC5zZXRUZXh0dXJlKFBJWEkuVGV4dHVyZUNhY2hlW3RoaXMuY3VycmVudEZyYW1lLnV1aWRdKTsKCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudC5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uU3RhcnQuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiB0aGlzOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhpcyBhbmltYXRpb24gYmFjayB0byB0aGUgZmlyc3QgZnJhbWUgYW5kIHJlc3RhcnRzIHRoZSBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNyZXN0YXJ0CiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgcmVzdGFydDogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IHRydWU7CiAgICAgICAgdGhpcy5pc0ZpbmlzaGVkID0gZmFsc2U7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgdGhpcy5fdGltZUxhc3RGcmFtZSA9IHRoaXMuZ2FtZS50aW1lLm5vdzsKICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5kZWxheTsKCiAgICAgICAgdGhpcy5fZnJhbWVJbmRleCA9IDA7CgogICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZUluZGV4XSk7CgogICAgfSwKCiAgICAvKioKICAgICogU3RvcHMgcGxheWJhY2sgb2YgdGhpcyBhbmltYXRpb24gYW5kIHNldCBpdCB0byBhIGZpbmlzaGVkIHN0YXRlLiBJZiBhIHJlc2V0RnJhbWUgaXMgcHJvdmlkZWQgaXQgd2lsbCBzdG9wIHBsYXliYWNrIGFuZCBzZXQgZnJhbWUgdG8gdGhlIGZpcnN0IGluIHRoZSBhbmltYXRpb24uCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNzdG9wCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3Jlc2V0RnJhbWU9ZmFsc2VdIC0gSWYgdHJ1ZSBhZnRlciB0aGUgYW5pbWF0aW9uIHN0b3BzIHRoZSBjdXJyZW50RnJhbWUgdmFsdWUgd2lsbCBiZSBzZXQgdG8gdGhlIGZpcnN0IGZyYW1lIGluIHRoaXMgYW5pbWF0aW9uLgogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uIChyZXNldEZyYW1lKSB7CgogICAgICAgIGlmICh0eXBlb2YgcmVzZXRGcmFtZSA9PT0gJ3VuZGVmaW5lZCcpIHsgcmVzZXRGcmFtZSA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5pc0ZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLnBhdXNlZCA9IGZhbHNlOwoKICAgICAgICBpZiAocmVzZXRGcmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEZyYW1lID0gdGhpcy5fZnJhbWVEYXRhLmdldEZyYW1lKHRoaXMuX2ZyYW1lc1swXSk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFVwZGF0ZXMgdGhpcyBhbmltYXRpb24uIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBBbmltYXRpb25NYW5hZ2VyLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jdXBkYXRlCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLmlzUGF1c2VkKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nID09IHRydWUgJiYgdGhpcy5nYW1lLnRpbWUubm93ID49IHRoaXMuX3RpbWVOZXh0RnJhbWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9mcmFtZVNraXAgPSAxOwoKICAgICAgICAgICAgLy8gIExhZ2dpbmc/CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lRGlmZiA9IHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMuX3RpbWVOZXh0RnJhbWU7CgogICAgICAgICAgICB0aGlzLl90aW1lTGFzdEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwoKICAgICAgICAgICAgaWYgKHRoaXMuX2ZyYW1lRGlmZiA+IHRoaXMuZGVsYXkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSBuZWVkIHRvIHNraXAgYSBmcmFtZSwgd29yayBvdXQgaG93IG1hbnkKICAgICAgICAgICAgICAgIHRoaXMuX2ZyYW1lU2tpcCA9IE1hdGguZmxvb3IodGhpcy5fZnJhbWVEaWZmIC8gdGhpcy5kZWxheSk7CgogICAgICAgICAgICAgICAgdGhpcy5fZnJhbWVEaWZmIC09ICh0aGlzLl9mcmFtZVNraXAgKiB0aGlzLmRlbGF5KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIEFuZCB3aGF0J3MgbGVmdCBub3c/CiAgICAgICAgICAgIHRoaXMuX3RpbWVOZXh0RnJhbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgKyAodGhpcy5kZWxheSAtIHRoaXMuX2ZyYW1lRGlmZik7CgogICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ICs9IHRoaXMuX2ZyYW1lU2tpcDsKCiAgICAgICAgICAgIGlmICh0aGlzLl9mcmFtZUluZGV4ID49IHRoaXMuX2ZyYW1lcy5sZW5ndGgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3BlZCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9mcmFtZUluZGV4ICU9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uTG9vcC5kaXNwYXRjaCh0aGlzLl9wYXJlbnQsIHRoaXMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMub25Db21wbGV0ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50RnJhbWUgPSB0aGlzLl9mcmFtZURhdGEuZ2V0RnJhbWUodGhpcy5fZnJhbWVzW3RoaXMuX2ZyYW1lSW5kZXhdKTsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDbGVhbnMgdXAgdGhpcyBhbmltYXRpb24gcmVhZHkgZm9yIGRlbGV0aW9uLiBOdWxscyBhbGwgdmFsdWVzIGFuZCByZWZlcmVuY2VzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24jZGVzdHJveQogICAgKiBAbWVtYmVyb2YgUGhhc2VyLkFuaW1hdGlvbgogICAgKi8KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdGhpcy5nYW1lID0gbnVsbDsKICAgICAgICB0aGlzLl9wYXJlbnQgPSBudWxsOwogICAgICAgIHRoaXMuX2ZyYW1lcyA9IG51bGw7CiAgICAgICAgdGhpcy5fZnJhbWVEYXRhID0gbnVsbDsKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IG51bGw7CiAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgaW50ZXJuYWxseSB3aGVuIHRoZSBhbmltYXRpb24gZmluaXNoZXMgcGxheWJhY2suIFNldHMgdGhlIGlzUGxheWluZyBhbmQgaXNGaW5pc2hlZCBzdGF0ZXMgYW5kIGRpc3BhdGNoZXMgdGhlIG9uQW5pbWF0aW9uQ29tcGxldGUgZXZlbnQgaWYgaXQgZXhpc3RzIG9uIHRoZSBwYXJlbnQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvbiNvbkNvbXBsZXRlCiAgICAqIEBtZW1iZXJvZiBQaGFzZXIuQW5pbWF0aW9uCiAgICAqLwogICAgb25Db21wbGV0ZTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmlzUGxheWluZyA9IGZhbHNlOwogICAgICAgIHRoaXMuaXNGaW5pc2hlZCA9IHRydWU7CiAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKHRoaXMuX3BhcmVudC5ldmVudHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9wYXJlbnQuZXZlbnRzLm9uQW5pbWF0aW9uQ29tcGxldGUuZGlzcGF0Y2godGhpcy5fcGFyZW50LCB0aGlzKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmtpbGxPbkNvbXBsZXRlKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcGFyZW50LmtpbGwoKTsKICAgICAgICB9CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb24jcGF1c2VkCiogQHByb3BlcnR5IHtib29sZWFufSBwYXVzZWQgLSBHZXRzIGFuZCBzZXRzIHRoZSBwYXVzZWQgc3RhdGUgb2YgdGhpcyBBbmltYXRpb24uCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuQW5pbWF0aW9uLnByb3RvdHlwZSwgInBhdXNlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuaXNQYXVzZWQ7CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLmlzUGF1c2VkID0gdmFsdWU7CgogICAgICAgIGlmICh2YWx1ZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBQYXVzZWQKICAgICAgICAgICAgdGhpcy5fcGF1c2VTdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBVbi1wYXVzZWQKICAgICAgICAgICAgaWYgKHRoaXMuaXNQbGF5aW5nKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl90aW1lTmV4dEZyYW1lID0gdGhpcy5nYW1lLnRpbWUubm93ICsgdGhpcy5kZWxheTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5BbmltYXRpb24jZnJhbWVUb3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmcmFtZVRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhlIGN1cnJlbnRseSBsb2FkZWQgRnJhbWVEYXRhLCBvciAtMSBpZiBubyBGcmFtZURhdGEgaXMgbG9hZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICJmcmFtZVRvdGFsIiwgewoKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl9mcmFtZXMubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuQW5pbWF0aW9uI2ZyYW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IGZyYW1lIC0gR2V0cyBvciBzZXRzIHRoZSBjdXJyZW50IGZyYW1lIGluZGV4IGFuZCB1cGRhdGVzIHRoZSBUZXh0dXJlIENhY2hlIGZvciBkaXNwbGF5LgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkFuaW1hdGlvbi5wcm90b3R5cGUsICJmcmFtZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuY3VycmVudEZyYW1lICE9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEZyYW1lLmluZGV4OwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVJbmRleDsKICAgICAgICB9CgogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICB0aGlzLmN1cnJlbnRGcmFtZSA9IHRoaXMuX2ZyYW1lRGF0YS5nZXRGcmFtZSh2YWx1ZSk7CgogICAgICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZSAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ZyYW1lSW5kZXggPSB2YWx1ZTsKCQkJdGhpcy5fcGFyZW50LnNldFRleHR1cmUoUElYSS5UZXh0dXJlQ2FjaGVbdGhpcy5jdXJyZW50RnJhbWUudXVpZF0pOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCi8qKgoqIFJlYWxseSBoYW5keSBmdW5jdGlvbiBmb3Igd2hlbiB5b3UgYXJlIGNyZWF0aW5nIGFycmF5cyBvZiBhbmltYXRpb24gZGF0YSBidXQgaXQncyB1c2luZyBmcmFtZSBuYW1lcyBhbmQgbm90IG51bWJlcnMuCiogRm9yIGV4YW1wbGUgaW1hZ2luZSB5b3UndmUgZ290IDMwIGZyYW1lcyBuYW1lZDogJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0byAnZXhwbG9zaW9uXzAwMzAtbGFyZ2UnCiogWW91IGNvdWxkIHVzZSB0aGlzIGZ1bmN0aW9uIHRvIGdlbmVyYXRlIHRob3NlIGJ5IGRvaW5nOiBQaGFzZXIuQW5pbWF0aW9uLmdlbmVyYXRlRnJhbWVOYW1lcygnZXhwbG9zaW9uXycsIDEsIDMwLCAnLWxhcmdlJywgNCk7CioKKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb24uZ2VuZXJhdGVGcmFtZU5hbWVzCiogQHBhcmFtIHtzdHJpbmd9IHByZWZpeCAtIFRoZSBzdGFydCBvZiB0aGUgZmlsZW5hbWUuIElmIHRoZSBmaWxlbmFtZSB3YXMgJ2V4cGxvc2lvbl8wMDAxLWxhcmdlJyB0aGUgcHJlZml4IHdvdWxkIGJlICdleHBsb3Npb25fJy4KKiBAcGFyYW0ge251bWJlcn0gc3RhcnQgLSBUaGUgbnVtYmVyIHRvIHN0YXJ0IHNlcXVlbnRpYWxseSBjb3VudGluZyBmcm9tLiBJZiB5b3VyIGZyYW1lcyBhcmUgbmFtZWQgJ2V4cGxvc2lvbl8wMDAxJyB0byAnZXhwbG9zaW9uXzAwMzQnIHRoZSBzdGFydCBpcyAxLgoqIEBwYXJhbSB7bnVtYmVyfSBzdG9wIC0gVGhlIG51bWJlciB0byBjb3VudCB0by4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGUgc3RvcCB2YWx1ZSBpcyAzNC4KKiBAcGFyYW0ge3N0cmluZ30gW3N1ZmZpeD0nJ10gLSBUaGUgZW5kIG9mIHRoZSBmaWxlbmFtZS4gSWYgdGhlIGZpbGVuYW1lIHdhcyAnZXhwbG9zaW9uXzAwMDEtbGFyZ2UnIHRoZSBwcmVmaXggd291bGQgYmUgJy1sYXJnZScuCiogQHBhcmFtIHtudW1iZXJ9IFt6ZXJvUGFkPTBdIC0gVGhlIG51bWJlciBvZiB6ZXJvZXMgdG8gcGFkIHRoZSBtaW4gYW5kIG1heCB2YWx1ZXMgd2l0aC4gSWYgeW91ciBmcmFtZXMgYXJlIG5hbWVkICdleHBsb3Npb25fMDAwMScgdG8gJ2V4cGxvc2lvbl8wMDM0JyB0aGVuIHRoZSB6ZXJvUGFkIGlzIDQuCiovClBoYXNlci5BbmltYXRpb24uZ2VuZXJhdGVGcmFtZU5hbWVzID0gZnVuY3Rpb24gKHByZWZpeCwgc3RhcnQsIHN0b3AsIHN1ZmZpeCwgemVyb1BhZCkgewoKICAgIGlmICh0eXBlb2Ygc3VmZml4ID09ICd1bmRlZmluZWQnKSB7IHN1ZmZpeCA9ICcnOyB9CgogICAgdmFyIG91dHB1dCA9IFtdOwogICAgdmFyIGZyYW1lID0gJyc7CgogICAgaWYgKHN0YXJ0IDwgc3RvcCkKICAgIHsKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPD0gc3RvcDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiB6ZXJvUGFkID09ICdudW1iZXInKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgc3RyLCBsZW4sIHBhZCwgZGlyCiAgICAgICAgICAgICAgICBmcmFtZSA9IFBoYXNlci5VdGlscy5wYWQoaS50b1N0cmluZygpLCB6ZXJvUGFkLCAnMCcsIDEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZnJhbWUgPSBpLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZyYW1lID0gcHJlZml4ICsgZnJhbWUgKyBzdWZmaXg7CgogICAgICAgICAgICBvdXRwdXQucHVzaChmcmFtZSk7CiAgICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGZvciAodmFyIGkgPSBzdGFydDsgaSA+PSBzdG9wOyBpLS0pCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIHplcm9QYWQgPT0gJ251bWJlcicpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBzdHIsIGxlbiwgcGFkLCBkaXIKICAgICAgICAgICAgICAgIGZyYW1lID0gUGhhc2VyLlV0aWxzLnBhZChpLnRvU3RyaW5nKCksIHplcm9QYWQsICcwJywgMSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmcmFtZSA9IGkudG9TdHJpbmcoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZnJhbWUgPSBwcmVmaXggKyBmcmFtZSArIHN1ZmZpeDsKCiAgICAgICAgICAgIG91dHB1dC5wdXNoKGZyYW1lKTsKICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIG91dHB1dDsKCn0KCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgRnJhbWUgaXMgYSBzaW5nbGUgZnJhbWUgb2YgYW4gYW5pbWF0aW9uIGFuZCBpcyBwYXJ0IG9mIGEgRnJhbWVEYXRhIGNvbGxlY3Rpb24uCioKKiBAY2xhc3MgUGhhc2VyLkZyYW1lCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgRnJhbWUgd2l0aGluIHRoZSBGcmFtZURhdGEgc2V0IGl0IGlzIGJlaW5nIGFkZGVkIHRvLgoqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFdpZHRoIG9mIHRoZSBmcmFtZSB3aXRoaW4gdGhlIHRleHR1cmUgaW1hZ2UuCiogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIEhlaWdodCBvZiB0aGUgZnJhbWUgd2l0aGluIHRoZSB0ZXh0dXJlIGltYWdlLgoqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGZyYW1lLiBJbiBUZXh0dXJlIEF0bGFzIGRhdGEgdGhpcyBpcyB1c3VhbGx5IHNldCB0byB0aGUgZmlsZW5hbWUuCiogQHBhcmFtIHtzdHJpbmd9IHV1aWQgLSBJbnRlcm5hbCBVVUlEIGtleS4KKi8KUGhhc2VyLkZyYW1lID0gZnVuY3Rpb24gKGluZGV4LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBuYW1lLCB1dWlkKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGlzIEZyYW1lIHdpdGhpbiB0aGUgRnJhbWVEYXRhIHNldCBpdCBpcyBiZWluZyBhZGRlZCB0by4KCSovCgl0aGlzLmluZGV4ID0gaW5kZXg7CgkKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0geCAtIFggcG9zaXRpb24gd2l0aGluIHRoZSBpbWFnZSB0byBjdXQgZnJvbS4KCSovCgl0aGlzLnggPSB4OwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0geSAtIFkgcG9zaXRpb24gd2l0aGluIHRoZSBpbWFnZSB0byBjdXQgZnJvbS4KCSovCgl0aGlzLnkgPSB5OwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGggLSBXaWR0aCBvZiB0aGUgZnJhbWUuCgkqLwoJdGhpcy53aWR0aCA9IHdpZHRoOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBmcmFtZS4KCSovCgl0aGlzLmhlaWdodCA9IGhlaWdodDsKCgkvKioKCSogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBVc2VmdWwgZm9yIFRleHR1cmUgQXRsYXMgZmlsZXMgKGlzIHNldCB0byB0aGUgZmlsZW5hbWUgdmFsdWUpLgoJKi8KCXRoaXMubmFtZSA9IG5hbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1dWlkIC0gQSBsaW5rIHRvIHRoZSBQSVhJLlRleHR1cmVDYWNoZSBlbnRyeS4KCSovCgl0aGlzLnV1aWQgPSB1dWlkOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWCAtIENlbnRlciBYIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCgkqLwogICAgdGhpcy5jZW50ZXJYID0gTWF0aC5mbG9vcih3aWR0aCAvIDIpOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gY2VudGVyWSAtIENlbnRlciBZIHBvc2l0aW9uIHdpdGhpbiB0aGUgaW1hZ2UgdG8gY3V0IGZyb20uCgkqLwogICAgdGhpcy5jZW50ZXJZID0gTWF0aC5mbG9vcihoZWlnaHQgLyAyKTsKCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGRpc3RhbmNlIC0gVGhlIGRpc3RhbmNlIGZyb20gdGhlIHRvcCBsZWZ0IHRvIHRoZSBib3R0b20tcmlnaHQgb2YgdGhpcyBGcmFtZS4KCSovCgl0aGlzLmRpc3RhbmNlID0gUGhhc2VyLk1hdGguZGlzdGFuY2UoMCwgMCwgd2lkdGgsIGhlaWdodCk7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gcm90YXRlZCAtIFJvdGF0ZWQ/IChub3QgeWV0IGltcGxlbWVudGVkKQoJKiBAZGVmYXVsdAoJKi8KCXRoaXMucm90YXRlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gcm90YXRpb25EaXJlY3Rpb24gLSBFaXRoZXIgJ2N3JyBvciAnY2N3Jywgcm90YXRpb24gaXMgYWx3YXlzIDkwIGRlZ3JlZXMuCgkqIEBkZWZhdWx0ICdjdycKCSovCgl0aGlzLnJvdGF0aW9uRGlyZWN0aW9uID0gJ2N3JzsKCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSB0cmltbWVkIC0gV2FzIGl0IHRyaW1tZWQgd2hlbiBwYWNrZWQ/CgkqIEBkZWZhdWx0CgkqLwoJdGhpcy50cmltbWVkID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzb3VyY2VTaXplVyAtIFdpZHRoIG9mIHRoZSBvcmlnaW5hbCBzcHJpdGUuCgkqLwogICAgdGhpcy5zb3VyY2VTaXplVyA9IHdpZHRoOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlU2l6ZUggLSBIZWlnaHQgb2YgdGhlIG9yaWdpbmFsIHNwcml0ZS4KCSovCiAgICB0aGlzLnNvdXJjZVNpemVIID0gaGVpZ2h0OwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVggLSBYIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIHNwcml0ZSBpbnNpZGUgb3JpZ2luYWwgc3ByaXRlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuc3ByaXRlU291cmNlU2l6ZVggPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVkgLSBZIHBvc2l0aW9uIG9mIHRoZSB0cmltbWVkIHNwcml0ZSBpbnNpZGUgb3JpZ2luYWwgc3ByaXRlLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuc3ByaXRlU291cmNlU2l6ZVkgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gc3ByaXRlU291cmNlU2l6ZVcgLSBXaWR0aCBvZiB0aGUgdHJpbW1lZCBzcHJpdGUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5zcHJpdGVTb3VyY2VTaXplVyA9IDA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBzcHJpdGVTb3VyY2VTaXplSCAtIEhlaWdodCBvZiB0aGUgdHJpbW1lZCBzcHJpdGUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5zcHJpdGVTb3VyY2VTaXplSCA9IDA7Cgp9OwoKUGhhc2VyLkZyYW1lLnByb3RvdHlwZSA9IHsKCgkvKioKCSogSWYgdGhlIGZyYW1lIHdhcyB0cmltbWVkIHdoZW4gYWRkZWQgdG8gdGhlIFRleHR1cmUgQXRsYXMgdGhpcyByZWNvcmRzIHRoZSB0cmltIGFuZCBzb3VyY2UgZGF0YS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuRnJhbWUjc2V0VHJpbQoJKiBAcGFyYW0ge2Jvb2xlYW59IHRyaW1tZWQgLSBJZiB0aGlzIGZyYW1lIHdhcyB0cmltbWVkIG9yIG5vdC4KCSogQHBhcmFtIHtudW1iZXJ9IGFjdHVhbFdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBmcmFtZSBiZWZvcmUgYmVpbmcgdHJpbW1lZC4KCSogQHBhcmFtIHtudW1iZXJ9IGFjdHVhbEhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGZyYW1lIGJlZm9yZSBiZWluZyB0cmltbWVkLgoJKiBAcGFyYW0ge251bWJlcn0gZGVzdFggLSBUaGUgZGVzdGluYXRpb24gWCBwb3NpdGlvbiBvZiB0aGUgdHJpbW1lZCBmcmFtZSBmb3IgZGlzcGxheS4KCSogQHBhcmFtIHtudW1iZXJ9IGRlc3RZIC0gVGhlIGRlc3RpbmF0aW9uIFkgcG9zaXRpb24gb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCgkqIEBwYXJhbSB7bnVtYmVyfSBkZXN0V2lkdGggLSBUaGUgZGVzdGluYXRpb24gd2lkdGggb2YgdGhlIHRyaW1tZWQgZnJhbWUgZm9yIGRpc3BsYXkuCgkqIEBwYXJhbSB7bnVtYmVyfSBkZXN0SGVpZ2h0IC0gVGhlIGRlc3RpbmF0aW9uIGhlaWdodCBvZiB0aGUgdHJpbW1lZCBmcmFtZSBmb3IgZGlzcGxheS4KCSovCiAgICBzZXRUcmltOiBmdW5jdGlvbiAodHJpbW1lZCwgYWN0dWFsV2lkdGgsIGFjdHVhbEhlaWdodCwgZGVzdFgsIGRlc3RZLCBkZXN0V2lkdGgsIGRlc3RIZWlnaHQpIHsKCiAgICAgICAgdGhpcy50cmltbWVkID0gdHJpbW1lZDsKCiAgICAgICAgaWYgKHRyaW1tZWQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLndpZHRoID0gYWN0dWFsV2lkdGg7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gYWN0dWFsSGVpZ2h0OwogICAgICAgICAgICB0aGlzLnNvdXJjZVNpemVXID0gYWN0dWFsV2lkdGg7CiAgICAgICAgICAgIHRoaXMuc291cmNlU2l6ZUggPSBhY3R1YWxIZWlnaHQ7CgkJICAgIHRoaXMuY2VudGVyWCA9IE1hdGguZmxvb3IoYWN0dWFsV2lkdGggLyAyKTsKCQkgICAgdGhpcy5jZW50ZXJZID0gTWF0aC5mbG9vcihhY3R1YWxIZWlnaHQgLyAyKTsKICAgICAgICAgICAgdGhpcy5zcHJpdGVTb3VyY2VTaXplWCA9IGRlc3RYOwogICAgICAgICAgICB0aGlzLnNwcml0ZVNvdXJjZVNpemVZID0gZGVzdFk7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZVcgPSBkZXN0V2lkdGg7CiAgICAgICAgICAgIHRoaXMuc3ByaXRlU291cmNlU2l6ZUggPSBkZXN0SGVpZ2h0OwogICAgICAgIH0KCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogRnJhbWVEYXRhIGlzIGEgY29udGFpbmVyIGZvciBGcmFtZSBvYmplY3RzLCB3aGljaCBhcmUgdGhlIGludGVybmFsIHJlcHJlc2VudGF0aW9uIG9mIGFuaW1hdGlvbiBkYXRhIGluIFBoYXNlci4KKgoqIEBjbGFzcyBQaGFzZXIuRnJhbWVEYXRhCiogQGNvbnN0cnVjdG9yCiovClBoYXNlci5GcmFtZURhdGEgPSBmdW5jdGlvbiAoKSB7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9mcmFtZXMgLSBMb2NhbCBhcnJheSBvZiBmcmFtZXMuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fZnJhbWVzID0gW107CgoKCS8qKgoJKiBAcHJvcGVydHkge0FycmF5fSBfZnJhbWVOYW1lcyAtIExvY2FsIGFycmF5IG9mIGZyYW1lIG5hbWVzIGZvciBuYW1lIHRvIGluZGV4IGNvbnZlcnNpb25zLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2ZyYW1lTmFtZXMgPSBbXTsKCn07CgpQaGFzZXIuRnJhbWVEYXRhLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkcyBhIG5ldyBGcmFtZSB0byB0aGlzIEZyYW1lRGF0YSBjb2xsZWN0aW9uLiBUeXBpY2FsbHkgY2FsbGVkIGJ5IHRoZSBBbmltYXRpb24uUGFyc2VyIGFuZCBub3QgZGlyZWN0bHkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkZyYW1lRGF0YSNhZGRGcmFtZQogICAgKiBAcGFyYW0ge1BoYXNlci5GcmFtZX0gZnJhbWUgLSBUaGUgZnJhbWUgdG8gYWRkIHRvIHRoaXMgRnJhbWVEYXRhIHNldC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgdGhhdCB3YXMganVzdCBhZGRlZC4KICAgICovCiAgICBhZGRGcmFtZTogZnVuY3Rpb24gKGZyYW1lKSB7CgogICAgICAgIGZyYW1lLmluZGV4ID0gdGhpcy5fZnJhbWVzLmxlbmd0aDsKCiAgICAgICAgdGhpcy5fZnJhbWVzLnB1c2goZnJhbWUpOwoKICAgICAgICBpZiAoZnJhbWUubmFtZSAhPT0gJycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9mcmFtZU5hbWVzW2ZyYW1lLm5hbWVdID0gZnJhbWUuaW5kZXg7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnJhbWU7CgogICAgfSwKCgkvKioKCSogR2V0IGEgRnJhbWUgYnkgaXRzIG51bWVyaWNhbCBpbmRleC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2dldEZyYW1lCgkqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSBpbmRleCBvZiB0aGUgZnJhbWUgeW91IHdhbnQgdG8gZ2V0LgoJKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSwgaWYgZm91bmQuCgkqLwogICAgZ2V0RnJhbWU6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAodGhpcy5fZnJhbWVzLmxlbmd0aCA+IGluZGV4KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lc1tpbmRleF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBGcmFtZSBieSBpdHMgZnJhbWUgbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2dldEZyYW1lQnlOYW1lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGZyYW1lIHlvdSB3YW50IHRvIGdldC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUsIGlmIGZvdW5kLgogICAgKi8KICAgIGdldEZyYW1lQnlOYW1lOiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICBpZiAodHlwZW9mIHRoaXMuX2ZyYW1lTmFtZXNbbmFtZV0gPT09ICdudW1iZXInKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ZyYW1lc1t0aGlzLl9mcmFtZU5hbWVzW25hbWVdXTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIENoZWNrIGlmIHRoZXJlIGlzIGEgRnJhbWUgd2l0aCB0aGUgZ2l2ZW4gbmFtZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2NoZWNrRnJhbWVOYW1lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lIC0gVGhlIG5hbWUgb2YgdGhlIGZyYW1lIHlvdSB3YW50IHRvIGNoZWNrLgogICAgKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBmcmFtZSBpcyBmb3VuZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIGNoZWNrRnJhbWVOYW1lOiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICBpZiAodGhpcy5fZnJhbWVOYW1lc1tuYW1lXSA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgCiAgICB9LAoKCS8qKgoJKiBSZXR1cm5zIGEgcmFuZ2Ugb2YgZnJhbWVzIGJhc2VkIG9uIHRoZSBnaXZlbiBzdGFydCBhbmQgZW5kIGZyYW1lIGluZGV4ZXMgYW5kIHJldHVybnMgdGhlbSBpbiBhbiBBcnJheS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2dldEZyYW1lUmFuZ2UKICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gVGhlIHN0YXJ0aW5nIGZyYW1lIGluZGV4LgoJKiBAcGFyYW0ge251bWJlcn0gZW5kIC0gVGhlIGVuZGluZyBmcmFtZSBpbmRleC4KCSogQHBhcmFtIHtBcnJheX0gW291dHB1dF0gLSBJZiBnaXZlbiB0aGUgcmVzdWx0cyB3aWxsIGJlIGFwcGVuZGVkIHRvIHRoZSBlbmQgb2YgdGhpcyBhcnJheSBvdGhlcndpc2UgYSBuZXcgYXJyYXkgd2lsbCBiZSBjcmVhdGVkLgoJKiBAcmV0dXJuIHtBcnJheX0gQW4gYXJyYXkgb2YgRnJhbWVzIGJldHdlZW4gdGhlIHN0YXJ0IGFuZCBlbmQgaW5kZXggdmFsdWVzLCBvciBhbiBlbXB0eSBhcnJheSBpZiBub25lIHdlcmUgZm91bmQuCgkqLwogICAgZ2V0RnJhbWVSYW5nZTogZnVuY3Rpb24gKHN0YXJ0LCBlbmQsIG91dHB1dCkgewogICAgICAgIAogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBbXTsgfQoKICAgICAgICBmb3IgKHZhciBpID0gc3RhcnQ7IGkgPD0gZW5kOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBvdXRwdXQucHVzaCh0aGlzLl9mcmFtZXNbaV0pOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG91dHB1dDsKCiAgICB9LAoKCS8qKgoJKiBSZXR1cm5zIGFsbCBvZiB0aGUgRnJhbWVzIGluIHRoaXMgRnJhbWVEYXRhIHNldCB3aGVyZSB0aGUgZnJhbWUgaW5kZXggaXMgZm91bmQgaW4gdGhlIGlucHV0IGFycmF5LgogICAgKiBUaGUgZnJhbWVzIGFyZSByZXR1cm5lZCBpbiB0aGUgb3V0cHV0IGFycmF5LCBvciBpZiBub25lIGlzIHByb3ZpZGVkIGluIGEgbmV3IEFycmF5IG9iamVjdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuRnJhbWVEYXRhI2dldEZyYW1lcwogICAgKiBAcGFyYW0ge0FycmF5fSBmcmFtZXMgLSBBbiBBcnJheSBjb250YWluaW5nIHRoZSBpbmRleGVzIG9mIHRoZSBmcmFtZXMgdG8gcmV0cmlldmUuIElmIHRoZSBhcnJheSBpcyBlbXB0eSB0aGVuIGFsbCBmcmFtZXMgaW4gdGhlIEZyYW1lRGF0YSBhcmUgcmV0dXJuZWQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW3VzZU51bWVyaWNJbmRleD10cnVlXSAtIEFyZSB0aGUgZ2l2ZW4gZnJhbWVzIHVzaW5nIG51bWVyaWMgaW5kZXhlcyAoZGVmYXVsdCkgb3Igc3RyaW5ncz8gKGZhbHNlKQogICAgKiBAcGFyYW0ge0FycmF5fSBbb3V0cHV0XSAtIElmIGdpdmVuIHRoZSByZXN1bHRzIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlIGVuZCBvZiB0aGlzIGFycmF5IG90aGVyd2lzZSBhIG5ldyBhcnJheSB3aWxsIGJlIGNyZWF0ZWQuCiAgICAqIEByZXR1cm4ge0FycmF5fSBBbiBhcnJheSBvZiBhbGwgRnJhbWVzIGluIHRoaXMgRnJhbWVEYXRhIHNldCBtYXRjaGluZyB0aGUgZ2l2ZW4gbmFtZXMgb3IgSURzLgoJKi8KICAgIGdldEZyYW1lczogZnVuY3Rpb24gKGZyYW1lcywgdXNlTnVtZXJpY0luZGV4LCBvdXRwdXQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB1c2VOdW1lcmljSW5kZXggPT09ICJ1bmRlZmluZWQiKSB7IHVzZU51bWVyaWNJbmRleCA9IHRydWU7IH0KICAgICAgICBpZiAodHlwZW9mIG91dHB1dCA9PT0gInVuZGVmaW5lZCIpIHsgb3V0cHV0ID0gW107IH0KCiAgICAgICAgaWYgKHR5cGVvZiBmcmFtZXMgPT09ICJ1bmRlZmluZWQiIHx8IGZyYW1lcy5sZW5ndGggPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBObyBpbnB1dCBhcnJheSwgc28gd2UgbG9vcCB0aHJvdWdoIGFsbCBmcmFtZXMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9mcmFtZXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBXZSBvbmx5IG5lZWQgdGhlIGluZGV4ZXMKICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuX2ZyYW1lc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIElucHV0IGFycmF5IGdpdmVuLCBsb29wIHRocm91Z2ggdGhhdCBpbnN0ZWFkCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwLCBsZW4gPSBmcmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBEb2VzIHRoZSBpbnB1dCBhcnJheSBjb250YWluIG5hbWVzIG9yIGluZGV4ZXM/CiAgICAgICAgICAgICAgICBpZiAodXNlTnVtZXJpY0luZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIC8vICBUaGUgYWN0dWFsIGZyYW1lCiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5nZXRGcmFtZShmcmFtZXNbaV0pKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhlIGFjdHVhbCBmcmFtZQogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyBhbGwgb2YgdGhlIEZyYW1lIGluZGV4ZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0LgogICAgKiBUaGUgZnJhbWVzIGluZGV4ZXMgYXJlIHJldHVybmVkIGluIHRoZSBvdXRwdXQgYXJyYXksIG9yIGlmIG5vbmUgaXMgcHJvdmlkZWQgaW4gYSBuZXcgQXJyYXkgb2JqZWN0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5GcmFtZURhdGEjZ2V0RnJhbWVJbmRleGVzCiAgICAqIEBwYXJhbSB7QXJyYXl9IGZyYW1lcyAtIEFuIEFycmF5IGNvbnRhaW5pbmcgdGhlIGluZGV4ZXMgb2YgdGhlIGZyYW1lcyB0byByZXRyaWV2ZS4gSWYgdGhlIGFycmF5IGlzIGVtcHR5IHRoZW4gYWxsIGZyYW1lcyBpbiB0aGUgRnJhbWVEYXRhIGFyZSByZXR1cm5lZC4KICAgICogQHBhcmFtIHtib29sZWFufSBbdXNlTnVtZXJpY0luZGV4PXRydWVdIC0gQXJlIHRoZSBnaXZlbiBmcmFtZXMgdXNpbmcgbnVtZXJpYyBpbmRleGVzIChkZWZhdWx0KSBvciBzdHJpbmdzPyAoZmFsc2UpCiAgICAqIEBwYXJhbSB7QXJyYXl9IFtvdXRwdXRdIC0gSWYgZ2l2ZW4gdGhlIHJlc3VsdHMgd2lsbCBiZSBhcHBlbmRlZCB0byB0aGUgZW5kIG9mIHRoaXMgYXJyYXkgb3RoZXJ3aXNlIGEgbmV3IGFycmF5IHdpbGwgYmUgY3JlYXRlZC4KICAgICogQHJldHVybiB7QXJyYXl9IEFuIGFycmF5IG9mIGFsbCBGcmFtZSBpbmRleGVzIG1hdGNoaW5nIHRoZSBnaXZlbiBuYW1lcyBvciBJRHMuCiAgICAqLwogICAgZ2V0RnJhbWVJbmRleGVzOiBmdW5jdGlvbiAoZnJhbWVzLCB1c2VOdW1lcmljSW5kZXgsIG91dHB1dCkgewoKICAgICAgICBpZiAodHlwZW9mIHVzZU51bWVyaWNJbmRleCA9PT0gInVuZGVmaW5lZCIpIHsgdXNlTnVtZXJpY0luZGV4ID0gdHJ1ZTsgfQogICAgICAgIGlmICh0eXBlb2Ygb3V0cHV0ID09PSAidW5kZWZpbmVkIikgeyBvdXRwdXQgPSBbXTsgfQoKICAgICAgICBpZiAodHlwZW9mIGZyYW1lcyA9PT0gInVuZGVmaW5lZCIgfHwgZnJhbWVzLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE5vIGZyYW1lcyBhcnJheSwgc28gd2UgbG9vcCB0aHJvdWdoIGFsbCBmcmFtZXMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IHRoaXMuX2ZyYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2godGhpcy5fZnJhbWVzW2ldLmluZGV4KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgSW5wdXQgYXJyYXkgZ2l2ZW4sIGxvb3AgdGhyb3VnaCB0aGF0IGluc3RlYWQKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIGxlbiA9IGZyYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIERvZXMgdGhlIGZyYW1lcyBhcnJheSBjb250YWluIG5hbWVzIG9yIGluZGV4ZXM/CiAgICAgICAgICAgICAgICBpZiAodXNlTnVtZXJpY0luZGV4KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKGZyYW1lc1tpXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dC5wdXNoKHRoaXMuZ2V0RnJhbWVCeU5hbWUoZnJhbWVzW2ldKS5pbmRleCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gb3V0cHV0OwoKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuRnJhbWVEYXRhI3RvdGFsCiogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsIC0gVGhlIHRvdGFsIG51bWJlciBvZiBmcmFtZXMgaW4gdGhpcyBGcmFtZURhdGEgc2V0LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLkZyYW1lRGF0YS5wcm90b3R5cGUsICJ0b3RhbCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZnJhbWVzLmxlbmd0aDsKICAgIH0KCn0pOwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUmVzcG9uc2libGUgZm9yIHBhcnNpbmcgc3ByaXRlIHNoZWV0IGFuZCBKU09OIGRhdGEgaW50byB0aGUgaW50ZXJuYWwgRnJhbWVEYXRhIGZvcm1hdCB0aGF0IFBoYXNlciB1c2VzIGZvciBhbmltYXRpb25zLgoqCiogQGNsYXNzIFBoYXNlci5BbmltYXRpb25QYXJzZXIKKi8KUGhhc2VyLkFuaW1hdGlvblBhcnNlciA9IHsKCiAgICAvKioKICAgICogUGFyc2UgYSBTcHJpdGUgU2hlZXQgYW5kIGV4dHJhY3QgdGhlIGFuaW1hdGlvbiBmcmFtZSBkYXRhIGZyb20gaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvblBhcnNlci5zcHJpdGVTaGVldAogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgR2FtZS5DYWNoZSBhc3NldCBrZXkgb2YgdGhlIFNwcml0ZSBTaGVldCBpbWFnZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lV2lkdGggLSBUaGUgZml4ZWQgd2lkdGggb2YgZWFjaCBmcmFtZSBvZiB0aGUgYW5pbWF0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0gZnJhbWVIZWlnaHQgLSBUaGUgZml4ZWQgaGVpZ2h0IG9mIGVhY2ggZnJhbWUgb2YgdGhlIGFuaW1hdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZU1heD0tMV0gLSBUaGUgdG90YWwgbnVtYmVyIG9mIGFuaW1hdGlvbiBmcmFtZXMgdG8gZXh0YWN0IGZyb20gdGhlIFNwcml0ZSBTaGVldC4gVGhlIGRlZmF1bHQgdmFsdWUgb2YgLTEgbWVhbnMgImV4dHJhY3QgYWxsIGZyYW1lcyIuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZURhdGF9IEEgRnJhbWVEYXRhIG9iamVjdCBjb250YWluaW5nIHRoZSBwYXJzZWQgZnJhbWVzLgogICAgKi8KICAgIHNwcml0ZVNoZWV0OiBmdW5jdGlvbiAoZ2FtZSwga2V5LCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgpIHsKCiAgICAgICAgLy8gIEhvdyBiaWcgaXMgb3VyIGltYWdlPwogICAgICAgIHZhciBpbWcgPSBnYW1lLmNhY2hlLmdldEltYWdlKGtleSk7CgogICAgICAgIGlmIChpbWcgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0KCiAgICAgICAgdmFyIHdpZHRoID0gaW1nLndpZHRoOwogICAgICAgIHZhciBoZWlnaHQgPSBpbWcuaGVpZ2h0OwoKICAgICAgICBpZiAoZnJhbWVXaWR0aCA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZnJhbWVXaWR0aCA9IE1hdGguZmxvb3IoLXdpZHRoIC8gTWF0aC5taW4oLTEsIGZyYW1lV2lkdGgpKTsKICAgICAgICB9CgogICAgICAgIGlmIChmcmFtZUhlaWdodCA8PSAwKQogICAgICAgIHsKICAgICAgICAgICAgZnJhbWVIZWlnaHQgPSBNYXRoLmZsb29yKC1oZWlnaHQgLyBNYXRoLm1pbigtMSwgZnJhbWVIZWlnaHQpKTsKICAgICAgICB9CgogICAgICAgIHZhciByb3cgPSBNYXRoLnJvdW5kKHdpZHRoIC8gZnJhbWVXaWR0aCk7CiAgICAgICAgdmFyIGNvbHVtbiA9IE1hdGgucm91bmQoaGVpZ2h0IC8gZnJhbWVIZWlnaHQpOwogICAgICAgIHZhciB0b3RhbCA9IHJvdyAqIGNvbHVtbjsKICAgICAgICAKICAgICAgICBpZiAoZnJhbWVNYXggIT09IC0xKQogICAgICAgIHsKICAgICAgICAgICAgdG90YWwgPSBmcmFtZU1heDsKICAgICAgICB9CgogICAgICAgIC8vICBaZXJvIG9yIHNtYWxsZXIgdGhhbiBmcmFtZSBzaXplcz8KICAgICAgICBpZiAod2lkdGggPT0gMCB8fCBoZWlnaHQgPT0gMCB8fCB3aWR0aCA8IGZyYW1lV2lkdGggfHwgaGVpZ2h0IDwgZnJhbWVIZWlnaHQgfHwgdG90YWwgPT09IDApCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuc3ByaXRlU2hlZXQ6IHdpZHRoL2hlaWdodCB6ZXJvIG9yIHdpZHRoL2hlaWdodCA8IGdpdmVuIGZyYW1lV2lkdGgvZnJhbWVIZWlnaHQiKTsKICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgfQoKICAgICAgICAvLyAgTGV0J3MgY3JlYXRlIHNvbWUgZnJhbWVzIHRoZW4KICAgICAgICB2YXIgZGF0YSA9IG5ldyBQaGFzZXIuRnJhbWVEYXRhKCk7CiAgICAgICAgdmFyIHggPSAwOwogICAgICAgIHZhciB5ID0gMDsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHV1aWQgPSBnYW1lLnJuZC51dWlkKCk7CgogICAgICAgICAgICBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoaSwgeCwgeSwgZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQsICcnLCB1dWlkKSk7CgogICAgICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVt1dWlkXSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0sIHsKICAgICAgICAgICAgICAgIHg6IHgsCiAgICAgICAgICAgICAgICB5OiB5LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lV2lkdGgsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lSGVpZ2h0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgeCArPSBmcmFtZVdpZHRoOwoKICAgICAgICAgICAgaWYgKHggPT09IHdpZHRoKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB4ID0gMDsKICAgICAgICAgICAgICAgIHkgKz0gZnJhbWVIZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBkYXRhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhcnNlIHRoZSBKU09OIGRhdGEgYW5kIGV4dHJhY3QgdGhlIGFuaW1hdGlvbiBmcmFtZSBkYXRhIGZyb20gaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkFuaW1hdGlvblBhcnNlci5KU09ORGF0YQogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSBqc29uIC0gVGhlIEpTT04gZGF0YSBmcm9tIHRoZSBUZXh0dXJlIEF0bGFzLiBNdXN0IGJlIGluIEFycmF5IGZvcm1hdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlS2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGltYWdlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBKU09ORGF0YTogZnVuY3Rpb24gKGdhbWUsIGpzb24sIGNhY2hlS2V5KSB7CgogICAgICAgIC8vICBNYWxmb3JtZWQ/CiAgICAgICAgaWYgKCFqc29uWydmcmFtZXMnXSkKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLkFuaW1hdGlvblBhcnNlci5KU09ORGF0YTogSW52YWxpZCBUZXh0dXJlIEF0bGFzIEpTT04gZ2l2ZW4sIG1pc3NpbmcgJ2ZyYW1lcycgYXJyYXkiKTsKICAgICAgICAgICAgY29uc29sZS5sb2coanNvbik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKICAgICAgICAKICAgICAgICAvLyAgQnkgdGhpcyBzdGFnZSBmcmFtZXMgaXMgYSBmdWxseSBwYXJzZWQgYXJyYXkKICAgICAgICB2YXIgZnJhbWVzID0ganNvblsnZnJhbWVzJ107CiAgICAgICAgdmFyIG5ld0ZyYW1lOwogICAgICAgIAogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZnJhbWVzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIHV1aWQgPSBnYW1lLnJuZC51dWlkKCk7CgogICAgICAgICAgICBuZXdGcmFtZSA9IGRhdGEuYWRkRnJhbWUobmV3IFBoYXNlci5GcmFtZSgKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgIAlmcmFtZXNbaV0uZnJhbWUueCwgCiAgICAgICAgICAgIAlmcmFtZXNbaV0uZnJhbWUueSwgCiAgICAgICAgICAgIAlmcmFtZXNbaV0uZnJhbWUudywgCiAgICAgICAgICAgIAlmcmFtZXNbaV0uZnJhbWUuaCwgCiAgICAgICAgICAgIAlmcmFtZXNbaV0uZmlsZW5hbWUsCiAgICAgICAgICAgICAgICB1dWlkCgkJCSkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtjYWNoZUtleV0sIHsKICAgICAgICAgICAgICAgIHg6IGZyYW1lc1tpXS5mcmFtZS54LAogICAgICAgICAgICAgICAgeTogZnJhbWVzW2ldLmZyYW1lLnksCiAgICAgICAgICAgICAgICB3aWR0aDogZnJhbWVzW2ldLmZyYW1lLncsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lc1tpXS5mcmFtZS5oCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKGZyYW1lc1tpXS50cmltbWVkKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXdGcmFtZS5zZXRUcmltKAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1tpXS50cmltbWVkLCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc291cmNlU2l6ZS53LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc291cmNlU2l6ZS5oLCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS54LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS55LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS53LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNbaV0uc3ByaXRlU291cmNlU2l6ZS5oCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8vICBXZSBoYWQgdG8gaGFjayBQaXhpIHRvIGdldCB0aGlzIHRvIHdvcmsgOigKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW1tZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS54ID0gZnJhbWVzW2ldLnNwcml0ZVNvdXJjZVNpemUueDsKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW0ueSA9IGZyYW1lc1tpXS5zcHJpdGVTb3VyY2VTaXplLnk7CgogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXJzZSB0aGUgSlNPTiBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoCiAgICAqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KICAgICogQHBhcmFtIHtPYmplY3R9IGpzb24gLSBUaGUgSlNPTiBkYXRhIGZyb20gdGhlIFRleHR1cmUgQXRsYXMuIE11c3QgYmUgaW4gSlNPTiBIYXNoIGZvcm1hdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNhY2hlS2V5IC0gVGhlIEdhbWUuQ2FjaGUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGltYWdlLgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWVEYXRhfSBBIEZyYW1lRGF0YSBvYmplY3QgY29udGFpbmluZyB0aGUgcGFyc2VkIGZyYW1lcy4KICAgICovCiAgICBKU09ORGF0YUhhc2g6IGZ1bmN0aW9uIChnYW1lLCBqc29uLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICghanNvblsnZnJhbWVzJ10pCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoOiBJbnZhbGlkIFRleHR1cmUgQXRsYXMgSlNPTiBnaXZlbiwgbWlzc2luZyAnZnJhbWVzJyBvYmplY3QiKTsKICAgICAgICAgICAgY29uc29sZS5sb2coanNvbik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKCiAgICAgICAgLy8gIEJ5IHRoaXMgc3RhZ2UgZnJhbWVzIGlzIGEgZnVsbHkgcGFyc2VkIGFycmF5CiAgICAgICAgdmFyIGZyYW1lcyA9IGpzb25bJ2ZyYW1lcyddOwogICAgICAgIHZhciBuZXdGcmFtZTsKICAgICAgICB2YXIgaSA9IDA7CiAgICAgICAgCiAgICAgICAgZm9yICh2YXIga2V5IGluIGZyYW1lcykKICAgICAgICB7CiAgICAgICAgICAgIHZhciB1dWlkID0gZ2FtZS5ybmQudXVpZCgpOwoKICAgICAgICAgICAgbmV3RnJhbWUgPSBkYXRhLmFkZEZyYW1lKG5ldyBQaGFzZXIuRnJhbWUoCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUueCwgCiAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5mcmFtZS55LCAKICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLmZyYW1lLncsIAogICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uZnJhbWUuaCwgCiAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICB1dWlkCiAgICAgICAgICAgICkpOwoKICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtjYWNoZUtleV0sIHsKICAgICAgICAgICAgICAgIHg6IGZyYW1lc1trZXldLmZyYW1lLngsCiAgICAgICAgICAgICAgICB5OiBmcmFtZXNba2V5XS5mcmFtZS55LAogICAgICAgICAgICAgICAgd2lkdGg6IGZyYW1lc1trZXldLmZyYW1lLncsCiAgICAgICAgICAgICAgICBoZWlnaHQ6IGZyYW1lc1trZXldLmZyYW1lLmgKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAoZnJhbWVzW2tleV0udHJpbW1lZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmV3RnJhbWUuc2V0VHJpbSgKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS50cmltbWVkLCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zb3VyY2VTaXplLncsIAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNvdXJjZVNpemUuaCwgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS54LCAKICAgICAgICAgICAgICAgICAgICBmcmFtZXNba2V5XS5zcHJpdGVTb3VyY2VTaXplLnksIAogICAgICAgICAgICAgICAgICAgIGZyYW1lc1trZXldLnNwcml0ZVNvdXJjZVNpemUudywgCiAgICAgICAgICAgICAgICAgICAgZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS5oCiAgICAgICAgICAgICAgICApOwoKICAgICAgICAgICAgICAgIC8vICBXZSBoYWQgdG8gaGFjayBQaXhpIHRvIGdldCB0aGlzIHRvIHdvcmsgOigKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW1tZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS54ID0gZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS54OwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS55ID0gZnJhbWVzW2tleV0uc3ByaXRlU291cmNlU2l6ZS55OwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaSsrOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGRhdGE7CgogICAgfSwKCiAgICAvKioKICAgICogUGFyc2UgdGhlIFhNTCBkYXRhIGFuZCBleHRyYWN0IHRoZSBhbmltYXRpb24gZnJhbWUgZGF0YSBmcm9tIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YQogICAgKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiAgICAqIEBwYXJhbSB7T2JqZWN0fSB4bWwgLSBUaGUgWE1MIGRhdGEgZnJvbSB0aGUgVGV4dHVyZSBBdGxhcy4gTXVzdCBiZSBpbiBTdGFybGluZyBYTUwgZm9ybWF0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gY2FjaGVLZXkgLSBUaGUgR2FtZS5DYWNoZSBhc3NldCBrZXkgb2YgdGhlIHRleHR1cmUgaW1hZ2UuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZURhdGF9IEEgRnJhbWVEYXRhIG9iamVjdCBjb250YWluaW5nIHRoZSBwYXJzZWQgZnJhbWVzLgogICAgKi8KICAgIFhNTERhdGE6IGZ1bmN0aW9uIChnYW1lLCB4bWwsIGNhY2hlS2V5KSB7CgogICAgICAgIC8vICBNYWxmb3JtZWQ/CiAgICAgICAgaWYgKCF4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ1RleHR1cmVBdGxhcycpKQogICAgICAgIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGE6IEludmFsaWQgVGV4dHVyZSBBdGxhcyBYTUwgZ2l2ZW4sIG1pc3NpbmcgPFRleHR1cmVBdGxhcz4gdGFnIik7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSBmcmFtZXMgdGhlbgogICAgICAgIHZhciBkYXRhID0gbmV3IFBoYXNlci5GcmFtZURhdGEoKTsKICAgICAgICB2YXIgZnJhbWVzID0geG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdTdWJUZXh0dXJlJyk7CiAgICAgICAgdmFyIG5ld0ZyYW1lOwoKICAgICAgICB2YXIgdXVpZDsKICAgICAgICB2YXIgZnJhbWU7CiAgICAgICAgdmFyIHg7CiAgICAgICAgdmFyIHk7CiAgICAgICAgdmFyIHdpZHRoOwogICAgICAgIHZhciBoZWlnaHQ7CiAgICAgICAgdmFyIGZyYW1lWDsKICAgICAgICB2YXIgZnJhbWVZOwogICAgICAgIHZhciBmcmFtZVdpZHRoOwogICAgICAgIHZhciBmcmFtZUhlaWdodDsKICAgICAgICAKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZyYW1lcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHV1aWQgPSBnYW1lLnJuZC51dWlkKCk7CgogICAgICAgICAgICBmcmFtZSA9IGZyYW1lc1tpXS5hdHRyaWJ1dGVzOwoKICAgICAgICAgICAgbmFtZSA9IGZyYW1lLm5hbWUubm9kZVZhbHVlOwogICAgICAgICAgICB4ID0gcGFyc2VJbnQoZnJhbWUueC5ub2RlVmFsdWUpOwogICAgICAgICAgICB5ID0gcGFyc2VJbnQoZnJhbWUueS5ub2RlVmFsdWUpOwogICAgICAgICAgICB3aWR0aCA9IHBhcnNlSW50KGZyYW1lLndpZHRoLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgIGhlaWdodCA9IHBhcnNlSW50KGZyYW1lLmhlaWdodC5ub2RlVmFsdWUpOwoKICAgICAgICAgICAgZnJhbWVYID0gbnVsbDsKICAgICAgICAgICAgZnJhbWVZID0gbnVsbDsKCiAgICAgICAgICAgIGlmIChmcmFtZS5mcmFtZVgpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGZyYW1lWCA9IE1hdGguYWJzKHBhcnNlSW50KGZyYW1lLmZyYW1lWC5ub2RlVmFsdWUpKTsKICAgICAgICAgICAgICAgIGZyYW1lWSA9IE1hdGguYWJzKHBhcnNlSW50KGZyYW1lLmZyYW1lWS5ub2RlVmFsdWUpKTsKICAgICAgICAgICAgICAgIGZyYW1lV2lkdGggPSBwYXJzZUludChmcmFtZS5mcmFtZVdpZHRoLm5vZGVWYWx1ZSk7CiAgICAgICAgICAgICAgICBmcmFtZUhlaWdodCA9IHBhcnNlSW50KGZyYW1lLmZyYW1lSGVpZ2h0Lm5vZGVWYWx1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIG5ld0ZyYW1lID0gZGF0YS5hZGRGcmFtZShuZXcgUGhhc2VyLkZyYW1lKGksIHgsIHksIHdpZHRoLCBoZWlnaHQsIG5hbWUsIHV1aWQpKTsKCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbY2FjaGVLZXldLCB7CiAgICAgICAgICAgICAgICB4OiB4LAogICAgICAgICAgICAgICAgeTogeSwKICAgICAgICAgICAgICAgIHdpZHRoOiB3aWR0aCwKICAgICAgICAgICAgICAgIGhlaWdodDogaGVpZ2h0CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gIFRyaW1tZWQ/CiAgICAgICAgICAgIGlmIChmcmFtZVggIT09IG51bGwgfHwgZnJhbWVZICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuZXdGcmFtZS5zZXRUcmltKHRydWUsIHdpZHRoLCBoZWlnaHQsIGZyYW1lWCwgZnJhbWVZLCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCk7CgogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0ucmVhbFNpemUgPSB7IHg6IGZyYW1lWCwgeTogZnJhbWVZLCB3OiBmcmFtZVdpZHRoLCBoOiBmcmFtZUhlaWdodCB9OwoKICAgICAgICAgICAgICAgIC8vICBXZSBoYWQgdG8gaGFjayBQaXhpIHRvIGdldCB0aGlzIHRvIHdvcmsgOigKICAgICAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW3V1aWRdLnRyaW1tZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS54ID0gZnJhbWVYOwogICAgICAgICAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVbdXVpZF0udHJpbS55ID0gZnJhbWVZOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZGF0YTsKCiAgICB9Cgp9OwoKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogUGhhc2VyLkNhY2hlIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzICAgIFBoYXNlci5DYWNoZQoqIEBjbGFzc2Rlc2MgQSBnYW1lIG9ubHkgaGFzIG9uZSBpbnN0YW5jZSBvZiBhIENhY2hlIGFuZCBpdCBpcyB1c2VkIHRvIHN0b3JlIGFsbCBleHRlcm5hbGx5IGxvYWRlZCBhc3NldHMgc3VjaAoqIGFzIGltYWdlcywgc291bmRzIGFuZCBkYXRhIGZpbGVzIGFzIGEgcmVzdWx0IG9mIExvYWRlciBjYWxscy4gQ2FjaGUgaXRlbXMgdXNlIHN0cmluZyBiYXNlZCBrZXlzIGZvciBsb29rLXVwLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKi8KUGhhc2VyLkNhY2hlID0gZnVuY3Rpb24gKGdhbWUpIHsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgoJKi8KCXRoaXMuZ2FtZSA9IGdhbWU7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBnYW1lIC0gQ2FudmFzIGtleS12YWx1ZSBjb250YWluZXIuCgkqIEBwcml2YXRlCgkqLwogICAgdGhpcy5fY2FudmFzZXMgPSB7fTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF9pbWFnZXMgLSBJbWFnZSBrZXktdmFsdWUgY29udGFpbmVyLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX2ltYWdlcyA9IHt9OwoKICAgIC8qKgoJKiBAcHJvcGVydHkge29iamVjdH0gX3RleHR1cmVzIC0gUmVuZGVyVGV4dHVyZSBrZXktdmFsdWUgY29udGFpbmVyLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX3RleHR1cmVzID0ge307CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfc291bmRzIC0gU291bmQga2V5LXZhbHVlIGNvbnRhaW5lci4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl9zb3VuZHMgPSB7fTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF90ZXh0IC0gVGV4dCBrZXktdmFsdWUgY29udGFpbmVyLgoJKiBAcHJpdmF0ZQoJKi8KICAgIHRoaXMuX3RleHQgPSB7fTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtvYmplY3R9IF90aWxlbWFwcyAtIFRpbGVtYXAga2V5LXZhbHVlIGNvbnRhaW5lci4KCSogQHByaXZhdGUKCSovCiAgICB0aGlzLl90aWxlbWFwcyA9IHt9OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge29iamVjdH0gX3RpbGVzZXRzIC0gVGlsZXNldCBrZXktdmFsdWUgY29udGFpbmVyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RpbGVzZXRzID0ge307CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBfYml0bWFwRGF0YXMgLSBCaXRtYXBEYXRhIGtleS12YWx1ZSBjb250YWluZXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYml0bWFwRGF0YXMgPSB7fTsKCiAgICB0aGlzLmFkZERlZmF1bHRJbWFnZSgpOwogICAgdGhpcy5hZGRNaXNzaW5nSW1hZ2UoKTsKCiAgICAvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvblNvdW5kVW5sb2NrIC0gRGVzY3JpcHRpb24uCgkqLwogICAgdGhpcy5vblNvdW5kVW5sb2NrID0gbmV3IFBoYXNlci5TaWduYWw7Cgp9OwoKUGhhc2VyLkNhY2hlLnByb3RvdHlwZSA9IHsKCiAgICAvKioKICAgICogQWRkIGEgbmV3IGNhbnZhcyBvYmplY3QgaW4gdG8gdGhlIGNhY2hlLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRDYW52YXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhpcyBjYW52YXMuCiAgICAqIEBwYXJhbSB7SFRNTENhbnZhc0VsZW1lbnR9IGNhbnZhcyAtIENhbnZhcyBET00gZWxlbWVudC4KICAgICogQHBhcmFtIHtDYW52YXNSZW5kZXJpbmdDb250ZXh0MkR9IGNvbnRleHQgLSBSZW5kZXIgY29udGV4dCBvZiB0aGlzIGNhbnZhcy4KICAgICovCiAgICBhZGRDYW52YXM6IGZ1bmN0aW9uIChrZXksIGNhbnZhcywgY29udGV4dCkgewoKICAgICAgICB0aGlzLl9jYW52YXNlc1trZXldID0geyBjYW52YXM6IGNhbnZhcywgY29udGV4dDogY29udGV4dCB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIEJpdG1hcERhdGEgb2JqZWN0IGluIHRvIHRoZSBjYWNoZS4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkQml0bWFwRGF0YQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGlzIEJpdG1hcERhdGEuCiAgICAqIEBwYXJhbSB7UGhhc2VyLkJpdG1hcERhdGF9IGJpdG1hcERhdGEgLSBUaGUgQml0bWFwRGF0YSBvYmplY3QgdG8gYmUgYWRkZGVkIHRvIHRoZSBjYWNoZS4KICAgICogQHJldHVybiB7UGhhc2VyLkJpdG1hcERhdGF9IFRoZSBCaXRtYXBEYXRhIG9iamVjdCB0byBiZSBhZGRkZWQgdG8gdGhlIGNhY2hlLgogICAgKi8KICAgIGFkZEJpdG1hcERhdGE6IGZ1bmN0aW9uIChrZXksIGJpdG1hcERhdGEpIHsKCiAgICAgICAgdGhpcy5fYml0bWFwRGF0YXNba2V5XSA9IGJpdG1hcERhdGE7CgogICAgICAgIHJldHVybiBiaXRtYXBEYXRhOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBQaGFzZXIuUmVuZGVyVGV4dHVyZSBpbiB0byB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFJlbmRlclRleHR1cmUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtQaGFzZXIuVGV4dHVyZX0gdGV4dHVyZSAtIFRoZSB0ZXh0dXJlIHRvIHVzZSBhcyB0aGUgYmFzZSBvZiB0aGUgUmVuZGVyVGV4dHVyZS4KICAgICovCiAgICBhZGRSZW5kZXJUZXh0dXJlOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlKSB7CgogICAgICAgIHZhciBmcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgdGV4dHVyZS53aWR0aCwgdGV4dHVyZS5oZWlnaHQsICcnLCAnJyk7CgogICAgICAgIHRoaXMuX3RleHR1cmVzW2tleV0gPSB7IHRleHR1cmU6IHRleHR1cmUsIGZyYW1lOiBmcmFtZSB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyBzcHJpdGUgc2hlZXQgaW4gdG8gdGhlIGNhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRTcHJpdGVTaGVldAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVGhlIHVuaXF1ZSBrZXkgYnkgd2hpY2ggeW91IHdpbGwgcmVmZXJlbmNlIHRoaXMgb2JqZWN0LgogICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoaXMgc3ByaXRlIHNoZWV0IGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgc3ByaXRlIHNoZWV0IGRhdGEuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZVdpZHRoIC0gV2lkdGggb2YgdGhlIHNwcml0ZSBzaGVldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZyYW1lSGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZU1heCAtIEhvdyBtYW55IGZyYW1lcyBzdG9yZWQgaW4gdGhlIHNwcml0ZSBzaGVldC4KICAgICovCiAgICBhZGRTcHJpdGVTaGVldDogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhLCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogdHJ1ZSwgZnJhbWVXaWR0aDogZnJhbWVXaWR0aCwgZnJhbWVIZWlnaHQ6IGZyYW1lSGVpZ2h0IH07CgogICAgICAgIFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoZGF0YSk7CiAgICAgICAgUElYSS5UZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLlRleHR1cmUoUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0pOwoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLnNwcml0ZVNoZWV0KHRoaXMuZ2FtZSwga2V5LCBmcmFtZVdpZHRoLCBmcmFtZUhlaWdodCwgZnJhbWVNYXgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0aWxlIHNldCBpbiB0byB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFRpbGVzZXQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHRpbGUgc2V0IGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgdGlsZSBzZXQgZGF0YS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVXaWR0aCAtIFdpZHRoIG9mIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gSGVpZ2h0IG9mIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlTWF4IC0gSG93IG1hbnkgdGlsZXMgc3RvcmVkIGluIHRoZSBzcHJpdGUgc2hlZXQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdGlsZU1hcmdpbj0wXSAtIElmIHRoZSB0aWxlcyBoYXZlIGJlZW4gZHJhd24gd2l0aCBhIG1hcmdpbiwgc3BlY2lmeSB0aGUgYW1vdW50IGhlcmUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdGlsZVNwYWNpbmc9MF0gLSBJZiB0aGUgdGlsZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggc3BhY2luZyBiZXR3ZWVuIHRoZW0sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgogICAgKi8KICAgIGFkZFRpbGVzZXQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSwgdGlsZVdpZHRoLCB0aWxlSGVpZ2h0LCB0aWxlTWF4LCB0aWxlTWFyZ2luLCB0aWxlU3BhY2luZykgewoKICAgICAgICB0aGlzLl90aWxlc2V0c1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgdGlsZVdpZHRoOiB0aWxlV2lkdGgsIHRpbGVIZWlnaHQ6IHRpbGVIZWlnaHQsIHRpbGVNYXJnaW46IHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nOiB0aWxlU3BhY2luZyB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgdGhpcy5fdGlsZXNldHNba2V5XS50aWxlRGF0YSA9IFBoYXNlci5UaWxlbWFwUGFyc2VyLnRpbGVzZXQodGhpcy5nYW1lLCBrZXksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1heCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0aWxlbWFwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUaWxlbWFwCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIHRpbGVtYXAgaW1hZ2UuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBtYXBEYXRhIC0gVGhlIHRpbGVtYXAgZGF0YSBvYmplY3QuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBmb3JtYXQgLSBUaGUgZm9ybWF0IG9mIHRoZSB0aWxlbWFwIGRhdGEuCiAgICAqLwogICAgYWRkVGlsZW1hcDogZnVuY3Rpb24gKGtleSwgdXJsLCBtYXBEYXRhLCBmb3JtYXQpIHsKCiAgICAgICAgdGhpcy5fdGlsZW1hcHNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IG1hcERhdGEsIGZvcm1hdDogZm9ybWF0IH07CgogICAgICAgIHRoaXMuX3RpbGVtYXBzW2tleV0ubGF5ZXJzID0gUGhhc2VyLlRpbGVtYXBQYXJzZXIucGFyc2UodGhpcy5nYW1lLCBtYXBEYXRhLCBmb3JtYXQpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0dXJlIGF0bGFzLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRUZXh0dXJlQXRsYXMKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFRoZSB1bmlxdWUga2V5IGJ5IHdoaWNoIHlvdSB3aWxsIHJlZmVyZW5jZSB0aGlzIG9iamVjdC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHRleHR1cmUgYXRsYXMgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSB0ZXh0dXJlIGF0bGFzIGRhdGEuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBhdGxhc0RhdGEgIC0gVGV4dHVyZSBhdGxhcyBmcmFtZXMgZGF0YS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGZvcm1hdCAtIFRoZSBmb3JtYXQgb2YgdGhlIHRleHR1cmUgYXRsYXMuCiAgICAqLwogICAgYWRkVGV4dHVyZUF0bGFzOiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIGF0bGFzRGF0YSwgZm9ybWF0KSB7CgogICAgICAgIHRoaXMuX2ltYWdlc1trZXldID0geyB1cmw6IHVybCwgZGF0YTogZGF0YSwgc3ByaXRlU2hlZXQ6IHRydWUgfTsKCiAgICAgICAgUElYSS5CYXNlVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5CYXNlVGV4dHVyZShkYXRhKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVtrZXldID0gbmV3IFBJWEkuVGV4dHVyZShQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSk7CgogICAgICAgIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fQVJSQVkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLkpTT05EYXRhKHRoaXMuZ2FtZSwgYXRsYXNEYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fSEFTSCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuSlNPTkRhdGFIYXNoKHRoaXMuZ2FtZSwgYXRsYXNEYXRhLCBrZXkpOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChmb3JtYXQgPT0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSA9IFBoYXNlci5BbmltYXRpb25QYXJzZXIuWE1MRGF0YSh0aGlzLmdhbWUsIGF0bGFzRGF0YSwga2V5KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQWRkIGEgbmV3IEJpdG1hcCBGb250LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRCaXRtYXBGb250CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBmb250IHhtbCBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIGZvbnQgZGF0YS4KICAgICogQHBhcmFtIHhtbERhdGEge29iamVjdH0gVGV4dHVyZSBhdGxhcyBmcmFtZXMgZGF0YS4KICAgICovCiAgICBhZGRCaXRtYXBGb250OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGRhdGEsIHhtbERhdGEpIHsKCiAgICAgICAgdGhpcy5faW1hZ2VzW2tleV0gPSB7IHVybDogdXJsLCBkYXRhOiBkYXRhLCBzcHJpdGVTaGVldDogdHJ1ZSB9OwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICAgICAgUGhhc2VyLkxvYWRlclBhcnNlci5iaXRtYXBGb250KHRoaXMuZ2FtZSwgeG1sRGF0YSwga2V5KTsKICAgICAgICAvLyB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEgPSBQaGFzZXIuQW5pbWF0aW9uUGFyc2VyLlhNTERhdGEodGhpcy5nYW1lLCB4bWxEYXRhLCBrZXkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBkZWZhdWx0IGltYWdlIHRvIGJlIHVzZWQgaW4gc3BlY2lhbCBjYXNlcyBzdWNoIGFzIFdlYkdMIEZpbHRlcnMuIElzIG1hcHBlZCB0byB0aGUga2V5IF9fZGVmYXVsdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjYWRkRGVmYXVsdEltYWdlCiAgICAqLwogICAgYWRkRGVmYXVsdEltYWdlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHZhciBpbWcgPSBuZXcgSW1hZ2UoKTsKICAgICAgICBpbWcuc3JjID0gImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBQ0FBQUFBZ0FRTUFBQUJKdE9pM0FBQUFBMUJNVkVYLy8vK254QnZJQUFBQUFYUlNUbE1BUU9iWVpnQUFBQlZKUkVGVWVGN053SUVBQUFBQWdLRDlxZGVvY0FNQW9BQUJtM0RrY0FBQUFBQkpSVTVFcmtKZ2dnPT0iOwoKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fZGVmYXVsdCddID0geyB1cmw6IG51bGwsIGRhdGE6IGltZywgc3ByaXRlU2hlZXQ6IGZhbHNlIH07CiAgICAgICAgdGhpcy5faW1hZ2VzWydfX2RlZmF1bHQnXS5mcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgMzIsIDMyLCAnJywgJycpOwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fZGVmYXVsdCddID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoaW1nKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVsnX19kZWZhdWx0J10gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19kZWZhdWx0J10pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYW4gaW1hZ2UgdG8gYmUgdXNlZCB3aGVuIGEga2V5IGlzIHdyb25nIC8gbWlzc2luZy4gSXMgbWFwcGVkIHRvIHRoZSBrZXkgX19taXNzaW5nLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNhZGRNaXNzaW5nSW1hZ2UKICAgICovCiAgICBhZGRNaXNzaW5nSW1hZ2U6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGltZyA9IG5ldyBJbWFnZSgpOwogICAgICAgIGltZy5zcmMgPSAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFDQUFBQUFnQ0FJQUFBRDhHTzJqQUFBQUdYUkZXSFJUYjJaMGQyRnlaUUJCWkc5aVpTQkpiV0ZuWlZKbFlXUjVjY2xsUEFBQUFKOUpSRUZVZU5xMDFzc093eUFNUkZHNDZ2Ly9NdDFFU21naCtERm1FMkdQT0JBUktiMk5Wam8rMTdQWExEOGExK3BsNStBK3dTZ0Z5Z3ltV1lIQmIwRnRzS2hKRGRabG5jRzJJeko0YXlvTUR2MjB3VG1TTXpDbEVnYldZTlRBa1EwWitPSitBL2VXbkFhUjkrb3hDRjRPczBIOGh0c01VcCtwd2NnQkJpTU5uQXdGOEdxSWdMMmhBemFHRkZnWmF1RFBLQUJtb3daNEdMMzY5LzByd0FDcDJ5QS90dG12c1FBQUFBQkpSVTVFcmtKZ2dnPT0iOwoKICAgICAgICB0aGlzLl9pbWFnZXNbJ19fbWlzc2luZyddID0geyB1cmw6IG51bGwsIGRhdGE6IGltZywgc3ByaXRlU2hlZXQ6IGZhbHNlIH07CiAgICAgICAgdGhpcy5faW1hZ2VzWydfX21pc3NpbmcnXS5mcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgMzIsIDMyLCAnJywgJycpOwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVbJ19fbWlzc2luZyddID0gbmV3IFBJWEkuQmFzZVRleHR1cmUoaW1nKTsKICAgICAgICBQSVhJLlRleHR1cmVDYWNoZVsnX19taXNzaW5nJ10gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVsnX19taXNzaW5nJ10pOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZCBhIG5ldyB0ZXh0IGRhdGEuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFRleHQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHRleHQgZGF0YS4gCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyB0ZXh0IGRhdGEgZmlsZS4KICAgICogQHBhcmFtIHtvYmplY3R9IGRhdGEgLSBFeHRyYSB0ZXh0IGRhdGEuCiAgICAqLyAgICAKICAgIGFkZFRleHQ6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSkgewoKICAgICAgICB0aGlzLl90ZXh0W2tleV0gPSB7CiAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICBkYXRhOiBkYXRhCiAgICAgICAgfTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgaW1hZ2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZEltYWdlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBUaGUgdW5pcXVlIGtleSBieSB3aGljaCB5b3Ugd2lsbCByZWZlcmVuY2UgdGhpcyBvYmplY3QuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhpcyBpbWFnZSBmaWxlLgogICAgKiBAcGFyYW0ge29iamVjdH0gZGF0YSAtIEV4dHJhIGltYWdlIGRhdGEuCiAgICAqLwogICAgYWRkSW1hZ2U6IGZ1bmN0aW9uIChrZXksIHVybCwgZGF0YSkgewoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHNwcml0ZVNoZWV0OiBmYWxzZSB9OwoKICAgICAgICB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZSA9IG5ldyBQaGFzZXIuRnJhbWUoMCwgMCwgMCwgZGF0YS53aWR0aCwgZGF0YS5oZWlnaHQsIGtleSwgdGhpcy5nYW1lLnJuZC51dWlkKCkpOwoKICAgICAgICBQSVhJLkJhc2VUZXh0dXJlQ2FjaGVba2V5XSA9IG5ldyBQSVhJLkJhc2VUZXh0dXJlKGRhdGEpOwogICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2tleV0gPSBuZXcgUElYSS5UZXh0dXJlKFBJWEkuQmFzZVRleHR1cmVDYWNoZVtrZXldKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBZGQgYSBuZXcgc291bmQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2FkZFNvdW5kCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGlzIHNvdW5kIGZpbGUuCiAgICAqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgc291bmQgZGF0YS4KICAgICogQHBhcmFtIHtib29sZWFufSB3ZWJBdWRpbyAtIFRydWUgaWYgdGhlIGZpbGUgaXMgdXNpbmcgd2ViIGF1ZGlvLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IGF1ZGlvVGFnIC0gVHJ1ZSBpZiB0aGUgZmlsZSBpcyB1c2luZyBsZWdhY3kgSFRNTCBhdWRpby4KICAgICovCiAgICBhZGRTb3VuZDogZnVuY3Rpb24gKGtleSwgdXJsLCBkYXRhLCB3ZWJBdWRpbywgYXVkaW9UYWcpIHsKCiAgICAgICAgd2ViQXVkaW8gPSB3ZWJBdWRpbyB8fCB0cnVlOwogICAgICAgIGF1ZGlvVGFnID0gYXVkaW9UYWcgfHwgZmFsc2U7CgogICAgICAgIHZhciBsb2NrZWQgPSB0aGlzLmdhbWUuc291bmQudG91Y2hMb2NrZWQ7CiAgICAgICAgdmFyIGRlY29kZWQgPSBmYWxzZTsKCiAgICAgICAgaWYgKGF1ZGlvVGFnKQogICAgICAgIHsKICAgICAgICAgICAgZGVjb2RlZCA9IHRydWU7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9zb3VuZHNba2V5XSA9IHsgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIGlzRGVjb2Rpbmc6IGZhbHNlLCBkZWNvZGVkOiBkZWNvZGVkLCB3ZWJBdWRpbzogd2ViQXVkaW8sIGF1ZGlvVGFnOiBhdWRpb1RhZyB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbG9hZCBhIHNvdW5kLgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNyZWxvYWRTb3VuZAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCiAgICAqLwogICAgcmVsb2FkU291bmQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5zcmMgPSB0aGlzLl9zb3VuZHNba2V5XS51cmw7CgogICAgICAgICAgICB0aGlzLl9zb3VuZHNba2V5XS5kYXRhLmFkZEV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlbG9hZFNvdW5kQ29tcGxldGUoa2V5KTsKICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YS5sb2FkKCk7CiAgICAgICAgfQogICAgfSwKCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbG9hZFNvdW5kQ29tcGxldGUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHJlbG9hZFNvdW5kQ29tcGxldGU6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fc291bmRzW2tleV0ubG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMub25Tb3VuZFVubG9jay5kaXNwYXRjaChrZXkpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjdXBkYXRlU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKi8KICAgIHVwZGF0ZVNvdW5kOiBmdW5jdGlvbiAoa2V5LCBwcm9wZXJ0eSwgdmFsdWUpIHsKICAgICAgICAKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZHNba2V5XVtwcm9wZXJ0eV0gPSB2YWx1ZTsKICAgICAgICB9CgogICAgfSwKCgkvKioKCSogQWRkIGEgbmV3IGRlY29kZWQgc291bmQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2RlY29kZWRTb3VuZAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IGZvciB0aGUgc291bmQuCgkqIEBwYXJhbSB7b2JqZWN0fSBkYXRhIC0gRXh0cmEgc291bmQgZGF0YS4KCSovCiAgICBkZWNvZGVkU291bmQ6IGZ1bmN0aW9uIChrZXksIGRhdGEpIHsKCiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGF0YSA9IGRhdGE7CiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZCA9IHRydWU7CiAgICAgICAgdGhpcy5fc291bmRzW2tleV0uaXNEZWNvZGluZyA9IGZhbHNlOwoKICAgIH0sCgoJLyoqCgkqIEdldCBhIGNhbnZhcyBvYmplY3QgZnJvbSB0aGUgY2FjaGUgYnkgaXRzIGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0Q2FudmFzCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGNhbnZhcyB5b3Ugd2FudC4KCSogQHJldHVybiB7b2JqZWN0fSBUaGUgY2FudmFzIHlvdSB3YW50LgoJKi8KICAgIGdldENhbnZhczogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fY2FudmFzZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9jYW52YXNlc1trZXldLmNhbnZhczsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIEJpdG1hcERhdGEgb2JqZWN0IGZyb20gdGhlIGNhY2hlIGJ5IGl0cyBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEJpdG1hcERhdGEKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgQml0bWFwRGF0YSBvYmplY3QgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5CaXRtYXBEYXRhfSBUaGUgcmVxdWVzdGVkIEJpdG1hcERhdGEgb2JqZWN0IGlmIGZvdW5kLCBvciBudWxsIGlmIG5vdC4KICAgICovCiAgICBnZXRCaXRtYXBEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9iaXRtYXBEYXRhc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2JpdG1hcERhdGFzW2tleV07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDaGVja3MgaWYgYW4gaW1hZ2Uga2V5IGV4aXN0cy4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjY2hlY2tJbWFnZUtleQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBpbWFnZSB5b3Ugd2FudC4KICAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUga2V5IGV4aXN0cywgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8gICAgCiAgICBjaGVja0ltYWdlS2V5OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCgkqIEdldCBpbWFnZSBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0SW1hZ2UKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgeW91IHdhbnQuCgkqIEByZXR1cm4ge29iamVjdH0gVGhlIGltYWdlIGRhdGEgeW91IHdhbnQuCgkqLyAgICAKICAgIGdldEltYWdlOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5kYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRpbGUgc2V0IGltYWdlIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUaWxlU2V0SW1hZ2UKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge29iamVjdH0gVGhlIGltYWdlIGRhdGEgeW91IHdhbnQuCiAgICAqLyAgICAKICAgIGdldFRpbGVzZXRJbWFnZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGlsZXNldHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90aWxlc2V0c1trZXldLmRhdGE7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgdGlsZSBzZXQgaW1hZ2UgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRpbGVzZXQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgaW1hZ2UgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5UaWxlc2V0fSBUaGUgdGlsZXNldCBkYXRhLiBUaGUgdGlsZXNldCBpbWFnZSBpcyBpbiB0aGUgZGF0YSBwcm9wZXJ0eSwgdGhlIHRpbGUgZGF0YSBpbiB0aWxlRGF0YS4KICAgICovICAgIAogICAgZ2V0VGlsZXNldDogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGlsZXNldHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90aWxlc2V0c1trZXldLnRpbGVEYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRpbGVtYXAgZGF0YSBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRpbGVtYXAKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgdGlsZW1hcCB5b3Ugd2FudC4KICAgICogQHJldHVybiB7T2JqZWN0fSBUaGUgdGlsZW1hcCBkYXRhLiBUaGUgdGlsZXNldCBpbWFnZSBpcyBpbiB0aGUgZGF0YSBwcm9wZXJ0eSwgdGhlIG1hcCBkYXRhIGluIG1hcERhdGEuCiAgICAqLwogICAgZ2V0VGlsZW1hcERhdGE6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RpbGVtYXBzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fdGlsZW1hcHNba2V5XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCgkvKioKCSogR2V0IGZyYW1lIGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRGcmFtZURhdGEKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KCSogQHJldHVybiB7UGhhc2VyLkZyYW1lRGF0YX0gVGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCgkqLwogICAgZ2V0RnJhbWVEYXRhOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBzaW5nbGUgZnJhbWUgb3V0IG9mIGEgZnJhbWVEYXRhIHNldCBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lQnlJbmRleAogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKi8KICAgIGdldEZyYW1lQnlJbmRleDogZnVuY3Rpb24gKGtleSwgZnJhbWUpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldICYmIHRoaXMuX2ltYWdlc1trZXldLmZyYW1lRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEuZ2V0RnJhbWUoZnJhbWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBzaW5nbGUgZnJhbWUgb3V0IG9mIGEgZnJhbWVEYXRhIHNldCBieSBrZXkuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldEZyYW1lQnlOYW1lCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCiAgICAqIEByZXR1cm4ge1BoYXNlci5GcmFtZX0gVGhlIGZyYW1lIGRhdGEgeW91IHdhbnQuCiAgICAqLwogICAgZ2V0RnJhbWVCeU5hbWU6IGZ1bmN0aW9uIChrZXksIGZyYW1lKSB7CgogICAgICAgIGlmICh0aGlzLl9pbWFnZXNba2V5XSAmJiB0aGlzLl9pbWFnZXNba2V5XS5mcmFtZURhdGEpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWVEYXRhLmdldEZyYW1lQnlOYW1lKGZyYW1lKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgfSwKCiAgICAvKioKICAgICogR2V0IGEgc2luZ2xlIGZyYW1lIGJ5IGtleS4gWW91J2Qgb25seSBkbyB0aGlzIHRvIGdldCB0aGUgZGVmYXVsdCBGcmFtZSBjcmVhdGVkIGZvciBhIG5vbi1hdGxhcy9zcHJpdGVzaGVldCBpbWFnZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0RnJhbWUKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICogQHJldHVybiB7UGhhc2VyLkZyYW1lfSBUaGUgZnJhbWUgZGF0YSB5b3Ugd2FudC4KICAgICovCiAgICBnZXRGcmFtZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5faW1hZ2VzW2tleV0gJiYgdGhpcy5faW1hZ2VzW2tleV0uc3ByaXRlU2hlZXQgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5faW1hZ2VzW2tleV0uZnJhbWU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdldCBhIHNpbmdsZSBmcmFtZSBieSBrZXkuIFlvdSdkIG9ubHkgZG8gdGhpcyB0byBnZXQgdGhlIGRlZmF1bHQgRnJhbWUgY3JlYXRlZCBmb3IgYSBub24tYXRsYXMvc3ByaXRlc2hlZXQgaW1hZ2UuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2dldFRleHR1cmVGcmFtZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuRnJhbWV9IFRoZSBmcmFtZSBkYXRhIHlvdSB3YW50LgogICAgKi8KICAgIGdldFRleHR1cmVGcmFtZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGV4dHVyZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlc1trZXldLmZyYW1lOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CiAgICB9LAoKICAgIC8qKgogICAgKiBHZXQgYSBSZW5kZXJUZXh0dXJlIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGV4dHVyZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBSZW5kZXJUZXh0dXJlIHlvdSB3YW50LgogICAgKiBAcmV0dXJuIHtQaGFzZXIuUmVuZGVyVGV4dHVyZX0gVGhlIFJlbmRlclRleHR1cmUgeW91IHdhbnQuCiAgICAqLwogICAgZ2V0VGV4dHVyZTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fdGV4dHVyZXNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0dXJlc1trZXldOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCgkvKioKCSogR2V0IHNvdW5kIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0U291bmQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBvZiB0aGUgc291bmQgeW91IHdhbnQuCgkqIEByZXR1cm4ge1BoYXNlci5Tb3VuZH0gVGhlIHNvdW5kIHlvdSB3YW50LgoJKi8KICAgIGdldFNvdW5kOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VuZHNba2V5XTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgoJLyoqCgkqIEdldCBzb3VuZCBkYXRhIGJ5IGtleS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0U291bmREYXRhCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHlvdSB3YW50LgoJKiBAcmV0dXJuIHtvYmplY3R9IFRoZSBzb3VuZCBkYXRhIHlvdSB3YW50LgoJKi8KICAgIGdldFNvdW5kRGF0YTogZnVuY3Rpb24gKGtleSkgewoKICAgICAgICBpZiAodGhpcy5fc291bmRzW2tleV0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5fc291bmRzW2tleV0uZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwoKICAgIH0sCgoJLyoqCgkqIENoZWNrIGlmIHRoZSBnaXZlbiBzb3VuZCBoYXMgZmluaXNoZWQgZGVjb2RpbmcuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI2lzU291bmREZWNvZGVkCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHlvdSB3YW50LgoJKiBAcmV0dXJuIHtib29sZWFufSBUaGUgZGVjb2RlZCBzdGF0ZSBvZiB0aGUgU291bmQgb2JqZWN0LgoJKi8KICAgIGlzU291bmREZWNvZGVkOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmICh0aGlzLl9zb3VuZHNba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9zb3VuZHNba2V5XS5kZWNvZGVkOwogICAgICAgIH0KCiAgICB9LAoKCS8qKgoJKiBDaGVjayBpZiB0aGUgZ2l2ZW4gc291bmQgaXMgcmVhZHkgZm9yIHBsYXliYWNrLiBBIHNvdW5kIGlzIGNvbnNpZGVyZWQgcmVhZHkgd2hlbiBpdCBoYXMgZmluaXNoZWQgZGVjb2RpbmcgYW5kIHRoZSBkZXZpY2UgaXMgbm8gbG9uZ2VyIHRvdWNoIGxvY2tlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjaXNTb3VuZFJlYWR5CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHNvdW5kIHlvdSB3YW50LgoJKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIHRoZSBzb3VuZCBpcyBkZWNvZGVkIGFuZCB0aGUgZGV2aWNlIGlzIG5vdCB0b3VjaCBsb2NrZWQuCgkqLwogICAgaXNTb3VuZFJlYWR5OiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIHJldHVybiAodGhpcy5fc291bmRzW2tleV0gJiYgdGhpcy5fc291bmRzW2tleV0uZGVjb2RlZCAmJiB0aGlzLmdhbWUuc291bmQudG91Y2hMb2NrZWQgPT0gZmFsc2UpOwoKICAgIH0sCgoJLyoqCgkqIENoZWNrIHdoZXRoZXIgYW4gaW1hZ2UgYXNzZXQgaXMgc3ByaXRlIHNoZWV0IG9yIG5vdC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjaXNTcHJpdGVTaGVldAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXQga2V5IG9mIHRoZSBzcHJpdGUgc2hlZXQgeW91IHdhbnQuCgkqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGltYWdlIGlzIGEgc3ByaXRlIHNoZWV0LgoJKi8KICAgIGlzU3ByaXRlU2hlZXQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX2ltYWdlc1trZXldKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2ltYWdlc1trZXldLnNwcml0ZVNoZWV0OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgoJLyoqCgkqIEdldCB0ZXh0IGRhdGEgYnkga2V5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRUZXh0CgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgb2YgdGhlIHRleHQgZGF0YSB5b3Ugd2FudC4KCSogQHJldHVybiB7b2JqZWN0fSBUaGUgdGV4dCBkYXRhIHlvdSB3YW50LgoJKi8KICAgIGdldFRleHQ6IGZ1bmN0aW9uIChrZXkpIHsKCiAgICAgICAgaWYgKHRoaXMuX3RleHRba2V5XSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl90ZXh0W2tleV0uZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBudWxsOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogR2V0IHRoZSBjYWNoZSBrZXlzIGZyb20gYSBnaXZlbiBhcnJheSBvZiBvYmplY3RzLgogICAgKiBOb3JtYWxseSB5b3UgZG9uJ3QgY2FsbCB0aGlzIGRpcmVjdGx5IGJ1dCBpbnN0ZWFkIHVzZSBnZXRJbWFnZUtleXMsIGdldFNvdW5kS2V5cywgZXRjLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRLZXlzCiAgICAqIEBwYXJhbSB7QXJyYXl9IGFycmF5IC0gQW4gYXJyYXkgb2YgaXRlbXMgdG8gcmV0dXJuIHRoZSBrZXlzIGZvci4KICAgICogQHJldHVybiB7QXJyYXl9IFRoZSBhcnJheSBvZiBpdGVtIGtleXMuCiAgICAqLwogICAgZ2V0S2V5czogZnVuY3Rpb24gKGFycmF5KSB7CgogICAgICAgIHZhciBvdXRwdXQgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiBhcnJheSkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChpdGVtICE9PSAnX19kZWZhdWx0JykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3V0cHV0LnB1c2goaXRlbSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBvdXRwdXQ7CgogICAgfSwKCgkvKioKCSogUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCBvZiB0aGUga2V5cyBvZiBJbWFnZXMgaW4gdGhlIENhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRJbWFnZUtleXMKCSogQHJldHVybiB7QXJyYXl9IFRoZSBzdHJpbmcgYmFzZWQga2V5cyBpbiB0aGUgQ2FjaGUuCgkqLwogICAgZ2V0SW1hZ2VLZXlzOiBmdW5jdGlvbiAoKSB7CiAgICAJcmV0dXJuIHRoaXMuZ2V0S2V5cyh0aGlzLl9pbWFnZXMpOwogICAgfSwKCgkvKioKCSogUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCBvZiB0aGUga2V5cyBvZiBTb3VuZHMgaW4gdGhlIENhY2hlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNnZXRTb3VuZEtleXMKCSogQHJldHVybiB7QXJyYXl9IFRoZSBzdHJpbmcgYmFzZWQga2V5cyBpbiB0aGUgQ2FjaGUuCgkqLwogICAgZ2V0U291bmRLZXlzOiBmdW5jdGlvbiAoKSB7CiAgICAJcmV0dXJuIHRoaXMuZ2V0S2V5cyh0aGlzLl9zb3VuZHMpOwogICAgfSwKCgkvKioKCSogUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIGFsbCBvZiB0aGUga2V5cyBvZiBUZXh0IEZpbGVzIGluIHRoZSBDYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjZ2V0VGV4dEtleXMKCSogQHJldHVybiB7QXJyYXl9IFRoZSBzdHJpbmcgYmFzZWQga2V5cyBpbiB0aGUgQ2FjaGUuCgkqLwogICAgZ2V0VGV4dEtleXM6IGZ1bmN0aW9uICgpIHsKICAgIAlyZXR1cm4gdGhpcy5nZXRLZXlzKHRoaXMuX3RleHQpOwogICAgfSwKCgkvKioKCSogUmVtb3ZlcyBhIGNhbnZhcyBmcm9tIHRoZSBjYWNoZS4KICAgICoKCSogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVtb3ZlQ2FudmFzCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KCSovCiAgICByZW1vdmVDYW52YXM6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5fY2FudmFzZXNba2V5XTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYW4gaW1hZ2UgZnJvbSB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZUltYWdlCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGFzc2V0IHlvdSB3YW50IHRvIHJlbW92ZS4KICAgICovCiAgICByZW1vdmVJbWFnZTogZnVuY3Rpb24gKGtleSkgewogICAgICAgIGRlbGV0ZSB0aGlzLl9pbWFnZXNba2V5XTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbW92ZXMgYSBzb3VuZCBmcm9tIHRoZSBjYWNoZS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ2FjaGUjcmVtb3ZlU291bmQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZVNvdW5kOiBmdW5jdGlvbiAoa2V5KSB7CiAgICAgICAgZGVsZXRlIHRoaXMuX3NvdW5kc1trZXldOwogICAgfSwKCiAgICAvKioKICAgICogUmVtb3ZlcyBhIHRleHQgZnJvbSB0aGUgY2FjaGUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNhY2hlI3JlbW92ZVRleHQKICAgICogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgYXNzZXQgeW91IHdhbnQgdG8gcmVtb3ZlLgogICAgKi8KICAgIHJlbW92ZVRleHQ6IGZ1bmN0aW9uIChrZXkpIHsKICAgICAgICBkZWxldGUgdGhpcy5fdGV4dFtrZXldOwogICAgfSwKCgkvKioKCSogQ2xlYXJzIHRoZSBjYWNoZS4gUmVtb3ZlcyBldmVyeSBsb2NhbCBjYWNoZSBvYmplY3QgcmVmZXJlbmNlLgogICAgKgoJKiBAbWV0aG9kIFBoYXNlci5DYWNoZSNkZXN0cm95CgkqLwogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIHRoaXMuX2NhbnZhc2VzKQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2NhbnZhc2VzW2l0ZW1bJ2tleSddXTsKICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGl0ZW0gaW4gdGhpcy5faW1hZ2VzKQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX2ltYWdlc1tpdGVtWydrZXknXV07CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpdGVtIGluIHRoaXMuX3NvdW5kcykKICAgICAgICB7CiAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9zb3VuZHNbaXRlbVsna2V5J11dOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaXRlbSBpbiB0aGlzLl90ZXh0KQogICAgICAgIHsKICAgICAgICAgICAgZGVsZXRlIHRoaXMuX3RleHRbaXRlbVsna2V5J11dOwogICAgICAgIH0KICAgIH0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgbG9hZGVyIGNvbnN0cnVjdG9yLgoqIFRoZSBMb2FkZXIgaGFuZGxlcyBsb2FkaW5nIGFsbCBleHRlcm5hbCBjb250ZW50IHN1Y2ggYXMgSW1hZ2VzLCBTb3VuZHMsIFRleHR1cmUgQXRsYXNlcyBhbmQgZGF0YSBmaWxlcy4KKiBJdCB1c2VzIGEgY29tYmluYXRpb24gb2YgSW1hZ2UoKSBsb2FkaW5nIGFuZCB4aHIgYW5kIHByb3ZpZGVzIHByb2dyZXNzIGFuZCBjb21wbGV0aW9uIGNhbGxiYWNrcy4KKiBAY2xhc3MgUGhhc2VyLkxvYWRlcgoqIEBjbGFzc2Rlc2MgIFRoZSBMb2FkZXIgaGFuZGxlcyBsb2FkaW5nIGFsbCBleHRlcm5hbCBjb250ZW50IHN1Y2ggYXMgSW1hZ2VzLCBTb3VuZHMsIFRleHR1cmUgQXRsYXNlcyBhbmQgZGF0YSBmaWxlcy4KKiBJdCB1c2VzIGEgY29tYmluYXRpb24gb2YgSW1hZ2UoKSBsb2FkaW5nIGFuZCB4aHIgYW5kIHByb3ZpZGVzIHByb2dyZXNzIGFuZCBjb21wbGV0aW9uIGNhbGxiYWNrcy4KKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIGdhbWUuCiovClBoYXNlci5Mb2FkZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCgkvKioKCSogQHByb3BlcnR5IHthcnJheX0gX2tleXMgLSBBcnJheSBzdG9yZXMgYXNzZXRzIGtleXMuIFNvIHlvdSBjYW4gZ2V0IHRoYXQgYXNzZXQgYnkgaXRzIHVuaXF1ZSBrZXkuCgkqIEBwcml2YXRlCiAgICAqLwoJdGhpcy5fa2V5cyA9IFtdOwoKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfZmlsZUxpc3QgLSBDb250YWlucyBhbGwgdGhlIGFzc2V0cyBmaWxlIGluZm9zLgoJKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX2ZpbGVMaXN0ID0ge307CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcHJvZ3Jlc3NDaHVuayAtIEluZGljYXRlcyBhc3NldHMgbG9hZGluZyBwcm9ncmVzcy4gKGZyb20gMCB0byAxMDApCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5fcHJvZ3Jlc3NDaHVuayA9IDA7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7WE1MSHR0cFJlcXVlc3R9IC0gQW4gWE1MSHR0cFJlcXVlc3Qgb2JqZWN0IHVzZWQgZm9yIGxvYWRpbmcgdGV4dCBhbmQgYXVkaW8gZGF0YS4KCSogQHByaXZhdGUKCSovCgl0aGlzLl94aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKCgkvKiogCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSAtIExlbmd0aCBvZiBhc3NldHMgcXVldWUuCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5xdWV1ZVNpemUgPSAwOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzTG9hZGluZyAtIFRydWUgaWYgdGhlIExvYWRlciBpcyBpbiB0aGUgcHJvY2VzcyBvZiBsb2FkaW5nIHRoZSBxdWV1ZS4KCSogQGRlZmF1bHQKCSovCgl0aGlzLmlzTG9hZGluZyA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IGhhc0xvYWRlZCAtIFRydWUgaWYgYWxsIGFzc2V0cyBpbiB0aGUgcXVldWUgaGF2ZSBmaW5pc2hlZCBsb2FkaW5nLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuaGFzTG9hZGVkID0gZmFsc2U7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcm9ncmVzcyAtIFRoZSBMb2FkIHByb2dyZXNzIHBlcmNlbnRhZ2UgdmFsdWUgKGZyb20gMCB0byAxMDApCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5wcm9ncmVzcyA9IDA7CgoJLyoqCgkqIFlvdSBjYW4gb3B0aW9uYWxseSBsaW5rIGEgc3ByaXRlIHRvIHRoZSBwcmVsb2FkZXIuCgkqIElmIHlvdSBkbyBzbyB0aGUgU3ByaXRlJ3Mgd2lkdGggb3IgaGVpZ2h0IHdpbGwgYmUgY3JvcHBlZCBiYXNlZCBvbiB0aGUgcGVyY2VudGFnZSBsb2FkZWQuCgkqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IHByZWxvYWRTcHJpdGUKCSogQGRlZmF1bHQKCSovCgl0aGlzLnByZWxvYWRTcHJpdGUgPSBudWxsOwoKCS8qKgoJKiBAcHJvcGVydHkge3N0cmluZ30gY3Jvc3NPcmlnaW4gLSBUaGUgY3Jvc3NPcmlnaW4gdmFsdWUgYXBwbGllZCB0byBsb2FkZWQgaW1hZ2VzCgkqLwoJdGhpcy5jcm9zc09yaWdpbiA9ICcnOwoKCS8qKgoJKiBJZiB5b3Ugd2FudCB0byBhcHBlbmQgYSBVUkwgYmVmb3JlIHRoZSBwYXRoIG9mIGFueSBhc3NldCB5b3UgY2FuIHNldCB0aGlzIGhlcmUuCgkqIFVzZWZ1bCBpZiB5b3UgbmVlZCB0byBhbGxvdyBhbiBhc3NldCB1cmwgdG8gYmUgY29uZmlndXJlZCBvdXRzaWRlIG9mIHRoZSBnYW1lIGNvZGUuCgkqIE1VU1QgaGF2ZSAvIG9uIHRoZSBlbmQgb2YgaXQhCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBiYXNlVVJMCgkqIEBkZWZhdWx0CgkqLwoJdGhpcy5iYXNlVVJMID0gJyc7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25GaWxlQ29tcGxldGUgLSBFdmVudCBzaWduYWwuCgkqLwoJdGhpcy5vbkZpbGVDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJCgkvKioKCSogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkZpbGVFcnJvciAtIEV2ZW50IHNpZ25hbC4KCSovCgl0aGlzLm9uRmlsZUVycm9yID0gbmV3IFBoYXNlci5TaWduYWw7CgkKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uTG9hZFN0YXJ0IC0gRXZlbnQgc2lnbmFsLgoJKi8KCXRoaXMub25Mb2FkU3RhcnQgPSBuZXcgUGhhc2VyLlNpZ25hbDsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Mb2FkQ29tcGxldGUgLSBFdmVudCBzaWduYWwuCgkqLwoJdGhpcy5vbkxvYWRDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKfTsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZID0gMDsKCi8qKgoqIEBjb25zdGFudAoqIEB0eXBlIHtudW1iZXJ9CiovClBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0ggPSAxOwoKLyoqCiogQGNvbnN0YW50CiogQHR5cGUge251bWJlcn0KKi8KUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORyA9IDI7CgpQaGFzZXIuTG9hZGVyLnByb3RvdHlwZSA9IHsKCgkvKioKCSogWW91IGNhbiBzZXQgYSBTcHJpdGUgdG8gYmUgYSAicHJlbG9hZCIgc3ByaXRlIGJ5IHBhc3NpbmcgaXQgdG8gdGhpcyBtZXRob2QuCgkqIEEgInByZWxvYWQiIHNwcml0ZSB3aWxsIGhhdmUgaXRzIHdpZHRoIG9yIGhlaWdodCBjcm9wIGFkanVzdGVkIGJhc2VkIG9uIHRoZSBwZXJjZW50YWdlIG9mIHRoZSBsb2FkZXIgaW4gcmVhbC10aW1lLgoJKiBUaGlzIGFsbG93cyB5b3UgdG8gZWFzaWx5IG1ha2UgbG9hZGluZyBiYXJzIGZvciBnYW1lcy4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3NldFByZWxvYWRTcHJpdGUKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBUaGUgc3ByaXRlIHRoYXQgd2lsbCBiZSBjcm9wcGVkIGR1cmluZyB0aGUgbG9hZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtkaXJlY3Rpb249MF0gLSBBIHZhbHVlIG9mIHplcm8gbWVhbnMgdGhlIHNwcml0ZSB3aWR0aCB3aWxsIGJlIGNyb3BwZWQsIGEgdmFsdWUgb2YgMSBtZWFucyBpdHMgaGVpZ2h0IHdpbGwgYmUgY3JvcHBlZC4KICAgICovCglzZXRQcmVsb2FkU3ByaXRlOiBmdW5jdGlvbiAoc3ByaXRlLCBkaXJlY3Rpb24pIHsKCgkJZGlyZWN0aW9uID0gZGlyZWN0aW9uIHx8IDA7CgoJCXRoaXMucHJlbG9hZFNwcml0ZSA9IHsgc3ByaXRlOiBzcHJpdGUsIGRpcmVjdGlvbjogZGlyZWN0aW9uLCB3aWR0aDogc3ByaXRlLndpZHRoLCBoZWlnaHQ6IHNwcml0ZS5oZWlnaHQsIGNyb3A6IG51bGwgfTsKCgkJaWYgKGRpcmVjdGlvbiA9PSAwKQoJCXsKCQkJLy8JSG9yaXpvbnRhbCBjcm9wCgkJCXRoaXMucHJlbG9hZFNwcml0ZS5jcm9wID0gbmV3IFBoYXNlci5SZWN0YW5nbGUoMCwgMCwgMSwgc3ByaXRlLmhlaWdodCk7CgkJfQoJCWVsc2UKCQl7CgkJCS8vCVZlcnRpY2FsIGNyb3AKCQkJdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3AgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgwLCAwLCBzcHJpdGUud2lkdGgsIDEpOwoJCX0KCgkJc3ByaXRlLmNyb3AgPSB0aGlzLnByZWxvYWRTcHJpdGUuY3JvcDsKCQlzcHJpdGUuY3JvcEVuYWJsZWQgPSB0cnVlOwoKCX0sCgoJLyoqCgkqIENoZWNrIHdoZXRoZXIgYXNzZXQgZXhpc3RzIHdpdGggYSBzcGVjaWZpYyBrZXkuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNjaGVja0tleUV4aXN0cwoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBhc3NldCB5b3Ugd2FudCB0byBjaGVjay4KCSogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJuIHRydWUgaWYgZXhpc3RzLCBvdGhlcndpc2UgcmV0dXJuIGZhbHNlLgoJKi8KCWNoZWNrS2V5RXhpc3RzOiBmdW5jdGlvbiAoa2V5KSB7CgoJCWlmICh0aGlzLl9maWxlTGlzdFtrZXldKQoJCXsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWVsc2UKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJCgl9LAoKCS8qKgoJKiBSZXNldCBsb2FkZXIsIHRoaXMgd2lsbCByZW1vdmUgYWxsIGxvYWRlZCBhc3NldHMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZXNldAoJKi8KCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMucHJlbG9hZFNwcml0ZSA9IG51bGw7CgkJdGhpcy5xdWV1ZVNpemUgPSAwOwoJCXRoaXMuaXNMb2FkaW5nID0gZmFsc2U7CgoJfSwKCgkvKioKCSogSW50ZXJuYWwgZnVuY3Rpb24gdGhhdCBhZGRzIGEgbmV3IGVudHJ5IHRvIHRoZSBmaWxlIGxpc3QuIERvIG5vdCBjYWxsIGRpcmVjdGx5LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYWRkVG9GaWxlTGlzdAoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB0eXBlIC0gRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiBEZXNjcmlwdGlvbi4KCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gcHJvcGVydGllcyAtIERlc2NyaXB0aW9uLgoJKiBAcHJvdGVjdGVkCgkqLwoJYWRkVG9GaWxlTGlzdDogZnVuY3Rpb24gKHR5cGUsIGtleSwgdXJsLCBwcm9wZXJ0aWVzKSB7CgoJCXZhciBlbnRyeSA9IHsKCQkJdHlwZTogdHlwZSwKCQkJa2V5OiBrZXksCgkJCXVybDogdXJsLAoJCQlkYXRhOiBudWxsLAoJCQllcnJvcjogZmFsc2UsCgkJCWxvYWRlZDogZmFsc2UKCQl9OwoKCQlpZiAodHlwZW9mIHByb3BlcnRpZXMgIT09ICJ1bmRlZmluZWQiKQoJCXsKCQkJZm9yICh2YXIgcHJvcCBpbiBwcm9wZXJ0aWVzKQoJCQl7CgkJCQllbnRyeVtwcm9wXSA9IHByb3BlcnRpZXNbcHJvcF07CgkJCX0KCQl9CgoJCXRoaXMuX2ZpbGVMaXN0W2tleV0gPSBlbnRyeTsKCgkJdGhpcy5fa2V5cy5wdXNoKGtleSk7CgoJCXRoaXMucXVldWVTaXplKys7CgoJfSwKCgkvKioKCSogQWRkIGFuIGltYWdlIHRvIHRoZSBMb2FkZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNpbWFnZQoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGlzIGltYWdlIGZpbGUuCgkqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgaW1hZ2UgZmlsZS4KCSogQHBhcmFtIHtib29sZWFufSBvdmVyd3JpdGUgLSBJZiBhbiBlbnRyeSB3aXRoIGEgbWF0Y2hpbmcga2V5IGFscmVhZHkgZXhpc3RzIHRoaXMgd2lsbCBvdmVyLXdyaXRlIGl0CgkqLwoJaW1hZ2U6IGZ1bmN0aW9uIChrZXksIHVybCwgb3ZlcndyaXRlKSB7CgoJCWlmICh0eXBlb2Ygb3ZlcndyaXRlID09PSAidW5kZWZpbmVkIikgeyBvdmVyd3JpdGUgPSBmYWxzZTsgfQoKCQlpZiAob3ZlcndyaXRlIHx8IHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PSBmYWxzZSkKCQl7CgkJCXRoaXMuYWRkVG9GaWxlTGlzdCgnaW1hZ2UnLCBrZXksIHVybCk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBBZGQgYSB0ZXh0IGZpbGUgdG8gdGhlIExvYWRlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3RleHQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRleHQgZmlsZS4KCSogQHBhcmFtIHtzdHJpbmd9IHVybCAtIFVSTCBvZiB0aGUgdGV4dCBmaWxlLgoJKiBAcGFyYW0ge2Jvb2xlYW59IG92ZXJ3cml0ZSAtIFRydWUgaWYgRGVzY3JpcHRpb24uCgkqLwoJdGV4dDogZnVuY3Rpb24gKGtleSwgdXJsLCBvdmVyd3JpdGUpIHsKCgkJaWYgKHR5cGVvZiBvdmVyd3JpdGUgPT09ICJ1bmRlZmluZWQiKSB7IG92ZXJ3cml0ZSA9IGZhbHNlOyB9CgoJCWlmIChvdmVyd3JpdGUgfHwgdGhpcy5jaGVja0tleUV4aXN0cyhrZXkpID09IGZhbHNlKQoJCXsKCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0Jywga2V5LCB1cmwpOwoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHNwcml0ZSBzaGVldCB0byB0aGUgbG9hZGVyLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjc3ByaXRlc2hlZXQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHNoZWV0IGZpbGUuCgkqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBVUkwgb2YgdGhlIHNoZWV0IGZpbGUuCgkqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZVdpZHRoIC0gV2lkdGggb2YgZWFjaCBzaW5nbGUgZnJhbWUuCgkqIEBwYXJhbSB7bnVtYmVyfSBmcmFtZUhlaWdodCAtIEhlaWdodCBvZiBlYWNoIHNpbmdsZSBmcmFtZS4KCSogQHBhcmFtIHtudW1iZXJ9IFtmcmFtZU1heD0tMV0gLSBIb3cgbWFueSBmcmFtZXMgaW4gdGhpcyBzcHJpdGUgc2hlZXQuIElmIG5vdCBzcGVjaWZpZWQgaXQgd2lsbCBkaXZpZGUgdGhlIHdob2xlIGltYWdlIGludG8gZnJhbWVzLgoJKi8KCXNwcml0ZXNoZWV0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0LCBmcmFtZU1heCkgewoKCQlpZiAodHlwZW9mIGZyYW1lTWF4ID09PSAidW5kZWZpbmVkIikgeyBmcmFtZU1heCA9IC0xOyB9CgoJCWlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT09IGZhbHNlKQoJCXsKCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCdzcHJpdGVzaGVldCcsIGtleSwgdXJsLCB7IGZyYW1lV2lkdGg6IGZyYW1lV2lkdGgsIGZyYW1lSGVpZ2h0OiBmcmFtZUhlaWdodCwgZnJhbWVNYXg6IGZyYW1lTWF4IH0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHRpbGUgc2V0IHRvIHRoZSBsb2FkZXIuIFRoZXNlIGFyZSB1c2VkIGluIHRoZSByZW5kZXJpbmcgb2YgdGlsZSBtYXBzLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjdGlsZXNldAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgdGlsZXNldCBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gdXJsIC0gVVJMIG9mIHRoZSB0aWxlc2V0LgoJKiBAcGFyYW0ge251bWJlcn0gdGlsZVdpZHRoIC0gV2lkdGggb2YgZWFjaCBzaW5nbGUgdGlsZSBpbiBwaXhlbHMuCgkqIEBwYXJhbSB7bnVtYmVyfSB0aWxlSGVpZ2h0IC0gSGVpZ2h0IG9mIGVhY2ggc2luZ2xlIHRpbGUgaW4gcGl4ZWxzLgoJKiBAcGFyYW0ge251bWJlcn0gW3RpbGVNYXg9LTFdIC0gSG93IG1hbnkgdGlsZXMgaW4gdGhpcyB0aWxlc2V0LiBJZiBub3Qgc3BlY2lmaWVkIGl0IHdpbGwgZGl2aWRlIHRoZSB3aG9sZSBpbWFnZSBpbnRvIHRpbGVzLgoJKiBAcGFyYW0ge251bWJlcn0gW3RpbGVNYXJnaW49MF0gLSBJZiB0aGUgdGlsZXMgaGF2ZSBiZWVuIGRyYXduIHdpdGggYSBtYXJnaW4sIHNwZWNpZnkgdGhlIGFtb3VudCBoZXJlLgoJKiBAcGFyYW0ge251bWJlcn0gW3RpbGVTcGFjaW5nPTBdIC0gSWYgdGhlIHRpbGVzIGhhdmUgYmVlbiBkcmF3biB3aXRoIHNwYWNpbmcgYmV0d2VlbiB0aGVtLCBzcGVjaWZ5IHRoZSBhbW91bnQgaGVyZS4KCSovCgl0aWxlc2V0OiBmdW5jdGlvbiAoa2V5LCB1cmwsIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1heCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcpIHsKCgkJaWYgKHR5cGVvZiB0aWxlTWF4ID09PSAidW5kZWZpbmVkIikgeyB0aWxlTWF4ID0gLTE7IH0KCQlpZiAodHlwZW9mIHRpbGVNYXJnaW4gPT09ICJ1bmRlZmluZWQiKSB7IHRpbGVNYXJnaW4gPSAwOyB9CgkJaWYgKHR5cGVvZiB0aWxlU3BhY2luZyA9PT0gInVuZGVmaW5lZCIpIHsgdGlsZVNwYWNpbmcgPSAwOyB9CgoJCWlmICh0aGlzLmNoZWNrS2V5RXhpc3RzKGtleSkgPT09IGZhbHNlKQoJCXsKCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCd0aWxlc2V0Jywga2V5LCB1cmwsIHsgdGlsZVdpZHRoOiB0aWxlV2lkdGgsIHRpbGVIZWlnaHQ6IHRpbGVIZWlnaHQsIHRpbGVNYXg6IHRpbGVNYXgsIHRpbGVNYXJnaW46IHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nOiB0aWxlU3BhY2luZyB9KTsKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyBhdWRpbyBmaWxlIHRvIHRoZSBsb2FkZXIuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdWRpbwoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgYXVkaW8gZmlsZS4KCSogQHBhcmFtIHtBcnJheX0gdXJscyAtIEFuIGFycmF5IGNvbnRhaW5pbmcgdGhlIFVSTHMgb2YgdGhlIGF1ZGlvIGZpbGVzLCBpLmUuOiBbICdqdW1wLm1wMycsICdqdW1wLm9nZycsICdqdW1wLm00YScgXS4KCSogQHBhcmFtIHtib29sZWFufSBhdXRvRGVjb2RlIC0gV2hlbiB1c2luZyBXZWIgQXVkaW8gdGhlIGF1ZGlvIGZpbGVzIGNhbiBlaXRoZXIgYmUgZGVjb2RlZCBhdCBsb2FkIHRpbWUgb3IgcnVuLXRpbWUuIFRoZXkgY2FuJ3QgYmUgcGxheWVkIHVudGlsIHRoZXkgYXJlIGRlY29kZWQsIGJ1dCB0aGlzIGxldCdzIHlvdSBjb250cm9sIHdoZW4gdGhhdCBoYXBwZW5zLiBEZWNvZGluZyBpcyBhIG5vbi1ibG9ja2luZyBhc3luYyBwcm9jZXNzLgoJKi8KCWF1ZGlvOiBmdW5jdGlvbiAoa2V5LCB1cmxzLCBhdXRvRGVjb2RlKSB7CgoJCWlmICh0eXBlb2YgYXV0b0RlY29kZSA9PT0gInVuZGVmaW5lZCIpIHsgYXV0b0RlY29kZSA9IHRydWU7IH0KCgkJaWYgKHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PT0gZmFsc2UpCgkJewoJCQl0aGlzLmFkZFRvRmlsZUxpc3QoJ2F1ZGlvJywga2V5LCB1cmxzLCB7IGJ1ZmZlcjogbnVsbCwgYXV0b0RlY29kZTogYXV0b0RlY29kZSB9KTsKCQl9CgoJCXJldHVybiB0aGlzOwoKCX0sCgoJLyoqCgkqIEFkZCBhIG5ldyB0aWxlbWFwIGxvYWRpbmcgcmVxdWVzdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3RpbGVtYXAKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIHRpbGVtYXAgZGF0YS4KCSogQHBhcmFtIHtzdHJpbmd9IHRpbGVzZXRVUkwgLSBUaGUgdXJsIG9mIHRoZSB0aWxlIHNldCBpbWFnZSBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gW21hcERhdGFVUkxdIC0gVGhlIHVybCBvZiB0aGUgbWFwIGRhdGEgZmlsZSAoY3N2L2pzb24pCgkqIEBwYXJhbSB7b2JqZWN0fSBbbWFwRGF0YV0gLSBBbiBvcHRpb25hbCBKU09OIGRhdGEgb2JqZWN0IChjYW4gYmUgZ2l2ZW4gaW4gcGxhY2Ugb2YgYSBVUkwpLgoJKiBAcGFyYW0ge3N0cmluZ30gW2Zvcm1hdF0gLSBUaGUgZm9ybWF0IG9mIHRoZSBtYXAgZGF0YS4KCSovCgl0aWxlbWFwOiBmdW5jdGlvbiAoa2V5LCBtYXBEYXRhVVJMLCBtYXBEYXRhLCBmb3JtYXQpIHsKCgkJaWYgKHR5cGVvZiBtYXBEYXRhVVJMID09PSAidW5kZWZpbmVkIikgeyBtYXBEYXRhVVJMID0gbnVsbDsgfQoJCWlmICh0eXBlb2YgbWFwRGF0YSA9PT0gInVuZGVmaW5lZCIpIHsgbWFwRGF0YSA9IG51bGw7IH0KCQlpZiAodHlwZW9mIGZvcm1hdCA9PT0gInVuZGVmaW5lZCIpIHsgZm9ybWF0ID0gUGhhc2VyLlRpbGVtYXAuQ1NWOyB9CgoJCWlmIChtYXBEYXRhVVJMID09IG51bGwgJiYgbWFwRGF0YSA9PSBudWxsKQoJCXsKCQkJY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyLnRpbGVtYXAgLSBCb3RoIG1hcERhdGFVUkwgYW5kIG1hcERhdGEgYXJlIG51bGwuIE9uZSBtdXN0IGJlIHNldC4nKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PT0gZmFsc2UpCgkJewoJCQkvLyAgQSBVUkwgdG8gYSBqc29uL2NzdiBmaWxlIGhhcyBiZWVuIGdpdmVuCgkJCWlmIChtYXBEYXRhVVJMKQoJCQl7CgkJCQl0aGlzLmFkZFRvRmlsZUxpc3QoJ3RpbGVtYXAnLCBrZXksIG1hcERhdGFVUkwsIHsgZm9ybWF0OiBmb3JtYXQgfSk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlzd2l0Y2ggKGZvcm1hdCkKCQkJCXsKCQkJCQkvLyAgQSBjc3Ygc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgoJCQkJCWNhc2UgUGhhc2VyLlRpbGVtYXAuQ1NWOgoJCQkJCQlicmVhazsKCgkJCQkJLy8gIEFuIHhtbCBzdHJpbmcgb3Igb2JqZWN0IGhhcyBiZWVuIGdpdmVuCgkJCQkJY2FzZSBQaGFzZXIuVGlsZW1hcC5USUxFRF9KU09OOgoKCQkJCQkJaWYgKHR5cGVvZiBtYXBEYXRhID09PSAnc3RyaW5nJykKCQkJCQkJewoJCQkJCQkJbWFwRGF0YSA9IEpTT04ucGFyc2UobWFwRGF0YSk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFRpbGVtYXAoa2V5LCBudWxsLCBtYXBEYXRhLCBmb3JtYXQpOwoKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IGJpdG1hcCBmb250IGxvYWRpbmcgcmVxdWVzdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2JpdG1hcEZvbnQKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGJpdG1hcCBmb250LgoJKiBAcGFyYW0ge3N0cmluZ30gdGV4dHVyZVVSTCAtIFRoZSB1cmwgb2YgdGhlIGZvbnQgaW1hZ2UgZmlsZS4KCSogQHBhcmFtIHtzdHJpbmd9IFt4bWxVUkxdIC0gVGhlIHVybCBvZiB0aGUgZm9udCBkYXRhIGZpbGUgKHhtbC9mbnQpCgkqIEBwYXJhbSB7b2JqZWN0fSBbeG1sRGF0YV0gLSBBbiBvcHRpb25hbCBYTUwgZGF0YSBvYmplY3QuCgkqLwoJYml0bWFwRm9udDogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgeG1sVVJMLCB4bWxEYXRhKSB7CgoJCWlmICh0eXBlb2YgeG1sVVJMID09PSAidW5kZWZpbmVkIikgeyB4bWxVUkwgPSBudWxsOyB9CgkJaWYgKHR5cGVvZiB4bWxEYXRhID09PSAidW5kZWZpbmVkIikgeyB4bWxEYXRhID0gbnVsbDsgfQoKCQlpZiAodGhpcy5jaGVja0tleUV4aXN0cyhrZXkpID09PSBmYWxzZSkKCQl7CgkJCS8vICBBIFVSTCB0byBhIGpzb24veG1sIGZpbGUgaGFzIGJlZW4gZ2l2ZW4KCQkJaWYgKHhtbFVSTCkKCQkJewoJCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCdiaXRtYXBmb250Jywga2V5LCB0ZXh0dXJlVVJMLCB7IHhtbFVSTDogeG1sVVJMIH0pOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJLy8gIEFuIHhtbCBzdHJpbmcgb3Igb2JqZWN0IGhhcyBiZWVuIGdpdmVuCgkJCQlpZiAodHlwZW9mIHhtbERhdGEgPT09ICdzdHJpbmcnKQoJCQkJewoJCQkJCXZhciB4bWw7CgoJCQkJCXRyeSAgewoJCQkJCQlpZiAod2luZG93WydET01QYXJzZXInXSkKCQkJCQkJewoJCQkJCQkJdmFyIGRvbXBhcnNlciA9IG5ldyBET01QYXJzZXIoKTsKCQkJCQkJCXhtbCA9IGRvbXBhcnNlci5wYXJzZUZyb21TdHJpbmcoeG1sRGF0YSwgInRleHQveG1sIik7CgkJCQkJCX0KCQkJCQkJZWxzZQoJCQkJCQl7CgkJCQkJCQl4bWwgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTERPTSIpOwoJCQkJCQkJeG1sLmFzeW5jID0gJ2ZhbHNlJzsKCQkJCQkJCXhtbC5sb2FkWE1MKHhtbERhdGEpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWNhdGNoIChlKQoJCQkJCXsKCQkJCQkJeG1sID0gdW5kZWZpbmVkOwoJCQkJCX0KCgkJCQkJaWYgKCF4bWwgfHwgIXhtbC5kb2N1bWVudEVsZW1lbnQgfHwgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJwYXJzZXJlcnJvciIpLmxlbmd0aCkKCQkJCQl7CgkJCQkJCXRocm93IG5ldyBFcnJvcigiUGhhc2VyLkxvYWRlci4gSW52YWxpZCBCaXRtYXAgRm9udCBYTUwgZ2l2ZW4iKTsKCQkJCQl9CgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCdiaXRtYXBmb250Jywga2V5LCB0ZXh0dXJlVVJMLCB7IHhtbFVSTDogbnVsbCwgeG1sRGF0YTogeG1sIH0pOwoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXM7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBKU09OIEFycmF5IGRhdGEgZm9ybWF0LgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjYXRsYXNKU09OQXJyYXkKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGJpdG1hcCBmb250LgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc1VSTCAtIFRoZSB1cmwgb2YgdGhlIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc0RhdGEgLSBEZXNjcmlwdGlvbi4KCSovCglhdGxhc0pTT05BcnJheTogZnVuY3Rpb24gKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSkgewoKCQlyZXR1cm4gdGhpcy5hdGxhcyhrZXksIHRleHR1cmVVUkwsIGF0bGFzVVJMLCBhdGxhc0RhdGEsIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZKTsKCgl9LAoKCS8qKgoJKiBBZGQgYSBuZXcgdGV4dHVyZSBhdGxhcyB0byB0aGUgbG9hZGVyLiBUaGlzIGF0bGFzIHVzZXMgdGhlIEpTT04gSGFzaCBkYXRhIGZvcm1hdC4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzSlNPTkhhc2gKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIFVuaXF1ZSBhc3NldCBrZXkgb2YgdGhlIGJpdG1hcCBmb250LgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc1VSTCAtIFRoZSB1cmwgb2YgdGhlIERlc2NyaXB0aW9uLgoJKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBhdGxhc0RhdGEgLSBEZXNjcmlwdGlvbi4KCSovCglhdGxhc0pTT05IYXNoOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhKSB7CgoJCXJldHVybiB0aGlzLmF0bGFzKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fSEFTSCk7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4gVGhpcyBhdGxhcyB1c2VzIHRoZSBTdGFybGluZyBYTUwgZGF0YSBmb3JtYXQuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNhdGxhc1hNTAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gVW5pcXVlIGFzc2V0IGtleSBvZiB0aGUgYml0bWFwIGZvbnQuCgkqIEBwYXJhbSB7RGVzY3JpcHRpb259IGF0bGFzVVJMIC0gVGhlIHVybCBvZiB0aGUgRGVzY3JpcHRpb24uCgkqIEBwYXJhbSB7RGVzY3JpcHRpb259IGF0bGFzRGF0YSAtIERlc2NyaXB0aW9uLgoJKi8KCWF0bGFzWE1MOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhKSB7CgoJCXJldHVybiB0aGlzLmF0bGFzKGtleSwgdGV4dHVyZVVSTCwgYXRsYXNVUkwsIGF0bGFzRGF0YSwgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORyk7CgoJfSwKCgkvKioKCSogQWRkIGEgbmV3IHRleHR1cmUgYXRsYXMgdG8gdGhlIGxvYWRlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2F0bGFzCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBVbmlxdWUgYXNzZXQga2V5IG9mIHRoZSB0ZXh0dXJlIGF0bGFzIGZpbGUuCgkqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0dXJlVVJMIC0gVGhlIHVybCBvZiB0aGUgdGV4dHVyZSBhdGxhcyBpbWFnZSBmaWxlLgoJKiBAcGFyYW0ge3N0cmluZ30gW2F0bGFzVVJMXSAtIFRoZSB1cmwgb2YgdGhlIHRleHR1cmUgYXRsYXMgZGF0YSBmaWxlIChqc29uL3htbCkuIFlvdSBkb24ndCBuZWVkIHRoaXMgaWYgeW91IGFyZSBwYXNzaW5nIGFuIGF0bGFzRGF0YSBvYmplY3QgaW5zdGVhZC4KCSogQHBhcmFtIHtvYmplY3R9IFthdGxhc0RhdGFdIC0gQSBKU09OIG9yIFhNTCBkYXRhIG9iamVjdC4gWW91IGRvbid0IG5lZWQgdGhpcyBpZiB0aGUgZGF0YSBpcyBiZWluZyBsb2FkZWQgZnJvbSBhIFVSTC4KCSogQHBhcmFtIHtudW1iZXJ9IFtmb3JtYXRdIC0gQSB2YWx1ZSBkZXNjcmliaW5nIHRoZSBmb3JtYXQgb2YgdGhlIGRhdGEsIHRoZSBkZWZhdWx0IGlzIFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZLgoJKi8KCWF0bGFzOiBmdW5jdGlvbiAoa2V5LCB0ZXh0dXJlVVJMLCBhdGxhc1VSTCwgYXRsYXNEYXRhLCBmb3JtYXQpIHsKCgkJaWYgKHR5cGVvZiBhdGxhc1VSTCA9PT0gInVuZGVmaW5lZCIpIHsgYXRsYXNVUkwgPSBudWxsOyB9CgkJaWYgKHR5cGVvZiBhdGxhc0RhdGEgPT09ICJ1bmRlZmluZWQiKSB7IGF0bGFzRGF0YSA9IG51bGw7IH0KCQlpZiAodHlwZW9mIGZvcm1hdCA9PT0gInVuZGVmaW5lZCIpIHsgZm9ybWF0ID0gUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fQVJSQVk7IH0KCgkJaWYgKHRoaXMuY2hlY2tLZXlFeGlzdHMoa2V5KSA9PT0gZmFsc2UpCgkJewoJCQkvLyAgQSBVUkwgdG8gYSBqc29uL3htbCBmaWxlIGhhcyBiZWVuIGdpdmVuCgkJCWlmIChhdGxhc1VSTCkKCQkJewoJCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0dXJlYXRsYXMnLCBrZXksIHRleHR1cmVVUkwsIHsgYXRsYXNVUkw6IGF0bGFzVVJMLCBmb3JtYXQ6IGZvcm1hdCB9KTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXN3aXRjaCAoZm9ybWF0KQoJCQkJewoJCQkJCS8vICBBIGpzb24gc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgoJCQkJCWNhc2UgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX0pTT05fQVJSQVk6IAoKCQkJCQkJaWYgKHR5cGVvZiBhdGxhc0RhdGEgPT09ICdzdHJpbmcnKQoJCQkJCQl7CgkJCQkJCQlhdGxhc0RhdGEgPSBKU09OLnBhcnNlKGF0bGFzRGF0YSk7CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgoJCQkJCS8vICBBbiB4bWwgc3RyaW5nIG9yIG9iamVjdCBoYXMgYmVlbiBnaXZlbgoJCQkJCWNhc2UgUGhhc2VyLkxvYWRlci5URVhUVVJFX0FUTEFTX1hNTF9TVEFSTElORzoKCgkJCQkJCWlmICh0eXBlb2YgYXRsYXNEYXRhID09PSAnc3RyaW5nJykKCQkJCQkJewoJCQkJCQkJdmFyIHhtbDsKCgkJCQkJCQl0cnkgIHsKCQkJCQkJCQlpZiAod2luZG93WydET01QYXJzZXInXSkKCQkJCQkJCQl7CgkJCQkJCQkJCXZhciBkb21wYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCQkJCQkJCXhtbCA9IGRvbXBhcnNlci5wYXJzZUZyb21TdHJpbmcoYXRsYXNEYXRhLCAidGV4dC94bWwiKTsKCQkJCQkJCQl9CgkJCQkJCQkJZWxzZQoJCQkJCQkJCXsKCQkJCQkJCQkJeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKCQkJCQkJCQkJeG1sLmFzeW5jID0gJ2ZhbHNlJzsKCQkJCQkJCQkJeG1sLmxvYWRYTUwoYXRsYXNEYXRhKTsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCQljYXRjaCAoZSkKCQkJCQkJCXsKCQkJCQkJCQl4bWwgPSB1bmRlZmluZWQ7CgkJCQkJCQl9CgoJCQkJCQkJaWYgKCF4bWwgfHwgIXhtbC5kb2N1bWVudEVsZW1lbnQgfHwgeG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCJwYXJzZXJlcnJvciIpLmxlbmd0aCkKCQkJCQkJCXsKCQkJCQkJCQl0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGV4dHVyZSBBdGxhcyBYTUwgZ2l2ZW4iKTsKCQkJCQkJCX0KCQkJCQkJCWVsc2UKCQkJCQkJCXsKCQkJCQkJCQlhdGxhc0RhdGEgPSB4bWw7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJdGhpcy5hZGRUb0ZpbGVMaXN0KCd0ZXh0dXJlYXRsYXMnLCBrZXksIHRleHR1cmVVUkwsIHsgYXRsYXNVUkw6IG51bGwsIGF0bGFzRGF0YTogYXRsYXNEYXRhLCBmb3JtYXQ6IGZvcm1hdCB9KTsKCgkJCX0KCgkJfQoKCQlyZXR1cm4gdGhpczsKCgl9LAoKCS8qKgoJKiBSZW1vdmUgbG9hZGluZyByZXF1ZXN0IG9mIGEgZmlsZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI3JlbW92ZUZpbGUKCSogQHBhcmFtIGtleSB7c3RyaW5nfSBLZXkgb2YgdGhlIGZpbGUgeW91IHdhbnQgdG8gcmVtb3ZlLgoJKi8KCXJlbW92ZUZpbGU6IGZ1bmN0aW9uIChrZXkpIHsKCgkJZGVsZXRlIHRoaXMuX2ZpbGVMaXN0W2tleV07CgoJfSwKCgkvKioKCSogUmVtb3ZlIGFsbCBmaWxlIGxvYWRpbmcgcmVxdWVzdHMuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNyZW1vdmVBbGwKCSovCglyZW1vdmVBbGw6IGZ1bmN0aW9uICgpIHsKCgkJdGhpcy5fZmlsZUxpc3QgPSB7fTsKCgl9LAoKCS8qKgoJKiBTdGFydCBsb2FkaW5nIHRoZSBhc3NldHMuIE5vcm1hbGx5IHlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB5b3Vyc2VsZiBhcyB0aGUgU3RhdGVNYW5hZ2VyIHdpbGwgZG8gc28uCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNzdGFydAoJKi8KCXN0YXJ0OiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLmlzTG9hZGluZykKCQl7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMucHJvZ3Jlc3MgPSAwOwoJCXRoaXMuaGFzTG9hZGVkID0gZmFsc2U7CgkJdGhpcy5pc0xvYWRpbmcgPSB0cnVlOwoKCQl0aGlzLm9uTG9hZFN0YXJ0LmRpc3BhdGNoKHRoaXMucXVldWVTaXplKTsKCgkJaWYgKHRoaXMuX2tleXMubGVuZ3RoID4gMCkKCQl7CgkJCXRoaXMuX3Byb2dyZXNzQ2h1bmsgPSAxMDAgLyB0aGlzLl9rZXlzLmxlbmd0aDsKCQkJdGhpcy5sb2FkRmlsZSgpOwoJCX0KCQllbHNlCgkJewoJCQl0aGlzLnByb2dyZXNzID0gMTAwOwoJCQl0aGlzLmhhc0xvYWRlZCA9IHRydWU7CgkJCXRoaXMub25Mb2FkQ29tcGxldGUuZGlzcGF0Y2goKTsKCQl9CgoJfSwKCgkvKioKCSogTG9hZCBmaWxlcy4gUHJpdmF0ZSBtZXRob2QgT05MWSB1c2VkIGJ5IGxvYWRlci4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2xvYWRGaWxlCgkqIEBwcml2YXRlCgkqLwoJbG9hZEZpbGU6IGZ1bmN0aW9uICgpIHsKCgkJdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFt0aGlzLl9rZXlzLnNoaWZ0KCldOwoJCXZhciBfdGhpcyA9IHRoaXM7CgoJCS8vICBJbWFnZSBvciBEYXRhPwoJCXN3aXRjaCAoZmlsZS50eXBlKQoJCXsKCQkJY2FzZSAnaW1hZ2UnOgoJCQljYXNlICdzcHJpdGVzaGVldCc6CgkJCWNhc2UgJ3RleHR1cmVhdGxhcyc6CgkJCWNhc2UgJ2JpdG1hcGZvbnQnOgoJCQljYXNlICd0aWxlc2V0JzoKCQkJCWZpbGUuZGF0YSA9IG5ldyBJbWFnZSgpOwoJCQkJZmlsZS5kYXRhLm5hbWUgPSBmaWxlLmtleTsKCQkJCWZpbGUuZGF0YS5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIF90aGlzLmZpbGVDb21wbGV0ZShmaWxlLmtleSk7CgkJCQl9OwoJCQkJZmlsZS5kYXRhLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIF90aGlzLmZpbGVFcnJvcihmaWxlLmtleSk7CgkJCQl9OwoJCQkJZmlsZS5kYXRhLmNyb3NzT3JpZ2luID0gdGhpcy5jcm9zc09yaWdpbjsKCQkJCWZpbGUuZGF0YS5zcmMgPSB0aGlzLmJhc2VVUkwgKyBmaWxlLnVybDsKCQkJCWJyZWFrOwoKCQkJY2FzZSAnYXVkaW8nOgoJCQkJZmlsZS51cmwgPSB0aGlzLmdldEF1ZGlvVVJMKGZpbGUudXJsKTsKCgkJCQlpZiAoZmlsZS51cmwgIT09IG51bGwpCgkJCQl7CgkJCQkJLy8gIFdlYkF1ZGlvIG9yIEF1ZGlvIFRhZz8KCQkJCQlpZiAodGhpcy5nYW1lLnNvdW5kLnVzaW5nV2ViQXVkaW8pCgkJCQkJewoJCQkJCQl0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwoJCQkJCQl0aGlzLl94aHIucmVzcG9uc2VUeXBlID0gImFycmF5YnVmZmVyIjsKCQkJCQkJdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJCXJldHVybiBfdGhpcy5maWxlQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCQl9OwoJCQkJCQl0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJCXJldHVybiBfdGhpcy5maWxlRXJyb3IoZmlsZS5rZXkpOwoJCQkJCQl9OwoJCQkJCQl0aGlzLl94aHIuc2VuZCgpOwoJCQkJCX0KCQkJCQllbHNlIGlmICh0aGlzLmdhbWUuc291bmQudXNpbmdBdWRpb1RhZykKCQkJCQl7CgkJCQkJCWlmICh0aGlzLmdhbWUuc291bmQudG91Y2hMb2NrZWQpCgkJCQkJCXsKCQkJCQkJCS8vICBJZiBhdWRpbyBpcyBsb2NrZWQgd2UgY2FuJ3QgZG8gdGhpcyB5ZXQsIHNvIG5lZWQgdG8gcXVldWUgdGhpcyBsb2FkIHJlcXVlc3QuIEJ1bS4KCQkJCQkJCWZpbGUuZGF0YSA9IG5ldyBBdWRpbygpOwoJCQkJCQkJZmlsZS5kYXRhLm5hbWUgPSBmaWxlLmtleTsKCQkJCQkJCWZpbGUuZGF0YS5wcmVsb2FkID0gJ2F1dG8nOwoJCQkJCQkJZmlsZS5kYXRhLnNyYyA9IHRoaXMuYmFzZVVSTCArIGZpbGUudXJsOwoJCQkJCQkJdGhpcy5maWxlQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCQl9CgkJCQkJCWVsc2UKCQkJCQkJewoJCQkJCQkJZmlsZS5kYXRhID0gbmV3IEF1ZGlvKCk7CgkJCQkJCQlmaWxlLmRhdGEubmFtZSA9IGZpbGUua2V5OwoJCQkJCQkJZmlsZS5kYXRhLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCQkJcmV0dXJuIF90aGlzLmZpbGVFcnJvcihmaWxlLmtleSk7CgkJCQkJCQl9OwoJCQkJCQkJZmlsZS5kYXRhLnByZWxvYWQgPSAnYXV0byc7CgkJCQkJCQlmaWxlLmRhdGEuc3JjID0gdGhpcy5iYXNlVVJMICsgZmlsZS51cmw7CgkJCQkJCQlmaWxlLmRhdGEuYWRkRXZlbnRMaXN0ZW5lcignY2FucGxheXRocm91Z2gnLCBQaGFzZXIuR0FNRVNbdGhpcy5nYW1lLmlkXS5sb2FkLmZpbGVDb21wbGV0ZShmaWxlLmtleSksIGZhbHNlKTsKCQkJCQkJCWZpbGUuZGF0YS5sb2FkKCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJdGhpcy5maWxlRXJyb3IoZmlsZS5rZXkpOwoJCQkJfQoKCQkJCWJyZWFrOwoKCQkJY2FzZSAndGlsZW1hcCc6CgkJCQl0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwoJCQkJdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKCgkJCQlpZiAoZmlsZS5mb3JtYXQgPT0gUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTikKCQkJCXsKCQkJCQl0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCQlyZXR1cm4gX3RoaXMuanNvbkxvYWRDb21wbGV0ZShmaWxlLmtleSk7CgkJCQkJfTsKCQkJCX0KCQkJCWVsc2UgaWYgKGZpbGUuZm9ybWF0ID09IFBoYXNlci5UaWxlbWFwLkNTVikKCQkJCXsKCQkJCQl0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCQlyZXR1cm4gX3RoaXMuY3N2TG9hZENvbXBsZXRlKGZpbGUua2V5KTsKCQkJCQl9OwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRocm93IG5ldyBFcnJvcigiUGhhc2VyLkxvYWRlci4gSW52YWxpZCBUaWxlbWFwIGZvcm1hdDogIiArIGZpbGUuZm9ybWF0KTsKCQkJCX0KCgkJCQl0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKCQkJCQlyZXR1cm4gX3RoaXMuZGF0YUxvYWRFcnJvcihmaWxlLmtleSk7CgkJCQl9OwoJCQkJdGhpcy5feGhyLnNlbmQoKTsKCQkJCWJyZWFrOwoKCQkJY2FzZSAndGV4dCc6CgkJCQl0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS51cmwsIHRydWUpOwoJCQkJdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKCQkJCXRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIF90aGlzLmZpbGVDb21wbGV0ZShmaWxlLmtleSk7CgkJCQl9OwoJCQkJdGhpcy5feGhyLm9uZXJyb3IgPSBmdW5jdGlvbiAoKSB7CgkJCQkJcmV0dXJuIF90aGlzLmZpbGVFcnJvcihmaWxlLmtleSk7CgkJCQl9OwoJCQkJdGhpcy5feGhyLnNlbmQoKTsKCQkJCWJyZWFrOwoJCX0KCgl9LAoKCS8qKgoJKiBQcml2YXRlIG1ldGhvZCBPTkxZIHVzZWQgYnkgbG9hZGVyLgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjZ2V0QXVkaW9VUkwKCSogQHBhcmFtIHtEZXNjcmlwdGlvbn0gdXJscyAtIERlc2NyaXB0aW9uLgoJKiBAcHJpdmF0ZQoJKi8KCWdldEF1ZGlvVVJMOiBmdW5jdGlvbiAodXJscykgewoKCQl2YXIgZXh0ZW5zaW9uOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IHVybHMubGVuZ3RoOyBpKyspCgkJewoJCQlleHRlbnNpb24gPSB1cmxzW2ldLnRvTG93ZXJDYXNlKCk7CgkJCWV4dGVuc2lvbiA9IGV4dGVuc2lvbi5zdWJzdHIoKE1hdGgubWF4KDAsIGV4dGVuc2lvbi5sYXN0SW5kZXhPZigiLiIpKSB8fCBJbmZpbml0eSkgKyAxKTsKCgkJCWlmICh0aGlzLmdhbWUuZGV2aWNlLmNhblBsYXlBdWRpbyhleHRlbnNpb24pKQoJCQl7CgkJCQlyZXR1cm4gdXJsc1tpXTsKCQkJfQoKCQl9CgoJCXJldHVybiBudWxsOwoKCX0sCgoJLyoqCgkqIEVycm9yIG9jY3VyZWQgd2hlbiBsb2FkIGEgZmlsZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2ZpbGVFcnJvcgoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gS2V5IG9mIHRoZSBlcnJvciBsb2FkaW5nIGZpbGUuCgkqLwoJZmlsZUVycm9yOiBmdW5jdGlvbiAoa2V5KSB7CgoJCXRoaXMuX2ZpbGVMaXN0W2tleV0ubG9hZGVkID0gdHJ1ZTsKCQl0aGlzLl9maWxlTGlzdFtrZXldLmVycm9yID0gdHJ1ZTsKCgkJdGhpcy5vbkZpbGVFcnJvci5kaXNwYXRjaChrZXkpOwoKCQljb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXIgZXJyb3IgbG9hZGluZyBmaWxlOiAiICsga2V5ICsgJyBmcm9tIFVSTCAnICsgdGhpcy5fZmlsZUxpc3Rba2V5XS51cmwpOwoKCQl0aGlzLm5leHRGaWxlKGtleSwgZmFsc2UpOwoKCX0sCgoJLyoqCgkqIENhbGxlZCB3aGVuIGEgZmlsZSBpcyBzdWNjZXNzZnVsbHkgbG9hZGVkLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjZmlsZUNvbXBsZXRlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIHN1Y2Nlc3NmdWxseSBsb2FkZWQgZmlsZS4KCSovCglmaWxlQ29tcGxldGU6IGZ1bmN0aW9uIChrZXkpIHsKCgkJaWYgKCF0aGlzLl9maWxlTGlzdFtrZXldKQoJCXsKCQkJY29uc29sZS53YXJuKCdQaGFzZXIuTG9hZGVyIGZpbGVDb21wbGV0ZSBpbnZhbGlkIGtleSAnICsga2V5KTsKCQkJcmV0dXJuOwoJCX0KCQkKCQl0aGlzLl9maWxlTGlzdFtrZXldLmxvYWRlZCA9IHRydWU7CgoJCXZhciBmaWxlID0gdGhpcy5fZmlsZUxpc3Rba2V5XTsKCQl2YXIgbG9hZE5leHQgPSB0cnVlOwoJCXZhciBfdGhpcyA9IHRoaXM7CgoJCXN3aXRjaCAoZmlsZS50eXBlKQoJCXsKCQkJY2FzZSAnaW1hZ2UnOgoKCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRJbWFnZShmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSk7CgkJCQlicmVhazsKCgkJCWNhc2UgJ3Nwcml0ZXNoZWV0JzoKCgkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkU3ByaXRlU2hlZXQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZpbGUuZnJhbWVXaWR0aCwgZmlsZS5mcmFtZUhlaWdodCwgZmlsZS5mcmFtZU1heCk7CgkJCQlicmVhazsKCgkJCWNhc2UgJ3RpbGVzZXQnOgoKCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRUaWxlc2V0KGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLnRpbGVXaWR0aCwgZmlsZS50aWxlSGVpZ2h0LCBmaWxlLnRpbGVNYXgsIGZpbGUudGlsZU1hcmdpbiwgZmlsZS50aWxlU3BhY2luZyk7CgkJCQlicmVhazsKCgkJCWNhc2UgJ3RleHR1cmVhdGxhcyc6CgoJCQkJaWYgKGZpbGUuYXRsYXNVUkwgPT0gbnVsbCkKCQkJCXsKCQkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dHVyZUF0bGFzKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCBmaWxlLmF0bGFzRGF0YSwgZmlsZS5mb3JtYXQpOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCS8vICBMb2FkIHRoZSBKU09OIG9yIFhNTCBiZWZvcmUgY2Fycnlpbmcgb24gd2l0aCB0aGUgbmV4dCBmaWxlCgkJCQkJbG9hZE5leHQgPSBmYWxzZTsKCQkJCQl0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS5hdGxhc1VSTCwgdHJ1ZSk7CgkJCQkJdGhpcy5feGhyLnJlc3BvbnNlVHlwZSA9ICJ0ZXh0IjsKCgkJCQkJaWYgKGZpbGUuZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0FSUkFZIHx8IGZpbGUuZm9ybWF0ID09IFBoYXNlci5Mb2FkZXIuVEVYVFVSRV9BVExBU19KU09OX0hBU0gpCgkJCQkJewoJCQkJCQl0aGlzLl94aHIub25sb2FkID0gZnVuY3Rpb24gKCkgewoJCQkJCQkJcmV0dXJuIF90aGlzLmpzb25Mb2FkQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCQl9OwoJCQkJCX0KCQkJCQllbHNlIGlmIChmaWxlLmZvcm1hdCA9PSBQaGFzZXIuTG9hZGVyLlRFWFRVUkVfQVRMQVNfWE1MX1NUQVJMSU5HKQoJCQkJCXsKCQkJCQkJdGhpcy5feGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJCXJldHVybiBfdGhpcy54bWxMb2FkQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCQl9OwoJCQkJCX0KCQkJCQllbHNlCgkJCQkJewoJCQkJCQl0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgVGV4dHVyZSBBdGxhcyBmb3JtYXQ6ICIgKyBmaWxlLmZvcm1hdCk7CgkJCQkJfQoKCQkJCQl0aGlzLl94aHIub25lcnJvciA9IGZ1bmN0aW9uICgpIHsKCQkJCQkJcmV0dXJuIF90aGlzLmRhdGFMb2FkRXJyb3IoZmlsZS5rZXkpOwoJCQkJCX07CgkJCQkJdGhpcy5feGhyLnNlbmQoKTsKCQkJCX0KCQkJCWJyZWFrOwoKCQkJY2FzZSAnYml0bWFwZm9udCc6CgoJCQkJaWYgKGZpbGUueG1sVVJMID09IG51bGwpCgkJCQl7CgkJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZEJpdG1hcEZvbnQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGZpbGUueG1sRGF0YSk7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJLy8gIExvYWQgdGhlIFhNTCBiZWZvcmUgY2Fycnlpbmcgb24gd2l0aCB0aGUgbmV4dCBmaWxlCgkJCQkJbG9hZE5leHQgPSBmYWxzZTsKCQkJCQl0aGlzLl94aHIub3BlbigiR0VUIiwgdGhpcy5iYXNlVVJMICsgZmlsZS54bWxVUkwsIHRydWUpOwoJCQkJCXRoaXMuX3hoci5yZXNwb25zZVR5cGUgPSAidGV4dCI7CgoJCQkJCXRoaXMuX3hoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7CgkJCQkJCXJldHVybiBfdGhpcy54bWxMb2FkQ29tcGxldGUoZmlsZS5rZXkpOwoJCQkJCX07CgoJCQkJCXRoaXMuX3hoci5vbmVycm9yID0gZnVuY3Rpb24gKCkgewoJCQkJCQlyZXR1cm4gX3RoaXMuZGF0YUxvYWRFcnJvcihmaWxlLmtleSk7CgkJCQkJfTsKCQkJCQl0aGlzLl94aHIuc2VuZCgpOwoJCQkJfQoJCQkJYnJlYWs7CgoJCQljYXNlICdhdWRpbyc6CgoJCQkJaWYgKHRoaXMuZ2FtZS5zb3VuZC51c2luZ1dlYkF1ZGlvKQoJCQkJewoJCQkJCWZpbGUuZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZTsKCgkJCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFNvdW5kKGZpbGUua2V5LCBmaWxlLnVybCwgZmlsZS5kYXRhLCB0cnVlLCBmYWxzZSk7CgoJCQkJCWlmIChmaWxlLmF1dG9EZWNvZGUpCgkJCQkJewoJCQkJCQl0aGlzLmdhbWUuY2FjaGUudXBkYXRlU291bmQoa2V5LCAnaXNEZWNvZGluZycsIHRydWUpOwoKCQkJCQkJdmFyIHRoYXQgPSB0aGlzOwoJCQkJCQl2YXIga2V5ID0gZmlsZS5rZXk7CgoJCQkJCQl0aGlzLmdhbWUuc291bmQuY29udGV4dC5kZWNvZGVBdWRpb0RhdGEoZmlsZS5kYXRhLCBmdW5jdGlvbiAoYnVmZmVyKSB7CgkJCQkJCQlpZiAoYnVmZmVyKQoJCQkJCQkJewoJCQkJCQkJCXRoYXQuZ2FtZS5jYWNoZS5kZWNvZGVkU291bmQoa2V5LCBidWZmZXIpOwoJCQkJCQkJfQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJZmlsZS5kYXRhLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NhbnBsYXl0aHJvdWdoJywgUGhhc2VyLkdBTUVTW3RoaXMuZ2FtZS5pZF0ubG9hZC5maWxlQ29tcGxldGUpOwoJCQkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRTb3VuZChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSwgZmFsc2UsIHRydWUpOwoJCQkJfQoJCQkJYnJlYWs7CgoJCQljYXNlICd0ZXh0JzoKCQkJCWZpbGUuZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZVRleHQ7CgkJCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGV4dChmaWxlLmtleSwgZmlsZS51cmwsIGZpbGUuZGF0YSk7CgkJCQlicmVhazsKCQl9CgoJCWlmIChsb2FkTmV4dCkKCQl7CgkJCXRoaXMubmV4dEZpbGUoa2V5LCB0cnVlKTsKCQl9CgoJfSwKCgkvKioKCSogU3VjY2Vzc2Z1bGx5IGxvYWRlZCBhIEpTT04gZmlsZS4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2pzb25Mb2FkQ29tcGxldGUKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgbG9hZGVkIEpTT04gZmlsZS4KCSovCglqc29uTG9hZENvbXBsZXRlOiBmdW5jdGlvbiAoa2V5KSB7CgoJCXZhciBkYXRhID0gSlNPTi5wYXJzZSh0aGlzLl94aHIucmVzcG9uc2VUZXh0KTsKCQl2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2tleV07CgoJCWlmIChmaWxlLnR5cGUgPT0gJ3RpbGVtYXAnKQoJCXsKCQkJdGhpcy5nYW1lLmNhY2hlLmFkZFRpbGVtYXAoZmlsZS5rZXksIGZpbGUudXJsLCBkYXRhLCBmaWxlLmZvcm1hdCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRUZXh0dXJlQXRsYXMoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIGRhdGEsIGZpbGUuZm9ybWF0KTsKCQl9CgoJCXRoaXMubmV4dEZpbGUoa2V5LCB0cnVlKTsKCgl9LAoKCS8qKgoJKiBTdWNjZXNzZnVsbHkgbG9hZGVkIGEgQ1NWIGZpbGUuCgkqCgkqIEBtZXRob2QgUGhhc2VyLkxvYWRlciNjc3ZMb2FkQ29tcGxldGUKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgbG9hZGVkIENTViBmaWxlLgoJKi8KCWNzdkxvYWRDb21wbGV0ZTogZnVuY3Rpb24gKGtleSkgewoKCQl2YXIgZGF0YSA9IHRoaXMuX3hoci5yZXNwb25zZVRleHQ7CgkJdmFyIGZpbGUgPSB0aGlzLl9maWxlTGlzdFtrZXldOwoKCQl0aGlzLmdhbWUuY2FjaGUuYWRkVGlsZW1hcChmaWxlLmtleSwgZmlsZS51cmwsIGRhdGEsIGZpbGUuZm9ybWF0KTsKCgkJdGhpcy5uZXh0RmlsZShrZXksIHRydWUpOwoKCX0sCgoJLyoqCgkqIEVycm9yIG9jY3VyZWQgd2hlbiBsb2FkIGEgSlNPTi4KCSoKCSogQG1ldGhvZCBQaGFzZXIuTG9hZGVyI2RhdGFMb2FkRXJyb3IKCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEtleSBvZiB0aGUgZXJyb3IgbG9hZGluZyBKU09OIGZpbGUuCgkqLwoJZGF0YUxvYWRFcnJvcjogZnVuY3Rpb24gKGtleSkgewoKCQl2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2tleV07CgoJCWZpbGUuZXJyb3IgPSB0cnVlOwoKCQljb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXIgZGF0YUxvYWRFcnJvcjogIiArIGtleSk7CgoJCXRoaXMubmV4dEZpbGUoa2V5LCB0cnVlKTsKCgl9LAoKCS8qKgoJKiBTdWNjZXNzZnVsbHkgbG9hZGVkIGFuIFhNTCBmaWxlLgoJKgoJKiBAbWV0aG9kIFBoYXNlci5Mb2FkZXIjeG1sTG9hZENvbXBsZXRlCgkqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBLZXkgb2YgdGhlIGxvYWRlZCBYTUwgZmlsZS4KCSovCgl4bWxMb2FkQ29tcGxldGU6IGZ1bmN0aW9uIChrZXkpIHsKCgkJdmFyIGRhdGEgPSB0aGlzLl94aHIucmVzcG9uc2VUZXh0OwoJCXZhciB4bWw7CgoJCXRyeQoJCXsKCQkJaWYgKHdpbmRvd1snRE9NUGFyc2VyJ10pCgkJCXsKCQkJCXZhciBkb21wYXJzZXIgPSBuZXcgRE9NUGFyc2VyKCk7CgkJCQl4bWwgPSBkb21wYXJzZXIucGFyc2VGcm9tU3RyaW5nKGRhdGEsICJ0ZXh0L3htbCIpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJeG1sID0gbmV3IEFjdGl2ZVhPYmplY3QoIk1pY3Jvc29mdC5YTUxET00iKTsKCQkJCXhtbC5hc3luYyA9ICdmYWxzZSc7CgkJCQl4bWwubG9hZFhNTChkYXRhKTsKCQkJfQoJCX0KCQljYXRjaCAoZSkKCQl7CgkJCXhtbCA9IHVuZGVmaW5lZDsKCQl9CgoJCWlmICgheG1sIHx8ICF4bWwuZG9jdW1lbnRFbGVtZW50IHx8IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgicGFyc2VyZXJyb3IiKS5sZW5ndGgpCgkJewoJCQl0aHJvdyBuZXcgRXJyb3IoIlBoYXNlci5Mb2FkZXIuIEludmFsaWQgWE1MIGdpdmVuIik7CgkJfQoKCQl2YXIgZmlsZSA9IHRoaXMuX2ZpbGVMaXN0W2tleV07CgoJCWlmIChmaWxlLnR5cGUgPT0gJ2JpdG1hcGZvbnQnKQoJCXsKCQkJdGhpcy5nYW1lLmNhY2hlLmFkZEJpdG1hcEZvbnQoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIHhtbCk7CgkJfQoJCWVsc2UgaWYgKGZpbGUudHlwZSA9PSAndGV4dHVyZWF0bGFzJykKCQl7CgkJCXRoaXMuZ2FtZS5jYWNoZS5hZGRUZXh0dXJlQXRsYXMoZmlsZS5rZXksIGZpbGUudXJsLCBmaWxlLmRhdGEsIHhtbCwgZmlsZS5mb3JtYXQpOwoJCX0KCgkJdGhpcy5uZXh0RmlsZShrZXksIHRydWUpOwoKCX0sCgoJLyoqCgkqIEhhbmRsZSBsb2FkaW5nIG5leHQgZmlsZS4KCSoKCSogQHBhcmFtIHByZXZpb3VzS2V5IHtzdHJpbmd9IEtleSBvZiBwcmV2aW91cyBsb2FkZWQgYXNzZXQuCgkqIEBwYXJhbSBzdWNjZXNzIHtib29sZWFufSBXaGV0aGVyIHRoZSBwcmV2aW91cyBhc3NldCBsb2FkZWQgc3VjY2Vzc2Z1bGx5IG9yIG5vdC4KCSogQHByaXZhdGUKCSovCgluZXh0RmlsZTogZnVuY3Rpb24gKHByZXZpb3VzS2V5LCBzdWNjZXNzKSB7CgoJCXRoaXMucHJvZ3Jlc3MgPSBNYXRoLnJvdW5kKHRoaXMucHJvZ3Jlc3MgKyB0aGlzLl9wcm9ncmVzc0NodW5rKTsKCgkJaWYgKHRoaXMucHJvZ3Jlc3MgPiAxMDApCgkJewoJCQl0aGlzLnByb2dyZXNzID0gMTAwOwoJCX0KCgkJaWYgKHRoaXMucHJlbG9hZFNwcml0ZSAhPT0gbnVsbCkKCQl7CgkJCWlmICh0aGlzLnByZWxvYWRTcHJpdGUuZGlyZWN0aW9uID09IDApCgkJCXsKCQkJCXRoaXMucHJlbG9hZFNwcml0ZS5jcm9wLndpZHRoID0gTWF0aC5mbG9vcigodGhpcy5wcmVsb2FkU3ByaXRlLndpZHRoIC8gMTAwKSAqIHRoaXMucHJvZ3Jlc3MpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3AuaGVpZ2h0ID0gTWF0aC5mbG9vcigodGhpcy5wcmVsb2FkU3ByaXRlLmhlaWdodCAvIDEwMCkgKiB0aGlzLnByb2dyZXNzKTsKCQkJfQoKCQkJdGhpcy5wcmVsb2FkU3ByaXRlLnNwcml0ZS5jcm9wID0gdGhpcy5wcmVsb2FkU3ByaXRlLmNyb3A7CgkJfQoKCQl0aGlzLm9uRmlsZUNvbXBsZXRlLmRpc3BhdGNoKHRoaXMucHJvZ3Jlc3MsIHByZXZpb3VzS2V5LCBzdWNjZXNzLCB0aGlzLnF1ZXVlU2l6ZSAtIHRoaXMuX2tleXMubGVuZ3RoLCB0aGlzLnF1ZXVlU2l6ZSk7CgoJCWlmICh0aGlzLl9rZXlzLmxlbmd0aCA+IDApCgkJewoJCQl0aGlzLmxvYWRGaWxlKCk7CgkJfQoJCWVsc2UKCQl7CgkJCXRoaXMuaGFzTG9hZGVkID0gdHJ1ZTsKCQkJdGhpcy5pc0xvYWRpbmcgPSBmYWxzZTsKCQkJCgkJCXRoaXMucmVtb3ZlQWxsKCk7CgoJCQl0aGlzLm9uTG9hZENvbXBsZXRlLmRpc3BhdGNoKCk7CgkJfQoKCX0KCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuTG9hZGVyUGFyc2VyIHBhcnNlcyBkYXRhIG9iamVjdHMgZnJvbSBQaGFzZXIuTG9hZGVyIHRoYXQgbmVlZCBtb3JlIHByZXBhcmF0aW9uIGJlZm9yZSB0aGV5IGNhbiBiZSBpbnNlcnRlZCBpbnRvIHRoZSBDYWNoZS4KKgoqIEBjbGFzcyBQaGFzZXIuTG9hZGVyUGFyc2VyCiovClBoYXNlci5Mb2FkZXJQYXJzZXIgPSB7CgkKICAgIC8qKgogICAgKiBQYXJzZSBmcmFtZSBkYXRhIGZyb20gYW4gWE1MIGZpbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLkxvYWRlclBhcnNlci5iaXRtYXBGb250CiAgICAqIEBwYXJhbSB7b2JqZWN0fSB4bWwgLSBYTUwgZGF0YSB5b3Ugd2FudCB0byBwYXJzZS4KICAgICogQHJldHVybiB7RnJhbWVEYXRhfSBHZW5lcmF0ZWQgRnJhbWVEYXRhIG9iamVjdC4KICAgICovCgliaXRtYXBGb250OiBmdW5jdGlvbiAoZ2FtZSwgeG1sLCBjYWNoZUtleSkgewoKICAgICAgICAvLyAgTWFsZm9ybWVkPwogICAgICAgIGlmICgheG1sLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdmb250JykpCiAgICAgICAgewogICAgICAgICAgICBjb25zb2xlLndhcm4oIlBoYXNlci5Mb2FkZXJQYXJzZXIuYml0bWFwRm9udDogSW52YWxpZCBYTUwgZ2l2ZW4sIG1pc3NpbmcgPGZvbnQ+IHRhZyIpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB2YXIgdGV4dHVyZSA9IFBJWEkuVGV4dHVyZUNhY2hlW2NhY2hlS2V5XTsKCiAgICAgICAgdmFyIGRhdGEgPSB7fTsKICAgICAgICB2YXIgaW5mbyA9IHhtbC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiaW5mbyIpWzBdOwogICAgICAgIHZhciBjb21tb24gPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNvbW1vbiIpWzBdOwogICAgICAgIGRhdGEuZm9udCA9IGluZm8uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oImZhY2UiKS5ub2RlVmFsdWU7CiAgICAgICAgZGF0YS5zaXplID0gcGFyc2VJbnQoaW5mby5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgic2l6ZSIpLm5vZGVWYWx1ZSwgMTApOwogICAgICAgIGRhdGEubGluZUhlaWdodCA9IHBhcnNlSW50KGNvbW1vbi5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgibGluZUhlaWdodCIpLm5vZGVWYWx1ZSwgMTApOwogICAgICAgIGRhdGEuY2hhcnMgPSB7fTsKCiAgICAgICAgLy9wYXJzZSBsZXR0ZXJzCiAgICAgICAgdmFyIGxldHRlcnMgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImNoYXIiKTsKCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZXR0ZXJzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGNoYXJDb2RlID0gcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiaWQiKS5ub2RlVmFsdWUsIDEwKTsKCiAgICAgICAgICAgIHZhciB0ZXh0dXJlUmVjdCA9IHsKICAgICAgICAgICAgICAgIHg6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oIngiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHk6IHBhcnNlSW50KGxldHRlcnNbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInkiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIHdpZHRoOiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ3aWR0aCIpLm5vZGVWYWx1ZSwgMTApLAogICAgICAgICAgICAgICAgaGVpZ2h0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJoZWlnaHQiKS5ub2RlVmFsdWUsIDEwKQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8JTm90ZTogVGhpcyBtZWFucyB5b3UgY2FuIG9ubHkgaGF2ZSAxIEJpdG1hcEZvbnQgbG9hZGVkIGF0IG9uY2UhCiAgICAgICAgICAgIC8vCU5lZWQgdG8gcmVwbGFjZSB0aGlzIHdpdGggb3VyIG93biBoYW5kbGVyIHNvb24uCiAgICAgICAgICAgIFBJWEkuVGV4dHVyZUNhY2hlW2NoYXJDb2RlXSA9IG5ldyBQSVhJLlRleHR1cmUodGV4dHVyZSwgdGV4dHVyZVJlY3QpOwoKICAgICAgICAgICAgZGF0YS5jaGFyc1tjaGFyQ29kZV0gPSB7CiAgICAgICAgICAgICAgICB4T2Zmc2V0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ4b2Zmc2V0Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB5T2Zmc2V0OiBwYXJzZUludChsZXR0ZXJzW2ldLmF0dHJpYnV0ZXMuZ2V0TmFtZWRJdGVtKCJ5b2Zmc2V0Iikubm9kZVZhbHVlLCAxMCksCiAgICAgICAgICAgICAgICB4QWR2YW5jZTogcGFyc2VJbnQobGV0dGVyc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgieGFkdmFuY2UiKS5ub2RlVmFsdWUsIDEwKSwKICAgICAgICAgICAgICAgIGtlcm5pbmc6IHt9LAogICAgICAgICAgICAgICAgdGV4dHVyZTpuZXcgUElYSS5UZXh0dXJlKHRleHR1cmUsIHRleHR1cmVSZWN0KQoKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIC8vcGFyc2Uga2VybmluZ3MKICAgICAgICB2YXIga2VybmluZ3MgPSB4bWwuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImtlcm5pbmciKTsKCiAgICAgICAgZm9yIChpID0gMDsgaSA8IGtlcm5pbmdzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICB2YXIgZmlyc3QgPSBwYXJzZUludChrZXJuaW5nc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiZmlyc3QiKS5ub2RlVmFsdWUsIDEwKTsKICAgICAgICAgICB2YXIgc2Vjb25kID0gcGFyc2VJbnQoa2VybmluZ3NbaV0uYXR0cmlidXRlcy5nZXROYW1lZEl0ZW0oInNlY29uZCIpLm5vZGVWYWx1ZSwgMTApOwogICAgICAgICAgIHZhciBhbW91bnQgPSBwYXJzZUludChrZXJuaW5nc1tpXS5hdHRyaWJ1dGVzLmdldE5hbWVkSXRlbSgiYW1vdW50Iikubm9kZVZhbHVlLCAxMCk7CgogICAgICAgICAgICBkYXRhLmNoYXJzW3NlY29uZF0ua2VybmluZ1tmaXJzdF0gPSBhbW91bnQ7CiAgICAgICAgfQoKICAgICAgICBQSVhJLkJpdG1hcFRleHQuZm9udHNbZGF0YS5mb250XSA9IGRhdGE7CgogICAgfQoKfTsKLyoqCiogQGF1dGhvciAgICAgICBSaWNoYXJkIERhdmV5IDxyaWNoQHBob3RvbnN0b3JtLmNvbT4KKiBAY29weXJpZ2h0ICAgIDIwMTMgUGhvdG9uIFN0b3JtIEx0ZC4KKiBAbGljZW5zZSAgICAgIHtAbGluayBodHRwczovL2dpdGh1Yi5jb20vcGhvdG9uc3Rvcm0vcGhhc2VyL2Jsb2IvbWFzdGVyL2xpY2Vuc2UudHh0fE1JVCBMaWNlbnNlfQoqLwoKLyoqCiogVGhlIFNvdW5kIGNsYXNzIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5Tb3VuZAoqIEBjbGFzc2Rlc2MgVGhlIFNvdW5kIGNsYXNzCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIFJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KKiBAcGFyYW0ge251bWJlcn0gW3ZvbHVtZT0xXSAtIERlZmF1bHQgdmFsdWUgZm9yIHRoZSB2b2x1bWUsIGJldHdlZW4gMCBhbmQgMS4KKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiovClBoYXNlci5Tb3VuZCA9IGZ1bmN0aW9uIChnYW1lLCBrZXksIHZvbHVtZSwgbG9vcCkgewoJCgl2b2x1bWUgPSB2b2x1bWUgfHwgMTsKCWlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KCiAgICAvKioKICAgICogQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLkdhbWV9IGdhbWUKICAgICovCiAgICB0aGlzLmdhbWUgPSBnYW1lOwoKICAgIC8qKgogICAgKiBOYW1lIG9mIHRoZSBzb3VuZC4KICAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm5hbWUgPSBrZXk7CgogICAgLyoqCiAgICAqIEFzc2V0IGtleSBmb3IgdGhlIHNvdW5kLgogICAgKiBAcHJvcGVydHkge3N0cmluZ30ga2V5CiAgICAqLwogICAgdGhpcy5rZXkgPSBrZXk7CgogICAgLyoqCiAgICAqIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbG9vcAogICAgKi8KICAgIHRoaXMubG9vcCA9IGxvb3A7CgogICAgLyoqCiAgICAqIFRoZSBnbG9iYWwgYXVkaW8gdm9sdW1lLiBBIHZhbHVlIGJldHdlZW4gMCAoc2lsZW5jZSkgYW5kIDEgKGZ1bGwgdm9sdW1lKS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF92b2x1bWUKICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl92b2x1bWUgPSB2b2x1bWU7CgogICAgLyoqCiAgICAqIFRoZSBzb3VuZCBtYXJrZXJzLCBlbXB0eSBieSBkZWZhdWx0LgogICAgKiBAcHJvcGVydHkge29iamVjdH0gbWFya2VycwogICAgKi8KICAgIHRoaXMubWFya2VycyA9IHt9OwoKICAgIAogICAgLyoqCiAgICAqIFJlZmVyZW5jZSB0byBBdWRpb0NvbnRleHQgaW5zdGFuY2UuCiAgICAqIEBwcm9wZXJ0eSB7QXVkaW9Db250ZXh0fSBjb250ZXh0CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKCiAgICAvKioKICAgICogRGVjb2RlZCBkYXRhIGJ1ZmZlciAvIEF1ZGlvIHRhZy4KICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gX2J1ZmZlcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2J1ZmZlciA9IG51bGw7CgogICAgLyoqCiAgICAqIEJvb2xlYW4gaW5kaWNhdGluZyB3aGV0aGVyIHRoZSBnYW1lIGlzIG9uICJtdXRlIi4gCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX211dGVkCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5fbXV0ZWQgPSBmYWxzZTsKCiAgICAvKioKICAgICogQm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHNvdW5kIHNob3VsZCBzdGFydCBhdXRvbWF0aWNhbGx5LgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGF1dG9wbGF5CiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5hdXRvcGxheSA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBUaGUgdG90YWwgZHVyYXRpb24gb2YgdGhlIHNvdW5kLCBpbiBtaWxsaXNlY29uZHMKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHRvdGFsRHVyYXRpb24KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnRvdGFsRHVyYXRpb24gPSAwOwogICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHN0YXJ0VGltZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuc3RhcnRUaW1lID0gMDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFRpbWUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gZHVyYXRpb24KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmR1cmF0aW9uID0gMDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc3RvcFRpbWUKICAgICovCiAgICB0aGlzLnN0b3BUaW1lID0gMDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBhdXNlZAogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGF1c2VkID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHBhdXNlZFBvc2l0aW9uCiAgICAqLwogICAgdGhpcy5wYXVzZWRQb3NpdGlvbiA9IDA7CgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gcGF1c2VkVGltZQogICAgKi8KICAgIHRoaXMucGF1c2VkVGltZSA9IDA7CgogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGlzUGxheWluZwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGN1cnJlbnRNYXJrZXIKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmN1cnJlbnRNYXJrZXIgPSAnJzsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHBlbmRpbmdQbGF5YmFjawogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gZmFsc2U7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtib29sZWFufSBvdmVycmlkZQogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMub3ZlcnJpZGUgPSBmYWxzZTsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nV2ViQXVkaW8KICAgICovCiAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSB0aGlzLmdhbWUuc291bmQudXNpbmdXZWJBdWRpbzsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB1c2luZ0F1ZGlvVGFnCiAgICAqLwogICAgdGhpcy51c2luZ0F1ZGlvVGFnID0gdGhpcy5nYW1lLnNvdW5kLnVzaW5nQXVkaW9UYWc7CgogICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgIHsKICAgICAgICB0aGlzLmNvbnRleHQgPSB0aGlzLmdhbWUuc291bmQuY29udGV4dDsKICAgICAgICB0aGlzLm1hc3RlckdhaW5Ob2RlID0gdGhpcy5nYW1lLnNvdW5kLm1hc3RlckdhaW47CgogICAgICAgIGlmICh0eXBlb2YgdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4gPT09ICd1bmRlZmluZWQnKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYWluTm9kZSA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluTm9kZSgpOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmdhaW5Ob2RlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4oKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZvbHVtZSAqIHRoaXMuZ2FtZS5zb3VuZC52b2x1bWU7CiAgICAgICAgdGhpcy5nYWluTm9kZS5jb25uZWN0KHRoaXMubWFzdGVyR2Fpbk5vZGUpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQoa2V5KSAmJiB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KGtleSkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEoa2V5KTsKICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gMDsKCiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZC5kdXJhdGlvbikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmNhY2hlLm9uU291bmRVbmxvY2suYWRkKHRoaXMuc291bmRIYXNVbmxvY2tlZCwgdGhpcyk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbkRlY29kZWQKICAgICovCiAgICB0aGlzLm9uRGVjb2RlZCA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25QbGF5CiAgICAqLwogICAgdGhpcy5vblBsYXkgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUGF1c2UKICAgICovCiAgICB0aGlzLm9uUGF1c2UgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uUmVzdW1lCiAgICAqLwogICAgdGhpcy5vblJlc3VtZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Mb29wCiAgICAqLwogICAgdGhpcy5vbkxvb3AgPSBuZXcgUGhhc2VyLlNpZ25hbDsKICAgIAogICAgLyoqCiAgICAqIERlc2NyaXB0aW9uLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5TaWduYWx9IG9uU3RvcAogICAgKi8KICAgIHRoaXMub25TdG9wID0gbmV3IFBoYXNlci5TaWduYWw7CiAgICAKICAgIC8qKgogICAgKiBEZXNjcmlwdGlvbi4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuU2lnbmFsfSBvbk11dGUKICAgICovCiAgICB0aGlzLm9uTXV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwogICAgCiAgICAvKioKICAgICogRGVzY3JpcHRpb24uCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25NYXJrZXJDb21wbGV0ZQogICAgKi8KICAgIHRoaXMub25NYXJrZXJDb21wbGV0ZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoKfTsKClBoYXNlci5Tb3VuZC5wcm90b3R5cGUgPSB7CgoJLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IHdoZW4gdGhpcyBzb3VuZCBpcyB1bmxvY2tlZC4KCSogQG1ldGhvZCBQaGFzZXIuU291bmQjc291bmRIYXNVbmxvY2tlZAoJKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gRGVzY3JpcHRpb24uCiAgICAqIEBwcm90ZWN0ZWQKCSovCiAgICBzb3VuZEhhc1VubG9ja2VkOiBmdW5jdGlvbiAoa2V5KSB7CgogICAgICAgIGlmIChrZXkgPT0gdGhpcy5rZXkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEodGhpcy5rZXkpOwogICAgICAgICAgICB0aGlzLnRvdGFsRHVyYXRpb24gPSB0aGlzLl9zb3VuZC5kdXJhdGlvbjsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NvdW5kIGhhcyB1bmxvY2tlZCcgKyB0aGlzLl9zb3VuZCk7CgkgICAgfQoKCX0sCgoJLyoqCgkgKiBEZXNjcmlwdGlvbi4KCSAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI2FkZE1hcmtlcgoJICogQHBhcmFtIHtzdHJpbmd9IG5hbWUgLSBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7RGVzY3JpcHRpb259IHN0YXJ0IC0gRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSBzdG9wIC0gRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge0Rlc2NyaXB0aW9ufSB2b2x1bWUgLSBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7RGVzY3JpcHRpb259IGxvb3AgLSBEZXNjcmlwdGlvbi4KICAgIGFkZE1hcmtlcjogZnVuY3Rpb24gKG5hbWUsIHN0YXJ0LCBzdG9wLCB2b2x1bWUsIGxvb3ApIHsKCiAgICAJdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAJaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB0aGlzLm1hcmtlcnNbbmFtZV0gPSB7CiAgICAgICAgICAgIG5hbWU6IG5hbWUsCiAgICAgICAgICAgIHN0YXJ0OiBzdGFydCwKICAgICAgICAgICAgc3RvcDogc3RvcCwKICAgICAgICAgICAgdm9sdW1lOiB2b2x1bWUsCiAgICAgICAgICAgIGR1cmF0aW9uOiBzdG9wIC0gc3RhcnQsCiAgICAgICAgICAgIGxvb3A6IGxvb3AKICAgICAgICB9OwoKICAgIH0sCiAgICAqLwoKICAgIC8qKgogICAgKiBBZGRzIGEgbWFya2VyIGludG8gdGhlIGN1cnJlbnQgU291bmQuIEEgbWFya2VyIGlzIHJlcHJlc2VudGVkIGJ5IGEgdW5pcXVlIGtleSBhbmQgYSBzdGFydCB0aW1lIGFuZCBkdXJhdGlvbi4KICAgICogVGhpcyBhbGxvd3MgeW91IHRvIGJ1bmRsZSBtdWx0aXBsZSBzb3VuZHMgdG9nZXRoZXIgaW50byBhIHNpbmdsZSBhdWRpbyBmaWxlIGFuZCB1c2UgbWFya2VycyB0byBqdW1wIGJldHdlZW4gdGhlbSBmb3IgcGxheWJhY2suCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI2FkZE1hcmtlcgogICAgKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIEEgdW5pcXVlIG5hbWUgZm9yIHRoaXMgbWFya2VyLCBpLmUuICdleHBsb3Npb24nLCAnZ3Vuc2hvdCcsIGV0Yy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IC0gVGhlIHN0YXJ0IHBvaW50IG9mIHRoaXMgbWFya2VyIGluIHRoZSBhdWRpbyBmaWxlLCBnaXZlbiBpbiBzZWNvbmRzLiAyLjUgPSAyNTAwbXMsIDAuNSA9IDUwMG1zLCBldGMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBkdXJhdGlvbiAtIFRoZSBkdXJhdGlvbiBvZiB0aGUgbWFya2VyIGluIHNlY29uZHMuIDIuNSA9IDI1MDBtcywgMC41ID0gNTAwbXMsIGV0Yy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBUaGUgdm9sdW1lIHRoZSBzb3VuZCB3aWxsIHBsYXkgYmFjayBhdCwgYmV0d2VlbiAwIChzaWxlbnQpIGFuZCAxIChmdWxsIHZvbHVtZSkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gU2V0cyBpZiB0aGUgc291bmQgd2lsbCBsb29wIG9yIG5vdC4KICAgICovCiAgICBhZGRNYXJrZXI6IGZ1bmN0aW9uIChuYW1lLCBzdGFydCwgZHVyYXRpb24sIHZvbHVtZSwgbG9vcCkgewoKICAgICAgICB2b2x1bWUgPSB2b2x1bWUgfHwgMTsKICAgICAgICBpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMubWFya2Vyc1tuYW1lXSA9IHsKICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0LAogICAgICAgICAgICBzdG9wOiBzdGFydCArIGR1cmF0aW9uLAogICAgICAgICAgICB2b2x1bWU6IHZvbHVtZSwKICAgICAgICAgICAgZHVyYXRpb246IGR1cmF0aW9uLAogICAgICAgICAgICBkdXJhdGlvbk1TOiBkdXJhdGlvbiAqIDEwMDAsCiAgICAgICAgICAgIGxvb3A6IGxvb3AKICAgICAgICB9OwoKICAgIH0sCgoJLyoqCgkqIFJlbW92ZXMgYSBtYXJrZXIgZnJvbSB0aGUgc291bmQuCgkqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3JlbW92ZU1hcmtlcgoJKiBAcGFyYW0ge3N0cmluZ30gbmFtZSAtIFRoZSBrZXkgb2YgdGhlIG1hcmtlciB0byByZW1vdmUuCgkqLwogICAgcmVtb3ZlTWFya2VyOiBmdW5jdGlvbiAobmFtZSkgewoKICAgICAgICBkZWxldGUgdGhpcy5tYXJrZXJzW25hbWVdOwoKICAgIH0sCgoJLyoqCgkqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IFBoYXNlci5Tb3VuZE1hbmFnZXIuCgkqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3VwZGF0ZQogICAgKiBAcHJvdGVjdGVkCgkqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnBlbmRpbmdQbGF5YmFjayAmJiB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KHRoaXMua2V5KSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMucGVuZGluZ1BsYXliYWNrID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLl90ZW1wTWFya2VyLCB0aGlzLl90ZW1wUG9zaXRpb24sIHRoaXMuX3RlbXBWb2x1bWUsIHRoaXMuX3RlbXBMb29wKTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3cgLSB0aGlzLnN0YXJ0VGltZTsKCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRUaW1lID49IHRoaXMuZHVyYXRpb25NUykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLmN1cnJlbnRNYXJrZXIsICdoYXMgaGl0IGR1cmF0aW9uJyk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmxvb3ApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdsb29wMScpOwogICAgICAgICAgICAgICAgICAgICAgICAvLyAgd29uJ3Qgd29yayB3aXRoIG1hcmtlcnMsIG5lZWRzIHRvIHJlc2V0IHRoZSBwb3NpdGlvbgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uTG9vcC5kaXNwYXRjaCh0aGlzKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRNYXJrZXIgPT0gJycpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2xvb3AyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnbG9vcDMnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLmN1cnJlbnRNYXJrZXIsIDAsIHRoaXMudm9sdW1lLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdzdG9wcGluZywgbm8gbG9vcCBmb3IgbWFya2VyJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5sb29wKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkxvb3AuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGxheSh0aGlzLmN1cnJlbnRNYXJrZXIsIDAsIHRoaXMudm9sdW1lLCB0cnVlLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwKCgkvKioKICAgICogUGxheSB0aGlzIHNvdW5kLCBvciBhIG1hcmtlZCBzZWN0aW9uIG9mIGl0LgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNwbGF5CiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbbWFya2VyPScnXSAtIElmIHlvdSB3YW50IHRvIHBsYXkgYSBtYXJrZXIgdGhlbiBnaXZlIHRoZSBrZXkgaGVyZSwgb3RoZXJ3aXNlIGxlYXZlIGJsYW5rIHRvIHBsYXkgdGhlIGZ1bGwgc291bmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbcG9zaXRpb249MF0gLSBUaGUgc3RhcnRpbmcgcG9zaXRpb24gdG8gcGxheSB0aGUgc291bmQgZnJvbSAtIHRoaXMgaXMgaWdub3JlZCBpZiB5b3UgcHJvdmlkZSBhIG1hcmtlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBWb2x1bWUgb2YgdGhlIHNvdW5kIHlvdSB3YW50IHRvIHBsYXkuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2xvb3A9ZmFsc2VdIC0gTG9vcCB3aGVuIGl0IGZpbmlzaGVkIHBsYXlpbmc/CiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZvcmNlUmVzdGFydD10cnVlXSAtIElmIHRoZSBzb3VuZCBpcyBhbHJlYWR5IHBsYXlpbmcgeW91IGNhbiBzZXQgZm9yY2VSZXN0YXJ0IHRvIHJlc3RhcnQgaXQgZnJvbSB0aGUgYmVnaW5uaW5nLgogICAgKiBAcmV0dXJuIHtTb3VuZH0gVGhlIHBsYXlpbmcgc291bmQgb2JqZWN0LgogICAgKi8KICAgIHBsYXk6IGZ1bmN0aW9uIChtYXJrZXIsIHBvc2l0aW9uLCB2b2x1bWUsIGxvb3AsIGZvcmNlUmVzdGFydCkgewoKICAgIAltYXJrZXIgPSBtYXJrZXIgfHwgJyc7CiAgICAJcG9zaXRpb24gPSBwb3NpdGlvbiB8fCAwOwogICAgCXZvbHVtZSA9IHZvbHVtZSB8fCAxOwogICAgCWlmICh0eXBlb2YgbG9vcCA9PSAndW5kZWZpbmVkJykgeyBsb29wID0gZmFsc2U7IH0KICAgIAlpZiAodHlwZW9mIGZvcmNlUmVzdGFydCA9PSAndW5kZWZpbmVkJykgeyBmb3JjZVJlc3RhcnQgPSB0cnVlOyB9CgogICAgICAgIC8vIGNvbnNvbGUubG9nKHRoaXMubmFtZSArICcgcGxheSAnICsgbWFya2VyICsgJyBwb3NpdGlvbiAnICsgcG9zaXRpb24gKyAnIHZvbHVtZSAnICsgdm9sdW1lICsgJyBsb29wICcgKyBsb29wLCAnZm9yY2UnLCBmb3JjZVJlc3RhcnQpOwoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgPT0gdHJ1ZSAmJiBmb3JjZVJlc3RhcnQgPT0gZmFsc2UgJiYgdGhpcy5vdmVycmlkZSA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBVc2UgUmVzdGFydCBpbnN0ZWFkCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmlzUGxheWluZyAmJiB0aGlzLm92ZXJyaWRlKQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Fza2VkIHRvIHBsYXkgJyArIG1hcmtlciArICcgYnV0IGFscmVhZHkgcGxheWluZyAnICsgdGhpcy5jdXJyZW50TWFya2VyKTsKICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdG9wID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5ub3RlT2ZmKDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnN0b3AoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSBpZiAodGhpcy51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wYXVzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLmN1cnJlbnRNYXJrZXIgPSBtYXJrZXI7CgogICAgICAgIGlmIChtYXJrZXIgIT09ICcnKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMubWFya2Vyc1ttYXJrZXJdKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uc3RhcnQ7CiAgICAgICAgICAgICAgICB0aGlzLnZvbHVtZSA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLnZvbHVtZTsKICAgICAgICAgICAgICAgIHRoaXMubG9vcCA9IHRoaXMubWFya2Vyc1ttYXJrZXJdLmxvb3A7CiAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy5tYXJrZXJzW21hcmtlcl0uZHVyYXRpb247CiAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uTVMgPSB0aGlzLm1hcmtlcnNbbWFya2VyXS5kdXJhdGlvbk1TOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdNYXJrZXIgTG9hZGVkOiAnLCBtYXJrZXIsICdzdGFydDonLCB0aGlzLnBvc2l0aW9uLCAnZW5kOiAnLCB0aGlzLmR1cmF0aW9uLCAnbG9vcCcsIHRoaXMubG9vcCk7CgogICAgICAgICAgICAgICAgdGhpcy5fdGVtcE1hcmtlciA9IG1hcmtlcjsKICAgICAgICAgICAgICAgIHRoaXMuX3RlbXBQb3NpdGlvbiA9IHRoaXMucG9zaXRpb247CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wVm9sdW1lID0gdGhpcy52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLl90ZW1wTG9vcCA9IHRoaXMubG9vcDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiUGhhc2VyLlNvdW5kLnBsYXk6IGF1ZGlvIG1hcmtlciAiICsgbWFya2VyICsgIiBkb2Vzbid0IGV4aXN0Iik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ25vIG1hcmtlciBpbmZvIGxvYWRlZCcsIG1hcmtlcik7CgogICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gcG9zaXRpb247CiAgICAgICAgICAgIHRoaXMudm9sdW1lID0gdm9sdW1lOwogICAgICAgICAgICB0aGlzLmxvb3AgPSBsb29wOwogICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gMDsKICAgICAgICAgICAgdGhpcy5kdXJhdGlvbk1TID0gMDsKCiAgICAgICAgICAgIHRoaXMuX3RlbXBNYXJrZXIgPSBtYXJrZXI7CiAgICAgICAgICAgIHRoaXMuX3RlbXBQb3NpdGlvbiA9IHBvc2l0aW9uOwogICAgICAgICAgICB0aGlzLl90ZW1wVm9sdW1lID0gdm9sdW1lOwogICAgICAgICAgICB0aGlzLl90ZW1wTG9vcCA9IGxvb3A7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIERvZXMgdGhlIHNvdW5kIG5lZWQgZGVjb2Rpbmc/CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZERlY29kZWQodGhpcy5rZXkpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgRG8gd2UgbmVlZCB0byBkbyB0aGlzIGV2ZXJ5IHRpbWUgd2UgcGxheT8gSG93IGFib3V0IGp1c3QgaWYgdGhlIGJ1ZmZlciBpcyBlbXB0eT8KICAgICAgICAgICAgICAgIGlmICh0aGlzLl9idWZmZXIgPT0gbnVsbCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9idWZmZXIgPSB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmREYXRhKHRoaXMua2V5KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZCA9IHRoaXMuY29udGV4dC5jcmVhdGVCdWZmZXJTb3VyY2UoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmJ1ZmZlciA9IHRoaXMuX2J1ZmZlcjsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLmNvbm5lY3QodGhpcy5nYWluTm9kZSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRHVyYXRpb24gPSB0aGlzLl9zb3VuZC5idWZmZXIuZHVyYXRpb247CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuZHVyYXRpb24gPT0gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZHVyYXRpb24gcmVzZXQnKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy50b3RhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZHVyYXRpb25NUyA9IHRoaXMudG90YWxEdXJhdGlvbiAqIDEwMDA7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKHRoaXMubG9vcCAmJiBtYXJrZXIgPT0gJycpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubG9vcCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gIFVzZWZ1bCB0byBjYWNoZSB0aGlzIHNvbWV3aGVyZSBwZXJoYXBzPwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9zb3VuZC5zdGFydCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQubm90ZUdyYWluT24oMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICAgICAgLy8gdGhpcy5fc291bmQubm90ZUdyYWluT24oMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbiAvIDEwMDApOwogICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fc291bmQubm90ZU9uKDApOyAvLyB0aGUgemVybyBpcyB2aXRhbGx5IGltcG9ydGFudCwgY3Jhc2hlcyBpT1M2IHdpdGhvdXQgaXQKCQkJCX0KCQkJCWVsc2UKCQkJCXsKICAgICAgICAgICAgICAgICAgICAvLyB0aGlzLl9zb3VuZC5zdGFydCgwLCB0aGlzLnBvc2l0aW9uLCB0aGlzLmR1cmF0aW9uIC8gMTAwMCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RhcnQoMCwgdGhpcy5wb3NpdGlvbiwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgPSB0aGlzLmdhbWUudGltZS5ub3c7CiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuc3RvcFRpbWUgPSB0aGlzLnN0YXJ0VGltZSArIHRoaXMuZHVyYXRpb25NUzsKICAgICAgICAgICAgICAgIHRoaXMub25QbGF5LmRpc3BhdGNoKHRoaXMpOwoJCQl9CgkJCWVsc2UKCQkJewogICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nUGxheWJhY2sgPSB0cnVlOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpICYmIHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkuaXNEZWNvZGluZyA9PSBmYWxzZSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuc291bmQuZGVjb2RlKHRoaXMua2V5LCB0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnU291bmQgcGxheSBBdWRpbycpOwogICAgICAgICAgICBpZiAodGhpcy5nYW1lLmNhY2hlLmdldFNvdW5kKHRoaXMua2V5KSAmJiB0aGlzLmdhbWUuY2FjaGUuZ2V0U291bmQodGhpcy5rZXkpLmxvY2tlZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3RyaWVkIHBsYXlpbmcgbG9ja2VkIHNvdW5kLCBwZW5kaW5nIHNldCwgcmVsb2FkIHN0YXJ0ZWQnKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS5yZWxvYWRTb3VuZCh0aGlzLmtleSk7CiAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnc291bmQgbm90IGxvY2tlZCwgc3RhdGU/JywgdGhpcy5fc291bmQucmVhZHlTdGF0ZSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5fc291bmQgJiYgdGhpcy5fc291bmQucmVhZHlTdGF0ZSA9PSA0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAvLyAgVGhpcyBkb2Vzbid0IGJlY29tZSBhdmFpbGFibGUgdW50aWwgeW91IGNhbGwgcGxheSgpLCB3b25kZXJmdWwgLi4uCiAgICAgICAgICAgICAgICAgICAgdGhpcy50b3RhbER1cmF0aW9uID0gdGhpcy5fc291bmQuZHVyYXRpb247CgogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmR1cmF0aW9uID09IDApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uID0gdGhpcy50b3RhbER1cmF0aW9uOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmR1cmF0aW9uTVMgPSB0aGlzLnRvdGFsRHVyYXRpb24gKiAxMDAwOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3BsYXlpbmcnLCB0aGlzLl9zb3VuZCk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY3VycmVudFRpbWUgPSB0aGlzLnBvc2l0aW9uOwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm11dGVkID0gdGhpcy5fbXV0ZWQ7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX211dGVkKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gMDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gdGhpcy5fdm9sdW1lOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RhcnRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFRpbWUgPSAwOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcFRpbWUgPSB0aGlzLnN0YXJ0VGltZSArIHRoaXMuZHVyYXRpb25NUzsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uUGxheS5kaXNwYXRjaCh0aGlzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBlbmRpbmdQbGF5YmFjayA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9LAoKICAgIC8qKgogICAgKiBSZXN0YXJ0IHRoZSBzb3VuZCwgb3IgYSBtYXJrZWQgc2VjdGlvbiBvZiBpdC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjcmVzdGFydAogICAgKiBAcGFyYW0ge3N0cmluZ30gW21hcmtlcj0nJ10gLSBJZiB5b3Ugd2FudCB0byBwbGF5IGEgbWFya2VyIHRoZW4gZ2l2ZSB0aGUga2V5IGhlcmUsIG90aGVyd2lzZSBsZWF2ZSBibGFuayB0byBwbGF5IHRoZSBmdWxsIHNvdW5kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3Bvc2l0aW9uPTBdIC0gVGhlIHN0YXJ0aW5nIHBvc2l0aW9uIHRvIHBsYXkgdGhlIHNvdW5kIGZyb20gLSB0aGlzIGlzIGlnbm9yZWQgaWYgeW91IHByb3ZpZGUgYSBtYXJrZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbdm9sdW1lPTFdIC0gVm9sdW1lIG9mIHRoZSBzb3VuZCB5b3Ugd2FudCB0byBwbGF5LgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIExvb3Agd2hlbiBpdCBmaW5pc2hlZCBwbGF5aW5nPwogICAgKi8KICAgIHJlc3RhcnQ6IGZ1bmN0aW9uIChtYXJrZXIsIHBvc2l0aW9uLCB2b2x1bWUsIGxvb3ApIHsKCiAgICAJbWFya2VyID0gbWFya2VyIHx8ICcnOwogICAgCXBvc2l0aW9uID0gcG9zaXRpb24gfHwgMDsKICAgIAl2b2x1bWUgPSB2b2x1bWUgfHwgMTsKICAgIAlpZiAodHlwZW9mIGxvb3AgPT0gJ3VuZGVmaW5lZCcpIHsgbG9vcCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMucGxheShtYXJrZXIsIHBvc2l0aW9uLCB2b2x1bWUsIGxvb3AsIHRydWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFBhdXNlcyB0aGUgc291bmQKICAgICogQG1ldGhvZCBQaGFzZXIuU291bmQjcGF1c2UKICAgICovCiAgICBwYXVzZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy5pc1BsYXlpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLnBhdXNlZFBvc2l0aW9uID0gdGhpcy5jdXJyZW50VGltZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWRUaW1lID0gdGhpcy5nYW1lLnRpbWUubm93OwogICAgICAgICAgICB0aGlzLm9uUGF1c2UuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlc3VtZXMgdGhlIHNvdW5kCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kI3Jlc3VtZQogICAgKi8KICAgIHJlc3VtZTogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5wYXVzZWQgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2YXIgcCA9IHRoaXMucG9zaXRpb24gKyAodGhpcy5wYXVzZWRQb3NpdGlvbiAvIDEwMDApOwoKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kID0gdGhpcy5jb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQuYnVmZmVyID0gdGhpcy5fYnVmZmVyOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQuY29ubmVjdCh0aGlzLmdhaW5Ob2RlKTsKCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NvdW5kLnN0YXJ0ID09PSAndW5kZWZpbmVkJykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5ub3RlR3JhaW5PbigwLCBwLCB0aGlzLmR1cmF0aW9uKTsKICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX3NvdW5kLm5vdGVPbigwKTsgLy8gdGhlIHplcm8gaXMgdml0YWxseSBpbXBvcnRhbnQsIGNyYXNoZXMgaU9TNiB3aXRob3V0IGl0CgkJCQl9CgkJCQllbHNlCgkJCQl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RhcnQoMCwgcCwgdGhpcy5kdXJhdGlvbik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5wbGF5KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuaXNQbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5wYXVzZWQgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5zdGFydFRpbWUgKz0gKHRoaXMuZ2FtZS50aW1lLm5vdyAtIHRoaXMucGF1c2VkVGltZSk7CiAgICAgICAgICAgIHRoaXMub25SZXN1bWUuZGlzcGF0Y2godGhpcyk7CiAgICAgICAgfQoKICAgIH0sCgoJLyoqCiAgICAqIFN0b3AgcGxheWluZyB0aGlzIHNvdW5kLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZCNzdG9wCiAgICAqLwogICAgc3RvcDogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy5pc1BsYXlpbmcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMuX3NvdW5kLnN0b3AgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLm5vdGVPZmYoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc291bmQuc3RvcCgwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kLnBhdXNlKCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC5jdXJyZW50VGltZSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuaXNQbGF5aW5nID0gZmFsc2U7CiAgICAgICAgdmFyIHByZXZNYXJrZXIgPSB0aGlzLmN1cnJlbnRNYXJrZXI7CiAgICAgICAgCiAgICAgICAgdGhpcy5jdXJyZW50TWFya2VyID0gJyc7CiAgICAgICAgdGhpcy5vblN0b3AuZGlzcGF0Y2godGhpcywgcHJldk1hcmtlcik7CgogICAgfQoKfTsKCi8qKgoqIEBuYW1lIFBoYXNlci5Tb3VuZCNpc0RlY29kaW5nCiogQHByb3BlcnR5IHtib29sZWFufSBpc0RlY29kaW5nIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBzb3VuZCBmaWxlIGlzIHN0aWxsIGRlY29kaW5nLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgImlzRGVjb2RpbmciLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZCh0aGlzLmtleSkuaXNEZWNvZGluZzsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI2lzRGVjb2RlZAoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gaXNEZWNvZGVkIC0gUmV0dXJucyB0cnVlIGlmIHRoZSBzb3VuZCBmaWxlIGhhcyBkZWNvZGVkLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgImlzRGVjb2RlZCIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nYW1lLmNhY2hlLmlzU291bmREZWNvZGVkKHRoaXMua2V5KTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kI211dGUKKiBAcHJvcGVydHkge2Jvb2xlYW59IG11dGUgLSBHZXRzIG9yIHNldHMgdGhlIG11dGVkIHN0YXRlIG9mIHRoaXMgc291bmQuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU291bmQucHJvdG90eXBlLCAibXV0ZSIsIHsKCQogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX211dGVkOwogICAgfSwKIAogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAJdmFsdWUgPSB2YWx1ZSB8fCBudWxsOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tdXRlZCA9IHRydWU7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9tdXRlVm9sdW1lID0gdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5nYWluTm9kZS5nYWluLnZhbHVlID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX211dGVWb2x1bWUgPSB0aGlzLl9zb3VuZC52b2x1bWU7CiAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZC52b2x1bWUgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX211dGVkID0gZmFsc2U7CgogICAgICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLmdhaW5Ob2RlLmdhaW4udmFsdWUgPSB0aGlzLl9tdXRlVm9sdW1lOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKHRoaXMudXNpbmdBdWRpb1RhZyAmJiB0aGlzLl9zb3VuZCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gdGhpcy5fbXV0ZVZvbHVtZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5vbk11dGUuZGlzcGF0Y2godGhpcyk7CgogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU291bmQjdm9sdW1lCiogQHByb3BlcnR5IHtudW1iZXJ9IHZvbHVtZSAtIEdldHMgb3Igc2V0cyB0aGUgdm9sdW1lIG9mIHRoaXMgc291bmQsIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAxLgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlNvdW5kLnByb3RvdHlwZSwgInZvbHVtZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdm9sdW1lOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fdm9sdW1lID0gdmFsdWU7CiAgICAgICAgICAgIHRoaXMuZ2Fpbk5vZGUuZ2Fpbi52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh0aGlzLnVzaW5nQXVkaW9UYWcgJiYgdGhpcy5fc291bmQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ2F1c2VzIGFuIEluZGV4IHNpemUgZXJyb3IgaW4gRmlyZWZveCBpZiB5b3UgZG9uJ3QgY2xhbXAgdGhlIHZhbHVlCiAgICAgICAgICAgIGlmICh2YWx1ZSA+PSAwICYmIHZhbHVlIDw9IDEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5fc291bmQudm9sdW1lID0gdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFNvdW5kIE1hbmFnZXIgY29uc3RydWN0b3IuCiogVGhlIFNvdW5kIE1hbmFnZXIgaXMgcmVzcG9uc2libGUgZm9yIHBsYXlpbmcgYmFjayBhdWRpbyB2aWEgZWl0aGVyIHRoZSBMZWdhY3kgSFRNTCBBdWRpbyB0YWcgb3IgdmlhIFdlYiBBdWRpbyBpZiB0aGUgYnJvd3NlciBzdXBwb3J0cyBpdC4KKiBOb3RlOiBPbiBGaXJlZm94IDI1KyBvbiBMaW51eCBpZiB5b3UgaGF2ZSBtZWRpYS5nc3RyZWFtZXIgZGlzYWJsZWQgaW4gYWJvdXQ6Y29uZmlnIHRoZW4gaXQgY2Fubm90IHBsYXkgYmFjayBtcDMgb3IgbTRhIGZpbGVzLgoqCiogQGNsYXNzIFBoYXNlci5Tb3VuZE1hbmFnZXIKKiBAY2xhc3NkZXNjIFBoYXNlciBTb3VuZCBNYW5hZ2VyLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IGdhbWUgaW5zdGFuY2UuCiovClBoYXNlci5Tb3VuZE1hbmFnZXIgPSBmdW5jdGlvbiAoZ2FtZSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCgkqLwoJdGhpcy5nYW1lID0gZ2FtZTsKCQoJLyoqCgkqIEBwcm9wZXJ0eSB7UGhhc2VyLlNpZ25hbH0gb25Tb3VuZERlY29kZSAtIERlc2NyaXB0aW9uLgoJKi8KCXRoaXMub25Tb3VuZERlY29kZSA9IG5ldyBQaGFzZXIuU2lnbmFsOwoJCgkvKioKCSogQHByb3BlcnR5IHtib29sZWFufSBfbXV0ZWQgLSBEZXNjcmlwdGlvbi4KCSogQHByaXZhdGUKCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLl9tdXRlZCA9IGZhbHNlOwogICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBfdW5sb2NrU291cmNlIC0gRGVzY3JpcHRpb24uCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5fdW5sb2NrU291cmNlID0gbnVsbDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF92b2x1bWUgLSBUaGUgZ2xvYmFsIGF1ZGlvIHZvbHVtZS4gQSB2YWx1ZSBiZXR3ZWVuIDAgKHNpbGVuY2UpIGFuZCAxIChmdWxsIHZvbHVtZSkuCiAgICAqIEBwcml2YXRlCiAgICAqIEBkZWZhdWx0IAogICAgKi8KICAgIHRoaXMuX3ZvbHVtZSA9IDE7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IF9zb3VuZHMgLSBBbiBhcnJheSBjb250YWluaW5nIGFsbCB0aGUgc291bmRzIAogICAgKiBAcHJpdmF0ZQogICAgKiBAZGVmYXVsdCBUaGUgZW1wdHkgYXJyYXkuCiAgICAqLwogICAgdGhpcy5fc291bmRzID0gW107CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7RGVzY3JpcHRpb259IGNvbnRleHQgLSBEZXNjcmlwdGlvbi4gCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb250ZXh0ID0gbnVsbDsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNpbmdXZWJBdWRpbyAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IHRydWU7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHVzaW5nQXVkaW9UYWcgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLnVzaW5nQXVkaW9UYWcgPSBmYWxzZTsKICAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbm9BdWRpbyAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMubm9BdWRpbyA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHRvdWNoTG9ja2VkIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwoKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gY2hhbm5lbHMgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNoYW5uZWxzID0gMzI7CgkKfTsKClBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbml0aWFsaXNlcyB0aGUgc291bmQgbWFuYWdlci4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2Jvb3QKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIGJvb3Q6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2UuaU9TICYmIHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXVkaW8gPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNoYW5uZWxzID0gMTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmdhbWUuZGV2aWNlLmlPUyB8fCAod2luZG93WydQaGFzZXJHbG9iYWwnXSAmJiB3aW5kb3dbJ1BoYXNlckdsb2JhbCddLmZha2VpT1NUb3VjaExvY2spKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC50b3VjaC50b3VjaFN0YXJ0Q2FsbGJhY2sgPSB0aGlzLnVubG9jazsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0Lm1vdXNlLmNhbGxiYWNrQ29udGV4dCA9IHRoaXM7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5tb3VzZURvd25DYWxsYmFjayA9IHRoaXMudW5sb2NrOwogICAgICAgICAgICB0aGlzLnRvdWNoTG9ja2VkID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdoYXQgYWJvdXQgaU9TNT8KICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10pCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ2hlY2sgdG8gc2VlIGlmIGFsbCBhdWRpbyBwbGF5YmFjayBpcyBkaXNhYmxlZCAoaS5lLiBoYW5kbGVkIGJ5IGEgM3JkIHBhcnR5IGNsYXNzKQogICAgICAgICAgICBpZiAod2luZG93WydQaGFzZXJHbG9iYWwnXS5kaXNhYmxlQXVkaW8gPT0gdHJ1ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIFdlYiBBdWRpbyBBUEkgaXMgZGlzYWJsZWQgKGZvciB0ZXN0aW5nIEF1ZGlvIFRhZyBwbGF5YmFjayBkdXJpbmcgZGV2ZWxvcG1lbnQpCiAgICAgICAgICAgIGlmICh3aW5kb3dbJ1BoYXNlckdsb2JhbCddLmRpc2FibGVXZWJBdWRpbyA9PSB0cnVlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnVzaW5nV2ViQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRydWU7CiAgICAgICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSBmYWxzZTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCEhd2luZG93WydBdWRpb0NvbnRleHQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG5ldyB3aW5kb3dbJ0F1ZGlvQ29udGV4dCddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEhd2luZG93Wyd3ZWJraXRBdWRpb0NvbnRleHQnXSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dCA9IG5ldyB3aW5kb3dbJ3dlYmtpdEF1ZGlvQ29udGV4dCddKCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKCEhd2luZG93WydBdWRpbyddKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy51c2luZ1dlYkF1ZGlvID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMudXNpbmdBdWRpb1RhZyA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMudXNpbmdXZWJBdWRpbyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLm5vQXVkaW8gPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCAhPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGhpcy5jb250ZXh0LmNyZWF0ZUdhaW4gPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLm1hc3RlckdhaW4gPSB0aGlzLmNvbnRleHQuY3JlYXRlR2Fpbk5vZGUoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubWFzdGVyR2FpbiA9IHRoaXMuY29udGV4dC5jcmVhdGVHYWluKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gMTsKICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmNvbm5lY3QodGhpcy5jb250ZXh0LmRlc3RpbmF0aW9uKTsKICAgICAgICB9CgoKICAgIH0sCgogICAgLyoqCiAgICAqIEVuYWJsZXMgdGhlIGF1ZGlvLCB1c3VhbGx5IGFmdGVyIHRoZSBmaXJzdCB0b3VjaC4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3VubG9jawogICAgKi8KICAgIHVubG9jazogZnVuY3Rpb24gKCkgewoKICAgICAgICBpZiAodGhpcy50b3VjaExvY2tlZCA9PSBmYWxzZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIC8vICBHbG9iYWwgb3ZlcnJpZGUgKG1vc3RseSBmb3IgQXVkaW8gVGFnIHRlc3RpbmcpCiAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXVkaW8gPT0gZmFsc2UgfHwgKHdpbmRvd1snUGhhc2VyR2xvYmFsJ10gJiYgd2luZG93WydQaGFzZXJHbG9iYWwnXS5kaXNhYmxlV2ViQXVkaW8gPT0gdHJ1ZSkpCiAgICAgICAgewogICAgICAgICAgICAvLyAgQ3JlYXRlIGFuIEF1ZGlvIHRhZz8KICAgICAgICAgICAgdGhpcy50b3VjaExvY2tlZCA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2guY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgdGhpcy5nYW1lLmlucHV0LnRvdWNoLnRvdWNoU3RhcnRDYWxsYmFjayA9IG51bGw7CiAgICAgICAgICAgIHRoaXMuZ2FtZS5pbnB1dC5tb3VzZS5jYWxsYmFja0NvbnRleHQgPSBudWxsOwogICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQubW91c2UubW91c2VEb3duQ2FsbGJhY2sgPSBudWxsOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyBDcmVhdGUgZW1wdHkgYnVmZmVyIGFuZCBwbGF5IGl0CiAgICAgICAgICAgIHZhciBidWZmZXIgPSB0aGlzLmNvbnRleHQuY3JlYXRlQnVmZmVyKDEsIDEsIDIyMDUwKTsKICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlID0gdGhpcy5jb250ZXh0LmNyZWF0ZUJ1ZmZlclNvdXJjZSgpOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UuYnVmZmVyID0gYnVmZmVyOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2UuY29ubmVjdCh0aGlzLmNvbnRleHQuZGVzdGluYXRpb24pOwogICAgICAgICAgICB0aGlzLl91bmxvY2tTb3VyY2Uubm90ZU9uKDApOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTdG9wcyBhbGwgdGhlIHNvdW5kcyBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3N0b3BBbGwKICAgICovCiAgICBzdG9wQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnN0b3AoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBQYXVzZXMgYWxsIHRoZSBzb3VuZHMgaW4gdGhlIGdhbWUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlNvdW5kTWFuYWdlciNwYXVzZUFsbAogICAgKi8KICAgIHBhdXNlQWxsOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5fc291bmRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc291bmRzW2ldLnBhdXNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogcmVzdW1lcyBldmVyeSBzb3VuZCBpbiB0aGUgZ2FtZS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI3Jlc3VtZUFsbAogICAgKi8KICAgIHJlc3VtZUFsbDogZnVuY3Rpb24gKCkgewoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5yZXN1bWUoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgCgl9LAoKCS8qKgogICAgKiBEZWNvZGUgYSBzb3VuZCBieSBpdHMgYXNzZXRzIGtleS4KICAgICogQG1ldGhvZCBQaGFzZXIuU291bmRNYW5hZ2VyI2RlY29kZQogICAgKiBAcGFyYW0ge3N0cmluZ30ga2V5IC0gQXNzZXRzIGtleSBvZiB0aGUgc291bmQgdG8gYmUgZGVjb2RlZC4KICAgICogQHBhcmFtIHtQaGFzZXIuU291bmR9IFtzb3VuZF0gLSBJdHMgYnVmZmVyIHdpbGwgYmUgc2V0IHRvIGRlY29kZWQgZGF0YS4KICAgICovCiAgICBkZWNvZGU6IGZ1bmN0aW9uIChrZXksIHNvdW5kKSB7CgogICAgICAgIHNvdW5kID0gc291bmQgfHwgbnVsbDsKCiAgICAgICAgdmFyIHNvdW5kRGF0YSA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRTb3VuZERhdGEoa2V5KTsKCiAgICAgICAgaWYgKHNvdW5kRGF0YSkKICAgICAgICB7CiAgICAgICAgICAgIGlmICh0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZERlY29kZWQoa2V5KSA9PT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuZ2FtZS5jYWNoZS51cGRhdGVTb3VuZChrZXksICdpc0RlY29kaW5nJywgdHJ1ZSk7CgogICAgICAgICAgICAgICAgdmFyIHRoYXQgPSB0aGlzOwoKICAgICAgICAgICAgICAgIHRoaXMuY29udGV4dC5kZWNvZGVBdWRpb0RhdGEoc291bmREYXRhLCBmdW5jdGlvbiAoYnVmZmVyKSB7CiAgICAgICAgICAgICAgICAgICAgdGhhdC5nYW1lLmNhY2hlLmRlY29kZWRTb3VuZChrZXksIGJ1ZmZlcik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHNvdW5kKQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhhdC5vblNvdW5kRGVjb2RlLmRpc3BhdGNoKHNvdW5kKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBVcGRhdGVzIGV2ZXJ5IHNvdW5kIGluIHRoZSBnYW1lLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjdXBkYXRlCiAgICAqLwogICAgdXBkYXRlOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnRvdWNoTG9ja2VkKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2FtZS5kZXZpY2Uud2ViQXVkaW8gJiYgdGhpcy5fdW5sb2NrU291cmNlICE9PSBudWxsKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoKHRoaXMuX3VubG9ja1NvdXJjZS5wbGF5YmFja1N0YXRlID09PSB0aGlzLl91bmxvY2tTb3VyY2UuUExBWUlOR19TVEFURSB8fCB0aGlzLl91bmxvY2tTb3VyY2UucGxheWJhY2tTdGF0ZSA9PT0gdGhpcy5fdW5sb2NrU291cmNlLkZJTklTSEVEX1NUQVRFKSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnRvdWNoTG9ja2VkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdW5sb2NrU291cmNlID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2guY2FsbGJhY2tDb250ZXh0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB0aGlzLmdhbWUuaW5wdXQudG91Y2gudG91Y2hTdGFydENhbGxiYWNrID0gbnVsbDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0udXBkYXRlKCk7CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFkZHMgYSBuZXcgU291bmQgaW50byB0aGUgU291bmRNYW5hZ2VyLgogICAgKiBAbWV0aG9kIFBoYXNlci5Tb3VuZE1hbmFnZXIjYWRkCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBrZXkgLSBBc3NldCBrZXkgZm9yIHRoZSBzb3VuZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt2b2x1bWU9MV0gLSBEZWZhdWx0IHZhbHVlIGZvciB0aGUgdm9sdW1lLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtsb29wPWZhbHNlXSAtIFdoZXRoZXIgb3Igbm90IHRoZSBzb3VuZCB3aWxsIGxvb3AuCiAgICAqLwogICAgYWRkOiBmdW5jdGlvbiAoa2V5LCB2b2x1bWUsIGxvb3ApIHsKCiAgICAJdm9sdW1lID0gdm9sdW1lIHx8IDE7CiAgICAJaWYgKHR5cGVvZiBsb29wID09ICd1bmRlZmluZWQnKSB7IGxvb3AgPSBmYWxzZTsgfQoKICAgICAgICB2YXIgc291bmQgPSBuZXcgUGhhc2VyLlNvdW5kKHRoaXMuZ2FtZSwga2V5LCB2b2x1bWUsIGxvb3ApOwoKICAgICAgICB0aGlzLl9zb3VuZHMucHVzaChzb3VuZCk7CgogICAgICAgIHJldHVybiBzb3VuZDsKCiAgICB9Cgp9OwoKLyoqCiogQG5hbWUgUGhhc2VyLlNvdW5kTWFuYWdlciNtdXRlCiogQHByb3BlcnR5IHtib29sZWFufSBtdXRlIC0gR2V0cyBvciBzZXRzIHRoZSBtdXRlZCBzdGF0ZSBvZiB0aGUgU291bmRNYW5hZ2VyLiBUaGlzIGVmZmVjdHMgYWxsIHNvdW5kcyBpbiB0aGUgZ2FtZS4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5Tb3VuZE1hbmFnZXIucHJvdG90eXBlLCAibXV0ZSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgcmV0dXJuIHRoaXMuX211dGVkOwoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB2YWx1ZSB8fCBudWxsOwoKICAgICAgICBpZiAodmFsdWUpCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fbXV0ZWQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fbXV0ZWQgPSB0cnVlOwogICAgICAgICAgICAKICAgICAgICAgICAgaWYgKHRoaXMudXNpbmdXZWJBdWRpbykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fbXV0ZVZvbHVtZSA9IHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmdhaW4udmFsdWUgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgTG9vcCB0aHJvdWdoIHNvdW5kcwogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuX3NvdW5kcy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3NvdW5kc1tpXS51c2luZ0F1ZGlvVGFnKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS5tdXRlID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fbXV0ZWQgPT0gZmFsc2UpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fbXV0ZWQgPSBmYWxzZTsKCiAgICAgICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMubWFzdGVyR2Fpbi5nYWluLnZhbHVlID0gdGhpcy5fbXV0ZVZvbHVtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gIExvb3AgdGhyb3VnaCBzb3VuZHMKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLl9zb3VuZHNbaV0udXNpbmdBdWRpb1RhZykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9zb3VuZHNbaV0ubXV0ZSA9IGZhbHNlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuU291bmRNYW5hZ2VyI3ZvbHVtZQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB2b2x1bWUgLSBHZXRzIG9yIHNldHMgdGhlIGdsb2JhbCB2b2x1bWUgb2YgdGhlIFNvdW5kTWFuYWdlciwgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDEuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuU291bmRNYW5hZ2VyLnByb3RvdHlwZSwgInZvbHVtZSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGlmICh0aGlzLnVzaW5nV2ViQXVkaW8pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy5tYXN0ZXJHYWluLmdhaW4udmFsdWU7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl92b2x1bWU7CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKCiAgICAgICAgdmFsdWUgPSB0aGlzLmdhbWUubWF0aC5jbGFtcCh2YWx1ZSwgMSwgMCk7CgogICAgICAgIHRoaXMuX3ZvbHVtZSA9IHZhbHVlOwoKICAgICAgICBpZiAodGhpcy51c2luZ1dlYkF1ZGlvKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5tYXN0ZXJHYWluLmdhaW4udmFsdWUgPSB2YWx1ZTsKICAgICAgICB9CgogICAgICAgIC8vICBMb29wIHRocm91Z2ggdGhlIHNvdW5kIGNhY2hlIGFuZCBjaGFuZ2UgdGhlIHZvbHVtZSBvZiBhbGwgaHRtbCBhdWRpbyB0YWdzCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9zb3VuZHMubGVuZ3RoOyBpKyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5fc291bmRzW2ldLnVzaW5nQXVkaW9UYWcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3NvdW5kc1tpXS52b2x1bWUgPSB0aGlzLl9zb3VuZHNbaV0udm9sdW1lICogdmFsdWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgCiAgICB9Cgp9KTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIEEgY29sbGVjdGlvbiBvZiBtZXRob2RzIGZvciBkaXNwbGF5aW5nIGRlYnVnIGluZm9ybWF0aW9uIGFib3V0IGdhbWUgb2JqZWN0cy4gUGhhc2VyLkRlYnVnIHJlcXVpcmVzIGEgQ0FOVkFTIGdhbWUgdHlwZSBpbiBvcmRlciB0byByZW5kZXIsIHNvIGlmIHlvdSd2ZSBnb3QKKiB5b3VyIGdhbWUgc2V0IHRvIHVzZSBQaGFzZXIuQVVUTyB0aGVuIHN3YXAgaXQgZm9yIFBoYXNlci5DQU5WQVMgdG8gZW5zdXJlIFdlYkdMIGRvZXNuJ3Qga2ljayBpbiwgdGhlbiB0aGUgRGVidWcgZnVuY3Rpb25zIHdpbGwgYWxsIGRpc3BsYXkuCioKKiBAY2xhc3MgUGhhc2VyLlV0aWxzLkRlYnVnCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuVXRpbHMuRGVidWcgPSBmdW5jdGlvbiAoZ2FtZSkgewoKICAgIC8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gQSByZWZlcmVuY2UgdG8gdGhlIGN1cnJlbnRseSBydW5uaW5nIEdhbWUuCgkqLwogICAgdGhpcy5nYW1lID0gZ2FtZTsKICAKCS8qKgoJKiBAcHJvcGVydHkge0NvbnRleHR9IGNvbnRleHQgLSBUaGUgY2FudmFzIGNvbnRleHQgb24gd2hpY2ggdG8gcmVuZGVyIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbi4KCSovCiAgICB0aGlzLmNvbnRleHQgPSBnYW1lLmNvbnRleHQ7CgoJLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBmb250IC0gVGhlIGZvbnQgdGhhdCB0aGUgZGVidWcgaW5mb3JtYXRpb24gaXMgcmVuZGVyZWQgaW4uCgkqIEBkZWZhdWx0ICcxNHB4IENvdXJpZXInCgkqLwogICAgdGhpcy5mb250ID0gJzE0cHggQ291cmllcic7CiAgIAoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsaW5lSGVpZ2h0IC0gVGhlIGxpbmUgaGVpZ2h0IGJldHdlZW4gdGhlIGRlYnVnIHRleHQuCgkqLwogICAgdGhpcy5saW5lSGVpZ2h0ID0gMTY7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlbmRlclNoYWRvdyAtIFNob3VsZCB0aGUgdGV4dCBiZSByZW5kZXJlZCB3aXRoIGEgc2xpZ2h0IHNoYWRvdz8gTWFrZXMgaXQgZWFzaWVyIHRvIHJlYWQgb24gZGlmZmVyZW50IHR5cGVzIG9mIGJhY2tncm91bmQuCgkqLwogICAgdGhpcy5yZW5kZXJTaGFkb3cgPSB0cnVlOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtDb250ZXh0fSBjdXJyZW50WCAtIFRoZSBjdXJyZW50IFggcG9zaXRpb24gdGhlIGRlYnVnIGluZm9ybWF0aW9uIHdpbGwgYmUgcmVuZGVyZWQgYXQuCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy5jdXJyZW50WCA9IDA7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge251bWJlcn0gY3VycmVudFkgLSBUaGUgY3VycmVudCBZIHBvc2l0aW9uIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiB3aWxsIGJlIHJlbmRlcmVkIGF0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY3VycmVudFkgPSAwOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtudW1iZXJ9IGN1cnJlbnRBbHBoYSAtIFRoZSBjdXJyZW50IGFscGhhIHRoZSBkZWJ1ZyBpbmZvcm1hdGlvbiB3aWxsIGJlIHJlbmRlcmVkIGF0LgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY3VycmVudEFscGhhID0gMTsKCn07CgpQaGFzZXIuVXRpbHMuRGVidWcucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QgdGhhdCByZXNldHMgYW5kIHN0YXJ0cyB0aGUgZGVidWcgb3V0cHV0IHZhbHVlcy4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjc3RhcnQKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBUaGUgWCB2YWx1ZSB0aGUgZGVidWcgaW5mbyB3aWxsIHN0YXJ0IGZyb20uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gVGhlIFkgdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKiBAcGFyYW0ge3N0cmluZ30gY29sb3IgLSBUaGUgY29sb3IgdGhlIGRlYnVnIGluZm8gd2lsbCBkcmF3biBpbi4KICAgICovCiAgICBzdGFydDogZnVuY3Rpb24gKHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgeCAhPT0gJ251bWJlcicpIHsgeCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHkgIT09ICdudW1iZXInKSB7IHkgPSAwOyB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLmN1cnJlbnRYID0geDsKICAgICAgICB0aGlzLmN1cnJlbnRZID0geTsKICAgICAgICB0aGlzLmN1cnJlbnRDb2xvciA9IGNvbG9yOwogICAgICAgIHRoaXMuY3VycmVudEFscGhhID0gdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhOwoKICAgICAgICB0aGlzLmNvbnRleHQuc2F2ZSgpOwogICAgICAgIHRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oMSwgMCwgMCwgMSwgMCwgMCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5mb250ID0gdGhpcy5mb250OwogICAgICAgIHRoaXMuY29udGV4dC5nbG9iYWxBbHBoYSA9IDE7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgc3RvcHMgdGhlIGRlYnVnIG91dHB1dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjc3RvcAogICAgKi8KICAgIHN0b3A6IGZ1bmN0aW9uICgpIHsKCgogICAgICAgIHRoaXMuY29udGV4dC5yZXN0b3JlKCk7CiAgICAgICAgdGhpcy5jb250ZXh0Lmdsb2JhbEFscGhhID0gdGhpcy5jdXJyZW50QWxwaGE7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kIHRoYXQgb3V0cHV0cyBhIHNpbmdsZSBsaW5lIG9mIHRleHQuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI2xpbmUKICAgICogQHBhcmFtIHtzdHJpbmd9IHRleHQgLSBUaGUgbGluZSBvZiB0ZXh0IHRvIGRyYXcuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gVGhlIFggdmFsdWUgdGhlIGRlYnVnIGluZm8gd2lsbCBzdGFydCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSBZIHZhbHVlIHRoZSBkZWJ1ZyBpbmZvIHdpbGwgc3RhcnQgZnJvbS4KICAgICovCiAgICBsaW5lOiBmdW5jdGlvbiAodGV4dCwgeCwgeSkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB4ID0geCB8fCBudWxsOwogICAgICAgIHkgPSB5IHx8IG51bGw7CgogICAgICAgIGlmICh4ICE9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudFggPSB4OwogICAgICAgIH0KCiAgICAgICAgaWYgKHkgIT09IG51bGwpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50WSA9IHk7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5yZW5kZXJTaGFkb3cpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gJ3JnYigwLDAsMCknOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQodGV4dCwgdGhpcy5jdXJyZW50WCArIDEsIHRoaXMuY3VycmVudFkgKyAxKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IHRoaXMuY3VycmVudENvbG9yOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxUZXh0KHRleHQsIHRoaXMuY3VycmVudFgsIHRoaXMuY3VycmVudFkpOwogICAgICAgIHRoaXMuY3VycmVudFkgKz0gdGhpcy5saW5lSGVpZ2h0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFZpc3VhbGx5IHJlbmRlcnMgYSBRdWFkVHJlZSB0byB0aGUgZGlzcGxheS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUXVhZFRyZWUKICAgICogQHBhcmFtIHtQaGFzZXIuUXVhZFRyZWV9IHF1YWR0cmVlIC0gVGhlIHF1YWR0cmVlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IGNvbG9yIC0gVGhlIGNvbG9yIG9mIHRoZSBsaW5lcyBpbiB0aGUgcXVhZHRyZWUuCiAgICAqLwogICAgcmVuZGVyUXVhZFRyZWU6IGZ1bmN0aW9uIChxdWFkdHJlZSwgY29sb3IpIHsKCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgyNTUsMCwwLDAuMyknOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CgogICAgICAgIHZhciBib3VuZHMgPSBxdWFkdHJlZS5ib3VuZHM7CgogICAgICAgIGlmIChxdWFkdHJlZS5ub2Rlcy5sZW5ndGggPT09IDApCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QoYm91bmRzLngsIGJvdW5kcy55LCBib3VuZHMud2lkdGgsIGJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLnJlbmRlclRleHQocXVhZHRyZWUuSUQgKyAnIC8gJyArIHF1YWR0cmVlLm9iamVjdHMubGVuZ3RoLCBib3VuZHMueCArIDQsIGJvdW5kcy55ICsgMTYsICdyZ2IoMCwyMDAsMCknLCAnMTJweCBDb3VyaWVyJyk7CgogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiKDAsMjU1LDApJzsKCiAgICAgICAgICAgIC8vIGNoaWxkcmVuCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcXVhZHRyZWUub2JqZWN0cy5sZW5ndGg7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZVJlY3QocXVhZHRyZWUub2JqZWN0c1tpXS54LCBxdWFkdHJlZS5vYmplY3RzW2ldLnksIHF1YWR0cmVlLm9iamVjdHNbaV0ud2lkdGgsIHF1YWR0cmVlLm9iamVjdHNbaV0uaGVpZ2h0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHF1YWR0cmVlLm5vZGVzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclF1YWRUcmVlKHF1YWR0cmVlLm5vZGVzW2ldKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICAqIFJlbmRlcnMgdGhlIGNvcm5lcnMgYW5kIHBvaW50IGluZm9ybWF0aW9uIG9mIHRoZSBnaXZlbiBTcHJpdGUuCiAgICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTcHJpdGVDb3JuZXJzCiAgICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtzaG93VGV4dD1mYWxzZV0gLSBJZiB0cnVlIHRoZSB4L3kgY29vcmRpbmF0ZXMgb2YgZWFjaCBwb2ludCB3aWxsIGJlIHJlbmRlcmVkLgogICAgICogQHBhcmFtIHtib29sZWFufSBbc2hvd0JvdW5kcz1mYWxzZV0gLSBJZiB0cnVlIHRoZSBib3VuZHMgd2lsbCBiZSByZW5kZXJlZCBvdmVyIHRoZSB0b3Agb2YgdGhlIHNwcml0ZS4KICAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMCwyNTUpJ10gLSBUaGUgY29sb3IgdGhlIHRleHQgaXMgcmVuZGVyZWQgaW4uCiAgICAgKi8KICAgIHJlbmRlclNwcml0ZUNvcm5lcnM6IGZ1bmN0aW9uIChzcHJpdGUsIHNob3dUZXh0LCBzaG93Qm91bmRzLCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBzaG93VGV4dCA9IHNob3dUZXh0IHx8IGZhbHNlOwogICAgICAgIHNob3dCb3VuZHMgPSBzaG93Qm91bmRzIHx8IGZhbHNlOwogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgaWYgKHNob3dCb3VuZHMpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9ICdyZ2JhKDAsIDI1NSwgMCwgMC43KSc7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VSZWN0KHNwcml0ZS5ib3VuZHMueCwgc3ByaXRlLmJvdW5kcy55LCBzcHJpdGUuYm91bmRzLndpZHRoLCBzcHJpdGUuYm91bmRzLmhlaWdodCk7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICAgIHRoaXMuY29udGV4dC5tb3ZlVG8oc3ByaXRlLnRvcExlZnQueCwgc3ByaXRlLnRvcExlZnQueSk7CiAgICAgICAgdGhpcy5jb250ZXh0LmxpbmVUbyhzcHJpdGUudG9wUmlnaHQueCwgc3ByaXRlLnRvcFJpZ2h0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8oc3ByaXRlLmJvdHRvbVJpZ2h0LngsIHNwcml0ZS5ib3R0b21SaWdodC55KTsKICAgICAgICB0aGlzLmNvbnRleHQubGluZVRvKHNwcml0ZS5ib3R0b21MZWZ0LngsIHNwcml0ZS5ib3R0b21MZWZ0LnkpOwogICAgICAgIHRoaXMuY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlU3R5bGUgPSAncmdiYSgyNTUsIDAsIDI1NSwgMC43KSc7CiAgICAgICAgdGhpcy5jb250ZXh0LnN0cm9rZSgpOwoKICAgICAgICB0aGlzLnJlbmRlclBvaW50KHNwcml0ZS5vZmZzZXQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmNlbnRlcik7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUudG9wTGVmdCk7CiAgICAgICAgdGhpcy5yZW5kZXJQb2ludChzcHJpdGUudG9wUmlnaHQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmJvdHRvbUxlZnQpOwogICAgICAgIHRoaXMucmVuZGVyUG9pbnQoc3ByaXRlLmJvdHRvbVJpZ2h0KTsKCiAgICAgICAgaWYgKHNob3dUZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Q29sb3IgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgTWF0aC5mbG9vcihzcHJpdGUudG9wTGVmdC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcExlZnQueSksIHNwcml0ZS50b3BMZWZ0LngsIHNwcml0ZS50b3BMZWZ0LnkpOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS50b3BSaWdodC54KSArICcgeTogJyArIE1hdGguZmxvb3Ioc3ByaXRlLnRvcFJpZ2h0LnkpLCBzcHJpdGUudG9wUmlnaHQueCwgc3ByaXRlLnRvcFJpZ2h0LnkpOwogICAgICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBNYXRoLmZsb29yKHNwcml0ZS5ib3R0b21MZWZ0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tTGVmdC55KSwgc3ByaXRlLmJvdHRvbUxlZnQueCwgc3ByaXRlLmJvdHRvbUxlZnQueSk7CiAgICAgICAgICAgIHRoaXMubGluZSgneDogJyArIE1hdGguZmxvb3Ioc3ByaXRlLmJvdHRvbVJpZ2h0LngpICsgJyB5OiAnICsgTWF0aC5mbG9vcihzcHJpdGUuYm90dG9tUmlnaHQueSksIHNwcml0ZS5ib3R0b21SaWdodC54LCBzcHJpdGUuYm90dG9tUmlnaHQueSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgU291bmQgaW5mb3JtYXRpb24sIGluY2x1ZGluZyBkZWNvZGVkIHN0YXRlLCBkdXJhdGlvbiwgdm9sdW1lIGFuZCBtb3JlLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJTb3VuZEluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuU291bmR9IHNvdW5kIC0gVGhlIHNvdW5kIG9iamVjdCB0byBkZWJ1Zy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNvdW5kSW5mbzogZnVuY3Rpb24gKHNvdW5kLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdTb3VuZDogJyArIHNvdW5kLmtleSArICcgTG9ja2VkOiAnICsgc291bmQuZ2FtZS5zb3VuZC50b3VjaExvY2tlZCk7CiAgICAgICAgdGhpcy5saW5lKCdJcyBSZWFkeT86ICcgKyB0aGlzLmdhbWUuY2FjaGUuaXNTb3VuZFJlYWR5KHNvdW5kLmtleSkgKyAnIFBlbmRpbmcgUGxheWJhY2s6ICcgKyBzb3VuZC5wZW5kaW5nUGxheWJhY2spOwogICAgICAgIHRoaXMubGluZSgnRGVjb2RlZDogJyArIHNvdW5kLmlzRGVjb2RlZCArICcgRGVjb2Rpbmc6ICcgKyBzb3VuZC5pc0RlY29kaW5nKTsKICAgICAgICB0aGlzLmxpbmUoJ1RvdGFsIER1cmF0aW9uOiAnICsgc291bmQudG90YWxEdXJhdGlvbiArICcgUGxheWluZzogJyArIHNvdW5kLmlzUGxheWluZyk7CiAgICAgICAgdGhpcy5saW5lKCdUaW1lOiAnICsgc291bmQuY3VycmVudFRpbWUpOwogICAgICAgIHRoaXMubGluZSgnVm9sdW1lOiAnICsgc291bmQudm9sdW1lICsgJyBNdXRlZDogJyArIHNvdW5kLm11dGUpOwogICAgICAgIHRoaXMubGluZSgnV2ViQXVkaW86ICcgKyBzb3VuZC51c2luZ1dlYkF1ZGlvICsgJyBBdWRpbzogJyArIHNvdW5kLnVzaW5nQXVkaW9UYWcpOwoKICAgICAgICBpZiAoc291bmQuY3VycmVudE1hcmtlciAhPT0gJycpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxpbmUoJ01hcmtlcjogJyArIHNvdW5kLmN1cnJlbnRNYXJrZXIgKyAnIER1cmF0aW9uOiAnICsgc291bmQuZHVyYXRpb24pOwogICAgICAgICAgICB0aGlzLmxpbmUoJ1N0YXJ0OiAnICsgc291bmQubWFya2Vyc1tzb3VuZC5jdXJyZW50TWFya2VyXS5zdGFydCArICcgU3RvcDogJyArIHNvdW5kLm1hcmtlcnNbc291bmQuY3VycmVudE1hcmtlcl0uc3RvcCk7CiAgICAgICAgICAgIHRoaXMubGluZSgnUG9zaXRpb246ICcgKyBzb3VuZC5wb3NpdGlvbik7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXIgY2FtZXJhIGluZm9ybWF0aW9uIGluY2x1ZGluZyBkaW1lbnNpb25zIGFuZCBsb2NhdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyQ2FtZXJhSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5DYW1lcmF9IGNhbWVyYSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyQ2FtZXJhSW5mbzogZnVuY3Rpb24gKGNhbWVyYSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwyNTUsMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgnQ2FtZXJhICgnICsgY2FtZXJhLndpZHRoICsgJyB4ICcgKyBjYW1lcmEuaGVpZ2h0ICsgJyknKTsKICAgICAgICB0aGlzLmxpbmUoJ1g6ICcgKyBjYW1lcmEueCArICcgWTogJyArIGNhbWVyYS55KTsKICAgICAgICB0aGlzLmxpbmUoJ0JvdW5kcyB4OiAnICsgY2FtZXJhLmJvdW5kcy54ICsgJyBZOiAnICsgY2FtZXJhLmJvdW5kcy55ICsgJyB3OiAnICsgY2FtZXJhLmJvdW5kcy53aWR0aCArICcgaDogJyArIGNhbWVyYS5ib3VuZHMuaGVpZ2h0KTsKICAgICAgICB0aGlzLmxpbmUoJ1ZpZXcgeDogJyArIGNhbWVyYS52aWV3LnggKyAnIFk6ICcgKyBjYW1lcmEudmlldy55ICsgJyB3OiAnICsgY2FtZXJhLnZpZXcud2lkdGggKyAnIGg6ICcgKyBjYW1lcmEudmlldy5oZWlnaHQpOwogICAgICAgIHRoaXMuc3RvcCgpOwogICAgICAgIAogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyB0aGUgUG9pbnRlci5jaXJjbGUgb2JqZWN0IG9udG8gdGhlIHN0YWdlIGluIGdyZWVuIGlmIGRvd24gb3IgcmVkIGlmIHVwIGFsb25nIHdpdGggZGVidWcgdGV4dC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyRGVidWcKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gcG9pbnRlciAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge2Jvb2xlYW59IFtoaWRlSWZVcD1mYWxzZV0gLSBEb2Vzbid0IHJlbmRlciB0aGUgY2lyY2xlIGlmIHRoZSBwb2ludGVyIGlzIHVwLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2Rvd25Db2xvcj0ncmdiYSgwLDI1NSwwLDAuNSknXSAtIFRoZSBjb2xvciB0aGUgY2lyY2xlIGlzIHJlbmRlcmVkIGluIGlmIGRvd24uCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbdXBDb2xvcj0ncmdiYSgyNTUsMCwwLDAuNSknXSAtIFRoZSBjb2xvciB0aGUgY2lyY2xlIGlzIHJlbmRlcmVkIGluIGlmIHVwIChhbmQgaGlkZUlmVXAgaXMgZmFsc2UpLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJQb2ludGVyOiBmdW5jdGlvbiAocG9pbnRlciwgaGlkZUlmVXAsIGRvd25Db2xvciwgdXBDb2xvciwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsIHx8IHBvaW50ZXIgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgaGlkZUlmVXAgPT09ICd1bmRlZmluZWQnKSB7IGhpZGVJZlVwID0gZmFsc2U7IH0KICAgICAgICBkb3duQ29sb3IgPSBkb3duQ29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwwLjUpJzsKICAgICAgICB1cENvbG9yID0gdXBDb2xvciB8fCAncmdiYSgyNTUsMCwwLDAuNSknOwogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICBpZiAoaGlkZUlmVXAgPT0gdHJ1ZSAmJiBwb2ludGVyLmlzVXAgPT0gdHJ1ZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuc3RhcnQocG9pbnRlci54LCBwb2ludGVyLnkgLSAxMDAsIGNvbG9yKTsKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmFyYyhwb2ludGVyLngsIHBvaW50ZXIueSwgcG9pbnRlci5jaXJjbGUucmFkaXVzLCAwLCBNYXRoLlBJICogMik7CgogICAgICAgIGlmIChwb2ludGVyLmFjdGl2ZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBkb3duQ29sb3I7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSB1cENvbG9yOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGwoKTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgIC8vICBSZW5kZXIgdGhlIHBvaW50cwogICAgICAgIHRoaXMuY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgICB0aGlzLmNvbnRleHQubW92ZVRvKHBvaW50ZXIucG9zaXRpb25Eb3duLngsIHBvaW50ZXIucG9zaXRpb25Eb3duLnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lVG8ocG9pbnRlci5wb3NpdGlvbi54LCBwb2ludGVyLnBvc2l0aW9uLnkpOwogICAgICAgIHRoaXMuY29udGV4dC5saW5lV2lkdGggPSAyOwogICAgICAgIHRoaXMuY29udGV4dC5zdHJva2UoKTsKICAgICAgICB0aGlzLmNvbnRleHQuY2xvc2VQYXRoKCk7CgogICAgICAgIC8vICBSZW5kZXIgdGhlIHRleHQKICAgICAgICAvLyB0aGlzLnN0YXJ0KHBvaW50ZXIueCwgcG9pbnRlci55IC0gMTAwLCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdJRDogJyArIHBvaW50ZXIuaWQgKyAiIEFjdGl2ZTogIiArIHBvaW50ZXIuYWN0aXZlKTsKICAgICAgICB0aGlzLmxpbmUoJ1dvcmxkIFg6ICcgKyBwb2ludGVyLndvcmxkWCArICIgV29ybGQgWTogIiArIHBvaW50ZXIud29ybGRZKTsKICAgICAgICB0aGlzLmxpbmUoJ1NjcmVlbiBYOiAnICsgcG9pbnRlci54ICsgIiBTY3JlZW4gWTogIiArIHBvaW50ZXIueSk7CiAgICAgICAgdGhpcy5saW5lKCdEdXJhdGlvbjogJyArIHBvaW50ZXIuZHVyYXRpb24gKyAiIG1zIik7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIFNwcml0ZSBJbnB1dCBEZWJ1ZyBpbmZvcm1hdGlvbi4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlSW5wdXRJbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIHNwcml0ZSB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8gICAgCiAgICByZW5kZXJTcHJpdGVJbnB1dEluZm86IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKICAgICAgICB0aGlzLmxpbmUoJ1Nwcml0ZSBJbnB1dDogKCcgKyBzcHJpdGUud2lkdGggKyAnIHggJyArIHNwcml0ZS5oZWlnaHQgKyAnKScpOwogICAgICAgIHRoaXMubGluZSgneDogJyArIHNwcml0ZS5pbnB1dC5wb2ludGVyWCgpLnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlclkoKS50b0ZpeGVkKDEpKTsKICAgICAgICB0aGlzLmxpbmUoJ292ZXI6ICcgKyBzcHJpdGUuaW5wdXQucG9pbnRlck92ZXIoKSArICcgZHVyYXRpb246ICcgKyBzcHJpdGUuaW5wdXQub3ZlckR1cmF0aW9uKCkudG9GaXhlZCgwKSk7CiAgICAgICAgdGhpcy5saW5lKCdkb3duOiAnICsgc3ByaXRlLmlucHV0LnBvaW50ZXJEb3duKCkgKyAnIGR1cmF0aW9uOiAnICsgc3ByaXRlLmlucHV0LmRvd25EdXJhdGlvbigpLnRvRml4ZWQoMCkpOwogICAgICAgIHRoaXMubGluZSgnanVzdCBvdmVyOiAnICsgc3ByaXRlLmlucHV0Lmp1c3RPdmVyKCkgKyAnIGp1c3Qgb3V0OiAnICsgc3ByaXRlLmlucHV0Lmp1c3RPdXQoKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICAqIFJlbmRlciBTcHJpdGUgY29sbGlzaW9uLgogICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlQ29sbGlzaW9uCiAgICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIFRoZSBzcHJpdGUgdG8gYmUgcmVuZGVyZWQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgICovIAogICAgcmVuZGVyU3ByaXRlQ29sbGlzaW9uOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDI1NSwyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdTcHJpdGUgQ29sbGlzaW9uOiAoJyArIHNwcml0ZS53aWR0aCArICcgeCAnICsgc3ByaXRlLmhlaWdodCArICcpJyk7CiAgICAgICAgdGhpcy5saW5lKCdsZWZ0OiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcubGVmdCk7CiAgICAgICAgdGhpcy5saW5lKCdyaWdodDogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLnJpZ2h0KTsKICAgICAgICB0aGlzLmxpbmUoJ3VwOiAnICsgc3ByaXRlLmJvZHkudG91Y2hpbmcudXApOwogICAgICAgIHRoaXMubGluZSgnZG93bjogJyArIHNwcml0ZS5ib2R5LnRvdWNoaW5nLmRvd24pOwogICAgICAgIHRoaXMubGluZSgndmVsb2NpdHkueDogJyArIHNwcml0ZS5ib2R5LnZlbG9jaXR5LngpOwogICAgICAgIHRoaXMubGluZSgndmVsb2NpdHkueTogJyArIHNwcml0ZS5ib2R5LnZlbG9jaXR5LnkpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciBkZWJ1ZyBpbmZvcm1hdGlvbiBhYm91dCB0aGUgSW5wdXQgb2JqZWN0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJJbnB1dEluZm8KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlcklucHV0SW5mbzogZnVuY3Rpb24gKHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDApJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CiAgICAgICAgdGhpcy5saW5lKCdJbnB1dCcpOwogICAgICAgIHRoaXMubGluZSgnWDogJyArIHRoaXMuZ2FtZS5pbnB1dC54ICsgJyBZOiAnICsgdGhpcy5nYW1lLmlucHV0LnkpOwogICAgICAgIHRoaXMubGluZSgnV29ybGQgWDogJyArIHRoaXMuZ2FtZS5pbnB1dC53b3JsZFggKyAnIFdvcmxkIFk6ICcgKyB0aGlzLmdhbWUuaW5wdXQud29ybGRZKTsKICAgICAgICB0aGlzLmxpbmUoJ1NjYWxlIFg6ICcgKyB0aGlzLmdhbWUuaW5wdXQuc2NhbGUueC50b0ZpeGVkKDEpICsgJyBTY2FsZSBZOiAnICsgdGhpcy5nYW1lLmlucHV0LnNjYWxlLngudG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5saW5lKCdTY3JlZW4gWDogJyArIHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyLnNjcmVlblggKyAnIFNjcmVlbiBZOiAnICsgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXIuc2NyZWVuWSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIGRlYnVnIGluZm9zIChpbmNsdWRpbmcgbmFtZSwgYm91bmRzIGluZm8sIHBvc2l0aW9uIGFuZCBzb21lIG90aGVyIHByb3BlcnRpZXMpIGFib3V0IHRoZSBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBzcHJpdGUgLSBEZXNjcmlwdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFkgcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBbY29sb3I9J3JnYigyNTUsMjU1LDI1NSknXSAtIGNvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLiAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclNwcml0ZUluZm86IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwoKICAgICAgICB0aGlzLmxpbmUoJ1Nwcml0ZTogJyArICcgKCcgKyBzcHJpdGUud2lkdGggKyAnIHggJyArIHNwcml0ZS5oZWlnaHQgKyAnKSBhbmNob3I6ICcgKyBzcHJpdGUuYW5jaG9yLnggKyAnIHggJyArIHNwcml0ZS5hbmNob3IueSk7CiAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgc3ByaXRlLngudG9GaXhlZCgxKSArICcgeTogJyArIHNwcml0ZS55LnRvRml4ZWQoMSkpOwogICAgICAgIHRoaXMubGluZSgnYW5nbGU6ICcgKyBzcHJpdGUuYW5nbGUudG9GaXhlZCgxKSArICcgcm90YXRpb246ICcgKyBzcHJpdGUucm90YXRpb24udG9GaXhlZCgxKSk7CiAgICAgICAgdGhpcy5saW5lKCd2aXNpYmxlOiAnICsgc3ByaXRlLnZpc2libGUgKyAnIGluIGNhbWVyYTogJyArIHNwcml0ZS5pbkNhbWVyYSk7CiAgICAgICAgdGhpcy5saW5lKCdib2R5IHg6ICcgKyBzcHJpdGUuYm9keS54LnRvRml4ZWQoMSkgKyAnIHk6ICcgKyBzcHJpdGUuYm9keS55LnRvRml4ZWQoMSkpOwoKICAgICAgICAvLyAgMCA9IHNjYWxlWAogICAgICAgIC8vICAxID0gc2tld1kKICAgICAgICAvLyAgMiA9IHRyYW5zbGF0ZVgKICAgICAgICAvLyAgMyA9IHNrZXdYCiAgICAgICAgLy8gIDQgPSBzY2FsZVkKICAgICAgICAvLyAgNSA9IHRyYW5zbGF0ZVkKCiAgICAgICAgLy8gdGhpcy5saW5lKCdpZDogJyArIHNwcml0ZS5faWQpOwogICAgICAgIC8vIHRoaXMubGluZSgnc2NhbGUgeDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVswXSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCdzY2FsZSB5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzRdKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3R4OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzJdKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3R5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzVdKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3NrZXcgeDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVszXSk7CiAgICAgICAgLy8gdGhpcy5saW5lKCdza2V3IHk6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMV0pOwogICAgICAgIHRoaXMubGluZSgnZGVsdGFYOiAnICsgc3ByaXRlLmJvZHkuZGVsdGFYKCkpOwogICAgICAgIHRoaXMubGluZSgnZGVsdGFZOiAnICsgc3ByaXRlLmJvZHkuZGVsdGFZKCkpOwogICAgICAgIC8vIHRoaXMubGluZSgnc2R4OiAnICsgc3ByaXRlLmRlbHRhWCgpKTsKICAgICAgICAvLyB0aGlzLmxpbmUoJ3NkeTogJyArIHNwcml0ZS5kZWx0YVkoKSk7CgogICAgICAgIC8vIHRoaXMubGluZSgnaW5DYW1lcmE6ICcgKyB0aGlzLmdhbWUucmVuZGVyZXIuc3ByaXRlUmVuZGVyZXIuaW5DYW1lcmEodGhpcy5nYW1lLmNhbWVyYSwgc3ByaXRlKSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVyIHRoZSBXb3JsZCBUcmFuc2Zvcm0gaW5mb3JtYXRpb24gb2YgdGhlIGdpdmVuIFNwcml0ZS4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyV29ybGRUcmFuc2Zvcm1JbmZvCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gRGVzY3JpcHRpb24uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB4IC0gWCBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yPSdyZ2IoMjU1LDI1NSwyNTUpJ10gLSBjb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4gKGZvcm1hdCBpcyBjc3MgY29sb3Igc3RyaW5nKS4KICAgICovCiAgICByZW5kZXJXb3JsZFRyYW5zZm9ybUluZm86IGZ1bmN0aW9uIChzcHJpdGUsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwoKICAgICAgICB0aGlzLmxpbmUoJ1dvcmxkIFRyYW5zZm9ybScpOwogICAgICAgIHRoaXMubGluZSgnc2tld1g6ICAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzNdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NrZXdZOiAgJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVsxXSk7CiAgICAgICAgdGhpcy5saW5lKCdzY2FsZVg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMF0pOwogICAgICAgIHRoaXMubGluZSgnc2NhbGVZOiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzRdKTsKICAgICAgICB0aGlzLmxpbmUoJ3RyYW5zWDogJyArIHNwcml0ZS53b3JsZFRyYW5zZm9ybVsyXSk7CiAgICAgICAgdGhpcy5saW5lKCd0cmFuc1k6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bNV0pOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciB0aGUgTG9jYWwgVHJhbnNmb3JtIGluZm9ybWF0aW9uIG9mIHRoZSBnaXZlbiBTcHJpdGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckxvY2FsVHJhbnNmb3JtSW5mbwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyTG9jYWxUcmFuc2Zvcm1JbmZvOiBmdW5jdGlvbiAoc3ByaXRlLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKCiAgICAgICAgdGhpcy5saW5lKCdMb2NhbCBUcmFuc2Zvcm0nKTsKICAgICAgICB0aGlzLmxpbmUoJ3NrZXdYOiAgJyArIHNwcml0ZS5sb2NhbFRyYW5zZm9ybVszXSk7CiAgICAgICAgdGhpcy5saW5lKCdza2V3WTogICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bMV0pOwogICAgICAgIHRoaXMubGluZSgnc2NhbGVYOiAnICsgc3ByaXRlLmxvY2FsVHJhbnNmb3JtWzBdKTsKICAgICAgICB0aGlzLmxpbmUoJ3NjYWxlWTogJyArIHNwcml0ZS5sb2NhbFRyYW5zZm9ybVs0XSk7CiAgICAgICAgdGhpcy5saW5lKCd0cmFuc1g6ICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bMl0pOwogICAgICAgIHRoaXMubGluZSgndHJhbnNZOiAnICsgc3ByaXRlLmxvY2FsVHJhbnNmb3JtWzVdKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIHJlbmRlclNwcml0ZUNvb3JkczogZnVuY3Rpb24gKHNwcml0ZSwgeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiKDI1NSwgMjU1LCAyNTUpJzsKCiAgICAgICAgdGhpcy5zdGFydCh4LCB5LCBjb2xvcik7CgogICAgICAgIGlmIChzcHJpdGUubmFtZSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGluZShzcHJpdGUubmFtZSk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmxpbmUoJ3g6ICcgKyBzcHJpdGUueCk7CiAgICAgICAgdGhpcy5saW5lKCd5OiAnICsgc3ByaXRlLnkpOwogICAgICAgIHRoaXMubGluZSgncG9zIHg6ICcgKyBzcHJpdGUucG9zaXRpb24ueCk7CiAgICAgICAgdGhpcy5saW5lKCdwb3MgeTogJyArIHNwcml0ZS5wb3NpdGlvbi55KTsKICAgICAgICB0aGlzLmxpbmUoJ2xvY2FsIHg6ICcgKyBzcHJpdGUubG9jYWxUcmFuc2Zvcm1bMl0pOwogICAgICAgIHRoaXMubGluZSgnbG9jYWwgeTogJyArIHNwcml0ZS5sb2NhbFRyYW5zZm9ybVs1XSk7CiAgICAgICAgdGhpcy5saW5lKCd0IHg6ICcgKyBzcHJpdGUud29ybGRUcmFuc2Zvcm1bMl0pOwogICAgICAgIHRoaXMubGluZSgndCB5OiAnICsgc3ByaXRlLndvcmxkVHJhbnNmb3JtWzVdKTsKICAgICAgICB0aGlzLmxpbmUoJ3dvcmxkIHg6ICcgKyBzcHJpdGUud29ybGQueCk7CiAgICAgICAgdGhpcy5saW5lKCd3b3JsZCB5OiAnICsgc3ByaXRlLndvcmxkLnkpOwoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIHJlbmRlckdyb3VwSW5mbzogZnVuY3Rpb24gKGdyb3VwLCB4LCB5LCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LCAyNTUsIDI1NSknOwoKICAgICAgICB0aGlzLnN0YXJ0KHgsIHksIGNvbG9yKTsKCiAgICAgICAgdGhpcy5saW5lKCdHcm91cCAoc2l6ZTogJyArIGdyb3VwLmxlbmd0aCArICcpJyk7CiAgICAgICAgdGhpcy5saW5lKCd4OiAnICsgZ3JvdXAueCk7CiAgICAgICAgdGhpcy5saW5lKCd5OiAnICsgZ3JvdXAueSk7CgogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgUG9pbnQgY29vcmRpbmF0ZXMgaW4gdGhlIGdpdmVuIGNvbG9yLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQb2ludEluZm8KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcj0ncmdiKDI1NSwyNTUsMjU1KSddIC0gY29sb3Igb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyUG9pbnRJbmZvOiBmdW5jdGlvbiAocG9pbnQsIHgsIHksIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsIDI1NSwgMjU1KSc7CgogICAgICAgIHRoaXMuc3RhcnQoeCwgeSwgY29sb3IpOwogICAgICAgIHRoaXMubGluZSgncHg6ICcgKyBwb2ludC54LnRvRml4ZWQoMSkgKyAnIHB5OiAnICsgcG9pbnQueS50b0ZpeGVkKDEpKTsKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGp1c3QgdGhlIFNwcml0ZS5ib2R5IGJvdW5kcy4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyU3ByaXRlQm9keQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQm9keTogZnVuY3Rpb24gKHNwcml0ZSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgyNTUsMCwyNTUsIDAuMyknOwoKICAgICAgICB0aGlzLnN0YXJ0KDAsIDAsIGNvbG9yKTsKCiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsUmVjdChzcHJpdGUuYm9keS5zY3JlZW5YLCBzcHJpdGUuYm9keS5zY3JlZW5ZLCBzcHJpdGUuYm9keS53aWR0aCwgc3ByaXRlLmJvZHkuaGVpZ2h0KTsKCiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBqdXN0IHRoZSBmdWxsIFNwcml0ZSBib3VuZHMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclNwcml0ZUJvdW5kcwogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV9IHNwcml0ZSAtIERlc2NyaXB0aW9uLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gW2ZpbGw9ZmFsc2VdIC0gSWYgZmFsc2UgdGhlIGJvdW5kcyBvdXRsaW5lIGlzIHJlbmRlcmVkLCBpZiB0cnVlIHRoZSB3aG9sZSByZWN0YW5nbGUgaXMgcmVuZGVyZWQuCiAgICAqLwogICAgcmVuZGVyU3ByaXRlQm91bmRzOiBmdW5jdGlvbiAoc3ByaXRlLCBjb2xvciwgZmlsbCkgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2IoMjU1LDAsMjU1KSc7CgogICAgICAgIGlmICh0eXBlb2YgZmlsbCA9PT0gJ3VuZGVmaW5lZCcpIHsgZmlsbCA9IGZhbHNlOyB9CgogICAgICAgIHRoaXMuc3RhcnQoMCwgMCwgY29sb3IpOwoKICAgICAgICBpZiAoZmlsbCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHNwcml0ZS5ib3VuZHMueCwgc3ByaXRlLmJvdW5kcy55LCBzcHJpdGUuYm91bmRzLndpZHRoLCBzcHJpdGUuYm91bmRzLmhlaWdodCk7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuY29udGV4dC5zdHJva2VTdHlsZSA9IGNvbG9yOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlUmVjdChzcHJpdGUuYm91bmRzLngsIHNwcml0ZS5ib3VuZHMueSwgc3ByaXRlLmJvdW5kcy53aWR0aCwgc3ByaXRlLmJvdW5kcy5oZWlnaHQpOwogICAgICAgICAgICB0aGlzLmNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnN0b3AoKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZW5kZXJzIGEgc2luZ2xlIHBpeGVsLgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJQaXhlbAogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBpeGVsOiBmdW5jdGlvbiAoeCwgeSwgY29sb3IpIHsKCiAgICAgICAgaWYgKHRoaXMuY29udGV4dCA9PSBudWxsKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29sb3IgPSBjb2xvciB8fCAncmdiYSgwLDI1NSwwLDEpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QoeCwgeSwgMiwgMik7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVuZGVycyBhIFBvaW50IG9iamVjdC4KICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjcmVuZGVyUG9pbnQKICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR9IHBvaW50IC0gVGhlIFBvaW50IHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclBvaW50OiBmdW5jdGlvbiAocG9pbnQsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwxKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFN0eWxlID0gY29sb3I7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxSZWN0KHBvaW50LngsIHBvaW50LnksIDQsIDQpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBSZWN0YW5nbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlclJlY3RhbmdsZQogICAgKiBAcGFyYW0ge1BoYXNlci5SZWN0YW5nbGV9IHJlY3QgLSBUaGUgUmVjdGFuZ2xlIHRvIHJlbmRlci4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKi8KICAgIHJlbmRlclJlY3RhbmdsZTogZnVuY3Rpb24gKHJlY3QsIGNvbG9yKSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYmEoMCwyNTUsMCwwLjMpJzsKCiAgICAgICAgdGhpcy5zdGFydCgpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFJlY3QocmVjdC54LCByZWN0LnksIHJlY3Qud2lkdGgsIHJlY3QuaGVpZ2h0KTsKICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlcnMgYSBDaXJjbGUuCiAgICAqIEBtZXRob2QgUGhhc2VyLlV0aWxzLkRlYnVnI3JlbmRlckNpcmNsZQogICAgKiBAcGFyYW0ge1BoYXNlci5DaXJjbGV9IGNpcmNsZSAtIFRoZSBDaXJjbGUgdG8gcmVuZGVyLgogICAgKiBAcGFyYW0ge3N0cmluZ30gW2NvbG9yXSAtIENvbG9yIG9mIHRoZSBkZWJ1ZyBpbmZvIHRvIGJlIHJlbmRlcmVkIChmb3JtYXQgaXMgY3NzIGNvbG9yIHN0cmluZykuCiAgICAqLwogICAgcmVuZGVyQ2lyY2xlOiBmdW5jdGlvbiAoY2lyY2xlLCBjb2xvcikgewoKICAgICAgICBpZiAodGhpcy5jb250ZXh0ID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb2xvciA9IGNvbG9yIHx8ICdyZ2JhKDAsMjU1LDAsMC4zKSc7CgogICAgICAgIHRoaXMuc3RhcnQoKTsKICAgICAgICB0aGlzLmNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZpbGxTdHlsZSA9IGNvbG9yOwogICAgICAgIHRoaXMuY29udGV4dC5hcmMoY2lyY2xlLngsIGNpcmNsZS55LCBjaXJjbGUucmFkaXVzLCAwLCBNYXRoLlBJICogMiwgZmFsc2UpOwogICAgICAgIHRoaXMuY29udGV4dC5maWxsKCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmNsb3NlUGF0aCgpOwogICAgICAgIHRoaXMuc3RvcCgpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJlbmRlciB0ZXh0LgogICAgKiBAbWV0aG9kIFBoYXNlci5VdGlscy5EZWJ1ZyNyZW5kZXJUZXh0CiAgICAqIEBwYXJhbSB7c3RyaW5nfSB0ZXh0IC0gVGhlIGxpbmUgb2YgdGV4dCB0byBkcmF3LgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIGRlYnVnIGluZm8gdG8gYmUgcmVuZGVyZWQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB5IC0gWSBwb3NpdGlvbiBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZC4KICAgICogQHBhcmFtIHtzdHJpbmd9IFtjb2xvcl0gLSBDb2xvciBvZiB0aGUgZGVidWcgaW5mbyB0byBiZSByZW5kZXJlZCAoZm9ybWF0IGlzIGNzcyBjb2xvciBzdHJpbmcpLgogICAgKiBAcGFyYW0ge3N0cmluZ30gZm9udCAtIFRoZSBmb250IG9mIHRleHQgdG8gZHJhdy4KICAgICovICAgIAogICAgcmVuZGVyVGV4dDogZnVuY3Rpb24gKHRleHQsIHgsIHksIGNvbG9yLCBmb250KSB7CgogICAgICAgIGlmICh0aGlzLmNvbnRleHQgPT0gbnVsbCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGNvbG9yID0gY29sb3IgfHwgJ3JnYigyNTUsMjU1LDI1NSknOwogICAgICAgIGZvbnQgPSBmb250IHx8ICcxNnB4IENvdXJpZXInOwoKICAgICAgICB0aGlzLnN0YXJ0KCk7CiAgICAgICAgdGhpcy5jb250ZXh0LmZvbnQgPSBmb250OwogICAgICAgIHRoaXMuY29udGV4dC5maWxsU3R5bGUgPSBjb2xvcjsKICAgICAgICB0aGlzLmNvbnRleHQuZmlsbFRleHQodGV4dCwgeCwgeSk7CiAgICAgICAgdGhpcy5zdG9wKCk7CgogICAgfSwKCiAgICAvKioKICAgICogRHVtcHMgdGhlIExpbmtlZCBMaXN0IHRvIHRoZSBjb25zb2xlLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuVXRpbHMuRGVidWcjUGhhc2VyLkxpbmtlZExpc3QjZHVtcCAKICAgICogQHBhcmFtIHtQaGFzZXIuTGlua2VkTGlzdH0gbGlzdCAtIFRoZSBMaW5rZWRMaXN0IHRvIGR1bXAuCiAgICAqLwogICAgZHVtcExpbmtlZExpc3Q6IGZ1bmN0aW9uIChsaXN0KSB7CgogICAgICAgIHZhciBzcGFjaW5nID0gMjA7CgogICAgICAgIHZhciBvdXRwdXQgPSAiXG4iICsgUGhhc2VyLlV0aWxzLnBhZCgnTm9kZScsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnTmV4dCcsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZCgnUHJldmlvdXMnLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJ0ZpcnN0Jywgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKCdMYXN0Jywgc3BhY2luZyk7CiAgICAgICAgY29uc29sZS5sb2cob3V0cHV0KTsKCiAgICAgICAgdmFyIG91dHB1dCA9IFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQoJy0tLS0tLS0tLS0nLCBzcGFjaW5nKTsKICAgICAgICBjb25zb2xlLmxvZyhvdXRwdXQpOwoKICAgICAgICB2YXIgZW50aXR5ID0gbGlzdDsKCiAgICAgICAgdmFyIHRlc3RPYmplY3QgPSBlbnRpdHkubGFzdC5uZXh0OwogICAgICAgIGVudGl0eSA9IGVudGl0eS5maXJzdDsKICAgICAgICAKICAgICAgICBkbyAgCiAgICAgICAgewogICAgICAgICAgICB2YXIgbmFtZSA9IGVudGl0eS5zcHJpdGUubmFtZSB8fCAnKic7CiAgICAgICAgICAgIHZhciBuYW1lTmV4dCA9ICctJzsKICAgICAgICAgICAgdmFyIG5hbWVQcmV2ID0gJy0nOwogICAgICAgICAgICB2YXIgbmFtZUZpcnN0ID0gJy0nOwogICAgICAgICAgICB2YXIgbmFtZUxhc3QgPSAnLSc7CgogICAgICAgICAgICBpZiAoZW50aXR5Lm5leHQpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVOZXh0ID0gZW50aXR5Lm5leHQuc3ByaXRlLm5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChlbnRpdHkucHJldikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZVByZXYgPSBlbnRpdHkucHJldi5zcHJpdGUubmFtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGVudGl0eS5maXJzdCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbmFtZUZpcnN0ID0gZW50aXR5LmZpcnN0LnNwcml0ZS5uYW1lOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZW50aXR5Lmxhc3QpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVMYXN0ID0gZW50aXR5Lmxhc3Quc3ByaXRlLm5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0eXBlb2YgbmFtZU5leHQgPT09ICd1bmRlZmluZWQnKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBuYW1lTmV4dCA9ICctJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lUHJldiA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVQcmV2ID0gJy0nOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHlwZW9mIG5hbWVGaXJzdCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVGaXJzdCA9ICctJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBuYW1lTGFzdCA9PT0gJ3VuZGVmaW5lZCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIG5hbWVMYXN0ID0gJy0nOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3V0cHV0ID0gUGhhc2VyLlV0aWxzLnBhZChuYW1lLCBzcGFjaW5nKSArICJ8IiArIFBoYXNlci5VdGlscy5wYWQobmFtZU5leHQsIHNwYWNpbmcpICsgInwiICsgUGhhc2VyLlV0aWxzLnBhZChuYW1lUHJldiwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVGaXJzdCwgc3BhY2luZykgKyAifCIgKyBQaGFzZXIuVXRpbHMucGFkKG5hbWVMYXN0LCBzcGFjaW5nKTsKICAgICAgICAgICAgY29uc29sZS5sb2cob3V0cHV0KTsKCiAgICAgICAgICAgIGVudGl0eSA9IGVudGl0eS5uZXh0OwoKICAgICAgICB9CiAgICAgICAgd2hpbGUoZW50aXR5ICE9IHRlc3RPYmplY3QpCgogICAgfQoKCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBBIGNvbGxlY3Rpb24gb2YgbWV0aG9kcyB1c2VmdWwgZm9yIG1hbmlwdWxhdGluZyBhbmQgY29tcGFyaW5nIGNvbG9ycy4KKgoqIEBjbGFzcyBQaGFzZXIuQ29sb3IKKi8KUGhhc2VyLkNvbG9yID0gewoKICAgIC8qKgogICAgKiBHaXZlbiBhbiBhbHBoYSBhbmQgMyBjb2xvciB2YWx1ZXMgdGhpcyB3aWxsIHJldHVybiBhbiBpbnRlZ2VyIHJlcHJlc2VudGF0aW9uIG9mIGl0LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvcjMyCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGFscGhhIC0gVGhlIEFscGhhIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByZWQgLSBUaGUgUmVkIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGdyZWVuIC0gVGhlIEdyZWVuIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGJsdWUgLSBUaGUgQmx1ZSBjaGFubmVsIHZhbHVlIChiZXR3ZWVuIDAgYW5kIDI1NSkuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IEEgbmF0aXZlIGNvbG9yIHZhbHVlIGludGVnZXIgKGZvcm1hdDogMHhBQVJSR0dCQikuCiAgICAqLwogICAgZ2V0Q29sb3IzMjogZnVuY3Rpb24gKGFscGhhLCByZWQsIGdyZWVuLCBibHVlKSB7CiAgICAgICAgcmV0dXJuIGFscGhhIDw8IDI0IHwgcmVkIDw8IDE2IHwgZ3JlZW4gPDwgOCB8IGJsdWU7CiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiAzIGNvbG9yIHZhbHVlcyB0aGlzIHdpbGwgcmV0dXJuIGFuIGludGVnZXIgcmVwcmVzZW50YXRpb24gb2YgaXQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldENvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IHJlZCAtIFRoZSBSZWQgY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gZ3JlZW4gLSBUaGUgR3JlZW4gY2hhbm5lbCB2YWx1ZSAoYmV0d2VlbiAwIGFuZCAyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYmx1ZSAtIFRoZSBCbHVlIGNoYW5uZWwgdmFsdWUgKGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHJldHVybnMge251bWJlcn0gQSBuYXRpdmUgY29sb3IgdmFsdWUgaW50ZWdlciAoZm9ybWF0OiAweFJSR0dCQikuCiAgICAqLwogICAgZ2V0Q29sb3I6IGZ1bmN0aW9uIChyZWQsIGdyZWVuLCBibHVlKSB7CiAgICAgICAgcmV0dXJuIHJlZCA8PCAxNiB8IGdyZWVuIDw8IDggfCBibHVlOwogICAgfSwKCiAgICAvKioKICAgICogQ29udmVydHMgdGhlIGdpdmVuIGhleCBzdHJpbmcgaW50byBhbiBpbnRlZ2VyIGNvbG9yIHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5oZXhUb1JHQgogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7c3RyaW5nfSBoIC0gVGhlIHN0cmluZyBoZXggY29sb3IgdG8gY29udmVydC4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIHJnYiBjb2xvciB2YWx1ZS4KICAgICovCiAgICBoZXhUb1JHQjogZnVuY3Rpb24gKGgpIHsKCiAgICAgICAgdmFyIGhleDE2ID0gKGguY2hhckF0KDApID09ICIjIikgPyBoLnN1YnN0cmluZygxLCA3KSA6IGg7CgogICAgICAgIGlmIChoZXgxNi5sZW5ndGg9PTMpCiAgICAgICAgewogICAgICAgICAgICBoZXgxNiA9IGhleDE2LmNoYXJBdCgwKSArIGhleDE2LmNoYXJBdCgwKSArIGhleDE2LmNoYXJBdCgxKSArIGhleDE2LmNoYXJBdCgxKSArIGhleDE2LmNoYXJBdCgyKSArIGhleDE2LmNoYXJBdCgyKTsKICAgICAgICB9CgogICAgICAgIHZhciByZWQgPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoMCwgMiksIDE2KTsKICAgICAgICB2YXIgZ3JlZW4gPSBwYXJzZUludChoZXgxNi5zdWJzdHJpbmcoMiwgNCksIDE2KTsKICAgICAgICB2YXIgYmx1ZSA9IHBhcnNlSW50KGhleDE2LnN1YnN0cmluZyg0LCA2KSwgMTYpOwoKICAgICAgICByZXR1cm4gcmVkIDw8IDE2IHwgZ3JlZW4gPDwgOCB8IGJsdWU7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIGEgc3RyaW5nIGNvbnRhaW5pbmcgaGFuZHkgaW5mb3JtYXRpb24gYWJvdXQgdGhlIGdpdmVuIGNvbG9yIGluY2x1ZGluZyBzdHJpbmcgaGV4IHZhbHVlLAogICAgKiBSR0IgZm9ybWF0IGluZm9ybWF0aW9uIGFuZCBIU0wgaW5mb3JtYXRpb24uIEVhY2ggc2VjdGlvbiBzdGFydHMgb24gYSBuZXdsaW5lLCAzIGxpbmVzIGluIHRvdGFsLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRDb2xvckluZm8KICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBBIGNvbG9yIHZhbHVlIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge3N0cmluZ30gU3RyaW5nIGNvbnRhaW5pbmcgdGhlIDMgbGluZXMgb2YgaW5mb3JtYXRpb24uCiAgICAqLwogICAgZ2V0Q29sb3JJbmZvOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKICAgICAgICB2YXIgaHNsID0gUGhhc2VyLkNvbG9yLlJHQnRvSFNWKGNvbG9yKTsKICAgICAgICAKICAgICAgICAvLwlIZXggZm9ybWF0CiAgICAgICAgdmFyIHJlc3VsdCA9IFBoYXNlci5Db2xvci5SR0J0b0hleHN0cmluZyhjb2xvcikgKyAiXG4iOwogICAgICAgIAogICAgICAgIC8vCVJHQiBmb3JtYXQKICAgICAgICByZXN1bHQgPSByZXN1bHQuY29uY2F0KCJBbHBoYTogIiArIGFyZ2IuYWxwaGEgKyAiIFJlZDogIiArIGFyZ2IucmVkICsgIiBHcmVlbjogIiArIGFyZ2IuZ3JlZW4gKyAiIEJsdWU6ICIgKyBhcmdiLmJsdWUpICsgIlxuIjsKICAgICAgICAKICAgICAgICAvLwlIU0wgaW5mbwogICAgICAgIHJlc3VsdCA9IHJlc3VsdC5jb25jYXQoIkh1ZTogIiArIGhzbC5odWUgKyAiIFNhdHVyYXRpb246ICIgKyBoc2wuc2F0dXJhdGlvbiArICIgTGlnaHRuZXM6ICIgKyBoc2wubGlnaHRuZXNzKTsKCiAgICAgICAgcmV0dXJuIHJlc3VsdDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvbG9yIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuUkdCdG9IZXhzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gZ2V0IHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gZm9yCiAgICAqIEByZXR1cm5zIHtzdHJpbmd9IEEgc3RyaW5nIG9mIGxlbmd0aCAxMCBjaGFyYWN0ZXJzIGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQgogICAgKi8KICAgIFJHQnRvSGV4c3RyaW5nOiBmdW5jdGlvbiAoY29sb3IpIHsKCiAgICAgICAgdmFyIGFyZ2IgPSBQaGFzZXIuQ29sb3IuZ2V0UkdCKGNvbG9yKTsKCiAgICAgICAgcmV0dXJuICIweCIgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmFscGhhKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IucmVkKSArIFBoYXNlci5Db2xvci5jb2xvclRvSGV4c3RyaW5nKGFyZ2IuZ3JlZW4pICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ibHVlKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBSZXR1cm4gYSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvbG9yIGluIHRoZSBmb3JtYXQgI1JSR0dCQi4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuUkdCdG9XZWJzdHJpbmcKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBUaGUgY29sb3IgdG8gZ2V0IHRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gZm9yLgogICAgKiBAcmV0dXJucyB7c3RyaW5nfSBBIHN0cmluZyBvZiBsZW5ndGggMTAgY2hhcmFjdGVycyBpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqLwogICAgUkdCdG9XZWJzdHJpbmc6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB2YXIgYXJnYiA9IFBoYXNlci5Db2xvci5nZXRSR0IoY29sb3IpOwoKICAgICAgICByZXR1cm4gIiMiICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5yZWQpICsgUGhhc2VyLkNvbG9yLmNvbG9yVG9IZXhzdHJpbmcoYXJnYi5ncmVlbikgKyBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZyhhcmdiLmJsdWUpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybiBhIHN0cmluZyBjb250YWluaW5nIGEgaGV4IHJlcHJlc2VudGF0aW9uIG9mIHRoZSBnaXZlbiBjb2xvci4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuY29sb3JUb0hleHN0cmluZwogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIFRoZSBjb2xvciBjaGFubmVsIHRvIGdldCB0aGUgaGV4IHZhbHVlIGZvciwgbXVzdCBiZSBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1KS4KICAgICogQHJldHVybnMge3N0cmluZ30gQSBzdHJpbmcgb2YgbGVuZ3RoIDIgY2hhcmFjdGVycywgaS5lLiAyNTUgPSBGRiwgMCA9IDAwLgogICAgKi8KICAgIGNvbG9yVG9IZXhzdHJpbmc6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB2YXIgZGlnaXRzID0gIjAxMjM0NTY3ODlBQkNERUYiOwogICAgICAgIHZhciBsc2QgPSBjb2xvciAlIDE2OwogICAgICAgIHZhciBtc2QgPSAoY29sb3IgLSBsc2QpIC8gMTY7CiAgICAgICAgdmFyIGhleGlmaWVkID0gZGlnaXRzLmNoYXJBdChtc2QpICsgZGlnaXRzLmNoYXJBdChsc2QpOwogICAgICAgIHJldHVybiBoZXhpZmllZDsKCiAgICB9LAoKICAgIC8qKgogICAgKiBJbnRlcnBvbGF0ZXMgdGhlIHR3byBnaXZlbiBjb2xvdXJzIGJhc2VkIG9uIHRoZSBzdXBwbGllZCBzdGVwIGFuZCBjdXJyZW50U3RlcCBwcm9wZXJ0aWVzLgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5pbnRlcnBvbGF0ZUNvbG9yCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yMSAtIFRoZSBmaXJzdCBjb2xvciB2YWx1ZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yMiAtIFRoZSBzZWNvbmQgY29sb3IgdmFsdWUuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGVwcyAtIFRoZSBudW1iZXIgb2Ygc3RlcHMgdG8gcnVuIHRoZSBpbnRlcnBvbGF0aW9uIG92ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjdXJyZW50U3RlcCAtIFRoZSBjdXJyZW50U3RlcCB2YWx1ZS4gSWYgdGhlIGludGVycG9sYXRpb24gd2lsbCB0YWtlIDEwMCBzdGVwcywgYSBjdXJyZW50U3RlcCB2YWx1ZSBvZiA1MCB3b3VsZCBiZSBoYWxmLXdheSBiZXR3ZWVuIHRoZSB0d28uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbHBoYSAtIFRoZSBhbHBoYSBvZiB0aGUgcmV0dXJuZWQgY29sb3IuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBpbnRlcnBvbGF0ZWQgY29sb3IgdmFsdWUuCiAgICAqLwogICAgaW50ZXJwb2xhdGVDb2xvcjogZnVuY3Rpb24gKGNvbG9yMSwgY29sb3IyLCBzdGVwcywgY3VycmVudFN0ZXAsIGFscGhhKSB7CgogICAgICAgIGlmICh0eXBlb2YgYWxwaGEgPT09ICJ1bmRlZmluZWQiKSB7IGFscGhhID0gMjU1OyB9CgogICAgICAgIHZhciBzcmMxID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcjEpOwogICAgICAgIHZhciBzcmMyID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcjIpOwogICAgICAgIHZhciByID0gKCgoc3JjMi5yZWQgLSBzcmMxLnJlZCkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyBzcmMxLnJlZDsKICAgICAgICB2YXIgZyA9ICgoKHNyYzIuZ3JlZW4gLSBzcmMxLmdyZWVuKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYzEuZ3JlZW47CiAgICAgICAgdmFyIGIgPSAoKChzcmMyLmJsdWUgLSBzcmMxLmJsdWUpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjMS5ibHVlOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yMzIoYWxwaGEsIHIsIGcsIGIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEludGVycG9sYXRlcyB0aGUgdHdvIGdpdmVuIGNvbG91cnMgYmFzZWQgb24gdGhlIHN1cHBsaWVkIHN0ZXAgYW5kIGN1cnJlbnRTdGVwIHByb3BlcnRpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmludGVycG9sYXRlQ29sb3JXaXRoUkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gVGhlIGZpcnN0IGNvbG9yIHZhbHVlLgogICAgKiBAcGFyYW0ge251bWJlcn0gciAtIFRoZSByZWQgY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGcgLSBUaGUgZ3JlZW4gY29sb3IgdmFsdWUsIGJldHdlZW4gMCBhbmQgMHhGRiAoMjU1KS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGIgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlQ29sb3JXaXRoUkdCOiBmdW5jdGlvbiAoY29sb3IsIHIsIGcsIGIsIHN0ZXBzLCBjdXJyZW50U3RlcCkgewoKICAgICAgICB2YXIgc3JjID0gUGhhc2VyLkNvbG9yLmdldFJHQihjb2xvcik7CiAgICAgICAgdmFyIG9yID0gKCgociAtIHNyYy5yZWQpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjLnJlZDsKICAgICAgICB2YXIgb2cgPSAoKChnIC0gc3JjLmdyZWVuKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIHNyYy5ncmVlbjsKICAgICAgICB2YXIgb2IgPSAoKChiIC0gc3JjLmJsdWUpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgc3JjLmJsdWU7CgogICAgICAgIHJldHVybiBQaGFzZXIuQ29sb3IuZ2V0Q29sb3Iob3IsIG9nLCBvYik7CgogICAgfSwKCiAgICAvKioKICAgICogSW50ZXJwb2xhdGVzIHRoZSB0d28gZ2l2ZW4gY29sb3VycyBiYXNlZCBvbiB0aGUgc3VwcGxpZWQgc3RlcCBhbmQgY3VycmVudFN0ZXAgcHJvcGVydGllcy4KICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuaW50ZXJwb2xhdGVSR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gcjEgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnMSAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYjEgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gcjIgLSBUaGUgcmVkIGNvbG9yIHZhbHVlLCBiZXR3ZWVuIDAgYW5kIDB4RkYgKDI1NSkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBnMiAtIFRoZSBncmVlbiBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gYjIgLSBUaGUgYmx1ZSBjb2xvciB2YWx1ZSwgYmV0d2VlbiAwIGFuZCAweEZGICgyNTUpLgogICAgKiBAcGFyYW0ge251bWJlcn0gc3RlcHMgLSBUaGUgbnVtYmVyIG9mIHN0ZXBzIHRvIHJ1biB0aGUgaW50ZXJwb2xhdGlvbiBvdmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gY3VycmVudFN0ZXAgLSBUaGUgY3VycmVudFN0ZXAgdmFsdWUuIElmIHRoZSBpbnRlcnBvbGF0aW9uIHdpbGwgdGFrZSAxMDAgc3RlcHMsIGEgY3VycmVudFN0ZXAgdmFsdWUgb2YgNTAgd291bGQgYmUgaGFsZi13YXkgYmV0d2VlbiB0aGUgdHdvLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgaW50ZXJwb2xhdGVkIGNvbG9yIHZhbHVlLgogICAgKi8KICAgIGludGVycG9sYXRlUkdCOiBmdW5jdGlvbiAocjEsIGcxLCBiMSwgcjIsIGcyLCBiMiwgc3RlcHMsIGN1cnJlbnRTdGVwKSB7CgogICAgICAgIHZhciByID0gKCgocjIgLSByMSkgKiBjdXJyZW50U3RlcCkgLyBzdGVwcykgKyByMTsKICAgICAgICB2YXIgZyA9ICgoKGcyIC0gZzEpICogY3VycmVudFN0ZXApIC8gc3RlcHMpICsgZzE7CiAgICAgICAgdmFyIGIgPSAoKChiMiAtIGIxKSAqIGN1cnJlbnRTdGVwKSAvIHN0ZXBzKSArIGIxOwoKICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKHIsIGcsIGIpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSByYW5kb20gY29sb3IgdmFsdWUgYmV0d2VlbiBibGFjayBhbmQgd2hpdGUKICAgICogU2V0IHRoZSBtaW4gdmFsdWUgdG8gc3RhcnQgZWFjaCBjaGFubmVsIGZyb20gdGhlIGdpdmVuIG9mZnNldC4KICAgICogU2V0IHRoZSBtYXggdmFsdWUgdG8gcmVzdHJpY3QgdGhlIG1heGltdW0gY29sb3IgdXNlZCBwZXIgY2hhbm5lbC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0UmFuZG9tQ29sb3IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gbWluIC0gVGhlIGxvd2VzdCB2YWx1ZSB0byB1c2UgZm9yIHRoZSBjb2xvci4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1heCAtIFRoZSBoaWdoZXN0IHZhbHVlIHRvIHVzZSBmb3IgdGhlIGNvbG9yLgogICAgKiBAcGFyYW0ge251bWJlcn0gYWxwaGEgLSBUaGUgYWxwaGEgdmFsdWUgb2YgdGhlIHJldHVybmluZyBjb2xvciAoZGVmYXVsdCAyNTUgPSBmdWxseSBvcGFxdWUpLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSAzMi1iaXQgY29sb3IgdmFsdWUgd2l0aCBhbHBoYS4KICAgICovCiAgICBnZXRSYW5kb21Db2xvcjogZnVuY3Rpb24gKG1pbiwgbWF4LCBhbHBoYSkgewoKICAgICAgICBpZiAodHlwZW9mIG1pbiA9PT0gInVuZGVmaW5lZCIpIHsgbWluID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgbWF4ID09PSAidW5kZWZpbmVkIikgeyBtYXggPSAyNTU7IH0KICAgICAgICBpZiAodHlwZW9mIGFscGhhID09PSAidW5kZWZpbmVkIikgeyBhbHBoYSA9IDI1NTsgfQoKICAgICAgICAvLwlTYW5pdHkgY2hlY2tzCiAgICAgICAgaWYgKG1heCA+IDI1NSkgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKDI1NSwgMjU1LCAyNTUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKG1pbiA+IG1heCkgewogICAgICAgICAgICByZXR1cm4gUGhhc2VyLkNvbG9yLmdldENvbG9yKDI1NSwgMjU1LCAyNTUpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlZCA9IG1pbiArIE1hdGgucm91bmQoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4pKTsKICAgICAgICB2YXIgZ3JlZW4gPSBtaW4gKyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSk7CiAgICAgICAgdmFyIGJsdWUgPSBtaW4gKyBNYXRoLnJvdW5kKE1hdGgucmFuZG9tKCkgKiAobWF4IC0gbWluKSk7CgogICAgICAgIHJldHVybiBQaGFzZXIuQ29sb3IuZ2V0Q29sb3IzMihhbHBoYSwgcmVkLCBncmVlbiwgYmx1ZSk7CgogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJuIHRoZSBjb21wb25lbnQgcGFydHMgb2YgYSBjb2xvciBhcyBhbiBPYmplY3Qgd2l0aCB0aGUgcHJvcGVydGllcyBhbHBoYSwgcmVkLCBncmVlbiwgYmx1ZQogICAgKgogICAgKiBBbHBoYSB3aWxsIG9ubHkgYmUgc2V0IGlmIGl0IGV4aXN0IGluIHRoZSBnaXZlbiBjb2xvciAoMHhBQVJSR0dCQikKICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0UkdCCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gQ29sb3IgaW4gUkdCICgweFJSR0dCQikgb3IgQVJHQiBmb3JtYXQgKDB4QUFSUkdHQkIpLgogICAgKiBAcmV0dXJucyB7b2JqZWN0fSBBbiBPYmplY3Qgd2l0aCBwcm9wZXJ0aWVzOiBhbHBoYSwgcmVkLCBncmVlbiwgYmx1ZS4KICAgICovCiAgICBnZXRSR0I6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBhbHBoYTogY29sb3IgPj4+IDI0LAogICAgICAgICAgICByZWQ6IGNvbG9yID4+IDE2ICYgMHhGRiwKICAgICAgICAgICAgZ3JlZW46IGNvbG9yID4+IDggJiAweEZGLAogICAgICAgICAgICBibHVlOiBjb2xvciAmIDB4RkYKICAgICAgICB9OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgYSBDU1MgZnJpZW5kbHkgc3RyaW5nIHZhbHVlIGZyb20gdGhlIGdpdmVuIGNvbG9yLgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRXZWJSR0IKICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IKICAgICogQHJldHVybnMge3N0cmluZ31BIHN0cmluZyBpbiB0aGUgZm9ybWF0OiAncmdiYShyLGcsYixhKScKICAgICovCiAgICBnZXRXZWJSR0I6IGZ1bmN0aW9uIChjb2xvcikgewoKICAgICAgICB2YXIgYWxwaGEgPSAoY29sb3IgPj4+IDI0KSAvIDI1NTsKICAgICAgICB2YXIgcmVkID0gY29sb3IgPj4gMTYgJiAweEZGOwogICAgICAgIHZhciBncmVlbiA9IGNvbG9yID4+IDggJiAweEZGOwogICAgICAgIHZhciBibHVlID0gY29sb3IgJiAweEZGOwoKICAgICAgICByZXR1cm4gJ3JnYmEoJyArIHJlZC50b1N0cmluZygpICsgJywnICsgZ3JlZW4udG9TdHJpbmcoKSArICcsJyArIGJsdWUudG9TdHJpbmcoKSArICcsJyArIGFscGhhLnRvU3RyaW5nKCkgKyAnKSc7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiBhIG5hdGl2ZSBjb2xvciB2YWx1ZSAoaW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCKSB0aGlzIHdpbGwgcmV0dXJuIHRoZSBBbHBoYSBjb21wb25lbnQsIGFzIGEgdmFsdWUgYmV0d2VlbiAwIGFuZCAyNTUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLkNvbG9yLmdldEFscGhhCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgQWxwaGEgY29tcG9uZW50IG9mIHRoZSBjb2xvciwgd2lsbCBiZSBiZXR3ZWVuIDAgYW5kIDEgKDAgYmVpbmcgbm8gQWxwaGEgKG9wYXF1ZSksIDEgZnVsbCBBbHBoYSAodHJhbnNwYXJlbnQpKS4KICAgICovCiAgICBnZXRBbHBoYTogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGNvbG9yID4+PiAyNDsKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIEFscGhhIGNvbXBvbmVudCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0QWxwaGFGbG9hdAogICAgKiBAc3RhdGljCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBjb2xvciAtIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIEFscGhhIGNvbXBvbmVudCBvZiB0aGUgY29sb3IsIHdpbGwgYmUgYmV0d2VlbiAwIGFuZCAxICgwIGJlaW5nIG5vIEFscGhhIChvcGFxdWUpLCAxIGZ1bGwgQWxwaGEgKHRyYW5zcGFyZW50KSkuCiAgICAqLwogICAgZ2V0QWxwaGFGbG9hdDogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIChjb2xvciA+Pj4gMjQpIC8gMjU1OwogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gYSBuYXRpdmUgY29sb3IgdmFsdWUgKGluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQikgdGhpcyB3aWxsIHJldHVybiB0aGUgUmVkIGNvbXBvbmVudCwgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0UmVkCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIEluIHRoZSBmb3JtYXQgMHhBQVJSR0dCQi4KICAgICogQHJldHVybnMge251bWJlcn0gVGhlIFJlZCBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMjU1ICgwIGJlaW5nIG5vIGNvbG9yLCAyNTUgZnVsbCBSZWQpLgogICAgKi8KICAgIGdldFJlZDogZnVuY3Rpb24gKGNvbG9yKSB7CiAgICAgICAgcmV0dXJuIGNvbG9yID4+IDE2ICYgMHhGRjsKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIEdyZWVuIGNvbXBvbmVudCwgYXMgYSB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDI1NS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuQ29sb3IuZ2V0R3JlZW4KICAgICogQHN0YXRpYwogICAgKiBAcGFyYW0ge251bWJlcn0gY29sb3IgLSBJbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBHcmVlbiBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMjU1ICgwIGJlaW5nIG5vIGNvbG9yLCAyNTUgZnVsbCBHcmVlbikuCiAgICAqLwogICAgZ2V0R3JlZW46IGZ1bmN0aW9uIChjb2xvcikgewogICAgICAgIHJldHVybiBjb2xvciA+PiA4ICYgMHhGRjsKICAgIH0sCgogICAgLyoqCiAgICAqIEdpdmVuIGEgbmF0aXZlIGNvbG9yIHZhbHVlIChpbiB0aGUgZm9ybWF0IDB4QUFSUkdHQkIpIHRoaXMgd2lsbCByZXR1cm4gdGhlIEJsdWUgY29tcG9uZW50LCBhcyBhIHZhbHVlIGJldHdlZW4gMCBhbmQgMjU1LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5Db2xvci5nZXRCbHVlCiAgICAqIEBzdGF0aWMKICAgICogQHBhcmFtIHtudW1iZXJ9IGNvbG9yIC0gSW4gdGhlIGZvcm1hdCAweEFBUlJHR0JCLgogICAgKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgQmx1ZSBjb21wb25lbnQgb2YgdGhlIGNvbG9yLCB3aWxsIGJlIGJldHdlZW4gMCBhbmQgMjU1ICgwIGJlaW5nIG5vIGNvbG9yLCAyNTUgZnVsbCBCbHVlKS4KICAgICovCiAgICBnZXRCbHVlOiBmdW5jdGlvbiAoY29sb3IpIHsKICAgICAgICByZXR1cm4gY29sb3IgJiAweEZGOwogICAgfQoJCn07CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBAY2xhc3MgUGhhc2VyLlBoeXNpY3MKKi8KUGhhc2VyLlBoeXNpY3MgPSB7fTsKCi8qKgoqIEFyY2FkZSBQaHlzaWNzIGNvbnN0cnVjdG9yLgoqCiogQGNsYXNzIFBoYXNlci5QaHlzaWNzLkFyY2FkZQoqIEBjbGFzc2Rlc2MgQXJjYWRlIFBoeXNpY3MgQ29uc3RydWN0b3IKKiBAY29uc3RydWN0b3IKKiBAcGFyYW0ge1BoYXNlci5HYW1lfSBnYW1lIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudCBnYW1lIGluc3RhbmNlLgoqLwpQaGFzZXIuUGh5c2ljcy5BcmNhZGUgPSBmdW5jdGlvbiAoZ2FtZSkgewogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuR2FtZX0gZ2FtZSAtIExvY2FsIHJlZmVyZW5jZSB0byBnYW1lLgogICAgKi8KICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBncmF2aXR5IC0gVGhlIFdvcmxkIGdyYXZpdHkgc2V0dGluZy4gRGVmYXVsdHMgdG8geDogMCwgeTogMCwgb3Igbm8gZ3Jhdml0eS4KICAgICovCiAgICB0aGlzLmdyYXZpdHkgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGJvdW5kcyAtIFRoZSBib3VuZHMgaW5zaWRlIG9mIHdoaWNoIHRoZSBwaHlzaWNzIHdvcmxkIGV4aXN0cy4gRGVmYXVsdHMgdG8gbWF0Y2ggdGhlIHdvcmxkIGJvdW5kcy4KICAgICovCiAgICB0aGlzLmJvdW5kcyA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKDAsIDAsIGdhbWUud29ybGQud2lkdGgsIGdhbWUud29ybGQuaGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heE9iamVjdHMgLSBVc2VkIGJ5IHRoZSBRdWFkVHJlZSB0byBzZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIG9iamVjdHMgcGVyIHF1YWQuCiAgICAqLwogICAgdGhpcy5tYXhPYmplY3RzID0gMTA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXhMZXZlbHMgLSBVc2VkIGJ5IHRoZSBRdWFkVHJlZSB0byBzZXQgdGhlIG1heGltdW0gbnVtYmVyIG9mIGl0ZXJhdGlvbiBsZXZlbHMuCiAgICAqLwogICAgdGhpcy5tYXhMZXZlbHMgPSA0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gT1ZFUkxBUF9CSUFTIC0gQSB2YWx1ZSBhZGRlZCB0byB0aGUgZGVsdGEgdmFsdWVzIGR1cmluZyBjb2xsaXNpb24gY2hlY2tzLgogICAgKi8KICAgIHRoaXMuT1ZFUkxBUF9CSUFTID0gNDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUXVhZFRyZWV9IHF1YWRUcmVlIC0gVGhlIHdvcmxkIFF1YWRUcmVlLgogICAgKi8KICAgIHRoaXMucXVhZFRyZWUgPSBuZXcgUGhhc2VyLlF1YWRUcmVlKHRoaXMsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueCwgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy55LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLndpZHRoLCB0aGlzLmdhbWUud29ybGQuYm91bmRzLmhlaWdodCwgdGhpcy5tYXhPYmplY3RzLCB0aGlzLm1heExldmVscyk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBxdWFkVHJlZUlEIC0gVGhlIFF1YWRUcmVlIElELgogICAgKi8KICAgIHRoaXMucXVhZFRyZWVJRCA9IDA7CgogICAgLy8gIEF2b2lkIGdjIHNwaWtlcyBieSBjYWNoaW5nIHRoZXNlIHZhbHVlcyBmb3IgcmUtdXNlCgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlJlY3RhbmdsZX0gX2JvdW5kczEgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fYm91bmRzMSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IF9ib3VuZHMyIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2JvdW5kczIgPSBuZXcgUGhhc2VyLlJlY3RhbmdsZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9vdmVybGFwIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX292ZXJsYXAgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX21heE92ZXJsYXAgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbWF4T3ZlcmxhcCA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdmVsb2NpdHkxIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZlbG9jaXR5MSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdmVsb2NpdHkyIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3ZlbG9jaXR5MiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbmV3VmVsb2NpdHkxIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX25ld1ZlbG9jaXR5MSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbmV3VmVsb2NpdHkyIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX25ld1ZlbG9jaXR5MiA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfYXZlcmFnZSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9hdmVyYWdlID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gX21hcERhdGEgLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fbWFwRGF0YSA9IFtdOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX21hcFRpbGVzIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX21hcFRpbGVzID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBfcmVzdWx0IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3Jlc3VsdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3RvdGFsIC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX3RvdGFsID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9hbmdsZSAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCiAgICB0aGlzLl9hbmdsZSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfZHggLSBJbnRlcm5hbCBjYWNoZSB2YXIuCiAgICAqIEBwcml2YXRlCiAgICAqLwogICAgdGhpcy5fZHggPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIHRoaXMuX2R5ID0gMDsKCn07CgpQaGFzZXIuUGh5c2ljcy5BcmNhZGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSBhIFBoeXNpY3MgYm9keSwgaXQgdXBkYXRlcyBhbGwgbW90aW9uIHJlbGF0ZWQgdmFsdWVzIG9uIHRoZSBCb2R5LgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSN1cGRhdGVNb3Rpb24KICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gVGhlIEJvZHkgb2JqZWN0IHRvIGJlIHVwZGF0ZWQuCiAgICAqLwogICAgdXBkYXRlTW90aW9uOiBmdW5jdGlvbiAoYm9keSkgewoKICAgICAgICAvLyAgSWYgeW91J3JlIHdvbmRlcmluZyB3aHkgdGhlIHZlbG9jaXR5IGlzIGhhbHZlZCBhbmQgYXBwbGllZCB0d2ljZSwgcmVhZCB0aGlzOiBodHRwOi8vd3d3Lm5pa3N1bGEuaHV0LmZpL35oa2Fua2Fhbi9Ib21lcGFnZXMvZ3Jhdml0eS5odG1sCgogICAgICAgIC8vICBSb3RhdGlvbgogICAgICAgIHRoaXMuX3ZlbG9jaXR5RGVsdGEgPSAodGhpcy5jb21wdXRlVmVsb2NpdHkoMCwgYm9keSwgYm9keS5hbmd1bGFyVmVsb2NpdHksIGJvZHkuYW5ndWxhckFjY2VsZXJhdGlvbiwgYm9keS5hbmd1bGFyRHJhZywgYm9keS5tYXhBbmd1bGFyKSAtIGJvZHkuYW5ndWxhclZlbG9jaXR5KSAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkICogMC41ICogNjA7CiAgICAgICAgYm9keS5hbmd1bGFyVmVsb2NpdHkgKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKICAgICAgICBib2R5LnJvdGF0aW9uICs9IChib2R5LmFuZ3VsYXJWZWxvY2l0eSAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkKTsKICAgICAgICBib2R5LmFuZ3VsYXJWZWxvY2l0eSArPSB0aGlzLl92ZWxvY2l0eURlbHRhOwoKICAgICAgICAvLyAgSG9yaXpvbnRhbAogICAgICAgIHRoaXMuX3ZlbG9jaXR5RGVsdGEgPSAodGhpcy5jb21wdXRlVmVsb2NpdHkoMSwgYm9keSwgYm9keS52ZWxvY2l0eS54LCBib2R5LmFjY2VsZXJhdGlvbi54LCBib2R5LmRyYWcueCwgYm9keS5tYXhWZWxvY2l0eS54KSAtIGJvZHkudmVsb2NpdHkueCkgKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZCAqIDAuNSAqIDYwOwogICAgICAgIGJvZHkudmVsb2NpdHkueCArPSB0aGlzLl92ZWxvY2l0eURlbHRhOwogICAgICAgIGJvZHkueCArPSAoYm9keS52ZWxvY2l0eS54ICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQpOwogICAgICAgIGJvZHkudmVsb2NpdHkueCArPSB0aGlzLl92ZWxvY2l0eURlbHRhOwoKICAgICAgICAvLyAgVmVydGljYWwKICAgICAgICB0aGlzLl92ZWxvY2l0eURlbHRhID0gKHRoaXMuY29tcHV0ZVZlbG9jaXR5KDIsIGJvZHksIGJvZHkudmVsb2NpdHkueSwgYm9keS5hY2NlbGVyYXRpb24ueSwgYm9keS5kcmFnLnksIGJvZHkubWF4VmVsb2NpdHkueSkgLSBib2R5LnZlbG9jaXR5LnkpICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQgKiAwLjUgKiA2MDsKICAgICAgICBib2R5LnZlbG9jaXR5LnkgKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKICAgICAgICBib2R5LnkgKz0gKGJvZHkudmVsb2NpdHkueSAqIHRoaXMuZ2FtZS50aW1lLnBoeXNpY3NFbGFwc2VkKTsKICAgICAgICBib2R5LnZlbG9jaXR5LnkgKz0gdGhpcy5fdmVsb2NpdHlEZWx0YTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBIHR3ZWVuLWxpa2UgZnVuY3Rpb24gdGhhdCB0YWtlcyBhIHN0YXJ0aW5nIHZlbG9jaXR5IGFuZCBzb21lIG90aGVyIGZhY3RvcnMgYW5kIHJldHVybnMgYW4gYWx0ZXJlZCB2ZWxvY2l0eS4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29tcHV0ZVZlbG9jaXR5CiAgICAqIEBwYXJhbSB7bnVtYmVyfSBheGlzIC0gMSBmb3IgaG9yaXpvbnRhbCwgMiBmb3IgdmVydGljYWwuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkgLSBUaGUgQm9keSBvYmplY3QgdG8gYmUgdXBkYXRlZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHZlbG9jaXR5IC0gQW55IGNvbXBvbmVudCBvZiB2ZWxvY2l0eSAoZS5nLiAyMCkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhY2NlbGVyYXRpb24gLSBSYXRlIGF0IHdoaWNoIHRoZSB2ZWxvY2l0eSBpcyBjaGFuZ2luZy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGRyYWcgLSBSZWFsbHkga2luZCBvZiBhIGRlY2VsZXJhdGlvbiwgdGhpcyBpcyBob3cgbXVjaCB0aGUgdmVsb2NpdHkgY2hhbmdlcyBpZiBBY2NlbGVyYXRpb24gaXMgbm90IHNldC4KICAgICogQHBhcmFtIHtudW1iZXJ9IG1NYXggLSBBbiBhYnNvbHV0ZSB2YWx1ZSBjYXAgZm9yIHRoZSB2ZWxvY2l0eS4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYWx0ZXJlZCBWZWxvY2l0eSB2YWx1ZS4KICAgICovCiAgICBjb21wdXRlVmVsb2NpdHk6IGZ1bmN0aW9uIChheGlzLCBib2R5LCB2ZWxvY2l0eSwgYWNjZWxlcmF0aW9uLCBkcmFnLCBtYXgpIHsKCiAgICAgICAgbWF4ID0gbWF4IHx8IDEwMDAwOwoKICAgICAgICBpZiAoYXhpcyA9PSAxICYmIGJvZHkuYWxsb3dHcmF2aXR5KQogICAgICAgIHsKICAgICAgICAgICAgdmVsb2NpdHkgKz0gdGhpcy5ncmF2aXR5LnggKyBib2R5LmdyYXZpdHkueDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYXhpcyA9PSAyICYmIGJvZHkuYWxsb3dHcmF2aXR5KQogICAgICAgIHsKICAgICAgICAgICAgdmVsb2NpdHkgKz0gdGhpcy5ncmF2aXR5LnkgKyBib2R5LmdyYXZpdHkueTsKICAgICAgICB9CgogICAgICAgIGlmIChhY2NlbGVyYXRpb24gIT09IDApCiAgICAgICAgewogICAgICAgICAgICB2ZWxvY2l0eSArPSBhY2NlbGVyYXRpb24gKiB0aGlzLmdhbWUudGltZS5waHlzaWNzRWxhcHNlZDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoZHJhZyAhPT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX2RyYWcgPSBkcmFnICogdGhpcy5nYW1lLnRpbWUucGh5c2ljc0VsYXBzZWQ7CgogICAgICAgICAgICBpZiAodmVsb2NpdHkgLSB0aGlzLl9kcmFnID4gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmVsb2NpdHkgLT0gdGhpcy5fZHJhZzsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICh2ZWxvY2l0eSArIHRoaXMuX2RyYWcgPCAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB2ZWxvY2l0eSArPSB0aGlzLl9kcmFnOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdmVsb2NpdHkgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodmVsb2NpdHkgPiBtYXgpCiAgICAgICAgewogICAgICAgICAgICB2ZWxvY2l0eSA9IG1heDsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAodmVsb2NpdHkgPCAtbWF4KQogICAgICAgIHsKICAgICAgICAgICAgdmVsb2NpdHkgPSAtbWF4OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZlbG9jaXR5OwoKICAgIH0sCgogICAgLyoqCiAgICAqIENhbGxlZCBhdXRvbWF0aWNhbGx5IGJ5IHRoZSBjb3JlIGdhbWUgbG9vcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjcHJlVXBkYXRlCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCiAgICBwcmVVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIENsZWFyIHRoZSB0cmVlCiAgICAgICAgdGhpcy5xdWFkVHJlZS5jbGVhcigpOwoKICAgICAgICAvLyAgQ3JlYXRlIG91ciB0cmVlIHdoaWNoIGFsbCBvZiB0aGUgUGh5c2ljcyBib2RpZXMgd2lsbCBhZGQgdGhlbXNlbHZlcyB0bwogICAgICAgIHRoaXMucXVhZFRyZWVJRCA9IDA7CiAgICAgICAgdGhpcy5xdWFkVHJlZSA9IG5ldyBQaGFzZXIuUXVhZFRyZWUodGhpcywgdGhpcy5nYW1lLndvcmxkLmJvdW5kcy54LCB0aGlzLmdhbWUud29ybGQuYm91bmRzLnksIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMud2lkdGgsIHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuaGVpZ2h0LCB0aGlzLm1heE9iamVjdHMsIHRoaXMubWF4TGV2ZWxzKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBDYWxsZWQgYXV0b21hdGljYWxseSBieSB0aGUgY29yZSBnYW1lIGxvb3AuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3Bvc3RVcGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHBvc3RVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gIENsZWFyIHRoZSB0cmVlIHJlYWR5IGZvciB0aGUgbmV4dCB1cGRhdGUKICAgICAgICB0aGlzLnF1YWRUcmVlLmNsZWFyKCk7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGlmIHR3byBTcHJpdGUgb2JqZWN0cyBvdmVybGFwLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNvdmVybGFwCiAgICAqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gb2JqZWN0MSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlIG9yIGFueXRoaW5nIHRoYXQgZXh0ZW5kcyBpdC4KICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfSBvYmplY3QyIC0gVGhlIHNlY29uZCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlIG9yIGFueXRoaW5nIHRoYXQgZXh0ZW5kcyBpdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgdGhlIHR3byBvYmplY3RzIG92ZXJsYXAuCiAgICAqLwogICAgb3ZlcmxhcDogZnVuY3Rpb24gKG9iamVjdDEsIG9iamVjdDIpIHsKCiAgICAgICAgLy8gIE9ubHkgdGVzdCB2YWxpZCBvYmplY3RzCiAgICAgICAgaWYgKG9iamVjdDEgJiYgb2JqZWN0MiAmJiBvYmplY3QxLmV4aXN0cyAmJiBvYmplY3QyLmV4aXN0cykKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiAoUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKG9iamVjdDEuYm9keSwgb2JqZWN0Mi5ib2R5KSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogQ2hlY2tzIGZvciBjb2xsaXNpb24gYmV0d2VlbiB0d28gZ2FtZSBvYmplY3RzLiBUaGUgb2JqZWN0cyBjYW4gYmUgU3ByaXRlcywgR3JvdXBzLCBFbWl0dGVycyBvciBUaWxlbWFwIExheWVycy4KICAgICogWW91IGNhbiBwZXJmb3JtIFNwcml0ZSB2cy4gU3ByaXRlLCBTcHJpdGUgdnMuIEdyb3VwLCBHcm91cCB2cy4gR3JvdXAsIFNwcml0ZSB2cy4gVGlsZW1hcCBMYXllciBvciBHcm91cCB2cy4gVGlsZW1hcCBMYXllciBjb2xsaXNpb25zLgogICAgKiBUaGUgb2JqZWN0cyBhcmUgYWxzbyBhdXRvbWF0aWNhbGx5IHNlcGFyYXRlZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZQogICAgKiBAcGFyYW0ge1BoYXNlci5TcHJpdGV8UGhhc2VyLkdyb3VwfFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlcnxQaGFzZXIuVGlsZW1hcH0gb2JqZWN0MSAtIFRoZSBmaXJzdCBvYmplY3QgdG8gY2hlY2suIENhbiBiZSBhbiBpbnN0YW5jZSBvZiBQaGFzZXIuU3ByaXRlLCBQaGFzZXIuR3JvdXAsIFBoYXNlci5QYXJ0aWNsZXMuRW1pdHRlciwgb3IgUGhhc2VyLlRpbGVtYXAKICAgICogQHBhcmFtIHtQaGFzZXIuU3ByaXRlfFBoYXNlci5Hcm91cHxQaGFzZXIuUGFydGljbGVzLkVtaXR0ZXJ8UGhhc2VyLlRpbGVtYXB9IG9iamVjdDIgLSBUaGUgc2Vjb25kIG9iamVjdCB0byBjaGVjay4gQ2FuIGJlIGFuIGluc3RhbmNlIG9mIFBoYXNlci5TcHJpdGUsIFBoYXNlci5Hcm91cCwgUGhhc2VyLlBhcnRpY2xlcy5FbWl0dGVyIG9yIFBoYXNlci5UaWxlbWFwCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtjb2xsaWRlQ2FsbGJhY2s9bnVsbF0gLSBBbiBvcHRpb25hbCBjYWxsYmFjayBmdW5jdGlvbiB0aGF0IGlzIGNhbGxlZCBpZiB0aGUgb2JqZWN0cyBvdmVybGFwLiBUaGUgdHdvIG9iamVjdHMgd2lsbCBiZSBwYXNzZWQgdG8gdGhpcyBmdW5jdGlvbiBpbiB0aGUgc2FtZSBvcmRlciBpbiB3aGljaCB5b3UgcGFzc2VkIHRoZW0gdG8gQ29sbGlzaW9uLm92ZXJsYXAuCiAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IFtwcm9jZXNzQ2FsbGJhY2s9bnVsbF0gLSBBIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgbGV0cyB5b3UgcGVyZm9ybSBhZGRpdGlvbmFsIGNoZWNrcyBhZ2FpbnN0IHRoZSB0d28gb2JqZWN0cyBpZiB0aGV5IG92ZXJsYXAuIElmIHRoaXMgaXMgc2V0IHRoZW4gY29sbGlkZUNhbGxiYWNrIHdpbGwgb25seSBiZSBjYWxsZWQgaWYgcHJvY2Vzc0NhbGxiYWNrIHJldHVybnMgdHJ1ZS4KICAgICogQHBhcmFtIHtvYmplY3R9IFtjYWxsYmFja0NvbnRleHRdIC0gVGhlIGNvbnRleHQgaW4gd2hpY2ggdG8gcnVuIHRoZSBjYWxsYmFja3MuCiAgICAqIEByZXR1cm5zIHtudW1iZXJ9IFRoZSBudW1iZXIgb2YgY29sbGlzaW9ucyB0aGF0IHdlcmUgcHJvY2Vzc2VkLgogICAgKi8KICAgIGNvbGxpZGU6IGZ1bmN0aW9uIChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIGNvbGxpZGVDYWxsYmFjayA9IGNvbGxpZGVDYWxsYmFjayB8fCBudWxsOwogICAgICAgIHByb2Nlc3NDYWxsYmFjayA9IHByb2Nlc3NDYWxsYmFjayB8fCBudWxsOwogICAgICAgIGNhbGxiYWNrQ29udGV4dCA9IGNhbGxiYWNrQ29udGV4dCB8fCBjb2xsaWRlQ2FsbGJhY2s7CgogICAgICAgIHRoaXMuX3Jlc3VsdCA9IGZhbHNlOwogICAgICAgIHRoaXMuX3RvdGFsID0gMDsKCiAgICAgICAgLy8gIE9ubHkgY29sbGlkZSB2YWxpZCBvYmplY3RzCiAgICAgICAgaWYgKG9iamVjdDEgJiYgb2JqZWN0MiAmJiBvYmplY3QxLmV4aXN0cyAmJiBvYmplY3QyLmV4aXN0cykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBDYW4gZXhwYW5kIHRvIHN1cHBvcnQgQnV0dG9ucywgVGV4dCwgZXRjIGF0IGEgbGF0ZXIgZGF0ZS4gRm9yIG5vdyB0aGVzZSBhcmUgdGhlIGVzc2VudGlhbHMuCgogICAgICAgICAgICAvLyAgU1BSSVRFUwogICAgICAgICAgICBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5TUFJJVEUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1Nwcml0ZShvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzR3JvdXAob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlRJTEVNQVBMQVlFUikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAgR1JPVVBTCiAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDEudHlwZSA9PSBQaGFzZXIuR1JPVVApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKG9iamVjdDIsIG9iamVjdDEsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5HUk9VUCB8fCBvYmplY3QyLnR5cGUgPT0gUGhhc2VyLkVNSVRURVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlR3JvdXBWc0dyb3VwKG9iamVjdDEsIG9iamVjdDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5USUxFTUFQTEFZRVIpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlR3JvdXBWc1RpbGVtYXBMYXllcihvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAgVElMRU1BUCBMQVlFUlMKICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5USUxFTUFQTEFZRVIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChvYmplY3QyLnR5cGUgPT0gUGhhc2VyLlNQUklURSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcihvYmplY3QyLCBvYmplY3QxLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIob2JqZWN0Miwgb2JqZWN0MSwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gIEVNSVRURVIKICAgICAgICAgICAgZWxzZSBpZiAob2JqZWN0MS50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAob2JqZWN0Mi50eXBlID09IFBoYXNlci5TUFJJVEUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb2xsaWRlU3ByaXRlVnNHcm91cChvYmplY3QyLCBvYmplY3QxLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuR1JPVVAgfHwgb2JqZWN0Mi50eXBlID09IFBoYXNlci5FTUlUVEVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNHcm91cChvYmplY3QxLCBvYmplY3QyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKG9iamVjdDIudHlwZSA9PSBQaGFzZXIuVElMRU1BUExBWUVSKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIob2JqZWN0MSwgb2JqZWN0MiwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiAodGhpcy5fdG90YWwgPiAwKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcgogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVTcHJpdGVWc1RpbGVtYXBMYXllcjogZnVuY3Rpb24gKHNwcml0ZSwgdGlsZW1hcExheWVyLCBjb2xsaWRlQ2FsbGJhY2ssIHByb2Nlc3NDYWxsYmFjaywgY2FsbGJhY2tDb250ZXh0KSB7CgogICAgICAgIHRoaXMuX21hcERhdGEgPSB0aWxlbWFwTGF5ZXIuZ2V0VGlsZXMoc3ByaXRlLmJvZHkueCwgc3ByaXRlLmJvZHkueSwgc3ByaXRlLmJvZHkud2lkdGgsIHNwcml0ZS5ib2R5LmhlaWdodCwgdHJ1ZSk7CgogICAgICAgIGlmICh0aGlzLl9tYXBEYXRhLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLl9tYXBEYXRhLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuc2VwYXJhdGVUaWxlKHNwcml0ZS5ib2R5LCB0aGlzLl9tYXBEYXRhW2ldKSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFRoZXkgY29sbGlkZWQsIGlzIHRoZXJlIGEgY3VzdG9tIHByb2Nlc3MgY2FsbGJhY2s/CiAgICAgICAgICAgICAgICBpZiAocHJvY2Vzc0NhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGlmIChwcm9jZXNzQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZSwgdGhpcy5fbWFwRGF0YVtpXSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl90b3RhbCsrOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29sbGlkZUNhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX21hcERhdGFbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZSwgdGhpcy5fbWFwRGF0YVtpXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgLyoqCiAgICAqIEFuIGludGVybmFsIGZ1bmN0aW9uLiBVc2UgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLmNvbGxpZGUgaW5zdGVhZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjY29sbGlkZUdyb3VwVnNUaWxlbWFwTGF5ZXIKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlR3JvdXBWc1RpbGVtYXBMYXllcjogZnVuY3Rpb24gKGdyb3VwLCB0aWxlbWFwTGF5ZXIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgaWYgKGdyb3VwLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGdyb3VwLmxlbmd0aCA9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgaWYgKGdyb3VwLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gZ3JvdXAuX2NvbnRhaW5lci5maXJzdC5faU5leHQ7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZG8gIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuZXhpc3RzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuY29sbGlkZVNwcml0ZVZzVGlsZW1hcExheWVyKGN1cnJlbnROb2RlLCB0aWxlbWFwTGF5ZXIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IGdyb3VwLl9jb250YWluZXIubGFzdC5faU5leHQpOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVTcHJpdGVWc1Nwcml0ZQogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVTcHJpdGVWc1Nwcml0ZTogZnVuY3Rpb24gKHNwcml0ZTEsIHNwcml0ZTIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgdGhpcy5zZXBhcmF0ZShzcHJpdGUxLmJvZHksIHNwcml0ZTIuYm9keSk7CgogICAgICAgIGlmICh0aGlzLl9yZXN1bHQpCiAgICAgICAgewogICAgICAgICAgICAvLyAgVGhleSBjb2xsaWRlZCwgaXMgdGhlcmUgYSBjdXN0b20gcHJvY2VzcyBjYWxsYmFjaz8KICAgICAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjaykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKHByb2Nlc3NDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlMSwgc3ByaXRlMikpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVDYWxsYmFjaykKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlMSwgc3ByaXRlMik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fdG90YWwrKzsKCiAgICAgICAgICAgICAgICBpZiAoY29sbGlkZUNhbGxiYWNrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGNvbGxpZGVDYWxsYmFjay5jYWxsKGNhbGxiYWNrQ29udGV4dCwgc3ByaXRlMSwgc3ByaXRlMik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogQW4gaW50ZXJuYWwgZnVuY3Rpb24uIFVzZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuY29sbGlkZSBpbnN0ZWFkLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjb2xsaWRlU3ByaXRlVnNHcm91cAogICAgKiBAcHJpdmF0ZQogICAgKi8KICAgIGNvbGxpZGVTcHJpdGVWc0dyb3VwOiBmdW5jdGlvbiAoc3ByaXRlLCBncm91cCwgY29sbGlkZUNhbGxiYWNrLCBwcm9jZXNzQ2FsbGJhY2ssIGNhbGxiYWNrQ29udGV4dCkgewoKICAgICAgICBpZiAoZ3JvdXAubGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICAvLyAgV2hhdCBpcyB0aGUgc3ByaXRlIGNvbGxpZGluZyB3aXRoIGluIHRoZSBxdWFkdHJlZT8KICAgICAgICB0aGlzLl9wb3RlbnRpYWxzID0gdGhpcy5xdWFkVHJlZS5yZXRyaWV2ZShzcHJpdGUpOwoKICAgICAgICBmb3IgKHZhciBpID0gMCwgbGVuID0gdGhpcy5fcG90ZW50aWFscy5sZW5ndGg7IGkgPCBsZW47IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIC8vICBXZSBoYXZlIG91ciBwb3RlbnRpYWwgc3VzcGVjdHMsIGFyZSB0aGV5IGluIHRoaXMgZ3JvdXA/CiAgICAgICAgICAgIGlmICh0aGlzLl9wb3RlbnRpYWxzW2ldLnNwcml0ZS5ncm91cCA9PSBncm91cCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5zZXBhcmF0ZShzcHJpdGUuYm9keSwgdGhpcy5fcG90ZW50aWFsc1tpXSk7CgogICAgICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdCAmJiBwcm9jZXNzQ2FsbGJhY2spCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzdWx0ID0gcHJvY2Vzc0NhbGxiYWNrLmNhbGwoY2FsbGJhY2tDb250ZXh0LCBzcHJpdGUsIHRoaXMuX3BvdGVudGlhbHNbaV0uc3ByaXRlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVzdWx0KQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX3RvdGFsKys7CgogICAgICAgICAgICAgICAgICAgIGlmIChjb2xsaWRlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBjb2xsaWRlQ2FsbGJhY2suY2FsbChjYWxsYmFja0NvbnRleHQsIHNwcml0ZSwgdGhpcy5fcG90ZW50aWFsc1tpXS5zcHJpdGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBBbiBpbnRlcm5hbCBmdW5jdGlvbi4gVXNlIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5jb2xsaWRlIGluc3RlYWQuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2NvbGxpZGVHcm91cFZzR3JvdXAKICAgICogQHByaXZhdGUKICAgICovCiAgICBjb2xsaWRlR3JvdXBWc0dyb3VwOiBmdW5jdGlvbiAoZ3JvdXAxLCBncm91cDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpIHsKCiAgICAgICAgaWYgKGdyb3VwMS5sZW5ndGggPT0gMCB8fCBncm91cDIubGVuZ3RoID09IDApCiAgICAgICAgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBpZiAoZ3JvdXAxLl9jb250YWluZXIuZmlyc3QuX2lOZXh0KQogICAgICAgIHsKICAgICAgICAgICAgdmFyIGN1cnJlbnROb2RlID0gZ3JvdXAxLl9jb250YWluZXIuZmlyc3QuX2lOZXh0OwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGRvICAKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmV4aXN0cykKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbGxpZGVTcHJpdGVWc0dyb3VwKGN1cnJlbnROb2RlLCBncm91cDIsIGNvbGxpZGVDYWxsYmFjaywgcHJvY2Vzc0NhbGxiYWNrLCBjYWxsYmFja0NvbnRleHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5faU5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnROb2RlICE9IGdyb3VwMS5fY29udGFpbmVyLmxhc3QuX2lOZXh0KTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSB0d28gcGh5c2ljcyBib2RpZXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkxIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MiAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9kaWVzIHdlcmUgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGU6IGZ1bmN0aW9uIChib2R5MSwgYm9keTIpIHsKCiAgICAgICAgdGhpcy5fcmVzdWx0ID0gKHRoaXMuc2VwYXJhdGVYKGJvZHkxLCBib2R5MikgfHwgdGhpcy5zZXBhcmF0ZVkoYm9keTEsIGJvZHkyKSk7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSB0d28gcGh5c2ljcyBib2RpZXMgb24gdGhlIHggYXhpcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2VwYXJhdGVYCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkxIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MiAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9kaWVzIHdlcmUgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGVYOiBmdW5jdGlvbiAoYm9keTEsIGJvZHkyKSB7CgogICAgICAgIC8vICBDYW4ndCBzZXBhcmF0ZSB0d28gaW1tb3ZhYmxlIGJvZGllcwogICAgICAgIGlmIChib2R5MS5pbW1vdmFibGUgJiYgYm9keTIuaW1tb3ZhYmxlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CgogICAgICAgIC8vICBDaGVjayBpZiB0aGUgaHVsbHMgYWN0dWFsbHkgb3ZlcmxhcAogICAgICAgIGlmIChQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMoYm9keTEsIGJvZHkyKSkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX21heE92ZXJsYXAgPSBib2R5MS5kZWx0YUFic1goKSArIGJvZHkyLmRlbHRhQWJzWCgpICsgdGhpcy5PVkVSTEFQX0JJQVM7CgogICAgICAgICAgICBpZiAoYm9keTEuZGVsdGFYKCkgPT0gMCAmJiBib2R5Mi5kZWx0YVgoKSA9PSAwKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgVGhleSBvdmVybGFwIGJ1dCBuZWl0aGVyIG9mIHRoZW0gYXJlIG1vdmluZwogICAgICAgICAgICAgICAgYm9keTEuZW1iZWRkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYm9keTIuZW1iZWRkZWQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGJvZHkxLmRlbHRhWCgpID4gYm9keTIuZGVsdGFYKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBCb2R5MSBpcyBtb3ZpbmcgcmlnaHQgYW5kL29yIEJvZHkyIGlzIG1vdmluZyBsZWZ0CiAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwID0gYm9keTEueCArIGJvZHkxLndpZHRoIC0gYm9keTIueDsKCiAgICAgICAgICAgICAgICBpZiAoKHRoaXMuX292ZXJsYXAgPiB0aGlzLl9tYXhPdmVybGFwKSB8fCBib2R5MS5hbGxvd0NvbGxpc2lvbi5yaWdodCA9PSBmYWxzZSB8fCBib2R5Mi5hbGxvd0NvbGxpc2lvbi5sZWZ0ID09IGZhbHNlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkxLnRvdWNoaW5nLnJpZ2h0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBib2R5Mi50b3VjaGluZy5sZWZ0ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChib2R5MS5kZWx0YVgoKSA8IGJvZHkyLmRlbHRhWCgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQm9keTEgaXMgbW92aW5nIGxlZnQgYW5kL29yIEJvZHkyIGlzIG1vdmluZyByaWdodAogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkxLnggLSBib2R5Mi53aWR0aCAtIGJvZHkyLng7CgogICAgICAgICAgICAgICAgaWYgKCgtdGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkxLmFsbG93Q29sbGlzaW9uLmxlZnQgPT0gZmFsc2UgfHwgYm9keTIuYWxsb3dDb2xsaXNpb24ucmlnaHQgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTEudG91Y2hpbmcubGVmdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYm9keTIudG91Y2hpbmcucmlnaHQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgVGhlbiBhZGp1c3QgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yZGluZ2x5IChpZiB0aGVyZSB3YXMgYW55IG92ZXJsYXApCiAgICAgICAgICAgIGlmICh0aGlzLl9vdmVybGFwICE9IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkxLm92ZXJsYXBYID0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgIGJvZHkyLm92ZXJsYXBYID0gdGhpcy5fb3ZlcmxhcDsKCiAgICAgICAgICAgICAgICBpZiAoYm9keTEuY3VzdG9tU2VwYXJhdGVYIHx8IGJvZHkyLmN1c3RvbVNlcGFyYXRlWCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl92ZWxvY2l0eTEgPSBib2R5MS52ZWxvY2l0eS54OwogICAgICAgICAgICAgICAgdGhpcy5fdmVsb2NpdHkyID0gYm9keTIudmVsb2NpdHkueDsKCiAgICAgICAgICAgICAgICBpZiAoIWJvZHkxLmltbW92YWJsZSAmJiAhYm9keTIuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgKj0gMC41OwoKICAgICAgICAgICAgICAgICAgICBib2R5MS54ID0gYm9keTEueCAtIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICAgICAgYm9keTIueCArPSB0aGlzLl9vdmVybGFwOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZXdWZWxvY2l0eTEgPSBNYXRoLnNxcnQoKHRoaXMuX3ZlbG9jaXR5MiAqIHRoaXMuX3ZlbG9jaXR5MiAqIGJvZHkyLm1hc3MpIC8gYm9keTEubWFzcykgKiAoKHRoaXMuX3ZlbG9jaXR5MiA+IDApID8gMSA6IC0xKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZXdWZWxvY2l0eTIgPSBNYXRoLnNxcnQoKHRoaXMuX3ZlbG9jaXR5MSAqIHRoaXMuX3ZlbG9jaXR5MSAqIGJvZHkxLm1hc3MpIC8gYm9keTIubWFzcykgKiAoKHRoaXMuX3ZlbG9jaXR5MSA+IDApID8gMSA6IC0xKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdmVyYWdlID0gKHRoaXMuX25ld1ZlbG9jaXR5MSArIHRoaXMuX25ld1ZlbG9jaXR5MikgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkxIC09IHRoaXMuX2F2ZXJhZ2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkyIC09IHRoaXMuX2F2ZXJhZ2U7CgogICAgICAgICAgICAgICAgICAgIGJvZHkxLnZlbG9jaXR5LnggPSB0aGlzLl9hdmVyYWdlICsgdGhpcy5fbmV3VmVsb2NpdHkxICogYm9keTEuYm91bmNlLng7CiAgICAgICAgICAgICAgICAgICAgYm9keTIudmVsb2NpdHkueCA9IHRoaXMuX2F2ZXJhZ2UgKyB0aGlzLl9uZXdWZWxvY2l0eTIgKiBib2R5Mi5ib3VuY2UueDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFib2R5MS5pbW1vdmFibGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTEueCA9IGJvZHkxLnggLSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkxLnZlbG9jaXR5LnggPSB0aGlzLl92ZWxvY2l0eTIgLSB0aGlzLl92ZWxvY2l0eTEgKiBib2R5MS5ib3VuY2UueDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFib2R5Mi5pbW1vdmFibGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTIueCArPSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnZlbG9jaXR5LnggPSB0aGlzLl92ZWxvY2l0eTEgLSB0aGlzLl92ZWxvY2l0eTIgKiBib2R5Mi5ib3VuY2UueDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgdHdvIHBoeXNpY3MgYm9kaWVzIG9uIHRoZSB5IGF4aXMuCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3NlcGFyYXRlWQogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTIgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlWTogZnVuY3Rpb24gKGJvZHkxLCBib2R5MikgewoKICAgICAgICAvLyAgQ2FuJ3Qgc2VwYXJhdGUgdHdvIGltbW92YWJsZSBvciBub24tZXhpc3RpbmcgYm9keXMKICAgICAgICBpZiAoYm9keTEuaW1tb3ZhYmxlICYmIGJvZHkyLmltbW92YWJsZSkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CgogICAgICAgIHRoaXMuX292ZXJsYXAgPSAwOwoKICAgICAgICAvLyAgQ2hlY2sgaWYgdGhlIGh1bGxzIGFjdHVhbGx5IG92ZXJsYXAKICAgICAgICBpZiAoUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKGJvZHkxLCBib2R5MikpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9tYXhPdmVybGFwID0gYm9keTEuZGVsdGFBYnNZKCkgKyBib2R5Mi5kZWx0YUFic1koKSArIHRoaXMuT1ZFUkxBUF9CSUFTOwoKICAgICAgICAgICAgaWYgKGJvZHkxLmRlbHRhWSgpID09IDAgJiYgYm9keTIuZGVsdGFZKCkgPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIFRoZXkgb3ZlcmxhcCBidXQgbmVpdGhlciBvZiB0aGVtIGFyZSBtb3ZpbmcKICAgICAgICAgICAgICAgIGJvZHkxLmVtYmVkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJvZHkyLmVtYmVkZGVkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChib2R5MS5kZWx0YVkoKSA+IGJvZHkyLmRlbHRhWSgpKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAvLyAgQm9keTEgaXMgbW92aW5nIGRvd24gYW5kL29yIEJvZHkyIGlzIG1vdmluZyB1cAogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkxLnkgKyBib2R5MS5oZWlnaHQgLSBib2R5Mi55OwoKICAgICAgICAgICAgICAgIGlmICgodGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkxLmFsbG93Q29sbGlzaW9uLmRvd24gPT0gZmFsc2UgfHwgYm9keTIuYWxsb3dDb2xsaXNpb24udXAgPT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTEudG91Y2hpbmcuZG93biA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgYm9keTIudG91Y2hpbmcudXAgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgaWYgKGJvZHkxLmRlbHRhWSgpIDwgYm9keTIuZGVsdGFZKCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIC8vICBCb2R5MSBpcyBtb3ZpbmcgdXAgYW5kL29yIEJvZHkyIGlzIG1vdmluZyBkb3duCiAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwID0gYm9keTEueSAtIGJvZHkyLmhlaWdodCAtIGJvZHkyLnk7CgogICAgICAgICAgICAgICAgaWYgKCgtdGhpcy5fb3ZlcmxhcCA+IHRoaXMuX21heE92ZXJsYXApIHx8IGJvZHkxLmFsbG93Q29sbGlzaW9uLnVwID09IGZhbHNlIHx8IGJvZHkyLmFsbG93Q29sbGlzaW9uLmRvd24gPT0gZmFsc2UpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTEudG91Y2hpbmcudXAgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnRvdWNoaW5nLmRvd24gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyAgVGhlbiBhZGp1c3QgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yZGluZ2x5IChpZiB0aGVyZSB3YXMgYW55IG92ZXJsYXApCiAgICAgICAgICAgIGlmICh0aGlzLl9vdmVybGFwICE9IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkxLm92ZXJsYXBZID0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgIGJvZHkyLm92ZXJsYXBZID0gdGhpcy5fb3ZlcmxhcDsKCiAgICAgICAgICAgICAgICBpZiAoYm9keTEuY3VzdG9tU2VwYXJhdGVZIHx8IGJvZHkyLmN1c3RvbVNlcGFyYXRlWSkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl92ZWxvY2l0eTEgPSBib2R5MS52ZWxvY2l0eS55OwogICAgICAgICAgICAgICAgdGhpcy5fdmVsb2NpdHkyID0gYm9keTIudmVsb2NpdHkueTsKCiAgICAgICAgICAgICAgICBpZiAoIWJvZHkxLmltbW92YWJsZSAmJiAhYm9keTIuaW1tb3ZhYmxlKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgKj0gMC41OwoKICAgICAgICAgICAgICAgICAgICBib2R5MS55ID0gYm9keTEueSAtIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICAgICAgYm9keTIueSArPSB0aGlzLl9vdmVybGFwOwoKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZXdWZWxvY2l0eTEgPSBNYXRoLnNxcnQoKHRoaXMuX3ZlbG9jaXR5MiAqIHRoaXMuX3ZlbG9jaXR5MiAqIGJvZHkyLm1hc3MpIC8gYm9keTEubWFzcykgKiAoKHRoaXMuX3ZlbG9jaXR5MiA+IDApID8gMSA6IC0xKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9uZXdWZWxvY2l0eTIgPSBNYXRoLnNxcnQoKHRoaXMuX3ZlbG9jaXR5MSAqIHRoaXMuX3ZlbG9jaXR5MSAqIGJvZHkxLm1hc3MpIC8gYm9keTIubWFzcykgKiAoKHRoaXMuX3ZlbG9jaXR5MSA+IDApID8gMSA6IC0xKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9hdmVyYWdlID0gKHRoaXMuX25ld1ZlbG9jaXR5MSArIHRoaXMuX25ld1ZlbG9jaXR5MikgKiAwLjU7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkxIC09IHRoaXMuX2F2ZXJhZ2U7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fbmV3VmVsb2NpdHkyIC09IHRoaXMuX2F2ZXJhZ2U7CgogICAgICAgICAgICAgICAgICAgIGJvZHkxLnZlbG9jaXR5LnkgPSB0aGlzLl9hdmVyYWdlICsgdGhpcy5fbmV3VmVsb2NpdHkxICogYm9keTEuYm91bmNlLnk7CiAgICAgICAgICAgICAgICAgICAgYm9keTIudmVsb2NpdHkueSA9IHRoaXMuX2F2ZXJhZ2UgKyB0aGlzLl9uZXdWZWxvY2l0eTIgKiBib2R5Mi5ib3VuY2UueTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFib2R5MS5pbW1vdmFibGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTEueSA9IGJvZHkxLnkgLSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkxLnZlbG9jaXR5LnkgPSB0aGlzLl92ZWxvY2l0eTIgLSB0aGlzLl92ZWxvY2l0eTEgKiBib2R5MS5ib3VuY2UueTsKCiAgICAgICAgICAgICAgICAgICAgLy8gIFRoaXMgaXMgc3BlY2lhbCBjYXNlIGNvZGUgdGhhdCBoYW5kbGVzIHRoaW5ncyBsaWtlIGhvcml6b250YWwgbW92aW5nIHBsYXRmb3JtcyB5b3UgY2FuIHJpZGUKICAgICAgICAgICAgICAgICAgICBpZiAoYm9keTIuYWN0aXZlICYmIGJvZHkyLm1vdmVzICYmIChib2R5MS5kZWx0YVkoKSA+IGJvZHkyLmRlbHRhWSgpKSkKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHkxLnggKz0gYm9keTIueCAtIGJvZHkyLmxhc3RYOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKCFib2R5Mi5pbW1vdmFibGUpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keTIueSArPSB0aGlzLl9vdmVybGFwOwogICAgICAgICAgICAgICAgICAgIGJvZHkyLnZlbG9jaXR5LnkgPSB0aGlzLl92ZWxvY2l0eTEgLSB0aGlzLl92ZWxvY2l0eTIgKiBib2R5Mi5ib3VuY2UueTsKCiAgICAgICAgICAgICAgICAgICAgLy8gIFRoaXMgaXMgc3BlY2lhbCBjYXNlIGNvZGUgdGhhdCBoYW5kbGVzIHRoaW5ncyBsaWtlIGhvcml6b250YWwgbW92aW5nIHBsYXRmb3JtcyB5b3UgY2FuIHJpZGUKICAgICAgICAgICAgICAgICAgICBpZiAoYm9keTEuc3ByaXRlLmFjdGl2ZSAmJiBib2R5MS5tb3ZlcyAmJiAoYm9keTEuZGVsdGFZKCkgPCBib2R5Mi5kZWx0YVkoKSkpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBib2R5Mi54ICs9IGJvZHkxLnggLSBib2R5MS5sYXN0WDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZmFsc2U7CgogICAgfSwKCiAgICAvKioKICAgICogVGhlIGNvcmUgc2VwYXJhdGlvbiBmdW5jdGlvbiB0byBzZXBhcmF0ZSBhIHBoeXNpY3MgYm9keSBhbmQgYSB0aWxlLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZVRpbGUKICAgICogQHBhcmFtIHtQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keX0gYm9keTEgLSBUaGUgQm9keSBvYmplY3QgdG8gc2VwYXJhdGUuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlRpbGV9IHRpbGUgLSBUaGUgdGlsZSB0byBjb2xsaWRlIGFnYWluc3QuCiAgICAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIHRydWUgaWYgdGhlIGJvZGllcyB3ZXJlIHNlcGFyYXRlZCwgb3RoZXJ3aXNlIGZhbHNlLgogICAgKi8KICAgIHNlcGFyYXRlVGlsZTogZnVuY3Rpb24gKGJvZHksIHRpbGUpIHsKCiAgICAgICAgdGhpcy5fcmVzdWx0ID0gKHRoaXMuc2VwYXJhdGVUaWxlWChib2R5LCB0aWxlLCB0cnVlKSB8fCB0aGlzLnNlcGFyYXRlVGlsZVkoYm9keSwgdGlsZSwgdHJ1ZSkpOwoKICAgICAgICByZXR1cm4gdGhpcy5fcmVzdWx0OwoKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBjb3JlIHNlcGFyYXRpb24gZnVuY3Rpb24gdG8gc2VwYXJhdGUgYSBwaHlzaWNzIGJvZHkgYW5kIGEgdGlsZSBvbiB0aGUgeCBheGlzLgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXBhcmF0ZVRpbGVYCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHl9IGJvZHkxIC0gVGhlIEJvZHkgb2JqZWN0IHRvIHNlcGFyYXRlLgogICAgKiBAcGFyYW0ge1BoYXNlci5UaWxlfSB0aWxlIC0gVGhlIHRpbGUgdG8gY29sbGlkZSBhZ2FpbnN0LgogICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyB0cnVlIGlmIHRoZSBib2RpZXMgd2VyZSBzZXBhcmF0ZWQsIG90aGVyd2lzZSBmYWxzZS4KICAgICovCiAgICBzZXBhcmF0ZVRpbGVYOiBmdW5jdGlvbiAoYm9keSwgdGlsZSwgc2VwYXJhdGUpIHsKCiAgICAgICAgLy8gIENhbid0IHNlcGFyYXRlIHR3byBpbW1vdmFibGUgb2JqZWN0cyAodGlsZXMgYXJlIGFsd2F5cyBpbW1vdmFibGUpCiAgICAgICAgaWYgKGJvZHkuaW1tb3ZhYmxlIHx8IGJvZHkuZGVsdGFYKCkgPT0gMCB8fCBQaGFzZXIuUmVjdGFuZ2xlLmludGVyc2VjdHMoYm9keS5odWxsWCwgdGlsZSkgPT0gZmFsc2UpCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9vdmVybGFwID0gMDsKCiAgICAgICAgLy8gIFRoZSBodWxscyBvdmVybGFwLCBsZXQncyBwcm9jZXNzIGl0CiAgICAgICAgLy8gdGhpcy5fbWF4T3ZlcmxhcCA9IGJvZHkuZGVsdGFBYnNYKCkgKyB0aGlzLk9WRVJMQVBfQklBUzsKCiAgICAgICAgaWYgKGJvZHkuZGVsdGFYKCkgPCAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIE1vdmluZyBsZWZ0CiAgICAgICAgICAgIHRoaXMuX292ZXJsYXAgPSB0aWxlLnJpZ2h0IC0gYm9keS5odWxsWC54OwoKICAgICAgICAgICAgLy8gaWYgKCh0aGlzLl9vdmVybGFwID4gdGhpcy5fbWF4T3ZlcmxhcCkgfHwgYm9keS5hbGxvd0NvbGxpc2lvbi5sZWZ0ID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlUmlnaHQgPT0gZmFsc2UpCiAgICAgICAgICAgIGlmIChib2R5LmFsbG93Q29sbGlzaW9uLmxlZnQgPT0gZmFsc2UgfHwgdGlsZS50aWxlLmNvbGxpZGVSaWdodCA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5LnRvdWNoaW5nLmxlZnQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIC8vICBNb3ZpbmcgcmlnaHQKICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkuaHVsbFgucmlnaHQgLSB0aWxlLng7CgogICAgICAgICAgICAvLyBpZiAoKHRoaXMuX292ZXJsYXAgPiB0aGlzLl9tYXhPdmVybGFwKSB8fCBib2R5LmFsbG93Q29sbGlzaW9uLnJpZ2h0ID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlTGVmdCA9PSBmYWxzZSkKICAgICAgICAgICAgaWYgKGJvZHkuYWxsb3dDb2xsaXNpb24ucmlnaHQgPT0gZmFsc2UgfHwgdGlsZS50aWxlLmNvbGxpZGVMZWZ0ID09IGZhbHNlKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9vdmVybGFwID0gMDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJvZHkudG91Y2hpbmcucmlnaHQgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgVGhlbiBhZGp1c3QgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yZGluZ2x5IChpZiB0aGVyZSB3YXMgYW55IG92ZXJsYXApCiAgICAgICAgaWYgKHRoaXMuX292ZXJsYXAgIT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChzZXBhcmF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGJvZHkuZGVsdGFYKCkgPCAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkueCA9IGJvZHkueCArIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keS54ID0gYm9keS54IC0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYm9keS5ib3VuY2UueCA9PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkudmVsb2NpdHkueCA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keS52ZWxvY2l0eS54ID0gLWJvZHkudmVsb2NpdHkueCAqIGJvZHkuYm91bmNlLng7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm9keS51cGRhdGVIdWxscygpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBUaGUgY29yZSBzZXBhcmF0aW9uIGZ1bmN0aW9uIHRvIHNlcGFyYXRlIGEgcGh5c2ljcyBib2R5IGFuZCBhIHRpbGUgb24gdGhlIHggYXhpcy4KICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjc2VwYXJhdGVUaWxlWQogICAgKiBAcGFyYW0ge1BoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5fSBib2R5MSAtIFRoZSBCb2R5IG9iamVjdCB0byBzZXBhcmF0ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuVGlsZX0gdGlsZSAtIFRoZSB0aWxlIHRvIGNvbGxpZGUgYWdhaW5zdC4KICAgICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgdHJ1ZSBpZiB0aGUgYm9kaWVzIHdlcmUgc2VwYXJhdGVkLCBvdGhlcndpc2UgZmFsc2UuCiAgICAqLwogICAgc2VwYXJhdGVUaWxlWTogZnVuY3Rpb24gKGJvZHksIHRpbGUsIHNlcGFyYXRlKSB7CgogICAgICAgIC8vICBDYW4ndCBzZXBhcmF0ZSB0d28gaW1tb3ZhYmxlIG9iamVjdHMgKHRpbGVzIGFyZSBhbHdheXMgaW1tb3ZhYmxlKQogICAgICAgIGlmIChib2R5LmltbW92YWJsZSB8fCBib2R5LmRlbHRhWSgpID09IDAgfHwgUGhhc2VyLlJlY3RhbmdsZS5pbnRlcnNlY3RzKGJvZHkuaHVsbFksIHRpbGUpID09IGZhbHNlKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CgogICAgICAgIC8vICBUaGUgaHVsbHMgb3ZlcmxhcCwgbGV0J3MgcHJvY2VzcyBpdAogICAgICAgIC8vIHRoaXMuX21heE92ZXJsYXAgPSBib2R5LmRlbHRhQWJzWSgpICsgdGhpcy5PVkVSTEFQX0JJQVM7CgogICAgICAgIGlmIChib2R5LmRlbHRhWSgpIDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIC8vICBNb3ZpbmcgdXAKICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IHRpbGUuYm90dG9tIC0gYm9keS5odWxsWS55OwoKICAgICAgICAgICAgLy8gaWYgKCh0aGlzLl9vdmVybGFwID4gdGhpcy5fbWF4T3ZlcmxhcCkgfHwgYm9keS5hbGxvd0NvbGxpc2lvbi51cCA9PSBmYWxzZSB8fCB0aWxlLnRpbGUuY29sbGlkZURvd24gPT0gZmFsc2UpCiAgICAgICAgICAgIGlmIChib2R5LmFsbG93Q29sbGlzaW9uLnVwID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlRG93biA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5LnRvdWNoaW5nLnVwID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICAvLyAgTW92aW5nIGRvd24KICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IGJvZHkuaHVsbFkuYm90dG9tIC0gdGlsZS55OwoKICAgICAgICAgICAgLy8gaWYgKCh0aGlzLl9vdmVybGFwID4gdGhpcy5fbWF4T3ZlcmxhcCkgfHwgYm9keS5hbGxvd0NvbGxpc2lvbi5kb3duID09IGZhbHNlIHx8IHRpbGUudGlsZS5jb2xsaWRlVXAgPT0gZmFsc2UpCiAgICAgICAgICAgIGlmIChib2R5LmFsbG93Q29sbGlzaW9uLmRvd24gPT0gZmFsc2UgfHwgdGlsZS50aWxlLmNvbGxpZGVVcCA9PSBmYWxzZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fb3ZlcmxhcCA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBib2R5LnRvdWNoaW5nLmRvd24gPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAvLyAgVGhlbiBhZGp1c3QgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yZGluZ2x5IChpZiB0aGVyZSB3YXMgYW55IG92ZXJsYXApCiAgICAgICAgaWYgKHRoaXMuX292ZXJsYXAgIT0gMCkKICAgICAgICB7CiAgICAgICAgICAgIGlmIChzZXBhcmF0ZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaWYgKGJvZHkuZGVsdGFZKCkgPCAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkueSA9IGJvZHkueSArIHRoaXMuX292ZXJsYXA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keS55ID0gYm9keS55IC0gdGhpcy5fb3ZlcmxhcDsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBpZiAoYm9keS5ib3VuY2UueSA9PSAwKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIGJvZHkudmVsb2NpdHkueSA9IDA7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYm9keS52ZWxvY2l0eS55ID0gLWJvZHkudmVsb2NpdHkueSAqIGJvZHkuYm91bmNlLnk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgYm9keS51cGRhdGVIdWxscygpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBNb3ZlIHRoZSBnaXZlbiBkaXNwbGF5IG9iamVjdCB0b3dhcmRzIHRoZSBkZXN0aW5hdGlvbiBvYmplY3QgYXQgYSBzdGVhZHkgdmVsb2NpdHkuCiAgICAqIElmIHlvdSBzcGVjaWZ5IGEgbWF4VGltZSB0aGVuIGl0IHdpbGwgYWRqdXN0IHRoZSBzcGVlZCAob3Zlci13cml0aW5nIHdoYXQgeW91IHNldCkgc28gaXQgYXJyaXZlcyBhdCB0aGUgZGVzdGluYXRpb24gaW4gdGhhdCBudW1iZXIgb2Ygc2Vjb25kcy4KICAgICogVGltaW5ncyBhcmUgYXBwcm94aW1hdGUgZHVlIHRvIHRoZSB3YXkgYnJvd3NlciB0aW1lcnMgd29yay4gQWxsb3cgZm9yIGEgdmFyaWFuY2Ugb2YgKy0gNTBtcy4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiBOb3RlOiBEb2Vzbid0IHRha2UgaW50byBhY2NvdW50IGFjY2VsZXJhdGlvbiwgbWF4VmVsb2NpdHkgb3IgZHJhZyAoaWYgeW91J3ZlIHNldCBkcmFnIG9yIGFjY2VsZXJhdGlvbiB0b28gaGlnaCB0aGlzIG9iamVjdCBtYXkgbm90IG1vdmUgYXQgYWxsKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjbW92ZVRvT2JqZWN0CiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIGRpc3BsYXkgb2JqZWN0IHRvIG1vdmUuCiAgICAqIEBwYXJhbSB7YW55fSBkZXN0aW5hdGlvbiAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlIHRvd2FyZHMuIENhbiBiZSBhbnkgb2JqZWN0IGJ1dCBtdXN0IGhhdmUgdmlzaWJsZSB4L3kgcHJvcGVydGllcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCAoZGVmYXVsdCBpcyA2MCBwaXhlbHMvc2VjKQogICAgKiBAcGFyYW0ge251bWJlcn0gW21heFRpbWU9MF0gLSBUaW1lIGdpdmVuIGluIG1pbGxpc2Vjb25kcyAoMTAwMCA9IDEgc2VjKS4gSWYgc2V0IHRoZSBzcGVlZCBpcyBhZGp1c3RlZCBzbyB0aGUgb2JqZWN0IHdpbGwgYXJyaXZlIGF0IGRlc3RpbmF0aW9uIGluIHRoZSBnaXZlbiBudW1iZXIgb2YgbXMuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHZlbG9jaXR5LgogICAgKi8KICAgIG1vdmVUb09iamVjdDogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIGRlc3RpbmF0aW9uLCBzcGVlZCwgbWF4VGltZSkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBtYXhUaW1lID09PSAndW5kZWZpbmVkJykgeyBtYXhUaW1lID0gMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IE1hdGguYXRhbjIoZGVzdGluYXRpb24ueSAtIGRpc3BsYXlPYmplY3QueSwgZGVzdGluYXRpb24ueCAtIGRpc3BsYXlPYmplY3QueCk7CiAgICAgICAgCiAgICAgICAgaWYgKG1heFRpbWUgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdlIGtub3cgaG93IG1hbnkgcGl4ZWxzIHdlIG5lZWQgdG8gbW92ZSwgYnV0IGhvdyBmYXN0PwogICAgICAgICAgICBzcGVlZCA9IHRoaXMuZGlzdGFuY2VCZXR3ZWVuKGRpc3BsYXlPYmplY3QsIGRlc3RpbmF0aW9uKSAvIChtYXhUaW1lIC8gMTAwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS54ID0gTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQ7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnkgPSBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1vdmUgdGhlIGdpdmVuIGRpc3BsYXkgb2JqZWN0IHRvd2FyZHMgdGhlIHBvaW50ZXIgYXQgYSBzdGVhZHkgdmVsb2NpdHkuIElmIG5vIHBvaW50ZXIgaXMgZ2l2ZW4gaXQgd2lsbCB1c2UgUGhhc2VyLklucHV0LmFjdGl2ZVBvaW50ZXIuCiAgICAqIElmIHlvdSBzcGVjaWZ5IGEgbWF4VGltZSB0aGVuIGl0IHdpbGwgYWRqdXN0IHRoZSBzcGVlZCAob3Zlci13cml0aW5nIHdoYXQgeW91IHNldCkgc28gaXQgYXJyaXZlcyBhdCB0aGUgZGVzdGluYXRpb24gaW4gdGhhdCBudW1iZXIgb2Ygc2Vjb25kcy4KICAgICogVGltaW5ncyBhcmUgYXBwcm94aW1hdGUgZHVlIHRvIHRoZSB3YXkgYnJvd3NlciB0aW1lcnMgd29yay4gQWxsb3cgZm9yIGEgdmFyaWFuY2Ugb2YgKy0gNTBtcy4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXMgbm90IGNvbnRpbnVvdXNseSB0cmFjayB0aGUgdGFyZ2V0LiBJZiB0aGUgdGFyZ2V0IGNoYW5nZXMgbG9jYXRpb24gZHVyaW5nIHRyYW5zaXQgdGhlIGRpc3BsYXkgb2JqZWN0IHdpbGwgbm90IG1vZGlmeSBpdHMgY291cnNlLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lc24ndCBzdG9wIG1vdmluZyBvbmNlIGl0IHJlYWNoZXMgdGhlIGRlc3RpbmF0aW9uIGNvb3JkaW5hdGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjbW92ZVRvUG9pbnRlcgogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIChkZWZhdWx0IGlzIDYwIHBpeGVscy9zZWMpCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50ZXJ9IFtwb2ludGVyXSAtIFRoZSBwb2ludGVyIHRvIG1vdmUgdG93YXJkcy4gRGVmYXVsdHMgdG8gUGhhc2VyLklucHV0LmFjdGl2ZVBvaW50ZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4VGltZT0wXSAtIFRpbWUgZ2l2ZW4gaW4gbWlsbGlzZWNvbmRzICgxMDAwID0gMSBzZWMpLiBJZiBzZXQgdGhlIHNwZWVkIGlzIGFkanVzdGVkIHNvIHRoZSBvYmplY3Qgd2lsbCBhcnJpdmUgYXQgZGVzdGluYXRpb24gaW4gdGhlIGdpdmVuIG51bWJlciBvZiBtcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdmVsb2NpdHkuCiAgICAqLwogICAgbW92ZVRvUG9pbnRlcjogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHNwZWVkLCBwb2ludGVyLCBtYXhUaW1lKSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlcjsKICAgICAgICBpZiAodHlwZW9mIG1heFRpbWUgPT09ICd1bmRlZmluZWQnKSB7IG1heFRpbWUgPSAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gdGhpcy5hbmdsZVRvUG9pbnRlcihkaXNwbGF5T2JqZWN0LCBwb2ludGVyKTsKICAgICAgICAKICAgICAgICBpZiAobWF4VGltZSA+IDApCiAgICAgICAgewogICAgICAgICAgICAvLyAgV2Uga25vdyBob3cgbWFueSBwaXhlbHMgd2UgbmVlZCB0byBtb3ZlLCBidXQgaG93IGZhc3Q/CiAgICAgICAgICAgIHNwZWVkID0gdGhpcy5kaXN0YW5jZVRvUG9pbnRlcihkaXNwbGF5T2JqZWN0LCBwb2ludGVyKSAvIChtYXhUaW1lIC8gMTAwMCk7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS52ZWxvY2l0eS54ID0gTWF0aC5jb3ModGhpcy5fYW5nbGUpICogc3BlZWQ7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnkgPSBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZDsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIE1vdmUgdGhlIGdpdmVuIGRpc3BsYXkgb2JqZWN0IHRvd2FyZHMgdGhlIHgveSBjb29yZGluYXRlcyBhdCBhIHN0ZWFkeSB2ZWxvY2l0eS4KICAgICogSWYgeW91IHNwZWNpZnkgYSBtYXhUaW1lIHRoZW4gaXQgd2lsbCBhZGp1c3QgdGhlIHNwZWVkIChvdmVyLXdyaXRpbmcgd2hhdCB5b3Ugc2V0KSBzbyBpdCBhcnJpdmVzIGF0IHRoZSBkZXN0aW5hdGlvbiBpbiB0aGF0IG51bWJlciBvZiBzZWNvbmRzLgogICAgKiBUaW1pbmdzIGFyZSBhcHByb3hpbWF0ZSBkdWUgdG8gdGhlIHdheSBicm93c2VyIHRpbWVycyB3b3JrLiBBbGxvdyBmb3IgYSB2YXJpYW5jZSBvZiArLSA1MG1zLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIE5vdGU6IERvZXNuJ3QgdGFrZSBpbnRvIGFjY291bnQgYWNjZWxlcmF0aW9uLCBtYXhWZWxvY2l0eSBvciBkcmFnIChpZiB5b3UndmUgc2V0IGRyYWcgb3IgYWNjZWxlcmF0aW9uIHRvbyBoaWdoIHRoaXMgb2JqZWN0IG1heSBub3QgbW92ZSBhdCBhbGwpCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNtb3ZlVG9YWQogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gbW92ZSB0b3dhcmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gbW92ZSB0b3dhcmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIChkZWZhdWx0IGlzIDYwIHBpeGVscy9zZWMpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4VGltZT0wXSAtIFRpbWUgZ2l2ZW4gaW4gbWlsbGlzZWNvbmRzICgxMDAwID0gMSBzZWMpLiBJZiBzZXQgdGhlIHNwZWVkIGlzIGFkanVzdGVkIHNvIHRoZSBvYmplY3Qgd2lsbCBhcnJpdmUgYXQgZGVzdGluYXRpb24gaW4gdGhlIGdpdmVuIG51bWJlciBvZiBtcy4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdmVsb2NpdHkuCiAgICAqLwogICAgbW92ZVRvWFk6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCB4LCB5LCBzcGVlZCwgbWF4VGltZSkgewoKICAgICAgICBpZiAodHlwZW9mIHNwZWVkID09PSAndW5kZWZpbmVkJykgeyBzcGVlZCA9IDYwOyB9CiAgICAgICAgaWYgKHR5cGVvZiBtYXhUaW1lID09PSAndW5kZWZpbmVkJykgeyBtYXhUaW1lID0gMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IE1hdGguYXRhbjIoeSAtIGRpc3BsYXlPYmplY3QueSwgeCAtIGRpc3BsYXlPYmplY3QueCk7CiAgICAgICAgCiAgICAgICAgaWYgKG1heFRpbWUgPiAwKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIFdlIGtub3cgaG93IG1hbnkgcGl4ZWxzIHdlIG5lZWQgdG8gbW92ZSwgYnV0IGhvdyBmYXN0PwogICAgICAgICAgICBzcGVlZCA9IHRoaXMuZGlzdGFuY2VUb1hZKGRpc3BsYXlPYmplY3QsIHgsIHkpIC8gKG1heFRpbWUgLyAxMDAwKTsKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LnZlbG9jaXR5LnggPSBNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZDsKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkudmVsb2NpdHkueSA9IE1hdGguc2luKHRoaXMuX2FuZ2xlKSAqIHNwZWVkOwoKICAgICAgICByZXR1cm4gdGhpcy5fYW5nbGU7CgogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gdGhlIGFuZ2xlIChpbiBkZWdyZWVzKSBhbmQgc3BlZWQgY2FsY3VsYXRlIHRoZSB2ZWxvY2l0eSBhbmQgcmV0dXJuIGl0IGFzIGEgUG9pbnQgb2JqZWN0LCBvciBzZXQgaXQgdG8gdGhlIGdpdmVuIHBvaW50IG9iamVjdC4KICAgICogT25lIHdheSB0byB1c2UgdGhpcyBpczogdmVsb2NpdHlGcm9tQW5nbGUoYW5nbGUsIDIwMCwgc3ByaXRlLnZlbG9jaXR5KSB3aGljaCB3aWxsIHNldCB0aGUgdmFsdWVzIGRpcmVjdGx5IHRvIHRoZSBzcHJpdGVzIHZlbG9jaXR5IGFuZCBub3QgY3JlYXRlIGEgbmV3IFBvaW50IG9iamVjdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3ZlbG9jaXR5RnJvbUFuZ2xlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBhbmdsZSAtIFRoZSBhbmdsZSBpbiBkZWdyZWVzIGNhbGN1bGF0ZWQgaW4gY2xvY2t3aXNlIHBvc2l0aXZlIGRpcmVjdGlvbiAoZG93biA9IDkwIGRlZ3JlZXMgcG9zaXRpdmUsIHJpZ2h0ID0gMCBkZWdyZWVzIHBvc2l0aXZlLCB1cCA9IDkwIGRlZ3JlZXMgbmVnYXRpdmUpCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgbW92ZSwgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuCiAgICAqIEBwYXJhbSB7UGhhc2VyLlBvaW50fG9iamVjdH0gW3BvaW50XSAtIFRoZSBQb2ludCBvYmplY3QgaW4gd2hpY2ggdGhlIHggYW5kIHkgcHJvcGVydGllcyB3aWxsIGJlIHNldCB0byB0aGUgY2FsY3VsYXRlZCB2ZWxvY2l0eS4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSAtIEEgUG9pbnQgd2hlcmUgcG9pbnQueCBjb250YWlucyB0aGUgdmVsb2NpdHkgeCB2YWx1ZSBhbmQgcG9pbnQueSBjb250YWlucyB0aGUgdmVsb2NpdHkgeSB2YWx1ZS4KICAgICovCiAgICB2ZWxvY2l0eUZyb21BbmdsZTogZnVuY3Rpb24gKGFuZ2xlLCBzcGVlZCwgcG9pbnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIHBvaW50ID0gcG9pbnQgfHwgbmV3IFBoYXNlci5Qb2ludDsKCiAgICAgICAgcmV0dXJuIHBvaW50LnNldFRvKChNYXRoLmNvcyh0aGlzLmdhbWUubWF0aC5kZWdUb1JhZChhbmdsZSkpICogc3BlZWQpLCAoTWF0aC5zaW4odGhpcy5nYW1lLm1hdGguZGVnVG9SYWQoYW5nbGUpKSAqIHNwZWVkKSk7CgogICAgfSwKCiAgICAvKioKICAgICogR2l2ZW4gdGhlIHJvdGF0aW9uIChpbiByYWRpYW5zKSBhbmQgc3BlZWQgY2FsY3VsYXRlIHRoZSB2ZWxvY2l0eSBhbmQgcmV0dXJuIGl0IGFzIGEgUG9pbnQgb2JqZWN0LCBvciBzZXQgaXQgdG8gdGhlIGdpdmVuIHBvaW50IG9iamVjdC4KICAgICogT25lIHdheSB0byB1c2UgdGhpcyBpczogdmVsb2NpdHlGcm9tUm90YXRpb24ocm90YXRpb24sIDIwMCwgc3ByaXRlLnZlbG9jaXR5KSB3aGljaCB3aWxsIHNldCB0aGUgdmFsdWVzIGRpcmVjdGx5IHRvIHRoZSBzcHJpdGVzIHZlbG9jaXR5IGFuZCBub3QgY3JlYXRlIGEgbmV3IFBvaW50IG9iamVjdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3ZlbG9jaXR5RnJvbVJvdGF0aW9uCiAgICAqIEBwYXJhbSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbmdsZSBpbiByYWRpYW5zLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIG1vdmUsIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludHxvYmplY3R9IFtwb2ludF0gLSBUaGUgUG9pbnQgb2JqZWN0IGluIHdoaWNoIHRoZSB4IGFuZCB5IHByb3BlcnRpZXMgd2lsbCBiZSBzZXQgdG8gdGhlIGNhbGN1bGF0ZWQgdmVsb2NpdHkuCiAgICAqIEByZXR1cm4ge1BoYXNlci5Qb2ludH0gLSBBIFBvaW50IHdoZXJlIHBvaW50LnggY29udGFpbnMgdGhlIHZlbG9jaXR5IHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIHZlbG9jaXR5IHkgdmFsdWUuCiAgICAqLwogICAgdmVsb2NpdHlGcm9tUm90YXRpb246IGZ1bmN0aW9uIChyb3RhdGlvbiwgc3BlZWQsIHBvaW50KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBwb2ludCA9IHBvaW50IHx8IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgICAgIHJldHVybiBwb2ludC5zZXRUbygoTWF0aC5jb3Mocm90YXRpb24pICogc3BlZWQpLCAoTWF0aC5zaW4ocm90YXRpb24pICogc3BlZWQpKTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBHaXZlbiB0aGUgcm90YXRpb24gKGluIHJhZGlhbnMpIGFuZCBzcGVlZCBjYWxjdWxhdGUgdGhlIGFjY2VsZXJhdGlvbiBhbmQgcmV0dXJuIGl0IGFzIGEgUG9pbnQgb2JqZWN0LCBvciBzZXQgaXQgdG8gdGhlIGdpdmVuIHBvaW50IG9iamVjdC4KICAgICogT25lIHdheSB0byB1c2UgdGhpcyBpczogdmVsb2NpdHlGcm9tUm90YXRpb24ocm90YXRpb24sIDIwMCwgc3ByaXRlLnZlbG9jaXR5KSB3aGljaCB3aWxsIHNldCB0aGUgdmFsdWVzIGRpcmVjdGx5IHRvIHRoZSBzcHJpdGVzIHZlbG9jaXR5IGFuZCBub3QgY3JlYXRlIGEgbmV3IFBvaW50IG9iamVjdC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FjY2VsZXJhdGlvbkZyb21Sb3RhdGlvbgogICAgKiBAcGFyYW0ge251bWJlcn0gcm90YXRpb24gLSBUaGUgYW5nbGUgaW4gcmFkaWFucy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBtb3ZlLCBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnR8b2JqZWN0fSBbcG9pbnRdIC0gVGhlIFBvaW50IG9iamVjdCBpbiB3aGljaCB0aGUgeCBhbmQgeSBwcm9wZXJ0aWVzIHdpbGwgYmUgc2V0IHRvIHRoZSBjYWxjdWxhdGVkIGFjY2VsZXJhdGlvbi4KICAgICogQHJldHVybiB7UGhhc2VyLlBvaW50fSAtIEEgUG9pbnQgd2hlcmUgcG9pbnQueCBjb250YWlucyB0aGUgYWNjZWxlcmF0aW9uIHggdmFsdWUgYW5kIHBvaW50LnkgY29udGFpbnMgdGhlIGFjY2VsZXJhdGlvbiB5IHZhbHVlLgogICAgKi8KICAgIGFjY2VsZXJhdGlvbkZyb21Sb3RhdGlvbjogZnVuY3Rpb24gKHJvdGF0aW9uLCBzcGVlZCwgcG9pbnQpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIHBvaW50ID0gcG9pbnQgfHwgbmV3IFBoYXNlci5Qb2ludDsKCiAgICAgICAgcmV0dXJuIHBvaW50LnNldFRvKChNYXRoLmNvcyhyb3RhdGlvbikgKiBzcGVlZCksIChNYXRoLnNpbihyb3RhdGlvbikgKiBzcGVlZCkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGFjY2VsZXJhdGlvbi54L3kgcHJvcGVydHkgb24gdGhlIGRpc3BsYXkgb2JqZWN0IHNvIGl0IHdpbGwgbW92ZSB0b3dhcmRzIHRoZSB0YXJnZXQgYXQgdGhlIGdpdmVuIHNwZWVkIChpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4pCiAgICAqIFlvdSBtdXN0IGdpdmUgYSBtYXhpbXVtIHNwZWVkIHZhbHVlLCBiZXlvbmQgd2hpY2ggdGhlIGRpc3BsYXkgb2JqZWN0IHdvbid0IGdvIGFueSBmYXN0ZXIuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FjY2VsZXJhdGVUb09iamVjdAogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge2FueX0gZGVzdGluYXRpb24gLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZSB0b3dhcmRzLiBDYW4gYmUgYW55IG9iamVjdCBidXQgbXVzdCBoYXZlIHZpc2libGUgeC95IHByb3BlcnRpZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbc3BlZWQ9NjBdIC0gVGhlIHNwZWVkIGl0IHdpbGwgYWNjZWxlcmF0ZSBpbiBwaXhlbHMgcGVyIHNlY29uZC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHggdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5U3BlZWRNYXg9NTAwXSAtIFRoZSBtYXhpbXVtIHkgdmVsb2NpdHkgdGhlIGRpc3BsYXkgb2JqZWN0IGNhbiByZWFjaC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgYW5nbGUgKGluIHJhZGlhbnMpIHRoYXQgdGhlIG9iamVjdCBzaG91bGQgYmUgdmlzdWFsbHkgc2V0IHRvIGluIG9yZGVyIHRvIG1hdGNoIGl0cyBuZXcgdHJhamVjdG9yeS4KICAgICovCiAgICBhY2NlbGVyYXRlVG9PYmplY3Q6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBkZXN0aW5hdGlvbiwgc3BlZWQsIHhTcGVlZE1heCwgeVNwZWVkTWF4KSB7CgogICAgICAgIGlmICh0eXBlb2Ygc3BlZWQgPT09ICd1bmRlZmluZWQnKSB7IHNwZWVkID0gNjA7IH0KICAgICAgICBpZiAodHlwZW9mIHhTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeFNwZWVkTWF4ID0gMTAwMDsgfQogICAgICAgIGlmICh0eXBlb2YgeVNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB5U3BlZWRNYXggPSAxMDAwOyB9CgogICAgICAgIHRoaXMuX2FuZ2xlID0gdGhpcy5hbmdsZUJldHdlZW4oZGlzcGxheU9iamVjdCwgZGVzdGluYXRpb24pOwoKICAgICAgICBkaXNwbGF5T2JqZWN0LmJvZHkuYWNjZWxlcmF0aW9uLnNldFRvKE1hdGguY29zKHRoaXMuX2FuZ2xlKSAqIHNwZWVkLCBNYXRoLnNpbih0aGlzLl9hbmdsZSkgKiBzcGVlZCk7CiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5Lm1heFZlbG9jaXR5LnNldFRvKHhTcGVlZE1heCwgeVNwZWVkTWF4KTsKCiAgICAgICAgcmV0dXJuIHRoaXMuX2FuZ2xlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFNldHMgdGhlIGFjY2VsZXJhdGlvbi54L3kgcHJvcGVydHkgb24gdGhlIGRpc3BsYXkgb2JqZWN0IHNvIGl0IHdpbGwgbW92ZSB0b3dhcmRzIHRoZSB0YXJnZXQgYXQgdGhlIGdpdmVuIHNwZWVkIChpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4pCiAgICAqIFlvdSBtdXN0IGdpdmUgYSBtYXhpbXVtIHNwZWVkIHZhbHVlLCBiZXlvbmQgd2hpY2ggdGhlIGRpc3BsYXkgb2JqZWN0IHdvbid0IGdvIGFueSBmYXN0ZXIuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2VzIG5vdCBjb250aW51b3VzbHkgdHJhY2sgdGhlIHRhcmdldC4gSWYgdGhlIHRhcmdldCBjaGFuZ2VzIGxvY2F0aW9uIGR1cmluZyB0cmFuc2l0IHRoZSBkaXNwbGF5IG9iamVjdCB3aWxsIG5vdCBtb2RpZnkgaXRzIGNvdXJzZS4KICAgICogTm90ZTogVGhlIGRpc3BsYXkgb2JqZWN0IGRvZXNuJ3Qgc3RvcCBtb3Zpbmcgb25jZSBpdCByZWFjaGVzIHRoZSBkZXN0aW5hdGlvbiBjb29yZGluYXRlcy4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FjY2VsZXJhdGVUb1BvaW50ZXIKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgZGlzcGxheSBvYmplY3QgdG8gbW92ZS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gW3BvaW50ZXJdIC0gVGhlIHBvaW50ZXIgdG8gbW92ZSB0b3dhcmRzLiBEZWZhdWx0cyB0byBQaGFzZXIuSW5wdXQuYWN0aXZlUG9pbnRlci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtzcGVlZD02MF0gLSBUaGUgc3BlZWQgaXQgd2lsbCBhY2NlbGVyYXRlIGluIHBpeGVscyBwZXIgc2Vjb25kLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geCB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3lTcGVlZE1heD01MDBdIC0gVGhlIG1heGltdW0geSB2ZWxvY2l0eSB0aGUgZGlzcGxheSBvYmplY3QgY2FuIHJlYWNoLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhbmdsZSAoaW4gcmFkaWFucykgdGhhdCB0aGUgb2JqZWN0IHNob3VsZCBiZSB2aXN1YWxseSBzZXQgdG8gaW4gb3JkZXIgdG8gbWF0Y2ggaXRzIG5ldyB0cmFqZWN0b3J5LgogICAgKi8KICAgIGFjY2VsZXJhdGVUb1BvaW50ZXI6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCBwb2ludGVyLCBzcGVlZCwgeFNwZWVkTWF4LCB5U3BlZWRNYXgpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgcG9pbnRlciA9PT0gJ3VuZGVmaW5lZCcpIHsgcG9pbnRlciA9IHRoaXMuZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyOyB9CiAgICAgICAgaWYgKHR5cGVvZiB4U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHhTcGVlZE1heCA9IDEwMDA7IH0KICAgICAgICBpZiAodHlwZW9mIHlTcGVlZE1heCA9PT0gJ3VuZGVmaW5lZCcpIHsgeVNwZWVkTWF4ID0gMTAwMDsgfQoKICAgICAgICB0aGlzLl9hbmdsZSA9IHRoaXMuYW5nbGVUb1BvaW50ZXIoZGlzcGxheU9iamVjdCwgcG9pbnRlcik7CiAgICAgICAgCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LmFjY2VsZXJhdGlvbi5zZXRUbyhNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZCwgTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQpOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5tYXhWZWxvY2l0eS5zZXRUbyh4U3BlZWRNYXgsIHlTcGVlZE1heCk7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXRzIHRoZSBhY2NlbGVyYXRpb24ueC95IHByb3BlcnR5IG9uIHRoZSBkaXNwbGF5IG9iamVjdCBzbyBpdCB3aWxsIG1vdmUgdG93YXJkcyB0aGUgeC95IGNvb3JkaW5hdGVzIGF0IHRoZSBnaXZlbiBzcGVlZCAoaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuKQogICAgKiBZb3UgbXVzdCBnaXZlIGEgbWF4aW11bSBzcGVlZCB2YWx1ZSwgYmV5b25kIHdoaWNoIHRoZSBkaXNwbGF5IG9iamVjdCB3b24ndCBnbyBhbnkgZmFzdGVyLgogICAgKiBOb3RlOiBUaGUgZGlzcGxheSBvYmplY3QgZG9lcyBub3QgY29udGludW91c2x5IHRyYWNrIHRoZSB0YXJnZXQuIElmIHRoZSB0YXJnZXQgY2hhbmdlcyBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdCB0aGUgZGlzcGxheSBvYmplY3Qgd2lsbCBub3QgbW9kaWZ5IGl0cyBjb3Vyc2UuCiAgICAqIE5vdGU6IFRoZSBkaXNwbGF5IG9iamVjdCBkb2Vzbid0IHN0b3AgbW92aW5nIG9uY2UgaXQgcmVhY2hlcyB0aGUgZGVzdGluYXRpb24gY29vcmRpbmF0ZXMuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhY2NlbGVyYXRlVG9YWQogICAgKiBAcGFyYW0ge2FueX0gZGlzcGxheU9iamVjdCAtIFRoZSBkaXNwbGF5IG9iamVjdCB0byBtb3ZlLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gYWNjZWxlcmF0ZSB0b3dhcmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gYWNjZWxlcmF0ZSB0b3dhcmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3NwZWVkPTYwXSAtIFRoZSBzcGVlZCBpdCB3aWxsIGFjY2VsZXJhdGUgaW4gcGl4ZWxzIHBlciBzZWNvbmQuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeFNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB4IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeVNwZWVkTWF4PTUwMF0gLSBUaGUgbWF4aW11bSB5IHZlbG9jaXR5IHRoZSBkaXNwbGF5IG9iamVjdCBjYW4gcmVhY2guCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIChpbiByYWRpYW5zKSB0aGF0IHRoZSBvYmplY3Qgc2hvdWxkIGJlIHZpc3VhbGx5IHNldCB0byBpbiBvcmRlciB0byBtYXRjaCBpdHMgbmV3IHRyYWplY3RvcnkuCiAgICAqLwogICAgYWNjZWxlcmF0ZVRvWFk6IGZ1bmN0aW9uIChkaXNwbGF5T2JqZWN0LCB4LCB5LCBzcGVlZCwgeFNwZWVkTWF4LCB5U3BlZWRNYXgpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBzcGVlZCA9PT0gJ3VuZGVmaW5lZCcpIHsgc3BlZWQgPSA2MDsgfQogICAgICAgIGlmICh0eXBlb2YgeFNwZWVkTWF4ID09PSAndW5kZWZpbmVkJykgeyB4U3BlZWRNYXggPSAxMDAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB5U3BlZWRNYXggPT09ICd1bmRlZmluZWQnKSB7IHlTcGVlZE1heCA9IDEwMDA7IH0KCiAgICAgICAgdGhpcy5fYW5nbGUgPSB0aGlzLmFuZ2xlVG9YWShkaXNwbGF5T2JqZWN0LCB4LCB5KTsKCiAgICAgICAgZGlzcGxheU9iamVjdC5ib2R5LmFjY2VsZXJhdGlvbi5zZXRUbyhNYXRoLmNvcyh0aGlzLl9hbmdsZSkgKiBzcGVlZCwgTWF0aC5zaW4odGhpcy5fYW5nbGUpICogc3BlZWQpOwogICAgICAgIGRpc3BsYXlPYmplY3QuYm9keS5tYXhWZWxvY2l0eS5zZXRUbyh4U3BlZWRNYXgsIHlTcGVlZE1heCk7CgogICAgICAgIHJldHVybiB0aGlzLl9hbmdsZTsKCiAgICB9LAoKICAgIC8qKgogICAgKiBGaW5kIHRoZSBkaXN0YW5jZSBiZXR3ZWVuIHR3byBkaXNwbGF5IG9iamVjdHMgKGxpa2UgU3ByaXRlcykuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNkaXN0YW5jZUJldHdlZW4KICAgICogQHBhcmFtIHthbnl9IHNvdXJjZSAtIFRoZSBEaXNwbGF5IE9iamVjdCB0byB0ZXN0IGZyb20uCiAgICAqIEBwYXJhbSB7YW55fSB0YXJnZXQgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCB0by4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgc291cmNlIGFuZCB0YXJnZXQgb2JqZWN0cy4KICAgICovCiAgICBkaXN0YW5jZUJldHdlZW46IGZ1bmN0aW9uIChzb3VyY2UsIHRhcmdldCkgewoKICAgICAgICB0aGlzLl9keCA9IHNvdXJjZS54IC0gdGFyZ2V0Lng7CiAgICAgICAgdGhpcy5fZHkgPSBzb3VyY2UueSAtIHRhcmdldC55OwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5fZHggKiB0aGlzLl9keCArIHRoaXMuX2R5ICogdGhpcy5fZHkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGRpc3RhbmNlIGJldHdlZW4gYSBkaXNwbGF5IG9iamVjdCAobGlrZSBhIFNwcml0ZSkgYW5kIHRoZSBnaXZlbiB4L3kgY29vcmRpbmF0ZXMuCiAgICAqIFRoZSBjYWxjdWxhdGlvbiBpcyBtYWRlIGZyb20gdGhlIGRpc3BsYXkgb2JqZWN0cyB4L3kgY29vcmRpbmF0ZS4gVGhpcyBtYXkgYmUgdGhlIHRvcC1sZWZ0IGlmIGl0cyBhbmNob3IgaGFzbid0IGJlZW4gY2hhbmdlZC4KICAgICogSWYgeW91IG5lZWQgdG8gY2FsY3VsYXRlIGZyb20gdGhlIGNlbnRlciBvZiBhIGRpc3BsYXkgb2JqZWN0IGluc3RlYWQgdXNlIHRoZSBtZXRob2QgZGlzdGFuY2VCZXR3ZWVuQ2VudGVycygpCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNkaXN0YW5jZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gbW92ZSB0b3dhcmRzLgogICAgKiBAcGFyYW0ge251bWJlcn0geSAtIFRoZSB5IGNvb3JkaW5hdGUgdG8gbW92ZSB0b3dhcmRzLgogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBkaXN0YW5jZSBiZXR3ZWVuIHRoZSBvYmplY3QgYW5kIHRoZSB4L3kgY29vcmRpbmF0ZXMuCiAgICAqLwogICAgZGlzdGFuY2VUb1hZOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgeCwgeSkgewoKICAgICAgICB0aGlzLl9keCA9IGRpc3BsYXlPYmplY3QueCAtIHg7CiAgICAgICAgdGhpcy5fZHkgPSBkaXNwbGF5T2JqZWN0LnkgLSB5OwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5fZHggKiB0aGlzLl9keCArIHRoaXMuX2R5ICogdGhpcy5fZHkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGRpc3RhbmNlIGJldHdlZW4gYSBkaXNwbGF5IG9iamVjdCAobGlrZSBhIFNwcml0ZSkgYW5kIGEgUG9pbnRlci4gSWYgbm8gUG9pbnRlciBpcyBnaXZlbiB0aGUgSW5wdXQuYWN0aXZlUG9pbnRlciBpcyB1c2VkLgogICAgKiBUaGUgY2FsY3VsYXRpb24gaXMgbWFkZSBmcm9tIHRoZSBkaXNwbGF5IG9iamVjdHMgeC95IGNvb3JkaW5hdGUuIFRoaXMgbWF5IGJlIHRoZSB0b3AtbGVmdCBpZiBpdHMgYW5jaG9yIGhhc24ndCBiZWVuIGNoYW5nZWQuCiAgICAqIElmIHlvdSBuZWVkIHRvIGNhbGN1bGF0ZSBmcm9tIHRoZSBjZW50ZXIgb2YgYSBkaXNwbGF5IG9iamVjdCBpbnN0ZWFkIHVzZSB0aGUgbWV0aG9kIGRpc3RhbmNlQmV0d2VlbkNlbnRlcnMoKQogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjZGlzdGFuY2VUb1BvaW50ZXIKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge1BoYXNlci5Qb2ludGVyfSBbcG9pbnRlcl0gLSBUaGUgUGhhc2VyLlBvaW50ZXIgdG8gdGVzdCB0by4gSWYgbm9uZSBpcyBnaXZlbiB0aGVuIElucHV0LmFjdGl2ZVBvaW50ZXIgaXMgdXNlZC4KICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgb2JqZWN0IGFuZCB0aGUgUG9pbnRlci4KICAgICovCiAgICBkaXN0YW5jZVRvUG9pbnRlcjogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHBvaW50ZXIpIHsKCiAgICAgICAgcG9pbnRlciA9IHBvaW50ZXIgfHwgdGhpcy5nYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXI7CgogICAgICAgIHRoaXMuX2R4ID0gZGlzcGxheU9iamVjdC54IC0gcG9pbnRlci54OwogICAgICAgIHRoaXMuX2R5ID0gZGlzcGxheU9iamVjdC55IC0gcG9pbnRlci55OwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLnNxcnQodGhpcy5fZHggKiB0aGlzLl9keCArIHRoaXMuX2R5ICogdGhpcy5fZHkpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbmQgdGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiB0d28gZGlzcGxheSBvYmplY3RzIChsaWtlIFNwcml0ZXMpLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjYW5nbGVCZXR3ZWVuCiAgICAqIEBwYXJhbSB7YW55fSBzb3VyY2UgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge2FueX0gdGFyZ2V0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgdG8uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiB0aGUgc291cmNlIGFuZCB0YXJnZXQgZGlzcGxheSBvYmplY3RzLgogICAgKi8KICAgIGFuZ2xlQmV0d2VlbjogZnVuY3Rpb24gKHNvdXJjZSwgdGFyZ2V0KSB7CgogICAgICAgIHRoaXMuX2R4ID0gdGFyZ2V0LnggLSBzb3VyY2UueDsKICAgICAgICB0aGlzLl9keSA9IHRhcmdldC55IC0gc291cmNlLnk7CgogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHRoaXMuX2R5LCB0aGlzLl9keCk7CgogICAgfSwKCiAgICAvKioKICAgICogRmluZCB0aGUgYW5nbGUgaW4gcmFkaWFucyBiZXR3ZWVuIGEgZGlzcGxheSBvYmplY3QgKGxpa2UgYSBTcHJpdGUpIGFuZCB0aGUgZ2l2ZW4geC95IGNvb3JkaW5hdGUuCiAgICAqIAogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNhbmdsZVRvWFkKICAgICogQHBhcmFtIHthbnl9IGRpc3BsYXlPYmplY3QgLSBUaGUgRGlzcGxheSBPYmplY3QgdG8gdGVzdCBmcm9tLgogICAgKiBAcGFyYW0ge251bWJlcn0geCAtIFRoZSB4IGNvb3JkaW5hdGUgdG8gZ2V0IHRoZSBhbmdsZSB0by4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBUaGUgeSBjb29yZGluYXRlIHRvIGdldCB0aGUgYW5nbGUgdG8uCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiBkaXNwbGF5T2JqZWN0LngveSB0byBQb2ludGVyLngveQogICAgKi8KICAgIGFuZ2xlVG9YWTogZnVuY3Rpb24gKGRpc3BsYXlPYmplY3QsIHgsIHkpIHsKCiAgICAgICAgdGhpcy5fZHggPSB4IC0gZGlzcGxheU9iamVjdC54OwogICAgICAgIHRoaXMuX2R5ID0geSAtIGRpc3BsYXlPYmplY3QueTsKICAgICAgICAKICAgICAgICByZXR1cm4gTWF0aC5hdGFuMih0aGlzLl9keSwgdGhpcy5fZHgpOwoKICAgIH0sCiAgICAKICAgIC8qKgogICAgKiBGaW5kIHRoZSBhbmdsZSBpbiByYWRpYW5zIGJldHdlZW4gYSBkaXNwbGF5IG9iamVjdCAobGlrZSBhIFNwcml0ZSkgYW5kIGEgUG9pbnRlciwgdGFraW5nIHRoZWlyIHgveSBhbmQgY2VudGVyIGludG8gYWNjb3VudC4KICAgICogCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI2FuZ2xlVG9Qb2ludGVyCiAgICAqIEBwYXJhbSB7YW55fSBkaXNwbGF5T2JqZWN0IC0gVGhlIERpc3BsYXkgT2JqZWN0IHRvIHRlc3QgZnJvbS4KICAgICogQHBhcmFtIHtQaGFzZXIuUG9pbnRlcn0gW3BvaW50ZXJdIC0gVGhlIFBoYXNlci5Qb2ludGVyIHRvIHRlc3QgdG8uIElmIG5vbmUgaXMgZ2l2ZW4gdGhlbiBJbnB1dC5hY3RpdmVQb2ludGVyIGlzIHVzZWQuCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFuZ2xlIGluIHJhZGlhbnMgYmV0d2VlbiBkaXNwbGF5T2JqZWN0LngveSB0byBQb2ludGVyLngveQogICAgKi8KICAgIGFuZ2xlVG9Qb2ludGVyOiBmdW5jdGlvbiAoZGlzcGxheU9iamVjdCwgcG9pbnRlcikgewoKICAgICAgICBwb2ludGVyID0gcG9pbnRlciB8fCB0aGlzLmdhbWUuaW5wdXQuYWN0aXZlUG9pbnRlcjsKCiAgICAgICAgdGhpcy5fZHggPSBwb2ludGVyLndvcmxkWCAtIGRpc3BsYXlPYmplY3QueDsKICAgICAgICB0aGlzLl9keSA9IHBvaW50ZXIud29ybGRZIC0gZGlzcGxheU9iamVjdC55OwogICAgICAgIAogICAgICAgIHJldHVybiBNYXRoLmF0YW4yKHRoaXMuX2R5LCB0aGlzLl9keCk7CgogICAgfQoKfTsKCi8qKgoqIEBhdXRob3IgICAgICAgUmljaGFyZCBEYXZleSA8cmljaEBwaG90b25zdG9ybS5jb20+CiogQGNvcHlyaWdodCAgICAyMDEzIFBob3RvbiBTdG9ybSBMdGQuCiogQGxpY2Vuc2UgICAgICB7QGxpbmsgaHR0cHM6Ly9naXRodWIuY29tL3Bob3RvbnN0b3JtL3BoYXNlci9ibG9iL21hc3Rlci9saWNlbnNlLnR4dHxNSVQgTGljZW5zZX0KKi8KCi8qKgoqIFRoZSBQaHlzaWNzIEJvZHkgaXMgbGlua2VkIHRvIGEgc2luZ2xlIFNwcml0ZS4gQWxsIHBoeXNpY3Mgb3BlcmF0aW9ucyBzaG91bGQgYmUgcGVyZm9ybWVkIGFnYWluc3QgdGhlIGJvZHkgcmF0aGVyIHRoYW4KKiB0aGUgU3ByaXRlIGl0c2VsZi4gRm9yIGV4YW1wbGUgeW91IGNhbiBzZXQgdGhlIHZlbG9jaXR5LCBhY2NlbGVyYXRpb24sIGJvdW5jZSB2YWx1ZXMgZXRjIGFsbCBvbiB0aGUgQm9keS4KKgoqIEBjbGFzcyBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keQoqIEBjbGFzc2Rlc2MgQXJjYWRlIFBoeXNpY3MgQm9keSBDb25zdHJ1Y3RvcgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gVGhlIFNwcml0ZSBvYmplY3QgdGhpcyBwaHlzaWNzIGJvZHkgYmVsb25ncyB0by4KKi8KUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkgPSBmdW5jdGlvbiAoc3ByaXRlKSB7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlNwcml0ZX0gc3ByaXRlIC0gUmVmZXJlbmNlIHRvIHRoZSBwYXJlbnQgU3ByaXRlLgogICAgKi8KCXRoaXMuc3ByaXRlID0gc3ByaXRlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gTG9jYWwgcmVmZXJlbmNlIHRvIGdhbWUuCiAgICAqLwoJdGhpcy5nYW1lID0gc3ByaXRlLmdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBvZmZzZXQgLSBUaGUgb2Zmc2V0IG9mIHRoZSBQaHlzaWNzIEJvZHkgZnJvbSB0aGUgU3ByaXRlIHgveSBwb3NpdGlvbi4KICAgICovCgl0aGlzLm9mZnNldCA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHggcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy54ID0gc3ByaXRlLng7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHkgcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy55ID0gc3ByaXRlLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVYIC0gVGhlIHByZXZpb3VzIHggcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy5wcmVYID0gc3ByaXRlLng7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVZIC0gVGhlIHByZXZpb3VzIHkgcG9zaXRpb24gb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICogQHJlYWRvbmx5CiAgICAqLwoJdGhpcy5wcmVZID0gc3ByaXRlLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBwcmVSb3RhdGlvbiAtIFRoZSBwcmV2aW91cyByb3RhdGlvbiBvZiB0aGUgcGh5c2ljcyBib2R5LgogICAgKiBAcmVhZG9ubHkKICAgICovCgl0aGlzLnByZVJvdGF0aW9uID0gc3ByaXRlLmFuZ2xlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2NyZWVuWCAtIFRoZSB4IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkgdHJhbnNsYXRlZCB0byBzY3JlZW4gc3BhY2UuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMuc2NyZWVuWCA9IHNwcml0ZS54OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc2NyZWVuWSAtIFRoZSB5IHBvc2l0aW9uIG9mIHRoZSBwaHlzaWNzIGJvZHkgdHJhbnNsYXRlZCB0byBzY3JlZW4gc3BhY2UuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMuc2NyZWVuWSA9IHNwcml0ZS55OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlV2lkdGggLSBUaGUgdW4tc2NhbGVkIG9yaWdpbmFsIHNpemUuCiAgICAqIEByZWFkb25seQogICAgKi8KCXRoaXMuc291cmNlV2lkdGggPSBzcHJpdGUuY3VycmVudEZyYW1lLnNvdXJjZVNpemVXOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gc291cmNlSGVpZ2h0IC0gVGhlIHVuLXNjYWxlZCBvcmlnaW5hbCBzaXplLgogICAgKiBAcmVhZG9ubHkKICAgICovCgl0aGlzLnNvdXJjZUhlaWdodCA9IHNwcml0ZS5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB3aWR0aCAtIFRoZSBjYWxjdWxhdGVkIHdpZHRoIG9mIHRoZSBwaHlzaWNzIGJvZHkuCiAgICAqLwoJdGhpcy53aWR0aCA9IHNwcml0ZS5jdXJyZW50RnJhbWUuc291cmNlU2l6ZVc7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSAubnVtSW50ZXJuYWwgSUQgY2FjaGUKICAgICovCgl0aGlzLmhlaWdodCA9IHNwcml0ZS5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUg7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBoYWxmV2lkdGggLSBUaGUgY2FsY3VsYXRlZCB3aWR0aCAvIDIgb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICovCgl0aGlzLmhhbGZXaWR0aCA9IE1hdGguZmxvb3Ioc3ByaXRlLmN1cnJlbnRGcmFtZS5zb3VyY2VTaXplVyAvIDIpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGFsZkhlaWdodCAtIFRoZSBjYWxjdWxhdGVkIGhlaWdodCAvIDIgb2YgdGhlIHBoeXNpY3MgYm9keS4KICAgICovCgl0aGlzLmhhbGZIZWlnaHQgPSBNYXRoLmZsb29yKHNwcml0ZS5jdXJyZW50RnJhbWUuc291cmNlU2l6ZUggLyAyKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGNlbnRlciAtIFRoZSBjZW50ZXIgY29vcmRpbmF0ZSBvZiB0aGUgUGh5c2ljcyBCb2R5LgogICAgKi8KICAgIHRoaXMuY2VudGVyID0gbmV3IFBoYXNlci5Qb2ludCh0aGlzLnggKyB0aGlzLmhhbGZXaWR0aCwgdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0KTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zeCAtIEludGVybmFsIGNhY2hlIHZhci4KICAgICogQHByaXZhdGUKICAgICovCgl0aGlzLl9zeCA9IHNwcml0ZS5zY2FsZS54OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N5IC0gSW50ZXJuYWwgY2FjaGUgdmFyLgogICAgKiBAcHJpdmF0ZQogICAgKi8KCXRoaXMuX3N5ID0gc3ByaXRlLnNjYWxlLnk7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSB2ZWxvY2l0eSAtIFRoZSB2ZWxvY2l0eSBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gb2YgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy52ZWxvY2l0eSA9IG5ldyBQaGFzZXIuUG9pbnQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7UGhhc2VyLlBvaW50fSBhY2NlbGVyYXRpb24gLSBUaGUgdmVsb2NpdHkgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIG9mIHRoZSBCb2R5LgogICAgKi8KICAgIHRoaXMuYWNjZWxlcmF0aW9uID0gbmV3IFBoYXNlci5Qb2ludDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGRyYWcgLSBUaGUgZHJhZyBhcHBsaWVkIHRvIHRoZSBtb3Rpb24gb2YgdGhlIEJvZHkuCiAgICAqLwogICAgdGhpcy5kcmFnID0gbmV3IFBoYXNlci5Qb2ludDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGdyYXZpdHkgLSBBIHByaXZhdGUgR3Jhdml0eSBzZXR0aW5nIGZvciB0aGUgQm9keS4KICAgICovCiAgICB0aGlzLmdyYXZpdHkgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gYm91bmNlIC0gVGhlIGVsYXN0aWNpdGl5IG9mIHRoZSBCb2R5IHdoZW4gY29sbGlkaW5nLiBib3VuY2UueC95ID0gMSBtZWFucyBmdWxsIHJlYm91bmQsIGJvdW5jZS54L3kgPSAwLjUgbWVhbnMgNTAlIHJlYm91bmQgdmVsb2NpdHkuCiAgICAqLwogICAgdGhpcy5ib3VuY2UgPSBuZXcgUGhhc2VyLlBvaW50OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gbWF4VmVsb2NpdHkgLSBUaGUgbWF4aW11bSB2ZWxvY2l0eSBpbiBwaXhlbHMgcGVyIHNlY29uZCBzcS4gdGhhdCB0aGUgQm9keSBjYW4gcmVhY2guCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXhWZWxvY2l0eSA9IG5ldyBQaGFzZXIuUG9pbnQoMTAwMDAsIDEwMDAwKTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJWZWxvY2l0eSAtIFRoZSBhbmd1bGFyIHZlbG9jaXR5IGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLiBvZiB0aGUgQm9keS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZ3VsYXJWZWxvY2l0eSA9IDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbmd1bGFyQWNjZWxlcmF0aW9uIC0gVGhlIGFuZ3VsYXIgYWNjZWxlcmF0aW9uIGluIHBpeGVscyBwZXIgc2Vjb25kIHNxLiBvZiB0aGUgQm9keS4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmFuZ3VsYXJBY2NlbGVyYXRpb24gPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gYW5ndWxhckRyYWcgLSBUaGUgYW5ndWxhciBkcmFnIGFwcGxpZWQgdG8gdGhlIHJvdGF0aW9uIG9mIHRoZSBCb2R5LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuYW5ndWxhckRyYWcgPSAwOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4QW5ndWxhciAtIFRoZSBtYXhpbXVtIGFuZ3VsYXIgdmVsb2NpdHkgaW4gcGl4ZWxzIHBlciBzZWNvbmQgc3EuIHRoYXQgdGhlIEJvZHkgY2FuIHJlYWNoLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMubWF4QW5ndWxhciA9IDEwMDA7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYXNzIC0gVGhlIG1hc3Mgb2YgdGhlIEJvZHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXNzID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBza2lwUXVhZFRyZWUgLSBJZiB0aGUgQm9keSBpcyBhbiBpcnJlZ3VsYXIgc2hhcGUgeW91IGNhbiBzZXQgdGhpcyB0byB0cnVlIHRvIGF2b2lkIGl0IGJlaW5nIGFkZGVkIHRvIHRoZSBXb3JsZCBxdWFkIHRyZWUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5za2lwUXVhZFRyZWUgPSBmYWxzZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtBcnJheX0gcXVhZFRyZWVJRHMgLSBJbnRlcm5hbCBJRCBjYWNoZS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMucXVhZFRyZWVJRHMgPSBbXTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHF1YWRUcmVlSW5kZXggLSBJbnRlcm5hbCBJRCBjYWNoZS4KICAgICogQHByb3RlY3RlZAogICAgKi8KICAgIHRoaXMucXVhZFRyZWVJbmRleCA9IC0xOwoKICAgIC8vCUFsbG93IGNvbGxpc2lvbgoKICAgIC8qKgogICAgKiBTZXQgdGhlIGFsbG93Q29sbGlzaW9uIHByb3BlcnRpZXMgdG8gY29udHJvbCB3aGljaCBkaXJlY3Rpb25zIGNvbGxpc2lvbiBpcyBwcm9jZXNzZWQgZm9yIHRoaXMgQm9keS4KICAgICogRm9yIGV4YW1wbGUgYWxsb3dDb2xsaXNpb24udXAgPSBmYWxzZSBtZWFucyBpdCB3b24ndCBjb2xsaWRlIHdoZW4gdGhlIGNvbGxpc2lvbiBoYXBwZW5lZCB3aGlsZSBtb3ZpbmcgdXAuCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSBhbGxvd0NvbGxpc2lvbiAtIEFuIG9iamVjdCBjb250YWluaW5nIGFsbG93ZWQgY29sbGlzaW9uLgogICAgKi8KICAgIHRoaXMuYWxsb3dDb2xsaXNpb24gPSB7IG5vbmU6IGZhbHNlLCBhbnk6IHRydWUsIHVwOiB0cnVlLCBkb3duOiB0cnVlLCBsZWZ0OiB0cnVlLCByaWdodDogdHJ1ZSB9OwoKICAgIC8qKgogICAgKiBUaGlzIG9iamVjdCBpcyBwb3B1bGF0ZWQgd2l0aCBib29sZWFuIHZhbHVlcyB3aGVuIHRoZSBCb2R5IGNvbGxpZGVzIHdpdGggYW5vdGhlci4KICAgICogdG91Y2hpbmcudXAgPSB0cnVlIG1lYW5zIHRoZSBjb2xsaXNpb24gaGFwcGVuZWQgdG8gdGhlIHRvcCBvZiB0aGlzIEJvZHkgZm9yIGV4YW1wbGUuCiAgICAqIEBwcm9wZXJ0eSB7b2JqZWN0fSB0b3VjaGluZyAtIEFuIG9iamVjdCBjb250YWluaW5nIHRvdWNoaW5nIHJlc3VsdHMuCiAgICAqLwogICAgdGhpcy50b3VjaGluZyA9IHsgbm9uZTogdHJ1ZSwgdXA6IGZhbHNlLCBkb3duOiBmYWxzZSwgbGVmdDogZmFsc2UsIHJpZ2h0OiBmYWxzZSB9OwoKICAgIC8qKgogICAgKiBUaGlzIG9iamVjdCBpcyBwb3B1bGF0ZWQgd2l0aCBwcmV2aW91cyB0b3VjaGluZyB2YWx1ZXMgZnJvbSB0aGUgYm9kaWVzIHByZXZpb3VzIGNvbGxpc2lvbi4KICAgICogQHByb3BlcnR5IHtvYmplY3R9IHdhc1RvdWNoaW5nIC0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgcHJldmlvdXMgdG91Y2hpbmcgcmVzdWx0cy4KICAgICovCiAgICB0aGlzLndhc1RvdWNoaW5nID0geyBub25lOiB0cnVlLCB1cDogZmFsc2UsIGRvd246IGZhbHNlLCBsZWZ0OiBmYWxzZSwgcmlnaHQ6IGZhbHNlIH07CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBmYWNpbmcgLSBBIGNvbnN0IHJlZmVyZW5jZSB0byB0aGUgZGlyZWN0aW9uIHRoZSBCb2R5IGlzIHRyYXZlbGluZyBvciBmYWNpbmcuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5mYWNpbmcgPSBQaGFzZXIuTk9ORTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBpbW1vdmFibGUgLSBBbiBpbW1vdmFibGUgQm9keSB3aWxsIG5vdCByZWNlaXZlIGFueSBpbXBhY3RzIGZyb20gb3RoZXIgYm9kaWVzLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuaW1tb3ZhYmxlID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gbW92ZXMgLSBTZXQgdG8gdHJ1ZSB0byBhbGxvdyB0aGUgUGh5c2ljcyBzeXN0ZW0gdG8gbW92ZSB0aGlzIEJvZHksIG90aGVyIGZhbHNlIHRvIG1vdmUgaXQgbWFudWFsbHkuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tb3ZlcyA9IHRydWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSByb3RhdGlvbiAtIFRoZSBhbW91bnQgdGhlIEJvZHkgaXMgcm90YXRlZC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLnJvdGF0aW9uID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1JvdGF0aW9uIC0gQWxsb3cgdGhpcyBCb2R5IHRvIGJlIHJvdGF0ZWQ/ICh2aWEgYW5ndWxhclZlbG9jaXR5LCBldGMpCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGxvd1JvdGF0aW9uID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd0dyYXZpdHkgLSBBbGxvdyB0aGlzIEJvZHkgdG8gYmUgaW5mbHVlbmNlZCBieSB0aGUgZ2xvYmFsIEdyYXZpdHk/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5hbGxvd0dyYXZpdHkgPSB0cnVlOwoKICAgIC8qKgogICAgKiBUaGlzIGZsYWcgYWxsb3dzIHlvdSB0byBkaXNhYmxlIHRoZSBjdXN0b20geCBzZXBhcmF0aW9uIHRoYXQgdGFrZXMgcGxhY2UgYnkgUGh5c2ljcy5BcmNhZGUuc2VwYXJhdGUuCiAgICAqIFVzZWQgaW4gY29tYmluYXRpb24gd2l0aCB5b3VyIG93biBjb2xsaXNpb24gcHJvY2Vzc0hhbmRsZXIgeW91IGNhbiBjcmVhdGUgd2hhdGV2ZXIgdHlwZSBvZiBjb2xsaXNpb24gcmVzcG9uc2UgeW91IG5lZWQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY3VzdG9tU2VwYXJhdGVYIC0gVXNlIGEgY3VzdG9tIHNlcGFyYXRpb24gc3lzdGVtIG9yIHRoZSBidWlsdC1pbiBvbmU/CiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jdXN0b21TZXBhcmF0ZVggPSBmYWxzZTsKCiAgICAvKioKICAgICogVGhpcyBmbGFnIGFsbG93cyB5b3UgdG8gZGlzYWJsZSB0aGUgY3VzdG9tIHkgc2VwYXJhdGlvbiB0aGF0IHRha2VzIHBsYWNlIGJ5IFBoeXNpY3MuQXJjYWRlLnNlcGFyYXRlLgogICAgKiBVc2VkIGluIGNvbWJpbmF0aW9uIHdpdGggeW91ciBvd24gY29sbGlzaW9uIHByb2Nlc3NIYW5kbGVyIHlvdSBjYW4gY3JlYXRlIHdoYXRldmVyIHR5cGUgb2YgY29sbGlzaW9uIHJlc3BvbnNlIHlvdSBuZWVkLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGN1c3RvbVNlcGFyYXRlWSAtIFVzZSBhIGN1c3RvbSBzZXBhcmF0aW9uIHN5c3RlbSBvciB0aGUgYnVpbHQtaW4gb25lPwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY3VzdG9tU2VwYXJhdGVZID0gZmFsc2U7CgogICAgLyoqCiAgICAqIFdoZW4gdGhpcyBib2R5IGNvbGxpZGVzIHdpdGggYW5vdGhlciwgdGhlIGFtb3VudCBvZiBvdmVybGFwIGlzIHN0b3JlZCBoZXJlLgogICAgKiBAcHJvcGVydHkge251bWJlcn0gb3ZlcmxhcFggLSBUaGUgYW1vdW50IG9mIGhvcml6b250YWwgb3ZlcmxhcCBkdXJpbmcgdGhlIGNvbGxpc2lvbi4KICAgICovCiAgICB0aGlzLm92ZXJsYXBYID0gMDsKCiAgICAvKioKICAgICogV2hlbiB0aGlzIGJvZHkgY29sbGlkZXMgd2l0aCBhbm90aGVyLCB0aGUgYW1vdW50IG9mIG92ZXJsYXAgaXMgc3RvcmVkIGhlcmUuCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBvdmVybGFwWSAtIFRoZSBhbW91bnQgb2YgdmVydGljYWwgb3ZlcmxhcCBkdXJpbmcgdGhlIGNvbGxpc2lvbi4KICAgICovCiAgICB0aGlzLm92ZXJsYXBZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtQaGFzZXIuUmVjdGFuZ2xlfSBodWxsWCAtIFRoZSBkeW5hbWljYWxseSBjYWxjdWxhdGVkIGh1bGwgdXNlZCBkdXJpbmcgY29sbGlzaW9uLgogICAgKi8KICAgIHRoaXMuaHVsbFggPSBuZXcgUGhhc2VyLlJlY3RhbmdsZSgpOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge1BoYXNlci5SZWN0YW5nbGV9IGh1bGxZIC0gVGhlIGR5bmFtaWNhbGx5IGNhbGN1bGF0ZWQgaHVsbCB1c2VkIGR1cmluZyBjb2xsaXNpb24uCiAgICAqLwogICAgdGhpcy5odWxsWSA9IG5ldyBQaGFzZXIuUmVjdGFuZ2xlKCk7CgogICAgLyoqCiAgICAqIElmIGEgYm9keSBpcyBvdmVybGFwcGluZyB3aXRoIGFub3RoZXIgYm9keSwgYnV0IG5laXRoZXIgb2YgdGhlbSBhcmUgbW92aW5nIChtYXliZSB0aGV5IHNwYXduZWQgb24tdG9wIG9mIGVhY2ggb3RoZXI/KSB0aGlzIGlzIHNldCB0byB0cnVlLgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGVtYmVkZGVkIC0gQm9keSBlbWJlZCB2YWx1ZS4KICAgICovCiAgICB0aGlzLmVtYmVkZGVkID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEEgQm9keSBjYW4gYmUgc2V0IHRvIGNvbGxpZGUgYWdhaW5zdCB0aGUgV29ybGQgYm91bmRzIGF1dG9tYXRpY2FsbHkgYW5kIHJlYm91bmQgYmFjayBpbnRvIHRoZSBXb3JsZCBpZiB0aGlzIGlzIHNldCB0byB0cnVlLiBPdGhlcndpc2UgaXQgd2lsbCBsZWF2ZSB0aGUgV29ybGQuCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZVdvcmxkQm91bmRzIC0gU2hvdWxkIHRoZSBCb2R5IGNvbGxpZGUgd2l0aCB0aGUgV29ybGQgYm91bmRzPwogICAgKi8KICAgIHRoaXMuY29sbGlkZVdvcmxkQm91bmRzID0gZmFsc2U7Cgp9OwoKUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3VwZGF0ZUJvdW5kcwogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJdXBkYXRlQm91bmRzOiBmdW5jdGlvbiAoY2VudGVyWCwgY2VudGVyWSwgc2NhbGVYLCBzY2FsZVkpIHsKCgkJaWYgKHNjYWxlWCAhPSB0aGlzLl9zeCB8fCBzY2FsZVkgIT0gdGhpcy5fc3kpCgkJewoJCQl0aGlzLndpZHRoID0gdGhpcy5zb3VyY2VXaWR0aCAqIHNjYWxlWDsKCQkJdGhpcy5oZWlnaHQgPSB0aGlzLnNvdXJjZUhlaWdodCAqIHNjYWxlWTsKCQkJdGhpcy5oYWxmV2lkdGggPSBNYXRoLmZsb29yKHRoaXMud2lkdGggLyAyKTsKCQkJdGhpcy5oYWxmSGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLmhlaWdodCAvIDIpOwoJCQl0aGlzLl9zeCA9IHNjYWxlWDsKCQkJdGhpcy5fc3kgPSBzY2FsZVk7CiAgICAgICAgICAgIHRoaXMuY2VudGVyLnNldFRvKHRoaXMueCArIHRoaXMuaGFsZldpZHRoLCB0aGlzLnkgKyB0aGlzLmhhbGZIZWlnaHQpOwoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3ByZVVwZGF0ZQogICAgKiBAcHJvdGVjdGVkCiAgICAqLwoJcHJlVXBkYXRlOiBmdW5jdGlvbiAoKSB7CgoJCS8vCVN0b3JlIGFuZCByZXNldCBjb2xsaXNpb24gZmxhZ3MKCSAgICB0aGlzLndhc1RvdWNoaW5nLm5vbmUgPSB0aGlzLnRvdWNoaW5nLm5vbmU7CgkgICAgdGhpcy53YXNUb3VjaGluZy51cCA9IHRoaXMudG91Y2hpbmcudXA7CgkgICAgdGhpcy53YXNUb3VjaGluZy5kb3duID0gdGhpcy50b3VjaGluZy5kb3duOwoJICAgIHRoaXMud2FzVG91Y2hpbmcubGVmdCA9IHRoaXMudG91Y2hpbmcubGVmdDsKCSAgICB0aGlzLndhc1RvdWNoaW5nLnJpZ2h0ID0gdGhpcy50b3VjaGluZy5yaWdodDsKCgkgICAgdGhpcy50b3VjaGluZy5ub25lID0gdHJ1ZTsKCSAgICB0aGlzLnRvdWNoaW5nLnVwID0gZmFsc2U7CgkgICAgdGhpcy50b3VjaGluZy5kb3duID0gZmFsc2U7CgkgICAgdGhpcy50b3VjaGluZy5sZWZ0ID0gZmFsc2U7CgkgICAgdGhpcy50b3VjaGluZy5yaWdodCA9IGZhbHNlOwoKCSAgICB0aGlzLmVtYmVkZGVkID0gZmFsc2U7CgoJCXRoaXMuc2NyZWVuWCA9ICh0aGlzLnNwcml0ZS53b3JsZFRyYW5zZm9ybVsyXSAtICh0aGlzLnNwcml0ZS5hbmNob3IueCAqIHRoaXMud2lkdGgpKSArIHRoaXMub2Zmc2V0Lng7CgkJdGhpcy5zY3JlZW5ZID0gKHRoaXMuc3ByaXRlLndvcmxkVHJhbnNmb3JtWzVdIC0gKHRoaXMuc3ByaXRlLmFuY2hvci55ICogdGhpcy5oZWlnaHQpKSArIHRoaXMub2Zmc2V0Lnk7CgogICAgICAgIHRoaXMucHJlWCA9ICh0aGlzLnNwcml0ZS53b3JsZC54IC0gKHRoaXMuc3ByaXRlLmFuY2hvci54ICogdGhpcy53aWR0aCkpICsgdGhpcy5vZmZzZXQueDsKICAgICAgICB0aGlzLnByZVkgPSAodGhpcy5zcHJpdGUud29ybGQueSAtICh0aGlzLnNwcml0ZS5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSkgKyB0aGlzLm9mZnNldC55OwoKCQl0aGlzLnByZVJvdGF0aW9uID0gdGhpcy5zcHJpdGUuYW5nbGU7CgoJCXRoaXMueCA9IHRoaXMucHJlWDsKCQl0aGlzLnkgPSB0aGlzLnByZVk7CgkJdGhpcy5yb3RhdGlvbiA9IHRoaXMucHJlUm90YXRpb247CgoJCWlmICh0aGlzLm1vdmVzKQoJCXsKCQkJdGhpcy5nYW1lLnBoeXNpY3MudXBkYXRlTW90aW9uKHRoaXMpOwoKCQkJaWYgKHRoaXMuY29sbGlkZVdvcmxkQm91bmRzKQoJCQl7CgkJCQl0aGlzLmNoZWNrV29ybGRCb3VuZHMoKTsKCQkJfQoKCQkJdGhpcy51cGRhdGVIdWxscygpOwogICAgICAgIH0KCgkJaWYgKHRoaXMuc2tpcFF1YWRUcmVlID09IGZhbHNlICYmIHRoaXMuYWxsb3dDb2xsaXNpb24ubm9uZSA9PSBmYWxzZSAmJiB0aGlzLnNwcml0ZS52aXNpYmxlICYmIHRoaXMuc3ByaXRlLmFsaXZlKQoJCXsKCQkgICAgdGhpcy5xdWFkVHJlZUlEcyA9IFtdOwoJCSAgICB0aGlzLnF1YWRUcmVlSW5kZXggPSAtMTsKCQkJdGhpcy5nYW1lLnBoeXNpY3MucXVhZFRyZWUuaW5zZXJ0KHRoaXMpOwoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBJbnRlcm5hbCBtZXRob2QuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlI3Bvc3RVcGRhdGUKICAgICogQHByb3RlY3RlZAogICAgKi8KCXBvc3RVcGRhdGU6IGZ1bmN0aW9uICgpIHsKCgkJaWYgKHRoaXMuZGVsdGFYKCkgPCAwKQoJCXsKCQkJdGhpcy5mYWNpbmcgPSBQaGFzZXIuTEVGVDsKCQl9CgkJZWxzZSBpZiAodGhpcy5kZWx0YVgoKSA+IDApCgkJewoJCQl0aGlzLmZhY2luZyA9IFBoYXNlci5SSUdIVDsKCQl9CgoJCWlmICh0aGlzLmRlbHRhWSgpIDwgMCkKCQl7CgkJCXRoaXMuZmFjaW5nID0gUGhhc2VyLlVQOwoJCX0KCQllbHNlIGlmICh0aGlzLmRlbHRhWSgpID4gMCkKCQl7CgkJCXRoaXMuZmFjaW5nID0gUGhhc2VyLkRPV047CgkJfQoKICAgICAgICBpZiAodGhpcy5kZWx0YVgoKSAhPT0gMCB8fCB0aGlzLmRlbHRhWSgpICE9PSAwKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5zcHJpdGUueCArPSB0aGlzLmRlbHRhWCgpOwogICAgICAgICAgICB0aGlzLnNwcml0ZS55ICs9IHRoaXMuZGVsdGFZKCk7CiAgICAgICAgICAgIHRoaXMuY2VudGVyLnNldFRvKHRoaXMueCArIHRoaXMuaGFsZldpZHRoLCB0aGlzLnkgKyB0aGlzLmhhbGZIZWlnaHQpOwogICAgICAgIH0KCgkJaWYgKHRoaXMuYWxsb3dSb3RhdGlvbikKCQl7CgkJCXRoaXMuc3ByaXRlLmFuZ2xlICs9IHRoaXMuZGVsdGFaKCk7CgkJfQoKCX0sCgogICAgLyoqCiAgICAqIEludGVybmFsIG1ldGhvZC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUjdXBkYXRlSHVsbHMKICAgICogQHByb3RlY3RlZAogICAgKi8KCXVwZGF0ZUh1bGxzOiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMuaHVsbFguc2V0VG8odGhpcy54LCB0aGlzLnByZVksIHRoaXMud2lkdGgsIHRoaXMuaGVpZ2h0KTsKCQl0aGlzLmh1bGxZLnNldFRvKHRoaXMucHJlWCwgdGhpcy55LCB0aGlzLndpZHRoLCB0aGlzLmhlaWdodCk7CgoJfSwKCiAgICAvKioKICAgICogSW50ZXJuYWwgbWV0aG9kLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNjaGVja1dvcmxkQm91bmRzCiAgICAqIEBwcm90ZWN0ZWQKICAgICovCgljaGVja1dvcmxkQm91bmRzOiBmdW5jdGlvbiAoKSB7CgoJCWlmICh0aGlzLnggPCB0aGlzLmdhbWUud29ybGQuYm91bmRzLngpCgkJewoJCQl0aGlzLnggPSB0aGlzLmdhbWUud29ybGQuYm91bmRzLng7CgkJCXRoaXMudmVsb2NpdHkueCAqPSAtdGhpcy5ib3VuY2UueDsKCQl9CgkJZWxzZSBpZiAodGhpcy5yaWdodCA+IHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMucmlnaHQpCgkJewoJCQl0aGlzLnggPSB0aGlzLmdhbWUud29ybGQuYm91bmRzLnJpZ2h0IC0gdGhpcy53aWR0aDsKCQkJdGhpcy52ZWxvY2l0eS54ICo9IC10aGlzLmJvdW5jZS54OwoJCX0KCgkJaWYgKHRoaXMueSA8IHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueSkKCQl7CgkJCXRoaXMueSA9IHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMueTsKCQkJdGhpcy52ZWxvY2l0eS55ICo9IC10aGlzLmJvdW5jZS55OwoJCX0KCQllbHNlIGlmICh0aGlzLmJvdHRvbSA+IHRoaXMuZ2FtZS53b3JsZC5ib3VuZHMuYm90dG9tKQoJCXsKCQkJdGhpcy55ID0gdGhpcy5nYW1lLndvcmxkLmJvdW5kcy5ib3R0b20gLSB0aGlzLmhlaWdodDsKCQkJdGhpcy52ZWxvY2l0eS55ICo9IC10aGlzLmJvdW5jZS55OwoJCX0KCgl9LAoKICAgIC8qKgogICAgKiBZb3UgY2FuIG1vZGlmeSB0aGUgc2l6ZSBvZiB0aGUgcGh5c2ljcyBCb2R5IHRvIGJlIGFueSBkaW1lbnNpb24geW91IG5lZWQuCiAgICAqIFNvIGl0IGNvdWxkIGJlIHNtYWxsZXIgb3IgbGFyZ2VyIHRoYW4gdGhlIHBhcmVudCBTcHJpdGUuIFlvdSBjYW4gYWxzbyBjb250cm9sIHRoZSB4IGFuZCB5IG9mZnNldCwgd2hpY2gKICAgICogaXMgdGhlIHBvc2l0aW9uIG9mIHRoZSBCb2R5IHJlbGF0aXZlIHRvIHRoZSB0b3AtbGVmdCBvZiB0aGUgU3ByaXRlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNzZXRTaXplCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB3aWR0aCAtIFRoZSB3aWR0aCBvZiB0aGUgQm9keS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIEJvZHkuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBvZmZzZXRYIC0gVGhlIFggb2Zmc2V0IG9mIHRoZSBCb2R5IGZyb20gdGhlIFNwcml0ZSBwb3NpdGlvbi4KICAgICogQHBhcmFtIHtudW1iZXJ9IG9mZnNldFkgLSBUaGUgWSBvZmZzZXQgb2YgdGhlIEJvZHkgZnJvbSB0aGUgU3ByaXRlIHBvc2l0aW9uLgogICAgKi8KCXNldFNpemU6IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0LCBvZmZzZXRYLCBvZmZzZXRZKSB7CgoJCW9mZnNldFggPSBvZmZzZXRYIHx8IHRoaXMub2Zmc2V0Lng7CgkJb2Zmc2V0WSA9IG9mZnNldFkgfHwgdGhpcy5vZmZzZXQueTsKCgkJdGhpcy5zb3VyY2VXaWR0aCA9IHdpZHRoOwoJCXRoaXMuc291cmNlSGVpZ2h0ID0gaGVpZ2h0OwoJCXRoaXMud2lkdGggPSB0aGlzLnNvdXJjZVdpZHRoICogdGhpcy5fc3g7CgkJdGhpcy5oZWlnaHQgPSB0aGlzLnNvdXJjZUhlaWdodCAqIHRoaXMuX3N5OwoJCXRoaXMuaGFsZldpZHRoID0gTWF0aC5mbG9vcih0aGlzLndpZHRoIC8gMik7CgkJdGhpcy5oYWxmSGVpZ2h0ID0gTWF0aC5mbG9vcih0aGlzLmhlaWdodCAvIDIpOwoJCXRoaXMub2Zmc2V0LnNldFRvKG9mZnNldFgsIG9mZnNldFkpOwoKICAgICAgICB0aGlzLmNlbnRlci5zZXRUbyh0aGlzLnggKyB0aGlzLmhhbGZXaWR0aCwgdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0KTsKCgl9LAoKICAgIC8qKgogICAgKiBSZXNldHMgYWxsIEJvZHkgdmFsdWVzICh2ZWxvY2l0eSwgYWNjZWxlcmF0aW9uLCByb3RhdGlvbiwgZXRjKQogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZSNyZXNldAogICAgKi8KCXJlc2V0OiBmdW5jdGlvbiAoKSB7CgoJCXRoaXMudmVsb2NpdHkuc2V0VG8oMCwgMCk7CgkJdGhpcy5hY2NlbGVyYXRpb24uc2V0VG8oMCwgMCk7CgoJICAgIHRoaXMuYW5ndWxhclZlbG9jaXR5ID0gMDsKCSAgICB0aGlzLmFuZ3VsYXJBY2NlbGVyYXRpb24gPSAwOwogICAgICAgIHRoaXMucHJlWCA9ICh0aGlzLnNwcml0ZS53b3JsZC54IC0gKHRoaXMuc3ByaXRlLmFuY2hvci54ICogdGhpcy53aWR0aCkpICsgdGhpcy5vZmZzZXQueDsKICAgICAgICB0aGlzLnByZVkgPSAodGhpcy5zcHJpdGUud29ybGQueSAtICh0aGlzLnNwcml0ZS5hbmNob3IueSAqIHRoaXMuaGVpZ2h0KSkgKyB0aGlzLm9mZnNldC55OwoJCXRoaXMucHJlUm90YXRpb24gPSB0aGlzLnNwcml0ZS5hbmdsZTsKCgkJdGhpcy54ID0gdGhpcy5wcmVYOwoJCXRoaXMueSA9IHRoaXMucHJlWTsKCQl0aGlzLnJvdGF0aW9uID0gdGhpcy5wcmVSb3RhdGlvbjsKICAgICAgICAKICAgICAgICB0aGlzLmNlbnRlci5zZXRUbyh0aGlzLnggKyB0aGlzLmhhbGZXaWR0aCwgdGhpcy55ICsgdGhpcy5oYWxmSGVpZ2h0KTsKCgl9LAoKICAgIC8qKgogICAgKiBSZXR1cm5zIHRoZSBhYnNvbHV0ZSBkZWx0YSB4IHZhbHVlLgogICAgKgogICAgKiBAbWV0aG9kIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I2RlbHRhQWJzWAogICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBhYnNvbHV0ZSBkZWx0YSB2YWx1ZS4KICAgICovCiAgICBkZWx0YUFic1g6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gKHRoaXMuZGVsdGFYKCkgPiAwID8gdGhpcy5kZWx0YVgoKSA6IC10aGlzLmRlbHRhWCgpKTsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGFic29sdXRlIGRlbHRhIHkgdmFsdWUuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFBYnNZCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGFic29sdXRlIGRlbHRhIHZhbHVlLgogICAgKi8KICAgIGRlbHRhQWJzWTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiAodGhpcy5kZWx0YVkoKSA+IDAgPyB0aGlzLmRlbHRhWSgpIDogLXRoaXMuZGVsdGFZKCkpOwogICAgfSwKCiAgICAvKioKICAgICogUmV0dXJucyB0aGUgZGVsdGEgeCB2YWx1ZS4gVGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBCb2R5Lnggbm93IGFuZCBpbiB0aGUgcHJldmlvdXMgc3RlcC4KICAgICoKICAgICogQG1ldGhvZCBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNkZWx0YVgKICAgICogQHJldHVybiB7bnVtYmVyfSBUaGUgZGVsdGEgdmFsdWUuCiAgICAqLwogICAgZGVsdGFYOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCAtIHRoaXMucHJlWDsKICAgIH0sCgogICAgLyoqCiAgICAqIFJldHVybnMgdGhlIGRlbHRhIHkgdmFsdWUuIFRoZSBkaWZmZXJlbmNlIGJldHdlZW4gQm9keS55IG5vdyBhbmQgaW4gdGhlIHByZXZpb3VzIHN0ZXAuCiAgICAqCiAgICAqIEBtZXRob2QgUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkjZGVsdGFZCiAgICAqIEByZXR1cm4ge251bWJlcn0gVGhlIGRlbHRhIHZhbHVlLgogICAgKi8KICAgIGRlbHRhWTogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgLSB0aGlzLnByZVk7CiAgICB9LAoKICAgIGRlbHRhWjogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnJvdGF0aW9uIC0gdGhpcy5wcmVSb3RhdGlvbjsKICAgIH0KCn07CgovKioKKiBAbmFtZSBQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keSNib3R0b20KKiBAcHJvcGVydHkge251bWJlcn0gYm90dG9tIC0gVGhlIGJvdHRvbSB2YWx1ZSBvZiB0aGlzIEJvZHkgKHNhbWUgYXMgQm9keS55ICsgQm9keS5oZWlnaHQpCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGh5c2ljcy5BcmNhZGUuQm9keS5wcm90b3R5cGUsICJib3R0b20iLCB7CiAgICAKICAgIC8qKgogICAgKiBUaGUgc3VtIG9mIHRoZSB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIGJvdHRvbSBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgd2lkdGggcHJvcGVydGllcywgYnV0IGRvZXMgY2hhbmdlIHRoZSBoZWlnaHQgcHJvcGVydHkuCiAgICAqIEBtZXRob2QgYm90dG9tCiAgICAqIEByZXR1cm4ge251bWJlcn0KICAgICoqLwogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueSArIHRoaXMuaGVpZ2h0OwogICAgfSwKCiAgICAvKioKICAgICogVGhlIHN1bSBvZiB0aGUgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSBib3R0b20gcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIHdpZHRoIHByb3BlcnRpZXMsIGJ1dCBkb2VzIGNoYW5nZSB0aGUgaGVpZ2h0IHByb3BlcnR5LgogICAgKiBAbWV0aG9kIGJvdHRvbQogICAgKiBAcGFyYW0ge251bWJlcn0gdmFsdWUKICAgICoqLyAgICAKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CgogICAgICAgIGlmICh2YWx1ZSA8PSB0aGlzLnkpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmhlaWdodCA9IDA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuaGVpZ2h0ID0gKHRoaXMueSAtIHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgCiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QaHlzaWNzLkFyY2FkZS5Cb2R5I3JpZ2h0CiogQHByb3BlcnR5IHtudW1iZXJ9IHJpZ2h0IC0gVGhlIHJpZ2h0IHZhbHVlIG9mIHRoaXMgQm9keSAoc2FtZSBhcyBCb2R5LnggKyBCb2R5LndpZHRoKQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBoeXNpY3MuQXJjYWRlLkJvZHkucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAKICAgIC8qKgogICAgKiBUaGUgc3VtIG9mIHRoZSB4IGFuZCB3aWR0aCBwcm9wZXJ0aWVzLiBDaGFuZ2luZyB0aGUgcmlnaHQgcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIGhlaWdodCBwcm9wZXJ0aWVzLgogICAgKiBIb3dldmVyIGl0IGRvZXMgYWZmZWN0IHRoZSB3aWR0aCBwcm9wZXJ0eS4KICAgICogQG1ldGhvZCByaWdodAogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqKi8gICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy54ICsgdGhpcy53aWR0aDsKICAgIH0sCgogICAgLyoqCiAgICAqIFRoZSBzdW0gb2YgdGhlIHggYW5kIHdpZHRoIHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSByaWdodCBwcm9wZXJ0eSBvZiBhIFJlY3RhbmdsZSBvYmplY3QgaGFzIG5vIGVmZmVjdCBvbiB0aGUgeCwgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuCiAgICAqIEhvd2V2ZXIgaXQgZG9lcyBhZmZlY3QgdGhlIHdpZHRoIHByb3BlcnR5LgogICAgKiBAbWV0aG9kIHJpZ2h0CiAgICAqIEBwYXJhbSB7bnVtYmVyfSB2YWx1ZQogICAgKiovCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgPD0gdGhpcy54KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy53aWR0aCA9IDA7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMud2lkdGggPSB0aGlzLnggKyB2YWx1ZTsKICAgICAgICB9CgogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIuUGFydGljbGVzIGlzIHRoZSBQYXJ0aWNsZSBNYW5hZ2VyIGZvciB0aGUgZ2FtZS4gSXQgaXMgY2FsbGVkIGR1cmluZyB0aGUgZ2FtZSB1cGRhdGUgbG9vcCBhbmQgaW4gdHVybiB1cGRhdGVzIGFueSBFbWl0dGVycyBhdHRhY2hlZCB0byBpdC4KKgoqIEBjbGFzcyBQaGFzZXIuUGFydGljbGVzCiogQGNsYXNzZGVzYyBQaGFzZXIgUGFydGljbGVzCiogQGNvbnN0cnVjdG9yCiogQHBhcmFtIHtQaGFzZXIuR2FtZX0gZ2FtZSAtIEEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50bHkgcnVubmluZyBnYW1lLgoqLwpQaGFzZXIuUGFydGljbGVzID0gZnVuY3Rpb24gKGdhbWUpIHsKCgkvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gZW1pdHRlcnMgLSBEZXNjcmlwdGlvbi4KCSovCgl0aGlzLmVtaXR0ZXJzID0ge307CgoJLyoqCgkqIEBwcm9wZXJ0eSB7bnVtYmVyfSBJRCAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KCXRoaXMuSUQgPSAwOwoKfTsKClBoYXNlci5QYXJ0aWNsZXMucHJvdG90eXBlID0gewoKCS8qKgoJKiBBZGRzIGEgbmV3IFBhcnRpY2xlIEVtaXR0ZXIgdG8gdGhlIFBhcnRpY2xlIE1hbmFnZXIuCgkqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyNhZGQKCSogQHBhcmFtIHtQaGFzZXIuRW1pdHRlcn0gZW1pdHRlciAtIERlc2NyaXB0aW9uLgoJKiBAcmV0dXJuIHtQaGFzZXIuRW1pdHRlcn0gVGhlIGVtaXR0ZXIgdGhhdCB3YXMgYWRkZWQuCgkqLwoJYWRkOiBmdW5jdGlvbiAoZW1pdHRlcikgewoKCQl0aGlzLmVtaXR0ZXJzW2VtaXR0ZXIubmFtZV0gPSBlbWl0dGVyOwoKCQlyZXR1cm4gZW1pdHRlcjsKCgl9LAoKCS8qKgoJKiBSZW1vdmVzIGFuIGV4aXN0aW5nIFBhcnRpY2xlIEVtaXR0ZXIgZnJvbSB0aGUgUGFydGljbGUgTWFuYWdlci4KCSogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzI3JlbW92ZQoJKiBAcGFyYW0ge1BoYXNlci5FbWl0dGVyfSBlbWl0dGVyIC0gVGhlIGVtaXR0ZXIgdG8gcmVtb3ZlLgoJKi8KCXJlbW92ZTogZnVuY3Rpb24gKGVtaXR0ZXIpIHsKCgkJZGVsZXRlIHRoaXMuZW1pdHRlcnNbZW1pdHRlci5uYW1lXTsKCgl9LAoKCS8qKgoJKiBDYWxsZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wLiBVcGRhdGVzIGFsbCBFbWl0dGVycyB3aG8gaGF2ZSB0aGVpciBleGlzdHMgdmFsdWUgc2V0IHRvIHRydWUuCgkqIEBtZXRob2QgUGhhc2VyLlBhcnRpY2xlcyN1cGRhdGUKCSogQHByb3RlY3RlZAoJKi8KCXVwZGF0ZTogZnVuY3Rpb24gKCkgewoKCQlmb3IgKHZhciBrZXkgaW4gdGhpcy5lbWl0dGVycykKCQl7CgkJCWlmICh0aGlzLmVtaXR0ZXJzW2tleV0uZXhpc3RzKQoJCQl7CgkJCQl0aGlzLmVtaXR0ZXJzW2tleV0udXBkYXRlKCk7CgkJCX0KCQl9CgoJfQoKfTsKUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUgPSB7fQovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiovCgovKioKKiBQaGFzZXIgLSBBcmNhZGVFbWl0dGVyCioKKiBAY2xhc3MgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlcgoqIEBjbGFzc2Rlc2MgRW1pdHRlciBpcyBhIGxpZ2h0d2VpZ2h0IHBhcnRpY2xlIGVtaXR0ZXIuIEl0IGNhbiBiZSB1c2VkIGZvciBvbmUtdGltZSBleHBsb3Npb25zIG9yIGZvcgoqIGNvbnRpbnVvdXMgZWZmZWN0cyBsaWtlIHJhaW4gYW5kIGZpcmUuIEFsbCBpdCByZWFsbHkgZG9lcyBpcyBsYXVuY2ggUGFydGljbGUgb2JqZWN0cyBvdXQKKiBhdCBzZXQgaW50ZXJ2YWxzLCBhbmQgZml4ZXMgdGhlaXIgcG9zaXRpb25zIGFuZCB2ZWxvY2l0aWVzIGFjY29yaW5kZ2x5LgoqIEBjb25zdHJ1Y3RvcgoqIEBleHRlbmRzIFBoYXNlci5Hcm91cAoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBDdXJyZW50IGdhbWUgaW5zdGFuY2UuCiogQHBhcmFtIHtudW1iZXJ9IFt4PTBdIC0gVGhlIHggY29vcmRpbmF0ZSB3aXRoaW4gdGhlIEVtaXR0ZXIgdGhhdCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiogQHBhcmFtIHtudW1iZXJ9IFt5PTBdIC0gVGhlIHkgY29vcmRpbmF0ZSB3aXRoaW4gdGhlIEVtaXR0ZXIgdGhhdCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiogQHBhcmFtIHtudW1iZXJ9IFttYXhQYXJ0aWNsZXM9NTBdIC0gVGhlIHRvdGFsIG51bWJlciBvZiBwYXJ0aWNsZXMgaW4gdGhpcyBlbWl0dGVyLi4KKi8KClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIgPSBmdW5jdGlvbiAoZ2FtZSwgeCwgeSwgbWF4UGFydGljbGVzKSB7CgogICAgLyoqCiAgICAqIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFBhcnRpY2xlcyAtIFRoZSB0b3RhbCBudW1iZXIgb2YgcGFydGljbGVzIGluIHRoaXMgZW1pdHRlci4uCiAgICAqIEBkZWZhdWx0CiAgICAqLwoJdGhpcy5tYXhQYXJ0aWNsZXMgPSBtYXhQYXJ0aWNsZXMgfHwgNTA7CgoJUGhhc2VyLkdyb3VwLmNhbGwodGhpcywgZ2FtZSk7CgogICAgLyoqCgkqIEBwcm9wZXJ0eSB7c3RyaW5nfSBuYW1lIC0gRGVzY3JpcHRpb24uCgkqLwogICAgdGhpcy5uYW1lID0gJ2VtaXR0ZXInICsgdGhpcy5nYW1lLnBhcnRpY2xlcy5JRCsrOwoKICAgIC8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0eXBlIC0gRGVzY3JpcHRpb24uCgkqLwogICAgdGhpcy50eXBlID0gUGhhc2VyLkVNSVRURVI7CgogICAgLyoqCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0geCAtIFRoZSBYIHBvc2l0aW9uIG9mIHRoZSB0b3AgbGVmdCBjb3JuZXIgb2YgdGhlIGVtaXR0ZXIgaW4gd29ybGQgc3BhY2UuCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLnggPSAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHkgLSBUaGUgWSBwb3NpdGlvbiBvZiB0aGUgdG9wIGxlZnQgY29ybmVyIG9mIGVtaXR0ZXIgaW4gd29ybGQgc3BhY2UuCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLnkgPSAwOwoKICAgIC8qKgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSBlbWl0dGVyLiAgUGFydGljbGVzIGNhbiBiZSByYW5kb21seSBnZW5lcmF0ZWQgZnJvbSBhbnl3aGVyZSB3aXRoaW4gdGhpcyBib3guCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLndpZHRoID0gMTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodCAtIFRoZSBoZWlnaHQgb2YgdGhlIGVtaXR0ZXIuICBQYXJ0aWNsZXMgY2FuIGJlIHJhbmRvbWx5IGdlbmVyYXRlZCBmcm9tIGFueXdoZXJlIHdpdGhpbiB0aGlzIGJveC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmhlaWdodCA9IDE7CgogICAgLyoqCiAgICAqIFRoZSBtaW5pbXVtIHBvc3NpYmxlIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuCiAgICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzICgtMTAwLC0xMDApLgogICAgKiBAcHJvcGVydHkge1BoYXNlci5Qb2ludH0gbWluUGFydGljbGVTcGVlZAogICAgKi8KICAgIHRoaXMubWluUGFydGljbGVTcGVlZCA9IG5ldyBQaGFzZXIuUG9pbnQoLTEwMCwgLTEwMCk7CgogICAgLyoqCiAgICAqIFRoZSBtYXhpbXVtIHBvc3NpYmxlIHZlbG9jaXR5IG9mIGEgcGFydGljbGUuCiAgICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzICgxMDAsMTAwKS4KICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IG1heFBhcnRpY2xlU3BlZWQKICAgICovCiAgICB0aGlzLm1heFBhcnRpY2xlU3BlZWQgPSBuZXcgUGhhc2VyLlBvaW50KDEwMCwgMTAwKTsKCiAgICAvKioKICAgICogVGhlIG1pbmltdW0gcG9zc2libGUgc2NhbGUgb2YgYSBwYXJ0aWNsZS4KICAgICogVGhlIGRlZmF1bHQgdmFsdWUgaXMgMS4KICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1pblBhcnRpY2xlU2NhbGUKICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLm1pblBhcnRpY2xlU2NhbGUgPSAxOwoKICAgIC8qKgogICAgICogVGhlIG1heGltdW0gcG9zc2libGUgc2NhbGUgb2YgYSBwYXJ0aWNsZS4KICAgICAqIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDEuCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gbWF4UGFydGljbGVTY2FsZQogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5tYXhQYXJ0aWNsZVNjYWxlID0gMTsKCiAgICAvKioKICAgICAqIFRoZSBtaW5pbXVtIHBvc3NpYmxlIGFuZ3VsYXIgdmVsb2NpdHkgb2YgYSBwYXJ0aWNsZS4gIFRoZSBkZWZhdWx0IHZhbHVlIGlzIC0zNjAuCiAgICAgKiBAcHJvcGVydHkge251bWJlcn0gbWluUm90YXRpb24KICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMubWluUm90YXRpb24gPSAtMzYwOwoKICAgIC8qKgogICAgICogVGhlIG1heGltdW0gcG9zc2libGUgYW5ndWxhciB2ZWxvY2l0eSBvZiBhIHBhcnRpY2xlLiAgVGhlIGRlZmF1bHQgdmFsdWUgaXMgMzYwLgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IG1heFJvdGF0aW9uCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLm1heFJvdGF0aW9uID0gMzYwOwoKICAgIC8qKgogICAgICogU2V0cyB0aGUgPGNvZGU+Z3Jhdml0eS55PC9jb2RlPiBvZiBlYWNoIHBhcnRpY2xlIHRvIHRoaXMgdmFsdWUgb24gbGF1bmNoLgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGdyYXZpdHkKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMuZ3Jhdml0eSA9IDI7CgogICAgLyoqCiAgICAgKiBTZXQgeW91ciBvd24gcGFydGljbGUgY2xhc3MgdHlwZSBoZXJlLgogICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gcGFydGljbGVDbGFzcwogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5wYXJ0aWNsZUNsYXNzID0gbnVsbDsKCiAgICAvKioKICAgICAqIFRoZSBYIGFuZCBZIGRyYWcgY29tcG9uZW50IG9mIHBhcnRpY2xlcyBsYXVuY2hlZCBmcm9tIHRoZSBlbWl0dGVyLgogICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IHBhcnRpY2xlRHJhZwogICAgICovCiAgICB0aGlzLnBhcnRpY2xlRHJhZyA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICAqIFRoZSBhbmd1bGFyIGRyYWcgY29tcG9uZW50IG9mIHBhcnRpY2xlcyBsYXVuY2hlZCBmcm9tIHRoZSBlbWl0dGVyIGlmIHRoZXkgYXJlIHJvdGF0aW5nLgogICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGFuZ3VsYXJEcmFnCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLmFuZ3VsYXJEcmFnID0gMDsKCiAgICAvKioKICAgICAqIEhvdyBvZnRlbiBhIHBhcnRpY2xlIGlzIGVtaXR0ZWQgaW4gbXMgKGlmIGVtaXR0ZXIgaXMgc3RhcnRlZCB3aXRoIEV4cGxvZGUgPT0gZmFsc2UpLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBmcmVxdWVuY3kKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMuZnJlcXVlbmN5ID0gMTAwOwoKICAgIC8qKgogICAgICogSG93IGxvbmcgZWFjaCBwYXJ0aWNsZSBsaXZlcyBvbmNlIGl0IGlzIGVtaXR0ZWQgaW4gbXMuIERlZmF1bHQgaXMgMiBzZWNvbmRzLgogICAgICogU2V0IGxpZmVzcGFuIHRvICd6ZXJvJyBmb3IgcGFydGljbGVzIHRvIGxpdmUgZm9yZXZlci4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsaWZlc3BhbgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5saWZlc3BhbiA9IDIwMDA7CgogICAgLyoqCiAgICAgKiBIb3cgbXVjaCBlYWNoIHBhcnRpY2xlIHNob3VsZCBib3VuY2Ugb24gZWFjaCBheGlzLiAgMSA9IGZ1bGwgYm91bmNlLCAwID0gbm8gYm91bmNlLgogICAgICogQHByb3BlcnR5IHtQaGFzZXIuUG9pbnR9IGJvdW5jZQogICAgICovCiAgICB0aGlzLmJvdW5jZSA9IG5ldyBQaGFzZXIuUG9pbnQoKTsKCiAgICAvKioKICAgICAqIEludGVybmFsIGhlbHBlciBmb3IgZGVjaWRpbmcgaG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfcXVhbnRpdHkKICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLl9xdWFudGl0eSA9IDA7CgogICAvKioKICAgICAqIEludGVybmFsIGhlbHBlciBmb3IgZGVjaWRpbmcgd2hlbiB0byBsYXVuY2ggcGFydGljbGVzIG9yIGtpbGwgdGhlbS4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGltZXIKICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLl90aW1lciA9IDA7CgogICAgLyoqCiAgICAgKiBJbnRlcm5hbCBjb3VudGVyIGZvciBmaWd1cmluZyBvdXQgaG93IG1hbnkgcGFydGljbGVzIHRvIGxhdW5jaC4KICAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfY291bnRlcgogICAgICogQHByaXZhdGUKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMuX2NvdW50ZXIgPSAwOwoKICAgIC8qKgogICAgICogSW50ZXJuYWwgaGVscGVyIGZvciB0aGUgc3R5bGUgb2YgcGFydGljbGUgZW1pc3Npb24gKGFsbCBhdCBvbmNlLCBvciBvbmUgYXQgYSB0aW1lKS4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gX2V4cGxvZGUKICAgICAqIEBwcml2YXRlCiAgICAgKiBAZGVmYXVsdAogICAgICovCiAgICB0aGlzLl9leHBsb2RlID0gdHJ1ZTsKCiAgICAvKioKICAgICAqIERldGVybWluZXMgd2hldGhlciB0aGUgZW1pdHRlciBpcyBjdXJyZW50bHkgZW1pdHRpbmcgcGFydGljbGVzLgogICAgICogSXQgaXMgdG90YWxseSBzYWZlIHRvIGRpcmVjdGx5IHRvZ2dsZSB0aGlzLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBvbgogICAgICogQGRlZmF1bHQKICAgICAqLwogICAgdGhpcy5vbiA9IGZhbHNlOwoKICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyB3aGV0aGVyIHRoZSBlbWl0dGVyIGlzIGJlaW5nIHVwZGF0ZWQgYnkgdGhlIGNvcmUgZ2FtZSBsb29wLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBleGlzdHMKICAgICAqIEBkZWZhdWx0CiAgICAgKi8KICAgIHRoaXMuZXhpc3RzID0gdHJ1ZTsKCiAgICAvKioKICAgICAqIFRoZSBwb2ludCB0aGUgcGFydGljbGVzIGFyZSBlbWl0dGVkIGZyb20uCiAgICAgKiBFbWl0dGVyLnggYW5kIEVtaXR0ZXIueSBjb250cm9sIHRoZSBjb250YWluZXJzIGxvY2F0aW9uLCB3aGljaCB1cGRhdGVzIGFsbCBjdXJyZW50IHBhcnRpY2xlcwogICAgICogRW1pdHRlci5lbWl0WCBhbmQgRW1pdHRlci5lbWl0WSBjb250cm9sIHRoZSBlbWlzc2lvbiBsb2NhdGlvbiByZWxhdGl2ZSB0byB0aGUgeC95IHBvc2l0aW9uLgogICAgICogQHByb3BlcnR5IHtib29sZWFufSBlbWl0WAogICAgICovCiAgICB0aGlzLmVtaXRYID0geDsKICAgIAogICAgLyoqCiAgICAgKiBUaGUgcG9pbnQgdGhlIHBhcnRpY2xlcyBhcmUgZW1pdHRlZCBmcm9tLgogICAgICogRW1pdHRlci54IGFuZCBFbWl0dGVyLnkgY29udHJvbCB0aGUgY29udGFpbmVycyBsb2NhdGlvbiwgd2hpY2ggdXBkYXRlcyBhbGwgY3VycmVudCBwYXJ0aWNsZXMKICAgICAqIEVtaXR0ZXIuZW1pdFggYW5kIEVtaXR0ZXIuZW1pdFkgY29udHJvbCB0aGUgZW1pc3Npb24gbG9jYXRpb24gcmVsYXRpdmUgdG8gdGhlIHgveSBwb3NpdGlvbi4KICAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZW1pdFkKICAgICAqLwogICAgdGhpcy5lbWl0WSA9IHk7CgkKfTsKClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShQaGFzZXIuR3JvdXAucHJvdG90eXBlKTsKUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyOwoKLyoqCiogQ2FsbGVkIGF1dG9tYXRpY2FsbHkgYnkgdGhlIGdhbWUgbG9vcCwgZGVjaWRlcyB3aGVuIHRvIGxhdW5jaCBwYXJ0aWNsZXMgYW5kIHdoZW4gdG8gImRpZSIuCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3VwZGF0ZQoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbiAoKSB7CgogICAgaWYgKHRoaXMub24pCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX2V4cGxvZGUpCiAgICAgICAgewoJCQl0aGlzLl9jb3VudGVyID0gMDsKCiAgICAgICAgICAgIGRvCiAgICAgICAgICAgIHsKICAgICAgICAgICAgCXRoaXMuZW1pdFBhcnRpY2xlKCk7CiAgICAgICAgICAgIAl0aGlzLl9jb3VudGVyKys7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKHRoaXMuX2NvdW50ZXIgPCB0aGlzLl9xdWFudGl0eSk7CgogICAgICAgICAgICB0aGlzLm9uID0gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGVsc2UKICAgICAgICB7CiAgICAgICAgCWlmICh0aGlzLmdhbWUudGltZS5ub3cgPj0gdGhpcy5fdGltZXIpCiAgICAgICAgCXsKICAgICAgICAgICAgICAgIHRoaXMuZW1pdFBhcnRpY2xlKCk7CgkJCQkKCQkJCXRoaXMuX2NvdW50ZXIrKzsKCiAgICAgICAgICAgICAgICBpZiAodGhpcy5fcXVhbnRpdHkgPiAwKQogICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgIGlmICh0aGlzLl9jb3VudGVyID49IHRoaXMuX3F1YW50aXR5KQoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAJdGhpcy5vbiA9IGZhbHNlOwoJICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0aGlzLl90aW1lciA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIHRoaXMuZnJlcXVlbmN5OwogICAgICAgIAl9CiAgICAgICAgfQogICAgfQoKfQoKLyoqCiogVGhpcyBmdW5jdGlvbiBnZW5lcmF0ZXMgYSBuZXcgYXJyYXkgb2YgcGFydGljbGUgc3ByaXRlcyB0byBhdHRhY2ggdG8gdGhlIGVtaXR0ZXIuCioKKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjbWFrZVBhcnRpY2xlcwoqIEBwYXJhbSB7RGVzY3JpcHRpb259IGtleXMgLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge251bWJlcn0gZnJhbWVzIC0gRGVzY3JpcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IHF1YW50aXR5IC0gVGhlIG51bWJlciBvZiBwYXJ0aWNsZXMgdG8gZ2VuZXJhdGUgd2hlbiB1c2luZyB0aGUgImNyZWF0ZSBmcm9tIGltYWdlIiBvcHRpb24uCiogQHBhcmFtIHtudW1iZXJ9IGNvbGxpZGUgLSBEZXNjcmlwdGlvbi4KKiBAcGFyYW0ge2Jvb2xlYW59IGNvbGxpZGVXb3JsZEJvdW5kcyAtIERlc2NyaXB0aW9uLgoqIEByZXR1cm4gVGhpcyBFbWl0dGVyIGluc3RhbmNlIChuaWNlIGZvciBjaGFpbmluZyBzdHVmZiB0b2dldGhlciwgaWYgeW91J3JlIGludG8gdGhhdCkuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLm1ha2VQYXJ0aWNsZXMgPSBmdW5jdGlvbiAoa2V5cywgZnJhbWVzLCBxdWFudGl0eSwgY29sbGlkZSwgY29sbGlkZVdvcmxkQm91bmRzKSB7CgogICAgaWYgKHR5cGVvZiBmcmFtZXMgPT0gJ3VuZGVmaW5lZCcpCiAgICB7CiAgICAgICAgZnJhbWVzID0gMDsKICAgIH0KCglxdWFudGl0eSA9IHF1YW50aXR5IHx8IHRoaXMubWF4UGFydGljbGVzOwogICAgY29sbGlkZSA9IGNvbGxpZGUgfHwgMDsKCiAgICBpZiAodHlwZW9mIGNvbGxpZGVXb3JsZEJvdW5kcyA9PSAndW5kZWZpbmVkJykKICAgIHsKICAgICAgICBjb2xsaWRlV29ybGRCb3VuZHMgPSBmYWxzZTsKICAgIH0KCiAgICB2YXIgcGFydGljbGU7CiAgICB2YXIgaSA9IDA7CiAgICB2YXIgcm5kS2V5ID0ga2V5czsKICAgIHZhciBybmRGcmFtZSA9IDA7CgogICAgd2hpbGUgKGkgPCBxdWFudGl0eSkKICAgIHsKICAgICAgICBpZiAodGhpcy5wYXJ0aWNsZUNsYXNzID09IG51bGwpCiAgICAgICAgewogICAgICAgICAgICBpZiAodHlwZW9mIGtleXMgPT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJuZEtleSA9IHRoaXMuZ2FtZS5ybmQucGljayhrZXlzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHR5cGVvZiBmcmFtZXMgPT0gJ29iamVjdCcpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHJuZEZyYW1lID0gdGhpcy5nYW1lLnJuZC5waWNrKGZyYW1lcyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHBhcnRpY2xlID0gbmV3IFBoYXNlci5TcHJpdGUodGhpcy5nYW1lLCAwLCAwLCBybmRLZXksIHJuZEZyYW1lKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgLy8gcGFydGljbGUgPSBuZXcgdGhpcy5wYXJ0aWNsZUNsYXNzKHRoaXMuZ2FtZSk7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29sbGlkZSA+IDApCiAgICAgICAgewogICAgICAgICAgICBwYXJ0aWNsZS5ib2R5LmFsbG93Q29sbGlzaW9uLmFueSA9IHRydWU7CiAgICAgICAgICAgIHBhcnRpY2xlLmJvZHkuYWxsb3dDb2xsaXNpb24ubm9uZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBwYXJ0aWNsZS5ib2R5LmFsbG93Q29sbGlzaW9uLm5vbmUgPSB0cnVlOwogICAgICAgIH0KCiAgICAgICAgcGFydGljbGUuYm9keS5jb2xsaWRlV29ybGRCb3VuZHMgPSBjb2xsaWRlV29ybGRCb3VuZHM7CgogICAgICAgIHBhcnRpY2xlLmV4aXN0cyA9IGZhbHNlOwogICAgICAgIHBhcnRpY2xlLnZpc2libGUgPSBmYWxzZTsKCiAgICAgICAgLy8gIENlbnRlciB0aGUgb3JpZ2luIGZvciByb3RhdGlvbiBhc3Npc3RhbmNlCiAgICAgICAgcGFydGljbGUuYW5jaG9yLnNldFRvKDAuNSwgMC41KTsKCiAgICAgICAgdGhpcy5hZGQocGFydGljbGUpOwoKICAgICAgICBpKys7CiAgICB9CgogICAgcmV0dXJuIHRoaXM7Cn0KCi8qKgogKiBDYWxsIHRoaXMgZnVuY3Rpb24gdG8gdHVybiBvZmYgYWxsIHRoZSBwYXJ0aWNsZXMgYW5kIHRoZSBlbWl0dGVyLgogKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIja2lsbAogKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUua2lsbCA9IGZ1bmN0aW9uICgpIHsKCiAgICB0aGlzLm9uID0gZmFsc2U7CiAgICB0aGlzLmFsaXZlID0gZmFsc2U7CiAgICB0aGlzLmV4aXN0cyA9IGZhbHNlOwoKfQoKLyoqCiAqIEhhbmR5IGZvciBicmluZ2luZyBnYW1lIG9iamVjdHMgImJhY2sgdG8gbGlmZSIuIEp1c3Qgc2V0cyBhbGl2ZSBhbmQgZXhpc3RzIGJhY2sgdG8gdHJ1ZS4KICogSW4gcHJhY3RpY2UsIHRoaXMgaXMgbW9zdCBvZnRlbiBjYWxsZWQgYnkgPGNvZGU+T2JqZWN0LnJlc2V0KCk8L2NvZGU+LgogKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjcmV2aXZlCiAqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5yZXZpdmUgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5hbGl2ZSA9IHRydWU7CiAgICB0aGlzLmV4aXN0cyA9IHRydWU7Cgp9CgovKioKICogQ2FsbCB0aGlzIGZ1bmN0aW9uIHRvIHN0YXJ0IGVtaXR0aW5nIHBhcnRpY2xlcy4KICogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3N0YXJ0CiAqIEBwYXJhbSB7Ym9vbGVhbn0gZXhwbG9kZSAtIFdoZXRoZXIgdGhlIHBhcnRpY2xlcyBzaG91bGQgYWxsIGJ1cnN0IG91dCBhdCBvbmNlLgogKiBAcGFyYW0ge251bWJlcn0gbGlmZXNwYW4gLSBIb3cgbG9uZyBlYWNoIHBhcnRpY2xlIGxpdmVzIG9uY2UgZW1pdHRlZC4gMCA9IGZvcmV2ZXIuCiAqIEBwYXJhbSB7bnVtYmVyfSBmcmVxdWVuY3kgLSBJZ25vcmVkIGlmIEV4cGxvZGUgaXMgc2V0IHRvIHRydWUuIEZyZXF1ZW5jeSBpcyBob3cgb2Z0ZW4gdG8gZW1pdCBhIHBhcnRpY2xlIGluIG1zLgogKiBAcGFyYW0ge251bWJlcn0gcXVhbnRpdHkgLSBIb3cgbWFueSBwYXJ0aWNsZXMgdG8gbGF1bmNoLiAwID0gImFsbCBvZiB0aGUgcGFydGljbGVzIi4KICovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnN0YXJ0ID0gZnVuY3Rpb24gKGV4cGxvZGUsIGxpZmVzcGFuLCBmcmVxdWVuY3ksIHF1YW50aXR5KSB7CgoJaWYgKHR5cGVvZiBleHBsb2RlICE9PSAnYm9vbGVhbicpCgl7CgkJZXhwbG9kZSA9IHRydWU7Cgl9CgoJbGlmZXNwYW4gPSBsaWZlc3BhbiB8fCAwOwoKCS8vCUhvdyBtYW55IG1zIGJldHdlZW4gZW1pc3Npb25zPwoJZnJlcXVlbmN5ID0gZnJlcXVlbmN5IHx8IDI1MDsKCgkvLwlUb3RhbCBudW1iZXIgb2YgcGFydGljbGVzIHRvIGVtaXQKCXF1YW50aXR5ID0gcXVhbnRpdHkgfHwgMDsKCiAgICB0aGlzLnJldml2ZSgpOwoKICAgIHRoaXMudmlzaWJsZSA9IHRydWU7CiAgICB0aGlzLm9uID0gdHJ1ZTsKCiAgICB0aGlzLl9leHBsb2RlID0gZXhwbG9kZTsKICAgIHRoaXMubGlmZXNwYW4gPSBsaWZlc3BhbjsKICAgIHRoaXMuZnJlcXVlbmN5ID0gZnJlcXVlbmN5OwoKICAgIGlmIChleHBsb2RlKQogICAgewogICAgICAgIHRoaXMuX3F1YW50aXR5ID0gcXVhbnRpdHk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgdGhpcy5fcXVhbnRpdHkgKz0gcXVhbnRpdHk7CiAgICB9CgogICAgdGhpcy5fY291bnRlciA9IDA7CiAgICB0aGlzLl90aW1lciA9IHRoaXMuZ2FtZS50aW1lLm5vdyArIGZyZXF1ZW5jeTsKCn0KCi8qKgogKiBUaGlzIGZ1bmN0aW9uIGNhbiBiZSB1c2VkIGJvdGggaW50ZXJuYWxseSBhbmQgZXh0ZXJuYWxseSB0byBlbWl0IHRoZSBuZXh0IHBhcnRpY2xlLgogKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjZW1pdFBhcnRpY2xlCiAqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5lbWl0UGFydGljbGUgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIHBhcnRpY2xlID0gdGhpcy5nZXRGaXJzdEV4aXN0cyhmYWxzZSk7CgogICAgaWYgKHBhcnRpY2xlID09IG51bGwpCiAgICB7CiAgICAJcmV0dXJuOwogICAgfQoKICAgIGlmICh0aGlzLndpZHRoID4gMSB8fCB0aGlzLmhlaWdodCA+IDEpCiAgICB7CiAgICAJcGFydGljbGUucmVzZXQodGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLmxlZnQsIHRoaXMucmlnaHQpLCB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMudG9wLCB0aGlzLmJvdHRvbSkpOwogICAgfQogICAgZWxzZQogICAgewogICAgCXBhcnRpY2xlLnJlc2V0KHRoaXMuZW1pdFgsIHRoaXMuZW1pdFkpOwogICAgfQoKICAgIHBhcnRpY2xlLmxpZmVzcGFuID0gdGhpcy5saWZlc3BhbjsKCiAgICBwYXJ0aWNsZS5ib2R5LmJvdW5jZS5zZXRUbyh0aGlzLmJvdW5jZS54LCB0aGlzLmJvdW5jZS55KTsKCiAgICBpZiAodGhpcy5taW5QYXJ0aWNsZVNwZWVkLnggIT0gdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLngpCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS54ID0gdGhpcy5nYW1lLnJuZC5pbnRlZ2VySW5SYW5nZSh0aGlzLm1pblBhcnRpY2xlU3BlZWQueCwgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLngpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHBhcnRpY2xlLmJvZHkudmVsb2NpdHkueCA9IHRoaXMubWluUGFydGljbGVTcGVlZC54OwogICAgfQoKICAgIGlmICh0aGlzLm1pblBhcnRpY2xlU3BlZWQueSAhPSB0aGlzLm1heFBhcnRpY2xlU3BlZWQueSkKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LnZlbG9jaXR5LnkgPSB0aGlzLmdhbWUucm5kLmludGVnZXJJblJhbmdlKHRoaXMubWluUGFydGljbGVTcGVlZC55LCB0aGlzLm1heFBhcnRpY2xlU3BlZWQueSk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS52ZWxvY2l0eS55ID0gdGhpcy5taW5QYXJ0aWNsZVNwZWVkLnk7CiAgICB9CgogICAgcGFydGljbGUuYm9keS5ncmF2aXR5LnkgPSB0aGlzLmdyYXZpdHk7CgogICAgaWYgKHRoaXMubWluUm90YXRpb24gIT0gdGhpcy5tYXhSb3RhdGlvbikKICAgIHsKICAgICAgICBwYXJ0aWNsZS5ib2R5LmFuZ3VsYXJWZWxvY2l0eSA9IHRoaXMuZ2FtZS5ybmQuaW50ZWdlckluUmFuZ2UodGhpcy5taW5Sb3RhdGlvbiwgdGhpcy5tYXhSb3RhdGlvbik7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgcGFydGljbGUuYm9keS5hbmd1bGFyVmVsb2NpdHkgPSB0aGlzLm1pblJvdGF0aW9uOwogICAgfQoKICAgIGlmICh0aGlzLm1pblBhcnRpY2xlU2NhbGUgIT09IDEgfHwgdGhpcy5tYXhQYXJ0aWNsZVNjYWxlICE9PSAxKQogICAgewogICAgICAgIHZhciBzY2FsZSA9IHRoaXMuZ2FtZS5ybmQucmVhbEluUmFuZ2UodGhpcy5taW5QYXJ0aWNsZVNjYWxlLCB0aGlzLm1heFBhcnRpY2xlU2NhbGUpOwogICAgICAgIHBhcnRpY2xlLnNjYWxlLnNldFRvKHNjYWxlLCBzY2FsZSk7CiAgICB9CgogICAgcGFydGljbGUuYm9keS5kcmFnLnggPSB0aGlzLnBhcnRpY2xlRHJhZy54OwogICAgcGFydGljbGUuYm9keS5kcmFnLnkgPSB0aGlzLnBhcnRpY2xlRHJhZy55OwogICAgcGFydGljbGUuYm9keS5hbmd1bGFyRHJhZyA9IHRoaXMuYW5ndWxhckRyYWc7Cgp9CgovKioKKiBBIG1vcmUgY29tcGFjdCB3YXkgb2Ygc2V0dGluZyB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc2V0U2l6ZQoqIEBwYXJhbSAge251bWJlcn0gd2lkdGggLSBUaGUgZGVzaXJlZCB3aWR0aCBvZiB0aGUgZW1pdHRlciAocGFydGljbGVzIGFyZSBzcGF3bmVkIHJhbmRvbWx5IHdpdGhpbiB0aGVzZSBkaW1lbnNpb25zKS4KKiBAcGFyYW0gIHtudW1iZXJ9IGhlaWdodCAtIFRoZSBkZXNpcmVkIGhlaWdodCBvZiB0aGUgZW1pdHRlci4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuc2V0U2l6ZSA9IGZ1bmN0aW9uICh3aWR0aCwgaGVpZ2h0KSB7CgogICAgdGhpcy53aWR0aCA9IHdpZHRoOwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7Cgp9CgovKioKKiBBIG1vcmUgY29tcGFjdCB3YXkgb2Ygc2V0dGluZyB0aGUgWCB2ZWxvY2l0eSByYW5nZSBvZiB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc2V0WFNwZWVkCiogQHBhcmFtICB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKiBAcGFyYW0gIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zZXRYU3BlZWQgPSBmdW5jdGlvbiAobWluLCBtYXgpIHsKCgltaW4gPSBtaW4gfHwgMDsKCW1heCA9IG1heCB8fCAwOwoKICAgIHRoaXMubWluUGFydGljbGVTcGVlZC54ID0gbWluOwogICAgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLnggPSBtYXg7Cgp9CgovKioKKiBBIG1vcmUgY29tcGFjdCB3YXkgb2Ygc2V0dGluZyB0aGUgWSB2ZWxvY2l0eSByYW5nZSBvZiB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc2V0WVNwZWVkCiogQHBhcmFtICB7bnVtYmVyfSBtaW4gLSBUaGUgbWluaW11bSB2YWx1ZSBmb3IgdGhpcyByYW5nZS4KKiBAcGFyYW0gIHtudW1iZXJ9IG1heCAtIFRoZSBtYXhpbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqLwpQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZS5zZXRZU3BlZWQgPSBmdW5jdGlvbiAobWluLCBtYXgpIHsKCgltaW4gPSBtaW4gfHwgMDsKCW1heCA9IG1heCB8fCAwOwoKICAgIHRoaXMubWluUGFydGljbGVTcGVlZC55ID0gbWluOwogICAgdGhpcy5tYXhQYXJ0aWNsZVNwZWVkLnkgPSBtYXg7Cgp9CgovKioKKiBBIG1vcmUgY29tcGFjdCB3YXkgb2Ygc2V0dGluZyB0aGUgYW5ndWxhciB2ZWxvY2l0eSBjb25zdHJhaW50cyBvZiB0aGUgZW1pdHRlci4KKiBAbWV0aG9kIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjc2V0Um90YXRpb24KKiBAcGFyYW0ge251bWJlcn0gbWluIC0gIFRoZSBtaW5pbXVtIHZhbHVlIGZvciB0aGlzIHJhbmdlLgoqIEBwYXJhbSB7bnVtYmVyfSBtYXggLSAgVGhlIG1heGltdW0gdmFsdWUgZm9yIHRoaXMgcmFuZ2UuCiovClBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLnNldFJvdGF0aW9uID0gZnVuY3Rpb24gKG1pbiwgbWF4KSB7CgoJbWluID0gbWluIHx8IDA7CgltYXggPSBtYXggfHwgMDsKCiAgICB0aGlzLm1pblJvdGF0aW9uID0gbWluOwogICAgdGhpcy5tYXhSb3RhdGlvbiA9IG1heDsKCn0KCi8qKgoqIENoYW5nZSB0aGUgZW1pdHRlcidzIG1pZHBvaW50IHRvIG1hdGNoIHRoZSBtaWRwb2ludCBvZiBhIDxjb2RlPk9iamVjdDwvY29kZT4uCiogQG1ldGhvZCBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2F0CiogQHBhcmFtICB7b2JqZWN0fSBvYmplY3QgLSBUaGUgPGNvZGU+T2JqZWN0PC9jb2RlPiB0aGF0IHlvdSB3YW50IHRvIHN5bmMgdXAgd2l0aC4KKi8KUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUuYXQgPSBmdW5jdGlvbiAob2JqZWN0KSB7CgogICAgdGhpcy5lbWl0WCA9IG9iamVjdC5jZW50ZXIueDsKICAgIHRoaXMuZW1pdFkgPSBvYmplY3QuY2VudGVyLnk7Cgp9CgovKioKKiBUaGUgZW1pdHRlcnMgYWxwaGEgdmFsdWUuCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciNhbHBoYQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBhbHBoYSAtIEdldHMgb3Igc2V0cyB0aGUgYWxwaGEgdmFsdWUgb2YgdGhlIEVtaXR0ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgImFscGhhIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLmFscGhhOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHRoaXMuX2NvbnRhaW5lci5hbHBoYSA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBUaGUgZW1pdHRlciB2aXNpYmxlIHN0YXRlLgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjdmlzaWJsZQoqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdmlzaWJsZSAtIEdldHMgb3Igc2V0cyB0aGUgRW1pdHRlciB2aXNpYmxlIHN0YXRlLgoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlci5wcm90b3R5cGUsICJ2aXNpYmxlIiwgewogICAgCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY29udGFpbmVyLnZpc2libGU7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fY29udGFpbmVyLnZpc2libGUgPSB2YWx1ZTsKICAgIH0KCn0pOwoKLyoqCiogQG5hbWUgUGhhc2VyLlBhcnRpY2xlcy5BcmNhZGUuRW1pdHRlciN4CiogQHByb3BlcnR5IHtudW1iZXJ9IHggLSBHZXRzIG9yIHNldHMgdGhlIHggcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgIngiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZW1pdFg7CiAgICB9LAoKICAgIHNldDogZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdGhpcy5lbWl0WCA9IHZhbHVlOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3kKKiBAcHJvcGVydHkge251bWJlcn0geSAtIEdldHMgb3Igc2V0cyB0aGUgeSBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAieSIsIHsKCiAgICBnZXQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdGhpcy5lbWl0WTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAodmFsdWUpIHsKICAgICAgICB0aGlzLmVtaXRZID0gdmFsdWU7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjbGVmdAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBsZWZ0IC0gR2V0cyB0aGUgbGVmdCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAibGVmdCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy54IC0gKHRoaXMud2lkdGggLyAyKSk7CiAgICB9Cgp9KTsKCi8qKgoqIEBuYW1lIFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIjcmlnaHQKKiBAcHJvcGVydHkge251bWJlcn0gcmlnaHQgLSBHZXRzIHRoZSByaWdodCBwb3NpdGlvbiBvZiB0aGUgRW1pdHRlci4KKiBAcmVhZG9ubHkKKi8KT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5QYXJ0aWNsZXMuQXJjYWRlLkVtaXR0ZXIucHJvdG90eXBlLCAicmlnaHQiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBNYXRoLmZsb29yKHRoaXMueCArICh0aGlzLndpZHRoIC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI3RvcAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3AgLSBHZXRzIHRoZSB0b3AgcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgInRvcCIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy55IC0gKHRoaXMuaGVpZ2h0IC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAbmFtZSBQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyI2JvdHRvbQoqIEBwcm9wZXJ0eSB7bnVtYmVyfSBib3R0b20gLSBHZXRzIHRoZSBib3R0b20gcG9zaXRpb24gb2YgdGhlIEVtaXR0ZXIuCiogQHJlYWRvbmx5CiovCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuUGFydGljbGVzLkFyY2FkZS5FbWl0dGVyLnByb3RvdHlwZSwgImJvdHRvbSIsIHsKICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIE1hdGguZmxvb3IodGhpcy55ICsgKHRoaXMuaGVpZ2h0IC8gMikpOwogICAgfQoKfSk7CgovKioKKiBAYXV0aG9yICAgICAgIFJpY2hhcmQgRGF2ZXkgPHJpY2hAcGhvdG9uc3Rvcm0uY29tPgoqIEBjb3B5cmlnaHQgICAgMjAxMyBQaG90b24gU3Rvcm0gTHRkLgoqIEBsaWNlbnNlICAgICAge0BsaW5rIGh0dHBzOi8vZ2l0aHViLmNvbS9waG90b25zdG9ybS9waGFzZXIvYmxvYi9tYXN0ZXIvbGljZW5zZS50eHR8TUlUIExpY2Vuc2V9CiogQG1vZHVsZSAgICAgICBQaGFzZXIuVGlsZQoqLwoKCi8qKgoqIENyZWF0ZSBhIG5ldyA8Y29kZT5UaWxlPC9jb2RlPi4KKgoqIEBjbGFzcyBQaGFzZXIuVGlsZQoqIEBjbGFzc2Rlc2MgQSBUaWxlIGlzIGEgc2luZ2xlIHJlcHJlc2VudGF0aW9uIG9mIGEgdGlsZSB3aXRoaW4gYSBUaWxlbWFwLgoqIEBjb25zdHJ1Y3RvcgoqIEBwYXJhbSB7UGhhc2VyLkdhbWV9IGdhbWUgLSBBIHJlZmVyZW5jZSB0byB0aGUgY3VycmVudGx5IHJ1bm5pbmcgZ2FtZS4KKiBAcGFyYW0ge1RpbGVtYXB9IHRpbGVtYXAgLSBUaGUgdGlsZW1hcCB0aGlzIHRpbGUgYmVsb25ncyB0by4KKiBAcGFyYW0ge251bWJlcn0gIGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB0eXBlIGluIHRoZSBjb3JlIG1hcCBkYXRhLgoqIEBwYXJhbSB7bnVtYmVyfSAgd2lkdGggLSBXaWR0aCBvZiB0aGUgdGlsZS4KKiBAcGFyYW0ge251bWJlcn0gIGhlaWdodCAtIEhlaWdodCBvZiB0aGUgdGlsZS4KKi8KUGhhc2VyLlRpbGUgPSBmdW5jdGlvbiAodGlsZXNldCwgaW5kZXgsIHgsIHksIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IHRpbGVzZXQgLSBUaGUgdGlsZXNldCB0aGlzIHRpbGUgYmVsb25ncyB0by4KICAgICovCiAgICB0aGlzLnRpbGVzZXQgPSB0aWxlc2V0OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB3aXRoaW4gdGhlIHRpbGVzZXQuCiAgICAqLwogICAgdGhpcy5pbmRleCA9IGluZGV4OwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHdpZHRoIC0gVGhlIHdpZHRoIG9mIHRoZSB0aWxlIGluIHBpeGVscy4KICAgICovCiAgICB0aGlzLndpZHRoID0gd2lkdGg7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gaGVpZ2h0IC0gVGhlIGhlaWdodCBvZiB0aGUgdGlsZSBpbiBwaXhlbHMuCiAgICAqLwogICAgdGhpcy5oZWlnaHQgPSBoZWlnaHQ7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB4IC0gVGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgdGlsZSB3aXRoaW4gdGhlIHRpbGVzZXQuCiAgICAqLwogICAgdGhpcy54ID0geDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB5IC0gVGhlIHRvcC1sZWZ0IGNvcm5lciBvZiB0aGUgdGlsZSB3aXRoaW4gdGhlIHRpbGVzZXQuCiAgICAqLwogICAgdGhpcy55ID0geTsKCiAgICAvLyAgQW55IGV4dHJhIG1ldGEgZGF0YSBpbmZvIHdlIG5lZWQgaGVyZQoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gbWFzcyAtIFRoZSB2aXJ0dWFsIG1hc3Mgb2YgdGhlIHRpbGUuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5tYXNzID0gMS4wOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVOb25lIC0gSW5kaWNhdGluZyB0aGlzIFRpbGUgZG9lc24ndCBjb2xsaWRlIGF0IGFsbC4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtib29sZWFufSBjb2xsaWRlTGVmdCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIGxlZnQuCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlTGVmdCA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpZGVSaWdodCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHJpZ2h0LgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZVJpZ2h0ID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZVVwIC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgdG9wLgogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMuY29sbGlkZVVwID0gZmFsc2U7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlkZURvd24gLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBib3R0b20uCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaWRlRG93biA9IGZhbHNlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNlcGFyYXRlWCAtIEVuYWJsZSBzZXBhcmF0aW9uIGF0IHgtYXhpcy4gCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zZXBhcmF0ZVggPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IHNlcGFyYXRlWSAtIEVuYWJsZSBzZXBhcmF0aW9uIGF0IHktYXhpcy4gCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5zZXBhcmF0ZVkgPSB0cnVlOwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge2Jvb2xlYW59IGNvbGxpc2lvbkNhbGxiYWNrIC0gVGlsZW1hcCBjb2xsaXNpb24gY2FsbGJhY2suCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5jb2xsaXNpb25DYWxsYmFjayA9IG51bGw7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gY29sbGlzaW9uQ2FsbGJhY2sgLSBUaWxlbWFwIGNvbGxpc2lvbiBjYWxsYmFjay4KICAgICogQGRlZmF1bHQKICAgICovCiAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrQ29udGV4dCA9IHRoaXM7Cgp9OwoKUGhhc2VyLlRpbGUucHJvdG90eXBlID0gewoKICAgIC8qKgogICAgKiBTZXQgY2FsbGJhY2sgdG8gYmUgY2FsbGVkIHdoZW4gdGhpcyB0aWxlbWFwIGNvbGxpZGVzLgogICAgKiAKICAgICogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcC5wcm90b3R5cGUuc2V0Q29sbGlzaW9uQ2FsbGJhY2sKICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgLSBDYWxsYmFjayBmdW5jdGlvbi4KICAgICogQHBhcmFtIHtvYmplY3R9IGNvbnRleHQgLSBDYWxsYmFjayB3aWxsIGJlIGNhbGxlZCB3aXRoIHRoaXMgY29udGV4dC4KICAgICovCiAgICBzZXRDb2xsaXNpb25DYWxsYmFjazogZnVuY3Rpb24gKGNhbGxiYWNrLCBjb250ZXh0KSB7CgogICAgICAgIHRoaXMuY29sbGlzaW9uQ2FsbGJhY2tDb250ZXh0ID0gY29udGV4dDsKICAgICAgICB0aGlzLmNvbGxpc2lvbkNhbGxiYWNrID0gY2FsbGJhY2s7CgogICAgfSwKCiAgICAvKioKICAgICogQ2xlYW4gdXAgbWVtb3J5LgogICAgKiBAbWV0aG9kIGRlc3Ryb3kKICAgICovCiAgICBkZXN0cm95OiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMudGlsZXNldCA9IG51bGw7CiAgICAgICAgCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgY29sbGlzaW9uIGNvbmZpZ3MuCiAgICAqIEBtZXRob2Qgc2V0Q29sbGlzaW9uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICBsZWZ0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgbGVmdC4KICAgICogQHBhcmFtIHtib29sZWFufSAgIHJpZ2h0IC0gSW5kaWNhdGluZyBjb2xsaWRlIHdpdGggYW55IG9iamVjdCBvbiB0aGUgcmlnaHQuCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICB1cCAtIEluZGljYXRpbmcgY29sbGlkZSB3aXRoIGFueSBvYmplY3Qgb24gdGhlIHRvcC4KICAgICogQHBhcmFtIHtib29sZWFufSAgIGRvd24gLSBJbmRpY2F0aW5nIGNvbGxpZGUgd2l0aCBhbnkgb2JqZWN0IG9uIHRoZSBib3R0b20uCiAgICAqIEBwYXJhbSB7Ym9vbGVhbn0gICByZXNldCAtIERlc2NyaXB0aW9uLiAKICAgICogQHBhcmFtIHtib29sZWFufSAgIHNlcGFyYXRlWCAtIFNlcGFyYXRlIGF0IHgtYXhpcy4KICAgICogQHBhcmFtIHtib29sZWFufSAgIHNlcGFyYXRlWSAtIFNlcGFyYXRlIGF0IHktYXhpcy4KICAgICovCiAgICBzZXRDb2xsaXNpb246IGZ1bmN0aW9uIChsZWZ0LCByaWdodCwgdXAsIGRvd24pIHsKCiAgICAgICAgdGhpcy5jb2xsaWRlTGVmdCA9IGxlZnQ7CiAgICAgICAgdGhpcy5jb2xsaWRlUmlnaHQgPSByaWdodDsKICAgICAgICB0aGlzLmNvbGxpZGVVcCA9IHVwOwogICAgICAgIHRoaXMuY29sbGlkZURvd24gPSBkb3duOwoKICAgICAgICBpZiAobGVmdCB8fCByaWdodCB8fCB1cCB8fCBkb3duKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5jb2xsaWRlTm9uZSA9IGZhbHNlOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmNvbGxpZGVOb25lID0gdHJ1ZTsKICAgICAgICB9CgogICAgfSwKCiAgICAvKioKICAgICogUmVzZXQgY29sbGlzaW9uIHN0YXR1cyBmbGFncy4KICAgICogQG1ldGhvZCByZXNldENvbGxpc2lvbgogICAgKi8KICAgIHJlc2V0Q29sbGlzaW9uOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIHRoaXMuY29sbGlkZU5vbmUgPSB0cnVlOwogICAgICAgIHRoaXMuY29sbGlkZUxlZnQgPSBmYWxzZTsKICAgICAgICB0aGlzLmNvbGxpZGVSaWdodCA9IGZhbHNlOwogICAgICAgIHRoaXMuY29sbGlkZVVwID0gZmFsc2U7CiAgICAgICAgdGhpcy5jb2xsaWRlRG93biA9IGZhbHNlOwoKICAgIH0KCn07CgpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGUucHJvdG90eXBlLCAiYm90dG9tIiwgewogICAgCiAgICAvKioKICAgICogVGhlIHN1bSBvZiB0aGUgeSBhbmQgaGVpZ2h0IHByb3BlcnRpZXMuIENoYW5naW5nIHRoZSBib3R0b20gcHJvcGVydHkgb2YgYSBSZWN0YW5nbGUgb2JqZWN0IGhhcyBubyBlZmZlY3Qgb24gdGhlIHgsIHkgYW5kIHdpZHRoIHByb3BlcnRpZXMsIGJ1dCBkb2VzIGNoYW5nZSB0aGUgaGVpZ2h0IHByb3BlcnR5LgogICAgKiBAbWV0aG9kIGJvdHRvbQogICAgKiBAcmV0dXJuIHtudW1iZXJ9CiAgICAqKi8KICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLnkgKyB0aGlzLmhlaWdodDsKICAgIH0KCn0pOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KFBoYXNlci5UaWxlLnByb3RvdHlwZSwgInJpZ2h0IiwgewogICAgCiAgICAvKioKICAgICogVGhlIHN1bSBvZiB0aGUgeCBhbmQgd2lkdGggcHJvcGVydGllcy4gQ2hhbmdpbmcgdGhlIHJpZ2h0IHByb3BlcnR5IG9mIGEgUmVjdGFuZ2xlIG9iamVjdCBoYXMgbm8gZWZmZWN0IG9uIHRoZSB4LCB5IGFuZCBoZWlnaHQgcHJvcGVydGllcy4KICAgICogSG93ZXZlciBpdCBkb2VzIGFmZmVjdCB0aGUgd2lkdGggcHJvcGVydHkuCiAgICAqIEBtZXRob2QgcmlnaHQKICAgICogQHJldHVybiB7bnVtYmVyfQogICAgKiovICAgIAogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMueCArIHRoaXMud2lkdGg7CiAgICB9Cgp9KTsKClBoYXNlci5UaWxlbWFwID0gZnVuY3Rpb24gKGdhbWUsIGtleSkgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gRGVzY3JpcHRpb24uCgkqLyAKICAgIHRoaXMuZ2FtZSA9IGdhbWU7CgogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7YXJyYXl9IGxheWVycyAtIERlc2NyaXB0aW9uLgogICAgKi8KCXRoaXMubGF5ZXJzOwoKICAgIGlmICh0eXBlb2Yga2V5ID09PSAnc3RyaW5nJykKICAgIHsKICAgIAl0aGlzLmtleSA9IGtleTsKCgkJdGhpcy5sYXllcnMgPSBnYW1lLmNhY2hlLmdldFRpbGVtYXBEYXRhKGtleSkubGF5ZXJzOwogICAgICAgIHRoaXMuY2FsY3VsYXRlSW5kZXhlcygpOwogICAgfQogICAgZWxzZQogICAgewoJICAgIHRoaXMubGF5ZXJzID0gW107CiAgICB9CgogICAgdGhpcy5jdXJyZW50TGF5ZXIgPSAwOwoKICAgIHRoaXMuZGVidWdNYXAgPSBbXTsKCiAgICB0aGlzLmRpcnR5ID0gZmFsc2U7CgogICAgdGhpcy5fcmVzdWx0cyA9IFtdOwogICAgdGhpcy5fdGVtcEEgPSAwOwogICAgdGhpcy5fdGVtcEIgPSAwOwoKfTsKClBoYXNlci5UaWxlbWFwLkNTViA9IDA7ClBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04gPSAxOwoKUGhhc2VyLlRpbGVtYXAucHJvdG90eXBlID0gewoKICAgIGNyZWF0ZTogZnVuY3Rpb24gKG5hbWUsIHdpZHRoLCBoZWlnaHQpIHsKCiAgICAgICAgdmFyIGRhdGEgPSBbXTsKCiAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCBoZWlnaHQ7IHkrKykKICAgICAgICB7CiAgICAgICAgICAgIGRhdGFbeV0gPSBbXTsKCiAgICAgICAgICAgIGZvciAodmFyIHggPSAwOyB4IDwgd2lkdGg7IHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgZGF0YVt5XVt4XSA9IDA7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMuY3VycmVudExheWVyID0gdGhpcy5sYXllcnMucHVzaCh7CgoJCQluYW1lOiBuYW1lLCAKCQkJd2lkdGg6IHdpZHRoLCAKCQkJaGVpZ2h0OiBoZWlnaHQsIAoJCQlhbHBoYTogMSwgCgkJCXZpc2libGU6IHRydWUsIAoJCQl0aWxlTWFyZ2luOiAwLCAKCQkJdGlsZVNwYWNpbmc6IDAsCgkJCWZvcm1hdDogUGhhc2VyLlRpbGVtYXAuQ1NWLAoJCQlkYXRhOiBkYXRhLAogICAgICAgICAgICBpbmRleGVzOiBbXQoKICAgICAgICB9KTsKCiAgICAgICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgfSwKCiAgICBjYWxjdWxhdGVJbmRleGVzOiBmdW5jdGlvbiAoKSB7CgogICAgICAgIGZvciAodmFyIGxheWVyID0gMDsgbGF5ZXIgPCB0aGlzLmxheWVycy5sZW5ndGg7IGxheWVyKyspCiAgICAgICAgewogICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uaW5kZXhlcyA9IFtdOwoKICAgICAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0IDsgeSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMubGF5ZXJzW2xheWVyXS53aWR0aDsgeCsrKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMubGF5ZXJzW2xheWVyXS5pbmRleGVzLmluZGV4T2YoaWR4KSA9PT0gLTEpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxheWVyc1tsYXllcl0uaW5kZXhlcy5wdXNoKGlkeCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH0sCgogICAgc2V0TGF5ZXI6IGZ1bmN0aW9uIChsYXllcikgewoKICAgIAlpZiAodGhpcy5sYXllcnNbbGF5ZXJdKQogICAgCXsKICAgIAkJdGhpcy5jdXJyZW50TGF5ZXIgPSBsYXllcjsKICAgIAl9CgogICAgfSwKCiAgICAvKioKICAgICogU2V0IGEgc3BlY2lmaWMgdGlsZSB3aXRoIGl0cyB4IGFuZCB5IGluIHRpbGVzLgogICAgKiBAbWV0aG9kIHB1dFRpbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoaXMgdGlsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoaXMgdGlsZS4KICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB0eXBlIGluIHRoZSBjb3JlIG1hcCBkYXRhLgogICAgKi8KICAgIHB1dFRpbGU6IGZ1bmN0aW9uIChpbmRleCwgeCwgeSwgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gInVuZGVmaW5lZCIpIHsgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsgfQoKICAgIAlpZiAoeCA+PSAwICYmIHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGggJiYgeSA+PSAwICYmIHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0KQogICAgCXsKICAgIAkJdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbeV1beF0gPSBpbmRleDsKICAgIAl9CgogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIH0sCgogICAgZ2V0VGlsZTogZnVuY3Rpb24gKHgsIHksIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxheWVyc1tsYXllcl0uZGF0YVt5XVt4XTsKICAgICAgICB9CgogICAgfSwKCiAgICBnZXRUaWxlV29ybGRYWTogZnVuY3Rpb24gKHgsIHksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gInVuZGVmaW5lZCIpIHsgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsgfQoKICAgICAgICB4ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeCwgdGlsZVdpZHRoKSAvIHRpbGVXaWR0aDsKICAgICAgICB5ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeSwgdGlsZUhlaWdodCkgLyB0aWxlSGVpZ2h0OwoKICAgICAgICBpZiAoeCA+PSAwICYmIHggPCB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGggJiYgeSA+PSAwICYmIHkgPCB0aGlzLmxheWVyc1tsYXllcl0uaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTZXQgYSBzcGVjaWZpYyB0aWxlIHdpdGggaXRzIHggYW5kIHkgaW4gdGlsZXMuCiAgICAqIEBtZXRob2QgcHV0VGlsZVdvcmxkWFkKICAgICogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoaXMgdGlsZSBpbiB3b3JsZCBjb29yZGluYXRlcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IHkgLSBZIHBvc2l0aW9uIG9mIHRoaXMgdGlsZSBpbiB3b3JsZCBjb29yZGluYXRlcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gVGhlIGluZGV4IG9mIHRoaXMgdGlsZSB0eXBlIGluIHRoZSBjb3JlIG1hcCBkYXRhLgogICAgKi8KICAgIHB1dFRpbGVXb3JsZFhZOiBmdW5jdGlvbiAoaW5kZXgsIHgsIHksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgeCA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHgsIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICAgICAgeSA9IHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKCiAgICAgICAgaWYgKHggPj0gMCAmJiB4IDwgdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoICYmIHkgPj0gMCAmJiB5IDwgdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhW3ldW3hdID0gaW5kZXg7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCiAgICB9LAoKICAgIC8vICBWYWx1ZXMgYXJlIGluIFRJTEVzLCBub3QgcGl4ZWxzLgogICAgY29weTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAgICAgaWYgKCF0aGlzLmxheWVyc1tsYXllcl0pCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgeCA9PT0gInVuZGVmaW5lZCIpIHsgeCA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIHkgPT09ICJ1bmRlZmluZWQiKSB7IHkgPSAwOyB9CiAgICAgICAgaWYgKHR5cGVvZiB3aWR0aCA9PT0gInVuZGVmaW5lZCIpIHsgd2lkdGggPSB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7IH0KICAgICAgICBpZiAodHlwZW9mIGhlaWdodCA9PT0gInVuZGVmaW5lZCIpIHsgaGVpZ2h0ID0gdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodDsgfQoKICAgICAgICBpZiAoeCA8IDApCiAgICAgICAgewogICAgICAgICAgICB4ID0gMDsKICAgICAgICB9CgogICAgICAgIGlmICh5IDwgMCkKICAgICAgICB7CiAgICAgICAgICAgIHkgPSAwOwogICAgICAgIH0KCiAgICAgICAgaWYgKHdpZHRoID4gdGhpcy5sYXllcnNbbGF5ZXJdLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgd2lkdGggPSB0aGlzLmxheWVyc1tsYXllcl0ud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAoaGVpZ2h0ID4gdGhpcy5sYXllcnNbbGF5ZXJdLmhlaWdodCkKICAgICAgICB7CiAgICAgICAgICAgIGhlaWdodCA9IHRoaXMubGF5ZXJzW2xheWVyXS5oZWlnaHQ7CiAgICAgICAgfQoKICAgICAgICB0aGlzLl9yZXN1bHRzLmxlbmd0aCA9IDA7CgogICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCggeyB4OiB4LCB5OiB5LCB3aWR0aDogd2lkdGgsIGhlaWdodDogaGVpZ2h0LCBsYXllcjogbGF5ZXIgfSk7CgogICAgICAgIGZvciAodmFyIHR5ID0geTsgdHkgPCB5ICsgaGVpZ2h0OyB0eSsrKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgdHggPSB4OyB0eCA8IHggKyB3aWR0aDsgdHgrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fcmVzdWx0cy5wdXNoKHsgeDogdHgsIHk6IHR5LCBpbmRleDogdGhpcy5sYXllcnNbbGF5ZXJdLmRhdGFbdHldW3R4XSB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHRoaXMuX3Jlc3VsdHM7CgogICAgfSwKCiAgICBwYXN0ZTogZnVuY3Rpb24gKHgsIHksIHRpbGVibG9jaywgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiB4ID09PSAidW5kZWZpbmVkIikgeyB4ID0gMDsgfQogICAgICAgIGlmICh0eXBlb2YgeSA9PT0gInVuZGVmaW5lZCIpIHsgeSA9IDA7IH0KICAgICAgICBpZiAodHlwZW9mIGxheWVyID09PSAidW5kZWZpbmVkIikgeyBsYXllciA9IHRoaXMuY3VycmVudExheWVyOyB9CgogICAgICAgIGlmICghdGlsZWJsb2NrIHx8IHRpbGVibG9jay5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgLy8gIEZpbmQgb3V0IHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdGlsZWJsb2NrWzFdLngveSBhbmQgeC95IGFuZCB1c2UgaXQgYXMgYW4gb2Zmc2V0LCBhcyBpdCdzIHRoZSB0b3AgbGVmdCBvZiB0aGUgYmxvY2sgdG8gcGFzdGUKICAgICAgICB2YXIgZGlmZlggPSB0aWxlYmxvY2tbMV0ueCAtIHg7CiAgICAgICAgdmFyIGRpZmZZID0gdGlsZWJsb2NrWzFdLnkgLSB5OwoKICAgICAgICBmb3IgKHZhciBpID0gMTsgaSA8IHRpbGVibG9jay5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMubGF5ZXJzW2xheWVyXS5kYXRhWyBkaWZmWSArIHRpbGVibG9ja1tpXS55IF1bIGRpZmZYICsgdGlsZWJsb2NrW2ldLnggXSA9IHRpbGVibG9ja1tpXS5pbmRleDsKICAgICAgICB9CgogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFN3YXAgdGlsZXMgd2l0aCAyIGtpbmRzIG9mIGluZGV4ZXMuCiAgICAqIEBtZXRob2Qgc3dhcFRpbGUKICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVBIC0gRmlyc3QgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IHRpbGVCIC0gU2Vjb25kIHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB4IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt5XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHkgcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHdpZHRoIGluIHRpbGVzLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSBoZWlnaHQgaW4gdGlsZXMuCiAgICAqLwogICAgc3dhcDogZnVuY3Rpb24gKHRpbGVBLCB0aWxlQiwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3RlbXBBID0gdGlsZUE7CiAgICAgICAgdGhpcy5fdGVtcEIgPSB0aWxlQjsKCiAgICAgICAgdGhpcy5fcmVzdWx0cy5mb3JFYWNoKHRoaXMuc3dhcEhhbmRsZXIsIHRoaXMpOwoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMpOwoKICAgIH0sCgogICAgc3dhcEhhbmRsZXI6IGZ1bmN0aW9uICh2YWx1ZSwgaW5kZXgsIGFycmF5KSB7CgogICAgICAgIGlmICh2YWx1ZS5pbmRleCA9PT0gdGhpcy5fdGVtcEEpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2luZGV4XS5pbmRleCA9IHRoaXMuX3RlbXBCOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmICh2YWx1ZS5pbmRleCA9PT0gdGhpcy5fdGVtcEIpCiAgICAgICAgewogICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2luZGV4XS5pbmRleCA9IHRoaXMuX3RlbXBBOwogICAgICAgIH0KCiAgICB9LAoKICAgIC8qKgogICAgKiBTd2FwIHRpbGVzIHdpdGggMiBraW5kcyBvZiBpbmRleGVzLgogICAgKiBAbWV0aG9kIHN3YXBUaWxlCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQSAtIEZpcnN0IHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQiAtIFNlY29uZCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeCBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB5IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB3aWR0aCBpbiB0aWxlcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHRdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgaGVpZ2h0IGluIHRpbGVzLgogICAgKi8KICAgIGZvckVhY2g6IGZ1bmN0aW9uIChjYWxsYmFjaywgY29udGV4dCwgeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHRoaXMuX3Jlc3VsdHMuZm9yRWFjaChjYWxsYmFjaywgY29udGV4dCk7CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cyk7CgogICAgfSwKCiAgICAvKioKICAgICogUmVwbGFjZXMgb25lIHR5cGUgb2YgdGlsZSB3aXRoIGFub3RoZXIuCiAgICAqIEBtZXRob2QgcmVwbGFjZQogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUEgLSBGaXJzdCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUIgLSBTZWNvbmQgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHggcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeSBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgd2lkdGggaW4gdGlsZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIGhlaWdodCBpbiB0aWxlcy4KICAgICovCiAgICByZXBsYWNlOiBmdW5jdGlvbiAodGlsZUEsIHRpbGVCLCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPT09IHRpbGVBKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0aGlzLl9yZXN1bHRzW2ldLmluZGV4ID0gdGlsZUI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHRoaXMucGFzdGUoeCwgeSwgdGhpcy5fcmVzdWx0cyk7CgogICAgfSwKCiAgICAvKioKICAgICogUmFuZG9taXNlcyBhIHNldCBvZiB0aWxlcyBpbiBhIGdpdmVuIGFyZWEuIEl0IHdpbGwgb25seSByYW5kb21pc2UgdGhlIHRpbGVzIGluIHRoYXQgYXJlYSwgc28gaWYgdGhleSdyZSBhbGwgdGhlIHNhbWUgbm90aGluZyB3aWxsIGFwcGVhciB0byBoYXZlIGNoYW5nZWQhCiAgICAqIEBtZXRob2QgcmFuZG9tCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQSAtIEZpcnN0IHRpbGUgaW5kZXguCiAgICAqIEBwYXJhbSB7bnVtYmVyfSB0aWxlQiAtIFNlY29uZCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeCBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbeV0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB5IHBvc2l0aW9uIGluIHRpbGVzIG9mIFJlY3RhbmdsZSdzIGxlZnQtdG9wIGNvcm5lci4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt3aWR0aF0gLSBzcGVjaWZ5IGEgUmVjdGFuZ2xlIG9mIHRpbGVzIHRvIG9wZXJhdGUuIFRoZSB3aWR0aCBpbiB0aWxlcy4KICAgICogQHBhcmFtIHtudW1iZXJ9IFtoZWlnaHRdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgaGVpZ2h0IGluIHRpbGVzLgogICAgKi8KICAgIHJhbmRvbTogZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKSB7CgogICAgICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICJ1bmRlZmluZWQiKSB7IGxheWVyID0gdGhpcy5jdXJyZW50TGF5ZXI7IH0KCiAgICAgICAgdGhpcy5jb3B5KHgsIHksIHdpZHRoLCBoZWlnaHQsIGxheWVyKTsKCiAgICAgICAgaWYgKHRoaXMuX3Jlc3VsdHMubGVuZ3RoIDwgMikKICAgICAgICB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHZhciBpbmRleGVzID0gW107CgogICAgICAgIGZvciAodmFyIHQgPSAxOyB0IDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IHQrKykKICAgICAgICB7CiAgICAgICAgICAgIHZhciBpZHggPSB0aGlzLl9yZXN1bHRzW3RdLmluZGV4OwoKICAgICAgICAgICAgaWYgKGluZGV4ZXMuaW5kZXhPZihpZHgpID09PSAtMSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgaW5kZXhlcy5wdXNoKGlkeCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgdGhpcy5fcmVzdWx0cy5sZW5ndGg7IGkrKykKICAgICAgICB7CiAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHNbaV0uaW5kZXggPSB0aGlzLmdhbWUucm5kLnBpY2soaW5kZXhlcyk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIFJhbmRvbWlzZXMgYSBzZXQgb2YgdGlsZXMgaW4gYSBnaXZlbiBhcmVhLiBJdCB3aWxsIG9ubHkgcmFuZG9taXNlIHRoZSB0aWxlcyBpbiB0aGF0IGFyZWEsIHNvIGlmIHRoZXkncmUgYWxsIHRoZSBzYW1lIG5vdGhpbmcgd2lsbCBhcHBlYXIgdG8gaGF2ZSBjaGFuZ2VkIQogICAgKiBAbWV0aG9kIHJhbmRvbQogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUEgLSBGaXJzdCB0aWxlIGluZGV4LgogICAgKiBAcGFyYW0ge251bWJlcn0gdGlsZUIgLSBTZWNvbmQgdGlsZSBpbmRleC4KICAgICogQHBhcmFtIHtudW1iZXJ9IFt4XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIHggcG9zaXRpb24gaW4gdGlsZXMgb2YgUmVjdGFuZ2xlJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgeSBwb3NpdGlvbiBpbiB0aWxlcyBvZiBSZWN0YW5nbGUncyBsZWZ0LXRvcCBjb3JuZXIuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbd2lkdGhdIC0gc3BlY2lmeSBhIFJlY3RhbmdsZSBvZiB0aWxlcyB0byBvcGVyYXRlLiBUaGUgd2lkdGggaW4gdGlsZXMuCiAgICAqIEBwYXJhbSB7bnVtYmVyfSBbaGVpZ2h0XSAtIHNwZWNpZnkgYSBSZWN0YW5nbGUgb2YgdGlsZXMgdG8gb3BlcmF0ZS4gVGhlIGhlaWdodCBpbiB0aWxlcy4KICAgICovCiAgICBzaHVmZmxlOiBmdW5jdGlvbiAoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpIHsKCiAgICAgICAgaWYgKHR5cGVvZiBsYXllciA9PT0gInVuZGVmaW5lZCIpIHsgbGF5ZXIgPSB0aGlzLmN1cnJlbnRMYXllcjsgfQoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdmFyIGhlYWRlciA9IHRoaXMuX3Jlc3VsdHMuc2hpZnQoKTsKCiAgICAgICAgUGhhc2VyLlV0aWxzLnNodWZmbGUodGhpcy5fcmVzdWx0cyk7CgogICAgICAgIHRoaXMuX3Jlc3VsdHMudW5zaGlmdChoZWFkZXIpOwoKICAgICAgICB0aGlzLnBhc3RlKHgsIHksIHRoaXMuX3Jlc3VsdHMpOwoKICAgIH0sCgogICAgLyoqCiAgICAqIEZpbGwgYSB0aWxlIGJsb2NrIHdpdGggYSBzcGVjaWZpYyB0aWxlIGluZGV4LgogICAgKiBAbWV0aG9kIGZpbGwKICAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IC0gSW5kZXggb2YgdGlsZXMgeW91IHdhbnQgdG8gZmlsbCB3aXRoLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3hdIC0gWCBwb3NpdGlvbiAoaW4gdGlsZXMpIG9mIGJsb2NrJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3ldIC0gWSBwb3NpdGlvbiAoaW4gdGlsZXMpIG9mIGJsb2NrJ3MgbGVmdC10b3AgY29ybmVyLgogICAgKiBAcGFyYW0ge251bWJlcn0gW3dpZHRoXSAtIHdpZHRoIG9mIGJsb2NrLgogICAgKiBAcGFyYW0ge251bWJlcn0gW2hlaWdodF0gLSBoZWlnaHQgb2YgYmxvY2suCiAgICAqLwogICAgZmlsbDogZnVuY3Rpb24gKGluZGV4LCB4LCB5LCB3aWR0aCwgaGVpZ2h0LCBsYXllcikgewoKICAgICAgICB0aGlzLmNvcHkoeCwgeSwgd2lkdGgsIGhlaWdodCwgbGF5ZXIpOwoKICAgICAgICBpZiAodGhpcy5fcmVzdWx0cy5sZW5ndGggPCAyKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLl9yZXN1bHRzLmxlbmd0aDsgaSsrKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fcmVzdWx0c1tpXS5pbmRleCA9IGluZGV4OwogICAgICAgIH0KCiAgICAgICAgdGhpcy5wYXN0ZSh4LCB5LCB0aGlzLl9yZXN1bHRzKTsKCiAgICB9LAoKICAgIHJlbW92ZUFsbExheWVyczogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLmxheWVycy5sZW5ndGggPSAwOwogICAgICAgIHRoaXMuY3VycmVudExheWVyID0gMDsKCiAgICB9LAoKICAgIGR1bXA6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIHR4dCA9ICcnOwogICAgICAgIHZhciBhcmdzID0gWycnXTsKCiAgICAgICAgZm9yICh2YXIgeSA9IDA7IHkgPCB0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0uaGVpZ2h0OyB5KyspCiAgICAgICAgewogICAgICAgICAgICBmb3IgKHZhciB4ID0gMDsgeCA8IHRoaXMubGF5ZXJzW3RoaXMuY3VycmVudExheWVyXS53aWR0aDsgeCsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICB0eHQgKz0gIiVjICAiOwoKICAgICAgICAgICAgICAgIGlmICh0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0uZGF0YVt5XVt4XSA+IDEpCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAJaWYgKHRoaXMuZGVidWdNYXBbdGhpcy5sYXllcnNbdGhpcy5jdXJyZW50TGF5ZXJdLmRhdGFbeV1beF1dKQogICAgICAgICAgICAgICAgCXsKCSAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKCJiYWNrZ3JvdW5kOiAiICsgdGhpcy5kZWJ1Z01hcFt0aGlzLmxheWVyc1t0aGlzLmN1cnJlbnRMYXllcl0uZGF0YVt5XVt4XV0pOwogICAgICAgICAgICAgICAgCX0KICAgICAgICAgICAgICAgIAllbHNlCiAgICAgICAgICAgICAgICAJewoJICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goImJhY2tncm91bmQ6ICNmZmZmZmYiKTsKICAgICAgICAgICAgICAgIAl9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKCJiYWNrZ3JvdW5kOiByZ2IoMCwgMCwgMCkiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgdHh0ICs9ICJcbiI7CiAgICAgICAgfQoKICAgICAgICBhcmdzWzBdID0gdHh0OwogICAgICAgIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIGFyZ3MpOwoKICAgIH0sCgogICAgZGVzdHJveTogZnVuY3Rpb24gKCkgewoKICAgICAgICB0aGlzLnJlbW92ZUFsbExheWVycygpOwogICAgICAgIHRoaXMuZ2FtZSA9IG51bGw7CgogICAgfQoKfTsKCi8vICBNYXliZSBzaG91bGQgZXh0ZW5kIFNwcml0ZT8KUGhhc2VyLlRpbGVtYXBMYXllciA9IGZ1bmN0aW9uIChnYW1lLCB4LCB5LCByZW5kZXJXaWR0aCwgcmVuZGVySGVpZ2h0LCB0aWxlc2V0LCB0aWxlbWFwLCBsYXllcikgewoKCS8qKgoJKiBAcHJvcGVydHkge1BoYXNlci5HYW1lfSBnYW1lIC0gRGVzY3JpcHRpb24uCgkqLyAKICAgIHRoaXMuZ2FtZSA9IGdhbWU7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBjYW52YXMgLSBEZXNjcmlwdGlvbi4KCSogQGRlZmF1bHQKCSovCiAgICB0aGlzLmNhbnZhcyA9IFBoYXNlci5DYW52YXMuY3JlYXRlKHJlbmRlcldpZHRoLCByZW5kZXJIZWlnaHQpOwogICAgCgkvKioKCSogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gY29udGV4dCAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuY29udGV4dCA9IHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJyk7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSBiYXNlVGV4dHVyZSAtIERlc2NyaXB0aW9uLgoJKiBAZGVmYXVsdAoJKi8KICAgIHRoaXMuYmFzZVRleHR1cmUgPSBuZXcgUElYSS5CYXNlVGV4dHVyZSh0aGlzLmNhbnZhcyk7CiAgICAKCS8qKgoJKiBAcHJvcGVydHkge0Rlc2NyaXB0aW9ufSB0ZXh0dXJlIC0gRGVzY3JpcHRpb24uCgkqIEBkZWZhdWx0CgkqLwogICAgdGhpcy50ZXh0dXJlID0gbmV3IFBJWEkuVGV4dHVyZSh0aGlzLmJhc2VUZXh0dXJlKTsKICAgIAogICAgdGhpcy50ZXh0dXJlRnJhbWUgPSBuZXcgUGhhc2VyLkZyYW1lKDAsIDAsIDAsIHJlbmRlcldpZHRoLCByZW5kZXJIZWlnaHQsICd0aWxlbWFwbGF5ZXInLCBnYW1lLnJuZC51dWlkKCkpOwoKICAgIFBoYXNlci5TcHJpdGUuY2FsbCh0aGlzLCB0aGlzLmdhbWUsIHgsIHksIHRoaXMudGV4dHVyZSwgdGhpcy50ZXh0dXJlRnJhbWUpOwoKICAgIHRoaXMudHlwZSA9IFBoYXNlci5USUxFTUFQTEFZRVI7CgogICAgdGhpcy5maXhlZFRvQ2FtZXJhID0gdHJ1ZTsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtEZXNjcmlwdGlvbn0gdGlsZXNldCAtIERlc2NyaXB0aW9uLgogICAgKi8KICAgIHRoaXMudGlsZXNldCA9IG51bGw7CgogICAgdGhpcy50aWxlV2lkdGggPSAwOwogICAgdGhpcy50aWxlSGVpZ2h0ID0gMDsKICAgIHRoaXMudGlsZU1hcmdpbiA9IDA7CiAgICB0aGlzLnRpbGVTcGFjaW5nID0gMDsKCiAgICAvKioKICAgICogUmVhZC1vbmx5IHZhcmlhYmxlLCBkbyBOT1QgcmVjb21tZW5kIGNoYW5naW5nIGFmdGVyIHRoZSBtYXAgaXMgbG9hZGVkIQogICAgKiBAcHJvcGVydHkge251bWJlcn0gd2lkdGhJblBpeGVscwogICAgKiBAZGVmYXVsdAogICAgKi8KICAgIHRoaXMud2lkdGhJblBpeGVscyA9IDA7CgogICAgLyoqCiAgICAqIFJlYWQtb25seSB2YXJpYWJsZSwgZG8gTk9UIHJlY29tbWVuZCBjaGFuZ2luZyBhZnRlciB0aGUgbWFwIGlzIGxvYWRlZCEKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IGhlaWdodEluUGl4ZWxzCiAgICAqIEBkZWZhdWx0CiAgICAqLwogICAgdGhpcy5oZWlnaHRJblBpeGVscyA9IDA7CgoKICAgIHRoaXMucmVuZGVyV2lkdGggPSByZW5kZXJXaWR0aDsKICAgIHRoaXMucmVuZGVySGVpZ2h0ID0gcmVuZGVySGVpZ2h0OwoKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2dhIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9nYSA9IDE7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R4IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9keCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R5IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9keSA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2R3IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9kdyA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX2RoIC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl9kaCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3R4IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90eCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3R5IC0gTG9jYWwgcmVuZGVyIGxvb3AgdmFyIHRvIGhlbHAgYXZvaWQgZ2Mgc3Bpa2VzLgogICAgKiBAcHJpdmF0ZSAKICAgICovCiAgICB0aGlzLl90eSA9IDA7CgogICAgdGhpcy5fcmVzdWx0cyA9IFtdOwoKICAgIHRoaXMuX3R3ID0gMDsKICAgIHRoaXMuX3RoID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfdGwgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3RsID0gMDsKICAgIAogICAgLyoqCiAgICAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBfbWF4WCAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fbWF4WCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX21heFkgLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX21heFkgPSAwOwogICAgCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IF9zdGFydFggLSBMb2NhbCByZW5kZXIgbG9vcCB2YXIgdG8gaGVscCBhdm9pZCBnYyBzcGlrZXMuCiAgICAqIEBwcml2YXRlIAogICAgKi8KICAgIHRoaXMuX3N0YXJ0WCA9IDA7CiAgICAKICAgIC8qKgogICAgKiBAcHJvcGVydHkge251bWJlcn0gX3N0YXJ0WSAtIExvY2FsIHJlbmRlciBsb29wIHZhciB0byBoZWxwIGF2b2lkIGdjIHNwaWtlcy4KICAgICogQHByaXZhdGUgCiAgICAqLwogICAgdGhpcy5fc3RhcnRZID0gMDsKCiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbEZhY3RvclggLSBzcGVlZCBhdCB3aGljaCB0aGlzIGxheWVyIHNjcm9sbHMKCSogaG9yaXpvbnRhbGx5LCByZWxhdGl2ZSB0byB0aGUgY2FtZXJhIChlLmcuIHNjcm9sbEZhY3Rvclggb2YgMC41IHNjcm9sbHMKCSogaGFsZiBhcyBxdWlja2x5IGFzIHRoZSAnbm9ybWFsJyBjYW1lcmEtbG9ja2VkIGxheWVycyBkbykKCSogQGRlZmF1bHQgMQogICAgKi8KCXRoaXMuc2Nyb2xsRmFjdG9yWCA9IDE7CiAgICAvKioKICAgICogQHByb3BlcnR5IHtudW1iZXJ9IHNjcm9sbEZhY3RvclkgLSBzcGVlZCBhdCB3aGljaCB0aGlzIGxheWVyIHNjcm9sbHMKCSogdmVydGljYWxseSwgcmVsYXRpdmUgdG8gdGhlIGNhbWVyYSAoZS5nLiBzY3JvbGxGYWN0b3JZIG9mIDAuNSBzY3JvbGxzCgkqIGhhbGYgYXMgcXVpY2tseSBhcyB0aGUgJ25vcm1hbCcgY2FtZXJhLWxvY2tlZCBsYXllcnMgZG8pCgkqIEBkZWZhdWx0IDEKICAgICovCgl0aGlzLnNjcm9sbEZhY3RvclkgPSAxOwoKICAgIHRoaXMudGlsZW1hcCA9IG51bGw7CiAgICB0aGlzLmxheWVyID0gbnVsbDsKICAgIHRoaXMuaW5kZXggPSAwOwoKICAgIHRoaXMuX3ggPSAwOwogICAgdGhpcy5feSA9IDA7CiAgICB0aGlzLl9wcmV2WCA9IDA7CiAgICB0aGlzLl9wcmV2WSA9IDA7CgogICAgdGhpcy5kaXJ0eSA9IHRydWU7CgogICAgaWYgKHRpbGVzZXQgaW5zdGFuY2VvZiBQaGFzZXIuVGlsZXNldCB8fCB0eXBlb2YgdGlsZXNldCA9PT0gJ3N0cmluZycpCiAgICB7CiAgICAgICAgdGhpcy51cGRhdGVUaWxlc2V0KHRpbGVzZXQpOwogICAgfQoKICAgIGlmICh0aWxlbWFwIGluc3RhbmNlb2YgUGhhc2VyLlRpbGVtYXApCiAgICB7CiAgICAgICAgdGhpcy51cGRhdGVNYXBEYXRhKHRpbGVtYXAsIGxheWVyKTsKICAgIH0KCn07CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoUGhhc2VyLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSA9IFBoYXNlci5VdGlscy5leHRlbmQodHJ1ZSwgUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUsIFBoYXNlci5TcHJpdGUucHJvdG90eXBlLCBQSVhJLlNwcml0ZS5wcm90b3R5cGUpOwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IFBoYXNlci5UaWxlbWFwTGF5ZXI7CgoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24gKCkgewoKICAgIHRoaXMuc2Nyb2xsWCA9IHRoaXMuZ2FtZS5jYW1lcmEueCAqIHRoaXMuc2Nyb2xsRmFjdG9yWDsKICAgIHRoaXMuc2Nyb2xsWSA9IHRoaXMuZ2FtZS5jYW1lcmEueSAqIHRoaXMuc2Nyb2xsRmFjdG9yWTsKCiAgICB0aGlzLnJlbmRlcigpOwoKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUucmVzaXplV29ybGQgPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5nYW1lLndvcmxkLnNldEJvdW5kcygwLCAwLCB0aGlzLndpZHRoSW5QaXhlbHMsIHRoaXMuaGVpZ2h0SW5QaXhlbHMpOwoKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUudXBkYXRlVGlsZXNldCA9IGZ1bmN0aW9uICh0aWxlc2V0KSB7CgogICAgaWYgKHRpbGVzZXQgaW5zdGFuY2VvZiBQaGFzZXIuVGlsZXNldCkKICAgIHsKICAgICAgICB0aGlzLnRpbGVzZXQgPSB0aWxlc2V0OwogICAgfQogICAgZWxzZSBpZiAodHlwZW9mIHRpbGVzZXQgPT09ICdzdHJpbmcnKQogICAgewogICAgICAgIHRoaXMudGlsZXNldCA9IHRoaXMuZ2FtZS5jYWNoZS5nZXRUaWxlc2V0KCd0aWxlcycpOwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIHJldHVybjsKICAgIH0KCiAgICB0aGlzLnRpbGVXaWR0aCA9IHRoaXMudGlsZXNldC50aWxlV2lkdGg7CiAgICB0aGlzLnRpbGVIZWlnaHQgPSB0aGlzLnRpbGVzZXQudGlsZUhlaWdodDsKICAgIHRoaXMudGlsZU1hcmdpbiA9IHRoaXMudGlsZXNldC50aWxlTWFyZ2luOwogICAgdGhpcy50aWxlU3BhY2luZyA9IHRoaXMudGlsZXNldC50aWxlU3BhY2luZzsKCiAgICB0aGlzLnVwZGF0ZU1heCgpOwoKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUudXBkYXRlTWFwRGF0YSA9IGZ1bmN0aW9uICh0aWxlbWFwLCBsYXllcikgewoKICAgIGlmICh0eXBlb2YgbGF5ZXIgPT09ICd1bmRlZmluZWQnKQogICAgewogICAgICAgIGxheWVyID0gMDsKICAgIH0KCiAgICBpZiAodGlsZW1hcCBpbnN0YW5jZW9mIFBoYXNlci5UaWxlbWFwKQogICAgewogICAgICAgIHRoaXMudGlsZW1hcCA9IHRpbGVtYXA7CiAgICAgICAgdGhpcy5sYXllciA9IHRoaXMudGlsZW1hcC5sYXllcnNbbGF5ZXJdOwogICAgICAgIHRoaXMuaW5kZXggPSBsYXllcjsKICAgICAgICB0aGlzLnVwZGF0ZU1heCgpOwogICAgICAgIHRoaXMudGlsZW1hcC5kaXJ0eSA9IHRydWU7CiAgICB9Cgp9CgovKioKICogVGFrZSBhbiB4IGNvb3JkaW5hdGUgdGhhdCBkb2Vzbid0IGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclkgYW5kICdmaXgnIGl0IAogKiBpbnRvIGEgc2Nyb2xsZWQgbG9jYWwgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKICogQHBhcmFtIHtudW1iZXJ9IHggLSB4IGNvb3JkaW5hdGUgaW4gY2FtZXJhIHNwYWNlCiAqIEByZXR1cm4ge251bWJlcn0geCBjb29yZGluYXRlIGluIHNjcm9sbEZhY3Rvci1hZGp1c3RlZCBkaW1lbnNpb25zCiAqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5fZml4WCA9IGZ1bmN0aW9uKHgpIHsKCglpZiAodGhpcy5zY3JvbGxGYWN0b3JYID09PSAxKQogICAgewogICAgICAgIHJldHVybiB4OwogICAgfQoKCXZhciBsZWZ0X2VkZ2UgPSB4IC0gKHRoaXMuX3ggLyB0aGlzLnNjcm9sbEZhY3RvclgpOwoKCXJldHVybiB0aGlzLl94ICsgbGVmdF9lZGdlOwoKfQoKLyoqCiAqIFRha2UgYW4geCBjb29yZGluYXRlIHRoYXQgX2RvZXNfIGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclkgYW5kICd1bmZpeCcgaXQgCiAqIGJhY2sgdG8gY2FtZXJhIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiAqIEBwYXJhbSB7bnVtYmVyfSB4IC0geCBjb29yZGluYXRlIGluIHNjcm9sbEZhY3Rvci1hZGp1c3RlZCBkaW1lbnNpb25zCiAqIEByZXR1cm4ge251bWJlcn0geCBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQogKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX3VuZml4WCA9IGZ1bmN0aW9uKHgpIHsKCglpZiAodGhpcy5zY3JvbGxGYWN0b3JYID09PSAxKQogICAgewogICAgICAgIHJldHVybiB4OwogICAgfQoKCXZhciBsZWZ0X2VkZ2UgPSB4IC0gdGhpcy5feDsKCglyZXR1cm4gKHRoaXMuX3ggLyB0aGlzLnNjcm9sbEZhY3RvclgpICsgbGVmdF9lZGdlOwoKfQoKLyoqCiAqIFRha2UgYSB5IGNvb3JkaW5hdGUgdGhhdCBkb2Vzbid0IGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclkgYW5kICdmaXgnIGl0IAogKiBpbnRvIGEgc2Nyb2xsZWQgbG9jYWwgc3BhY2UuIFVzZWQgcHJpbWFyaWx5IGludGVybmFsbHkKICogQHBhcmFtIHtudW1iZXJ9IHkgLSB5IGNvb3JkaW5hdGUgaW4gY2FtZXJhIHNwYWNlCiAqIEByZXR1cm4ge251bWJlcn0geSBjb29yZGluYXRlIGluIHNjcm9sbEZhY3Rvci1hZGp1c3RlZCBkaW1lbnNpb25zCiAqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5fZml4WSA9IGZ1bmN0aW9uKHkpIHsKCglpZiAodGhpcy5zY3JvbGxGYWN0b3JZID09PSAxKQogICAgewogICAgICAgIHJldHVybiB5OwogICAgfQoKCXZhciB0b3BfZWRnZSA9IHkgLSAodGhpcy5feSAvIHRoaXMuc2Nyb2xsRmFjdG9yWSk7CgoJcmV0dXJuIHRoaXMuX3kgKyB0b3BfZWRnZTsKCn0KCi8qKgogKiBUYWtlIGEgeSBjb29yZGluYXRlIHRoYXQgX2RvZXNfIGFjY291bnQgZm9yIHNjcm9sbEZhY3RvclkgYW5kICd1bmZpeCcgaXQgCiAqIGJhY2sgdG8gY2FtZXJhIHNwYWNlLiBVc2VkIHByaW1hcmlseSBpbnRlcm5hbGx5CiAqIEBwYXJhbSB7bnVtYmVyfSB5IC0geSBjb29yZGluYXRlIGluIHNjcm9sbEZhY3Rvci1hZGp1c3RlZCBkaW1lbnNpb25zCiAqIEByZXR1cm4ge251bWJlcn0geSBjb29yZGluYXRlIGluIGNhbWVyYSBzcGFjZQogKi8KUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuX3VuZml4WSA9IGZ1bmN0aW9uKHkpIHsKCglpZiAodGhpcy5zY3JvbGxGYWN0b3JZID09PSAxKQogICAgewogICAgICAgIHJldHVybiB5OwogICAgfQoKCXZhciB0b3BfZWRnZSA9IHkgLSB0aGlzLl95OwoKCXJldHVybiAodGhpcy5feSAvIHRoaXMuc2Nyb2xsRmFjdG9yWSkgKyB0b3BfZWRnZTsKCn0KCi8qKgoqIENvbnZlcnQgYSBwaXhlbCB2YWx1ZSB0byBhIHRpbGUgY29vcmRpbmF0ZS4KKiBAcGFyYW0ge251bWJlcn0geCAtIFggcG9zaXRpb24gb2YgdGhlIHBvaW50IGluIHRhcmdldCB0aWxlLgoqIEBwYXJhbSB7bnVtYmVyfSBbbGF5ZXJdIC0gbGF5ZXIgb2YgdGhpcyB0aWxlIGxvY2F0ZWQuCiogQHJldHVybiB7bnVtYmVyfSBUaGUgdGlsZSB3aXRoIHNwZWNpZmljIHByb3BlcnRpZXMuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVYID0gZnVuY3Rpb24gKHgpIHsKCiAgICB2YXIgdGlsZVdpZHRoID0gdGhpcy50aWxlV2lkdGggKiB0aGlzLnNjYWxlLng7CgoJcmV0dXJuIHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHRoaXMuX2ZpeFgoeCksIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7Cgp9CgovKioKKiBDb252ZXJ0IGEgcGl4ZWwgdmFsdWUgdG8gYSB0aWxlIGNvb3JkaW5hdGUuCiogQHBhcmFtIHtudW1iZXJ9IHggLSBYIHBvc2l0aW9uIG9mIHRoZSBwb2ludCBpbiB0YXJnZXQgdGlsZS4KKiBAcGFyYW0ge251bWJlcn0gW2xheWVyXSAtIGxheWVyIG9mIHRoaXMgdGlsZSBsb2NhdGVkLgoqIEByZXR1cm4ge251bWJlcn0gVGhlIHRpbGUgd2l0aCBzcGVjaWZpYyBwcm9wZXJ0aWVzLgoqLwpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5nZXRUaWxlWSA9IGZ1bmN0aW9uICh5KSB7CgogICAgdmFyIHRpbGVIZWlnaHQgPSB0aGlzLnRpbGVIZWlnaHQgKiB0aGlzLnNjYWxlLnk7CgoJcmV0dXJuIHRoaXMuZ2FtZS5tYXRoLnNuYXBUb0Zsb29yKHRoaXMuX2ZpeFkoeSksIHRpbGVIZWlnaHQpIC8gdGlsZUhlaWdodDsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVYWSA9IGZ1bmN0aW9uICh4LCB5LCBwb2ludCkgewoKICAgIHBvaW50LnggPSB0aGlzLmdldFRpbGVYKHgpOwogICAgcG9pbnQueSA9IHRoaXMuZ2V0VGlsZVkoeSk7CgogICAgcmV0dXJuIHBvaW50OwoKfQoKLyoqCiogCiogQG1ldGhvZCBnZXRUaWxlT3ZlcmxhcHMKKiBAcGFyYW0ge0dhbWVPYmplY3R9IG9iamVjdCAtIFRpbGVzIHlvdSB3YW50IHRvIGdldCB0aGF0IG92ZXJsYXBzIHRoaXMuCiogQHJldHVybiB7YXJyYXl9IEFycmF5IHdpdGggdGlsZXMgaW5mb3JtYXRpb25zIChlYWNoIGNvbnRhaW5zIHgsIHksIGFuZCB0aGUgdGlsZSkuCiovClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmdldFRpbGVzID0gZnVuY3Rpb24gKHgsIHksIHdpZHRoLCBoZWlnaHQsIGNvbGxpZGVzKSB7CgogICAgaWYgKHRoaXMudGlsZW1hcCA9PT0gbnVsbCkKICAgIHsKICAgICAgICByZXR1cm47CiAgICB9CgogICAgLy8gIFNob3VsZCB3ZSBvbmx5IGdldCB0aWxlcyB0aGF0IGhhdmUgYXQgbGVhc3Qgb25lIG9mIHRoZWlyIGNvbGxpc2lvbiBmbGFncyBzZXQ/ICh0cnVlID0geWVzLCBmYWxzZSA9IG5vIGp1c3QgZ2V0IHRoZW0gYWxsKQogICAgaWYgKHR5cGVvZiBjb2xsaWRlcyA9PT0gJ3VuZGVmaW5lZCcpIHsgY29sbGlkZXMgPSBmYWxzZTsgfQoKICAgIC8vICBDYXAgdGhlIHZhbHVlcwoKICAgIGlmICh4IDwgMCkKICAgIHsKICAgICAgICB4ID0gMDsKICAgIH0KCiAgICBpZiAoeSA8IDApCiAgICB7CiAgICAgICAgeSA9IDA7CiAgICB9CgoJLy8gYWRqdXN0IHRoZSB4LHkgY29vcmRpbmF0ZXMgZm9yIHNjcm9sbEZhY3RvcgoJeCA9IHRoaXMuX2ZpeFgoIHggKTsKCXkgPSB0aGlzLl9maXhZKCB5ICk7CgogICAgaWYgKHdpZHRoID4gdGhpcy53aWR0aEluUGl4ZWxzKQogICAgewogICAgICAgIHdpZHRoID0gdGhpcy53aWR0aEluUGl4ZWxzOwogICAgfQoKICAgIGlmIChoZWlnaHQgPiB0aGlzLmhlaWdodEluUGl4ZWxzKQogICAgewogICAgICAgIGhlaWdodCA9IHRoaXMuaGVpZ2h0SW5QaXhlbHM7CiAgICB9CgogICAgdmFyIHRpbGVXaWR0aCA9IHRoaXMudGlsZVdpZHRoICogdGhpcy5zY2FsZS54OwogICAgdmFyIHRpbGVIZWlnaHQgPSB0aGlzLnRpbGVIZWlnaHQgKiB0aGlzLnNjYWxlLnk7CgogICAgLy8gIENvbnZlcnQgdGhlIHBpeGVsIHZhbHVlcyBpbnRvIHRpbGUgY29vcmRpbmF0ZXMKICAgIHRoaXMuX3R4ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeCwgdGlsZVdpZHRoKSAvIHRpbGVXaWR0aDsKICAgIHRoaXMuX3R5ID0gdGhpcy5nYW1lLm1hdGguc25hcFRvRmxvb3IoeSwgdGlsZUhlaWdodCkgLyB0aWxlSGVpZ2h0OwogICAgdGhpcy5fdHcgPSAodGhpcy5nYW1lLm1hdGguc25hcFRvQ2VpbCh3aWR0aCwgdGlsZVdpZHRoKSArIHRpbGVXaWR0aCkgLyB0aWxlV2lkdGg7CiAgICB0aGlzLl90aCA9ICh0aGlzLmdhbWUubWF0aC5zbmFwVG9DZWlsKGhlaWdodCwgdGlsZUhlaWdodCkgKyB0aWxlSGVpZ2h0KSAvIHRpbGVIZWlnaHQ7CgogICAgLy8gIFRoaXMgc2hvdWxkIGFwcGx5IHRoZSBsYXllciB4L3kgaGVyZQoKICAgIC8vIHRoaXMuX3Jlc3VsdHMubGVuZ3RoID0gMDsKICAgIHRoaXMuX3Jlc3VsdHMgPSBbXTsKCiAgICAvLyAgcHJldHR5IHN1cmUgd2UgZG9uJ3QgdXNlIHRoaXMgYW55IG1vcmU/CiAgICAvLyB0aGlzLl9yZXN1bHRzLnB1c2goIHsgeDogeCwgeTogeSwgd2lkdGg6IHdpZHRoLCBoZWlnaHQ6IGhlaWdodCwgdHg6IHRoaXMuX3R4LCB0eTogdGhpcy5fdHksIHR3OiB0aGlzLl90dywgdGg6IHRoaXMuX3RoIH0pOwoKICAgIHZhciBfaW5kZXggPSAwOwogICAgdmFyIF90aWxlID0gbnVsbDsKICAgIHZhciBzeCA9IDA7CiAgICB2YXIgc3kgPSAwOwoKICAgIGZvciAodmFyIHd5ID0gdGhpcy5fdHk7IHd5IDwgdGhpcy5fdHkgKyB0aGlzLl90aDsgd3krKykKICAgIHsKICAgICAgICBmb3IgKHZhciB3eCA9IHRoaXMuX3R4OyB3eCA8IHRoaXMuX3R4ICsgdGhpcy5fdHc7IHd4KyspCiAgICAgICAgewogICAgICAgICAgICBpZiAodGhpcy5sYXllci5kYXRhW3d5XSAmJiB0aGlzLmxheWVyLmRhdGFbd3ldW3d4XSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgLy8gIENvdWxkIGNvbWJpbmUKICAgICAgICAgICAgICAgIF9pbmRleCA9IHRoaXMubGF5ZXIuZGF0YVt3eV1bd3hdIC0gMTsKICAgICAgICAgICAgICAgIF90aWxlID0gdGhpcy50aWxlc2V0LmdldFRpbGUoX2luZGV4KTsKCiAgICAgICAgICAgICAgICBzeCA9IF90aWxlLndpZHRoICogdGhpcy5zY2FsZS54OwogICAgICAgICAgICAgICAgc3kgPSBfdGlsZS5oZWlnaHQgKiB0aGlzLnNjYWxlLnk7CgogICAgICAgICAgICAgICAgaWYgKGNvbGxpZGVzID09IGZhbHNlIHx8IChjb2xsaWRlcyAmJiBfdGlsZS5jb2xsaWRlTm9uZSA9PSBmYWxzZSkpCiAgICAgICAgICAgICAgICB7CgkJCQkJLy8gY29udmVydCB0aWxlIGNvb3JkaW5hdGVzIGJhY2sgdG8gY2FtZXJhIHNwYWNlIGZvciByZXR1cm4KCQkJCQl2YXIgX3d4ID0gdGhpcy5fdW5maXhYKCB3eCpzeCApIC8gdGlsZVdpZHRoOwoJCQkJCXZhciBfd3kgPSB0aGlzLl91bmZpeFkoIHd5KnN5ICkgLyB0aWxlSGVpZ2h0OwogICAgICAgICAgICAgICAgICAgIHRoaXMuX3Jlc3VsdHMucHVzaCh7IHg6IF93eCAqIHN4LCByaWdodDogKF93eCAqIHN4KSArIHN4LCB5OiBfd3kgKiBzeSwgYm90dG9tOiAoX3d5ICogc3kpICsgc3ksIHdpZHRoOiBzeCwgaGVpZ2h0OiBzeSwgdHg6IF93eCwgdHk6IF93eSwgdGlsZTogX3RpbGUgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHRoaXMuX3Jlc3VsdHM7Cgp9CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS51cGRhdGVNYXggPSBmdW5jdGlvbiAoKSB7CgogICAgdGhpcy5fbWF4WCA9IHRoaXMuZ2FtZS5tYXRoLmNlaWwodGhpcy5jYW52YXMud2lkdGggLyB0aGlzLnRpbGVXaWR0aCkgKyAxOwogICAgdGhpcy5fbWF4WSA9IHRoaXMuZ2FtZS5tYXRoLmNlaWwodGhpcy5jYW52YXMuaGVpZ2h0IC8gdGhpcy50aWxlSGVpZ2h0KSArIDE7CgogICAgaWYgKHRoaXMubGF5ZXIpCiAgICB7CiAgICAgICAgaWYgKHRoaXMuX21heFggPiB0aGlzLmxheWVyLndpZHRoKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbWF4WCA9IHRoaXMubGF5ZXIud2lkdGg7CiAgICAgICAgfQoKICAgICAgICBpZiAodGhpcy5fbWF4WSA+IHRoaXMubGF5ZXIuaGVpZ2h0KQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5fbWF4WSA9IHRoaXMubGF5ZXIuaGVpZ2h0OwogICAgICAgIH0KCiAgICAgICAgdGhpcy53aWR0aEluUGl4ZWxzID0gdGhpcy5sYXllci53aWR0aCAqIHRoaXMudGlsZVdpZHRoOwogICAgICAgIHRoaXMuaGVpZ2h0SW5QaXhlbHMgPSB0aGlzLmxheWVyLmhlaWdodCAqIHRoaXMudGlsZUhlaWdodDsKICAgIH0KCiAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKCn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uICgpIHsKCiAgICBpZiAodGhpcy50aWxlbWFwICYmIHRoaXMudGlsZW1hcC5kaXJ0eSkKICAgIHsKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgIH0KCiAgICBpZiAoIXRoaXMuZGlydHkgfHwgIXRoaXMudGlsZXNldCB8fCAhdGhpcy50aWxlbWFwIHx8ICF0aGlzLnZpc2libGUpCiAgICB7CiAgICAgICAgcmV0dXJuOwogICAgfQoKICAgIHRoaXMuX3ByZXZYID0gdGhpcy5fZHg7CiAgICB0aGlzLl9wcmV2WSA9IHRoaXMuX2R5OwoKICAgIHRoaXMuX2R4ID0gLSh0aGlzLl94IC0gKHRoaXMuX3N0YXJ0WCAqIHRoaXMudGlsZVdpZHRoKSk7CiAgICB0aGlzLl9keSA9IC0odGhpcy5feSAtICh0aGlzLl9zdGFydFkgKiB0aGlzLnRpbGVIZWlnaHQpKTsKCiAgICB0aGlzLl90eCA9IHRoaXMuX2R4OwogICAgdGhpcy5fdHkgPSB0aGlzLl9keTsKCiAgICB0aGlzLmNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIHRoaXMuY2FudmFzLndpZHRoLCB0aGlzLmNhbnZhcy5oZWlnaHQpOwoKICAgIGZvciAodmFyIHkgPSB0aGlzLl9zdGFydFk7IHkgPCB0aGlzLl9zdGFydFkgKyB0aGlzLl9tYXhZOyB5KyspCiAgICB7CiAgICAgICAgdGhpcy5fY29sdW1uID0gdGhpcy5sYXllci5kYXRhW3ldOwoKICAgICAgICBmb3IgKHZhciB4ID0gdGhpcy5fc3RhcnRYOyB4IDwgdGhpcy5fc3RhcnRYICsgdGhpcy5fbWF4WDsgeCsrKQogICAgICAgIHsKICAgICAgICAgICAgLy8gIG9ubHkgLTEgb24gVElMRUQgbWFwcywgbm90IENTVgogICAgICAgICAgICB2YXIgdGlsZSA9IHRoaXMudGlsZXNldC50aWxlc1t0aGlzLl9jb2x1bW5beF0tMV07CgogICAgICAgICAgICBpZiAodGlsZSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LmRyYXdJbWFnZSgKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbGVzZXQuaW1hZ2UsCiAgICAgICAgICAgICAgICAgICAgdGlsZS54LAogICAgICAgICAgICAgICAgICAgIHRpbGUueSwKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbGVXaWR0aCwKICAgICAgICAgICAgICAgICAgICB0aGlzLnRpbGVIZWlnaHQsCiAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcih0aGlzLl90eCksCiAgICAgICAgICAgICAgICAgICAgTWF0aC5mbG9vcih0aGlzLl90eSksCiAgICAgICAgICAgICAgICAgICAgdGhpcy50aWxlV2lkdGgsCiAgICAgICAgICAgICAgICAgICAgdGhpcy50aWxlSGVpZ2h0CiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl90eCArPSB0aGlzLnRpbGVXaWR0aDsKCiAgICAgICAgfQoKICAgICAgICB0aGlzLl90eCA9IHRoaXMuX2R4OwogICAgICAgIHRoaXMuX3R5ICs9IHRoaXMudGlsZUhlaWdodDsKICAgIH0KCiAgICAvLyAgT25seSBuZWVkZWQgaWYgcnVubmluZyBpbiBXZWJHTCwgb3RoZXJ3aXNlIHRoaXMgYXJyYXkgd2lsbCBuZXZlciBnZXQgY2xlYXJlZCBkb3duIEkgZG9uJ3QgdGhpbmshCiAgICBpZiAodGhpcy5nYW1lLnJlbmRlclR5cGUgPT0gUGhhc2VyLldFQkdMKQogICAgewogICAgICAgIFBJWEkudGV4dHVyZXNUb1VwZGF0ZS5wdXNoKHRoaXMuYmFzZVRleHR1cmUpOwogICAgfQoKICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKCiAgICBpZiAodGhpcy50aWxlbWFwLmRpcnR5KQogICAgewogICAgICAgIHRoaXMudGlsZW1hcC5kaXJ0eSA9IGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwoKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuZGVsdGFBYnNYID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuICh0aGlzLmRlbHRhWCgpID4gMCA/IHRoaXMuZGVsdGFYKCkgOiAtdGhpcy5kZWx0YVgoKSk7Cn0KClBoYXNlci5UaWxlbWFwTGF5ZXIucHJvdG90eXBlLmRlbHRhQWJzWSA9IGZ1bmN0aW9uICgpIHsKICAgIHJldHVybiAodGhpcy5kZWx0YVkoKSA+IDAgPyB0aGlzLmRlbHRhWSgpIDogLXRoaXMuZGVsdGFZKCkpOwp9CgpQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZS5kZWx0YVggPSBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gdGhpcy5fZHggLSB0aGlzLl9wcmV2WDsKfQoKUGhhc2VyLlRpbGVtYXBMYXllci5wcm90b3R5cGUuZGVsdGFZID0gZnVuY3Rpb24gKCkgewogICAgcmV0dXJuIHRoaXMuX2R5IC0gdGhpcy5fcHJldlk7Cn0KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSwgInNjcm9sbFgiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl94OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3ggJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5feCA9IHZhbHVlOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3ggPiAodGhpcy53aWR0aEluUGl4ZWxzIC0gdGhpcy5yZW5kZXJXaWR0aCkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3ggPSB0aGlzLndpZHRoSW5QaXhlbHMgLSB0aGlzLnJlbmRlcldpZHRoOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLl9zdGFydFggPSB0aGlzLmdhbWUubWF0aC5mbG9vcih0aGlzLl94IC8gdGhpcy50aWxlV2lkdGgpOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WCA8IDApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0YXJ0WCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICh0aGlzLl9zdGFydFggKyB0aGlzLl9tYXhYID4gdGhpcy5sYXllci53aWR0aCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRYID0gdGhpcy5sYXllci53aWR0aCAtIHRoaXMuX21heFg7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIH0KCiAgICB9Cgp9KTsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShQaGFzZXIuVGlsZW1hcExheWVyLnByb3RvdHlwZSwgInNjcm9sbFkiLCB7CiAgICAKICAgIGdldDogZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLl95OwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uICh2YWx1ZSkgewoKICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMuX3kgJiYgdmFsdWUgPj0gMCAmJiB0aGlzLmxheWVyKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy5feSA9IHZhbHVlOwoKICAgICAgICAgICAgaWYgKHRoaXMuX3kgPiAodGhpcy5oZWlnaHRJblBpeGVscyAtIHRoaXMucmVuZGVySGVpZ2h0KSkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5feSA9IHRoaXMuaGVpZ2h0SW5QaXhlbHMgLSB0aGlzLnJlbmRlckhlaWdodDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gdGhpcy5nYW1lLm1hdGguZmxvb3IodGhpcy5feSAvIHRoaXMudGlsZUhlaWdodCk7CgogICAgICAgICAgICBpZiAodGhpcy5fc3RhcnRZIDwgMCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKHRoaXMuX3N0YXJ0WSArIHRoaXMuX21heFkgPiB0aGlzLmxheWVyLmhlaWdodCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy5fc3RhcnRZID0gdGhpcy5sYXllci5oZWlnaHQgLSB0aGlzLl9tYXhZOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB9CgogICAgfQoKfSk7CgpQaGFzZXIuVGlsZW1hcFBhcnNlciA9IHsKCgl0aWxlc2V0OiBmdW5jdGlvbiAoZ2FtZSwga2V5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXgsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nKSB7CgoJICAgIC8vICBIb3cgYmlnIGlzIG91ciBpbWFnZT8KCSAgICB2YXIgaW1nID0gZ2FtZS5jYWNoZS5nZXRUaWxlc2V0SW1hZ2Uoa2V5KTsKCgkgICAgaWYgKGltZyA9PSBudWxsKQoJICAgIHsKCSAgICAgICAgcmV0dXJuIG51bGw7CgkgICAgfQoKCSAgICB2YXIgd2lkdGggPSBpbWcud2lkdGg7CgkgICAgdmFyIGhlaWdodCA9IGltZy5oZWlnaHQ7CgoJICAgIC8vCUlmIG5vIHRpbGUgd2lkdGgvaGVpZ2h0IGlzIGdpdmVuLCB0cnkgYW5kIGZpZ3VyZSBpdCBvdXQgKHdvbid0IHdvcmsgaWYgdGhlIHRpbGVzZXQgaGFzIG1hcmdpbi9zcGFjaW5nKQoJICAgIGlmICh0aWxlV2lkdGggPD0gMCkKCSAgICB7CgkgICAgICAgIHRpbGVXaWR0aCA9IE1hdGguZmxvb3IoLXdpZHRoIC8gTWF0aC5taW4oLTEsIHRpbGVXaWR0aCkpOwoJICAgIH0KCgkgICAgaWYgKHRpbGVIZWlnaHQgPD0gMCkKCSAgICB7CgkgICAgICAgIHRpbGVIZWlnaHQgPSBNYXRoLmZsb29yKC1oZWlnaHQgLyBNYXRoLm1pbigtMSwgdGlsZUhlaWdodCkpOwoJICAgIH0KCgkgICAgdmFyIHJvdyA9IE1hdGgucm91bmQod2lkdGggLyB0aWxlV2lkdGgpOwoJICAgIHZhciBjb2x1bW4gPSBNYXRoLnJvdW5kKGhlaWdodCAvIHRpbGVIZWlnaHQpOwoJICAgIHZhciB0b3RhbCA9IHJvdyAqIGNvbHVtbjsKCSAgICAKCSAgICBpZiAodGlsZU1heCAhPT0gLTEpCgkgICAgewoJICAgICAgICB0b3RhbCA9IHRpbGVNYXg7CgkgICAgfQoKCSAgICAvLyAgWmVybyBvciBzbWFsbGVyIHRoYW4gdGlsZSBzaXplcz8KCSAgICBpZiAod2lkdGggPT0gMCB8fCBoZWlnaHQgPT0gMCB8fCB3aWR0aCA8IHRpbGVXaWR0aCB8fCBoZWlnaHQgPCB0aWxlSGVpZ2h0IHx8IHRvdGFsID09PSAwKQoJICAgIHsKCSAgICAgICAgY29uc29sZS53YXJuKCJQaGFzZXIuVGlsZW1hcFBhcnNlci50aWxlU2V0OiB3aWR0aC9oZWlnaHQgemVybyBvciB3aWR0aC9oZWlnaHQgPCBnaXZlbiB0aWxlV2lkdGgvdGlsZUhlaWdodCIpOwoJICAgICAgICByZXR1cm4gbnVsbDsKCSAgICB9CgoJICAgIC8vICBMZXQncyBjcmVhdGUgc29tZSB0aWxlcwoJICAgIHZhciB4ID0gdGlsZU1hcmdpbjsKCSAgICB2YXIgeSA9IHRpbGVNYXJnaW47CgoJICAgIHZhciB0aWxlc2V0ID0gbmV3IFBoYXNlci5UaWxlc2V0KGltZywga2V5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQsIHRpbGVNYXJnaW4sIHRpbGVTcGFjaW5nKTsKCgkgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0b3RhbDsgaSsrKQoJICAgIHsKCSAgICAgICAgdGlsZXNldC5hZGRUaWxlKG5ldyBQaGFzZXIuVGlsZSh0aWxlc2V0LCBpLCB4LCB5LCB0aWxlV2lkdGgsIHRpbGVIZWlnaHQpKTsKCgkgICAgICAgIHggKz0gdGlsZVdpZHRoICsgdGlsZVNwYWNpbmc7CgoJICAgICAgICBpZiAoeCA9PT0gd2lkdGgpCgkgICAgICAgIHsKCSAgICAgICAgICAgIHggPSB0aWxlTWFyZ2luOwoJICAgICAgICAgICAgeSArPSB0aWxlSGVpZ2h0ICsgdGlsZVNwYWNpbmc7CgkgICAgICAgIH0KCSAgICB9CgoJICAgIHJldHVybiB0aWxlc2V0OwoKCX0sCgoJcGFyc2U6IGZ1bmN0aW9uIChnYW1lLCBkYXRhLCBmb3JtYXQpIHsKCgkJaWYgKGZvcm1hdCA9PT0gUGhhc2VyLlRpbGVtYXAuQ1NWKQoJCXsKCQkJcmV0dXJuIHRoaXMucGFyc2VDU1YoZGF0YSk7CgkJfQoJCWVsc2UgaWYgKGZvcm1hdCA9PT0gUGhhc2VyLlRpbGVtYXAuVElMRURfSlNPTikKCQl7CgkJCXJldHVybiB0aGlzLnBhcnNlVGlsZWRKU09OKGRhdGEpOwoJCX0KCgl9LAoKCS8qKgoJKiBQYXJzZSBjc3YgbWFwIGRhdGEgYW5kIGdlbmVyYXRlIHRpbGVzLgoJKiAKCSogQG1ldGhvZCBQaGFzZXIuVGlsZW1hcC5wcm90b3R5cGUucGFyc2VDU1YKCSogQHBhcmFtIHtzdHJpbmd9IGRhdGEgLSBDU1YgbWFwIGRhdGEuCgkqLwoJcGFyc2VDU1Y6IGZ1bmN0aW9uIChkYXRhKSB7CgoJICAgIC8vICBUcmltIGFueSByb2d1ZSB3aGl0ZXNwYWNlIGZyb20gdGhlIGRhdGEKCSAgICBkYXRhID0gZGF0YS50cmltKCk7CgoJICAgIHZhciBvdXRwdXQgPSBbXTsKCSAgICB2YXIgcm93cyA9IGRhdGEuc3BsaXQoIlxuIik7CgkgICAgdmFyIGhlaWdodCA9IHJvd3MubGVuZ3RoOwoJICAgIHZhciB3aWR0aCA9IDA7CgoJICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcm93cy5sZW5ndGg7IGkrKykKCSAgICB7CgkgICAgCW91dHB1dFtpXSA9IFtdOwoKCSAgICAgICAgdmFyIGNvbHVtbiA9IHJvd3NbaV0uc3BsaXQoIiwiKTsKCgkgICAgICAgIGZvciAodmFyIGMgPSAwOyBjIDwgY29sdW1uLmxlbmd0aDsgYysrKQoJICAgICAgICB7CgkgICAgICAgICAgICBvdXRwdXRbaV1bY10gPSBwYXJzZUludChjb2x1bW5bY10pOwoJICAgICAgICB9CgogICAgICAgICAgICBpZiAod2lkdGggPT0gMCkKICAgICAgICAgICAgewogICAgICAgICAgICAJd2lkdGggPSBjb2x1bW4ubGVuZ3RoOwogICAgICAgICAgICB9CgkgICAgfQoKCSAgICByZXR1cm4gW3sgbmFtZTogJ2NzdicsIHdpZHRoOiB3aWR0aCwgaGVpZ2h0OiBoZWlnaHQsIGFscGhhOiAxLCB2aXNpYmxlOiB0cnVlLCBpbmRleGVzOiBbXSwgdGlsZU1hcmdpbjogMCwgdGlsZVNwYWNpbmc6IDAsIGRhdGE6IG91dHB1dCB9XTsKCgl9LAoKCS8qKgoJKiBQYXJzZSBKU09OIG1hcCBkYXRhIGFuZCBnZW5lcmF0ZSB0aWxlcy4KCSogCgkqIEBtZXRob2QgUGhhc2VyLlRpbGVtYXAucHJvdG90eXBlLnBhcnNlVGlsZWRKU09OCgkqIEBwYXJhbSB7c3RyaW5nfSBkYXRhIC0gSlNPTiBtYXAgZGF0YS4KCSogQHBhcmFtIHtzdHJpbmd9IGtleSAtIEFzc2V0IGtleSBmb3IgdGlsZXNldCBpbWFnZS4KCSovCglwYXJzZVRpbGVkSlNPTjogZnVuY3Rpb24gKGpzb24pIHsKCgkJdmFyIGxheWVycyA9IFtdOwoKCSAgICBmb3IgKHZhciBpID0gMDsgaSA8IGpzb24ubGF5ZXJzLmxlbmd0aDsgaSsrKQoJICAgIHsKCSAgICAgICAgLy8gIENoZWNrIGl0J3MgYSBkYXRhIGxheWVyCgkgICAgICAgIGlmICghanNvbi5sYXllcnNbaV0uZGF0YSkKCSAgICAgICAgewoJICAgICAgICAgICAgY29udGludWU7CgkgICAgICAgIH0KCgkJCS8vCWpzb24udGlsZXdpZHRoCgkJCS8vCWpzb24udGlsZWhlaWdodAoKCSAgICAgICAgdmFyIGxheWVyID0gewoKCQkgICAgICAgIG5hbWU6IGpzb24ubGF5ZXJzW2ldLm5hbWUsCgkJICAgICAgICB3aWR0aDoganNvbi5sYXllcnNbaV0ud2lkdGgsCgkJICAgICAgICBoZWlnaHQ6IGpzb24ubGF5ZXJzW2ldLmhlaWdodCwKCQkgICAgICAgIGFscGhhOiBqc29uLmxheWVyc1tpXS5vcGFjaXR5LAoJCSAgICAgICAgdmlzaWJsZToganNvbi5sYXllcnNbaV0udmlzaWJsZSwKCQkgICAgICAgIGluZGV4ZXM6IFtdLAoKCQkgICAgICAgIHRpbGVNYXJnaW46IGpzb24udGlsZXNldHNbMF0ubWFyZ2luLAoJCSAgICAgICAgdGlsZVNwYWNpbmc6IGpzb24udGlsZXNldHNbMF0uc3BhY2luZywKCgkgICAgICAgIH07CgoJICAgICAgICB2YXIgb3V0cHV0ID0gW107CgkgICAgICAgIHZhciBjID0gMDsKCSAgICAgICAgdmFyIHJvdzsKCgkgICAgICAgIGZvciAodmFyIHQgPSAwOyB0IDwganNvbi5sYXllcnNbaV0uZGF0YS5sZW5ndGg7IHQrKykKCSAgICAgICAgewoJICAgICAgICAgICAgaWYgKGMgPT0gMCkKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICByb3cgPSBbXTsKCSAgICAgICAgICAgIH0KCgkgICAgICAgICAgICByb3cucHVzaChqc29uLmxheWVyc1tpXS5kYXRhW3RdKTsKCSAgICAgICAgICAgIGMrKzsKCgkgICAgICAgICAgICBpZiAoYyA9PSBqc29uLmxheWVyc1tpXS53aWR0aCkKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgIAlvdXRwdXQucHVzaChyb3cpOwoJICAgICAgICAgICAgICAgIGMgPSAwOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgoJICAgICAgICBsYXllci5kYXRhID0gb3V0cHV0OwoJICAgICAgICAKCSAgICAgICAgbGF5ZXJzLnB1c2gobGF5ZXIpOwoKCSAgICB9CgoJICAgIHJldHVybiBsYXllcnM7CgoJfQoKfQoKClBoYXNlci5UaWxlc2V0ID0gZnVuY3Rpb24gKGltYWdlLCBrZXksIHRpbGVXaWR0aCwgdGlsZUhlaWdodCwgdGlsZU1hcmdpbiwgdGlsZVNwYWNpbmcpIHsKCiAgICBpZiAodHlwZW9mIHRpbGVNYXJnaW4gPT09ICJ1bmRlZmluZWQiKSB7IHRpbGVNYXJnaW4gPSAwOyB9CiAgICBpZiAodHlwZW9mIHRpbGVTcGFjaW5nID09PSAidW5kZWZpbmVkIikgeyB0aWxlU3BhY2luZyA9IDA7IH0KCiAgICAvKioKICAgICogQHByb3BlcnR5IHtzdHJpbmd9IGtleSAtIFRoZSBjYWNoZSBJRC4KICAgICovCiAgICB0aGlzLmtleSA9IGtleTsKCiAgICB0aGlzLmltYWdlID0gaW1hZ2U7CgogICAgdGhpcy50aWxlV2lkdGggPSB0aWxlV2lkdGg7CiAgICB0aGlzLnRpbGVIZWlnaHQgPSB0aWxlSGVpZ2h0OwogICAgdGhpcy5tYXJnaW4gPSB0aWxlTWFyZ2luOwogICAgdGhpcy5zcGFjaW5nID0gdGlsZVNwYWNpbmc7CgogICAgdGhpcy50aWxlcyA9IFtdOwoKfQoKUGhhc2VyLlRpbGVzZXQucHJvdG90eXBlID0gewoKICAgIGFkZFRpbGU6IGZ1bmN0aW9uICh0aWxlKSB7CgogICAgICAgIHRoaXMudGlsZXMucHVzaCh0aWxlKTsKCiAgICAgICAgcmV0dXJuIHRpbGU7CgogICAgfSwKCiAgICBnZXRUaWxlOiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAgICAgaWYgKHRoaXMudGlsZXNbaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudGlsZXNbaW5kZXhdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIG51bGw7CgogICAgfSwKCiAgICBzZXRTcGFjaW5nOiBmdW5jdGlvbiAobWFyZ2luLCBzcGFjaW5nKSB7CgogICAgICAgIHRoaXMudGlsZU1hcmdpbiA9IG1hcmdpbjsKICAgICAgICB0aGlzLnRpbGVTcGFjaW5nID0gc3BhY2luZzsKCiAgICB9LAoKICAgIGNhbkNvbGxpZGU6IGZ1bmN0aW9uIChpbmRleCkgewoKICAgICAgICBpZiAodGhpcy50aWxlc1tpbmRleF0pCiAgICAgICAgewogICAgICAgICAgICByZXR1cm4gdGhpcy50aWxlc1tpbmRleF0uY29sbGlkZU5vbmU7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gbnVsbDsKCiAgICB9LAoKICAgIGNoZWNrVGlsZUluZGV4OiBmdW5jdGlvbiAoaW5kZXgpIHsKCiAgICAJcmV0dXJuICh0aGlzLnRpbGVzW2luZGV4XSk7CgogICAgfSwKCiAgICBzZXRDb2xsaXNpb25SYW5nZTogZnVuY3Rpb24gKHN0YXJ0LCBzdG9wLCBsZWZ0LCByaWdodCwgdXAsIGRvd24pIHsKCiAgICAgICAgaWYgKHRoaXMudGlsZXNbc3RhcnRdICYmIHRoaXMudGlsZXNbc3RvcF0gJiYgc3RhcnQgPCBzdG9wKQogICAgICAgIHsKICAgICAgICAgICAgZm9yICh2YXIgaSA9IHN0YXJ0OyBpIDw9IHN0b3A7IGkrKykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgdGhpcy50aWxlc1tpXS5zZXRDb2xsaXNpb24obGVmdCwgcmlnaHQsIHVwLCBkb3duKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9LAoKICAgIHNldENvbGxpc2lvbjogZnVuY3Rpb24gKGluZGV4LCBsZWZ0LCByaWdodCwgdXAsIGRvd24pIHsKCiAgICAgICAgaWYgKHRoaXMudGlsZXNbaW5kZXhdKQogICAgICAgIHsKICAgICAgICAgICAgdGhpcy50aWxlc1tpbmRleF0uc2V0Q29sbGlzaW9uKGxlZnQsIHJpZ2h0LCB1cCwgZG93bik7CiAgICAgICAgfQoKICAgIH0sCgp9CgovKioKKiBAbmFtZSBQaGFzZXIuVGlsZXNldCN0b3RhbAoqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0b3RhbCAtIFRoZSB0b3RhbCBudW1iZXIgb2YgdGlsZXMgaW4gdGhpcyBUaWxlc2V0LgoqIEByZWFkb25seQoqLwpPYmplY3QuZGVmaW5lUHJvcGVydHkoUGhhc2VyLlRpbGVzZXQucHJvdG90eXBlLCAidG90YWwiLCB7CgogICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMudGlsZXMubGVuZ3RoOwogICAgfQoKfSk7CgovKioKKiBXZSdyZSByZXBsYWNpbmcgYSBjb3VwbGUgb2YgUGl4aSdzIG1ldGhvZHMgaGVyZSB0byBmaXggb3IgYWRkIHNvbWUgdml0YWwgZnVuY3Rpb25hbGl0eToKKgoqIDEpIEFkZGVkIHN1cHBvcnQgZm9yIFRyaW1tZWQgc3ByaXRlIHNoZWV0cwoqIDIpIFNraXAgZGlzcGxheSBvYmplY3RzIHdpdGggYW4gYWxwaGEgb2YgemVybwoqIDMpIEF2b2lkIFN0eWxlIFJlY2FsY3VsYXRpb24gZnJvbSB0aGUgaW5jb3JyZWN0IGJnY29sb3IgdmFsdWUKKgoqIEhvcGVmdWxseSB3ZSBjYW4gcmVtb3ZlIHRoaXMgb25jZSBQaXhpIGhhcyBiZWVuIHVwZGF0ZWQgdG8gc3VwcG9ydCB0aGVzZSB0aGluZ3MuCiovCgovKioKICogUmVuZGVycyB0aGUgc3RhZ2UgdG8gaXRzIGNhbnZhcyB2aWV3CiAqCiAqIEBtZXRob2QgcmVuZGVyCiAqIEBwYXJhbSBzdGFnZSB7U3RhZ2V9IHRoZSBTdGFnZSBlbGVtZW50IHRvIGJlIHJlbmRlcmVkCiAqLwpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihzdGFnZSkKewoJUElYSS50ZXh0dXJlc1RvVXBkYXRlLmxlbmd0aCA9IDA7CglQSVhJLnRleHR1cmVzVG9EZXN0cm95Lmxlbmd0aCA9IDA7CgkKCVBJWEkudmlzaWJsZUNvdW50Kys7CglzdGFnZS51cGRhdGVUcmFuc2Zvcm0oKTsKCQoJLy8gdXBkYXRlIHRoZSBiYWNrZ3JvdW5kIGNvbG9yCgkvLyBpZih0aGlzLnZpZXcuc3R5bGUuYmFja2dyb3VuZENvbG9yIT1zdGFnZS5iYWNrZ3JvdW5kQ29sb3JTdHJpbmcgJiYgIXRoaXMudHJhbnNwYXJlbnQpdGhpcy52aWV3LnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHN0YWdlLmJhY2tncm91bmRDb2xvclN0cmluZzsKCgl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKDEsIDAsIDAsIDEsIDAsIDApOyAKCXRoaXMuY29udGV4dC5jbGVhclJlY3QoMCwgMCwgdGhpcy53aWR0aCwgdGhpcy5oZWlnaHQpCiAgICB0aGlzLnJlbmRlckRpc3BsYXlPYmplY3Qoc3RhZ2UpOwogICAKCS8vCVJlbW92ZSBmcmFtZSB1cGRhdGVzCglpZiAoUElYSS5UZXh0dXJlLmZyYW1lVXBkYXRlcy5sZW5ndGggPiAwKQoJewoJCVBJWEkuVGV4dHVyZS5mcmFtZVVwZGF0ZXMubGVuZ3RoID0gMDsKCX0KCQp9CgpQSVhJLkNhbnZhc1JlbmRlcmVyLnByb3RvdHlwZS5yZW5kZXJEaXNwbGF5T2JqZWN0ID0gZnVuY3Rpb24oZGlzcGxheU9iamVjdCkKewoJLy8gT25jZSB0aGUgZGlzcGxheSBvYmplY3QgaGl0cyB0aGlzIHdlIGNhbiBicmVhayB0aGUgbG9vcAkKCXZhciB0ZXN0T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0LmZpcnN0OwoJCglkbwkKCXsKCQkvL3RyYW5zZm9ybSA9IGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm07CgkJCgkJaWYgKCFkaXNwbGF5T2JqZWN0LnZpc2libGUpCgkJewoJCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5sYXN0Ll9pTmV4dDsKCQkJY29udGludWU7CgkJfQoJCQoJCWlmICghZGlzcGxheU9iamVjdC5yZW5kZXJhYmxlIHx8IGRpc3BsYXlPYmplY3QuYWxwaGEgPT0gMCkKCQl7CgkJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCQkJY29udGludWU7CgkJfQoJCQoJCWlmIChkaXNwbGF5T2JqZWN0IGluc3RhbmNlb2YgUElYSS5TcHJpdGUpCgkJewoJCQkvLyB2YXIgZnJhbWUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWU7CgkJCQoJCQlpZiAoZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lKQoJCQl7CgkJCQl0aGlzLmNvbnRleHQuZ2xvYmFsQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgkJCQkKCQkJCWlmIChkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbW1lZCkKCQkJCXsKCQkJCQl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMV0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0gKyBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS54LCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdICsgZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueSk7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJdGhpcy5jb250ZXh0LnNldFRyYW5zZm9ybShkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzBdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzNdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzFdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzRdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzJdLCBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtWzVdKTsKCQkJCX0KCQkJCQkKCQkJCXRoaXMuY29udGV4dC5kcmF3SW1hZ2UoCgkJCQkJZGlzcGxheU9iamVjdC50ZXh0dXJlLmJhc2VUZXh0dXJlLnNvdXJjZSwgCgkJCQkJZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLngsCgkJCQkJZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLnksCgkJCQkJZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoLAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQsCgkJCQkJKGRpc3BsYXlPYmplY3QuYW5jaG9yLngpICogLWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS53aWR0aCwgCgkJCQkJKGRpc3BsYXlPYmplY3QuYW5jaG9yLnkpICogLWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQsCgkJCQkJZGlzcGxheU9iamVjdC50ZXh0dXJlLmZyYW1lLndpZHRoLAoJCQkJCWRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQpOwoJCQl9CQkJCQkgICAKCSAgIAl9CgkgICAJZWxzZSBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuU3RyaXApCgkJewoJCQl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMV0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0pCgkJCXRoaXMucmVuZGVyU3RyaXAoZGlzcGxheU9iamVjdCk7CgkJfQoJCWVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLlRpbGluZ1Nwcml0ZSkKCQl7CgkJCXRoaXMuY29udGV4dC5zZXRUcmFuc2Zvcm0oZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVswXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVszXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsxXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs0XSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVsyXSwgZGlzcGxheU9iamVjdC53b3JsZFRyYW5zZm9ybVs1XSkKCQkJdGhpcy5yZW5kZXJUaWxpbmdTcHJpdGUoZGlzcGxheU9iamVjdCk7CgkJfQoJCWVsc2UgaWYgKGRpc3BsYXlPYmplY3QgaW5zdGFuY2VvZiBQSVhJLkN1c3RvbVJlbmRlcmFibGUpCgkJewoJCQlkaXNwbGF5T2JqZWN0LnJlbmRlckNhbnZhcyh0aGlzKTsKCQl9CgkJZWxzZSBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuR3JhcGhpY3MpCgkJewoJCQl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bM10sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMV0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNF0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bMl0sIGRpc3BsYXlPYmplY3Qud29ybGRUcmFuc2Zvcm1bNV0pCgkJCVBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3MoZGlzcGxheU9iamVjdCwgdGhpcy5jb250ZXh0KTsKCQl9CgkJZWxzZSBpZiAoZGlzcGxheU9iamVjdCBpbnN0YW5jZW9mIFBJWEkuRmlsdGVyQmxvY2spCgkJewoJCQlpZiAoZGlzcGxheU9iamVjdC5vcGVuKQoJCQl7CgkJCQl0aGlzLmNvbnRleHQuc2F2ZSgpOwoJCQkJCgkJCQl2YXIgY2FjaGVBbHBoYSA9IGRpc3BsYXlPYmplY3QubWFzay5hbHBoYTsKCQkJCXZhciBtYXNrVHJhbnNmb3JtID0gZGlzcGxheU9iamVjdC5tYXNrLndvcmxkVHJhbnNmb3JtOwoJCQkJCgkJCQl0aGlzLmNvbnRleHQuc2V0VHJhbnNmb3JtKG1hc2tUcmFuc2Zvcm1bMF0sIG1hc2tUcmFuc2Zvcm1bM10sIG1hc2tUcmFuc2Zvcm1bMV0sIG1hc2tUcmFuc2Zvcm1bNF0sIG1hc2tUcmFuc2Zvcm1bMl0sIG1hc2tUcmFuc2Zvcm1bNV0pCgkJCQkKCQkJCWRpc3BsYXlPYmplY3QubWFzay53b3JsZEFscGhhID0gMC41OwoJCQkJCgkJCQl0aGlzLmNvbnRleHQud29ybGRBbHBoYSA9IDA7CgkJCQkKCQkJCVBJWEkuQ2FudmFzR3JhcGhpY3MucmVuZGVyR3JhcGhpY3NNYXNrKGRpc3BsYXlPYmplY3QubWFzaywgdGhpcy5jb250ZXh0KTsKCQkJCXRoaXMuY29udGV4dC5jbGlwKCk7CgkJCQkKCQkJCWRpc3BsYXlPYmplY3QubWFzay53b3JsZEFscGhhID0gY2FjaGVBbHBoYTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXRoaXMuY29udGV4dC5yZXN0b3JlKCk7CgkJCX0KCQl9CgkJLy8JY291bnQrKwoJCWRpc3BsYXlPYmplY3QgPSBkaXNwbGF5T2JqZWN0Ll9pTmV4dDsKCX0KCXdoaWxlKGRpc3BsYXlPYmplY3QgIT0gdGVzdE9iamVjdCkKCQp9CgpQSVhJLldlYkdMQmF0Y2gucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCkKewoJdmFyIGdsID0gdGhpcy5nbDsKCXZhciB3b3JsZFRyYW5zZm9ybSwgd2lkdGgsIGhlaWdodCwgYVgsIGFZLCB3MCwgdzEsIGgwLCBoMSwgaW5kZXgsIGluZGV4MiwgaW5kZXgzCgoJdmFyIGEsIGIsIGMsIGQsIHR4LCB0eTsKCgl2YXIgaW5kZXhSdW4gPSAwOwoKCXZhciBkaXNwbGF5T2JqZWN0ID0gdGhpcy5oZWFkOwoKCXdoaWxlKGRpc3BsYXlPYmplY3QpCgl7CgkJaWYoZGlzcGxheU9iamVjdC52Y291bnQgPT09IFBJWEkudmlzaWJsZUNvdW50KQoJCXsKCQkJd2lkdGggPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUuZnJhbWUud2lkdGg7CgkJCWhlaWdodCA9IGRpc3BsYXlPYmplY3QudGV4dHVyZS5mcmFtZS5oZWlnaHQ7CgoJCQkvLyBUT0RPIHRyaW0/PwoJCQlhWCA9IGRpc3BsYXlPYmplY3QuYW5jaG9yLng7Ly8gLSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS54CgkJCWFZID0gZGlzcGxheU9iamVjdC5hbmNob3IueTsgLy8tIGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltLnkKCQkJdzAgPSB3aWR0aCAqICgxLWFYKTsKCQkJdzEgPSB3aWR0aCAqIC1hWDsKCgkJCWgwID0gaGVpZ2h0ICogKDEtYVkpOwoJCQloMSA9IGhlaWdodCAqIC1hWTsKCgkJCWluZGV4ID0gaW5kZXhSdW4gKiA4OwoKCQkJd29ybGRUcmFuc2Zvcm0gPSBkaXNwbGF5T2JqZWN0LndvcmxkVHJhbnNmb3JtOwoKCQkJYSA9IHdvcmxkVHJhbnNmb3JtWzBdOwoJCQliID0gd29ybGRUcmFuc2Zvcm1bM107CgkJCWMgPSB3b3JsZFRyYW5zZm9ybVsxXTsKCQkJZCA9IHdvcmxkVHJhbnNmb3JtWzRdOwoJCQl0eCA9IHdvcmxkVHJhbnNmb3JtWzJdOwoJCQl0eSA9IHdvcmxkVHJhbnNmb3JtWzVdOwoKCQkJaWYgKGRpc3BsYXlPYmplY3QudGV4dHVyZS50cmltbWVkKQoJCQl7CgkJCQl0eCArPSBkaXNwbGF5T2JqZWN0LnRleHR1cmUudHJpbS54OwoJCQkJdHkgKz0gZGlzcGxheU9iamVjdC50ZXh0dXJlLnRyaW0ueTsKCQkJfQoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAwIF0gPSBhICogdzEgKyBjICogaDEgKyB0eDsgCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgMSBdID0gZCAqIGgxICsgYiAqIHcxICsgdHk7CgoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDIgXSA9IGEgKiB3MCArIGMgKiBoMSArIHR4OyAKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAzIF0gPSBkICogaDEgKyBiICogdzAgKyB0eTsgCgoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDQgXSA9IGEgKiB3MCArIGMgKiBoMCArIHR4OyAKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSBkICogaDAgKyBiICogdzAgKyB0eTsgCgoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDZdID0gIGEgKiB3MSArIGMgKiBoMCArIHR4OyAKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA3XSA9ICBkICogaDAgKyBiICogdzEgKyB0eTsgCgoJCQlpZihkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lIHx8IGRpc3BsYXlPYmplY3QudGV4dHVyZS51cGRhdGVGcmFtZSkKCQkJewoJCQkJdGhpcy5kaXJ0eVVWUyA9IHRydWU7CgoJCQkJdmFyIHRleHR1cmUgPSBkaXNwbGF5T2JqZWN0LnRleHR1cmU7CgoJCQkJdmFyIGZyYW1lID0gdGV4dHVyZS5mcmFtZTsKCQkJCXZhciB0dyA9IHRleHR1cmUuYmFzZVRleHR1cmUud2lkdGg7CgkJCQl2YXIgdGggPSB0ZXh0dXJlLmJhc2VUZXh0dXJlLmhlaWdodDsKCgkJCQl0aGlzLnV2c1tpbmRleCArIDBdID0gZnJhbWUueCAvIHR3OwoJCQkJdGhpcy51dnNbaW5kZXggKzFdID0gZnJhbWUueSAvIHRoOwoKCQkJCXRoaXMudXZzW2luZGV4ICsyXSA9IChmcmFtZS54ICsgZnJhbWUud2lkdGgpIC8gdHc7CgkJCQl0aGlzLnV2c1tpbmRleCArM10gPSBmcmFtZS55IC8gdGg7CgoJCQkJdGhpcy51dnNbaW5kZXggKzRdID0gKGZyYW1lLnggKyBmcmFtZS53aWR0aCkgLyB0dzsKCQkJCXRoaXMudXZzW2luZGV4ICs1XSA9IChmcmFtZS55ICsgZnJhbWUuaGVpZ2h0KSAvIHRoOyAKCgkJCQl0aGlzLnV2c1tpbmRleCArNl0gPSBmcmFtZS54IC8gdHc7CgkJCQl0aGlzLnV2c1tpbmRleCArN10gPSAoZnJhbWUueSArIGZyYW1lLmhlaWdodCkgLyB0aDsKCgkJCQlkaXNwbGF5T2JqZWN0LnVwZGF0ZUZyYW1lID0gZmFsc2U7CgkJCX0KCgkJCS8vIFRPRE8gdGhpcyBwcm9iYWJseSBjb3VsZCBkbyB3aXRoIHNvbWUgb3B0aW1pc2F0aW9uLi4uLgoJCQlpZihkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgIT0gZGlzcGxheU9iamVjdC53b3JsZEFscGhhKQoJCQl7CgkJCQlkaXNwbGF5T2JqZWN0LmNhY2hlQWxwaGEgPSBkaXNwbGF5T2JqZWN0LndvcmxkQWxwaGE7CgoJCQkJdmFyIGNvbG9ySW5kZXggPSBpbmRleFJ1biAqIDQ7CgkJCQl0aGlzLmNvbG9yc1tjb2xvckluZGV4XSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAxXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAyXSA9IHRoaXMuY29sb3JzW2NvbG9ySW5kZXggKyAzXSA9IGRpc3BsYXlPYmplY3Qud29ybGRBbHBoYTsKCQkJCXRoaXMuZGlydHlDb2xvcnMgPSB0cnVlOwoJCQl9CgkJfQoJCWVsc2UKCQl7CgkJCWluZGV4ID0gaW5kZXhSdW4gKiA4OwoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyAwIF0gPSAwOwoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDEgXSA9IDA7CgoJCQl0aGlzLnZlcnRpY2llc1tpbmRleCArIDIgXSA9IDA7CgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgMyBdID0gMDsKCgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgNCBdID0gMDsKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA1IF0gPSAwOwoKCQkJdGhpcy52ZXJ0aWNpZXNbaW5kZXggKyA2XSA9IDA7CgkJCXRoaXMudmVydGljaWVzW2luZGV4ICsgN10gPSAwOwoJCX0KCgkJaW5kZXhSdW4rKzsKCQlkaXNwbGF5T2JqZWN0ID0gZGlzcGxheU9iamVjdC5fX25leHQ7CiAgIH0KfQogIHJldHVybiBQaGFzZXI7Cn0pOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:52:32 GMT",
                    "Content-Length": "1102762",
                    "Date": "Fri, 07 Nov 2014 21:52:40 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}