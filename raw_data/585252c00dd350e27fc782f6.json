{
    "url": "http://localhost:9999/Fluidbyte/ColtJS/example/js/libs/colt.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>location.pathname</b> and written to <b>history.pushState()</b> via the following statements:<ul><li>var location = window.location,                 root = location.pathname.replace(/[^\\/]$/, \"$&amp;\"),                 _this = this,                 url;</li><li>url = root + location.search;</li><li>history.pushState(null, document.title, url);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Fluidbyte/ColtJS/example/js/libs/colt.js",
                "path": "/Fluidbyte/ColtJS/example/js/libs/colt.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9GbHVpZGJ5dGUvQ29sdEpTL2V4YW1wbGUvanMvbGlicy9jb2x0LmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMzk4MzQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTU6NTY6MzAgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjU2OjI3IEdNVA0KDQovKioKICogQ29sdEpTIEZyYW1ld29yawogKgogKiBAdmVyc2lvbiAxLjAuMAogKiBAbGljZW5zZSBNSVQtTGljZW5zZSA8aHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL01JVD4KICoKICogQ29weXJpZ2h0IChjKSAyMDEzIENvbHRKUwogKgogKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5CiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMKICogb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMgZnVybmlzaGVkIHRvIGRvCiAqIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKICoKICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCiAqCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SIElNUExJRUQsCiAqIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBCiAqIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUgQVVUSE9SUyBPUiBDT1BZUklHSFQKICogSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OCiAqIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRQogKiBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRSBTT0ZUV0FSRQogKi8KCgovKioKICogQ29sdEpTIEZyYW1ld29yawogKi8KZGVmaW5lKGZ1bmN0aW9uICgpIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICAvKioKICAgICAqIFRoZSBtYWluIENvbHQgb2JqZWN0CiAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICovCiAgICB2YXIgQ29sdCA9IHsKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udGFpbmVyIGZvciBhbGwgcm91dGVzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICByb3V0ZXM6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDb250YWluZXIgZm9yIGFsbCBtb2R1bGUgb2JqZWN0cwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgc2NvcGU6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDb25hdGluZXIgZm9yIGFsbCBkZXBlbmRlbmNpZXMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIGRlcGVuZGVuY2llczoge30sCiAgICAgICAgCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udGFpbmVyIGZvciBhbGwgbW9kZWxzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBtb2RlbHM6IHt9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIENvbnRhaW5lciBmb3IgYWxsIGRlZmluZWQgeGhyIHJlcXVlc3RzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICByZXF1ZXN0czoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgaW5pdAogICAgICAgICAqCiAgICAgICAgICogQWRkcyBtb2R1bGUgdG8gQ29sdCBvYmplY3QsIHNldHMgdXAgY29yZSBwcm9wZXJ0aWVzIGFuZCBpbml0aWFsaXplcyByb3V0ZXIKICAgICAgICAgKi8KICAgICAgICBpbml0OiBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICB2YXIgbW9kdWxlLAogICAgICAgICAgICAgICAgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIG1heDsKCiAgICAgICAgICAgIC8vIE1ha2UgYXZhaWxhYmxlIGluIGdsb2JhbCBzY29wZQogICAgICAgICAgICB3aW5kb3cuQ29sdCA9IHRoaXM7CgogICAgICAgICAgICByZXF1aXJlKHRoaXMubW9kdWxlcywgZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgICAgIC8vIExvYWQgbW9kdWxlcyBpbnRvIGFwcGxpY2F0aW9uIHNjb3BlCiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBtb2R1bGUgPSBfdGhpcy5tb2R1bGVzW2ldLnNwbGl0KCIvIikucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcGVbbW9kdWxlXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICAvLyBBZGQgbW9kdWxlLWlkIHRvIHNjb3BlCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcGVbbW9kdWxlXS5taWQgPSBtb2R1bGU7CiAgICAgICAgICAgICAgICAgICAgLy8gQ3JlYXRlIGVsZW1lbnQgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcGVbbW9kdWxlXS5lbCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIltkYXRhLXZpZXc9JyIgKyBtb2R1bGUgKyAiJ10iKTsKICAgICAgICAgICAgICAgICAgICAvLyBJZiBqUXVlcnkgaXMgYXZhaWxhYmxlIGNyZWF0ZSBqUXVlcnkgYWNjZXNzaWJsZSBET00gcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3BlW21vZHVsZV0uJGVsID0galF1ZXJ5KCJbZGF0YS12aWV3PSciICsgbW9kdWxlICsgIiddIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBtb2R1bGUuZm9yRWFjaEVsCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuc2NvcGVbbW9kdWxlXS5mb3JFYWNoRWwgPSBfdGhpcy5mb3JFYWNoRWw7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgcm91dGVyCiAgICAgICAgICAgICAgICBfdGhpcy5yb3V0ZXIoKTsKCiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gUG9seWZpbGwgZm9yIGJpbmQoKQogICAgICAgICAgICBpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBvbHlmaWxsX2JpbmQoKTsKICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHJvdXRlcgogICAgICAgICAqCiAgICAgICAgICogU2V0cyB1cCBSb3V0aW5nIFRhYmxlLCBiaW5kcyBhbmQgbG9hZHMgUm91dGVzCiAgICAgICAgICovCiAgICAgICAgcm91dGVyOiBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICB2YXIgY3VyX3JvdXRlID0gd2luZG93LmxvY2F0aW9uLmhhc2gsCiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBtb2R1bGUsCiAgICAgICAgICAgICAgICByb3V0ZTsKCiAgICAgICAgICAgIGZvciAobW9kdWxlIGluIHRoaXMuc2NvcGUpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLnNjb3BlLmhhc093blByb3BlcnR5KG1vZHVsZSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKHJvdXRlIGluIHRoaXMuc2NvcGVbbW9kdWxlXS5yb3V0ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLnJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVzW3JvdXRlXSA9IFtbbW9kdWxlLCB0aGlzLnNjb3BlW21vZHVsZV0ucm91dGVzW3JvdXRlXV1dOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5yb3V0ZXNbcm91dGVdLnB1c2goW21vZHVsZSx0aGlzLnNjb3BlW21vZHVsZV0ucm91dGVzW3JvdXRlXV0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJbml0aWFsIHJvdXRlCiAgICAgICAgICAgIHRoaXMubG9hZFVybChjdXJfcm91dGUpOwoKICAgICAgICAgICAgLy8gQmluZCBjaGFuZ2UKICAgICAgICAgICAgd2luZG93Lm9uaGFzaGNoYW5nZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIF90aGlzLmxvYWRVcmwod2luZG93LmxvY2F0aW9uLmhhc2gpOwogICAgICAgICAgICB9OwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGxvYWRVcmwKICAgICAgICAgKgogICAgICAgICAqIENoZWNrcyB0byB2ZXJpZnkgdGhhdCBjdXJyZW50IHJvdXRlIG1hdGNoZXMgYSBtb2R1bGUncyByb3V0ZSwgcGFzc2VzIGl0IHRvIHRoZSBwcm9jZXNzb3IoKSBhbmQgaGlkZXMgYWxsIG1vZHVsZXMgdGhhdCBkb24ndCBuZWVkIHRvIGJlIHJlbmRlcmVkCiAgICAgICAgICoKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZnJhZ21lbnQgVGhlIGN1cnJlbnQgaGFzaAogICAgICAgICAqLwogICAgICAgIGxvYWRVcmw6IGZ1bmN0aW9uIChmcmFnbWVudCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgcXVlcnlzdHJpbmcgPSBmYWxzZSwKICAgICAgICAgICAgICAgIHVybF9kYXRhID0ge30sCiAgICAgICAgICAgICAgICBxc19kYXRhLAogICAgICAgICAgICAgICAgZWxfbG9jaywKICAgICAgICAgICAgICAgIG1vZHVsZV9uYW1lLAogICAgICAgICAgICAgICAgcm91dGUsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgX2ksCiAgICAgICAgICAgICAgICBfbWF4LAogICAgICAgICAgICAgICAgYml0czsKCiAgICAgICAgICAgIC8vIEJyZWFrIGFwYXJ0IGZyYWdtZW50CiAgICAgICAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQucmVwbGFjZSgiIyEvIiwgIiIpOwoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGFuZCByZW1vdmUgdHJhaWxpbmcgc2xhc2gKICAgICAgICAgICAgaWYoZnJhZ21lbnQuc3Vic3RyKC0xKSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnN1YnN0cigwLCBmcmFnbWVudC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3BsaXQgb2ZmIGFueSBxdWVyeXN0cmluZ3MKICAgICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zcGxpdCgiPyIpOwogICAgICAgICAgICBpZiAoZnJhZ21lbnRbMV0pIHsKICAgICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nID0gZnJhZ21lbnRbMV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBVUkwgRGF0YSAtIFNsYXNoIGRlbGltaXRlZAogICAgICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50WzBdLnNwbGl0KCIvIik7CiAgICAgICAgICAgIGlmKGZyYWdtZW50Lmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDEsIG1heCA9IGZyYWdtZW50Lmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgdXJsX2RhdGFbaS0xXSA9IGZyYWdtZW50W2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBBZGQgUXVlcnlzdHJpbmcgZGF0YSB0byBVUkwgRGF0YSBvYmplY3QKICAgICAgICAgICAgaWYgKHF1ZXJ5c3RyaW5nKSB7CiAgICAgICAgICAgICAgICBxc19kYXRhID0gcXVlcnlzdHJpbmcuc3BsaXQoIiYiKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG1heCA9IHFzX2RhdGEubGVuZ3RoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBiaXRzID0gcXNfZGF0YVtpXS5zcGxpdCgiPSIpOwogICAgICAgICAgICAgICAgICAgIHVybF9kYXRhW2JpdHNbMF1dID0gYml0c1sxXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU3RvcmUgY3VycmVudCByb3V0ZQogICAgICAgICAgICBfdGhpcy5jdXJyZW50X3JvdXRlID0gZnJhZ21lbnRbMF07CgogICAgICAgICAgICAvLyBTdG9yZSB1cmwgZGF0YQogICAgICAgICAgICBfdGhpcy51cmxfZGF0YSA9IHVybF9kYXRhOwoKICAgICAgICAgICAgLy8gQ2hlY2sgcm91dGUgZm9yIG1hdGNoKGVzKQogICAgICAgICAgICBmb3IgKHJvdXRlIGluIF90aGlzLnJvdXRlcykgewogICAgICAgICAgICAgICAgaWYgKF90aGlzLnJvdXRlcy5oYXNPd25Qcm9wZXJ0eShyb3V0ZSkpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKF9pID0gMCwgX21heCA9IF90aGlzLnJvdXRlc1tyb3V0ZV0ubGVuZ3RoOyBfaSA8IF9tYXg7IF9pKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gR2V0IE5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgbW9kdWxlX25hbWUgPSBfdGhpcy5yb3V0ZXNbcm91dGVdW19pXVswXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIHJvdXRlIGZvciBtYXRjaAogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZnJhZ21lbnRbMF0gPT09IHJvdXRlIHx8IHJvdXRlID09PSAiKiIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWxfbG9jayAhPT0gbW9kdWxlX25hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBQcmV2ZW50cyBvdGhlciByb3V0ZXMgaW4gdGhlIHNhbWUgbW9kdWxlIGZyb20gaGlkaW5nIHRoaXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbF9sb2NrID0gbW9kdWxlX25hbWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2VuZCBtb2R1bGUgdG8gcHJvY2Vzc29yCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucHJvY2Vzc29yKG1vZHVsZV9uYW1lLCBfdGhpcy5yb3V0ZXNbcm91dGVdW19pXVsxXSwgdXJsX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIENsZWFyICYgSGlkZSBzZWN0aW9ucyB0aGF0IGRvbid0IGV4aXN0IGluIGN1cnJlbnQgcm91dGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnVucmVuZGVyKG1vZHVsZV9uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHByb2Nlc3NvcgogICAgICAgICAqCiAgICAgICAgICogSGFuZGxlcyBwcm9jZXNzaW5nIG9mIHRoZSBtb2R1bGUsIGxvYWRzIHRlbXBsYXRlLCBmaXJlcyBkZXBlbmRlbmN5IGxvYWRlciB0aGVuIHRoZSByb3V0ZSBldmVudAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IG1vZHVsZSBUaGUgbW9kdWxlIG9iamVjdCB0byBiZSB1c2VkLgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IHJvdXRlX2ZuIFRoZSByZXR1cm4gZnVuY3Rpb24gZnJvbSB0aGUgcm91dGUuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHVybF9kYXRhIFRoZSBkYXRhIGZyb20gYW55IHVybCBxdWVyeSBzdHJpbmdzCiAgICAgICAgICovCiAgICAgICAgcHJvY2Vzc29yOiBmdW5jdGlvbiAobW9kdWxlLCByb3V0ZV9mbiwgdXJsX2RhdGEpIHsKCiAgICAgICAgICAgIHZhciBzY29wZSA9IHRoaXMuc2NvcGVbbW9kdWxlXSwKICAgICAgICAgICAgICAgIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIFNldCBtb2R1bGUgdG8gbG9hZGVkCiAgICAgICAgICAgIHNjb3BlLmxvYWRlZCA9IHRydWU7CgogICAgICAgICAgICAvLyBDaGVjayB0byBzZWUgaWYgd2UgYXJlIHVzaW5nIGlubGluZSB0ZW1wbGF0ZSBvciBpZiB0ZW1wbGF0ZSBoYXMgYWxyZWFkeSBiZWVuIGxvYWRlZC9kZWZpbmVkCiAgICAgICAgICAgIGlmICghc2NvcGUuaGFzT3duUHJvcGVydHkoInRlbXBsYXRlIikpIHsKCiAgICAgICAgICAgICAgICAvLyBHZXQgdGhlIHRlbXBsYXRlCiAgICAgICAgICAgICAgICBfdGhpcy5hamF4KHsKICAgICAgICAgICAgICAgICAgICB1cmw6ICJ0ZW1wbGF0ZXMvIiArIHNjb3BlLm1pZCArICIudHBsIiwKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAoZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICBzY29wZS50ZW1wbGF0ZSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmxvYWREZXBlbmRlbmNpZXMoc2NvcGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJ1biByb3V0ZSBhZnRlciBkZXBzIGFyZSBsb2FkZWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW3JvdXRlX2ZuXSh1cmxfZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJFcnJvciBMb2FkaW5nIiArIHNjb3BlLm1pZCArICIudHBsIik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX3RoaXMubG9hZERlcGVuZGVuY2llcyhzY29wZSwgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIC8vIFJ1biByb3V0ZSBhZnRlciBkZXBzIGFyZSBsb2FkZWQKICAgICAgICAgICAgICAgICAgICBzY29wZVtyb3V0ZV9mbl0odXJsX2RhdGEpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBsb2FkRGVwZW5kZW5jaWVzCiAgICAgICAgICogCiAgICAgICAgICogQ2hlY2tzIGZvciAmIGxvYWRzIGFueSBkZXBlbmRlbmNpZXMgYmVmb3JlIGNhbGxpbmcgdGhlIHJvdXRlJ3MgZnVuY3Rpb24KICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgVGhlIG1vZHVsZSBvYmplY3QgdG8gYmUgdXNlZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBGdW5jdGlvbiB0byBleGVjdXRlIHdoZW4gYWxsIGRlcHMgYXJlIGxvYWRlZAogICAgICAgICAqLwogICAgICAgIGxvYWREZXBlbmRlbmNpZXM6IGZ1bmN0aW9uIChzY29wZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICBkZXAsCiAgICAgICAgICAgICAgICBkZXBfbmFtZSwKICAgICAgICAgICAgICAgIGRlcF9zcmMsCiAgICAgICAgICAgICAgICBhcnJfZGVwX25hbWUgPSBbXSwKICAgICAgICAgICAgICAgIGFycl9kZXBfc3JjID0gW107CgogICAgICAgICAgICAvLyBMb2FkIG1vZHVsZSdzIGRlcGVuZGVuY2llcwogICAgICAgICAgICBpZiAoc2NvcGUuaGFzT3duUHJvcGVydHkoImRlcGVuZGVuY2llcyIpKSB7CgogICAgICAgICAgICAgICAgLy8gQnVpbGQgRGVwZW5kZW5jeSBBcnJheXMKICAgICAgICAgICAgICAgIGZvciAoZGVwIGluIHNjb3BlLmRlcGVuZGVuY2llcykgewogICAgICAgICAgICAgICAgICAgIGlmIChzY29wZS5kZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkoZGVwKSkgewogICAgICAgICAgICAgICAgICAgICAgICBkZXBfbmFtZSA9IGRlcDsKICAgICAgICAgICAgICAgICAgICAgICAgZGVwX3NyYyA9IHNjb3BlLmRlcGVuZGVuY2llc1tkZXBdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQ2hlY2sgaWYgYWxyZWFkeSBsb2FkZWQgaW50byBnbG9iYWwKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKF90aGlzLmRlcGVuZGVuY2llcy5oYXNPd25Qcm9wZXJ0eShkZXBfc3JjKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbZGVwX25hbWVdID0gX3RoaXMuZGVwZW5kZW5jaWVzW2RlcF9zcmNdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gQWRkIHRvIGFycmF5IHRvIGJlIHB1bGxlZCB2aWEgUmVxdWlyZQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyX2RlcF9uYW1lLnB1c2goZGVwX25hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJyX2RlcF9zcmMucHVzaChkZXBfc3JjKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBMb2FkIGRlcHMgYW5kIGFkZCB0byBvYmplY3QKICAgICAgICAgICAgICAgIHJlcXVpcmUoYXJyX2RlcF9zcmMsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGVbYXJyX2RlcF9uYW1lW2ldXSA9IGFyZ3VtZW50c1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0b3JlIGluIGdsb2JhbGx5IGFjY2Vzc2libGUgZGVwZW5kZW5jaWVzIG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5kZXBlbmRlbmNpZXNbYXJyX2RlcF9zcmNbaV1dID0gYXJndW1lbnRzW2ldOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBGaXJlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICAgICAgaWYgKCBjYWxsYmFjayAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIgKXsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgLy8gTW9kdWxlIGhhcyBubyBkZXBlbmRlbmNpZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZpcmUgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmICggY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iICl7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCByZW5kZXIKICAgICAgICAgKiAKICAgICAgICAgKiBSZW5kZXJzIGEgbW9kdWxlJ3MgdGVtcGxhdGUgb250byB0aGUgc2NyZWVuCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBtb2R1bGUgb2JqZWN0IHRvIGJlIHVzZWQuCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFtkYXRhXSBBbnkgZGF0YSB0byBiZSByZW5kZXJlZCBvbnRvIHRoZSB0ZW1wbGF0ZS4KICAgICAgICAgKi8KICAgICAgICByZW5kZXI6IGZ1bmN0aW9uIChzY29wZSwgZGF0YSkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBzY29wZS50ZW1wbGF0ZSwKICAgICAgICAgICAgICAgIHRlbXBsYXRlUmVuZGVyLAogICAgICAgICAgICAgICAgcmVuZGVyZWQsCiAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgIGk7CgogICAgICAgICAgICAvLyBmaWx0ZXIgZnVuY3Rpb24gZm9yIHRoZSB0ZW1wbGF0ZQogICAgICAgICAgICB0ZW1wbGF0ZVJlbmRlciA9IGZ1bmN0aW9uIChpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFbbWF0Y2hdOwogICAgICAgICAgICB9OwoKICAgICAgICAgICAgZm9yIChtYXggPSBzY29wZS5lbC5sZW5ndGgsIGkgPSAwOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgIC8vIEdldCBlbGVtZW50CiAgICAgICAgICAgICAgICBlbCA9IHNjb3BlLmVsW2ldOwogICAgICAgICAgICAgICAgLy8gUmVwbGFjZSBhbnkgbXVzdGFjaGUtc3R5bGUge3tWQVJ9fSdzCiAgICAgICAgICAgICAgICByZW5kZXJlZCA9IHRlbXBsYXRlLnJlcGxhY2UoL1x7XHsoW159XSspXH1cfS9nLCB0ZW1wbGF0ZVJlbmRlcik7CgogICAgICAgICAgICAgICAgLy8gUmVuZGVyIHRvIERPTSAmIFNob3cgRWxlbWVudAogICAgICAgICAgICAgICAgZWwuaW5uZXJIVE1MID0gcmVuZGVyZWQ7CiAgICAgICAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQnVpbGQgRXZlbnQgTGlzdGVuZXJzCiAgICAgICAgICAgIF90aGlzLmRlbGVnYXRlRXZlbnRzKHNjb3BlLmV2ZW50cywgc2NvcGUpOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgdW5yZW5kZXIKICAgICAgICAgKiAKICAgICAgICAgKiBSZW1vdmVzIHVudXNlZCBtb2R1bGVzJyBjb250ZW50IGZyb20gRE9NIGFuZCBzZXRzIGRpc3BsYXkgdG8gbm9uZQogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtb2R1bGVfbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kdWxlIHRvIHVucmVuZGVyCiAgICAgICAgICovCiAgICAgICAgdW5yZW5kZXI6IGZ1bmN0aW9uIChtb2R1bGVfbmFtZSkgewogICAgICAgICAgICB2YXIgaW5kZXgsCiAgICAgICAgICAgICAgICBlbCwKICAgICAgICAgICAgICAgIG1heDsKICAgICAgICAgICAgZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS12aWV3PSciICsgbW9kdWxlX25hbWUgKyAiJ10iKTsKICAgICAgICAgICAgZm9yIChpbmRleCA9IDAsIG1heCA9IGVsLmxlbmd0aDsgaW5kZXggPCBtYXg7IGluZGV4KyspIHsKICAgICAgICAgICAgICAgIGVsW2luZGV4XS5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgICAgICAgIGVsW2luZGV4XS5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBhY2Nlc3MKICAgICAgICAgKiAKICAgICAgICAgKiBQcm94eSBmdW5jdGlvbiBmb3IgYWNjZXNzaW5nIG90aGVyIG1vZHVsZXMgYW5kIHRoZWlyIGRlcGVuZGVuY2llcwogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGUgTmFtZSBvZiB0aGUgbW9kdWxlIHRvIGFjY2VzcwogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBmaXJlIG9uY2UgYWNjZXNzIGlzIGNvbXBsZXRlCiAgICAgICAgICovCiAgICAgICAgYWNjZXNzOiBmdW5jdGlvbiAobW9kdWxlLCBjYWxsYmFjaykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgc2NvcGUgPSB0aGlzLnNjb3BlW21vZHVsZV07CiAgICAgICAgICAgIGlmICghc2NvcGUuaGFzT3duUHJvcGVydHkoImxvYWRlZCIpKSB7CiAgICAgICAgICAgICAgICAvLyBOb3QgcHJldmlvdXNseSBsb2FkZWQsIGNoZWNrIGZvciBkZXBlbmRlbmNpZXMKICAgICAgICAgICAgICAgIF90aGlzLmxvYWREZXBlbmRlbmNpZXMoc2NvcGUsIGZ1bmN0aW9uIChzY29wZSkgewogICAgICAgICAgICAgICAgICAgIHNjb3BlLmxvYWRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhzY29wZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBNb2R1bGUgcHJldmlvdXNseSBsb2FkZWQsIGZpcmUgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhzY29wZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG5hdmlnYXRlCiAgICAgICAgICogCiAgICAgICAgICogUmVzcG9uc2libGUgZm9yIHVwZGF0aW5nIHRoZSBoaXN0b3J5IGhhc2gsIGFuZCBjaGFuZ2luZyB0aGUgVVJMCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtICB7U3RyaW5nfSBmcmFnbWVudCBUaGUgbG9jYXRpb24gdG8gYmUgbG9hZGVkCiAgICAgICAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgICAgICAgKi8KICAgICAgICBuYXZpZ2F0ZTogZnVuY3Rpb24gKGZyYWdtZW50KSB7CgogICAgICAgICAgICB2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24sCiAgICAgICAgICAgICAgICByb290ID0gbG9jYXRpb24ucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgIiQmIiksCiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICB1cmw7CgogICAgICAgICAgICAvLyBIYW5kbGUgdXJsIGNvbXBvc2l0aW9uCiAgICAgICAgICAgIGlmIChmcmFnbWVudC5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIC8vIEZyYWdtZW50IGV4aXN0cwogICAgICAgICAgICAgICAgdXJsID0gcm9vdCArIGxvY2F0aW9uLnNlYXJjaCArICIjIS8iICsgZnJhZ21lbnQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBOdWxsL0JsYW5rIGZyYWdtZW50LCBuYXYgdG8gcm9vdAogICAgICAgICAgICAgICAgdXJsID0gcm9vdCArIGxvY2F0aW9uLnNlYXJjaDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKGhpc3RvcnkucHVzaFN0YXRlKSB7CiAgICAgICAgICAgICAgICAvLyBCcm93c2VyIHN1cHBvcnRzIHB1c2hTdGF0ZSgpCiAgICAgICAgICAgICAgICBoaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBkb2N1bWVudC50aXRsZSwgdXJsKTsKICAgICAgICAgICAgICAgIF90aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gT2xkZXIgYnJvd3NlciBmYWxsYmFjawogICAgICAgICAgICAgICAgbG9jYXRpb24ucmVwbGFjZShyb290ICsgdXJsKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBkZWxlZ2F0ZUV2ZW50cwogICAgICAgICAqIAogICAgICAgICAqIEJpbmRzIGNhbGxiYWNrcyBmb3IgYSBtb2R1bGUncyBldmVudHMgb2JqZWN0CiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGV2ZW50cyBFdmVudHMgdG8gYmUgd2F0Y2hlZCBmb3IKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gc2NvcGUgVGhlIGN1cnJlbnQgbW9kdWxlCiAgICAgICAgICovCiAgICAgICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uIChldmVudHMsIHNjb3BlKSB7CgogICAgICAgICAgICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLywKICAgICAgICAgICAgICAgIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIG1ldGhvZCwKICAgICAgICAgICAgICAgIG1hdGNoLAogICAgICAgICAgICAgICAgZXZlbnRfbmFtZSwKICAgICAgICAgICAgICAgIHNlbGVjdG9yLAogICAgICAgICAgICAgICAgbm9kZXMsCiAgICAgICAgICAgICAgICBrZXksCiAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGV2ZW50cyBvbiB0aGlzIHNlY3Rpb25hbCB0aGVuIHdlIG1vdmUgb24KICAgICAgICAgICAgaWYgKCFldmVudHMpIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yIChrZXkgaW4gZXZlbnRzKSB7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnRzLmhhc093blByb3BlcnR5KGtleSkpIHsKICAgICAgICAgICAgICAgICAgICBtZXRob2QgPSBldmVudHNba2V5XTsKICAgICAgICAgICAgICAgICAgICBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgICAgICAgICAgICAgIGV2ZW50X25hbWUgPSBtYXRjaFsxXTsKICAgICAgICAgICAgICAgICAgICBzZWxlY3RvciA9IG1hdGNoWzJdOwogICAgICAgICAgICAgICAgICAgIC8qCiAgICAgICAgICAgICAgICAgICAgICogYmluZCBtZXRob2Qgb24gZXZlbnQgZm9yIHNlbGVjdG9yIG9uIHNjb3BlLm1pZAogICAgICAgICAgICAgICAgICAgICAqIHRoZSBjYWxsZXIgZnVuY3Rpb24gaGFzIGFjY2VzcyB0byBldmVudCwgQ29sdCwgc2NvcGUKICAgICAgICAgICAgICAgICAgICAgKi8KICAgICAgICAgICAgICAgICAgICBub2RlcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoIltkYXRhLXZpZXc9JyIgKyBzY29wZS5taWQgKyAiJ10gIiArIHNlbGVjdG9yKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbWF4ID0gbm9kZXMubGVuZ3RoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuYmluZEV2ZW50KG5vZGVzW2ldLCBldmVudF9uYW1lLCBzY29wZVttZXRob2RdLmJpbmQoc2NvcGUpLCB0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGJpbmRFdmVudAogICAgICAgICAqIAogICAgICAgICAqIFVzZWQgdG8gYmluZCBldmVudHMgdG8gRE9NIG9iamVjdHMKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZWwgRWxlbWVudCBvbiB3aGljaCB0byBhdHRhY2ggZXZlbnQKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gZXZ0IEV2ZW50IG5hbWUKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbiBGdW5jdGlvbiB0byBiZSBjYWxsZWQKICAgICAgICAgKiBAcGFyYW0ge0Jvb2xlYW59IFtwZGVmXSBCb29sZWFuIHRvIHByZXZlbnREZWZhdWx0CiAgICAgICAgICovCiAgICAgICAgYmluZEV2ZW50OiBmdW5jdGlvbiAoZWwsIGV2dCwgZm4sIHBkZWYpIHsKICAgICAgICAgICAgcGRlZiA9IHBkZWYgfHwgZmFsc2U7CiAgICAgICAgICAgIGlmIChlbC5hZGRFdmVudExpc3RlbmVyKSB7IC8vIE1vZGVybiBicm93c2VycwogICAgICAgICAgICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcihldnQsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwZGVmKSB7IGV2ZW50LnByZXZlbnREZWZhdWx0ID8gZXZlbnQucHJldmVudERlZmF1bHQoKSA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IH0KICAgICAgICAgICAgICAgICAgICBmbihldmVudCk7CiAgICAgICAgICAgICAgICB9LCBmYWxzZSk7CiAgICAgICAgICAgIH0gZWxzZSB7IC8vIElFIDw9IDgKICAgICAgICAgICAgICAgIGVsLmF0dGFjaEV2ZW50KCJvbiIgKyBldnQsIGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgICAgIGlmIChwZGVmKSB7IGV2ZW50LnByZXZlbnREZWZhdWx0ID8gZXZlbnQucHJldmVudERlZmF1bHQoKSA6IGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7IH0KICAgICAgICAgICAgICAgICAgICBmbihldmVudCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgbW9kZWwKICAgICAgICAgKiAKICAgICAgICAgKiBBbGxvd3MgZm9yIGxvY2FsIEFQSSBtb2RlbCBjcmVhdGUsIHJlYWQsIGFuZCBkZWxldGUKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgbW9kZWwKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gW2RhdGFdIENvbnRlbnRzIG9mIHRoZSBtb2RlbCwgYmxhbmsgdG8gcmV0dXJuLCAnbnVsbCcgdG8gY2xlYXIKICAgICAgICAgKiAKICAgICAgICAgKiBTcGVjaWZ5IGEgb2JqZWN0IHZhbHVlIHRvIGBzZXRgLCBub25lIHRvIGBnZXRgLCBhbmQgJ251bGwnIHRvIGBjbGVhcmAKICAgICAgICAgKi8KICAgICAgICBtb2RlbDogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICBtb2RlbCwKICAgICAgICAgICAgICAgIHBhcmFtczsKCiAgICAgICAgICAgIC8vIElmIGZpcnN0IGFyZ3VtZW50IGlzIGFuIG9iamVjdCwgY3JlYXRlIG1vZGVsCiAgICAgICAgICAgIGlmICh0eXBlb2YgYXJndW1lbnRzWzBdID09PSAib2JqZWN0IikgewoKICAgICAgICAgICAgICAgIHBhcmFtcyA9IGFyZ3VtZW50c1swXTsKCiAgICAgICAgICAgICAgICAvLyBDaGVjayBvcHRpb25hbCBwYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICBwYXJhbXMudXJsID0gcGFyYW1zLnVybCB8fCBmYWxzZTsKICAgICAgICAgICAgICAgIHBhcmFtcy5vbmNoYW5nZSA9IHBhcmFtcy5vbmNoYW5nZSB8fCBmYWxzZTsKCiAgICAgICAgICAgICAgICAvLyBDb3JlIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIGlmKHR5cGVvZiBwYXJhbXMubmFtZSA9PT0gInN0cmluZyIgJiYgcGFyYW1zLm5hbWUgIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgX3RoaXMubW9kZWxzW3BhcmFtcy5uYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogcGFyYW1zLmRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSBzYXZlIG1ldGhvZCwgZXg6IENvbHQubW9kZWwoJ3NvbWVfbW9kZWwnKS5nZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgImdldCI6IF90aGlzLnN5bmMuYmluZChfdGhpcywgcGFyYW1zLm5hbWUsICJHRVQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmaW5lIGdldCBtZXRob2QsIGV4OiBDb2x0Lm1vZGVsKCdzb21lX21vZGVsJykucHV0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICJwdXQiOiBfdGhpcy5zeW5jLmJpbmQoX3RoaXMsIHBhcmFtcy5uYW1lLCAiUFVUIiksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSBwb3N0IG1ldGhvZCwgZXg6IENvbHQubW9kZWwoJ3NvbWVfbW9kZWwnKS5wb3N0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICJwb3N0IjogX3RoaXMuc3luYy5iaW5kKF90aGlzLCBwYXJhbXMubmFtZSwgIlBPU1QiKSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRGVmaW5lIGRlbGV0ZSBtZXRob2QsIGV4OiBDb2x0Lm1vZGVsKCdzb21lX21vZGVsJykuZGVsZXRlOwogICAgICAgICAgICAgICAgICAgICAgICAiZGVsZXRlIjogX3RoaXMuc3luYy5iaW5kKF90aGlzLCBwYXJhbXMubmFtZSwgIkRFTEVURSIpCiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgVVJMIG9mIGVuZHBvaW50IHN1cHBsaWVkLCBzZXQgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLnVybCkgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb2RlbHNbcGFyYW1zLm5hbWVdLnVybCA9IHBhcmFtcy51cmw7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvbmNoYW5nZSBmbiBpcyBzcGVjaWZpZWQsIHNldCBhcyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMub25jaGFuZ2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubW9kZWxzW3BhcmFtcy5uYW1lXS5vbmNoYW5nZSA9IHBhcmFtcy5vbmNoYW5nZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIElmIG9uc3luYyBmbiBpcyBzcGVjaWZpZWQsIHNldCBhcyBwcm9wZXJ0eQogICAgICAgICAgICAgICAgICAgIGlmIChwYXJhbXMub25zeW5jKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vZGVsc1twYXJhbXMubmFtZV0ub25zeW5jID0gcGFyYW1zLm9uc3luYzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0aGUgbW9kZWwKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMubW9kZWxzW3BhcmFtcy5uYW1lXTsKCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2Fubm90IGNyZWF0ZSBhIG51bGwgbW9kZWwiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1vZGlmeSBleGlzdGluZyBvYmplY3QKICAgICAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CgogICAgICAgICAgICAgICAgbmFtZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgIG1vZGVsID0gX3RoaXMubW9kZWxzW25hbWVdOwoKICAgICAgICAgICAgICAgIC8vIE1vZGlmeSBkYXRhCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1sxXSA9PT0gIm9iamVjdCIgJiYgYXJndW1lbnRzWzFdICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kZWwuZGF0YSA9IGFyZ3VtZW50c1sxXTsKCiAgICAgICAgICAgICAgICAgICAgLy8gRmlyZSBvbmNoYW5nZQogICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5oYXNPd25Qcm9wZXJ0eSgib25jaGFuZ2UiKSkgewogICAgICAgICAgICAgICAgICAgICAgICBtb2RlbC5vbmNoYW5nZShtb2RlbC5kYXRhKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIFB1Ymxpc2ggZm9yIGFueSBzdWJzY3JpcHRpb25zCiAgICAgICAgICAgICAgICAgICAgX3RoaXMucHVibGlzaCgibW9kZWxfIituYW1lKyJfY2hhbmdlIiwgbW9kZWwuZGF0YSk7CgogICAgICAgICAgICAgICAgLy8gRGVsZXRlIG1vZGVsCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBfdGhpcy5tb2RlbHNbbmFtZV07CiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgLy8gUmV0dXJuIG1vZGVsCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuYW1lID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICAgICAgbW9kZWwgPSBfdGhpcy5tb2RlbHNbbmFtZV07CiAgICAgICAgICAgICAgICByZXR1cm4gbW9kZWw7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBzeW5jCiAgICAgICAgICogCiAgICAgICAgICogR2V0cyBib3VuZCB0byBtb2RlbHMsIHVzZWQgdG8gYWNjZXNzIEFQSQogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIE5hbWUgb2YgdGhlIG1vZGVsCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCBSRVNUZnVsIHJlcXVlc3QgbWV0aG9kCiAgICAgICAgICovCgogICAgICAgIHN5bmM6IGZ1bmN0aW9uIChuYW1lLCBtZXRob2QpIHsKCiAgICAgICAgICAgIHZhciBtb2RlbCA9IHRoaXMubW9kZWxzW25hbWVdLAogICAgICAgICAgICAgICAgc2VuZGJhY2sgPSB7fSwKICAgICAgICAgICAgICAgIC8vIERlZmluZSBjYWxsCiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICB1cmwgPSB0aGlzLnBhcnNlVVJMKG1vZGVsLnVybCwgbW9kZWwuZGF0YSksCiAgICAgICAgICAgICAgICBkYXRhID0gbW9kZWwuZGF0YSwKICAgICAgICAgICAgICAgIHN5bmNQYXJhbXMgPSB7CiAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmwsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogbWV0aG9kLAogICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgcXNEYXRhOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiAocmV0dXJuRGF0YSApewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHNlbmRiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRiYWNrLnN0YXR1cyA9ICJzdWNjZXNzIjsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGJhY2suZGF0YSA9IHJldHVybkRhdGE7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiBHRVQgc3VjY2VzcywgVXBkYXRlIG1vZGVsIGRhdGEKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gIkdFVCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vZGVsKG5hbWUsSlNPTi5wYXJzZShyZXR1cm5EYXRhKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE9uIERFTEVURSBzdWNjZXNzLCBSZW1vdmUgbW9kZWwKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1ldGhvZCA9PT0gIkRFTEVURSIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vZGVsKG5hbWUsbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmUgb25zeW5jIGlmIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsLmhhc093blByb3BlcnR5KCJvbnN5bmMiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwub25zeW5jKHNlbmRiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHVibGlzaCBmb3IgYW55IHN1YnNjcmlwdGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucHVibGlzaCgibW9kZWxfIituYW1lKyJfc3luYyIsIHNlbmRiYWNrKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiAocmVxKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTZXQgc2VuZGJhY2sKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGJhY2suc3RhdHVzID0gImVycm9yIjsKICAgICAgICAgICAgICAgICAgICAgICAgc2VuZGJhY2suZGF0YSA9IHJlcTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEZpcmUgb25zeW5jIGlmIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1vZGVsLmhhc093blByb3BlcnR5KCJvbnN5bmMiKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwub25zeW5jKHNlbmRiYWNrKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHVibGlzaCBmb3IgYW55IHN1YnNjcmlwdGlvbnMKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMucHVibGlzaCgibW9kZWxfIituYW1lKyJfc3luYyIsIHNlbmRiYWNrKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERyb3AgZXJyb3IgYm9tYgogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk1vZGVsIFN5bmMgRXJyb3I6IFtyZXFdIDogIiArIHJlcSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIENhbGwgdGhlIGFqYXggZnVuY3Rpb24KICAgICAgICAgICAgX3RoaXMuYWpheChzeW5jUGFyYW1zKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHJlcXVlc3QKICAgICAgICAgKiAKICAgICAgICAgKiBBbGxvd3MgZm9yIHN0b3JpbmcgcHJlLXNldCB4aHIgcmVxdWVzdHMgZm9yIHJlLXVzZQogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB4aHItcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBwYXJhbXMgUGFyYW1hdGVycyBvZiB0aGUgcmVxdWVzdCB0byBkZWZpbmUgKHNlZSBAbWV0aG9kIGFqYXgpCiAgICAgICAgICovCiAgICAgICAgcmVxdWVzdDogZnVuY3Rpb24gKG5hbWUsIHBhcmFtcykgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgICAgIC8vIElmIHZhbHVlIGlzIGRldGVjdGVkLCBzZXQgbmV3IG9yIG1vZGlmeSByZXF1ZXN0CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW1zID09PSAib2JqZWN0IiAmJiBwYXJhbXMgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIFN0cmluZ2lmeSBvYmplY3RzCiAgICAgICAgICAgICAgICBfdGhpcy5yZXF1ZXN0c1tuYW1lXSA9IHsKICAgICAgICAgICAgICAgICAgICAvLyBDb25uZWN0aW9uIHBhcmFtZXRlcnMKICAgICAgICAgICAgICAgICAgICBwYXJhbXM6IHBhcmFtcywKICAgICAgICAgICAgICAgICAgICAvLyBEZWZpbmUgY2FsbCBtZXRob2QsIGV4OiBDb2x0LnJlcXVlc3QoInNvbWVfcmVxdWVzdCIpLmNhbGwoZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgY2FsbDogX3RoaXMuY2FsbFJlcXVlc3QuYmluZChfdGhpcywgbmFtZSkKICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSByZXF1ZXN0IGZvciB2YXJpYWJsZSBhc3NpZ25tZW50CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVxdWVzdHNbbmFtZV07CgogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBObyBwYXJhbXMgc3VwcGxpZWQsIHJldHVybiByZXF1ZXN0CiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5yZXF1ZXN0c1tuYW1lXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTnVsbCBzcGVjaWZpZWQsIHJlbW92ZSByZXF1ZXN0CiAgICAgICAgICAgIGlmIChwYXJhbXMgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5yZXF1ZXN0cy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBfdGhpcy5yZXF1ZXN0c1tuYW1lXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGNhbGxSZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogRmlyZXMgYSBzdG9yZWQgcmVxdWVzdCB2aWEgYWpheCgpIG1ldGhvZAogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIHBhc3NlZCBmcm9tIHRoZSBiaW5kLCBvciBtYW51YWxseSBzdXBwbGllZAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBkYXRhIFRoZSBkYXRhIHRvIGJlIHNlbnQgd2l0aCB0aGUgcmVxdWVzdAogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IFtzdWNjZXNzXSBPcHRpb25hbCBzdWNjZXNzIGNhbGxiYWNrLCBjYW4gYWxzbyBiZSBzcGVjaWZpZWQgaW4gcmVxdWVzdCBwYXJhbXMKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbZXJyb3JdIE9wdGlvbmFsIGVycm9yIGNhbGxiYWNrLCBjYW4gYWxzbyBiZSBzcGVjaWZpZWQgaW4gcmVxdWVzdCBwYXJhbXMKICAgICAgICAgKi8KICAgICAgICBjYWxsUmVxdWVzdDogZnVuY3Rpb24gKG5hbWUsIGRhdGEsIHN1Y2Nlc3MsIGVycm9yKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgcmVxdWVzdCA9IHt9LAogICAgICAgICAgICAgICAgcGFyYW07CgogICAgICAgICAgICAvLyBDaGVjayBmb3Igb3B0aW9uYWwgc3VjY2VzcyBhbmQgZXJyb3IgY2FsbGJhY2tzCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzdWNjZXNzIHx8IGZhbHNlOwogICAgICAgICAgICBlcnJvciA9IGVycm9yIHx8IGZhbHNlOwoKICAgICAgICAgICAgaWYgKF90aGlzLnJlcXVlc3RzLmhhc093blByb3BlcnR5KG5hbWUpKSB7CgogICAgICAgICAgICAgICAgLy8gV2UgaGF2ZSB0byBsb29wIHRoZSByZXF1ZXN0J3MgcGFyYW1zIGludG8gdGhlIG5ldyByZXF1ZXN0IG9iamVjdAogICAgICAgICAgICAgICAgLy8gc28gd2UgZG9uJ3Qgb3ZlcnJpZGUgdGhlIHJlcXVlc3RzIHNldHRpbmdzCiAgICAgICAgICAgICAgICBmb3IgKHBhcmFtIGluIF90aGlzLnJlcXVlc3RzW25hbWVdLnBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5yZXF1ZXN0c1tuYW1lXS5wYXJhbXMuaGFzT3duUHJvcGVydHkocGFyYW0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RbcGFyYW1dID0gX3RoaXMucmVxdWVzdHNbbmFtZV0ucGFyYW1zW3BhcmFtXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gUGFyc2UgYW55IFVSTCBkYXRhCiAgICAgICAgICAgICAgICByZXF1ZXN0LnVybCA9IF90aGlzLnBhcnNlVVJMKHJlcXVlc3QudXJsLCBkYXRhKTsKCiAgICAgICAgICAgICAgICAvLyBTZXQgdGhlIGRhdGEgcGFyYW0KICAgICAgICAgICAgICAgIHJlcXVlc3QuZGF0YSA9IGRhdGE7CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIHN1Y2Nlc3MgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmIChzdWNjZXNzICYmIHR5cGVvZiBzdWNjZXNzID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5zdWNjZXNzID0gc3VjY2VzczsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBDaGVjayBmb3IgZXJyb3IgY2FsbGJhY2sKICAgICAgICAgICAgICAgIGlmIChlcnJvciAmJiB0eXBlb2YgZXJyb3IgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICByZXF1ZXN0LmVycm9yID0gZXJyb3I7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2FsbCB0aGUgYWpheCByZXF1ZXN0CiAgICAgICAgICAgICAgICBfdGhpcy5hamF4KHJlcXVlc3QpOwoKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgcGFyc2VVUkwKICAgICAgICAgKiAKICAgICAgICAgKiBQYXJzZXMgbW9kZWwncyB1cmwgcHJvcGVydHkgYWdhaW5zdCBkYXRhIG9iamVjdAogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgbW9kZWwKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBDb250ZW50cyBvZiB0aGUgbW9kZWwKICAgICAgICAgKi8KICAgICAgICBwYXJzZVVSTDogZnVuY3Rpb24gKHVybCwgZGF0YSkgewogICAgICAgICAgICByZXR1cm4gdXJsLnJlcGxhY2UoL1x7KFtefV0rKVx9L2csIGZ1bmN0aW9uIChpLCBtYXRjaCkgewogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGFbbWF0Y2hdOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGFqYXgKICAgICAgICAgKiAKICAgICAgICAgKiBVc2VkIHRvIG1ha2UgQUpBWCBjYWxscwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBVUkwgb2YgdGhlIHJlc291cmNlCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFtjb25maWddIENvbmZpZ3VyYXRpb24gb2JqZWN0IHBhc3NlZCBpbnRvIHJlcXVlc3QKICAgICAgICAgKiAKICAgICAgICAgKiAqKkNvbmZpZ3VyYXRpb24gT2JqZWN0OioqCiAgICAgICAgICogCiAgICAgICAgICogYHVybGA6IFVSTCBvZiByZXF1ZXN0IGlmIG5vdCBzcGVjaWZpZWQgYXMgZmlyc3QgYXJndW1lbnQKICAgICAgICAgKiAKICAgICAgICAgKiBgdHlwZWA6IFJlcXVlc3QgbWV0aG9kLCBkZWZhdWx0cyB0byBgR0VUYAogICAgICAgICAqIAogICAgICAgICAqIGBhc3luY2A6IFJ1biByZXF1ZXN0IGFzeW5jaHJvbm91c2x5LCBkZWZhdWx0cyB0byBgVFJVRWAKICAgICAgICAgKiAKICAgICAgICAgKiBgY2FjaGVgOiBDYWNoZSB0aGUgcmVxdWVzdCwgZGVmYXVsdHMgdG8gYFRSVUVgCiAgICAgICAgICogCiAgICAgICAgICogYGRhdGFgOiBPYmplY3Qgb3IgSlNPTiBkYXRhIHBhc3NlZCB0aHJvdWdoIHJlcXVlc3QKICAgICAgICAgKiAKICAgICAgICAgKiBgc3VjY2Vzc2A6IEZ1bmN0aW9uIGNhbGxlZCBvbiBzdWNjZXNzZnVsIHJlcXVlc3QKICAgICAgICAgKiAKICAgICAgICAgKiBgZXJyb3JgOiBGdW5jdGlvbiBjYWxsZWQgb24gZmFpbHVyZSBvZiByZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogYHFzRGF0YWA6IEFsbG93cyBibG9ja2luZyAoc2V0IGBmYWxzZWApIG9mIGBkYXRhYCBhZGQgdG8gVVJMIGZvciBSRVNUZnVsIHJlcXVlc3RzCiAgICAgICAgICovCiAgICAgICAgYWpheDogZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAvLyBQYXJlbnQgb2JqZWN0IGZvciBhbGwgcGFyYW1ldGVycwogICAgICAgICAgICB2YXIgeGhyID0ge307CgogICAgICAgICAgICAvLyBEZXRlcm1pbmUgY2FsbCBzdHJ1Y3R1cmU6IGFqYXgodXJsLCB7IHBhcmFtcyB9KTsgb3IgYWpheCh7IHBhcmFtcyB9KTsKICAgICAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIC8vIEFsbCBwYXJhbXMgcGFzc2VkIGFzIG9iamVjdAogICAgICAgICAgICAgICAgeGhyID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gUG9wdWxhdGUgeGhyIG9iaiB3aXRoIHNlY29uZCBhcmd1bWVudAogICAgICAgICAgICAgICAgeGhyID0gYXJndW1lbnRzWzFdOwogICAgICAgICAgICAgICAgLy8gQWRkIGZpcnN0IGFyZ3VtZW50IHRvIHhociBvYmplY3QgYXMgdXJsCiAgICAgICAgICAgICAgICB4aHIudXJsID0gYXJndW1lbnRzWzBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQYXJhbWV0ZXJzICYgRGVmYXVsdHMKICAgICAgICAgICAgeGhyLnJlcXVlc3QgPSBmYWxzZTsKICAgICAgICAgICAgeGhyLnR5cGUgPSB4aHIudHlwZSB8fCAiR0VUIjsKICAgICAgICAgICAgeGhyLmRhdGEgPSB4aHIuZGF0YSB8fCBudWxsOwogICAgICAgICAgICBpZiAoeGhyLnFzRGF0YSB8fCAheGhyLmhhc093blByb3BlcnR5KCJxc0RhdGEiKSkgeyB4aHIucXNEYXRhID0gdHJ1ZTsgfSBlbHNlIHsgeGhyLnFzRGF0YSA9IGZhbHNlOyB9CiAgICAgICAgICAgIGlmICh4aHIuY2FjaGUgfHwgIXhoci5oYXNPd25Qcm9wZXJ0eSgiY2FjaGUiKSkgeyB4aHIuY2FjaGUgPSB0cnVlOyB9IGVsc2UgeyB4aHIuY2FjaGUgPSBmYWxzZTsgfQogICAgICAgICAgICBpZiAoeGhyLmFzeW5jIHx8ICF4aHIuaGFzT3duUHJvcGVydHkoImFzeW5jIikpIHsgeGhyLmFzeW5jID0gdHJ1ZTsgfSBlbHNlIHsgeGhyLmFzeW5jID0gZmFsc2U7IH0KICAgICAgICAgICAgaWYgKHhoci5zdWNjZXNzICYmIHR5cGVvZiB4aHIuc3VjY2VzcyA9PT0gImZ1bmN0aW9uIikgeyB4aHIuc3VjY2VzcyA9IHhoci5zdWNjZXNzOyB9IGVsc2UgeyB4aHIuc3VjY2VzcyA9IGZhbHNlOyB9CiAgICAgICAgICAgIGlmICh4aHIuZXJyb3IgJiYgdHlwZW9mIHhoci5lcnJvciA9PT0gImZ1bmN0aW9uIikgeyB4aHIuZXJyb3IgPSB4aHIuZXJyb3I7IH0gZWxzZSB7IHhoci5lcnJvciA9IGZhbHNlOyB9CgogICAgICAgICAgICAvLyBGb3JtYXQgeGhyLmRhdGEgJiBlbmNvZGUgdmFsdWVzCiAgICAgICAgICAgIGlmICh4aHIuZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIHBhcmFtX2NvdW50ID0gMCwKICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlLAogICAgICAgICAgICAgICAgICAgIHRtcF9kYXRhID0geGhyLmRhdGE7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBwYXJhbSBpbiB0bXBfZGF0YSkgewogICAgICAgICAgICAgICAgICAgIGlmKHRtcF9kYXRhLmhhc093blByb3BlcnR5KHBhcmFtKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBlbmNvZGVVUklDb21wb25lbnQocGFyYW0pOwogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh0bXBfZGF0YVtwYXJhbV0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1fY291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5kYXRhID0gbmFtZSArICI9IiArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLmRhdGEgKz0gIiYiICsgbmFtZSArICI9IiArIHZhbHVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtX2NvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgeGhyLmRhdGEgPSB4aHIuZGF0YTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQXBwZW5kcyBkYXRhIHRvIFVSTAogICAgICAgICAgICBmdW5jdGlvbiBmb3JtYXRVUkwoZGF0YSkgewogICAgICAgICAgICAgICAgdmFyIHVybF9zcGxpdCA9IHhoci51cmwuc3BsaXQoIj8iKTsKICAgICAgICAgICAgICAgIGlmICh1cmxfc3BsaXQubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLnVybCArPSAiJiIgKyBkYXRhOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB4aHIudXJsICs9ICI/IiArIGRhdGE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEhhbmRsZSB4aHIuZGF0YSBvbiBHRVQgcmVxdWVzdCB0eXBlCiAgICAgICAgICAgIGlmICh4aHIuZGF0YSAmJiB4aHIudHlwZS50b1VwcGVyQ2FzZSgpID09PSAiR0VUIiAmJiB4aHIucXNEYXRhKSB7CiAgICAgICAgICAgICAgICBmb3JtYXRVUkwoeGhyLmRhdGEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBjYWNoZSBwYXJhbWV0ZXIsIHNldCBVUkwgcGFyYW0KICAgICAgICAgICAgaWYgKCF4aHIuY2FjaGUpIHsKICAgICAgICAgICAgICAgIGZvcm1hdFVSTChuZXcgRGF0ZSgpLmdldFRpbWUoKSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEVzdGFibGlzaCByZXF1ZXN0CiAgICAgICAgICAgIGlmICh3aW5kb3cuWE1MSHR0cFJlcXVlc3QpIHsKICAgICAgICAgICAgICAgIC8vIE1vZGVybiBub24tSUUKICAgICAgICAgICAgICAgIHhoci5yZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAod2luZG93LkFjdGl2ZVhPYmplY3QpIHsKICAgICAgICAgICAgICAgIC8vIEludGVybmV0IEV4cGxvcmVyCiAgICAgICAgICAgICAgICB4aHIucmVxdWVzdCA9IG5ldyBBY3RpdmVYT2JqZWN0KCJNaWNyb3NvZnQuWE1MSFRUUCIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTm8gcmVxdWVzdCBvYmplY3QsIGJyZWFrCiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE1vbml0b3IgUmVhZHlTdGF0ZQogICAgICAgICAgICB4aHIucmVxdWVzdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoeGhyLnJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgICAgICAgICAgICAgIGlmICh4aHIucmVxdWVzdC5zdGF0dXMgPT09IDIwMCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnN1Y2Nlc3MpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFJldHVybnMgcmVzcG9uc2VUZXh0IGFuZCByZXF1ZXN0IG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLnN1Y2Nlc3MoeGhyLnJlcXVlc3QucmVzcG9uc2VUZXh0LCB4aHIucmVxdWVzdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLmVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm5zIHJlcXVlc3Qgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuZXJyb3IoeGhyLnJlcXVlc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgLy8gT3BlbiBIdHRwIFJlcXVlc3QgY29ubmVjdGlvbgogICAgICAgICAgICB4aHIucmVxdWVzdC5vcGVuKHhoci50eXBlLCB4aHIudXJsLCB4aHIuYXN5bmMpOwoKICAgICAgICAgICAgLy8gU2V0IHJlcXVlc3QgaGVhZGVyIGZvciBQT1NUCiAgICAgICAgICAgIGlmICh4aHIudHlwZS50b1VwcGVyQ2FzZSgpID09PSAiUE9TVCIgfHwgeGhyLnR5cGUudG9VcHBlckNhc2UoKSA9PT0gIlBVVCIpIHsKICAgICAgICAgICAgICAgIHhoci5yZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gU2VuZCBkYXRhCiAgICAgICAgICAgIHhoci5yZXF1ZXN0LnNlbmQoeGhyLmRhdGEpOwoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHN0b3JlCiAgICAgICAgICogCiAgICAgICAgICogTG9jYWxTdG9yYWdlIHdpdGggcG9seWZpbGwgc3VwcG9ydCB2aWEgY29va2llcwogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgVGhlIGtleSBvciBpZGVudGlmaWVyIGZvciB0aGUgc3RvcmUKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ3xPYmplY3R9IFt2YWx1ZV0gQ29udGVudHMgb2YgdGhlIHN0b3JlLCBibGFuayB0byByZXR1cm4sICdudWxsJyB0byBjbGVhcgogICAgICAgICAqIAogICAgICAgICAqIFNwZWNpZnkgYSBzdHJpbmcvb2JqZWN0IHZhbHVlIHRvIGBzZXRgLCBub25lIHRvIGBnZXRgLCBhbmQgJ251bGwnIHRvIGBjbGVhcmAKICAgICAgICAgKi8KICAgICAgICBzdG9yZTogZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBsc1N1cHBvcnQgPSBmYWxzZTsKCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBuYXRpdmUgc3VwcG9ydAogICAgICAgICAgICBpZiAobG9jYWxTdG9yYWdlKSB7CiAgICAgICAgICAgICAgICBsc1N1cHBvcnQgPSB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBkZXRlY3RlZCwgc2V0IG5ldyBvciBtb2RpZnkgc3RvcmUKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSAhPT0gInVuZGVmaW5lZCIgJiYgdmFsdWUgIT09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIFN0cmluZ2lmeSBvYmplY3RzCiAgICAgICAgICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBBZGQgdG8gLyBtb2RpZnkgc3RvcmFnZQogICAgICAgICAgICAgICAgaWYgKGxzU3VwcG9ydCkgeyAvLyBOYXRpdmUgc3VwcG9ydAogICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gVXNlIENvb2tpZQogICAgICAgICAgICAgICAgICAgIF90aGlzLmNyZWF0ZUNvb2tpZShrZXksIHZhbHVlLCAzMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE5vIHZhbHVlIHN1cHBsaWVkLCByZXR1cm4gdmFsdWUKICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIGlmIChsc1N1cHBvcnQpIHsgLy8gTmF0aXZlIHN1cHBvcnQKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIFVzZSBjb29raWUKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVhZENvb2tpZShrZXkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBOdWxsIHNwZWNpZmllZCwgcmVtb3ZlIHN0b3JlCiAgICAgICAgICAgIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaWYgKGxzU3VwcG9ydCkgeyAvLyBOYXRpdmUgc3VwcG9ydAogICAgICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKGtleSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBVc2UgY29va2llCiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY3JlYXRlQ29va2llKGtleSwgIiIsIC0xKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGNyZWF0ZUNvb2tpZQogICAgICAgICAqIAogICAgICAgICAqIENyZWF0ZXMgbmV3IGNvb2tpZSBvciByZW1vdmVzIGNvb2tpZSB3aXRoIG5lZ2F0aXZlIGV4cGlyYXRpb24KICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgb3IgaWRlbnRpZmllciBmb3IgdGhlIHN0b3JlCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHZhbHVlIENvbnRlbnRzIG9mIHRoZSBzdG9yZQogICAgICAgICAqIEBwYXJhbSB7TnVtYmVyfSBleHAgRXhwaXJhdGlvbiBpbiBkYXlzCiAgICAgICAgICovCiAgICAgICAgY3JlYXRlQ29va2llOiBmdW5jdGlvbihrZXksIHZhbHVlLCBleHApIHsKICAgICAgICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgpLAogICAgICAgICAgICAgICAgZXhwaXJlczsKICAgICAgICAgICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpICsgKGV4cCAqIDI0ICogNjAgKiA2MCAqIDEwMDApKTsKICAgICAgICAgICAgZXhwaXJlcyA9ICI7IGV4cGlyZXM9IiArIGRhdGUudG9HTVRTdHJpbmcoKTsKICAgICAgICAgICAgZG9jdW1lbnQuY29va2llID0ga2V5ICsgIj0iICsgdmFsdWUgKyBleHBpcmVzICsgIjsgcGF0aD0vIjsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBSZXR1cm5zIGNvbnRlbnRzIG9mIGNvb2tpZQogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBrZXkgVGhlIGtleSBvciBpZGVudGlmaWVyIGZvciB0aGUgc3RvcmUKICAgICAgICAgKiBAcmV0dXJuIHtTdHJpbmd9IHRoZSB2YWx1ZSBvZiB0aGUgY29va2llCiAgICAgICAgICovCiAgICAgICAgcmVhZENvb2tpZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgIHZhciBuYW1lRVEgPSBrZXkgKyAiPSIsCiAgICAgICAgICAgICAgICBjYSA9IGRvY3VtZW50LmNvb2tpZS5zcGxpdCgiOyIpLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIG1heCwKICAgICAgICAgICAgICAgIGM7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIG1heCA9IGNhLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICBjID0gY2FbaV07CiAgICAgICAgICAgICAgICB3aGlsZSAoYy5jaGFyQXQoMCkgPT09ICIgIikgeyBjID0gYy5zdWJzdHJpbmcoMSwgYy5sZW5ndGgpOyB9CiAgICAgICAgICAgICAgICBpZiAoYy5pbmRleE9mKG5hbWVFUSkgPT09IDApIHsgcmV0dXJuIGMuc3Vic3RyaW5nKG5hbWVFUS5sZW5ndGgsIGMubGVuZ3RoKTsgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBudWxsOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFBsYWNlaG9sZGVyIG9iamVjdCBmb3IgcHViL3N1YgogICAgICAgICAqLwogICAgICAgIHRvcGljczoge30sCgogICAgICAgIC8qKgogICAgICAgICAqIElEIGZvciBpbmNyZW1lbnRpbmcKICAgICAgICAgKi8KICAgICAgICB0b3BpY19pZDogMCwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBwdWJsaXNoCiAgICAgICAgICogCiAgICAgICAgICogUHVibGlzaCB0byBhIHRvcGljCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IHRvcGljIFRvcGljIG9mIHRoZSBzdWJzY3JpcHRpb24KICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gYXJncyBBcnJheSBvZiBhcmd1bWVudHMgcGFzc2VkCiAgICAgICAgICovCiAgICAgICAgcHVibGlzaDogZnVuY3Rpb24gKHRvcGljLCBhcmdzKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CiAgICAgICAgICAgIGlmICghX3RoaXMudG9waWNzLmhhc093blByb3BlcnR5KHRvcGljKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIHN1YnNjcmliZXJzID0gX3RoaXMudG9waWNzW3RvcGljXSwKICAgICAgICAgICAgICAgICAgICBsZW47CgogICAgICAgICAgICAgICAgaWYgKHN1YnNjcmliZXJzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgICAgIGxlbiA9IHN1YnNjcmliZXJzLmxlbmd0aDsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHdoaWxlIChsZW4tLSkgewogICAgICAgICAgICAgICAgICAgIHN1YnNjcmliZXJzW2xlbl0uZm4oYXJncyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIDApOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHN1YnNjcmliZQogICAgICAgICAqIAogICAgICAgICAqIFN1YnNjcmliZXMgdG8gYSB0b3BpYwogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0b3BpYyBUb3BpYyBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gRnVuY3Rpb24gdG8gYmUgY2FsbGVkCiAgICAgICAgICovCiAgICAgICAgc3Vic2NyaWJlOiBmdW5jdGlvbiAodG9waWMsIGZuKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBpZCA9ICsrdGhpcy50b3BpY19pZCwKICAgICAgICAgICAgICAgIG1heCwKICAgICAgICAgICAgICAgIGk7CgogICAgICAgICAgICAvLyBDcmVhdGUgbmV3IHRvcGljCiAgICAgICAgICAgIGlmICghX3RoaXMudG9waWNzW3RvcGljXSkgewogICAgICAgICAgICAgICAgX3RoaXMudG9waWNzW3RvcGljXSA9IFtdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBQcmV2ZW50IHJlLXN1YnNjcmliZSBpc3N1ZXMgKGNvbW1vbiBvbiByb3V0ZS1yZWxvYWQpCiAgICAgICAgICAgIGZvciAoaSA9IDAsIG1heCA9IF90aGlzLnRvcGljc1t0b3BpY10ubGVuZ3RoOyBpIDwgbWF4OyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy50b3BpY3NbdG9waWNdW2ldLmZuLnRvU3RyaW5nKCkgPT09IGZuLnRvU3RyaW5nKCkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMudG9waWNzW3RvcGljXVtpXS5pZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgX3RoaXMudG9waWNzW3RvcGljXS5wdXNoKHsKICAgICAgICAgICAgICAgIGlkOiBpZCwKICAgICAgICAgICAgICAgIGZuOiBmbgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHJldHVybiBpZDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHVuc3Vic2NyaWJlCiAgICAgICAgICogCiAgICAgICAgICogVW5zdWJzY3JpYmVzIGZyb20gYSB0b3BpYwogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0b2tlbiBUb2tlbiBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgICAgICovCiAgICAgICAgdW5zdWJzY3JpYmU6IGZ1bmN0aW9uICh0b2tlbikgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgdG9waWMsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbWF4OwogICAgICAgICAgICBmb3IgKHRvcGljIGluIF90aGlzLnRvcGljcykgewogICAgICAgICAgICAgICAgaWYgKF90aGlzLnRvcGljcy5oYXNPd25Qcm9wZXJ0eSh0b3BpYykpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBfdGhpcy50b3BpY3NbdG9waWNdLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy50b3BpY3NbdG9waWNdW2ldLmlkID09PSB0b2tlbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMudG9waWNzW3RvcGljXS5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdG9rZW47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgcG9seWZpbGxfYmluZAogICAgICAgICAqIAogICAgICAgICAqIFBvbHlmaWxsIGZvciAuYmluZCgpCiAgICAgICAgICovCiAgICAgICAgcG9seWZpbGxfYmluZDogZnVuY3Rpb24gKCkgewogICAgICAgICAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uIChvYmopIHsKICAgICAgICAgICAgICAgIC8vIGNsb3Nlc3QgdGhpbmcgcG9zc2libGUgdG8gdGhlIEVDTUFTY3JpcHQgNSBpbnRlcm5hbCBJc0NhbGxhYmxlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJGdW5jdGlvbi5wcm90b3R5cGUuYmluZCAtIHdoYXQgaXMgdHJ5aW5nIHRvIGJlIGJvdW5kIGlzIG5vdCBjYWxsYWJsZSIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBzbGljZSA9IFtdLnNsaWNlLAogICAgICAgICAgICAgICAgICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksCiAgICAgICAgICAgICAgICAgICAgc2VsZiA9IHRoaXMsCiAgICAgICAgICAgICAgICAgICAgbm9wID0gZnVuY3Rpb24gKCkgeyB9LAogICAgICAgICAgICAgICAgICAgIGJvdW5kID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5hcHBseSh0aGlzIGluc3RhbmNlb2Ygbm9wID8gdGhpcyA6IChvYmogfHwge30pLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcmdzLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cykpKTsKICAgICAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIGJvdW5kLnByb3RvdHlwZSA9IHRoaXMucHJvdG90eXBlOwoKICAgICAgICAgICAgICAgIHJldHVybiBib3VuZDsKICAgICAgICAgICAgfTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBIZWxwZXIgZnVuY3Rpb24gdGhhdCBleGVjdXRlcyBhIGNhbGxiYWNrIGZ1bmN0aW9uIG9uIGVhY2ggbW9kdWxlLmVsCiAgICAgICAgICogQG1ldGhvZCBmb3JlRWFjaEVsCiAgICAgICAgICogQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sKICAgICAgICAgKi8KICAgICAgICBmb3JFYWNoRWw6IGZ1bmN0aW9uIChjYWxsYmFjaykgewogICAgICAgICAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICB2YXIgaW5kZXggPSAtMSwKICAgICAgICAgICAgICAgICAgICBtYXggPSB0aGlzLmVsLmxlbmd0aDsKICAgICAgICAgICAgICAgIHdoaWxlICgrK2luZGV4IDwgbWF4KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKGluZGV4LCB0aGlzLmVsW2luZGV4XSwgdGhpcy5lbCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ2FsbGJhY2sgbXVzdCBiZSBhIGZ1bmN0aW9uIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgoKICAgIH07CgoKICAgIC8vIFJldHVybiB0aGUgZnJhbWV3b3JrCiAgICByZXR1cm4gQ29sdDsKCn0pOwo=",
                "body": "LyoqCiAqIENvbHRKUyBGcmFtZXdvcmsKICoKICogQHZlcnNpb24gMS4wLjAKICogQGxpY2Vuc2UgTUlULUxpY2Vuc2UgPGh0dHA6Ly9vcGVuc291cmNlLm9yZy9saWNlbnNlcy9NSVQ+CiAqCiAqIENvcHlyaWdodCAoYykgMjAxMyBDb2x0SlMKICoKICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weQogKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSAiU29mdHdhcmUiKSwgdG8gZGVhbAogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzCiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGwgY29waWVzCiAqIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbwogKiBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6CiAqCiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbAogKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLgogKgogKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUiBJTVBMSUVELAogKiBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwgRklUTkVTUyBGT1IgQQogKiBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUCiAqIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTgogKiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUKICogU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUKICovCgoKLyoqCiAqIENvbHRKUyBGcmFtZXdvcmsKICovCmRlZmluZShmdW5jdGlvbiAoKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgLyoqCiAgICAgKiBUaGUgbWFpbiBDb2x0IG9iamVjdAogICAgICogQHR5cGUge09iamVjdH0KICAgICAqLwogICAgdmFyIENvbHQgPSB7CgogICAgICAgIC8qKgogICAgICAgICAqIENvbnRhaW5lciBmb3IgYWxsIHJvdXRlcwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcm91dGVzOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29udGFpbmVyIGZvciBhbGwgbW9kdWxlIG9iamVjdHMKICAgICAgICAgKiBAdHlwZSB7T2JqZWN0fQogICAgICAgICAqLwogICAgICAgIHNjb3BlOiB7fSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ29uYXRpbmVyIGZvciBhbGwgZGVwZW5kZW5jaWVzCiAgICAgICAgICogQHR5cGUge09iamVjdH0KICAgICAgICAgKi8KICAgICAgICBkZXBlbmRlbmNpZXM6IHt9LAogICAgICAgIAogICAgICAgIC8qKgogICAgICAgICAqIENvbnRhaW5lciBmb3IgYWxsIG1vZGVscwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgbW9kZWxzOiB7fSwKICAgICAgICAKICAgICAgICAvKioKICAgICAgICAgKiBDb250YWluZXIgZm9yIGFsbCBkZWZpbmVkIHhociByZXF1ZXN0cwogICAgICAgICAqIEB0eXBlIHtPYmplY3R9CiAgICAgICAgICovCiAgICAgICAgcmVxdWVzdHM6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIGluaXQKICAgICAgICAgKgogICAgICAgICAqIEFkZHMgbW9kdWxlIHRvIENvbHQgb2JqZWN0LCBzZXRzIHVwIGNvcmUgcHJvcGVydGllcyBhbmQgaW5pdGlhbGl6ZXMgcm91dGVyCiAgICAgICAgICovCiAgICAgICAgaW5pdDogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgdmFyIG1vZHVsZSwKICAgICAgICAgICAgICAgIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBtYXg7CgogICAgICAgICAgICAvLyBNYWtlIGF2YWlsYWJsZSBpbiBnbG9iYWwgc2NvcGUKICAgICAgICAgICAgd2luZG93LkNvbHQgPSB0aGlzOwoKICAgICAgICAgICAgcmVxdWlyZSh0aGlzLm1vZHVsZXMsIGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgICAvLyBMb2FkIG1vZHVsZXMgaW50byBhcHBsaWNhdGlvbiBzY29wZQogICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbWF4ID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbW9kdWxlID0gX3RoaXMubW9kdWxlc1tpXS5zcGxpdCgiLyIpLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3BlW21vZHVsZV0gPSBhcmd1bWVudHNbaV07CiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIG1vZHVsZS1pZCB0byBzY29wZQogICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3BlW21vZHVsZV0ubWlkID0gbW9kdWxlOwogICAgICAgICAgICAgICAgICAgIC8vIENyZWF0ZSBlbGVtZW50IHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3BlW21vZHVsZV0uZWwgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS12aWV3PSciICsgbW9kdWxlICsgIiddIik7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSBjcmVhdGUgalF1ZXJ5IGFjY2Vzc2libGUgRE9NIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5ICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5zY29wZVttb2R1bGVdLiRlbCA9IGpRdWVyeSgiW2RhdGEtdmlldz0nIiArIG1vZHVsZSArICInXSIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAvLyBDcmVhdGUgbW9kdWxlLmZvckVhY2hFbAogICAgICAgICAgICAgICAgICAgIF90aGlzLnNjb3BlW21vZHVsZV0uZm9yRWFjaEVsID0gX3RoaXMuZm9yRWFjaEVsOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhbGwgdGhlIHJvdXRlcgogICAgICAgICAgICAgICAgX3RoaXMucm91dGVyKCk7CgogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIFBvbHlmaWxsIGZvciBiaW5kKCkKICAgICAgICAgICAgaWYgKCFGdW5jdGlvbi5wcm90b3R5cGUuYmluZCkgewogICAgICAgICAgICAgICAgdGhpcy5wb2x5ZmlsbF9iaW5kKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCByb3V0ZXIKICAgICAgICAgKgogICAgICAgICAqIFNldHMgdXAgUm91dGluZyBUYWJsZSwgYmluZHMgYW5kIGxvYWRzIFJvdXRlcwogICAgICAgICAqLwogICAgICAgIHJvdXRlcjogZnVuY3Rpb24gKCkgewoKICAgICAgICAgICAgdmFyIGN1cl9yb3V0ZSA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLAogICAgICAgICAgICAgICAgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgbW9kdWxlLAogICAgICAgICAgICAgICAgcm91dGU7CgogICAgICAgICAgICBmb3IgKG1vZHVsZSBpbiB0aGlzLnNjb3BlKSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5zY29wZS5oYXNPd25Qcm9wZXJ0eShtb2R1bGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChyb3V0ZSBpbiB0aGlzLnNjb3BlW21vZHVsZV0ucm91dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5yb3V0ZXMuaGFzT3duUHJvcGVydHkocm91dGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJvdXRlc1tyb3V0ZV0gPSBbW21vZHVsZSwgdGhpcy5zY29wZVttb2R1bGVdLnJvdXRlc1tyb3V0ZV1dXTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVzW3JvdXRlXS5wdXNoKFttb2R1bGUsdGhpcy5zY29wZVttb2R1bGVdLnJvdXRlc1tyb3V0ZV1dKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSW5pdGlhbCByb3V0ZQogICAgICAgICAgICB0aGlzLmxvYWRVcmwoY3VyX3JvdXRlKTsKCiAgICAgICAgICAgIC8vIEJpbmQgY2hhbmdlCiAgICAgICAgICAgIHdpbmRvdy5vbmhhc2hjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBfdGhpcy5sb2FkVXJsKHdpbmRvdy5sb2NhdGlvbi5oYXNoKTsKICAgICAgICAgICAgfTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBsb2FkVXJsCiAgICAgICAgICoKICAgICAgICAgKiBDaGVja3MgdG8gdmVyaWZ5IHRoYXQgY3VycmVudCByb3V0ZSBtYXRjaGVzIGEgbW9kdWxlJ3Mgcm91dGUsIHBhc3NlcyBpdCB0byB0aGUgcHJvY2Vzc29yKCkgYW5kIGhpZGVzIGFsbCBtb2R1bGVzIHRoYXQgZG9uJ3QgbmVlZCB0byBiZSByZW5kZXJlZAogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGZyYWdtZW50IFRoZSBjdXJyZW50IGhhc2gKICAgICAgICAgKi8KICAgICAgICBsb2FkVXJsOiBmdW5jdGlvbiAoZnJhZ21lbnQpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIHF1ZXJ5c3RyaW5nID0gZmFsc2UsCiAgICAgICAgICAgICAgICB1cmxfZGF0YSA9IHt9LAogICAgICAgICAgICAgICAgcXNfZGF0YSwKICAgICAgICAgICAgICAgIGVsX2xvY2ssCiAgICAgICAgICAgICAgICBtb2R1bGVfbmFtZSwKICAgICAgICAgICAgICAgIHJvdXRlLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIG1heCwKICAgICAgICAgICAgICAgIF9pLAogICAgICAgICAgICAgICAgX21heCwKICAgICAgICAgICAgICAgIGJpdHM7CgogICAgICAgICAgICAvLyBCcmVhayBhcGFydCBmcmFnbWVudAogICAgICAgICAgICBmcmFnbWVudCA9IGZyYWdtZW50LnJlcGxhY2UoIiMhLyIsICIiKTsKCiAgICAgICAgICAgIC8vIENoZWNrIGZvciBhbmQgcmVtb3ZlIHRyYWlsaW5nIHNsYXNoCiAgICAgICAgICAgIGlmKGZyYWdtZW50LnN1YnN0cigtMSkgPT09ICIvIikgewogICAgICAgICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIoMCwgZnJhZ21lbnQubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNwbGl0IG9mZiBhbnkgcXVlcnlzdHJpbmdzCiAgICAgICAgICAgIGZyYWdtZW50ID0gZnJhZ21lbnQuc3BsaXQoIj8iKTsKICAgICAgICAgICAgaWYgKGZyYWdtZW50WzFdKSB7CiAgICAgICAgICAgICAgICBxdWVyeXN0cmluZyA9IGZyYWdtZW50WzFdOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgVVJMIERhdGEgLSBTbGFzaCBkZWxpbWl0ZWQKICAgICAgICAgICAgZnJhZ21lbnQgPSBmcmFnbWVudFswXS5zcGxpdCgiLyIpOwogICAgICAgICAgICBpZihmcmFnbWVudC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAxLCBtYXggPSBmcmFnbWVudC5sZW5ndGg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHVybF9kYXRhW2ktMV0gPSBmcmFnbWVudFtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQWRkIFF1ZXJ5c3RyaW5nIGRhdGEgdG8gVVJMIERhdGEgb2JqZWN0CiAgICAgICAgICAgIGlmIChxdWVyeXN0cmluZykgewogICAgICAgICAgICAgICAgcXNfZGF0YSA9IHF1ZXJ5c3RyaW5nLnNwbGl0KCImIik7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBxc19kYXRhLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgYml0cyA9IHFzX2RhdGFbaV0uc3BsaXQoIj0iKTsKICAgICAgICAgICAgICAgICAgICB1cmxfZGF0YVtiaXRzWzBdXSA9IGJpdHNbMV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFN0b3JlIGN1cnJlbnQgcm91dGUKICAgICAgICAgICAgX3RoaXMuY3VycmVudF9yb3V0ZSA9IGZyYWdtZW50WzBdOwoKICAgICAgICAgICAgLy8gU3RvcmUgdXJsIGRhdGEKICAgICAgICAgICAgX3RoaXMudXJsX2RhdGEgPSB1cmxfZGF0YTsKCiAgICAgICAgICAgIC8vIENoZWNrIHJvdXRlIGZvciBtYXRjaChlcykKICAgICAgICAgICAgZm9yIChyb3V0ZSBpbiBfdGhpcy5yb3V0ZXMpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy5yb3V0ZXMuaGFzT3duUHJvcGVydHkocm91dGUpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChfaSA9IDAsIF9tYXggPSBfdGhpcy5yb3V0ZXNbcm91dGVdLmxlbmd0aDsgX2kgPCBfbWF4OyBfaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEdldCBOYW1lCiAgICAgICAgICAgICAgICAgICAgICAgIG1vZHVsZV9uYW1lID0gX3RoaXMucm91dGVzW3JvdXRlXVtfaV1bMF07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBDaGVjayByb3V0ZSBmb3IgbWF0Y2gKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZyYWdtZW50WzBdID09PSByb3V0ZSB8fCByb3V0ZSA9PT0gIioiKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVsX2xvY2sgIT09IG1vZHVsZV9uYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUHJldmVudHMgb3RoZXIgcm91dGVzIGluIHRoZSBzYW1lIG1vZHVsZSBmcm9tIGhpZGluZyB0aGlzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxfbG9jayA9IG1vZHVsZV9uYW1lOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNlbmQgbW9kdWxlIHRvIHByb2Nlc3NvcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnByb2Nlc3Nvcihtb2R1bGVfbmFtZSwgX3RoaXMucm91dGVzW3JvdXRlXVtfaV1bMV0sIHVybF9kYXRhKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBDbGVhciAmIEhpZGUgc2VjdGlvbnMgdGhhdCBkb24ndCBleGlzdCBpbiBjdXJyZW50IHJvdXRlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy51bnJlbmRlcihtb2R1bGVfbmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBwcm9jZXNzb3IKICAgICAgICAgKgogICAgICAgICAqIEhhbmRsZXMgcHJvY2Vzc2luZyBvZiB0aGUgbW9kdWxlLCBsb2FkcyB0ZW1wbGF0ZSwgZmlyZXMgZGVwZW5kZW5jeSBsb2FkZXIgdGhlbiB0aGUgcm91dGUgZXZlbnQKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBtb2R1bGUgVGhlIG1vZHVsZSBvYmplY3QgdG8gYmUgdXNlZC4KICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSByb3V0ZV9mbiBUaGUgcmV0dXJuIGZ1bmN0aW9uIGZyb20gdGhlIHJvdXRlLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSB1cmxfZGF0YSBUaGUgZGF0YSBmcm9tIGFueSB1cmwgcXVlcnkgc3RyaW5ncwogICAgICAgICAqLwogICAgICAgIHByb2Nlc3NvcjogZnVuY3Rpb24gKG1vZHVsZSwgcm91dGVfZm4sIHVybF9kYXRhKSB7CgogICAgICAgICAgICB2YXIgc2NvcGUgPSB0aGlzLnNjb3BlW21vZHVsZV0sCiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAvLyBTZXQgbW9kdWxlIHRvIGxvYWRlZAogICAgICAgICAgICBzY29wZS5sb2FkZWQgPSB0cnVlOwoKICAgICAgICAgICAgLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIGFyZSB1c2luZyBpbmxpbmUgdGVtcGxhdGUgb3IgaWYgdGVtcGxhdGUgaGFzIGFscmVhZHkgYmVlbiBsb2FkZWQvZGVmaW5lZAogICAgICAgICAgICBpZiAoIXNjb3BlLmhhc093blByb3BlcnR5KCJ0ZW1wbGF0ZSIpKSB7CgogICAgICAgICAgICAgICAgLy8gR2V0IHRoZSB0ZW1wbGF0ZQogICAgICAgICAgICAgICAgX3RoaXMuYWpheCh7CiAgICAgICAgICAgICAgICAgICAgdXJsOiAidGVtcGxhdGVzLyIgKyBzY29wZS5taWQgKyAiLnRwbCIsCiAgICAgICAgICAgICAgICAgICAgdHlwZTogIkdFVCIsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGUudGVtcGxhdGUgPSBkYXRhOwogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5sb2FkRGVwZW5kZW5jaWVzKHNjb3BlLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSdW4gcm91dGUgYWZ0ZXIgZGVwcyBhcmUgbG9hZGVkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZVtyb3V0ZV9mbl0odXJsX2RhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRXJyb3IgTG9hZGluZyIgKyBzY29wZS5taWQgKyAiLnRwbCIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF90aGlzLmxvYWREZXBlbmRlbmNpZXMoc2NvcGUsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAvLyBSdW4gcm91dGUgYWZ0ZXIgZGVwcyBhcmUgbG9hZGVkCiAgICAgICAgICAgICAgICAgICAgc2NvcGVbcm91dGVfZm5dKHVybF9kYXRhKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgbG9hZERlcGVuZGVuY2llcwogICAgICAgICAqIAogICAgICAgICAqIENoZWNrcyBmb3IgJiBsb2FkcyBhbnkgZGVwZW5kZW5jaWVzIGJlZm9yZSBjYWxsaW5nIHRoZSByb3V0ZSdzIGZ1bmN0aW9uCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBtb2R1bGUgb2JqZWN0IHRvIGJlIHVzZWQuCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgRnVuY3Rpb24gdG8gZXhlY3V0ZSB3aGVuIGFsbCBkZXBzIGFyZSBsb2FkZWQKICAgICAgICAgKi8KICAgICAgICBsb2FkRGVwZW5kZW5jaWVzOiBmdW5jdGlvbiAoc2NvcGUsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBpLAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgZGVwLAogICAgICAgICAgICAgICAgZGVwX25hbWUsCiAgICAgICAgICAgICAgICBkZXBfc3JjLAogICAgICAgICAgICAgICAgYXJyX2RlcF9uYW1lID0gW10sCiAgICAgICAgICAgICAgICBhcnJfZGVwX3NyYyA9IFtdOwoKICAgICAgICAgICAgLy8gTG9hZCBtb2R1bGUncyBkZXBlbmRlbmNpZXMKICAgICAgICAgICAgaWYgKHNjb3BlLmhhc093blByb3BlcnR5KCJkZXBlbmRlbmNpZXMiKSkgewoKICAgICAgICAgICAgICAgIC8vIEJ1aWxkIERlcGVuZGVuY3kgQXJyYXlzCiAgICAgICAgICAgICAgICBmb3IgKGRlcCBpbiBzY29wZS5kZXBlbmRlbmNpZXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoc2NvcGUuZGVwZW5kZW5jaWVzLmhhc093blByb3BlcnR5KGRlcCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVwX25hbWUgPSBkZXA7CiAgICAgICAgICAgICAgICAgICAgICAgIGRlcF9zcmMgPSBzY29wZS5kZXBlbmRlbmNpZXNbZGVwXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGlmIGFscmVhZHkgbG9hZGVkIGludG8gZ2xvYmFsCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChfdGhpcy5kZXBlbmRlbmNpZXMuaGFzT3duUHJvcGVydHkoZGVwX3NyYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW2RlcF9uYW1lXSA9IF90aGlzLmRlcGVuZGVuY2llc1tkZXBfc3JjXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEFkZCB0byBhcnJheSB0byBiZSBwdWxsZWQgdmlhIFJlcXVpcmUKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycl9kZXBfbmFtZS5wdXNoKGRlcF9uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFycl9kZXBfc3JjLnB1c2goZGVwX3NyYyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gTG9hZCBkZXBzIGFuZCBhZGQgdG8gb2JqZWN0CiAgICAgICAgICAgICAgICByZXF1aXJlKGFycl9kZXBfc3JjLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbWF4ID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlW2Fycl9kZXBfbmFtZVtpXV0gPSBhcmd1bWVudHNbaV07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBTdG9yZSBpbiBnbG9iYWxseSBhY2Nlc3NpYmxlIGRlcGVuZGVuY2llcyBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMuZGVwZW5kZW5jaWVzW2Fycl9kZXBfc3JjW2ldXSA9IGFyZ3VtZW50c1tpXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgLy8gRmlyZSBjYWxsYmFjawogICAgICAgICAgICAgICAgICAgIGlmICggY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iICl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHNjb3BlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIC8vIE1vZHVsZSBoYXMgbm8gZGVwZW5kZW5jaWVzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGaXJlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAoIGNhbGxiYWNrICYmIHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIiApewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKHNjb3BlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgcmVuZGVyCiAgICAgICAgICogCiAgICAgICAgICogUmVuZGVycyBhIG1vZHVsZSdzIHRlbXBsYXRlIG9udG8gdGhlIHNjcmVlbgogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBzY29wZSBUaGUgbW9kdWxlIG9iamVjdCB0byBiZSB1c2VkLgogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbZGF0YV0gQW55IGRhdGEgdG8gYmUgcmVuZGVyZWQgb250byB0aGUgdGVtcGxhdGUuCiAgICAgICAgICovCiAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiAoc2NvcGUsIGRhdGEpIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIHRlbXBsYXRlID0gc2NvcGUudGVtcGxhdGUsCiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVJlbmRlciwKICAgICAgICAgICAgICAgIHJlbmRlcmVkLAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgLy8gZmlsdGVyIGZ1bmN0aW9uIGZvciB0aGUgdGVtcGxhdGUKICAgICAgICAgICAgdGVtcGxhdGVSZW5kZXIgPSBmdW5jdGlvbiAoaSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW21hdGNoXTsKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGZvciAobWF4ID0gc2NvcGUuZWwubGVuZ3RoLCBpID0gMDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAvLyBHZXQgZWxlbWVudAogICAgICAgICAgICAgICAgZWwgPSBzY29wZS5lbFtpXTsKICAgICAgICAgICAgICAgIC8vIFJlcGxhY2UgYW55IG11c3RhY2hlLXN0eWxlIHt7VkFSfX0ncwogICAgICAgICAgICAgICAgcmVuZGVyZWQgPSB0ZW1wbGF0ZS5yZXBsYWNlKC9ce1x7KFtefV0rKVx9XH0vZywgdGVtcGxhdGVSZW5kZXIpOwoKICAgICAgICAgICAgICAgIC8vIFJlbmRlciB0byBET00gJiBTaG93IEVsZW1lbnQKICAgICAgICAgICAgICAgIGVsLmlubmVySFRNTCA9IHJlbmRlcmVkOwogICAgICAgICAgICAgICAgZWwuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEJ1aWxkIEV2ZW50IExpc3RlbmVycwogICAgICAgICAgICBfdGhpcy5kZWxlZ2F0ZUV2ZW50cyhzY29wZS5ldmVudHMsIHNjb3BlKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHVucmVuZGVyCiAgICAgICAgICogCiAgICAgICAgICogUmVtb3ZlcyB1bnVzZWQgbW9kdWxlcycgY29udGVudCBmcm9tIERPTSBhbmQgc2V0cyBkaXNwbGF5IHRvIG5vbmUKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbW9kdWxlX25hbWUgVGhlIG5hbWUgb2YgdGhlIG1vZHVsZSB0byB1bnJlbmRlcgogICAgICAgICAqLwogICAgICAgIHVucmVuZGVyOiBmdW5jdGlvbiAobW9kdWxlX25hbWUpIHsKICAgICAgICAgICAgdmFyIGluZGV4LAogICAgICAgICAgICAgICAgZWwsCiAgICAgICAgICAgICAgICBtYXg7CiAgICAgICAgICAgIGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgiW2RhdGEtdmlldz0nIiArIG1vZHVsZV9uYW1lICsgIiddIik7CiAgICAgICAgICAgIGZvciAoaW5kZXggPSAwLCBtYXggPSBlbC5sZW5ndGg7IGluZGV4IDwgbWF4OyBpbmRleCsrKSB7CiAgICAgICAgICAgICAgICBlbFtpbmRleF0uaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgICAgICBlbFtpbmRleF0uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgYWNjZXNzCiAgICAgICAgICogCiAgICAgICAgICogUHJveHkgZnVuY3Rpb24gZm9yIGFjY2Vzc2luZyBvdGhlciBtb2R1bGVzIGFuZCB0aGVpciBkZXBlbmRlbmNpZXMKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gbW9kdWxlIE5hbWUgb2YgdGhlIG1vZHVsZSB0byBhY2Nlc3MKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gZmlyZSBvbmNlIGFjY2VzcyBpcyBjb21wbGV0ZQogICAgICAgICAqLwogICAgICAgIGFjY2VzczogZnVuY3Rpb24gKG1vZHVsZSwgY2FsbGJhY2spIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIHNjb3BlID0gdGhpcy5zY29wZVttb2R1bGVdOwogICAgICAgICAgICBpZiAoIXNjb3BlLmhhc093blByb3BlcnR5KCJsb2FkZWQiKSkgewogICAgICAgICAgICAgICAgLy8gTm90IHByZXZpb3VzbHkgbG9hZGVkLCBjaGVjayBmb3IgZGVwZW5kZW5jaWVzCiAgICAgICAgICAgICAgICBfdGhpcy5sb2FkRGVwZW5kZW5jaWVzKHNjb3BlLCBmdW5jdGlvbiAoc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICBzY29wZS5sb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NvcGUpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTW9kdWxlIHByZXZpb3VzbHkgbG9hZGVkLCBmaXJlIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2sgJiYgdHlwZW9mIGNhbGxiYWNrID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soc2NvcGUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBuYXZpZ2F0ZQogICAgICAgICAqIAogICAgICAgICAqIFJlc3BvbnNpYmxlIGZvciB1cGRhdGluZyB0aGUgaGlzdG9yeSBoYXNoLCBhbmQgY2hhbmdpbmcgdGhlIFVSTAogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSAge1N0cmluZ30gZnJhZ21lbnQgVGhlIGxvY2F0aW9uIHRvIGJlIGxvYWRlZAogICAgICAgICAqIEByZXR1cm4ge0Jvb2xlYW59CiAgICAgICAgICovCiAgICAgICAgbmF2aWdhdGU6IGZ1bmN0aW9uIChmcmFnbWVudCkgewoKICAgICAgICAgICAgdmFyIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uLAogICAgICAgICAgICAgICAgcm9vdCA9IGxvY2F0aW9uLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICIkJiIpLAogICAgICAgICAgICAgICAgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgdXJsOwoKICAgICAgICAgICAgLy8gSGFuZGxlIHVybCBjb21wb3NpdGlvbgogICAgICAgICAgICBpZiAoZnJhZ21lbnQubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAvLyBGcmFnbWVudCBleGlzdHMKICAgICAgICAgICAgICAgIHVybCA9IHJvb3QgKyBsb2NhdGlvbi5zZWFyY2ggKyAiIyEvIiArIGZyYWdtZW50OwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgLy8gTnVsbC9CbGFuayBmcmFnbWVudCwgbmF2IHRvIHJvb3QKICAgICAgICAgICAgICAgIHVybCA9IHJvb3QgKyBsb2NhdGlvbi5zZWFyY2g7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChoaXN0b3J5LnB1c2hTdGF0ZSkgewogICAgICAgICAgICAgICAgLy8gQnJvd3NlciBzdXBwb3J0cyBwdXNoU3RhdGUoKQogICAgICAgICAgICAgICAgaGlzdG9yeS5wdXNoU3RhdGUobnVsbCwgZG9jdW1lbnQudGl0bGUsIHVybCk7CiAgICAgICAgICAgICAgICBfdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE9sZGVyIGJyb3dzZXIgZmFsbGJhY2sKICAgICAgICAgICAgICAgIGxvY2F0aW9uLnJlcGxhY2Uocm9vdCArIHVybCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgZGVsZWdhdGVFdmVudHMKICAgICAgICAgKiAKICAgICAgICAgKiBCaW5kcyBjYWxsYmFja3MgZm9yIGEgbW9kdWxlJ3MgZXZlbnRzIG9iamVjdAogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBldmVudHMgRXZlbnRzIHRvIGJlIHdhdGNoZWQgZm9yCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IHNjb3BlIFRoZSBjdXJyZW50IG1vZHVsZQogICAgICAgICAqLwogICAgICAgIGRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbiAoZXZlbnRzLCBzY29wZSkgewoKICAgICAgICAgICAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC8sCiAgICAgICAgICAgICAgICBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBtZXRob2QsCiAgICAgICAgICAgICAgICBtYXRjaCwKICAgICAgICAgICAgICAgIGV2ZW50X25hbWUsCiAgICAgICAgICAgICAgICBzZWxlY3RvciwKICAgICAgICAgICAgICAgIG5vZGVzLAogICAgICAgICAgICAgICAga2V5LAogICAgICAgICAgICAgICAgbWF4LAogICAgICAgICAgICAgICAgaTsKCiAgICAgICAgICAgIC8vIGlmIHRoZXJlIGFyZSBubyBldmVudHMgb24gdGhpcyBzZWN0aW9uYWwgdGhlbiB3ZSBtb3ZlIG9uCiAgICAgICAgICAgIGlmICghZXZlbnRzKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAoa2V5IGluIGV2ZW50cykgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50cy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsKICAgICAgICAgICAgICAgICAgICBldmVudF9uYW1lID0gbWF0Y2hbMV07CiAgICAgICAgICAgICAgICAgICAgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICAgICAqIGJpbmQgbWV0aG9kIG9uIGV2ZW50IGZvciBzZWxlY3RvciBvbiBzY29wZS5taWQKICAgICAgICAgICAgICAgICAgICAgKiB0aGUgY2FsbGVyIGZ1bmN0aW9uIGhhcyBhY2Nlc3MgdG8gZXZlbnQsIENvbHQsIHNjb3BlCiAgICAgICAgICAgICAgICAgICAgICovCiAgICAgICAgICAgICAgICAgICAgbm9kZXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJbZGF0YS12aWV3PSciICsgc2NvcGUubWlkICsgIiddICIgKyBzZWxlY3Rvcik7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDAsIG1heCA9IG5vZGVzLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLmJpbmRFdmVudChub2Rlc1tpXSwgZXZlbnRfbmFtZSwgc2NvcGVbbWV0aG9kXS5iaW5kKHNjb3BlKSwgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBiaW5kRXZlbnQKICAgICAgICAgKiAKICAgICAgICAgKiBVc2VkIHRvIGJpbmQgZXZlbnRzIHRvIERPTSBvYmplY3RzCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGVsIEVsZW1lbnQgb24gd2hpY2ggdG8gYXR0YWNoIGV2ZW50CiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGV2dCBFdmVudCBuYW1lCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4gRnVuY3Rpb24gdG8gYmUgY2FsbGVkCiAgICAgICAgICogQHBhcmFtIHtCb29sZWFufSBbcGRlZl0gQm9vbGVhbiB0byBwcmV2ZW50RGVmYXVsdAogICAgICAgICAqLwogICAgICAgIGJpbmRFdmVudDogZnVuY3Rpb24gKGVsLCBldnQsIGZuLCBwZGVmKSB7CiAgICAgICAgICAgIHBkZWYgPSBwZGVmIHx8IGZhbHNlOwogICAgICAgICAgICBpZiAoZWwuYWRkRXZlbnRMaXN0ZW5lcikgeyAvLyBNb2Rlcm4gYnJvd3NlcnMKICAgICAgICAgICAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoZXZ0LCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGRlZikgeyBldmVudC5wcmV2ZW50RGVmYXVsdCA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkgOiBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyB9CiAgICAgICAgICAgICAgICAgICAgZm4oZXZlbnQpOwogICAgICAgICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgICAgICB9IGVsc2UgeyAvLyBJRSA8PSA4CiAgICAgICAgICAgICAgICBlbC5hdHRhY2hFdmVudCgib24iICsgZXZ0LCBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGRlZikgeyBldmVudC5wcmV2ZW50RGVmYXVsdCA/IGV2ZW50LnByZXZlbnREZWZhdWx0KCkgOiBldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOyB9CiAgICAgICAgICAgICAgICAgICAgZm4oZXZlbnQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIG1vZGVsCiAgICAgICAgICogCiAgICAgICAgICogQWxsb3dzIGZvciBsb2NhbCBBUEkgbW9kZWwgY3JlYXRlLCByZWFkLCBhbmQgZGVsZXRlCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIG1vZGVsCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IFtkYXRhXSBDb250ZW50cyBvZiB0aGUgbW9kZWwsIGJsYW5rIHRvIHJldHVybiwgJ251bGwnIHRvIGNsZWFyCiAgICAgICAgICogCiAgICAgICAgICogU3BlY2lmeSBhIG9iamVjdCB2YWx1ZSB0byBgc2V0YCwgbm9uZSB0byBgZ2V0YCwgYW5kICdudWxsJyB0byBgY2xlYXJgCiAgICAgICAgICovCiAgICAgICAgbW9kZWw6IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXMsCiAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgbW9kZWwsCiAgICAgICAgICAgICAgICBwYXJhbXM7CgogICAgICAgICAgICAvLyBJZiBmaXJzdCBhcmd1bWVudCBpcyBhbiBvYmplY3QsIGNyZWF0ZSBtb2RlbAogICAgICAgICAgICBpZiAodHlwZW9mIGFyZ3VtZW50c1swXSA9PT0gIm9iamVjdCIpIHsKCiAgICAgICAgICAgICAgICBwYXJhbXMgPSBhcmd1bWVudHNbMF07CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgb3B0aW9uYWwgcGFyYW1ldGVycwogICAgICAgICAgICAgICAgcGFyYW1zLnVybCA9IHBhcmFtcy51cmwgfHwgZmFsc2U7CiAgICAgICAgICAgICAgICBwYXJhbXMub25jaGFuZ2UgPSBwYXJhbXMub25jaGFuZ2UgfHwgZmFsc2U7CgogICAgICAgICAgICAgICAgLy8gQ29yZSBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBpZih0eXBlb2YgcGFyYW1zLm5hbWUgPT09ICJzdHJpbmciICYmIHBhcmFtcy5uYW1lICE9PSAiIikgewogICAgICAgICAgICAgICAgICAgIF90aGlzLm1vZGVsc1twYXJhbXMubmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGE6IHBhcmFtcy5kYXRhLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZpbmUgc2F2ZSBtZXRob2QsIGV4OiBDb2x0Lm1vZGVsKCdzb21lX21vZGVsJykuZ2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICJnZXQiOiBfdGhpcy5zeW5jLmJpbmQoX3RoaXMsIHBhcmFtcy5uYW1lLCAiR0VUIiksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSBnZXQgbWV0aG9kLCBleDogQ29sdC5tb2RlbCgnc29tZV9tb2RlbCcpLnB1dCgpOwogICAgICAgICAgICAgICAgICAgICAgICAicHV0IjogX3RoaXMuc3luYy5iaW5kKF90aGlzLCBwYXJhbXMubmFtZSwgIlBVVCIpLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBEZWZpbmUgcG9zdCBtZXRob2QsIGV4OiBDb2x0Lm1vZGVsKCdzb21lX21vZGVsJykucG9zdCgpOwogICAgICAgICAgICAgICAgICAgICAgICAicG9zdCI6IF90aGlzLnN5bmMuYmluZChfdGhpcywgcGFyYW1zLm5hbWUsICJQT1NUIiksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIERlZmluZSBkZWxldGUgbWV0aG9kLCBleDogQ29sdC5tb2RlbCgnc29tZV9tb2RlbCcpLmRlbGV0ZTsKICAgICAgICAgICAgICAgICAgICAgICAgImRlbGV0ZSI6IF90aGlzLnN5bmMuYmluZChfdGhpcywgcGFyYW1zLm5hbWUsICJERUxFVEUiKQogICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgIC8vIElmIFVSTCBvZiBlbmRwb2ludCBzdXBwbGllZCwgc2V0IHByb3BlcnR5CiAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtcy51cmwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgX3RoaXMubW9kZWxzW3BhcmFtcy5uYW1lXS51cmwgPSBwYXJhbXMudXJsOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgb25jaGFuZ2UgZm4gaXMgc3BlY2lmaWVkLCBzZXQgYXMgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLm9uY2hhbmdlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLm1vZGVsc1twYXJhbXMubmFtZV0ub25jaGFuZ2UgPSBwYXJhbXMub25jaGFuZ2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiBvbnN5bmMgZm4gaXMgc3BlY2lmaWVkLCBzZXQgYXMgcHJvcGVydHkKICAgICAgICAgICAgICAgICAgICBpZiAocGFyYW1zLm9uc3luYykgewogICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb2RlbHNbcGFyYW1zLm5hbWVdLm9uc3luYyA9IHBhcmFtcy5vbnN5bmM7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdGhlIG1vZGVsCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLm1vZGVsc1twYXJhbXMubmFtZV07CgogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbm5vdCBjcmVhdGUgYSBudWxsIG1vZGVsIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb2RpZnkgZXhpc3Rpbmcgb2JqZWN0CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMikgewoKICAgICAgICAgICAgICAgIG5hbWUgPSBhcmd1bWVudHNbMF07CiAgICAgICAgICAgICAgICBtb2RlbCA9IF90aGlzLm1vZGVsc1tuYW1lXTsKCiAgICAgICAgICAgICAgICAvLyBNb2RpZnkgZGF0YQogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhcmd1bWVudHNbMV0gPT09ICJvYmplY3QiICYmIGFyZ3VtZW50c1sxXSAhPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIG1vZGVsLmRhdGEgPSBhcmd1bWVudHNbMV07CgogICAgICAgICAgICAgICAgICAgIC8vIEZpcmUgb25jaGFuZ2UKICAgICAgICAgICAgICAgICAgICBpZiAobW9kZWwuaGFzT3duUHJvcGVydHkoIm9uY2hhbmdlIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbW9kZWwub25jaGFuZ2UobW9kZWwuZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBQdWJsaXNoIGZvciBhbnkgc3Vic2NyaXB0aW9ucwogICAgICAgICAgICAgICAgICAgIF90aGlzLnB1Ymxpc2goIm1vZGVsXyIrbmFtZSsiX2NoYW5nZSIsIG1vZGVsLmRhdGEpOwoKICAgICAgICAgICAgICAgIC8vIERlbGV0ZSBtb2RlbAogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgX3RoaXMubW9kZWxzW25hbWVdOwogICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIC8vIFJldHVybiBtb2RlbAogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmFtZSA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgICAgIG1vZGVsID0gX3RoaXMubW9kZWxzW25hbWVdOwogICAgICAgICAgICAgICAgcmV0dXJuIG1vZGVsOwogICAgICAgICAgICB9CgogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2Qgc3luYwogICAgICAgICAqIAogICAgICAgICAqIEdldHMgYm91bmQgdG8gbW9kZWxzLCB1c2VkIHRvIGFjY2VzcyBBUEkKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBOYW1lIG9mIHRoZSBtb2RlbAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgUkVTVGZ1bCByZXF1ZXN0IG1ldGhvZAogICAgICAgICAqLwoKICAgICAgICBzeW5jOiBmdW5jdGlvbiAobmFtZSwgbWV0aG9kKSB7CgogICAgICAgICAgICB2YXIgbW9kZWwgPSB0aGlzLm1vZGVsc1tuYW1lXSwKICAgICAgICAgICAgICAgIHNlbmRiYWNrID0ge30sCiAgICAgICAgICAgICAgICAvLyBEZWZpbmUgY2FsbAogICAgICAgICAgICAgICAgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgdXJsID0gdGhpcy5wYXJzZVVSTChtb2RlbC51cmwsIG1vZGVsLmRhdGEpLAogICAgICAgICAgICAgICAgZGF0YSA9IG1vZGVsLmRhdGEsCiAgICAgICAgICAgICAgICBzeW5jUGFyYW1zID0gewogICAgICAgICAgICAgICAgICAgIHVybDogdXJsLAogICAgICAgICAgICAgICAgICAgIHR5cGU6IG1ldGhvZCwKICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhLAogICAgICAgICAgICAgICAgICAgIHFzRGF0YTogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gKHJldHVybkRhdGEgKXsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFNldCBzZW5kYmFjawogICAgICAgICAgICAgICAgICAgICAgICBzZW5kYmFjay5zdGF0dXMgPSAic3VjY2VzcyI7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRiYWNrLmRhdGEgPSByZXR1cm5EYXRhOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gT24gR0VUIHN1Y2Nlc3MsIFVwZGF0ZSBtb2RlbCBkYXRhCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICJHRVQiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb2RlbChuYW1lLEpTT04ucGFyc2UocmV0dXJuRGF0YSkpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBPbiBERUxFVEUgc3VjY2VzcywgUmVtb3ZlIG1vZGVsCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXRob2QgPT09ICJERUxFVEUiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfdGhpcy5tb2RlbChuYW1lLG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJlIG9uc3luYyBpZiBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5oYXNPd25Qcm9wZXJ0eSgib25zeW5jIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLm9uc3luYyhzZW5kYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFB1Ymxpc2ggZm9yIGFueSBzdWJzY3JpcHRpb25zCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnB1Ymxpc2goIm1vZGVsXyIrbmFtZSsiX3N5bmMiLCBzZW5kYmFjayk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZnVuY3Rpb24gKHJlcSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gU2V0IHNlbmRiYWNrCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRiYWNrLnN0YXR1cyA9ICJlcnJvciI7CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbmRiYWNrLmRhdGEgPSByZXE7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBGaXJlIG9uc3luYyBpZiBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtb2RlbC5oYXNPd25Qcm9wZXJ0eSgib25zeW5jIikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1vZGVsLm9uc3luYyhzZW5kYmFjayk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFB1Ymxpc2ggZm9yIGFueSBzdWJzY3JpcHRpb25zCiAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnB1Ymxpc2goIm1vZGVsXyIrbmFtZSsiX3N5bmMiLCBzZW5kYmFjayk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEcm9wIGVycm9yIGJvbWIKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJNb2RlbCBTeW5jIEVycm9yOiBbcmVxXSA6ICIgKyByZXEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAvLyBDYWxsIHRoZSBhamF4IGZ1bmN0aW9uCiAgICAgICAgICAgIF90aGlzLmFqYXgoc3luY1BhcmFtcyk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCByZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogQWxsb3dzIGZvciBzdG9yaW5nIHByZS1zZXQgeGhyIHJlcXVlc3RzIGZvciByZS11c2UKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgeGhyLXJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gcGFyYW1zIFBhcmFtYXRlcnMgb2YgdGhlIHJlcXVlc3QgdG8gZGVmaW5lIChzZWUgQG1ldGhvZCBhamF4KQogICAgICAgICAqLwogICAgICAgIHJlcXVlc3Q6IGZ1bmN0aW9uIChuYW1lLCBwYXJhbXMpIHsKCiAgICAgICAgICAgIHZhciBfdGhpcyA9IHRoaXM7CgogICAgICAgICAgICAvLyBJZiB2YWx1ZSBpcyBkZXRlY3RlZCwgc2V0IG5ldyBvciBtb2RpZnkgcmVxdWVzdAogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtcyA9PT0gIm9iamVjdCIgJiYgcGFyYW1zICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTdHJpbmdpZnkgb2JqZWN0cwogICAgICAgICAgICAgICAgX3RoaXMucmVxdWVzdHNbbmFtZV0gPSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQ29ubmVjdGlvbiBwYXJhbWV0ZXJzCiAgICAgICAgICAgICAgICAgICAgcGFyYW1zOiBwYXJhbXMsCiAgICAgICAgICAgICAgICAgICAgLy8gRGVmaW5lIGNhbGwgbWV0aG9kLCBleDogQ29sdC5yZXF1ZXN0KCJzb21lX3JlcXVlc3QiKS5jYWxsKGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGNhbGw6IF90aGlzLmNhbGxSZXF1ZXN0LmJpbmQoX3RoaXMsIG5hbWUpCiAgICAgICAgICAgICAgICB9OwoKICAgICAgICAgICAgICAgIC8vIFJldHVybiB0aGUgcmVxdWVzdCBmb3IgdmFyaWFibGUgYXNzaWdubWVudAogICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlcXVlc3RzW25hbWVdOwoKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTm8gcGFyYW1zIHN1cHBsaWVkLCByZXR1cm4gcmVxdWVzdAogICAgICAgICAgICBpZiAodHlwZW9mIGRhdGEgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMucmVxdWVzdHNbbmFtZV07CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIE51bGwgc3BlY2lmaWVkLCByZW1vdmUgcmVxdWVzdAogICAgICAgICAgICBpZiAocGFyYW1zID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMucmVxdWVzdHMuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBkZWxldGUgX3RoaXMucmVxdWVzdHNbbmFtZV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBjYWxsUmVxdWVzdAogICAgICAgICAqIAogICAgICAgICAqIEZpcmVzIGEgc3RvcmVkIHJlcXVlc3QgdmlhIGFqYXgoKSBtZXRob2QKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBwYXNzZWQgZnJvbSB0aGUgYmluZCwgb3IgbWFudWFsbHkgc3VwcGxpZWQKICAgICAgICAgKiBAcGFyYW0ge09iamVjdH0gZGF0YSBUaGUgZGF0YSB0byBiZSBzZW50IHdpdGggdGhlIHJlcXVlc3QKICAgICAgICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBbc3VjY2Vzc10gT3B0aW9uYWwgc3VjY2VzcyBjYWxsYmFjaywgY2FuIGFsc28gYmUgc3BlY2lmaWVkIGluIHJlcXVlc3QgcGFyYW1zCiAgICAgICAgICogQHBhcmFtIHtGdW5jdGlvbn0gW2Vycm9yXSBPcHRpb25hbCBlcnJvciBjYWxsYmFjaywgY2FuIGFsc28gYmUgc3BlY2lmaWVkIGluIHJlcXVlc3QgcGFyYW1zCiAgICAgICAgICovCiAgICAgICAgY2FsbFJlcXVlc3Q6IGZ1bmN0aW9uIChuYW1lLCBkYXRhLCBzdWNjZXNzLCBlcnJvcikgewoKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIHJlcXVlc3QgPSB7fSwKICAgICAgICAgICAgICAgIHBhcmFtOwoKICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIG9wdGlvbmFsIHN1Y2Nlc3MgYW5kIGVycm9yIGNhbGxiYWNrcwogICAgICAgICAgICBzdWNjZXNzID0gc3VjY2VzcyB8fCBmYWxzZTsKICAgICAgICAgICAgZXJyb3IgPSBlcnJvciB8fCBmYWxzZTsKCiAgICAgICAgICAgIGlmIChfdGhpcy5yZXF1ZXN0cy5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewoKICAgICAgICAgICAgICAgIC8vIFdlIGhhdmUgdG8gbG9vcCB0aGUgcmVxdWVzdCdzIHBhcmFtcyBpbnRvIHRoZSBuZXcgcmVxdWVzdCBvYmplY3QKICAgICAgICAgICAgICAgIC8vIHNvIHdlIGRvbid0IG92ZXJyaWRlIHRoZSByZXF1ZXN0cyBzZXR0aW5ncwogICAgICAgICAgICAgICAgZm9yIChwYXJhbSBpbiBfdGhpcy5yZXF1ZXN0c1tuYW1lXS5wYXJhbXMpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMucmVxdWVzdHNbbmFtZV0ucGFyYW1zLmhhc093blByb3BlcnR5KHBhcmFtKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0W3BhcmFtXSA9IF90aGlzLnJlcXVlc3RzW25hbWVdLnBhcmFtc1twYXJhbV07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIFBhcnNlIGFueSBVUkwgZGF0YQogICAgICAgICAgICAgICAgcmVxdWVzdC51cmwgPSBfdGhpcy5wYXJzZVVSTChyZXF1ZXN0LnVybCwgZGF0YSk7CgogICAgICAgICAgICAgICAgLy8gU2V0IHRoZSBkYXRhIHBhcmFtCiAgICAgICAgICAgICAgICByZXF1ZXN0LmRhdGEgPSBkYXRhOwoKICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBzdWNjZXNzIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAoc3VjY2VzcyAmJiB0eXBlb2Ygc3VjY2VzcyA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHJlcXVlc3Quc3VjY2VzcyA9IHN1Y2Nlc3M7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gQ2hlY2sgZm9yIGVycm9yIGNhbGxiYWNrCiAgICAgICAgICAgICAgICBpZiAoZXJyb3IgJiYgdHlwZW9mIGVycm9yID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdC5lcnJvciA9IGVycm9yOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIENhbGwgdGhlIGFqYXggcmVxdWVzdAogICAgICAgICAgICAgICAgX3RoaXMuYWpheChyZXF1ZXN0KTsKCiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHBhcnNlVVJMCiAgICAgICAgICogCiAgICAgICAgICogUGFyc2VzIG1vZGVsJ3MgdXJsIHByb3BlcnR5IGFnYWluc3QgZGF0YSBvYmplY3QKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgb2YgdGhlIG1vZGVsCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGRhdGEgQ29udGVudHMgb2YgdGhlIG1vZGVsCiAgICAgICAgICovCiAgICAgICAgcGFyc2VVUkw6IGZ1bmN0aW9uICh1cmwsIGRhdGEpIHsKICAgICAgICAgICAgcmV0dXJuIHVybC5yZXBsYWNlKC9ceyhbXn1dKylcfS9nLCBmdW5jdGlvbiAoaSwgbWF0Y2gpIHsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhW21hdGNoXTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBhamF4CiAgICAgICAgICogCiAgICAgICAgICogVXNlZCB0byBtYWtlIEFKQVggY2FsbHMKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgVVJMIG9mIHRoZSByZXNvdXJjZQogICAgICAgICAqIEBwYXJhbSB7T2JqZWN0fSBbY29uZmlnXSBDb25maWd1cmF0aW9uIG9iamVjdCBwYXNzZWQgaW50byByZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogKipDb25maWd1cmF0aW9uIE9iamVjdDoqKgogICAgICAgICAqIAogICAgICAgICAqIGB1cmxgOiBVUkwgb2YgcmVxdWVzdCBpZiBub3Qgc3BlY2lmaWVkIGFzIGZpcnN0IGFyZ3VtZW50CiAgICAgICAgICogCiAgICAgICAgICogYHR5cGVgOiBSZXF1ZXN0IG1ldGhvZCwgZGVmYXVsdHMgdG8gYEdFVGAKICAgICAgICAgKiAKICAgICAgICAgKiBgYXN5bmNgOiBSdW4gcmVxdWVzdCBhc3luY2hyb25vdXNseSwgZGVmYXVsdHMgdG8gYFRSVUVgCiAgICAgICAgICogCiAgICAgICAgICogYGNhY2hlYDogQ2FjaGUgdGhlIHJlcXVlc3QsIGRlZmF1bHRzIHRvIGBUUlVFYAogICAgICAgICAqIAogICAgICAgICAqIGBkYXRhYDogT2JqZWN0IG9yIEpTT04gZGF0YSBwYXNzZWQgdGhyb3VnaCByZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogYHN1Y2Nlc3NgOiBGdW5jdGlvbiBjYWxsZWQgb24gc3VjY2Vzc2Z1bCByZXF1ZXN0CiAgICAgICAgICogCiAgICAgICAgICogYGVycm9yYDogRnVuY3Rpb24gY2FsbGVkIG9uIGZhaWx1cmUgb2YgcmVxdWVzdAogICAgICAgICAqIAogICAgICAgICAqIGBxc0RhdGFgOiBBbGxvd3MgYmxvY2tpbmcgKHNldCBgZmFsc2VgKSBvZiBgZGF0YWAgYWRkIHRvIFVSTCBmb3IgUkVTVGZ1bCByZXF1ZXN0cwogICAgICAgICAqLwogICAgICAgIGFqYXg6IGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgLy8gUGFyZW50IG9iamVjdCBmb3IgYWxsIHBhcmFtZXRlcnMKICAgICAgICAgICAgdmFyIHhociA9IHt9OwoKICAgICAgICAgICAgLy8gRGV0ZXJtaW5lIGNhbGwgc3RydWN0dXJlOiBhamF4KHVybCwgeyBwYXJhbXMgfSk7IG9yIGFqYXgoeyBwYXJhbXMgfSk7CiAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICAgICAgICAgICAgICAvLyBBbGwgcGFyYW1zIHBhc3NlZCBhcyBvYmplY3QKICAgICAgICAgICAgICAgIHhociA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIFBvcHVsYXRlIHhociBvYmogd2l0aCBzZWNvbmQgYXJndW1lbnQKICAgICAgICAgICAgICAgIHhociA9IGFyZ3VtZW50c1sxXTsKICAgICAgICAgICAgICAgIC8vIEFkZCBmaXJzdCBhcmd1bWVudCB0byB4aHIgb2JqZWN0IGFzIHVybAogICAgICAgICAgICAgICAgeGhyLnVybCA9IGFyZ3VtZW50c1swXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUGFyYW1ldGVycyAmIERlZmF1bHRzCiAgICAgICAgICAgIHhoci5yZXF1ZXN0ID0gZmFsc2U7CiAgICAgICAgICAgIHhoci50eXBlID0geGhyLnR5cGUgfHwgIkdFVCI7CiAgICAgICAgICAgIHhoci5kYXRhID0geGhyLmRhdGEgfHwgbnVsbDsKICAgICAgICAgICAgaWYgKHhoci5xc0RhdGEgfHwgIXhoci5oYXNPd25Qcm9wZXJ0eSgicXNEYXRhIikpIHsgeGhyLnFzRGF0YSA9IHRydWU7IH0gZWxzZSB7IHhoci5xc0RhdGEgPSBmYWxzZTsgfQogICAgICAgICAgICBpZiAoeGhyLmNhY2hlIHx8ICF4aHIuaGFzT3duUHJvcGVydHkoImNhY2hlIikpIHsgeGhyLmNhY2hlID0gdHJ1ZTsgfSBlbHNlIHsgeGhyLmNhY2hlID0gZmFsc2U7IH0KICAgICAgICAgICAgaWYgKHhoci5hc3luYyB8fCAheGhyLmhhc093blByb3BlcnR5KCJhc3luYyIpKSB7IHhoci5hc3luYyA9IHRydWU7IH0gZWxzZSB7IHhoci5hc3luYyA9IGZhbHNlOyB9CiAgICAgICAgICAgIGlmICh4aHIuc3VjY2VzcyAmJiB0eXBlb2YgeGhyLnN1Y2Nlc3MgPT09ICJmdW5jdGlvbiIpIHsgeGhyLnN1Y2Nlc3MgPSB4aHIuc3VjY2VzczsgfSBlbHNlIHsgeGhyLnN1Y2Nlc3MgPSBmYWxzZTsgfQogICAgICAgICAgICBpZiAoeGhyLmVycm9yICYmIHR5cGVvZiB4aHIuZXJyb3IgPT09ICJmdW5jdGlvbiIpIHsgeGhyLmVycm9yID0geGhyLmVycm9yOyB9IGVsc2UgeyB4aHIuZXJyb3IgPSBmYWxzZTsgfQoKICAgICAgICAgICAgLy8gRm9ybWF0IHhoci5kYXRhICYgZW5jb2RlIHZhbHVlcwogICAgICAgICAgICBpZiAoeGhyLmRhdGEpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJhbV9jb3VudCA9IDAsCiAgICAgICAgICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICB0bXBfZGF0YSA9IHhoci5kYXRhOwogICAgICAgICAgICAgICAgZm9yICh2YXIgcGFyYW0gaW4gdG1wX2RhdGEpIHsKICAgICAgICAgICAgICAgICAgICBpZih0bXBfZGF0YS5oYXNPd25Qcm9wZXJ0eShwYXJhbSkpewogICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gZW5jb2RlVVJJQ29tcG9uZW50KHBhcmFtKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBlbmNvZGVVUklDb21wb25lbnQodG1wX2RhdGFbcGFyYW1dKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBhcmFtX2NvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4aHIuZGF0YSA9IG5hbWUgKyAiPSIgKyB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5kYXRhICs9ICImIiArIG5hbWUgKyAiPSIgKyB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbV9jb3VudCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHhoci5kYXRhID0geGhyLmRhdGE7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIEFwcGVuZHMgZGF0YSB0byBVUkwKICAgICAgICAgICAgZnVuY3Rpb24gZm9ybWF0VVJMKGRhdGEpIHsKICAgICAgICAgICAgICAgIHZhciB1cmxfc3BsaXQgPSB4aHIudXJsLnNwbGl0KCI/Iik7CiAgICAgICAgICAgICAgICBpZiAodXJsX3NwbGl0Lmxlbmd0aCAhPT0gMSkgewogICAgICAgICAgICAgICAgICAgIHhoci51cmwgKz0gIiYiICsgZGF0YTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgeGhyLnVybCArPSAiPyIgKyBkYXRhOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBIYW5kbGUgeGhyLmRhdGEgb24gR0VUIHJlcXVlc3QgdHlwZQogICAgICAgICAgICBpZiAoeGhyLmRhdGEgJiYgeGhyLnR5cGUudG9VcHBlckNhc2UoKSA9PT0gIkdFVCIgJiYgeGhyLnFzRGF0YSkgewogICAgICAgICAgICAgICAgZm9ybWF0VVJMKHhoci5kYXRhKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gQ2hlY2sgY2FjaGUgcGFyYW1ldGVyLCBzZXQgVVJMIHBhcmFtCiAgICAgICAgICAgIGlmICgheGhyLmNhY2hlKSB7CiAgICAgICAgICAgICAgICBmb3JtYXRVUkwobmV3IERhdGUoKS5nZXRUaW1lKCkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBFc3RhYmxpc2ggcmVxdWVzdAogICAgICAgICAgICBpZiAod2luZG93LlhNTEh0dHBSZXF1ZXN0KSB7CiAgICAgICAgICAgICAgICAvLyBNb2Rlcm4gbm9uLUlFCiAgICAgICAgICAgICAgICB4aHIucmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSB7CiAgICAgICAgICAgICAgICAvLyBJbnRlcm5ldCBFeHBsb3JlcgogICAgICAgICAgICAgICAgeGhyLnJlcXVlc3QgPSBuZXcgQWN0aXZlWE9iamVjdCgiTWljcm9zb2Z0LlhNTEhUVFAiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIE5vIHJlcXVlc3Qgb2JqZWN0LCBicmVhawogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBNb25pdG9yIFJlYWR5U3RhdGUKICAgICAgICAgICAgeGhyLnJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKHhoci5yZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoeGhyLnJlcXVlc3Quc3RhdHVzID09PSAyMDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdWNjZXNzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm5zIHJlc3BvbnNlVGV4dCBhbmQgcmVxdWVzdCBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhoci5zdWNjZXNzKHhoci5yZXF1ZXN0LnJlc3BvbnNlVGV4dCwgeGhyLnJlcXVlc3QpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5lcnJvcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmV0dXJucyByZXF1ZXN0IG9iamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgeGhyLmVycm9yKHhoci5yZXF1ZXN0KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIC8vIE9wZW4gSHR0cCBSZXF1ZXN0IGNvbm5lY3Rpb24KICAgICAgICAgICAgeGhyLnJlcXVlc3Qub3Blbih4aHIudHlwZSwgeGhyLnVybCwgeGhyLmFzeW5jKTsKCiAgICAgICAgICAgIC8vIFNldCByZXF1ZXN0IGhlYWRlciBmb3IgUE9TVAogICAgICAgICAgICBpZiAoeGhyLnR5cGUudG9VcHBlckNhc2UoKSA9PT0gIlBPU1QiIHx8IHhoci50eXBlLnRvVXBwZXJDYXNlKCkgPT09ICJQVVQiKSB7CiAgICAgICAgICAgICAgICB4aHIucmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIC8vIFNlbmQgZGF0YQogICAgICAgICAgICB4aHIucmVxdWVzdC5zZW5kKHhoci5kYXRhKTsKCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBzdG9yZQogICAgICAgICAqIAogICAgICAgICAqIExvY2FsU3RvcmFnZSB3aXRoIHBvbHlmaWxsIHN1cHBvcnQgdmlhIGNvb2tpZXMKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgb3IgaWRlbnRpZmllciBmb3IgdGhlIHN0b3JlCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd8T2JqZWN0fSBbdmFsdWVdIENvbnRlbnRzIG9mIHRoZSBzdG9yZSwgYmxhbmsgdG8gcmV0dXJuLCAnbnVsbCcgdG8gY2xlYXIKICAgICAgICAgKiAKICAgICAgICAgKiBTcGVjaWZ5IGEgc3RyaW5nL29iamVjdCB2YWx1ZSB0byBgc2V0YCwgbm9uZSB0byBgZ2V0YCwgYW5kICdudWxsJyB0byBgY2xlYXJgCiAgICAgICAgICovCiAgICAgICAgc3RvcmU6IGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CgogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgbHNTdXBwb3J0ID0gZmFsc2U7CgogICAgICAgICAgICAvLyBDaGVjayBmb3IgbmF0aXZlIHN1cHBvcnQKICAgICAgICAgICAgaWYgKGxvY2FsU3RvcmFnZSkgewogICAgICAgICAgICAgICAgbHNTdXBwb3J0ID0gdHJ1ZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gSWYgdmFsdWUgaXMgZGV0ZWN0ZWQsIHNldCBuZXcgb3IgbW9kaWZ5IHN0b3JlCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgIT09ICJ1bmRlZmluZWQiICYmIHZhbHVlICE9PSBudWxsKSB7CiAgICAgICAgICAgICAgICAvLyBTdHJpbmdpZnkgb2JqZWN0cwogICAgICAgICAgICAgICAgaWYodHlwZW9mIHZhbHVlID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gQWRkIHRvIC8gbW9kaWZ5IHN0b3JhZ2UKICAgICAgICAgICAgICAgIGlmIChsc1N1cHBvcnQpIHsgLy8gTmF0aXZlIHN1cHBvcnQKICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7IC8vIFVzZSBDb29raWUKICAgICAgICAgICAgICAgICAgICBfdGhpcy5jcmVhdGVDb29raWUoa2V5LCB2YWx1ZSwgMzApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICAvLyBObyB2YWx1ZSBzdXBwbGllZCwgcmV0dXJuIHZhbHVlCiAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICBpZiAobHNTdXBwb3J0KSB7IC8vIE5hdGl2ZSBzdXBwb3J0CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgeyAvLyBVc2UgY29va2llCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnJlYWRDb29raWUoa2V5KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gTnVsbCBzcGVjaWZpZWQsIHJlbW92ZSBzdG9yZQogICAgICAgICAgICBpZiAodmFsdWUgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIGlmIChsc1N1cHBvcnQpIHsgLy8gTmF0aXZlIHN1cHBvcnQKICAgICAgICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsgLy8gVXNlIGNvb2tpZQogICAgICAgICAgICAgICAgICAgIF90aGlzLmNyZWF0ZUNvb2tpZShrZXksICIiLCAtMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBjcmVhdGVDb29raWUKICAgICAgICAgKiAKICAgICAgICAgKiBDcmVhdGVzIG5ldyBjb29raWUgb3IgcmVtb3ZlcyBjb29raWUgd2l0aCBuZWdhdGl2ZSBleHBpcmF0aW9uCiAgICAgICAgICogCiAgICAgICAgICogQHBhcmFtIHtTdHJpbmd9IGtleSBUaGUga2V5IG9yIGlkZW50aWZpZXIgZm9yIHRoZSBzdG9yZQogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YWx1ZSBDb250ZW50cyBvZiB0aGUgc3RvcmUKICAgICAgICAgKiBAcGFyYW0ge051bWJlcn0gZXhwIEV4cGlyYXRpb24gaW4gZGF5cwogICAgICAgICAqLwogICAgICAgIGNyZWF0ZUNvb2tpZTogZnVuY3Rpb24oa2V5LCB2YWx1ZSwgZXhwKSB7CiAgICAgICAgICAgIHZhciBkYXRlID0gbmV3IERhdGUoKSwKICAgICAgICAgICAgICAgIGV4cGlyZXM7CiAgICAgICAgICAgIGRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIChleHAgKiAyNCAqIDYwICogNjAgKiAxMDAwKSk7CiAgICAgICAgICAgIGV4cGlyZXMgPSAiOyBleHBpcmVzPSIgKyBkYXRlLnRvR01UU3RyaW5nKCk7CiAgICAgICAgICAgIGRvY3VtZW50LmNvb2tpZSA9IGtleSArICI9IiArIHZhbHVlICsgZXhwaXJlcyArICI7IHBhdGg9LyI7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmV0dXJucyBjb250ZW50cyBvZiBjb29raWUKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30ga2V5IFRoZSBrZXkgb3IgaWRlbnRpZmllciBmb3IgdGhlIHN0b3JlCiAgICAgICAgICogQHJldHVybiB7U3RyaW5nfSB0aGUgdmFsdWUgb2YgdGhlIGNvb2tpZQogICAgICAgICAqLwogICAgICAgIHJlYWRDb29raWU6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICB2YXIgbmFtZUVRID0ga2V5ICsgIj0iLAogICAgICAgICAgICAgICAgY2EgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKSwKICAgICAgICAgICAgICAgIGksCiAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICBjOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBjYS5sZW5ndGg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICAgICAgYyA9IGNhW2ldOwogICAgICAgICAgICAgICAgd2hpbGUgKGMuY2hhckF0KDApID09PSAiICIpIHsgYyA9IGMuc3Vic3RyaW5nKDEsIGMubGVuZ3RoKTsgfQogICAgICAgICAgICAgICAgaWYgKGMuaW5kZXhPZihuYW1lRVEpID09PSAwKSB7IHJldHVybiBjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLCBjLmxlbmd0aCk7IH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBQbGFjZWhvbGRlciBvYmplY3QgZm9yIHB1Yi9zdWIKICAgICAgICAgKi8KICAgICAgICB0b3BpY3M6IHt9LAoKICAgICAgICAvKioKICAgICAgICAgKiBJRCBmb3IgaW5jcmVtZW50aW5nCiAgICAgICAgICovCiAgICAgICAgdG9waWNfaWQ6IDAsCgogICAgICAgIC8qKgogICAgICAgICAqIEBtZXRob2QgcHVibGlzaAogICAgICAgICAqIAogICAgICAgICAqIFB1Ymxpc2ggdG8gYSB0b3BpYwogICAgICAgICAqIAogICAgICAgICAqIEBwYXJhbSB7U3RyaW5nfSB0b3BpYyBUb3BpYyBvZiB0aGUgc3Vic2NyaXB0aW9uCiAgICAgICAgICogQHBhcmFtIHtPYmplY3R9IGFyZ3MgQXJyYXkgb2YgYXJndW1lbnRzIHBhc3NlZAogICAgICAgICAqLwogICAgICAgIHB1Ymxpc2g6IGZ1bmN0aW9uICh0b3BpYywgYXJncykgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwogICAgICAgICAgICBpZiAoIV90aGlzLnRvcGljcy5oYXNPd25Qcm9wZXJ0eSh0b3BpYykpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBzdWJzY3JpYmVycyA9IF90aGlzLnRvcGljc1t0b3BpY10sCiAgICAgICAgICAgICAgICAgICAgbGVuOwoKICAgICAgICAgICAgICAgIGlmIChzdWJzY3JpYmVycy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgICAgICBsZW4gPSBzdWJzY3JpYmVycy5sZW5ndGg7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB3aGlsZSAobGVuLS0pIHsKICAgICAgICAgICAgICAgICAgICBzdWJzY3JpYmVyc1tsZW5dLmZuKGFyZ3MpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCAwKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCBzdWJzY3JpYmUKICAgICAgICAgKiAKICAgICAgICAgKiBTdWJzY3JpYmVzIHRvIGEgdG9waWMKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdG9waWMgVG9waWMgb2YgdGhlIHN1YnNjcmlwdGlvbgogICAgICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuIEZ1bmN0aW9uIHRvIGJlIGNhbGxlZAogICAgICAgICAqLwogICAgICAgIHN1YnNjcmliZTogZnVuY3Rpb24gKHRvcGljLCBmbikgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzLAogICAgICAgICAgICAgICAgaWQgPSArK3RoaXMudG9waWNfaWQsCiAgICAgICAgICAgICAgICBtYXgsCiAgICAgICAgICAgICAgICBpOwoKICAgICAgICAgICAgLy8gQ3JlYXRlIG5ldyB0b3BpYwogICAgICAgICAgICBpZiAoIV90aGlzLnRvcGljc1t0b3BpY10pIHsKICAgICAgICAgICAgICAgIF90aGlzLnRvcGljc1t0b3BpY10gPSBbXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gUHJldmVudCByZS1zdWJzY3JpYmUgaXNzdWVzIChjb21tb24gb24gcm91dGUtcmVsb2FkKQogICAgICAgICAgICBmb3IgKGkgPSAwLCBtYXggPSBfdGhpcy50b3BpY3NbdG9waWNdLmxlbmd0aDsgaSA8IG1heDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAoX3RoaXMudG9waWNzW3RvcGljXVtpXS5mbi50b1N0cmluZygpID09PSBmbi50b1N0cmluZygpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIF90aGlzLnRvcGljc1t0b3BpY11baV0uaWQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIF90aGlzLnRvcGljc1t0b3BpY10ucHVzaCh7CiAgICAgICAgICAgICAgICBpZDogaWQsCiAgICAgICAgICAgICAgICBmbjogZm4KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICByZXR1cm4gaWQ7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQG1ldGhvZCB1bnN1YnNjcmliZQogICAgICAgICAqIAogICAgICAgICAqIFVuc3Vic2NyaWJlcyBmcm9tIGEgdG9waWMKICAgICAgICAgKiAKICAgICAgICAgKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4gVG9rZW4gb2YgdGhlIHN1YnNjcmlwdGlvbgogICAgICAgICAqLwogICAgICAgIHVuc3Vic2NyaWJlOiBmdW5jdGlvbiAodG9rZW4pIHsKICAgICAgICAgICAgdmFyIF90aGlzID0gdGhpcywKICAgICAgICAgICAgICAgIHRvcGljLAogICAgICAgICAgICAgICAgaSwKICAgICAgICAgICAgICAgIG1heDsKICAgICAgICAgICAgZm9yICh0b3BpYyBpbiBfdGhpcy50b3BpY3MpIHsKICAgICAgICAgICAgICAgIGlmIChfdGhpcy50b3BpY3MuaGFzT3duUHJvcGVydHkodG9waWMpKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbWF4ID0gX3RoaXMudG9waWNzW3RvcGljXS5sZW5ndGg7IGkgPCBtYXg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoX3RoaXMudG9waWNzW3RvcGljXVtpXS5pZCA9PT0gdG9rZW4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF90aGlzLnRvcGljc1t0b3BpY10uc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRva2VuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBAbWV0aG9kIHBvbHlmaWxsX2JpbmQKICAgICAgICAgKiAKICAgICAgICAgKiBQb2x5ZmlsbCBmb3IgLmJpbmQoKQogICAgICAgICAqLwogICAgICAgIHBvbHlmaWxsX2JpbmQ6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgPSBmdW5jdGlvbiAob2JqKSB7CiAgICAgICAgICAgICAgICAvLyBjbG9zZXN0IHRoaW5nIHBvc3NpYmxlIHRvIHRoZSBFQ01BU2NyaXB0IDUgaW50ZXJuYWwgSXNDYWxsYWJsZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzICE9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgLSB3aGF0IGlzIHRyeWluZyB0byBiZSBib3VuZCBpcyBub3QgY2FsbGFibGUiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgc2xpY2UgPSBbXS5zbGljZSwKICAgICAgICAgICAgICAgICAgICBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpLAogICAgICAgICAgICAgICAgICAgIHNlbGYgPSB0aGlzLAogICAgICAgICAgICAgICAgICAgIG5vcCA9IGZ1bmN0aW9uICgpIHsgfSwKICAgICAgICAgICAgICAgICAgICBib3VuZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuYXBwbHkodGhpcyBpbnN0YW5jZW9mIG5vcCA/IHRoaXMgOiAob2JqIHx8IHt9KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICBib3VuZC5wcm90b3R5cGUgPSB0aGlzLnByb3RvdHlwZTsKCiAgICAgICAgICAgICAgICByZXR1cm4gYm91bmQ7CiAgICAgICAgICAgIH07CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogSGVscGVyIGZ1bmN0aW9uIHRoYXQgZXhlY3V0ZXMgYSBjYWxsYmFjayBmdW5jdGlvbiBvbiBlYWNoIG1vZHVsZS5lbAogICAgICAgICAqIEBtZXRob2QgZm9yZUVhY2hFbAogICAgICAgICAqIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrCiAgICAgICAgICovCiAgICAgICAgZm9yRWFjaEVsOiBmdW5jdGlvbiAoY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgdmFyIGluZGV4ID0gLTEsCiAgICAgICAgICAgICAgICAgICAgbWF4ID0gdGhpcy5lbC5sZW5ndGg7CiAgICAgICAgICAgICAgICB3aGlsZSAoKytpbmRleCA8IG1heCkgewogICAgICAgICAgICAgICAgICAgIGlmIChjYWxsYmFjayhpbmRleCwgdGhpcy5lbFtpbmRleF0sIHRoaXMuZWwpID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNhbGxiYWNrIG11c3QgYmUgYSBmdW5jdGlvbiIpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICB9OwoKCiAgICAvLyBSZXR1cm4gdGhlIGZyYW1ld29yawogICAgcmV0dXJuIENvbHQ7Cgp9KTsK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:56:27 GMT",
                    "Content-Length": "39834",
                    "Date": "Thu, 06 Nov 2014 15:56:30 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}