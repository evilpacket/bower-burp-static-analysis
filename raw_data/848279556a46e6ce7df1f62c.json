{
    "url": "http://localhost:9999/ngryman/page.js/test/index.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location</b> via the following statement:<ul><li>location = location.href.split('#')[0] + '#' + this.canonicalPath;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/ngryman/page.js/test/index.js",
                "path": "/ngryman/page.js/test/index.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9uZ3J5bWFuL3BhZ2UuanMvdGVzdC9pbmRleC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTE0NTUNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6MzU6NTAgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjM1OjUwIEdNVA0KDQohKGZ1bmN0aW9uKCkgewoKICAvKioKICAgKiBQZXJmb3JtIGluaXRpYWwgZGlzcGF0Y2guCiAgICovCgogIHZhciBkaXNwYXRjaCA9IHRydWU7CgogIC8qKgogICAqIEJhc2UgcGF0aC4KICAgKi8KCiAgdmFyIGJhc2UgPSAnJzsKCiAgLyoqCiAgICogUnVubmluZyBmbGFnLgogICAqLwoKICB2YXIgcnVubmluZzsKCiAgLyoqCiAgICogUG9wIHN0YXRlIHJlYWR5IGZsYWcuCiAgICovCgogIHZhciByZWFkeSA9IGZhbHNlOwoKICAvKioKICAgKiBJbml0aWFsIHVybC4KICAgKi8KCiAgdmFyIGluaXRpYWxVcmwgPSBsb2NhdGlvbi5ocmVmOwoKICAvKioKICAgKiBMb2NrIGZsYWcuCiAgICovCgogIHZhciBsb2NrID0gZmFsc2U7CgogIC8qKgogICAqIGhpc3RvcnkgYXBpIGZsYWcuCiAgICovCiAgdmFyIGhpc3RvcnlBcGkgPSAoaGlzdG9yeS5wdXNoU3RhdGUgJiYgJ2ZpbGU6JyAhPSBsb2NhdGlvbi5wcm90b2NvbCk7CgogIC8qKgogICAqIFJlZ2lzdGVyIGBwYXRoYCB3aXRoIGNhbGxiYWNrIGBmbigpYCwKICAgKiBvciByb3V0ZSBgcGF0aGAsIG9yIGBwYWdlLnN0YXJ0KClgLgogICAqCiAgICogICBwYWdlKGZuKTsKICAgKiAgIHBhZ2UoJyonLCBmbik7CiAgICogICBwYWdlKCcvdXNlci86aWQnLCBsb2FkLCB1c2VyKTsKICAgKiAgIHBhZ2UoJy91c2VyLycgKyB1c2VyLmlkLCB7IHNvbWU6ICd0aGluZycgfSk7CiAgICogICBwYWdlKCcvdXNlci8nICsgdXNlci5pZCk7CiAgICogICBwYWdlKCk7CiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ3xGdW5jdGlvbn0gcGF0aAogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuLi4uCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgZnVuY3Rpb24gcGFnZShwYXRoLCBmbikgewogICAgLy8gPGNhbGxiYWNrPgogICAgaWYgKCdmdW5jdGlvbicgPT0gdHlwZW9mIHBhdGgpIHsKICAgICAgcmV0dXJuIHBhZ2UoJyonLCBwYXRoKTsKICAgIH0KCiAgICAvLyByb3V0ZSA8cGF0aD4gdG8gPGNhbGxiYWNrIC4uLj4KICAgIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiBmbikgewogICAgICB2YXIgcm91dGUgPSBuZXcgUm91dGUocGF0aCk7CiAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgYXJndW1lbnRzLmxlbmd0aDsgKytpKSB7CiAgICAgICAgcGFnZS5jYWxsYmFja3MucHVzaChyb3V0ZS5taWRkbGV3YXJlKGFyZ3VtZW50c1tpXSkpOwogICAgICB9CiAgICAgIC8vIHNob3cgPHBhdGg+IHdpdGggW3N0YXRlXQogICAgfSBlbHNlIGlmICgnc3RyaW5nJyA9PSB0eXBlb2YgcGF0aCkgewogICAgICBwYWdlLnNob3cocGF0aCwgZm4pOwogICAgICAvLyBzdGFydCBbb3B0aW9uc10KICAgIH0gZWxzZSB7CiAgICAgIHBhZ2Uuc3RhcnQocGF0aCk7CiAgICB9CiAgfQoKICAvKioKICAgKiBDYWxsYmFjayBmdW5jdGlvbnMuCiAgICovCgogIHBhZ2UuY2FsbGJhY2tzID0gW107CgogIC8qKgogICAqIEdldCBvciBzZXQgYmFzZXBhdGggdG8gYHBhdGhgLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLmJhc2UgPSBmdW5jdGlvbihwYXRoKSB7CiAgICBpZiAoMCA9PSBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gYmFzZTsKICAgIGJhc2UgPSBwYXRoOwogIH07CgogIC8qKgogICAqIEJpbmQgd2l0aCB0aGUgZ2l2ZW4gYG9wdGlvbnNgLgogICAqCiAgICogT3B0aW9uczoKICAgKgogICAqICAgIC0gYGNsaWNrYCBiaW5kIHRvIGNsaWNrIGV2ZW50cyBbdHJ1ZV0KICAgKiAgICAtIGBwb3BzdGF0ZWAgYmluZCB0byBwb3BzdGF0ZSBbdHJ1ZV0KICAgKiAgICAtIGBkaXNwYXRjaGAgcGVyZm9ybSBpbml0aWFsIGRpc3BhdGNoIFt0cnVlXQogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnN0YXJ0ID0gZnVuY3Rpb24ob3B0aW9ucykgewogICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgICBpZiAocnVubmluZykgcmV0dXJuOwogICAgcnVubmluZyA9IHRydWU7CiAgICBpZiAoZmFsc2UgPT09IG9wdGlvbnMuZGlzcGF0Y2gpIGRpc3BhdGNoID0gZmFsc2U7CiAgICBpZiAoZmFsc2UgIT09IG9wdGlvbnMucG9wc3RhdGUpIHsKICAgICAgaWYgKGhpc3RvcnlBcGkpIHsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBvbnBvcHN0YXRlLCBmYWxzZSk7CiAgICAgIH0KICAgICAgZWxzZSB7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2hhc2hjaGFuZ2UnLCBvbmhhc2hjaGFuZ2UsIGZhbHNlKTsKICAgICAgfQogICAgfQogICAgaWYgKGZhbHNlICE9PSBvcHRpb25zLmNsaWNrKSB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbmNsaWNrLCBmYWxzZSk7CiAgICBpZiAoIWRpc3BhdGNoKSByZXR1cm47CiAgICBwYWdlLnJlcGxhY2UobG9jYXRpb24uaGFzaCA/IGxvY2F0aW9uLmhhc2gucmVwbGFjZSgnIycsICcnKSA6IGxvY2F0aW9uLnBhdGhuYW1lICsgbG9jYXRpb24uc2VhcmNoCiAgICAgICwgbnVsbAogICAgICAsIHRydWUKICAgICAgLCBkaXNwYXRjaCk7CiAgfTsKCiAgLyoqCiAgICogVW5iaW5kIGNsaWNrIGFuZCBwb3BzdGF0ZSBldmVudCBoYW5kbGVycy4KICAgKgogICAqIEBhcGkgcHVibGljCiAgICovCgogIHBhZ2Uuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgcnVubmluZyA9IGZhbHNlOwogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCBvbmNsaWNrLCBmYWxzZSk7CiAgICByZW1vdmVFdmVudExpc3RlbmVyKCdwb3BzdGF0ZScsIG9ucG9wc3RhdGUsIGZhbHNlKTsKICB9OwoKICAvKioKICAgKiBTaG93IGBwYXRoYCB3aXRoIG9wdGlvbmFsIGBzdGF0ZWAgb2JqZWN0LgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge09iamVjdH0gc3RhdGUKICAgKiBAcGFyYW0ge0Jvb2xlYW59IGRpc3BhdGNoCiAgICogQHJldHVybiB7Q29udGV4dH0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnNob3cgPSBmdW5jdGlvbihwYXRoLCBzdGF0ZSwgZGlzcGF0Y2gpIHsKICAgIHZhciBjdHggPSBuZXcgQ29udGV4dChwYXRoLCBzdGF0ZSk7CiAgICBpZiAoZmFsc2UgIT09IGRpc3BhdGNoKSBwYWdlLmRpc3BhdGNoKGN0eCk7CiAgICBpZiAoIWN0eC51bmhhbmRsZWQpIGN0eC5wdXNoU3RhdGUoKTsKICAgIHJldHVybiBjdHg7CiAgfTsKCiAgLyoqCiAgICogUmVwbGFjZSBgcGF0aGAgd2l0aCBvcHRpb25hbCBgc3RhdGVgIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICogQHJldHVybiB7Q29udGV4dH0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnJlcGxhY2UgPSBmdW5jdGlvbihwYXRoLCBzdGF0ZSwgaW5pdCwgZGlzcGF0Y2gpIHsKICAgIHZhciBjdHggPSBuZXcgQ29udGV4dChwYXRoLCBzdGF0ZSk7CiAgICBjdHguaW5pdCA9IGluaXQ7CiAgICBpZiAobnVsbCA9PSBkaXNwYXRjaCkgZGlzcGF0Y2ggPSB0cnVlOwogICAgaWYgKGRpc3BhdGNoKSBwYWdlLmRpc3BhdGNoKGN0eCk7CiAgICBjdHguc2F2ZSgpOwogICAgcmV0dXJuIGN0eDsKICB9OwoKICAvKioKICAgKiBEaXNwYXRjaCB0aGUgZ2l2ZW4gYGN0eGAuCiAgICoKICAgKiBAcGFyYW0ge09iamVjdH0gY3R4CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIHBhZ2UuZGlzcGF0Y2ggPSBmdW5jdGlvbihjdHgpIHsKICAgIHZhciBpID0gMDsKCiAgICBmdW5jdGlvbiBuZXh0KCkgewogICAgICB2YXIgZm4gPSBwYWdlLmNhbGxiYWNrc1tpKytdOwogICAgICBpZiAoIWZuKSByZXR1cm4gdW5oYW5kbGVkKGN0eCk7CiAgICAgIGZuKGN0eCwgbmV4dCk7CiAgICB9CgogICAgbmV4dCgpOwogIH07CgogIC8qKgogICAqIFVuaGFuZGxlZCBgY3R4YC4gV2hlbiBpdCdzIG5vdCB0aGUgaW5pdGlhbAogICAqIHBvcHN0YXRlIHRoZW4gcmVkaXJlY3QuIElmIHlvdSB3aXNoIHRvIGhhbmRsZQogICAqIDQwNHMgb24geW91ciBvd24gdXNlIGBwYWdlKCcqJywgY2FsbGJhY2spYC4KICAgKgogICAqIEBwYXJhbSB7Q29udGV4dH0gY3R4CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIHVuaGFuZGxlZChjdHgpIHsKICAgIGlmICh3aW5kb3cubG9jYXRpb24ucGF0aG5hbWUgKyB3aW5kb3cubG9jYXRpb24uc2VhcmNoID09IGN0eC5jYW5vbmljYWxQYXRoKSByZXR1cm47CiAgICBwYWdlLnN0b3AoKTsKICAgIGN0eC51bmhhbmRsZWQgPSB0cnVlOwogICAgd2luZG93LmxvY2F0aW9uID0gY3R4LmNhbm9uaWNhbFBhdGg7CiAgfQoKICAvKioKICAgKiBJbml0aWFsaXplIGEgbmV3ICJyZXF1ZXN0IiBgQ29udGV4dGAKICAgKiB3aXRoIHRoZSBnaXZlbiBgcGF0aGAgYW5kIG9wdGlvbmFsIGluaXRpYWwgYHN0YXRlYC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgZnVuY3Rpb24gQ29udGV4dChwYXRoLCBzdGF0ZSkgewogICAgaWYgKCcvJyA9PSBwYXRoWzBdICYmIDAgIT0gcGF0aC5pbmRleE9mKGJhc2UpKSBwYXRoID0gYmFzZSArIHBhdGg7CiAgICAvLyBmaXhlcyBhbmRyb2lkIDMuMCB3aGljaCBkb2VzIG5vdCBwcmVwZW5kIGEgc2xhc2gKICAgIHBhdGggPSAnLycgIT0gcGF0aFswXSA/ICcvJyArIHBhdGggOiBwYXRoOwogICAgLy8gaWYgZmlsZSBpcyB0aGUgcHJvdG9jb2wsIHJld3JpdGUgdXJsCiAgICBpZiAoJ2ZpbGU6JyA9PSBsb2NhdGlvbi5wcm90b2NvbCkgewogICAgICAvLyByb290CiAgICAgIGlmIChwYXRoID09IGxvY2F0aW9uLnBhdGhuYW1lKSB7CiAgICAgICAgcGF0aCA9ICcvJzsKICAgICAgfQogICAgICAvLyBvdGhlciBwYXRocyBoYXZlIHRoZSBkcml2ZSBwcmVwZW5kZWQsIGVuc3VyZSB3ZSBnZXQgb25seSB0aGUgbGFzdCBwYXJ0CiAgICAgIGVsc2UgewogICAgICAgIHBhdGggPSBwYXRoLnN1YnN0cihwYXRoLmxhc3RJbmRleE9mKCcvJykpOwogICAgICB9CiAgICB9CiAgICB2YXIgaSA9IHBhdGguaW5kZXhPZignPycpOwogICAgdGhpcy5jYW5vbmljYWxQYXRoID0gcGF0aDsKICAgIHRoaXMucGF0aCA9IHBhdGgucmVwbGFjZShiYXNlLCAnJykgfHwgJy8nOwogICAgdGhpcy50aXRsZSA9IGRvY3VtZW50LnRpdGxlOwogICAgdGhpcy5zdGF0ZSA9IHN0YXRlIHx8IHt9OwogICAgdGhpcy5zdGF0ZS5wYXRoID0gcGF0aDsKICAgIHRoaXMucXVlcnlzdHJpbmcgPSB+aSA/IHBhdGguc2xpY2UoaSArIDEpIDogJyc7CiAgICB0aGlzLnBhdGhuYW1lID0gfmkgPyBwYXRoLnNsaWNlKDAsIGkpIDogcGF0aDsKICAgIHRoaXMucGFyYW1zID0gW107CiAgfQoKICAvKioKICAgKiBFeHBvc2UgYENvbnRleHRgLgogICAqLwoKICBwYWdlLkNvbnRleHQgPSBDb250ZXh0OwoKICAvKioKICAgKiBQdXNoIHN0YXRlLgogICAqCiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIENvbnRleHQucHJvdG90eXBlLnB1c2hTdGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGhpc3RvcnlBcGkpIHsKICAgICAgaGlzdG9yeS5wdXNoU3RhdGUodGhpcy5zdGF0ZSwgdGhpcy50aXRsZSwgdGhpcy5jYW5vbmljYWxQYXRoKTsKICAgIH0KICAgIGVsc2UgewogICAgICBsb2NrID0gdHJ1ZTsKICAgICAgLy8gc3RvcmVzIHN0YXRlIGluIHNlc3Npb24gc3RvcmFnZSB3aXRoIHRoZSB1cmwgYXMga2V5CiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0odGhpcy5jYW5vbmljYWxQYXRoLCBKU09OLnN0cmluZ2lmeSh0aGlzLnN0YXRlKSk7CiAgICAgIC8vIHVzZXMgaGFzaCBhcyBhIGZhbGxiYWNrCiAgICAgIGxvY2F0aW9uID0gbG9jYXRpb24uaHJlZi5zcGxpdCgnIycpWzBdICsgJyMnICsgdGhpcy5jYW5vbmljYWxQYXRoOwogICAgfQogIH07CgogIC8qKgogICAqIFNhdmUgdGhlIGNvbnRleHQgc3RhdGUuCiAgICoKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBDb250ZXh0LnByb3RvdHlwZS5zYXZlID0gZnVuY3Rpb24oKSB7CiAgICBpZiAoaGlzdG9yeUFwaSkgewogICAgICBoaXN0b3J5LnJlcGxhY2VTdGF0ZSh0aGlzLnN0YXRlLCB0aGlzLnRpdGxlLCB0aGlzLmNhbm9uaWNhbFBhdGgpOwogICAgfQogICAgZWxzZSB7CiAgICAgIC8vIHN0b3JlcyBzdGF0ZSBpbiBzZXNzaW9uIHN0b3JhZ2Ugd2l0aCB0aGUgdXJsIGFzIGtleQogICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMuY2Fub25pY2FsUGF0aCwgSlNPTi5zdHJpbmdpZnkodGhpcy5zdGF0ZSkpOwogICAgICAvLyB1c2VzIGhhc2ggYXMgYSBmYWxsYmFjawogICAgICBsb2NhdGlvbi5yZXBsYWNlKGxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVswXSArICcjJyArIHRoaXMuY2Fub25pY2FsUGF0aCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogSW5pdGlhbGl6ZSBgUm91dGVgIHdpdGggdGhlIGdpdmVuIEhUVFAgYHBhdGhgLAogICAqIGFuZCBhbiBhcnJheSBvZiBgY2FsbGJhY2tzYCBhbmQgYG9wdGlvbnNgLgogICAqCiAgICogT3B0aW9uczoKICAgKgogICAqICAgLSBgc2Vuc2l0aXZlYCAgICBlbmFibGUgY2FzZS1zZW5zaXRpdmUgcm91dGVzCiAgICogICAtIGBzdHJpY3RgICAgICAgIGVuYWJsZSBzdHJpY3QgbWF0Y2hpbmcgZm9yIHRyYWlsaW5nIHNsYXNoZXMKICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMuCiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIFJvdXRlKHBhdGgsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdGhpcy5wYXRoID0gcGF0aDsKICAgIHRoaXMubWV0aG9kID0gJ0dFVCc7CiAgICB0aGlzLnJlZ2V4cCA9IHBhdGh0b1JlZ2V4cChwYXRoCiAgICAgICwgdGhpcy5rZXlzID0gW10KICAgICAgLCBvcHRpb25zLnNlbnNpdGl2ZQogICAgICAsIG9wdGlvbnMuc3RyaWN0KTsKICB9CgogIC8qKgogICAqIEV4cG9zZSBgUm91dGVgLgogICAqLwoKICBwYWdlLlJvdXRlID0gUm91dGU7CgogIC8qKgogICAqIFJldHVybiByb3V0ZSBtaWRkbGV3YXJlIHdpdGgKICAgKiB0aGUgZ2l2ZW4gY2FsbGJhY2sgYGZuKClgLgogICAqCiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZm4KICAgKiBAcmV0dXJuIHtGdW5jdGlvbn0KICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBSb3V0ZS5wcm90b3R5cGUubWlkZGxld2FyZSA9IGZ1bmN0aW9uKGZuKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CiAgICByZXR1cm4gZnVuY3Rpb24oY3R4LCBuZXh0KSB7CiAgICAgIGlmIChzZWxmLm1hdGNoKGN0eC5wYXRoLCBjdHgucGFyYW1zKSkgcmV0dXJuIGZuKGN0eCwgbmV4dCk7CiAgICAgIG5leHQoKTsKICAgIH0KICB9OwoKICAvKioKICAgKiBDaGVjayBpZiB0aGlzIHJvdXRlIG1hdGNoZXMgYHBhdGhgLCBpZiBzbwogICAqIHBvcHVsYXRlIGBwYXJhbXNgLgogICAqCiAgICogQHBhcmFtIHtTdHJpbmd9IHBhdGgKICAgKiBAcGFyYW0ge0FycmF5fSBwYXJhbXMKICAgKiBAcmV0dXJuIHtCb29sZWFufQogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBSb3V0ZS5wcm90b3R5cGUubWF0Y2ggPSBmdW5jdGlvbihwYXRoLCBwYXJhbXMpIHsKICAgIHZhciBrZXlzID0gdGhpcy5rZXlzCiAgICAgICwgcXNJbmRleCA9IHBhdGguaW5kZXhPZignPycpCiAgICAgICwgcGF0aG5hbWUgPSB+cXNJbmRleCA/IHBhdGguc2xpY2UoMCwgcXNJbmRleCkgOiBwYXRoCiAgICAgICwgbSA9IHRoaXMucmVnZXhwLmV4ZWMocGF0aG5hbWUpOwoKICAgIGlmICghbSkgcmV0dXJuIGZhbHNlOwoKICAgIGZvciAodmFyIGkgPSAxLCBsZW4gPSBtLmxlbmd0aDsgaSA8IGxlbjsgKytpKSB7CiAgICAgIHZhciBrZXkgPSBrZXlzW2kgLSAxXTsKCiAgICAgIHZhciB2YWwgPSAnc3RyaW5nJyA9PSB0eXBlb2YgbVtpXQogICAgICAgID8gZGVjb2RlVVJJQ29tcG9uZW50KG1baV0pCiAgICAgICAgOiBtW2ldOwoKICAgICAgaWYgKGtleSkgewogICAgICAgIHBhcmFtc1trZXkubmFtZV0gPSB1bmRlZmluZWQgIT09IHBhcmFtc1trZXkubmFtZV0KICAgICAgICAgID8gcGFyYW1zW2tleS5uYW1lXQogICAgICAgICAgOiB2YWw7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcGFyYW1zLnB1c2godmFsKTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH07CgogIC8qKgogICAqIE5vcm1hbGl6ZSB0aGUgZ2l2ZW4gcGF0aCBzdHJpbmcsCiAgICogcmV0dXJuaW5nIGEgcmVndWxhciBleHByZXNzaW9uLgogICAqCiAgICogQW4gZW1wdHkgYXJyYXkgc2hvdWxkIGJlIHBhc3NlZCwKICAgKiB3aGljaCB3aWxsIGNvbnRhaW4gdGhlIHBsYWNlaG9sZGVyCiAgICoga2V5IG5hbWVzLiBGb3IgZXhhbXBsZSAiL3VzZXIvOmlkIiB3aWxsCiAgICogdGhlbiBjb250YWluIFsiaWQiXS4KICAgKgogICAqIEBwYXJhbSAge1N0cmluZ3xSZWdFeHB8QXJyYXl9IHBhdGgKICAgKiBAcGFyYW0gIHtBcnJheX0ga2V5cwogICAqIEBwYXJhbSAge0Jvb2xlYW59IHNlbnNpdGl2ZQogICAqIEBwYXJhbSAge0Jvb2xlYW59IHN0cmljdAogICAqIEByZXR1cm4ge1JlZ0V4cH0KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgZnVuY3Rpb24gcGF0aHRvUmVnZXhwKHBhdGgsIGtleXMsIHNlbnNpdGl2ZSwgc3RyaWN0KSB7CiAgICBpZiAocGF0aCBpbnN0YW5jZW9mIFJlZ0V4cCkgcmV0dXJuIHBhdGg7CiAgICBpZiAocGF0aCBpbnN0YW5jZW9mIEFycmF5KSBwYXRoID0gJygnICsgcGF0aC5qb2luKCd8JykgKyAnKSc7CiAgICBwYXRoID0gcGF0aAogICAgICAuY29uY2F0KHN0cmljdCA/ICcnIDogJy8/JykKICAgICAgLnJlcGxhY2UoL1wvXCgvZywgJyg/Oi8nKQogICAgICAucmVwbGFjZSgvKFwvKT8oXC4pPzooXHcrKSg/OihcKC4qP1wpKSk/KFw/KT8vZywgZnVuY3Rpb24oXywgc2xhc2gsIGZvcm1hdCwga2V5LCBjYXB0dXJlLCBvcHRpb25hbCkgewogICAgICAgIGtleXMucHVzaCh7IG5hbWU6IGtleSwgb3B0aW9uYWw6ICEhb3B0aW9uYWwgfSk7CiAgICAgICAgc2xhc2ggPSBzbGFzaCB8fCAnJzsKICAgICAgICByZXR1cm4gJycKICAgICAgICAgICsgKG9wdGlvbmFsID8gJycgOiBzbGFzaCkKICAgICAgICAgICsgJyg/OicKICAgICAgICAgICsgKG9wdGlvbmFsID8gc2xhc2ggOiAnJykKICAgICAgICAgICsgKGZvcm1hdCB8fCAnJykgKyAoY2FwdHVyZSB8fCAoZm9ybWF0ICYmICcoW14vLl0rPyknIHx8ICcoW14vXSs/KScpKSArICcpJwogICAgICAgICAgKyAob3B0aW9uYWwgfHwgJycpOwogICAgICB9KQogICAgICAucmVwbGFjZSgvKFtcLy5dKS9nLCAnXFwkMScpCiAgICAgIC5yZXBsYWNlKC9cKi9nLCAnKC4qKScpOwogICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcGF0aCArICckJywgc2Vuc2l0aXZlID8gJycgOiAnaScpOwogIH07CgogIC8qKgogICAqIEhhbmRsZSAicG9wdWxhdGUiIGV2ZW50cy4KICAgKi8KCiAgZnVuY3Rpb24gb25wb3BzdGF0ZShlKSB7CiAgICAvLyBvbiBjaHJvbWUsIGFuIGluaXRpYWwgcG9wc3RhdGUgZXZlbnQgaXMgcmFpc2VkCiAgICBpZiAoIXJlYWR5ICYmIGxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbFVybCkgewogICAgICByZWFkeSA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBpZiAoZS5zdGF0ZSkgewogICAgICB2YXIgcGF0aCA9IGUuc3RhdGUucGF0aDsKICAgICAgcGFnZS5yZXBsYWNlKHBhdGgsIGUuc3RhdGUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gb25oYXNoY2hhbmdlKCkgewogICAgLy8gd2hlbiBpbml0aWFsIHVybCBpcyAvLCBpdCBnZXRzIHJlZGlyZWN0ZWQgdG8gLyMvCiAgICAvLyB0aGlzIGF2b2lkIGEgZG91YmxlIG1hdGNoIHRvIHRoZSAvIHBhZ2UKICAgIGlmICghcmVhZHkgJiYgbG9jYXRpb24uaHJlZiA9PSBpbml0aWFsVXJsICsgJyMvJykgewogICAgICByZWFkeSA9IHRydWU7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBlbnN1cmUgdGhhdCBwdXNoIHN0YXRlIGRvZXMgbm90IHRyaWdnZXIgdGhpcwogICAgLy8gdGhpcyBhdm9pZCBhIGRvdWJsZSBtYXRjaCB0byB0aGUgcGFnZQogICAgaWYgKGxvY2spIHsKICAgICAgbG9jayA9IGZhbHNlOwogICAgICByZXR1cm47CiAgICB9CgogICAgdmFyIHN0YXRlID0gSlNPTi5wYXJzZShzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKGxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVsxXSkpOwogICAgaWYgKHN0YXRlKSB7CiAgICAgIHZhciBwYXRoID0gc3RhdGUucGF0aDsKICAgICAgcGFnZS5yZXBsYWNlKHBhdGgsIHN0YXRlKTsKICAgIH0KICB9CgogIC8qKgogICAqIEhhbmRsZSAiY2xpY2siIGV2ZW50cy4KICAgKi8KCiAgZnVuY3Rpb24gb25jbGljayhlKSB7CiAgICBpZiAoMSAhPSB3aGljaChlKSkgcmV0dXJuOwogICAgaWYgKGUubWV0YUtleSB8fCBlLmN0cmxLZXkgfHwgZS5zaGlmdEtleSkgcmV0dXJuOwogICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZCkgcmV0dXJuOwoKICAgIC8vIGVuc3VyZSBsaW5rCiAgICB2YXIgZWwgPSBlLnRhcmdldDsKICAgIHdoaWxlIChlbCAmJiAnQScgIT0gZWwubm9kZU5hbWUpIGVsID0gZWwucGFyZW50Tm9kZTsKICAgIGlmICghZWwgfHwgJ0EnICE9IGVsLm5vZGVOYW1lKSByZXR1cm47CgogICAgLy8gZW5zdXJlIG5vbi1oYXNoCiAgICB2YXIgaHJlZiA9IGVsLmhyZWY7CiAgICB2YXIgcGF0aCA9IGVsLnBhdGhuYW1lICsgZWwuc2VhcmNoOwogICAgaWYgKGVsLmhhc2ggfHwgJyMnID09IGVsLmdldEF0dHJpYnV0ZSgnaHJlZicpKSByZXR1cm47CgogICAgLy8gY2hlY2sgdGFyZ2V0CiAgICBpZiAoZWwudGFyZ2V0KSByZXR1cm47CgogICAgLy8geC1vcmlnaW4KICAgIGlmICghc2FtZU9yaWdpbihocmVmKSkgcmV0dXJuOwoKICAgIC8vIHNhbWUgcGFnZQogICAgdmFyIG9yaWcgPSBwYXRoOwogICAgcGF0aCA9IHBhdGgucmVwbGFjZShiYXNlLCAnJyk7CiAgICBpZiAoYmFzZSAmJiBvcmlnID09IHBhdGgpIHJldHVybjsKCiAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICBwYWdlLnNob3cob3JpZyk7CiAgfQoKICAvKioKICAgKiBFdmVudCBidXR0b24uCiAgICovCgogIGZ1bmN0aW9uIHdoaWNoKGUpIHsKICAgIGUgPSBlIHx8IHdpbmRvdy5ldmVudDsKICAgIHJldHVybiBudWxsID09IGUud2hpY2gKICAgICAgPyBlLmJ1dHRvbgogICAgICA6IGUud2hpY2g7CiAgfQoKICAvKioKICAgKiBDaGVjayBpZiBgaHJlZmAgaXMgdGhlIHNhbWUgb3JpZ2luLgogICAqLwoKICBmdW5jdGlvbiBzYW1lT3JpZ2luKGhyZWYpIHsKICAgIHZhciBvcmlnaW4gPSBsb2NhdGlvbi5wcm90b2NvbCArICcvLycgKyBsb2NhdGlvbi5ob3N0bmFtZTsKICAgIGlmIChsb2NhdGlvbi5wb3J0KSBvcmlnaW4gKz0gJzonICsgbG9jYXRpb24ucG9ydDsKICAgIHJldHVybiAwID09IGhyZWYuaW5kZXhPZihvcmlnaW4pOwogIH0KCiAgLyoqCiAgICogRXhwb3NlIGBwYWdlYC4KICAgKi8KCiAgaWYgKCd1bmRlZmluZWQnID09IHR5cGVvZiBtb2R1bGUpIHsKICAgIHdpbmRvdy5wYWdlID0gcGFnZTsKICB9IGVsc2UgewogICAgbW9kdWxlLmV4cG9ydHMgPSBwYWdlOwogIH0KCn0pKCk7",
                "body": "IShmdW5jdGlvbigpIHsKCiAgLyoqCiAgICogUGVyZm9ybSBpbml0aWFsIGRpc3BhdGNoLgogICAqLwoKICB2YXIgZGlzcGF0Y2ggPSB0cnVlOwoKICAvKioKICAgKiBCYXNlIHBhdGguCiAgICovCgogIHZhciBiYXNlID0gJyc7CgogIC8qKgogICAqIFJ1bm5pbmcgZmxhZy4KICAgKi8KCiAgdmFyIHJ1bm5pbmc7CgogIC8qKgogICAqIFBvcCBzdGF0ZSByZWFkeSBmbGFnLgogICAqLwoKICB2YXIgcmVhZHkgPSBmYWxzZTsKCiAgLyoqCiAgICogSW5pdGlhbCB1cmwuCiAgICovCgogIHZhciBpbml0aWFsVXJsID0gbG9jYXRpb24uaHJlZjsKCiAgLyoqCiAgICogTG9jayBmbGFnLgogICAqLwoKICB2YXIgbG9jayA9IGZhbHNlOwoKICAvKioKICAgKiBoaXN0b3J5IGFwaSBmbGFnLgogICAqLwogIHZhciBoaXN0b3J5QXBpID0gKGhpc3RvcnkucHVzaFN0YXRlICYmICdmaWxlOicgIT0gbG9jYXRpb24ucHJvdG9jb2wpOwoKICAvKioKICAgKiBSZWdpc3RlciBgcGF0aGAgd2l0aCBjYWxsYmFjayBgZm4oKWAsCiAgICogb3Igcm91dGUgYHBhdGhgLCBvciBgcGFnZS5zdGFydCgpYC4KICAgKgogICAqICAgcGFnZShmbik7CiAgICogICBwYWdlKCcqJywgZm4pOwogICAqICAgcGFnZSgnL3VzZXIvOmlkJywgbG9hZCwgdXNlcik7CiAgICogICBwYWdlKCcvdXNlci8nICsgdXNlci5pZCwgeyBzb21lOiAndGhpbmcnIH0pOwogICAqICAgcGFnZSgnL3VzZXIvJyArIHVzZXIuaWQpOwogICAqICAgcGFnZSgpOwogICAqCiAgICogQHBhcmFtIHtTdHJpbmd8RnVuY3Rpb259IHBhdGgKICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBmbi4uLgogICAqIEBhcGkgcHVibGljCiAgICovCgogIGZ1bmN0aW9uIHBhZ2UocGF0aCwgZm4pIHsKICAgIC8vIDxjYWxsYmFjaz4KICAgIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiBwYXRoKSB7CiAgICAgIHJldHVybiBwYWdlKCcqJywgcGF0aCk7CiAgICB9CgogICAgLy8gcm91dGUgPHBhdGg+IHRvIDxjYWxsYmFjayAuLi4+CiAgICBpZiAoJ2Z1bmN0aW9uJyA9PSB0eXBlb2YgZm4pIHsKICAgICAgdmFyIHJvdXRlID0gbmV3IFJvdXRlKHBhdGgpOwogICAgICBmb3IgKHZhciBpID0gMTsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7ICsraSkgewogICAgICAgIHBhZ2UuY2FsbGJhY2tzLnB1c2gocm91dGUubWlkZGxld2FyZShhcmd1bWVudHNbaV0pKTsKICAgICAgfQogICAgICAvLyBzaG93IDxwYXRoPiB3aXRoIFtzdGF0ZV0KICAgIH0gZWxzZSBpZiAoJ3N0cmluZycgPT0gdHlwZW9mIHBhdGgpIHsKICAgICAgcGFnZS5zaG93KHBhdGgsIGZuKTsKICAgICAgLy8gc3RhcnQgW29wdGlvbnNdCiAgICB9IGVsc2UgewogICAgICBwYWdlLnN0YXJ0KHBhdGgpOwogICAgfQogIH0KCiAgLyoqCiAgICogQ2FsbGJhY2sgZnVuY3Rpb25zLgogICAqLwoKICBwYWdlLmNhbGxiYWNrcyA9IFtdOwoKICAvKioKICAgKiBHZXQgb3Igc2V0IGJhc2VwYXRoIHRvIGBwYXRoYC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgcGFnZS5iYXNlID0gZnVuY3Rpb24ocGF0aCkgewogICAgaWYgKDAgPT0gYXJndW1lbnRzLmxlbmd0aCkgcmV0dXJuIGJhc2U7CiAgICBiYXNlID0gcGF0aDsKICB9OwoKICAvKioKICAgKiBCaW5kIHdpdGggdGhlIGdpdmVuIGBvcHRpb25zYC4KICAgKgogICAqIE9wdGlvbnM6CiAgICoKICAgKiAgICAtIGBjbGlja2AgYmluZCB0byBjbGljayBldmVudHMgW3RydWVdCiAgICogICAgLSBgcG9wc3RhdGVgIGJpbmQgdG8gcG9wc3RhdGUgW3RydWVdCiAgICogICAgLSBgZGlzcGF0Y2hgIHBlcmZvcm0gaW5pdGlhbCBkaXNwYXRjaCBbdHJ1ZV0KICAgKgogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgcGFnZS5zdGFydCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgaWYgKHJ1bm5pbmcpIHJldHVybjsKICAgIHJ1bm5pbmcgPSB0cnVlOwogICAgaWYgKGZhbHNlID09PSBvcHRpb25zLmRpc3BhdGNoKSBkaXNwYXRjaCA9IGZhbHNlOwogICAgaWYgKGZhbHNlICE9PSBvcHRpb25zLnBvcHN0YXRlKSB7CiAgICAgIGlmIChoaXN0b3J5QXBpKSB7CiAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3BvcHN0YXRlJywgb25wb3BzdGF0ZSwgZmFsc2UpOwogICAgICB9CiAgICAgIGVsc2UgewogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdoYXNoY2hhbmdlJywgb25oYXNoY2hhbmdlLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KICAgIGlmIChmYWxzZSAhPT0gb3B0aW9ucy5jbGljaykgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25jbGljaywgZmFsc2UpOwogICAgaWYgKCFkaXNwYXRjaCkgcmV0dXJuOwogICAgcGFnZS5yZXBsYWNlKGxvY2F0aW9uLmhhc2ggPyBsb2NhdGlvbi5oYXNoLnJlcGxhY2UoJyMnLCAnJykgOiBsb2NhdGlvbi5wYXRobmFtZSArIGxvY2F0aW9uLnNlYXJjaAogICAgICAsIG51bGwKICAgICAgLCB0cnVlCiAgICAgICwgZGlzcGF0Y2gpOwogIH07CgogIC8qKgogICAqIFVuYmluZCBjbGljayBhbmQgcG9wc3RhdGUgZXZlbnQgaGFuZGxlcnMuCiAgICoKICAgKiBAYXBpIHB1YmxpYwogICAqLwoKICBwYWdlLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgIHJ1bm5pbmcgPSBmYWxzZTsKICAgIHJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgb25jbGljaywgZmFsc2UpOwogICAgcmVtb3ZlRXZlbnRMaXN0ZW5lcigncG9wc3RhdGUnLCBvbnBvcHN0YXRlLCBmYWxzZSk7CiAgfTsKCiAgLyoqCiAgICogU2hvdyBgcGF0aGAgd2l0aCBvcHRpb25hbCBgc3RhdGVgIG9iamVjdC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtPYmplY3R9IHN0YXRlCiAgICogQHBhcmFtIHtCb29sZWFufSBkaXNwYXRjaAogICAqIEByZXR1cm4ge0NvbnRleHR9CiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgcGFnZS5zaG93ID0gZnVuY3Rpb24ocGF0aCwgc3RhdGUsIGRpc3BhdGNoKSB7CiAgICB2YXIgY3R4ID0gbmV3IENvbnRleHQocGF0aCwgc3RhdGUpOwogICAgaWYgKGZhbHNlICE9PSBkaXNwYXRjaCkgcGFnZS5kaXNwYXRjaChjdHgpOwogICAgaWYgKCFjdHgudW5oYW5kbGVkKSBjdHgucHVzaFN0YXRlKCk7CiAgICByZXR1cm4gY3R4OwogIH07CgogIC8qKgogICAqIFJlcGxhY2UgYHBhdGhgIHdpdGggb3B0aW9uYWwgYHN0YXRlYCBvYmplY3QuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAqIEByZXR1cm4ge0NvbnRleHR9CiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgcGFnZS5yZXBsYWNlID0gZnVuY3Rpb24ocGF0aCwgc3RhdGUsIGluaXQsIGRpc3BhdGNoKSB7CiAgICB2YXIgY3R4ID0gbmV3IENvbnRleHQocGF0aCwgc3RhdGUpOwogICAgY3R4LmluaXQgPSBpbml0OwogICAgaWYgKG51bGwgPT0gZGlzcGF0Y2gpIGRpc3BhdGNoID0gdHJ1ZTsKICAgIGlmIChkaXNwYXRjaCkgcGFnZS5kaXNwYXRjaChjdHgpOwogICAgY3R4LnNhdmUoKTsKICAgIHJldHVybiBjdHg7CiAgfTsKCiAgLyoqCiAgICogRGlzcGF0Y2ggdGhlIGdpdmVuIGBjdHhgLgogICAqCiAgICogQHBhcmFtIHtPYmplY3R9IGN0eAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBwYWdlLmRpc3BhdGNoID0gZnVuY3Rpb24oY3R4KSB7CiAgICB2YXIgaSA9IDA7CgogICAgZnVuY3Rpb24gbmV4dCgpIHsKICAgICAgdmFyIGZuID0gcGFnZS5jYWxsYmFja3NbaSsrXTsKICAgICAgaWYgKCFmbikgcmV0dXJuIHVuaGFuZGxlZChjdHgpOwogICAgICBmbihjdHgsIG5leHQpOwogICAgfQoKICAgIG5leHQoKTsKICB9OwoKICAvKioKICAgKiBVbmhhbmRsZWQgYGN0eGAuIFdoZW4gaXQncyBub3QgdGhlIGluaXRpYWwKICAgKiBwb3BzdGF0ZSB0aGVuIHJlZGlyZWN0LiBJZiB5b3Ugd2lzaCB0byBoYW5kbGUKICAgKiA0MDRzIG9uIHlvdXIgb3duIHVzZSBgcGFnZSgnKicsIGNhbGxiYWNrKWAuCiAgICoKICAgKiBAcGFyYW0ge0NvbnRleHR9IGN0eAogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBmdW5jdGlvbiB1bmhhbmRsZWQoY3R4KSB7CiAgICBpZiAod2luZG93LmxvY2F0aW9uLnBhdGhuYW1lICsgd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9PSBjdHguY2Fub25pY2FsUGF0aCkgcmV0dXJuOwogICAgcGFnZS5zdG9wKCk7CiAgICBjdHgudW5oYW5kbGVkID0gdHJ1ZTsKICAgIHdpbmRvdy5sb2NhdGlvbiA9IGN0eC5jYW5vbmljYWxQYXRoOwogIH0KCiAgLyoqCiAgICogSW5pdGlhbGl6ZSBhIG5ldyAicmVxdWVzdCIgYENvbnRleHRgCiAgICogd2l0aCB0aGUgZ2l2ZW4gYHBhdGhgIGFuZCBvcHRpb25hbCBpbml0aWFsIGBzdGF0ZWAuCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBwYXJhbSB7T2JqZWN0fSBzdGF0ZQogICAqIEBhcGkgcHVibGljCiAgICovCgogIGZ1bmN0aW9uIENvbnRleHQocGF0aCwgc3RhdGUpIHsKICAgIGlmICgnLycgPT0gcGF0aFswXSAmJiAwICE9IHBhdGguaW5kZXhPZihiYXNlKSkgcGF0aCA9IGJhc2UgKyBwYXRoOwogICAgLy8gZml4ZXMgYW5kcm9pZCAzLjAgd2hpY2ggZG9lcyBub3QgcHJlcGVuZCBhIHNsYXNoCiAgICBwYXRoID0gJy8nICE9IHBhdGhbMF0gPyAnLycgKyBwYXRoIDogcGF0aDsKICAgIC8vIGlmIGZpbGUgaXMgdGhlIHByb3RvY29sLCByZXdyaXRlIHVybAogICAgaWYgKCdmaWxlOicgPT0gbG9jYXRpb24ucHJvdG9jb2wpIHsKICAgICAgLy8gcm9vdAogICAgICBpZiAocGF0aCA9PSBsb2NhdGlvbi5wYXRobmFtZSkgewogICAgICAgIHBhdGggPSAnLyc7CiAgICAgIH0KICAgICAgLy8gb3RoZXIgcGF0aHMgaGF2ZSB0aGUgZHJpdmUgcHJlcGVuZGVkLCBlbnN1cmUgd2UgZ2V0IG9ubHkgdGhlIGxhc3QgcGFydAogICAgICBlbHNlIHsKICAgICAgICBwYXRoID0gcGF0aC5zdWJzdHIocGF0aC5sYXN0SW5kZXhPZignLycpKTsKICAgICAgfQogICAgfQogICAgdmFyIGkgPSBwYXRoLmluZGV4T2YoJz8nKTsKICAgIHRoaXMuY2Fub25pY2FsUGF0aCA9IHBhdGg7CiAgICB0aGlzLnBhdGggPSBwYXRoLnJlcGxhY2UoYmFzZSwgJycpIHx8ICcvJzsKICAgIHRoaXMudGl0bGUgPSBkb2N1bWVudC50aXRsZTsKICAgIHRoaXMuc3RhdGUgPSBzdGF0ZSB8fCB7fTsKICAgIHRoaXMuc3RhdGUucGF0aCA9IHBhdGg7CiAgICB0aGlzLnF1ZXJ5c3RyaW5nID0gfmkgPyBwYXRoLnNsaWNlKGkgKyAxKSA6ICcnOwogICAgdGhpcy5wYXRobmFtZSA9IH5pID8gcGF0aC5zbGljZSgwLCBpKSA6IHBhdGg7CiAgICB0aGlzLnBhcmFtcyA9IFtdOwogIH0KCiAgLyoqCiAgICogRXhwb3NlIGBDb250ZXh0YC4KICAgKi8KCiAgcGFnZS5Db250ZXh0ID0gQ29udGV4dDsKCiAgLyoqCiAgICogUHVzaCBzdGF0ZS4KICAgKgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBDb250ZXh0LnByb3RvdHlwZS5wdXNoU3RhdGUgPSBmdW5jdGlvbigpIHsKICAgIGlmIChoaXN0b3J5QXBpKSB7CiAgICAgIGhpc3RvcnkucHVzaFN0YXRlKHRoaXMuc3RhdGUsIHRoaXMudGl0bGUsIHRoaXMuY2Fub25pY2FsUGF0aCk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgbG9jayA9IHRydWU7CiAgICAgIC8vIHN0b3JlcyBzdGF0ZSBpbiBzZXNzaW9uIHN0b3JhZ2Ugd2l0aCB0aGUgdXJsIGFzIGtleQogICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKHRoaXMuY2Fub25pY2FsUGF0aCwgSlNPTi5zdHJpbmdpZnkodGhpcy5zdGF0ZSkpOwogICAgICAvLyB1c2VzIGhhc2ggYXMgYSBmYWxsYmFjawogICAgICBsb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYuc3BsaXQoJyMnKVswXSArICcjJyArIHRoaXMuY2Fub25pY2FsUGF0aDsKICAgIH0KICB9OwoKICAvKioKICAgKiBTYXZlIHRoZSBjb250ZXh0IHN0YXRlLgogICAqCiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgQ29udGV4dC5wcm90b3R5cGUuc2F2ZSA9IGZ1bmN0aW9uKCkgewogICAgaWYgKGhpc3RvcnlBcGkpIHsKICAgICAgaGlzdG9yeS5yZXBsYWNlU3RhdGUodGhpcy5zdGF0ZSwgdGhpcy50aXRsZSwgdGhpcy5jYW5vbmljYWxQYXRoKTsKICAgIH0KICAgIGVsc2UgewogICAgICAvLyBzdG9yZXMgc3RhdGUgaW4gc2Vzc2lvbiBzdG9yYWdlIHdpdGggdGhlIHVybCBhcyBrZXkKICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSh0aGlzLmNhbm9uaWNhbFBhdGgsIEpTT04uc3RyaW5naWZ5KHRoaXMuc3RhdGUpKTsKICAgICAgLy8gdXNlcyBoYXNoIGFzIGEgZmFsbGJhY2sKICAgICAgbG9jYXRpb24ucmVwbGFjZShsb2NhdGlvbi5ocmVmLnNwbGl0KCcjJylbMF0gKyAnIycgKyB0aGlzLmNhbm9uaWNhbFBhdGgpOwogICAgfQogIH07CgogIC8qKgogICAqIEluaXRpYWxpemUgYFJvdXRlYCB3aXRoIHRoZSBnaXZlbiBIVFRQIGBwYXRoYCwKICAgKiBhbmQgYW4gYXJyYXkgb2YgYGNhbGxiYWNrc2AgYW5kIGBvcHRpb25zYC4KICAgKgogICAqIE9wdGlvbnM6CiAgICoKICAgKiAgIC0gYHNlbnNpdGl2ZWAgICAgZW5hYmxlIGNhc2Utc2Vuc2l0aXZlIHJvdXRlcwogICAqICAgLSBgc3RyaWN0YCAgICAgICBlbmFibGUgc3RyaWN0IG1hdGNoaW5nIGZvciB0cmFpbGluZyBzbGFzaGVzCiAgICoKICAgKiBAcGFyYW0ge1N0cmluZ30gcGF0aAogICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zLgogICAqIEBhcGkgcHJpdmF0ZQogICAqLwoKICBmdW5jdGlvbiBSb3V0ZShwYXRoLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgIHRoaXMucGF0aCA9IHBhdGg7CiAgICB0aGlzLm1ldGhvZCA9ICdHRVQnOwogICAgdGhpcy5yZWdleHAgPSBwYXRodG9SZWdleHAocGF0aAogICAgICAsIHRoaXMua2V5cyA9IFtdCiAgICAgICwgb3B0aW9ucy5zZW5zaXRpdmUKICAgICAgLCBvcHRpb25zLnN0cmljdCk7CiAgfQoKICAvKioKICAgKiBFeHBvc2UgYFJvdXRlYC4KICAgKi8KCiAgcGFnZS5Sb3V0ZSA9IFJvdXRlOwoKICAvKioKICAgKiBSZXR1cm4gcm91dGUgbWlkZGxld2FyZSB3aXRoCiAgICogdGhlIGdpdmVuIGNhbGxiYWNrIGBmbigpYC4KICAgKgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuCiAgICogQHJldHVybiB7RnVuY3Rpb259CiAgICogQGFwaSBwdWJsaWMKICAgKi8KCiAgUm91dGUucHJvdG90eXBlLm1pZGRsZXdhcmUgPSBmdW5jdGlvbihmbikgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgcmV0dXJuIGZ1bmN0aW9uKGN0eCwgbmV4dCkgewogICAgICBpZiAoc2VsZi5tYXRjaChjdHgucGF0aCwgY3R4LnBhcmFtcykpIHJldHVybiBmbihjdHgsIG5leHQpOwogICAgICBuZXh0KCk7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQ2hlY2sgaWYgdGhpcyByb3V0ZSBtYXRjaGVzIGBwYXRoYCwgaWYgc28KICAgKiBwb3B1bGF0ZSBgcGFyYW1zYC4KICAgKgogICAqIEBwYXJhbSB7U3RyaW5nfSBwYXRoCiAgICogQHBhcmFtIHtBcnJheX0gcGFyYW1zCiAgICogQHJldHVybiB7Qm9vbGVhbn0KICAgKiBAYXBpIHByaXZhdGUKICAgKi8KCiAgUm91dGUucHJvdG90eXBlLm1hdGNoID0gZnVuY3Rpb24ocGF0aCwgcGFyYW1zKSB7CiAgICB2YXIga2V5cyA9IHRoaXMua2V5cwogICAgICAsIHFzSW5kZXggPSBwYXRoLmluZGV4T2YoJz8nKQogICAgICAsIHBhdGhuYW1lID0gfnFzSW5kZXggPyBwYXRoLnNsaWNlKDAsIHFzSW5kZXgpIDogcGF0aAogICAgICAsIG0gPSB0aGlzLnJlZ2V4cC5leGVjKHBhdGhuYW1lKTsKCiAgICBpZiAoIW0pIHJldHVybiBmYWxzZTsKCiAgICBmb3IgKHZhciBpID0gMSwgbGVuID0gbS5sZW5ndGg7IGkgPCBsZW47ICsraSkgewogICAgICB2YXIga2V5ID0ga2V5c1tpIC0gMV07CgogICAgICB2YXIgdmFsID0gJ3N0cmluZycgPT0gdHlwZW9mIG1baV0KICAgICAgICA/IGRlY29kZVVSSUNvbXBvbmVudChtW2ldKQogICAgICAgIDogbVtpXTsKCiAgICAgIGlmIChrZXkpIHsKICAgICAgICBwYXJhbXNba2V5Lm5hbWVdID0gdW5kZWZpbmVkICE9PSBwYXJhbXNba2V5Lm5hbWVdCiAgICAgICAgICA/IHBhcmFtc1trZXkubmFtZV0KICAgICAgICAgIDogdmFsOwogICAgICB9IGVsc2UgewogICAgICAgIHBhcmFtcy5wdXNoKHZhbCk7CiAgICAgIH0KICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9OwoKICAvKioKICAgKiBOb3JtYWxpemUgdGhlIGdpdmVuIHBhdGggc3RyaW5nLAogICAqIHJldHVybmluZyBhIHJlZ3VsYXIgZXhwcmVzc2lvbi4KICAgKgogICAqIEFuIGVtcHR5IGFycmF5IHNob3VsZCBiZSBwYXNzZWQsCiAgICogd2hpY2ggd2lsbCBjb250YWluIHRoZSBwbGFjZWhvbGRlcgogICAqIGtleSBuYW1lcy4gRm9yIGV4YW1wbGUgIi91c2VyLzppZCIgd2lsbAogICAqIHRoZW4gY29udGFpbiBbImlkIl0uCiAgICoKICAgKiBAcGFyYW0gIHtTdHJpbmd8UmVnRXhwfEFycmF5fSBwYXRoCiAgICogQHBhcmFtICB7QXJyYXl9IGtleXMKICAgKiBAcGFyYW0gIHtCb29sZWFufSBzZW5zaXRpdmUKICAgKiBAcGFyYW0gIHtCb29sZWFufSBzdHJpY3QKICAgKiBAcmV0dXJuIHtSZWdFeHB9CiAgICogQGFwaSBwcml2YXRlCiAgICovCgogIGZ1bmN0aW9uIHBhdGh0b1JlZ2V4cChwYXRoLCBrZXlzLCBzZW5zaXRpdmUsIHN0cmljdCkgewogICAgaWYgKHBhdGggaW5zdGFuY2VvZiBSZWdFeHApIHJldHVybiBwYXRoOwogICAgaWYgKHBhdGggaW5zdGFuY2VvZiBBcnJheSkgcGF0aCA9ICcoJyArIHBhdGguam9pbignfCcpICsgJyknOwogICAgcGF0aCA9IHBhdGgKICAgICAgLmNvbmNhdChzdHJpY3QgPyAnJyA6ICcvPycpCiAgICAgIC5yZXBsYWNlKC9cL1woL2csICcoPzovJykKICAgICAgLnJlcGxhY2UoLyhcLyk/KFwuKT86KFx3KykoPzooXCguKj9cKSkpPyhcPyk/L2csIGZ1bmN0aW9uKF8sIHNsYXNoLCBmb3JtYXQsIGtleSwgY2FwdHVyZSwgb3B0aW9uYWwpIHsKICAgICAgICBrZXlzLnB1c2goeyBuYW1lOiBrZXksIG9wdGlvbmFsOiAhIW9wdGlvbmFsIH0pOwogICAgICAgIHNsYXNoID0gc2xhc2ggfHwgJyc7CiAgICAgICAgcmV0dXJuICcnCiAgICAgICAgICArIChvcHRpb25hbCA/ICcnIDogc2xhc2gpCiAgICAgICAgICArICcoPzonCiAgICAgICAgICArIChvcHRpb25hbCA/IHNsYXNoIDogJycpCiAgICAgICAgICArIChmb3JtYXQgfHwgJycpICsgKGNhcHR1cmUgfHwgKGZvcm1hdCAmJiAnKFteLy5dKz8pJyB8fCAnKFteL10rPyknKSkgKyAnKScKICAgICAgICAgICsgKG9wdGlvbmFsIHx8ICcnKTsKICAgICAgfSkKICAgICAgLnJlcGxhY2UoLyhbXC8uXSkvZywgJ1xcJDEnKQogICAgICAucmVwbGFjZSgvXCovZywgJyguKiknKTsKICAgIHJldHVybiBuZXcgUmVnRXhwKCdeJyArIHBhdGggKyAnJCcsIHNlbnNpdGl2ZSA/ICcnIDogJ2knKTsKICB9OwoKICAvKioKICAgKiBIYW5kbGUgInBvcHVsYXRlIiBldmVudHMuCiAgICovCgogIGZ1bmN0aW9uIG9ucG9wc3RhdGUoZSkgewogICAgLy8gb24gY2hyb21lLCBhbiBpbml0aWFsIHBvcHN0YXRlIGV2ZW50IGlzIHJhaXNlZAogICAgaWYgKCFyZWFkeSAmJiBsb2NhdGlvbi5ocmVmID09IGluaXRpYWxVcmwpIHsKICAgICAgcmVhZHkgPSB0cnVlOwogICAgICByZXR1cm47CiAgICB9CgogICAgaWYgKGUuc3RhdGUpIHsKICAgICAgdmFyIHBhdGggPSBlLnN0YXRlLnBhdGg7CiAgICAgIHBhZ2UucmVwbGFjZShwYXRoLCBlLnN0YXRlKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIG9uaGFzaGNoYW5nZSgpIHsKICAgIC8vIHdoZW4gaW5pdGlhbCB1cmwgaXMgLywgaXQgZ2V0cyByZWRpcmVjdGVkIHRvIC8jLwogICAgLy8gdGhpcyBhdm9pZCBhIGRvdWJsZSBtYXRjaCB0byB0aGUgLyBwYWdlCiAgICBpZiAoIXJlYWR5ICYmIGxvY2F0aW9uLmhyZWYgPT0gaW5pdGlhbFVybCArICcjLycpIHsKICAgICAgcmVhZHkgPSB0cnVlOwogICAgICByZXR1cm47CiAgICB9CgogICAgLy8gZW5zdXJlIHRoYXQgcHVzaCBzdGF0ZSBkb2VzIG5vdCB0cmlnZ2VyIHRoaXMKICAgIC8vIHRoaXMgYXZvaWQgYSBkb3VibGUgbWF0Y2ggdG8gdGhlIHBhZ2UKICAgIGlmIChsb2NrKSB7CiAgICAgIGxvY2sgPSBmYWxzZTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIHZhciBzdGF0ZSA9IEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShsb2NhdGlvbi5ocmVmLnNwbGl0KCcjJylbMV0pKTsKICAgIGlmIChzdGF0ZSkgewogICAgICB2YXIgcGF0aCA9IHN0YXRlLnBhdGg7CiAgICAgIHBhZ2UucmVwbGFjZShwYXRoLCBzdGF0ZSk7CiAgICB9CiAgfQoKICAvKioKICAgKiBIYW5kbGUgImNsaWNrIiBldmVudHMuCiAgICovCgogIGZ1bmN0aW9uIG9uY2xpY2soZSkgewogICAgaWYgKDEgIT0gd2hpY2goZSkpIHJldHVybjsKICAgIGlmIChlLm1ldGFLZXkgfHwgZS5jdHJsS2V5IHx8IGUuc2hpZnRLZXkpIHJldHVybjsKICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpIHJldHVybjsKCiAgICAvLyBlbnN1cmUgbGluawogICAgdmFyIGVsID0gZS50YXJnZXQ7CiAgICB3aGlsZSAoZWwgJiYgJ0EnICE9IGVsLm5vZGVOYW1lKSBlbCA9IGVsLnBhcmVudE5vZGU7CiAgICBpZiAoIWVsIHx8ICdBJyAhPSBlbC5ub2RlTmFtZSkgcmV0dXJuOwoKICAgIC8vIGVuc3VyZSBub24taGFzaAogICAgdmFyIGhyZWYgPSBlbC5ocmVmOwogICAgdmFyIHBhdGggPSBlbC5wYXRobmFtZSArIGVsLnNlYXJjaDsKICAgIGlmIChlbC5oYXNoIHx8ICcjJyA9PSBlbC5nZXRBdHRyaWJ1dGUoJ2hyZWYnKSkgcmV0dXJuOwoKICAgIC8vIGNoZWNrIHRhcmdldAogICAgaWYgKGVsLnRhcmdldCkgcmV0dXJuOwoKICAgIC8vIHgtb3JpZ2luCiAgICBpZiAoIXNhbWVPcmlnaW4oaHJlZikpIHJldHVybjsKCiAgICAvLyBzYW1lIHBhZ2UKICAgIHZhciBvcmlnID0gcGF0aDsKICAgIHBhdGggPSBwYXRoLnJlcGxhY2UoYmFzZSwgJycpOwogICAgaWYgKGJhc2UgJiYgb3JpZyA9PSBwYXRoKSByZXR1cm47CgogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgcGFnZS5zaG93KG9yaWcpOwogIH0KCiAgLyoqCiAgICogRXZlbnQgYnV0dG9uLgogICAqLwoKICBmdW5jdGlvbiB3aGljaChlKSB7CiAgICBlID0gZSB8fCB3aW5kb3cuZXZlbnQ7CiAgICByZXR1cm4gbnVsbCA9PSBlLndoaWNoCiAgICAgID8gZS5idXR0b24KICAgICAgOiBlLndoaWNoOwogIH0KCiAgLyoqCiAgICogQ2hlY2sgaWYgYGhyZWZgIGlzIHRoZSBzYW1lIG9yaWdpbi4KICAgKi8KCiAgZnVuY3Rpb24gc2FtZU9yaWdpbihocmVmKSB7CiAgICB2YXIgb3JpZ2luID0gbG9jYXRpb24ucHJvdG9jb2wgKyAnLy8nICsgbG9jYXRpb24uaG9zdG5hbWU7CiAgICBpZiAobG9jYXRpb24ucG9ydCkgb3JpZ2luICs9ICc6JyArIGxvY2F0aW9uLnBvcnQ7CiAgICByZXR1cm4gMCA9PSBocmVmLmluZGV4T2Yob3JpZ2luKTsKICB9CgogIC8qKgogICAqIEV4cG9zZSBgcGFnZWAuCiAgICovCgogIGlmICgndW5kZWZpbmVkJyA9PSB0eXBlb2YgbW9kdWxlKSB7CiAgICB3aW5kb3cucGFnZSA9IHBhZ2U7CiAgfSBlbHNlIHsKICAgIG1vZHVsZS5leHBvcnRzID0gcGFnZTsKICB9Cgp9KSgpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:35:50 GMT",
                    "Content-Length": "11455",
                    "Date": "Fri, 07 Nov 2014 21:35:50 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}