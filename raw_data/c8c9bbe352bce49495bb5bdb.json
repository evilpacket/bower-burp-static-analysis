{
    "url": "http://localhost:9999/x-tag/template/demo/x-tag-components.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>the 'baseURI' property of a DOM element</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statement:<ul><li>base.setAttribute('href', document.baseURI);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/x-tag/template/demo/x-tag-components.js",
                "path": "/x-tag/template/demo/x-tag-components.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC94LXRhZy90ZW1wbGF0ZS9kZW1vL3gtdGFnLWNvbXBvbmVudHMuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODQzNTANCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDM6NDc6MDUgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAzOjQ3OjA1IEdNVA0KDQovLyBXZSBkb24ndCB1c2UgdGhlIHBsYXRmb3JtIGJvb3RzdHJhcHBlciwgc28gZmFrZSB0aGlzIHN0dWZmLgoKd2luZG93LlBsYXRmb3JtID0ge307CnZhciBsb2dGbGFncyA9IHt9OwoKCgovLyBET01Ub2tlbkxpc3QgcG9seWZpbGwgZmlyIElFOQooZnVuY3Rpb24gKCkgewoKaWYgKHR5cGVvZiB3aW5kb3cuRWxlbWVudCA9PT0gInVuZGVmaW5lZCIgfHwgImNsYXNzTGlzdCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KSByZXR1cm47Cgp2YXIgcHJvdG90eXBlID0gQXJyYXkucHJvdG90eXBlLAogICAgaW5kZXhPZiA9IHByb3RvdHlwZS5pbmRleE9mLAogICAgc2xpY2UgPSBwcm90b3R5cGUuc2xpY2UsCiAgICBwdXNoID0gcHJvdG90eXBlLnB1c2gsCiAgICBzcGxpY2UgPSBwcm90b3R5cGUuc3BsaWNlLAogICAgam9pbiA9IHByb3RvdHlwZS5qb2luOwoKZnVuY3Rpb24gRE9NVG9rZW5MaXN0KGVsKSB7CiAgdGhpcy5fZWxlbWVudCA9IGVsOwogIGlmIChlbC5jbGFzc05hbWUgIT0gdGhpcy5fY2xhc3NDYWNoZSkgewogICAgdGhpcy5fY2xhc3NDYWNoZSA9IGVsLmNsYXNzTmFtZTsKCiAgICBpZiAoIXRoaXMuX2NsYXNzQ2FjaGUpIHJldHVybjsKCiAgICAgIC8vIFRoZSBjbGFzc05hbWUgbmVlZHMgdG8gYmUgdHJpbW1lZCBhbmQgc3BsaXQgb24gd2hpdGVzcGFjZQogICAgICAvLyB0byByZXRyaWV2ZSBhIGxpc3Qgb2YgY2xhc3Nlcy4KICAgICAgdmFyIGNsYXNzZXMgPSB0aGlzLl9jbGFzc0NhY2hlLnJlcGxhY2UoL15ccyt8XHMrJC9nLCcnKS5zcGxpdCgvXHMrLyksCiAgICAgICAgaTsKICAgIGZvciAoaSA9IDA7IGkgPCBjbGFzc2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHB1c2guY2FsbCh0aGlzLCBjbGFzc2VzW2ldKTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBzZXRUb0NsYXNzTmFtZShlbCwgY2xhc3NlcykgewogIGVsLmNsYXNzTmFtZSA9IGNsYXNzZXMuam9pbignICcpOwp9CgpET01Ub2tlbkxpc3QucHJvdG90eXBlID0gewogIGFkZDogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmKHRoaXMuY29udGFpbnModG9rZW4pKSByZXR1cm47CiAgICBwdXNoLmNhbGwodGhpcywgdG9rZW4pOwogICAgc2V0VG9DbGFzc05hbWUodGhpcy5fZWxlbWVudCwgc2xpY2UuY2FsbCh0aGlzLCAwKSk7CiAgfSwKICBjb250YWluczogZnVuY3Rpb24odG9rZW4pIHsKICAgIHJldHVybiBpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pICE9PSAtMTsKICB9LAogIGl0ZW06IGZ1bmN0aW9uKGluZGV4KSB7CiAgICByZXR1cm4gdGhpc1tpbmRleF0gfHwgbnVsbDsKICB9LAogIHJlbW92ZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIHZhciBpID0gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKTsKICAgICBpZiAoaSA9PT0gLTEpIHsKICAgICAgIHJldHVybjsKICAgICB9CiAgICBzcGxpY2UuY2FsbCh0aGlzLCBpLCAxKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgdG9TdHJpbmc6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGpvaW4uY2FsbCh0aGlzLCAnICcpOwogIH0sCiAgdG9nZ2xlOiBmdW5jdGlvbih0b2tlbikgewogICAgaWYgKGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbikgPT09IC0xKSB7CiAgICAgIHRoaXMuYWRkKHRva2VuKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucmVtb3ZlKHRva2VuKTsKICAgIH0KICB9Cn07Cgp3aW5kb3cuRE9NVG9rZW5MaXN0ID0gRE9NVG9rZW5MaXN0OwoKZnVuY3Rpb24gZGVmaW5lRWxlbWVudEdldHRlciAob2JqLCBwcm9wLCBnZXR0ZXIpIHsKICBpZiAoT2JqZWN0LmRlZmluZVByb3BlcnR5KSB7CiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBwcm9wLHsKICAgICAgZ2V0IDogZ2V0dGVyCiAgICB9KQogIH0gZWxzZSB7CiAgICBvYmouX19kZWZpbmVHZXR0ZXJfXyhwcm9wLCBnZXR0ZXIpOwogIH0KfQoKZGVmaW5lRWxlbWVudEdldHRlcihFbGVtZW50LnByb3RvdHlwZSwgJ2NsYXNzTGlzdCcsIGZ1bmN0aW9uICgpIHsKICByZXR1cm4gbmV3IERPTVRva2VuTGlzdCh0aGlzKTsKfSk7Cgp9KSgpOwoKCi8qCiAqIENvcHlyaWdodCAyMDEyIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVyZW5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKLy8gU2lkZVRhYmxlIGlzIGEgd2VhayBtYXAgd2hlcmUgcG9zc2libGUuIElmIFdlYWtNYXAgaXMgbm90IGF2YWlsYWJsZSB0aGUKLy8gYXNzb2NpYXRpb24gaXMgc3RvcmVkIGFzIGFuIGV4cGFuZG8gcHJvcGVydHkuCnZhciBTaWRlVGFibGU7Ci8vIFRPRE8oYXJ2KTogV2Vha01hcCBkb2VzIG5vdCBhbGxvdyBmb3IgTm9kZSBldGMgdG8gYmUga2V5cyBpbiBGaXJlZm94CmlmICh0eXBlb2YgV2Vha01hcCAhPT0gJ3VuZGVmaW5lZCcgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCdGaXJlZm94LycpIDwgMCkgewogIFNpZGVUYWJsZSA9IFdlYWtNYXA7Cn0gZWxzZSB7CiAgKGZ1bmN0aW9uKCkgewogICAgdmFyIGRlZmluZVByb3BlcnR5ID0gT2JqZWN0LmRlZmluZVByb3BlcnR5OwogICAgdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0Lmhhc093blByb3BlcnR5OwogICAgdmFyIGNvdW50ZXIgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKSAlIDFlOTsKCiAgICBTaWRlVGFibGUgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5uYW1lID0gJ19fc3QnICsgKE1hdGgucmFuZG9tKCkgKiAxZTkgPj4+IDApICsgKGNvdW50ZXIrKyArICdfXycpOwogICAgfTsKCiAgICBTaWRlVGFibGUucHJvdG90eXBlID0gewogICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICBkZWZpbmVQcm9wZXJ0eShrZXksIHRoaXMubmFtZSwge3ZhbHVlOiB2YWx1ZSwgd3JpdGFibGU6IHRydWV9KTsKICAgICAgfSwKICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICByZXR1cm4gaGFzT3duUHJvcGVydHkuY2FsbChrZXksIHRoaXMubmFtZSkgPyBrZXlbdGhpcy5uYW1lXSA6IHVuZGVmaW5lZDsKICAgICAgfSwKICAgICAgZGVsZXRlOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICB0aGlzLnNldChrZXksIHVuZGVmaW5lZCk7CiAgICAgIH0KICAgIH0KICB9KSgpOwp9CgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihnbG9iYWwpIHsKCiAgdmFyIHJlZ2lzdHJhdGlvbnNUYWJsZSA9IG5ldyBTaWRlVGFibGUoKTsKCiAgLy8gV2UgdXNlIHNldEltbWVkaWF0ZSBvciBwb3N0TWVzc2FnZSBmb3Igb3VyIGZ1dHVyZSBjYWxsYmFjay4KICB2YXIgc2V0SW1tZWRpYXRlID0gd2luZG93Lm1zU2V0SW1tZWRpYXRlOwoKICAvLyBVc2UgcG9zdCBtZXNzYWdlIHRvIGVtdWxhdGUgc2V0SW1tZWRpYXRlLgogIGlmICghc2V0SW1tZWRpYXRlKSB7CiAgICB2YXIgc2V0SW1tZWRpYXRlUXVldWUgPSBbXTsKICAgIHZhciBzZW50aW5lbCA9IFN0cmluZyhNYXRoLnJhbmRvbSgpKTsKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24oZSkgewogICAgICBpZiAoZS5kYXRhID09PSBzZW50aW5lbCkgewogICAgICAgIHZhciBxdWV1ZSA9IHNldEltbWVkaWF0ZVF1ZXVlOwogICAgICAgIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICAgICAgcXVldWUuZm9yRWFjaChmdW5jdGlvbihmdW5jKSB7CiAgICAgICAgICBmdW5jKCk7CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0pOwogICAgc2V0SW1tZWRpYXRlID0gZnVuY3Rpb24oZnVuYykgewogICAgICBzZXRJbW1lZGlhdGVRdWV1ZS5wdXNoKGZ1bmMpOwogICAgICB3aW5kb3cucG9zdE1lc3NhZ2Uoc2VudGluZWwsICcqJyk7CiAgICB9OwogIH0KCiAgLy8gVGhpcyBpcyB1c2VkIHRvIGVuc3VyZSB0aGF0IHdlIG5ldmVyIHNjaGVkdWxlIDIgY2FsbGFzIHRvIHNldEltbWVkaWF0ZQogIHZhciBpc1NjaGVkdWxlZCA9IGZhbHNlOwoKICAvLyBLZWVwIHRyYWNrIG9mIG9ic2VydmVycyB0aGF0IG5lZWRzIHRvIGJlIG5vdGlmaWVkIG5leHQgdGltZS4KICB2YXIgc2NoZWR1bGVkT2JzZXJ2ZXJzID0gW107CgogIC8qKgogICAqIFNjaGVkdWxlcyB8ZGlzcGF0Y2hDYWxsYmFja3wgdG8gYmUgY2FsbGVkIGluIHRoZSBmdXR1cmUuCiAgICogQHBhcmFtIHtNdXRhdGlvbk9ic2VydmVyfSBvYnNlcnZlcgogICAqLwogIGZ1bmN0aW9uIHNjaGVkdWxlQ2FsbGJhY2sob2JzZXJ2ZXIpIHsKICAgIHNjaGVkdWxlZE9ic2VydmVycy5wdXNoKG9ic2VydmVyKTsKICAgIGlmICghaXNTY2hlZHVsZWQpIHsKICAgICAgaXNTY2hlZHVsZWQgPSB0cnVlOwogICAgICBzZXRJbW1lZGlhdGUoZGlzcGF0Y2hDYWxsYmFja3MpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gd3JhcElmTmVlZGVkKG5vZGUpIHsKICAgIHJldHVybiB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwgJiYKICAgICAgICB3aW5kb3cuU2hhZG93RE9NUG9seWZpbGwud3JhcElmTmVlZGVkKG5vZGUpIHx8CiAgICAgICAgbm9kZTsKICB9CgogIGZ1bmN0aW9uIGRpc3BhdGNoQ2FsbGJhY2tzKCkgewogICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI211dGF0aW9uLW9ic2VydmVycwoKICAgIGlzU2NoZWR1bGVkID0gZmFsc2U7IC8vIFVzZWQgdG8gYWxsb3cgYSBuZXcgc2V0SW1tZWRpYXRlIGNhbGwgYWJvdmUuCgogICAgdmFyIG9ic2VydmVycyA9IHNjaGVkdWxlZE9ic2VydmVyczsKICAgIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwogICAgLy8gU29ydCBvYnNlcnZlcnMgYmFzZWQgb24gdGhlaXIgY3JlYXRpb24gVUlEIChpbmNyZW1lbnRhbCkuCiAgICBvYnNlcnZlcnMuc29ydChmdW5jdGlvbihvMSwgbzIpIHsKICAgICAgcmV0dXJuIG8xLnVpZF8gLSBvMi51aWRfOwogICAgfSk7CgogICAgdmFyIGFueU5vbkVtcHR5ID0gZmFsc2U7CiAgICBvYnNlcnZlcnMuZm9yRWFjaChmdW5jdGlvbihvYnNlcnZlcikgewoKICAgICAgLy8gMi4xLCAyLjIKICAgICAgdmFyIHF1ZXVlID0gb2JzZXJ2ZXIudGFrZVJlY29yZHMoKTsKICAgICAgLy8gMi4zLiBSZW1vdmUgYWxsIHRyYW5zaWVudCByZWdpc3RlcmVkIG9ic2VydmVycyB3aG9zZSBvYnNlcnZlciBpcyBtby4KICAgICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKTsKCiAgICAgIC8vIDIuNAogICAgICBpZiAocXVldWUubGVuZ3RoKSB7CiAgICAgICAgb2JzZXJ2ZXIuY2FsbGJhY2tfKHF1ZXVlLCBvYnNlcnZlcik7CiAgICAgICAgYW55Tm9uRW1wdHkgPSB0cnVlOwogICAgICB9CiAgICB9KTsKCiAgICAvLyAzLgogICAgaWYgKGFueU5vbkVtcHR5KQogICAgICBkaXNwYXRjaENhbGxiYWNrcygpOwogIH0KCiAgZnVuY3Rpb24gcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzRm9yKG9ic2VydmVyKSB7CiAgICBvYnNlcnZlci5ub2Rlc18uZm9yRWFjaChmdW5jdGlvbihub2RlKSB7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJldHVybjsKICAgICAgcmVnaXN0cmF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlZ2lzdHJhdGlvbikgewogICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IG9ic2VydmVyKQogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZVRyYW5zaWVudE9ic2VydmVycygpOwogICAgICB9KTsKICAgIH0pOwogIH0KCiAgLyoqCiAgICogVGhpcyBmdW5jdGlvbiBpcyB1c2VkIGZvciB0aGUgIkZvciBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGgKICAgKiBvYnNlcnZlcidzIG9wdGlvbnMgYXMgb3B0aW9ucykgaW4gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkIG9ic2VydmVycywKICAgKiBydW4gdGhlc2Ugc3Vic3RlcHM6IiBhbmQgdGhlICJGb3IgZWFjaCBhbmNlc3RvciBhbmNlc3RvciBvZiB0YXJnZXQsIGFuZCBmb3IKICAgKiBlYWNoIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgb2JzZXJ2ZXIgKHdpdGggb3B0aW9ucyBvcHRpb25zKSBpbiBhbmNlc3RvcidzIGxpc3QKICAgKiBvZiByZWdpc3RlcmVkIG9ic2VydmVycywgcnVuIHRoZXNlIHN1YnN0ZXBzOiIgcGFydCBvZiB0aGUgYWxnb3JpdGhtcy4gVGhlCiAgICogfG9wdGlvbnMuc3VidHJlZXwgaXMgY2hlY2tlZCB0byBlbnN1cmUgdGhhdCB0aGUgY2FsbGJhY2sgaXMgY2FsbGVkCiAgICogY29ycmVjdGx5LgogICAqCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge2Z1bmN0aW9uKE11dGF0aW9uT2JzZXJ2ZXJJbml0KTpNdXRhdGlvblJlY29yZH0gY2FsbGJhY2sKICAgKi8KICBmdW5jdGlvbiBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBjYWxsYmFjaykgewogICAgZm9yICh2YXIgbm9kZSA9IHRhcmdldDsgbm9kZTsgbm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CgogICAgICBpZiAocmVnaXN0cmF0aW9ucykgewogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGorKykgewogICAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbal07CiAgICAgICAgICB2YXIgb3B0aW9ucyA9IHJlZ2lzdHJhdGlvbi5vcHRpb25zOwoKICAgICAgICAgIC8vIE9ubHkgdGFyZ2V0IGlnbm9yZXMgc3VidHJlZS4KICAgICAgICAgIGlmIChub2RlICE9PSB0YXJnZXQgJiYgIW9wdGlvbnMuc3VidHJlZSkKICAgICAgICAgICAgY29udGludWU7CgogICAgICAgICAgdmFyIHJlY29yZCA9IGNhbGxiYWNrKG9wdGlvbnMpOwogICAgICAgICAgaWYgKHJlY29yZCkKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLmVucXVldWUocmVjb3JkKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9CgogIHZhciB1aWRDb3VudGVyID0gMDsKCiAgLyoqCiAgICogVGhlIGNsYXNzIHRoYXQgbWFwcyB0byB0aGUgRE9NIE11dGF0aW9uT2JzZXJ2ZXIgaW50ZXJmYWNlLgogICAqIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrLgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIEpzTXV0YXRpb25PYnNlcnZlcihjYWxsYmFjaykgewogICAgdGhpcy5jYWxsYmFja18gPSBjYWxsYmFjazsKICAgIHRoaXMubm9kZXNfID0gW107CiAgICB0aGlzLnJlY29yZHNfID0gW107CiAgICB0aGlzLnVpZF8gPSArK3VpZENvdW50ZXI7CiAgfQoKICBKc011dGF0aW9uT2JzZXJ2ZXIucHJvdG90eXBlID0gewogICAgb2JzZXJ2ZTogZnVuY3Rpb24odGFyZ2V0LCBvcHRpb25zKSB7CiAgICAgIHRhcmdldCA9IHdyYXBJZk5lZWRlZCh0YXJnZXQpOwoKICAgICAgLy8gMS4xCiAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QgJiYgIW9wdGlvbnMuYXR0cmlidXRlcyAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhIHx8CgogICAgICAgICAgLy8gMS4yCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjMKICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyICYmIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmxlbmd0aCAmJgogICAgICAgICAgICAgICFvcHRpb25zLmF0dHJpYnV0ZXMgfHwKCiAgICAgICAgICAvLyAxLjQKICAgICAgICAgIG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlICYmICFvcHRpb25zLmNoYXJhY3RlckRhdGEpIHsKCiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKCk7CiAgICAgIH0KCiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldCh0YXJnZXQpOwogICAgICBpZiAoIXJlZ2lzdHJhdGlvbnMpCiAgICAgICAgcmVnaXN0cmF0aW9uc1RhYmxlLnNldCh0YXJnZXQsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyAyCiAgICAgIC8vIElmIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgYWxyZWFkeSBpbmNsdWRlcyBhIHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCwgcmVwbGFjZSB0aGF0IHJlZ2lzdGVyZWQKICAgICAgLy8gb2JzZXJ2ZXIncyBvcHRpb25zIHdpdGggb3B0aW9ucy4KICAgICAgdmFyIHJlZ2lzdHJhdGlvbjsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgIHJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbnNbaV07CiAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICByZWdpc3RyYXRpb24ub3B0aW9ucyA9IG9wdGlvbnM7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIC8vIDMuCiAgICAgIC8vIE90aGVyd2lzZSwgYWRkIGEgbmV3IHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgdG8gdGFyZ2V0J3MgbGlzdCBvZiByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVycyB3aXRoIHRoZSBjb250ZXh0IG9iamVjdCBhcyB0aGUgb2JzZXJ2ZXIgYW5kIG9wdGlvbnMgYXMgdGhlCiAgICAgIC8vIG9wdGlvbnMsIGFuZCBhZGQgdGFyZ2V0IHRvIGNvbnRleHQgb2JqZWN0J3MgbGlzdCBvZiBub2RlcyBvbiB3aGljaCBpdAogICAgICAvLyBpcyByZWdpc3RlcmVkLgogICAgICBpZiAoIXJlZ2lzdHJhdGlvbikgewogICAgICAgIHJlZ2lzdHJhdGlvbiA9IG5ldyBSZWdpc3RyYXRpb24odGhpcywgdGFyZ2V0LCBvcHRpb25zKTsKICAgICAgICByZWdpc3RyYXRpb25zLnB1c2gocmVnaXN0cmF0aW9uKTsKICAgICAgICB0aGlzLm5vZGVzXy5wdXNoKHRhcmdldCk7CiAgICAgIH0KCiAgICAgIHJlZ2lzdHJhdGlvbi5hZGRMaXN0ZW5lcnMoKTsKICAgIH0sCgogICAgZGlzY29ubmVjdDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbi5vYnNlcnZlciA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb24ucmVtb3ZlTGlzdGVuZXJzKCk7CiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAvLyBFYWNoIG5vZGUgY2FuIG9ubHkgaGF2ZSBvbmUgcmVnaXN0ZXJlZCBvYnNlcnZlciBhc3NvY2lhdGVkIHdpdGgKICAgICAgICAgICAgLy8gdGhpcyBvYnNlcnZlci4KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LCB0aGlzKTsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgfSwKCiAgICB0YWtlUmVjb3JkczogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBjb3B5T2ZSZWNvcmRzID0gdGhpcy5yZWNvcmRzXzsKICAgICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgICByZXR1cm4gY29weU9mUmVjb3JkczsKICAgIH0KICB9OwoKICAvKioKICAgKiBAcGFyYW0ge3N0cmluZ30gdHlwZQogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gTXV0YXRpb25SZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLmFkZGVkTm9kZXMgPSBbXTsKICAgIHRoaXMucmVtb3ZlZE5vZGVzID0gW107CiAgICB0aGlzLnByZXZpb3VzU2libGluZyA9IG51bGw7CiAgICB0aGlzLm5leHRTaWJsaW5nID0gbnVsbDsKICAgIHRoaXMuYXR0cmlidXRlTmFtZSA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG51bGw7CiAgICB0aGlzLm9sZFZhbHVlID0gbnVsbDsKICB9CgogIGZ1bmN0aW9uIGNvcHlNdXRhdGlvblJlY29yZChvcmlnaW5hbCkgewogICAgdmFyIHJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZChvcmlnaW5hbC50eXBlLCBvcmlnaW5hbC50YXJnZXQpOwogICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBvcmlnaW5hbC5hZGRlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gb3JpZ2luYWwucmVtb3ZlZE5vZGVzLnNsaWNlKCk7CiAgICByZWNvcmQucHJldmlvdXNTaWJsaW5nID0gb3JpZ2luYWwucHJldmlvdXNTaWJsaW5nOwogICAgcmVjb3JkLm5leHRTaWJsaW5nID0gb3JpZ2luYWwubmV4dFNpYmxpbmc7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWU7CiAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gb3JpZ2luYWwuYXR0cmlidXRlTmFtZXNwYWNlOwogICAgcmVjb3JkLm9sZFZhbHVlID0gb3JpZ2luYWwub2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkOwogIH07CgogIC8vIFdlIGtlZXAgdHJhY2sgb2YgdGhlIHR3byAocG9zc2libHkgb25lKSByZWNvcmRzIHVzZWQgaW4gYSBzaW5nbGUgbXV0YXRpb24uCiAgdmFyIGN1cnJlbnRSZWNvcmQsIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgLyoqCiAgICogQ3JlYXRlcyBhIHJlY29yZCB3aXRob3V0IHxvbGRWYWx1ZXwgYW5kIGNhY2hlcyBpdCBhcyB8Y3VycmVudFJlY29yZHwgZm9yCiAgICogbGF0ZXIgdXNlLgogICAqIEBwYXJhbSB7c3RyaW5nfSBvbGRWYWx1ZQogICAqIEByZXR1cm4ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIGdldFJlY29yZCh0eXBlLCB0YXJnZXQpIHsKICAgIHJldHVybiBjdXJyZW50UmVjb3JkID0gbmV3IE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCk7CiAgfQoKICAvKioKICAgKiBHZXRzIG9yIGNyZWF0ZXMgYSByZWNvcmQgd2l0aCB8b2xkVmFsdWV8IGJhc2VkIGluIHRoZSB8Y3VycmVudFJlY29yZHwKICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpIHsKICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUpCiAgICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUgPSBjb3B5TXV0YXRpb25SZWNvcmQoY3VycmVudFJlY29yZCk7CiAgICByZWNvcmRXaXRoT2xkVmFsdWUub2xkVmFsdWUgPSBvbGRWYWx1ZTsKICAgIHJldHVybiByZWNvcmRXaXRoT2xkVmFsdWU7CiAgfQoKICBmdW5jdGlvbiBjbGVhclJlY29yZHMoKSB7CiAgICBjdXJyZW50UmVjb3JkID0gcmVjb3JkV2l0aE9sZFZhbHVlID0gdW5kZWZpbmVkOwogIH0KCiAgLyoqCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gcmVjb3JkCiAgICogQHJldHVybiB7Ym9vbGVhbn0gV2hldGhlciB0aGUgcmVjb3JkIHJlcHJlc2VudHMgYSByZWNvcmQgZnJvbSB0aGUgY3VycmVudAogICAqIG11dGF0aW9uIGV2ZW50LgogICAqLwogIGZ1bmN0aW9uIHJlY29yZFJlcHJlc2VudHNDdXJyZW50TXV0YXRpb24ocmVjb3JkKSB7CiAgICByZXR1cm4gcmVjb3JkID09PSByZWNvcmRXaXRoT2xkVmFsdWUgfHwgcmVjb3JkID09PSBjdXJyZW50UmVjb3JkOwogIH0KCiAgLyoqCiAgICogU2VsZWN0cyB3aGljaCByZWNvcmQsIGlmIGFueSwgdG8gcmVwbGFjZSB0aGUgbGFzdCByZWNvcmQgaW4gdGhlIHF1ZXVlLgogICAqIFRoaXMgcmV0dXJucyB8bnVsbHwgaWYgbm8gcmVjb3JkIHNob3VsZCBiZSByZXBsYWNlZC4KICAgKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IGxhc3RSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBuZXdSZWNvcmQKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfQogICAqLwogIGZ1bmN0aW9uIHNlbGVjdFJlY29yZChsYXN0UmVjb3JkLCBuZXdSZWNvcmQpIHsKICAgIGlmIChsYXN0UmVjb3JkID09PSBuZXdSZWNvcmQpCiAgICAgIHJldHVybiBsYXN0UmVjb3JkOwoKICAgIC8vIENoZWNrIGlmIHRoZSB0aGUgcmVjb3JkIHdlIGFyZSBhZGRpbmcgcmVwcmVzZW50cyB0aGUgc2FtZSByZWNvcmQuIElmCiAgICAvLyBzbywgd2Uga2VlcCB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlIGluIGl0LgogICAgaWYgKHJlY29yZFdpdGhPbGRWYWx1ZSAmJiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKGxhc3RSZWNvcmQpKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwoKICAgIHJldHVybiBudWxsOwogIH0KCiAgLyoqCiAgICogQ2xhc3MgdXNlZCB0byByZXByZXNlbnQgYSByZWdpc3RlcmVkIG9ic2VydmVyLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlckluaXR9IG9wdGlvbnMKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBSZWdpc3RyYXRpb24ob2JzZXJ2ZXIsIHRhcmdldCwgb3B0aW9ucykgewogICAgdGhpcy5vYnNlcnZlciA9IG9ic2VydmVyOwogICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7CiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CiAgfQoKICBSZWdpc3RyYXRpb24ucHJvdG90eXBlID0gewogICAgZW5xdWV1ZTogZnVuY3Rpb24ocmVjb3JkKSB7CiAgICAgIHZhciByZWNvcmRzID0gdGhpcy5vYnNlcnZlci5yZWNvcmRzXzsKICAgICAgdmFyIGxlbmd0aCA9IHJlY29yZHMubGVuZ3RoOwoKICAgICAgLy8gVGhlcmUgYXJlIGNhc2VzIHdoZXJlIHdlIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIHdpdGggdGhlIG5ldyByZWNvcmQuCiAgICAgIC8vIEZvciBleGFtcGxlIGlmIHRoZSByZWNvcmQgcmVwcmVzZW50cyB0aGUgc2FtZSBtdXRhdGlvbiB3ZSBuZWVkIHRvIHVzZQogICAgICAvLyB0aGUgb25lIHdpdGggdGhlIG9sZFZhbHVlLiBJZiB3ZSBnZXQgc2FtZSByZWNvcmQgKHRoaXMgY2FuIGhhcHBlbiBhcyB3ZQogICAgICAvLyB3YWxrIHVwIHRoZSB0cmVlKSB3ZSBpZ25vcmUgdGhlIG5ldyByZWNvcmQuCiAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXIgbGFzdFJlY29yZCA9IHJlY29yZHNbbGVuZ3RoIC0gMV07CiAgICAgICAgdmFyIHJlY29yZFRvUmVwbGFjZUxhc3QgPSBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgcmVjb3JkKTsKICAgICAgICBpZiAocmVjb3JkVG9SZXBsYWNlTGFzdCkgewogICAgICAgICAgcmVjb3Jkc1tsZW5ndGggLSAxXSA9IHJlY29yZFRvUmVwbGFjZUxhc3Q7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHNjaGVkdWxlQ2FsbGJhY2sodGhpcy5vYnNlcnZlcik7CiAgICAgIH0KCiAgICAgIHJlY29yZHNbbGVuZ3RoXSA9IHJlY29yZDsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5hZGRMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgYWRkTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKHRoaXMudGFyZ2V0KTsKICAgIH0sCgogICAgcmVtb3ZlTGlzdGVuZXJzXzogZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKICAgICAgaWYgKG9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUF0dHJNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTUNoYXJhY3RlckRhdGFNb2RpZmllZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0KQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZUluc2VydGVkJywgdGhpcywgdHJ1ZSk7CgogICAgICBpZiAob3B0aW9ucy5jaGlsZExpc3QgfHwgb3B0aW9ucy5zdWJ0cmVlKQogICAgICAgIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcignRE9NTm9kZVJlbW92ZWQnLCB0aGlzLCB0cnVlKTsKICAgIH0sCgogICAgLyoqCiAgICAgKiBBZGRzIGEgdHJhbnNpZW50IG9ic2VydmVyIG9uIG5vZGUuIFRoZSB0cmFuc2llbnQgb2JzZXJ2ZXIgZ2V0cyByZW1vdmVkCiAgICAgKiBuZXh0IHRpbWUgd2UgZGVsaXZlciB0aGUgY2hhbmdlIHJlY29yZHMuCiAgICAgKiBAcGFyYW0ge05vZGV9IG5vZGUKICAgICAqLwogICAgYWRkVHJhbnNpZW50T2JzZXJ2ZXI6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgLy8gRG9uJ3QgYWRkIHRyYW5zaWVudCBvYnNlcnZlcnMgb24gdGhlIHRhcmdldCBpdHNlbGYuIFdlIGFscmVhZHkgaGF2ZSBhbGwKICAgICAgLy8gdGhlIHJlcXVpcmVkIGxpc3RlbmVycyBzZXQgdXAgb24gdGhlIHRhcmdldC4KICAgICAgaWYgKG5vZGUgPT09IHRoaXMudGFyZ2V0KQogICAgICAgIHJldHVybjsKCiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyhub2RlKTsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzLnB1c2gobm9kZSk7CiAgICAgIHZhciByZWdpc3RyYXRpb25zID0gcmVnaXN0cmF0aW9uc1RhYmxlLmdldChub2RlKTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQobm9kZSwgcmVnaXN0cmF0aW9ucyA9IFtdKTsKCiAgICAgIC8vIFdlIGtub3cgdGhhdCByZWdpc3RyYXRpb25zIGRvZXMgbm90IGNvbnRhaW4gdGhpcyBiZWNhdXNlIHdlIGFscmVhZHkKICAgICAgLy8gY2hlY2tlZCBpZiBub2RlID09PSB0aGlzLnRhcmdldC4KICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHRoaXMpOwogICAgfSwKCiAgICByZW1vdmVUcmFuc2llbnRPYnNlcnZlcnM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlczsKICAgICAgdGhpcy50cmFuc2llbnRPYnNlcnZlZE5vZGVzID0gW107CgogICAgICB0cmFuc2llbnRPYnNlcnZlZE5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICAgIC8vIFRyYW5zaWVudCBvYnNlcnZlcnMgYXJlIG5ldmVyIGFkZGVkIHRvIHRoZSB0YXJnZXQuCiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnNfKG5vZGUpOwoKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAocmVnaXN0cmF0aW9uc1tpXSA9PT0gdGhpcykgewogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICB9LAoKICAgIGhhbmRsZUV2ZW50OiBmdW5jdGlvbihlKSB7CiAgICAgIC8vIFN0b3AgcHJvcGFnYXRpb24gc2luY2Ugd2UgYXJlIG1hbmFnaW5nIHRoZSBwcm9wYWdhdGlvbiBtYW51YWxseS4KICAgICAgLy8gVGhpcyBtZWFucyB0aGF0IG90aGVyIG11dGF0aW9uIGV2ZW50cyBvbiB0aGUgcGFnZSB3aWxsIG5vdCB3b3JrCiAgICAgIC8vIGNvcnJlY3RseSBidXQgdGhhdCBpcyBieSBkZXNpZ24uCiAgICAgIGUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgogICAgICBzd2l0Y2ggKGUudHlwZSkgewogICAgICAgIGNhc2UgJ0RPTUF0dHJNb2RpZmllZCc6CiAgICAgICAgICAvLyBodHRwOi8vZG9tLnNwZWMud2hhdHdnLm9yZy8jY29uY2VwdC1tby1xdWV1ZS1hdHRyaWJ1dGVzCgogICAgICAgICAgdmFyIG5hbWUgPSBlLmF0dHJOYW1lOwogICAgICAgICAgdmFyIG5hbWVzcGFjZSA9IGUucmVsYXRlZE5vZGUubmFtZXNwYWNlVVJJOwogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gbmV3IGdldFJlY29yZCgnYXR0cmlidXRlcycsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZSA9IG5hbWU7CiAgICAgICAgICByZWNvcmQuYXR0cmlidXRlTmFtZXNwYWNlID0gbmFtZXNwYWNlOwoKICAgICAgICAgIC8vIDIuCiAgICAgICAgICB2YXIgb2xkVmFsdWUgPQogICAgICAgICAgICAgIGUuYXR0ckNoYW5nZSA9PT0gTXV0YXRpb25FdmVudC5BRERJVElPTiA/IG51bGwgOiBlLnByZXZWYWx1ZTsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5hdHRyaWJ1dGVzKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAgIG9wdGlvbnMuYXR0cmlidXRlRmlsdGVyLmluZGV4T2YobmFtZSkgPT09IC0xICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWVzcGFjZSkgPT09IC0xKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy40LCA0LjUKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hhcmFjdGVyZGF0YQogICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGFyYWN0ZXJEYXRhJywgdGFyZ2V0KTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0gZS5wcmV2VmFsdWU7CgoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMy4xLCA0LjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMy4yLCA0LjMKICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hhcmFjdGVyRGF0YU9sZFZhbHVlKQogICAgICAgICAgICAgIHJldHVybiBnZXRSZWNvcmRXaXRoT2xkVmFsdWUob2xkVmFsdWUpOwoKICAgICAgICAgICAgLy8gMy4zLCA0LjQKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGJyZWFrOwoKICAgICAgICBjYXNlICdET01Ob2RlUmVtb3ZlZCc6CiAgICAgICAgICB0aGlzLmFkZFRyYW5zaWVudE9ic2VydmVyKGUudGFyZ2V0KTsKICAgICAgICAgIC8vIEZhbGwgdGhyb3VnaC4KICAgICAgICBjYXNlICdET01Ob2RlSW5zZXJ0ZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtY2hpbGRsaXN0CiAgICAgICAgICB2YXIgdGFyZ2V0ID0gZS5yZWxhdGVkTm9kZTsKICAgICAgICAgIHZhciBjaGFuZ2VkTm9kZSA9IGUudGFyZ2V0OwogICAgICAgICAgdmFyIGFkZGVkTm9kZXMsIHJlbW92ZWROb2RlczsKICAgICAgICAgIGlmIChlLnR5cGUgPT09ICdET01Ob2RlSW5zZXJ0ZWQnKSB7CiAgICAgICAgICAgIGFkZGVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbXTsKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBhZGRlZE5vZGVzID0gW107CiAgICAgICAgICAgIHJlbW92ZWROb2RlcyA9IFtjaGFuZ2VkTm9kZV07CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gY2hhbmdlZE5vZGUucHJldmlvdXNTaWJsaW5nOwogICAgICAgICAgdmFyIG5leHRTaWJsaW5nID0gY2hhbmdlZE5vZGUubmV4dFNpYmxpbmc7CgogICAgICAgICAgLy8gMS4KICAgICAgICAgIHZhciByZWNvcmQgPSBnZXRSZWNvcmQoJ2NoaWxkTGlzdCcsIHRhcmdldCk7CiAgICAgICAgICByZWNvcmQuYWRkZWROb2RlcyA9IGFkZGVkTm9kZXM7CiAgICAgICAgICByZWNvcmQucmVtb3ZlZE5vZGVzID0gcmVtb3ZlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IHByZXZpb3VzU2libGluZzsKICAgICAgICAgIHJlY29yZC5uZXh0U2libGluZyA9IG5leHRTaWJsaW5nOwoKICAgICAgICAgIGZvckVhY2hBbmNlc3RvckFuZE9ic2VydmVyRW5xdWV1ZVJlY29yZCh0YXJnZXQsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgICAgICAgLy8gMi4xLCAzLjIKICAgICAgICAgICAgaWYgKCFvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAyLjIsIDMuMwogICAgICAgICAgICByZXR1cm4gcmVjb3JkOwogICAgICAgICAgfSk7CgogICAgICB9CgogICAgICBjbGVhclJlY29yZHMoKTsKICAgIH0KICB9OwoKICBnbG9iYWwuSnNNdXRhdGlvbk9ic2VydmVyID0gSnNNdXRhdGlvbk9ic2VydmVyOwoKfSkodGhpcyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKaWYgKCF3aW5kb3cuTXV0YXRpb25PYnNlcnZlcikgewogIHdpbmRvdy5NdXRhdGlvbk9ic2VydmVyID0KICAgICAgd2luZG93LldlYktpdE11dGF0aW9uT2JzZXJ2ZXIgfHwKICAgICAgd2luZG93LkpzTXV0YXRpb25PYnNlcnZlcjsKICBpZiAoIU11dGF0aW9uT2JzZXJ2ZXIpIHsKICAgIHRocm93IG5ldyBFcnJvcigibm8gbXV0YXRpb24gb2JzZXJ2ZXIgc3VwcG9ydCIpOwogIH0KfQoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8qKgogKiBJbXBsZW1lbnRzIGBkb2N1bWVudC5yZWdpc3RlcmAKICogQG1vZHVsZSBDdXN0b21FbGVtZW50cwoqLwoKLyoqCiAqIFBvbHlmaWxsZWQgZXh0ZW5zaW9ucyB0byB0aGUgYGRvY3VtZW50YCBvYmplY3QuCiAqIEBjbGFzcyBEb2N1bWVudAoqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7CgppZiAoIXNjb3BlKSB7CiAgc2NvcGUgPSB3aW5kb3cuQ3VzdG9tRWxlbWVudHMgPSB7ZmxhZ3M6e319Owp9CgovLyBuYXRpdmUgZG9jdW1lbnQucmVnaXN0ZXI/CgpzY29wZS5oYXNOYXRpdmUgPSAoZG9jdW1lbnQud2Via2l0UmVnaXN0ZXIgfHwgZG9jdW1lbnQucmVnaXN0ZXIpICYmIHNjb3BlLmZsYWdzLnJlZ2lzdGVyID09PSAnbmF0aXZlJzsKaWYgKHNjb3BlLmhhc05hdGl2ZSkgewoKICAvLyBub3JtYWxpemUKICBkb2N1bWVudC5yZWdpc3RlciA9IGRvY3VtZW50LnJlZ2lzdGVyIHx8IGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyOwoKICB2YXIgbm9wID0gZnVuY3Rpb24oKSB7fTsKCiAgLy8gZXhwb3J0cwogIHNjb3BlLnJlZ2lzdHJ5ID0ge307CiAgc2NvcGUudXBncmFkZUVsZW1lbnQgPSBub3A7Cgp9IGVsc2UgewoKLyoqCiAqIFJlZ2lzdGVycyBhIGN1c3RvbSB0YWcgbmFtZSB3aXRoIHRoZSBkb2N1bWVudC4KICoKICogV2hlbiBhIHJlZ2lzdGVyZWQgZWxlbWVudCBpcyBjcmVhdGVkLCBhIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgaXMgY2FsbGVkCiAqIGluIHRoZSBzY29wZSBvZiB0aGUgZWxlbWVudC4gVGhlIGByZWFkeUNhbGxiYWNrYCBtZXRob2QgY2FuIGJlIHNwZWNpZmllZCBvbgogKiBlaXRoZXIgYGluT3B0aW9ucy5wcm90b3R5cGVgIG9yIGBpbk9wdGlvbnMubGlmZWN5Y2xlYCB3aXRoIHRoZSBsYXR0ZXIgdGFraW5nCiAqIHByZWNlZGVuY2UuCiAqCiAqIEBtZXRob2QgcmVnaXN0ZXIKICogQHBhcmFtIHtTdHJpbmd9IGluTmFtZSBUaGUgdGFnIG5hbWUgdG8gcmVnaXN0ZXIuIE11c3QgaW5jbHVkZSBhIGRhc2ggKCctJyksCiAqICAgIGZvciBleGFtcGxlICd4LWNvbXBvbmVudCcuCiAqIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMKICogICAgQHBhcmFtIHtTdHJpbmd9IFtpbk9wdGlvbnMuZXh0ZW5kc10KICogICAgICAoX29mZiBzcGVjXykgVGFnIG5hbWUgb2YgYW4gZWxlbWVudCB0byBleHRlbmQgKG9yIGJsYW5rIGZvciBhIG5ldwogKiAgICAgIGVsZW1lbnQpLiBUaGlzIHBhcmFtZXRlciBpcyBub3QgcGFydCBvZiB0aGUgc3BlY2lmaWNhdGlvbiwgYnV0IGluc3RlYWQKICogICAgICBpcyBhIGhpbnQgZm9yIHRoZSBwb2x5ZmlsbCBiZWNhdXNlIHRoZSBleHRlbmRlZSBpcyBkaWZmaWN1bHQgdG8gaW5mZXIuCiAqICAgICAgUmVtZW1iZXIgdGhhdCB0aGUgaW5wdXQgcHJvdG90eXBlIG11c3QgY2hhaW4gdG8gdGhlIGV4dGVuZGVkIGVsZW1lbnQncwogKiAgICAgIHByb3RvdHlwZSAob3IgSFRNTEVsZW1lbnQucHJvdG90eXBlKSByZWdhcmRsZXNzIG9mIHRoZSB2YWx1ZSBvZgogKiAgICAgIGBleHRlbmRzYC4KICogICAgQHBhcmFtIHtPYmplY3R9IGluT3B0aW9ucy5wcm90b3R5cGUgVGhlIHByb3RvdHlwZSB0byB1c2UgZm9yIHRoZSBuZXcKICogICAgICBlbGVtZW50LiBUaGUgcHJvdG90eXBlIG11c3QgaW5oZXJpdCBmcm9tIEhUTUxFbGVtZW50LgogKiAgICBAcGFyYW0ge09iamVjdH0gW2luT3B0aW9ucy5saWZlY3ljbGVdCiAqICAgICAgQ2FsbGJhY2tzIHRoYXQgZmlyZSBhdCBpbXBvcnRhbnQgcGhhc2VzIGluIHRoZSBsaWZlIG9mIHRoZSBjdXN0b20KICogICAgICBlbGVtZW50LgogKgogKiBAZXhhbXBsZQogKiAgICAgIEZhbmN5QnV0dG9uID0gZG9jdW1lbnQucmVnaXN0ZXIoImZhbmN5LWJ1dHRvbiIsIHsKICogICAgICAgIGV4dGVuZHM6ICdidXR0b24nLAogKiAgICAgICAgcHJvdG90eXBlOiBPYmplY3QuY3JlYXRlKEhUTUxCdXR0b25FbGVtZW50LnByb3RvdHlwZSwgewogKiAgICAgICAgICByZWFkeUNhbGxiYWNrOiB7CiAqICAgICAgICAgICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogKiAgICAgICAgICAgICAgY29uc29sZS5sb2coImEgZmFuY3ktYnV0dG9uIHdhcyBjcmVhdGVkIiwKICogICAgICAgICAgICB9CiAqICAgICAgICAgIH0KICogICAgICAgIH0pCiAqICAgICAgfSk7CiAqIEByZXR1cm4ge0Z1bmN0aW9ufSBDb25zdHJ1Y3RvciBmb3IgdGhlIG5ld2x5IHJlZ2lzdGVyZWQgdHlwZS4KICovCmZ1bmN0aW9uIHJlZ2lzdGVyKGluTmFtZSwgaW5PcHRpb25zKSB7CiAgLy9jb25zb2xlLndhcm4oJ2RvY3VtZW50LnJlZ2lzdGVyKCInICsgaW5OYW1lICsgJyIsICcsIGluT3B0aW9ucywgJyknKTsKICAvLyBjb25zdHJ1Y3QgYSBkZWZpbnRpb24gb3V0IG9mIG9wdGlvbnMKICAvLyBUT0RPKHNqbWlsZXMpOiBwcm9iYWJseSBzaG91bGQgY2xvbmUgaW5PcHRpb25zIGluc3RlYWQgb2YgbXV0YXRpbmcgaXQKICB2YXIgZGVmaW5pdGlvbiA9IGluT3B0aW9ucyB8fCB7fTsKICBpZiAoIWluTmFtZSkgewogICAgLy8gVE9ETyhzam1pbGVzKTogcmVwbGFjZSB3aXRoIG1vcmUgYXBwcm9wcmlhdGUgZXJyb3IgKEVyaWsgY2FuIHByb2JhYmx5CiAgICAvLyBvZmZlciBndWlkYW5jZSkKICAgIHRocm93IG5ldyBFcnJvcignTmFtZSBhcmd1bWVudCBtdXN0IG5vdCBiZSBlbXB0eScpOwogIH0KICAvLyByZWNvcmQgbmFtZQogIGRlZmluaXRpb24ubmFtZSA9IGluTmFtZTsKICAvLyBtdXN0IGhhdmUgYSBwcm90b3R5cGUsIGRlZmF1bHQgdG8gYW4gZXh0ZW5zaW9uIG9mIEhUTUxFbGVtZW50CiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIHRocm93IGlmIG5vIHByb3RvdHlwZSwgY2hlY2sgc3BlYwogIGlmICghZGVmaW5pdGlvbi5wcm90b3R5cGUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ09wdGlvbnMgbWlzc2luZyByZXF1aXJlZCBwcm90b3R5cGUgcHJvcGVydHknKTsKICB9CiAgLy8gZW5zdXJlIGEgbGlmZWN5Y2xlIG9iamVjdCBzbyB3ZSBkb24ndCBoYXZlIHRvIG51bGwgdGVzdCBpdAogIGRlZmluaXRpb24ubGlmZWN5Y2xlID0gZGVmaW5pdGlvbi5saWZlY3ljbGUgfHwge307CiAgLy8gYnVpbGQgYSBsaXN0IG9mIGFuY2VzdHJhbCBjdXN0b20gZWxlbWVudHMgKGZvciBuYXRpdmUgYmFzZSBkZXRlY3Rpb24pCiAgLy8gVE9ETyhzam1pbGVzKTogd2UgdXNlZCB0byBuZWVkIHRvIHN0b3JlIHRoaXMsIGJ1dCBjdXJyZW50IGNvZGUgb25seQogIC8vIHVzZXMgaXQgaW4gJ3Jlc29sdmVUYWdOYW1lJzogaXQgc2hvdWxkIHByb2JhYmx5IGJlIGlubGluZWQKICBkZWZpbml0aW9uLmFuY2VzdHJ5ID0gYW5jZXN0cnkoZGVmaW5pdGlvbi5leHRlbmRzKTsKICAvLyBleHRlbnNpb25zIG9mIG5hdGl2ZSBzcGVjaWFsaXphdGlvbnMgb2YgSFRNTEVsZW1lbnQgcmVxdWlyZSBsb2NhbE5hbWUKICAvLyB0byByZW1haW4gbmF0aXZlLCBhbmQgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllciBmb3IgZXh0ZW5zaW9uIHR5cGUKICByZXNvbHZlVGFnTmFtZShkZWZpbml0aW9uKTsKICAvLyBzb21lIHBsYXRmb3JtcyByZXF1aXJlIG1vZGlmaWNhdGlvbnMgdG8gdGhlIHVzZXItc3VwcGxpZWQgcHJvdG90eXBlCiAgLy8gY2hhaW4KICByZXNvbHZlUHJvdG90eXBlQ2hhaW4oZGVmaW5pdGlvbik7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBhdHRyaWJ1dGVDaGFuZ2VkIGNhbGxiYWNrCiAgb3ZlcnJpZGVBdHRyaWJ1dGVBcGkoZGVmaW5pdGlvbi5wcm90b3R5cGUpOwogIC8vIDcuMS41OiBSZWdpc3RlciB0aGUgREVGSU5JVElPTiB3aXRoIERPQ1VNRU5UCiAgcmVnaXN0ZXJEZWZpbml0aW9uKGluTmFtZSwgZGVmaW5pdGlvbik7CiAgLy8gNy4xLjcuIFJ1biBjdXN0b20gZWxlbWVudCBjb25zdHJ1Y3RvciBnZW5lcmF0aW9uIGFsZ29yaXRobSB3aXRoIFBST1RPVFlQRQogIC8vIDcuMS44LiBSZXR1cm4gdGhlIG91dHB1dCBvZiB0aGUgcHJldmlvdXMgc3RlcC4KICBkZWZpbml0aW9uLmN0b3IgPSBnZW5lcmF0ZUNvbnN0cnVjdG9yKGRlZmluaXRpb24pOwogIGRlZmluaXRpb24uY3Rvci5wcm90b3R5cGUgPSBkZWZpbml0aW9uLnByb3RvdHlwZTsKICAvLyBmb3JjZSBvdXIgLmNvbnN0cnVjdG9yIHRvIGJlIG91ciBhY3R1YWwgY29uc3RydWN0b3IKICBkZWZpbml0aW9uLnByb3RvdHlwZS5jb25zdHJ1Y3RvciA9IGRlZmluaXRpb24uY3RvcjsKICAvLyBpZiBpbml0aWFsIHBhcnNpbmcgaXMgY29tcGxldGUKICBpZiAoc2NvcGUucmVhZHkpIHsKICAgIC8vIHVwZ3JhZGUgYW55IHByZS1leGlzdGluZyBub2RlcyBvZiB0aGlzIHR5cGUKICAgIHNjb3BlLnVwZ3JhZGVBbGwoZG9jdW1lbnQpOwogIH0KICByZXR1cm4gZGVmaW5pdGlvbi5jdG9yOwp9CgpmdW5jdGlvbiBhbmNlc3RyeShpbkV4dGVuZHMpIHsKICB2YXIgZXh0ZW5kZWUgPSByZWdpc3RyeVtpbkV4dGVuZHNdOwogIGlmIChleHRlbmRlZSkgewogICAgcmV0dXJuIGFuY2VzdHJ5KGV4dGVuZGVlLmV4dGVuZHMpLmNvbmNhdChbZXh0ZW5kZWVdKTsKICB9CiAgcmV0dXJuIFtdOwp9CgpmdW5jdGlvbiByZXNvbHZlVGFnTmFtZShpbkRlZmluaXRpb24pIHsKICAvLyBpZiB3ZSBhcmUgZXhwbGljaXRseSBleHRlbmRpbmcgc29tZXRoaW5nLCB0aGF0IHRoaW5nIGlzIG91cgogIC8vIGJhc2VUYWcsIHVubGVzcyBpdCByZXByZXNlbnRzIGEgY3VzdG9tIGNvbXBvbmVudAogIHZhciBiYXNlVGFnID0gaW5EZWZpbml0aW9uLmV4dGVuZHM7CiAgLy8gaWYgb3VyIGFuY2VzdHJ5IGluY2x1ZGVzIGN1c3RvbSBjb21wb25lbnRzLCB3ZSBvbmx5IGhhdmUgYQogIC8vIGJhc2VUYWcgaWYgb25lIG9mIHRoZW0gZG9lcwogIGZvciAodmFyIGk9MCwgYTsgKGE9aW5EZWZpbml0aW9uLmFuY2VzdHJ5W2ldKTsgaSsrKSB7CiAgICBiYXNlVGFnID0gYS5pcyAmJiBhLnRhZzsKICB9CiAgLy8gb3VyIHRhZyBpcyBvdXIgYmFzZVRhZywgaWYgaXQgZXhpc3RzLCBhbmQgb3RoZXJ3aXNlIGp1c3Qgb3VyIG5hbWUKICBpbkRlZmluaXRpb24udGFnID0gYmFzZVRhZyB8fCBpbkRlZmluaXRpb24ubmFtZTsKICBpZiAoYmFzZVRhZykgewogICAgLy8gaWYgdGhlcmUgaXMgYSBiYXNlIHRhZywgdXNlIHNlY29uZGFyeSAnaXMnIHNwZWNpZmllcgogICAgaW5EZWZpbml0aW9uLmlzID0gaW5EZWZpbml0aW9uLm5hbWU7CiAgfQp9CgpmdW5jdGlvbiByZXNvbHZlUHJvdG90eXBlQ2hhaW4oaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgZG9uJ3Qgc3VwcG9ydCBfX3Byb3RvX18gd2UgbmVlZCB0byBsb2NhdGUgdGhlIG5hdGl2ZSBsZXZlbAogIC8vIHByb3RvdHlwZSBmb3IgcHJlY2lzZSBtaXhpbmcgaW4KICBpZiAoIU9iamVjdC5fX3Byb3RvX18pIHsKICAgIC8vIGRlZmF1bHQgcHJvdG90eXBlCiAgICB2YXIgbmF0aXZlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogICAgLy8gd29yayBvdXQgcHJvdG90eXBlIHdoZW4gdXNpbmcgdHlwZS1leHRlbnNpb24KICAgIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgICAgdmFyIGluc3QgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpOwogICAgICBuYXRpdmUgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoaW5zdCk7CiAgICB9CiAgfQogIC8vIGNhY2hlIHRoaXMgaW4gY2FzZSBvZiBtaXhpbgogIGluRGVmaW5pdGlvbi5uYXRpdmUgPSBuYXRpdmU7Cn0KCi8vIFNFQ1RJT04gNAoKZnVuY3Rpb24gaW5zdGFudGlhdGUoaW5EZWZpbml0aW9uKSB7CiAgLy8gNC5hLjEuIENyZWF0ZSBhIG5ldyBvYmplY3QgdGhhdCBpbXBsZW1lbnRzIFBST1RPVFlQRQogIC8vIDQuYS4yLiBMZXQgRUxFTUVOVCBieSB0aGlzIG5ldyBvYmplY3QKICAvLwogIC8vIHRoZSBjdXN0b20gZWxlbWVudCBpbnN0YW50aWF0aW9uIGFsZ29yaXRobSBtdXN0IGFsc28gZW5zdXJlIHRoYXQgdGhlCiAgLy8gb3V0cHV0IGlzIGEgdmFsaWQgRE9NIGVsZW1lbnQgd2l0aCB0aGUgcHJvcGVyIHdyYXBwZXIgaW4gcGxhY2UuCiAgLy8KICByZXR1cm4gdXBncmFkZShkb21DcmVhdGVFbGVtZW50KGluRGVmaW5pdGlvbi50YWcpLCBpbkRlZmluaXRpb24pOwp9CgpmdW5jdGlvbiB1cGdyYWRlKGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gc29tZSBkZWZpbml0aW9ucyBzcGVjaWZ5IGFuICdpcycgYXR0cmlidXRlCiAgaWYgKGluRGVmaW5pdGlvbi5pcykgewogICAgaW5FbGVtZW50LnNldEF0dHJpYnV0ZSgnaXMnLCBpbkRlZmluaXRpb24uaXMpOwogIH0KICAvLyBtYWtlICdlbGVtZW50JyBpbXBsZW1lbnQgaW5EZWZpbml0aW9uLnByb3RvdHlwZQogIGltcGxlbWVudChpbkVsZW1lbnQsIGluRGVmaW5pdGlvbik7CiAgLy8gZmxhZyBhcyB1cGdyYWRlZAogIGluRWxlbWVudC5fX3VwZ3JhZGVkX18gPSB0cnVlOwogIC8vIHRoZXJlIHNob3VsZCBuZXZlciBiZSBhIHNoYWRvdyByb290IG9uIGluRWxlbWVudCBhdCB0aGlzIHBvaW50CiAgLy8gd2UgcmVxdWlyZSBjaGlsZCBub2RlcyBiZSB1cGdyYWRlZCBiZWZvcmUgcmVhZHkKICBzY29wZS51cGdyYWRlU3VidHJlZShpbkVsZW1lbnQpOwogIC8vIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgcmVhZHkoaW5FbGVtZW50KTsKICAvLyBPVVRQVVQKICByZXR1cm4gaW5FbGVtZW50Owp9CgpmdW5jdGlvbiBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pIHsKICAvLyBwcm90b3R5cGUgc3dpenpsaW5nIGlzIGJlc3QKICBpZiAoT2JqZWN0Ll9fcHJvdG9fXykgewogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfSBlbHNlIHsKICAgIC8vIHdoZXJlIGFib3ZlIHdlIGNhbiByZS1hY3F1aXJlIGluUHJvdG90eXBlIHZpYQogICAgLy8gZ2V0UHJvdG90eXBlT2YoRWxlbWVudCksIHdlIGNhbm5vdCBkbyBzbyB3aGVuCiAgICAvLyB3ZSB1c2UgbWl4aW4sIHNvIHdlIGluc3RhbGwgYSBtYWdpYyByZWZlcmVuY2UKICAgIGN1c3RvbU1peGluKGluRWxlbWVudCwgaW5EZWZpbml0aW9uLnByb3RvdHlwZSwgaW5EZWZpbml0aW9uLm5hdGl2ZSk7CiAgICBpbkVsZW1lbnQuX19wcm90b19fID0gaW5EZWZpbml0aW9uLnByb3RvdHlwZTsKICB9Cn0KCmZ1bmN0aW9uIGN1c3RvbU1peGluKGluVGFyZ2V0LCBpblNyYywgaW5OYXRpdmUpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiAndXNlZCcgYWxsb3dzIHVzIHRvIG9ubHkgY29weSB0aGUgJ3lvdW5nZXN0JyB2ZXJzaW9uIG9mCiAgLy8gYW55IHByb3BlcnR5LiBUaGlzIHNldCBzaG91bGQgYmUgcHJlY2FsY3VsYXRlZC4gV2UgYWxzbyBuZWVkIHRvCiAgLy8gY29uc2lkZXIgdGhpcyBmb3Igc3VwcG9ydGluZyAnc3VwZXInLgogIHZhciB1c2VkID0ge307CiAgLy8gc3RhcnQgd2l0aCBpblNyYwogIHZhciBwID0gaW5TcmM7CiAgLy8gc29tZXRpbWVzIHRoZSBkZWZhdWx0IGlzIEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUgaW5zdGVhZCBvZgogIC8vIEhUTUxFbGVtZW50LnByb3RvdHlwZSwgc28gd2UgYWRkIGEgdGVzdAogIC8vIHRoZSBpZGVhIGlzIHRvIGF2b2lkIG1peGluZyBpbiBuYXRpdmUgcHJvdG90eXBlcywgc28gYWRkaW5nCiAgLy8gdGhlIHNlY29uZCB0ZXN0IGlzIFdMT0cKICB3aGlsZSAocCAhPT0gaW5OYXRpdmUgJiYgcCAhPT0gSFRNTFVua25vd25FbGVtZW50LnByb3RvdHlwZSkgewogICAgdmFyIGtleXMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwKTsKICAgIGZvciAodmFyIGk9MCwgazsgaz1rZXlzW2ldOyBpKyspIHsKICAgICAgaWYgKCF1c2VkW2tdKSB7CiAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGluVGFyZ2V0LCBrLAogICAgICAgICAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKHAsIGspKTsKICAgICAgICB1c2VkW2tdID0gMTsKICAgICAgfQogICAgfQogICAgcCA9IE9iamVjdC5nZXRQcm90b3R5cGVPZihwKTsKICB9Cn0KCmZ1bmN0aW9uIHJlYWR5KGluRWxlbWVudCkgewogIC8vIGludm9rZSByZWFkeUNhbGxiYWNrCiAgaWYgKGluRWxlbWVudC5yZWFkeUNhbGxiYWNrKSB7CiAgICBpbkVsZW1lbnQucmVhZHlDYWxsYmFjaygpOwogIH0KfQoKLy8gYXR0cmlidXRlIHdhdGNoaW5nCgpmdW5jdGlvbiBvdmVycmlkZUF0dHJpYnV0ZUFwaShwcm90b3R5cGUpIHsKICAvLyBvdmVycmlkZXMgdG8gaW1wbGVtZW50IGNhbGxiYWNrcwogIC8vIFRPRE8oc2ptaWxlcyk6IHNob3VsZCBzdXBwb3J0IGFjY2VzcyB2aWEgLmF0dHJpYnV0ZXMgTmFtZWROb2RlTWFwCiAgLy8gVE9ETyhzam1pbGVzKTogcHJlc2VydmVzIHVzZXIgZGVmaW5lZCBvdmVycmlkZXMsIGlmIGFueQogIHZhciBzZXRBdHRyaWJ1dGUgPSBwcm90b3R5cGUuc2V0QXR0cmlidXRlOwogIHByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHNldEF0dHJpYnV0ZSk7CiAgfQogIHZhciByZW1vdmVBdHRyaWJ1dGUgPSBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogIHByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgY2hhbmdlQXR0cmlidXRlLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIHJlbW92ZUF0dHJpYnV0ZSk7CiAgfQp9CgpmdW5jdGlvbiBjaGFuZ2VBdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wZXJhdGlvbikgewogIHZhciBvbGRWYWx1ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpOwogIG9wZXJhdGlvbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGlmICh0aGlzLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjawogICAgICAmJiAodGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgIT09IG9sZFZhbHVlKSkgewogICAgdGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkVmFsdWUpOwogIH0KfQoKLy8gZWxlbWVudCByZWdpc3RyeSAobWFwcyB0YWcgbmFtZXMgdG8gZGVmaW5pdGlvbnMpCgp2YXIgcmVnaXN0cnkgPSB7fTsKCmZ1bmN0aW9uIHJlZ2lzdGVyRGVmaW5pdGlvbihpbk5hbWUsIGluRGVmaW5pdGlvbikgewogIHJlZ2lzdHJ5W2luTmFtZV0gPSBpbkRlZmluaXRpb247Cn0KCmZ1bmN0aW9uIGdlbmVyYXRlQ29uc3RydWN0b3IoaW5EZWZpbml0aW9uKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIGluc3RhbnRpYXRlKGluRGVmaW5pdGlvbik7CiAgfTsKfQoKZnVuY3Rpb24gY3JlYXRlRWxlbWVudChpblRhZykgewogIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbaW5UYWddOwogIGlmIChkZWZpbml0aW9uKSB7CiAgICByZXR1cm4gbmV3IGRlZmluaXRpb24uY3RvcigpOwogIH0KICByZXR1cm4gZG9tQ3JlYXRlRWxlbWVudChpblRhZyk7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGVFbGVtZW50KGluRWxlbWVudCkgewogIGlmICghaW5FbGVtZW50Ll9fdXBncmFkZWRfXyAmJiAoaW5FbGVtZW50Lm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkpIHsKICAgIHZhciB0eXBlID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBpbkVsZW1lbnQubG9jYWxOYW1lOwogICAgdmFyIGRlZmluaXRpb24gPSByZWdpc3RyeVt0eXBlXTsKICAgIHJldHVybiBkZWZpbml0aW9uICYmIHVwZ3JhZGUoaW5FbGVtZW50LCBkZWZpbml0aW9uKTsKICB9Cn0KCmZ1bmN0aW9uIGNsb25lTm9kZShkZWVwKSB7CiAgLy8gY2FsbCBvcmlnaW5hbCBjbG9uZQogIHZhciBuID0gZG9tQ2xvbmVOb2RlLmNhbGwodGhpcywgZGVlcCk7CiAgLy8gdXBncmFkZSB0aGUgZWxlbWVudCBhbmQgc3VidHJlZQogIHNjb3BlLnVwZ3JhZGVBbGwobik7CiAgcmV0dXJuIG47Cn0KLy8gY2FwdHVyZSBuYXRpdmUgY3JlYXRlRWxlbWVudCBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DcmVhdGVFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudC5iaW5kKGRvY3VtZW50KTsKCi8vIGNhcHR1cmUgbmF0aXZlIGNsb25lTm9kZSBiZWZvcmUgd2Ugb3ZlcnJpZGUgaXQKCnZhciBkb21DbG9uZU5vZGUgPSBOb2RlLnByb3RvdHlwZS5jbG9uZU5vZGU7CgovLyBleHBvcnRzCgpkb2N1bWVudC5yZWdpc3RlciA9IHJlZ2lzdGVyOwpkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gY3JlYXRlRWxlbWVudDsgLy8gb3ZlcnJpZGUKTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlID0gY2xvbmVOb2RlOyAvLyBvdmVycmlkZQoKc2NvcGUucmVnaXN0cnkgPSByZWdpc3RyeTsKCi8qKgogKiBVcGdyYWRlIGFuIGVsZW1lbnQgdG8gYSBjdXN0b20gZWxlbWVudC4gVXBncmFkaW5nIGFuIGVsZW1lbnQKICogY2F1c2VzIHRoZSBjdXN0b20gcHJvdG90eXBlIHRvIGJlIGFwcGxpZWQsIGFuIGBpc2AgYXR0cmlidXRlCiAqIHRvIGJlIGF0dGFjaGVkIChhcyBuZWVkZWQpLCBhbmQgaW52b2NhdGlvbiBvZiB0aGUgYHJlYWR5Q2FsbGJhY2tgLgogKiBgdXBncmFkZWAgZG9lcyBub3RoaW5nIGlmIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgdXBncmFkZWQsIG9yCiAqIGlmIGl0IG1hdGNoZXMgbm8gcmVnaXN0ZXJlZCBjdXN0b20gdGFnIG5hbWUuCiAqCiAqIEBtZXRob2QgdWdwcmFkZQogKiBAcGFyYW0ge0VsZW1lbnR9IGluRWxlbWVudCBUaGUgZWxlbWVudCB0byB1cGdyYWRlLgogKiBAcmV0dXJuIHtFbGVtZW50fSBUaGUgdXBncmFkZWQgZWxlbWVudC4KICovCnNjb3BlLnVwZ3JhZGUgPSB1cGdyYWRlRWxlbWVudDsKCn0KCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7CgogLyoKQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgoqLwoKKGZ1bmN0aW9uKHNjb3BlKXsKCi8qCmlmIChIVE1MRWxlbWVudC5wcm90b3R5cGUud2Via2l0U2hhZG93Um9vdCkgewogIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShIVE1MRWxlbWVudC5wcm90b3R5cGUsICdzaGFkb3dSb290JywgewogICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXMud2Via2l0U2hhZG93Um9vdDsKICAgIH0KICB9Owp9CiovCgovLyB3YWxrIHRoZSBzdWJ0cmVlIHJvb3RlZCBhdCBub2RlLCBhcHBseWluZyAnZmluZChlbGVtZW50LCBkYXRhKScgZnVuY3Rpb24KLy8gdG8gZWFjaCBlbGVtZW50Ci8vIGlmICdmaW5kJyByZXR1cm5zIHRydWUgZm9yICdlbGVtZW50JywgZG8gbm90IHNlYXJjaCBlbGVtZW50J3Mgc3VidHJlZQpmdW5jdGlvbiBmaW5kQWxsKG5vZGUsIGZpbmQsIGRhdGEpIHsKICB2YXIgZSA9IG5vZGUuZmlyc3RFbGVtZW50Q2hpbGQ7CiAgaWYgKCFlKSB7CiAgICBlID0gbm9kZS5maXJzdENoaWxkOwogICAgd2hpbGUgKGUgJiYgZS5ub2RlVHlwZSAhPT0gTm9kZS5FTEVNRU5UX05PREUpIHsKICAgICAgZSA9IGUubmV4dFNpYmxpbmc7CiAgICB9CiAgfQogIHdoaWxlIChlKSB7CiAgICBpZiAoZmluZChlLCBkYXRhKSAhPT0gdHJ1ZSkgewogICAgICBmaW5kQWxsKGUsIGZpbmQsIGRhdGEpOwogICAgfQogICAgZSA9IGUubmV4dEVsZW1lbnRTaWJsaW5nOwogIH0KICByZXR1cm4gbnVsbDsKfQoKLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgaW5jbHVkaW5nIGRlc2NlbnQgaW50byBzaGFkb3ctcm9vdHMsCi8vIGFwcGx5aW5nICdjYicgdG8gZWFjaCBlbGVtZW50CmZ1bmN0aW9uIGZvclN1YnRyZWUobm9kZSwgY2IpIHsKICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwKCdzdWJUcmVlOiAnLCBub2RlKTsKICBmaW5kQWxsKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgIGlmIChjYihlKSkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGlmIChlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICAgICAgZm9yU3VidHJlZShlLndlYmtpdFNoYWRvd1Jvb3QsIGNiKTsKICAgIH0KICB9KTsKICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290KSB7CiAgICBmb3JTdWJ0cmVlKG5vZGUud2Via2l0U2hhZG93Um9vdCwgY2IpOwogIH0KICAvL2xvZ0ZsYWdzLmRvbSAmJiBub2RlLmNoaWxkTm9kZXMgJiYgbm9kZS5jaGlsZE5vZGVzLmxlbmd0aCAmJiBjb25zb2xlLmdyb3VwRW5kKCk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZQpmdW5jdGlvbiBhZGRlZChub2RlKSB7CiAgaWYgKHVwZ3JhZGUobm9kZSkpIHsKICAgIGluc2VydGVkTm9kZShub2RlKTsKICAgIHJldHVybiB0cnVlOwogIH0KICBpbnNlcnRlZChub2RlKTsKfQoKLy8gbWFuYWdlIGxpZmVjeWNsZSBvbiBhZGRlZCBub2RlJ3Mgc3VidHJlZSBvbmx5CmZ1bmN0aW9uIGFkZGVkU3VidHJlZShub2RlKSB7CiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICBpZiAoYWRkZWQoZSkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfSk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSBhbmQgaXQncyBzdWJ0cmVlCmZ1bmN0aW9uIGFkZGVkTm9kZShub2RlKSB7CiAgcmV0dXJuIGFkZGVkKG5vZGUpIHx8IGFkZGVkU3VidHJlZShub2RlKTsKfQoKLy8gdXBncmFkZSBjdXN0b20gZWxlbWVudHMgYXQgbm9kZSwgaWYgYXBwbGljYWJsZQpmdW5jdGlvbiB1cGdyYWRlKG5vZGUpIHsKICBpZiAoIW5vZGUuX191cGdyYWRlZF9fICYmIG5vZGUubm9kZVR5cGUgPT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICB2YXIgdHlwZSA9IG5vZGUuZ2V0QXR0cmlidXRlKCdpcycpIHx8IG5vZGUubG9jYWxOYW1lOwogICAgdmFyIGRlZmluaXRpb24gPSBzY29wZS5yZWdpc3RyeVt0eXBlXTsKICAgIGlmIChkZWZpbml0aW9uKSB7CiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlOicsIG5vZGUubG9jYWxOYW1lKTsKICAgICAgc2NvcGUudXBncmFkZShub2RlKTsKICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBpbnNlcnRlZE5vZGUobm9kZSkgewogIGluc2VydGVkKG5vZGUpOwogIGlmIChpbkRvY3VtZW50KG5vZGUpKSB7CiAgICBmb3JTdWJ0cmVlKG5vZGUsIGZ1bmN0aW9uKGUpIHsKICAgICAgaW5zZXJ0ZWQoZSk7CiAgICB9KTsKICB9Cn0KCi8vIFRPRE8oc2ptaWxlcyk6IGlmIHRoZXJlIGFyZSBkZXNjZW50cyBpbnRvIHRyZWVzIHRoYXQgY2FuIG5ldmVyIGhhdmUgaW5Eb2N1bWVudCgqKSB0cnVlLCBmaXggdGhpcwoKZnVuY3Rpb24gaW5zZXJ0ZWQoZWxlbWVudCkgewogIC8vIFRPRE8oc2ptaWxlcyk6IGl0J3MgcG9zc2libGUgd2Ugd2VyZSBpbnNlcnRlZCBhbmQgcmVtb3ZlZCBpbiB0aGUgc3BhY2UKICAvLyBvZiBvbmUgbWljcm90YXNrLCBpbiB3aGljaCBjYXNlIHdlIHdvbid0IGJlICdpbkRvY3VtZW50JyBoZXJlCiAgLy8gQnV0IHRoZXJlIGFyZSBvdGhlciBjYXNlcyB3aGVyZSB3ZSBhcmUgdGVzdGluZyBmb3IgaW5zZXJ0ZWQgd2l0aG91dAogIC8vIHNwZWNpZmljIGtub3dsZWRnZSBvZiBtdXRhdGlvbnMsIGFuZCBtdXN0IHRlc3QgJ2luRG9jdW1lbnQnIHRvIGRldGVybWluZQogIC8vIHdoZXRoZXIgdG8gY2FsbCBpbnNlcnRlZAogIC8vIElmIHdlIGNhbiBmYWN0b3IgdGhlc2UgY2FzZXMgaW50byBzZXBhcmF0ZSBjb2RlIHBhdGhzIHdlIGNhbiBoYXZlCiAgLy8gYmV0dGVyIGRpYWdub3N0aWNzLgogIC8vIFRPRE8oc2ptaWxlcyk6IHdoZW4gbG9nZ2luZywgZG8gd29yayBvbiBhbGwgY3VzdG9tIGVsZW1lbnRzIHNvIHdlIGNhbgogIC8vIHRyYWNrIGJlaGF2aW9yIGV2ZW4gd2hlbiBjYWxsYmFja3Mgbm90IGRlZmluZWQKICAvL2NvbnNvbGUubG9nKCdpbnNlcnRlZDogJywgZWxlbWVudC5sb2NhbE5hbWUpOwogIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2sgfHwgKGVsZW1lbnQuX191cGdyYWRlZF9fICYmIGxvZ0ZsYWdzLmRvbSkpIHsKICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSk7CiAgICBpZiAoaW5Eb2N1bWVudChlbGVtZW50KSkgewogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApICsgMTsKICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ3JlbW92ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAnaW5zZXJ0ZWQnIHN0YXRlCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAxKSB7CiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMTsKICAgICAgfQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgaW5zZXJ0ZWQnLCBzcXVlbGNoIHRoZSBjYWxsYmFjawogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkID4gMSkgewogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLndhcm4oJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lLAogICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjaykgewogICAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOwogICAgICAgIGVsZW1lbnQuaW5zZXJ0ZWRDYWxsYmFjaygpOwogICAgICB9CiAgICB9CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwogIH0KfQoKZnVuY3Rpb24gcmVtb3ZlZE5vZGUobm9kZSkgewogIHJlbW92ZWQobm9kZSk7CiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICByZW1vdmVkKGUpOwogIH0pOwp9CgpmdW5jdGlvbiByZW1vdmVkKGVsZW1lbnQpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiB0ZW1wb3Jhcnk6IGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4gdHJhY2sKICAvLyBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkCiAgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3JlbW92ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOwogICAgaWYgKCFpbkRvY3VtZW50KGVsZW1lbnQpKSB7CiAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IChlbGVtZW50Ll9faW5zZXJ0ZWQgfHwgMCkgLSAxOwogICAgICAvLyBpZiB3ZSBhcmUgaW4gYSAnaW5zZXJ0ZWQnIHN0YXRlLCBibHVudGx5IGFkanVzdCB0byBhbiAncmVtb3ZlZCcgc3RhdGUKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDApIHsKICAgICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAwOwogICAgICB9CiAgICAgIC8vIGlmIHdlIGFyZSAnb3ZlciByZW1vdmVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA8IDApIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lLAogICAgICAgICAgICAnaW5zZXJ0L3JlbW92ZSBjb3VudDonLCBlbGVtZW50Ll9faW5zZXJ0ZWQpCiAgICAgIH0gZWxzZSBpZiAoZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2spIHsKICAgICAgICBlbGVtZW50LnJlbW92ZWRDYWxsYmFjaygpOwogICAgICB9CiAgICB9CiAgfQp9CgpmdW5jdGlvbiBpbkRvY3VtZW50KGVsZW1lbnQpIHsKICB2YXIgcCA9IGVsZW1lbnQ7CiAgd2hpbGUgKHApIHsKICAgIGlmIChwID09IGVsZW1lbnQub3duZXJEb2N1bWVudCkgewogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIHAgPSBwLnBhcmVudE5vZGUgfHwgcC5ob3N0OwogIH0KfQoKZnVuY3Rpb24gd2F0Y2hTaGFkb3cobm9kZSkgewogIGlmIChub2RlLndlYmtpdFNoYWRvd1Jvb3QgJiYgIW5vZGUud2Via2l0U2hhZG93Um9vdC5fX3dhdGNoZWQpIHsKICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmxvZygnd2F0Y2hpbmcgc2hhZG93LXJvb3QgZm9yOiAnLCBub2RlLmxvY2FsTmFtZSk7CiAgICBvYnNlcnZlKG5vZGUud2Via2l0U2hhZG93Um9vdCk7CiAgICBub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkID0gdHJ1ZTsKICB9Cn0KCmZ1bmN0aW9uIHdhdGNoQWxsU2hhZG93cyhub2RlKSB7CiAgd2F0Y2hTaGFkb3cobm9kZSk7CiAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICB3YXRjaFNoYWRvdyhub2RlKTsKICB9KTsKfQoKZnVuY3Rpb24gZmlsdGVyKGluTm9kZSkgewogIHN3aXRjaCAoaW5Ob2RlLmxvY2FsTmFtZSkgewogICAgY2FzZSAnc3R5bGUnOgogICAgY2FzZSAnc2NyaXB0JzoKICAgIGNhc2UgJ3RlbXBsYXRlJzoKICAgIGNhc2UgdW5kZWZpbmVkOgogICAgICByZXR1cm4gdHJ1ZTsKICB9Cn0KCmZ1bmN0aW9uIGhhbmRsZXIobXV0YXRpb25zKSB7CiAgLy8KICBpZiAobG9nRmxhZ3MuZG9tKSB7CiAgICB2YXIgbXggPSBtdXRhdGlvbnNbMF07CiAgICBpZiAobXggJiYgbXgudHlwZSA9PT0gJ2NoaWxkTGlzdCcgJiYgbXguYWRkZWROb2RlcykgewogICAgICAgIGlmIChteC5hZGRlZE5vZGVzKSB7CiAgICAgICAgICB2YXIgZCA9IG14LmFkZGVkTm9kZXNbMF07CiAgICAgICAgICB3aGlsZSAoZCAmJiBkICE9PSBkb2N1bWVudCAmJiAhZC5ob3N0KSB7CiAgICAgICAgICAgIGQgPSBkLnBhcmVudE5vZGU7CiAgICAgICAgICB9CiAgICAgICAgICB2YXIgdSA9IGQgJiYgKGQuVVJMIHx8IGQuX1VSTCB8fCAoZC5ob3N0ICYmIGQuaG9zdC5sb2NhbE5hbWUpKSB8fCAnJzsKICAgICAgICAgIHUgPSB1LnNwbGl0KCcvPycpLnNoaWZ0KCkuc3BsaXQoJy8nKS5wb3AoKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbnMgKCVkKSBbJXNdJywgbXV0YXRpb25zLmxlbmd0aCwgdSB8fCAnJyk7CiAgfQogIC8vCiAgbXV0YXRpb25zLmZvckVhY2goZnVuY3Rpb24obXgpIHsKICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXAoJ211dGF0aW9uJyk7CiAgICBpZiAobXgudHlwZSA9PT0gJ2NoaWxkTGlzdCcpIHsKICAgICAgZm9yRWFjaChteC5hZGRlZE5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOwogICAgICAgIGlmIChmaWx0ZXIobikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgLy8gd2F0Y2ggc2hhZG93LXJvb3RzIG9uIG5vZGVzIHRoYXQgaGF2ZSBoYWQgdGhlbSBhdHRhY2hlZCBtYW51YWxseQogICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlbW92ZSBpZiBjcmVhdGVTaGFkb3dSb290IGlzIG92ZXJyaWRkZW4KICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmVkIGFzIGFuIG9wdGltaXphdGlvbiwgbWFudWFsIHNoYWRvdyByb290cwogICAgICAgIC8vIG11c3QgYmUgd2F0Y2hlZCBleHBsaWNpdGx5CiAgICAgICAgLy93YXRjaEFsbFNoYWRvd3Mobik7CiAgICAgICAgLy8gbm9kZXMgYWRkZWQgbWF5IG5lZWQgbGlmZWN5Y2xlIG1hbmFnZW1lbnQKICAgICAgICBhZGRlZE5vZGUobik7CiAgICAgIH0pOwogICAgICAvLyByZW1vdmVkIG5vZGVzIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgICAgIGZvckVhY2gobXgucmVtb3ZlZE5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2cobi5sb2NhbE5hbWUpOwogICAgICAgIGlmIChmaWx0ZXIobikpIHsKICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgcmVtb3ZlZE5vZGUobik7CiAgICAgIH0pOwogICAgfQogICAgLy9sb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwogIH0pOwogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7Cn07Cgp2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihoYW5kbGVyKTsKCmZ1bmN0aW9uIHRha2VSZWNvcmRzKCkgewogIC8vIFRPRE8oc2ptaWxlcyk6IGFzayBSYWYgd2h5IHdlIGhhdmUgdG8gY2FsbCBoYW5kbGVyIG91cnNlbHZlcwogIGhhbmRsZXIob2JzZXJ2ZXIudGFrZVJlY29yZHMoKSk7Cn0KCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCmZ1bmN0aW9uIG9ic2VydmUoaW5Sb290KSB7CiAgb2JzZXJ2ZXIub2JzZXJ2ZShpblJvb3QsIHtjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWV9KTsKfQoKZnVuY3Rpb24gb2JzZXJ2ZURvY3VtZW50KGRvY3VtZW50KSB7CiAgb2JzZXJ2ZShkb2N1bWVudCk7Cn0KCmZ1bmN0aW9uIHVwZ3JhZGVEb2N1bWVudChkb2N1bWVudCkgewogIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCd1cGdyYWRlRG9jdW1lbnQ6ICcsIChkb2N1bWVudC5VUkwgfHwgZG9jdW1lbnQuX1VSTCB8fCAnJykuc3BsaXQoJy8nKS5wb3AoKSk7CiAgYWRkZWROb2RlKGRvY3VtZW50KTsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwp9CgovLyBleHBvcnRzCgpzY29wZS53YXRjaFNoYWRvdyA9IHdhdGNoU2hhZG93OwpzY29wZS53YXRjaEFsbFNoYWRvd3MgPSB3YXRjaEFsbFNoYWRvd3M7CgpzY29wZS51cGdyYWRlQWxsID0gYWRkZWROb2RlOwpzY29wZS51cGdyYWRlU3VidHJlZSA9IGFkZGVkU3VidHJlZTsKCnNjb3BlLm9ic2VydmVEb2N1bWVudCA9IG9ic2VydmVEb2N1bWVudDsKc2NvcGUudXBncmFkZURvY3VtZW50ID0gdXBncmFkZURvY3VtZW50OwoKc2NvcGUudGFrZVJlY29yZHMgPSB0YWtlUmVjb3JkczsKCn0pKHdpbmRvdy5DdXN0b21FbGVtZW50cyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgSFRNTEVsZW1lbnRFbGVtZW50ID0gZnVuY3Rpb24oaW5FbGVtZW50KSB7CiAgaW5FbGVtZW50LnJlZ2lzdGVyID0gSFRNTEVsZW1lbnRFbGVtZW50LnByb3RvdHlwZS5yZWdpc3RlcjsKICBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCk7CiAgcmV0dXJuIGluRWxlbWVudDsKfTsKCkhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUgPSB7CiAgcmVnaXN0ZXI6IGZ1bmN0aW9uKGluTW9yZSkgewogICAgaWYgKGluTW9yZSkgewogICAgICB0aGlzLm9wdGlvbnMubGlmZWN5Y2xlID0gaW5Nb3JlLmxpZmVjeWNsZTsKICAgICAgaWYgKGluTW9yZS5wcm90b3R5cGUpIHsKICAgICAgICBtaXhpbih0aGlzLm9wdGlvbnMucHJvdG90eXBlLCBpbk1vcmUucHJvdG90eXBlKTsKICAgICAgfQogICAgfQogIH0KfTsKCmZ1bmN0aW9uIHBhcnNlRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50KSB7CiAgLy8gb3B0aW9ucyB0byBnbGVhbiBmcm9tIGluRWxlbWVudCBhdHRyaWJ1dGVzCiAgdmFyIG9wdGlvbnMgPSB7CiAgICBuYW1lOiAnJywKICAgIGV4dGVuZHM6IG51bGwKICB9OwogIC8vIGdsZWFuIHRoZW0KICB0YWtlQXR0cmlidXRlcyhpbkVsZW1lbnQsIG9wdGlvbnMpOwogIC8vIGRlZmF1bHQgYmFzZQogIHZhciBiYXNlID0gSFRNTEVsZW1lbnQucHJvdG90eXBlOwogIC8vIG9wdGlvbmFsIHNwZWNpZmllZCBiYXNlCiAgaWYgKG9wdGlvbnMuZXh0ZW5kcykgewogICAgLy8gYnVpbGQgYW4gaW5zdGFuY2Ugb2Ygb3B0aW9ucy5leHRlbmRzCiAgICB2YXIgYXJjaGV0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zLmV4dGVuZHMpOwogICAgLy8gYWNxdWlyZSB0aGUgcHJvdG90eXBlCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBfX3Byb3RvX18gbWF5IGJlIGhpbnRlZCBieSB0aGUgY3VzdG9tIGVsZW1lbnQKICAgIC8vIHN5c3RlbSBvbiBwbGF0Zm9ybXMgdGhhdCBkb24ndCBzdXBwb3J0IG5hdGl2ZSBfX3Byb3RvX18KICAgIC8vIG9uIHRob3NlIHBsYXRmb3JtcyB0aGUgQVBJIGlzIG1peGVkIGludG8gYXJjaGV0eXBlIGFuZCB0aGUKICAgIC8vIGVmZmVjdGl2ZSBiYXNlIGlzIG5vdCBhcmNoZXR5cGUncyByZWFsIHByb3RvdHlwZQogICAgYmFzZSA9IGFyY2hldHlwZS5fX3Byb3RvX18gfHwgT2JqZWN0LmdldFByb3RvdHlwZU9mKGFyY2hldHlwZSk7CiAgfQogIC8vIGV4dGVuZCBiYXNlCiAgb3B0aW9ucy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKGJhc2UpOwogIC8vIGluc3RhbGwgb3B0aW9ucwogIGluRWxlbWVudC5vcHRpb25zID0gb3B0aW9uczsKICAvLyBsb2NhdGUgdXNlciBzY3JpcHQKICB2YXIgc2NyaXB0ID0gaW5FbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ3NjcmlwdDpub3QoW3R5cGVdKSxzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0sc2NyaXB0cycpOwogIGlmIChzY3JpcHQpIHsKICAgIC8vIGV4ZWN1dGUgdXNlciBzY3JpcHQgaW4gJ2luRWxlbWVudCcgY29udGV4dAogICAgZXhlY3V0ZUNvbXBvbmVudFNjcmlwdChzY3JpcHQudGV4dENvbnRlbnQsIGluRWxlbWVudCwgb3B0aW9ucy5uYW1lKTsKICB9OwogIC8vIHJlZ2lzdGVyIG91ciBuZXcgZWxlbWVudAogIHZhciBjdG9yID0gZG9jdW1lbnQucmVnaXN0ZXIob3B0aW9ucy5uYW1lLCBvcHRpb25zKTsKICBpbkVsZW1lbnQuY3RvciA9IGN0b3I7CiAgLy8gc3RvcmUgb3B0aW9uYWwgY29uc3RydWN0b3IgcmVmZXJlbmNlCiAgdmFyIHJlZk5hbWUgPSBpbkVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjb25zdHJ1Y3RvcicpOwogIGlmIChyZWZOYW1lKSB7CiAgICB3aW5kb3dbcmVmTmFtZV0gPSBjdG9yOwogIH0KfQoKLy8gZWFjaCBwcm9wZXJ0eSBpbiBpbkRpY3Rpb25hcnkgdGFrZXMgYSB2YWx1ZQovLyBmcm9tIHRoZSBtYXRjaGluZyBhdHRyaWJ1dGUgaW4gaW5FbGVtZW50LCBpZiBhbnkKZnVuY3Rpb24gdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBpbkRpY3Rpb25hcnkpIHsKICBmb3IgKHZhciBuIGluIGluRGljdGlvbmFyeSkgewogICAgdmFyIGEgPSBpbkVsZW1lbnQuYXR0cmlidXRlc1tuXTsKICAgIGlmIChhKSB7CiAgICAgIGluRGljdGlvbmFyeVtuXSA9IGEudmFsdWU7CiAgICB9CiAgfQp9CgovLyBpbnZva2UgaW5TY3JpcHQgaW4gaW5Db250ZXh0IHNjb3BlCmZ1bmN0aW9uIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoaW5TY3JpcHQsIGluQ29udGV4dCwgaW5OYW1lKSB7CiAgLy8gc2V0IChoaWdobGFuZGVyKSBjb250ZXh0CiAgY29udGV4dCA9IGluQ29udGV4dDsKICAvLyBzb3VyY2UgbG9jYXRpb24KICB2YXIgb3duZXIgPSBjb250ZXh0Lm93bmVyRG9jdW1lbnQ7CiAgdmFyIHVybCA9IChvd25lci5fVVJMIHx8IG93bmVyLlVSTCB8fCBvd25lci5pbXBsCiAgICAgICYmIChvd25lci5pbXBsLl9VUkwgfHwgb3duZXIuaW1wbC5VUkwpKTsKICAvLyBlbnN1cmUgdGhlIGNvbXBvbmVudCBoYXMgYSB1bmlxdWUgc291cmNlIG1hcCBzbyBpdCBjYW4gYmUgZGVidWdnZWQKICAvLyBpZiB0aGUgbmFtZSBtYXRjaGVzIHRoZSBmaWxlbmFtZSBwYXJ0IG9mIHRoZSBvd25pbmcgZG9jdW1lbnQncyB1cmwsCiAgLy8gdXNlIHRoaXMsIG90aGVyd2lzZSwgYWRkICI6PG5hbWU+IiB0byB0aGUgZG9jdW1lbnQgdXJsLgogIHZhciBtYXRjaCA9IHVybC5tYXRjaCgvLipcLyhbXi5dKilbLl0/LiokLyk7CiAgaWYgKG1hdGNoKSB7CiAgICB2YXIgbmFtZSA9IG1hdGNoWzFdOwogICAgdXJsICs9IG5hbWUgIT0gaW5OYW1lID8gJzonICsgaW5OYW1lIDogJyc7CiAgfQogIC8vIGNvbXBvc2Ugc2NyaXB0CiAgdmFyIGNvZGUgPSAiX19jb21wb25lbnRTY3JpcHQoJyIKICAgICsgaW5OYW1lCiAgICArICInLCBmdW5jdGlvbigpeyIKICAgICsgaW5TY3JpcHQKICAgICsgIn0pOyIKICAgICsgIlxuLy8jIHNvdXJjZVVSTD0iICsgdXJsICsgIlxuIgogIDsKICAvLyBpbmplY3Qgc2NyaXB0CiAgZXZhbChjb2RlKTsKfQoKdmFyIGNvbnRleHQ7CgovLyBnbG9iYWwgbmVjZXNzYXJ5IGZvciBzY3JpcHQgaW5qZWN0aW9uCndpbmRvdy5fX2NvbXBvbmVudFNjcmlwdCA9IGZ1bmN0aW9uKGluTmFtZSwgaW5GdW5jKSB7CiAgaW5GdW5jLmNhbGwoY29udGV4dCk7Cn07CgovLyB1dGlsaXR5CgovLyBjb3B5IHRvcCBsZXZlbCBwcm9wZXJ0aWVzIGZyb20gcHJvcHMgdG8gb2JqCmZ1bmN0aW9uIG1peGluKG9iaiwgcHJvcHMpIHsKICBvYmogPSBvYmogfHwge307CiAgdHJ5IHsKICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzKS5mb3JFYWNoKGZ1bmN0aW9uKG4pIHsKICAgICAgdmFyIHBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm9wcywgbik7CiAgICAgIGlmIChwZCkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShvYmosIG4sIHBkKTsKICAgICAgfQogICAgfSk7CiAgfSBjYXRjaCh4KSB7CiAgfQogIHJldHVybiBvYmo7Cn0KCi8vIGV4cG9ydHMKCndpbmRvdy5IVE1MRWxlbWVudEVsZW1lbnQgPSBIVE1MRWxlbWVudEVsZW1lbnQ7Cgp9KSgpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkhUTUxJbXBvcnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gaW1wb3J0cwoKdmFyIHhociA9IHNjb3BlLnhocjsKCi8vIGltcG9ydGVyCgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwp2YXIgU1RZTEVfTElOS19UWVBFID0gJ3N0eWxlc2hlZXQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgcmVwcmVzZW50cyBhIHByaW1hcnkgZG9jdW1lbnQgKHRoZSBhcmd1bWVudCB0byAnbG9hZCcpCi8vIGF0IHRoZSByb290IG9mIGEgdHJlZSBvZiBkb2N1bWVudHMKCi8vIGZvciBhbnkgZG9jdW1lbnQsIGltcG9ydGVyOgovLyAtIGxvYWRzIGFueSBsaW5rZWQgZG9jdW1lbnRzICh3aXRoIGRlZHVwaW5nKSwgbW9kaWZpZXMgcGF0aHMgYW5kIGZlZWRzIHRoZW0gYmFjayBpbnRvIGltcG9ydGVyCi8vIC0gbG9hZHMgdGV4dCBvZiBleHRlcm5hbCBzY3JpcHQgdGFncwovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc3R5bGUgdGFncyBpbnNpZGUgb2YgPGVsZW1lbnQ+LCBtb2RpZmllcyBwYXRocwoKLy8gd2hlbiBpbXBvcnRlciAnbW9kaWZpZXMgcGF0aHMnIGluIGEgZG9jdW1lbnQsIHRoaXMgaW5jbHVkZXMKLy8gLSBocmVmL3NyYy9hY3Rpb24gaW4gbm9kZSBhdHRyaWJ1dGVzCi8vIC0gcGF0aHMgaW4gaW5saW5lIHN0eWxlc2hlZXRzCi8vIC0gYWxsIGNvbnRlbnQgaW5zaWRlIHRlbXBsYXRlcwoKLy8gbGlua2VkIHN0eWxlIHNoZWV0cyBpbiBhbiBpbXBvcnQgaGF2ZSB0aGVpciBvd24gcGF0aCBmaXhlZCB1cCB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gPGVsZW1lbnQ+IGFyZSBsb2FkZWQsIGFuZCB0aGUgY29udGVudCBnZXRzIHBhdGggZml4dXBzCi8vIGlubGluZSBzdHlsZSBzaGVldHMgZ2V0IHBhdGggZml4dXBzIHdoZW4gdGhlaXIgY29udGFpbmluZyBpbXBvcnQgbW9kaWZpZXMgcGF0aHMKCnZhciBpbXBvcnRlciA9IHsKICBkb2N1bWVudHM6IHt9LAogIGNhY2hlOiB7fSwKICBwcmVsb2FkU2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnZWxlbWVudCBsaW5rW3JlbD0nICsgU1RZTEVfTElOS19UWVBFICsgJ10nLAogICAgJ3RlbXBsYXRlJywKICAgICdzY3JpcHRbc3JjXScsCiAgICAnc2NyaXB0Om5vdChbdHlwZV0pJywKICAgICdzY3JpcHRbdHlwZT0idGV4dC9qYXZhc2NyaXB0Il0nCiAgXS5qb2luKCcsJyksCiAgbG9hZGVyOiBmdW5jdGlvbihpbk5leHQpIHsKICAgIC8vIGNvbnN0cnVjdCBhIGxvYWRlciBpbnN0YW5jZQogICAgbG9hZGVyID0gbmV3IExvYWRlcihpbXBvcnRlci5sb2FkZWQsIGluTmV4dCk7CiAgICAvLyBhbGlhcyB0aGUgbG9hZGVyIGNhY2hlIChmb3IgZGVidWdnaW5nKQogICAgbG9hZGVyLmNhY2hlID0gaW1wb3J0ZXIuY2FjaGU7CiAgICByZXR1cm4gbG9hZGVyOwogIH0sCiAgbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCwgaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IGltcG9ydGVyLmxvYWRlcihpbk5leHQpOwogICAgLy8gYWRkIG5vZGVzIGZyb20gZG9jdW1lbnQgaW50byBsb2FkZXIgcXVldWUKICAgIGltcG9ydGVyLnByZWxvYWQoaW5Eb2N1bWVudCk7CiAgfSwKICBwcmVsb2FkOiBmdW5jdGlvbihpbkRvY3VtZW50KSB7CiAgICAvLyBhbGwgcHJlbG9hZGFibGUgbm9kZXMgaW4gaW5Eb2N1bWVudAogICAgdmFyIG5vZGVzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydGVyLnByZWxvYWRTZWxlY3RvcnMpOwogICAgLy8gZnJvbSB0aGUgbWFpbiBkb2N1bWVudCwgb25seSBsb2FkIGltcG9ydHMKICAgIC8vIFRPRE8oc2ptaWxlcyk6IGRvIHRoaXMgYnkgYWx0ZXJpbmcgdGhlIHNlbGVjdG9yIGxpc3QgaW5zdGVhZAogICAgbm9kZXMgPSB0aGlzLmZpbHRlck1haW5Eb2N1bWVudE5vZGVzKGluRG9jdW1lbnQsIG5vZGVzKTsKICAgIC8vIGV4dHJhIGxpbmsgbm9kZXMgZnJvbSB0ZW1wbGF0ZXMsIGZpbHRlciB0ZW1wbGF0ZXMgb3V0IG9mIHRoZSBub2RlcyBsaXN0CiAgICBub2RlcyA9IHRoaXMuZXh0cmFjdFRlbXBsYXRlTm9kZXMobm9kZXMpOwogICAgLy8gYWRkIHRoZXNlIG5vZGVzIHRvIGxvYWRlcidzIHF1ZXVlCiAgICBsb2FkZXIuYWRkTm9kZXMobm9kZXMpOwogIH0sCiAgZmlsdGVyTWFpbkRvY3VtZW50Tm9kZXM6IGZ1bmN0aW9uKGluRG9jdW1lbnQsIG5vZGVzKSB7CiAgICBpZiAoaW5Eb2N1bWVudCA9PT0gZG9jdW1lbnQpIHsKICAgICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICByZXR1cm4gIWlzU2NyaXB0KG4pOwogICAgICB9KTsKICAgIH0KICAgIHJldHVybiBub2RlczsKICB9LAogIGV4dHJhY3RUZW1wbGF0ZU5vZGVzOiBmdW5jdGlvbihub2RlcykgewogICAgdmFyIGV4dHJhID0gW107CiAgICBub2RlcyA9IEFycmF5LnByb3RvdHlwZS5maWx0ZXIuY2FsbChub2RlcywgZnVuY3Rpb24obikgewogICAgICBpZiAobi5sb2NhbE5hbWUgPT09ICd0ZW1wbGF0ZScpIHsKICAgICAgICBpZiAobi5jb250ZW50KSB7CiAgICAgICAgICB2YXIgbCQgPSBuLmNvbnRlbnQucXVlcnlTZWxlY3RvckFsbCgnbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArCiAgICAgICAgICAgICddJyk7CiAgICAgICAgICBpZiAobCQubGVuZ3RoKSB7CiAgICAgICAgICAgIGV4dHJhID0gZXh0cmEuY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGwkLCAwKSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwogICAgaWYgKGV4dHJhLmxlbmd0aCkgewogICAgICBub2RlcyA9IG5vZGVzLmNvbmNhdChleHRyYSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBsb2FkZWQ6IGZ1bmN0aW9uKHVybCwgZWx0LCByZXNvdXJjZSkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGVsdCkpIHsKICAgICAgdmFyIGRvY3VtZW50ID0gaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF07CiAgICAgIC8vIGlmIHdlJ3ZlIG5ldmVyIHNlZW4gYSBkb2N1bWVudCBhdCB0aGlzIHVybAogICAgICBpZiAoIWRvY3VtZW50KSB7CiAgICAgICAgLy8gZ2VuZXJhdGUgYW4gSFRNTERvY3VtZW50IGZyb20gZGF0YQogICAgICAgIGRvY3VtZW50ID0gbWFrZURvY3VtZW50KHJlc291cmNlLCB1cmwpOwogICAgICAgIC8vIHJlc29sdmUgcmVzb3VyY2UgcGF0aHMgcmVsYXRpdmUgdG8gaG9zdCBkb2N1bWVudAogICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKGRvY3VtZW50LmJvZHkpOwogICAgICAgIC8vIGNhY2hlIGRvY3VtZW50CiAgICAgICAgaW1wb3J0ZXIuZG9jdW1lbnRzW3VybF0gPSBkb2N1bWVudDsKICAgICAgICAvLyBhZGQgbm9kZXMgZnJvbSB0aGlzIGRvY3VtZW50IHRvIHRoZSBsb2FkZXIgcXVldWUKICAgICAgICBpbXBvcnRlci5wcmVsb2FkKGRvY3VtZW50KTsKICAgICAgfQogICAgICAvLyBzdG9yZSBpbXBvcnQgcmVjb3JkCiAgICAgIGVsdC5pbXBvcnQgPSB7CiAgICAgICAgaHJlZjogdXJsLAogICAgICAgIG93bmVyTm9kZTogZWx0LAogICAgICAgIGNvbnRlbnQ6IGRvY3VtZW50CiAgICAgIH07CiAgICAgIC8vIHN0b3JlIGRvY3VtZW50IHJlc291cmNlCiAgICAgIGVsdC5jb250ZW50ID0gcmVzb3VyY2UgPSBkb2N1bWVudDsKICAgIH0KICAgIC8vIHN0b3JlIGdlbmVyaWMgcmVzb3VyY2UKICAgIC8vIFRPRE8oc29ydmVsbCk6IGZhaWxzIGZvciBub2RlcyBpbnNpZGUgPHRlbXBsYXRlPi5jb250ZW50CiAgICAvLyBzZWUgaHR0cHM6Ly9jb2RlLmdvb2dsZS5jb20vcC9jaHJvbWl1bS9pc3N1ZXMvZGV0YWlsP2lkPTI0OTM4MS4KICAgIGVsdC5fX3Jlc291cmNlID0gcmVzb3VyY2U7CiAgICAvLyBjc3MgcGF0aCBmaXh1cHMKICAgIGlmIChpc1N0eWxlc2hlZXRMaW5rKGVsdCkpIHsKICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQoZWx0KTsKICAgIH0KICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhlbHQpIHsKICByZXR1cm4gaXNMaW5rUmVsKGVsdCwgSU1QT1JUX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzU3R5bGVzaGVldExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIFNUWUxFX0xJTktfVFlQRSk7Cn0KCmZ1bmN0aW9uIGlzTGlua1JlbChlbHQsIHJlbCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnbGluaycgJiYgZWx0LmdldEF0dHJpYnV0ZSgncmVsJykgPT09IHJlbDsKfQoKZnVuY3Rpb24gaXNTY3JpcHQoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdzY3JpcHQnOwp9CgpmdW5jdGlvbiBtYWtlRG9jdW1lbnQoaW5IVE1MLCBpblVybCkgewogIC8vIGNyZWF0ZSBhIG5ldyBIVE1MIGRvY3VtZW50CiAgdmFyIGRvYyA9IGRvY3VtZW50LmltcGxlbWVudGF0aW9uLmNyZWF0ZUhUTUxEb2N1bWVudChJTVBPUlRfTElOS19UWVBFKTsKICAvLyBjYWNoZSB0aGUgbmV3IGRvY3VtZW50J3Mgc291cmNlIHVybAogIGRvYy5fVVJMID0gaW5Vcmw7CiAgLy8gZXN0YWJsaXNoIGEgcmVsYXRpdmUgcGF0aCB2aWEgPGJhc2U+CiAgdmFyIGJhc2UgPSBkb2MuY3JlYXRlRWxlbWVudCgnYmFzZScpOwogIGJhc2Uuc2V0QXR0cmlidXRlKCdocmVmJywgZG9jdW1lbnQuYmFzZVVSSSk7CiAgZG9jLmhlYWQuYXBwZW5kQ2hpbGQoYmFzZSk7CiAgLy8gaW5zdGFsbCBodG1sCiAgZG9jLmJvZHkuaW5uZXJIVE1MID0gaW5IVE1MOwogIC8vIFRPRE8oc29ydmVsbCk6IE1EViBQb2x5ZmlsbCBpbnRydXNpb246IGJvb3N0cmFwIHRlbXBsYXRlIHBvbHlmaWxsCiAgaWYgKHdpbmRvdy5IVE1MVGVtcGxhdGVFbGVtZW50ICYmIEhUTUxUZW1wbGF0ZUVsZW1lbnQuYm9vdHN0cmFwKSB7CiAgICBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcChkb2MpOwogIH0KICByZXR1cm4gZG9jOwp9Cgp2YXIgbG9hZGVyOwoKdmFyIExvYWRlciA9IGZ1bmN0aW9uKGluT25Mb2FkLCBpbk9uQ29tcGxldGUpIHsKICB0aGlzLm9ubG9hZCA9IGluT25Mb2FkOwogIHRoaXMub25jb21wbGV0ZSA9IGluT25Db21wbGV0ZTsKICB0aGlzLmluZmxpZ2h0ID0gMDsKICB0aGlzLnBlbmRpbmcgPSB7fTsKICB0aGlzLmNhY2hlID0ge307Cn07CgpMb2FkZXIucHJvdG90eXBlID0gewogIGFkZE5vZGVzOiBmdW5jdGlvbihpbk5vZGVzKSB7CiAgICAvLyBudW1iZXIgb2YgdHJhbnNhY3Rpb25zIHRvIGNvbXBsZXRlCiAgICB0aGlzLmluZmxpZ2h0ICs9IGluTm9kZXMubGVuZ3RoOwogICAgLy8gY29tbWVuY2UgdHJhbnNhY3Rpb25zCiAgICBmb3JFYWNoKGluTm9kZXMsIHRoaXMucmVxdWlyZSwgdGhpcyk7CiAgICAvLyBhbnl0aGluZyB0byBkbz8KICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICByZXF1aXJlOiBmdW5jdGlvbihpbkVsdCkgewogICAgdmFyIHVybCA9IHBhdGgubm9kZVVybChpbkVsdCk7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBhZC1ob2MKICAgIGluRWx0Ll9fbm9kZVVybCA9IHVybDsKICAgIC8vIGRlZHVwbGljYXRpb24KICAgIGlmICghdGhpcy5kZWR1cGUodXJsLCBpbkVsdCkpIHsKICAgICAgLy8gZmV0Y2ggdGhpcyByZXNvdXJjZQogICAgICB0aGlzLmZldGNoKHVybCwgaW5FbHQpOwogICAgfQogIH0sCiAgZGVkdXBlOiBmdW5jdGlvbihpblVybCwgaW5FbHQpIHsKICAgIGlmICh0aGlzLnBlbmRpbmdbaW5VcmxdKSB7CiAgICAgIC8vIGFkZCB0byBsaXN0IG9mIG5vZGVzIHdhaXRpbmcgZm9yIGluVXJsCiAgICAgIHRoaXMucGVuZGluZ1tpblVybF0ucHVzaChpbkVsdCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5jYWNoZVtpblVybF0pIHsKICAgICAgLy8gY29tcGxldGUgbG9hZCB1c2luZyBjYWNoZSBkYXRhCiAgICAgIHRoaXMub25sb2FkKGluVXJsLCBpbkVsdCwgbG9hZGVyLmNhY2hlW2luVXJsXSk7CiAgICAgIC8vIGZpbmlzaGVkIHRoaXMgdHJhbnNhY3Rpb24KICAgICAgdGhpcy50YWlsKCk7CiAgICAgIC8vIGRvbid0IG5lZWQgZmV0Y2gKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICAvLyBmaXJzdCBub2RlIHdhaXRpbmcgZm9yIGluVXJsCiAgICB0aGlzLnBlbmRpbmdbaW5VcmxdID0gW2luRWx0XTsKICAgIC8vIG5lZWQgZmV0Y2ggKG5vdCBhIGR1cGUpCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKICBmZXRjaDogZnVuY3Rpb24odXJsLCBlbHQpIHsKICAgIHZhciByZWNlaXZlWGhyID0gZnVuY3Rpb24oZXJyLCByZXNvdXJjZSkgewogICAgICB0aGlzLnJlY2VpdmUodXJsLCBlbHQsIGVyciwgcmVzb3VyY2UpOwogICAgfS5iaW5kKHRoaXMpOwogICAgeGhyLmxvYWQodXJsLCByZWNlaXZlWGhyKTsKICB9LAogIHJlY2VpdmU6IGZ1bmN0aW9uKGluVXJsLCBpbkVsdCwgaW5FcnIsIGluUmVzb3VyY2UpIHsKICAgIGlmICghaW5FcnIpIHsKICAgICAgbG9hZGVyLmNhY2hlW2luVXJsXSA9IGluUmVzb3VyY2U7CiAgICB9CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0uZm9yRWFjaChmdW5jdGlvbihlKSB7CiAgICAgIGlmICghaW5FcnIpIHsKICAgICAgICB0aGlzLm9ubG9hZChpblVybCwgZSwgaW5SZXNvdXJjZSk7CiAgICAgIH0KICAgICAgdGhpcy50YWlsKCk7CiAgICB9LCB0aGlzKTsKICAgIGxvYWRlci5wZW5kaW5nW2luVXJsXSA9IG51bGw7CiAgfSwKICB0YWlsOiBmdW5jdGlvbigpIHsKICAgIC0tdGhpcy5pbmZsaWdodDsKICAgIHRoaXMuY2hlY2tEb25lKCk7CiAgfSwKICBjaGVja0RvbmU6IGZ1bmN0aW9uKCkgewogICAgaWYgKCF0aGlzLmluZmxpZ2h0KSB7CiAgICAgIHRoaXMub25jb21wbGV0ZSgpOwogICAgfQogIH0KfTsKCnZhciBVUkxfQVRUUlMgPSBbJ2hyZWYnLCAnc3JjJywgJ2FjdGlvbiddOwp2YXIgVVJMX0FUVFJTX1NFTEVDVE9SID0gJ1snICsgVVJMX0FUVFJTLmpvaW4oJ10sWycpICsgJ10nOwp2YXIgVVJMX1RFTVBMQVRFX1NFQVJDSCA9ICd7ey4qfX0nOwoKdmFyIHBhdGggPSB7CiAgbm9kZVVybDogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5yZXNvbHZlVXJsKHBhdGguZ2V0RG9jdW1lbnRVcmwoZG9jdW1lbnQpLCBwYXRoLmhyZWZPclNyYyhpbk5vZGUpKTsKICB9LAogIGhyZWZPclNyYzogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gaW5Ob2RlLmdldEF0dHJpYnV0ZSgiaHJlZiIpIHx8IGluTm9kZS5nZXRBdHRyaWJ1dGUoInNyYyIpOwogIH0sCiAgZG9jdW1lbnRVcmxGcm9tTm9kZTogZnVuY3Rpb24oaW5Ob2RlKSB7CiAgICByZXR1cm4gcGF0aC5nZXREb2N1bWVudFVybChpbk5vZGUub3duZXJEb2N1bWVudCk7CiAgfSwKICBnZXREb2N1bWVudFVybDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgdmFyIHVybCA9IGluRG9jdW1lbnQgJiYKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgICAgICAoaW5Eb2N1bWVudC5fVVJMIHx8IChpbkRvY3VtZW50LmltcGwgJiYgaW5Eb2N1bWVudC5pbXBsLl9VUkwpCiAgICAgICAgICAgIHx8IGluRG9jdW1lbnQuYmFzZVVSSSB8fCBpbkRvY3VtZW50LlVSTCkKICAgICAgICAgICAgICAgIHx8ICcnOwogICAgLy8gdGFrZSBvbmx5IHRoZSBsZWZ0IHNpZGUgaWYgdGhlcmUgaXMgYSAjCiAgICByZXR1cm4gdXJsLnNwbGl0KCcjJylbMF07CiAgfSwKICByZXNvbHZlVXJsOiBmdW5jdGlvbihpbkJhc2VVcmwsIGluVXJsLCBpblJlbGF0aXZlVG9Eb2N1bWVudCkgewogICAgaWYgKHRoaXMuaXNBYnNVcmwoaW5VcmwpKSB7CiAgICAgIHJldHVybiBpblVybDsKICAgIH0KICAgIHZhciB1cmwgPSB0aGlzLmNvbXByZXNzVXJsKHRoaXMudXJsVG9QYXRoKGluQmFzZVVybCkgKyBpblVybCk7CiAgICBpZiAoaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgICAgdXJsID0gcGF0aC5tYWtlUmVsUGF0aChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgdXJsKTsKICAgIH0KICAgIHJldHVybiB1cmw7CiAgfSwKICBpc0Fic1VybDogZnVuY3Rpb24oaW5VcmwpIHsKICAgIHJldHVybiAvKF5kYXRhOil8KF5odHRwW3NdPzopfCheXC8pLy50ZXN0KGluVXJsKTsKICB9LAogIHVybFRvUGF0aDogZnVuY3Rpb24oaW5CYXNlVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpbkJhc2VVcmwuc3BsaXQoIi8iKTsKICAgIHBhcnRzLnBvcCgpOwogICAgcGFydHMucHVzaCgnJyk7CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgY29tcHJlc3NVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICB2YXIgcGFydHMgPSBpblVybC5zcGxpdCgiLyIpOwogICAgZm9yICh2YXIgaT0wLCBwOyBpPHBhcnRzLmxlbmd0aDsgaSsrKSB7CiAgICAgIHAgPSBwYXJ0c1tpXTsKICAgICAgaWYgKHAgPT09ICIuLiIpIHsKICAgICAgICBwYXJ0cy5zcGxpY2UoaS0xLCAyKTsKICAgICAgICBpIC09IDI7CiAgICAgIH0KICAgIH0KICAgIHJldHVybiBwYXJ0cy5qb2luKCIvIik7CiAgfSwKICAvLyBtYWtlIGEgcmVsYXRpdmUgcGF0aCBmcm9tIHNvdXJjZSB0byB0YXJnZXQKICBtYWtlUmVsUGF0aDogZnVuY3Rpb24oaW5Tb3VyY2UsIGluVGFyZ2V0KSB7CiAgICB2YXIgcywgdDsKICAgIHMgPSB0aGlzLmNvbXByZXNzVXJsKGluU291cmNlKS5zcGxpdCgiLyIpOwogICAgdCA9IHRoaXMuY29tcHJlc3NVcmwoaW5UYXJnZXQpLnNwbGl0KCIvIik7CiAgICB3aGlsZSAocy5sZW5ndGggJiYgc1swXSA9PT0gdFswXSl7CiAgICAgIHMuc2hpZnQoKTsKICAgICAgdC5zaGlmdCgpOwogICAgfQogICAgZm9yKHZhciBpID0gMCwgbCA9IHMubGVuZ3RoLTE7IGkgPCBsOyBpKyspIHsKICAgICAgdC51bnNoaWZ0KCIuLiIpOwogICAgfQogICAgdmFyIHIgPSB0LmpvaW4oIi8iKTsKICAgIHJldHVybiByOwogIH0sCiAgcmVzb2x2ZVBhdGhzSW5IVE1MOiBmdW5jdGlvbihyb290LCB1cmwpIHsKICAgIHVybCA9IHVybCB8fCBwYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUocm9vdCkKICAgIHBhdGgucmVzb2x2ZUF0dHJpYnV0ZXMocm9vdCwgdXJsKTsKICAgIHBhdGgucmVzb2x2ZVN0eWxlRWx0cyhyb290LCB1cmwpOwogICAgLy8gaGFuZGxlIHRlbXBsYXRlLmNvbnRlbnQKICAgIHZhciB0ZW1wbGF0ZXMgPSByb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3RlbXBsYXRlJyk7CiAgICBpZiAodGVtcGxhdGVzKSB7CiAgICAgIGZvckVhY2godGVtcGxhdGVzLCBmdW5jdGlvbih0KSB7CiAgICAgICAgaWYgKHQuY29udGVudCkgewogICAgICAgICAgcGF0aC5yZXNvbHZlUGF0aHNJbkhUTUwodC5jb250ZW50LCB1cmwpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9CiAgfSwKICByZXNvbHZlUGF0aHNJblN0eWxlc2hlZXQ6IGZ1bmN0aW9uKGluU2hlZXQpIHsKICAgIHZhciBkb2NVcmwgPSBwYXRoLm5vZGVVcmwoaW5TaGVldCk7CiAgICBpblNoZWV0Ll9fcmVzb3VyY2UgPSBwYXRoLnJlc29sdmVDc3NUZXh0KGluU2hlZXQuX19yZXNvdXJjZSwgZG9jVXJsKTsKICB9LAogIHJlc29sdmVTdHlsZUVsdHM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIHZhciBzdHlsZXMgPSBpblJvb3QucXVlcnlTZWxlY3RvckFsbCgnc3R5bGUnKTsKICAgIGlmIChzdHlsZXMpIHsKICAgICAgZm9yRWFjaChzdHlsZXMsIGZ1bmN0aW9uKHN0eWxlKSB7CiAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBwYXRoLnJlc29sdmVDc3NUZXh0KHN0eWxlLnRleHRDb250ZW50LCBpblVybCk7CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZUNzc1RleHQ6IGZ1bmN0aW9uKGluQ3NzVGV4dCwgaW5CYXNlVXJsKSB7CiAgICByZXR1cm4gaW5Dc3NUZXh0LnJlcGxhY2UoL3VybFwoW14pXSpcKS9nLCBmdW5jdGlvbihpbk1hdGNoKSB7CiAgICAgIC8vIGZpbmQgdGhlIHVybCBwYXRoLCBpZ25vcmUgcXVvdGVzIGluIHVybCBzdHJpbmcKICAgICAgdmFyIHVybFBhdGggPSBpbk1hdGNoLnJlcGxhY2UoL1siJ10vZywgIiIpLnNsaWNlKDQsIC0xKTsKICAgICAgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpbkJhc2VVcmwsIHVybFBhdGgsIHRydWUpOwogICAgICByZXR1cm4gInVybCgiICsgdXJsUGF0aCArICIpIjsKICAgIH0pOwogIH0sCiAgcmVzb2x2ZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluUm9vdCwgaW5VcmwpIHsKICAgIC8vIHNlYXJjaCBmb3IgYXR0cmlidXRlcyB0aGF0IGhvc3QgdXJscwogICAgdmFyIG5vZGVzID0gaW5Sb290ICYmIGluUm9vdC5xdWVyeVNlbGVjdG9yQWxsKFVSTF9BVFRSU19TRUxFQ1RPUik7CiAgICBpZiAobm9kZXMpIHsKICAgICAgZm9yRWFjaChub2RlcywgZnVuY3Rpb24obikgewogICAgICAgIHRoaXMucmVzb2x2ZU5vZGVBdHRyaWJ1dGVzKG4sIGluVXJsKTsKICAgICAgfSwgdGhpcyk7CiAgICB9CiAgfSwKICByZXNvbHZlTm9kZUF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGluTm9kZSwgaW5VcmwpIHsKICAgIFVSTF9BVFRSUy5mb3JFYWNoKGZ1bmN0aW9uKHYpIHsKICAgICAgdmFyIGF0dHIgPSBpbk5vZGUuYXR0cmlidXRlc1t2XTsKICAgICAgaWYgKGF0dHIgJiYgYXR0ci52YWx1ZSAmJgogICAgICAgICAoYXR0ci52YWx1ZS5zZWFyY2goVVJMX1RFTVBMQVRFX1NFQVJDSCkgPCAwKSkgewogICAgICAgIHZhciB1cmxQYXRoID0gcGF0aC5yZXNvbHZlVXJsKGluVXJsLCBhdHRyLnZhbHVlLCB0cnVlKTsKICAgICAgICBhdHRyLnZhbHVlID0gdXJsUGF0aDsKICAgICAgfQogICAgfSk7CiAgfQp9OwoKeGhyID0geGhyIHx8IHsKICBhc3luYzogdHJ1ZSwKICBvazogZnVuY3Rpb24oaW5SZXF1ZXN0KSB7CiAgICByZXR1cm4gKGluUmVxdWVzdC5zdGF0dXMgPj0gMjAwICYmIGluUmVxdWVzdC5zdGF0dXMgPCAzMDApCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDMwNCkKICAgICAgICB8fCAoaW5SZXF1ZXN0LnN0YXR1cyA9PT0gMCk7CiAgfSwKICBsb2FkOiBmdW5jdGlvbih1cmwsIG5leHQsIG5leHRDb250ZXh0KSB7CiAgICB2YXIgcmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaWYgKHNjb3BlLmZsYWdzLmRlYnVnIHx8IHNjb3BlLmZsYWdzLmJ1c3QpIHsKICAgICAgdXJsICs9ICc/JyArIE1hdGgucmFuZG9tKCk7CiAgICB9CiAgICByZXF1ZXN0Lm9wZW4oJ0dFVCcsIHVybCwgeGhyLmFzeW5jKTsKICAgIHJlcXVlc3QuYWRkRXZlbnRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKHJlcXVlc3QucmVhZHlTdGF0ZSA9PT0gNCkgewogICAgICAgIG5leHQuY2FsbChuZXh0Q29udGV4dCwgIXhoci5vayhyZXF1ZXN0KSAmJiByZXF1ZXN0LAogICAgICAgICAgcmVxdWVzdC5yZXNwb25zZSwgdXJsKTsKICAgICAgfQogICAgfSk7CiAgICByZXF1ZXN0LnNlbmQoKTsKICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgovLyBleHBvcnRzCgpzY29wZS5wYXRoID0gcGF0aDsKc2NvcGUueGhyID0geGhyOwpzY29wZS5pbXBvcnRlciA9IGltcG9ydGVyOwpzY29wZS5nZXREb2N1bWVudFVybCA9IHBhdGguZ2V0RG9jdW1lbnRVcmw7CnNjb3BlLklNUE9SVF9MSU5LX1RZUEUgPSBJTVBPUlRfTElOS19UWVBFOwoKfSkod2luZG93LkhUTUxJbXBvcnRzKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCnZhciBJTVBPUlRfTElOS19UWVBFID0gJ2ltcG9ydCc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBpbXBvcnRQYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnbGlua1tyZWw9c3R5bGVzaGVldF0nLAogICAgJ3N0eWxlJywKICAgICdzY3JpcHQnCiAgXSwKICBtYXA6IHsKICAgIGxpbms6ICdwYXJzZUxpbmsnLAogICAgc2NyaXB0OiAncGFyc2VTY3JpcHQnLAogICAgc3R5bGU6ICdwYXJzZUdlbmVyaWMnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9faW1wb3J0UGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKGltcG9ydFBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBpbXBvcnRQYXJzZXJbaW1wb3J0UGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgIH0KICB9LAogIHBhcnNlTGluazogZnVuY3Rpb24obGlua0VsdCkgewogICAgaWYgKGlzRG9jdW1lbnRMaW5rKGxpbmtFbHQpKSB7CiAgICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgICBpbXBvcnRQYXJzZXIucGFyc2UobGlua0VsdC5jb250ZW50KTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgdGhpcy5wYXJzZUdlbmVyaWMobGlua0VsdCk7CiAgICB9CiAgfSwKICBwYXJzZUdlbmVyaWM6IGZ1bmN0aW9uKGVsdCkgewogICAgaWYgKG5lZWRzTWFpbkRvY3VtZW50Q29udGV4dChlbHQpKSB7CiAgICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoZWx0KTsKICAgIH0KICB9LAogIHBhcnNlU2NyaXB0OiBmdW5jdGlvbihzY3JpcHRFbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoc2NyaXB0RWx0KSkgewogICAgICAvLyBhY3F1aXJlIGNvZGUgdG8gZXhlY3V0ZQogICAgICB2YXIgY29kZSA9IChzY3JpcHRFbHQuX19yZXNvdXJjZSB8fCBzY3JpcHRFbHQudGV4dENvbnRlbnQpLnRyaW0oKTsKICAgICAgaWYgKGNvZGUpIHsKICAgICAgICAvLyBjYWxjdWxhdGUgc291cmNlIG1hcCBoaW50CiAgICAgICAgdmFyIG1vbmlrZXIgPSBzY3JpcHRFbHQuX19ub2RlVXJsOwogICAgICAgIGlmICghbW9uaWtlcikgewogICAgICAgICAgdmFyIG1vbmlrZXIgPSBzY29wZS5wYXRoLmRvY3VtZW50VXJsRnJvbU5vZGUoc2NyaXB0RWx0KTsKICAgICAgICAgIC8vIHRoZXJlIGNvdWxkIGJlIG1vcmUgdGhhbiBvbmUgc2NyaXB0IHRoaXMgdXJsCiAgICAgICAgICB2YXIgdGFnID0gJ1snICsgTWF0aC5mbG9vcigoTWF0aC5yYW5kb20oKSsxKSoxMDAwKSArICddJzsKICAgICAgICAgIC8vIFRPRE8oc2ptaWxlcyk6IFBvbHltZXIgaGFjaywgc2hvdWxkIGJlIHBsdWdnYWJsZSBpZiB3ZSBuZWVkIHRvIGFsbG93CiAgICAgICAgICAvLyB0aGlzIHNvcnQgb2YgdGhpbmcKICAgICAgICAgIHZhciBtYXRjaGVzID0gY29kZS5tYXRjaCgvUG9seW1lclwoWyciXShbXiciXSopLyk7CiAgICAgICAgICB0YWcgPSBtYXRjaGVzICYmIG1hdGNoZXNbMV0gfHwgdGFnOwogICAgICAgICAgLy8gdGFnIHRoZSBtb25pa2VyCiAgICAgICAgICBtb25pa2VyICs9ICcvJyArIHRhZyArICcuanMnOwogICAgICAgIH0KICAgICAgICAvLyBzb3VyY2UgbWFwIGhpbnQKICAgICAgICBjb2RlICs9ICJcbi8vIyBzb3VyY2VVUkw9IiArIG1vbmlrZXIgKyAiXG4iOwogICAgICAgIC8vIGV2YWx1YXRlIHRoZSBjb2RlCiAgICAgICAgZXZhbC5jYWxsKHdpbmRvdywgY29kZSk7CiAgICAgIH0KICAgIH0KICB9Cn07Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhlbHQpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnCiAgICAgICYmIGVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFOwp9CgpmdW5jdGlvbiBuZWVkc01haW5Eb2N1bWVudENvbnRleHQobm9kZSkgewogIC8vIG5vZGVzIGNhbiBiZSBtb3ZlZCB0byB0aGUgbWFpbiBkb2N1bWVudDoKICAvLyBpZiB0aGV5IGFyZSBpbiBhIHRyZWUgYnV0IG5vdCBpbiB0aGUgbWFpbiBkb2N1bWVudCBhbmQgbm90IGNoaWxkcmVuIG9mIDxlbGVtZW50PgogIHJldHVybiBub2RlLnBhcmVudE5vZGUgJiYgIWluTWFpbkRvY3VtZW50KG5vZGUpCiAgICAgICYmICFpc0VsZW1lbnRFbGVtZW50Q2hpbGQobm9kZSk7Cn0KCmZ1bmN0aW9uIGluTWFpbkRvY3VtZW50KGVsdCkgewogIHJldHVybiBlbHQub3duZXJEb2N1bWVudCA9PT0gZG9jdW1lbnQgfHwKICAgIC8vIFRPRE8oc2ptaWxlcyk6IFNoYWRvd0RPTVBvbHlmaWxsIGludHJ1c2lvbgogICAgZWx0Lm93bmVyRG9jdW1lbnQuaW1wbCA9PT0gZG9jdW1lbnQ7Cn0KCmZ1bmN0aW9uIGlzRWxlbWVudEVsZW1lbnRDaGlsZChlbHQpIHsKICByZXR1cm4gZWx0LnBhcmVudE5vZGUgJiYgZWx0LnBhcmVudE5vZGUubG9jYWxOYW1lID09PSAnZWxlbWVudCc7Cn0KCi8vIGV4cG9ydHMKCnNjb3BlLnBhcnNlciA9IGltcG9ydFBhcnNlcjsKCn0pKEhUTUxJbXBvcnRzKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAKCi8vIElFIHNoaW0gZm9yIEN1c3RvbUV2ZW50CmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIHByZWxvYWQgZG9jdW1lbnQgcmVzb3VyY2UgdHJlZXMKICBIVE1MSW1wb3J0cy5pbXBvcnRlci5sb2FkKGRvY3VtZW50LCBmdW5jdGlvbigpIHsKICAgIEhUTUxJbXBvcnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICBIVE1MSW1wb3J0cy5yZWFkeVRpbWUgPSBuZXcgRGF0ZSgpLmdldFRpbWUoKTsKICAgIC8vIHNlbmQgSFRNTEltcG9ydHNMb2FkZWQgd2hlbiBmaW5pc2hlZAogICAgZG9jdW1lbnQuZGlzcGF0Y2hFdmVudCgKICAgICAgbmV3IEN1c3RvbUV2ZW50KCdIVE1MSW1wb3J0c0xvYWRlZCcsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSk7Cn07CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oKSB7CgovLyBpbXBvcnQKCnZhciBJTVBPUlRfTElOS19UWVBFID0gd2luZG93LkhUTUxJbXBvcnRzID8gSFRNTEltcG9ydHMuSU1QT1JUX0xJTktfVFlQRSA6ICdub25lJzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IGZvciBwYXJzaW5nIGEgZG9jdW1lbnQgdHJlZQoKdmFyIHBhcnNlciA9IHsKICBzZWxlY3RvcnM6IFsKICAgICdsaW5rW3JlbD0nICsgSU1QT1JUX0xJTktfVFlQRSArICddJywKICAgICdlbGVtZW50JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIGVsZW1lbnQ6ICdwYXJzZUVsZW1lbnQnCiAgfSwKICBwYXJzZTogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgaWYgKCFpbkRvY3VtZW50Ll9fcGFyc2VkKSB7CiAgICAgIC8vIG9ubHkgcGFyc2Ugb25jZQogICAgICBpbkRvY3VtZW50Ll9fcGFyc2VkID0gdHJ1ZTsKICAgICAgLy8gYWxsIHBhcnNhYmxlIGVsZW1lbnRzIGluIGluRG9jdW1lbnQgKGRlcHRoLWZpcnN0IHByZS1vcmRlciB0cmF2ZXJzYWwpCiAgICAgIHZhciBlbHRzID0gaW5Eb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKHBhcnNlci5zZWxlY3RvcnMpOwogICAgICAvLyBmb3IgZWFjaCBwYXJzYWJsZSBub2RlIHR5cGUsIGNhbGwgdGhlIG1hcHBlZCBwYXJzaW5nIG1ldGhvZAogICAgICBmb3JFYWNoKGVsdHMsIGZ1bmN0aW9uKGUpIHsKICAgICAgICBwYXJzZXJbcGFyc2VyLm1hcFtlLmxvY2FsTmFtZV1dKGUpOwogICAgICB9KTsKICAgICAgLy8gdXBncmFkZSBhbGwgdXBncmFkZWFibGUgc3RhdGljIGVsZW1lbnRzLCBhbnl0aGluZyBkeW5hbWljYWxseQogICAgICAvLyBjcmVhdGVkIHNob3VsZCBiZSBjYXVnaHQgYnkgb2JzZXJ2ZXIKICAgICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgICAvLyBvYnNlcnZlIGRvY3VtZW50IGZvciBkb20gY2hhbmdlcwogICAgICBDdXN0b21FbGVtZW50cy5vYnNlcnZlRG9jdW1lbnQoaW5Eb2N1bWVudCk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIC8vIGltcG9ydHMKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICB0aGlzLnBhcnNlSW1wb3J0KGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VJbXBvcnQ6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChsaW5rRWx0LmNvbnRlbnQpIHsKICAgICAgcGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICB9CiAgfSwKICBwYXJzZUVsZW1lbnQ6IGZ1bmN0aW9uKGluRWxlbWVudEVsdCkgewogICAgbmV3IEhUTUxFbGVtZW50RWxlbWVudChpbkVsZW1lbnRFbHQpOwogIH0KfTsKCmZ1bmN0aW9uIGlzRG9jdW1lbnRMaW5rKGluRWx0KSB7CiAgcmV0dXJuIChpbkVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBpbkVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSBJTVBPUlRfTElOS19UWVBFKTsKfQoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKQ3VzdG9tRWxlbWVudHMucGFyc2VyID0gcGFyc2VyOwoKfSkoKTsKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KKGZ1bmN0aW9uKCl7CgovLyBib290c3RyYXAgcGFyc2luZwoKZnVuY3Rpb24gYm9vdHN0cmFwKCkgewogIC8vIGdvIGFzeW5jIHNvIGNhbGwgc3RhY2sgY2FuIHVud2luZAogIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAvLyBwYXJzZSBkb2N1bWVudAogICAgQ3VzdG9tRWxlbWVudHMucGFyc2VyLnBhcnNlKGRvY3VtZW50KTsKICAgIC8vIG9uZSBtb3JlIHBhc3MgYmVmb3JlIHJlZ2lzdGVyIGlzICdsaXZlJwogICAgQ3VzdG9tRWxlbWVudHMudXBncmFkZURvY3VtZW50KGRvY3VtZW50KTsKICAgIC8vIHNldCBpbnRlcm5hbCAncmVhZHknIGZsYWcsIG5vdyBkb2N1bWVudC5yZWdpc3RlciB3aWxsIHRyaWdnZXIKICAgIC8vIHN5bmNocm9ub3VzIHVwZ3JhZGVzCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeSA9IHRydWU7CiAgICAvLyBjYXB0dXJlIGJsdW50IHByb2ZpbGluZyBkYXRhCiAgICBDdXN0b21FbGVtZW50cy5yZWFkeVRpbWUgPSBEYXRlLm5vdygpOwogICAgaWYgKHdpbmRvdy5IVE1MSW1wb3J0cykgewogICAgICBDdXN0b21FbGVtZW50cy5lbGFwc2VkID0gQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lIC0gSFRNTEltcG9ydHMucmVhZHlUaW1lOwogICAgfQogICAgLy8gbm90aWZ5IHRoZSBzeXN0ZW0gdGhhdCB3ZSBhcmUgYm9vdHN0cmFwcGVkCiAgICBkb2N1bWVudC5ib2R5LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnV2ViQ29tcG9uZW50c1JlYWR5Jywge2J1YmJsZXM6IHRydWV9KQogICAgKTsKICB9LCAwKTsKfQoKLy8gQ3VzdG9tRXZlbnQgc2hpbSBmb3IgSUUKaWYgKHR5cGVvZiB3aW5kb3cuQ3VzdG9tRXZlbnQgIT09ICdmdW5jdGlvbicpIHsKICB3aW5kb3cuQ3VzdG9tRXZlbnQgPSBmdW5jdGlvbihpblR5cGUpIHsKICAgICB2YXIgZSA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdIVE1MRXZlbnRzJyk7CiAgICAgZS5pbml0RXZlbnQoaW5UeXBlLCB0cnVlLCB0cnVlKTsKICAgICByZXR1cm4gZTsKICB9Owp9CgppZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gJ2NvbXBsZXRlJykgewogIGJvb3RzdHJhcCgpOwp9IGVsc2UgewogIHZhciBsb2FkRXZlbnQgPSB3aW5kb3cuSFRNTEltcG9ydHMgPyAnSFRNTEltcG9ydHNMb2FkZWQnIDogJ0RPTUNvbnRlbnRMb2FkZWQnOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKGxvYWRFdmVudCwgYm9vdHN0cmFwKTsKfQoKfSkoKTsKCihmdW5jdGlvbiAoKSB7CgovKioqIFZhcmlhYmxlcyAqKiovCgogIHZhciB3aW4gPSB3aW5kb3csCiAgICBkb2MgPSBkb2N1bWVudCwKICAgIG5vb3AgPSBmdW5jdGlvbigpe30sCiAgICByZWdleFBzZXVkb1NwbGl0ID0gLyhbXHctXSsoPzpcKFteXCldK1wpKT8pL2csCiAgICByZWdleFBzZXVkb1JlcGxhY2UgPSAvKFx3KikoPzpcKChbXlwpXSopXCkpPy8sCiAgICByZWdleERpZ2l0cyA9IC8oXGQrKS9nLAogICAga2V5cHNldWRvID0gewogICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgcmV0dXJuIHBzZXVkby52YWx1ZS5tYXRjaChyZWdleERpZ2l0cykuaW5kZXhPZihTdHJpbmcoZXZlbnQua2V5Q29kZSkpID4gLTEgPT0gKHBzZXVkby5uYW1lID09ICdrZXlwYXNzJyk7CiAgICAgIH0KICAgIH0sCiAgICBwcmVmaXggPSAoZnVuY3Rpb24gKCkgewogICAgICB2YXIgc3R5bGVzID0gd2luLmdldENvbXB1dGVkU3R5bGUoZG9jLmRvY3VtZW50RWxlbWVudCwgJycpLAogICAgICAgICAgcHJlID0gKEFycmF5LnByb3RvdHlwZS5zbGljZQogICAgICAgICAgICAuY2FsbChzdHlsZXMpCiAgICAgICAgICAgIC5qb2luKCcnKQogICAgICAgICAgICAubWF0Y2goLy0obW96fHdlYmtpdHxtcyktLykgfHwgKHN0eWxlcy5PTGluayA9PT0gJycgJiYgWycnLCAnbyddKQogICAgICAgICAgKVsxXTsKICAgICAgcmV0dXJuIHsKICAgICAgICBkb206IHByZSA9PSAnbXMnID8gcHJlLnRvVXBwZXJDYXNlKCkgOiBwcmUsCiAgICAgICAgbG93ZXJjYXNlOiBwcmUsCiAgICAgICAgY3NzOiAnLScgKyBwcmUgKyAnLScsCiAgICAgICAganM6IHByZSA9PSAnbXMnID8gcHJlIDogcHJlWzBdLnRvVXBwZXJDYXNlKCkgKyBwcmUuc3Vic3RyKDEpCiAgICAgIH07CgogICAgfSkoKSwKICAgIG1hdGNoU2VsZWN0b3IgPSBFbGVtZW50LnByb3RvdHlwZS5tYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudC5wcm90b3R5cGVbcHJlZml4Lmxvd2VyY2FzZSArICdNYXRjaGVzU2VsZWN0b3InXSwKICAgIG11dGF0aW9uID0gd2luLk11dGF0aW9uT2JzZXJ2ZXIgfHwgd2luW3ByZWZpeC5qcyArICdNdXRhdGlvbk9ic2VydmVyJ107CgovKioqIEZ1bmN0aW9ucyAqKiovCgovLyBVdGlsaXRpZXMKCiAgdmFyIHR5cGVPYmogPSB7fTsKICBmdW5jdGlvbiB0eXBlT2Yob2JqKSB7CiAgICByZXR1cm4gdHlwZU9iai50b1N0cmluZy5jYWxsKG9iaikubWF0Y2goL1xzKFthLXpBLVpdKykvKVsxXS50b0xvd2VyQ2FzZSgpOwogIH0KCiAgZnVuY3Rpb24gY2xvbmUoaXRlbSwgdHlwZSl7CiAgICB2YXIgZm4gPSBjbG9uZVt0eXBlIHx8IHR5cGVPZihpdGVtKV07CiAgICByZXR1cm4gZm4gPyBmbihpdGVtKSA6IGl0ZW07CiAgfQogICAgY2xvbmUub2JqZWN0ID0gZnVuY3Rpb24oc3JjKXsKICAgICAgdmFyIG9iaiA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gc3JjKSBvYmpba2V5XSA9IGNsb25lKHNyY1trZXldKTsKICAgICAgcmV0dXJuIG9iajsKICAgIH07CiAgICBjbG9uZS5hcnJheSA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBpID0gc3JjLmxlbmd0aCwgYXJyYXkgPSBuZXcgQXJyYXkoaSk7CiAgICAgIHdoaWxlIChpLS0pIGFycmF5W2ldID0gY2xvbmUoc3JjW2ldKTsKICAgICAgcmV0dXJuIGFycmF5OwogICAgfTsKCiAgdmFyIHVuc2xpY2VhYmxlID0gWydudW1iZXInLCAnYm9vbGVhbicsICdzdHJpbmcnLCAnZnVuY3Rpb24nXTsKICBmdW5jdGlvbiB0b0FycmF5KG9iail7CiAgICByZXR1cm4gdW5zbGljZWFibGUuaW5kZXhPZih0eXBlT2Yob2JqKSkgPT0gLTEgPwogICAgQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwob2JqLCAwKSA6CiAgICBbb2JqXTsKICB9CgovLyBET00KICB2YXIgc3RyID0gJyc7CiAgZnVuY3Rpb24gcXVlcnkoZWxlbWVudCwgc2VsZWN0b3IpewogICAgcmV0dXJuIChzZWxlY3RvciB8fCBzdHIpLmxlbmd0aCA/IHRvQXJyYXkoZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKSkgOiBbXTsKICB9CgogIGZ1bmN0aW9uIHBhcnNlTXV0YXRpb25zKGVsZW1lbnQsIG11dGF0aW9ucykgewogICAgdmFyIGRpZmYgPSB7IGFkZGVkOiBbXSwgcmVtb3ZlZDogW10gfTsKICAgIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKHJlY29yZCl7CiAgICAgIHJlY29yZC5fbXV0YXRpb24gPSB0cnVlOwogICAgICBmb3IgKHZhciB6IGluIGRpZmYpIHsKICAgICAgICB2YXIgdHlwZSA9IGVsZW1lbnQuX3JlY29yZHNbKHogPT0gJ2FkZGVkJykgPyAnaW5zZXJ0ZWQnIDogJ3JlbW92ZWQnXSwKICAgICAgICAgIG5vZGVzID0gcmVjb3JkW3ogKyAnTm9kZXMnXSwgbGVuZ3RoID0gbm9kZXMubGVuZ3RoOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoICYmIGRpZmZbel0uaW5kZXhPZihub2Rlc1tpXSkgPT0gLTE7IGkrKyl7CiAgICAgICAgICBkaWZmW3pdLnB1c2gobm9kZXNbaV0pOwogICAgICAgICAgdHlwZS5mb3JFYWNoKGZ1bmN0aW9uKGZuKXsKICAgICAgICAgICAgZm4obm9kZXNbaV0sIHJlY29yZCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogIH0KCi8vIE1peGlucwoKICBmdW5jdGlvbiBtZXJnZU9uZShzb3VyY2UsIGtleSwgY3VycmVudCl7CiAgICB2YXIgdHlwZSA9IHR5cGVPZihjdXJyZW50KTsKICAgIGlmICh0eXBlID09ICdvYmplY3QnICYmIHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIHh0YWcubWVyZ2Uoc291cmNlW2tleV0sIGN1cnJlbnQpOwogICAgZWxzZSBzb3VyY2Vba2V5XSA9IGNsb25lKGN1cnJlbnQsIHR5cGUpOwogICAgcmV0dXJuIHNvdXJjZTsKICB9CgogIGZ1bmN0aW9uIG1lcmdlTWl4aW4odHlwZSwgbWl4aW4sIG9wdGlvbikgewogICAgdmFyIG9yaWdpbmFsID0ge307CiAgICBmb3IgKHZhciBvIGluIG9wdGlvbikgb3JpZ2luYWxbby5zcGxpdCgnOicpWzBdXSA9IHRydWU7CiAgICBmb3IgKHZhciB4IGluIG1peGluKSBpZiAoIW9yaWdpbmFsW3guc3BsaXQoJzonKVswXV0pIG9wdGlvblt4XSA9IG1peGluW3hdOwogIH0KCiAgZnVuY3Rpb24gYXBwbHlNaXhpbnModGFnKSB7CiAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgdmFyIG1peGluID0geHRhZy5taXhpbnNbbmFtZV07CiAgICAgIGZvciAodmFyIHR5cGUgaW4gbWl4aW4pIHsKICAgICAgICBzd2l0Y2ggKHR5cGUpIHsKICAgICAgICAgIGNhc2UgJ2xpZmVjeWNsZSc6IGNhc2UgJ21ldGhvZHMnOgogICAgICAgICAgICBtZXJnZU1peGluKHR5cGUsIG1peGluW3R5cGVdLCB0YWdbdHlwZV0pOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2FjY2Vzc29ycyc6IGNhc2UgJ3Byb3RvdHlwZSc6CiAgICAgICAgICAgIGZvciAodmFyIHogaW4gbWl4aW5bdHlwZV0pIG1lcmdlTWl4aW4oeiwgbWl4aW5bdHlwZV0sIHRhZy5hY2Nlc3NvcnMpOwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgJ2V2ZW50cyc6CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gdGFnOwogIH0KCi8vIEV2ZW50cwoKICBmdW5jdGlvbiB0b3VjaEZpbHRlcihjdXN0b20sIGV2ZW50KSB7CiAgICBpZiAoZXZlbnQudHlwZS5tYXRjaCgndG91Y2gnKSl7CiAgICAgIGN1c3RvbS5saXN0ZW5lci50b3VjaGVkID0gdHJ1ZTsKICAgIH0KICAgIGVsc2UgaWYgKGN1c3RvbS5saXN0ZW5lci50b3VjaGVkICYmIGV2ZW50LnR5cGUubWF0Y2goJ21vdXNlJykpewogICAgICBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IGZhbHNlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKICB9CgogIGZ1bmN0aW9uIGNyZWF0ZUZsb3dFdmVudCh0eXBlKSB7CiAgICB2YXIgZmxvdyA9IHR5cGUgPT0gJ292ZXInOwogICAgcmV0dXJuIHsKICAgICAgYmFzZTogJ092ZXJmbG93RXZlbnQnIGluIHdpbiA/ICdvdmVyZmxvd2NoYW5nZWQnIDogdHlwZSArICdmbG93JywKICAgICAgY29uZGl0aW9uOiBmdW5jdGlvbiAoY3VzdG9tLCBldmVudCkgewogICAgICAgIGV2ZW50LmZsb3cgPSB0eXBlOwogICAgICAgIHJldHVybiBldmVudC50eXBlID09ICh0eXBlICsgJ2Zsb3cnKSB8fAogICAgICAgICgoZXZlbnQub3JpZW50ID09PSAwICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMSAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpIHx8CiAgICAgICAgKGV2ZW50Lm9yaWVudCA9PSAyICYmIGV2ZW50Lmhvcml6b250YWxPdmVyZmxvdyA9PSBmbG93ICYmIGV2ZW50LnZlcnRpY2FsT3ZlcmZsb3cgPT0gZmxvdykpOwogICAgICB9CiAgICB9OwogIH0KCi8vIEFjY2Vzc29ycwoKICBmdW5jdGlvbiBnZXRBcmdzKGF0dHIsIHZhbHVlKXsKICAgIHJldHVybiB7CiAgICAgIHZhbHVlOiBhdHRyLmJvb2xlYW4gPyAnJyA6IHZhbHVlLAogICAgICBtZXRob2Q6IGF0dHIuYm9vbGVhbiAmJiAhdmFsdWUgPyAncmVtb3ZlQXR0cmlidXRlJyA6ICdzZXRBdHRyaWJ1dGUnCiAgICB9OwogIH0KCiAgZnVuY3Rpb24gbW9kQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSl7CiAgICB2YXIgYXJncyA9IGdldEFyZ3MoYXR0ciwgdmFsdWUpOwogICAgZWxlbWVudFthcmdzLm1ldGhvZF0obmFtZSwgYXJncy52YWx1ZSk7CiAgfQoKICBmdW5jdGlvbiBzeW5jQXR0cihlbGVtZW50LCBhdHRyLCBuYW1lLCB2YWx1ZSwgbWV0aG9kKXsKICAgIHZhciBub2RlcyA9IGF0dHIucHJvcGVydHkgPyBbZWxlbWVudC54dGFnW2F0dHIucHJvcGVydHldXSA6IGF0dHIuc2VsZWN0b3IgPyB4dGFnLnF1ZXJ5KGVsZW1lbnQsIGF0dHIuc2VsZWN0b3IpIDogW10sCiAgICAgICAgaW5kZXggPSBub2Rlcy5sZW5ndGg7CiAgICB3aGlsZSAoaW5kZXgtLSkgbm9kZXNbaW5kZXhdW21ldGhvZF0obmFtZSwgdmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gdXBkYXRlVmlldyhlbGVtZW50LCBuYW1lLCB2YWx1ZSl7CiAgICBpZiAoZWxlbWVudC54dGFnLl9fdmlld19fKXsKICAgICAgZWxlbWVudC54dGFnLl9fdmlld19fLnVwZGF0ZUJpbmRpbmdWYWx1ZShlbGVtZW50LCBuYW1lLCB2YWx1ZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpewogICAgdmFyIGtleSA9IHouc3BsaXQoJzonKSwgdHlwZSA9IGtleVswXTsKICAgIGlmICh0eXBlID09ICdnZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHRhZy5wcm90b3R5cGVbcHJvcF0uZ2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYWNjZXNzb3Jbel0sIHRhZy5wc2V1ZG9zKTsKICAgIH0KICAgIGVsc2UgaWYgKHR5cGUgPT0gJ3NldCcpIHsKICAgICAga2V5WzBdID0gcHJvcDsKICAgICAgdmFyIHNldHRlciA9IHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0geHRhZy5hcHBseVBzZXVkb3Moa2V5LmpvaW4oJzonKSwgYXR0ciA/IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICB0aGlzLnh0YWcuX3NraXBTZXQgPSB0cnVlOwogICAgICAgIGlmICghdGhpcy54dGFnLl9za2lwQXR0cikgbW9kQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMueHRhZy5fc2tpcEF0dHIgJiYgYXR0ci5za2lwKSBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/ICEhdmFsdWUgOiB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcFNldDsKICAgICAgfSA6IGFjY2Vzc29yW3pdID8gZnVuY3Rpb24odmFsdWUpewogICAgICAgIGFjY2Vzc29yW3pdLmNhbGwodGhpcywgdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9IDogbnVsbCwgdGFnLnBzZXVkb3MpOwoKICAgICAgaWYgKGF0dHIpIGF0dHIuc2V0dGVyID0gc2V0dGVyOwogICAgfQogICAgZWxzZSB0YWcucHJvdG90eXBlW3Byb3BdW3pdID0gYWNjZXNzb3Jbel07CiAgfQoKICBmdW5jdGlvbiBwYXJzZUFjY2Vzc29yKHRhZywgcHJvcCl7CiAgICB0YWcucHJvdG90eXBlW3Byb3BdID0ge307CiAgICB2YXIgYWNjZXNzb3IgPSB0YWcuYWNjZXNzb3JzW3Byb3BdLAogICAgICAgIGF0dHIgPSBhY2Nlc3Nvci5hdHRyaWJ1dGUsCiAgICAgICAgbmFtZSA9IGF0dHIgJiYgYXR0ci5uYW1lID8gYXR0ci5uYW1lLnRvTG93ZXJDYXNlKCkgOiBwcm9wOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGF0dHIua2V5ID0gcHJvcDsKICAgICAgdGFnLmF0dHJpYnV0ZXNbbmFtZV0gPSBhdHRyOwogICAgfQoKICAgIGZvciAodmFyIHogaW4gYWNjZXNzb3IpIGF0dGFjaFByb3BlcnRpZXModGFnLCBwcm9wLCB6LCBhY2Nlc3NvciwgYXR0ciwgbmFtZSk7CgogICAgaWYgKGF0dHIpIHsKICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLmdldCkgewogICAgICAgIHZhciBtZXRob2QgPSAoYXR0ci5ib29sZWFuID8gJ2hhcycgOiAnZ2V0JykgKyAnQXR0cmlidXRlJzsKICAgICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICByZXR1cm4gdGhpc1ttZXRob2RdKG5hbWUpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgaWYgKCF0YWcucHJvdG90eXBlW3Byb3BdLnNldCkgdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQgPSBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgbW9kQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB2YWx1ZSk7CiAgICAgICAgdXBkYXRlVmlldyh0aGlzLCBuYW1lLCB2YWx1ZSk7CiAgICAgIH07CiAgICB9CiAgfQoKLyoqKiBYLVRhZyBPYmplY3QgRGVmaW5pdGlvbiAqKiovCgogIHZhciB4dGFnID0gewogICAgdGFnczoge30sCiAgICBkZWZhdWx0T3B0aW9uczogewogICAgICBwc2V1ZG9zOiBbXSwKICAgICAgbWl4aW5zOiBbXSwKICAgICAgZXZlbnRzOiB7fSwKICAgICAgbWV0aG9kczoge30sCiAgICAgIGFjY2Vzc29yczogewogICAgICAgIHRlbXBsYXRlOiB7CiAgICAgICAgICBhdHRyaWJ1dGU6IHt9LAogICAgICAgICAgc2V0OiBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgICAgIHZhciBsYXN0ID0gdGhpcy5nZXRBdHRyaWJ1dGUoJ3RlbXBsYXRlJyk7CiAgICAgICAgICAgIHRoaXMueHRhZy5fX3ByZXZpb3VzVGVtcGxhdGVfXyA9IGxhc3Q7CiAgICAgICAgICAgIHh0YWcuZmlyZUV2ZW50KHRoaXMsICd0ZW1wbGF0ZWNoYW5nZScsIHsgZGV0YWlsOiB7IHRlbXBsYXRlOiB2YWx1ZSB9fSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9LAogICAgICBsaWZlY3ljbGU6IHt9LAogICAgICBhdHRyaWJ1dGVzOiB7fSwKICAgICAgJ3Byb3RvdHlwZSc6IHsKICAgICAgICB4dGFnOiB7CiAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgIHJldHVybiB0aGlzLl9feHRhZ19fID8gdGhpcy5fX3h0YWdfXyA6ICh0aGlzLl9feHRhZ19fID0geyBkYXRhOiB7fSB9KTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0sCiAgICByZWdpc3RlcjogZnVuY3Rpb24gKG5hbWUsIG9wdGlvbnMpIHsKICAgICAgdmFyIGVsZW1lbnQsIF9uYW1lOwogICAgICBpZiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycpIHsKICAgICAgICBfbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIGlmIChuYW1lLm5vZGVOYW1lID09ICdFTEVNRU5UJykgewogICAgICAgIGVsZW1lbnQgPSBuYW1lOwogICAgICAgIF9uYW1lID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ25hbWUnKS50b0xvd2VyQ2FzZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdmFyIHRhZyA9IHh0YWcudGFnc1tfbmFtZV0gPSBhcHBseU1peGlucyh4dGFnLm1lcmdlKHt9LCB4dGFnLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKSk7CgogICAgICBmb3IgKHZhciB6IGluIHRhZy5ldmVudHMpIHRhZy5ldmVudHNbel0gPSB4dGFnLnBhcnNlRXZlbnQoeiwgdGFnLmV2ZW50c1t6XSk7CiAgICAgIGZvciAoeiBpbiB0YWcubGlmZWN5Y2xlKSB0YWcubGlmZWN5Y2xlW3ouc3BsaXQoJzonKVswXV0gPSB4dGFnLmFwcGx5UHNldWRvcyh6LCB0YWcubGlmZWN5Y2xlW3pdLCB0YWcucHNldWRvcyk7CiAgICAgIGZvciAoeiBpbiB0YWcubWV0aG9kcykgdGFnLnByb3RvdHlwZVt6LnNwbGl0KCc6JylbMF1dID0geyB2YWx1ZTogeHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLm1ldGhvZHNbel0sIHRhZy5wc2V1ZG9zKSwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBmb3IgKHogaW4gdGFnLmFjY2Vzc29ycykgcGFyc2VBY2Nlc3Nvcih0YWcsIHopOwoKICAgICAgdmFyIHJlYWR5ID0gdGFnLmxpZmVjeWNsZS5jcmVhdGVkIHx8IHRhZy5saWZlY3ljbGUucmVhZHk7CiAgICAgIHRhZy5wcm90b3R5cGUucmVhZHlDYWxsYmFjayA9IHsKICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGVsZW1lbnQgPSB0aGlzOwogICAgICAgICAgdmFyIHRlbXBsYXRlID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ3RlbXBsYXRlJyk7CiAgICAgICAgICBpZiAodGVtcGxhdGUpewogICAgICAgICAgICB4dGFnLmZpcmVFdmVudCh0aGlzLCAndGVtcGxhdGVjaGFuZ2UnLCB7IGRldGFpbDogeyB0ZW1wbGF0ZTogdGVtcGxhdGUgfX0pOwogICAgICAgICAgfQogICAgICAgICAgeHRhZy5hZGRFdmVudHModGhpcywgdGFnLmV2ZW50cyk7CiAgICAgICAgICB0YWcubWl4aW5zLmZvckVhY2goZnVuY3Rpb24obWl4aW4pewogICAgICAgICAgICBpZiAoeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cykgeHRhZy5hZGRFdmVudHMoZWxlbWVudCwgeHRhZy5taXhpbnNbbWl4aW5dLmV2ZW50cyk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHZhciBvdXRwdXQgPSByZWFkeSA/IHJlYWR5LmFwcGx5KHRoaXMsIHRvQXJyYXkoYXJndW1lbnRzKSkgOiBudWxsOwogICAgICAgICAgZm9yICh2YXIgbmFtZSBpbiB0YWcuYXR0cmlidXRlcykgewogICAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWVdLAogICAgICAgICAgICAgICAgaGFzQXR0ciA9IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpOwogICAgICAgICAgICBpZiAoaGFzQXR0ciB8fCBhdHRyLmJvb2xlYW4pIHsKICAgICAgICAgICAgICB0aGlzW2F0dHIua2V5XSA9IGF0dHIuYm9vbGVhbiA/IGhhc0F0dHIgOiB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgdGFnLnBzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICAgICAgfSk7CiAgICAgICAgICByZXR1cm4gb3V0cHV0OwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmluc2VydGVkKSB0YWcucHJvdG90eXBlLmluc2VydGVkQ2FsbGJhY2sgPSB7IHZhbHVlOiB0YWcubGlmZWN5Y2xlLmluc2VydGVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLnJlbW92ZWQpIHRhZy5wcm90b3R5cGUucmVtb3ZlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5yZW1vdmVkLCBlbnVtZXJhYmxlOiB0cnVlIH07CiAgICAgIGlmICh0YWcubGlmZWN5Y2xlLmF0dHJpYnV0ZUNoYW5nZWQpIHRhZy5wcm90b3R5cGUuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkLCBlbnVtZXJhYmxlOiB0cnVlIH07CgogICAgICB2YXIgc2V0QXR0cmlidXRlID0gdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgfHwgSFRNTEVsZW1lbnQucHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICAgICAgdGFnLnByb3RvdHlwZS5zZXRBdHRyaWJ1dGUgPSB7CiAgICAgICAgd3JpdGFibGU6IHRydWUsCiAgICAgICAgZW51bWJlcmFibGU6IHRydWUsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIChuYW1lLCB2YWx1ZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHNldEF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIGF0dHIgJiYgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSk7CiAgICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgICBpZiAoYXR0ci5zZXR0ZXIgJiYgIXRoaXMueHRhZy5fc2tpcFNldCkgewogICAgICAgICAgICAgIHRoaXMueHRhZy5fc2tpcEF0dHIgPSB0cnVlOwogICAgICAgICAgICAgIGF0dHIuc2V0dGVyLmNhbGwodGhpcywgYXR0ci5ib29sZWFuID8gdHJ1ZSA6IHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YWx1ZSA9IGF0dHIuc2tpcCA/IGF0dHIuYm9vbGVhbiA/IHRoaXMuaGFzQXR0cmlidXRlKG5hbWUpIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkgOiB2YWx1ZTsKICAgICAgICAgICAgc3luY0F0dHIodGhpcywgYXR0ciwgbmFtZSwgYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwgJ3NldEF0dHJpYnV0ZScpOwogICAgICAgICAgfQogICAgICAgICAgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgdmFyIHJlbW92ZUF0dHJpYnV0ZSA9IHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZS5yZW1vdmVBdHRyaWJ1dGU7CiAgICAgIHRhZy5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gewogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSl7CiAgICAgICAgICB2YXIgYXR0ciA9IHRhZy5hdHRyaWJ1dGVzW25hbWUudG9Mb3dlckNhc2UoKV07CiAgICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIHJlbW92ZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUpOwogICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyICYmICF0aGlzLnh0YWcuX3NraXBTZXQpIHsKICAgICAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IGZhbHNlIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzeW5jQXR0cih0aGlzLCBhdHRyLCBuYW1lLCB1bmRlZmluZWQsICdyZW1vdmVBdHRyaWJ1dGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGlmIChlbGVtZW50KXsKICAgICAgICBlbGVtZW50LnJlZ2lzdGVyKHsKICAgICAgICAgICdwcm90b3R5cGUnOiBPYmplY3QuY3JlYXRlKE9iamVjdC5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGRvYy5yZWdpc3RlcihfbmFtZSwgewogICAgICAgICAgJ2V4dGVuZHMnOiBvcHRpb25zWydleHRlbmRzJ10sCiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QuY3JlYXRlKChvcHRpb25zWydleHRlbmRzJ10gPwogICAgICAgICAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG9wdGlvbnNbJ2V4dGVuZHMnXSkuY29uc3RydWN0b3IgOgogICAgICAgICAgICB3aW4uSFRNTEVsZW1lbnQpLnByb3RvdHlwZSwgdGFnLnByb3RvdHlwZSksIHRhZy5wcm90b3R5cGUpCiAgICAgICAgfSk7CiAgICAgIH0KICAgIH0sCgogICAgLyogRXhwb3NlZCBWYXJpYWJsZXMgKi8KCiAgICBtaXhpbnM6IHt9LAogICAgcHJlZml4OiBwcmVmaXgsCiAgICB0ZW1wbGF0ZXM6IHt9LAogICAgY2FwdHVyZUV2ZW50czogWydmb2N1cycsICdibHVyJywgJ3Njcm9sbCcsICd1bmRlcmZsb3cnLCAnb3ZlcmZsb3cnLCAnb3ZlcmZsb3djaGFuZ2VkJ10sCiAgICBjdXN0b21FdmVudHM6IHsKICAgICAgb3ZlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgnb3ZlcicpLAogICAgICB1bmRlcmZsb3c6IGNyZWF0ZUZsb3dFdmVudCgndW5kZXInKSwKICAgICAgYW5pbWF0aW9uc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbCiAgICAgICAgICAnYW5pbWF0aW9uc3RhcnQnLAogICAgICAgICAgJ29BbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnTVNBbmltYXRpb25TdGFydCcsCiAgICAgICAgICAnd2Via2l0QW5pbWF0aW9uU3RhcnQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0cmFuc2l0aW9uZW5kOiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ3RyYW5zaXRpb25lbmQnLAogICAgICAgICAgJ29UcmFuc2l0aW9uRW5kJywKICAgICAgICAgICdNU1RyYW5zaXRpb25FbmQnLAogICAgICAgICAgJ3dlYmtpdFRyYW5zaXRpb25FbmQnCiAgICAgICAgXQogICAgICB9LAogICAgICB0YXA6IHsKICAgICAgICBiYXNlOiBbJ2NsaWNrJywgJ3RvdWNoZW5kJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBzdGFydDogewogICAgICAgIGJhc2U6IFsnbW91c2Vkb3duJywgJ3RvdWNoc3RhcnQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVuZDogewogICAgICAgIGJhc2U6IFsnbW91c2V1cCcsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwZW50ZXI6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3ZlcicsICd0b3VjaGVudGVyJ10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBsZWF2ZTogewogICAgICAgIGJhc2U6IFsnbW91c2VvdXQnLCAndG91Y2hsZWF2ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbW92ZTogewogICAgICAgIGJhc2U6IFsnbW91c2Vtb3ZlJywgJ3RvdWNobW92ZSddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfQogICAgfSwKICAgIHBzZXVkb3M6IHsKICAgICAga2V5cGFzczoga2V5cHNldWRvLAogICAgICBrZXlmYWlsOiBrZXlwc2V1ZG8sCiAgICAgIGRlbGVnYXRlOiB7CiAgICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgICAgdmFyIHRhcmdldCA9IHF1ZXJ5KHRoaXMsIHBzZXVkby52YWx1ZSkuZmlsdGVyKGZ1bmN0aW9uIChub2RlKSB7CiAgICAgICAgICAgIHJldHVybiBub2RlID09IGV2ZW50LnRhcmdldCB8fCBub2RlLmNvbnRhaW5zID8gbm9kZS5jb250YWlucyhldmVudC50YXJnZXQpIDogZmFsc2U7CiAgICAgICAgICB9KVswXTsKICAgICAgICAgIHJldHVybiB0YXJnZXQgPyBwc2V1ZG8ubGlzdGVuZXIgPSBwc2V1ZG8ubGlzdGVuZXIuYmluZCh0YXJnZXQpIDogZmFsc2U7CiAgICAgICAgfQogICAgICB9LAogICAgICBwcmV2ZW50YWJsZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHJldHVybiAhZXZlbnQuZGVmYXVsdFByZXZlbnRlZDsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLyogVVRJTElUSUVTICovCgogICAgY2xvbmU6IGNsb25lLAogICAgdHlwZU9mOiB0eXBlT2YsCiAgICB0b0FycmF5OiB0b0FycmF5LAoKICAgIHdyYXA6IGZ1bmN0aW9uIChvcmlnaW5hbCwgZm4pIHsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKCl7CiAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICByZXR1cm5lZCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIHJldHVybiByZXR1cm5lZCA9PT0gZmFsc2UgPyBmYWxzZSA6IGZuLmFwcGx5KHRoaXMsIHR5cGVvZiByZXR1cm5lZCAhPSAndW5kZWZpbmVkJyA/IHRvQXJyYXkocmV0dXJuZWQpIDogYXJncyk7CiAgICAgIH07CiAgICB9LAoKICAgIG1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewogICAgICBpZiAodHlwZU9mKGspID09ICdzdHJpbmcnKSByZXR1cm4gbWVyZ2VPbmUoc291cmNlLCBrLCB2KTsKICAgICAgZm9yICh2YXIgaSA9IDEsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKICAgICAgICB2YXIgb2JqZWN0ID0gYXJndW1lbnRzW2ldOwogICAgICAgIGZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHNvdXJjZTsKICAgIH0sCgogICAgdWlkOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsMTApOwogICAgfSwKCiAgICAvKiBET00gKi8KCiAgICBxdWVyeTogcXVlcnksCgogICAgc2tpcFRyYW5zaXRpb246IGZ1bmN0aW9uKGVsZW1lbnQsIGZuLCBiaW5kKXsKICAgICAgdmFyIHByb3AgPSBwcmVmaXguanMgKyAnVHJhbnNpdGlvblByb3BlcnR5JzsKICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJ25vbmUnOwogICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgIHZhciBjYWxsYmFjazsKICAgICAgICBpZiAoZm4pIGNhbGxiYWNrID0gZm4uY2FsbChiaW5kKTsKICAgICAgICB4dGFnLnJlcXVlc3RGcmFtZShmdW5jdGlvbigpewogICAgICAgICAgZWxlbWVudC5zdHlsZVtwcm9wXSA9IGVsZW1lbnQuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID0gJyc7CiAgICAgICAgICBpZiAoY2FsbGJhY2spIHh0YWcucmVxdWVzdEZyYW1lKGNhbGxiYWNrKTsKICAgICAgICB9KTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlcXVlc3RGcmFtZTogKGZ1bmN0aW9uKCl7CiAgICAgIHZhciByYWYgPSB3aW4ucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8CiAgICAgICAgd2luW3ByZWZpeC5sb3dlcmNhc2UgKyAnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHwKICAgICAgICBmdW5jdGlvbihmbil7IHJldHVybiB3aW4uc2V0VGltZW91dChmbiwgMjApOyB9OwogICAgICByZXR1cm4gZnVuY3Rpb24oZm4pewogICAgICAgIHJldHVybiByYWYuY2FsbCh3aW4sIGZuKTsKICAgICAgfTsKICAgIH0pKCksCgogICAgbWF0Y2hTZWxlY3RvcjogZnVuY3Rpb24gKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICAgIHJldHVybiBtYXRjaFNlbGVjdG9yLmNhbGwoZWxlbWVudCwgc2VsZWN0b3IpOwogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uIChlbGVtZW50LCBtZXRob2QsIHZhbHVlKSB7CiAgICAgIGVsZW1lbnRbbWV0aG9kXSA9IHZhbHVlOwogICAgICBpZiAod2luZG93LkN1c3RvbUVsZW1lbnRzKSBDdXN0b21FbGVtZW50cy51cGdyYWRlQWxsKGVsZW1lbnQpOwogICAgfSwKCiAgICBpbm5lckhUTUw6IGZ1bmN0aW9uKGVsLCBodG1sKXsKICAgICAgeHRhZy5zZXQoZWwsICdpbm5lckhUTUwnLCBodG1sKTsKICAgIH0sCgogICAgaGFzQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICByZXR1cm4gZWxlbWVudC5jbGFzc05hbWUuc3BsaXQoJyAnKS5pbmRleE9mKGtsYXNzLnRyaW0oKSk+LTE7CiAgICB9LAoKICAgIGFkZENsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgdmFyIGxpc3QgPSBlbGVtZW50LmNsYXNzTmFtZS50cmltKCkuc3BsaXQoJyAnKTsKICAgICAga2xhc3MudHJpbSgpLnNwbGl0KCcgJykuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGlmICghfmxpc3QuaW5kZXhPZihuYW1lKSkgbGlzdC5wdXNoKG5hbWUpOwogICAgICB9KTsKICAgICAgZWxlbWVudC5jbGFzc05hbWUgPSBsaXN0LmpvaW4oJyAnKS50cmltKCk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICByZW1vdmVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBjbGFzc2VzID0ga2xhc3MudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJykuZmlsdGVyKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgcmV0dXJuIG5hbWUgJiYgIX5jbGFzc2VzLmluZGV4T2YobmFtZSk7CiAgICAgIH0pLmpvaW4oJyAnKTsKICAgICAgcmV0dXJuIGVsZW1lbnQ7CiAgICB9LAoKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIHh0YWdbeHRhZy5oYXNDbGFzcyhlbGVtZW50LCBrbGFzcykgPyAncmVtb3ZlQ2xhc3MnIDogJ2FkZENsYXNzJ10uY2FsbChudWxsLCBlbGVtZW50LCBrbGFzcyk7CiAgICB9LAoKICAgIHF1ZXJ5Q2hpbGRyZW46IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICB2YXIgaWQgPSBlbGVtZW50LmlkLAogICAgICAgIGd1aWQgPSBlbGVtZW50LmlkID0gaWQgfHwgJ3hfJyArIHh0YWcudWlkKCksCiAgICAgICAgYXR0ciA9ICcjJyArIGd1aWQgKyAnID4gJzsKICAgICAgc2VsZWN0b3IgPSBhdHRyICsgKHNlbGVjdG9yICsgJycpLnJlcGxhY2UoJywnLCAnLCcgKyBhdHRyLCAnZycpOwogICAgICB2YXIgcmVzdWx0ID0gZWxlbWVudC5wYXJlbnROb2RlLnF1ZXJ5U2VsZWN0b3JBbGwoc2VsZWN0b3IpOwogICAgICBpZiAoIWlkKSBlbGVtZW50LnJlbW92ZUF0dHJpYnV0ZSgnaWQnKTsKICAgICAgcmV0dXJuIHRvQXJyYXkocmVzdWx0KTsKICAgIH0sCgogICAgY3JlYXRlRnJhZ21lbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdmFyIGZyYWcgPSBkb2MuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwogICAgICBpZiAoY29udGVudCkgewogICAgICAgIHZhciBkaXYgPSBmcmFnLmFwcGVuZENoaWxkKGRvYy5jcmVhdGVFbGVtZW50KCdkaXYnKSksCiAgICAgICAgICBub2RlcyA9IHRvQXJyYXkoY29udGVudC5ub2RlTmFtZSA/IGFyZ3VtZW50cyA6ICEoZGl2LmlubmVySFRNTCA9IGNvbnRlbnQpIHx8IGRpdi5jaGlsZHJlbiksCiAgICAgICAgICBsZW5ndGggPSBub2Rlcy5sZW5ndGgsCiAgICAgICAgICBpbmRleCA9IDA7CiAgICAgICAgd2hpbGUgKGluZGV4IDwgbGVuZ3RoKSBmcmFnLmluc2VydEJlZm9yZShub2Rlc1tpbmRleCsrXSwgZGl2KTsKICAgICAgICBmcmFnLnJlbW92ZUNoaWxkKGRpdik7CiAgICAgIH0KICAgICAgcmV0dXJuIGZyYWc7CiAgICB9LAoKICAgIG1hbmlwdWxhdGU6IGZ1bmN0aW9uKGVsZW1lbnQsIGZuKXsKICAgICAgdmFyIG5leHQgPSBlbGVtZW50Lm5leHRTaWJsaW5nLAogICAgICAgIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwKICAgICAgICBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKICAgICAgICByZXR1cm5lZCA9IGZuLmNhbGwoZnJhZy5hcHBlbmRDaGlsZChlbGVtZW50KSwgZnJhZykgfHwgZWxlbWVudDsKICAgICAgaWYgKG5leHQpIHBhcmVudC5pbnNlcnRCZWZvcmUocmV0dXJuZWQsIG5leHQpOwogICAgICBlbHNlIHBhcmVudC5hcHBlbmRDaGlsZChyZXR1cm5lZCk7CiAgICB9LAoKICAgIC8qIFBTRVVET1MgKi8KCiAgICBhcHBseVBzZXVkb3M6IGZ1bmN0aW9uKGtleSwgZm4sIGVsZW1lbnQpIHsKICAgICAgdmFyIGxpc3RlbmVyID0gZm4sCiAgICAgICAgICBwc2V1ZG9zID0ge307CiAgICAgIGlmIChrZXkubWF0Y2goJzonKSkgewogICAgICAgIHZhciBzcGxpdCA9IGtleS5tYXRjaChyZWdleFBzZXVkb1NwbGl0KSwKICAgICAgICAgICAgaSA9IHNwbGl0Lmxlbmd0aDsKICAgICAgICB3aGlsZSAoLS1pKSB7CiAgICAgICAgICBzcGxpdFtpXS5yZXBsYWNlKHJlZ2V4UHNldWRvUmVwbGFjZSwgZnVuY3Rpb24gKG1hdGNoLCBuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICBpZiAoIXh0YWcucHNldWRvc1tuYW1lXSkgdGhyb3cgInBzZXVkbyBub3QgZm91bmQ6ICIgKyBuYW1lICsgIiAiICsgc3BsaXQ7CiAgICAgICAgICAgIHZhciBwc2V1ZG8gPSBwc2V1ZG9zW2ldID0gT2JqZWN0LmNyZWF0ZSh4dGFnLnBzZXVkb3NbbmFtZV0pOwogICAgICAgICAgICAgICAgcHNldWRvLmtleSA9IGtleTsKICAgICAgICAgICAgICAgIHBzZXVkby5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIHBzZXVkby52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICB2YXIgbGFzdCA9IGxpc3RlbmVyOwogICAgICAgICAgICBsaXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyksCiAgICAgICAgICAgICAgICAgIG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGtleSwKICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLAogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2YWx1ZSwKICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcjogbGFzdAogICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIGlmIChwc2V1ZG8uYWN0aW9uICYmIHBzZXVkby5hY3Rpb24uYXBwbHkodGhpcywgW29ial0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gb2JqLmxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBpZiAoZWxlbWVudCAmJiBwc2V1ZG8ub25BZGQpIHsKICAgICAgICAgICAgICBpZiAoZWxlbWVudC5nZXRBdHRyaWJ1dGUpIHsKICAgICAgICAgICAgICAgIHBzZXVkby5vbkFkZC5jYWxsKGVsZW1lbnQsIHBzZXVkbyk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQucHVzaChwc2V1ZG8pOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIGZvciAodmFyIHogaW4gcHNldWRvcykgewogICAgICAgIGlmIChwc2V1ZG9zW3pdLm9uQ29tcGlsZWQpIGxpc3RlbmVyID0gcHNldWRvc1t6XS5vbkNvbXBpbGVkKGxpc3RlbmVyLCBwc2V1ZG9zW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXI7CiAgICB9LAoKICAgIHJlbW92ZVBzZXVkb3M6IGZ1bmN0aW9uKGVsZW1lbnQsIGV2ZW50KXsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgfSwKCiAgLyoqKiBFdmVudHMgKioqLwoKICAgIHBhcnNlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKSB7CiAgICAgIHZhciBwc2V1ZG9zID0gdHlwZS5zcGxpdCgnOicpLAogICAgICAgIGtleSA9IHBzZXVkb3Muc2hpZnQoKSwKICAgICAgICBldmVudCA9IHh0YWcubWVyZ2UoewogICAgICAgICAgYmFzZToga2V5LAogICAgICAgICAgcHNldWRvczogJycsCiAgICAgICAgICBfcHNldWRvczogW10sCiAgICAgICAgICBvbkFkZDogbm9vcCwKICAgICAgICAgIG9uUmVtb3ZlOiBub29wLAogICAgICAgICAgY29uZGl0aW9uOiBub29wCiAgICAgICAgfSwgeHRhZy5jdXN0b21FdmVudHNba2V5XSB8fCB7fSk7CiAgICAgIGV2ZW50LnR5cGUgPSBrZXkgKyAoZXZlbnQucHNldWRvcy5sZW5ndGggPyAnOicgKyBldmVudC5wc2V1ZG9zIDogJycpICsgKHBzZXVkb3MubGVuZ3RoID8gJzonICsgcHNldWRvcy5qb2luKCc6JykgOiAnJyk7CiAgICAgIGlmIChmbikgewogICAgICAgIHZhciBjaGFpbmVkID0geHRhZy5hcHBseVBzZXVkb3MoZXZlbnQudHlwZSwgZm4sIGV2ZW50Ll9wc2V1ZG9zKTsKICAgICAgICBldmVudC5saXN0ZW5lciA9IGZ1bmN0aW9uKCl7CiAgICAgICAgICB2YXIgYXJncyA9IHRvQXJyYXkoYXJndW1lbnRzKTsKICAgICAgICAgIGlmIChldmVudC5jb25kaXRpb24uYXBwbHkodGhpcywgW2V2ZW50XS5jb25jYXQoYXJncykpID09PSBmYWxzZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgcmV0dXJuIGNoYWluZWQuYXBwbHkodGhpcywgYXJncyk7CiAgICAgICAgfTsKICAgICAgfQogICAgICByZXR1cm4gZXZlbnQ7CiAgICB9LAoKICAgIGFkZEV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gKHR5cGVvZiBmbiA9PSAnZnVuY3Rpb24nKSA/IHh0YWcucGFyc2VFdmVudCh0eXBlLCBmbikgOiBmbjsKICAgICAgZXZlbnQubGlzdGVuZXIuZXZlbnQgPSBldmVudDsKICAgICAgZXZlbnQuX3BzZXVkb3MuZm9yRWFjaChmdW5jdGlvbihvYmopewogICAgICAgIG9iai5vbkFkZC5jYWxsKGVsZW1lbnQsIG9iaik7CiAgICAgIH0pOwogICAgICBldmVudC5vbkFkZC5jYWxsKGVsZW1lbnQsIGV2ZW50LCBldmVudC5saXN0ZW5lcik7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBldmVudC5saXN0ZW5lciwgeHRhZy5jYXB0dXJlRXZlbnRzLmluZGV4T2YobmFtZSkgPiAtMSk7CiAgICAgIH0pOwogICAgICByZXR1cm4gZXZlbnQubGlzdGVuZXI7CiAgICB9LAoKICAgIGFkZEV2ZW50czogZnVuY3Rpb24gKGVsZW1lbnQsIGV2ZW50cykgewogICAgICB2YXIgbGlzdGVuZXJzID0ge307CiAgICAgIGZvciAodmFyIHogaW4gZXZlbnRzKSB7CiAgICAgICAgbGlzdGVuZXJzW3pdID0geHRhZy5hZGRFdmVudChlbGVtZW50LCB6LCBldmVudHNbel0pOwogICAgICB9CiAgICAgIHJldHVybiBsaXN0ZW5lcnM7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50OiBmdW5jdGlvbiAoZWxlbWVudCwgdHlwZSwgZm4pIHsKICAgICAgdmFyIGV2ZW50ID0gZm4uZXZlbnQ7CiAgICAgIGV2ZW50Lm9uUmVtb3ZlLmNhbGwoZWxlbWVudCwgZXZlbnQsIGZuKTsKICAgICAgeHRhZy5yZW1vdmVQc2V1ZG9zKGVsZW1lbnQsIGV2ZW50KTsKICAgICAgdG9BcnJheShldmVudC5iYXNlKS5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKG5hbWUsIGZuKTsKICAgICAgfSk7CiAgICB9LAoKICAgIHJlbW92ZUV2ZW50czogZnVuY3Rpb24oZWxlbWVudCwgbGlzdGVuZXJzKXsKICAgICAgZm9yICh2YXIgeiBpbiBsaXN0ZW5lcnMpIHh0YWcucmVtb3ZlRXZlbnQoZWxlbWVudCwgeiwgbGlzdGVuZXJzW3pdKTsKICAgIH0sCgogICAgZmlyZUV2ZW50OiBmdW5jdGlvbihlbGVtZW50LCB0eXBlLCBvcHRpb25zLCB3YXJuKXsKICAgICAgdmFyIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9LAogICAgICAgICAgZXZlbnQgPSBkb2MuY3JlYXRlRXZlbnQoJ0N1c3RvbUV2ZW50Jyk7CiAgICAgIGlmICh3YXJuKSBjb25zb2xlLndhcm4oJ2ZpcmVFdmVudCBoYXMgYmVlbiBtb2RpZmllZCwgbW9yZSBpbmZvIGhlcmU6ICcpOwogICAgICBldmVudC5pbml0Q3VzdG9tRXZlbnQodHlwZSwKICAgICAgICBvcHRpb25zLmJ1YmJsZXMgPT0gZmFsc2UgPyBmYWxzZSA6IHRydWUsCiAgICAgICAgb3B0aW9ucy5jYW5jZWxhYmxlID09IGZhbHNlID8gZmFsc2UgOiB0cnVlLAogICAgICAgIG9wdGlvbnMuZGV0YWlsCiAgICAgICk7CiAgICAgIHRyeSB7IGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7IH0KICAgICAgY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ1RoaXMgZXJyb3IgbWF5IGhhdmUgYmVlbiBjYXVzZWQgYnkgYSBjaGFuZ2UgaW4gdGhlIGZpcmVFdmVudCBtZXRob2QsIG1vcmUgaW5mbyBoZXJlOiAnLCBlKTsKICAgICAgfQogICAgfSwKCiAgICBhZGRPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICBpZiAoIWVsZW1lbnQuX3JlY29yZHMpIHsKICAgICAgICBlbGVtZW50Ll9yZWNvcmRzID0geyBpbnNlcnRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICAgICAgaWYgKG11dGF0aW9uKXsKICAgICAgICAgIGVsZW1lbnQuX29ic2VydmVyID0gbmV3IG11dGF0aW9uKGZ1bmN0aW9uKG11dGF0aW9ucykgewogICAgICAgICAgICBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpOwogICAgICAgICAgfSk7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlci5vYnNlcnZlKGVsZW1lbnQsIHsKICAgICAgICAgICAgc3VidHJlZTogdHJ1ZSwKICAgICAgICAgICAgY2hpbGRMaXN0OiB0cnVlLAogICAgICAgICAgICBhdHRyaWJ1dGVzOiAhdHJ1ZSwKICAgICAgICAgICAgY2hhcmFjdGVyRGF0YTogZmFsc2UKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBlbHNlIFsnSW5zZXJ0ZWQnLCAnUmVtb3ZlZCddLmZvckVhY2goZnVuY3Rpb24odHlwZSl7CiAgICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGUnICsgdHlwZSwgZnVuY3Rpb24oZXZlbnQpewogICAgICAgICAgICBldmVudC5fbXV0YXRpb24gPSB0cnVlOwogICAgICAgICAgICBlbGVtZW50Ll9yZWNvcmRzW3R5cGUudG9Mb3dlckNhc2UoKV0uZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgICAgZm4oZXZlbnQudGFyZ2V0LCBldmVudCk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSwgZmFsc2UpOwogICAgICAgIH0pOwogICAgICB9CiAgICAgIGlmIChlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLmluZGV4T2YoZm4pID09IC0xKSBlbGVtZW50Ll9yZWNvcmRzW3R5cGVdLnB1c2goZm4pOwogICAgfSwKCiAgICByZW1vdmVPYnNlcnZlcjogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgZm4pewogICAgICB2YXIgb2JqID0gZWxlbWVudC5fcmVjb3JkczsKICAgICAgaWYgKG9iaiAmJiBmbil7CiAgICAgICAgb2JqW3R5cGVdLnNwbGljZShvYmpbdHlwZV0uaW5kZXhPZihmbiksIDEpOwogICAgICB9CiAgICAgIGVsc2V7CiAgICAgICAgb2JqW3R5cGVdID0gW107CiAgICAgIH0KICAgIH0KCiAgfTsKCiAgaWYgKHR5cGVvZiBkZWZpbmUgPT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKSBkZWZpbmUoeHRhZyk7CiAgZWxzZSB3aW4ueHRhZyA9IHh0YWc7CgogIGRvYy5hZGRFdmVudExpc3RlbmVyKCdXZWJDb21wb25lbnRzUmVhZHknLCBmdW5jdGlvbigpewogICAgeHRhZy5maXJlRXZlbnQoZG9jLmJvZHksICdET01Db21wb25lbnRzTG9hZGVkJyk7CiAgfSk7Cgp9KSgpOw==",
                "body": "Ly8gV2UgZG9uJ3QgdXNlIHRoZSBwbGF0Zm9ybSBib290c3RyYXBwZXIsIHNvIGZha2UgdGhpcyBzdHVmZi4KCndpbmRvdy5QbGF0Zm9ybSA9IHt9Owp2YXIgbG9nRmxhZ3MgPSB7fTsKCgoKLy8gRE9NVG9rZW5MaXN0IHBvbHlmaWxsIGZpciBJRTkKKGZ1bmN0aW9uICgpIHsKCmlmICh0eXBlb2Ygd2luZG93LkVsZW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8ICJjbGFzc0xpc3QiIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgcmV0dXJuOwoKdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKICAgIGluZGV4T2YgPSBwcm90b3R5cGUuaW5kZXhPZiwKICAgIHNsaWNlID0gcHJvdG90eXBlLnNsaWNlLAogICAgcHVzaCA9IHByb3RvdHlwZS5wdXNoLAogICAgc3BsaWNlID0gcHJvdG90eXBlLnNwbGljZSwKICAgIGpvaW4gPSBwcm90b3R5cGUuam9pbjsKCmZ1bmN0aW9uIERPTVRva2VuTGlzdChlbCkgewogIHRoaXMuX2VsZW1lbnQgPSBlbDsKICBpZiAoZWwuY2xhc3NOYW1lICE9IHRoaXMuX2NsYXNzQ2FjaGUpIHsKICAgIHRoaXMuX2NsYXNzQ2FjaGUgPSBlbC5jbGFzc05hbWU7CgogICAgaWYgKCF0aGlzLl9jbGFzc0NhY2hlKSByZXR1cm47CgogICAgICAvLyBUaGUgY2xhc3NOYW1lIG5lZWRzIHRvIGJlIHRyaW1tZWQgYW5kIHNwbGl0IG9uIHdoaXRlc3BhY2UKICAgICAgLy8gdG8gcmV0cmlldmUgYSBsaXN0IG9mIGNsYXNzZXMuCiAgICAgIHZhciBjbGFzc2VzID0gdGhpcy5fY2xhc3NDYWNoZS5yZXBsYWNlKC9eXHMrfFxzKyQvZywnJykuc3BsaXQoL1xzKy8pLAogICAgICAgIGk7CiAgICBmb3IgKGkgPSAwOyBpIDwgY2xhc3Nlcy5sZW5ndGg7IGkrKykgewogICAgICBwdXNoLmNhbGwodGhpcywgY2xhc3Nlc1tpXSk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gc2V0VG9DbGFzc05hbWUoZWwsIGNsYXNzZXMpIHsKICBlbC5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oJyAnKTsKfQoKRE9NVG9rZW5MaXN0LnByb3RvdHlwZSA9IHsKICBhZGQ6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICBpZih0aGlzLmNvbnRhaW5zKHRva2VuKSkgcmV0dXJuOwogICAgcHVzaC5jYWxsKHRoaXMsIHRva2VuKTsKICAgIHNldFRvQ2xhc3NOYW1lKHRoaXMuX2VsZW1lbnQsIHNsaWNlLmNhbGwodGhpcywgMCkpOwogIH0sCiAgY29udGFpbnM6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICByZXR1cm4gaW5kZXhPZi5jYWxsKHRoaXMsIHRva2VuKSAhPT0gLTE7CiAgfSwKICBpdGVtOiBmdW5jdGlvbihpbmRleCkgewogICAgcmV0dXJuIHRoaXNbaW5kZXhdIHx8IG51bGw7CiAgfSwKICByZW1vdmU6IGZ1bmN0aW9uKHRva2VuKSB7CiAgICB2YXIgaSA9IGluZGV4T2YuY2FsbCh0aGlzLCB0b2tlbik7CiAgICAgaWYgKGkgPT09IC0xKSB7CiAgICAgICByZXR1cm47CiAgICAgfQogICAgc3BsaWNlLmNhbGwodGhpcywgaSwgMSk7CiAgICBzZXRUb0NsYXNzTmFtZSh0aGlzLl9lbGVtZW50LCBzbGljZS5jYWxsKHRoaXMsIDApKTsKICB9LAogIHRvU3RyaW5nOiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBqb2luLmNhbGwodGhpcywgJyAnKTsKICB9LAogIHRvZ2dsZTogZnVuY3Rpb24odG9rZW4pIHsKICAgIGlmIChpbmRleE9mLmNhbGwodGhpcywgdG9rZW4pID09PSAtMSkgewogICAgICB0aGlzLmFkZCh0b2tlbik7CiAgICB9IGVsc2UgewogICAgICB0aGlzLnJlbW92ZSh0b2tlbik7CiAgICB9CiAgfQp9OwoKd2luZG93LkRPTVRva2VuTGlzdCA9IERPTVRva2VuTGlzdDsKCmZ1bmN0aW9uIGRlZmluZUVsZW1lbnRHZXR0ZXIgKG9iaiwgcHJvcCwgZ2V0dGVyKSB7CiAgaWYgKE9iamVjdC5kZWZpbmVQcm9wZXJ0eSkgewogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwgcHJvcCx7CiAgICAgIGdldCA6IGdldHRlcgogICAgfSkKICB9IGVsc2UgewogICAgb2JqLl9fZGVmaW5lR2V0dGVyX18ocHJvcCwgZ2V0dGVyKTsKICB9Cn0KCmRlZmluZUVsZW1lbnRHZXR0ZXIoRWxlbWVudC5wcm90b3R5cGUsICdjbGFzc0xpc3QnLCBmdW5jdGlvbiAoKSB7CiAgcmV0dXJuIG5ldyBET01Ub2tlbkxpc3QodGhpcyk7Cn0pOwoKfSkoKTsKCgovKgogKiBDb3B5cmlnaHQgMjAxMiBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3ZlcmVuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCi8vIFNpZGVUYWJsZSBpcyBhIHdlYWsgbWFwIHdoZXJlIHBvc3NpYmxlLiBJZiBXZWFrTWFwIGlzIG5vdCBhdmFpbGFibGUgdGhlCi8vIGFzc29jaWF0aW9uIGlzIHN0b3JlZCBhcyBhbiBleHBhbmRvIHByb3BlcnR5Lgp2YXIgU2lkZVRhYmxlOwovLyBUT0RPKGFydik6IFdlYWtNYXAgZG9lcyBub3QgYWxsb3cgZm9yIE5vZGUgZXRjIHRvIGJlIGtleXMgaW4gRmlyZWZveAppZiAodHlwZW9mIFdlYWtNYXAgIT09ICd1bmRlZmluZWQnICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZignRmlyZWZveC8nKSA8IDApIHsKICBTaWRlVGFibGUgPSBXZWFrTWFwOwp9IGVsc2UgewogIChmdW5jdGlvbigpIHsKICAgIHZhciBkZWZpbmVQcm9wZXJ0eSA9IE9iamVjdC5kZWZpbmVQcm9wZXJ0eTsKICAgIHZhciBoYXNPd25Qcm9wZXJ0eSA9IE9iamVjdC5oYXNPd25Qcm9wZXJ0eTsKICAgIHZhciBjb3VudGVyID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgJSAxZTk7CgogICAgU2lkZVRhYmxlID0gZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubmFtZSA9ICdfX3N0JyArIChNYXRoLnJhbmRvbSgpICogMWU5ID4+PiAwKSArIChjb3VudGVyKysgKyAnX18nKTsKICAgIH07CgogICAgU2lkZVRhYmxlLnByb3RvdHlwZSA9IHsKICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgZGVmaW5lUHJvcGVydHkoa2V5LCB0aGlzLm5hbWUsIHt2YWx1ZTogdmFsdWUsIHdyaXRhYmxlOiB0cnVlfSk7CiAgICAgIH0sCiAgICAgIGdldDogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwoa2V5LCB0aGlzLm5hbWUpID8ga2V5W3RoaXMubmFtZV0gOiB1bmRlZmluZWQ7CiAgICAgIH0sCiAgICAgIGRlbGV0ZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgdGhpcy5zZXQoa2V5LCB1bmRlZmluZWQpOwogICAgICB9CiAgICB9CiAgfSkoKTsKfQoKLyoKICogQ29weXJpZ2h0IDIwMTIgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJlbmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oZ2xvYmFsKSB7CgogIHZhciByZWdpc3RyYXRpb25zVGFibGUgPSBuZXcgU2lkZVRhYmxlKCk7CgogIC8vIFdlIHVzZSBzZXRJbW1lZGlhdGUgb3IgcG9zdE1lc3NhZ2UgZm9yIG91ciBmdXR1cmUgY2FsbGJhY2suCiAgdmFyIHNldEltbWVkaWF0ZSA9IHdpbmRvdy5tc1NldEltbWVkaWF0ZTsKCiAgLy8gVXNlIHBvc3QgbWVzc2FnZSB0byBlbXVsYXRlIHNldEltbWVkaWF0ZS4KICBpZiAoIXNldEltbWVkaWF0ZSkgewogICAgdmFyIHNldEltbWVkaWF0ZVF1ZXVlID0gW107CiAgICB2YXIgc2VudGluZWwgPSBTdHJpbmcoTWF0aC5yYW5kb20oKSk7CiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uKGUpIHsKICAgICAgaWYgKGUuZGF0YSA9PT0gc2VudGluZWwpIHsKICAgICAgICB2YXIgcXVldWUgPSBzZXRJbW1lZGlhdGVRdWV1ZTsKICAgICAgICBzZXRJbW1lZGlhdGVRdWV1ZSA9IFtdOwogICAgICAgIHF1ZXVlLmZvckVhY2goZnVuY3Rpb24oZnVuYykgewogICAgICAgICAgZnVuYygpOwogICAgICAgIH0pOwogICAgICB9CiAgICB9KTsKICAgIHNldEltbWVkaWF0ZSA9IGZ1bmN0aW9uKGZ1bmMpIHsKICAgICAgc2V0SW1tZWRpYXRlUXVldWUucHVzaChmdW5jKTsKICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHNlbnRpbmVsLCAnKicpOwogICAgfTsKICB9CgogIC8vIFRoaXMgaXMgdXNlZCB0byBlbnN1cmUgdGhhdCB3ZSBuZXZlciBzY2hlZHVsZSAyIGNhbGxhcyB0byBzZXRJbW1lZGlhdGUKICB2YXIgaXNTY2hlZHVsZWQgPSBmYWxzZTsKCiAgLy8gS2VlcCB0cmFjayBvZiBvYnNlcnZlcnMgdGhhdCBuZWVkcyB0byBiZSBub3RpZmllZCBuZXh0IHRpbWUuCiAgdmFyIHNjaGVkdWxlZE9ic2VydmVycyA9IFtdOwoKICAvKioKICAgKiBTY2hlZHVsZXMgfGRpc3BhdGNoQ2FsbGJhY2t8IHRvIGJlIGNhbGxlZCBpbiB0aGUgZnV0dXJlLgogICAqIEBwYXJhbSB7TXV0YXRpb25PYnNlcnZlcn0gb2JzZXJ2ZXIKICAgKi8KICBmdW5jdGlvbiBzY2hlZHVsZUNhbGxiYWNrKG9ic2VydmVyKSB7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMucHVzaChvYnNlcnZlcik7CiAgICBpZiAoIWlzU2NoZWR1bGVkKSB7CiAgICAgIGlzU2NoZWR1bGVkID0gdHJ1ZTsKICAgICAgc2V0SW1tZWRpYXRlKGRpc3BhdGNoQ2FsbGJhY2tzKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIHdyYXBJZk5lZWRlZChub2RlKSB7CiAgICByZXR1cm4gd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsICYmCiAgICAgICAgd2luZG93LlNoYWRvd0RPTVBvbHlmaWxsLndyYXBJZk5lZWRlZChub2RlKSB8fAogICAgICAgIG5vZGU7CiAgfQoKICBmdW5jdGlvbiBkaXNwYXRjaENhbGxiYWNrcygpIHsKICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNtdXRhdGlvbi1vYnNlcnZlcnMKCiAgICBpc1NjaGVkdWxlZCA9IGZhbHNlOyAvLyBVc2VkIHRvIGFsbG93IGEgbmV3IHNldEltbWVkaWF0ZSBjYWxsIGFib3ZlLgoKICAgIHZhciBvYnNlcnZlcnMgPSBzY2hlZHVsZWRPYnNlcnZlcnM7CiAgICBzY2hlZHVsZWRPYnNlcnZlcnMgPSBbXTsKICAgIC8vIFNvcnQgb2JzZXJ2ZXJzIGJhc2VkIG9uIHRoZWlyIGNyZWF0aW9uIFVJRCAoaW5jcmVtZW50YWwpLgogICAgb2JzZXJ2ZXJzLnNvcnQoZnVuY3Rpb24obzEsIG8yKSB7CiAgICAgIHJldHVybiBvMS51aWRfIC0gbzIudWlkXzsKICAgIH0pOwoKICAgIHZhciBhbnlOb25FbXB0eSA9IGZhbHNlOwogICAgb2JzZXJ2ZXJzLmZvckVhY2goZnVuY3Rpb24ob2JzZXJ2ZXIpIHsKCiAgICAgIC8vIDIuMSwgMi4yCiAgICAgIHZhciBxdWV1ZSA9IG9ic2VydmVyLnRha2VSZWNvcmRzKCk7CiAgICAgIC8vIDIuMy4gUmVtb3ZlIGFsbCB0cmFuc2llbnQgcmVnaXN0ZXJlZCBvYnNlcnZlcnMgd2hvc2Ugb2JzZXJ2ZXIgaXMgbW8uCiAgICAgIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcik7CgogICAgICAvLyAyLjQKICAgICAgaWYgKHF1ZXVlLmxlbmd0aCkgewogICAgICAgIG9ic2VydmVyLmNhbGxiYWNrXyhxdWV1ZSwgb2JzZXJ2ZXIpOwogICAgICAgIGFueU5vbkVtcHR5ID0gdHJ1ZTsKICAgICAgfQogICAgfSk7CgogICAgLy8gMy4KICAgIGlmIChhbnlOb25FbXB0eSkKICAgICAgZGlzcGF0Y2hDYWxsYmFja3MoKTsKICB9CgogIGZ1bmN0aW9uIHJlbW92ZVRyYW5zaWVudE9ic2VydmVyc0ZvcihvYnNlcnZlcikgewogICAgb2JzZXJ2ZXIubm9kZXNfLmZvckVhY2goZnVuY3Rpb24obm9kZSkgewogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZXR1cm47CiAgICAgIHJlZ2lzdHJhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWdpc3RyYXRpb24pIHsKICAgICAgICBpZiAocmVnaXN0cmF0aW9uLm9ic2VydmVyID09PSBvYnNlcnZlcikKICAgICAgICAgIHJlZ2lzdHJhdGlvbi5yZW1vdmVUcmFuc2llbnRPYnNlcnZlcnMoKTsKICAgICAgfSk7CiAgICB9KTsKICB9CgogIC8qKgogICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBmb3IgdGhlICJGb3IgZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoCiAgICogb2JzZXJ2ZXIncyBvcHRpb25zIGFzIG9wdGlvbnMpIGluIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsCiAgICogcnVuIHRoZXNlIHN1YnN0ZXBzOiIgYW5kIHRoZSAiRm9yIGVhY2ggYW5jZXN0b3IgYW5jZXN0b3Igb2YgdGFyZ2V0LCBhbmQgZm9yCiAgICogZWFjaCByZWdpc3RlcmVkIG9ic2VydmVyIG9ic2VydmVyICh3aXRoIG9wdGlvbnMgb3B0aW9ucykgaW4gYW5jZXN0b3IncyBsaXN0CiAgICogb2YgcmVnaXN0ZXJlZCBvYnNlcnZlcnMsIHJ1biB0aGVzZSBzdWJzdGVwczoiIHBhcnQgb2YgdGhlIGFsZ29yaXRobXMuIFRoZQogICAqIHxvcHRpb25zLnN1YnRyZWV8IGlzIGNoZWNrZWQgdG8gZW5zdXJlIHRoYXQgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAqIGNvcnJlY3RseS4KICAgKgogICAqIEBwYXJhbSB7Tm9kZX0gdGFyZ2V0CiAgICogQHBhcmFtIHtmdW5jdGlvbihNdXRhdGlvbk9ic2VydmVySW5pdCk6TXV0YXRpb25SZWNvcmR9IGNhbGxiYWNrCiAgICovCiAgZnVuY3Rpb24gZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgY2FsbGJhY2spIHsKICAgIGZvciAodmFyIG5vZGUgPSB0YXJnZXQ7IG5vZGU7IG5vZGUgPSBub2RlLnBhcmVudE5vZGUpIHsKICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwoKICAgICAgaWYgKHJlZ2lzdHJhdGlvbnMpIHsKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHJlZ2lzdHJhdGlvbnMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIHZhciByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2pdOwogICAgICAgICAgdmFyIG9wdGlvbnMgPSByZWdpc3RyYXRpb24ub3B0aW9uczsKCiAgICAgICAgICAvLyBPbmx5IHRhcmdldCBpZ25vcmVzIHN1YnRyZWUuCiAgICAgICAgICBpZiAobm9kZSAhPT0gdGFyZ2V0ICYmICFvcHRpb25zLnN1YnRyZWUpCiAgICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICAgIHZhciByZWNvcmQgPSBjYWxsYmFjayhvcHRpb25zKTsKICAgICAgICAgIGlmIChyZWNvcmQpCiAgICAgICAgICAgIHJlZ2lzdHJhdGlvbi5lbnF1ZXVlKHJlY29yZCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQoKICB2YXIgdWlkQ291bnRlciA9IDA7CgogIC8qKgogICAqIFRoZSBjbGFzcyB0aGF0IG1hcHMgdG8gdGhlIERPTSBNdXRhdGlvbk9ic2VydmVyIGludGVyZmFjZS4KICAgKiBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjay4KICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBKc011dGF0aW9uT2JzZXJ2ZXIoY2FsbGJhY2spIHsKICAgIHRoaXMuY2FsbGJhY2tfID0gY2FsbGJhY2s7CiAgICB0aGlzLm5vZGVzXyA9IFtdOwogICAgdGhpcy5yZWNvcmRzXyA9IFtdOwogICAgdGhpcy51aWRfID0gKyt1aWRDb3VudGVyOwogIH0KCiAgSnNNdXRhdGlvbk9ic2VydmVyLnByb3RvdHlwZSA9IHsKICAgIG9ic2VydmU6IGZ1bmN0aW9uKHRhcmdldCwgb3B0aW9ucykgewogICAgICB0YXJnZXQgPSB3cmFwSWZOZWVkZWQodGFyZ2V0KTsKCiAgICAgIC8vIDEuMQogICAgICBpZiAoIW9wdGlvbnMuY2hpbGRMaXN0ICYmICFvcHRpb25zLmF0dHJpYnV0ZXMgJiYgIW9wdGlvbnMuY2hhcmFjdGVyRGF0YSB8fAoKICAgICAgICAgIC8vIDEuMgogICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSAmJiAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS4zCiAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlciAmJiBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5sZW5ndGggJiYKICAgICAgICAgICAgICAhb3B0aW9ucy5hdHRyaWJ1dGVzIHx8CgogICAgICAgICAgLy8gMS40CiAgICAgICAgICBvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSAmJiAhb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKSB7CgogICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcigpOwogICAgICB9CgogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQodGFyZ2V0KTsKICAgICAgaWYgKCFyZWdpc3RyYXRpb25zKQogICAgICAgIHJlZ2lzdHJhdGlvbnNUYWJsZS5zZXQodGFyZ2V0LCByZWdpc3RyYXRpb25zID0gW10pOwoKICAgICAgLy8gMgogICAgICAvLyBJZiB0YXJnZXQncyBsaXN0IG9mIHJlZ2lzdGVyZWQgb2JzZXJ2ZXJzIGFscmVhZHkgaW5jbHVkZXMgYSByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aCB0aGUgY29udGV4dCBvYmplY3QsIHJlcGxhY2UgdGhhdCByZWdpc3RlcmVkCiAgICAgIC8vIG9ic2VydmVyJ3Mgb3B0aW9ucyB3aXRoIG9wdGlvbnMuCiAgICAgIHZhciByZWdpc3RyYXRpb247CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmIChyZWdpc3RyYXRpb25zW2ldLm9ic2VydmVyID09PSB0aGlzKSB7CiAgICAgICAgICByZWdpc3RyYXRpb24gPSByZWdpc3RyYXRpb25zW2ldOwogICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgcmVnaXN0cmF0aW9uLm9wdGlvbnMgPSBvcHRpb25zOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyAzLgogICAgICAvLyBPdGhlcndpc2UsIGFkZCBhIG5ldyByZWdpc3RlcmVkIG9ic2VydmVyIHRvIHRhcmdldCdzIGxpc3Qgb2YgcmVnaXN0ZXJlZAogICAgICAvLyBvYnNlcnZlcnMgd2l0aCB0aGUgY29udGV4dCBvYmplY3QgYXMgdGhlIG9ic2VydmVyIGFuZCBvcHRpb25zIGFzIHRoZQogICAgICAvLyBvcHRpb25zLCBhbmQgYWRkIHRhcmdldCB0byBjb250ZXh0IG9iamVjdCdzIGxpc3Qgb2Ygbm9kZXMgb24gd2hpY2ggaXQKICAgICAgLy8gaXMgcmVnaXN0ZXJlZC4KICAgICAgaWYgKCFyZWdpc3RyYXRpb24pIHsKICAgICAgICByZWdpc3RyYXRpb24gPSBuZXcgUmVnaXN0cmF0aW9uKHRoaXMsIHRhcmdldCwgb3B0aW9ucyk7CiAgICAgICAgcmVnaXN0cmF0aW9ucy5wdXNoKHJlZ2lzdHJhdGlvbik7CiAgICAgICAgdGhpcy5ub2Rlc18ucHVzaCh0YXJnZXQpOwogICAgICB9CgogICAgICByZWdpc3RyYXRpb24uYWRkTGlzdGVuZXJzKCk7CiAgICB9LAoKICAgIGRpc2Nvbm5lY3Q6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLm5vZGVzXy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCByZWdpc3RyYXRpb25zLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICB2YXIgcmVnaXN0cmF0aW9uID0gcmVnaXN0cmF0aW9uc1tpXTsKICAgICAgICAgIGlmIChyZWdpc3RyYXRpb24ub2JzZXJ2ZXIgPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9uLnJlbW92ZUxpc3RlbmVycygpOwogICAgICAgICAgICByZWdpc3RyYXRpb25zLnNwbGljZShpLCAxKTsKICAgICAgICAgICAgLy8gRWFjaCBub2RlIGNhbiBvbmx5IGhhdmUgb25lIHJlZ2lzdGVyZWQgb2JzZXJ2ZXIgYXNzb2NpYXRlZCB3aXRoCiAgICAgICAgICAgIC8vIHRoaXMgb2JzZXJ2ZXIuCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwgdGhpcyk7CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgIH0sCgogICAgdGFrZVJlY29yZHM6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgY29weU9mUmVjb3JkcyA9IHRoaXMucmVjb3Jkc187CiAgICAgIHRoaXMucmVjb3Jkc18gPSBbXTsKICAgICAgcmV0dXJuIGNvcHlPZlJlY29yZHM7CiAgICB9CiAgfTsKCiAgLyoqCiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGUKICAgKiBAcGFyYW0ge05vZGV9IHRhcmdldAogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIE11dGF0aW9uUmVjb3JkKHR5cGUsIHRhcmdldCkgewogICAgdGhpcy50eXBlID0gdHlwZTsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5hZGRlZE5vZGVzID0gW107CiAgICB0aGlzLnJlbW92ZWROb2RlcyA9IFtdOwogICAgdGhpcy5wcmV2aW91c1NpYmxpbmcgPSBudWxsOwogICAgdGhpcy5uZXh0U2libGluZyA9IG51bGw7CiAgICB0aGlzLmF0dHJpYnV0ZU5hbWUgPSBudWxsOwogICAgdGhpcy5hdHRyaWJ1dGVOYW1lc3BhY2UgPSBudWxsOwogICAgdGhpcy5vbGRWYWx1ZSA9IG51bGw7CiAgfQoKICBmdW5jdGlvbiBjb3B5TXV0YXRpb25SZWNvcmQob3JpZ2luYWwpIHsKICAgIHZhciByZWNvcmQgPSBuZXcgTXV0YXRpb25SZWNvcmQob3JpZ2luYWwudHlwZSwgb3JpZ2luYWwudGFyZ2V0KTsKICAgIHJlY29yZC5hZGRlZE5vZGVzID0gb3JpZ2luYWwuYWRkZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IG9yaWdpbmFsLnJlbW92ZWROb2Rlcy5zbGljZSgpOwogICAgcmVjb3JkLnByZXZpb3VzU2libGluZyA9IG9yaWdpbmFsLnByZXZpb3VzU2libGluZzsKICAgIHJlY29yZC5uZXh0U2libGluZyA9IG9yaWdpbmFsLm5leHRTaWJsaW5nOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBvcmlnaW5hbC5hdHRyaWJ1dGVOYW1lOwogICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG9yaWdpbmFsLmF0dHJpYnV0ZU5hbWVzcGFjZTsKICAgIHJlY29yZC5vbGRWYWx1ZSA9IG9yaWdpbmFsLm9sZFZhbHVlOwogICAgcmV0dXJuIHJlY29yZDsKICB9OwoKICAvLyBXZSBrZWVwIHRyYWNrIG9mIHRoZSB0d28gKHBvc3NpYmx5IG9uZSkgcmVjb3JkcyB1c2VkIGluIGEgc2luZ2xlIG11dGF0aW9uLgogIHZhciBjdXJyZW50UmVjb3JkLCByZWNvcmRXaXRoT2xkVmFsdWU7CgogIC8qKgogICAqIENyZWF0ZXMgYSByZWNvcmQgd2l0aG91dCB8b2xkVmFsdWV8IGFuZCBjYWNoZXMgaXQgYXMgfGN1cnJlbnRSZWNvcmR8IGZvcgogICAqIGxhdGVyIHVzZS4KICAgKiBAcGFyYW0ge3N0cmluZ30gb2xkVmFsdWUKICAgKiBAcmV0dXJuIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBnZXRSZWNvcmQodHlwZSwgdGFyZ2V0KSB7CiAgICByZXR1cm4gY3VycmVudFJlY29yZCA9IG5ldyBNdXRhdGlvblJlY29yZCh0eXBlLCB0YXJnZXQpOwogIH0KCiAgLyoqCiAgICogR2V0cyBvciBjcmVhdGVzIGEgcmVjb3JkIHdpdGggfG9sZFZhbHVlfCBiYXNlZCBpbiB0aGUgfGN1cnJlbnRSZWNvcmR8CiAgICogQHBhcmFtIHtzdHJpbmd9IG9sZFZhbHVlCiAgICogQHJldHVybiB7TXV0YXRpb25SZWNvcmR9CiAgICovCiAgZnVuY3Rpb24gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKSB7CiAgICBpZiAocmVjb3JkV2l0aE9sZFZhbHVlKQogICAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlID0gY29weU11dGF0aW9uUmVjb3JkKGN1cnJlbnRSZWNvcmQpOwogICAgcmVjb3JkV2l0aE9sZFZhbHVlLm9sZFZhbHVlID0gb2xkVmFsdWU7CiAgICByZXR1cm4gcmVjb3JkV2l0aE9sZFZhbHVlOwogIH0KCiAgZnVuY3Rpb24gY2xlYXJSZWNvcmRzKCkgewogICAgY3VycmVudFJlY29yZCA9IHJlY29yZFdpdGhPbGRWYWx1ZSA9IHVuZGVmaW5lZDsKICB9CgogIC8qKgogICAqIEBwYXJhbSB7TXV0YXRpb25SZWNvcmR9IHJlY29yZAogICAqIEByZXR1cm4ge2Jvb2xlYW59IFdoZXRoZXIgdGhlIHJlY29yZCByZXByZXNlbnRzIGEgcmVjb3JkIGZyb20gdGhlIGN1cnJlbnQKICAgKiBtdXRhdGlvbiBldmVudC4KICAgKi8KICBmdW5jdGlvbiByZWNvcmRSZXByZXNlbnRzQ3VycmVudE11dGF0aW9uKHJlY29yZCkgewogICAgcmV0dXJuIHJlY29yZCA9PT0gcmVjb3JkV2l0aE9sZFZhbHVlIHx8IHJlY29yZCA9PT0gY3VycmVudFJlY29yZDsKICB9CgogIC8qKgogICAqIFNlbGVjdHMgd2hpY2ggcmVjb3JkLCBpZiBhbnksIHRvIHJlcGxhY2UgdGhlIGxhc3QgcmVjb3JkIGluIHRoZSBxdWV1ZS4KICAgKiBUaGlzIHJldHVybnMgfG51bGx8IGlmIG5vIHJlY29yZCBzaG91bGQgYmUgcmVwbGFjZWQuCiAgICoKICAgKiBAcGFyYW0ge011dGF0aW9uUmVjb3JkfSBsYXN0UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0gbmV3UmVjb3JkCiAgICogQHBhcmFtIHtNdXRhdGlvblJlY29yZH0KICAgKi8KICBmdW5jdGlvbiBzZWxlY3RSZWNvcmQobGFzdFJlY29yZCwgbmV3UmVjb3JkKSB7CiAgICBpZiAobGFzdFJlY29yZCA9PT0gbmV3UmVjb3JkKQogICAgICByZXR1cm4gbGFzdFJlY29yZDsKCiAgICAvLyBDaGVjayBpZiB0aGUgdGhlIHJlY29yZCB3ZSBhcmUgYWRkaW5nIHJlcHJlc2VudHMgdGhlIHNhbWUgcmVjb3JkLiBJZgogICAgLy8gc28sIHdlIGtlZXAgdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZSBpbiBpdC4KICAgIGlmIChyZWNvcmRXaXRoT2xkVmFsdWUgJiYgcmVjb3JkUmVwcmVzZW50c0N1cnJlbnRNdXRhdGlvbihsYXN0UmVjb3JkKSkKICAgICAgcmV0dXJuIHJlY29yZFdpdGhPbGRWYWx1ZTsKCiAgICByZXR1cm4gbnVsbDsKICB9CgogIC8qKgogICAqIENsYXNzIHVzZWQgdG8gcmVwcmVzZW50IGEgcmVnaXN0ZXJlZCBvYnNlcnZlci4KICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJ9IG9ic2VydmVyCiAgICogQHBhcmFtIHtOb2RlfSB0YXJnZXQKICAgKiBAcGFyYW0ge011dGF0aW9uT2JzZXJ2ZXJJbml0fSBvcHRpb25zCiAgICogQGNvbnN0cnVjdG9yCiAgICovCiAgZnVuY3Rpb24gUmVnaXN0cmF0aW9uKG9ic2VydmVyLCB0YXJnZXQsIG9wdGlvbnMpIHsKICAgIHRoaXMub2JzZXJ2ZXIgPSBvYnNlcnZlcjsKICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0OwogICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwogIH0KCiAgUmVnaXN0cmF0aW9uLnByb3RvdHlwZSA9IHsKICAgIGVucXVldWU6IGZ1bmN0aW9uKHJlY29yZCkgewogICAgICB2YXIgcmVjb3JkcyA9IHRoaXMub2JzZXJ2ZXIucmVjb3Jkc187CiAgICAgIHZhciBsZW5ndGggPSByZWNvcmRzLmxlbmd0aDsKCiAgICAgIC8vIFRoZXJlIGFyZSBjYXNlcyB3aGVyZSB3ZSByZXBsYWNlIHRoZSBsYXN0IHJlY29yZCB3aXRoIHRoZSBuZXcgcmVjb3JkLgogICAgICAvLyBGb3IgZXhhbXBsZSBpZiB0aGUgcmVjb3JkIHJlcHJlc2VudHMgdGhlIHNhbWUgbXV0YXRpb24gd2UgbmVlZCB0byB1c2UKICAgICAgLy8gdGhlIG9uZSB3aXRoIHRoZSBvbGRWYWx1ZS4gSWYgd2UgZ2V0IHNhbWUgcmVjb3JkICh0aGlzIGNhbiBoYXBwZW4gYXMgd2UKICAgICAgLy8gd2FsayB1cCB0aGUgdHJlZSkgd2UgaWdub3JlIHRoZSBuZXcgcmVjb3JkLgogICAgICBpZiAocmVjb3Jkcy5sZW5ndGggPiAwKSB7CiAgICAgICAgdmFyIGxhc3RSZWNvcmQgPSByZWNvcmRzW2xlbmd0aCAtIDFdOwogICAgICAgIHZhciByZWNvcmRUb1JlcGxhY2VMYXN0ID0gc2VsZWN0UmVjb3JkKGxhc3RSZWNvcmQsIHJlY29yZCk7CiAgICAgICAgaWYgKHJlY29yZFRvUmVwbGFjZUxhc3QpIHsKICAgICAgICAgIHJlY29yZHNbbGVuZ3RoIC0gMV0gPSByZWNvcmRUb1JlcGxhY2VMYXN0OwogICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBzY2hlZHVsZUNhbGxiYWNrKHRoaXMub2JzZXJ2ZXIpOwogICAgICB9CgogICAgICByZWNvcmRzW2xlbmd0aF0gPSByZWNvcmQ7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuYWRkTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIGFkZExpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5hZGRFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLmFkZEV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyczogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyh0aGlzLnRhcmdldCk7CiAgICB9LAoKICAgIHJlbW92ZUxpc3RlbmVyc186IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CiAgICAgIGlmIChvcHRpb25zLmF0dHJpYnV0ZXMpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01BdHRyTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGEpCiAgICAgICAgbm9kZS5yZW1vdmVFdmVudExpc3RlbmVyKCdET01DaGFyYWN0ZXJEYXRhTW9kaWZpZWQnLCB0aGlzLCB0cnVlKTsKCiAgICAgIGlmIChvcHRpb25zLmNoaWxkTGlzdCkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVJbnNlcnRlZCcsIHRoaXMsIHRydWUpOwoKICAgICAgaWYgKG9wdGlvbnMuY2hpbGRMaXN0IHx8IG9wdGlvbnMuc3VidHJlZSkKICAgICAgICBub2RlLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ0RPTU5vZGVSZW1vdmVkJywgdGhpcywgdHJ1ZSk7CiAgICB9LAoKICAgIC8qKgogICAgICogQWRkcyBhIHRyYW5zaWVudCBvYnNlcnZlciBvbiBub2RlLiBUaGUgdHJhbnNpZW50IG9ic2VydmVyIGdldHMgcmVtb3ZlZAogICAgICogbmV4dCB0aW1lIHdlIGRlbGl2ZXIgdGhlIGNoYW5nZSByZWNvcmRzLgogICAgICogQHBhcmFtIHtOb2RlfSBub2RlCiAgICAgKi8KICAgIGFkZFRyYW5zaWVudE9ic2VydmVyOiBmdW5jdGlvbihub2RlKSB7CiAgICAgIC8vIERvbid0IGFkZCB0cmFuc2llbnQgb2JzZXJ2ZXJzIG9uIHRoZSB0YXJnZXQgaXRzZWxmLiBXZSBhbHJlYWR5IGhhdmUgYWxsCiAgICAgIC8vIHRoZSByZXF1aXJlZCBsaXN0ZW5lcnMgc2V0IHVwIG9uIHRoZSB0YXJnZXQuCiAgICAgIGlmIChub2RlID09PSB0aGlzLnRhcmdldCkKICAgICAgICByZXR1cm47CgogICAgICB0aGlzLmFkZExpc3RlbmVyc18obm9kZSk7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5wdXNoKG5vZGUpOwogICAgICB2YXIgcmVnaXN0cmF0aW9ucyA9IHJlZ2lzdHJhdGlvbnNUYWJsZS5nZXQobm9kZSk7CiAgICAgIGlmICghcmVnaXN0cmF0aW9ucykKICAgICAgICByZWdpc3RyYXRpb25zVGFibGUuc2V0KG5vZGUsIHJlZ2lzdHJhdGlvbnMgPSBbXSk7CgogICAgICAvLyBXZSBrbm93IHRoYXQgcmVnaXN0cmF0aW9ucyBkb2VzIG5vdCBjb250YWluIHRoaXMgYmVjYXVzZSB3ZSBhbHJlYWR5CiAgICAgIC8vIGNoZWNrZWQgaWYgbm9kZSA9PT0gdGhpcy50YXJnZXQuCiAgICAgIHJlZ2lzdHJhdGlvbnMucHVzaCh0aGlzKTsKICAgIH0sCgogICAgcmVtb3ZlVHJhbnNpZW50T2JzZXJ2ZXJzOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHRyYW5zaWVudE9ic2VydmVkTm9kZXMgPSB0aGlzLnRyYW5zaWVudE9ic2VydmVkTm9kZXM7CiAgICAgIHRoaXMudHJhbnNpZW50T2JzZXJ2ZWROb2RlcyA9IFtdOwoKICAgICAgdHJhbnNpZW50T2JzZXJ2ZWROb2Rlcy5mb3JFYWNoKGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvLyBUcmFuc2llbnQgb2JzZXJ2ZXJzIGFyZSBuZXZlciBhZGRlZCB0byB0aGUgdGFyZ2V0LgogICAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzXyhub2RlKTsKCiAgICAgICAgdmFyIHJlZ2lzdHJhdGlvbnMgPSByZWdpc3RyYXRpb25zVGFibGUuZ2V0KG5vZGUpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVnaXN0cmF0aW9ucy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHJlZ2lzdHJhdGlvbnNbaV0gPT09IHRoaXMpIHsKICAgICAgICAgICAgcmVnaXN0cmF0aW9ucy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIC8vIEVhY2ggbm9kZSBjYW4gb25seSBoYXZlIG9uZSByZWdpc3RlcmVkIG9ic2VydmVyIGFzc29jaWF0ZWQgd2l0aAogICAgICAgICAgICAvLyB0aGlzIG9ic2VydmVyLgogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfSwKCiAgICBoYW5kbGVFdmVudDogZnVuY3Rpb24oZSkgewogICAgICAvLyBTdG9wIHByb3BhZ2F0aW9uIHNpbmNlIHdlIGFyZSBtYW5hZ2luZyB0aGUgcHJvcGFnYXRpb24gbWFudWFsbHkuCiAgICAgIC8vIFRoaXMgbWVhbnMgdGhhdCBvdGhlciBtdXRhdGlvbiBldmVudHMgb24gdGhlIHBhZ2Ugd2lsbCBub3Qgd29yawogICAgICAvLyBjb3JyZWN0bHkgYnV0IHRoYXQgaXMgYnkgZGVzaWduLgogICAgICBlLnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoKICAgICAgc3dpdGNoIChlLnR5cGUpIHsKICAgICAgICBjYXNlICdET01BdHRyTW9kaWZpZWQnOgogICAgICAgICAgLy8gaHR0cDovL2RvbS5zcGVjLndoYXR3Zy5vcmcvI2NvbmNlcHQtbW8tcXVldWUtYXR0cmlidXRlcwoKICAgICAgICAgIHZhciBuYW1lID0gZS5hdHRyTmFtZTsKICAgICAgICAgIHZhciBuYW1lc3BhY2UgPSBlLnJlbGF0ZWROb2RlLm5hbWVzcGFjZVVSSTsKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IG5ldyBnZXRSZWNvcmQoJ2F0dHJpYnV0ZXMnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWUgPSBuYW1lOwogICAgICAgICAgcmVjb3JkLmF0dHJpYnV0ZU5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCiAgICAgICAgICAvLyAyLgogICAgICAgICAgdmFyIG9sZFZhbHVlID0KICAgICAgICAgICAgICBlLmF0dHJDaGFuZ2UgPT09IE11dGF0aW9uRXZlbnQuQURESVRJT04gPyBudWxsIDogZS5wcmV2VmFsdWU7CgogICAgICAgICAgZm9yRWFjaEFuY2VzdG9yQW5kT2JzZXJ2ZXJFbnF1ZXVlUmVjb3JkKHRhcmdldCwgZnVuY3Rpb24ob3B0aW9ucykgewogICAgICAgICAgICAvLyAzLjEsIDQuMgogICAgICAgICAgICBpZiAoIW9wdGlvbnMuYXR0cmlidXRlcykKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICAvLyAzLjIsIDQuMwogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIgJiYgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIubGVuZ3RoICYmCiAgICAgICAgICAgICAgICBvcHRpb25zLmF0dHJpYnV0ZUZpbHRlci5pbmRleE9mKG5hbWUpID09PSAtMSAmJgogICAgICAgICAgICAgICAgb3B0aW9ucy5hdHRyaWJ1dGVGaWx0ZXIuaW5kZXhPZihuYW1lc3BhY2UpID09PSAtMSkgewogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyAzLjMsIDQuNAogICAgICAgICAgICBpZiAob3B0aW9ucy5hdHRyaWJ1dGVPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuNCwgNC41CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NQ2hhcmFjdGVyRGF0YU1vZGlmaWVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoYXJhY3RlcmRhdGEKICAgICAgICAgIHZhciB0YXJnZXQgPSBlLnRhcmdldDsKCiAgICAgICAgICAvLyAxLgogICAgICAgICAgdmFyIHJlY29yZCA9IGdldFJlY29yZCgnY2hhcmFjdGVyRGF0YScsIHRhcmdldCk7CgogICAgICAgICAgLy8gMi4KICAgICAgICAgIHZhciBvbGRWYWx1ZSA9IGUucHJldlZhbHVlOwoKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDMuMSwgNC4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGFyYWN0ZXJEYXRhKQogICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIC8vIDMuMiwgNC4zCiAgICAgICAgICAgIGlmIChvcHRpb25zLmNoYXJhY3RlckRhdGFPbGRWYWx1ZSkKICAgICAgICAgICAgICByZXR1cm4gZ2V0UmVjb3JkV2l0aE9sZFZhbHVlKG9sZFZhbHVlKTsKCiAgICAgICAgICAgIC8vIDMuMywgNC40CiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBicmVhazsKCiAgICAgICAgY2FzZSAnRE9NTm9kZVJlbW92ZWQnOgogICAgICAgICAgdGhpcy5hZGRUcmFuc2llbnRPYnNlcnZlcihlLnRhcmdldCk7CiAgICAgICAgICAvLyBGYWxsIHRocm91Z2guCiAgICAgICAgY2FzZSAnRE9NTm9kZUluc2VydGVkJzoKICAgICAgICAgIC8vIGh0dHA6Ly9kb20uc3BlYy53aGF0d2cub3JnLyNjb25jZXB0LW1vLXF1ZXVlLWNoaWxkbGlzdAogICAgICAgICAgdmFyIHRhcmdldCA9IGUucmVsYXRlZE5vZGU7CiAgICAgICAgICB2YXIgY2hhbmdlZE5vZGUgPSBlLnRhcmdldDsKICAgICAgICAgIHZhciBhZGRlZE5vZGVzLCByZW1vdmVkTm9kZXM7CiAgICAgICAgICBpZiAoZS50eXBlID09PSAnRE9NTm9kZUluc2VydGVkJykgewogICAgICAgICAgICBhZGRlZE5vZGVzID0gW2NoYW5nZWROb2RlXTsKICAgICAgICAgICAgcmVtb3ZlZE5vZGVzID0gW107CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgYWRkZWROb2RlcyA9IFtdOwogICAgICAgICAgICByZW1vdmVkTm9kZXMgPSBbY2hhbmdlZE5vZGVdOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHByZXZpb3VzU2libGluZyA9IGNoYW5nZWROb2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgIHZhciBuZXh0U2libGluZyA9IGNoYW5nZWROb2RlLm5leHRTaWJsaW5nOwoKICAgICAgICAgIC8vIDEuCiAgICAgICAgICB2YXIgcmVjb3JkID0gZ2V0UmVjb3JkKCdjaGlsZExpc3QnLCB0YXJnZXQpOwogICAgICAgICAgcmVjb3JkLmFkZGVkTm9kZXMgPSBhZGRlZE5vZGVzOwogICAgICAgICAgcmVjb3JkLnJlbW92ZWROb2RlcyA9IHJlbW92ZWROb2RlczsKICAgICAgICAgIHJlY29yZC5wcmV2aW91c1NpYmxpbmcgPSBwcmV2aW91c1NpYmxpbmc7CiAgICAgICAgICByZWNvcmQubmV4dFNpYmxpbmcgPSBuZXh0U2libGluZzsKCiAgICAgICAgICBmb3JFYWNoQW5jZXN0b3JBbmRPYnNlcnZlckVucXVldWVSZWNvcmQodGFyZ2V0LCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgICAgICAgIC8vIDIuMSwgMy4yCiAgICAgICAgICAgIGlmICghb3B0aW9ucy5jaGlsZExpc3QpCiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgLy8gMi4yLCAzLjMKICAgICAgICAgICAgcmV0dXJuIHJlY29yZDsKICAgICAgICAgIH0pOwoKICAgICAgfQoKICAgICAgY2xlYXJSZWNvcmRzKCk7CiAgICB9CiAgfTsKCiAgZ2xvYmFsLkpzTXV0YXRpb25PYnNlcnZlciA9IEpzTXV0YXRpb25PYnNlcnZlcjsKCn0pKHRoaXMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCmlmICghd2luZG93Lk11dGF0aW9uT2JzZXJ2ZXIpIHsKICB3aW5kb3cuTXV0YXRpb25PYnNlcnZlciA9CiAgICAgIHdpbmRvdy5XZWJLaXRNdXRhdGlvbk9ic2VydmVyIHx8CiAgICAgIHdpbmRvdy5Kc011dGF0aW9uT2JzZXJ2ZXI7CiAgaWYgKCFNdXRhdGlvbk9ic2VydmVyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIm5vIG11dGF0aW9uIG9ic2VydmVyIHN1cHBvcnQiKTsKICB9Cn0KCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgovKioKICogSW1wbGVtZW50cyBgZG9jdW1lbnQucmVnaXN0ZXJgCiAqIEBtb2R1bGUgQ3VzdG9tRWxlbWVudHMKKi8KCi8qKgogKiBQb2x5ZmlsbGVkIGV4dGVuc2lvbnMgdG8gdGhlIGBkb2N1bWVudGAgb2JqZWN0LgogKiBAY2xhc3MgRG9jdW1lbnQKKi8KCihmdW5jdGlvbihzY29wZSkgewoKaWYgKCFzY29wZSkgewogIHNjb3BlID0gd2luZG93LkN1c3RvbUVsZW1lbnRzID0ge2ZsYWdzOnt9fTsKfQoKLy8gbmF0aXZlIGRvY3VtZW50LnJlZ2lzdGVyPwoKc2NvcGUuaGFzTmF0aXZlID0gKGRvY3VtZW50LndlYmtpdFJlZ2lzdGVyIHx8IGRvY3VtZW50LnJlZ2lzdGVyKSAmJiBzY29wZS5mbGFncy5yZWdpc3RlciA9PT0gJ25hdGl2ZSc7CmlmIChzY29wZS5oYXNOYXRpdmUpIHsKCiAgLy8gbm9ybWFsaXplCiAgZG9jdW1lbnQucmVnaXN0ZXIgPSBkb2N1bWVudC5yZWdpc3RlciB8fCBkb2N1bWVudC53ZWJraXRSZWdpc3RlcjsKCiAgdmFyIG5vcCA9IGZ1bmN0aW9uKCkge307CgogIC8vIGV4cG9ydHMKICBzY29wZS5yZWdpc3RyeSA9IHt9OwogIHNjb3BlLnVwZ3JhZGVFbGVtZW50ID0gbm9wOwoKfSBlbHNlIHsKCi8qKgogKiBSZWdpc3RlcnMgYSBjdXN0b20gdGFnIG5hbWUgd2l0aCB0aGUgZG9jdW1lbnQuCiAqCiAqIFdoZW4gYSByZWdpc3RlcmVkIGVsZW1lbnQgaXMgY3JlYXRlZCwgYSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGlzIGNhbGxlZAogKiBpbiB0aGUgc2NvcGUgb2YgdGhlIGVsZW1lbnQuIFRoZSBgcmVhZHlDYWxsYmFja2AgbWV0aG9kIGNhbiBiZSBzcGVjaWZpZWQgb24KICogZWl0aGVyIGBpbk9wdGlvbnMucHJvdG90eXBlYCBvciBgaW5PcHRpb25zLmxpZmVjeWNsZWAgd2l0aCB0aGUgbGF0dGVyIHRha2luZwogKiBwcmVjZWRlbmNlLgogKgogKiBAbWV0aG9kIHJlZ2lzdGVyCiAqIEBwYXJhbSB7U3RyaW5nfSBpbk5hbWUgVGhlIHRhZyBuYW1lIHRvIHJlZ2lzdGVyLiBNdXN0IGluY2x1ZGUgYSBkYXNoICgnLScpLAogKiAgICBmb3IgZXhhbXBsZSAneC1jb21wb25lbnQnLgogKiBAcGFyYW0ge09iamVjdH0gaW5PcHRpb25zCiAqICAgIEBwYXJhbSB7U3RyaW5nfSBbaW5PcHRpb25zLmV4dGVuZHNdCiAqICAgICAgKF9vZmYgc3BlY18pIFRhZyBuYW1lIG9mIGFuIGVsZW1lbnQgdG8gZXh0ZW5kIChvciBibGFuayBmb3IgYSBuZXcKICogICAgICBlbGVtZW50KS4gVGhpcyBwYXJhbWV0ZXIgaXMgbm90IHBhcnQgb2YgdGhlIHNwZWNpZmljYXRpb24sIGJ1dCBpbnN0ZWFkCiAqICAgICAgaXMgYSBoaW50IGZvciB0aGUgcG9seWZpbGwgYmVjYXVzZSB0aGUgZXh0ZW5kZWUgaXMgZGlmZmljdWx0IHRvIGluZmVyLgogKiAgICAgIFJlbWVtYmVyIHRoYXQgdGhlIGlucHV0IHByb3RvdHlwZSBtdXN0IGNoYWluIHRvIHRoZSBleHRlbmRlZCBlbGVtZW50J3MKICogICAgICBwcm90b3R5cGUgKG9yIEhUTUxFbGVtZW50LnByb3RvdHlwZSkgcmVnYXJkbGVzcyBvZiB0aGUgdmFsdWUgb2YKICogICAgICBgZXh0ZW5kc2AuCiAqICAgIEBwYXJhbSB7T2JqZWN0fSBpbk9wdGlvbnMucHJvdG90eXBlIFRoZSBwcm90b3R5cGUgdG8gdXNlIGZvciB0aGUgbmV3CiAqICAgICAgZWxlbWVudC4gVGhlIHByb3RvdHlwZSBtdXN0IGluaGVyaXQgZnJvbSBIVE1MRWxlbWVudC4KICogICAgQHBhcmFtIHtPYmplY3R9IFtpbk9wdGlvbnMubGlmZWN5Y2xlXQogKiAgICAgIENhbGxiYWNrcyB0aGF0IGZpcmUgYXQgaW1wb3J0YW50IHBoYXNlcyBpbiB0aGUgbGlmZSBvZiB0aGUgY3VzdG9tCiAqICAgICAgZWxlbWVudC4KICoKICogQGV4YW1wbGUKICogICAgICBGYW5jeUJ1dHRvbiA9IGRvY3VtZW50LnJlZ2lzdGVyKCJmYW5jeS1idXR0b24iLCB7CiAqICAgICAgICBleHRlbmRzOiAnYnV0dG9uJywKICogICAgICAgIHByb3RvdHlwZTogT2JqZWN0LmNyZWF0ZShIVE1MQnV0dG9uRWxlbWVudC5wcm90b3R5cGUsIHsKICogICAgICAgICAgcmVhZHlDYWxsYmFjazogewogKiAgICAgICAgICAgIHZhbHVlOiBmdW5jdGlvbigpIHsKICogICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJhIGZhbmN5LWJ1dHRvbiB3YXMgY3JlYXRlZCIsCiAqICAgICAgICAgICAgfQogKiAgICAgICAgICB9CiAqICAgICAgICB9KQogKiAgICAgIH0pOwogKiBAcmV0dXJuIHtGdW5jdGlvbn0gQ29uc3RydWN0b3IgZm9yIHRoZSBuZXdseSByZWdpc3RlcmVkIHR5cGUuCiAqLwpmdW5jdGlvbiByZWdpc3Rlcihpbk5hbWUsIGluT3B0aW9ucykgewogIC8vY29uc29sZS53YXJuKCdkb2N1bWVudC5yZWdpc3RlcigiJyArIGluTmFtZSArICciLCAnLCBpbk9wdGlvbnMsICcpJyk7CiAgLy8gY29uc3RydWN0IGEgZGVmaW50aW9uIG91dCBvZiBvcHRpb25zCiAgLy8gVE9ETyhzam1pbGVzKTogcHJvYmFibHkgc2hvdWxkIGNsb25lIGluT3B0aW9ucyBpbnN0ZWFkIG9mIG11dGF0aW5nIGl0CiAgdmFyIGRlZmluaXRpb24gPSBpbk9wdGlvbnMgfHwge307CiAgaWYgKCFpbk5hbWUpIHsKICAgIC8vIFRPRE8oc2ptaWxlcyk6IHJlcGxhY2Ugd2l0aCBtb3JlIGFwcHJvcHJpYXRlIGVycm9yIChFcmlrIGNhbiBwcm9iYWJseQogICAgLy8gb2ZmZXIgZ3VpZGFuY2UpCiAgICB0aHJvdyBuZXcgRXJyb3IoJ05hbWUgYXJndW1lbnQgbXVzdCBub3QgYmUgZW1wdHknKTsKICB9CiAgLy8gcmVjb3JkIG5hbWUKICBkZWZpbml0aW9uLm5hbWUgPSBpbk5hbWU7CiAgLy8gbXVzdCBoYXZlIGEgcHJvdG90eXBlLCBkZWZhdWx0IHRvIGFuIGV4dGVuc2lvbiBvZiBIVE1MRWxlbWVudAogIC8vIFRPRE8oc2ptaWxlcyk6IHByb2JhYmx5IHNob3VsZCB0aHJvdyBpZiBubyBwcm90b3R5cGUsIGNoZWNrIHNwZWMKICBpZiAoIWRlZmluaXRpb24ucHJvdG90eXBlKSB7CiAgICAvLyBUT0RPKHNqbWlsZXMpOiByZXBsYWNlIHdpdGggbW9yZSBhcHByb3ByaWF0ZSBlcnJvciAoRXJpayBjYW4gcHJvYmFibHkKICAgIC8vIG9mZmVyIGd1aWRhbmNlKQogICAgdGhyb3cgbmV3IEVycm9yKCdPcHRpb25zIG1pc3NpbmcgcmVxdWlyZWQgcHJvdG90eXBlIHByb3BlcnR5Jyk7CiAgfQogIC8vIGVuc3VyZSBhIGxpZmVjeWNsZSBvYmplY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBudWxsIHRlc3QgaXQKICBkZWZpbml0aW9uLmxpZmVjeWNsZSA9IGRlZmluaXRpb24ubGlmZWN5Y2xlIHx8IHt9OwogIC8vIGJ1aWxkIGEgbGlzdCBvZiBhbmNlc3RyYWwgY3VzdG9tIGVsZW1lbnRzIChmb3IgbmF0aXZlIGJhc2UgZGV0ZWN0aW9uKQogIC8vIFRPRE8oc2ptaWxlcyk6IHdlIHVzZWQgdG8gbmVlZCB0byBzdG9yZSB0aGlzLCBidXQgY3VycmVudCBjb2RlIG9ubHkKICAvLyB1c2VzIGl0IGluICdyZXNvbHZlVGFnTmFtZSc6IGl0IHNob3VsZCBwcm9iYWJseSBiZSBpbmxpbmVkCiAgZGVmaW5pdGlvbi5hbmNlc3RyeSA9IGFuY2VzdHJ5KGRlZmluaXRpb24uZXh0ZW5kcyk7CiAgLy8gZXh0ZW5zaW9ucyBvZiBuYXRpdmUgc3BlY2lhbGl6YXRpb25zIG9mIEhUTUxFbGVtZW50IHJlcXVpcmUgbG9jYWxOYW1lCiAgLy8gdG8gcmVtYWluIG5hdGl2ZSwgYW5kIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIgZm9yIGV4dGVuc2lvbiB0eXBlCiAgcmVzb2x2ZVRhZ05hbWUoZGVmaW5pdGlvbik7CiAgLy8gc29tZSBwbGF0Zm9ybXMgcmVxdWlyZSBtb2RpZmljYXRpb25zIHRvIHRoZSB1c2VyLXN1cHBsaWVkIHByb3RvdHlwZQogIC8vIGNoYWluCiAgcmVzb2x2ZVByb3RvdHlwZUNoYWluKGRlZmluaXRpb24pOwogIC8vIG92ZXJyaWRlcyB0byBpbXBsZW1lbnQgYXR0cmlidXRlQ2hhbmdlZCBjYWxsYmFjawogIG92ZXJyaWRlQXR0cmlidXRlQXBpKGRlZmluaXRpb24ucHJvdG90eXBlKTsKICAvLyA3LjEuNTogUmVnaXN0ZXIgdGhlIERFRklOSVRJT04gd2l0aCBET0NVTUVOVAogIHJlZ2lzdGVyRGVmaW5pdGlvbihpbk5hbWUsIGRlZmluaXRpb24pOwogIC8vIDcuMS43LiBSdW4gY3VzdG9tIGVsZW1lbnQgY29uc3RydWN0b3IgZ2VuZXJhdGlvbiBhbGdvcml0aG0gd2l0aCBQUk9UT1RZUEUKICAvLyA3LjEuOC4gUmV0dXJuIHRoZSBvdXRwdXQgb2YgdGhlIHByZXZpb3VzIHN0ZXAuCiAgZGVmaW5pdGlvbi5jdG9yID0gZ2VuZXJhdGVDb25zdHJ1Y3RvcihkZWZpbml0aW9uKTsKICBkZWZpbml0aW9uLmN0b3IucHJvdG90eXBlID0gZGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgLy8gZm9yY2Ugb3VyIC5jb25zdHJ1Y3RvciB0byBiZSBvdXIgYWN0dWFsIGNvbnN0cnVjdG9yCiAgZGVmaW5pdGlvbi5wcm90b3R5cGUuY29uc3RydWN0b3IgPSBkZWZpbml0aW9uLmN0b3I7CiAgLy8gaWYgaW5pdGlhbCBwYXJzaW5nIGlzIGNvbXBsZXRlCiAgaWYgKHNjb3BlLnJlYWR5KSB7CiAgICAvLyB1cGdyYWRlIGFueSBwcmUtZXhpc3Rpbmcgbm9kZXMgb2YgdGhpcyB0eXBlCiAgICBzY29wZS51cGdyYWRlQWxsKGRvY3VtZW50KTsKICB9CiAgcmV0dXJuIGRlZmluaXRpb24uY3RvcjsKfQoKZnVuY3Rpb24gYW5jZXN0cnkoaW5FeHRlbmRzKSB7CiAgdmFyIGV4dGVuZGVlID0gcmVnaXN0cnlbaW5FeHRlbmRzXTsKICBpZiAoZXh0ZW5kZWUpIHsKICAgIHJldHVybiBhbmNlc3RyeShleHRlbmRlZS5leHRlbmRzKS5jb25jYXQoW2V4dGVuZGVlXSk7CiAgfQogIHJldHVybiBbXTsKfQoKZnVuY3Rpb24gcmVzb2x2ZVRhZ05hbWUoaW5EZWZpbml0aW9uKSB7CiAgLy8gaWYgd2UgYXJlIGV4cGxpY2l0bHkgZXh0ZW5kaW5nIHNvbWV0aGluZywgdGhhdCB0aGluZyBpcyBvdXIKICAvLyBiYXNlVGFnLCB1bmxlc3MgaXQgcmVwcmVzZW50cyBhIGN1c3RvbSBjb21wb25lbnQKICB2YXIgYmFzZVRhZyA9IGluRGVmaW5pdGlvbi5leHRlbmRzOwogIC8vIGlmIG91ciBhbmNlc3RyeSBpbmNsdWRlcyBjdXN0b20gY29tcG9uZW50cywgd2Ugb25seSBoYXZlIGEKICAvLyBiYXNlVGFnIGlmIG9uZSBvZiB0aGVtIGRvZXMKICBmb3IgKHZhciBpPTAsIGE7IChhPWluRGVmaW5pdGlvbi5hbmNlc3RyeVtpXSk7IGkrKykgewogICAgYmFzZVRhZyA9IGEuaXMgJiYgYS50YWc7CiAgfQogIC8vIG91ciB0YWcgaXMgb3VyIGJhc2VUYWcsIGlmIGl0IGV4aXN0cywgYW5kIG90aGVyd2lzZSBqdXN0IG91ciBuYW1lCiAgaW5EZWZpbml0aW9uLnRhZyA9IGJhc2VUYWcgfHwgaW5EZWZpbml0aW9uLm5hbWU7CiAgaWYgKGJhc2VUYWcpIHsKICAgIC8vIGlmIHRoZXJlIGlzIGEgYmFzZSB0YWcsIHVzZSBzZWNvbmRhcnkgJ2lzJyBzcGVjaWZpZXIKICAgIGluRGVmaW5pdGlvbi5pcyA9IGluRGVmaW5pdGlvbi5uYW1lOwogIH0KfQoKZnVuY3Rpb24gcmVzb2x2ZVByb3RvdHlwZUNoYWluKGluRGVmaW5pdGlvbikgewogIC8vIGlmIHdlIGRvbid0IHN1cHBvcnQgX19wcm90b19fIHdlIG5lZWQgdG8gbG9jYXRlIHRoZSBuYXRpdmUgbGV2ZWwKICAvLyBwcm90b3R5cGUgZm9yIHByZWNpc2UgbWl4aW5nIGluCiAgaWYgKCFPYmplY3QuX19wcm90b19fKSB7CiAgICAvLyBkZWZhdWx0IHByb3RvdHlwZQogICAgdmFyIG5hdGl2ZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAgIC8vIHdvcmsgb3V0IHByb3RvdHlwZSB3aGVuIHVzaW5nIHR5cGUtZXh0ZW5zaW9uCiAgICBpZiAoaW5EZWZpbml0aW9uLmlzKSB7CiAgICAgIHZhciBpbnN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChpbkRlZmluaXRpb24udGFnKTsKICAgICAgbmF0aXZlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGluc3QpOwogICAgfQogIH0KICAvLyBjYWNoZSB0aGlzIGluIGNhc2Ugb2YgbWl4aW4KICBpbkRlZmluaXRpb24ubmF0aXZlID0gbmF0aXZlOwp9CgovLyBTRUNUSU9OIDQKCmZ1bmN0aW9uIGluc3RhbnRpYXRlKGluRGVmaW5pdGlvbikgewogIC8vIDQuYS4xLiBDcmVhdGUgYSBuZXcgb2JqZWN0IHRoYXQgaW1wbGVtZW50cyBQUk9UT1RZUEUKICAvLyA0LmEuMi4gTGV0IEVMRU1FTlQgYnkgdGhpcyBuZXcgb2JqZWN0CiAgLy8KICAvLyB0aGUgY3VzdG9tIGVsZW1lbnQgaW5zdGFudGlhdGlvbiBhbGdvcml0aG0gbXVzdCBhbHNvIGVuc3VyZSB0aGF0IHRoZQogIC8vIG91dHB1dCBpcyBhIHZhbGlkIERPTSBlbGVtZW50IHdpdGggdGhlIHByb3BlciB3cmFwcGVyIGluIHBsYWNlLgogIC8vCiAgcmV0dXJuIHVwZ3JhZGUoZG9tQ3JlYXRlRWxlbWVudChpbkRlZmluaXRpb24udGFnKSwgaW5EZWZpbml0aW9uKTsKfQoKZnVuY3Rpb24gdXBncmFkZShpbkVsZW1lbnQsIGluRGVmaW5pdGlvbikgewogIC8vIHNvbWUgZGVmaW5pdGlvbnMgc3BlY2lmeSBhbiAnaXMnIGF0dHJpYnV0ZQogIGlmIChpbkRlZmluaXRpb24uaXMpIHsKICAgIGluRWxlbWVudC5zZXRBdHRyaWJ1dGUoJ2lzJywgaW5EZWZpbml0aW9uLmlzKTsKICB9CiAgLy8gbWFrZSAnZWxlbWVudCcgaW1wbGVtZW50IGluRGVmaW5pdGlvbi5wcm90b3R5cGUKICBpbXBsZW1lbnQoaW5FbGVtZW50LCBpbkRlZmluaXRpb24pOwogIC8vIGZsYWcgYXMgdXBncmFkZWQKICBpbkVsZW1lbnQuX191cGdyYWRlZF9fID0gdHJ1ZTsKICAvLyB0aGVyZSBzaG91bGQgbmV2ZXIgYmUgYSBzaGFkb3cgcm9vdCBvbiBpbkVsZW1lbnQgYXQgdGhpcyBwb2ludAogIC8vIHdlIHJlcXVpcmUgY2hpbGQgbm9kZXMgYmUgdXBncmFkZWQgYmVmb3JlIHJlYWR5CiAgc2NvcGUudXBncmFkZVN1YnRyZWUoaW5FbGVtZW50KTsKICAvLyBsaWZlY3ljbGUgbWFuYWdlbWVudAogIHJlYWR5KGluRWxlbWVudCk7CiAgLy8gT1VUUFVUCiAgcmV0dXJuIGluRWxlbWVudDsKfQoKZnVuY3Rpb24gaW1wbGVtZW50KGluRWxlbWVudCwgaW5EZWZpbml0aW9uKSB7CiAgLy8gcHJvdG90eXBlIHN3aXp6bGluZyBpcyBiZXN0CiAgaWYgKE9iamVjdC5fX3Byb3RvX18pIHsKICAgIGluRWxlbWVudC5fX3Byb3RvX18gPSBpbkRlZmluaXRpb24ucHJvdG90eXBlOwogIH0gZWxzZSB7CiAgICAvLyB3aGVyZSBhYm92ZSB3ZSBjYW4gcmUtYWNxdWlyZSBpblByb3RvdHlwZSB2aWEKICAgIC8vIGdldFByb3RvdHlwZU9mKEVsZW1lbnQpLCB3ZSBjYW5ub3QgZG8gc28gd2hlbgogICAgLy8gd2UgdXNlIG1peGluLCBzbyB3ZSBpbnN0YWxsIGEgbWFnaWMgcmVmZXJlbmNlCiAgICBjdXN0b21NaXhpbihpbkVsZW1lbnQsIGluRGVmaW5pdGlvbi5wcm90b3R5cGUsIGluRGVmaW5pdGlvbi5uYXRpdmUpOwogICAgaW5FbGVtZW50Ll9fcHJvdG9fXyA9IGluRGVmaW5pdGlvbi5wcm90b3R5cGU7CiAgfQp9CgpmdW5jdGlvbiBjdXN0b21NaXhpbihpblRhcmdldCwgaW5TcmMsIGluTmF0aXZlKSB7CiAgLy8gVE9ETyhzam1pbGVzKTogJ3VzZWQnIGFsbG93cyB1cyB0byBvbmx5IGNvcHkgdGhlICd5b3VuZ2VzdCcgdmVyc2lvbiBvZgogIC8vIGFueSBwcm9wZXJ0eS4gVGhpcyBzZXQgc2hvdWxkIGJlIHByZWNhbGN1bGF0ZWQuIFdlIGFsc28gbmVlZCB0bwogIC8vIGNvbnNpZGVyIHRoaXMgZm9yIHN1cHBvcnRpbmcgJ3N1cGVyJy4KICB2YXIgdXNlZCA9IHt9OwogIC8vIHN0YXJ0IHdpdGggaW5TcmMKICB2YXIgcCA9IGluU3JjOwogIC8vIHNvbWV0aW1lcyB0aGUgZGVmYXVsdCBpcyBIVE1MVW5rbm93bkVsZW1lbnQucHJvdG90eXBlIGluc3RlYWQgb2YKICAvLyBIVE1MRWxlbWVudC5wcm90b3R5cGUsIHNvIHdlIGFkZCBhIHRlc3QKICAvLyB0aGUgaWRlYSBpcyB0byBhdm9pZCBtaXhpbmcgaW4gbmF0aXZlIHByb3RvdHlwZXMsIHNvIGFkZGluZwogIC8vIHRoZSBzZWNvbmQgdGVzdCBpcyBXTE9HCiAgd2hpbGUgKHAgIT09IGluTmF0aXZlICYmIHAgIT09IEhUTUxVbmtub3duRWxlbWVudC5wcm90b3R5cGUpIHsKICAgIHZhciBrZXlzID0gT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocCk7CiAgICBmb3IgKHZhciBpPTAsIGs7IGs9a2V5c1tpXTsgaSsrKSB7CiAgICAgIGlmICghdXNlZFtrXSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShpblRhcmdldCwgaywKICAgICAgICAgICAgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwLCBrKSk7CiAgICAgICAgdXNlZFtrXSA9IDE7CiAgICAgIH0KICAgIH0KICAgIHAgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YocCk7CiAgfQp9CgpmdW5jdGlvbiByZWFkeShpbkVsZW1lbnQpIHsKICAvLyBpbnZva2UgcmVhZHlDYWxsYmFjawogIGlmIChpbkVsZW1lbnQucmVhZHlDYWxsYmFjaykgewogICAgaW5FbGVtZW50LnJlYWR5Q2FsbGJhY2soKTsKICB9Cn0KCi8vIGF0dHJpYnV0ZSB3YXRjaGluZwoKZnVuY3Rpb24gb3ZlcnJpZGVBdHRyaWJ1dGVBcGkocHJvdG90eXBlKSB7CiAgLy8gb3ZlcnJpZGVzIHRvIGltcGxlbWVudCBjYWxsYmFja3MKICAvLyBUT0RPKHNqbWlsZXMpOiBzaG91bGQgc3VwcG9ydCBhY2Nlc3MgdmlhIC5hdHRyaWJ1dGVzIE5hbWVkTm9kZU1hcAogIC8vIFRPRE8oc2ptaWxlcyk6IHByZXNlcnZlcyB1c2VyIGRlZmluZWQgb3ZlcnJpZGVzLCBpZiBhbnkKICB2YXIgc2V0QXR0cmlidXRlID0gcHJvdG90eXBlLnNldEF0dHJpYnV0ZTsKICBwcm90b3R5cGUuc2V0QXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCBzZXRBdHRyaWJ1dGUpOwogIH0KICB2YXIgcmVtb3ZlQXR0cmlidXRlID0gcHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZTsKICBwcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgIGNoYW5nZUF0dHJpYnV0ZS5jYWxsKHRoaXMsIG5hbWUsIHZhbHVlLCByZW1vdmVBdHRyaWJ1dGUpOwogIH0KfQoKZnVuY3Rpb24gY2hhbmdlQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcGVyYXRpb24pIHsKICB2YXIgb2xkVmFsdWUgPSB0aGlzLmdldEF0dHJpYnV0ZShuYW1lKTsKICBvcGVyYXRpb24uYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAodGhpcy5hdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sKICAgICAgJiYgKHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpICE9PSBvbGRWYWx1ZSkpIHsKICAgIHRoaXMuYXR0cmlidXRlQ2hhbmdlZENhbGxiYWNrKG5hbWUsIG9sZFZhbHVlKTsKICB9Cn0KCi8vIGVsZW1lbnQgcmVnaXN0cnkgKG1hcHMgdGFnIG5hbWVzIHRvIGRlZmluaXRpb25zKQoKdmFyIHJlZ2lzdHJ5ID0ge307CgpmdW5jdGlvbiByZWdpc3RlckRlZmluaXRpb24oaW5OYW1lLCBpbkRlZmluaXRpb24pIHsKICByZWdpc3RyeVtpbk5hbWVdID0gaW5EZWZpbml0aW9uOwp9CgpmdW5jdGlvbiBnZW5lcmF0ZUNvbnN0cnVjdG9yKGluRGVmaW5pdGlvbikgewogIHJldHVybiBmdW5jdGlvbigpIHsKICAgIHJldHVybiBpbnN0YW50aWF0ZShpbkRlZmluaXRpb24pOwogIH07Cn0KCmZ1bmN0aW9uIGNyZWF0ZUVsZW1lbnQoaW5UYWcpIHsKICB2YXIgZGVmaW5pdGlvbiA9IHJlZ2lzdHJ5W2luVGFnXTsKICBpZiAoZGVmaW5pdGlvbikgewogICAgcmV0dXJuIG5ldyBkZWZpbml0aW9uLmN0b3IoKTsKICB9CiAgcmV0dXJuIGRvbUNyZWF0ZUVsZW1lbnQoaW5UYWcpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRWxlbWVudChpbkVsZW1lbnQpIHsKICBpZiAoIWluRWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgKGluRWxlbWVudC5ub2RlVHlwZSA9PT0gTm9kZS5FTEVNRU5UX05PREUpKSB7CiAgICB2YXIgdHlwZSA9IGluRWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2lzJykgfHwgaW5FbGVtZW50LmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gcmVnaXN0cnlbdHlwZV07CiAgICByZXR1cm4gZGVmaW5pdGlvbiAmJiB1cGdyYWRlKGluRWxlbWVudCwgZGVmaW5pdGlvbik7CiAgfQp9CgpmdW5jdGlvbiBjbG9uZU5vZGUoZGVlcCkgewogIC8vIGNhbGwgb3JpZ2luYWwgY2xvbmUKICB2YXIgbiA9IGRvbUNsb25lTm9kZS5jYWxsKHRoaXMsIGRlZXApOwogIC8vIHVwZ3JhZGUgdGhlIGVsZW1lbnQgYW5kIHN1YnRyZWUKICBzY29wZS51cGdyYWRlQWxsKG4pOwogIHJldHVybiBuOwp9Ci8vIGNhcHR1cmUgbmF0aXZlIGNyZWF0ZUVsZW1lbnQgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQuYmluZChkb2N1bWVudCk7CgovLyBjYXB0dXJlIG5hdGl2ZSBjbG9uZU5vZGUgYmVmb3JlIHdlIG92ZXJyaWRlIGl0Cgp2YXIgZG9tQ2xvbmVOb2RlID0gTm9kZS5wcm90b3R5cGUuY2xvbmVOb2RlOwoKLy8gZXhwb3J0cwoKZG9jdW1lbnQucmVnaXN0ZXIgPSByZWdpc3RlcjsKZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGNyZWF0ZUVsZW1lbnQ7IC8vIG92ZXJyaWRlCk5vZGUucHJvdG90eXBlLmNsb25lTm9kZSA9IGNsb25lTm9kZTsgLy8gb3ZlcnJpZGUKCnNjb3BlLnJlZ2lzdHJ5ID0gcmVnaXN0cnk7CgovKioKICogVXBncmFkZSBhbiBlbGVtZW50IHRvIGEgY3VzdG9tIGVsZW1lbnQuIFVwZ3JhZGluZyBhbiBlbGVtZW50CiAqIGNhdXNlcyB0aGUgY3VzdG9tIHByb3RvdHlwZSB0byBiZSBhcHBsaWVkLCBhbiBgaXNgIGF0dHJpYnV0ZQogKiB0byBiZSBhdHRhY2hlZCAoYXMgbmVlZGVkKSwgYW5kIGludm9jYXRpb24gb2YgdGhlIGByZWFkeUNhbGxiYWNrYC4KICogYHVwZ3JhZGVgIGRvZXMgbm90aGluZyBpZiB0aGUgZWxlbWVudCBpcyBhbHJlYWR5IHVwZ3JhZGVkLCBvcgogKiBpZiBpdCBtYXRjaGVzIG5vIHJlZ2lzdGVyZWQgY3VzdG9tIHRhZyBuYW1lLgogKgogKiBAbWV0aG9kIHVncHJhZGUKICogQHBhcmFtIHtFbGVtZW50fSBpbkVsZW1lbnQgVGhlIGVsZW1lbnQgdG8gdXBncmFkZS4KICogQHJldHVybiB7RWxlbWVudH0gVGhlIHVwZ3JhZGVkIGVsZW1lbnQuCiAqLwpzY29wZS51cGdyYWRlID0gdXBncmFkZUVsZW1lbnQ7Cgp9Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKIC8qCkNvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuClVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCmxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KKi8KCihmdW5jdGlvbihzY29wZSl7CgovKgppZiAoSFRNTEVsZW1lbnQucHJvdG90eXBlLndlYmtpdFNoYWRvd1Jvb3QpIHsKICBPYmplY3QuZGVmaW5lUHJvcGVydHkoSFRNTEVsZW1lbnQucHJvdG90eXBlLCAnc2hhZG93Um9vdCcsIHsKICAgIGdldDogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLndlYmtpdFNoYWRvd1Jvb3Q7CiAgICB9CiAgfTsKfQoqLwoKLy8gd2FsayB0aGUgc3VidHJlZSByb290ZWQgYXQgbm9kZSwgYXBwbHlpbmcgJ2ZpbmQoZWxlbWVudCwgZGF0YSknIGZ1bmN0aW9uCi8vIHRvIGVhY2ggZWxlbWVudAovLyBpZiAnZmluZCcgcmV0dXJucyB0cnVlIGZvciAnZWxlbWVudCcsIGRvIG5vdCBzZWFyY2ggZWxlbWVudCdzIHN1YnRyZWUKZnVuY3Rpb24gZmluZEFsbChub2RlLCBmaW5kLCBkYXRhKSB7CiAgdmFyIGUgPSBub2RlLmZpcnN0RWxlbWVudENoaWxkOwogIGlmICghZSkgewogICAgZSA9IG5vZGUuZmlyc3RDaGlsZDsKICAgIHdoaWxlIChlICYmIGUubm9kZVR5cGUgIT09IE5vZGUuRUxFTUVOVF9OT0RFKSB7CiAgICAgIGUgPSBlLm5leHRTaWJsaW5nOwogICAgfQogIH0KICB3aGlsZSAoZSkgewogICAgaWYgKGZpbmQoZSwgZGF0YSkgIT09IHRydWUpIHsKICAgICAgZmluZEFsbChlLCBmaW5kLCBkYXRhKTsKICAgIH0KICAgIGUgPSBlLm5leHRFbGVtZW50U2libGluZzsKICB9CiAgcmV0dXJuIG51bGw7Cn0KCi8vIHdhbGsgdGhlIHN1YnRyZWUgcm9vdGVkIGF0IG5vZGUsIGluY2x1ZGluZyBkZXNjZW50IGludG8gc2hhZG93LXJvb3RzLAovLyBhcHBseWluZyAnY2InIHRvIGVhY2ggZWxlbWVudApmdW5jdGlvbiBmb3JTdWJ0cmVlKG5vZGUsIGNiKSB7CiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cCgnc3ViVHJlZTogJywgbm9kZSk7CiAgZmluZEFsbChub2RlLCBmdW5jdGlvbihlKSB7CiAgICBpZiAoY2IoZSkpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBpZiAoZS53ZWJraXRTaGFkb3dSb290KSB7CiAgICAgIGZvclN1YnRyZWUoZS53ZWJraXRTaGFkb3dSb290LCBjYik7CiAgICB9CiAgfSk7CiAgaWYgKG5vZGUud2Via2l0U2hhZG93Um9vdCkgewogICAgZm9yU3VidHJlZShub2RlLndlYmtpdFNoYWRvd1Jvb3QsIGNiKTsKICB9CiAgLy9sb2dGbGFncy5kb20gJiYgbm9kZS5jaGlsZE5vZGVzICYmIG5vZGUuY2hpbGROb2Rlcy5sZW5ndGggJiYgY29uc29sZS5ncm91cEVuZCgpOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUKZnVuY3Rpb24gYWRkZWQobm9kZSkgewogIGlmICh1cGdyYWRlKG5vZGUpKSB7CiAgICBpbnNlcnRlZE5vZGUobm9kZSk7CiAgICByZXR1cm4gdHJ1ZTsKICB9CiAgaW5zZXJ0ZWQobm9kZSk7Cn0KCi8vIG1hbmFnZSBsaWZlY3ljbGUgb24gYWRkZWQgbm9kZSdzIHN1YnRyZWUgb25seQpmdW5jdGlvbiBhZGRlZFN1YnRyZWUobm9kZSkgewogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgaWYgKGFkZGVkKGUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0pOwp9CgovLyBtYW5hZ2UgbGlmZWN5Y2xlIG9uIGFkZGVkIG5vZGUgYW5kIGl0J3Mgc3VidHJlZQpmdW5jdGlvbiBhZGRlZE5vZGUobm9kZSkgewogIHJldHVybiBhZGRlZChub2RlKSB8fCBhZGRlZFN1YnRyZWUobm9kZSk7Cn0KCi8vIHVwZ3JhZGUgY3VzdG9tIGVsZW1lbnRzIGF0IG5vZGUsIGlmIGFwcGxpY2FibGUKZnVuY3Rpb24gdXBncmFkZShub2RlKSB7CiAgaWYgKCFub2RlLl9fdXBncmFkZWRfXyAmJiBub2RlLm5vZGVUeXBlID09PSBOb2RlLkVMRU1FTlRfTk9ERSkgewogICAgdmFyIHR5cGUgPSBub2RlLmdldEF0dHJpYnV0ZSgnaXMnKSB8fCBub2RlLmxvY2FsTmFtZTsKICAgIHZhciBkZWZpbml0aW9uID0gc2NvcGUucmVnaXN0cnlbdHlwZV07CiAgICBpZiAoZGVmaW5pdGlvbikgewogICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZTonLCBub2RlLmxvY2FsTmFtZSk7CiAgICAgIHNjb3BlLnVwZ3JhZGUobm9kZSk7CiAgICAgIGxvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwRW5kKCk7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5zZXJ0ZWROb2RlKG5vZGUpIHsKICBpbnNlcnRlZChub2RlKTsKICBpZiAoaW5Eb2N1bWVudChub2RlKSkgewogICAgZm9yU3VidHJlZShub2RlLCBmdW5jdGlvbihlKSB7CiAgICAgIGluc2VydGVkKGUpOwogICAgfSk7CiAgfQp9CgovLyBUT0RPKHNqbWlsZXMpOiBpZiB0aGVyZSBhcmUgZGVzY2VudHMgaW50byB0cmVlcyB0aGF0IGNhbiBuZXZlciBoYXZlIGluRG9jdW1lbnQoKikgdHJ1ZSwgZml4IHRoaXMKCmZ1bmN0aW9uIGluc2VydGVkKGVsZW1lbnQpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBpdCdzIHBvc3NpYmxlIHdlIHdlcmUgaW5zZXJ0ZWQgYW5kIHJlbW92ZWQgaW4gdGhlIHNwYWNlCiAgLy8gb2Ygb25lIG1pY3JvdGFzaywgaW4gd2hpY2ggY2FzZSB3ZSB3b24ndCBiZSAnaW5Eb2N1bWVudCcgaGVyZQogIC8vIEJ1dCB0aGVyZSBhcmUgb3RoZXIgY2FzZXMgd2hlcmUgd2UgYXJlIHRlc3RpbmcgZm9yIGluc2VydGVkIHdpdGhvdXQKICAvLyBzcGVjaWZpYyBrbm93bGVkZ2Ugb2YgbXV0YXRpb25zLCBhbmQgbXVzdCB0ZXN0ICdpbkRvY3VtZW50JyB0byBkZXRlcm1pbmUKICAvLyB3aGV0aGVyIHRvIGNhbGwgaW5zZXJ0ZWQKICAvLyBJZiB3ZSBjYW4gZmFjdG9yIHRoZXNlIGNhc2VzIGludG8gc2VwYXJhdGUgY29kZSBwYXRocyB3ZSBjYW4gaGF2ZQogIC8vIGJldHRlciBkaWFnbm9zdGljcy4KICAvLyBUT0RPKHNqbWlsZXMpOiB3aGVuIGxvZ2dpbmcsIGRvIHdvcmsgb24gYWxsIGN1c3RvbSBlbGVtZW50cyBzbyB3ZSBjYW4KICAvLyB0cmFjayBiZWhhdmlvciBldmVuIHdoZW4gY2FsbGJhY2tzIG5vdCBkZWZpbmVkCiAgLy9jb25zb2xlLmxvZygnaW5zZXJ0ZWQ6ICcsIGVsZW1lbnQubG9jYWxOYW1lKTsKICBpZiAoZWxlbWVudC5pbnNlcnRlZENhbGxiYWNrIHx8IChlbGVtZW50Ll9fdXBncmFkZWRfXyAmJiBsb2dGbGFncy5kb20pKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgnaW5zZXJ0ZWQ6JywgZWxlbWVudC5sb2NhbE5hbWUpOwogICAgaWYgKGluRG9jdW1lbnQoZWxlbWVudCkpIHsKICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gKGVsZW1lbnQuX19pbnNlcnRlZCB8fCAwKSArIDE7CiAgICAgIC8vIGlmIHdlIGFyZSBpbiBhICdyZW1vdmVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ2luc2VydGVkJyBzdGF0ZQogICAgICBpZiAoZWxlbWVudC5fX2luc2VydGVkIDwgMSkgewogICAgICAgIGVsZW1lbnQuX19pbnNlcnRlZCA9IDE7CiAgICAgIH0KICAgICAgLy8gaWYgd2UgYXJlICdvdmVyIGluc2VydGVkJywgc3F1ZWxjaCB0aGUgY2FsbGJhY2sKICAgICAgaWYgKGVsZW1lbnQuX19pbnNlcnRlZCA+IDEpIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS53YXJuKCdpbnNlcnRlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICdpbnNlcnQvcmVtb3ZlIGNvdW50OicsIGVsZW1lbnQuX19pbnNlcnRlZCkKICAgICAgfSBlbHNlIGlmIChlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2spIHsKICAgICAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ2luc2VydGVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgICAgICBlbGVtZW50Lmluc2VydGVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9Cn0KCmZ1bmN0aW9uIHJlbW92ZWROb2RlKG5vZGUpIHsKICByZW1vdmVkKG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgcmVtb3ZlZChlKTsKICB9KTsKfQoKZnVuY3Rpb24gcmVtb3ZlZChlbGVtZW50KSB7CiAgLy8gVE9ETyhzam1pbGVzKTogdGVtcG9yYXJ5OiBkbyB3b3JrIG9uIGFsbCBjdXN0b20gZWxlbWVudHMgc28gd2UgY2FuIHRyYWNrCiAgLy8gYmVoYXZpb3IgZXZlbiB3aGVuIGNhbGxiYWNrcyBub3QgZGVmaW5lZAogIGlmIChlbGVtZW50LnJlbW92ZWRDYWxsYmFjayB8fCAoZWxlbWVudC5fX3VwZ3JhZGVkX18gJiYgbG9nRmxhZ3MuZG9tKSkgewogICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKCdyZW1vdmVkOicsIGVsZW1lbnQubG9jYWxOYW1lKTsKICAgIGlmICghaW5Eb2N1bWVudChlbGVtZW50KSkgewogICAgICBlbGVtZW50Ll9faW5zZXJ0ZWQgPSAoZWxlbWVudC5fX2luc2VydGVkIHx8IDApIC0gMTsKICAgICAgLy8gaWYgd2UgYXJlIGluIGEgJ2luc2VydGVkJyBzdGF0ZSwgYmx1bnRseSBhZGp1c3QgdG8gYW4gJ3JlbW92ZWQnIHN0YXRlCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPiAwKSB7CiAgICAgICAgZWxlbWVudC5fX2luc2VydGVkID0gMDsKICAgICAgfQogICAgICAvLyBpZiB3ZSBhcmUgJ292ZXIgcmVtb3ZlZCcsIHNxdWVsY2ggdGhlIGNhbGxiYWNrCiAgICAgIGlmIChlbGVtZW50Ll9faW5zZXJ0ZWQgPCAwKSB7CiAgICAgICAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUud2FybigncmVtb3ZlZDonLCBlbGVtZW50LmxvY2FsTmFtZSwKICAgICAgICAgICAgJ2luc2VydC9yZW1vdmUgY291bnQ6JywgZWxlbWVudC5fX2luc2VydGVkKQogICAgICB9IGVsc2UgaWYgKGVsZW1lbnQucmVtb3ZlZENhbGxiYWNrKSB7CiAgICAgICAgZWxlbWVudC5yZW1vdmVkQ2FsbGJhY2soKTsKICAgICAgfQogICAgfQogIH0KfQoKZnVuY3Rpb24gaW5Eb2N1bWVudChlbGVtZW50KSB7CiAgdmFyIHAgPSBlbGVtZW50OwogIHdoaWxlIChwKSB7CiAgICBpZiAocCA9PSBlbGVtZW50Lm93bmVyRG9jdW1lbnQpIHsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBwID0gcC5wYXJlbnROb2RlIHx8IHAuaG9zdDsKICB9Cn0KCmZ1bmN0aW9uIHdhdGNoU2hhZG93KG5vZGUpIHsKICBpZiAobm9kZS53ZWJraXRTaGFkb3dSb290ICYmICFub2RlLndlYmtpdFNoYWRvd1Jvb3QuX193YXRjaGVkKSB7CiAgICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5sb2coJ3dhdGNoaW5nIHNoYWRvdy1yb290IGZvcjogJywgbm9kZS5sb2NhbE5hbWUpOwogICAgb2JzZXJ2ZShub2RlLndlYmtpdFNoYWRvd1Jvb3QpOwogICAgbm9kZS53ZWJraXRTaGFkb3dSb290Ll9fd2F0Y2hlZCA9IHRydWU7CiAgfQp9CgpmdW5jdGlvbiB3YXRjaEFsbFNoYWRvd3Mobm9kZSkgewogIHdhdGNoU2hhZG93KG5vZGUpOwogIGZvclN1YnRyZWUobm9kZSwgZnVuY3Rpb24oZSkgewogICAgd2F0Y2hTaGFkb3cobm9kZSk7CiAgfSk7Cn0KCmZ1bmN0aW9uIGZpbHRlcihpbk5vZGUpIHsKICBzd2l0Y2ggKGluTm9kZS5sb2NhbE5hbWUpIHsKICAgIGNhc2UgJ3N0eWxlJzoKICAgIGNhc2UgJ3NjcmlwdCc6CiAgICBjYXNlICd0ZW1wbGF0ZSc6CiAgICBjYXNlIHVuZGVmaW5lZDoKICAgICAgcmV0dXJuIHRydWU7CiAgfQp9CgpmdW5jdGlvbiBoYW5kbGVyKG11dGF0aW9ucykgewogIC8vCiAgaWYgKGxvZ0ZsYWdzLmRvbSkgewogICAgdmFyIG14ID0gbXV0YXRpb25zWzBdOwogICAgaWYgKG14ICYmIG14LnR5cGUgPT09ICdjaGlsZExpc3QnICYmIG14LmFkZGVkTm9kZXMpIHsKICAgICAgICBpZiAobXguYWRkZWROb2RlcykgewogICAgICAgICAgdmFyIGQgPSBteC5hZGRlZE5vZGVzWzBdOwogICAgICAgICAgd2hpbGUgKGQgJiYgZCAhPT0gZG9jdW1lbnQgJiYgIWQuaG9zdCkgewogICAgICAgICAgICBkID0gZC5wYXJlbnROb2RlOwogICAgICAgICAgfQogICAgICAgICAgdmFyIHUgPSBkICYmIChkLlVSTCB8fCBkLl9VUkwgfHwgKGQuaG9zdCAmJiBkLmhvc3QubG9jYWxOYW1lKSkgfHwgJyc7CiAgICAgICAgICB1ID0gdS5zcGxpdCgnLz8nKS5zaGlmdCgpLnNwbGl0KCcvJykucG9wKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5ncm91cCgnbXV0YXRpb25zICglZCkgWyVzXScsIG11dGF0aW9ucy5sZW5ndGgsIHUgfHwgJycpOwogIH0KICAvLwogIG11dGF0aW9ucy5mb3JFYWNoKGZ1bmN0aW9uKG14KSB7CiAgICAvL2xvZ0ZsYWdzLmRvbSAmJiBjb25zb2xlLmdyb3VwKCdtdXRhdGlvbicpOwogICAgaWYgKG14LnR5cGUgPT09ICdjaGlsZExpc3QnKSB7CiAgICAgIGZvckVhY2gobXguYWRkZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIC8vIHdhdGNoIHNoYWRvdy1yb290cyBvbiBub2RlcyB0aGF0IGhhdmUgaGFkIHRoZW0gYXR0YWNoZWQgbWFudWFsbHkKICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiByZW1vdmUgaWYgY3JlYXRlU2hhZG93Um9vdCBpcyBvdmVycmlkZGVuCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogcmVtb3ZlZCBhcyBhbiBvcHRpbWl6YXRpb24sIG1hbnVhbCBzaGFkb3cgcm9vdHMKICAgICAgICAvLyBtdXN0IGJlIHdhdGNoZWQgZXhwbGljaXRseQogICAgICAgIC8vd2F0Y2hBbGxTaGFkb3dzKG4pOwogICAgICAgIC8vIG5vZGVzIGFkZGVkIG1heSBuZWVkIGxpZmVjeWNsZSBtYW5hZ2VtZW50CiAgICAgICAgYWRkZWROb2RlKG4pOwogICAgICB9KTsKICAgICAgLy8gcmVtb3ZlZCBub2RlcyBtYXkgbmVlZCBsaWZlY3ljbGUgbWFuYWdlbWVudAogICAgICBmb3JFYWNoKG14LnJlbW92ZWROb2RlcywgZnVuY3Rpb24obikgewogICAgICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUubG9nKG4ubG9jYWxOYW1lKTsKICAgICAgICBpZiAoZmlsdGVyKG4pKSB7CiAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHJlbW92ZWROb2RlKG4pOwogICAgICB9KTsKICAgIH0KICAgIC8vbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKICB9KTsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cEVuZCgpOwp9OwoKdmFyIG9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoaGFuZGxlcik7CgpmdW5jdGlvbiB0YWtlUmVjb3JkcygpIHsKICAvLyBUT0RPKHNqbWlsZXMpOiBhc2sgUmFmIHdoeSB3ZSBoYXZlIHRvIGNhbGwgaGFuZGxlciBvdXJzZWx2ZXMKICBoYW5kbGVyKG9ic2VydmVyLnRha2VSZWNvcmRzKCkpOwp9Cgp2YXIgZm9yRWFjaCA9IEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwuYmluZChBcnJheS5wcm90b3R5cGUuZm9yRWFjaCk7CgpmdW5jdGlvbiBvYnNlcnZlKGluUm9vdCkgewogIG9ic2VydmVyLm9ic2VydmUoaW5Sb290LCB7Y2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlfSk7Cn0KCmZ1bmN0aW9uIG9ic2VydmVEb2N1bWVudChkb2N1bWVudCkgewogIG9ic2VydmUoZG9jdW1lbnQpOwp9CgpmdW5jdGlvbiB1cGdyYWRlRG9jdW1lbnQoZG9jdW1lbnQpIHsKICBsb2dGbGFncy5kb20gJiYgY29uc29sZS5ncm91cCgndXBncmFkZURvY3VtZW50OiAnLCAoZG9jdW1lbnQuVVJMIHx8IGRvY3VtZW50Ll9VUkwgfHwgJycpLnNwbGl0KCcvJykucG9wKCkpOwogIGFkZGVkTm9kZShkb2N1bWVudCk7CiAgbG9nRmxhZ3MuZG9tICYmIGNvbnNvbGUuZ3JvdXBFbmQoKTsKfQoKLy8gZXhwb3J0cwoKc2NvcGUud2F0Y2hTaGFkb3cgPSB3YXRjaFNoYWRvdzsKc2NvcGUud2F0Y2hBbGxTaGFkb3dzID0gd2F0Y2hBbGxTaGFkb3dzOwoKc2NvcGUudXBncmFkZUFsbCA9IGFkZGVkTm9kZTsKc2NvcGUudXBncmFkZVN1YnRyZWUgPSBhZGRlZFN1YnRyZWU7CgpzY29wZS5vYnNlcnZlRG9jdW1lbnQgPSBvYnNlcnZlRG9jdW1lbnQ7CnNjb3BlLnVwZ3JhZGVEb2N1bWVudCA9IHVwZ3JhZGVEb2N1bWVudDsKCnNjb3BlLnRha2VSZWNvcmRzID0gdGFrZVJlY29yZHM7Cgp9KSh3aW5kb3cuQ3VzdG9tRWxlbWVudHMpOwoKLyoKICogQ29weXJpZ2h0IDIwMTMgVGhlIFBvbHltZXIgQXV0aG9ycy4gQWxsIHJpZ2h0cyByZXNlcnZlZC4KICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYSBCU0Qtc3R5bGUKICogbGljZW5zZSB0aGF0IGNhbiBiZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlLgogKi8KCihmdW5jdGlvbigpewoKdmFyIEhUTUxFbGVtZW50RWxlbWVudCA9IGZ1bmN0aW9uKGluRWxlbWVudCkgewogIGluRWxlbWVudC5yZWdpc3RlciA9IEhUTUxFbGVtZW50RWxlbWVudC5wcm90b3R5cGUucmVnaXN0ZXI7CiAgcGFyc2VFbGVtZW50RWxlbWVudChpbkVsZW1lbnQpOwogIHJldHVybiBpbkVsZW1lbnQ7Cn07CgpIVE1MRWxlbWVudEVsZW1lbnQucHJvdG90eXBlID0gewogIHJlZ2lzdGVyOiBmdW5jdGlvbihpbk1vcmUpIHsKICAgIGlmIChpbk1vcmUpIHsKICAgICAgdGhpcy5vcHRpb25zLmxpZmVjeWNsZSA9IGluTW9yZS5saWZlY3ljbGU7CiAgICAgIGlmIChpbk1vcmUucHJvdG90eXBlKSB7CiAgICAgICAgbWl4aW4odGhpcy5vcHRpb25zLnByb3RvdHlwZSwgaW5Nb3JlLnByb3RvdHlwZSk7CiAgICAgIH0KICAgIH0KICB9Cn07CgpmdW5jdGlvbiBwYXJzZUVsZW1lbnRFbGVtZW50KGluRWxlbWVudCkgewogIC8vIG9wdGlvbnMgdG8gZ2xlYW4gZnJvbSBpbkVsZW1lbnQgYXR0cmlidXRlcwogIHZhciBvcHRpb25zID0gewogICAgbmFtZTogJycsCiAgICBleHRlbmRzOiBudWxsCiAgfTsKICAvLyBnbGVhbiB0aGVtCiAgdGFrZUF0dHJpYnV0ZXMoaW5FbGVtZW50LCBvcHRpb25zKTsKICAvLyBkZWZhdWx0IGJhc2UKICB2YXIgYmFzZSA9IEhUTUxFbGVtZW50LnByb3RvdHlwZTsKICAvLyBvcHRpb25hbCBzcGVjaWZpZWQgYmFzZQogIGlmIChvcHRpb25zLmV4dGVuZHMpIHsKICAgIC8vIGJ1aWxkIGFuIGluc3RhbmNlIG9mIG9wdGlvbnMuZXh0ZW5kcwogICAgdmFyIGFyY2hldHlwZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQob3B0aW9ucy5leHRlbmRzKTsKICAgIC8vIGFjcXVpcmUgdGhlIHByb3RvdHlwZQogICAgLy8gVE9ETyhzam1pbGVzKTogX19wcm90b19fIG1heSBiZSBoaW50ZWQgYnkgdGhlIGN1c3RvbSBlbGVtZW50CiAgICAvLyBzeXN0ZW0gb24gcGxhdGZvcm1zIHRoYXQgZG9uJ3Qgc3VwcG9ydCBuYXRpdmUgX19wcm90b19fCiAgICAvLyBvbiB0aG9zZSBwbGF0Zm9ybXMgdGhlIEFQSSBpcyBtaXhlZCBpbnRvIGFyY2hldHlwZSBhbmQgdGhlCiAgICAvLyBlZmZlY3RpdmUgYmFzZSBpcyBub3QgYXJjaGV0eXBlJ3MgcmVhbCBwcm90b3R5cGUKICAgIGJhc2UgPSBhcmNoZXR5cGUuX19wcm90b19fIHx8IE9iamVjdC5nZXRQcm90b3R5cGVPZihhcmNoZXR5cGUpOwogIH0KICAvLyBleHRlbmQgYmFzZQogIG9wdGlvbnMucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShiYXNlKTsKICAvLyBpbnN0YWxsIG9wdGlvbnMKICBpbkVsZW1lbnQub3B0aW9ucyA9IG9wdGlvbnM7CiAgLy8gbG9jYXRlIHVzZXIgc2NyaXB0CiAgdmFyIHNjcmlwdCA9IGluRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdzY3JpcHQ6bm90KFt0eXBlXSksc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdLHNjcmlwdHMnKTsKICBpZiAoc2NyaXB0KSB7CiAgICAvLyBleGVjdXRlIHVzZXIgc2NyaXB0IGluICdpbkVsZW1lbnQnIGNvbnRleHQKICAgIGV4ZWN1dGVDb21wb25lbnRTY3JpcHQoc2NyaXB0LnRleHRDb250ZW50LCBpbkVsZW1lbnQsIG9wdGlvbnMubmFtZSk7CiAgfTsKICAvLyByZWdpc3RlciBvdXIgbmV3IGVsZW1lbnQKICB2YXIgY3RvciA9IGRvY3VtZW50LnJlZ2lzdGVyKG9wdGlvbnMubmFtZSwgb3B0aW9ucyk7CiAgaW5FbGVtZW50LmN0b3IgPSBjdG9yOwogIC8vIHN0b3JlIG9wdGlvbmFsIGNvbnN0cnVjdG9yIHJlZmVyZW5jZQogIHZhciByZWZOYW1lID0gaW5FbGVtZW50LmdldEF0dHJpYnV0ZSgnY29uc3RydWN0b3InKTsKICBpZiAocmVmTmFtZSkgewogICAgd2luZG93W3JlZk5hbWVdID0gY3RvcjsKICB9Cn0KCi8vIGVhY2ggcHJvcGVydHkgaW4gaW5EaWN0aW9uYXJ5IHRha2VzIGEgdmFsdWUKLy8gZnJvbSB0aGUgbWF0Y2hpbmcgYXR0cmlidXRlIGluIGluRWxlbWVudCwgaWYgYW55CmZ1bmN0aW9uIHRha2VBdHRyaWJ1dGVzKGluRWxlbWVudCwgaW5EaWN0aW9uYXJ5KSB7CiAgZm9yICh2YXIgbiBpbiBpbkRpY3Rpb25hcnkpIHsKICAgIHZhciBhID0gaW5FbGVtZW50LmF0dHJpYnV0ZXNbbl07CiAgICBpZiAoYSkgewogICAgICBpbkRpY3Rpb25hcnlbbl0gPSBhLnZhbHVlOwogICAgfQogIH0KfQoKLy8gaW52b2tlIGluU2NyaXB0IGluIGluQ29udGV4dCBzY29wZQpmdW5jdGlvbiBleGVjdXRlQ29tcG9uZW50U2NyaXB0KGluU2NyaXB0LCBpbkNvbnRleHQsIGluTmFtZSkgewogIC8vIHNldCAoaGlnaGxhbmRlcikgY29udGV4dAogIGNvbnRleHQgPSBpbkNvbnRleHQ7CiAgLy8gc291cmNlIGxvY2F0aW9uCiAgdmFyIG93bmVyID0gY29udGV4dC5vd25lckRvY3VtZW50OwogIHZhciB1cmwgPSAob3duZXIuX1VSTCB8fCBvd25lci5VUkwgfHwgb3duZXIuaW1wbAogICAgICAmJiAob3duZXIuaW1wbC5fVVJMIHx8IG93bmVyLmltcGwuVVJMKSk7CiAgLy8gZW5zdXJlIHRoZSBjb21wb25lbnQgaGFzIGEgdW5pcXVlIHNvdXJjZSBtYXAgc28gaXQgY2FuIGJlIGRlYnVnZ2VkCiAgLy8gaWYgdGhlIG5hbWUgbWF0Y2hlcyB0aGUgZmlsZW5hbWUgcGFydCBvZiB0aGUgb3duaW5nIGRvY3VtZW50J3MgdXJsLAogIC8vIHVzZSB0aGlzLCBvdGhlcndpc2UsIGFkZCAiOjxuYW1lPiIgdG8gdGhlIGRvY3VtZW50IHVybC4KICB2YXIgbWF0Y2ggPSB1cmwubWF0Y2goLy4qXC8oW14uXSopWy5dPy4qJC8pOwogIGlmIChtYXRjaCkgewogICAgdmFyIG5hbWUgPSBtYXRjaFsxXTsKICAgIHVybCArPSBuYW1lICE9IGluTmFtZSA/ICc6JyArIGluTmFtZSA6ICcnOwogIH0KICAvLyBjb21wb3NlIHNjcmlwdAogIHZhciBjb2RlID0gIl9fY29tcG9uZW50U2NyaXB0KCciCiAgICArIGluTmFtZQogICAgKyAiJywgZnVuY3Rpb24oKXsiCiAgICArIGluU2NyaXB0CiAgICArICJ9KTsiCiAgICArICJcbi8vIyBzb3VyY2VVUkw9IiArIHVybCArICJcbiIKICA7CiAgLy8gaW5qZWN0IHNjcmlwdAogIGV2YWwoY29kZSk7Cn0KCnZhciBjb250ZXh0OwoKLy8gZ2xvYmFsIG5lY2Vzc2FyeSBmb3Igc2NyaXB0IGluamVjdGlvbgp3aW5kb3cuX19jb21wb25lbnRTY3JpcHQgPSBmdW5jdGlvbihpbk5hbWUsIGluRnVuYykgewogIGluRnVuYy5jYWxsKGNvbnRleHQpOwp9OwoKLy8gdXRpbGl0eQoKLy8gY29weSB0b3AgbGV2ZWwgcHJvcGVydGllcyBmcm9tIHByb3BzIHRvIG9iagpmdW5jdGlvbiBtaXhpbihvYmosIHByb3BzKSB7CiAgb2JqID0gb2JqIHx8IHt9OwogIHRyeSB7CiAgICBPYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcykuZm9yRWFjaChmdW5jdGlvbihuKSB7CiAgICAgIHZhciBwZCA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IocHJvcHMsIG4pOwogICAgICBpZiAocGQpIHsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBuLCBwZCk7CiAgICAgIH0KICAgIH0pOwogIH0gY2F0Y2goeCkgewogIH0KICByZXR1cm4gb2JqOwp9CgovLyBleHBvcnRzCgp3aW5kb3cuSFRNTEVsZW1lbnRFbGVtZW50ID0gSFRNTEVsZW1lbnRFbGVtZW50OwoKfSkoKTsKCi8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCgooZnVuY3Rpb24oc2NvcGUpIHsKCmlmICghc2NvcGUpIHsKICBzY29wZSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA9IHtmbGFnczp7fX07Cn0KCi8vIGltcG9ydHMKCnZhciB4aHIgPSBzY29wZS54aHI7CgovLyBpbXBvcnRlcgoKdmFyIElNUE9SVF9MSU5LX1RZUEUgPSAnaW1wb3J0JzsKdmFyIFNUWUxFX0xJTktfVFlQRSA9ICdzdHlsZXNoZWV0JzsKCi8vIGhpZ2hsYW5kZXIgb2JqZWN0IHJlcHJlc2VudHMgYSBwcmltYXJ5IGRvY3VtZW50ICh0aGUgYXJndW1lbnQgdG8gJ2xvYWQnKQovLyBhdCB0aGUgcm9vdCBvZiBhIHRyZWUgb2YgZG9jdW1lbnRzCgovLyBmb3IgYW55IGRvY3VtZW50LCBpbXBvcnRlcjoKLy8gLSBsb2FkcyBhbnkgbGlua2VkIGRvY3VtZW50cyAod2l0aCBkZWR1cGluZyksIG1vZGlmaWVzIHBhdGhzIGFuZCBmZWVkcyB0aGVtIGJhY2sgaW50byBpbXBvcnRlcgovLyAtIGxvYWRzIHRleHQgb2YgZXh0ZXJuYWwgc2NyaXB0IHRhZ3MKLy8gLSBsb2FkcyB0ZXh0IG9mIGV4dGVybmFsIHN0eWxlIHRhZ3MgaW5zaWRlIG9mIDxlbGVtZW50PiwgbW9kaWZpZXMgcGF0aHMKCi8vIHdoZW4gaW1wb3J0ZXIgJ21vZGlmaWVzIHBhdGhzJyBpbiBhIGRvY3VtZW50LCB0aGlzIGluY2x1ZGVzCi8vIC0gaHJlZi9zcmMvYWN0aW9uIGluIG5vZGUgYXR0cmlidXRlcwovLyAtIHBhdGhzIGluIGlubGluZSBzdHlsZXNoZWV0cwovLyAtIGFsbCBjb250ZW50IGluc2lkZSB0ZW1wbGF0ZXMKCi8vIGxpbmtlZCBzdHlsZSBzaGVldHMgaW4gYW4gaW1wb3J0IGhhdmUgdGhlaXIgb3duIHBhdGggZml4ZWQgdXAgd2hlbiB0aGVpciBjb250YWluaW5nIGltcG9ydCBtb2RpZmllcyBwYXRocwovLyBsaW5rZWQgc3R5bGUgc2hlZXRzIGluIGFuIDxlbGVtZW50PiBhcmUgbG9hZGVkLCBhbmQgdGhlIGNvbnRlbnQgZ2V0cyBwYXRoIGZpeHVwcwovLyBpbmxpbmUgc3R5bGUgc2hlZXRzIGdldCBwYXRoIGZpeHVwcyB3aGVuIHRoZWlyIGNvbnRhaW5pbmcgaW1wb3J0IG1vZGlmaWVzIHBhdGhzCgp2YXIgaW1wb3J0ZXIgPSB7CiAgZG9jdW1lbnRzOiB7fSwKICBjYWNoZToge30sCiAgcHJlbG9hZFNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2VsZW1lbnQgbGlua1tyZWw9JyArIFNUWUxFX0xJTktfVFlQRSArICddJywKICAgICd0ZW1wbGF0ZScsCiAgICAnc2NyaXB0W3NyY10nLAogICAgJ3NjcmlwdDpub3QoW3R5cGVdKScsCiAgICAnc2NyaXB0W3R5cGU9InRleHQvamF2YXNjcmlwdCJdJwogIF0uam9pbignLCcpLAogIGxvYWRlcjogZnVuY3Rpb24oaW5OZXh0KSB7CiAgICAvLyBjb25zdHJ1Y3QgYSBsb2FkZXIgaW5zdGFuY2UKICAgIGxvYWRlciA9IG5ldyBMb2FkZXIoaW1wb3J0ZXIubG9hZGVkLCBpbk5leHQpOwogICAgLy8gYWxpYXMgdGhlIGxvYWRlciBjYWNoZSAoZm9yIGRlYnVnZ2luZykKICAgIGxvYWRlci5jYWNoZSA9IGltcG9ydGVyLmNhY2hlOwogICAgcmV0dXJuIGxvYWRlcjsKICB9LAogIGxvYWQ6IGZ1bmN0aW9uKGluRG9jdW1lbnQsIGluTmV4dCkgewogICAgLy8gY29uc3RydWN0IGEgbG9hZGVyIGluc3RhbmNlCiAgICBsb2FkZXIgPSBpbXBvcnRlci5sb2FkZXIoaW5OZXh0KTsKICAgIC8vIGFkZCBub2RlcyBmcm9tIGRvY3VtZW50IGludG8gbG9hZGVyIHF1ZXVlCiAgICBpbXBvcnRlci5wcmVsb2FkKGluRG9jdW1lbnQpOwogIH0sCiAgcHJlbG9hZDogZnVuY3Rpb24oaW5Eb2N1bWVudCkgewogICAgLy8gYWxsIHByZWxvYWRhYmxlIG5vZGVzIGluIGluRG9jdW1lbnQKICAgIHZhciBub2RlcyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRlci5wcmVsb2FkU2VsZWN0b3JzKTsKICAgIC8vIGZyb20gdGhlIG1haW4gZG9jdW1lbnQsIG9ubHkgbG9hZCBpbXBvcnRzCiAgICAvLyBUT0RPKHNqbWlsZXMpOiBkbyB0aGlzIGJ5IGFsdGVyaW5nIHRoZSBzZWxlY3RvciBsaXN0IGluc3RlYWQKICAgIG5vZGVzID0gdGhpcy5maWx0ZXJNYWluRG9jdW1lbnROb2RlcyhpbkRvY3VtZW50LCBub2Rlcyk7CiAgICAvLyBleHRyYSBsaW5rIG5vZGVzIGZyb20gdGVtcGxhdGVzLCBmaWx0ZXIgdGVtcGxhdGVzIG91dCBvZiB0aGUgbm9kZXMgbGlzdAogICAgbm9kZXMgPSB0aGlzLmV4dHJhY3RUZW1wbGF0ZU5vZGVzKG5vZGVzKTsKICAgIC8vIGFkZCB0aGVzZSBub2RlcyB0byBsb2FkZXIncyBxdWV1ZQogICAgbG9hZGVyLmFkZE5vZGVzKG5vZGVzKTsKICB9LAogIGZpbHRlck1haW5Eb2N1bWVudE5vZGVzOiBmdW5jdGlvbihpbkRvY3VtZW50LCBub2RlcykgewogICAgaWYgKGluRG9jdW1lbnQgPT09IGRvY3VtZW50KSB7CiAgICAgIG5vZGVzID0gQXJyYXkucHJvdG90eXBlLmZpbHRlci5jYWxsKG5vZGVzLCBmdW5jdGlvbihuKSB7CiAgICAgICAgcmV0dXJuICFpc1NjcmlwdChuKTsKICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gbm9kZXM7CiAgfSwKICBleHRyYWN0VGVtcGxhdGVOb2RlczogZnVuY3Rpb24obm9kZXMpIHsKICAgIHZhciBleHRyYSA9IFtdOwogICAgbm9kZXMgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyLmNhbGwobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgaWYgKG4ubG9jYWxOYW1lID09PSAndGVtcGxhdGUnKSB7CiAgICAgICAgaWYgKG4uY29udGVudCkgewogICAgICAgICAgdmFyIGwkID0gbi5jb250ZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ2xpbmtbcmVsPScgKyBTVFlMRV9MSU5LX1RZUEUgKwogICAgICAgICAgICAnXScpOwogICAgICAgICAgaWYgKGwkLmxlbmd0aCkgewogICAgICAgICAgICBleHRyYSA9IGV4dHJhLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChsJCwgMCkpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICAgIGlmIChleHRyYS5sZW5ndGgpIHsKICAgICAgbm9kZXMgPSBub2Rlcy5jb25jYXQoZXh0cmEpOwogICAgfQogICAgcmV0dXJuIG5vZGVzOwogIH0sCiAgbG9hZGVkOiBmdW5jdGlvbih1cmwsIGVsdCwgcmVzb3VyY2UpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhlbHQpKSB7CiAgICAgIHZhciBkb2N1bWVudCA9IGltcG9ydGVyLmRvY3VtZW50c1t1cmxdOwogICAgICAvLyBpZiB3ZSd2ZSBuZXZlciBzZWVuIGEgZG9jdW1lbnQgYXQgdGhpcyB1cmwKICAgICAgaWYgKCFkb2N1bWVudCkgewogICAgICAgIC8vIGdlbmVyYXRlIGFuIEhUTUxEb2N1bWVudCBmcm9tIGRhdGEKICAgICAgICBkb2N1bWVudCA9IG1ha2VEb2N1bWVudChyZXNvdXJjZSwgdXJsKTsKICAgICAgICAvLyByZXNvbHZlIHJlc291cmNlIHBhdGhzIHJlbGF0aXZlIHRvIGhvc3QgZG9jdW1lbnQKICAgICAgICBwYXRoLnJlc29sdmVQYXRoc0luSFRNTChkb2N1bWVudC5ib2R5KTsKICAgICAgICAvLyBjYWNoZSBkb2N1bWVudAogICAgICAgIGltcG9ydGVyLmRvY3VtZW50c1t1cmxdID0gZG9jdW1lbnQ7CiAgICAgICAgLy8gYWRkIG5vZGVzIGZyb20gdGhpcyBkb2N1bWVudCB0byB0aGUgbG9hZGVyIHF1ZXVlCiAgICAgICAgaW1wb3J0ZXIucHJlbG9hZChkb2N1bWVudCk7CiAgICAgIH0KICAgICAgLy8gc3RvcmUgaW1wb3J0IHJlY29yZAogICAgICBlbHQuaW1wb3J0ID0gewogICAgICAgIGhyZWY6IHVybCwKICAgICAgICBvd25lck5vZGU6IGVsdCwKICAgICAgICBjb250ZW50OiBkb2N1bWVudAogICAgICB9OwogICAgICAvLyBzdG9yZSBkb2N1bWVudCByZXNvdXJjZQogICAgICBlbHQuY29udGVudCA9IHJlc291cmNlID0gZG9jdW1lbnQ7CiAgICB9CiAgICAvLyBzdG9yZSBnZW5lcmljIHJlc291cmNlCiAgICAvLyBUT0RPKHNvcnZlbGwpOiBmYWlscyBmb3Igbm9kZXMgaW5zaWRlIDx0ZW1wbGF0ZT4uY29udGVudAogICAgLy8gc2VlIGh0dHBzOi8vY29kZS5nb29nbGUuY29tL3AvY2hyb21pdW0vaXNzdWVzL2RldGFpbD9pZD0yNDkzODEuCiAgICBlbHQuX19yZXNvdXJjZSA9IHJlc291cmNlOwogICAgLy8gY3NzIHBhdGggZml4dXBzCiAgICBpZiAoaXNTdHlsZXNoZWV0TGluayhlbHQpKSB7CiAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0KGVsdCk7CiAgICB9CiAgfQp9OwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGlzTGlua1JlbChlbHQsIElNUE9SVF9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc1N0eWxlc2hlZXRMaW5rKGVsdCkgewogIHJldHVybiBpc0xpbmtSZWwoZWx0LCBTVFlMRV9MSU5LX1RZUEUpOwp9CgpmdW5jdGlvbiBpc0xpbmtSZWwoZWx0LCByZWwpIHsKICByZXR1cm4gZWx0LmxvY2FsTmFtZSA9PT0gJ2xpbmsnICYmIGVsdC5nZXRBdHRyaWJ1dGUoJ3JlbCcpID09PSByZWw7Cn0KCmZ1bmN0aW9uIGlzU2NyaXB0KGVsdCkgewogIHJldHVybiBlbHQubG9jYWxOYW1lID09PSAnc2NyaXB0JzsKfQoKZnVuY3Rpb24gbWFrZURvY3VtZW50KGluSFRNTCwgaW5VcmwpIHsKICAvLyBjcmVhdGUgYSBuZXcgSFRNTCBkb2N1bWVudAogIHZhciBkb2MgPSBkb2N1bWVudC5pbXBsZW1lbnRhdGlvbi5jcmVhdGVIVE1MRG9jdW1lbnQoSU1QT1JUX0xJTktfVFlQRSk7CiAgLy8gY2FjaGUgdGhlIG5ldyBkb2N1bWVudCdzIHNvdXJjZSB1cmwKICBkb2MuX1VSTCA9IGluVXJsOwogIC8vIGVzdGFibGlzaCBhIHJlbGF0aXZlIHBhdGggdmlhIDxiYXNlPgogIHZhciBiYXNlID0gZG9jLmNyZWF0ZUVsZW1lbnQoJ2Jhc2UnKTsKICBiYXNlLnNldEF0dHJpYnV0ZSgnaHJlZicsIGRvY3VtZW50LmJhc2VVUkkpOwogIGRvYy5oZWFkLmFwcGVuZENoaWxkKGJhc2UpOwogIC8vIGluc3RhbGwgaHRtbAogIGRvYy5ib2R5LmlubmVySFRNTCA9IGluSFRNTDsKICAvLyBUT0RPKHNvcnZlbGwpOiBNRFYgUG9seWZpbGwgaW50cnVzaW9uOiBib29zdHJhcCB0ZW1wbGF0ZSBwb2x5ZmlsbAogIGlmICh3aW5kb3cuSFRNTFRlbXBsYXRlRWxlbWVudCAmJiBIVE1MVGVtcGxhdGVFbGVtZW50LmJvb3RzdHJhcCkgewogICAgSFRNTFRlbXBsYXRlRWxlbWVudC5ib290c3RyYXAoZG9jKTsKICB9CiAgcmV0dXJuIGRvYzsKfQoKdmFyIGxvYWRlcjsKCnZhciBMb2FkZXIgPSBmdW5jdGlvbihpbk9uTG9hZCwgaW5PbkNvbXBsZXRlKSB7CiAgdGhpcy5vbmxvYWQgPSBpbk9uTG9hZDsKICB0aGlzLm9uY29tcGxldGUgPSBpbk9uQ29tcGxldGU7CiAgdGhpcy5pbmZsaWdodCA9IDA7CiAgdGhpcy5wZW5kaW5nID0ge307CiAgdGhpcy5jYWNoZSA9IHt9Owp9OwoKTG9hZGVyLnByb3RvdHlwZSA9IHsKICBhZGROb2RlczogZnVuY3Rpb24oaW5Ob2RlcykgewogICAgLy8gbnVtYmVyIG9mIHRyYW5zYWN0aW9ucyB0byBjb21wbGV0ZQogICAgdGhpcy5pbmZsaWdodCArPSBpbk5vZGVzLmxlbmd0aDsKICAgIC8vIGNvbW1lbmNlIHRyYW5zYWN0aW9ucwogICAgZm9yRWFjaChpbk5vZGVzLCB0aGlzLnJlcXVpcmUsIHRoaXMpOwogICAgLy8gYW55dGhpbmcgdG8gZG8/CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgcmVxdWlyZTogZnVuY3Rpb24oaW5FbHQpIHsKICAgIHZhciB1cmwgPSBwYXRoLm5vZGVVcmwoaW5FbHQpOwogICAgLy8gVE9ETyhzam1pbGVzKTogYWQtaG9jCiAgICBpbkVsdC5fX25vZGVVcmwgPSB1cmw7CiAgICAvLyBkZWR1cGxpY2F0aW9uCiAgICBpZiAoIXRoaXMuZGVkdXBlKHVybCwgaW5FbHQpKSB7CiAgICAgIC8vIGZldGNoIHRoaXMgcmVzb3VyY2UKICAgICAgdGhpcy5mZXRjaCh1cmwsIGluRWx0KTsKICAgIH0KICB9LAogIGRlZHVwZTogZnVuY3Rpb24oaW5VcmwsIGluRWx0KSB7CiAgICBpZiAodGhpcy5wZW5kaW5nW2luVXJsXSkgewogICAgICAvLyBhZGQgdG8gbGlzdCBvZiBub2RlcyB3YWl0aW5nIGZvciBpblVybAogICAgICB0aGlzLnBlbmRpbmdbaW5VcmxdLnB1c2goaW5FbHQpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgaWYgKHRoaXMuY2FjaGVbaW5VcmxdKSB7CiAgICAgIC8vIGNvbXBsZXRlIGxvYWQgdXNpbmcgY2FjaGUgZGF0YQogICAgICB0aGlzLm9ubG9hZChpblVybCwgaW5FbHQsIGxvYWRlci5jYWNoZVtpblVybF0pOwogICAgICAvLyBmaW5pc2hlZCB0aGlzIHRyYW5zYWN0aW9uCiAgICAgIHRoaXMudGFpbCgpOwogICAgICAvLyBkb24ndCBuZWVkIGZldGNoCiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgLy8gZmlyc3Qgbm9kZSB3YWl0aW5nIGZvciBpblVybAogICAgdGhpcy5wZW5kaW5nW2luVXJsXSA9IFtpbkVsdF07CiAgICAvLyBuZWVkIGZldGNoIChub3QgYSBkdXBlKQogICAgcmV0dXJuIGZhbHNlOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKHVybCwgZWx0KSB7CiAgICB2YXIgcmVjZWl2ZVhociA9IGZ1bmN0aW9uKGVyciwgcmVzb3VyY2UpIHsKICAgICAgdGhpcy5yZWNlaXZlKHVybCwgZWx0LCBlcnIsIHJlc291cmNlKTsKICAgIH0uYmluZCh0aGlzKTsKICAgIHhoci5sb2FkKHVybCwgcmVjZWl2ZVhocik7CiAgfSwKICByZWNlaXZlOiBmdW5jdGlvbihpblVybCwgaW5FbHQsIGluRXJyLCBpblJlc291cmNlKSB7CiAgICBpZiAoIWluRXJyKSB7CiAgICAgIGxvYWRlci5jYWNoZVtpblVybF0gPSBpblJlc291cmNlOwogICAgfQogICAgbG9hZGVyLnBlbmRpbmdbaW5VcmxdLmZvckVhY2goZnVuY3Rpb24oZSkgewogICAgICBpZiAoIWluRXJyKSB7CiAgICAgICAgdGhpcy5vbmxvYWQoaW5VcmwsIGUsIGluUmVzb3VyY2UpOwogICAgICB9CiAgICAgIHRoaXMudGFpbCgpOwogICAgfSwgdGhpcyk7CiAgICBsb2FkZXIucGVuZGluZ1tpblVybF0gPSBudWxsOwogIH0sCiAgdGFpbDogZnVuY3Rpb24oKSB7CiAgICAtLXRoaXMuaW5mbGlnaHQ7CiAgICB0aGlzLmNoZWNrRG9uZSgpOwogIH0sCiAgY2hlY2tEb25lOiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5pbmZsaWdodCkgewogICAgICB0aGlzLm9uY29tcGxldGUoKTsKICAgIH0KICB9Cn07Cgp2YXIgVVJMX0FUVFJTID0gWydocmVmJywgJ3NyYycsICdhY3Rpb24nXTsKdmFyIFVSTF9BVFRSU19TRUxFQ1RPUiA9ICdbJyArIFVSTF9BVFRSUy5qb2luKCddLFsnKSArICddJzsKdmFyIFVSTF9URU1QTEFURV9TRUFSQ0ggPSAne3suKn19JzsKCnZhciBwYXRoID0gewogIG5vZGVVcmw6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGgucmVzb2x2ZVVybChwYXRoLmdldERvY3VtZW50VXJsKGRvY3VtZW50KSwgcGF0aC5ocmVmT3JTcmMoaW5Ob2RlKSk7CiAgfSwKICBocmVmT3JTcmM6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIGluTm9kZS5nZXRBdHRyaWJ1dGUoImhyZWYiKSB8fCBpbk5vZGUuZ2V0QXR0cmlidXRlKCJzcmMiKTsKICB9LAogIGRvY3VtZW50VXJsRnJvbU5vZGU6IGZ1bmN0aW9uKGluTm9kZSkgewogICAgcmV0dXJuIHBhdGguZ2V0RG9jdW1lbnRVcmwoaW5Ob2RlLm93bmVyRG9jdW1lbnQpOwogIH0sCiAgZ2V0RG9jdW1lbnRVcmw6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIHZhciB1cmwgPSBpbkRvY3VtZW50ICYmCiAgICAgICAgLy8gVE9ETyhzam1pbGVzKTogU2hhZG93RE9NUG9seWZpbGwgaW50cnVzaW9uCiAgICAgICAgKGluRG9jdW1lbnQuX1VSTCB8fCAoaW5Eb2N1bWVudC5pbXBsICYmIGluRG9jdW1lbnQuaW1wbC5fVVJMKQogICAgICAgICAgICB8fCBpbkRvY3VtZW50LmJhc2VVUkkgfHwgaW5Eb2N1bWVudC5VUkwpCiAgICAgICAgICAgICAgICB8fCAnJzsKICAgIC8vIHRha2Ugb25seSB0aGUgbGVmdCBzaWRlIGlmIHRoZXJlIGlzIGEgIwogICAgcmV0dXJuIHVybC5zcGxpdCgnIycpWzBdOwogIH0sCiAgcmVzb2x2ZVVybDogZnVuY3Rpb24oaW5CYXNlVXJsLCBpblVybCwgaW5SZWxhdGl2ZVRvRG9jdW1lbnQpIHsKICAgIGlmICh0aGlzLmlzQWJzVXJsKGluVXJsKSkgewogICAgICByZXR1cm4gaW5Vcmw7CiAgICB9CiAgICB2YXIgdXJsID0gdGhpcy5jb21wcmVzc1VybCh0aGlzLnVybFRvUGF0aChpbkJhc2VVcmwpICsgaW5VcmwpOwogICAgaWYgKGluUmVsYXRpdmVUb0RvY3VtZW50KSB7CiAgICAgIHVybCA9IHBhdGgubWFrZVJlbFBhdGgocGF0aC5nZXREb2N1bWVudFVybChkb2N1bWVudCksIHVybCk7CiAgICB9CiAgICByZXR1cm4gdXJsOwogIH0sCiAgaXNBYnNVcmw6IGZ1bmN0aW9uKGluVXJsKSB7CiAgICByZXR1cm4gLyheZGF0YTopfCheaHR0cFtzXT86KXwoXlwvKS8udGVzdChpblVybCk7CiAgfSwKICB1cmxUb1BhdGg6IGZ1bmN0aW9uKGluQmFzZVVybCkgewogICAgdmFyIHBhcnRzID0gaW5CYXNlVXJsLnNwbGl0KCIvIik7CiAgICBwYXJ0cy5wb3AoKTsKICAgIHBhcnRzLnB1c2goJycpOwogICAgcmV0dXJuIHBhcnRzLmpvaW4oIi8iKTsKICB9LAogIGNvbXByZXNzVXJsOiBmdW5jdGlvbihpblVybCkgewogICAgdmFyIHBhcnRzID0gaW5Vcmwuc3BsaXQoIi8iKTsKICAgIGZvciAodmFyIGk9MCwgcDsgaTxwYXJ0cy5sZW5ndGg7IGkrKykgewogICAgICBwID0gcGFydHNbaV07CiAgICAgIGlmIChwID09PSAiLi4iKSB7CiAgICAgICAgcGFydHMuc3BsaWNlKGktMSwgMik7CiAgICAgICAgaSAtPSAyOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcGFydHMuam9pbigiLyIpOwogIH0sCiAgLy8gbWFrZSBhIHJlbGF0aXZlIHBhdGggZnJvbSBzb3VyY2UgdG8gdGFyZ2V0CiAgbWFrZVJlbFBhdGg6IGZ1bmN0aW9uKGluU291cmNlLCBpblRhcmdldCkgewogICAgdmFyIHMsIHQ7CiAgICBzID0gdGhpcy5jb21wcmVzc1VybChpblNvdXJjZSkuc3BsaXQoIi8iKTsKICAgIHQgPSB0aGlzLmNvbXByZXNzVXJsKGluVGFyZ2V0KS5zcGxpdCgiLyIpOwogICAgd2hpbGUgKHMubGVuZ3RoICYmIHNbMF0gPT09IHRbMF0pewogICAgICBzLnNoaWZ0KCk7CiAgICAgIHQuc2hpZnQoKTsKICAgIH0KICAgIGZvcih2YXIgaSA9IDAsIGwgPSBzLmxlbmd0aC0xOyBpIDwgbDsgaSsrKSB7CiAgICAgIHQudW5zaGlmdCgiLi4iKTsKICAgIH0KICAgIHZhciByID0gdC5qb2luKCIvIik7CiAgICByZXR1cm4gcjsKICB9LAogIHJlc29sdmVQYXRoc0luSFRNTDogZnVuY3Rpb24ocm9vdCwgdXJsKSB7CiAgICB1cmwgPSB1cmwgfHwgcGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHJvb3QpCiAgICBwYXRoLnJlc29sdmVBdHRyaWJ1dGVzKHJvb3QsIHVybCk7CiAgICBwYXRoLnJlc29sdmVTdHlsZUVsdHMocm9vdCwgdXJsKTsKICAgIC8vIGhhbmRsZSB0ZW1wbGF0ZS5jb250ZW50CiAgICB2YXIgdGVtcGxhdGVzID0gcm9vdC5xdWVyeVNlbGVjdG9yQWxsKCd0ZW1wbGF0ZScpOwogICAgaWYgKHRlbXBsYXRlcykgewogICAgICBmb3JFYWNoKHRlbXBsYXRlcywgZnVuY3Rpb24odCkgewogICAgICAgIGlmICh0LmNvbnRlbnQpIHsKICAgICAgICAgIHBhdGgucmVzb2x2ZVBhdGhzSW5IVE1MKHQuY29udGVudCwgdXJsKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sCiAgcmVzb2x2ZVBhdGhzSW5TdHlsZXNoZWV0OiBmdW5jdGlvbihpblNoZWV0KSB7CiAgICB2YXIgZG9jVXJsID0gcGF0aC5ub2RlVXJsKGluU2hlZXQpOwogICAgaW5TaGVldC5fX3Jlc291cmNlID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChpblNoZWV0Ll9fcmVzb3VyY2UsIGRvY1VybCk7CiAgfSwKICByZXNvbHZlU3R5bGVFbHRzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICB2YXIgc3R5bGVzID0gaW5Sb290LnF1ZXJ5U2VsZWN0b3JBbGwoJ3N0eWxlJyk7CiAgICBpZiAoc3R5bGVzKSB7CiAgICAgIGZvckVhY2goc3R5bGVzLCBmdW5jdGlvbihzdHlsZSkgewogICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcGF0aC5yZXNvbHZlQ3NzVGV4dChzdHlsZS50ZXh0Q29udGVudCwgaW5VcmwpOwogICAgICB9KTsKICAgIH0KICB9LAogIHJlc29sdmVDc3NUZXh0OiBmdW5jdGlvbihpbkNzc1RleHQsIGluQmFzZVVybCkgewogICAgcmV0dXJuIGluQ3NzVGV4dC5yZXBsYWNlKC91cmxcKFteKV0qXCkvZywgZnVuY3Rpb24oaW5NYXRjaCkgewogICAgICAvLyBmaW5kIHRoZSB1cmwgcGF0aCwgaWdub3JlIHF1b3RlcyBpbiB1cmwgc3RyaW5nCiAgICAgIHZhciB1cmxQYXRoID0gaW5NYXRjaC5yZXBsYWNlKC9bIiddL2csICIiKS5zbGljZSg0LCAtMSk7CiAgICAgIHVybFBhdGggPSBwYXRoLnJlc29sdmVVcmwoaW5CYXNlVXJsLCB1cmxQYXRoLCB0cnVlKTsKICAgICAgcmV0dXJuICJ1cmwoIiArIHVybFBhdGggKyAiKSI7CiAgICB9KTsKICB9LAogIHJlc29sdmVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpblJvb3QsIGluVXJsKSB7CiAgICAvLyBzZWFyY2ggZm9yIGF0dHJpYnV0ZXMgdGhhdCBob3N0IHVybHMKICAgIHZhciBub2RlcyA9IGluUm9vdCAmJiBpblJvb3QucXVlcnlTZWxlY3RvckFsbChVUkxfQVRUUlNfU0VMRUNUT1IpOwogICAgaWYgKG5vZGVzKSB7CiAgICAgIGZvckVhY2gobm9kZXMsIGZ1bmN0aW9uKG4pIHsKICAgICAgICB0aGlzLnJlc29sdmVOb2RlQXR0cmlidXRlcyhuLCBpblVybCk7CiAgICAgIH0sIHRoaXMpOwogICAgfQogIH0sCiAgcmVzb2x2ZU5vZGVBdHRyaWJ1dGVzOiBmdW5jdGlvbihpbk5vZGUsIGluVXJsKSB7CiAgICBVUkxfQVRUUlMuZm9yRWFjaChmdW5jdGlvbih2KSB7CiAgICAgIHZhciBhdHRyID0gaW5Ob2RlLmF0dHJpYnV0ZXNbdl07CiAgICAgIGlmIChhdHRyICYmIGF0dHIudmFsdWUgJiYKICAgICAgICAgKGF0dHIudmFsdWUuc2VhcmNoKFVSTF9URU1QTEFURV9TRUFSQ0gpIDwgMCkpIHsKICAgICAgICB2YXIgdXJsUGF0aCA9IHBhdGgucmVzb2x2ZVVybChpblVybCwgYXR0ci52YWx1ZSwgdHJ1ZSk7CiAgICAgICAgYXR0ci52YWx1ZSA9IHVybFBhdGg7CiAgICAgIH0KICAgIH0pOwogIH0KfTsKCnhociA9IHhociB8fCB7CiAgYXN5bmM6IHRydWUsCiAgb2s6IGZ1bmN0aW9uKGluUmVxdWVzdCkgewogICAgcmV0dXJuIChpblJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiBpblJlcXVlc3Quc3RhdHVzIDwgMzAwKQogICAgICAgIHx8IChpblJlcXVlc3Quc3RhdHVzID09PSAzMDQpCiAgICAgICAgfHwgKGluUmVxdWVzdC5zdGF0dXMgPT09IDApOwogIH0sCiAgbG9hZDogZnVuY3Rpb24odXJsLCBuZXh0LCBuZXh0Q29udGV4dCkgewogICAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKICAgIGlmIChzY29wZS5mbGFncy5kZWJ1ZyB8fCBzY29wZS5mbGFncy5idXN0KSB7CiAgICAgIHVybCArPSAnPycgKyBNYXRoLnJhbmRvbSgpOwogICAgfQogICAgcmVxdWVzdC5vcGVuKCdHRVQnLCB1cmwsIHhoci5hc3luYyk7CiAgICByZXF1ZXN0LmFkZEV2ZW50TGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgICAgIGlmIChyZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQpIHsKICAgICAgICBuZXh0LmNhbGwobmV4dENvbnRleHQsICF4aHIub2socmVxdWVzdCkgJiYgcmVxdWVzdCwKICAgICAgICAgIHJlcXVlc3QucmVzcG9uc2UsIHVybCk7CiAgICAgIH0KICAgIH0pOwogICAgcmVxdWVzdC5zZW5kKCk7CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKLy8gZXhwb3J0cwoKc2NvcGUucGF0aCA9IHBhdGg7CnNjb3BlLnhociA9IHhocjsKc2NvcGUuaW1wb3J0ZXIgPSBpbXBvcnRlcjsKc2NvcGUuZ2V0RG9jdW1lbnRVcmwgPSBwYXRoLmdldERvY3VtZW50VXJsOwpzY29wZS5JTVBPUlRfTElOS19UWVBFID0gSU1QT1JUX0xJTktfVFlQRTsKCn0pKHdpbmRvdy5IVE1MSW1wb3J0cyk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKHNjb3BlKSB7Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9ICdpbXBvcnQnOwoKLy8gaGlnaGxhbmRlciBvYmplY3QgZm9yIHBhcnNpbmcgYSBkb2N1bWVudCB0cmVlCgp2YXIgaW1wb3J0UGFyc2VyID0gewogIHNlbGVjdG9yczogWwogICAgJ2xpbmtbcmVsPScgKyBJTVBPUlRfTElOS19UWVBFICsgJ10nLAogICAgJ2xpbmtbcmVsPXN0eWxlc2hlZXRdJywKICAgICdzdHlsZScsCiAgICAnc2NyaXB0JwogIF0sCiAgbWFwOiB7CiAgICBsaW5rOiAncGFyc2VMaW5rJywKICAgIHNjcmlwdDogJ3BhcnNlU2NyaXB0JywKICAgIHN0eWxlOiAncGFyc2VHZW5lcmljJwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX2ltcG9ydFBhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChpbXBvcnRQYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgaW1wb3J0UGFyc2VyW2ltcG9ydFBhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICB9CiAgfSwKICBwYXJzZUxpbms6IGZ1bmN0aW9uKGxpbmtFbHQpIHsKICAgIGlmIChpc0RvY3VtZW50TGluayhsaW5rRWx0KSkgewogICAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgICAgaW1wb3J0UGFyc2VyLnBhcnNlKGxpbmtFbHQuY29udGVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHRoaXMucGFyc2VHZW5lcmljKGxpbmtFbHQpOwogICAgfQogIH0sCiAgcGFyc2VHZW5lcmljOiBmdW5jdGlvbihlbHQpIHsKICAgIGlmIChuZWVkc01haW5Eb2N1bWVudENvbnRleHQoZWx0KSkgewogICAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKGVsdCk7CiAgICB9CiAgfSwKICBwYXJzZVNjcmlwdDogZnVuY3Rpb24oc2NyaXB0RWx0KSB7CiAgICBpZiAobmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KHNjcmlwdEVsdCkpIHsKICAgICAgLy8gYWNxdWlyZSBjb2RlIHRvIGV4ZWN1dGUKICAgICAgdmFyIGNvZGUgPSAoc2NyaXB0RWx0Ll9fcmVzb3VyY2UgfHwgc2NyaXB0RWx0LnRleHRDb250ZW50KS50cmltKCk7CiAgICAgIGlmIChjb2RlKSB7CiAgICAgICAgLy8gY2FsY3VsYXRlIHNvdXJjZSBtYXAgaGludAogICAgICAgIHZhciBtb25pa2VyID0gc2NyaXB0RWx0Ll9fbm9kZVVybDsKICAgICAgICBpZiAoIW1vbmlrZXIpIHsKICAgICAgICAgIHZhciBtb25pa2VyID0gc2NvcGUucGF0aC5kb2N1bWVudFVybEZyb21Ob2RlKHNjcmlwdEVsdCk7CiAgICAgICAgICAvLyB0aGVyZSBjb3VsZCBiZSBtb3JlIHRoYW4gb25lIHNjcmlwdCB0aGlzIHVybAogICAgICAgICAgdmFyIHRhZyA9ICdbJyArIE1hdGguZmxvb3IoKE1hdGgucmFuZG9tKCkrMSkqMTAwMCkgKyAnXSc7CiAgICAgICAgICAvLyBUT0RPKHNqbWlsZXMpOiBQb2x5bWVyIGhhY2ssIHNob3VsZCBiZSBwbHVnZ2FibGUgaWYgd2UgbmVlZCB0byBhbGxvdwogICAgICAgICAgLy8gdGhpcyBzb3J0IG9mIHRoaW5nCiAgICAgICAgICB2YXIgbWF0Y2hlcyA9IGNvZGUubWF0Y2goL1BvbHltZXJcKFsnIl0oW14nIl0qKS8pOwogICAgICAgICAgdGFnID0gbWF0Y2hlcyAmJiBtYXRjaGVzWzFdIHx8IHRhZzsKICAgICAgICAgIC8vIHRhZyB0aGUgbW9uaWtlcgogICAgICAgICAgbW9uaWtlciArPSAnLycgKyB0YWcgKyAnLmpzJzsKICAgICAgICB9CiAgICAgICAgLy8gc291cmNlIG1hcCBoaW50CiAgICAgICAgY29kZSArPSAiXG4vLyMgc291cmNlVVJMPSIgKyBtb25pa2VyICsgIlxuIjsKICAgICAgICAvLyBldmFsdWF0ZSB0aGUgY29kZQogICAgICAgIGV2YWwuY2FsbCh3aW5kb3csIGNvZGUpOwogICAgICB9CiAgICB9CiAgfQp9OwoKdmFyIGZvckVhY2ggPSBBcnJheS5wcm90b3R5cGUuZm9yRWFjaC5jYWxsLmJpbmQoQXJyYXkucHJvdG90eXBlLmZvckVhY2gpOwoKZnVuY3Rpb24gaXNEb2N1bWVudExpbmsoZWx0KSB7CiAgcmV0dXJuIGVsdC5sb2NhbE5hbWUgPT09ICdsaW5rJwogICAgICAmJiBlbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRTsKfQoKZnVuY3Rpb24gbmVlZHNNYWluRG9jdW1lbnRDb250ZXh0KG5vZGUpIHsKICAvLyBub2RlcyBjYW4gYmUgbW92ZWQgdG8gdGhlIG1haW4gZG9jdW1lbnQ6CiAgLy8gaWYgdGhleSBhcmUgaW4gYSB0cmVlIGJ1dCBub3QgaW4gdGhlIG1haW4gZG9jdW1lbnQgYW5kIG5vdCBjaGlsZHJlbiBvZiA8ZWxlbWVudD4KICByZXR1cm4gbm9kZS5wYXJlbnROb2RlICYmICFpbk1haW5Eb2N1bWVudChub2RlKQogICAgICAmJiAhaXNFbGVtZW50RWxlbWVudENoaWxkKG5vZGUpOwp9CgpmdW5jdGlvbiBpbk1haW5Eb2N1bWVudChlbHQpIHsKICByZXR1cm4gZWx0Lm93bmVyRG9jdW1lbnQgPT09IGRvY3VtZW50IHx8CiAgICAvLyBUT0RPKHNqbWlsZXMpOiBTaGFkb3dET01Qb2x5ZmlsbCBpbnRydXNpb24KICAgIGVsdC5vd25lckRvY3VtZW50LmltcGwgPT09IGRvY3VtZW50Owp9CgpmdW5jdGlvbiBpc0VsZW1lbnRFbGVtZW50Q2hpbGQoZWx0KSB7CiAgcmV0dXJuIGVsdC5wYXJlbnROb2RlICYmIGVsdC5wYXJlbnROb2RlLmxvY2FsTmFtZSA9PT0gJ2VsZW1lbnQnOwp9CgovLyBleHBvcnRzCgpzY29wZS5wYXJzZXIgPSBpbXBvcnRQYXJzZXI7Cgp9KShIVE1MSW1wb3J0cyk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwCgovLyBJRSBzaGltIGZvciBDdXN0b21FdmVudAppZiAodHlwZW9mIHdpbmRvdy5DdXN0b21FdmVudCAhPT0gJ2Z1bmN0aW9uJykgewogIHdpbmRvdy5DdXN0b21FdmVudCA9IGZ1bmN0aW9uKGluVHlwZSkgewogICAgIHZhciBlID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ0hUTUxFdmVudHMnKTsKICAgICBlLmluaXRFdmVudChpblR5cGUsIHRydWUsIHRydWUpOwogICAgIHJldHVybiBlOwogIH07Cn0KCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBwcmVsb2FkIGRvY3VtZW50IHJlc291cmNlIHRyZWVzCiAgSFRNTEltcG9ydHMuaW1wb3J0ZXIubG9hZChkb2N1bWVudCwgZnVuY3Rpb24oKSB7CiAgICBIVE1MSW1wb3J0cy5wYXJzZXIucGFyc2UoZG9jdW1lbnQpOwogICAgSFRNTEltcG9ydHMucmVhZHlUaW1lID0gbmV3IERhdGUoKS5nZXRUaW1lKCk7CiAgICAvLyBzZW5kIEhUTUxJbXBvcnRzTG9hZGVkIHdoZW4gZmluaXNoZWQKICAgIGRvY3VtZW50LmRpc3BhdGNoRXZlbnQoCiAgICAgIG5ldyBDdXN0b21FdmVudCgnSFRNTEltcG9ydHNMb2FkZWQnLCB7YnViYmxlczogdHJ1ZX0pCiAgICApOwogIH0pOwp9OwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICBib290c3RyYXAoKTsKfSBlbHNlIHsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGJvb3RzdHJhcCk7Cn0KCn0pKCk7CgovKgogKiBDb3B5cmlnaHQgMjAxMyBUaGUgUG9seW1lciBBdXRob3JzLiBBbGwgcmlnaHRzIHJlc2VydmVkLgogKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhIEJTRC1zdHlsZQogKiBsaWNlbnNlIHRoYXQgY2FuIGJlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUuCiAqLwoKKGZ1bmN0aW9uKCkgewoKLy8gaW1wb3J0Cgp2YXIgSU1QT1JUX0xJTktfVFlQRSA9IHdpbmRvdy5IVE1MSW1wb3J0cyA/IEhUTUxJbXBvcnRzLklNUE9SVF9MSU5LX1RZUEUgOiAnbm9uZSc7CgovLyBoaWdobGFuZGVyIG9iamVjdCBmb3IgcGFyc2luZyBhIGRvY3VtZW50IHRyZWUKCnZhciBwYXJzZXIgPSB7CiAgc2VsZWN0b3JzOiBbCiAgICAnbGlua1tyZWw9JyArIElNUE9SVF9MSU5LX1RZUEUgKyAnXScsCiAgICAnZWxlbWVudCcKICBdLAogIG1hcDogewogICAgbGluazogJ3BhcnNlTGluaycsCiAgICBlbGVtZW50OiAncGFyc2VFbGVtZW50JwogIH0sCiAgcGFyc2U6IGZ1bmN0aW9uKGluRG9jdW1lbnQpIHsKICAgIGlmICghaW5Eb2N1bWVudC5fX3BhcnNlZCkgewogICAgICAvLyBvbmx5IHBhcnNlIG9uY2UKICAgICAgaW5Eb2N1bWVudC5fX3BhcnNlZCA9IHRydWU7CiAgICAgIC8vIGFsbCBwYXJzYWJsZSBlbGVtZW50cyBpbiBpbkRvY3VtZW50IChkZXB0aC1maXJzdCBwcmUtb3JkZXIgdHJhdmVyc2FsKQogICAgICB2YXIgZWx0cyA9IGluRG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChwYXJzZXIuc2VsZWN0b3JzKTsKICAgICAgLy8gZm9yIGVhY2ggcGFyc2FibGUgbm9kZSB0eXBlLCBjYWxsIHRoZSBtYXBwZWQgcGFyc2luZyBtZXRob2QKICAgICAgZm9yRWFjaChlbHRzLCBmdW5jdGlvbihlKSB7CiAgICAgICAgcGFyc2VyW3BhcnNlci5tYXBbZS5sb2NhbE5hbWVdXShlKTsKICAgICAgfSk7CiAgICAgIC8vIHVwZ3JhZGUgYWxsIHVwZ3JhZGVhYmxlIHN0YXRpYyBlbGVtZW50cywgYW55dGhpbmcgZHluYW1pY2FsbHkKICAgICAgLy8gY3JlYXRlZCBzaG91bGQgYmUgY2F1Z2h0IGJ5IG9ic2VydmVyCiAgICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChpbkRvY3VtZW50KTsKICAgICAgLy8gb2JzZXJ2ZSBkb2N1bWVudCBmb3IgZG9tIGNoYW5nZXMKICAgICAgQ3VzdG9tRWxlbWVudHMub2JzZXJ2ZURvY3VtZW50KGluRG9jdW1lbnQpOwogICAgfQogIH0sCiAgcGFyc2VMaW5rOiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICAvLyBpbXBvcnRzCiAgICBpZiAoaXNEb2N1bWVudExpbmsobGlua0VsdCkpIHsKICAgICAgdGhpcy5wYXJzZUltcG9ydChsaW5rRWx0KTsKICAgIH0KICB9LAogIHBhcnNlSW1wb3J0OiBmdW5jdGlvbihsaW5rRWx0KSB7CiAgICBpZiAobGlua0VsdC5jb250ZW50KSB7CiAgICAgIHBhcnNlci5wYXJzZShsaW5rRWx0LmNvbnRlbnQpOwogICAgfQogIH0sCiAgcGFyc2VFbGVtZW50OiBmdW5jdGlvbihpbkVsZW1lbnRFbHQpIHsKICAgIG5ldyBIVE1MRWxlbWVudEVsZW1lbnQoaW5FbGVtZW50RWx0KTsKICB9Cn07CgpmdW5jdGlvbiBpc0RvY3VtZW50TGluayhpbkVsdCkgewogIHJldHVybiAoaW5FbHQubG9jYWxOYW1lID09PSAnbGluaycKICAgICAgJiYgaW5FbHQuZ2V0QXR0cmlidXRlKCdyZWwnKSA9PT0gSU1QT1JUX0xJTktfVFlQRSk7Cn0KCnZhciBmb3JFYWNoID0gQXJyYXkucHJvdG90eXBlLmZvckVhY2guY2FsbC5iaW5kKEFycmF5LnByb3RvdHlwZS5mb3JFYWNoKTsKCi8vIGV4cG9ydHMKCkN1c3RvbUVsZW1lbnRzLnBhcnNlciA9IHBhcnNlcjsKCn0pKCk7Ci8qCiAqIENvcHlyaWdodCAyMDEzIFRoZSBQb2x5bWVyIEF1dGhvcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlCiAqIGxpY2Vuc2UgdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZS4KICovCihmdW5jdGlvbigpewoKLy8gYm9vdHN0cmFwIHBhcnNpbmcKCmZ1bmN0aW9uIGJvb3RzdHJhcCgpIHsKICAvLyBnbyBhc3luYyBzbyBjYWxsIHN0YWNrIGNhbiB1bndpbmQKICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgLy8gcGFyc2UgZG9jdW1lbnQKICAgIEN1c3RvbUVsZW1lbnRzLnBhcnNlci5wYXJzZShkb2N1bWVudCk7CiAgICAvLyBvbmUgbW9yZSBwYXNzIGJlZm9yZSByZWdpc3RlciBpcyAnbGl2ZScKICAgIEN1c3RvbUVsZW1lbnRzLnVwZ3JhZGVEb2N1bWVudChkb2N1bWVudCk7CiAgICAvLyBzZXQgaW50ZXJuYWwgJ3JlYWR5JyBmbGFnLCBub3cgZG9jdW1lbnQucmVnaXN0ZXIgd2lsbCB0cmlnZ2VyCiAgICAvLyBzeW5jaHJvbm91cyB1cGdyYWRlcwogICAgQ3VzdG9tRWxlbWVudHMucmVhZHkgPSB0cnVlOwogICAgLy8gY2FwdHVyZSBibHVudCBwcm9maWxpbmcgZGF0YQogICAgQ3VzdG9tRWxlbWVudHMucmVhZHlUaW1lID0gRGF0ZS5ub3coKTsKICAgIGlmICh3aW5kb3cuSFRNTEltcG9ydHMpIHsKICAgICAgQ3VzdG9tRWxlbWVudHMuZWxhcHNlZCA9IEN1c3RvbUVsZW1lbnRzLnJlYWR5VGltZSAtIEhUTUxJbXBvcnRzLnJlYWR5VGltZTsKICAgIH0KICAgIC8vIG5vdGlmeSB0aGUgc3lzdGVtIHRoYXQgd2UgYXJlIGJvb3RzdHJhcHBlZAogICAgZG9jdW1lbnQuYm9keS5kaXNwYXRjaEV2ZW50KAogICAgICBuZXcgQ3VzdG9tRXZlbnQoJ1dlYkNvbXBvbmVudHNSZWFkeScsIHtidWJibGVzOiB0cnVlfSkKICAgICk7CiAgfSwgMCk7Cn0KCi8vIEN1c3RvbUV2ZW50IHNoaW0gZm9yIElFCmlmICh0eXBlb2Ygd2luZG93LkN1c3RvbUV2ZW50ICE9PSAnZnVuY3Rpb24nKSB7CiAgd2luZG93LkN1c3RvbUV2ZW50ID0gZnVuY3Rpb24oaW5UeXBlKSB7CiAgICAgdmFyIGUgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgnSFRNTEV2ZW50cycpOwogICAgIGUuaW5pdEV2ZW50KGluVHlwZSwgdHJ1ZSwgdHJ1ZSk7CiAgICAgcmV0dXJuIGU7CiAgfTsKfQoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICdjb21wbGV0ZScpIHsKICBib290c3RyYXAoKTsKfSBlbHNlIHsKICB2YXIgbG9hZEV2ZW50ID0gd2luZG93LkhUTUxJbXBvcnRzID8gJ0hUTUxJbXBvcnRzTG9hZGVkJyA6ICdET01Db250ZW50TG9hZGVkJzsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihsb2FkRXZlbnQsIGJvb3RzdHJhcCk7Cn0KCn0pKCk7CgooZnVuY3Rpb24gKCkgewoKLyoqKiBWYXJpYWJsZXMgKioqLwoKICB2YXIgd2luID0gd2luZG93LAogICAgZG9jID0gZG9jdW1lbnQsCiAgICBub29wID0gZnVuY3Rpb24oKXt9LAogICAgcmVnZXhQc2V1ZG9TcGxpdCA9IC8oW1x3LV0rKD86XChbXlwpXStcKSk/KS9nLAogICAgcmVnZXhQc2V1ZG9SZXBsYWNlID0gLyhcdyopKD86XCgoW15cKV0qKVwpKT8vLAogICAgcmVnZXhEaWdpdHMgPSAvKFxkKykvZywKICAgIGtleXBzZXVkbyA9IHsKICAgICAgYWN0aW9uOiBmdW5jdGlvbiAocHNldWRvLCBldmVudCkgewogICAgICAgIHJldHVybiBwc2V1ZG8udmFsdWUubWF0Y2gocmVnZXhEaWdpdHMpLmluZGV4T2YoU3RyaW5nKGV2ZW50LmtleUNvZGUpKSA+IC0xID09IChwc2V1ZG8ubmFtZSA9PSAna2V5cGFzcycpOwogICAgICB9CiAgICB9LAogICAgcHJlZml4ID0gKGZ1bmN0aW9uICgpIHsKICAgICAgdmFyIHN0eWxlcyA9IHdpbi5nZXRDb21wdXRlZFN0eWxlKGRvYy5kb2N1bWVudEVsZW1lbnQsICcnKSwKICAgICAgICAgIHByZSA9IChBcnJheS5wcm90b3R5cGUuc2xpY2UKICAgICAgICAgICAgLmNhbGwoc3R5bGVzKQogICAgICAgICAgICAuam9pbignJykKICAgICAgICAgICAgLm1hdGNoKC8tKG1venx3ZWJraXR8bXMpLS8pIHx8IChzdHlsZXMuT0xpbmsgPT09ICcnICYmIFsnJywgJ28nXSkKICAgICAgICAgIClbMV07CiAgICAgIHJldHVybiB7CiAgICAgICAgZG9tOiBwcmUgPT0gJ21zJyA/IHByZS50b1VwcGVyQ2FzZSgpIDogcHJlLAogICAgICAgIGxvd2VyY2FzZTogcHJlLAogICAgICAgIGNzczogJy0nICsgcHJlICsgJy0nLAogICAgICAgIGpzOiBwcmUgPT0gJ21zJyA/IHByZSA6IHByZVswXS50b1VwcGVyQ2FzZSgpICsgcHJlLnN1YnN0cigxKQogICAgICB9OwoKICAgIH0pKCksCiAgICBtYXRjaFNlbGVjdG9yID0gRWxlbWVudC5wcm90b3R5cGUubWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnQucHJvdG90eXBlW3ByZWZpeC5sb3dlcmNhc2UgKyAnTWF0Y2hlc1NlbGVjdG9yJ10sCiAgICBtdXRhdGlvbiA9IHdpbi5NdXRhdGlvbk9ic2VydmVyIHx8IHdpbltwcmVmaXguanMgKyAnTXV0YXRpb25PYnNlcnZlciddOwoKLyoqKiBGdW5jdGlvbnMgKioqLwoKLy8gVXRpbGl0aWVzCgogIHZhciB0eXBlT2JqID0ge307CiAgZnVuY3Rpb24gdHlwZU9mKG9iaikgewogICAgcmV0dXJuIHR5cGVPYmoudG9TdHJpbmcuY2FsbChvYmopLm1hdGNoKC9ccyhbYS16QS1aXSspLylbMV0udG9Mb3dlckNhc2UoKTsKICB9CgogIGZ1bmN0aW9uIGNsb25lKGl0ZW0sIHR5cGUpewogICAgdmFyIGZuID0gY2xvbmVbdHlwZSB8fCB0eXBlT2YoaXRlbSldOwogICAgcmV0dXJuIGZuID8gZm4oaXRlbSkgOiBpdGVtOwogIH0KICAgIGNsb25lLm9iamVjdCA9IGZ1bmN0aW9uKHNyYyl7CiAgICAgIHZhciBvYmogPSB7fTsKICAgICAgZm9yICh2YXIga2V5IGluIHNyYykgb2JqW2tleV0gPSBjbG9uZShzcmNba2V5XSk7CiAgICAgIHJldHVybiBvYmo7CiAgICB9OwogICAgY2xvbmUuYXJyYXkgPSBmdW5jdGlvbihzcmMpewogICAgICB2YXIgaSA9IHNyYy5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwogICAgICB3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGNsb25lKHNyY1tpXSk7CiAgICAgIHJldHVybiBhcnJheTsKICAgIH07CgogIHZhciB1bnNsaWNlYWJsZSA9IFsnbnVtYmVyJywgJ2Jvb2xlYW4nLCAnc3RyaW5nJywgJ2Z1bmN0aW9uJ107CiAgZnVuY3Rpb24gdG9BcnJheShvYmopewogICAgcmV0dXJuIHVuc2xpY2VhYmxlLmluZGV4T2YodHlwZU9mKG9iaikpID09IC0xID8KICAgIEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKG9iaiwgMCkgOgogICAgW29ial07CiAgfQoKLy8gRE9NCiAgdmFyIHN0ciA9ICcnOwogIGZ1bmN0aW9uIHF1ZXJ5KGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHJldHVybiAoc2VsZWN0b3IgfHwgc3RyKS5sZW5ndGggPyB0b0FycmF5KGVsZW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikpIDogW107CiAgfQoKICBmdW5jdGlvbiBwYXJzZU11dGF0aW9ucyhlbGVtZW50LCBtdXRhdGlvbnMpIHsKICAgIHZhciBkaWZmID0geyBhZGRlZDogW10sIHJlbW92ZWQ6IFtdIH07CiAgICBtdXRhdGlvbnMuZm9yRWFjaChmdW5jdGlvbihyZWNvcmQpewogICAgICByZWNvcmQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgZm9yICh2YXIgeiBpbiBkaWZmKSB7CiAgICAgICAgdmFyIHR5cGUgPSBlbGVtZW50Ll9yZWNvcmRzWyh6ID09ICdhZGRlZCcpID8gJ2luc2VydGVkJyA6ICdyZW1vdmVkJ10sCiAgICAgICAgICBub2RlcyA9IHJlY29yZFt6ICsgJ05vZGVzJ10sIGxlbmd0aCA9IG5vZGVzLmxlbmd0aDsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aCAmJiBkaWZmW3pdLmluZGV4T2Yobm9kZXNbaV0pID09IC0xOyBpKyspewogICAgICAgICAgZGlmZlt6XS5wdXNoKG5vZGVzW2ldKTsKICAgICAgICAgIHR5cGUuZm9yRWFjaChmdW5jdGlvbihmbil7CiAgICAgICAgICAgIGZuKG5vZGVzW2ldLCByZWNvcmQpOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9KTsKICB9CgovLyBNaXhpbnMKCiAgZnVuY3Rpb24gbWVyZ2VPbmUoc291cmNlLCBrZXksIGN1cnJlbnQpewogICAgdmFyIHR5cGUgPSB0eXBlT2YoY3VycmVudCk7CiAgICBpZiAodHlwZSA9PSAnb2JqZWN0JyAmJiB0eXBlT2Yoc291cmNlW2tleV0pID09ICdvYmplY3QnKSB4dGFnLm1lcmdlKHNvdXJjZVtrZXldLCBjdXJyZW50KTsKICAgIGVsc2Ugc291cmNlW2tleV0gPSBjbG9uZShjdXJyZW50LCB0eXBlKTsKICAgIHJldHVybiBzb3VyY2U7CiAgfQoKICBmdW5jdGlvbiBtZXJnZU1peGluKHR5cGUsIG1peGluLCBvcHRpb24pIHsKICAgIHZhciBvcmlnaW5hbCA9IHt9OwogICAgZm9yICh2YXIgbyBpbiBvcHRpb24pIG9yaWdpbmFsW28uc3BsaXQoJzonKVswXV0gPSB0cnVlOwogICAgZm9yICh2YXIgeCBpbiBtaXhpbikgaWYgKCFvcmlnaW5hbFt4LnNwbGl0KCc6JylbMF1dKSBvcHRpb25beF0gPSBtaXhpblt4XTsKICB9CgogIGZ1bmN0aW9uIGFwcGx5TWl4aW5zKHRhZykgewogICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uIChuYW1lKSB7CiAgICAgIHZhciBtaXhpbiA9IHh0YWcubWl4aW5zW25hbWVdOwogICAgICBmb3IgKHZhciB0eXBlIGluIG1peGluKSB7CiAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICBjYXNlICdsaWZlY3ljbGUnOiBjYXNlICdtZXRob2RzJzoKICAgICAgICAgICAgbWVyZ2VNaXhpbih0eXBlLCBtaXhpblt0eXBlXSwgdGFnW3R5cGVdKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdhY2Nlc3NvcnMnOiBjYXNlICdwcm90b3R5cGUnOgogICAgICAgICAgICBmb3IgKHZhciB6IGluIG1peGluW3R5cGVdKSBtZXJnZU1peGluKHosIG1peGluW3R5cGVdLCB0YWcuYWNjZXNzb3JzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlICdldmVudHMnOgogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0pOwogICAgcmV0dXJuIHRhZzsKICB9CgovLyBFdmVudHMKCiAgZnVuY3Rpb24gdG91Y2hGaWx0ZXIoY3VzdG9tLCBldmVudCkgewogICAgaWYgKGV2ZW50LnR5cGUubWF0Y2goJ3RvdWNoJykpewogICAgICBjdXN0b20ubGlzdGVuZXIudG91Y2hlZCA9IHRydWU7CiAgICB9CiAgICBlbHNlIGlmIChjdXN0b20ubGlzdGVuZXIudG91Y2hlZCAmJiBldmVudC50eXBlLm1hdGNoKCdtb3VzZScpKXsKICAgICAgY3VzdG9tLmxpc3RlbmVyLnRvdWNoZWQgPSBmYWxzZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQoKICBmdW5jdGlvbiBjcmVhdGVGbG93RXZlbnQodHlwZSkgewogICAgdmFyIGZsb3cgPSB0eXBlID09ICdvdmVyJzsKICAgIHJldHVybiB7CiAgICAgIGJhc2U6ICdPdmVyZmxvd0V2ZW50JyBpbiB3aW4gPyAnb3ZlcmZsb3djaGFuZ2VkJyA6IHR5cGUgKyAnZmxvdycsCiAgICAgIGNvbmRpdGlvbjogZnVuY3Rpb24gKGN1c3RvbSwgZXZlbnQpIHsKICAgICAgICBldmVudC5mbG93ID0gdHlwZTsKICAgICAgICByZXR1cm4gZXZlbnQudHlwZSA9PSAodHlwZSArICdmbG93JykgfHwKICAgICAgICAoKGV2ZW50Lm9yaWVudCA9PT0gMCAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdykgfHwKICAgICAgICAoZXZlbnQub3JpZW50ID09IDEgJiYgZXZlbnQudmVydGljYWxPdmVyZmxvdyA9PSBmbG93KSB8fAogICAgICAgIChldmVudC5vcmllbnQgPT0gMiAmJiBldmVudC5ob3Jpem9udGFsT3ZlcmZsb3cgPT0gZmxvdyAmJiBldmVudC52ZXJ0aWNhbE92ZXJmbG93ID09IGZsb3cpKTsKICAgICAgfQogICAgfTsKICB9CgovLyBBY2Nlc3NvcnMKCiAgZnVuY3Rpb24gZ2V0QXJncyhhdHRyLCB2YWx1ZSl7CiAgICByZXR1cm4gewogICAgICB2YWx1ZTogYXR0ci5ib29sZWFuID8gJycgOiB2YWx1ZSwKICAgICAgbWV0aG9kOiBhdHRyLmJvb2xlYW4gJiYgIXZhbHVlID8gJ3JlbW92ZUF0dHJpYnV0ZScgOiAnc2V0QXR0cmlidXRlJwogICAgfTsKICB9CgogIGZ1bmN0aW9uIG1vZEF0dHIoZWxlbWVudCwgYXR0ciwgbmFtZSwgdmFsdWUpewogICAgdmFyIGFyZ3MgPSBnZXRBcmdzKGF0dHIsIHZhbHVlKTsKICAgIGVsZW1lbnRbYXJncy5tZXRob2RdKG5hbWUsIGFyZ3MudmFsdWUpOwogIH0KCiAgZnVuY3Rpb24gc3luY0F0dHIoZWxlbWVudCwgYXR0ciwgbmFtZSwgdmFsdWUsIG1ldGhvZCl7CiAgICB2YXIgbm9kZXMgPSBhdHRyLnByb3BlcnR5ID8gW2VsZW1lbnQueHRhZ1thdHRyLnByb3BlcnR5XV0gOiBhdHRyLnNlbGVjdG9yID8geHRhZy5xdWVyeShlbGVtZW50LCBhdHRyLnNlbGVjdG9yKSA6IFtdLAogICAgICAgIGluZGV4ID0gbm9kZXMubGVuZ3RoOwogICAgd2hpbGUgKGluZGV4LS0pIG5vZGVzW2luZGV4XVttZXRob2RdKG5hbWUsIHZhbHVlKTsKICB9CgogIGZ1bmN0aW9uIHVwZGF0ZVZpZXcoZWxlbWVudCwgbmFtZSwgdmFsdWUpewogICAgaWYgKGVsZW1lbnQueHRhZy5fX3ZpZXdfXyl7CiAgICAgIGVsZW1lbnQueHRhZy5fX3ZpZXdfXy51cGRhdGVCaW5kaW5nVmFsdWUoZWxlbWVudCwgbmFtZSwgdmFsdWUpOwogICAgfQogIH0KCiAgZnVuY3Rpb24gYXR0YWNoUHJvcGVydGllcyh0YWcsIHByb3AsIHosIGFjY2Vzc29yLCBhdHRyLCBuYW1lKXsKICAgIHZhciBrZXkgPSB6LnNwbGl0KCc6JyksIHR5cGUgPSBrZXlbMF07CiAgICBpZiAodHlwZSA9PSAnZ2V0JykgewogICAgICBrZXlbMF0gPSBwcm9wOwogICAgICB0YWcucHJvdG90eXBlW3Byb3BdLmdldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGFjY2Vzc29yW3pdLCB0YWcucHNldWRvcyk7CiAgICB9CiAgICBlbHNlIGlmICh0eXBlID09ICdzZXQnKSB7CiAgICAgIGtleVswXSA9IHByb3A7CiAgICAgIHZhciBzZXR0ZXIgPSB0YWcucHJvdG90eXBlW3Byb3BdLnNldCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGtleS5qb2luKCc6JyksIGF0dHIgPyBmdW5jdGlvbih2YWx1ZSl7CiAgICAgICAgdGhpcy54dGFnLl9za2lwU2V0ID0gdHJ1ZTsKICAgICAgICBpZiAoIXRoaXMueHRhZy5fc2tpcEF0dHIpIG1vZEF0dHIodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIGlmICh0aGlzLnh0YWcuX3NraXBBdHRyICYmIGF0dHIuc2tpcCkgZGVsZXRlIHRoaXMueHRhZy5fc2tpcEF0dHI7CiAgICAgICAgYWNjZXNzb3Jbel0uY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyAhIXZhbHVlIDogdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBTZXQ7CiAgICAgIH0gOiBhY2Nlc3Nvclt6XSA/IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgICBhY2Nlc3Nvclt6XS5jYWxsKHRoaXMsIHZhbHVlKTsKICAgICAgICB1cGRhdGVWaWV3KHRoaXMsIG5hbWUsIHZhbHVlKTsKICAgICAgfSA6IG51bGwsIHRhZy5wc2V1ZG9zKTsKCiAgICAgIGlmIChhdHRyKSBhdHRyLnNldHRlciA9IHNldHRlcjsKICAgIH0KICAgIGVsc2UgdGFnLnByb3RvdHlwZVtwcm9wXVt6XSA9IGFjY2Vzc29yW3pdOwogIH0KCiAgZnVuY3Rpb24gcGFyc2VBY2Nlc3Nvcih0YWcsIHByb3ApewogICAgdGFnLnByb3RvdHlwZVtwcm9wXSA9IHt9OwogICAgdmFyIGFjY2Vzc29yID0gdGFnLmFjY2Vzc29yc1twcm9wXSwKICAgICAgICBhdHRyID0gYWNjZXNzb3IuYXR0cmlidXRlLAogICAgICAgIG5hbWUgPSBhdHRyICYmIGF0dHIubmFtZSA/IGF0dHIubmFtZS50b0xvd2VyQ2FzZSgpIDogcHJvcDsKCiAgICBpZiAoYXR0cikgewogICAgICBhdHRyLmtleSA9IHByb3A7CiAgICAgIHRhZy5hdHRyaWJ1dGVzW25hbWVdID0gYXR0cjsKICAgIH0KCiAgICBmb3IgKHZhciB6IGluIGFjY2Vzc29yKSBhdHRhY2hQcm9wZXJ0aWVzKHRhZywgcHJvcCwgeiwgYWNjZXNzb3IsIGF0dHIsIG5hbWUpOwoKICAgIGlmIChhdHRyKSB7CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQpIHsKICAgICAgICB2YXIgbWV0aG9kID0gKGF0dHIuYm9vbGVhbiA/ICdoYXMnIDogJ2dldCcpICsgJ0F0dHJpYnV0ZSc7CiAgICAgICAgdGFnLnByb3RvdHlwZVtwcm9wXS5nZXQgPSBmdW5jdGlvbigpewogICAgICAgICAgcmV0dXJuIHRoaXNbbWV0aG9kXShuYW1lKTsKICAgICAgICB9OwogICAgICB9CiAgICAgIGlmICghdGFnLnByb3RvdHlwZVtwcm9wXS5zZXQpIHRhZy5wcm90b3R5cGVbcHJvcF0uc2V0ID0gZnVuY3Rpb24odmFsdWUpewogICAgICAgIG1vZEF0dHIodGhpcywgYXR0ciwgbmFtZSwgdmFsdWUpOwogICAgICAgIHVwZGF0ZVZpZXcodGhpcywgbmFtZSwgdmFsdWUpOwogICAgICB9OwogICAgfQogIH0KCi8qKiogWC1UYWcgT2JqZWN0IERlZmluaXRpb24gKioqLwoKICB2YXIgeHRhZyA9IHsKICAgIHRhZ3M6IHt9LAogICAgZGVmYXVsdE9wdGlvbnM6IHsKICAgICAgcHNldWRvczogW10sCiAgICAgIG1peGluczogW10sCiAgICAgIGV2ZW50czoge30sCiAgICAgIG1ldGhvZHM6IHt9LAogICAgICBhY2Nlc3NvcnM6IHsKICAgICAgICB0ZW1wbGF0ZTogewogICAgICAgICAgYXR0cmlidXRlOiB7fSwKICAgICAgICAgIHNldDogZnVuY3Rpb24odmFsdWUpewogICAgICAgICAgICB2YXIgbGFzdCA9IHRoaXMuZ2V0QXR0cmlidXRlKCd0ZW1wbGF0ZScpOwogICAgICAgICAgICB0aGlzLnh0YWcuX19wcmV2aW91c1RlbXBsYXRlX18gPSBsYXN0OwogICAgICAgICAgICB4dGFnLmZpcmVFdmVudCh0aGlzLCAndGVtcGxhdGVjaGFuZ2UnLCB7IGRldGFpbDogeyB0ZW1wbGF0ZTogdmFsdWUgfX0pOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSwKICAgICAgbGlmZWN5Y2xlOiB7fSwKICAgICAgYXR0cmlidXRlczoge30sCiAgICAgICdwcm90b3R5cGUnOiB7CiAgICAgICAgeHRhZzogewogICAgICAgICAgZ2V0OiBmdW5jdGlvbigpewogICAgICAgICAgICByZXR1cm4gdGhpcy5fX3h0YWdfXyA/IHRoaXMuX194dGFnX18gOiAodGhpcy5fX3h0YWdfXyA9IHsgZGF0YToge30gfSk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICB9LAogICAgcmVnaXN0ZXI6IGZ1bmN0aW9uIChuYW1lLCBvcHRpb25zKSB7CiAgICAgIHZhciBlbGVtZW50LCBfbmFtZTsKICAgICAgaWYgKHR5cGVvZiBuYW1lID09ICdzdHJpbmcnKSB7CiAgICAgICAgX25hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7CiAgICAgIH0gZWxzZSBpZiAobmFtZS5ub2RlTmFtZSA9PSAnRUxFTUVOVCcpIHsKICAgICAgICBlbGVtZW50ID0gbmFtZTsKICAgICAgICBfbmFtZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCduYW1lJykudG9Mb3dlckNhc2UoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciB0YWcgPSB4dGFnLnRhZ3NbX25hbWVdID0gYXBwbHlNaXhpbnMoeHRhZy5tZXJnZSh7fSwgeHRhZy5kZWZhdWx0T3B0aW9ucywgb3B0aW9ucykpOwoKICAgICAgZm9yICh2YXIgeiBpbiB0YWcuZXZlbnRzKSB0YWcuZXZlbnRzW3pdID0geHRhZy5wYXJzZUV2ZW50KHosIHRhZy5ldmVudHNbel0pOwogICAgICBmb3IgKHogaW4gdGFnLmxpZmVjeWNsZSkgdGFnLmxpZmVjeWNsZVt6LnNwbGl0KCc6JylbMF1dID0geHRhZy5hcHBseVBzZXVkb3MoeiwgdGFnLmxpZmVjeWNsZVt6XSwgdGFnLnBzZXVkb3MpOwogICAgICBmb3IgKHogaW4gdGFnLm1ldGhvZHMpIHRhZy5wcm90b3R5cGVbei5zcGxpdCgnOicpWzBdXSA9IHsgdmFsdWU6IHh0YWcuYXBwbHlQc2V1ZG9zKHosIHRhZy5tZXRob2RzW3pdLCB0YWcucHNldWRvcyksIGVudW1lcmFibGU6IHRydWUgfTsKICAgICAgZm9yICh6IGluIHRhZy5hY2Nlc3NvcnMpIHBhcnNlQWNjZXNzb3IodGFnLCB6KTsKCiAgICAgIHZhciByZWFkeSA9IHRhZy5saWZlY3ljbGUuY3JlYXRlZCB8fCB0YWcubGlmZWN5Y2xlLnJlYWR5OwogICAgICB0YWcucHJvdG90eXBlLnJlYWR5Q2FsbGJhY2sgPSB7CiAgICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKXsKICAgICAgICAgIHZhciBlbGVtZW50ID0gdGhpczsKICAgICAgICAgIHZhciB0ZW1wbGF0ZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCd0ZW1wbGF0ZScpOwogICAgICAgICAgaWYgKHRlbXBsYXRlKXsKICAgICAgICAgICAgeHRhZy5maXJlRXZlbnQodGhpcywgJ3RlbXBsYXRlY2hhbmdlJywgeyBkZXRhaWw6IHsgdGVtcGxhdGU6IHRlbXBsYXRlIH19KTsKICAgICAgICAgIH0KICAgICAgICAgIHh0YWcuYWRkRXZlbnRzKHRoaXMsIHRhZy5ldmVudHMpOwogICAgICAgICAgdGFnLm1peGlucy5mb3JFYWNoKGZ1bmN0aW9uKG1peGluKXsKICAgICAgICAgICAgaWYgKHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpIHh0YWcuYWRkRXZlbnRzKGVsZW1lbnQsIHh0YWcubWl4aW5zW21peGluXS5ldmVudHMpOwogICAgICAgICAgfSk7CiAgICAgICAgICB2YXIgb3V0cHV0ID0gcmVhZHkgPyByZWFkeS5hcHBseSh0aGlzLCB0b0FycmF5KGFyZ3VtZW50cykpIDogbnVsbDsKICAgICAgICAgIGZvciAodmFyIG5hbWUgaW4gdGFnLmF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lXSwKICAgICAgICAgICAgICAgIGhhc0F0dHIgPSB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKTsKICAgICAgICAgICAgaWYgKGhhc0F0dHIgfHwgYXR0ci5ib29sZWFuKSB7CiAgICAgICAgICAgICAgdGhpc1thdHRyLmtleV0gPSBhdHRyLmJvb2xlYW4gPyBoYXNBdHRyIDogdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRhZy5wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICAgICAgb2JqLm9uQWRkLmNhbGwoZWxlbWVudCwgb2JqKTsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIG91dHB1dDsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAodGFnLmxpZmVjeWNsZS5pbnNlcnRlZCkgdGFnLnByb3RvdHlwZS5pbnNlcnRlZENhbGxiYWNrID0geyB2YWx1ZTogdGFnLmxpZmVjeWNsZS5pbnNlcnRlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5yZW1vdmVkKSB0YWcucHJvdG90eXBlLnJlbW92ZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUucmVtb3ZlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwogICAgICBpZiAodGFnLmxpZmVjeWNsZS5hdHRyaWJ1dGVDaGFuZ2VkKSB0YWcucHJvdG90eXBlLmF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayA9IHsgdmFsdWU6IHRhZy5saWZlY3ljbGUuYXR0cmlidXRlQ2hhbmdlZCwgZW51bWVyYWJsZTogdHJ1ZSB9OwoKICAgICAgdmFyIHNldEF0dHJpYnV0ZSA9IHRhZy5wcm90b3R5cGUuc2V0QXR0cmlidXRlIHx8IEhUTUxFbGVtZW50LnByb3RvdHlwZS5zZXRBdHRyaWJ1dGU7CiAgICAgIHRhZy5wcm90b3R5cGUuc2V0QXR0cmlidXRlID0gewogICAgICAgIHdyaXRhYmxlOiB0cnVlLAogICAgICAgIGVudW1iZXJhYmxlOiB0cnVlLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiAobmFtZSwgdmFsdWUpewogICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSBzZXRBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lLCBhdHRyICYmIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUpOwogICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgaWYgKGF0dHIuc2V0dGVyICYmICF0aGlzLnh0YWcuX3NraXBTZXQpIHsKICAgICAgICAgICAgICB0aGlzLnh0YWcuX3NraXBBdHRyID0gdHJ1ZTsKICAgICAgICAgICAgICBhdHRyLnNldHRlci5jYWxsKHRoaXMsIGF0dHIuYm9vbGVhbiA/IHRydWUgOiB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFsdWUgPSBhdHRyLnNraXAgPyBhdHRyLmJvb2xlYW4gPyB0aGlzLmhhc0F0dHJpYnV0ZShuYW1lKSA6IHRoaXMuZ2V0QXR0cmlidXRlKG5hbWUpIDogdmFsdWU7CiAgICAgICAgICAgIHN5bmNBdHRyKHRoaXMsIGF0dHIsIG5hbWUsIGF0dHIuYm9vbGVhbiA/ICcnIDogdmFsdWUsICdzZXRBdHRyaWJ1dGUnKTsKICAgICAgICAgIH0KICAgICAgICAgIGRlbGV0ZSB0aGlzLnh0YWcuX3NraXBBdHRyOwogICAgICAgIH0KICAgICAgfTsKCiAgICAgIHZhciByZW1vdmVBdHRyaWJ1dGUgPSB0YWcucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSB8fCBIVE1MRWxlbWVudC5wcm90b3R5cGUucmVtb3ZlQXR0cmlidXRlOwogICAgICB0YWcucHJvdG90eXBlLnJlbW92ZUF0dHJpYnV0ZSA9IHsKICAgICAgICB3cml0YWJsZTogdHJ1ZSwKICAgICAgICBlbnVtYmVyYWJsZTogdHJ1ZSwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gKG5hbWUpewogICAgICAgICAgdmFyIGF0dHIgPSB0YWcuYXR0cmlidXRlc1tuYW1lLnRvTG93ZXJDYXNlKCldOwogICAgICAgICAgaWYgKCF0aGlzLnh0YWcuX3NraXBBdHRyKSByZW1vdmVBdHRyaWJ1dGUuY2FsbCh0aGlzLCBuYW1lKTsKICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgIGlmIChhdHRyLnNldHRlciAmJiAhdGhpcy54dGFnLl9za2lwU2V0KSB7CiAgICAgICAgICAgICAgdGhpcy54dGFnLl9za2lwQXR0ciA9IHRydWU7CiAgICAgICAgICAgICAgYXR0ci5zZXR0ZXIuY2FsbCh0aGlzLCBhdHRyLmJvb2xlYW4gPyBmYWxzZSA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3luY0F0dHIodGhpcywgYXR0ciwgbmFtZSwgdW5kZWZpbmVkLCAncmVtb3ZlQXR0cmlidXRlJyk7CiAgICAgICAgICB9CiAgICAgICAgICBkZWxldGUgdGhpcy54dGFnLl9za2lwQXR0cjsKICAgICAgICB9CiAgICAgIH07CgogICAgICBpZiAoZWxlbWVudCl7CiAgICAgICAgZWxlbWVudC5yZWdpc3Rlcih7CiAgICAgICAgICAncHJvdG90eXBlJzogT2JqZWN0LmNyZWF0ZShPYmplY3QucHJvdG90eXBlLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBkb2MucmVnaXN0ZXIoX25hbWUsIHsKICAgICAgICAgICdleHRlbmRzJzogb3B0aW9uc1snZXh0ZW5kcyddLAogICAgICAgICAgJ3Byb3RvdHlwZSc6IE9iamVjdC5jcmVhdGUoT2JqZWN0LmNyZWF0ZSgob3B0aW9uc1snZXh0ZW5kcyddID8KICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudChvcHRpb25zWydleHRlbmRzJ10pLmNvbnN0cnVjdG9yIDoKICAgICAgICAgICAgd2luLkhUTUxFbGVtZW50KS5wcm90b3R5cGUsIHRhZy5wcm90b3R5cGUpLCB0YWcucHJvdG90eXBlKQogICAgICAgIH0pOwogICAgICB9CiAgICB9LAoKICAgIC8qIEV4cG9zZWQgVmFyaWFibGVzICovCgogICAgbWl4aW5zOiB7fSwKICAgIHByZWZpeDogcHJlZml4LAogICAgdGVtcGxhdGVzOiB7fSwKICAgIGNhcHR1cmVFdmVudHM6IFsnZm9jdXMnLCAnYmx1cicsICdzY3JvbGwnLCAndW5kZXJmbG93JywgJ292ZXJmbG93JywgJ292ZXJmbG93Y2hhbmdlZCddLAogICAgY3VzdG9tRXZlbnRzOiB7CiAgICAgIG92ZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ292ZXInKSwKICAgICAgdW5kZXJmbG93OiBjcmVhdGVGbG93RXZlbnQoJ3VuZGVyJyksCiAgICAgIGFuaW1hdGlvbnN0YXJ0OiB7CiAgICAgICAgYmFzZTogWwogICAgICAgICAgJ2FuaW1hdGlvbnN0YXJ0JywKICAgICAgICAgICdvQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ01TQW5pbWF0aW9uU3RhcnQnLAogICAgICAgICAgJ3dlYmtpdEFuaW1hdGlvblN0YXJ0JwogICAgICAgIF0KICAgICAgfSwKICAgICAgdHJhbnNpdGlvbmVuZDogewogICAgICAgIGJhc2U6IFsKICAgICAgICAgICd0cmFuc2l0aW9uZW5kJywKICAgICAgICAgICdvVHJhbnNpdGlvbkVuZCcsCiAgICAgICAgICAnTVNUcmFuc2l0aW9uRW5kJywKICAgICAgICAgICd3ZWJraXRUcmFuc2l0aW9uRW5kJwogICAgICAgIF0KICAgICAgfSwKICAgICAgdGFwOiB7CiAgICAgICAgYmFzZTogWydjbGljaycsICd0b3VjaGVuZCddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwc3RhcnQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlZG93bicsICd0b3VjaHN0YXJ0J10sCiAgICAgICAgY29uZGl0aW9uOiB0b3VjaEZpbHRlcgogICAgICB9LAogICAgICB0YXBlbmQ6IHsKICAgICAgICBiYXNlOiBbJ21vdXNldXAnLCAndG91Y2hlbmQnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcGVudGVyOiB7CiAgICAgICAgYmFzZTogWydtb3VzZW92ZXInLCAndG91Y2hlbnRlciddLAogICAgICAgIGNvbmRpdGlvbjogdG91Y2hGaWx0ZXIKICAgICAgfSwKICAgICAgdGFwbGVhdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlb3V0JywgJ3RvdWNobGVhdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0sCiAgICAgIHRhcG1vdmU6IHsKICAgICAgICBiYXNlOiBbJ21vdXNlbW92ZScsICd0b3VjaG1vdmUnXSwKICAgICAgICBjb25kaXRpb246IHRvdWNoRmlsdGVyCiAgICAgIH0KICAgIH0sCiAgICBwc2V1ZG9zOiB7CiAgICAgIGtleXBhc3M6IGtleXBzZXVkbywKICAgICAga2V5ZmFpbDoga2V5cHNldWRvLAogICAgICBkZWxlZ2F0ZTogewogICAgICAgIGFjdGlvbjogZnVuY3Rpb24gKHBzZXVkbywgZXZlbnQpIHsKICAgICAgICAgIHZhciB0YXJnZXQgPSBxdWVyeSh0aGlzLCBwc2V1ZG8udmFsdWUpLmZpbHRlcihmdW5jdGlvbiAobm9kZSkgewogICAgICAgICAgICByZXR1cm4gbm9kZSA9PSBldmVudC50YXJnZXQgfHwgbm9kZS5jb250YWlucyA/IG5vZGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSA6IGZhbHNlOwogICAgICAgICAgfSlbMF07CiAgICAgICAgICByZXR1cm4gdGFyZ2V0ID8gcHNldWRvLmxpc3RlbmVyID0gcHNldWRvLmxpc3RlbmVyLmJpbmQodGFyZ2V0KSA6IGZhbHNlOwogICAgICAgIH0KICAgICAgfSwKICAgICAgcHJldmVudGFibGU6IHsKICAgICAgICBhY3Rpb246IGZ1bmN0aW9uIChwc2V1ZG8sIGV2ZW50KSB7CiAgICAgICAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQ7CiAgICAgICAgfQogICAgICB9CiAgICB9LAoKICAgIC8qIFVUSUxJVElFUyAqLwoKICAgIGNsb25lOiBjbG9uZSwKICAgIHR5cGVPZjogdHlwZU9mLAogICAgdG9BcnJheTogdG9BcnJheSwKCiAgICB3cmFwOiBmdW5jdGlvbiAob3JpZ2luYWwsIGZuKSB7CiAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgcmV0dXJuZWQgPSBvcmlnaW5hbC5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICByZXR1cm4gcmV0dXJuZWQgPT09IGZhbHNlID8gZmFsc2UgOiBmbi5hcHBseSh0aGlzLCB0eXBlb2YgcmV0dXJuZWQgIT0gJ3VuZGVmaW5lZCcgPyB0b0FycmF5KHJldHVybmVkKSA6IGFyZ3MpOwogICAgICB9OwogICAgfSwKCiAgICBtZXJnZTogZnVuY3Rpb24oc291cmNlLCBrLCB2KXsKICAgICAgaWYgKHR5cGVPZihrKSA9PSAnc3RyaW5nJykgcmV0dXJuIG1lcmdlT25lKHNvdXJjZSwgaywgdik7CiAgICAgIGZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CiAgICAgICAgdmFyIG9iamVjdCA9IGFyZ3VtZW50c1tpXTsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gb2JqZWN0KSBtZXJnZU9uZShzb3VyY2UsIGtleSwgb2JqZWN0W2tleV0pOwogICAgICB9CiAgICAgIHJldHVybiBzb3VyY2U7CiAgICB9LAoKICAgIHVpZDogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLDEwKTsKICAgIH0sCgogICAgLyogRE9NICovCgogICAgcXVlcnk6IHF1ZXJ5LAoKICAgIHNraXBUcmFuc2l0aW9uOiBmdW5jdGlvbihlbGVtZW50LCBmbiwgYmluZCl7CiAgICAgIHZhciBwcm9wID0gcHJlZml4LmpzICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSc7CiAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICdub25lJzsKICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICB2YXIgY2FsbGJhY2s7CiAgICAgICAgaWYgKGZuKSBjYWxsYmFjayA9IGZuLmNhbGwoYmluZCk7CiAgICAgICAgeHRhZy5yZXF1ZXN0RnJhbWUoZnVuY3Rpb24oKXsKICAgICAgICAgIGVsZW1lbnQuc3R5bGVbcHJvcF0gPSBlbGVtZW50LnN0eWxlLnRyYW5zaXRpb25Qcm9wZXJ0eSA9ICcnOwogICAgICAgICAgaWYgKGNhbGxiYWNrKSB4dGFnLnJlcXVlc3RGcmFtZShjYWxsYmFjayk7CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgfSwKCiAgICByZXF1ZXN0RnJhbWU6IChmdW5jdGlvbigpewogICAgICB2YXIgcmFmID0gd2luLnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fAogICAgICAgIHdpbltwcmVmaXgubG93ZXJjYXNlICsgJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8CiAgICAgICAgZnVuY3Rpb24oZm4peyByZXR1cm4gd2luLnNldFRpbWVvdXQoZm4sIDIwKTsgfTsKICAgICAgcmV0dXJuIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gcmFmLmNhbGwod2luLCBmbik7CiAgICAgIH07CiAgICB9KSgpLAoKICAgIG1hdGNoU2VsZWN0b3I6IGZ1bmN0aW9uIChlbGVtZW50LCBzZWxlY3RvcikgewogICAgICByZXR1cm4gbWF0Y2hTZWxlY3Rvci5jYWxsKGVsZW1lbnQsIHNlbGVjdG9yKTsKICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbiAoZWxlbWVudCwgbWV0aG9kLCB2YWx1ZSkgewogICAgICBlbGVtZW50W21ldGhvZF0gPSB2YWx1ZTsKICAgICAgaWYgKHdpbmRvdy5DdXN0b21FbGVtZW50cykgQ3VzdG9tRWxlbWVudHMudXBncmFkZUFsbChlbGVtZW50KTsKICAgIH0sCgogICAgaW5uZXJIVE1MOiBmdW5jdGlvbihlbCwgaHRtbCl7CiAgICAgIHh0YWcuc2V0KGVsLCAnaW5uZXJIVE1MJywgaHRtbCk7CiAgICB9LAoKICAgIGhhc0NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwga2xhc3MpIHsKICAgICAgcmV0dXJuIGVsZW1lbnQuY2xhc3NOYW1lLnNwbGl0KCcgJykuaW5kZXhPZihrbGFzcy50cmltKCkpPi0xOwogICAgfSwKCiAgICBhZGRDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHZhciBsaXN0ID0gZWxlbWVudC5jbGFzc05hbWUudHJpbSgpLnNwbGl0KCcgJyk7CiAgICAgIGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBpZiAoIX5saXN0LmluZGV4T2YobmFtZSkpIGxpc3QucHVzaChuYW1lKTsKICAgICAgfSk7CiAgICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gbGlzdC5qb2luKCcgJykudHJpbSgpOwogICAgICByZXR1cm4gZWxlbWVudDsKICAgIH0sCgogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBrbGFzcykgewogICAgICB2YXIgY2xhc3NlcyA9IGtsYXNzLnRyaW0oKS5zcGxpdCgnICcpOwogICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lLnRyaW0oKS5zcGxpdCgnICcpLmZpbHRlcihmdW5jdGlvbiAobmFtZSkgewogICAgICAgIHJldHVybiBuYW1lICYmICF+Y2xhc3Nlcy5pbmRleE9mKG5hbWUpOwogICAgICB9KS5qb2luKCcgJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfSwKCiAgICB0b2dnbGVDbGFzczogZnVuY3Rpb24gKGVsZW1lbnQsIGtsYXNzKSB7CiAgICAgIHJldHVybiB4dGFnW3h0YWcuaGFzQ2xhc3MoZWxlbWVudCwga2xhc3MpID8gJ3JlbW92ZUNsYXNzJyA6ICdhZGRDbGFzcyddLmNhbGwobnVsbCwgZWxlbWVudCwga2xhc3MpOwogICAgfSwKCiAgICBxdWVyeUNoaWxkcmVuOiBmdW5jdGlvbiAoZWxlbWVudCwgc2VsZWN0b3IpIHsKICAgICAgdmFyIGlkID0gZWxlbWVudC5pZCwKICAgICAgICBndWlkID0gZWxlbWVudC5pZCA9IGlkIHx8ICd4XycgKyB4dGFnLnVpZCgpLAogICAgICAgIGF0dHIgPSAnIycgKyBndWlkICsgJyA+ICc7CiAgICAgIHNlbGVjdG9yID0gYXR0ciArIChzZWxlY3RvciArICcnKS5yZXBsYWNlKCcsJywgJywnICsgYXR0ciwgJ2cnKTsKICAgICAgdmFyIHJlc3VsdCA9IGVsZW1lbnQucGFyZW50Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKTsKICAgICAgaWYgKCFpZCkgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CiAgICAgIHJldHVybiB0b0FycmF5KHJlc3VsdCk7CiAgICB9LAoKICAgIGNyZWF0ZUZyYWdtZW50OiBmdW5jdGlvbihjb250ZW50KSB7CiAgICAgIHZhciBmcmFnID0gZG9jLmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKTsKICAgICAgaWYgKGNvbnRlbnQpIHsKICAgICAgICB2YXIgZGl2ID0gZnJhZy5hcHBlbmRDaGlsZChkb2MuY3JlYXRlRWxlbWVudCgnZGl2JykpLAogICAgICAgICAgbm9kZXMgPSB0b0FycmF5KGNvbnRlbnQubm9kZU5hbWUgPyBhcmd1bWVudHMgOiAhKGRpdi5pbm5lckhUTUwgPSBjb250ZW50KSB8fCBkaXYuY2hpbGRyZW4pLAogICAgICAgICAgbGVuZ3RoID0gbm9kZXMubGVuZ3RoLAogICAgICAgICAgaW5kZXggPSAwOwogICAgICAgIHdoaWxlIChpbmRleCA8IGxlbmd0aCkgZnJhZy5pbnNlcnRCZWZvcmUobm9kZXNbaW5kZXgrK10sIGRpdik7CiAgICAgICAgZnJhZy5yZW1vdmVDaGlsZChkaXYpOwogICAgICB9CiAgICAgIHJldHVybiBmcmFnOwogICAgfSwKCiAgICBtYW5pcHVsYXRlOiBmdW5jdGlvbihlbGVtZW50LCBmbil7CiAgICAgIHZhciBuZXh0ID0gZWxlbWVudC5uZXh0U2libGluZywKICAgICAgICBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGUsCiAgICAgICAgZnJhZyA9IGRvYy5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCksCiAgICAgICAgcmV0dXJuZWQgPSBmbi5jYWxsKGZyYWcuYXBwZW5kQ2hpbGQoZWxlbWVudCksIGZyYWcpIHx8IGVsZW1lbnQ7CiAgICAgIGlmIChuZXh0KSBwYXJlbnQuaW5zZXJ0QmVmb3JlKHJldHVybmVkLCBuZXh0KTsKICAgICAgZWxzZSBwYXJlbnQuYXBwZW5kQ2hpbGQocmV0dXJuZWQpOwogICAgfSwKCiAgICAvKiBQU0VVRE9TICovCgogICAgYXBwbHlQc2V1ZG9zOiBmdW5jdGlvbihrZXksIGZuLCBlbGVtZW50KSB7CiAgICAgIHZhciBsaXN0ZW5lciA9IGZuLAogICAgICAgICAgcHNldWRvcyA9IHt9OwogICAgICBpZiAoa2V5Lm1hdGNoKCc6JykpIHsKICAgICAgICB2YXIgc3BsaXQgPSBrZXkubWF0Y2gocmVnZXhQc2V1ZG9TcGxpdCksCiAgICAgICAgICAgIGkgPSBzcGxpdC5sZW5ndGg7CiAgICAgICAgd2hpbGUgKC0taSkgewogICAgICAgICAgc3BsaXRbaV0ucmVwbGFjZShyZWdleFBzZXVkb1JlcGxhY2UsIGZ1bmN0aW9uIChtYXRjaCwgbmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgaWYgKCF4dGFnLnBzZXVkb3NbbmFtZV0pIHRocm93ICJwc2V1ZG8gbm90IGZvdW5kOiAiICsgbmFtZSArICIgIiArIHNwbGl0OwogICAgICAgICAgICB2YXIgcHNldWRvID0gcHNldWRvc1tpXSA9IE9iamVjdC5jcmVhdGUoeHRhZy5wc2V1ZG9zW25hbWVdKTsKICAgICAgICAgICAgICAgIHBzZXVkby5rZXkgPSBrZXk7CiAgICAgICAgICAgICAgICBwc2V1ZG8ubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBwc2V1ZG8udmFsdWUgPSB2YWx1ZTsKICAgICAgICAgICAgdmFyIGxhc3QgPSBsaXN0ZW5lcjsKICAgICAgICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgICAgIHZhciBhcmdzID0gdG9BcnJheShhcmd1bWVudHMpLAogICAgICAgICAgICAgICAgICBvYmogPSB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgbmFtZTogbmFtZSwKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmFsdWUsCiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXI6IGxhc3QKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICBpZiAocHNldWRvLmFjdGlvbiAmJiBwc2V1ZG8uYWN0aW9uLmFwcGx5KHRoaXMsIFtvYmpdLmNvbmNhdChhcmdzKSkgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgcmV0dXJuIG9iai5saXN0ZW5lci5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgaWYgKGVsZW1lbnQgJiYgcHNldWRvLm9uQWRkKSB7CiAgICAgICAgICAgICAgaWYgKGVsZW1lbnQuZ2V0QXR0cmlidXRlKSB7CiAgICAgICAgICAgICAgICBwc2V1ZG8ub25BZGQuY2FsbChlbGVtZW50LCBwc2V1ZG8pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LnB1c2gocHNldWRvKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfQogICAgICBmb3IgKHZhciB6IGluIHBzZXVkb3MpIHsKICAgICAgICBpZiAocHNldWRvc1t6XS5vbkNvbXBpbGVkKSBsaXN0ZW5lciA9IHBzZXVkb3Nbel0ub25Db21waWxlZChsaXN0ZW5lciwgcHNldWRvc1t6XSk7CiAgICAgIH0KICAgICAgcmV0dXJuIGxpc3RlbmVyOwogICAgfSwKCiAgICByZW1vdmVQc2V1ZG9zOiBmdW5jdGlvbihlbGVtZW50LCBldmVudCl7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25SZW1vdmUuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgIH0sCgogIC8qKiogRXZlbnRzICoqKi8KCiAgICBwYXJzZUV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbikgewogICAgICB2YXIgcHNldWRvcyA9IHR5cGUuc3BsaXQoJzonKSwKICAgICAgICBrZXkgPSBwc2V1ZG9zLnNoaWZ0KCksCiAgICAgICAgZXZlbnQgPSB4dGFnLm1lcmdlKHsKICAgICAgICAgIGJhc2U6IGtleSwKICAgICAgICAgIHBzZXVkb3M6ICcnLAogICAgICAgICAgX3BzZXVkb3M6IFtdLAogICAgICAgICAgb25BZGQ6IG5vb3AsCiAgICAgICAgICBvblJlbW92ZTogbm9vcCwKICAgICAgICAgIGNvbmRpdGlvbjogbm9vcAogICAgICAgIH0sIHh0YWcuY3VzdG9tRXZlbnRzW2tleV0gfHwge30pOwogICAgICBldmVudC50eXBlID0ga2V5ICsgKGV2ZW50LnBzZXVkb3MubGVuZ3RoID8gJzonICsgZXZlbnQucHNldWRvcyA6ICcnKSArIChwc2V1ZG9zLmxlbmd0aCA/ICc6JyArIHBzZXVkb3Muam9pbignOicpIDogJycpOwogICAgICBpZiAoZm4pIHsKICAgICAgICB2YXIgY2hhaW5lZCA9IHh0YWcuYXBwbHlQc2V1ZG9zKGV2ZW50LnR5cGUsIGZuLCBldmVudC5fcHNldWRvcyk7CiAgICAgICAgZXZlbnQubGlzdGVuZXIgPSBmdW5jdGlvbigpewogICAgICAgICAgdmFyIGFyZ3MgPSB0b0FycmF5KGFyZ3VtZW50cyk7CiAgICAgICAgICBpZiAoZXZlbnQuY29uZGl0aW9uLmFwcGx5KHRoaXMsIFtldmVudF0uY29uY2F0KGFyZ3MpKSA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKICAgICAgICAgIHJldHVybiBjaGFpbmVkLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICAgIH07CiAgICAgIH0KICAgICAgcmV0dXJuIGV2ZW50OwogICAgfSwKCiAgICBhZGRFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9ICh0eXBlb2YgZm4gPT0gJ2Z1bmN0aW9uJykgPyB4dGFnLnBhcnNlRXZlbnQodHlwZSwgZm4pIDogZm47CiAgICAgIGV2ZW50Lmxpc3RlbmVyLmV2ZW50ID0gZXZlbnQ7CiAgICAgIGV2ZW50Ll9wc2V1ZG9zLmZvckVhY2goZnVuY3Rpb24ob2JqKXsKICAgICAgICBvYmoub25BZGQuY2FsbChlbGVtZW50LCBvYmopOwogICAgICB9KTsKICAgICAgZXZlbnQub25BZGQuY2FsbChlbGVtZW50LCBldmVudCwgZXZlbnQubGlzdGVuZXIpOwogICAgICB0b0FycmF5KGV2ZW50LmJhc2UpLmZvckVhY2goZnVuY3Rpb24gKG5hbWUpIHsKICAgICAgICBlbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIobmFtZSwgZXZlbnQubGlzdGVuZXIsIHh0YWcuY2FwdHVyZUV2ZW50cy5pbmRleE9mKG5hbWUpID4gLTEpOwogICAgICB9KTsKICAgICAgcmV0dXJuIGV2ZW50Lmxpc3RlbmVyOwogICAgfSwKCiAgICBhZGRFdmVudHM6IGZ1bmN0aW9uIChlbGVtZW50LCBldmVudHMpIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHt9OwogICAgICBmb3IgKHZhciB6IGluIGV2ZW50cykgewogICAgICAgIGxpc3RlbmVyc1t6XSA9IHh0YWcuYWRkRXZlbnQoZWxlbWVudCwgeiwgZXZlbnRzW3pdKTsKICAgICAgfQogICAgICByZXR1cm4gbGlzdGVuZXJzOwogICAgfSwKCiAgICByZW1vdmVFdmVudDogZnVuY3Rpb24gKGVsZW1lbnQsIHR5cGUsIGZuKSB7CiAgICAgIHZhciBldmVudCA9IGZuLmV2ZW50OwogICAgICBldmVudC5vblJlbW92ZS5jYWxsKGVsZW1lbnQsIGV2ZW50LCBmbik7CiAgICAgIHh0YWcucmVtb3ZlUHNldWRvcyhlbGVtZW50LCBldmVudCk7CiAgICAgIHRvQXJyYXkoZXZlbnQuYmFzZSkuZm9yRWFjaChmdW5jdGlvbiAobmFtZSkgewogICAgICAgIGVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBmbik7CiAgICAgIH0pOwogICAgfSwKCiAgICByZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGVsZW1lbnQsIGxpc3RlbmVycyl7CiAgICAgIGZvciAodmFyIHogaW4gbGlzdGVuZXJzKSB4dGFnLnJlbW92ZUV2ZW50KGVsZW1lbnQsIHosIGxpc3RlbmVyc1t6XSk7CiAgICB9LAoKICAgIGZpcmVFdmVudDogZnVuY3Rpb24oZWxlbWVudCwgdHlwZSwgb3B0aW9ucywgd2Fybil7CiAgICAgIHZhciBvcHRpb25zID0gb3B0aW9ucyB8fCB7fSwKICAgICAgICAgIGV2ZW50ID0gZG9jLmNyZWF0ZUV2ZW50KCdDdXN0b21FdmVudCcpOwogICAgICBpZiAod2FybikgY29uc29sZS53YXJuKCdmaXJlRXZlbnQgaGFzIGJlZW4gbW9kaWZpZWQsIG1vcmUgaW5mbyBoZXJlOiAnKTsKICAgICAgZXZlbnQuaW5pdEN1c3RvbUV2ZW50KHR5cGUsCiAgICAgICAgb3B0aW9ucy5idWJibGVzID09IGZhbHNlID8gZmFsc2UgOiB0cnVlLAogICAgICAgIG9wdGlvbnMuY2FuY2VsYWJsZSA9PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZSwKICAgICAgICBvcHRpb25zLmRldGFpbAogICAgICApOwogICAgICB0cnkgeyBlbGVtZW50LmRpc3BhdGNoRXZlbnQoZXZlbnQpOyB9CiAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgY29uc29sZS53YXJuKCdUaGlzIGVycm9yIG1heSBoYXZlIGJlZW4gY2F1c2VkIGJ5IGEgY2hhbmdlIGluIHRoZSBmaXJlRXZlbnQgbWV0aG9kLCBtb3JlIGluZm8gaGVyZTogJywgZSk7CiAgICAgIH0KICAgIH0sCgogICAgYWRkT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgaWYgKCFlbGVtZW50Ll9yZWNvcmRzKSB7CiAgICAgICAgZWxlbWVudC5fcmVjb3JkcyA9IHsgaW5zZXJ0ZWQ6IFtdLCByZW1vdmVkOiBbXSB9OwogICAgICAgIGlmIChtdXRhdGlvbil7CiAgICAgICAgICBlbGVtZW50Ll9vYnNlcnZlciA9IG5ldyBtdXRhdGlvbihmdW5jdGlvbihtdXRhdGlvbnMpIHsKICAgICAgICAgICAgcGFyc2VNdXRhdGlvbnMoZWxlbWVudCwgbXV0YXRpb25zKTsKICAgICAgICAgIH0pOwogICAgICAgICAgZWxlbWVudC5fb2JzZXJ2ZXIub2JzZXJ2ZShlbGVtZW50LCB7CiAgICAgICAgICAgIHN1YnRyZWU6IHRydWUsCiAgICAgICAgICAgIGNoaWxkTGlzdDogdHJ1ZSwKICAgICAgICAgICAgYXR0cmlidXRlczogIXRydWUsCiAgICAgICAgICAgIGNoYXJhY3RlckRhdGE6IGZhbHNlCiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgZWxzZSBbJ0luc2VydGVkJywgJ1JlbW92ZWQnXS5mb3JFYWNoKGZ1bmN0aW9uKHR5cGUpewogICAgICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Ob2RlJyArIHR5cGUsIGZ1bmN0aW9uKGV2ZW50KXsKICAgICAgICAgICAgZXZlbnQuX211dGF0aW9uID0gdHJ1ZTsKICAgICAgICAgICAgZWxlbWVudC5fcmVjb3Jkc1t0eXBlLnRvTG93ZXJDYXNlKCldLmZvckVhY2goZnVuY3Rpb24oZm4pewogICAgICAgICAgICAgIGZuKGV2ZW50LnRhcmdldCwgZXZlbnQpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0sIGZhbHNlKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBpZiAoZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5pbmRleE9mKGZuKSA9PSAtMSkgZWxlbWVudC5fcmVjb3Jkc1t0eXBlXS5wdXNoKGZuKTsKICAgIH0sCgogICAgcmVtb3ZlT2JzZXJ2ZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHR5cGUsIGZuKXsKICAgICAgdmFyIG9iaiA9IGVsZW1lbnQuX3JlY29yZHM7CiAgICAgIGlmIChvYmogJiYgZm4pewogICAgICAgIG9ialt0eXBlXS5zcGxpY2Uob2JqW3R5cGVdLmluZGV4T2YoZm4pLCAxKTsKICAgICAgfQogICAgICBlbHNlewogICAgICAgIG9ialt0eXBlXSA9IFtdOwogICAgICB9CiAgICB9CgogIH07CgogIGlmICh0eXBlb2YgZGVmaW5lID09ICdmdW5jdGlvbicgJiYgZGVmaW5lLmFtZCkgZGVmaW5lKHh0YWcpOwogIGVsc2Ugd2luLnh0YWcgPSB4dGFnOwoKICBkb2MuYWRkRXZlbnRMaXN0ZW5lcignV2ViQ29tcG9uZW50c1JlYWR5JywgZnVuY3Rpb24oKXsKICAgIHh0YWcuZmlyZUV2ZW50KGRvYy5ib2R5LCAnRE9NQ29tcG9uZW50c0xvYWRlZCcpOwogIH0pOwoKfSkoKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 03:47:05 GMT",
                    "Content-Length": "84350",
                    "Date": "Sun, 09 Nov 2014 03:47:05 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}