{
    "url": "http://localhost:9999/alexanderbeletsky/backbone.computedfields/public/backbone-0.9.9/backbone.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/alexanderbeletsky/backbone.computedfields/public/backbone-0.9.9/backbone.js",
                "path": "/alexanderbeletsky/backbone.computedfields/public/backbone-0.9.9/backbone.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9hbGV4YW5kZXJiZWxldHNreS9iYWNrYm9uZS5jb21wdXRlZGZpZWxkcy9wdWJsaWMvYmFja2JvbmUtMC45LjkvYmFja2JvbmUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNTg1ODYNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTE6MTU6MDggR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDExOjE1OjA1IEdNVA0KDQovLyAgICAgQmFja2JvbmUuanMgMC45LjkNCg0KLy8gICAgIChjKSAyMDEwLTIwMTIgSmVyZW15IEFzaGtlbmFzLCBEb2N1bWVudENsb3VkIEluYy4NCi8vICAgICBCYWNrYm9uZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4NCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246DQovLyAgICAgaHR0cDovL2JhY2tib25lanMub3JnDQoNCihmdW5jdGlvbigpew0KDQogIC8vIEluaXRpYWwgU2V0dXANCiAgLy8gLS0tLS0tLS0tLS0tLQ0KDQogIC8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGdsb2JhbCBvYmplY3QgKGB3aW5kb3dgIGluIHRoZSBicm93c2VyLCBgZXhwb3J0c2ANCiAgLy8gb24gdGhlIHNlcnZlcikuDQogIHZhciByb290ID0gdGhpczsNCg0KICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUNCiAgLy8gcmVzdG9yZWQgbGF0ZXIgb24sIGlmIGBub0NvbmZsaWN0YCBpcyB1c2VkLg0KICB2YXIgcHJldmlvdXNCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmU7DQoNCiAgLy8gQ3JlYXRlIGEgbG9jYWwgcmVmZXJlbmNlIHRvIGFycmF5IG1ldGhvZHMuDQogIHZhciBhcnJheSA9IFtdOw0KICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7DQogIHZhciBzbGljZSA9IGFycmF5LnNsaWNlOw0KICB2YXIgc3BsaWNlID0gYXJyYXkuc3BsaWNlOw0KDQogIC8vIFRoZSB0b3AtbGV2ZWwgbmFtZXNwYWNlLiBBbGwgcHVibGljIEJhY2tib25lIGNsYXNzZXMgYW5kIG1vZHVsZXMgd2lsbA0KICAvLyBiZSBhdHRhY2hlZCB0byB0aGlzLiBFeHBvcnRlZCBmb3IgYm90aCBDb21tb25KUyBhbmQgdGhlIGJyb3dzZXIuDQogIHZhciBCYWNrYm9uZTsNCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgew0KICAgIEJhY2tib25lID0gZXhwb3J0czsNCiAgfSBlbHNlIHsNCiAgICBCYWNrYm9uZSA9IHJvb3QuQmFja2JvbmUgPSB7fTsNCiAgfQ0KDQogIC8vIEN1cnJlbnQgdmVyc2lvbiBvZiB0aGUgbGlicmFyeS4gS2VlcCBpbiBzeW5jIHdpdGggYHBhY2thZ2UuanNvbmAuDQogIEJhY2tib25lLlZFUlNJT04gPSAnMC45LjknOw0KDQogIC8vIFJlcXVpcmUgVW5kZXJzY29yZSwgaWYgd2UncmUgb24gdGhlIHNlcnZlciwgYW5kIGl0J3Mgbm90IGFscmVhZHkgcHJlc2VudC4NCiAgdmFyIF8gPSByb290Ll87DQogIGlmICghXyAmJiAodHlwZW9mIHJlcXVpcmUgIT09ICd1bmRlZmluZWQnKSkgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsNCg0KICAvLyBGb3IgQmFja2JvbmUncyBwdXJwb3NlcywgalF1ZXJ5LCBaZXB0bywgb3IgRW5kZXIgb3ducyB0aGUgYCRgIHZhcmlhYmxlLg0KICBCYWNrYm9uZS4kID0gcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyOw0KDQogIC8vIFJ1bnMgQmFja2JvbmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYEJhY2tib25lYCB2YXJpYWJsZQ0KICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuDQogIEJhY2tib25lLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsNCiAgICByb290LkJhY2tib25lID0gcHJldmlvdXNCYWNrYm9uZTsNCiAgICByZXR1cm4gdGhpczsNCiAgfTsNCg0KICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uDQogIC8vIHdpbGwgZmFrZSBgIlBVVCJgIGFuZCBgIkRFTEVURSJgIHJlcXVlc3RzIHZpYSB0aGUgYF9tZXRob2RgIHBhcmFtZXRlciBhbmQNCiAgLy8gc2V0IGEgYFgtSHR0cC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4NCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsNCg0KICAvLyBUdXJuIG9uIGBlbXVsYXRlSlNPTmAgdG8gc3VwcG9ydCBsZWdhY3kgc2VydmVycyB0aGF0IGNhbid0IGRlYWwgd2l0aCBkaXJlY3QNCiAgLy8gYGFwcGxpY2F0aW9uL2pzb25gIHJlcXVlc3RzIC4uLiB3aWxsIGVuY29kZSB0aGUgYm9keSBhcw0KICAvLyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYCBpbnN0ZWFkIGFuZCB3aWxsIHNlbmQgdGhlIG1vZGVsIGluIGENCiAgLy8gZm9ybSBwYXJhbSBuYW1lZCBgbW9kZWxgLg0KICBCYWNrYm9uZS5lbXVsYXRlSlNPTiA9IGZhbHNlOw0KDQogIC8vIEJhY2tib25lLkV2ZW50cw0KICAvLyAtLS0tLS0tLS0tLS0tLS0NCg0KICAvLyBSZWd1bGFyIGV4cHJlc3Npb24gdXNlZCB0byBzcGxpdCBldmVudCBzdHJpbmdzLg0KICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOw0KDQogIC8vIEltcGxlbWVudCBmYW5jeSBmZWF0dXJlcyBvZiB0aGUgRXZlbnRzIEFQSSBzdWNoIGFzIG11bHRpcGxlIGV2ZW50DQogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gDQogIC8vIGluIHRlcm1zIG9mIHRoZSBleGlzdGluZyBBUEkuDQogIHZhciBldmVudHNBcGkgPSBmdW5jdGlvbihvYmosIGFjdGlvbiwgbmFtZSwgcmVzdCkgew0KICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7DQogICAgaWYgKHR5cGVvZiBuYW1lID09PSAnb2JqZWN0Jykgew0KICAgICAgZm9yICh2YXIga2V5IGluIG5hbWUpIHsNCiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7DQogICAgICB9DQogICAgfSBlbHNlIGlmIChldmVudFNwbGl0dGVyLnRlc3QobmFtZSkpIHsNCiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7DQogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICBvYmpbYWN0aW9uXS5hcHBseShvYmosIFtuYW1lc1tpXV0uY29uY2F0KHJlc3QpKTsNCiAgICAgIH0NCiAgICB9IGVsc2Ugew0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KICB9Ow0KDQogIC8vIE9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IgdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvDQogIC8vIGtlZXAgdGhlIHVzdWFsIGNhc2VzIHNwZWVkeSAobW9zdCBCYWNrYm9uZSBldmVudHMgaGF2ZSAzIGFyZ3VtZW50cykuDQogIHZhciB0cmlnZ2VyRXZlbnRzID0gZnVuY3Rpb24ob2JqLCBldmVudHMsIGFyZ3MpIHsNCiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGg7DQogICAgc3dpdGNoIChhcmdzLmxlbmd0aCkgew0KICAgIGNhc2UgMDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgpOw0KICAgIHJldHVybjsNCiAgICBjYXNlIDE6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdKTsNCiAgICByZXR1cm47DQogICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSk7DQogICAgcmV0dXJuOw0KICAgIGNhc2UgMzogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0sIGFyZ3NbMl0pOw0KICAgIHJldHVybjsNCiAgICBkZWZhdWx0OiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5hcHBseShldi5jdHgsIGFyZ3MpOw0KICAgIH0NCiAgfTsNCg0KICAvLyBBIG1vZHVsZSB0aGF0IGNhbiBiZSBtaXhlZCBpbiB0byAqYW55IG9iamVjdCogaW4gb3JkZXIgdG8gcHJvdmlkZSBpdCB3aXRoDQogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sNCiAgLy8gZnVuY3Rpb25zIHRvIGFuIGV2ZW50OyBgdHJpZ2dlcmAtaW5nIGFuIGV2ZW50IGZpcmVzIGFsbCBjYWxsYmFja3MgaW4NCiAgLy8gc3VjY2Vzc2lvbi4NCiAgLy8NCiAgLy8gICAgIHZhciBvYmplY3QgPSB7fTsNCiAgLy8gICAgIF8uZXh0ZW5kKG9iamVjdCwgQmFja2JvbmUuRXZlbnRzKTsNCiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOw0KICAvLyAgICAgb2JqZWN0LnRyaWdnZXIoJ2V4cGFuZCcpOw0KICAvLw0KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gew0KDQogICAgLy8gQmluZCBvbmUgb3IgbW9yZSBzcGFjZSBzZXBhcmF0ZWQgZXZlbnRzLCBvciBhbiBldmVudHMgbWFwLA0KICAgIC8vIHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8NCiAgICAvLyBhbGwgZXZlbnRzIGZpcmVkLg0KICAgIG9uOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgew0KICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7DQogICAgICB0aGlzLl9ldmVudHMgfHwgKHRoaXMuX2V2ZW50cyA9IHt9KTsNCiAgICAgIHZhciBsaXN0ID0gdGhpcy5fZXZlbnRzW25hbWVdIHx8ICh0aGlzLl9ldmVudHNbbmFtZV0gPSBbXSk7DQogICAgICBsaXN0LnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBCaW5kIGV2ZW50cyB0byBvbmx5IGJlIHRyaWdnZXJlZCBhIHNpbmdsZSB0aW1lLiBBZnRlciB0aGUgZmlyc3QgdGltZQ0KICAgIC8vIHRoZSBjYWxsYmFjayBpcyBpbnZva2VkLCBpdCB3aWxsIGJlIHJlbW92ZWQuDQogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsNCiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb25jZScsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7DQogICAgICB2YXIgc2VsZiA9IHRoaXM7DQogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsNCiAgICAgICAgc2VsZi5vZmYobmFtZSwgb25jZSk7DQogICAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgICB9KTsNCiAgICAgIG9uY2UuX2NhbGxiYWNrID0gY2FsbGJhY2s7DQogICAgICB0aGlzLm9uKG5hbWUsIG9uY2UsIGNvbnRleHQpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbA0KICAgIC8vIGNhbGxiYWNrcyB3aXRoIHRoYXQgZnVuY3Rpb24uIElmIGBjYWxsYmFja2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwNCiAgICAvLyBjYWxsYmFja3MgZm9yIHRoZSBldmVudC4gSWYgYGV2ZW50c2AgaXMgbnVsbCwgcmVtb3ZlcyBhbGwgYm91bmQNCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuDQogICAgb2ZmOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgY29udGV4dCkgew0KICAgICAgdmFyIGxpc3QsIGV2LCBldmVudHMsIG5hbWVzLCBpLCBsLCBqLCBrOw0KICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOw0KICAgICAgaWYgKCFuYW1lICYmICFjYWxsYmFjayAmJiAhY29udGV4dCkgew0KICAgICAgICB0aGlzLl9ldmVudHMgPSB7fTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOw0KICAgICAgZm9yIChpID0gMCwgbCA9IG5hbWVzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICBuYW1lID0gbmFtZXNbaV07DQogICAgICAgIGlmIChsaXN0ID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7DQogICAgICAgICAgZXZlbnRzID0gW107DQogICAgICAgICAgaWYgKGNhbGxiYWNrIHx8IGNvbnRleHQpIHsNCiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBsaXN0Lmxlbmd0aDsgaiA8IGs7IGorKykgew0KICAgICAgICAgICAgICBldiA9IGxpc3Rbal07DQogICAgICAgICAgICAgIGlmICgoY2FsbGJhY2sgJiYgY2FsbGJhY2sgIT09IChldi5jYWxsYmFjay5fY2FsbGJhY2sgfHwgZXYuY2FsbGJhY2spKSB8fA0KICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsNCiAgICAgICAgICAgICAgICBldmVudHMucHVzaChldik7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgICAgdGhpcy5fZXZlbnRzW25hbWVdID0gZXZlbnRzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUNCiAgICAvLyBwYXNzZWQgdGhlIHNhbWUgYXJndW1lbnRzIGFzIGB0cmlnZ2VyYCBpcywgYXBhcnQgZnJvbSB0aGUgZXZlbnQgbmFtZQ0KICAgIC8vICh1bmxlc3MgeW91J3JlIGxpc3RlbmluZyBvbiBgImFsbCJgLCB3aGljaCB3aWxsIGNhdXNlIHlvdXIgY2FsbGJhY2sgdG8NCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuDQogICAgdHJpZ2dlcjogZnVuY3Rpb24obmFtZSkgew0KICAgICAgaWYgKCF0aGlzLl9ldmVudHMpIHJldHVybiB0aGlzOw0KICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7DQogICAgICBpZiAoIWV2ZW50c0FwaSh0aGlzLCAndHJpZ2dlcicsIG5hbWUsIGFyZ3MpKSByZXR1cm4gdGhpczsNCiAgICAgIHZhciBldmVudHMgPSB0aGlzLl9ldmVudHNbbmFtZV07DQogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsNCiAgICAgIGlmIChldmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgZXZlbnRzLCBhcmdzKTsNCiAgICAgIGlmIChhbGxFdmVudHMpIHRyaWdnZXJFdmVudHModGhpcywgYWxsRXZlbnRzLCBhcmd1bWVudHMpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIEFuIGludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb24gb2YgYG9uYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvIGxpc3RlbiB0bw0KICAgIC8vIGFuIGV2ZW50IGluIGFub3RoZXIgb2JqZWN0IC4uLiBrZWVwaW5nIHRyYWNrIG9mIHdoYXQgaXQncyBsaXN0ZW5pbmcgdG8uDQogICAgbGlzdGVuVG86IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnRzLCBjYWxsYmFjaykgew0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOw0KICAgICAgdmFyIGlkID0gb2JqZWN0Ll9saXN0ZW5lcklkIHx8IChvYmplY3QuX2xpc3RlbmVySWQgPSBfLnVuaXF1ZUlkKCdsJykpOw0KICAgICAgbGlzdGVuZXJzW2lkXSA9IG9iamVjdDsNCiAgICAgIG9iamVjdC5vbihldmVudHMsIGNhbGxiYWNrIHx8IHRoaXMsIHRoaXMpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFRlbGwgdGhpcyBvYmplY3QgdG8gc3RvcCBsaXN0ZW5pbmcgdG8gZWl0aGVyIHNwZWNpZmljIGV2ZW50cyAuLi4gb3INCiAgICAvLyB0byBldmVyeSBvYmplY3QgaXQncyBjdXJyZW50bHkgbGlzdGVuaW5nIHRvLg0KICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnRzLCBjYWxsYmFjaykgew0KICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyczsNCiAgICAgIGlmICghbGlzdGVuZXJzKSByZXR1cm47DQogICAgICBpZiAob2JqZWN0KSB7DQogICAgICAgIG9iamVjdC5vZmYoZXZlbnRzLCBjYWxsYmFjaywgdGhpcyk7DQogICAgICAgIGlmICghZXZlbnRzICYmICFjYWxsYmFjaykgZGVsZXRlIGxpc3RlbmVyc1tvYmplY3QuX2xpc3RlbmVySWRdOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgZm9yICh2YXIgaWQgaW4gbGlzdGVuZXJzKSB7DQogICAgICAgICAgbGlzdGVuZXJzW2lkXS5vZmYobnVsbCwgbnVsbCwgdGhpcyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5fbGlzdGVuZXJzID0ge307DQogICAgICB9DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9DQogIH07DQoNCiAgLy8gQWxpYXNlcyBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkuDQogIEV2ZW50cy5iaW5kICAgPSBFdmVudHMub247DQogIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOw0KDQogIC8vIEFsbG93IHRoZSBgQmFja2JvbmVgIG9iamVjdCB0byBzZXJ2ZSBhcyBhIGdsb2JhbCBldmVudCBidXMsIGZvciBmb2xrcyB3aG8NCiAgLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLg0KICBfLmV4dGVuZChCYWNrYm9uZSwgRXZlbnRzKTsNCg0KICAvLyBCYWNrYm9uZS5Nb2RlbA0KICAvLyAtLS0tLS0tLS0tLS0tLQ0KDQogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCwgd2l0aCBkZWZpbmVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkNCiAgLy8gaXMgYXV0b21hdGljYWxseSBnZW5lcmF0ZWQgYW5kIGFzc2lnbmVkIGZvciB5b3UuDQogIHZhciBNb2RlbCA9IEJhY2tib25lLk1vZGVsID0gZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgew0KICAgIHZhciBkZWZhdWx0czsNCiAgICB2YXIgYXR0cnMgPSBhdHRyaWJ1dGVzIHx8IHt9Ow0KICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgnYycpOw0KICAgIHRoaXMuY2hhbmdlZCA9IHt9Ow0KICAgIHRoaXMuYXR0cmlidXRlcyA9IHt9Ow0KICAgIHRoaXMuX2NoYW5nZXMgPSBbXTsNCiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsNCiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBhcnNlKSBhdHRycyA9IHRoaXMucGFyc2UoYXR0cnMpOw0KICAgIGlmIChkZWZhdWx0cyA9IF8ucmVzdWx0KHRoaXMsICdkZWZhdWx0cycpKSBfLmRlZmF1bHRzKGF0dHJzLCBkZWZhdWx0cyk7DQogICAgdGhpcy5zZXQoYXR0cnMsIHtzaWxlbnQ6IHRydWV9KTsNCiAgICB0aGlzLl9jdXJyZW50QXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsNCiAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7DQogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogIH07DQoNCiAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuDQogIF8uZXh0ZW5kKE1vZGVsLnByb3RvdHlwZSwgRXZlbnRzLCB7DQoNCiAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB3aG9zZSBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIuDQogICAgY2hhbmdlZDogbnVsbCwNCg0KICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQNCiAgICAvLyBDb3VjaERCIHVzZXJzIG1heSB3YW50IHRvIHNldCB0aGlzIHRvIGAiX2lkImAuDQogICAgaWRBdHRyaWJ1dGU6ICdpZCcsDQoNCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24NCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4NCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sDQoNCiAgICAvLyBSZXR1cm4gYSBjb3B5IG9mIHRoZSBtb2RlbCdzIGBhdHRyaWJ1dGVzYCBvYmplY3QuDQogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOw0KICAgIH0sDQoNCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4NCiAgICBzeW5jOiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgfSwNCg0KICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLg0KICAgIGdldDogZnVuY3Rpb24oYXR0cikgew0KICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1thdHRyXTsNCiAgICB9LA0KDQogICAgLy8gR2V0IHRoZSBIVE1MLWVzY2FwZWQgdmFsdWUgb2YgYW4gYXR0cmlidXRlLg0KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgew0KICAgICAgcmV0dXJuIF8uZXNjYXBlKHRoaXMuZ2V0KGF0dHIpKTsNCiAgICB9LA0KDQogICAgLy8gUmV0dXJucyBgdHJ1ZWAgaWYgdGhlIGF0dHJpYnV0ZSBjb250YWlucyBhIHZhbHVlIHRoYXQgaXMgbm90IG51bGwNCiAgICAvLyBvciB1bmRlZmluZWQuDQogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7DQogICAgICByZXR1cm4gdGhpcy5nZXQoYXR0cikgIT0gbnVsbDsNCiAgICB9LA0KDQogICAgLy8gU2V0IGEgaGFzaCBvZiBtb2RlbCBhdHRyaWJ1dGVzIG9uIHRoZSBvYmplY3QsIGZpcmluZyBgImNoYW5nZSJgIHVubGVzcw0KICAgIC8vIHlvdSBjaG9vc2UgdG8gc2lsZW5jZSBpdC4NCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7DQogICAgICB2YXIgYXR0ciwgYXR0cnM7DQogICAgICBpZiAoa2V5ID09IG51bGwpIHJldHVybiB0aGlzOw0KDQogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4NCiAgICAgIGlmIChfLmlzT2JqZWN0KGtleSkpIHsNCiAgICAgICAgYXR0cnMgPSBrZXk7DQogICAgICAgIG9wdGlvbnMgPSB2YWw7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsNCiAgICAgIH0NCg0KICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLg0KICAgICAgdmFyIHNpbGVudCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQ7DQogICAgICB2YXIgdW5zZXQgPSBvcHRpb25zICYmIG9wdGlvbnMudW5zZXQ7DQoNCiAgICAgIC8vIFJ1biB2YWxpZGF0aW9uLg0KICAgICAgaWYgKCF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsNCg0KICAgICAgLy8gQ2hlY2sgZm9yIGNoYW5nZXMgb2YgYGlkYC4NCiAgICAgIGlmICh0aGlzLmlkQXR0cmlidXRlIGluIGF0dHJzKSB0aGlzLmlkID0gYXR0cnNbdGhpcy5pZEF0dHJpYnV0ZV07DQoNCiAgICAgIHZhciBub3cgPSB0aGlzLmF0dHJpYnV0ZXM7DQoNCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZS4uLg0KICAgICAgZm9yIChhdHRyIGluIGF0dHJzKSB7DQogICAgICAgIHZhbCA9IGF0dHJzW2F0dHJdOw0KDQogICAgICAgIC8vIFVwZGF0ZSBvciBkZWxldGUgdGhlIGN1cnJlbnQgdmFsdWUsIGFuZCB0cmFjayB0aGUgY2hhbmdlLg0KICAgICAgICB1bnNldCA/IGRlbGV0ZSBub3dbYXR0cl0gOiBub3dbYXR0cl0gPSB2YWw7DQogICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaChhdHRyLCB2YWwpOw0KICAgICAgfQ0KDQogICAgICAvLyBTaWduYWwgdGhhdCB0aGUgbW9kZWwncyBzdGF0ZSBoYXMgcG90ZW50aWFsbHkgY2hhbmdlZCwgYW5kIHdlIG5lZWQNCiAgICAgIC8vIHRvIHJlY29tcHV0ZSB0aGUgYWN0dWFsIGNoYW5nZXMuDQogICAgICB0aGlzLl9oYXNDb21wdXRlZCA9IGZhbHNlOw0KDQogICAgICAvLyBGaXJlIHRoZSBgImNoYW5nZSJgIGV2ZW50cy4NCiAgICAgIGlmICghc2lsZW50KSB0aGlzLmNoYW5nZShvcHRpb25zKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQ0KICAgIC8vIHRvIHNpbGVuY2UgaXQuIGB1bnNldGAgaXMgYSBub29wIGlmIHRoZSBhdHRyaWJ1dGUgZG9lc24ndCBleGlzdC4NCiAgICB1bnNldDogZnVuY3Rpb24oYXR0ciwgb3B0aW9ucykgew0KICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsNCiAgICB9LA0KDQogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQ0KICAgIC8vIHRvIHNpbGVuY2UgaXQuDQogICAgY2xlYXI6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIHZhciBhdHRycyA9IHt9Ow0KICAgICAgZm9yICh2YXIga2V5IGluIHRoaXMuYXR0cmlidXRlcykgYXR0cnNba2V5XSA9IHZvaWQgMDsNCiAgICAgIHJldHVybiB0aGlzLnNldChhdHRycywgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsNCiAgICB9LA0KDQogICAgLy8gRmV0Y2ggdGhlIG1vZGVsIGZyb20gdGhlIHNlcnZlci4gSWYgdGhlIHNlcnZlcidzIHJlcHJlc2VudGF0aW9uIG9mIHRoZQ0KICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLA0KICAgIC8vIHRyaWdnZXJpbmcgYSBgImNoYW5nZSJgIGV2ZW50Lg0KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsNCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOw0KICAgICAgdmFyIG1vZGVsID0gdGhpczsNCiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOw0KICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsNCiAgICAgICAgaWYgKCFtb2RlbC5zZXQobW9kZWwucGFyc2UocmVzcCksIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7DQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsNCiAgICAgIH07DQogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7DQogICAgfSwNCg0KICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcywgYW5kIHN5bmMgdGhlIG1vZGVsIHRvIHRoZSBzZXJ2ZXIuDQogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzDQogICAgLy8gc3RhdGUgd2lsbCBiZSBgc2V0YCBhZ2Fpbi4NCiAgICBzYXZlOiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgew0KICAgICAgdmFyIGF0dHJzLCBjdXJyZW50LCBkb25lOw0KDQogICAgICAvLyBIYW5kbGUgYm90aCBgImtleSIsIHZhbHVlYCBhbmQgYHtrZXk6IHZhbHVlfWAgLXN0eWxlIGFyZ3VtZW50cy4NCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCBfLmlzT2JqZWN0KGtleSkpIHsNCiAgICAgICAgYXR0cnMgPSBrZXk7DQogICAgICAgIG9wdGlvbnMgPSB2YWw7DQogICAgICB9IGVsc2UgaWYgKGtleSAhPSBudWxsKSB7DQogICAgICAgIChhdHRycyA9IHt9KVtrZXldID0gdmFsOw0KICAgICAgfQ0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307DQoNCiAgICAgIC8vIElmIHdlJ3JlICJ3YWl0Ii1pbmcgdG8gc2V0IGNoYW5nZWQgYXR0cmlidXRlcywgdmFsaWRhdGUgZWFybHkuDQogICAgICBpZiAob3B0aW9ucy53YWl0KSB7DQogICAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7DQogICAgICAgIGN1cnJlbnQgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7DQogICAgICB9DQoNCiAgICAgIC8vIFJlZ3VsYXIgc2F2ZXMgYHNldGAgYXR0cmlidXRlcyBiZWZvcmUgcGVyc2lzdGluZyB0byB0aGUgc2VydmVyLg0KICAgICAgdmFyIHNpbGVudE9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3NpbGVudDogdHJ1ZX0pOw0KICAgICAgaWYgKGF0dHJzICYmICF0aGlzLnNldChhdHRycywgb3B0aW9ucy53YWl0ID8gc2lsZW50T3B0aW9ucyA6IG9wdGlvbnMpKSB7DQogICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgIH0NCg0KICAgICAgLy8gRG8gbm90IHBlcnNpc3QgaW52YWxpZCBtb2RlbHMuDQogICAgICBpZiAoIWF0dHJzICYmICF0aGlzLl92YWxpZGF0ZShudWxsLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOw0KDQogICAgICAvLyBBZnRlciBhIHN1Y2Nlc3NmdWwgc2VydmVyLXNpZGUgc2F2ZSwgdGhlIGNsaWVudCBpcyAob3B0aW9uYWxseSkNCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuDQogICAgICB2YXIgbW9kZWwgPSB0aGlzOw0KICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7DQogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgew0KICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgdmFyIHNlcnZlckF0dHJzID0gbW9kZWwucGFyc2UocmVzcCk7DQogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsNCiAgICAgICAgaWYgKCFtb2RlbC5zZXQoc2VydmVyQXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7DQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsNCiAgICAgIH07DQoNCiAgICAgIC8vIEZpbmlzaCBjb25maWd1cmluZyBhbmQgc2VuZGluZyB0aGUgQWpheCByZXF1ZXN0Lg0KICAgICAgdmFyIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOw0KICAgICAgaWYgKG1ldGhvZCA9PSAncGF0Y2gnKSBvcHRpb25zLmF0dHJzID0gYXR0cnM7DQogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKG1ldGhvZCwgdGhpcywgb3B0aW9ucyk7DQoNCiAgICAgIC8vIFdoZW4gdXNpbmcgYHdhaXRgLCByZXNldCBhdHRyaWJ1dGVzIHRvIG9yaWdpbmFsIHZhbHVlcyB1bmxlc3MNCiAgICAgIC8vIGBzdWNjZXNzYCBoYXMgYmVlbiBjYWxsZWQgYWxyZWFkeS4NCiAgICAgIGlmICghZG9uZSAmJiBvcHRpb25zLndhaXQpIHsNCiAgICAgICAgdGhpcy5jbGVhcihzaWxlbnRPcHRpb25zKTsNCiAgICAgICAgdGhpcy5zZXQoY3VycmVudCwgc2lsZW50T3B0aW9ucyk7DQogICAgICB9DQoNCiAgICAgIHJldHVybiB4aHI7DQogICAgfSwNCg0KICAgIC8vIERlc3Ryb3kgdGhpcyBtb2RlbCBvbiB0aGUgc2VydmVyIGlmIGl0IHdhcyBhbHJlYWR5IHBlcnNpc3RlZC4NCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLg0KICAgIC8vIElmIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIHdhaXRzIGZvciB0aGUgc2VydmVyIHRvIHJlc3BvbmQgYmVmb3JlIHJlbW92YWwuDQogICAgZGVzdHJveTogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307DQogICAgICB2YXIgbW9kZWwgPSB0aGlzOw0KICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7DQoNCiAgICAgIHZhciBkZXN0cm95ID0gZnVuY3Rpb24oKSB7DQogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2Rlc3Ryb3knLCBtb2RlbCwgbW9kZWwuY29sbGVjdGlvbiwgb3B0aW9ucyk7DQogICAgICB9Ow0KDQogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwKSB7DQogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOw0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7DQogICAgICB9Ow0KDQogICAgICBpZiAodGhpcy5pc05ldygpKSB7DQogICAgICAgIG9wdGlvbnMuc3VjY2VzcygpOw0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQoNCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOw0KICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGRlc3Ryb3koKTsNCiAgICAgIHJldHVybiB4aHI7DQogICAgfSwNCg0KICAgIC8vIERlZmF1bHQgVVJMIGZvciB0aGUgbW9kZWwncyByZXByZXNlbnRhdGlvbiBvbiB0aGUgc2VydmVyIC0tIGlmIHlvdSdyZQ0KICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQNCiAgICAvLyB0aGF0IHdpbGwgYmUgY2FsbGVkLg0KICAgIHVybDogZnVuY3Rpb24oKSB7DQogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsNCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHJldHVybiBiYXNlOw0KICAgICAgcmV0dXJuIGJhc2UgKyAoYmFzZS5jaGFyQXQoYmFzZS5sZW5ndGggLSAxKSA9PT0gJy8nID8gJycgOiAnLycpICsgZW5jb2RlVVJJQ29tcG9uZW50KHRoaXMuaWQpOw0KICAgIH0sDQoNCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIHRoZSBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYHNldGAgb24NCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuDQogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsNCiAgICAgIHJldHVybiByZXNwOw0KICAgIH0sDQoNCiAgICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwgd2l0aCBpZGVudGljYWwgYXR0cmlidXRlcyB0byB0aGlzIG9uZS4NCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5hdHRyaWJ1dGVzKTsNCiAgICB9LA0KDQogICAgLy8gQSBtb2RlbCBpcyBuZXcgaWYgaXQgaGFzIG5ldmVyIGJlZW4gc2F2ZWQgdG8gdGhlIHNlcnZlciwgYW5kIGxhY2tzIGFuIGlkLg0KICAgIGlzTmV3OiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7DQogICAgfSwNCg0KICAgIC8vIENhbGwgdGhpcyBtZXRob2QgdG8gbWFudWFsbHkgZmlyZSBhIGAiY2hhbmdlImAgZXZlbnQgZm9yIHRoaXMgbW9kZWwgYW5kDQogICAgLy8gYSBgImNoYW5nZTphdHRyaWJ1dGUiYCBldmVudCBmb3IgZWFjaCBjaGFuZ2VkIGF0dHJpYnV0ZS4NCiAgICAvLyBDYWxsaW5nIHRoaXMgd2lsbCBjYXVzZSBhbGwgb2JqZWN0cyBvYnNlcnZpbmcgdGhlIG1vZGVsIHRvIHVwZGF0ZS4NCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIHZhciBjaGFuZ2luZyA9IHRoaXMuX2NoYW5naW5nOw0KICAgICAgdGhpcy5fY2hhbmdpbmcgPSB0cnVlOw0KDQogICAgICAvLyBHZW5lcmF0ZSB0aGUgY2hhbmdlcyB0byBiZSB0cmlnZ2VyZWQgb24gdGhlIG1vZGVsLg0KICAgICAgdmFyIHRyaWdnZXJzID0gdGhpcy5fY29tcHV0ZUNoYW5nZXModHJ1ZSk7DQoNCiAgICAgIHRoaXMuX3BlbmRpbmcgPSAhIXRyaWdnZXJzLmxlbmd0aDsNCg0KICAgICAgZm9yICh2YXIgaSA9IHRyaWdnZXJzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7DQogICAgICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOicgKyB0cmlnZ2Vyc1tpXSwgdGhpcywgdHJpZ2dlcnNbaSArIDFdLCBvcHRpb25zKTsNCiAgICAgIH0NCg0KICAgICAgaWYgKGNoYW5naW5nKSByZXR1cm4gdGhpczsNCg0KICAgICAgLy8gVHJpZ2dlciBhIGBjaGFuZ2VgIHdoaWxlIHRoZXJlIGhhdmUgYmVlbiBjaGFuZ2VzLg0KICAgICAgd2hpbGUgKHRoaXMuX3BlbmRpbmcpIHsNCiAgICAgICAgdGhpcy5fcGVuZGluZyA9IGZhbHNlOw0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOw0KICAgICAgICB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7DQogICAgICB9DQoNCiAgICAgIHRoaXMuX2NoYW5naW5nID0gZmFsc2U7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gRGV0ZXJtaW5lIGlmIHRoZSBtb2RlbCBoYXMgY2hhbmdlZCBzaW5jZSB0aGUgbGFzdCBgImNoYW5nZSJgIGV2ZW50Lg0KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuDQogICAgaGFzQ2hhbmdlZDogZnVuY3Rpb24oYXR0cikgew0KICAgICAgaWYgKCF0aGlzLl9oYXNDb21wdXRlZCkgdGhpcy5fY29tcHV0ZUNoYW5nZXMoKTsNCiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7DQogICAgICByZXR1cm4gXy5oYXModGhpcy5jaGFuZ2VkLCBhdHRyKTsNCiAgICB9LA0KDQogICAgLy8gUmV0dXJuIGFuIG9iamVjdCBjb250YWluaW5nIGFsbCB0aGUgYXR0cmlidXRlcyB0aGF0IGhhdmUgY2hhbmdlZCwgb3INCiAgICAvLyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gY2hhbmdlZCBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIGRldGVybWluaW5nIHdoYXQNCiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQ0KICAgIC8vIHBlcnNpc3RlZCB0byB0aGUgc2VydmVyLiBVbnNldCBhdHRyaWJ1dGVzIHdpbGwgYmUgc2V0IHRvIHVuZGVmaW5lZC4NCiAgICAvLyBZb3UgY2FuIGFsc28gcGFzcyBhbiBhdHRyaWJ1dGVzIG9iamVjdCB0byBkaWZmIGFnYWluc3QgdGhlIG1vZGVsLA0KICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuDQogICAgY2hhbmdlZEF0dHJpYnV0ZXM6IGZ1bmN0aW9uKGRpZmYpIHsNCiAgICAgIGlmICghZGlmZikgcmV0dXJuIHRoaXMuaGFzQ2hhbmdlZCgpID8gXy5jbG9uZSh0aGlzLmNoYW5nZWQpIDogZmFsc2U7DQogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2UsIG9sZCA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsNCiAgICAgIGZvciAodmFyIGF0dHIgaW4gZGlmZikgew0KICAgICAgICBpZiAoXy5pc0VxdWFsKG9sZFthdHRyXSwgKHZhbCA9IGRpZmZbYXR0cl0pKSkgY29udGludWU7DQogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsNCiAgICAgIH0NCiAgICAgIHJldHVybiBjaGFuZ2VkOw0KICAgIH0sDQoNCiAgICAvLyBMb29raW5nIGF0IHRoZSBidWlsdCB1cCBsaXN0IG9mIGBzZXRgIGF0dHJpYnV0ZSBjaGFuZ2VzLCBjb21wdXRlIGhvdw0KICAgIC8vIG1hbnkgb2YgdGhlIGF0dHJpYnV0ZXMgaGF2ZSBhY3R1YWxseSBjaGFuZ2VkLiBJZiBgbG91ZGAsIHJldHVybiBhDQogICAgLy8gYm9pbGVkLWRvd24gbGlzdCBvZiBvbmx5IHRoZSByZWFsIGNoYW5nZXMuDQogICAgX2NvbXB1dGVDaGFuZ2VzOiBmdW5jdGlvbihsb3VkKSB7DQogICAgICB0aGlzLmNoYW5nZWQgPSB7fTsNCiAgICAgIHZhciBhbHJlYWR5ID0ge307DQogICAgICB2YXIgdHJpZ2dlcnMgPSBbXTsNCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5fY3VycmVudEF0dHJpYnV0ZXM7DQogICAgICB2YXIgY2hhbmdlcyA9IHRoaXMuX2NoYW5nZXM7DQoNCiAgICAgIC8vIExvb3AgdGhyb3VnaCB0aGUgY3VycmVudCBxdWV1ZSBvZiBwb3RlbnRpYWwgbW9kZWwgY2hhbmdlcy4NCiAgICAgIGZvciAodmFyIGkgPSBjaGFuZ2VzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7DQogICAgICAgIHZhciBrZXkgPSBjaGFuZ2VzW2ldLCB2YWwgPSBjaGFuZ2VzW2kgKyAxXTsNCiAgICAgICAgaWYgKGFscmVhZHlba2V5XSkgY29udGludWU7DQogICAgICAgIGFscmVhZHlba2V5XSA9IHRydWU7DQoNCiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIGF0dHJpYnV0ZSBoYXMgYmVlbiBtb2RpZmllZCBzaW5jZSB0aGUgbGFzdCBjaGFuZ2UsDQogICAgICAgIC8vIGFuZCB1cGRhdGUgYHRoaXMuY2hhbmdlZGAgYWNjb3JkaW5nbHkuIElmIHdlJ3JlIGluc2lkZSBvZiBhIGBjaGFuZ2VgDQogICAgICAgIC8vIGNhbGwsIGFsc28gYWRkIGEgdHJpZ2dlciB0byB0aGUgbGlzdC4NCiAgICAgICAgaWYgKGN1cnJlbnRba2V5XSAhPT0gdmFsKSB7DQogICAgICAgICAgdGhpcy5jaGFuZ2VkW2tleV0gPSB2YWw7DQogICAgICAgICAgaWYgKCFsb3VkKSBjb250aW51ZTsNCiAgICAgICAgICB0cmlnZ2Vycy5wdXNoKGtleSwgdmFsKTsNCiAgICAgICAgICBjdXJyZW50W2tleV0gPSB2YWw7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIGlmIChsb3VkKSB0aGlzLl9jaGFuZ2VzID0gW107DQoNCiAgICAgIC8vIFNpZ25hbHMgYHRoaXMuY2hhbmdlZGAgaXMgY3VycmVudCB0byBwcmV2ZW50IGR1cGxpY2F0ZSBjYWxscyBmcm9tIGB0aGlzLmhhc0NoYW5nZWRgLg0KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSB0cnVlOw0KICAgICAgcmV0dXJuIHRyaWdnZXJzOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgdGhlIHByZXZpb3VzIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZSwgcmVjb3JkZWQgYXQgdGhlIHRpbWUgdGhlIGxhc3QNCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50IHdhcyBmaXJlZC4NCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgew0KICAgICAgaWYgKGF0dHIgPT0gbnVsbCB8fCAhdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzKSByZXR1cm4gbnVsbDsNCiAgICAgIHJldHVybiB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXNbYXR0cl07DQogICAgfSwNCg0KICAgIC8vIEdldCBhbGwgb2YgdGhlIGF0dHJpYnV0ZXMgb2YgdGhlIG1vZGVsIGF0IHRoZSB0aW1lIG9mIHRoZSBwcmV2aW91cw0KICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuDQogICAgcHJldmlvdXNBdHRyaWJ1dGVzOiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyk7DQogICAgfSwNCg0KICAgIC8vIFJ1biB2YWxpZGF0aW9uIGFnYWluc3QgdGhlIG5leHQgY29tcGxldGUgc2V0IG9mIG1vZGVsIGF0dHJpYnV0ZXMsDQogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcw0KICAgIC8vIGJlZW4gcGFzc2VkLCBjYWxsIHRoYXQgaW5zdGVhZCBvZiBmaXJpbmcgdGhlIGdlbmVyYWwgYCJlcnJvciJgIGV2ZW50Lg0KICAgIF92YWxpZGF0ZTogZnVuY3Rpb24oYXR0cnMsIG9wdGlvbnMpIHsNCiAgICAgIGlmICghdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7DQogICAgICBhdHRycyA9IF8uZXh0ZW5kKHt9LCB0aGlzLmF0dHJpYnV0ZXMsIGF0dHJzKTsNCiAgICAgIHZhciBlcnJvciA9IHRoaXMudmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpOw0KICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7DQogICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmVycm9yKSBvcHRpb25zLmVycm9yKHRoaXMsIGVycm9yLCBvcHRpb25zKTsNCiAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCB0aGlzLCBlcnJvciwgb3B0aW9ucyk7DQogICAgICByZXR1cm4gZmFsc2U7DQogICAgfQ0KDQogIH0pOw0KDQogIC8vIEJhY2tib25lLkNvbGxlY3Rpb24NCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQ0KDQogIC8vIFByb3ZpZGVzIGEgc3RhbmRhcmQgY29sbGVjdGlvbiBjbGFzcyBmb3Igb3VyIHNldHMgb2YgbW9kZWxzLCBvcmRlcmVkDQogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluDQogIC8vIGl0cyBtb2RlbHMgaW4gc29ydCBvcmRlciwgYXMgdGhleSdyZSBhZGRlZCBhbmQgcmVtb3ZlZC4NCiAgdmFyIENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uID0gZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7DQogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsNCiAgICBpZiAob3B0aW9ucy5tb2RlbCkgdGhpcy5tb2RlbCA9IG9wdGlvbnMubW9kZWw7DQogICAgaWYgKG9wdGlvbnMuY29tcGFyYXRvciAhPT0gdm9pZCAwKSB0aGlzLmNvbXBhcmF0b3IgPSBvcHRpb25zLmNvbXBhcmF0b3I7DQogICAgdGhpcy5fcmVzZXQoKTsNCiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCiAgICBpZiAobW9kZWxzKSB0aGlzLnJlc2V0KG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsNCiAgfTsNCg0KICAvLyBEZWZpbmUgdGhlIENvbGxlY3Rpb24ncyBpbmhlcml0YWJsZSBtZXRob2RzLg0KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7DQoNCiAgICAvLyBUaGUgZGVmYXVsdCBtb2RlbCBmb3IgYSBjb2xsZWN0aW9uIGlzIGp1c3QgYSAqKkJhY2tib25lLk1vZGVsKiouDQogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLg0KICAgIG1vZGVsOiBNb2RlbCwNCg0KICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bg0KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLg0KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwNCg0KICAgIC8vIFRoZSBKU09OIHJlcHJlc2VudGF0aW9uIG9mIGEgQ29sbGVjdGlvbiBpcyBhbiBhcnJheSBvZiB0aGUNCiAgICAvLyBtb2RlbHMnIGF0dHJpYnV0ZXMuDQogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICByZXR1cm4gdGhpcy5tYXAoZnVuY3Rpb24obW9kZWwpeyByZXR1cm4gbW9kZWwudG9KU09OKG9wdGlvbnMpOyB9KTsNCiAgICB9LA0KDQogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuDQogICAgc3luYzogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgIH0sDQoNCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkDQogICAgLy8gZmlyaW5nIHRoZSBgYWRkYCBldmVudCBmb3IgZXZlcnkgbmV3IG1vZGVsLg0KICAgIGFkZDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7DQogICAgICB2YXIgaSwgYXJncywgbGVuZ3RoLCBtb2RlbCwgZXhpc3RpbmcsIG5lZWRzU29ydDsNCiAgICAgIHZhciBhdCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5hdDsNCiAgICAgIHZhciBzb3J0ID0gKChvcHRpb25zICYmIG9wdGlvbnMuc29ydCkgPT0gbnVsbCA/IHRydWUgOiBvcHRpb25zLnNvcnQpOw0KICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOw0KDQogICAgICAvLyBUdXJuIGJhcmUgb2JqZWN0cyBpbnRvIG1vZGVsIHJlZmVyZW5jZXMsIGFuZCBwcmV2ZW50IGludmFsaWQgbW9kZWxzDQogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLg0KICAgICAgZm9yIChpID0gbW9kZWxzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7DQogICAgICAgIGlmKCEobW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWxzW2ldLCBvcHRpb25zKSkpIHsNCiAgICAgICAgICB0aGlzLnRyaWdnZXIoImVycm9yIiwgdGhpcywgbW9kZWxzW2ldLCBvcHRpb25zKTsNCiAgICAgICAgICBtb2RlbHMuc3BsaWNlKGksIDEpOw0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQogICAgICAgIG1vZGVsc1tpXSA9IG1vZGVsOw0KDQogICAgICAgIGV4aXN0aW5nID0gbW9kZWwuaWQgIT0gbnVsbCAmJiB0aGlzLl9ieUlkW21vZGVsLmlkXTsNCiAgICAgICAgLy8gSWYgYSBkdXBsaWNhdGUgaXMgZm91bmQsIHByZXZlbnQgaXQgZnJvbSBiZWluZyBhZGRlZCBhbmQNCiAgICAgICAgLy8gb3B0aW9uYWxseSBtZXJnZSBpdCBpbnRvIHRoZSBleGlzdGluZyBtb2RlbC4NCiAgICAgICAgaWYgKGV4aXN0aW5nIHx8IHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0pIHsNCiAgICAgICAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSB7DQogICAgICAgICAgICBleGlzdGluZy5zZXQobW9kZWwuYXR0cmlidXRlcywgb3B0aW9ucyk7DQogICAgICAgICAgICBuZWVkc1NvcnQgPSBzb3J0Ow0KICAgICAgICAgIH0NCiAgICAgICAgICBtb2RlbHMuc3BsaWNlKGksIDEpOw0KICAgICAgICAgIGNvbnRpbnVlOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkNCiAgICAgICAgLy8gYGlkYCBhbmQgYnkgYGNpZGAuDQogICAgICAgIG1vZGVsLm9uKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOw0KICAgICAgICB0aGlzLl9ieUNpZFttb2RlbC5jaWRdID0gbW9kZWw7DQogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOw0KICAgICAgfQ0KDQogICAgICAvLyBTZWUgaWYgc29ydGluZyBpcyBuZWVkZWQsIHVwZGF0ZSBgbGVuZ3RoYCBhbmQgc3BsaWNlIGluIG5ldyBtb2RlbHMuDQogICAgICBpZiAobW9kZWxzLmxlbmd0aCkgbmVlZHNTb3J0ID0gc29ydDsNCiAgICAgIHRoaXMubGVuZ3RoICs9IG1vZGVscy5sZW5ndGg7DQogICAgICBhcmdzID0gW2F0ICE9IG51bGwgPyBhdCA6IHRoaXMubW9kZWxzLmxlbmd0aCwgMF07DQogICAgICBwdXNoLmFwcGx5KGFyZ3MsIG1vZGVscyk7DQogICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3MpOw0KDQogICAgICAvLyBTb3J0IHRoZSBjb2xsZWN0aW9uIGlmIGFwcHJvcHJpYXRlLg0KICAgICAgaWYgKG5lZWRzU29ydCAmJiB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsNCg0KICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5zaWxlbnQpIHJldHVybiB0aGlzOw0KDQogICAgICAvLyBUcmlnZ2VyIGBhZGRgIGV2ZW50cy4NCiAgICAgIHdoaWxlIChtb2RlbCA9IG1vZGVscy5zaGlmdCgpKSB7DQogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsNCiAgICAgIH0NCg0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQNCiAgICAvLyBmaXJpbmcgdGhlIGByZW1vdmVgIGV2ZW50IGZvciBldmVyeSBtb2RlbCByZW1vdmVkLg0KICAgIHJlbW92ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7DQogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOw0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsNCiAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsNCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgIG1vZGVsID0gdGhpcy5nZXQobW9kZWxzW2ldKTsNCiAgICAgICAgaWYgKCFtb2RlbCkgY29udGludWU7DQogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsNCiAgICAgICAgZGVsZXRlIHRoaXMuX2J5Q2lkW21vZGVsLmNpZF07DQogICAgICAgIGluZGV4ID0gdGhpcy5pbmRleE9mKG1vZGVsKTsNCiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsNCiAgICAgICAgdGhpcy5sZW5ndGgtLTsNCiAgICAgICAgaWYgKCFvcHRpb25zLnNpbGVudCkgew0KICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsNCiAgICAgICAgICBtb2RlbC50cmlnZ2VyKCdyZW1vdmUnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLg0KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7DQogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7DQogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiB0aGlzLmxlbmd0aH0sIG9wdGlvbnMpKTsNCiAgICAgIHJldHVybiBtb2RlbDsNCiAgICB9LA0KDQogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLg0KICAgIHBvcDogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCh0aGlzLmxlbmd0aCAtIDEpOw0KICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIG1vZGVsOw0KICAgIH0sDQoNCiAgICAvLyBBZGQgYSBtb2RlbCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLg0KICAgIHVuc2hpZnQ6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7DQogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7DQogICAgICB0aGlzLmFkZChtb2RlbCwgXy5leHRlbmQoe2F0OiAwfSwgb3B0aW9ucykpOw0KICAgICAgcmV0dXJuIG1vZGVsOw0KICAgIH0sDQoNCiAgICAvLyBSZW1vdmUgYSBtb2RlbCBmcm9tIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uDQogICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQoMCk7DQogICAgICB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7DQogICAgICByZXR1cm4gbW9kZWw7DQogICAgfSwNCg0KICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4NCiAgICBzbGljZTogZnVuY3Rpb24oYmVnaW4sIGVuZCkgew0KICAgICAgcmV0dXJuIHRoaXMubW9kZWxzLnNsaWNlKGJlZ2luLCBlbmQpOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgYSBtb2RlbCBmcm9tIHRoZSBzZXQgYnkgaWQuDQogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsNCiAgICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIHZvaWQgMDsNCiAgICAgIHJldHVybiB0aGlzLl9ieUlkW29iai5pZCAhPSBudWxsID8gb2JqLmlkIDogb2JqXSB8fCB0aGlzLl9ieUNpZFtvYmouY2lkIHx8IG9ial07DQogICAgfSwNCg0KICAgIC8vIEdldCB0aGUgbW9kZWwgYXQgdGhlIGdpdmVuIGluZGV4Lg0KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgew0KICAgICAgcmV0dXJuIHRoaXMubW9kZWxzW2luZGV4XTsNCiAgICB9LA0KDQogICAgLy8gUmV0dXJuIG1vZGVscyB3aXRoIG1hdGNoaW5nIGF0dHJpYnV0ZXMuIFVzZWZ1bCBmb3Igc2ltcGxlIGNhc2VzIG9mIGBmaWx0ZXJgLg0KICAgIHdoZXJlOiBmdW5jdGlvbihhdHRycykgew0KICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsNCiAgICAgIHJldHVybiB0aGlzLmZpbHRlcihmdW5jdGlvbihtb2RlbCkgew0KICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXR0cnMpIHsNCiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0pOw0KICAgIH0sDQoNCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyDQogICAgLy8gbm9ybWFsIGNpcmN1bXN0YW5jZXMsIGFzIHRoZSBzZXQgd2lsbCBtYWludGFpbiBzb3J0IG9yZGVyIGFzIGVhY2ggaXRlbQ0KICAgIC8vIGlzIGFkZGVkLg0KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIGlmICghdGhpcy5jb21wYXJhdG9yKSB7DQogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNvcnQgYSBzZXQgd2l0aG91dCBhIGNvbXBhcmF0b3InKTsNCiAgICAgIH0NCg0KICAgICAgaWYgKF8uaXNTdHJpbmcodGhpcy5jb21wYXJhdG9yKSB8fCB0aGlzLmNvbXBhcmF0b3IubGVuZ3RoID09PSAxKSB7DQogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMubW9kZWxzLnNvcnQoXy5iaW5kKHRoaXMuY29tcGFyYXRvciwgdGhpcykpOw0KICAgICAgfQ0KDQogICAgICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3NvcnQnLCB0aGlzLCBvcHRpb25zKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLg0KICAgIHBsdWNrOiBmdW5jdGlvbihhdHRyKSB7DQogICAgICByZXR1cm4gXy5pbnZva2UodGhpcy5tb2RlbHMsICdnZXQnLCBhdHRyKTsNCiAgICB9LA0KDQogICAgLy8gU21hcnRseSB1cGRhdGUgYSBjb2xsZWN0aW9uIHdpdGggYSBjaGFuZ2Ugc2V0IG9mIG1vZGVscywgYWRkaW5nLA0KICAgIC8vIHJlbW92aW5nLCBhbmQgbWVyZ2luZyBhcyBuZWNlc3NhcnkuDQogICAgdXBkYXRlOiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsNCiAgICAgIHZhciBtb2RlbCwgaSwgbCwgZXhpc3Rpbmc7DQogICAgICB2YXIgYWRkID0gW10sIHJlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9Ow0KICAgICAgdmFyIGlkQXR0ciA9IHRoaXMubW9kZWwucHJvdG90eXBlLmlkQXR0cmlidXRlOw0KICAgICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHthZGQ6IHRydWUsIG1lcmdlOiB0cnVlLCByZW1vdmU6IHRydWV9LCBvcHRpb25zKTsNCiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7DQoNCiAgICAgIC8vIEFsbG93IGEgc2luZ2xlIG1vZGVsIChvciBubyBhcmd1bWVudCkgdG8gYmUgcGFzc2VkLg0KICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsNCg0KICAgICAgLy8gUHJveHkgdG8gYGFkZGAgZm9yIHRoaXMgY2FzZSwgbm8gbmVlZCB0byBpdGVyYXRlLi4uDQogICAgICBpZiAob3B0aW9ucy5hZGQgJiYgIW9wdGlvbnMucmVtb3ZlKSByZXR1cm4gdGhpcy5hZGQobW9kZWxzLCBvcHRpb25zKTsNCg0KICAgICAgLy8gRGV0ZXJtaW5lIHdoaWNoIG1vZGVscyB0byBhZGQgYW5kIG1lcmdlLCBhbmQgd2hpY2ggdG8gcmVtb3ZlLg0KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgbW9kZWwgPSBtb2RlbHNbaV07DQogICAgICAgIGV4aXN0aW5nID0gdGhpcy5nZXQobW9kZWwuaWQgfHwgbW9kZWwuY2lkIHx8IG1vZGVsW2lkQXR0cl0pOw0KICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmUgJiYgZXhpc3RpbmcpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOw0KICAgICAgICBpZiAoKG9wdGlvbnMuYWRkICYmICFleGlzdGluZykgfHwgKG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpKSB7DQogICAgICAgICAgYWRkLnB1c2gobW9kZWwpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBpZiAob3B0aW9ucy5yZW1vdmUpIHsNCiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICAgIG1vZGVsID0gdGhpcy5tb2RlbHNbaV07DQogICAgICAgICAgaWYgKCFtb2RlbE1hcFttb2RlbC5jaWRdKSByZW1vdmUucHVzaChtb2RlbCk7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgLy8gUmVtb3ZlIG1vZGVscyAoaWYgYXBwbGljYWJsZSkgYmVmb3JlIHdlIGFkZCBhbmQgbWVyZ2UgdGhlIHJlc3QuDQogICAgICBpZiAocmVtb3ZlLmxlbmd0aCkgdGhpcy5yZW1vdmUocmVtb3ZlLCBvcHRpb25zKTsNCiAgICAgIGlmIChhZGQubGVuZ3RoKSB0aGlzLmFkZChhZGQsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LA0KICAgIC8vIHlvdSBjYW4gcmVzZXQgdGhlIGVudGlyZSBzZXQgd2l0aCBhIG5ldyBsaXN0IG9mIG1vZGVscywgd2l0aG91dCBmaXJpbmcNCiAgICAvLyBhbnkgYGFkZGAgb3IgYHJlbW92ZWAgZXZlbnRzLiBGaXJlcyBgcmVzZXRgIHdoZW4gZmluaXNoZWQuDQogICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgew0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsNCiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7DQogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICB0aGlzLl9yZW1vdmVSZWZlcmVuY2UodGhpcy5tb2RlbHNbaV0pOw0KICAgICAgfQ0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOw0KICAgICAgdGhpcy5fcmVzZXQoKTsNCiAgICAgIGlmIChtb2RlbHMpIHRoaXMuYWRkKG1vZGVscywgXy5leHRlbmQoe3NpbGVudDogdHJ1ZX0sIG9wdGlvbnMpKTsNCiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBGZXRjaCB0aGUgZGVmYXVsdCBzZXQgb2YgbW9kZWxzIGZvciB0aGlzIGNvbGxlY3Rpb24sIHJlc2V0dGluZyB0aGUNCiAgICAvLyBjb2xsZWN0aW9uIHdoZW4gdGhleSBhcnJpdmUuIElmIGBhZGQ6IHRydWVgIGlzIHBhc3NlZCwgYXBwZW5kcyB0aGUNCiAgICAvLyBtb2RlbHMgdG8gdGhlIGNvbGxlY3Rpb24gaW5zdGVhZCBvZiByZXNldHRpbmcuDQogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9Ow0KICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7DQogICAgICB2YXIgY29sbGVjdGlvbiA9IHRoaXM7DQogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsNCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7DQogICAgICAgIHZhciBtZXRob2QgPSBvcHRpb25zLnVwZGF0ZSA/ICd1cGRhdGUnIDogJ3Jlc2V0JzsNCiAgICAgICAgY29sbGVjdGlvblttZXRob2RdKHJlc3AsIG9wdGlvbnMpOw0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsNCiAgICAgIH07DQogICAgICByZXR1cm4gdGhpcy5zeW5jKCdyZWFkJywgdGhpcywgb3B0aW9ucyk7DQogICAgfSwNCg0KICAgIC8vIENyZWF0ZSBhIG5ldyBpbnN0YW5jZSBvZiBhIG1vZGVsIGluIHRoaXMgY29sbGVjdGlvbi4gQWRkIHRoZSBtb2RlbCB0byB0aGUNCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQ0KICAgIC8vIHdhaXQgZm9yIHRoZSBzZXJ2ZXIgdG8gYWdyZWUuDQogICAgY3JlYXRlOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgew0KICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOw0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307DQogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7DQogICAgICBpZiAoIW1vZGVsKSByZXR1cm4gZmFsc2U7DQogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7DQogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgew0KICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7DQogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsNCiAgICAgIH07DQogICAgICBtb2RlbC5zYXZlKG51bGwsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIG1vZGVsOw0KICAgIH0sDQoNCiAgICAvLyAqKnBhcnNlKiogY29udmVydHMgYSByZXNwb25zZSBpbnRvIGEgbGlzdCBvZiBtb2RlbHMgdG8gYmUgYWRkZWQgdG8gdGhlDQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guDQogICAgcGFyc2U6IGZ1bmN0aW9uKHJlc3ApIHsNCiAgICAgIHJldHVybiByZXNwOw0KICAgIH0sDQoNCiAgICAvLyBDcmVhdGUgYSBuZXcgY29sbGVjdGlvbiB3aXRoIGFuIGlkZW50aWNhbCBsaXN0IG9mIG1vZGVscyBhcyB0aGlzIG9uZS4NCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gbmV3IHRoaXMuY29uc3RydWN0b3IodGhpcy5tb2RlbHMpOw0KICAgIH0sDQoNCiAgICAvLyBQcm94eSB0byBfJ3MgY2hhaW4uIENhbid0IGJlIHByb3hpZWQgdGhlIHNhbWUgd2F5IHRoZSByZXN0IG9mIHRoZQ0KICAgIC8vIHVuZGVyc2NvcmUgbWV0aG9kcyBhcmUgcHJveGllZCBiZWNhdXNlIGl0IHJlbGllcyBvbiB0aGUgdW5kZXJzY29yZQ0KICAgIC8vIGNvbnN0cnVjdG9yLg0KICAgIGNoYWluOiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiBfKHRoaXMubW9kZWxzKS5jaGFpbigpOw0KICAgIH0sDQoNCiAgICAvLyBSZXNldCBhbGwgaW50ZXJuYWwgc3RhdGUuIENhbGxlZCB3aGVuIHRoZSBjb2xsZWN0aW9uIGlzIHJlc2V0Lg0KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7DQogICAgICB0aGlzLmxlbmd0aCA9IDA7DQogICAgICB0aGlzLm1vZGVscyA9IFtdOw0KICAgICAgdGhpcy5fYnlJZCAgPSB7fTsNCiAgICAgIHRoaXMuX2J5Q2lkID0ge307DQogICAgfSwNCg0KICAgIC8vIFByZXBhcmUgYSBtb2RlbCBvciBoYXNoIG9mIGF0dHJpYnV0ZXMgdG8gYmUgYWRkZWQgdG8gdGhpcyBjb2xsZWN0aW9uLg0KICAgIF9wcmVwYXJlTW9kZWw6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7DQogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgew0KICAgICAgICBpZiAoIWF0dHJzLmNvbGxlY3Rpb24pIGF0dHJzLmNvbGxlY3Rpb24gPSB0aGlzOw0KICAgICAgICByZXR1cm4gYXR0cnM7DQogICAgICB9DQogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOw0KICAgICAgb3B0aW9ucy5jb2xsZWN0aW9uID0gdGhpczsNCiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsNCiAgICAgIGlmICghbW9kZWwuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgcmV0dXJuIG1vZGVsOw0KICAgIH0sDQoNCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgdG8gcmVtb3ZlIGEgbW9kZWwncyB0aWVzIHRvIGEgY29sbGVjdGlvbi4NCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgew0KICAgICAgaWYgKHRoaXMgPT09IG1vZGVsLmNvbGxlY3Rpb24pIGRlbGV0ZSBtb2RlbC5jb2xsZWN0aW9uOw0KICAgICAgbW9kZWwub2ZmKCdhbGwnLCB0aGlzLl9vbk1vZGVsRXZlbnQsIHRoaXMpOw0KICAgIH0sDQoNCiAgICAvLyBJbnRlcm5hbCBtZXRob2QgY2FsbGVkIGV2ZXJ5IHRpbWUgYSBtb2RlbCBpbiB0aGUgc2V0IGZpcmVzIGFuIGV2ZW50Lg0KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXINCiAgICAvLyBldmVudHMgc2ltcGx5IHByb3h5IHRocm91Z2guICJhZGQiIGFuZCAicmVtb3ZlIiBldmVudHMgdGhhdCBvcmlnaW5hdGUNCiAgICAvLyBpbiBvdGhlciBjb2xsZWN0aW9ucyBhcmUgaWdub3JlZC4NCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsNCiAgICAgIGlmICgoZXZlbnQgPT09ICdhZGQnIHx8IGV2ZW50ID09PSAncmVtb3ZlJykgJiYgY29sbGVjdGlvbiAhPT0gdGhpcykgcmV0dXJuOw0KICAgICAgaWYgKGV2ZW50ID09PSAnZGVzdHJveScpIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsNCiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsNCiAgICAgICAgZGVsZXRlIHRoaXMuX2J5SWRbbW9kZWwucHJldmlvdXMobW9kZWwuaWRBdHRyaWJ1dGUpXTsNCiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7DQogICAgICB9DQogICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCiAgICB9DQoNCiAgfSk7DQoNCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uDQogIHZhciBtZXRob2RzID0gWydmb3JFYWNoJywgJ2VhY2gnLCAnbWFwJywgJ2NvbGxlY3QnLCAncmVkdWNlJywgJ2ZvbGRsJywNCiAgICAnaW5qZWN0JywgJ3JlZHVjZVJpZ2h0JywgJ2ZvbGRyJywgJ2ZpbmQnLCAnZGV0ZWN0JywgJ2ZpbHRlcicsICdzZWxlY3QnLA0KICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywNCiAgICAnbWF4JywgJ21pbicsICdzb3J0ZWRJbmRleCcsICd0b0FycmF5JywgJ3NpemUnLCAnZmlyc3QnLCAnaGVhZCcsICd0YWtlJywNCiAgICAnaW5pdGlhbCcsICdyZXN0JywgJ3RhaWwnLCAnbGFzdCcsICd3aXRob3V0JywgJ2luZGV4T2YnLCAnc2h1ZmZsZScsDQogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknXTsNCg0KICAvLyBNaXggaW4gZWFjaCBVbmRlcnNjb3JlIG1ldGhvZCBhcyBhIHByb3h5IHRvIGBDb2xsZWN0aW9uI21vZGVsc2AuDQogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsNCiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24oKSB7DQogICAgICB2YXIgYXJncyA9IHNsaWNlLmNhbGwoYXJndW1lbnRzKTsNCiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7DQogICAgICByZXR1cm4gX1ttZXRob2RdLmFwcGx5KF8sIGFyZ3MpOw0KICAgIH07DQogIH0pOw0KDQogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHRha2UgYSBwcm9wZXJ0eSBuYW1lIGFzIGFuIGFyZ3VtZW50Lg0KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOw0KDQogIC8vIFVzZSBhdHRyaWJ1dGVzIGluc3RlYWQgb2YgcHJvcGVydGllcy4NCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgew0KICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbih2YWx1ZSwgY29udGV4dCkgew0KICAgICAgdmFyIGl0ZXJhdG9yID0gXy5pc0Z1bmN0aW9uKHZhbHVlKSA/IHZhbHVlIDogZnVuY3Rpb24obW9kZWwpIHsNCiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7DQogICAgICB9Ow0KICAgICAgcmV0dXJuIF9bbWV0aG9kXSh0aGlzLm1vZGVscywgaXRlcmF0b3IsIGNvbnRleHQpOw0KICAgIH07DQogIH0pOw0KDQogIC8vIEJhY2tib25lLlJvdXRlcg0KICAvLyAtLS0tLS0tLS0tLS0tLS0NCg0KICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQ0KICAvLyBtYXRjaGVkLiBDcmVhdGluZyBhIG5ldyBvbmUgc2V0cyBpdHMgYHJvdXRlc2AgaGFzaCwgaWYgbm90IHNldCBzdGF0aWNhbGx5Lg0KICB2YXIgUm91dGVyID0gQmFja2JvbmUuUm91dGVyID0gZnVuY3Rpb24ob3B0aW9ucykgew0KICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7DQogICAgaWYgKG9wdGlvbnMucm91dGVzKSB0aGlzLnJvdXRlcyA9IG9wdGlvbnMucm91dGVzOw0KICAgIHRoaXMuX2JpbmRSb3V0ZXMoKTsNCiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCiAgfTsNCg0KICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkDQogIC8vIHBhcnRzIG9mIHJvdXRlIHN0cmluZ3MuDQogIHZhciBvcHRpb25hbFBhcmFtID0gL1woKC4qPylcKS9nOw0KICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7DQogIHZhciBzcGxhdFBhcmFtICAgID0gL1wqXHcrL2c7DQogIHZhciBlc2NhcGVSZWdFeHAgID0gL1tcLXt9XFtcXSs/LixcXFxeJHwjXHNdL2c7DQoNCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlJvdXRlcioqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuDQogIF8uZXh0ZW5kKFJvdXRlci5wcm90b3R5cGUsIEV2ZW50cywgew0KDQogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duDQogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuDQogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LA0KDQogICAgLy8gTWFudWFsbHkgYmluZCBhIHNpbmdsZSBuYW1lZCByb3V0ZSB0byBhIGNhbGxiYWNrLiBGb3IgZXhhbXBsZToNCiAgICAvLw0KICAgIC8vICAgICB0aGlzLnJvdXRlKCdzZWFyY2gvOnF1ZXJ5L3A6bnVtJywgJ3NlYXJjaCcsIGZ1bmN0aW9uKHF1ZXJ5LCBudW0pIHsNCiAgICAvLyAgICAgICAuLi4NCiAgICAvLyAgICAgfSk7DQogICAgLy8NCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIG5hbWUsIGNhbGxiYWNrKSB7DQogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOw0KICAgICAgaWYgKCFjYWxsYmFjaykgY2FsbGJhY2sgPSB0aGlzW25hbWVdOw0KICAgICAgQmFja2JvbmUuaGlzdG9yeS5yb3V0ZShyb3V0ZSwgXy5iaW5kKGZ1bmN0aW9uKGZyYWdtZW50KSB7DQogICAgICAgIHZhciBhcmdzID0gdGhpcy5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsNCiAgICAgICAgY2FsbGJhY2sgJiYgY2FsbGJhY2suYXBwbHkodGhpcywgYXJncyk7DQogICAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOicgKyBuYW1lXS5jb25jYXQoYXJncykpOw0KICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7DQogICAgICB9LCB0aGlzKSk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gU2ltcGxlIHByb3h5IHRvIGBCYWNrYm9uZS5oaXN0b3J5YCB0byBzYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGlzdG9yeS4NCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsNCiAgICAgIEJhY2tib25lLmhpc3RvcnkubmF2aWdhdGUoZnJhZ21lbnQsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIEJpbmQgYWxsIGRlZmluZWQgcm91dGVzIHRvIGBCYWNrYm9uZS5oaXN0b3J5YC4gV2UgaGF2ZSB0byByZXZlcnNlIHRoZQ0KICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwNCiAgICAvLyByb3V0ZXMgY2FuIGJlIGRlZmluZWQgYXQgdGhlIGJvdHRvbSBvZiB0aGUgcm91dGUgbWFwLg0KICAgIF9iaW5kUm91dGVzOiBmdW5jdGlvbigpIHsNCiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsNCiAgICAgIHZhciByb3V0ZSwgcm91dGVzID0gXy5rZXlzKHRoaXMucm91dGVzKTsNCiAgICAgIHdoaWxlICgocm91dGUgPSByb3V0ZXMucG9wKCkpICE9IG51bGwpIHsNCiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsNCiAgICAgIH0NCiAgICB9LA0KDQogICAgLy8gQ29udmVydCBhIHJvdXRlIHN0cmluZyBpbnRvIGEgcmVndWxhciBleHByZXNzaW9uLCBzdWl0YWJsZSBmb3IgbWF0Y2hpbmcNCiAgICAvLyBhZ2FpbnN0IHRoZSBjdXJyZW50IGxvY2F0aW9uIGhhc2guDQogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7DQogICAgICByb3V0ZSA9IHJvdXRlLnJlcGxhY2UoZXNjYXBlUmVnRXhwLCAnXFwkJicpDQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uob3B0aW9uYWxQYXJhbSwgJyg/OiQxKT8nKQ0KICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpDQogICAgICAgICAgICAgICAgICAgLnJlcGxhY2Uoc3BsYXRQYXJhbSwgJyguKj8pJyk7DQogICAgICByZXR1cm4gbmV3IFJlZ0V4cCgnXicgKyByb3V0ZSArICckJyk7DQogICAgfSwNCg0KICAgIC8vIEdpdmVuIGEgcm91dGUsIGFuZCBhIFVSTCBmcmFnbWVudCB0aGF0IGl0IG1hdGNoZXMsIHJldHVybiB0aGUgYXJyYXkgb2YNCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4NCiAgICBfZXh0cmFjdFBhcmFtZXRlcnM6IGZ1bmN0aW9uKHJvdXRlLCBmcmFnbWVudCkgew0KICAgICAgcmV0dXJuIHJvdXRlLmV4ZWMoZnJhZ21lbnQpLnNsaWNlKDEpOw0KICAgIH0NCg0KICB9KTsNCg0KICAvLyBCYWNrYm9uZS5IaXN0b3J5DQogIC8vIC0tLS0tLS0tLS0tLS0tLS0NCg0KICAvLyBIYW5kbGVzIGNyb3NzLWJyb3dzZXIgaGlzdG9yeSBtYW5hZ2VtZW50LCBiYXNlZCBvbiBVUkwgZnJhZ21lbnRzLiBJZiB0aGUNCiAgLy8gYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IGBvbmhhc2hjaGFuZ2VgLCBmYWxscyBiYWNrIHRvIHBvbGxpbmcuDQogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgew0KICAgIHRoaXMuaGFuZGxlcnMgPSBbXTsNCiAgICBfLmJpbmRBbGwodGhpcywgJ2NoZWNrVXJsJyk7DQoNCiAgICAvLyBFbnN1cmUgdGhhdCBgSGlzdG9yeWAgY2FuIGJlIHVzZWQgb3V0c2lkZSBvZiB0aGUgYnJvd3Nlci4NCiAgICBpZiAodHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247DQogICAgICB0aGlzLmhpc3RvcnkgPSB3aW5kb3cuaGlzdG9yeTsNCiAgICB9DQogIH07DQoNCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBzdHJpcHBpbmcgYSBsZWFkaW5nIGhhc2gvc2xhc2ggYW5kIHRyYWlsaW5nIHNwYWNlLg0KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOw0KDQogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoZXMuDQogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7DQoNCiAgLy8gQ2FjaGVkIHJlZ2V4IGZvciBkZXRlY3RpbmcgTVNJRS4NCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOw0KDQogIC8vIENhY2hlZCByZWdleCBmb3IgcmVtb3ZpbmcgYSB0cmFpbGluZyBzbGFzaC4NCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsNCg0KICAvLyBIYXMgdGhlIGhpc3RvcnkgaGFuZGxpbmcgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQ/DQogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOw0KDQogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5IaXN0b3J5KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4NCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgew0KDQogICAgLy8gVGhlIGRlZmF1bHQgaW50ZXJ2YWwgdG8gcG9sbCBmb3IgaGFzaCBjaGFuZ2VzLCBpZiBuZWNlc3NhcnksIGlzDQogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLg0KICAgIGludGVydmFsOiA1MCwNCg0KICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcNCiAgICAvLyBpbiBGaXJlZm94IHdoZXJlIGxvY2F0aW9uLmhhc2ggd2lsbCBhbHdheXMgYmUgZGVjb2RlZC4NCiAgICBnZXRIYXNoOiBmdW5jdGlvbih3aW5kb3cpIHsNCiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7DQogICAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6ICcnOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgdGhlIGNyb3NzLWJyb3dzZXIgbm9ybWFsaXplZCBVUkwgZnJhZ21lbnQsIGVpdGhlciBmcm9tIHRoZSBVUkwsDQogICAgLy8gdGhlIGhhc2gsIG9yIHRoZSBvdmVycmlkZS4NCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7DQogICAgICBpZiAoZnJhZ21lbnQgPT0gbnVsbCkgew0KICAgICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlIHx8ICF0aGlzLl93YW50c0hhc2hDaGFuZ2UgfHwgZm9yY2VQdXNoU3RhdGUpIHsNCiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7DQogICAgICAgICAgdmFyIHJvb3QgPSB0aGlzLnJvb3QucmVwbGFjZSh0cmFpbGluZ1NsYXNoLCAnJyk7DQogICAgICAgICAgaWYgKCFmcmFnbWVudC5pbmRleE9mKHJvb3QpKSBmcmFnbWVudCA9IGZyYWdtZW50LnN1YnN0cihyb290Lmxlbmd0aCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcmV0dXJuIGZyYWdtZW50LnJlcGxhY2Uocm91dGVTdHJpcHBlciwgJycpOw0KICAgIH0sDQoNCiAgICAvLyBTdGFydCB0aGUgaGFzaCBjaGFuZ2UgaGFuZGxpbmcsIHJldHVybmluZyBgdHJ1ZWAgaWYgdGhlIGN1cnJlbnQgVVJMIG1hdGNoZXMNCiAgICAvLyBhbiBleGlzdGluZyByb3V0ZSwgYW5kIGBmYWxzZWAgb3RoZXJ3aXNlLg0KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICBpZiAoSGlzdG9yeS5zdGFydGVkKSB0aHJvdyBuZXcgRXJyb3IoIkJhY2tib25lLmhpc3RvcnkgaGFzIGFscmVhZHkgYmVlbiBzdGFydGVkIik7DQogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSB0cnVlOw0KDQogICAgICAvLyBGaWd1cmUgb3V0IHRoZSBpbml0aWFsIGNvbmZpZ3VyYXRpb24uIERvIHdlIG5lZWQgYW4gaWZyYW1lPw0KICAgICAgLy8gSXMgcHVzaFN0YXRlIGRlc2lyZWQgLi4uIGlzIGl0IGF2YWlsYWJsZT8NCiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsNCiAgICAgIHRoaXMucm9vdCAgICAgICAgICAgICA9IHRoaXMub3B0aW9ucy5yb290Ow0KICAgICAgdGhpcy5fd2FudHNIYXNoQ2hhbmdlID0gdGhpcy5vcHRpb25zLmhhc2hDaGFuZ2UgIT09IGZhbHNlOw0KICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOw0KICAgICAgdGhpcy5faGFzUHVzaFN0YXRlICAgID0gISEodGhpcy5vcHRpb25zLnB1c2hTdGF0ZSAmJiB0aGlzLmhpc3RvcnkgJiYgdGhpcy5oaXN0b3J5LnB1c2hTdGF0ZSk7DQogICAgICB2YXIgZnJhZ21lbnQgICAgICAgICAgPSB0aGlzLmdldEZyYWdtZW50KCk7DQogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7DQogICAgICB2YXIgb2xkSUUgICAgICAgICAgICAgPSAoaXNFeHBsb3Jlci5leGVjKG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSkgJiYgKCFkb2NNb2RlIHx8IGRvY01vZGUgPD0gNykpOw0KDQogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLg0KICAgICAgdGhpcy5yb290ID0gKCcvJyArIHRoaXMucm9vdCArICcvJykucmVwbGFjZShyb290U3RyaXBwZXIsICcvJyk7DQoNCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsNCiAgICAgICAgdGhpcy5pZnJhbWUgPSBCYWNrYm9uZS4kKCc8aWZyYW1lIHNyYz0iamF2YXNjcmlwdDowIiB0YWJpbmRleD0iLTEiIC8+JykuaGlkZSgpLmFwcGVuZFRvKCdib2R5JylbMF0uY29udGVudFdpbmRvdzsNCiAgICAgICAgdGhpcy5uYXZpZ2F0ZShmcmFnbWVudCk7DQogICAgICB9DQoNCiAgICAgIC8vIERlcGVuZGluZyBvbiB3aGV0aGVyIHdlJ3JlIHVzaW5nIHB1c2hTdGF0ZSBvciBoYXNoZXMsIGFuZCB3aGV0aGVyDQogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4NCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsNCiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCk7DQogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsNCiAgICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsNCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7DQogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsNCiAgICAgIH0NCg0KICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsNCiAgICAgIC8vIG9wZW5lZCBieSBhIG5vbi1wdXNoU3RhdGUgYnJvd3Nlci4NCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsNCiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOw0KICAgICAgdmFyIGF0Um9vdCA9IGxvYy5wYXRobmFtZS5yZXBsYWNlKC9bXlwvXSQvLCAnJCYvJykgPT09IHRoaXMucm9vdDsNCg0KICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkIGJyb3dzZXIsDQogICAgICAvLyBidXQgd2UncmUgY3VycmVudGx5IGluIGEgYnJvd3NlciB0aGF0IGRvZXNuJ3Qgc3VwcG9ydCBpdC4uLg0KICAgICAgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiB0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiAhdGhpcy5faGFzUHVzaFN0YXRlICYmICFhdFJvb3QpIHsNCiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7DQogICAgICAgIHRoaXMubG9jYXRpb24ucmVwbGFjZSh0aGlzLnJvb3QgKyB0aGlzLmxvY2F0aW9uLnNlYXJjaCArICcjJyArIHRoaXMuZnJhZ21lbnQpOw0KICAgICAgICAvLyBSZXR1cm4gaW1tZWRpYXRlbHkgYXMgYnJvd3NlciB3aWxsIGRvIHJlZGlyZWN0IHRvIG5ldyB1cmwNCiAgICAgICAgcmV0dXJuIHRydWU7DQoNCiAgICAgIC8vIE9yIGlmIHdlJ3ZlIHN0YXJ0ZWQgb3V0IHdpdGggYSBoYXNoLWJhc2VkIHJvdXRlLCBidXQgd2UncmUgY3VycmVudGx5DQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLg0KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c1B1c2hTdGF0ZSAmJiB0aGlzLl9oYXNQdXNoU3RhdGUgJiYgYXRSb290ICYmIGxvYy5oYXNoKSB7DQogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEhhc2goKS5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsNCiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsNCiAgICAgIH0NCg0KICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7DQogICAgfSwNCg0KICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLA0KICAgIC8vIGJ1dCBwb3NzaWJseSB1c2VmdWwgZm9yIHVuaXQgdGVzdGluZyBSb3V0ZXJzLg0KICAgIHN0b3A6IGZ1bmN0aW9uKCkgew0KICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLnVuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS51bmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsNCiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5fY2hlY2tVcmxJbnRlcnZhbCk7DQogICAgICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsNCiAgICB9LA0KDQogICAgLy8gQWRkIGEgcm91dGUgdG8gYmUgdGVzdGVkIHdoZW4gdGhlIGZyYWdtZW50IGNoYW5nZXMuIFJvdXRlcyBhZGRlZCBsYXRlcg0KICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuDQogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBjYWxsYmFjaykgew0KICAgICAgdGhpcy5oYW5kbGVycy51bnNoaWZ0KHtyb3V0ZTogcm91dGUsIGNhbGxiYWNrOiBjYWxsYmFja30pOw0KICAgIH0sDQoNCiAgICAvLyBDaGVja3MgdGhlIGN1cnJlbnQgVVJMIHRvIHNlZSBpZiBpdCBoYXMgY2hhbmdlZCwgYW5kIGlmIGl0IGhhcywNCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4NCiAgICBjaGVja1VybDogZnVuY3Rpb24oZSkgew0KICAgICAgdmFyIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KCk7DQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgew0KICAgICAgICBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCh0aGlzLmdldEhhc2godGhpcy5pZnJhbWUpKTsNCiAgICAgIH0NCiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7DQogICAgICBpZiAodGhpcy5pZnJhbWUpIHRoaXMubmF2aWdhdGUoY3VycmVudCk7DQogICAgICB0aGlzLmxvYWRVcmwoKSB8fCB0aGlzLmxvYWRVcmwodGhpcy5nZXRIYXNoKCkpOw0KICAgIH0sDQoNCiAgICAvLyBBdHRlbXB0IHRvIGxvYWQgdGhlIGN1cnJlbnQgVVJMIGZyYWdtZW50LiBJZiBhIHJvdXRlIHN1Y2NlZWRzIHdpdGggYQ0KICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsDQogICAgLy8gcmV0dXJucyBgZmFsc2VgLg0KICAgIGxvYWRVcmw6IGZ1bmN0aW9uKGZyYWdtZW50T3ZlcnJpZGUpIHsNCiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50T3ZlcnJpZGUpOw0KICAgICAgdmFyIG1hdGNoZWQgPSBfLmFueSh0aGlzLmhhbmRsZXJzLCBmdW5jdGlvbihoYW5kbGVyKSB7DQogICAgICAgIGlmIChoYW5kbGVyLnJvdXRlLnRlc3QoZnJhZ21lbnQpKSB7DQogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7DQogICAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICAgIH0NCiAgICAgIH0pOw0KICAgICAgcmV0dXJuIG1hdGNoZWQ7DQogICAgfSwNCg0KICAgIC8vIFNhdmUgYSBmcmFnbWVudCBpbnRvIHRoZSBoYXNoIGhpc3RvcnksIG9yIHJlcGxhY2UgdGhlIFVSTCBzdGF0ZSBpZiB0aGUNCiAgICAvLyAncmVwbGFjZScgb3B0aW9uIGlzIHBhc3NlZC4gWW91IGFyZSByZXNwb25zaWJsZSBmb3IgcHJvcGVybHkgVVJMLWVuY29kaW5nDQogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuDQogICAgLy8NCiAgICAvLyBUaGUgb3B0aW9ucyBvYmplY3QgY2FuIGNvbnRhaW4gYHRyaWdnZXI6IHRydWVgIGlmIHlvdSB3aXNoIHRvIGhhdmUgdGhlDQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYNCiAgICAvLyB5b3Ugd2lzaCB0byBtb2RpZnkgdGhlIGN1cnJlbnQgVVJMIHdpdGhvdXQgYWRkaW5nIGFuIGVudHJ5IHRvIHRoZSBoaXN0b3J5Lg0KICAgIG5hdmlnYXRlOiBmdW5jdGlvbihmcmFnbWVudCwgb3B0aW9ucykgew0KICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsNCiAgICAgIGlmICghb3B0aW9ucyB8fCBvcHRpb25zID09PSB0cnVlKSBvcHRpb25zID0ge3RyaWdnZXI6IG9wdGlvbnN9Ow0KICAgICAgZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50IHx8ICcnKTsNCiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOw0KICAgICAgdGhpcy5mcmFnbWVudCA9IGZyYWdtZW50Ow0KICAgICAgdmFyIHVybCA9IHRoaXMucm9vdCArIGZyYWdtZW50Ow0KDQogICAgICAvLyBJZiBwdXNoU3RhdGUgaXMgYXZhaWxhYmxlLCB3ZSB1c2UgaXQgdG8gc2V0IHRoZSBmcmFnbWVudCBhcyBhIHJlYWwgVVJMLg0KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgew0KICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOw0KDQogICAgICAvLyBJZiBoYXNoIGNoYW5nZXMgaGF2ZW4ndCBiZWVuIGV4cGxpY2l0bHkgZGlzYWJsZWQsIHVwZGF0ZSB0aGUgaGFzaA0KICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4NCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7DQogICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7DQogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7DQogICAgICAgICAgLy8gT3BlbmluZyBhbmQgY2xvc2luZyB0aGUgaWZyYW1lIHRyaWNrcyBJRTcgYW5kIGVhcmxpZXIgdG8gcHVzaCBhDQogICAgICAgICAgLy8gaGlzdG9yeSBlbnRyeSBvbiBoYXNoLXRhZyBjaGFuZ2UuICBXaGVuIHJlcGxhY2UgaXMgdHJ1ZSwgd2UgZG9uJ3QNCiAgICAgICAgICAvLyB3YW50IHRoaXMuDQogICAgICAgICAgaWYoIW9wdGlvbnMucmVwbGFjZSkgdGhpcy5pZnJhbWUuZG9jdW1lbnQub3BlbigpLmNsb3NlKCk7DQogICAgICAgICAgdGhpcy5fdXBkYXRlSGFzaCh0aGlzLmlmcmFtZS5sb2NhdGlvbiwgZnJhZ21lbnQsIG9wdGlvbnMucmVwbGFjZSk7DQogICAgICAgIH0NCg0KICAgICAgLy8gSWYgeW91J3ZlIHRvbGQgdXMgdGhhdCB5b3UgZXhwbGljaXRseSBkb24ndCB3YW50IGZhbGxiYWNrIGhhc2hjaGFuZ2UtDQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4NCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiB0aGlzLmxvY2F0aW9uLmFzc2lnbih1cmwpOw0KICAgICAgfQ0KICAgICAgaWYgKG9wdGlvbnMudHJpZ2dlcikgdGhpcy5sb2FkVXJsKGZyYWdtZW50KTsNCiAgICB9LA0KDQogICAgLy8gVXBkYXRlIHRoZSBoYXNoIGxvY2F0aW9uLCBlaXRoZXIgcmVwbGFjaW5nIHRoZSBjdXJyZW50IGVudHJ5LCBvciBhZGRpbmcNCiAgICAvLyBhIG5ldyBvbmUgdG8gdGhlIGJyb3dzZXIgaGlzdG9yeS4NCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7DQogICAgICBpZiAocmVwbGFjZSkgew0KICAgICAgICB2YXIgaHJlZiA9IGxvY2F0aW9uLmhyZWYucmVwbGFjZSgvKGphdmFzY3JpcHQ6fCMpLiokLywgJycpOw0KICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAvLyBTb21lIGJyb3dzZXJzIHJlcXVpcmUgdGhhdCBgaGFzaGAgY29udGFpbnMgYSBsZWFkaW5nICMuDQogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsNCiAgICAgIH0NCiAgICB9DQoNCiAgfSk7DQoNCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuDQogIEJhY2tib25lLmhpc3RvcnkgPSBuZXcgSGlzdG9yeTsNCg0KICAvLyBCYWNrYm9uZS5WaWV3DQogIC8vIC0tLS0tLS0tLS0tLS0NCg0KICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwNCiAgLy8gaWYgYW4gZXhpc3RpbmcgZWxlbWVudCBpcyBub3QgcHJvdmlkZWQuLi4NCiAgdmFyIFZpZXcgPSBCYWNrYm9uZS5WaWV3ID0gZnVuY3Rpb24ob3B0aW9ucykgew0KICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOw0KICAgIHRoaXMuX2NvbmZpZ3VyZShvcHRpb25zIHx8IHt9KTsNCiAgICB0aGlzLl9lbnN1cmVFbGVtZW50KCk7DQogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOw0KICB9Ow0KDQogIC8vIENhY2hlZCByZWdleCB0byBzcGxpdCBrZXlzIGZvciBgZGVsZWdhdGVgLg0KICB2YXIgZGVsZWdhdGVFdmVudFNwbGl0dGVyID0gL14oXFMrKVxzKiguKikkLzsNCg0KICAvLyBMaXN0IG9mIHZpZXcgb3B0aW9ucyB0byBiZSBtZXJnZWQgYXMgcHJvcGVydGllcy4NCiAgdmFyIHZpZXdPcHRpb25zID0gWydtb2RlbCcsICdjb2xsZWN0aW9uJywgJ2VsJywgJ2lkJywgJ2F0dHJpYnV0ZXMnLCAnY2xhc3NOYW1lJywgJ3RhZ05hbWUnLCAnZXZlbnRzJ107DQoNCiAgLy8gU2V0IHVwIGFsbCBpbmhlcml0YWJsZSAqKkJhY2tib25lLlZpZXcqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLg0KICBfLmV4dGVuZChWaWV3LnByb3RvdHlwZSwgRXZlbnRzLCB7DQoNCiAgICAvLyBUaGUgZGVmYXVsdCBgdGFnTmFtZWAgb2YgYSBWaWV3J3MgZWxlbWVudCBpcyBgImRpdiJgLg0KICAgIHRhZ05hbWU6ICdkaXYnLA0KDQogICAgLy8galF1ZXJ5IGRlbGVnYXRlIGZvciBlbGVtZW50IGxvb2t1cCwgc2NvcGVkIHRvIERPTSBlbGVtZW50cyB3aXRoaW4gdGhlDQogICAgLy8gY3VycmVudCB2aWV3LiBUaGlzIHNob3VsZCBiZSBwcmVmZXJlZCB0byBnbG9iYWwgbG9va3VwcyB3aGVyZSBwb3NzaWJsZS4NCiAgICAkOiBmdW5jdGlvbihzZWxlY3Rvcikgew0KICAgICAgcmV0dXJuIHRoaXMuJGVsLmZpbmQoc2VsZWN0b3IpOw0KICAgIH0sDQoNCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24NCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4NCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sDQoNCiAgICAvLyAqKnJlbmRlcioqIGlzIHRoZSBjb3JlIGZ1bmN0aW9uIHRoYXQgeW91ciB2aWV3IHNob3VsZCBvdmVycmlkZSwgaW4gb3JkZXINCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlDQogICAgLy8gY29udmVudGlvbiBpcyBmb3IgKipyZW5kZXIqKiB0byBhbHdheXMgcmV0dXJuIGB0aGlzYC4NCiAgICByZW5kZXI6IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55DQogICAgLy8gYXBwbGljYWJsZSBCYWNrYm9uZS5FdmVudHMgbGlzdGVuZXJzLg0KICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7DQogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsNCiAgICAgIHRoaXMuc3RvcExpc3RlbmluZygpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIEZvciBzbWFsbCBhbW91bnRzIG9mIERPTSBFbGVtZW50cywgd2hlcmUgYSBmdWxsLWJsb3duIHRlbXBsYXRlIGlzbid0DQogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuDQogICAgLy8NCiAgICAvLyAgICAgdmFyIGVsID0gdGhpcy5tYWtlKCdsaScsIHsnY2xhc3MnOiAncm93J30sIHRoaXMubW9kZWwuZXNjYXBlKCd0aXRsZScpKTsNCiAgICAvLw0KICAgIG1ha2U6IGZ1bmN0aW9uKHRhZ05hbWUsIGF0dHJpYnV0ZXMsIGNvbnRlbnQpIHsNCiAgICAgIHZhciBlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnTmFtZSk7DQogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsNCiAgICAgIGlmIChjb250ZW50ICE9IG51bGwpIEJhY2tib25lLiQoZWwpLmh0bWwoY29udGVudCk7DQogICAgICByZXR1cm4gZWw7DQogICAgfSwNCg0KICAgIC8vIENoYW5nZSB0aGUgdmlldydzIGVsZW1lbnQgKGB0aGlzLmVsYCBwcm9wZXJ0eSksIGluY2x1ZGluZyBldmVudA0KICAgIC8vIHJlLWRlbGVnYXRpb24uDQogICAgc2V0RWxlbWVudDogZnVuY3Rpb24oZWxlbWVudCwgZGVsZWdhdGUpIHsNCiAgICAgIGlmICh0aGlzLiRlbCkgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7DQogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7DQogICAgICB0aGlzLmVsID0gdGhpcy4kZWxbMF07DQogICAgICBpZiAoZGVsZWdhdGUgIT09IGZhbHNlKSB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YNCiAgICAvLw0KICAgIC8vICp7ImV2ZW50IHNlbGVjdG9yIjogImNhbGxiYWNrIn0qDQogICAgLy8NCiAgICAvLyAgICAgew0KICAgIC8vICAgICAgICdtb3VzZWRvd24gLnRpdGxlJzogICdlZGl0JywNCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScNCiAgICAvLyAgICAgICAnY2xpY2sgLm9wZW4nOiAgICAgICBmdW5jdGlvbihlKSB7IC4uLiB9DQogICAgLy8gICAgIH0NCiAgICAvLw0KICAgIC8vIHBhaXJzLiBDYWxsYmFja3Mgd2lsbCBiZSBib3VuZCB0byB0aGUgdmlldywgd2l0aCBgdGhpc2Agc2V0IHByb3Blcmx5Lg0KICAgIC8vIFVzZXMgZXZlbnQgZGVsZWdhdGlvbiBmb3IgZWZmaWNpZW5jeS4NCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4NCiAgICAvLyBUaGlzIG9ubHkgd29ya3MgZm9yIGRlbGVnYXRlLWFibGUgZXZlbnRzOiBub3QgYGZvY3VzYCwgYGJsdXJgLCBhbmQNCiAgICAvLyBub3QgYGNoYW5nZWAsIGBzdWJtaXRgLCBhbmQgYHJlc2V0YCBpbiBJbnRlcm5ldCBFeHBsb3Jlci4NCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7DQogICAgICBpZiAoIShldmVudHMgfHwgKGV2ZW50cyA9IF8ucmVzdWx0KHRoaXMsICdldmVudHMnKSkpKSByZXR1cm47DQogICAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsNCiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsNCiAgICAgICAgdmFyIG1ldGhvZCA9IGV2ZW50c1trZXldOw0KICAgICAgICBpZiAoIV8uaXNGdW5jdGlvbihtZXRob2QpKSBtZXRob2QgPSB0aGlzW2V2ZW50c1trZXldXTsNCiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOw0KICAgICAgICB2YXIgbWF0Y2ggPSBrZXkubWF0Y2goZGVsZWdhdGVFdmVudFNwbGl0dGVyKTsNCiAgICAgICAgdmFyIGV2ZW50TmFtZSA9IG1hdGNoWzFdLCBzZWxlY3RvciA9IG1hdGNoWzJdOw0KICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsNCiAgICAgICAgZXZlbnROYW1lICs9ICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7DQogICAgICAgIGlmIChzZWxlY3RvciA9PT0gJycpIHsNCiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICB0aGlzLiRlbC5kZWxlZ2F0ZShzZWxlY3RvciwgZXZlbnROYW1lLCBtZXRob2QpOw0KICAgICAgICB9DQogICAgICB9DQogICAgfSwNCg0KICAgIC8vIENsZWFycyBhbGwgY2FsbGJhY2tzIHByZXZpb3VzbHkgYm91bmQgdG8gdGhlIHZpZXcgd2l0aCBgZGVsZWdhdGVFdmVudHNgLg0KICAgIC8vIFlvdSB1c3VhbGx5IGRvbid0IG5lZWQgdG8gdXNlIHRoaXMsIGJ1dCBtYXkgd2lzaCB0byBpZiB5b3UgaGF2ZSBtdWx0aXBsZQ0KICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50Lg0KICAgIHVuZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKCkgew0KICAgICAgdGhpcy4kZWwudW5iaW5kKCcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQpOw0KICAgIH0sDQoNCiAgICAvLyBQZXJmb3JtcyB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uIG9mIGEgVmlldyB3aXRoIGEgc2V0IG9mIG9wdGlvbnMuDQogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQ0KICAgIC8vIGF0dGFjaGVkIGRpcmVjdGx5IHRvIHRoZSB2aWV3Lg0KICAgIF9jb25maWd1cmU6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7DQogICAgICBfLmV4dGVuZCh0aGlzLCBfLnBpY2sob3B0aW9ucywgdmlld09wdGlvbnMpKTsNCiAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7DQogICAgfSwNCg0KICAgIC8vIEVuc3VyZSB0aGF0IHRoZSBWaWV3IGhhcyBhIERPTSBlbGVtZW50IHRvIHJlbmRlciBpbnRvLg0KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdA0KICAgIC8vIG1hdGNoaW5nIGVsZW1lbnQsIGFuZCByZS1hc3NpZ24gaXQgdG8gYGVsYC4gT3RoZXJ3aXNlLCBjcmVhdGUNCiAgICAvLyBhbiBlbGVtZW50IGZyb20gdGhlIGBpZGAsIGBjbGFzc05hbWVgIGFuZCBgdGFnTmFtZWAgcHJvcGVydGllcy4NCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7DQogICAgICBpZiAoIXRoaXMuZWwpIHsNCiAgICAgICAgdmFyIGF0dHJzID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdhdHRyaWJ1dGVzJykpOw0KICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsNCiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKSBhdHRyc1snY2xhc3MnXSA9IF8ucmVzdWx0KHRoaXMsICdjbGFzc05hbWUnKTsNCiAgICAgICAgdGhpcy5zZXRFbGVtZW50KHRoaXMubWFrZShfLnJlc3VsdCh0aGlzLCAndGFnTmFtZScpLCBhdHRycyksIGZhbHNlKTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHRoaXMuc2V0RWxlbWVudChfLnJlc3VsdCh0aGlzLCAnZWwnKSwgZmFsc2UpOw0KICAgICAgfQ0KICAgIH0NCg0KICB9KTsNCg0KICAvLyBCYWNrYm9uZS5zeW5jDQogIC8vIC0tLS0tLS0tLS0tLS0NCg0KICAvLyBNYXAgZnJvbSBDUlVEIHRvIEhUVFAgZm9yIG91ciBkZWZhdWx0IGBCYWNrYm9uZS5zeW5jYCBpbXBsZW1lbnRhdGlvbi4NCiAgdmFyIG1ldGhvZE1hcCA9IHsNCiAgICAnY3JlYXRlJzogJ1BPU1QnLA0KICAgICd1cGRhdGUnOiAnUFVUJywNCiAgICAncGF0Y2gnOiAgJ1BBVENIJywNCiAgICAnZGVsZXRlJzogJ0RFTEVURScsDQogICAgJ3JlYWQnOiAgICdHRVQnDQogIH07DQoNCiAgLy8gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbiB0byBjaGFuZ2UgdGhlIG1hbm5lciBpbiB3aGljaCBCYWNrYm9uZSBwZXJzaXN0cw0KICAvLyBtb2RlbHMgdG8gdGhlIHNlcnZlci4gWW91IHdpbGwgYmUgcGFzc2VkIHRoZSB0eXBlIG9mIHJlcXVlc3QsIGFuZCB0aGUNCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QNCiAgLy8gdG8gdGhlIG1vZGVsJ3MgYHVybCgpYC4gU29tZSBwb3NzaWJsZSBjdXN0b21pemF0aW9ucyBjb3VsZCBiZToNCiAgLy8NCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuDQogIC8vICogU2VuZCB1cCB0aGUgbW9kZWxzIGFzIFhNTCBpbnN0ZWFkIG9mIEpTT04uDQogIC8vICogUGVyc2lzdCBtb2RlbHMgdmlhIFdlYlNvY2tldHMgaW5zdGVhZCBvZiBBamF4Lg0KICAvLw0KICAvLyBUdXJuIG9uIGBCYWNrYm9uZS5lbXVsYXRlSFRUUGAgaW4gb3JkZXIgdG8gc2VuZCBgUFVUYCBhbmQgYERFTEVURWAgcmVxdWVzdHMNCiAgLy8gYXMgYFBPU1RgLCB3aXRoIGEgYF9tZXRob2RgIHBhcmFtZXRlciBjb250YWluaW5nIHRoZSB0cnVlIEhUVFAgbWV0aG9kLA0KICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgDQogIC8vIGluc3RlYWQgb2YgYGFwcGxpY2F0aW9uL2pzb25gIHdpdGggdGhlIG1vZGVsIGluIGEgcGFyYW0gbmFtZWQgYG1vZGVsYC4NCiAgLy8gVXNlZnVsIHdoZW4gaW50ZXJmYWNpbmcgd2l0aCBzZXJ2ZXItc2lkZSBsYW5ndWFnZXMgbGlrZSAqKlBIUCoqIHRoYXQgbWFrZQ0KICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4NCiAgQmFja2JvbmUuc3luYyA9IGZ1bmN0aW9uKG1ldGhvZCwgbW9kZWwsIG9wdGlvbnMpIHsNCiAgICB2YXIgdHlwZSA9IG1ldGhvZE1hcFttZXRob2RdOw0KDQogICAgLy8gRGVmYXVsdCBvcHRpb25zLCB1bmxlc3Mgc3BlY2lmaWVkLg0KICAgIF8uZGVmYXVsdHMob3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KSwgew0KICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLA0KICAgICAgZW11bGF0ZUpTT046IEJhY2tib25lLmVtdWxhdGVKU09ODQogICAgfSk7DQoNCiAgICAvLyBEZWZhdWx0IEpTT04tcmVxdWVzdCBvcHRpb25zLg0KICAgIHZhciBwYXJhbXMgPSB7dHlwZTogdHlwZSwgZGF0YVR5cGU6ICdqc29uJ307DQoNCiAgICAvLyBFbnN1cmUgdGhhdCB3ZSBoYXZlIGEgVVJMLg0KICAgIGlmICghb3B0aW9ucy51cmwpIHsNCiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7DQogICAgfQ0KDQogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLg0KICAgIGlmIChvcHRpb25zLmRhdGEgPT0gbnVsbCAmJiBtb2RlbCAmJiAobWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnIHx8IG1ldGhvZCA9PT0gJ3BhdGNoJykpIHsNCiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJzsNCiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOw0KICAgIH0NCg0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uDQogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHsNCiAgICAgIHBhcmFtcy5jb250ZW50VHlwZSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnOw0KICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307DQogICAgfQ0KDQogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgDQogICAgLy8gQW5kIGFuIGBYLUhUVFAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuDQogICAgaWYgKG9wdGlvbnMuZW11bGF0ZUhUVFAgJiYgKHR5cGUgPT09ICdQVVQnIHx8IHR5cGUgPT09ICdERUxFVEUnIHx8IHR5cGUgPT09ICdQQVRDSCcpKSB7DQogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsNCiAgICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSBwYXJhbXMuZGF0YS5fbWV0aG9kID0gdHlwZTsNCiAgICAgIHZhciBiZWZvcmVTZW5kID0gb3B0aW9ucy5iZWZvcmVTZW5kOw0KICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7DQogICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdYLUhUVFAtTWV0aG9kLU92ZXJyaWRlJywgdHlwZSk7DQogICAgICAgIGlmIChiZWZvcmVTZW5kKSByZXR1cm4gYmVmb3JlU2VuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgICAgfTsNCiAgICB9DQoNCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuDQogICAgaWYgKHBhcmFtcy50eXBlICE9PSAnR0VUJyAmJiAhb3B0aW9ucy5lbXVsYXRlSlNPTikgew0KICAgICAgcGFyYW1zLnByb2Nlc3NEYXRhID0gZmFsc2U7DQogICAgfQ0KDQogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7DQogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsNCiAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKHJlc3AsIHN0YXR1cywgeGhyKTsNCiAgICAgIG1vZGVsLnRyaWdnZXIoJ3N5bmMnLCBtb2RlbCwgcmVzcCwgb3B0aW9ucyk7DQogICAgfTsNCg0KICAgIHZhciBlcnJvciA9IG9wdGlvbnMuZXJyb3I7DQogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHhociwgc3RhdHVzLCB0aHJvd24pIHsNCiAgICAgIGlmIChlcnJvcikgZXJyb3IobW9kZWwsIHhociwgb3B0aW9ucyk7DQogICAgICBtb2RlbC50cmlnZ2VyKCdlcnJvcicsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOw0KICAgIH07DQoNCiAgICAvLyBNYWtlIHRoZSByZXF1ZXN0LCBhbGxvd2luZyB0aGUgdXNlciB0byBvdmVycmlkZSBhbnkgQWpheCBvcHRpb25zLg0KICAgIHZhciB4aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOw0KICAgIG1vZGVsLnRyaWdnZXIoJ3JlcXVlc3QnLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsNCiAgICByZXR1cm4geGhyOw0KICB9Ow0KDQogIC8vIFNldCB0aGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBgQmFja2JvbmUuYWpheGAgdG8gcHJveHkgdGhyb3VnaCB0byBgJGAuDQogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsNCiAgICByZXR1cm4gQmFja2JvbmUuJC5hamF4LmFwcGx5KEJhY2tib25lLiQsIGFyZ3VtZW50cyk7DQogIH07DQoNCiAgLy8gSGVscGVycw0KICAvLyAtLS0tLS0tDQoNCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvcnJlY3RseSBzZXQgdXAgdGhlIHByb3RvdHlwZSBjaGFpbiwgZm9yIHN1YmNsYXNzZXMuDQogIC8vIFNpbWlsYXIgdG8gYGdvb2cuaW5oZXJpdHNgLCBidXQgdXNlcyBhIGhhc2ggb2YgcHJvdG90eXBlIHByb3BlcnRpZXMgYW5kDQogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuDQogIHZhciBleHRlbmQgPSBmdW5jdGlvbihwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgew0KICAgIHZhciBwYXJlbnQgPSB0aGlzOw0KICAgIHZhciBjaGlsZDsNCg0KICAgIC8vIFRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiBmb3IgdGhlIG5ldyBzdWJjbGFzcyBpcyBlaXRoZXIgZGVmaW5lZCBieSB5b3UNCiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkDQogICAgLy8gYnkgdXMgdG8gc2ltcGx5IGNhbGwgdGhlIHBhcmVudCdzIGNvbnN0cnVjdG9yLg0KICAgIGlmIChwcm90b1Byb3BzICYmIF8uaGFzKHByb3RvUHJvcHMsICdjb25zdHJ1Y3RvcicpKSB7DQogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7DQogICAgfSBlbHNlIHsNCiAgICAgIGNoaWxkID0gZnVuY3Rpb24oKXsgcGFyZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7IH07DQogICAgfQ0KDQogICAgLy8gQWRkIHN0YXRpYyBwcm9wZXJ0aWVzIHRvIHRoZSBjb25zdHJ1Y3RvciBmdW5jdGlvbiwgaWYgc3VwcGxpZWQuDQogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOw0KDQogICAgLy8gU2V0IHRoZSBwcm90b3R5cGUgY2hhaW4gdG8gaW5oZXJpdCBmcm9tIGBwYXJlbnRgLCB3aXRob3V0IGNhbGxpbmcNCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLg0KICAgIHZhciBTdXJyb2dhdGUgPSBmdW5jdGlvbigpeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH07DQogICAgU3Vycm9nYXRlLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7DQogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsNCg0KICAgIC8vIEFkZCBwcm90b3R5cGUgcHJvcGVydGllcyAoaW5zdGFuY2UgcHJvcGVydGllcykgdG8gdGhlIHN1YmNsYXNzLA0KICAgIC8vIGlmIHN1cHBsaWVkLg0KICAgIGlmIChwcm90b1Byb3BzKSBfLmV4dGVuZChjaGlsZC5wcm90b3R5cGUsIHByb3RvUHJvcHMpOw0KDQogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZA0KICAgIC8vIGxhdGVyLg0KICAgIGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7DQoNCiAgICByZXR1cm4gY2hpbGQ7DQogIH07DQoNCiAgLy8gU2V0IHVwIGluaGVyaXRhbmNlIGZvciB0aGUgbW9kZWwsIGNvbGxlY3Rpb24sIHJvdXRlciwgdmlldyBhbmQgaGlzdG9yeS4NCiAgTW9kZWwuZXh0ZW5kID0gQ29sbGVjdGlvbi5leHRlbmQgPSBSb3V0ZXIuZXh0ZW5kID0gVmlldy5leHRlbmQgPSBIaXN0b3J5LmV4dGVuZCA9IGV4dGVuZDsNCg0KICAvLyBUaHJvdyBhbiBlcnJvciB3aGVuIGEgVVJMIGlzIG5lZWRlZCwgYW5kIG5vbmUgaXMgc3VwcGxpZWQuDQogIHZhciB1cmxFcnJvciA9IGZ1bmN0aW9uKCkgew0KICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOw0KICB9Ow0KDQp9KS5jYWxsKHRoaXMpOw==",
                "body": "Ly8gICAgIEJhY2tib25lLmpzIDAuOS45DQoNCi8vICAgICAoYykgMjAxMC0yMDEyIEplcmVteSBBc2hrZW5hcywgRG9jdW1lbnRDbG91ZCBJbmMuDQovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuDQovLyAgICAgRm9yIGFsbCBkZXRhaWxzIGFuZCBkb2N1bWVudGF0aW9uOg0KLy8gICAgIGh0dHA6Ly9iYWNrYm9uZWpzLm9yZw0KDQooZnVuY3Rpb24oKXsNCg0KICAvLyBJbml0aWFsIFNldHVwDQogIC8vIC0tLS0tLS0tLS0tLS0NCg0KICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgDQogIC8vIG9uIHRoZSBzZXJ2ZXIpLg0KICB2YXIgcm9vdCA9IHRoaXM7DQoNCiAgLy8gU2F2ZSB0aGUgcHJldmlvdXMgdmFsdWUgb2YgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUsIHNvIHRoYXQgaXQgY2FuIGJlDQogIC8vIHJlc3RvcmVkIGxhdGVyIG9uLCBpZiBgbm9Db25mbGljdGAgaXMgdXNlZC4NCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOw0KDQogIC8vIENyZWF0ZSBhIGxvY2FsIHJlZmVyZW5jZSB0byBhcnJheSBtZXRob2RzLg0KICB2YXIgYXJyYXkgPSBbXTsNCiAgdmFyIHB1c2ggPSBhcnJheS5wdXNoOw0KICB2YXIgc2xpY2UgPSBhcnJheS5zbGljZTsNCiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsNCg0KICAvLyBUaGUgdG9wLWxldmVsIG5hbWVzcGFjZS4gQWxsIHB1YmxpYyBCYWNrYm9uZSBjbGFzc2VzIGFuZCBtb2R1bGVzIHdpbGwNCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggQ29tbW9uSlMgYW5kIHRoZSBicm93c2VyLg0KICB2YXIgQmFja2JvbmU7DQogIGlmICh0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsNCiAgICBCYWNrYm9uZSA9IGV4cG9ydHM7DQogIH0gZWxzZSB7DQogICAgQmFja2JvbmUgPSByb290LkJhY2tib25lID0ge307DQogIH0NCg0KICAvLyBDdXJyZW50IHZlcnNpb24gb2YgdGhlIGxpYnJhcnkuIEtlZXAgaW4gc3luYyB3aXRoIGBwYWNrYWdlLmpzb25gLg0KICBCYWNrYm9uZS5WRVJTSU9OID0gJzAuOS45JzsNCg0KICAvLyBSZXF1aXJlIFVuZGVyc2NvcmUsIGlmIHdlJ3JlIG9uIHRoZSBzZXJ2ZXIsIGFuZCBpdCdzIG5vdCBhbHJlYWR5IHByZXNlbnQuDQogIHZhciBfID0gcm9vdC5fOw0KICBpZiAoIV8gJiYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJykpIF8gPSByZXF1aXJlKCd1bmRlcnNjb3JlJyk7DQoNCiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIG9yIEVuZGVyIG93bnMgdGhlIGAkYCB2YXJpYWJsZS4NCiAgQmFja2JvbmUuJCA9IHJvb3QualF1ZXJ5IHx8IHJvb3QuWmVwdG8gfHwgcm9vdC5lbmRlcjsNCg0KICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUNCiAgLy8gdG8gaXRzIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoaXMgQmFja2JvbmUgb2JqZWN0Lg0KICBCYWNrYm9uZS5ub0NvbmZsaWN0ID0gZnVuY3Rpb24oKSB7DQogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7DQogICAgcmV0dXJuIHRoaXM7DQogIH07DQoNCiAgLy8gVHVybiBvbiBgZW11bGF0ZUhUVFBgIHRvIHN1cHBvcnQgbGVnYWN5IEhUVFAgc2VydmVycy4gU2V0dGluZyB0aGlzIG9wdGlvbg0KICAvLyB3aWxsIGZha2UgYCJQVVQiYCBhbmQgYCJERUxFVEUiYCByZXF1ZXN0cyB2aWEgdGhlIGBfbWV0aG9kYCBwYXJhbWV0ZXIgYW5kDQogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuDQogIEJhY2tib25lLmVtdWxhdGVIVFRQID0gZmFsc2U7DQoNCiAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0DQogIC8vIGBhcHBsaWNhdGlvbi9qc29uYCByZXF1ZXN0cyAuLi4gd2lsbCBlbmNvZGUgdGhlIGJvZHkgYXMNCiAgLy8gYGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZGAgaW5zdGVhZCBhbmQgd2lsbCBzZW5kIHRoZSBtb2RlbCBpbiBhDQogIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4NCiAgQmFja2JvbmUuZW11bGF0ZUpTT04gPSBmYWxzZTsNCg0KICAvLyBCYWNrYm9uZS5FdmVudHMNCiAgLy8gLS0tLS0tLS0tLS0tLS0tDQoNCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4NCiAgdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXHMrLzsNCg0KICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudA0KICAvLyBuYW1lcyBgImNoYW5nZSBibHVyImAgYW5kIGpRdWVyeS1zdHlsZSBldmVudCBtYXBzIGB7Y2hhbmdlOiBhY3Rpb259YA0KICAvLyBpbiB0ZXJtcyBvZiB0aGUgZXhpc3RpbmcgQVBJLg0KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsNCiAgICBpZiAoIW5hbWUpIHJldHVybiB0cnVlOw0KICAgIGlmICh0eXBlb2YgbmFtZSA9PT0gJ29iamVjdCcpIHsNCiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7DQogICAgICAgIG9ialthY3Rpb25dLmFwcGx5KG9iaiwgW2tleSwgbmFtZVtrZXldXS5jb25jYXQocmVzdCkpOw0KICAgICAgfQ0KICAgIH0gZWxzZSBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7DQogICAgICB2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KGV2ZW50U3BsaXR0ZXIpOw0KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7DQogICAgICB9DQogICAgfSBlbHNlIHsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCiAgfTsNCg0KICAvLyBPcHRpbWl6ZWQgaW50ZXJuYWwgZGlzcGF0Y2ggZnVuY3Rpb24gZm9yIHRyaWdnZXJpbmcgZXZlbnRzLiBUcmllcyB0bw0KICAvLyBrZWVwIHRoZSB1c3VhbCBjYXNlcyBzcGVlZHkgKG1vc3QgQmFja2JvbmUgZXZlbnRzIGhhdmUgMyBhcmd1bWVudHMpLg0KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBhcmdzKSB7DQogICAgdmFyIGV2LCBpID0gLTEsIGwgPSBldmVudHMubGVuZ3RoOw0KICAgIHN3aXRjaCAoYXJncy5sZW5ndGgpIHsNCiAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsNCiAgICByZXR1cm47DQogICAgY2FzZSAxOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSk7DQogICAgcmV0dXJuOw0KICAgIGNhc2UgMjogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0sIGFyZ3NbMV0pOw0KICAgIHJldHVybjsNCiAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsNCiAgICByZXR1cm47DQogICAgZGVmYXVsdDogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suYXBwbHkoZXYuY3R4LCBhcmdzKTsNCiAgICB9DQogIH07DQoNCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aA0KICAvLyBjdXN0b20gZXZlbnRzLiBZb3UgbWF5IGJpbmQgd2l0aCBgb25gIG9yIHJlbW92ZSB3aXRoIGBvZmZgIGNhbGxiYWNrDQogIC8vIGZ1bmN0aW9ucyB0byBhbiBldmVudDsgYHRyaWdnZXJgLWluZyBhbiBldmVudCBmaXJlcyBhbGwgY2FsbGJhY2tzIGluDQogIC8vIHN1Y2Nlc3Npb24uDQogIC8vDQogIC8vICAgICB2YXIgb2JqZWN0ID0ge307DQogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7DQogIC8vICAgICBvYmplY3Qub24oJ2V4cGFuZCcsIGZ1bmN0aW9uKCl7IGFsZXJ0KCdleHBhbmRlZCcpOyB9KTsNCiAgLy8gICAgIG9iamVjdC50cmlnZ2VyKCdleHBhbmQnKTsNCiAgLy8NCiAgdmFyIEV2ZW50cyA9IEJhY2tib25lLkV2ZW50cyA9IHsNCg0KICAgIC8vIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgb3IgYW4gZXZlbnRzIG1hcCwNCiAgICAvLyB0byBhIGBjYWxsYmFja2AgZnVuY3Rpb24uIFBhc3NpbmcgYCJhbGwiYCB3aWxsIGJpbmQgdGhlIGNhbGxiYWNrIHRvDQogICAgLy8gYWxsIGV2ZW50cyBmaXJlZC4NCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsNCiAgICAgIGlmICghKGV2ZW50c0FwaSh0aGlzLCAnb24nLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOw0KICAgICAgdGhpcy5fZXZlbnRzIHx8ICh0aGlzLl9ldmVudHMgPSB7fSk7DQogICAgICB2YXIgbGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOw0KICAgICAgbGlzdC5wdXNoKHtjYWxsYmFjazogY2FsbGJhY2ssIGNvbnRleHQ6IGNvbnRleHQsIGN0eDogY29udGV4dCB8fCB0aGlzfSk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gQmluZCBldmVudHMgdG8gb25seSBiZSB0cmlnZ2VyZWQgYSBzaW5nbGUgdGltZS4gQWZ0ZXIgdGhlIGZpcnN0IHRpbWUNCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLg0KICAgIG9uY2U6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7DQogICAgICBpZiAoIShldmVudHNBcGkodGhpcywgJ29uY2UnLCBuYW1lLCBbY2FsbGJhY2ssIGNvbnRleHRdKSAmJiBjYWxsYmFjaykpIHJldHVybiB0aGlzOw0KICAgICAgdmFyIHNlbGYgPSB0aGlzOw0KICAgICAgdmFyIG9uY2UgPSBfLm9uY2UoZnVuY3Rpb24oKSB7DQogICAgICAgIHNlbGYub2ZmKG5hbWUsIG9uY2UpOw0KICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgICAgfSk7DQogICAgICBvbmNlLl9jYWxsYmFjayA9IGNhbGxiYWNrOw0KICAgICAgdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBSZW1vdmUgb25lIG9yIG1hbnkgY2FsbGJhY2tzLiBJZiBgY29udGV4dGAgaXMgbnVsbCwgcmVtb3ZlcyBhbGwNCiAgICAvLyBjYWxsYmFja3Mgd2l0aCB0aGF0IGZ1bmN0aW9uLiBJZiBgY2FsbGJhY2tgIGlzIG51bGwsIHJlbW92ZXMgYWxsDQogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBldmVudHNgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kDQogICAgLy8gY2FsbGJhY2tzIGZvciBhbGwgZXZlbnRzLg0KICAgIG9mZjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsNCiAgICAgIHZhciBsaXN0LCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsNCiAgICAgIGlmICghdGhpcy5fZXZlbnRzIHx8ICFldmVudHNBcGkodGhpcywgJ29mZicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pKSByZXR1cm4gdGhpczsNCiAgICAgIGlmICghbmFtZSAmJiAhY2FsbGJhY2sgJiYgIWNvbnRleHQpIHsNCiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBuYW1lcyA9IG5hbWUgPyBbbmFtZV0gOiBfLmtleXModGhpcy5fZXZlbnRzKTsNCiAgICAgIGZvciAoaSA9IDAsIGwgPSBuYW1lcy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOw0KICAgICAgICBpZiAobGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSkgew0KICAgICAgICAgIGV2ZW50cyA9IFtdOw0KICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7DQogICAgICAgICAgICBmb3IgKGogPSAwLCBrID0gbGlzdC5sZW5ndGg7IGogPCBrOyBqKyspIHsNCiAgICAgICAgICAgICAgZXYgPSBsaXN0W2pdOw0KICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSAoZXYuY2FsbGJhY2suX2NhbGxiYWNrIHx8IGV2LmNhbGxiYWNrKSkgfHwNCiAgICAgICAgICAgICAgICAgIChjb250ZXh0ICYmIGNvbnRleHQgIT09IGV2LmNvbnRleHQpKSB7DQogICAgICAgICAgICAgICAgZXZlbnRzLnB1c2goZXYpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IGV2ZW50czsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gVHJpZ2dlciBvbmUgb3IgbWFueSBldmVudHMsIGZpcmluZyBhbGwgYm91bmQgY2FsbGJhY2tzLiBDYWxsYmFja3MgYXJlDQogICAgLy8gcGFzc2VkIHRoZSBzYW1lIGFyZ3VtZW50cyBhcyBgdHJpZ2dlcmAgaXMsIGFwYXJ0IGZyb20gdGhlIGV2ZW50IG5hbWUNCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvDQogICAgLy8gcmVjZWl2ZSB0aGUgdHJ1ZSBuYW1lIG9mIHRoZSBldmVudCBhcyB0aGUgZmlyc3QgYXJndW1lbnQpLg0KICAgIHRyaWdnZXI6IGZ1bmN0aW9uKG5hbWUpIHsNCiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsNCiAgICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOw0KICAgICAgaWYgKCFldmVudHNBcGkodGhpcywgJ3RyaWdnZXInLCBuYW1lLCBhcmdzKSkgcmV0dXJuIHRoaXM7DQogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOw0KICAgICAgdmFyIGFsbEV2ZW50cyA9IHRoaXMuX2V2ZW50cy5hbGw7DQogICAgICBpZiAoZXZlbnRzKSB0cmlnZ2VyRXZlbnRzKHRoaXMsIGV2ZW50cywgYXJncyk7DQogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKHRoaXMsIGFsbEV2ZW50cywgYXJndW1lbnRzKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBBbiBpbnZlcnNpb24tb2YtY29udHJvbCB2ZXJzaW9uIG9mIGBvbmAuIFRlbGwgKnRoaXMqIG9iamVjdCB0byBsaXN0ZW4gdG8NCiAgICAvLyBhbiBldmVudCBpbiBhbm90aGVyIG9iamVjdCAuLi4ga2VlcGluZyB0cmFjayBvZiB3aGF0IGl0J3MgbGlzdGVuaW5nIHRvLg0KICAgIGxpc3RlblRvOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsNCiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnMgfHwgKHRoaXMuX2xpc3RlbmVycyA9IHt9KTsNCiAgICAgIHZhciBpZCA9IG9iamVjdC5fbGlzdGVuZXJJZCB8fCAob2JqZWN0Ll9saXN0ZW5lcklkID0gXy51bmlxdWVJZCgnbCcpKTsNCiAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmplY3Q7DQogICAgICBvYmplY3Qub24oZXZlbnRzLCBjYWxsYmFjayB8fCB0aGlzLCB0aGlzKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBUZWxsIHRoaXMgb2JqZWN0IHRvIHN0b3AgbGlzdGVuaW5nIHRvIGVpdGhlciBzcGVjaWZpYyBldmVudHMgLi4uIG9yDQogICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4NCiAgICBzdG9wTGlzdGVuaW5nOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsNCiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnM7DQogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuOw0KICAgICAgaWYgKG9iamVjdCkgew0KICAgICAgICBvYmplY3Qub2ZmKGV2ZW50cywgY2FsbGJhY2ssIHRoaXMpOw0KICAgICAgICBpZiAoIWV2ZW50cyAmJiAhY2FsbGJhY2spIGRlbGV0ZSBsaXN0ZW5lcnNbb2JqZWN0Ll9saXN0ZW5lcklkXTsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGZvciAodmFyIGlkIGluIGxpc3RlbmVycykgew0KICAgICAgICAgIGxpc3RlbmVyc1tpZF0ub2ZmKG51bGwsIG51bGwsIHRoaXMpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9Ow0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfQ0KICB9Ow0KDQogIC8vIEFsaWFzZXMgZm9yIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5Lg0KICBFdmVudHMuYmluZCAgID0gRXZlbnRzLm9uOw0KICBFdmVudHMudW5iaW5kID0gRXZlbnRzLm9mZjsNCg0KICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvDQogIC8vIHdhbnQgZ2xvYmFsICJwdWJzdWIiIGluIGEgY29udmVuaWVudCBwbGFjZS4NCiAgXy5leHRlbmQoQmFja2JvbmUsIEV2ZW50cyk7DQoNCiAgLy8gQmFja2JvbmUuTW9kZWwNCiAgLy8gLS0tLS0tLS0tLS0tLS0NCg0KICAvLyBDcmVhdGUgYSBuZXcgbW9kZWwsIHdpdGggZGVmaW5lZCBhdHRyaWJ1dGVzLiBBIGNsaWVudCBpZCAoYGNpZGApDQogIC8vIGlzIGF1dG9tYXRpY2FsbHkgZ2VuZXJhdGVkIGFuZCBhc3NpZ25lZCBmb3IgeW91Lg0KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsNCiAgICB2YXIgZGVmYXVsdHM7DQogICAgdmFyIGF0dHJzID0gYXR0cmlidXRlcyB8fCB7fTsNCiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsNCiAgICB0aGlzLmNoYW5nZWQgPSB7fTsNCiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB7fTsNCiAgICB0aGlzLl9jaGFuZ2VzID0gW107DQogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5jb2xsZWN0aW9uKSB0aGlzLmNvbGxlY3Rpb24gPSBvcHRpb25zLmNvbGxlY3Rpb247DQogICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5wYXJzZSkgYXR0cnMgPSB0aGlzLnBhcnNlKGF0dHJzKTsNCiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgXy5kZWZhdWx0cyhhdHRycywgZGVmYXVsdHMpOw0KICAgIHRoaXMuc2V0KGF0dHJzLCB7c2lsZW50OiB0cnVlfSk7DQogICAgdGhpcy5fY3VycmVudEF0dHJpYnV0ZXMgPSBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7DQogICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOw0KICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICB9Ow0KDQogIC8vIEF0dGFjaCBhbGwgaW5oZXJpdGFibGUgbWV0aG9kcyB0byB0aGUgTW9kZWwgcHJvdG90eXBlLg0KICBfLmV4dGVuZChNb2RlbC5wcm90b3R5cGUsIEV2ZW50cywgew0KDQogICAgLy8gQSBoYXNoIG9mIGF0dHJpYnV0ZXMgd2hvc2UgY3VycmVudCBhbmQgcHJldmlvdXMgdmFsdWUgZGlmZmVyLg0KICAgIGNoYW5nZWQ6IG51bGwsDQoNCiAgICAvLyBUaGUgZGVmYXVsdCBuYW1lIGZvciB0aGUgSlNPTiBgaWRgIGF0dHJpYnV0ZSBpcyBgImlkImAuIE1vbmdvREIgYW5kDQogICAgLy8gQ291Y2hEQiB1c2VycyBtYXkgd2FudCB0byBzZXQgdGhpcyB0byBgIl9pZCJgLg0KICAgIGlkQXR0cmlidXRlOiAnaWQnLA0KDQogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duDQogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuDQogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LA0KDQogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0Lg0KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgcmV0dXJuIF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsNCiAgICB9LA0KDQogICAgLy8gUHJveHkgYEJhY2tib25lLnN5bmNgIGJ5IGRlZmF1bHQuDQogICAgc3luYzogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgdGhlIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4NCiAgICBnZXQ6IGZ1bmN0aW9uKGF0dHIpIHsNCiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07DQogICAgfSwNCg0KICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4NCiAgICBlc2NhcGU6IGZ1bmN0aW9uKGF0dHIpIHsNCiAgICAgIHJldHVybiBfLmVzY2FwZSh0aGlzLmdldChhdHRyKSk7DQogICAgfSwNCg0KICAgIC8vIFJldHVybnMgYHRydWVgIGlmIHRoZSBhdHRyaWJ1dGUgY29udGFpbnMgYSB2YWx1ZSB0aGF0IGlzIG5vdCBudWxsDQogICAgLy8gb3IgdW5kZWZpbmVkLg0KICAgIGhhczogZnVuY3Rpb24oYXR0cikgew0KICAgICAgcmV0dXJuIHRoaXMuZ2V0KGF0dHIpICE9IG51bGw7DQogICAgfSwNCg0KICAgIC8vIFNldCBhIGhhc2ggb2YgbW9kZWwgYXR0cmlidXRlcyBvbiB0aGUgb2JqZWN0LCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MNCiAgICAvLyB5b3UgY2hvb3NlIHRvIHNpbGVuY2UgaXQuDQogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgb3B0aW9ucykgew0KICAgICAgdmFyIGF0dHIsIGF0dHJzOw0KICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsNCg0KICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuDQogICAgICBpZiAoXy5pc09iamVjdChrZXkpKSB7DQogICAgICAgIGF0dHJzID0ga2V5Ow0KICAgICAgICBvcHRpb25zID0gdmFsOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7DQogICAgICB9DQoNCiAgICAgIC8vIEV4dHJhY3QgYXR0cmlidXRlcyBhbmQgb3B0aW9ucy4NCiAgICAgIHZhciBzaWxlbnQgPSBvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50Ow0KICAgICAgdmFyIHVuc2V0ID0gb3B0aW9ucyAmJiBvcHRpb25zLnVuc2V0Ow0KDQogICAgICAvLyBSdW4gdmFsaWRhdGlvbi4NCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIC8vIENoZWNrIGZvciBjaGFuZ2VzIG9mIGBpZGAuDQogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOw0KDQogICAgICB2YXIgbm93ID0gdGhpcy5hdHRyaWJ1dGVzOw0KDQogICAgICAvLyBGb3IgZWFjaCBgc2V0YCBhdHRyaWJ1dGUuLi4NCiAgICAgIGZvciAoYXR0ciBpbiBhdHRycykgew0KICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsNCg0KICAgICAgICAvLyBVcGRhdGUgb3IgZGVsZXRlIHRoZSBjdXJyZW50IHZhbHVlLCBhbmQgdHJhY2sgdGhlIGNoYW5nZS4NCiAgICAgICAgdW5zZXQgPyBkZWxldGUgbm93W2F0dHJdIDogbm93W2F0dHJdID0gdmFsOw0KICAgICAgICB0aGlzLl9jaGFuZ2VzLnB1c2goYXR0ciwgdmFsKTsNCiAgICAgIH0NCg0KICAgICAgLy8gU2lnbmFsIHRoYXQgdGhlIG1vZGVsJ3Mgc3RhdGUgaGFzIHBvdGVudGlhbGx5IGNoYW5nZWQsIGFuZCB3ZSBuZWVkDQogICAgICAvLyB0byByZWNvbXB1dGUgdGhlIGFjdHVhbCBjaGFuZ2VzLg0KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSBmYWxzZTsNCg0KICAgICAgLy8gRmlyZSB0aGUgYCJjaGFuZ2UiYCBldmVudHMuDQogICAgICBpZiAoIXNpbGVudCkgdGhpcy5jaGFuZ2Uob3B0aW9ucyk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gUmVtb3ZlIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UNCiAgICAvLyB0byBzaWxlbmNlIGl0LiBgdW5zZXRgIGlzIGEgbm9vcCBpZiB0aGUgYXR0cmlidXRlIGRvZXNuJ3QgZXhpc3QuDQogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsNCiAgICAgIHJldHVybiB0aGlzLnNldChhdHRyLCB2b2lkIDAsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7DQogICAgfSwNCg0KICAgIC8vIENsZWFyIGFsbCBhdHRyaWJ1dGVzIG9uIHRoZSBtb2RlbCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzIHlvdSBjaG9vc2UNCiAgICAvLyB0byBzaWxlbmNlIGl0Lg0KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICB2YXIgYXR0cnMgPSB7fTsNCiAgICAgIGZvciAodmFyIGtleSBpbiB0aGlzLmF0dHJpYnV0ZXMpIGF0dHJzW2tleV0gPSB2b2lkIDA7DQogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7DQogICAgfSwNCg0KICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUNCiAgICAvLyBtb2RlbCBkaWZmZXJzIGZyb20gaXRzIGN1cnJlbnQgYXR0cmlidXRlcywgdGhleSB3aWxsIGJlIG92ZXJyaWRlbiwNCiAgICAvLyB0cmlnZ2VyaW5nIGEgYCJjaGFuZ2UiYCBldmVudC4NCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307DQogICAgICBpZiAob3B0aW9ucy5wYXJzZSA9PT0gdm9pZCAwKSBvcHRpb25zLnBhcnNlID0gdHJ1ZTsNCiAgICAgIHZhciBtb2RlbCA9IHRoaXM7DQogICAgICB2YXIgc3VjY2VzcyA9IG9wdGlvbnMuc3VjY2VzczsNCiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7DQogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3ApLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7DQogICAgICB9Ow0KICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOw0KICAgIH0sDQoNCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLg0KICAgIC8vIElmIHRoZSBzZXJ2ZXIgcmV0dXJucyBhbiBhdHRyaWJ1dGVzIGhhc2ggdGhhdCBkaWZmZXJzLCB0aGUgbW9kZWwncw0KICAgIC8vIHN0YXRlIHdpbGwgYmUgYHNldGAgYWdhaW4uDQogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsNCiAgICAgIHZhciBhdHRycywgY3VycmVudCwgZG9uZTsNCg0KICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuDQogICAgICBpZiAoa2V5ID09IG51bGwgfHwgXy5pc09iamVjdChrZXkpKSB7DQogICAgICAgIGF0dHJzID0ga2V5Ow0KICAgICAgICBvcHRpb25zID0gdmFsOw0KICAgICAgfSBlbHNlIGlmIChrZXkgIT0gbnVsbCkgew0KICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsNCiAgICAgIH0NCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9Ow0KDQogICAgICAvLyBJZiB3ZSdyZSAid2FpdCItaW5nIHRvIHNldCBjaGFuZ2VkIGF0dHJpYnV0ZXMsIHZhbGlkYXRlIGVhcmx5Lg0KICAgICAgaWYgKG9wdGlvbnMud2FpdCkgew0KICAgICAgICBpZiAoYXR0cnMgJiYgIXRoaXMuX3ZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgICBjdXJyZW50ID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOw0KICAgICAgfQ0KDQogICAgICAvLyBSZWd1bGFyIHNhdmVzIGBzZXRgIGF0dHJpYnV0ZXMgYmVmb3JlIHBlcnNpc3RpbmcgdG8gdGhlIHNlcnZlci4NCiAgICAgIHZhciBzaWxlbnRPcHRpb25zID0gXy5leHRlbmQoe30sIG9wdGlvbnMsIHtzaWxlbnQ6IHRydWV9KTsNCiAgICAgIGlmIChhdHRycyAmJiAhdGhpcy5zZXQoYXR0cnMsIG9wdGlvbnMud2FpdCA/IHNpbGVudE9wdGlvbnMgOiBvcHRpb25zKSkgew0KICAgICAgICByZXR1cm4gZmFsc2U7DQogICAgICB9DQoNCiAgICAgIC8vIERvIG5vdCBwZXJzaXN0IGludmFsaWQgbW9kZWxzLg0KICAgICAgaWYgKCFhdHRycyAmJiAhdGhpcy5fdmFsaWRhdGUobnVsbCwgb3B0aW9ucykpIHJldHVybiBmYWxzZTsNCg0KICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpDQogICAgICAvLyB1cGRhdGVkIHdpdGggdGhlIHNlcnZlci1zaWRlIHN0YXRlLg0KICAgICAgdmFyIG1vZGVsID0gdGhpczsNCiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOw0KICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsNCiAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3ApOw0KICAgICAgICBpZiAob3B0aW9ucy53YWl0KSBzZXJ2ZXJBdHRycyA9IF8uZXh0ZW5kKGF0dHJzIHx8IHt9LCBzZXJ2ZXJBdHRycyk7DQogICAgICAgIGlmICghbW9kZWwuc2V0KHNlcnZlckF0dHJzLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOw0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7DQogICAgICB9Ow0KDQogICAgICAvLyBGaW5pc2ggY29uZmlndXJpbmcgYW5kIHNlbmRpbmcgdGhlIEFqYXggcmVxdWVzdC4NCiAgICAgIHZhciBtZXRob2QgPSB0aGlzLmlzTmV3KCkgPyAnY3JlYXRlJyA6IChvcHRpb25zLnBhdGNoID8gJ3BhdGNoJyA6ICd1cGRhdGUnKTsNCiAgICAgIGlmIChtZXRob2QgPT0gJ3BhdGNoJykgb3B0aW9ucy5hdHRycyA9IGF0dHJzOw0KICAgICAgdmFyIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOw0KDQogICAgICAvLyBXaGVuIHVzaW5nIGB3YWl0YCwgcmVzZXQgYXR0cmlidXRlcyB0byBvcmlnaW5hbCB2YWx1ZXMgdW5sZXNzDQogICAgICAvLyBgc3VjY2Vzc2AgaGFzIGJlZW4gY2FsbGVkIGFscmVhZHkuDQogICAgICBpZiAoIWRvbmUgJiYgb3B0aW9ucy53YWl0KSB7DQogICAgICAgIHRoaXMuY2xlYXIoc2lsZW50T3B0aW9ucyk7DQogICAgICAgIHRoaXMuc2V0KGN1cnJlbnQsIHNpbGVudE9wdGlvbnMpOw0KICAgICAgfQ0KDQogICAgICByZXR1cm4geGhyOw0KICAgIH0sDQoNCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuDQogICAgLy8gT3B0aW1pc3RpY2FsbHkgcmVtb3ZlcyB0aGUgbW9kZWwgZnJvbSBpdHMgY29sbGVjdGlvbiwgaWYgaXQgaGFzIG9uZS4NCiAgICAvLyBJZiBgd2FpdDogdHJ1ZWAgaXMgcGFzc2VkLCB3YWl0cyBmb3IgdGhlIHNlcnZlciB0byByZXNwb25kIGJlZm9yZSByZW1vdmFsLg0KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9Ow0KICAgICAgdmFyIG1vZGVsID0gdGhpczsNCiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOw0KDQogICAgICB2YXIgZGVzdHJveSA9IGZ1bmN0aW9uKCkgew0KICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOw0KICAgICAgfTsNCg0KICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgew0KICAgICAgICBpZiAob3B0aW9ucy53YWl0IHx8IG1vZGVsLmlzTmV3KCkpIGRlc3Ryb3koKTsNCiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MobW9kZWwsIHJlc3AsIG9wdGlvbnMpOw0KICAgICAgfTsNCg0KICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgew0KICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsNCiAgICAgICAgcmV0dXJuIGZhbHNlOw0KICAgICAgfQ0KDQogICAgICB2YXIgeGhyID0gdGhpcy5zeW5jKCdkZWxldGUnLCB0aGlzLCBvcHRpb25zKTsNCiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBkZXN0cm95KCk7DQogICAgICByZXR1cm4geGhyOw0KICAgIH0sDQoNCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUNCiAgICAvLyB1c2luZyBCYWNrYm9uZSdzIHJlc3RmdWwgbWV0aG9kcywgb3ZlcnJpZGUgdGhpcyB0byBjaGFuZ2UgdGhlIGVuZHBvaW50DQogICAgLy8gdGhhdCB3aWxsIGJlIGNhbGxlZC4NCiAgICB1cmw6IGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIGJhc2UgPSBfLnJlc3VsdCh0aGlzLCAndXJsUm9vdCcpIHx8IF8ucmVzdWx0KHRoaXMuY29sbGVjdGlvbiwgJ3VybCcpIHx8IHVybEVycm9yKCk7DQogICAgICBpZiAodGhpcy5pc05ldygpKSByZXR1cm4gYmFzZTsNCiAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsNCiAgICB9LA0KDQogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uDQogICAgLy8gdGhlIG1vZGVsLiBUaGUgZGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBpcyBqdXN0IHRvIHBhc3MgdGhlIHJlc3BvbnNlIGFsb25nLg0KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwKSB7DQogICAgICByZXR1cm4gcmVzcDsNCiAgICB9LA0KDQogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuDQogICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMuYXR0cmlidXRlcyk7DQogICAgfSwNCg0KICAgIC8vIEEgbW9kZWwgaXMgbmV3IGlmIGl0IGhhcyBuZXZlciBiZWVuIHNhdmVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCBsYWNrcyBhbiBpZC4NCiAgICBpc05ldzogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gdGhpcy5pZCA9PSBudWxsOw0KICAgIH0sDQoNCiAgICAvLyBDYWxsIHRoaXMgbWV0aG9kIHRvIG1hbnVhbGx5IGZpcmUgYSBgImNoYW5nZSJgIGV2ZW50IGZvciB0aGlzIG1vZGVsIGFuZA0KICAgIC8vIGEgYCJjaGFuZ2U6YXR0cmlidXRlImAgZXZlbnQgZm9yIGVhY2ggY2hhbmdlZCBhdHRyaWJ1dGUuDQogICAgLy8gQ2FsbGluZyB0aGlzIHdpbGwgY2F1c2UgYWxsIG9iamVjdHMgb2JzZXJ2aW5nIHRoZSBtb2RlbCB0byB1cGRhdGUuDQogICAgY2hhbmdlOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICB2YXIgY2hhbmdpbmcgPSB0aGlzLl9jaGFuZ2luZzsNCiAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsNCg0KICAgICAgLy8gR2VuZXJhdGUgdGhlIGNoYW5nZXMgdG8gYmUgdHJpZ2dlcmVkIG9uIHRoZSBtb2RlbC4NCiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuX2NvbXB1dGVDaGFuZ2VzKHRydWUpOw0KDQogICAgICB0aGlzLl9wZW5kaW5nID0gISF0cmlnZ2Vycy5sZW5ndGg7DQoNCiAgICAgIGZvciAodmFyIGkgPSB0cmlnZ2Vycy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgew0KICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTonICsgdHJpZ2dlcnNbaV0sIHRoaXMsIHRyaWdnZXJzW2kgKyAxXSwgb3B0aW9ucyk7DQogICAgICB9DQoNCiAgICAgIGlmIChjaGFuZ2luZykgcmV0dXJuIHRoaXM7DQoNCiAgICAgIC8vIFRyaWdnZXIgYSBgY2hhbmdlYCB3aGlsZSB0aGVyZSBoYXZlIGJlZW4gY2hhbmdlcy4NCiAgICAgIHdoaWxlICh0aGlzLl9wZW5kaW5nKSB7DQogICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsNCiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2UnLCB0aGlzLCBvcHRpb25zKTsNCiAgICAgICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOw0KICAgICAgfQ0KDQogICAgICB0aGlzLl9jaGFuZ2luZyA9IGZhbHNlOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4NCiAgICAvLyBJZiB5b3Ugc3BlY2lmeSBhbiBhdHRyaWJ1dGUgbmFtZSwgZGV0ZXJtaW5lIGlmIHRoYXQgYXR0cmlidXRlIGhhcyBjaGFuZ2VkLg0KICAgIGhhc0NoYW5nZWQ6IGZ1bmN0aW9uKGF0dHIpIHsNCiAgICAgIGlmICghdGhpcy5faGFzQ29tcHV0ZWQpIHRoaXMuX2NvbXB1dGVDaGFuZ2VzKCk7DQogICAgICBpZiAoYXR0ciA9PSBudWxsKSByZXR1cm4gIV8uaXNFbXB0eSh0aGlzLmNoYW5nZWQpOw0KICAgICAgcmV0dXJuIF8uaGFzKHRoaXMuY2hhbmdlZCwgYXR0cik7DQogICAgfSwNCg0KICAgIC8vIFJldHVybiBhbiBvYmplY3QgY29udGFpbmluZyBhbGwgdGhlIGF0dHJpYnV0ZXMgdGhhdCBoYXZlIGNoYW5nZWQsIG9yDQogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0DQogICAgLy8gcGFydHMgb2YgYSB2aWV3IG5lZWQgdG8gYmUgdXBkYXRlZCBhbmQvb3Igd2hhdCBhdHRyaWJ1dGVzIG5lZWQgdG8gYmUNCiAgICAvLyBwZXJzaXN0ZWQgdG8gdGhlIHNlcnZlci4gVW5zZXQgYXR0cmlidXRlcyB3aWxsIGJlIHNldCB0byB1bmRlZmluZWQuDQogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwNCiAgICAvLyBkZXRlcm1pbmluZyBpZiB0aGVyZSAqd291bGQgYmUqIGEgY2hhbmdlLg0KICAgIGNoYW5nZWRBdHRyaWJ1dGVzOiBmdW5jdGlvbihkaWZmKSB7DQogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOw0KICAgICAgdmFyIHZhbCwgY2hhbmdlZCA9IGZhbHNlLCBvbGQgPSB0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXM7DQogICAgICBmb3IgKHZhciBhdHRyIGluIGRpZmYpIHsNCiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOw0KICAgICAgICAoY2hhbmdlZCB8fCAoY2hhbmdlZCA9IHt9KSlbYXR0cl0gPSB2YWw7DQogICAgICB9DQogICAgICByZXR1cm4gY2hhbmdlZDsNCiAgICB9LA0KDQogICAgLy8gTG9va2luZyBhdCB0aGUgYnVpbHQgdXAgbGlzdCBvZiBgc2V0YCBhdHRyaWJ1dGUgY2hhbmdlcywgY29tcHV0ZSBob3cNCiAgICAvLyBtYW55IG9mIHRoZSBhdHRyaWJ1dGVzIGhhdmUgYWN0dWFsbHkgY2hhbmdlZC4gSWYgYGxvdWRgLCByZXR1cm4gYQ0KICAgIC8vIGJvaWxlZC1kb3duIGxpc3Qgb2Ygb25seSB0aGUgcmVhbCBjaGFuZ2VzLg0KICAgIF9jb21wdXRlQ2hhbmdlczogZnVuY3Rpb24obG91ZCkgew0KICAgICAgdGhpcy5jaGFuZ2VkID0ge307DQogICAgICB2YXIgYWxyZWFkeSA9IHt9Ow0KICAgICAgdmFyIHRyaWdnZXJzID0gW107DQogICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzOw0KICAgICAgdmFyIGNoYW5nZXMgPSB0aGlzLl9jaGFuZ2VzOw0KDQogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGN1cnJlbnQgcXVldWUgb2YgcG90ZW50aWFsIG1vZGVsIGNoYW5nZXMuDQogICAgICBmb3IgKHZhciBpID0gY2hhbmdlcy5sZW5ndGggLSAyOyBpID49IDA7IGkgLT0gMikgew0KICAgICAgICB2YXIga2V5ID0gY2hhbmdlc1tpXSwgdmFsID0gY2hhbmdlc1tpICsgMV07DQogICAgICAgIGlmIChhbHJlYWR5W2tleV0pIGNvbnRpbnVlOw0KICAgICAgICBhbHJlYWR5W2tleV0gPSB0cnVlOw0KDQogICAgICAgIC8vIENoZWNrIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgdGhlIGxhc3QgY2hhbmdlLA0KICAgICAgICAvLyBhbmQgdXBkYXRlIGB0aGlzLmNoYW5nZWRgIGFjY29yZGluZ2x5LiBJZiB3ZSdyZSBpbnNpZGUgb2YgYSBgY2hhbmdlYA0KICAgICAgICAvLyBjYWxsLCBhbHNvIGFkZCBhIHRyaWdnZXIgdG8gdGhlIGxpc3QuDQogICAgICAgIGlmIChjdXJyZW50W2tleV0gIT09IHZhbCkgew0KICAgICAgICAgIHRoaXMuY2hhbmdlZFtrZXldID0gdmFsOw0KICAgICAgICAgIGlmICghbG91ZCkgY29udGludWU7DQogICAgICAgICAgdHJpZ2dlcnMucHVzaChrZXksIHZhbCk7DQogICAgICAgICAgY3VycmVudFtrZXldID0gdmFsOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBpZiAobG91ZCkgdGhpcy5fY2hhbmdlcyA9IFtdOw0KDQogICAgICAvLyBTaWduYWxzIGB0aGlzLmNoYW5nZWRgIGlzIGN1cnJlbnQgdG8gcHJldmVudCBkdXBsaWNhdGUgY2FsbHMgZnJvbSBgdGhpcy5oYXNDaGFuZ2VkYC4NCiAgICAgIHRoaXMuX2hhc0NvbXB1dGVkID0gdHJ1ZTsNCiAgICAgIHJldHVybiB0cmlnZ2VyczsNCiAgICB9LA0KDQogICAgLy8gR2V0IHRoZSBwcmV2aW91cyB2YWx1ZSBvZiBhbiBhdHRyaWJ1dGUsIHJlY29yZGVkIGF0IHRoZSB0aW1lIHRoZSBsYXN0DQogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuDQogICAgcHJldmlvdXM6IGZ1bmN0aW9uKGF0dHIpIHsNCiAgICAgIGlmIChhdHRyID09IG51bGwgfHwgIXRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcykgcmV0dXJuIG51bGw7DQogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMNCiAgICAvLyBgImNoYW5nZSJgIGV2ZW50Lg0KICAgIHByZXZpb3VzQXR0cmlidXRlczogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOw0KICAgIH0sDQoNCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLA0KICAgIC8vIHJldHVybmluZyBgdHJ1ZWAgaWYgYWxsIGlzIHdlbGwuIElmIGEgc3BlY2lmaWMgYGVycm9yYCBjYWxsYmFjayBoYXMNCiAgICAvLyBiZWVuIHBhc3NlZCwgY2FsbCB0aGF0IGluc3RlYWQgb2YgZmlyaW5nIHRoZSBnZW5lcmFsIGAiZXJyb3IiYCBldmVudC4NCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7DQogICAgICBpZiAoIXRoaXMudmFsaWRhdGUpIHJldHVybiB0cnVlOw0KICAgICAgYXR0cnMgPSBfLmV4dGVuZCh7fSwgdGhpcy5hdHRyaWJ1dGVzLCBhdHRycyk7DQogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsNCiAgICAgIGlmICghZXJyb3IpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5lcnJvcikgb3B0aW9ucy5lcnJvcih0aGlzLCBlcnJvciwgb3B0aW9ucyk7DQogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIGZhbHNlOw0KICAgIH0NCg0KICB9KTsNCg0KICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uDQogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0NCg0KICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZA0KICAvLyBvciB1bm9yZGVyZWQuIElmIGEgYGNvbXBhcmF0b3JgIGlzIHNwZWNpZmllZCwgdGhlIENvbGxlY3Rpb24gd2lsbCBtYWludGFpbg0KICAvLyBpdHMgbW9kZWxzIGluIHNvcnQgb3JkZXIsIGFzIHRoZXkncmUgYWRkZWQgYW5kIHJlbW92ZWQuDQogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgew0KICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7DQogICAgaWYgKG9wdGlvbnMubW9kZWwpIHRoaXMubW9kZWwgPSBvcHRpb25zLm1vZGVsOw0KICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOw0KICAgIHRoaXMuX3Jlc2V0KCk7DQogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7DQogIH07DQoNCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4NCiAgXy5leHRlbmQoQ29sbGVjdGlvbi5wcm90b3R5cGUsIEV2ZW50cywgew0KDQogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLg0KICAgIC8vIFRoaXMgc2hvdWxkIGJlIG92ZXJyaWRkZW4gaW4gbW9zdCBjYXNlcy4NCiAgICBtb2RlbDogTW9kZWwsDQoNCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24NCiAgICAvLyBpbml0aWFsaXphdGlvbiBsb2dpYy4NCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sDQoNCiAgICAvLyBUaGUgSlNPTiByZXByZXNlbnRhdGlvbiBvZiBhIENvbGxlY3Rpb24gaXMgYW4gYXJyYXkgb2YgdGhlDQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLg0KICAgIHRvSlNPTjogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKG1vZGVsKXsgcmV0dXJuIG1vZGVsLnRvSlNPTihvcHRpb25zKTsgfSk7DQogICAgfSwNCg0KICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0Lg0KICAgIHN5bmM6IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCiAgICB9LA0KDQogICAgLy8gQWRkIGEgbW9kZWwsIG9yIGxpc3Qgb2YgbW9kZWxzIHRvIHRoZSBzZXQuIFBhc3MgKipzaWxlbnQqKiB0byBhdm9pZA0KICAgIC8vIGZpcmluZyB0aGUgYGFkZGAgZXZlbnQgZm9yIGV2ZXJ5IG5ldyBtb2RlbC4NCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgew0KICAgICAgdmFyIGksIGFyZ3MsIGxlbmd0aCwgbW9kZWwsIGV4aXN0aW5nLCBuZWVkc1NvcnQ7DQogICAgICB2YXIgYXQgPSBvcHRpb25zICYmIG9wdGlvbnMuYXQ7DQogICAgICB2YXIgc29ydCA9ICgob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpID09IG51bGwgPyB0cnVlIDogb3B0aW9ucy5zb3J0KTsNCiAgICAgIG1vZGVscyA9IF8uaXNBcnJheShtb2RlbHMpID8gbW9kZWxzLnNsaWNlKCkgOiBbbW9kZWxzXTsNCg0KICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscw0KICAgICAgLy8gZnJvbSBiZWluZyBhZGRlZC4NCiAgICAgIGZvciAoaSA9IG1vZGVscy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgew0KICAgICAgICBpZighKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7DQogICAgICAgICAgdGhpcy50cmlnZ2VyKCJlcnJvciIsIHRoaXMsIG1vZGVsc1tpXSwgb3B0aW9ucyk7DQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KICAgICAgICBtb2RlbHNbaV0gPSBtb2RlbDsNCg0KICAgICAgICBleGlzdGluZyA9IG1vZGVsLmlkICE9IG51bGwgJiYgdGhpcy5fYnlJZFttb2RlbC5pZF07DQogICAgICAgIC8vIElmIGEgZHVwbGljYXRlIGlzIGZvdW5kLCBwcmV2ZW50IGl0IGZyb20gYmVpbmcgYWRkZWQgYW5kDQogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuDQogICAgICAgIGlmIChleGlzdGluZyB8fCB0aGlzLl9ieUNpZFttb2RlbC5jaWRdKSB7DQogICAgICAgICAgaWYgKG9wdGlvbnMgJiYgb3B0aW9ucy5tZXJnZSAmJiBleGlzdGluZykgew0KICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOw0KICAgICAgICAgICAgbmVlZHNTb3J0ID0gc29ydDsNCiAgICAgICAgICB9DQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsNCiAgICAgICAgICBjb250aW51ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIExpc3RlbiB0byBhZGRlZCBtb2RlbHMnIGV2ZW50cywgYW5kIGluZGV4IG1vZGVscyBmb3IgbG9va3VwIGJ5DQogICAgICAgIC8vIGBpZGAgYW5kIGJ5IGBjaWRgLg0KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsNCiAgICAgICAgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXSA9IG1vZGVsOw0KICAgICAgICBpZiAobW9kZWwuaWQgIT0gbnVsbCkgdGhpcy5fYnlJZFttb2RlbC5pZF0gPSBtb2RlbDsNCiAgICAgIH0NCg0KICAgICAgLy8gU2VlIGlmIHNvcnRpbmcgaXMgbmVlZGVkLCB1cGRhdGUgYGxlbmd0aGAgYW5kIHNwbGljZSBpbiBuZXcgbW9kZWxzLg0KICAgICAgaWYgKG1vZGVscy5sZW5ndGgpIG5lZWRzU29ydCA9IHNvcnQ7DQogICAgICB0aGlzLmxlbmd0aCArPSBtb2RlbHMubGVuZ3RoOw0KICAgICAgYXJncyA9IFthdCAhPSBudWxsID8gYXQgOiB0aGlzLm1vZGVscy5sZW5ndGgsIDBdOw0KICAgICAgcHVzaC5hcHBseShhcmdzLCBtb2RlbHMpOw0KICAgICAgc3BsaWNlLmFwcGx5KHRoaXMubW9kZWxzLCBhcmdzKTsNCg0KICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4NCiAgICAgIGlmIChuZWVkc1NvcnQgJiYgdGhpcy5jb21wYXJhdG9yICYmIGF0ID09IG51bGwpIHRoaXMuc29ydCh7c2lsZW50OiB0cnVlfSk7DQoNCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsNCg0KICAgICAgLy8gVHJpZ2dlciBgYWRkYCBldmVudHMuDQogICAgICB3aGlsZSAobW9kZWwgPSBtb2RlbHMuc2hpZnQoKSkgew0KICAgICAgICBtb2RlbC50cmlnZ2VyKCdhZGQnLCBtb2RlbCwgdGhpcywgb3B0aW9ucyk7DQogICAgICB9DQoNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBSZW1vdmUgYSBtb2RlbCwgb3IgYSBsaXN0IG9mIG1vZGVscyBmcm9tIHRoZSBzZXQuIFBhc3Mgc2lsZW50IHRvIGF2b2lkDQogICAgLy8gZmlyaW5nIHRoZSBgcmVtb3ZlYCBldmVudCBmb3IgZXZlcnkgbW9kZWwgcmVtb3ZlZC4NCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgew0KICAgICAgdmFyIGksIGwsIGluZGV4LCBtb2RlbDsNCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7DQogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107DQogICAgICBmb3IgKGkgPSAwLCBsID0gbW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgew0KICAgICAgICBtb2RlbCA9IHRoaXMuZ2V0KG1vZGVsc1tpXSk7DQogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOw0KICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5pZF07DQogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUNpZFttb2RlbC5jaWRdOw0KICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7DQogICAgICAgIHRoaXMubW9kZWxzLnNwbGljZShpbmRleCwgMSk7DQogICAgICAgIHRoaXMubGVuZ3RoLS07DQogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsNCiAgICAgICAgICBvcHRpb25zLmluZGV4ID0gaW5kZXg7DQogICAgICAgICAgbW9kZWwudHJpZ2dlcigncmVtb3ZlJywgbW9kZWwsIHRoaXMsIG9wdGlvbnMpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZShtb2RlbCk7DQogICAgICB9DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4NCiAgICBwdXNoOiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgew0KICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7DQogICAgICByZXR1cm4gbW9kZWw7DQogICAgfSwNCg0KICAgIC8vIFJlbW92ZSBhIG1vZGVsIGZyb20gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4NCiAgICBwb3A6IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsNCiAgICAgIHRoaXMucmVtb3ZlKG1vZGVsLCBvcHRpb25zKTsNCiAgICAgIHJldHVybiBtb2RlbDsNCiAgICB9LA0KDQogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgY29sbGVjdGlvbi4NCiAgICB1bnNoaWZ0OiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgew0KICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogMH0sIG9wdGlvbnMpKTsNCiAgICAgIHJldHVybiBtb2RlbDsNCiAgICB9LA0KDQogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLg0KICAgIHNoaWZ0OiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICB2YXIgbW9kZWwgPSB0aGlzLmF0KDApOw0KICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgcmV0dXJuIG1vZGVsOw0KICAgIH0sDQoNCiAgICAvLyBTbGljZSBvdXQgYSBzdWItYXJyYXkgb2YgbW9kZWxzIGZyb20gdGhlIGNvbGxlY3Rpb24uDQogICAgc2xpY2U6IGZ1bmN0aW9uKGJlZ2luLCBlbmQpIHsNCiAgICAgIHJldHVybiB0aGlzLm1vZGVscy5zbGljZShiZWdpbiwgZW5kKTsNCiAgICB9LA0KDQogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLg0KICAgIGdldDogZnVuY3Rpb24ob2JqKSB7DQogICAgICBpZiAob2JqID09IG51bGwpIHJldHVybiB2b2lkIDA7DQogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgIT0gbnVsbCA/IG9iai5pZCA6IG9ial0gfHwgdGhpcy5fYnlDaWRbb2JqLmNpZCB8fCBvYmpdOw0KICAgIH0sDQoNCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4NCiAgICBhdDogZnVuY3Rpb24oaW5kZXgpIHsNCiAgICAgIHJldHVybiB0aGlzLm1vZGVsc1tpbmRleF07DQogICAgfSwNCg0KICAgIC8vIFJldHVybiBtb2RlbHMgd2l0aCBtYXRjaGluZyBhdHRyaWJ1dGVzLiBVc2VmdWwgZm9yIHNpbXBsZSBjYXNlcyBvZiBgZmlsdGVyYC4NCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsNCiAgICAgIGlmIChfLmlzRW1wdHkoYXR0cnMpKSByZXR1cm4gW107DQogICAgICByZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24obW9kZWwpIHsNCiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7DQogICAgICAgICAgaWYgKGF0dHJzW2tleV0gIT09IG1vZGVsLmdldChrZXkpKSByZXR1cm4gZmFsc2U7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9KTsNCiAgICB9LA0KDQogICAgLy8gRm9yY2UgdGhlIGNvbGxlY3Rpb24gdG8gcmUtc29ydCBpdHNlbGYuIFlvdSBkb24ndCBuZWVkIHRvIGNhbGwgdGhpcyB1bmRlcg0KICAgIC8vIG5vcm1hbCBjaXJjdW1zdGFuY2VzLCBhcyB0aGUgc2V0IHdpbGwgbWFpbnRhaW4gc29ydCBvcmRlciBhcyBlYWNoIGl0ZW0NCiAgICAvLyBpcyBhZGRlZC4NCiAgICBzb3J0OiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICBpZiAoIXRoaXMuY29tcGFyYXRvcikgew0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7DQogICAgICB9DQoNCiAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgew0KICAgICAgICB0aGlzLm1vZGVscyA9IHRoaXMuc29ydEJ5KHRoaXMuY29tcGFyYXRvciwgdGhpcyk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsNCiAgICAgIH0NCg0KICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gUGx1Y2sgYW4gYXR0cmlidXRlIGZyb20gZWFjaCBtb2RlbCBpbiB0aGUgY29sbGVjdGlvbi4NCiAgICBwbHVjazogZnVuY3Rpb24oYXR0cikgew0KICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7DQogICAgfSwNCg0KICAgIC8vIFNtYXJ0bHkgdXBkYXRlIGEgY29sbGVjdGlvbiB3aXRoIGEgY2hhbmdlIHNldCBvZiBtb2RlbHMsIGFkZGluZywNCiAgICAvLyByZW1vdmluZywgYW5kIG1lcmdpbmcgYXMgbmVjZXNzYXJ5Lg0KICAgIHVwZGF0ZTogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7DQogICAgICB2YXIgbW9kZWwsIGksIGwsIGV4aXN0aW5nOw0KICAgICAgdmFyIGFkZCA9IFtdLCByZW1vdmUgPSBbXSwgbW9kZWxNYXAgPSB7fTsNCiAgICAgIHZhciBpZEF0dHIgPSB0aGlzLm1vZGVsLnByb3RvdHlwZS5pZEF0dHJpYnV0ZTsNCiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7YWRkOiB0cnVlLCBtZXJnZTogdHJ1ZSwgcmVtb3ZlOiB0cnVlfSwgb3B0aW9ucyk7DQogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOw0KDQogICAgICAvLyBBbGxvdyBhIHNpbmdsZSBtb2RlbCAob3Igbm8gYXJndW1lbnQpIHRvIGJlIHBhc3NlZC4NCiAgICAgIGlmICghXy5pc0FycmF5KG1vZGVscykpIG1vZGVscyA9IG1vZGVscyA/IFttb2RlbHNdIDogW107DQoNCiAgICAgIC8vIFByb3h5IHRvIGBhZGRgIGZvciB0aGlzIGNhc2UsIG5vIG5lZWQgdG8gaXRlcmF0ZS4uLg0KICAgICAgaWYgKG9wdGlvbnMuYWRkICYmICFvcHRpb25zLnJlbW92ZSkgcmV0dXJuIHRoaXMuYWRkKG1vZGVscywgb3B0aW9ucyk7DQoNCiAgICAgIC8vIERldGVybWluZSB3aGljaCBtb2RlbHMgdG8gYWRkIGFuZCBtZXJnZSwgYW5kIHdoaWNoIHRvIHJlbW92ZS4NCiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7DQogICAgICAgIG1vZGVsID0gbW9kZWxzW2ldOw0KICAgICAgICBleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsLmlkIHx8IG1vZGVsLmNpZCB8fCBtb2RlbFtpZEF0dHJdKTsNCiAgICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlICYmIGV4aXN0aW5nKSBtb2RlbE1hcFtleGlzdGluZy5jaWRdID0gdHJ1ZTsNCiAgICAgICAgaWYgKChvcHRpb25zLmFkZCAmJiAhZXhpc3RpbmcpIHx8IChvcHRpb25zLm1lcmdlICYmIGV4aXN0aW5nKSkgew0KICAgICAgICAgIGFkZC5wdXNoKG1vZGVsKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7DQogICAgICAgIGZvciAoaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgICBtb2RlbCA9IHRoaXMubW9kZWxzW2ldOw0KICAgICAgICAgIGlmICghbW9kZWxNYXBbbW9kZWwuY2lkXSkgcmVtb3ZlLnB1c2gobW9kZWwpOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIC8vIFJlbW92ZSBtb2RlbHMgKGlmIGFwcGxpY2FibGUpIGJlZm9yZSB3ZSBhZGQgYW5kIG1lcmdlIHRoZSByZXN0Lg0KICAgICAgaWYgKHJlbW92ZS5sZW5ndGgpIHRoaXMucmVtb3ZlKHJlbW92ZSwgb3B0aW9ucyk7DQogICAgICBpZiAoYWRkLmxlbmd0aCkgdGhpcy5hZGQoYWRkLCBvcHRpb25zKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBXaGVuIHlvdSBoYXZlIG1vcmUgaXRlbXMgdGhhbiB5b3Ugd2FudCB0byBhZGQgb3IgcmVtb3ZlIGluZGl2aWR1YWxseSwNCiAgICAvLyB5b3UgY2FuIHJlc2V0IHRoZSBlbnRpcmUgc2V0IHdpdGggYSBuZXcgbGlzdCBvZiBtb2RlbHMsIHdpdGhvdXQgZmlyaW5nDQogICAgLy8gYW55IGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLg0KICAgIHJlc2V0OiBmdW5jdGlvbihtb2RlbHMsIG9wdGlvbnMpIHsNCiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7DQogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOw0KICAgICAgZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsNCiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKHRoaXMubW9kZWxzW2ldKTsNCiAgICAgIH0NCiAgICAgIG9wdGlvbnMucHJldmlvdXNNb2RlbHMgPSB0aGlzLm1vZGVsczsNCiAgICAgIHRoaXMuX3Jlc2V0KCk7DQogICAgICBpZiAobW9kZWxzKSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7DQogICAgICBpZiAoIW9wdGlvbnMuc2lsZW50KSB0aGlzLnRyaWdnZXIoJ3Jlc2V0JywgdGhpcywgb3B0aW9ucyk7DQogICAgICByZXR1cm4gdGhpczsNCiAgICB9LA0KDQogICAgLy8gRmV0Y2ggdGhlIGRlZmF1bHQgc2V0IG9mIG1vZGVscyBmb3IgdGhpcyBjb2xsZWN0aW9uLCByZXNldHRpbmcgdGhlDQogICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgYWRkOiB0cnVlYCBpcyBwYXNzZWQsIGFwcGVuZHMgdGhlDQogICAgLy8gbW9kZWxzIHRvIHRoZSBjb2xsZWN0aW9uIGluc3RlYWQgb2YgcmVzZXR0aW5nLg0KICAgIGZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsNCiAgICAgIGlmIChvcHRpb25zLnBhcnNlID09PSB2b2lkIDApIG9wdGlvbnMucGFyc2UgPSB0cnVlOw0KICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOw0KICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7DQogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgew0KICAgICAgICB2YXIgbWV0aG9kID0gb3B0aW9ucy51cGRhdGUgPyAndXBkYXRlJyA6ICdyZXNldCc7DQogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsNCiAgICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MoY29sbGVjdGlvbiwgcmVzcCwgb3B0aW9ucyk7DQogICAgICB9Ow0KICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOw0KICAgIH0sDQoNCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlDQogICAgLy8gY29sbGVjdGlvbiBpbW1lZGlhdGVseSwgdW5sZXNzIGB3YWl0OiB0cnVlYCBpcyBwYXNzZWQsIGluIHdoaWNoIGNhc2Ugd2UNCiAgICAvLyB3YWl0IGZvciB0aGUgc2VydmVyIHRvIGFncmVlLg0KICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsNCiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsNCiAgICAgIG9wdGlvbnMgPSBvcHRpb25zID8gXy5jbG9uZShvcHRpb25zKSA6IHt9Ow0KICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgaWYgKCFtb2RlbCkgcmV0dXJuIGZhbHNlOw0KICAgICAgaWYgKCFvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsNCiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOw0KICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24obW9kZWwsIHJlc3AsIG9wdGlvbnMpIHsNCiAgICAgICAgaWYgKG9wdGlvbnMud2FpdCkgY29sbGVjdGlvbi5hZGQobW9kZWwsIG9wdGlvbnMpOw0KICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7DQogICAgICB9Ow0KICAgICAgbW9kZWwuc2F2ZShudWxsLCBvcHRpb25zKTsNCiAgICAgIHJldHVybiBtb2RlbDsNCiAgICB9LA0KDQogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQ0KICAgIC8vIGNvbGxlY3Rpb24uIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyBpdCB0aHJvdWdoLg0KICAgIHBhcnNlOiBmdW5jdGlvbihyZXNwKSB7DQogICAgICByZXR1cm4gcmVzcDsNCiAgICB9LA0KDQogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuDQogICAgY2xvbmU6IGZ1bmN0aW9uKCkgew0KICAgICAgcmV0dXJuIG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMubW9kZWxzKTsNCiAgICB9LA0KDQogICAgLy8gUHJveHkgdG8gXydzIGNoYWluLiBDYW4ndCBiZSBwcm94aWVkIHRoZSBzYW1lIHdheSB0aGUgcmVzdCBvZiB0aGUNCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUNCiAgICAvLyBjb25zdHJ1Y3Rvci4NCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7DQogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsNCiAgICB9LA0KDQogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4NCiAgICBfcmVzZXQ6IGZ1bmN0aW9uKCkgew0KICAgICAgdGhpcy5sZW5ndGggPSAwOw0KICAgICAgdGhpcy5tb2RlbHMgPSBbXTsNCiAgICAgIHRoaXMuX2J5SWQgID0ge307DQogICAgICB0aGlzLl9ieUNpZCA9IHt9Ow0KICAgIH0sDQoNCiAgICAvLyBQcmVwYXJlIGEgbW9kZWwgb3IgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGFkZGVkIHRvIHRoaXMgY29sbGVjdGlvbi4NCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgew0KICAgICAgaWYgKGF0dHJzIGluc3RhbmNlb2YgTW9kZWwpIHsNCiAgICAgICAgaWYgKCFhdHRycy5jb2xsZWN0aW9uKSBhdHRycy5jb2xsZWN0aW9uID0gdGhpczsNCiAgICAgICAgcmV0dXJuIGF0dHJzOw0KICAgICAgfQ0KICAgICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsNCiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7DQogICAgICB2YXIgbW9kZWwgPSBuZXcgdGhpcy5tb2RlbChhdHRycywgb3B0aW9ucyk7DQogICAgICBpZiAoIW1vZGVsLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsNCiAgICAgIHJldHVybiBtb2RlbDsNCiAgICB9LA0KDQogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uDQogICAgX3JlbW92ZVJlZmVyZW5jZTogZnVuY3Rpb24obW9kZWwpIHsNCiAgICAgIGlmICh0aGlzID09PSBtb2RlbC5jb2xsZWN0aW9uKSBkZWxldGUgbW9kZWwuY29sbGVjdGlvbjsNCiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsNCiAgICB9LA0KDQogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4NCiAgICAvLyBTZXRzIG5lZWQgdG8gdXBkYXRlIHRoZWlyIGluZGV4ZXMgd2hlbiBtb2RlbHMgY2hhbmdlIGlkcy4gQWxsIG90aGVyDQogICAgLy8gZXZlbnRzIHNpbXBseSBwcm94eSB0aHJvdWdoLiAiYWRkIiBhbmQgInJlbW92ZSIgZXZlbnRzIHRoYXQgb3JpZ2luYXRlDQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuDQogICAgX29uTW9kZWxFdmVudDogZnVuY3Rpb24oZXZlbnQsIG1vZGVsLCBjb2xsZWN0aW9uLCBvcHRpb25zKSB7DQogICAgICBpZiAoKGV2ZW50ID09PSAnYWRkJyB8fCBldmVudCA9PT0gJ3JlbW92ZScpICYmIGNvbGxlY3Rpb24gIT09IHRoaXMpIHJldHVybjsNCiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7DQogICAgICBpZiAobW9kZWwgJiYgZXZlbnQgPT09ICdjaGFuZ2U6JyArIG1vZGVsLmlkQXR0cmlidXRlKSB7DQogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLnByZXZpb3VzKG1vZGVsLmlkQXR0cmlidXRlKV07DQogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOw0KICAgICAgfQ0KICAgICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogICAgfQ0KDQogIH0pOw0KDQogIC8vIFVuZGVyc2NvcmUgbWV0aG9kcyB0aGF0IHdlIHdhbnQgdG8gaW1wbGVtZW50IG9uIHRoZSBDb2xsZWN0aW9uLg0KICB2YXIgbWV0aG9kcyA9IFsnZm9yRWFjaCcsICdlYWNoJywgJ21hcCcsICdjb2xsZWN0JywgJ3JlZHVjZScsICdmb2xkbCcsDQogICAgJ2luamVjdCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywNCiAgICAncmVqZWN0JywgJ2V2ZXJ5JywgJ2FsbCcsICdzb21lJywgJ2FueScsICdpbmNsdWRlJywgJ2NvbnRhaW5zJywgJ2ludm9rZScsDQogICAgJ21heCcsICdtaW4nLCAnc29ydGVkSW5kZXgnLCAndG9BcnJheScsICdzaXplJywgJ2ZpcnN0JywgJ2hlYWQnLCAndGFrZScsDQogICAgJ2luaXRpYWwnLCAncmVzdCcsICd0YWlsJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLA0KICAgICdsYXN0SW5kZXhPZicsICdpc0VtcHR5J107DQoNCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLg0KICBfLmVhY2gobWV0aG9kcywgZnVuY3Rpb24obWV0aG9kKSB7DQogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKCkgew0KICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7DQogICAgICBhcmdzLnVuc2hpZnQodGhpcy5tb2RlbHMpOw0KICAgICAgcmV0dXJuIF9bbWV0aG9kXS5hcHBseShfLCBhcmdzKTsNCiAgICB9Ow0KICB9KTsNCg0KICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4NCiAgdmFyIGF0dHJpYnV0ZU1ldGhvZHMgPSBbJ2dyb3VwQnknLCAnY291bnRCeScsICdzb3J0QnknXTsNCg0KICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuDQogIF8uZWFjaChhdHRyaWJ1dGVNZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsNCiAgICBDb2xsZWN0aW9uLnByb3RvdHlwZVttZXRob2RdID0gZnVuY3Rpb24odmFsdWUsIGNvbnRleHQpIHsNCiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7DQogICAgICAgIHJldHVybiBtb2RlbC5nZXQodmFsdWUpOw0KICAgICAgfTsNCiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsNCiAgICB9Ow0KICB9KTsNCg0KICAvLyBCYWNrYm9uZS5Sb3V0ZXINCiAgLy8gLS0tLS0tLS0tLS0tLS0tDQoNCiAgLy8gUm91dGVycyBtYXAgZmF1eC1VUkxzIHRvIGFjdGlvbnMsIGFuZCBmaXJlIGV2ZW50cyB3aGVuIHJvdXRlcyBhcmUNCiAgLy8gbWF0Y2hlZC4gQ3JlYXRpbmcgYSBuZXcgb25lIHNldHMgaXRzIGByb3V0ZXNgIGhhc2gsIGlmIG5vdCBzZXQgc3RhdGljYWxseS4NCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOw0KICAgIGlmIChvcHRpb25zLnJvdXRlcykgdGhpcy5yb3V0ZXMgPSBvcHRpb25zLnJvdXRlczsNCiAgICB0aGlzLl9iaW5kUm91dGVzKCk7DQogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQogIH07DQoNCiAgLy8gQ2FjaGVkIHJlZ3VsYXIgZXhwcmVzc2lvbnMgZm9yIG1hdGNoaW5nIG5hbWVkIHBhcmFtIHBhcnRzIGFuZCBzcGxhdHRlZA0KICAvLyBwYXJ0cyBvZiByb3V0ZSBzdHJpbmdzLg0KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsNCiAgdmFyIG5hbWVkUGFyYW0gICAgPSAvOlx3Ky9nOw0KICB2YXIgc3BsYXRQYXJhbSAgICA9IC9cKlx3Ky9nOw0KICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOw0KDQogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5Sb3V0ZXIqKiBwcm9wZXJ0aWVzIGFuZCBtZXRob2RzLg0KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsNCg0KICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bg0KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLg0KICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKCl7fSwNCg0KICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6DQogICAgLy8NCiAgICAvLyAgICAgdGhpcy5yb3V0ZSgnc2VhcmNoLzpxdWVyeS9wOm51bScsICdzZWFyY2gnLCBmdW5jdGlvbihxdWVyeSwgbnVtKSB7DQogICAgLy8gICAgICAgLi4uDQogICAgLy8gICAgIH0pOw0KICAgIC8vDQogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgew0KICAgICAgaWYgKCFfLmlzUmVnRXhwKHJvdXRlKSkgcm91dGUgPSB0aGlzLl9yb3V0ZVRvUmVnRXhwKHJvdXRlKTsNCiAgICAgIGlmICghY2FsbGJhY2spIGNhbGxiYWNrID0gdGhpc1tuYW1lXTsNCiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIF8uYmluZChmdW5jdGlvbihmcmFnbWVudCkgew0KICAgICAgICB2YXIgYXJncyA9IHRoaXMuX2V4dHJhY3RQYXJhbWV0ZXJzKHJvdXRlLCBmcmFnbWVudCk7DQogICAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3MpOw0KICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsNCiAgICAgICAgQmFja2JvbmUuaGlzdG9yeS50cmlnZ2VyKCdyb3V0ZScsIHRoaXMsIG5hbWUsIGFyZ3MpOw0KICAgICAgfSwgdGhpcykpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuDQogICAgbmF2aWdhdGU6IGZ1bmN0aW9uKGZyYWdtZW50LCBvcHRpb25zKSB7DQogICAgICBCYWNrYm9uZS5oaXN0b3J5Lm5hdmlnYXRlKGZyYWdtZW50LCBvcHRpb25zKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUNCiAgICAvLyBvcmRlciBvZiB0aGUgcm91dGVzIGhlcmUgdG8gc3VwcG9ydCBiZWhhdmlvciB3aGVyZSB0aGUgbW9zdCBnZW5lcmFsDQogICAgLy8gcm91dGVzIGNhbiBiZSBkZWZpbmVkIGF0IHRoZSBib3R0b20gb2YgdGhlIHJvdXRlIG1hcC4NCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7DQogICAgICBpZiAoIXRoaXMucm91dGVzKSByZXR1cm47DQogICAgICB2YXIgcm91dGUsIHJvdXRlcyA9IF8ua2V5cyh0aGlzLnJvdXRlcyk7DQogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7DQogICAgICAgIHRoaXMucm91dGUocm91dGUsIHRoaXMucm91dGVzW3JvdXRlXSk7DQogICAgICB9DQogICAgfSwNCg0KICAgIC8vIENvbnZlcnQgYSByb3V0ZSBzdHJpbmcgaW50byBhIHJlZ3VsYXIgZXhwcmVzc2lvbiwgc3VpdGFibGUgZm9yIG1hdGNoaW5nDQogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLg0KICAgIF9yb3V0ZVRvUmVnRXhwOiBmdW5jdGlvbihyb3V0ZSkgew0KICAgICAgcm91dGUgPSByb3V0ZS5yZXBsYWNlKGVzY2FwZVJlZ0V4cCwgJ1xcJCYnKQ0KICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykNCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShuYW1lZFBhcmFtLCAnKFteXC9dKyknKQ0KICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKHNwbGF0UGFyYW0sICcoLio/KScpOw0KICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOw0KICAgIH0sDQoNCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mDQogICAgLy8gZXh0cmFjdGVkIHBhcmFtZXRlcnMuDQogICAgX2V4dHJhY3RQYXJhbWV0ZXJzOiBmdW5jdGlvbihyb3V0ZSwgZnJhZ21lbnQpIHsNCiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsNCiAgICB9DQoNCiAgfSk7DQoNCiAgLy8gQmFja2JvbmUuSGlzdG9yeQ0KICAvLyAtLS0tLS0tLS0tLS0tLS0tDQoNCiAgLy8gSGFuZGxlcyBjcm9zcy1icm93c2VyIGhpc3RvcnkgbWFuYWdlbWVudCwgYmFzZWQgb24gVVJMIGZyYWdtZW50cy4gSWYgdGhlDQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLg0KICB2YXIgSGlzdG9yeSA9IEJhY2tib25lLkhpc3RvcnkgPSBmdW5jdGlvbigpIHsNCiAgICB0aGlzLmhhbmRsZXJzID0gW107DQogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOw0KDQogICAgLy8gRW5zdXJlIHRoYXQgYEhpc3RvcnlgIGNhbiBiZSB1c2VkIG91dHNpZGUgb2YgdGhlIGJyb3dzZXIuDQogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7DQogICAgICB0aGlzLmxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uOw0KICAgICAgdGhpcy5oaXN0b3J5ID0gd2luZG93Lmhpc3Rvcnk7DQogICAgfQ0KICB9Ow0KDQogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4NCiAgdmFyIHJvdXRlU3RyaXBwZXIgPSAvXlsjXC9dfFxzKyQvZzsNCg0KICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLg0KICB2YXIgcm9vdFN0cmlwcGVyID0gL15cLyt8XC8rJC9nOw0KDQogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuDQogIHZhciBpc0V4cGxvcmVyID0gL21zaWUgW1x3Ll0rLzsNCg0KICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guDQogIHZhciB0cmFpbGluZ1NsYXNoID0gL1wvJC87DQoNCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPw0KICBIaXN0b3J5LnN0YXJ0ZWQgPSBmYWxzZTsNCg0KICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuDQogIF8uZXh0ZW5kKEhpc3RvcnkucHJvdG90eXBlLCBFdmVudHMsIHsNCg0KICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcw0KICAgIC8vIHR3ZW50eSB0aW1lcyBhIHNlY29uZC4NCiAgICBpbnRlcnZhbDogNTAsDQoNCiAgICAvLyBHZXRzIHRoZSB0cnVlIGhhc2ggdmFsdWUuIENhbm5vdCB1c2UgbG9jYXRpb24uaGFzaCBkaXJlY3RseSBkdWUgdG8gYnVnDQogICAgLy8gaW4gRmlyZWZveCB3aGVyZSBsb2NhdGlvbi5oYXNoIHdpbGwgYWx3YXlzIGJlIGRlY29kZWQuDQogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7DQogICAgICB2YXIgbWF0Y2ggPSAod2luZG93IHx8IHRoaXMpLmxvY2F0aW9uLmhyZWYubWF0Y2goLyMoLiopJC8pOw0KICAgICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiAnJzsNCiAgICB9LA0KDQogICAgLy8gR2V0IHRoZSBjcm9zcy1icm93c2VyIG5vcm1hbGl6ZWQgVVJMIGZyYWdtZW50LCBlaXRoZXIgZnJvbSB0aGUgVVJMLA0KICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuDQogICAgZ2V0RnJhZ21lbnQ6IGZ1bmN0aW9uKGZyYWdtZW50LCBmb3JjZVB1c2hTdGF0ZSkgew0KICAgICAgaWYgKGZyYWdtZW50ID09IG51bGwpIHsNCiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7DQogICAgICAgICAgZnJhZ21lbnQgPSB0aGlzLmxvY2F0aW9uLnBhdGhuYW1lOw0KICAgICAgICAgIHZhciByb290ID0gdGhpcy5yb290LnJlcGxhY2UodHJhaWxpbmdTbGFzaCwgJycpOw0KICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHJldHVybiBmcmFnbWVudC5yZXBsYWNlKHJvdXRlU3RyaXBwZXIsICcnKTsNCiAgICB9LA0KDQogICAgLy8gU3RhcnQgdGhlIGhhc2ggY2hhbmdlIGhhbmRsaW5nLCByZXR1cm5pbmcgYHRydWVgIGlmIHRoZSBjdXJyZW50IFVSTCBtYXRjaGVzDQogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4NCiAgICBzdGFydDogZnVuY3Rpb24ob3B0aW9ucykgew0KICAgICAgaWYgKEhpc3Rvcnkuc3RhcnRlZCkgdGhyb3cgbmV3IEVycm9yKCJCYWNrYm9uZS5oaXN0b3J5IGhhcyBhbHJlYWR5IGJlZW4gc3RhcnRlZCIpOw0KICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsNCg0KICAgICAgLy8gRmlndXJlIG91dCB0aGUgaW5pdGlhbCBjb25maWd1cmF0aW9uLiBEbyB3ZSBuZWVkIGFuIGlmcmFtZT8NCiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/DQogICAgICB0aGlzLm9wdGlvbnMgICAgICAgICAgPSBfLmV4dGVuZCh7fSwge3Jvb3Q6ICcvJ30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyk7DQogICAgICB0aGlzLnJvb3QgICAgICAgICAgICAgPSB0aGlzLm9wdGlvbnMucm9vdDsNCiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsNCiAgICAgIHRoaXMuX3dhbnRzUHVzaFN0YXRlICA9ICEhdGhpcy5vcHRpb25zLnB1c2hTdGF0ZTsNCiAgICAgIHRoaXMuX2hhc1B1c2hTdGF0ZSAgICA9ICEhKHRoaXMub3B0aW9ucy5wdXNoU3RhdGUgJiYgdGhpcy5oaXN0b3J5ICYmIHRoaXMuaGlzdG9yeS5wdXNoU3RhdGUpOw0KICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOw0KICAgICAgdmFyIGRvY01vZGUgICAgICAgICAgID0gZG9jdW1lbnQuZG9jdW1lbnRNb2RlOw0KICAgICAgdmFyIG9sZElFICAgICAgICAgICAgID0gKGlzRXhwbG9yZXIuZXhlYyhuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkpICYmICghZG9jTW9kZSB8fCBkb2NNb2RlIDw9IDcpKTsNCg0KICAgICAgLy8gTm9ybWFsaXplIHJvb3QgdG8gYWx3YXlzIGluY2x1ZGUgYSBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaC4NCiAgICAgIHRoaXMucm9vdCA9ICgnLycgKyB0aGlzLnJvb3QgKyAnLycpLnJlcGxhY2Uocm9vdFN0cmlwcGVyLCAnLycpOw0KDQogICAgICBpZiAob2xkSUUgJiYgdGhpcy5fd2FudHNIYXNoQ2hhbmdlKSB7DQogICAgICAgIHRoaXMuaWZyYW1lID0gQmFja2JvbmUuJCgnPGlmcmFtZSBzcmM9ImphdmFzY3JpcHQ6MCIgdGFiaW5kZXg9Ii0xIiAvPicpLmhpZGUoKS5hcHBlbmRUbygnYm9keScpWzBdLmNvbnRlbnRXaW5kb3c7DQogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOw0KICAgICAgfQ0KDQogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcg0KICAgICAgLy8gJ29uaGFzaGNoYW5nZScgaXMgc3VwcG9ydGVkLCBkZXRlcm1pbmUgaG93IHdlIGNoZWNrIHRoZSBVUkwgc3RhdGUuDQogICAgICBpZiAodGhpcy5faGFzUHVzaFN0YXRlKSB7DQogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOw0KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgKCdvbmhhc2hjaGFuZ2UnIGluIHdpbmRvdykgJiYgIW9sZElFKSB7DQogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7DQogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgew0KICAgICAgICB0aGlzLl9jaGVja1VybEludGVydmFsID0gc2V0SW50ZXJ2YWwodGhpcy5jaGVja1VybCwgdGhpcy5pbnRlcnZhbCk7DQogICAgICB9DQoNCiAgICAgIC8vIERldGVybWluZSBpZiB3ZSBuZWVkIHRvIGNoYW5nZSB0aGUgYmFzZSB1cmwsIGZvciBhIHB1c2hTdGF0ZSBsaW5rDQogICAgICAvLyBvcGVuZWQgYnkgYSBub24tcHVzaFN0YXRlIGJyb3dzZXIuDQogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7DQogICAgICB2YXIgbG9jID0gdGhpcy5sb2NhdGlvbjsNCiAgICAgIHZhciBhdFJvb3QgPSBsb2MucGF0aG5hbWUucmVwbGFjZSgvW15cL10kLywgJyQmLycpID09PSB0aGlzLnJvb3Q7DQoNCiAgICAgIC8vIElmIHdlJ3ZlIHN0YXJ0ZWQgb2ZmIHdpdGggYSByb3V0ZSBmcm9tIGEgYHB1c2hTdGF0ZWAtZW5hYmxlZCBicm93c2VyLA0KICAgICAgLy8gYnV0IHdlJ3JlIGN1cnJlbnRseSBpbiBhIGJyb3dzZXIgdGhhdCBkb2Vzbid0IHN1cHBvcnQgaXQuLi4NCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7DQogICAgICAgIHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KG51bGwsIHRydWUpOw0KICAgICAgICB0aGlzLmxvY2F0aW9uLnJlcGxhY2UodGhpcy5yb290ICsgdGhpcy5sb2NhdGlvbi5zZWFyY2ggKyAnIycgKyB0aGlzLmZyYWdtZW50KTsNCiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsDQogICAgICAgIHJldHVybiB0cnVlOw0KDQogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQ0KICAgICAgLy8gaW4gYSBicm93c2VyIHdoZXJlIGl0IGNvdWxkIGJlIGBwdXNoU3RhdGVgLWJhc2VkIGluc3RlYWQuLi4NCiAgICAgIH0gZWxzZSBpZiAodGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgdGhpcy5faGFzUHVzaFN0YXRlICYmIGF0Um9vdCAmJiBsb2MuaGFzaCkgew0KICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7DQogICAgICAgIHRoaXMuaGlzdG9yeS5yZXBsYWNlU3RhdGUoe30sIGRvY3VtZW50LnRpdGxlLCB0aGlzLnJvb3QgKyB0aGlzLmZyYWdtZW50ICsgbG9jLnNlYXJjaCk7DQogICAgICB9DQoNCiAgICAgIGlmICghdGhpcy5vcHRpb25zLnNpbGVudCkgcmV0dXJuIHRoaXMubG9hZFVybCgpOw0KICAgIH0sDQoNCiAgICAvLyBEaXNhYmxlIEJhY2tib25lLmhpc3RvcnksIHBlcmhhcHMgdGVtcG9yYXJpbHkuIE5vdCB1c2VmdWwgaW4gYSByZWFsIGFwcCwNCiAgICAvLyBidXQgcG9zc2libHkgdXNlZnVsIGZvciB1bml0IHRlc3RpbmcgUm91dGVycy4NCiAgICBzdG9wOiBmdW5jdGlvbigpIHsNCiAgICAgIEJhY2tib25lLiQod2luZG93KS51bmJpbmQoJ3BvcHN0YXRlJywgdGhpcy5jaGVja1VybCkudW5iaW5kKCdoYXNoY2hhbmdlJywgdGhpcy5jaGVja1VybCk7DQogICAgICBjbGVhckludGVydmFsKHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwpOw0KICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7DQogICAgfSwNCg0KICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXINCiAgICAvLyBtYXkgb3ZlcnJpZGUgcHJldmlvdXMgcm91dGVzLg0KICAgIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgY2FsbGJhY2spIHsNCiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsNCiAgICB9LA0KDQogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsDQogICAgLy8gY2FsbHMgYGxvYWRVcmxgLCBub3JtYWxpemluZyBhY3Jvc3MgdGhlIGhpZGRlbiBpZnJhbWUuDQogICAgY2hlY2tVcmw6IGZ1bmN0aW9uKGUpIHsNCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOw0KICAgICAgaWYgKGN1cnJlbnQgPT09IHRoaXMuZnJhZ21lbnQgJiYgdGhpcy5pZnJhbWUpIHsNCiAgICAgICAgY3VycmVudCA9IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSk7DQogICAgICB9DQogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCkgcmV0dXJuIGZhbHNlOw0KICAgICAgaWYgKHRoaXMuaWZyYW1lKSB0aGlzLm5hdmlnYXRlKGN1cnJlbnQpOw0KICAgICAgdGhpcy5sb2FkVXJsKCkgfHwgdGhpcy5sb2FkVXJsKHRoaXMuZ2V0SGFzaCgpKTsNCiAgICB9LA0KDQogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGENCiAgICAvLyBtYXRjaCwgcmV0dXJucyBgdHJ1ZWAuIElmIG5vIGRlZmluZWQgcm91dGVzIG1hdGNoZXMgdGhlIGZyYWdtZW50LA0KICAgIC8vIHJldHVybnMgYGZhbHNlYC4NCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlKSB7DQogICAgICB2YXIgZnJhZ21lbnQgPSB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudE92ZXJyaWRlKTsNCiAgICAgIHZhciBtYXRjaGVkID0gXy5hbnkodGhpcy5oYW5kbGVycywgZnVuY3Rpb24oaGFuZGxlcikgew0KICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgew0KICAgICAgICAgIGhhbmRsZXIuY2FsbGJhY2soZnJhZ21lbnQpOw0KICAgICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgICB9DQogICAgICB9KTsNCiAgICAgIHJldHVybiBtYXRjaGVkOw0KICAgIH0sDQoNCiAgICAvLyBTYXZlIGEgZnJhZ21lbnQgaW50byB0aGUgaGFzaCBoaXN0b3J5LCBvciByZXBsYWNlIHRoZSBVUkwgc3RhdGUgaWYgdGhlDQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZw0KICAgIC8vIHRoZSBmcmFnbWVudCBpbiBhZHZhbmNlLg0KICAgIC8vDQogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQ0KICAgIC8vIHJvdXRlIGNhbGxiYWNrIGJlIGZpcmVkIChub3QgdXN1YWxseSBkZXNpcmFibGUpLCBvciBgcmVwbGFjZTogdHJ1ZWAsIGlmDQogICAgLy8geW91IHdpc2ggdG8gbW9kaWZ5IHRoZSBjdXJyZW50IFVSTCB3aXRob3V0IGFkZGluZyBhbiBlbnRyeSB0byB0aGUgaGlzdG9yeS4NCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsNCiAgICAgIGlmICghSGlzdG9yeS5zdGFydGVkKSByZXR1cm4gZmFsc2U7DQogICAgICBpZiAoIW9wdGlvbnMgfHwgb3B0aW9ucyA9PT0gdHJ1ZSkgb3B0aW9ucyA9IHt0cmlnZ2VyOiBvcHRpb25zfTsNCiAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7DQogICAgICBpZiAodGhpcy5mcmFnbWVudCA9PT0gZnJhZ21lbnQpIHJldHVybjsNCiAgICAgIHRoaXMuZnJhZ21lbnQgPSBmcmFnbWVudDsNCiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsNCg0KICAgICAgLy8gSWYgcHVzaFN0YXRlIGlzIGF2YWlsYWJsZSwgd2UgdXNlIGl0IHRvIHNldCB0aGUgZnJhZ21lbnQgYXMgYSByZWFsIFVSTC4NCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsNCiAgICAgICAgdGhpcy5oaXN0b3J5W29wdGlvbnMucmVwbGFjZSA/ICdyZXBsYWNlU3RhdGUnIDogJ3B1c2hTdGF0ZSddKHt9LCBkb2N1bWVudC50aXRsZSwgdXJsKTsNCg0KICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gNCiAgICAgIC8vIGZyYWdtZW50IHRvIHN0b3JlIGhpc3RvcnkuDQogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgew0KICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOw0KICAgICAgICBpZiAodGhpcy5pZnJhbWUgJiYgKGZyYWdtZW50ICE9PSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpKSkgew0KICAgICAgICAgIC8vIE9wZW5pbmcgYW5kIGNsb3NpbmcgdGhlIGlmcmFtZSB0cmlja3MgSUU3IGFuZCBlYXJsaWVyIHRvIHB1c2ggYQ0KICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0DQogICAgICAgICAgLy8gd2FudCB0aGlzLg0KICAgICAgICAgIGlmKCFvcHRpb25zLnJlcGxhY2UpIHRoaXMuaWZyYW1lLmRvY3VtZW50Lm9wZW4oKS5jbG9zZSgpOw0KICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOw0KICAgICAgICB9DQoNCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQ0KICAgICAgLy8gYmFzZWQgaGlzdG9yeSwgdGhlbiBgbmF2aWdhdGVgIGJlY29tZXMgYSBwYWdlIHJlZnJlc2guDQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsNCiAgICAgIH0NCiAgICAgIGlmIChvcHRpb25zLnRyaWdnZXIpIHRoaXMubG9hZFVybChmcmFnbWVudCk7DQogICAgfSwNCg0KICAgIC8vIFVwZGF0ZSB0aGUgaGFzaCBsb2NhdGlvbiwgZWl0aGVyIHJlcGxhY2luZyB0aGUgY3VycmVudCBlbnRyeSwgb3IgYWRkaW5nDQogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuDQogICAgX3VwZGF0ZUhhc2g6IGZ1bmN0aW9uKGxvY2F0aW9uLCBmcmFnbWVudCwgcmVwbGFjZSkgew0KICAgICAgaWYgKHJlcGxhY2UpIHsNCiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsNCiAgICAgICAgbG9jYXRpb24ucmVwbGFjZShocmVmICsgJyMnICsgZnJhZ21lbnQpOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLg0KICAgICAgICBsb2NhdGlvbi5oYXNoID0gJyMnICsgZnJhZ21lbnQ7DQogICAgICB9DQogICAgfQ0KDQogIH0pOw0KDQogIC8vIENyZWF0ZSB0aGUgZGVmYXVsdCBCYWNrYm9uZS5oaXN0b3J5Lg0KICBCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEhpc3Rvcnk7DQoNCiAgLy8gQmFja2JvbmUuVmlldw0KICAvLyAtLS0tLS0tLS0tLS0tDQoNCiAgLy8gQ3JlYXRpbmcgYSBCYWNrYm9uZS5WaWV3IGNyZWF0ZXMgaXRzIGluaXRpYWwgZWxlbWVudCBvdXRzaWRlIG9mIHRoZSBET00sDQogIC8vIGlmIGFuIGV4aXN0aW5nIGVsZW1lbnQgaXMgbm90IHByb3ZpZGVkLi4uDQogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsNCiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ3ZpZXcnKTsNCiAgICB0aGlzLl9jb25maWd1cmUob3B0aW9ucyB8fCB7fSk7DQogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOw0KICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOw0KICAgIHRoaXMuZGVsZWdhdGVFdmVudHMoKTsNCiAgfTsNCg0KICAvLyBDYWNoZWQgcmVnZXggdG8gc3BsaXQga2V5cyBmb3IgYGRlbGVnYXRlYC4NCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87DQoNCiAgLy8gTGlzdCBvZiB2aWV3IG9wdGlvbnMgdG8gYmUgbWVyZ2VkIGFzIHByb3BlcnRpZXMuDQogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOw0KDQogIC8vIFNldCB1cCBhbGwgaW5oZXJpdGFibGUgKipCYWNrYm9uZS5WaWV3KiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4NCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgew0KDQogICAgLy8gVGhlIGRlZmF1bHQgYHRhZ05hbWVgIG9mIGEgVmlldydzIGVsZW1lbnQgaXMgYCJkaXYiYC4NCiAgICB0YWdOYW1lOiAnZGl2JywNCg0KICAgIC8vIGpRdWVyeSBkZWxlZ2F0ZSBmb3IgZWxlbWVudCBsb29rdXAsIHNjb3BlZCB0byBET00gZWxlbWVudHMgd2l0aGluIHRoZQ0KICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuDQogICAgJDogZnVuY3Rpb24oc2VsZWN0b3IpIHsNCiAgICAgIHJldHVybiB0aGlzLiRlbC5maW5kKHNlbGVjdG9yKTsNCiAgICB9LA0KDQogICAgLy8gSW5pdGlhbGl6ZSBpcyBhbiBlbXB0eSBmdW5jdGlvbiBieSBkZWZhdWx0LiBPdmVycmlkZSBpdCB3aXRoIHlvdXIgb3duDQogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuDQogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LA0KDQogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyDQogICAgLy8gdG8gcG9wdWxhdGUgaXRzIGVsZW1lbnQgKGB0aGlzLmVsYCksIHdpdGggdGhlIGFwcHJvcHJpYXRlIEhUTUwuIFRoZQ0KICAgIC8vIGNvbnZlbnRpb24gaXMgZm9yICoqcmVuZGVyKiogdG8gYWx3YXlzIHJldHVybiBgdGhpc2AuDQogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBSZW1vdmUgdGhpcyB2aWV3IGJ5IHRha2luZyB0aGUgZWxlbWVudCBvdXQgb2YgdGhlIERPTSwgYW5kIHJlbW92aW5nIGFueQ0KICAgIC8vIGFwcGxpY2FibGUgQmFja2JvbmUuRXZlbnRzIGxpc3RlbmVycy4NCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgew0KICAgICAgdGhpcy4kZWwucmVtb3ZlKCk7DQogICAgICB0aGlzLnN0b3BMaXN0ZW5pbmcoKTsNCiAgICAgIHJldHVybiB0aGlzOw0KICAgIH0sDQoNCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndA0KICAgIC8vIG5lZWRlZCwgdXNlICoqbWFrZSoqIHRvIG1hbnVmYWN0dXJlIGVsZW1lbnRzLCBvbmUgYXQgYSB0aW1lLg0KICAgIC8vDQogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7DQogICAgLy8NCiAgICBtYWtlOiBmdW5jdGlvbih0YWdOYW1lLCBhdHRyaWJ1dGVzLCBjb250ZW50KSB7DQogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOw0KICAgICAgaWYgKGF0dHJpYnV0ZXMpIEJhY2tib25lLiQoZWwpLmF0dHIoYXR0cmlidXRlcyk7DQogICAgICBpZiAoY29udGVudCAhPSBudWxsKSBCYWNrYm9uZS4kKGVsKS5odG1sKGNvbnRlbnQpOw0KICAgICAgcmV0dXJuIGVsOw0KICAgIH0sDQoNCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQNCiAgICAvLyByZS1kZWxlZ2F0aW9uLg0KICAgIHNldEVsZW1lbnQ6IGZ1bmN0aW9uKGVsZW1lbnQsIGRlbGVnYXRlKSB7DQogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOw0KICAgICAgdGhpcy4kZWwgPSBlbGVtZW50IGluc3RhbmNlb2YgQmFja2JvbmUuJCA/IGVsZW1lbnQgOiBCYWNrYm9uZS4kKGVsZW1lbnQpOw0KICAgICAgdGhpcy5lbCA9IHRoaXMuJGVsWzBdOw0KICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOw0KICAgICAgcmV0dXJuIHRoaXM7DQogICAgfSwNCg0KICAgIC8vIFNldCBjYWxsYmFja3MsIHdoZXJlIGB0aGlzLmV2ZW50c2AgaXMgYSBoYXNoIG9mDQogICAgLy8NCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9Kg0KICAgIC8vDQogICAgLy8gICAgIHsNCiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsDQogICAgLy8gICAgICAgJ2NsaWNrIC5idXR0b24nOiAgICAgJ3NhdmUnDQogICAgLy8gICAgICAgJ2NsaWNrIC5vcGVuJzogICAgICAgZnVuY3Rpb24oZSkgeyAuLi4gfQ0KICAgIC8vICAgICB9DQogICAgLy8NCiAgICAvLyBwYWlycy4gQ2FsbGJhY2tzIHdpbGwgYmUgYm91bmQgdG8gdGhlIHZpZXcsIHdpdGggYHRoaXNgIHNldCBwcm9wZXJseS4NCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuDQogICAgLy8gT21pdHRpbmcgdGhlIHNlbGVjdG9yIGJpbmRzIHRoZSBldmVudCB0byBgdGhpcy5lbGAuDQogICAgLy8gVGhpcyBvbmx5IHdvcmtzIGZvciBkZWxlZ2F0ZS1hYmxlIGV2ZW50czogbm90IGBmb2N1c2AsIGBibHVyYCwgYW5kDQogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuDQogICAgZGVsZWdhdGVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cykgew0KICAgICAgaWYgKCEoZXZlbnRzIHx8IChldmVudHMgPSBfLnJlc3VsdCh0aGlzLCAnZXZlbnRzJykpKSkgcmV0dXJuOw0KICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7DQogICAgICBmb3IgKHZhciBrZXkgaW4gZXZlbnRzKSB7DQogICAgICAgIHZhciBtZXRob2QgPSBldmVudHNba2V5XTsNCiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07DQogICAgICAgIGlmICghbWV0aG9kKSB0aHJvdyBuZXcgRXJyb3IoJ01ldGhvZCAiJyArIGV2ZW50c1trZXldICsgJyIgZG9lcyBub3QgZXhpc3QnKTsNCiAgICAgICAgdmFyIG1hdGNoID0ga2V5Lm1hdGNoKGRlbGVnYXRlRXZlbnRTcGxpdHRlcik7DQogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsNCiAgICAgICAgbWV0aG9kID0gXy5iaW5kKG1ldGhvZCwgdGhpcyk7DQogICAgICAgIGV2ZW50TmFtZSArPSAnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkOw0KICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7DQogICAgICAgICAgdGhpcy4kZWwuYmluZChldmVudE5hbWUsIG1ldGhvZCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgIH0sDQoNCiAgICAvLyBDbGVhcnMgYWxsIGNhbGxiYWNrcyBwcmV2aW91c2x5IGJvdW5kIHRvIHRoZSB2aWV3IHdpdGggYGRlbGVnYXRlRXZlbnRzYC4NCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUNCiAgICAvLyBCYWNrYm9uZSB2aWV3cyBhdHRhY2hlZCB0byB0aGUgc2FtZSBET00gZWxlbWVudC4NCiAgICB1bmRlbGVnYXRlRXZlbnRzOiBmdW5jdGlvbigpIHsNCiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsNCiAgICB9LA0KDQogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLg0KICAgIC8vIEtleXMgd2l0aCBzcGVjaWFsIG1lYW5pbmcgKihtb2RlbCwgY29sbGVjdGlvbiwgaWQsIGNsYXNzTmFtZSkqLCBhcmUNCiAgICAvLyBhdHRhY2hlZCBkaXJlY3RseSB0byB0aGUgdmlldy4NCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7DQogICAgICBpZiAodGhpcy5vcHRpb25zKSBvcHRpb25zID0gXy5leHRlbmQoe30sIF8ucmVzdWx0KHRoaXMsICdvcHRpb25zJyksIG9wdGlvbnMpOw0KICAgICAgXy5leHRlbmQodGhpcywgXy5waWNrKG9wdGlvbnMsIHZpZXdPcHRpb25zKSk7DQogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOw0KICAgIH0sDQoNCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4NCiAgICAvLyBJZiBgdGhpcy5lbGAgaXMgYSBzdHJpbmcsIHBhc3MgaXQgdGhyb3VnaCBgJCgpYCwgdGFrZSB0aGUgZmlyc3QNCiAgICAvLyBtYXRjaGluZyBlbGVtZW50LCBhbmQgcmUtYXNzaWduIGl0IHRvIGBlbGAuIE90aGVyd2lzZSwgY3JlYXRlDQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuDQogICAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgew0KICAgICAgaWYgKCF0aGlzLmVsKSB7DQogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsNCiAgICAgICAgaWYgKHRoaXMuaWQpIGF0dHJzLmlkID0gXy5yZXN1bHQodGhpcywgJ2lkJyk7DQogICAgICAgIGlmICh0aGlzLmNsYXNzTmFtZSkgYXR0cnNbJ2NsYXNzJ10gPSBfLnJlc3VsdCh0aGlzLCAnY2xhc3NOYW1lJyk7DQogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICB0aGlzLnNldEVsZW1lbnQoXy5yZXN1bHQodGhpcywgJ2VsJyksIGZhbHNlKTsNCiAgICAgIH0NCiAgICB9DQoNCiAgfSk7DQoNCiAgLy8gQmFja2JvbmUuc3luYw0KICAvLyAtLS0tLS0tLS0tLS0tDQoNCiAgLy8gTWFwIGZyb20gQ1JVRCB0byBIVFRQIGZvciBvdXIgZGVmYXVsdCBgQmFja2JvbmUuc3luY2AgaW1wbGVtZW50YXRpb24uDQogIHZhciBtZXRob2RNYXAgPSB7DQogICAgJ2NyZWF0ZSc6ICdQT1NUJywNCiAgICAndXBkYXRlJzogJ1BVVCcsDQogICAgJ3BhdGNoJzogICdQQVRDSCcsDQogICAgJ2RlbGV0ZSc6ICdERUxFVEUnLA0KICAgICdyZWFkJzogICAnR0VUJw0KICB9Ow0KDQogIC8vIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24gdG8gY2hhbmdlIHRoZSBtYW5uZXIgaW4gd2hpY2ggQmFja2JvbmUgcGVyc2lzdHMNCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlDQogIC8vIG1vZGVsIGluIHF1ZXN0aW9uLiBCeSBkZWZhdWx0LCBtYWtlcyBhIFJFU1RmdWwgQWpheCByZXF1ZXN0DQogIC8vIHRvIHRoZSBtb2RlbCdzIGB1cmwoKWAuIFNvbWUgcG9zc2libGUgY3VzdG9taXphdGlvbnMgY291bGQgYmU6DQogIC8vDQogIC8vICogVXNlIGBzZXRUaW1lb3V0YCB0byBiYXRjaCByYXBpZC1maXJlIHVwZGF0ZXMgaW50byBhIHNpbmdsZSByZXF1ZXN0Lg0KICAvLyAqIFNlbmQgdXAgdGhlIG1vZGVscyBhcyBYTUwgaW5zdGVhZCBvZiBKU09OLg0KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4NCiAgLy8NCiAgLy8gVHVybiBvbiBgQmFja2JvbmUuZW11bGF0ZUhUVFBgIGluIG9yZGVyIHRvIHNlbmQgYFBVVGAgYW5kIGBERUxFVEVgIHJlcXVlc3RzDQogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwNCiAgLy8gYXMgd2VsbCBhcyBhbGwgcmVxdWVzdHMgd2l0aCB0aGUgYm9keSBhcyBgYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkYA0KICAvLyBpbnN0ZWFkIG9mIGBhcHBsaWNhdGlvbi9qc29uYCB3aXRoIHRoZSBtb2RlbCBpbiBhIHBhcmFtIG5hbWVkIGBtb2RlbGAuDQogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UNCiAgLy8gaXQgZGlmZmljdWx0IHRvIHJlYWQgdGhlIGJvZHkgb2YgYFBVVGAgcmVxdWVzdHMuDQogIEJhY2tib25lLnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIG1vZGVsLCBvcHRpb25zKSB7DQogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsNCg0KICAgIC8vIERlZmF1bHQgb3B0aW9ucywgdW5sZXNzIHNwZWNpZmllZC4NCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsNCiAgICAgIGVtdWxhdGVIVFRQOiBCYWNrYm9uZS5lbXVsYXRlSFRUUCwNCiAgICAgIGVtdWxhdGVKU09OOiBCYWNrYm9uZS5lbXVsYXRlSlNPTg0KICAgIH0pOw0KDQogICAgLy8gRGVmYXVsdCBKU09OLXJlcXVlc3Qgb3B0aW9ucy4NCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9Ow0KDQogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBhIFVSTC4NCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7DQogICAgICBwYXJhbXMudXJsID0gXy5yZXN1bHQobW9kZWwsICd1cmwnKSB8fCB1cmxFcnJvcigpOw0KICAgIH0NCg0KICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgdGhlIGFwcHJvcHJpYXRlIHJlcXVlc3QgZGF0YS4NCiAgICBpZiAob3B0aW9ucy5kYXRhID09IG51bGwgJiYgbW9kZWwgJiYgKG1ldGhvZCA9PT0gJ2NyZWF0ZScgfHwgbWV0aG9kID09PSAndXBkYXRlJyB8fCBtZXRob2QgPT09ICdwYXRjaCcpKSB7DQogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7DQogICAgICBwYXJhbXMuZGF0YSA9IEpTT04uc3RyaW5naWZ5KG9wdGlvbnMuYXR0cnMgfHwgbW9kZWwudG9KU09OKG9wdGlvbnMpKTsNCiAgICB9DQoNCiAgICAvLyBGb3Igb2xkZXIgc2VydmVycywgZW11bGF0ZSBKU09OIGJ5IGVuY29kaW5nIHRoZSByZXF1ZXN0IGludG8gYW4gSFRNTC1mb3JtLg0KICAgIGlmIChvcHRpb25zLmVtdWxhdGVKU09OKSB7DQogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsNCiAgICAgIHBhcmFtcy5kYXRhID0gcGFyYW1zLmRhdGEgPyB7bW9kZWw6IHBhcmFtcy5kYXRhfSA6IHt9Ow0KICAgIH0NCg0KICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEhUVFAgYnkgbWltaWNraW5nIHRoZSBIVFRQIG1ldGhvZCB3aXRoIGBfbWV0aG9kYA0KICAgIC8vIEFuZCBhbiBgWC1IVFRQLU1ldGhvZC1PdmVycmlkZWAgaGVhZGVyLg0KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgew0KICAgICAgcGFyYW1zLnR5cGUgPSAnUE9TVCc7DQogICAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgcGFyYW1zLmRhdGEuX21ldGhvZCA9IHR5cGU7DQogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsNCiAgICAgIG9wdGlvbnMuYmVmb3JlU2VuZCA9IGZ1bmN0aW9uKHhocikgew0KICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignWC1IVFRQLU1ldGhvZC1PdmVycmlkZScsIHR5cGUpOw0KICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsNCiAgICAgIH07DQogICAgfQ0KDQogICAgLy8gRG9uJ3QgcHJvY2VzcyBkYXRhIG9uIGEgbm9uLUdFVCByZXF1ZXN0Lg0KICAgIGlmIChwYXJhbXMudHlwZSAhPT0gJ0dFVCcgJiYgIW9wdGlvbnMuZW11bGF0ZUpTT04pIHsNCiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOw0KICAgIH0NCg0KICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOw0KICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7DQogICAgICBpZiAoc3VjY2Vzcykgc3VjY2VzcyhyZXNwLCBzdGF0dXMsIHhocik7DQogICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOw0KICAgIH07DQoNCiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOw0KICAgIG9wdGlvbnMuZXJyb3IgPSBmdW5jdGlvbih4aHIsIHN0YXR1cywgdGhyb3duKSB7DQogICAgICBpZiAoZXJyb3IpIGVycm9yKG1vZGVsLCB4aHIsIG9wdGlvbnMpOw0KICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsNCiAgICB9Ow0KDQogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4NCiAgICB2YXIgeGhyID0gQmFja2JvbmUuYWpheChfLmV4dGVuZChwYXJhbXMsIG9wdGlvbnMpKTsNCiAgICBtb2RlbC50cmlnZ2VyKCdyZXF1ZXN0JywgbW9kZWwsIHhociwgb3B0aW9ucyk7DQogICAgcmV0dXJuIHhocjsNCiAgfTsNCg0KICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLg0KICBCYWNrYm9uZS5hamF4ID0gZnVuY3Rpb24oKSB7DQogICAgcmV0dXJuIEJhY2tib25lLiQuYWpheC5hcHBseShCYWNrYm9uZS4kLCBhcmd1bWVudHMpOw0KICB9Ow0KDQogIC8vIEhlbHBlcnMNCiAgLy8gLS0tLS0tLQ0KDQogIC8vIEhlbHBlciBmdW5jdGlvbiB0byBjb3JyZWN0bHkgc2V0IHVwIHRoZSBwcm90b3R5cGUgY2hhaW4sIGZvciBzdWJjbGFzc2VzLg0KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZA0KICAvLyBjbGFzcyBwcm9wZXJ0aWVzIHRvIGJlIGV4dGVuZGVkLg0KICB2YXIgZXh0ZW5kID0gZnVuY3Rpb24ocHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsNCiAgICB2YXIgcGFyZW50ID0gdGhpczsNCiAgICB2YXIgY2hpbGQ7DQoNCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91DQogICAgLy8gKHRoZSAiY29uc3RydWN0b3IiIHByb3BlcnR5IGluIHlvdXIgYGV4dGVuZGAgZGVmaW5pdGlvbiksIG9yIGRlZmF1bHRlZA0KICAgIC8vIGJ5IHVzIHRvIHNpbXBseSBjYWxsIHRoZSBwYXJlbnQncyBjb25zdHJ1Y3Rvci4NCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgew0KICAgICAgY2hpbGQgPSBwcm90b1Byb3BzLmNvbnN0cnVjdG9yOw0KICAgIH0gZWxzZSB7DQogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9Ow0KICAgIH0NCg0KICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLg0KICAgIF8uZXh0ZW5kKGNoaWxkLCBwYXJlbnQsIHN0YXRpY1Byb3BzKTsNCg0KICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nDQogICAgLy8gYHBhcmVudGAncyBjb25zdHJ1Y3RvciBmdW5jdGlvbi4NCiAgICB2YXIgU3Vycm9nYXRlID0gZnVuY3Rpb24oKXsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9Ow0KICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOw0KICAgIGNoaWxkLnByb3RvdHlwZSA9IG5ldyBTdXJyb2dhdGU7DQoNCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywNCiAgICAvLyBpZiBzdXBwbGllZC4NCiAgICBpZiAocHJvdG9Qcm9wcykgXy5leHRlbmQoY2hpbGQucHJvdG90eXBlLCBwcm90b1Byb3BzKTsNCg0KICAgIC8vIFNldCBhIGNvbnZlbmllbmNlIHByb3BlcnR5IGluIGNhc2UgdGhlIHBhcmVudCdzIHByb3RvdHlwZSBpcyBuZWVkZWQNCiAgICAvLyBsYXRlci4NCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOw0KDQogICAgcmV0dXJuIGNoaWxkOw0KICB9Ow0KDQogIC8vIFNldCB1cCBpbmhlcml0YW5jZSBmb3IgdGhlIG1vZGVsLCBjb2xsZWN0aW9uLCByb3V0ZXIsIHZpZXcgYW5kIGhpc3RvcnkuDQogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7DQoNCiAgLy8gVGhyb3cgYW4gZXJyb3Igd2hlbiBhIFVSTCBpcyBuZWVkZWQsIGFuZCBub25lIGlzIHN1cHBsaWVkLg0KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsNCiAgICB0aHJvdyBuZXcgRXJyb3IoJ0EgInVybCIgcHJvcGVydHkgb3IgZnVuY3Rpb24gbXVzdCBiZSBzcGVjaWZpZWQnKTsNCiAgfTsNCg0KfSkuY2FsbCh0aGlzKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 11:15:05 GMT",
                    "Content-Length": "58586",
                    "Date": "Thu, 06 Nov 2014 11:15:08 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}