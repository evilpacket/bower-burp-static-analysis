{
    "url": "http://localhost:9999/cpojer/mootools-history/Demos/mootools-core.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/cpojer/mootools-history/Demos/mootools-core.js",
                "path": "/cpojer/mootools-history/Demos/mootools-core.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9jcG9qZXIvbW9vdG9vbHMtaGlzdG9yeS9EZW1vcy9tb290b29scy1jb3JlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTA4ODc1DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDE2OjI5OjIxIEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAxNjoyOToyMSBHTVQNCg0KLyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEwIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjNkZXYnLAoJYnVpbGQ6ICcwYTdhZWFiYmJhYzViYzIzYjAyMWI0YzFhYTliYTcyMmM0MGUzMDNkJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm4gdGhpczsKCgl2YXIgaG9va3MgPSBob29rc09mKHRoaXMpOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspewoJCXZhciBob29rID0gaG9va3NbaV07CgkJaWYgKHR5cGVPZihob29rKSA9PSAndHlwZScpIGltcGxlbWVudC5jYWxsKGhvb2ssIG5hbWUsIG1ldGhvZCk7CgkJZWxzZSBob29rLmNhbGwodGhpcywgbmFtZSwgbWV0aG9kKTsKCX0KCQoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKCglyZXR1cm4gdGhpczsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuIHRoaXM7Cgl2YXIgcHJldmlvdXMgPSB0aGlzW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXNbbmFtZV0gPSBtZXRob2Q7CglyZXR1cm4gdGhpczsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgnZ2VuZXJhdGVVSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCi8vPDEuMmNvbXBhdD4KCnZhciBIYXNoID0gdGhpcy5IYXNoID0gbmV3IFR5cGUoJ0hhc2gnLCBmdW5jdGlvbihvYmplY3QpewoJaWYgKHR5cGVPZihvYmplY3QpID09ICdoYXNoJykgb2JqZWN0ID0gT2JqZWN0LmNsb25lKG9iamVjdC5nZXRDbGVhbigpKTsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpIHRoaXNba2V5XSA9IG9iamVjdFtrZXldOwoJcmV0dXJuIHRoaXM7Cn0pOwoKSGFzaC5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlPYmplY3QuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCWdldENsZWFuOiBmdW5jdGlvbigpewoJCXZhciBjbGVhbiA9IHt9OwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgY2xlYW5ba2V5XSA9IHRoaXNba2V5XTsKCQl9CgkJcmV0dXJuIGNsZWFuOwoJfSwKCglnZXRMZW5ndGg6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IDA7CgkJZm9yICh2YXIga2V5IGluIHRoaXMpewoJCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBsZW5ndGgrKzsKCQl9CgkJcmV0dXJuIGxlbmd0aDsKCX0KCn0pOwoKSGFzaC5hbGlhcygnZWFjaCcsICdmb3JFYWNoJyk7CgpPYmplY3QudHlwZSA9IFR5cGUuaXNPYmplY3Q7Cgp2YXIgTmF0aXZlID0gdGhpcy5OYXRpdmUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCXJldHVybiBuZXcgVHlwZShwcm9wZXJ0aWVzLm5hbWUsIHByb3BlcnRpZXMuaW5pdGlhbGl6ZSk7Cn07CgpOYXRpdmUudHlwZSA9IFR5cGUudHlwZTsKCk5hdGl2ZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihvYmplY3RzLCBtZXRob2RzKXsKCWZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgb2JqZWN0c1tpXS5pbXBsZW1lbnQobWV0aG9kcyk7CglyZXR1cm4gTmF0aXZlOwp9OwoKdmFyIGFycmF5VHlwZSA9IEFycmF5LnR5cGU7CkFycmF5LnR5cGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpbnN0YW5jZU9mKGl0ZW0sIEFycmF5KSB8fCBhcnJheVR5cGUoaXRlbSk7Cn07Cgp0aGlzLiRBID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gQXJyYXkuZnJvbShpdGVtKS5zbGljZSgpOwp9OwoKdGhpcy4kYXJndW1lbnRzID0gZnVuY3Rpb24oaSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQlyZXR1cm4gYXJndW1lbnRzW2ldOwoJfTsKfTsKCnRoaXMuJGNoayA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gISEob2JqIHx8IG9iaiA9PT0gMCk7Cn07Cgp0aGlzLiRjbGVhciA9IGZ1bmN0aW9uKHRpbWVyKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CgljbGVhckludGVydmFsKHRpbWVyKTsKCXJldHVybiBudWxsOwp9OwoKdGhpcy4kZGVmaW5lZCA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gKG9iaiAhPSBudWxsKTsKfTsKCnRoaXMuJGVhY2ggPSBmdW5jdGlvbihpdGVyYWJsZSwgZm4sIGJpbmQpewoJdmFyIHR5cGUgPSB0eXBlT2YoaXRlcmFibGUpOwoJKCh0eXBlID09ICdhcmd1bWVudHMnIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdlbGVtZW50cycpID8gQXJyYXkgOiBPYmplY3QpLmVhY2goaXRlcmFibGUsIGZuLCBiaW5kKTsKfTsKCnRoaXMuJGVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKdGhpcy4kZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luYWwsIGV4dGVuZGVkKXsKCXJldHVybiBPYmplY3QuYXBwZW5kKG9yaWdpbmFsLCBleHRlbmRlZCk7Cn07Cgp0aGlzLiRIID0gZnVuY3Rpb24ob2JqZWN0KXsKCXJldHVybiBuZXcgSGFzaChvYmplY3QpOwp9OwoKdGhpcy4kbWVyZ2UgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMpOwoJYXJncy51bnNoaWZ0KHt9KTsKCXJldHVybiBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgYXJncyk7Cn07Cgp0aGlzLiRsYW1iZGEgPSBGdW5jdGlvbi5mcm9tOwp0aGlzLiRtaXhpbiA9IE9iamVjdC5tZXJnZTsKdGhpcy4kcmFuZG9tID0gTnVtYmVyLnJhbmRvbTsKdGhpcy4kc3BsYXQgPSBBcnJheS5mcm9tOwp0aGlzLiR0aW1lID0gRGF0ZS5ub3c7Cgp0aGlzLiR0eXBlID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdCk7CglpZiAodHlwZSA9PSAnZWxlbWVudHMnKSByZXR1cm4gJ2FycmF5JzsKCXJldHVybiAodHlwZSA9PSAnbnVsbCcpID8gZmFsc2UgOiB0eXBlOwp9OwoKdGhpcy4kdW5saW5rID0gZnVuY3Rpb24ob2JqZWN0KXsKCXN3aXRjaCAodHlwZU9mKG9iamVjdCkpewoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUob2JqZWN0KTsKCQljYXNlICdhcnJheSc6IHJldHVybiBBcnJheS5jbG9uZShvYmplY3QpOwoJCWNhc2UgJ2hhc2gnOiByZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKCQlkZWZhdWx0OiByZXR1cm4gb2JqZWN0OwoJfQp9OwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJaW52b2tlOiBmdW5jdGlvbihtZXRob2ROYW1lKXsKCQl2YXIgYXJncyA9IEFycmF5LnNsaWNlKGFyZ3VtZW50cywgMSk7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbVttZXRob2ROYW1lXS5hcHBseShpdGVtLCBhcmdzKTsKCQl9KTsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbSAhPSBudWxsOwoJCX0pOwoJfSwKCglpbmRleE9mOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IChmcm9tIDwgMCkgPyBNYXRoLm1heCgwLCBsZW4gKyBmcm9tKSA6IGZyb20gfHwgMDsgaSA8IGxlbjsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCW1hcDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmIChpIGluIHRoaXMpIHJlc3VsdHNbaV0gPSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJc29tZTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJYXNzb2NpYXRlOiBmdW5jdGlvbihrZXlzKXsKCQl2YXIgb2JqID0ge30sIGxlbmd0aCA9IE1hdGgubWluKHRoaXMubGVuZ3RoLCBrZXlzLmxlbmd0aCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgb2JqW2tleXNbaV1dID0gdGhpc1tpXTsKCQlyZXR1cm4gb2JqOwoJfSwKCglsaW5rOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciByZXN1bHQgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCQlpZiAob2JqZWN0W2tleV0odGhpc1tpXSkpewoJCQkJCXJlc3VsdFtrZXldID0gdGhpc1tpXTsKCQkJCQlkZWxldGUgb2JqZWN0W2tleV07CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKGl0ZW0sIGZyb20pewoJCXJldHVybiB0aGlzLmluZGV4T2YoaXRlbSwgZnJvbSkgIT0gLTE7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24oYXJyYXkpewoJCXRoaXMucHVzaC5hcHBseSh0aGlzLCBhcnJheSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldExhc3Q6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLmxlbmd0aCkgPyB0aGlzW3RoaXMubGVuZ3RoIC0gMV0gOiBudWxsOwoJfSwKCglnZXRSYW5kb206IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLmxlbmd0aCkgPyB0aGlzW051bWJlci5yYW5kb20oMCwgdGhpcy5sZW5ndGggLSAxKV0gOiBudWxsOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihpdGVtKXsKCQlpZiAoIXRoaXMuY29udGFpbnMoaXRlbSkpIHRoaXMucHVzaChpdGVtKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tYmluZTogZnVuY3Rpb24oYXJyYXkpewoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLmluY2x1ZGUoYXJyYXlbaV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oaXRlbSl7CgkJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHRoaXMuc3BsaWNlKGksIDEpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJdGhpcy5sZW5ndGggPSAwOwoJCXJldHVybiB0aGlzOwoJfSwKCglmbGF0dGVuOiBmdW5jdGlvbigpewoJCXZhciBhcnJheSA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgdHlwZSA9IHR5cGVPZih0aGlzW2ldKTsKCQkJaWYgKHR5cGUgPT0gJ251bGwnKSBjb250aW51ZTsKCQkJYXJyYXkgPSBhcnJheS5jb25jYXQoKHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcmd1bWVudHMnIHx8IGluc3RhbmNlT2YodGhpc1tpXSwgQXJyYXkpKSA/IEFycmF5LmZsYXR0ZW4odGhpc1tpXSkgOiB0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIGFycmF5OwoJfSwKCglwaWNrOiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAodGhpc1tpXSAhPSBudWxsKSByZXR1cm4gdGhpc1tpXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoICE9IDMpIHJldHVybiBudWxsOwoJCXZhciByZ2IgPSB0aGlzLm1hcChmdW5jdGlvbih2YWx1ZSl7CgkJCWlmICh2YWx1ZS5sZW5ndGggPT0gMSkgdmFsdWUgKz0gdmFsdWU7CgkJCXJldHVybiB2YWx1ZS50b0ludCgxNik7CgkJfSk7CgkJcmV0dXJuIChhcnJheSkgPyByZ2IgOiAncmdiKCcgKyByZ2IgKyAnKSc7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CgkJaWYgKHRoaXMubGVuZ3RoID09IDQgJiYgdGhpc1szXSA9PSAwICYmICFhcnJheSkgcmV0dXJuICd0cmFuc3BhcmVudCc7CgkJdmFyIGhleCA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgMzsgaSsrKXsKCQkJdmFyIGJpdCA9ICh0aGlzW2ldIC0gMCkudG9TdHJpbmcoMTYpOwoJCQloZXgucHVzaCgoYml0Lmxlbmd0aCA9PSAxKSA/ICcwJyArIGJpdCA6IGJpdCk7CgkJfQoJCXJldHVybiAoYXJyYXkpID8gaGV4IDogJyMnICsgaGV4LmpvaW4oJycpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpBcnJheS5hbGlhcygnZXh0ZW5kJywgJ2FwcGVuZCcpOwoKdmFyICRwaWNrID0gZnVuY3Rpb24oKXsKCXJldHVybiBBcnJheS5mcm9tKGFyZ3VtZW50cykucGljaygpOwp9OwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IFN0cmluZwoKZGVzY3JpcHRpb246IENvbnRhaW5zIFN0cmluZyBQcm90b3R5cGVzIGxpa2UgY2FtZWxDYXNlLCBjYXBpdGFsaXplLCB0ZXN0LCBhbmQgdG9JbnQuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogU3RyaW5nCgouLi4KKi8KClN0cmluZy5pbXBsZW1lbnQoewoKCXRlc3Q6IGZ1bmN0aW9uKHJlZ2V4LCBwYXJhbXMpewoJCXJldHVybiAoKHR5cGVPZihyZWdleCkgPT0gJ3JlZ2V4cCcpID8gcmVnZXggOiBuZXcgUmVnRXhwKCcnICsgcmVnZXgsIHBhcmFtcykpLnRlc3QodGhpcyk7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihzdHJpbmcsIHNlcGFyYXRvcil7CgkJcmV0dXJuIChzZXBhcmF0b3IpID8gKHNlcGFyYXRvciArIHRoaXMgKyBzZXBhcmF0b3IpLmluZGV4T2Yoc2VwYXJhdG9yICsgc3RyaW5nICsgc2VwYXJhdG9yKSA+IC0xIDogdGhpcy5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJfSwKCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7Cgl9LAoKCWNhbWVsQ2FzZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiAoJy0nICsgbWF0Y2guY2hhckF0KDApLnRvTG93ZXJDYXNlKCkpOwoJCX0pOwoJfSwKCgljYXBpdGFsaXplOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xiW2Etel0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJZXNjYXBlUmVnRXhwOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IHRoaXMubWF0Y2goL14jPyhcd3sxLDJ9KShcd3sxLDJ9KShcd3sxLDJ9KSQvKTsKCQlyZXR1cm4gKGhleCkgPyBoZXguc2xpY2UoMSkuaGV4VG9SZ2IoYXJyYXkpIDogbnVsbDsKCX0sCgoJcmdiVG9IZXg6IGZ1bmN0aW9uKGFycmF5KXsKCQl2YXIgcmdiID0gdGhpcy5tYXRjaCgvXGR7MSwzfS9nKTsKCQlyZXR1cm4gKHJnYikgPyByZ2IucmdiVG9IZXgoYXJyYXkpIDogbnVsbDsKCX0sCgoJc3Vic3RpdHV0ZTogZnVuY3Rpb24ob2JqZWN0LCByZWdleHApewoJCXJldHVybiB0aGlzLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWRlbGF5OiBmdW5jdGlvbihkZWxheSwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldFRpbWVvdXQodGhpcy5wYXNzKGFyZ3MsIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoYXJncywgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCi8vPDEuMmNvbXBhdD4KCmlmIChCcm93c2VyLlBsYXRmb3JtLmlvcykgQnJvd3Nlci5QbGF0Zm9ybS5pcG9kID0gdHJ1ZTsKCkJyb3dzZXIuRW5naW5lID0ge307Cgp2YXIgc2V0RW5naW5lID0gZnVuY3Rpb24obmFtZSwgdmVyc2lvbil7CglCcm93c2VyLkVuZ2luZS5uYW1lID0gbmFtZTsKCUJyb3dzZXIuRW5naW5lW25hbWUgKyB2ZXJzaW9uXSA9IHRydWU7CglCcm93c2VyLkVuZ2luZS52ZXJzaW9uID0gdmVyc2lvbjsKfTsKCmlmIChCcm93c2VyLmllKXsKCUJyb3dzZXIuRW5naW5lLnRyaWRlbnQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDY6IHNldEVuZ2luZSgndHJpZGVudCcsIDQpOyBicmVhazsKCQljYXNlIDc6IHNldEVuZ2luZSgndHJpZGVudCcsIDUpOyBicmVhazsKCQljYXNlIDg6IHNldEVuZ2luZSgndHJpZGVudCcsIDYpOwoJfQp9CgppZiAoQnJvd3Nlci5maXJlZm94KXsKCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDMpIHNldEVuZ2luZSgnZ2Vja28nLCAxOSk7CgllbHNlIHNldEVuZ2luZSgnZ2Vja28nLCAxOCk7Cn0KCmlmIChCcm93c2VyLnNhZmFyaSB8fCBCcm93c2VyLmNocm9tZSl7CglCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDI6IHNldEVuZ2luZSgnd2Via2l0JywgNDE5KTsgYnJlYWs7CgkJY2FzZSAzOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQyMCk7IGJyZWFrOwoJCWNhc2UgNDogc2V0RW5naW5lKCd3ZWJraXQnLCA1MjUpOwoJfQp9CgppZiAoQnJvd3Nlci5vcGVyYSl7CglCcm93c2VyLkVuZ2luZS5wcmVzdG8gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gOS42KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk2MCk7CgllbHNlIGlmIChCcm93c2VyLnZlcnNpb24gPj0gOS41KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk1MCk7CgllbHNlIHNldEVuZ2luZSgncHJlc3RvJywgOTI1KTsKfQoKaWYgKEJyb3dzZXIubmFtZSA9PSAndW5rbm93bicpewoJc3dpdGNoICgodWEubWF0Y2goLyg/OndlYmtpdHxraHRtbHxnZWNrbykvKSB8fCBbXSlbMF0pewoJCWNhc2UgJ3dlYmtpdCc6CgkJY2FzZSAna2h0bWwnOgoJCQlCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoJCWJyZWFrOwoJCWNhc2UgJ2dlY2tvJzoKCQkJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoJfQp9Cgp0aGlzLiRleGVjID0gQnJvd3Nlci5leGVjOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLlBhcnNlcgpkZXNjcmlwdGlvbjogU3RhbmRhbG9uZSBDU1MzIFNlbGVjdG9yIHBhcnNlcgpwcm92aWRlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7U2xpY2s6IHRydWUsIGV4cHJlc3Npb25zOiBbXSwgcmF3OiBleHByZXNzaW9uLCByZXZlcnNlOiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7Cgl9fTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCAiXFwkJiIpOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXw6Kyg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEyXSopXFwxMil8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZQoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge307CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8IChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnKTsKfTsKCmxvY2FsLnNldERvY3VtZW50ID0gZnVuY3Rpb24oZG9jdW1lbnQpewoKCS8vIGNvbnZlcnQgZWxlbWVudHMgLyB3aW5kb3cgYXJndW1lbnRzIHRvIGRvY3VtZW50LiBpZiBkb2N1bWVudCBjYW5ub3QgYmUgZXh0cmFwb2xhdGVkLCB0aGUgZnVuY3Rpb24gcmV0dXJucy4KCglpZiAoZG9jdW1lbnQubm9kZVR5cGUgPT09IDkpOyAvLyBkb2N1bWVudAoJZWxzZSBpZiAoZG9jdW1lbnQub3duZXJEb2N1bWVudCkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7Cgl2YXIgcm9vdCA9IHRoaXMucm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgl0aGlzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCgl0aGlzLmJyb2tlblN0YXJHRUJUTgoJPSB0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IHRoaXMuaWRHZXRzTmFtZQoJPSB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJPSB0aGlzLmJyb2tlbkdFQkNOCgk9IHRoaXMuYnJva2VuQ2hlY2tlZFFTQQoJPSB0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBCgk9IHRoaXMuaXNIVE1MRG9jdW1lbnQKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lOwoKCXZhciBzZWxlY3RlZCwgaWQ7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCXJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQlpZCA9ICdzbGlja19nZXRieWlkX3Rlc3QnOwoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQl0aGlzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMCk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJdGhpcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQlpZiAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCkgdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQl0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBID0gKHNlbGVjdGVkICYmIHNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQlpZCA9ICdzbGlja19pZF9nZXRzX25hbWUnOwoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJytpZCsnIj48L2E+PGIgaWQ9IicraWQrJyI+PC9iPic7CgkJCXRoaXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJNaVhlZENhU2UiPjwvYT4nOwoJCQl0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYZWRDYVNlJykubGVuZ3RoOwoJCX0gY2F0Y2goZSl7fTsKCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCX0gY2F0Y2goZSl7fTsKCgkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJfSBjYXRjaChlKXt9OwoKCQl0aGlzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQkKCQkvLyBXZWJraXQgZG9udCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9ucyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQl0aGlzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJfSBjYXRjaChlKXt9OwoJCQoJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iIj48L2E+JzsKCQkJdGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQl9IGNhdGNoKGUpe307CgkJCgl9CgoJcm9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IG51bGw7CgoJLy8gaGFzQXR0cmlidXRlCgoJdGhpcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXRoaXMuY29udGFpbnMgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSkgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dC5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJdGhpcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJdGhpcy5nZXRVSUQgPSAodGhpcy5pc0hUTUxEb2N1bWVudCkgPyB0aGlzLmdldFVJREhUTUwgOiB0aGlzLmdldFVJRFhNTDsKCn07CgovLyBNYWluIE1ldGhvZAoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJLy8gY29udGV4dCBjaGVja3MKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsgLy8gTm8gY29udGV4dAoJaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7IC8vIFJlamVjdCBtaXNjIGp1bmsgaW5wdXQKCgkvLyBzZXR1cAoKCXZhciBwYXJzZWQsIGk7CgoJdmFyIHVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSkgdGhpcy5zZXREb2N1bWVudChjb250ZXh0KTsKCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCS8vIHNob3VsZCByZW1vdmUgZHVwbGljYXRlcyBpZiBhcHBlbmQgYWxyZWFkeSBoYXMgaXRlbXMKCXZhciBzaG91bGRVbmlxdWVzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKHNob3VsZFVuaXF1ZXMpIGZvciAoaSA9IGZvdW5kLmxlbmd0aDsgaS0tOykgdGhpcy51bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvLyBPdmVycmlkZXMKCgkJZm9yIChpID0gdGhpcy5vdmVycmlkZXMubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG92ZXJyaWRlID0gdGhpcy5vdmVycmlkZXNbaV07CgkJCWlmIChvdmVycmlkZS5yZWdleHAudGVzdChleHByZXNzaW9uKSl7CgkJCQl2YXIgcmVzdWx0ID0gb3ZlcnJpZGUubWV0aG9kLmNhbGwoY29udGV4dCwgZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KTsKCQkJCWlmIChyZXN1bHQgPT09IGZhbHNlKSBjb250aW51ZTsKCQkJCWlmIChyZXN1bHQgPT09IHRydWUpIHJldHVybiBmb3VuZDsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQl9CgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghc2hvdWxkVW5pcXVlcyAmJiAoZmlyc3QgfHwgKHBhcnNlZC5sZW5ndGggPT0gMSAmJiBwYXJzZWQuZXhwcmVzc2lvbnNbMF0ubGVuZ3RoID09IDEpKSkgPyB0aGlzLnB1c2hBcnJheSA6IHRoaXMucHVzaFVJRDsKCglpZiAoZm91bmQgPT0gbnVsbCkgZm91bmQgPSBbXTsKCgkvLyBkZWZhdWx0IGVuZ2luZQoKCXZhciBqLCBtLCBuOwoJdmFyIGNvbWJpbmF0b3IsIHRhZywgaWQsIGNsYXNzTGlzdCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvczsKCXZhciBjdXJyZW50SXRlbXMsIGN1cnJlbnRFeHByZXNzaW9uLCBjdXJyZW50Qml0LCBsYXN0Qml0LCBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9uczsKCglzZWFyY2g6IGZvciAoaSA9IDA7IChjdXJyZW50RXhwcmVzc2lvbiA9IGV4cHJlc3Npb25zW2ldKTsgaSsrKSBmb3IgKGogPSAwOyAoY3VycmVudEJpdCA9IGN1cnJlbnRFeHByZXNzaW9uW2pdKTsgaisrKXsKCgkJY29tYmluYXRvciA9ICdjb21iaW5hdG9yOicgKyBjdXJyZW50Qml0LmNvbWJpbmF0b3I7CgkJaWYgKCF0aGlzW2NvbWJpbmF0b3JdKSBjb250aW51ZSBzZWFyY2g7CgoJCXRhZyAgICAgICAgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IGN1cnJlbnRCaXQudGFnIDogY3VycmVudEJpdC50YWcudG9VcHBlckNhc2UoKTsKCQlpZCAgICAgICAgID0gY3VycmVudEJpdC5pZDsKCQljbGFzc0xpc3QgID0gY3VycmVudEJpdC5jbGFzc0xpc3Q7CgkJY2xhc3NlcyAgICA9IGN1cnJlbnRCaXQuY2xhc3NlczsKCQlhdHRyaWJ1dGVzID0gY3VycmVudEJpdC5hdHRyaWJ1dGVzOwoJCXBzZXVkb3MgICAgPSBjdXJyZW50Qml0LnBzZXVkb3M7CgkJbGFzdEJpdCAgICA9IChqID09PSAoY3VycmVudEV4cHJlc3Npb24ubGVuZ3RoIC0gMSkpOwoKCQl0aGlzLmJpdFVuaXF1ZXMgPSB7fTsKCgkJaWYgKGxhc3RCaXQpewoJCQl0aGlzLnVuaXF1ZXMgPSB1bmlxdWVzOwoJCQl0aGlzLmZvdW5kID0gZm91bmQ7CgkJfSBlbHNlIHsKCQkJdGhpcy51bmlxdWVzID0ge307CgkJCXRoaXMuZm91bmQgPSBbXTsKCQl9CgoJCWlmIChqID09PSAwKXsKCQkJdGhpc1tjb21iaW5hdG9yXShjb250ZXh0LCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCAmJiBmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQl9IGVsc2UgewoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCkgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspewoJCQkJdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCQlpZiAoZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJCX0gZWxzZSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKykgdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJfQoKCQljdXJyZW50SXRlbXMgPSB0aGlzLmZvdW5kOwoJfQoKCWlmIChzaG91bGRVbmlxdWVzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljazp1bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPT0gbm9kZU5hbWUpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0gZWxzZSB7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7Cgl2YXIgcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShzZWxlY3Rvcik7CglpZiAoIXBhcnNlZCkgcmV0dXJuIHRydWU7CgoJLy8gc2ltcGxlIChzaW5nbGUpIHNlbGVjdG9ycwoJaWYocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSl7CgkJdmFyIGV4cCA9IHBhcnNlZC5leHByZXNzaW9uc1swXVswXTsKCQlyZXR1cm4gdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKTsKCX0KCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpOwoJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBub2Rlc1tpKytdOyl7CgkJaWYgKGl0ZW0gPT09IG5vZGUpIHJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKbG9jYWwubWF0Y2hQc2V1ZG8gPSBmdW5jdGlvbihub2RlLCBuYW1lLCBhcmd1bWVudCl7Cgl2YXIgcHNldWRvTmFtZSA9ICdwc2V1ZG86JyArIG5hbWU7CglpZiAodGhpc1twc2V1ZG9OYW1lXSkgcmV0dXJuIHRoaXNbcHNldWRvTmFtZV0obm9kZSwgYXJndW1lbnQpOwoJdmFyIGF0dHJpYnV0ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwoJcmV0dXJuIChhcmd1bWVudCkgPyBhcmd1bWVudCA9PSBhdHRyaWJ1dGUgOiAhIWF0dHJpYnV0ZTsKfTsKCmxvY2FsLm1hdGNoU2VsZWN0b3IgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0YWcpewoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGUubm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZS5ub2RlTmFtZSAhPSB0YWcpIHJldHVybiBmYWxzZTsKCQl9Cgl9CgoJaWYgKGlkICYmIG5vZGUuZ2V0QXR0cmlidXRlKCdpZCcpICE9IGlkKSByZXR1cm4gZmFsc2U7CgoJdmFyIGksIHBhcnQsIGNsczsKCWlmIChjbGFzc2VzKSBmb3IgKGkgPSBjbGFzc2VzLmxlbmd0aDsgaS0tOyl7CgkJY2xzID0gKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgaWYgKGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgPT0gaWQpewoJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJYnJlYWs7CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT09IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlLmRpc2FibGVkID09PSBmYWxzZSk7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZS5kaXNhYmxlZCA9PT0gdHJ1ZSk7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gdGhpcykgPyB0aGlzLmNsYXNzTmFtZSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdodG1sRm9yJyBpbiB0aGlzKSA/IHRoaXMuaHRtbEZvciA6IHRoaXMuZ2V0QXR0cmlidXRlKCdmb3InKTsKCX0sCgoJJ2hyZWYnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2hyZWYnIGluIHRoaXMpID8gdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJyk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnN0eWxlKSA/IHRoaXMuc3R5bGUuY3NzVGV4dCA6IHRoaXMuZ2V0QXR0cmlidXRlKCdzdHlsZScpOwoJfQoKfTsKCmxvY2FsLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJLy8gRklYTUU6IGNoZWNrIGlmIGdldEF0dHJpYnV0ZSgpIHdpbGwgZ2V0IGlucHV0IGVsZW1lbnRzIG9uIGEgZm9ybSBvbiB0aGlzIGJyb3dzZXIKCS8vIGdldEF0dHJpYnV0ZSBpcyBmYXN0ZXIgdGhhbiBnZXRBdHRyaWJ1dGVOb2RlKCkubm9kZVZhbHVlCgl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJdmFyIGF0dHJpYnV0ZU5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CglyZXR1cm4gYXR0cmlidXRlTm9kZSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKfTsKCi8vIG92ZXJyaWRlcwoKbG9jYWwub3ZlcnJpZGVzID0gW107Cgpsb2NhbC5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgbWV0aG9kKXsKCXRoaXMub3ZlcnJpZGVzLnB1c2goe3JlZ2V4cDogcmVnZXhwLCBtZXRob2Q6IG1ldGhvZH0pOwp9OwoKLyo8b3ZlcnJpZGVzPiovCgovKjxxdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKdmFyIHJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuKlsqJF5dPSg/OlsiJ117Mn0pP1xdLzsKCmxvY2FsLm92ZXJyaWRlKC8uLywgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KXsgLy9xdWVyeVNlbGVjdG9yQWxsIG92ZXJyaWRlCgoJaWYgKCF0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwgfHwgdGhpcy5ub2RlVHlwZSAhPSA5IHx8ICFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCBsb2NhbC5icm9rZW5NaXhlZENhc2VRU0EgfHwKCShsb2NhbC5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJKGxvY2FsLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkgfHwgU2xpY2suZGlzYWJsZVFTQSkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2Rlcywgbm9kZTsKCXRyeSB7CgkJaWYgKGZpcnN0KSByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKGV4cHJlc3Npb24pIHx8IG51bGw7CgkJZWxzZSBub2RlcyA9IHRoaXMucXVlcnlTZWxlY3RvckFsbChleHByZXNzaW9uKTsKCX0gY2F0Y2goZXJyb3IpewoJCXJldHVybiBmYWxzZTsKCX0KCgl2YXIgaSwgaGFzT3RoZXJzID0gISEoZm91bmQubGVuZ3RoKTsKCglpZiAobG9jYWwuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKG5vZGUubm9kZU5hbWUgPiAnQCcgJiYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7Cgl9CgoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CgoJcmV0dXJuIHRydWU7Cgp9KTsKCi8qPC9xdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKLyo8dGFnLW92ZXJyaWRlPiovCgpsb2NhbC5vdmVycmlkZSgvXltcdy1dKyR8XlwqJC8sIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGZvdW5kLCBmaXJzdCl7IC8vIHRhZyBvdmVycmlkZQoJdmFyIHRhZyA9IGV4cHJlc3Npb247CglpZiAodGFnID09ICcqJyAmJiBsb2NhbC5icm9rZW5TdGFyR0VCVE4pIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgoJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCXZhciBpLCBub2RlLCBoYXNPdGhlcnMgPSAhIShmb3VuZC5sZW5ndGgpOwoKCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlEKG5vZGUpXSkgZm91bmQucHVzaChub2RlKTsKCX0KCglpZiAoaGFzT3RoZXJzKSBsb2NhbC5zb3J0KGZvdW5kKTsKCglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvdGFnLW92ZXJyaWRlPiovCgovKjxjbGFzcy1vdmVycmlkZT4qLwoKbG9jYWwub3ZlcnJpZGUoL15cLltcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBjbGFzcyBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCAoIXRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiB0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwpKSByZXR1cm4gZmFsc2U7CgoJdmFyIG5vZGVzLCBub2RlLCBpLCBoYXNPdGhlcnMgPSAhIShmb3VuZCAmJiBmb3VuZC5sZW5ndGgpLCBjbGFzc05hbWUgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKTsKCWlmICh0aGlzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIWxvY2FsLmJyb2tlbkdFQkNOKXsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwoJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfSBlbHNlIHsKCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArJyhcXHN8JCknKTsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQljbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKCQkJaWYgKCFjbGFzc05hbWUgfHwgIW1hdGNoQ2xhc3MudGVzdChjbGFzc05hbWUpKSBjb250aW51ZTsKCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfQoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiB0cnVlOwp9KTsKCi8qPC9jbGFzcy1vdmVycmlkZT4qLwoKLyo8aWQtb3ZlcnJpZGU+Ki8KCmxvY2FsLm92ZXJyaWRlKC9eI1tcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBJRCBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCB0aGlzLm5vZGVUeXBlICE9IDkpIHJldHVybiBmYWxzZTsKCgl2YXIgaWQgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKSwgZWwgPSB0aGlzLmdldEVsZW1lbnRCeUlkKGlkKTsKCWlmICghZWwpIHJldHVybiBmb3VuZDsKCWlmIChsb2NhbC5pZEdldHNOYW1lICYmIGVsLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSByZXR1cm4gZmFsc2U7CglpZiAoZmlyc3QpIHJldHVybiBlbCB8fCBudWxsOwoJdmFyIGhhc090aGVycyA9ICEhKGZvdW5kLmxlbmd0aCk7CglpZiAoIWhhc090aGVycyB8fCAhbG9jYWwudW5pcXVlc1tsb2NhbC5nZXRVSURIVE1MKGVsKV0pIGZvdW5kLnB1c2goZWwpOwoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvaWQtb3ZlcnJpZGU+Ki8KCi8qPC9vdmVycmlkZXM+Ki8KCmlmICh0eXBlb2YgZG9jdW1lbnQgIT0gJ3VuZGVmaW5lZCcpIGxvY2FsLnNldERvY3VtZW50KGRvY3VtZW50KTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMC45ZGV2JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCXJldHVybiBsb2NhbC5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWlmICh0eXBlb2Ygc2VsZWN0b3IgIT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoIXRhZy50ZXN0KC9eW1x3LV0rJC8pKXsKCQl2YXIgcGFyc2VkID0gU2xpY2sucGFyc2UodGFnKS5leHByZXNzaW9uc1swXVswXTsKCQl0YWcgPSAocGFyc2VkLnRhZyA9PSAnKicpID8gJ2RpdicgOiBwYXJzZWQudGFnOwoJCWlmIChwYXJzZWQuaWQgJiYgcHJvcHMuaWQgPT0gbnVsbCkgcHJvcHMuaWQgPSBwYXJzZWQuaWQ7CgoJCXZhciBhdHRyaWJ1dGVzID0gcGFyc2VkLmF0dHJpYnV0ZXM7CgkJaWYgKGF0dHJpYnV0ZXMpIGZvciAodmFyIGkgPSAwLCBsID0gYXR0cmlidXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChhdHRyLnZhbHVlICE9IG51bGwgJiYgYXR0ci5vcGVyYXRvciA9PSAnPScgJiYgcHJvcHNbYXR0ci5rZXldID09IG51bGwpCgkJCQlwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCX0KCgkJaWYgKHBhcnNlZC5jbGFzc0xpc3QgJiYgcHJvcHNbJ2NsYXNzJ10gPT0gbnVsbCkgcHJvcHNbJ2NsYXNzJ10gPSBwYXJzZWQuY2xhc3NMaXN0LmpvaW4oJyAnKTsKCX0KCglyZXR1cm4gZG9jdW1lbnQubmV3RWxlbWVudCh0YWcsIHByb3BzKTsKfTsKCmlmIChCcm93c2VyLkVsZW1lbnQpIEVsZW1lbnQucHJvdG90eXBlID0gQnJvd3Nlci5FbGVtZW50LnByb3RvdHlwZTsKCm5ldyBUeXBlKCdFbGVtZW50JywgRWxlbWVudCkubWlycm9yKGZ1bmN0aW9uKG5hbWUpewoJaWYgKEFycmF5LnByb3RvdHlwZVtuYW1lXSkgcmV0dXJuOwoKCXZhciBvYmogPSB7fTsKCW9ialtuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdHMgPSBbXSwgYXJncyA9IGFyZ3VtZW50cywgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IHRoaXNbaV0sIHJlc3VsdCA9IHJlc3VsdHNbaV0gPSBlbGVtZW50W25hbWVdLmFwcGx5KGVsZW1lbnQsIGFyZ3MpOwoJCQllbGVtZW50cyA9IChlbGVtZW50cyAmJiB0eXBlT2YocmVzdWx0KSA9PSAnZWxlbWVudCcpOwoJCX0KCQlyZXR1cm4gKGVsZW1lbnRzKSA/IG5ldyBFbGVtZW50cyhyZXN1bHRzKSA6IHJlc3VsdHM7Cgl9OwoKCUVsZW1lbnRzLmltcGxlbWVudChvYmopOwp9KTsKCmlmICghQnJvd3Nlci5FbGVtZW50KXsKCUVsZW1lbnQucGFyZW50ID0gT2JqZWN0OwoKCUVsZW1lbnQuUHJvdG90eXBlID0geyckZmFtaWx5JzogRnVuY3Rpb24uZnJvbSgnZWxlbWVudCcpLmhpZGUoKX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSBuZXcgSGFzaDsKCi8vPC8xLjJjb21wYXQ+Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcuZ2VuZXJhdGVVSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCQoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL15vYmplY3R8ZW1iZWQkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgooZnVuY3Rpb24oc2VhcmNoLCBmaW5kLCBtYXRjaCl7CgoJdGhpcy5TZWxlY3RvcnMgPSB7fTsKCXZhciBwc2V1ZG9zID0gdGhpcy5TZWxlY3RvcnMuUHNldWRvID0gbmV3IEhhc2goKTsKCgl2YXIgYWRkU2xpY2tQc2V1ZG9zID0gZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBuYW1lIGluIHBzZXVkb3MpIGlmIChwc2V1ZG9zLmhhc093blByb3BlcnR5KG5hbWUpKXsKCQkJU2xpY2suZGVmaW5lUHNldWRvKG5hbWUsIHBzZXVkb3NbbmFtZV0pOwoJCQlkZWxldGUgcHNldWRvc1tuYW1lXTsKCQl9Cgl9OwoKCVNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIHNlYXJjaC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cgl9OwoKCVNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gZmluZC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24pOwoJfTsKCglTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gbWF0Y2guY2FsbCh0aGlzLCBub2RlLCBzZWxlY3Rvcik7Cgl9OwoKfSkoU2xpY2suc2VhcmNoLCBTbGljay5maW5kLCBTbGljay5tYXRjaCk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJdmFyIGVsZW1lbnRzID0gbmV3IEVsZW1lbnRzOwoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIGVsZW1lbnRzKTsKCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmdzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGl0ZW0gPSBhcmdzW2ldOwoJCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goaXRlbSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgaXRlbSwgZWxlbWVudHMpOwoJCX0KCX0KCXJldHVybiBlbGVtZW50czsKfSk7CgovLzwvMS4yY29tcGF0PgoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCWlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIG5ldyBFbGVtZW50cyk7CgkJZWxzZSBpZiAoVHlwZS5pc0VudW1lcmFibGUoc2VsZWN0b3IpKSByZXR1cm4gbmV3IEVsZW1lbnRzKHNlbGVjdG9yKTsKCX0KCXJldHVybiBuZXcgRWxlbWVudHMoYXJndW1lbnRzKTsKfSk7CgooZnVuY3Rpb24oKXsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9Owp2YXIgcHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLmlubmVyVGV4dCA9PSBudWxsKSA/ICd0ZXh0Q29udGVudCcgOiAnaW5uZXJUZXh0JzsKCX0pKCkKfTsKdmFyIHJlYWRPbmx5ID0gWyd0eXBlJ107CnZhciBleHBhbmRvcyA9IFsndmFsdWUnLCAnZGVmYXVsdFZhbHVlJ107CnZhciB1cmlBdHRycyA9IC9eKD86aHJlZnxzcmN8dXNlbWFwKSQvaTsKCmJvb2xzID0gYm9vbHMuYXNzb2NpYXRlKGJvb2xzKTsKY2FtZWxzID0gY2FtZWxzLmFzc29jaWF0ZShjYW1lbHMubWFwKFN0cmluZy50b0xvd2VyQ2FzZSkpOwpyZWFkT25seSA9IHJlYWRPbmx5LmFzc29jaWF0ZShyZWFkT25seSk7CgpPYmplY3QuYXBwZW5kKGF0dHJpYnV0ZXMsIGV4cGFuZG9zLmFzc29jaWF0ZShleHBhbmRvcykpOwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpOwoJCXZhciBjbGVhbiA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQpewoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCWlmIChCcm93c2VyLmllKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQl2YXIgcHJvcCA9IHByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfTsKCgkJdmFyIGk7CgkJaWYgKGNvbnRlbnRzKXsKCQkJdmFyIGNlID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSwgdGUgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCWZvciAoaSA9IGNlLmxlbmd0aDsgaS0tOykgY2xlYW4oY2VbaV0sIHRlW2ldKTsKCQl9CgoJCWNsZWFuKGNsb25lLCB0aGlzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXZhciB0cyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLAoJCQkJY3MgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksCgkJCQl0bCA9IHRzLmxlbmd0aCwgY2wgPSBjcy5sZW5ndGg7CgkJCWZvciAoaSA9IDA7IGkgPCB0bCAmJiBpIDwgY2w7IGkrKykKCQkJCWNzW2ldLm91dGVySFRNTCA9IHRzW2ldLm91dGVySFRNTDsKCQl9CgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0sCgoJZGVzdHJveTogZnVuY3Rpb24oKXsKCQl2YXIgY2hpbGRyZW4gPSBjbGVhbih0aGlzKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCUFycmF5LmVhY2goY2hpbGRyZW4sIGNsZWFuKTsKCQlFbGVtZW50LmRpc3Bvc2UodGhpcyk7CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUFycmF5LmZyb20odGhpcy5jaGlsZE5vZGVzKS5lYWNoKEVsZW1lbnQuZGlzcG9zZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRpc3Bvc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnBhcmVudE5vZGUpID8gdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpIDogdGhpczsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkW3RoaXMudWlkXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKSwgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldOwoJCWlmIChkZmx0ICE9IG51bGwgJiYgcHJvcCA9PSBudWxsKSBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV0gPSBkZmx0OwoJCXJldHVybiBwcm9wICE9IG51bGwgPyBwcm9wIDogbnVsbDsKCX0sCgoJc3RvcmU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQodGhpcy51aWQpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKCi8qCi0tLQoKbmFtZTogT2JqZWN0CgpkZXNjcmlwdGlvbjogT2JqZWN0IGdlbmVyaWMgbWV0aG9kcwoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFtPYmplY3QsIEhhc2hdCgouLi4KKi8KCgpPYmplY3QuZXh0ZW5kKHsKCglzdWJzZXQ6IGZ1bmN0aW9uKG9iamVjdCwga2V5cyl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGsgPSBrZXlzW2ldOwoJCQlyZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlPYmplY3QuZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlpZiAoZm4uY2FsbChiaW5kLCB2YWx1ZSwga2V5LCBvYmplY3QpKSByZXN1bHRzW2tleV0gPSB2YWx1ZTsKCQl9KTsKCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IENsYXNzLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCnZhciBFdmVudCA9IG5ldyBUeXBlKCdFdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CglldmVudCA9IGV2ZW50IHx8IHdpbi5ldmVudDsKCWlmIChldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCXRoaXMuJGV4dGVuZGVkID0gdHJ1ZTsKCXZhciB0eXBlID0gZXZlbnQudHlwZSwKCQl0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudCwKCQlwYWdlID0ge30sCgkJY2xpZW50ID0ge307Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PSAzKSB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCglpZiAodHlwZS5pbmRleE9mKCdrZXknKSAhPSAtMSl7CgkJdmFyIGNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCXZhciBrZXkgPSBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSk7CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJdmFyIGZLZXkgPSBjb2RlIC0gMTExOwoJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSBrZXkgPSAnZicgKyBmS2V5OwoJCX0KCQlpZiAoIWtleSkga2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICh0eXBlLnRlc3QoL2NsaWNrfG1vdXNlfG1lbnUvaSkpewoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJcGFnZSA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggOiBldmVudC5jbGllbnRYICsgZG9jLnNjcm9sbExlZnQsCgkJCXk6IChldmVudC5wYWdlWSAhPSBudWxsKSA/IGV2ZW50LnBhZ2VZIDogZXZlbnQuY2xpZW50WSArIGRvYy5zY3JvbGxUb3AKCQl9OwoJCWNsaWVudCA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggLSB3aW4ucGFnZVhPZmZzZXQgOiBldmVudC5jbGllbnRYLAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSAtIHdpbi5wYWdlWU9mZnNldCA6IGV2ZW50LmNsaWVudFkKCQl9OwoJCWlmICh0eXBlLnRlc3QoL0RPTU1vdXNlU2Nyb2xsfG1vdXNld2hlZWwvKSl7CgkJCXZhciB3aGVlbCA9IChldmVudC53aGVlbERlbHRhKSA/IGV2ZW50LndoZWVsRGVsdGEgLyAxMjAgOiAtKGV2ZW50LmRldGFpbCB8fCAwKSAvIDM7CgkJfQoJCXZhciByaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMpIHx8IChldmVudC5idXR0b24gPT0gMiksCgkJCXJlbGF0ZWQgPSBudWxsOwoJCWlmICh0eXBlLnRlc3QoL292ZXJ8b3V0LykpewoJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJdmFyIHRlc3RSZWxhdGVkID0gZnVuY3Rpb24oKXsKCQkJCXdoaWxlIChyZWxhdGVkICYmIHJlbGF0ZWQubm9kZVR5cGUgPT0gMykgcmVsYXRlZCA9IHJlbGF0ZWQucGFyZW50Tm9kZTsKCQkJCXJldHVybiB0cnVlOwoJCQl9OwoJCQl2YXIgaGFzUmVsYXRlZCA9IChCcm93c2VyLmZpcmVmb3gyKSA/IHRlc3RSZWxhdGVkLmF0dGVtcHQoKSA6IHRlc3RSZWxhdGVkKCk7CgkJCXJlbGF0ZWQgPSAoaGFzUmVsYXRlZCkgPyByZWxhdGVkIDogbnVsbDsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUudGVzdCgvZ2VzdHVyZXx0b3VjaC9pKSl7CgkJdGhpcy5yb3RhdGlvbiA9IGV2ZW50LnJvdGF0aW9uOwoJCXRoaXMuc2NhbGUgPSBldmVudC5zY2FsZTsKCQl0aGlzLnRhcmdldFRvdWNoZXMgPSBldmVudC50YXJnZXRUb3VjaGVzOwoJCXRoaXMuY2hhbmdlZFRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlczsKCQl2YXIgdG91Y2hlcyA9IHRoaXMudG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7CgkJaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSl7CgkJCXZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCXBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJY2xpZW50ID0ge3g6IHRvdWNoLmNsaWVudFgsIHk6IHRvdWNoLmNsaWVudFl9OwoJCX0KCX0KCglyZXR1cm4gT2JqZWN0LmFwcGVuZCh0aGlzLCB7CgkJZXZlbnQ6IGV2ZW50LAoJCXR5cGU6IHR5cGUsCgoJCXBhZ2U6IHBhZ2UsCgkJY2xpZW50OiBjbGllbnQsCgkJcmlnaHRDbGljazogcmlnaHRDbGljaywKCgkJd2hlZWw6IHdoZWVsLAoKCQlyZWxhdGVkVGFyZ2V0OiBkb2N1bWVudC5pZChyZWxhdGVkKSwKCQl0YXJnZXQ6IGRvY3VtZW50LmlkKHRhcmdldCksCgoJCWNvZGU6IGNvZGUsCgkJa2V5OiBrZXksCgoJCXNoaWZ0OiBldmVudC5zaGlmdEtleSwKCQljb250cm9sOiBldmVudC5jdHJsS2V5LAoJCWFsdDogZXZlbnQuYWx0S2V5LAoJCW1ldGE6IGV2ZW50Lm1ldGFLZXkKCX0pOwp9KTsKCkV2ZW50LktleXMgPSB7CgknZW50ZXInOiAxMywKCSd1cCc6IDM4LAoJJ2Rvd24nOiA0MCwKCSdsZWZ0JzogMzcsCgkncmlnaHQnOiAzOSwKCSdlc2MnOiAyNywKCSdzcGFjZSc6IDMyLAoJJ2JhY2tzcGFjZSc6IDgsCgkndGFiJzogOSwKCSdkZWxldGUnOiA0Ngp9OwoKLy88MS4yY29tcGF0PgoKRXZlbnQuS2V5cyA9IG5ldyBIYXNoKEV2ZW50LktleXMpOwoKLy88LzEuMmNvbXBhdD4KCkV2ZW50LmltcGxlbWVudCh7CgoJc3RvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zdG9wUHJvcGFnYXRpb24oKS5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCWVsc2UgdGhpcy5ldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5wcmV2ZW50RGVmYXVsdCkgdGhpcy5ldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCWVsc2UgdGhpcy5ldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFdmVudF0KCnByb3ZpZGVzOiBFbGVtZW50LkV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpewoKRWxlbWVudC5Qcm9wZXJ0aWVzLmV2ZW50cyA9IHtzZXQ6IGZ1bmN0aW9uKGV2ZW50cyl7Cgl0aGlzLmFkZEV2ZW50cyhldmVudHMpOwp9fTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnLCB7fSk7CgkJaWYgKCFldmVudHNbdHlwZV0pIGV2ZW50c1t0eXBlXSA9IHtrZXlzOiBbXSwgdmFsdWVzOiBbXX07CgkJaWYgKGV2ZW50c1t0eXBlXS5rZXlzLmNvbnRhaW5zKGZuKSkgcmV0dXJuIHRoaXM7CgkJZXZlbnRzW3R5cGVdLmtleXMucHVzaChmbik7CgkJdmFyIHJlYWxUeXBlID0gdHlwZSwKCQkJY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV0sCgkJCWNvbmRpdGlvbiA9IGZuLAoJCQlzZWxmID0gdGhpczsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vbkFkZCkgY3VzdG9tLm9uQWRkLmNhbGwodGhpcywgZm4pOwoJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbil7CgkJCQljb25kaXRpb24gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJaWYgKGN1c3RvbS5jb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRoaXMsIGV2ZW50KTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX07CgkJCX0KCQkJcmVhbFR5cGUgPSBjdXN0b20uYmFzZSB8fCByZWFsVHlwZTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBJRTkKdHJ5IHsKCWlmICh0eXBlb2YgSFRNTEVsZW1lbnQgIT0gJ3VuZGVmaW5lZCcpCgkJSFRNTEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudCA9IEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudDsKfSBjYXRjaChlKXt9CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCWlzRnJhbWVkID0gdHJ1ZTsKCi8vIFRoYW5rcyB0byBSaWNoIERvdWdoZXJ0eSA8aHR0cDovL3d3dy5yaWNoZG91Z2hlcnR5LmNvbS8+CnRyeSB7Cglpc0ZyYW1lZCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgIT0gbnVsbDsKfSBjYXRjaChlKXt9Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCQoJZG9jdW1lbnQuZmlyZUV2ZW50KCdkb21yZWFkeScpOwoJd2luZG93LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKfTsKCnZhciBjaGVjayA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gY2hlY2tzLmxlbmd0aDsgaS0tOykgaWYgKGNoZWNrc1tpXSgpKXsKCQlkb21yZWFkeSgpOwoJCXJldHVybiB0cnVlOwoJfQoKCXJldHVybiBmYWxzZTsKfTsKCnZhciBwb2xsID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAoIWNoZWNrKCkpIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCAxMCk7Cn07Cgpkb2N1bWVudC5hZGRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KTsKCi8vIGRvU2Nyb2xsIHRlY2huaXF1ZSBieSBEaWVnbyBQZXJpbmkgaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KdmFyIHRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhaXNGcmFtZWQpewoJY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCQl0cnkgewoJCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGNhdGNoIChlKXt9CgoJCXJldHVybiBmYWxzZTsKCX0pOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlKSBjaGVja3MucHVzaChmdW5jdGlvbigpewoJdmFyIHN0YXRlID0gZG9jdW1lbnQucmVhZHlTdGF0ZTsKCXJldHVybiAoc3RhdGUgPT0gJ2xvYWRlZCcgfHwgc3RhdGUgPT0gJ2NvbXBsZXRlJyk7Cn0pOwoKaWYgKCdvbnJlYWR5c3RhdGVjaGFuZ2UnIGluIGRvY3VtZW50KSBkb2N1bWVudC5hZGRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKZWxzZSBzaG91bGRQb2xsID0gdHJ1ZTsKCmlmIChzaG91bGRQb2xsKSBwb2xsKCk7CgpFbGVtZW50LkV2ZW50cy5kb21yZWFkeSA9IHsKCW9uQWRkOiBmdW5jdGlvbihmbil7CgkJaWYgKHJlYWR5KSBmbi5jYWxsKHRoaXMpOwoJfQp9OwoKLy8gTWFrZSBzdXJlIHRoYXQgZG9tcmVhZHkgZmlyZXMgYmVmb3JlIGxvYWQKRWxlbWVudC5FdmVudHMubG9hZCA9IHsKCWJhc2U6ICdsb2FkJywKCW9uQWRkOiBmdW5jdGlvbihmbil7CgkJaWYgKGxvYWRlZCAmJiB0aGlzID09IHdpbmRvdykgZm4uY2FsbCh0aGlzKTsKCX0sCgljb25kaXRpb246IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMgPT0gd2luZG93KXsKCQkJZG9tcmVhZHkoKTsKCQkJZGVsZXRlIEVsZW1lbnQuRXZlbnRzLmxvYWQ7CgkJfQoJCQoJCXJldHVybiB0cnVlOwoJfQp9OwoKLy8gVGhpcyBpcyBiYXNlZCBvbiB0aGUgY3VzdG9tIGxvYWQgZXZlbnQKd2luZG93LmFkZEV2ZW50KCdsb2FkJywgZnVuY3Rpb24oKXsKCWxvYWRlZCA9IHRydWU7Cn0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAoIXRoaXMuYWRkRXZlbnQpIHJldHVybiB0aGlzOwoJCWZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7fTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJCgkJdGhpcy5yZXNwb25zZSA9IHt0ZXh0OiB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHhtbDogdGhpcy54aHIucmVzcG9uc2VYTUx9OwoJCWlmICh0aGlzLm9wdGlvbnMuaXNTdWNjZXNzLmNhbGwodGhpcywgdGhpcy5zdGF0dXMpKQoJCQl0aGlzLnN1Y2Nlc3ModGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLnJlc3BvbnNlLnhtbCk7CgkJZWxzZQoJCQl0aGlzLmZhaWx1cmUoKTsKCX0sCgoJaXNTdWNjZXNzOiBmdW5jdGlvbigpewoJCXZhciBzdGF0dXMgPSB0aGlzLnN0YXR1czsKCQlyZXR1cm4gKHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwKTsKCX0sCgoJaXNSdW5uaW5nOiBmdW5jdGlvbigpewoJCXJldHVybiAhIXRoaXMucnVubmluZzsKCX0sCgoJcHJvY2Vzc1NjcmlwdHM6IGZ1bmN0aW9uKHRleHQpewoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFJlc3BvbnNlIHx8ICgvKGVjbWF8amF2YSlzY3JpcHQvKS50ZXN0KHRoaXMuZ2V0SGVhZGVyKCdDb250ZW50LXR5cGUnKSkpIHJldHVybiBCcm93c2VyLmV4ZWModGV4dCk7CgkJcmV0dXJuIHRleHQuc3RyaXBTY3JpcHRzKHRoaXMub3B0aW9ucy5ldmFsU2NyaXB0cyk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQsIHhtbCl7CgkJdGhpcy5vblN1Y2Nlc3ModGhpcy5wcm9jZXNzU2NyaXB0cyh0ZXh0KSwgeG1sKTsKCX0sCgoJb25TdWNjZXNzOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIGFyZ3VtZW50cykuZmlyZUV2ZW50KCdzdWNjZXNzJywgYXJndW1lbnRzKS5jYWxsQ2hhaW4oKTsKCX0sCgoJZmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLm9uRmFpbHVyZSgpOwoJfSwKCglvbkZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJykuZmlyZUV2ZW50KCdmYWlsdXJlJywgdGhpcy54aHIpOwoJfSwKCQoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgkKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJdGltZW91dDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgndGltZW91dCcsIHRoaXMueGhyKTsKCX0sCgoJc2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpOwoJCX0uYmluZCh0aGlzKSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgkKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgkJCgkJdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpOwoJCWlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pOwoKCQlpZiAodGhpcy5vcHRpb25zLm5vQ2FjaGUpCgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgU3RyaW5nLmdlbmVyYXRlVUlEKCk7CgoJCWlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCl7CgkJCXhoci5vbmxvYWRzdGFydCA9IHRoaXMubG9hZHN0YXJ0LmJpbmQodGhpcyk7CgkJCXhoci5vbnByb2dyZXNzID0gdGhpcy5wcm9ncmVzcy5iaW5kKHRoaXMpOwoJCX0KCgkJeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgdGhpcy5vcHRpb25zLmFzeW5jLCB0aGlzLm9wdGlvbnMudXNlciwgdGhpcy5vcHRpb25zLnBhc3N3b3JkKTsKCQlpZiAodGhpcy5vcHRpb25zLnVzZXIgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyKSB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKCQkKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLnRpbWVvdXQuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQl4aHIuYWJvcnQoKTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZnVuY3Rpb24oKXt9OwoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIG1ldGhvZHMgPSB7fTsKWydnZXQnLCAncG9zdCcsICdwdXQnLCAnZGVsZXRlJywgJ0dFVCcsICdQT1NUJywgJ1BVVCcsICdERUxFVEUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CgltZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbihkYXRhKXsKCQlyZXR1cm4gdGhpcy5zZW5kKHsKCQkJZGF0YTogZGF0YSwKCQkJbWV0aG9kOiBtZXRob2QKCQl9KTsKCX07Cn0pOwoKUmVxdWVzdC5pbXBsZW1lbnQobWV0aG9kcyk7CgpFbGVtZW50LlByb3BlcnRpZXMuc2VuZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZW5kID0gdGhpcy5nZXQoJ3NlbmQnKS5jYW5jZWwoKTsKCQlzZW5kLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgc2VuZCA9IHRoaXMucmV0cmlldmUoJ3NlbmQnKTsKCQlpZiAoIXNlbmQpewoJCQlzZW5kID0gbmV3IFJlcXVlc3QoewoJCQkJZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIG1ldGhvZDogdGhpcy5nZXQoJ21ldGhvZCcpIHx8ICdwb3N0JywgdXJsOiB0aGlzLmdldCgnYWN0aW9uJykKCQkJfSk7CgkJCXRoaXMuc3RvcmUoJ3NlbmQnLCBzZW5kKTsKCQl9CgkJcmV0dXJuIHNlbmQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNlbmQ6IGZ1bmN0aW9uKHVybCl7CgkJdmFyIHNlbmRlciA9IHRoaXMuZ2V0KCdzZW5kJyk7CgkJc2VuZGVyLnNlbmQoe2RhdGE6IHRoaXMsIHVybDogdXJsIHx8IHNlbmRlci5vcHRpb25zLnVybH0pOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0LkhUTUwKCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBiYXNpYyBSZXF1ZXN0IENsYXNzIHdpdGggYWRkaXRpb25hbCBtZXRob2RzIGZvciBpbnRlcmFjdGluZyB3aXRoIEhUTUwgcmVzcG9uc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIFJlcXVlc3RdCgpwcm92aWRlczogUmVxdWVzdC5IVE1MCgouLi4KKi8KClJlcXVlc3QuSFRNTCA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogUmVxdWVzdCwKCglvcHRpb25zOiB7CgkJdXBkYXRlOiBmYWxzZSwKCQlhcHBlbmQ6IGZhbHNlLAoJCWV2YWxTY3JpcHRzOiB0cnVlLAoJCWZpbHRlcjogZmFsc2UsCgkJaGVhZGVyczogewoJCQlBY2NlcHQ6ICd0ZXh0L2h0bWwsIGFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwsICovKicKCQl9Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQpewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLCByZXNwb25zZSA9IHRoaXMucmVzcG9uc2U7CgoJCXJlc3BvbnNlLmh0bWwgPSB0ZXh0LnN0cmlwU2NyaXB0cyhmdW5jdGlvbihzY3JpcHQpewoJCQlyZXNwb25zZS5qYXZhc2NyaXB0ID0gc2NyaXB0OwoJCX0pOwoKCQl2YXIgbWF0Y2ggPSByZXNwb25zZS5odG1sLm1hdGNoKC88Ym9keVtePl0qPihbXHNcU10qPyk8XC9ib2R5Pi9pKTsKCQlpZiAobWF0Y2gpIHJlc3BvbnNlLmh0bWwgPSBtYXRjaFsxXTsKCQl2YXIgdGVtcCA9IG5ldyBFbGVtZW50KCdkaXYnKS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCgkJcmVzcG9uc2UudHJlZSA9IHRlbXAuY2hpbGROb2RlczsKCQlyZXNwb25zZS5lbGVtZW50cyA9IHRlbXAuZ2V0RWxlbWVudHMoJyonKTsKCgkJaWYgKG9wdGlvbnMuZmlsdGVyKSByZXNwb25zZS50cmVlID0gcmVzcG9uc2UuZWxlbWVudHMuZmlsdGVyKG9wdGlvbnMuZmlsdGVyKTsKCQlpZiAob3B0aW9ucy51cGRhdGUpIGRvY3VtZW50LmlkKG9wdGlvbnMudXBkYXRlKS5lbXB0eSgpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoJCWVsc2UgaWYgKG9wdGlvbnMuYXBwZW5kKSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCkuYWRvcHQodGVtcC5nZXRDaGlsZHJlbigpKTsKCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgo=",
                "body": "LyoKLS0tCgpuYW1lOiBDb3JlCgpkZXNjcmlwdGlvbjogVGhlIGhlYXJ0IG9mIE1vb1Rvb2xzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjb3B5cmlnaHQ6IENvcHlyaWdodCAoYykgMjAwNi0yMDEwIFtWYWxlcmlvIFByb2lldHRpXShodHRwOi8vbWFkNG1pbGsubmV0LykuCgphdXRob3JzOiBUaGUgTW9vVG9vbHMgcHJvZHVjdGlvbiB0ZWFtIChodHRwOi8vbW9vdG9vbHMubmV0L2RldmVsb3BlcnMvKQoKaW5zcGlyYXRpb246CiAgLSBDbGFzcyBpbXBsZW1lbnRhdGlvbiBpbnNwaXJlZCBieSBbQmFzZS5qc10oaHR0cDovL2RlYW4uZWR3YXJkcy5uYW1lL3dlYmxvZy8yMDA2LzAzL2Jhc2UvKSBDb3B5cmlnaHQgKGMpIDIwMDYgRGVhbiBFZHdhcmRzLCBbR05VIExlc3NlciBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbGdwbC1saWNlbnNlLnBocCkKICAtIFNvbWUgZnVuY3Rpb25hbGl0eSBpbnNwaXJlZCBieSBbUHJvdG90eXBlLmpzXShodHRwOi8vcHJvdG90eXBlanMub3JnKSBDb3B5cmlnaHQgKGMpIDIwMDUtMjAwNyBTYW0gU3RlcGhlbnNvbiwgW01JVCBMaWNlbnNlXShodHRwOi8vb3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvbWl0LWxpY2Vuc2UucGhwKQoKcHJvdmlkZXM6IFtDb3JlLCBNb29Ub29scywgVHlwZSwgdHlwZU9mLCBpbnN0YW5jZU9mLCBOYXRpdmVdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdGhpcy5Nb29Ub29scyA9IHsKCXZlcnNpb246ICcxLjNkZXYnLAoJYnVpbGQ6ICcwYTdhZWFiYmJhYzViYzIzYjAyMWI0YzFhYTliYTcyMmM0MGUzMDNkJwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm4gdGhpczsKCgl2YXIgaG9va3MgPSBob29rc09mKHRoaXMpOwoKCWZvciAodmFyIGkgPSAwOyBpIDwgaG9va3MubGVuZ3RoOyBpKyspewoJCXZhciBob29rID0gaG9va3NbaV07CgkJaWYgKHR5cGVPZihob29rKSA9PSAndHlwZScpIGltcGxlbWVudC5jYWxsKGhvb2ssIG5hbWUsIG1ldGhvZCk7CgkJZWxzZSBob29rLmNhbGwodGhpcywgbmFtZSwgbWV0aG9kKTsKCX0KCQoJdmFyIHByZXZpb3VzID0gdGhpcy5wcm90b3R5cGVbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpcy5wcm90b3R5cGVbbmFtZV0gPSBtZXRob2Q7CgoJaWYgKHRoaXNbbmFtZV0gPT0gbnVsbCAmJiB0eXBlT2YobWV0aG9kKSA9PSAnZnVuY3Rpb24nKSBleHRlbmQuY2FsbCh0aGlzLCBuYW1lLCBmdW5jdGlvbihpdGVtKXsKCQlyZXR1cm4gbWV0aG9kLmFwcGx5KGl0ZW0sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7Cgl9KTsKCglyZXR1cm4gdGhpczsKfTsKCnZhciBleHRlbmQgPSBmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJaWYgKG1ldGhvZCAmJiBtZXRob2QuJGhpZGRlbikgcmV0dXJuIHRoaXM7Cgl2YXIgcHJldmlvdXMgPSB0aGlzW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXNbbmFtZV0gPSBtZXRob2Q7CglyZXR1cm4gdGhpczsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgnZ2VuZXJhdGVVSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCi8vPDEuMmNvbXBhdD4KCnZhciBIYXNoID0gdGhpcy5IYXNoID0gbmV3IFR5cGUoJ0hhc2gnLCBmdW5jdGlvbihvYmplY3QpewoJaWYgKHR5cGVPZihvYmplY3QpID09ICdoYXNoJykgb2JqZWN0ID0gT2JqZWN0LmNsb25lKG9iamVjdC5nZXRDbGVhbigpKTsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpIHRoaXNba2V5XSA9IG9iamVjdFtrZXldOwoJcmV0dXJuIHRoaXM7Cn0pOwoKSGFzaC5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlPYmplY3QuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCWdldENsZWFuOiBmdW5jdGlvbigpewoJCXZhciBjbGVhbiA9IHt9OwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgY2xlYW5ba2V5XSA9IHRoaXNba2V5XTsKCQl9CgkJcmV0dXJuIGNsZWFuOwoJfSwKCglnZXRMZW5ndGg6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IDA7CgkJZm9yICh2YXIga2V5IGluIHRoaXMpewoJCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBsZW5ndGgrKzsKCQl9CgkJcmV0dXJuIGxlbmd0aDsKCX0KCn0pOwoKSGFzaC5hbGlhcygnZWFjaCcsICdmb3JFYWNoJyk7CgpPYmplY3QudHlwZSA9IFR5cGUuaXNPYmplY3Q7Cgp2YXIgTmF0aXZlID0gdGhpcy5OYXRpdmUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCXJldHVybiBuZXcgVHlwZShwcm9wZXJ0aWVzLm5hbWUsIHByb3BlcnRpZXMuaW5pdGlhbGl6ZSk7Cn07CgpOYXRpdmUudHlwZSA9IFR5cGUudHlwZTsKCk5hdGl2ZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihvYmplY3RzLCBtZXRob2RzKXsKCWZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgb2JqZWN0c1tpXS5pbXBsZW1lbnQobWV0aG9kcyk7CglyZXR1cm4gTmF0aXZlOwp9OwoKdmFyIGFycmF5VHlwZSA9IEFycmF5LnR5cGU7CkFycmF5LnR5cGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpbnN0YW5jZU9mKGl0ZW0sIEFycmF5KSB8fCBhcnJheVR5cGUoaXRlbSk7Cn07Cgp0aGlzLiRBID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gQXJyYXkuZnJvbShpdGVtKS5zbGljZSgpOwp9OwoKdGhpcy4kYXJndW1lbnRzID0gZnVuY3Rpb24oaSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQlyZXR1cm4gYXJndW1lbnRzW2ldOwoJfTsKfTsKCnRoaXMuJGNoayA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gISEob2JqIHx8IG9iaiA9PT0gMCk7Cn07Cgp0aGlzLiRjbGVhciA9IGZ1bmN0aW9uKHRpbWVyKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CgljbGVhckludGVydmFsKHRpbWVyKTsKCXJldHVybiBudWxsOwp9OwoKdGhpcy4kZGVmaW5lZCA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gKG9iaiAhPSBudWxsKTsKfTsKCnRoaXMuJGVhY2ggPSBmdW5jdGlvbihpdGVyYWJsZSwgZm4sIGJpbmQpewoJdmFyIHR5cGUgPSB0eXBlT2YoaXRlcmFibGUpOwoJKCh0eXBlID09ICdhcmd1bWVudHMnIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdlbGVtZW50cycpID8gQXJyYXkgOiBPYmplY3QpLmVhY2goaXRlcmFibGUsIGZuLCBiaW5kKTsKfTsKCnRoaXMuJGVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKdGhpcy4kZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luYWwsIGV4dGVuZGVkKXsKCXJldHVybiBPYmplY3QuYXBwZW5kKG9yaWdpbmFsLCBleHRlbmRlZCk7Cn07Cgp0aGlzLiRIID0gZnVuY3Rpb24ob2JqZWN0KXsKCXJldHVybiBuZXcgSGFzaChvYmplY3QpOwp9OwoKdGhpcy4kbWVyZ2UgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMpOwoJYXJncy51bnNoaWZ0KHt9KTsKCXJldHVybiBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgYXJncyk7Cn07Cgp0aGlzLiRsYW1iZGEgPSBGdW5jdGlvbi5mcm9tOwp0aGlzLiRtaXhpbiA9IE9iamVjdC5tZXJnZTsKdGhpcy4kcmFuZG9tID0gTnVtYmVyLnJhbmRvbTsKdGhpcy4kc3BsYXQgPSBBcnJheS5mcm9tOwp0aGlzLiR0aW1lID0gRGF0ZS5ub3c7Cgp0aGlzLiR0eXBlID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdCk7CglpZiAodHlwZSA9PSAnZWxlbWVudHMnKSByZXR1cm4gJ2FycmF5JzsKCXJldHVybiAodHlwZSA9PSAnbnVsbCcpID8gZmFsc2UgOiB0eXBlOwp9OwoKdGhpcy4kdW5saW5rID0gZnVuY3Rpb24ob2JqZWN0KXsKCXN3aXRjaCAodHlwZU9mKG9iamVjdCkpewoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUob2JqZWN0KTsKCQljYXNlICdhcnJheSc6IHJldHVybiBBcnJheS5jbG9uZShvYmplY3QpOwoJCWNhc2UgJ2hhc2gnOiByZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKCQlkZWZhdWx0OiByZXR1cm4gb2JqZWN0OwoJfQp9OwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJaW52b2tlOiBmdW5jdGlvbihtZXRob2ROYW1lKXsKCQl2YXIgYXJncyA9IEFycmF5LnNsaWNlKGFyZ3VtZW50cywgMSk7CgkJcmV0dXJuIHRoaXMubWFwKGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbVttZXRob2ROYW1lXS5hcHBseShpdGVtLCBhcmdzKTsKCQl9KTsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbSAhPSBudWxsOwoJCX0pOwoJfSwKCglpbmRleE9mOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQl2YXIgbGVuID0gdGhpcy5sZW5ndGg7CgkJZm9yICh2YXIgaSA9IChmcm9tIDwgMCkgPyBNYXRoLm1heCgwLCBsZW4gKyBmcm9tKSA6IGZyb20gfHwgMDsgaSA8IGxlbjsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHJldHVybiBpOwoJCX0KCQlyZXR1cm4gLTE7Cgl9LAoKCW1hcDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXZhciByZXN1bHRzID0gW107CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWlmIChpIGluIHRoaXMpIHJlc3VsdHNbaV0gPSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJc29tZTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJYXNzb2NpYXRlOiBmdW5jdGlvbihrZXlzKXsKCQl2YXIgb2JqID0ge30sIGxlbmd0aCA9IE1hdGgubWluKHRoaXMubGVuZ3RoLCBrZXlzLmxlbmd0aCk7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgb2JqW2tleXNbaV1dID0gdGhpc1tpXTsKCQlyZXR1cm4gb2JqOwoJfSwKCglsaW5rOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciByZXN1bHQgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJCQlpZiAob2JqZWN0W2tleV0odGhpc1tpXSkpewoJCQkJCXJlc3VsdFtrZXldID0gdGhpc1tpXTsKCQkJCQlkZWxldGUgb2JqZWN0W2tleV07CgkJCQkJYnJlYWs7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJY29udGFpbnM6IGZ1bmN0aW9uKGl0ZW0sIGZyb20pewoJCXJldHVybiB0aGlzLmluZGV4T2YoaXRlbSwgZnJvbSkgIT0gLTE7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24oYXJyYXkpewoJCXRoaXMucHVzaC5hcHBseSh0aGlzLCBhcnJheSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldExhc3Q6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLmxlbmd0aCkgPyB0aGlzW3RoaXMubGVuZ3RoIC0gMV0gOiBudWxsOwoJfSwKCglnZXRSYW5kb206IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLmxlbmd0aCkgPyB0aGlzW051bWJlci5yYW5kb20oMCwgdGhpcy5sZW5ndGggLSAxKV0gOiBudWxsOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihpdGVtKXsKCQlpZiAoIXRoaXMuY29udGFpbnMoaXRlbSkpIHRoaXMucHVzaChpdGVtKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tYmluZTogZnVuY3Rpb24oYXJyYXkpewoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLmluY2x1ZGUoYXJyYXlbaV0pOwoJCXJldHVybiB0aGlzOwoJfSwKCgllcmFzZTogZnVuY3Rpb24oaXRlbSl7CgkJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQkJaWYgKHRoaXNbaV0gPT09IGl0ZW0pIHRoaXMuc3BsaWNlKGksIDEpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJdGhpcy5sZW5ndGggPSAwOwoJCXJldHVybiB0aGlzOwoJfSwKCglmbGF0dGVuOiBmdW5jdGlvbigpewoJCXZhciBhcnJheSA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgdHlwZSA9IHR5cGVPZih0aGlzW2ldKTsKCQkJaWYgKHR5cGUgPT0gJ251bGwnKSBjb250aW51ZTsKCQkJYXJyYXkgPSBhcnJheS5jb25jYXQoKHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdjb2xsZWN0aW9uJyB8fCB0eXBlID09ICdhcmd1bWVudHMnIHx8IGluc3RhbmNlT2YodGhpc1tpXSwgQXJyYXkpKSA/IEFycmF5LmZsYXR0ZW4odGhpc1tpXSkgOiB0aGlzW2ldKTsKCQl9CgkJcmV0dXJuIGFycmF5OwoJfSwKCglwaWNrOiBmdW5jdGlvbigpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAodGhpc1tpXSAhPSBudWxsKSByZXR1cm4gdGhpc1tpXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoICE9IDMpIHJldHVybiBudWxsOwoJCXZhciByZ2IgPSB0aGlzLm1hcChmdW5jdGlvbih2YWx1ZSl7CgkJCWlmICh2YWx1ZS5sZW5ndGggPT0gMSkgdmFsdWUgKz0gdmFsdWU7CgkJCXJldHVybiB2YWx1ZS50b0ludCgxNik7CgkJfSk7CgkJcmV0dXJuIChhcnJheSkgPyByZ2IgOiAncmdiKCcgKyByZ2IgKyAnKSc7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJaWYgKHRoaXMubGVuZ3RoIDwgMykgcmV0dXJuIG51bGw7CgkJaWYgKHRoaXMubGVuZ3RoID09IDQgJiYgdGhpc1szXSA9PSAwICYmICFhcnJheSkgcmV0dXJuICd0cmFuc3BhcmVudCc7CgkJdmFyIGhleCA9IFtdOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgMzsgaSsrKXsKCQkJdmFyIGJpdCA9ICh0aGlzW2ldIC0gMCkudG9TdHJpbmcoMTYpOwoJCQloZXgucHVzaCgoYml0Lmxlbmd0aCA9PSAxKSA/ICcwJyArIGJpdCA6IGJpdCk7CgkJfQoJCXJldHVybiAoYXJyYXkpID8gaGV4IDogJyMnICsgaGV4LmpvaW4oJycpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpBcnJheS5hbGlhcygnZXh0ZW5kJywgJ2FwcGVuZCcpOwoKdmFyICRwaWNrID0gZnVuY3Rpb24oKXsKCXJldHVybiBBcnJheS5mcm9tKGFyZ3VtZW50cykucGljaygpOwp9OwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IFN0cmluZwoKZGVzY3JpcHRpb246IENvbnRhaW5zIFN0cmluZyBQcm90b3R5cGVzIGxpa2UgY2FtZWxDYXNlLCBjYXBpdGFsaXplLCB0ZXN0LCBhbmQgdG9JbnQuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogU3RyaW5nCgouLi4KKi8KClN0cmluZy5pbXBsZW1lbnQoewoKCXRlc3Q6IGZ1bmN0aW9uKHJlZ2V4LCBwYXJhbXMpewoJCXJldHVybiAoKHR5cGVPZihyZWdleCkgPT0gJ3JlZ2V4cCcpID8gcmVnZXggOiBuZXcgUmVnRXhwKCcnICsgcmVnZXgsIHBhcmFtcykpLnRlc3QodGhpcyk7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihzdHJpbmcsIHNlcGFyYXRvcil7CgkJcmV0dXJuIChzZXBhcmF0b3IpID8gKHNlcGFyYXRvciArIHRoaXMgKyBzZXBhcmF0b3IpLmluZGV4T2Yoc2VwYXJhdG9yICsgc3RyaW5nICsgc2VwYXJhdG9yKSA+IC0xIDogdGhpcy5pbmRleE9mKHN0cmluZykgPiAtMTsKCX0sCgoJdHJpbTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9eXHMrfFxzKyQvZywgJycpOwoJfSwKCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9ccysvZywgJyAnKS50cmltKCk7Cgl9LAoKCWNhbWVsQ2FzZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8tXEQvZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2guY2hhckF0KDEpLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWh5cGhlbmF0ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9bQS1aXS9nLCBmdW5jdGlvbihtYXRjaCl7CgkJCXJldHVybiAoJy0nICsgbWF0Y2guY2hhckF0KDApLnRvTG93ZXJDYXNlKCkpOwoJCX0pOwoJfSwKCgljYXBpdGFsaXplOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoL1xiW2Etel0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gbWF0Y2gudG9VcHBlckNhc2UoKTsKCQl9KTsKCX0sCgoJZXNjYXBlUmVnRXhwOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLnJlcGxhY2UoLyhbLS4qKz9eJHt9KCl8W1xdXC9cXF0pL2csICdcXCQxJyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCWhleFRvUmdiOiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIGhleCA9IHRoaXMubWF0Y2goL14jPyhcd3sxLDJ9KShcd3sxLDJ9KShcd3sxLDJ9KSQvKTsKCQlyZXR1cm4gKGhleCkgPyBoZXguc2xpY2UoMSkuaGV4VG9SZ2IoYXJyYXkpIDogbnVsbDsKCX0sCgoJcmdiVG9IZXg6IGZ1bmN0aW9uKGFycmF5KXsKCQl2YXIgcmdiID0gdGhpcy5tYXRjaCgvXGR7MSwzfS9nKTsKCQlyZXR1cm4gKHJnYikgPyByZ2IucmdiVG9IZXgoYXJyYXkpIDogbnVsbDsKCX0sCgoJc3Vic3RpdHV0ZTogZnVuY3Rpb24ob2JqZWN0LCByZWdleHApewoJCXJldHVybiB0aGlzLnJlcGxhY2UocmVnZXhwIHx8ICgvXFw/XHsoW157fV0rKVx9L2cpLCBmdW5jdGlvbihtYXRjaCwgbmFtZSl7CgkJCWlmIChtYXRjaC5jaGFyQXQoMCkgPT0gJ1xcJykgcmV0dXJuIG1hdGNoLnNsaWNlKDEpOwoJCQlyZXR1cm4gKG9iamVjdFtuYW1lXSAhPSBudWxsKSA/IG9iamVjdFtuYW1lXSA6ICcnOwoJCX0pOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCXBhc3M6IGZ1bmN0aW9uKGFyZ3MsIGJpbmQpewoJCXZhciBzZWxmID0gdGhpczsKCQlpZiAoYXJncyAhPSBudWxsKSBhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoKCWRlbGF5OiBmdW5jdGlvbihkZWxheSwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldFRpbWVvdXQodGhpcy5wYXNzKGFyZ3MsIGJpbmQpLCBkZWxheSk7Cgl9LAoKCXBlcmlvZGljYWw6IGZ1bmN0aW9uKHBlcmlvZGljYWwsIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRJbnRlcnZhbCh0aGlzLnBhc3MoYXJncywgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBOdW1iZXIKCmRlc2NyaXB0aW9uOiBDb250YWlucyBOdW1iZXIgUHJvdG90eXBlcyBsaWtlIGxpbWl0LCByb3VuZCwgdGltZXMsIGFuZCBjZWlsLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IE51bWJlcgoKLi4uCiovCgpOdW1iZXIuaW1wbGVtZW50KHsKCglsaW1pdDogZnVuY3Rpb24obWluLCBtYXgpewoJCXJldHVybiBNYXRoLm1pbihtYXgsIE1hdGgubWF4KG1pbiwgdGhpcykpOwoJfSwKCglyb3VuZDogZnVuY3Rpb24ocHJlY2lzaW9uKXsKCQlwcmVjaXNpb24gPSBNYXRoLnBvdygxMCwgcHJlY2lzaW9uIHx8IDApLnRvRml4ZWQocHJlY2lzaW9uIDwgMCA/IC1wcmVjaXNpb24gOiAwKTsKCQlyZXR1cm4gTWF0aC5yb3VuZCh0aGlzICogcHJlY2lzaW9uKSAvIHByZWNpc2lvbjsKCX0sCgoJdGltZXM6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMDsgaSA8IHRoaXM7IGkrKykgZm4uY2FsbChiaW5kLCBpLCB0aGlzKTsKCX0sCgoJdG9GbG9hdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gcGFyc2VGbG9hdCh0aGlzKTsKCX0sCgoJdG9JbnQ6IGZ1bmN0aW9uKGJhc2UpewoJCXJldHVybiBwYXJzZUludCh0aGlzLCBiYXNlIHx8IDEwKTsKCX0KCn0pOwoKTnVtYmVyLmFsaWFzKCdlYWNoJywgJ3RpbWVzJyk7CgooZnVuY3Rpb24obWF0aCl7Cgl2YXIgbWV0aG9kcyA9IHt9OwoJbWF0aC5lYWNoKGZ1bmN0aW9uKG5hbWUpewoJCWlmICghTnVtYmVyW25hbWVdKSBtZXRob2RzW25hbWVdID0gZnVuY3Rpb24oKXsKCQkJcmV0dXJuIE1hdGhbbmFtZV0uYXBwbHkobnVsbCwgW3RoaXNdLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQl9OwoJfSk7CglOdW1iZXIuaW1wbGVtZW50KG1ldGhvZHMpOwp9KShbJ2FicycsICdhY29zJywgJ2FzaW4nLCAnYXRhbicsICdhdGFuMicsICdjZWlsJywgJ2NvcycsICdleHAnLCAnZmxvb3InLCAnbG9nJywgJ21heCcsICdtaW4nLCAncG93JywgJ3NpbicsICdzcXJ0JywgJ3RhbiddKTsKCgovKgotLS0KCm5hbWU6IENsYXNzCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENsYXNzIEZ1bmN0aW9uIGZvciBlYXNpbHkgY3JlYXRpbmcsIGV4dGVuZGluZywgYW5kIGltcGxlbWVudGluZyByZXVzYWJsZSBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIEZ1bmN0aW9uLCBOdW1iZXJdCgpwcm92aWRlczogQ2xhc3MKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgQ2xhc3MgPSB0aGlzLkNsYXNzID0gbmV3IFR5cGUoJ0NsYXNzJywgZnVuY3Rpb24ocGFyYW1zKXsKCWlmIChpbnN0YW5jZU9mKHBhcmFtcywgRnVuY3Rpb24pKSBwYXJhbXMgPSB7aW5pdGlhbGl6ZTogcGFyYW1zfTsKCgl2YXIgbmV3Q2xhc3MgPSBmdW5jdGlvbigpewoJCXJlc2V0KHRoaXMpOwoJCWlmIChuZXdDbGFzcy4kcHJvdG90eXBpbmcpIHJldHVybiB0aGlzOwoJCXRoaXMuJGNhbGxlciA9IG51bGw7CgkJdmFyIHZhbHVlID0gKHRoaXMuaW5pdGlhbGl6ZSkgPyB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKSA6IHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gdGhpcy5jYWxsZXIgPSBudWxsOwoJCXJldHVybiB2YWx1ZTsKCX0uZXh0ZW5kKHRoaXMpLmltcGxlbWVudChwYXJhbXMpOwoKCW5ld0NsYXNzLiRjb25zdHJ1Y3RvciA9IENsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLiRjb25zdHJ1Y3RvciA9IG5ld0NsYXNzOwoJbmV3Q2xhc3MucHJvdG90eXBlLnBhcmVudCA9IHBhcmVudDsKCglyZXR1cm4gbmV3Q2xhc3M7Cn0pOwoKdmFyIHBhcmVudCA9IGZ1bmN0aW9uKCl7CglpZiAoIXRoaXMuJGNhbGxlcikgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICJwYXJlbnQiIGNhbm5vdCBiZSBjYWxsZWQuJyk7Cgl2YXIgbmFtZSA9IHRoaXMuJGNhbGxlci4kbmFtZSwKCQlwYXJlbnQgPSB0aGlzLiRjYWxsZXIuJG93bmVyLnBhcmVudCwKCQlwcmV2aW91cyA9IChwYXJlbnQpID8gcGFyZW50LnByb3RvdHlwZVtuYW1lXSA6IG51bGw7CglpZiAoIXByZXZpb3VzKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBuYW1lICsgJyIgaGFzIG5vIHBhcmVudC4nKTsKCXJldHVybiBwcmV2aW91cy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwp9OwoKdmFyIHJlc2V0ID0gZnVuY3Rpb24ob2JqZWN0KXsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCXZhciB2YWx1ZSA9IG9iamVjdFtrZXldOwoJCXN3aXRjaCAodHlwZU9mKHZhbHVlKSl7CgkJCWNhc2UgJ29iamVjdCc6CgkJCQl2YXIgRiA9IGZ1bmN0aW9uKCl7fTsKCQkJCUYucHJvdG90eXBlID0gdmFsdWU7CgkJCQlvYmplY3Rba2V5XSA9IHJlc2V0KG5ldyBGKTsKCQkJYnJlYWs7CgkJCWNhc2UgJ2FycmF5Jzogb2JqZWN0W2tleV0gPSB2YWx1ZS5jbG9uZSgpOyBicmVhazsKCQl9Cgl9CglyZXR1cm4gb2JqZWN0Owp9OwoKdmFyIHdyYXAgPSBmdW5jdGlvbihzZWxmLCBrZXksIG1ldGhvZCl7CglpZiAobWV0aG9kLiRvcmlnaW4pIG1ldGhvZCA9IG1ldGhvZC4kb3JpZ2luOwoJdmFyIHdyYXBwZXIgPSBmdW5jdGlvbigpewoJCWlmIChtZXRob2QuJHByb3RlY3RlZCAmJiB0aGlzLiRjYWxsZXIgPT0gbnVsbCkgdGhyb3cgbmV3IEVycm9yKCdUaGUgbWV0aG9kICInICsga2V5ICsgJyIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCQl2YXIgY2FsbGVyID0gdGhpcy5jYWxsZXIsIGN1cnJlbnQgPSB0aGlzLiRjYWxsZXI7CgkJdGhpcy5jYWxsZXIgPSBjdXJyZW50OyB0aGlzLiRjYWxsZXIgPSB3cmFwcGVyOwoJCXZhciByZXN1bHQgPSBtZXRob2QuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCQl0aGlzLiRjYWxsZXIgPSBjdXJyZW50OyB0aGlzLmNhbGxlciA9IGNhbGxlcjsKCQlyZXR1cm4gcmVzdWx0OwoJfS5leHRlbmQoeyRvd25lcjogc2VsZiwgJG9yaWdpbjogbWV0aG9kLCAkbmFtZToga2V5fSk7CglyZXR1cm4gd3JhcHBlcjsKfTsKCnZhciBpbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlLCByZXRhaW4pewoJaWYgKENsYXNzLk11dGF0b3JzLmhhc093blByb3BlcnR5KGtleSkpewoJCXZhbHVlID0gQ2xhc3MuTXV0YXRvcnNba2V5XS5jYWxsKHRoaXMsIHZhbHVlKTsKCQlpZiAodmFsdWUgPT0gbnVsbCkgcmV0dXJuIHRoaXM7Cgl9CgoJaWYgKHR5cGVPZih2YWx1ZSkgPT0gJ2Z1bmN0aW9uJyl7CgkJaWYgKHZhbHVlLiRoaWRkZW4pIHJldHVybiB0aGlzOwoJCXRoaXMucHJvdG90eXBlW2tleV0gPSAocmV0YWluKSA/IHZhbHVlIDogd3JhcCh0aGlzLCBrZXksIHZhbHVlKTsKCX0gZWxzZSB7CgkJT2JqZWN0Lm1lcmdlKHRoaXMucHJvdG90eXBlLCBrZXksIHZhbHVlKTsKCX0KCglyZXR1cm4gdGhpczsKfTsKCnZhciBnZXRJbnN0YW5jZSA9IGZ1bmN0aW9uKGtsYXNzKXsKCWtsYXNzLiRwcm90b3R5cGluZyA9IHRydWU7Cgl2YXIgcHJvdG8gPSBuZXcga2xhc3M7CglkZWxldGUga2xhc3MuJHByb3RvdHlwaW5nOwoJcmV0dXJuIHByb3RvOwp9OwoKQ2xhc3MuaW1wbGVtZW50KCdpbXBsZW1lbnQnLCBpbXBsZW1lbnQub3ZlcmxvYWRTZXR0ZXIoKSk7CgpDbGFzcy5NdXRhdG9ycyA9IHsKCglFeHRlbmRzOiBmdW5jdGlvbihwYXJlbnQpewoJCXRoaXMucGFyZW50ID0gcGFyZW50OwoJCXRoaXMucHJvdG90eXBlID0gZ2V0SW5zdGFuY2UocGFyZW50KTsKCX0sCgoJSW1wbGVtZW50czogZnVuY3Rpb24oaXRlbXMpewoJCUFycmF5LmZyb20oaXRlbXMpLmVhY2goZnVuY3Rpb24oaXRlbSl7CgkJCXZhciBpbnN0YW5jZSA9IG5ldyBpdGVtOwoJCQlmb3IgKHZhciBrZXkgaW4gaW5zdGFuY2UpIGltcGxlbWVudC5jYWxsKHRoaXMsIGtleSwgaW5zdGFuY2Vba2V5XSwgdHJ1ZSk7CgkJfSwgdGhpcyk7Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogQnJvd3NlcgoKZGVzY3JpcHRpb246IFRoZSBCcm93c2VyIE9iamVjdC4gQ29udGFpbnMgQnJvd3NlciBpbml0aWFsaXphdGlvbiwgV2luZG93IGFuZCBEb2N1bWVudCwgYW5kIHRoZSBCcm93c2VyIEhhc2guCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIEZ1bmN0aW9uLCBOdW1iZXIsIFN0cmluZ10KCnByb3ZpZGVzOiBbQnJvd3NlciwgV2luZG93LCBEb2N1bWVudF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgZG9jdW1lbnQgPSB0aGlzLmRvY3VtZW50Owp2YXIgd2luZG93ID0gZG9jdW1lbnQud2luZG93ID0gdGhpczsKCnZhciBVSUQgPSAxOwoKdGhpcy4kdWlkID0gKHdpbmRvdy5BY3RpdmVYT2JqZWN0KSA/IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuIChpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBbVUlEKytdKSlbMF07Cn0gOiBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpdGVtLnVpZCB8fCAoaXRlbS51aWQgPSBVSUQrKyk7Cn07CgokdWlkKHdpbmRvdyk7CiR1aWQoZG9jdW1lbnQpOwoKdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLAoJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0udG9Mb3dlckNhc2UoKSwKCVVBID0gdWEubWF0Y2goLyhvcGVyYXxpZXxmaXJlZm94fGNocm9tZXx2ZXJzaW9uKVtcc1wvOl0oW1x3XGRcLl0rKT8uKj8oc2FmYXJpfHZlcnNpb25bXHNcLzpdKFtcd1xkXC5dKyl8JCkvKSB8fCBbbnVsbCwgJ3Vua25vd24nLCAwXSwKCW1vZGUgPSBVQVsxXSA9PSAnaWUnICYmIGRvY3VtZW50LmRvY3VtZW50TW9kZTsKCnZhciBCcm93c2VyID0gdGhpcy5Ccm93c2VyID0gewoKCWV4dGVuZDogRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCwKCgluYW1lOiAoVUFbMV0gPT0gJ3ZlcnNpb24nKSA/IFVBWzNdIDogVUFbMV0sCgoJdmVyc2lvbjogbW9kZSB8fCBwYXJzZUZsb2F0KChVQVsxXSA9PSAnb3BlcmEnICYmIFVBWzRdKSA/IFVBWzRdIDogVUFbMl0pLAoKCVBsYXRmb3JtOiB7CgkJbmFtZTogdWEubWF0Y2goL2lwKD86YWR8b2R8aG9uZSkvKSA/ICdpb3MnIDogKHVhLm1hdGNoKC8oPzp3ZWJvc3xhbmRyb2lkKS8pIHx8IHBsYXRmb3JtLm1hdGNoKC9tYWN8d2lufGxpbnV4LykgfHwgWydvdGhlciddKVswXQoJfSwKCglGZWF0dXJlczogewoJCXhwYXRoOiAhIShkb2N1bWVudC5ldmFsdWF0ZSksCgkJYWlyOiAhISh3aW5kb3cucnVudGltZSksCgkJcXVlcnk6ICEhKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IpLAoJCWpzb246ICEhKHdpbmRvdy5KU09OKQoJfSwKCglQbHVnaW5zOiB7fQoKfTsKCkJyb3dzZXJbQnJvd3Nlci5uYW1lXSA9IHRydWU7CkJyb3dzZXJbQnJvd3Nlci5uYW1lICsgcGFyc2VJbnQoQnJvd3Nlci52ZXJzaW9uLCAxMCldID0gdHJ1ZTsKQnJvd3Nlci5QbGF0Zm9ybVtCcm93c2VyLlBsYXRmb3JtLm5hbWVdID0gdHJ1ZTsKCi8vIFJlcXVlc3QKCkJyb3dzZXIuUmVxdWVzdCA9IChmdW5jdGlvbigpewoKCXZhciBYTUxIVFRQID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7Cgl9OwoKCXZhciBNU1hNTDIgPSBmdW5jdGlvbigpewoJCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnTVNYTUwyLlhNTEhUVFAnKTsKCX07CgoJdmFyIE1TWE1MID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01pY3Jvc29mdC5YTUxIVFRQJyk7Cgl9OwoKCXJldHVybiBGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJWE1MSFRUUCgpOwoJCXJldHVybiBYTUxIVFRQOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTDIoKTsKCQlyZXR1cm4gTVNYTUwyOwoJfSwgZnVuY3Rpb24oKXsKCQlNU1hNTCgpOwoJCXJldHVybiBNU1hNTDsKCX0pOwoKfSkoKTsKCkJyb3dzZXIuRmVhdHVyZXMueGhyID0gISEoQnJvd3Nlci5SZXF1ZXN0KTsKCi8vIEZsYXNoIGRldGVjdGlvbgoKdmFyIHZlcnNpb24gPSAoRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJcmV0dXJuIG5hdmlnYXRvci5wbHVnaW5zWydTaG9ja3dhdmUgRmxhc2gnXS5kZXNjcmlwdGlvbjsKfSwgZnVuY3Rpb24oKXsKCXJldHVybiBuZXcgQWN0aXZlWE9iamVjdCgnU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2gnKS5HZXRWYXJpYWJsZSgnJHZlcnNpb24nKTsKfSkgfHwgJzAgcjAnKS5tYXRjaCgvXGQrL2cpOwoKQnJvd3Nlci5QbHVnaW5zLkZsYXNoID0gewoJdmVyc2lvbjogTnVtYmVyKHZlcnNpb25bMF0gfHwgJzAuJyArIHZlcnNpb25bMV0pIHx8IDAsCglidWlsZDogTnVtYmVyKHZlcnNpb25bMl0pIHx8IDAKfTsKCi8vIFN0cmluZyBzY3JpcHRzCgpCcm93c2VyLmV4ZWMgPSBmdW5jdGlvbih0ZXh0KXsKCWlmICghdGV4dCkgcmV0dXJuIHRleHQ7CglpZiAod2luZG93LmV4ZWNTY3JpcHQpewoJCXdpbmRvdy5leGVjU2NyaXB0KHRleHQpOwoJfSBlbHNlIHsKCQl2YXIgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJc2NyaXB0LnNldEF0dHJpYnV0ZSgndHlwZScsICd0ZXh0L2phdmFzY3JpcHQnKTsKCQlzY3JpcHQudGV4dCA9IHRleHQ7CgkJZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCWRvY3VtZW50LmhlYWQucmVtb3ZlQ2hpbGQoc2NyaXB0KTsKCX0KCXJldHVybiB0ZXh0Owp9OwoKU3RyaW5nLmltcGxlbWVudCgnc3RyaXBTY3JpcHRzJywgZnVuY3Rpb24oZXhlYyl7Cgl2YXIgc2NyaXB0cyA9ICcnOwoJdmFyIHRleHQgPSB0aGlzLnJlcGxhY2UoLzxzY3JpcHRbXj5dKj4oW1xzXFNdKj8pPFwvc2NyaXB0Pi9naSwgZnVuY3Rpb24oYWxsLCBjb2RlKXsKCQlzY3JpcHRzICs9IGNvZGUgKyAnXG4nOwoJCXJldHVybiAnJzsKCX0pOwoJaWYgKGV4ZWMgPT09IHRydWUpIEJyb3dzZXIuZXhlYyhzY3JpcHRzKTsKCWVsc2UgaWYgKHR5cGVPZihleGVjKSA9PSAnZnVuY3Rpb24nKSBleGVjKHNjcmlwdHMsIHRleHQpOwoJcmV0dXJuIHRleHQ7Cn0pOwoKLy8gV2luZG93LCBEb2N1bWVudAoKQnJvd3Nlci5leHRlbmQoewoJRG9jdW1lbnQ6IHRoaXMuRG9jdW1lbnQsCglXaW5kb3c6IHRoaXMuV2luZG93LAoJRWxlbWVudDogdGhpcy5FbGVtZW50LAoJRXZlbnQ6IHRoaXMuRXZlbnQKfSk7Cgp0aGlzLldpbmRvdyA9IHRoaXMuJGNvbnN0cnVjdG9yID0gbmV3IFR5cGUoJ1dpbmRvdycsIGZ1bmN0aW9uKCl7fSk7Cgp0aGlzLiRmYW1pbHkgPSBGdW5jdGlvbi5mcm9tKCd3aW5kb3cnKS5oaWRlKCk7CgpXaW5kb3cubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cgl3aW5kb3dbbmFtZV0gPSBtZXRob2Q7Cn0pOwoKdGhpcy5Eb2N1bWVudCA9IGRvY3VtZW50LiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdEb2N1bWVudCcsIGZ1bmN0aW9uKCl7fSk7Cgpkb2N1bWVudC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZG9jdW1lbnQnKS5oaWRlKCk7CgpEb2N1bWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWRvY3VtZW50W25hbWVdID0gbWV0aG9kOwp9KTsKCmRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQ7CmRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KCi8vPDEuMmNvbXBhdD4KCmlmIChCcm93c2VyLlBsYXRmb3JtLmlvcykgQnJvd3Nlci5QbGF0Zm9ybS5pcG9kID0gdHJ1ZTsKCkJyb3dzZXIuRW5naW5lID0ge307Cgp2YXIgc2V0RW5naW5lID0gZnVuY3Rpb24obmFtZSwgdmVyc2lvbil7CglCcm93c2VyLkVuZ2luZS5uYW1lID0gbmFtZTsKCUJyb3dzZXIuRW5naW5lW25hbWUgKyB2ZXJzaW9uXSA9IHRydWU7CglCcm93c2VyLkVuZ2luZS52ZXJzaW9uID0gdmVyc2lvbjsKfTsKCmlmIChCcm93c2VyLmllKXsKCUJyb3dzZXIuRW5naW5lLnRyaWRlbnQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDY6IHNldEVuZ2luZSgndHJpZGVudCcsIDQpOyBicmVhazsKCQljYXNlIDc6IHNldEVuZ2luZSgndHJpZGVudCcsIDUpOyBicmVhazsKCQljYXNlIDg6IHNldEVuZ2luZSgndHJpZGVudCcsIDYpOwoJfQp9CgppZiAoQnJvd3Nlci5maXJlZm94KXsKCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDMpIHNldEVuZ2luZSgnZ2Vja28nLCAxOSk7CgllbHNlIHNldEVuZ2luZSgnZ2Vja28nLCAxOCk7Cn0KCmlmIChCcm93c2VyLnNhZmFyaSB8fCBCcm93c2VyLmNocm9tZSl7CglCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoKCXN3aXRjaCAoQnJvd3Nlci52ZXJzaW9uKXsKCQljYXNlIDI6IHNldEVuZ2luZSgnd2Via2l0JywgNDE5KTsgYnJlYWs7CgkJY2FzZSAzOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQyMCk7IGJyZWFrOwoJCWNhc2UgNDogc2V0RW5naW5lKCd3ZWJraXQnLCA1MjUpOwoJfQp9CgppZiAoQnJvd3Nlci5vcGVyYSl7CglCcm93c2VyLkVuZ2luZS5wcmVzdG8gPSB0cnVlOwoKCWlmIChCcm93c2VyLnZlcnNpb24gPj0gOS42KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk2MCk7CgllbHNlIGlmIChCcm93c2VyLnZlcnNpb24gPj0gOS41KSBzZXRFbmdpbmUoJ3ByZXN0bycsIDk1MCk7CgllbHNlIHNldEVuZ2luZSgncHJlc3RvJywgOTI1KTsKfQoKaWYgKEJyb3dzZXIubmFtZSA9PSAndW5rbm93bicpewoJc3dpdGNoICgodWEubWF0Y2goLyg/OndlYmtpdHxraHRtbHxnZWNrbykvKSB8fCBbXSlbMF0pewoJCWNhc2UgJ3dlYmtpdCc6CgkJY2FzZSAna2h0bWwnOgoJCQlCcm93c2VyLkVuZ2luZS53ZWJraXQgPSB0cnVlOwoJCWJyZWFrOwoJCWNhc2UgJ2dlY2tvJzoKCQkJQnJvd3Nlci5FbmdpbmUuZ2Vja28gPSB0cnVlOwoJfQp9Cgp0aGlzLiRleGVjID0gQnJvd3Nlci5leGVjOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLlBhcnNlcgpkZXNjcmlwdGlvbjogU3RhbmRhbG9uZSBDU1MzIFNlbGVjdG9yIHBhcnNlcgpwcm92aWRlczogU2xpY2suUGFyc2VyCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7U2xpY2s6IHRydWUsIGV4cHJlc3Npb25zOiBbXSwgcmF3OiBleHByZXNzaW9uLCByZXZlcnNlOiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZSh0aGlzLnJhdywgdHJ1ZSk7Cgl9fTsKCXNlcGFyYXRvckluZGV4ID0gLTE7Cgl3aGlsZSAoZXhwcmVzc2lvbiAhPSAoZXhwcmVzc2lvbiA9IGV4cHJlc3Npb24ucmVwbGFjZShyZWdleHAsIHBhcnNlcikpKTsKCXBhcnNlZC5sZW5ndGggPSBwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoOwoJcmV0dXJuIGN1cnJlbnRDYWNoZVtleHByZXNzaW9uXSA9IChyZXZlcnNlZCkgPyByZXZlcnNlKHBhcnNlZCkgOiBwYXJzZWQ7Cn07Cgp2YXIgcmV2ZXJzZUNvbWJpbmF0b3IgPSBmdW5jdGlvbihjb21iaW5hdG9yKXsKCWlmIChjb21iaW5hdG9yID09PSAnIScpIHJldHVybiAnICc7CgllbHNlIGlmIChjb21iaW5hdG9yID09PSAnICcpIHJldHVybiAnISc7CgllbHNlIGlmICgoL14hLykudGVzdChjb21iaW5hdG9yKSkgcmV0dXJuIGNvbWJpbmF0b3IucmVwbGFjZSgvXiEvLCAnJyk7CgllbHNlIHJldHVybiAnIScgKyBjb21iaW5hdG9yOwp9OwoKdmFyIHJldmVyc2UgPSBmdW5jdGlvbihleHByZXNzaW9uKXsKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gMDsgaSA8IGV4cHJlc3Npb25zLmxlbmd0aDsgaSsrKXsKCQl2YXIgZXhwID0gZXhwcmVzc2lvbnNbaV07CgkJdmFyIGxhc3QgPSB7cGFydHM6IFtdLCB0YWc6ICcqJywgY29tYmluYXRvcjogcmV2ZXJzZUNvbWJpbmF0b3IoZXhwWzBdLmNvbWJpbmF0b3IpfTsKCgkJZm9yICh2YXIgaiA9IDA7IGogPCBleHAubGVuZ3RoOyBqKyspewoJCQl2YXIgY2V4cCA9IGV4cFtqXTsKCQkJaWYgKCFjZXhwLnJldmVyc2VDb21iaW5hdG9yKSBjZXhwLnJldmVyc2VDb21iaW5hdG9yID0gJyAnOwoJCQljZXhwLmNvbWJpbmF0b3IgPSBjZXhwLnJldmVyc2VDb21iaW5hdG9yOwoJCQlkZWxldGUgY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQl9CgoJCWV4cC5yZXZlcnNlKCkucHVzaChsYXN0KTsKCX0KCXJldHVybiBleHByZXNzaW9uOwp9OwoKdmFyIGVzY2FwZVJlZ0V4cCA9IGZ1bmN0aW9uKHN0cmluZyl7Ly8gQ3JlZGl0OiBYUmVnRXhwIDAuNi4xIChjKSAyMDA3LTIwMDggU3RldmVuIExldml0aGFuIDxodHRwOi8vc3RldmVubGV2aXRoYW4uY29tL3JlZ2V4L3hyZWdleHAvPiBNSVQgTGljZW5zZQoJcmV0dXJuIHN0cmluZy5yZXBsYWNlKC9bLVtcXXt9KCkqKz8uXFxeJHwsI1xzXS9nLCAiXFwkJiIpOwp9OwoKdmFyIHJlZ2V4cCA9IG5ldyBSZWdFeHAoCi8qCiMhL3Vzci9iaW4vZW52IHJ1YnkKcHV0cyAiXHRcdCIgKyBEQVRBLnJlYWQuZ3N1YigvXChcP3hcKXxccysjLiokfFxzK3xcXCR8XFxuLywnJykKX19FTkRfXwoJIig/eCleKD86XAoJICBcXHMqICggLCApIFxccyogICAgICAgICAgICAgICAjIFNlcGFyYXRvciAgICAgICAgICBcblwKCXwgXFxzKiAoIDxjb21iaW5hdG9yPisgKSBcXHMqICAgIyBDb21iaW5hdG9yICAgICAgICAgXG5cCgl8ICAgICAgKCBcXHMrICkgICAgICAgICAgICAgICAgICMgQ29tYmluYXRvckNoaWxkcmVuIFxuXAoJfCAgICAgICggPHVuaWNvZGU+KyB8IFxcKiApICAgICAjIFRhZyAgICAgICAgICAgICAgICBcblwKCXwgXFwjICAoIDx1bmljb2RlPisgICAgICAgKSAgICAgIyBJRCAgICAgICAgICAgICAgICAgXG5cCgl8IFxcLiAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgQ2xhc3NOYW1lICAgICAgICAgIFxuXAoJfCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEF0dHJpYnV0ZSAgICAgICAgICBcblwKCVxcWyAgXAoJCVxccyogKDx1bmljb2RlMT4rKSAgKD86ICBcCgkJCVxccyogKFsqXiQhfnxdPz0pICAoPzogIFwKCQkJCVxccyogKD86XAoJCQkJCShbXCInXT8pKC4qPylcXDkgXAoJCQkJKVwKCQkJKSAgXAoJCSk/ICBcXHMqICBcCglcXF0oPyFcXF0pIFxuXAoJfCAgIDorICggPHVuaWNvZGU+KyApKD86XAoJXFwoICg/OlwKCQkoPzooW1wiJ10pKFteXFwxMl0qKVxcMTIpfCgoPzpcXChbXildK1xcKXxbXigpXSopKylcCgkpIFxcKVwKCSk/XAoJKSIKKi8KCSJeKD86XFxzKigsKVxccyp8XFxzKig8Y29tYmluYXRvcj4rKVxccyp8KFxccyspfCg8dW5pY29kZT4rfFxcKil8XFwjKDx1bmljb2RlPispfFxcLig8dW5pY29kZT4rKXxcXFtcXHMqKDx1bmljb2RlMT4rKSg/OlxccyooWypeJCF+fF0/PSkoPzpcXHMqKD86KFtcIiddPykoLio/KVxcOSkpKT9cXHMqXFxdKD8hXFxdKXw6Kyg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEyXSopXFwxMil8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZQoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGxvY2FsID0ge307CgovLyBGZWF0dXJlIC8gQnVnIGRldGVjdGlvbgoKbG9jYWwuaXNOYXRpdmVDb2RlID0gZnVuY3Rpb24oZm4pewoJcmV0dXJuICgvXHtccypcW25hdGl2ZSBjb2RlXF1ccypcfS8pLnRlc3QoJycgKyBmbik7Cn07Cgpsb2NhbC5pc1hNTCA9IGZ1bmN0aW9uKGRvY3VtZW50KXsKCXJldHVybiAoISFkb2N1bWVudC54bWxWZXJzaW9uKSB8fCAoISFkb2N1bWVudC54bWwpIHx8IChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoZG9jdW1lbnQpID09PSAnW29iamVjdCBYTUxEb2N1bWVudF0nKSB8fAoJKGRvY3VtZW50Lm5vZGVUeXBlID09PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPT0gJ0hUTUwnKTsKfTsKCmxvY2FsLnNldERvY3VtZW50ID0gZnVuY3Rpb24oZG9jdW1lbnQpewoKCS8vIGNvbnZlcnQgZWxlbWVudHMgLyB3aW5kb3cgYXJndW1lbnRzIHRvIGRvY3VtZW50LiBpZiBkb2N1bWVudCBjYW5ub3QgYmUgZXh0cmFwb2xhdGVkLCB0aGUgZnVuY3Rpb24gcmV0dXJucy4KCglpZiAoZG9jdW1lbnQubm9kZVR5cGUgPT09IDkpOyAvLyBkb2N1bWVudAoJZWxzZSBpZiAoZG9jdW1lbnQub3duZXJEb2N1bWVudCkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7Cgl2YXIgcm9vdCA9IHRoaXMucm9vdCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgl0aGlzLmlzWE1MRG9jdW1lbnQgPSB0aGlzLmlzWE1MKGRvY3VtZW50KTsKCgl0aGlzLmJyb2tlblN0YXJHRUJUTgoJPSB0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IHRoaXMuaWRHZXRzTmFtZQoJPSB0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQQoJPSB0aGlzLmJyb2tlbkdFQkNOCgk9IHRoaXMuYnJva2VuQ2hlY2tlZFFTQQoJPSB0aGlzLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBCgk9IHRoaXMuaXNIVE1MRG9jdW1lbnQKCT0gZmFsc2U7CgoJdmFyIHN0YXJTZWxlY3RzQ2xvc2VkLCBzdGFyU2VsZWN0c0NvbW1lbnRzLAoJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOLCBjYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lOwoKCXZhciBzZWxlY3RlZCwgaWQ7Cgl2YXIgdGVzdE5vZGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCXJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQlpZCA9ICdzbGlja19nZXRieWlkX3Rlc3QnOwoJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBpZD0iJytpZCsnIj48L2E+JzsKCQl0aGlzLmlzSFRNTERvY3VtZW50ID0gISFkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7Cgl9IGNhdGNoKGUpe307CgoJaWYgKHRoaXMuaXNIVE1MRG9jdW1lbnQpewoJCQoJCXRlc3ROb2RlLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CgkJCgkJLy8gSUUgcmV0dXJucyBjb21tZW50IG5vZGVzIGZvciBnZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpIGZvciBzb21lIGRvY3VtZW50cwoJCXRlc3ROb2RlLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoJycpKTsKCQlzdGFyU2VsZWN0c0NvbW1lbnRzID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykubGVuZ3RoID4gMCk7CgoJCS8vIElFIHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQkJc3RhclNlbGVjdHNDbG9zZWQgPSAoc2VsZWN0ZWQgJiYgc2VsZWN0ZWQubGVuZ3RoICYmIHNlbGVjdGVkWzBdLm5vZGVOYW1lLmNoYXJBdCgwKSA9PSAnLycpOwoJCX0gY2F0Y2goZSl7fTsKCgkJdGhpcy5icm9rZW5TdGFyR0VCVE4gPSBzdGFyU2VsZWN0c0NvbW1lbnRzIHx8IHN0YXJTZWxlY3RzQ2xvc2VkOwoKCQkvLyBJRSA4IHJldHVybnMgY2xvc2VkIG5vZGVzIChFRzoiPC9mb28+IikgZm9yIHF1ZXJ5U2VsZWN0b3JBbGwoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQlpZiAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCkgdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJ2ZvbzwvZm9vPic7CgkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQl0aGlzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBID0gKHNlbGVjdGVkICYmIHNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQlpZCA9ICdzbGlja19pZF9nZXRzX25hbWUnOwoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJytpZCsnIj48L2E+PGIgaWQ9IicraWQrJyI+PC9iPic7CgkJCXRoaXMuaWRHZXRzTmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKSA9PT0gdGVzdE5vZGUuZmlyc3RDaGlsZDsKCQl9IGNhdGNoKGUpe307CgoJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJNaVhlZENhU2UiPjwvYT4nOwoJCQl0aGlzLmJyb2tlbk1peGVkQ2FzZVFTQSA9ICF0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCcuTWlYZWRDYVNlJykubGVuZ3RoOwoJCX0gY2F0Y2goZSl7fTsKCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSJmIj48L2E+PGEgY2xhc3M9ImIiPjwvYT4nOwoJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQl0ZXN0Tm9kZS5maXJzdENoaWxkLmNsYXNzTmFtZSA9ICdiJzsKCQkJY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoICE9IDIpOwoJCX0gY2F0Y2goZSl7fTsKCgkJLy8gT3BlcmEgOS42IGdldEVsZW1lbnRzQnlDbGFzc05hbWUgZG9lc250IGRldGVjdHMgdGhlIGNsYXNzIGlmIGl0cyBub3QgdGhlIGZpcnN0IG9uZQoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCWJyb2tlblNlY29uZENsYXNzTmFtZUdFQkNOID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2EnKS5sZW5ndGggIT0gMik7CgkJfSBjYXRjaChlKXt9OwoKCQl0aGlzLmJyb2tlbkdFQkNOID0gY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCBicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTjsKCQkKCQkvLyBXZWJraXQgZG9udCByZXR1cm4gc2VsZWN0ZWQgb3B0aW9ucyBvbiBxdWVyeVNlbGVjdG9yQWxsCgkJdHJ5IHsKCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxzZWxlY3Q+PG9wdGlvbiBzZWxlY3RlZD0ic2VsZWN0ZWQiPmE8L29wdGlvbj48L3NlbGVjdD4nOwoJCQl0aGlzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJfSBjYXRjaChlKXt9OwoJCQoJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iIj48L2E+JzsKCQkJdGhpcy5icm9rZW5FbXB0eUF0dHJpYnV0ZVFTQSA9ICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKCdbY2xhc3MqPSIiXScpLmxlbmd0aCAhPSAwKTsKCQl9IGNhdGNoKGUpe307CgkJCgl9CgoJcm9vdC5yZW1vdmVDaGlsZCh0ZXN0Tm9kZSk7Cgl0ZXN0Tm9kZSA9IG51bGw7CgoJLy8gaGFzQXR0cmlidXRlCgoJdGhpcy5oYXNBdHRyaWJ1dGUgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290Lmhhc0F0dHJpYnV0ZSkpID8gZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJcmV0dXJuIG5vZGUuaGFzQXR0cmlidXRlKGF0dHJpYnV0ZSk7Cgl9IDogZnVuY3Rpb24obm9kZSwgYXR0cmlidXRlKSB7CgkJbm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShhdHRyaWJ1dGUpOwoJCXJldHVybiAhIShub2RlICYmIChub2RlLnNwZWNpZmllZCB8fCBub2RlLm5vZGVWYWx1ZSkpOwoJfTsKCgkvLyBjb250YWlucwoJLy8gRklYTUU6IEFkZCBzcGVjczogbG9jYWwuY29udGFpbnMgc2hvdWxkIGJlIGRpZmZlcmVudCBmb3IgeG1sIGFuZCBodG1sIGRvY3VtZW50cz8KCXRoaXMuY29udGFpbnMgPSAocm9vdCAmJiB0aGlzLmlzTmF0aXZlQ29kZShyb290LmNvbnRhaW5zKSkgPyBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlyZXR1cm4gY29udGV4dC5jb250YWlucyhub2RlKTsKCX0gOiAocm9vdCAmJiByb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0ID09PSBub2RlIHx8ICEhKGNvbnRleHQuY29tcGFyZURvY3VtZW50UG9zaXRpb24obm9kZSkgJiAxNik7Cgl9IDogZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJaWYgKG5vZGUpIGRvIHsKCQkJaWYgKG5vZGUgPT09IGNvbnRleHQpIHJldHVybiB0cnVlOwoJCX0gd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSk7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCgkvLyBkb2N1bWVudCBvcmRlciBzb3J0aW5nCgkvLyBjcmVkaXRzIHRvIFNpenpsZSAoaHR0cDovL3NpenpsZWpzLmNvbS8pCgoJdGhpcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJdGhpcy5nZXRVSUQgPSAodGhpcy5pc0hUTUxEb2N1bWVudCkgPyB0aGlzLmdldFVJREhUTUwgOiB0aGlzLmdldFVJRFhNTDsKCn07CgovLyBNYWluIE1ldGhvZAoKbG9jYWwuc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kLCBmaXJzdCl7CgoJdmFyIGZvdW5kID0gdGhpcy5mb3VuZCA9IChmaXJzdCkgPyBudWxsIDogKGFwcGVuZCB8fCBbXSk7CgoJLy8gY29udGV4dCBjaGVja3MKCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsgLy8gTm8gY29udGV4dAoJaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7IC8vIFJlamVjdCBtaXNjIGp1bmsgaW5wdXQKCgkvLyBzZXR1cAoKCXZhciBwYXJzZWQsIGk7CgoJdmFyIHVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHQub3duZXJEb2N1bWVudCB8fCBjb250ZXh0KSkgdGhpcy5zZXREb2N1bWVudChjb250ZXh0KTsKCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCS8vIHNob3VsZCByZW1vdmUgZHVwbGljYXRlcyBpZiBhcHBlbmQgYWxyZWFkeSBoYXMgaXRlbXMKCXZhciBzaG91bGRVbmlxdWVzID0gISEoYXBwZW5kICYmIGFwcGVuZC5sZW5ndGgpOwoKCS8vIGF2b2lkIGR1cGxpY2F0aW5nIGl0ZW1zIGFscmVhZHkgaW4gdGhlIGFwcGVuZCBhcnJheQoJaWYgKHNob3VsZFVuaXF1ZXMpIGZvciAoaSA9IGZvdW5kLmxlbmd0aDsgaS0tOykgdGhpcy51bmlxdWVzW3RoaXMuZ2V0VUlEKGZvdW5kW2ldKV0gPSB0cnVlOwoKCS8vIGV4cHJlc3Npb24gY2hlY2tzCgoJaWYgKHR5cGVvZiBleHByZXNzaW9uID09ICdzdHJpbmcnKXsgLy8gZXhwcmVzc2lvbiBpcyBhIHN0cmluZwoKCQkvLyBPdmVycmlkZXMKCgkJZm9yIChpID0gdGhpcy5vdmVycmlkZXMubGVuZ3RoOyBpLS07KXsKCQkJdmFyIG92ZXJyaWRlID0gdGhpcy5vdmVycmlkZXNbaV07CgkJCWlmIChvdmVycmlkZS5yZWdleHAudGVzdChleHByZXNzaW9uKSl7CgkJCQl2YXIgcmVzdWx0ID0gb3ZlcnJpZGUubWV0aG9kLmNhbGwoY29udGV4dCwgZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KTsKCQkJCWlmIChyZXN1bHQgPT09IGZhbHNlKSBjb250aW51ZTsKCQkJCWlmIChyZXN1bHQgPT09IHRydWUpIHJldHVybiBmb3VuZDsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQl9CgoJCXBhcnNlZCA9IHRoaXMuU2xpY2sucGFyc2UoZXhwcmVzc2lvbik7CgkJaWYgKCFwYXJzZWQubGVuZ3RoKSByZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24gPT0gbnVsbCl7IC8vIHRoZXJlIGlzIG5vIGV4cHJlc3Npb24KCQlyZXR1cm4gZm91bmQ7Cgl9IGVsc2UgaWYgKGV4cHJlc3Npb24uU2xpY2speyAvLyBleHByZXNzaW9uIGlzIGEgcGFyc2VkIFNsaWNrIG9iamVjdAoJCXBhcnNlZCA9IGV4cHJlc3Npb247Cgl9IGVsc2UgaWYgKHRoaXMuY29udGFpbnMoY29udGV4dC5kb2N1bWVudEVsZW1lbnQgfHwgY29udGV4dCwgZXhwcmVzc2lvbikpeyAvLyBleHByZXNzaW9uIGlzIGEgbm9kZQoJCShmb3VuZCkgPyBmb3VuZC5wdXNoKGV4cHJlc3Npb24pIDogZm91bmQgPSBleHByZXNzaW9uOwoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSB7IC8vIG90aGVyIGp1bmsKCQlyZXR1cm4gZm91bmQ7Cgl9CgoJLy8gY2FjaGUgZWxlbWVudHMgZm9yIHRoZSBudGggc2VsZWN0b3JzCgoJLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJdGhpcy5wb3NOVEggPSB7fTsKCXRoaXMucG9zTlRITGFzdCA9IHt9OwoJdGhpcy5wb3NOVEhUeXBlID0ge307Cgl0aGlzLnBvc05USFR5cGVMYXN0ID0ge307CgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBpZiBhcHBlbmQgaXMgbnVsbCBhbmQgdGhlcmUgaXMgb25seSBhIHNpbmdsZSBzZWxlY3RvciB3aXRoIG9uZSBleHByZXNzaW9uIHVzZSBwdXNoQXJyYXksIGVsc2UgdXNlIHB1c2hVSUQKCXRoaXMucHVzaCA9ICghc2hvdWxkVW5pcXVlcyAmJiAoZmlyc3QgfHwgKHBhcnNlZC5sZW5ndGggPT0gMSAmJiBwYXJzZWQuZXhwcmVzc2lvbnNbMF0ubGVuZ3RoID09IDEpKSkgPyB0aGlzLnB1c2hBcnJheSA6IHRoaXMucHVzaFVJRDsKCglpZiAoZm91bmQgPT0gbnVsbCkgZm91bmQgPSBbXTsKCgkvLyBkZWZhdWx0IGVuZ2luZQoKCXZhciBqLCBtLCBuOwoJdmFyIGNvbWJpbmF0b3IsIHRhZywgaWQsIGNsYXNzTGlzdCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvczsKCXZhciBjdXJyZW50SXRlbXMsIGN1cnJlbnRFeHByZXNzaW9uLCBjdXJyZW50Qml0LCBsYXN0Qml0LCBleHByZXNzaW9ucyA9IHBhcnNlZC5leHByZXNzaW9uczsKCglzZWFyY2g6IGZvciAoaSA9IDA7IChjdXJyZW50RXhwcmVzc2lvbiA9IGV4cHJlc3Npb25zW2ldKTsgaSsrKSBmb3IgKGogPSAwOyAoY3VycmVudEJpdCA9IGN1cnJlbnRFeHByZXNzaW9uW2pdKTsgaisrKXsKCgkJY29tYmluYXRvciA9ICdjb21iaW5hdG9yOicgKyBjdXJyZW50Qml0LmNvbWJpbmF0b3I7CgkJaWYgKCF0aGlzW2NvbWJpbmF0b3JdKSBjb250aW51ZSBzZWFyY2g7CgoJCXRhZyAgICAgICAgPSAodGhpcy5pc1hNTERvY3VtZW50KSA/IGN1cnJlbnRCaXQudGFnIDogY3VycmVudEJpdC50YWcudG9VcHBlckNhc2UoKTsKCQlpZCAgICAgICAgID0gY3VycmVudEJpdC5pZDsKCQljbGFzc0xpc3QgID0gY3VycmVudEJpdC5jbGFzc0xpc3Q7CgkJY2xhc3NlcyAgICA9IGN1cnJlbnRCaXQuY2xhc3NlczsKCQlhdHRyaWJ1dGVzID0gY3VycmVudEJpdC5hdHRyaWJ1dGVzOwoJCXBzZXVkb3MgICAgPSBjdXJyZW50Qml0LnBzZXVkb3M7CgkJbGFzdEJpdCAgICA9IChqID09PSAoY3VycmVudEV4cHJlc3Npb24ubGVuZ3RoIC0gMSkpOwoKCQl0aGlzLmJpdFVuaXF1ZXMgPSB7fTsKCgkJaWYgKGxhc3RCaXQpewoJCQl0aGlzLnVuaXF1ZXMgPSB1bmlxdWVzOwoJCQl0aGlzLmZvdW5kID0gZm91bmQ7CgkJfSBlbHNlIHsKCQkJdGhpcy51bmlxdWVzID0ge307CgkJCXRoaXMuZm91bmQgPSBbXTsKCQl9CgoJCWlmIChqID09PSAwKXsKCQkJdGhpc1tjb21iaW5hdG9yXShjb250ZXh0LCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCAmJiBmb3VuZC5sZW5ndGgpIGJyZWFrIHNlYXJjaDsKCQl9IGVsc2UgewoJCQlpZiAoZmlyc3QgJiYgbGFzdEJpdCkgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspewoJCQkJdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJCQlpZiAoZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJCX0gZWxzZSBmb3IgKG0gPSAwLCBuID0gY3VycmVudEl0ZW1zLmxlbmd0aDsgbSA8IG47IG0rKykgdGhpc1tjb21iaW5hdG9yXShjdXJyZW50SXRlbXNbbV0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MsIGNsYXNzTGlzdCk7CgkJfQoKCQljdXJyZW50SXRlbXMgPSB0aGlzLmZvdW5kOwoJfQoKCWlmIChzaG91bGRVbmlxdWVzIHx8IChwYXJzZWQuZXhwcmVzc2lvbnMubGVuZ3RoID4gMSkpIHRoaXMuc29ydChmb3VuZCk7CgoJcmV0dXJuIChmaXJzdCkgPyAoZm91bmRbMF0gfHwgbnVsbCkgOiBmb3VuZDsKfTsKCi8vIFV0aWxzCgpsb2NhbC51aWR4ID0gMTsKbG9jYWwudWlkayA9ICdzbGljazp1bmlxdWVpZCc7Cgpsb2NhbC5nZXRVSURYTUwgPSBmdW5jdGlvbihub2RlKXsKCXZhciB1aWQgPSBub2RlLmdldEF0dHJpYnV0ZSh0aGlzLnVpZGspOwoJaWYgKCF1aWQpewoJCXVpZCA9IHRoaXMudWlkeCsrOwoJCW5vZGUuc2V0QXR0cmlidXRlKHRoaXMudWlkaywgdWlkKTsKCX0KCXJldHVybiB1aWQ7Cn07Cgpsb2NhbC5nZXRVSURIVE1MID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbm9kZS51bmlxdWVOdW1iZXIgfHwgKG5vZGUudW5pcXVlTnVtYmVyID0gdGhpcy51aWR4KyspOwp9OwoKLy8gc29ydCBiYXNlZCBvbiB0aGUgc2V0RG9jdW1lbnQgZG9jdW1lbnRTb3J0ZXIgbWV0aG9kLgoKbG9jYWwuc29ydCA9IGZ1bmN0aW9uKHJlc3VsdHMpewoJaWYgKCF0aGlzLmRvY3VtZW50U29ydGVyKSByZXR1cm4gcmVzdWx0czsKCXJlc3VsdHMuc29ydCh0aGlzLmRvY3VtZW50U29ydGVyKTsKCXJldHVybiByZXN1bHRzOwp9OwoKLyo8cHNldWRvLXNlbGVjdG9ycz4qLy8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgpsb2NhbC5jYWNoZU5USCA9IHt9OwoKbG9jYWwubWF0Y2hOVEggPSAvXihbKy1dP1xkKik/KFthLXpdKyk/KFsrLV1cZCspPyQvOwoKbG9jYWwucGFyc2VOVEhBcmd1bWVudCA9IGZ1bmN0aW9uKGFyZ3VtZW50KXsKCXZhciBwYXJzZWQgPSBhcmd1bWVudC5tYXRjaCh0aGlzLm1hdGNoTlRIKTsKCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7Cgl2YXIgc3BlY2lhbCA9IHBhcnNlZFsyXSB8fCBmYWxzZTsKCXZhciBhID0gcGFyc2VkWzFdIHx8IDE7CglpZiAoYSA9PSAnLScpIGEgPSAtMTsKCXZhciBiID0gK3BhcnNlZFszXSB8fCAwOwoJcGFyc2VkID0KCQkoc3BlY2lhbCA9PSAnbicpCT8ge2E6IGEsIGI6IGJ9IDoKCQkoc3BlY2lhbCA9PSAnb2RkJykJPyB7YTogMiwgYjogMX0gOgoJCShzcGVjaWFsID09ICdldmVuJykJPyB7YTogMiwgYjogMH0gOiB7YTogMCwgYjogYX07CgoJcmV0dXJuICh0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSA9IHBhcnNlZCk7Cn07Cgpsb2NhbC5jcmVhdGVOVEhQc2V1ZG8gPSBmdW5jdGlvbihjaGlsZCwgc2libGluZywgcG9zaXRpb25zLCBvZlR5cGUpewoJcmV0dXJuIGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJaWYgKCF0aGlzW3Bvc2l0aW9uc11bdWlkXSl7CgkJCXZhciBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CgkJCWlmICghcGFyZW50KSByZXR1cm4gZmFsc2U7CgkJCXZhciBlbCA9IHBhcmVudFtjaGlsZF0sIGNvdW50ID0gMTsKCQkJaWYgKG9mVHlwZSl7CgkJCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlTmFtZSAhPT0gbm9kZU5hbWUpIGNvbnRpbnVlOwoJCQkJCXRoaXNbcG9zaXRpb25zXVt0aGlzLmdldFVJRChlbCldID0gY291bnQrKzsKCQkJCX0gd2hpbGUgKChlbCA9IGVsW3NpYmxpbmddKSk7CgkJCX0gZWxzZSB7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7Cgl2YXIgcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShzZWxlY3Rvcik7CglpZiAoIXBhcnNlZCkgcmV0dXJuIHRydWU7CgoJLy8gc2ltcGxlIChzaW5nbGUpIHNlbGVjdG9ycwoJaWYocGFyc2VkLmxlbmd0aCA9PSAxICYmIHBhcnNlZC5leHByZXNzaW9uc1swXS5sZW5ndGggPT0gMSl7CgkJdmFyIGV4cCA9IHBhcnNlZC5leHByZXNzaW9uc1swXVswXTsKCQlyZXR1cm4gdGhpcy5tYXRjaFNlbGVjdG9yKG5vZGUsICh0aGlzLmlzWE1MRG9jdW1lbnQpID8gZXhwLnRhZyA6IGV4cC50YWcudG9VcHBlckNhc2UoKSwgZXhwLmlkLCBleHAuY2xhc3NlcywgZXhwLmF0dHJpYnV0ZXMsIGV4cC5wc2V1ZG9zKTsKCX0KCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpOwoJZm9yICh2YXIgaSA9IDAsIGl0ZW07IGl0ZW0gPSBub2Rlc1tpKytdOyl7CgkJaWYgKGl0ZW0gPT09IG5vZGUpIHJldHVybiB0cnVlOwoJfQoJcmV0dXJuIGZhbHNlOwp9OwoKbG9jYWwubWF0Y2hQc2V1ZG8gPSBmdW5jdGlvbihub2RlLCBuYW1lLCBhcmd1bWVudCl7Cgl2YXIgcHNldWRvTmFtZSA9ICdwc2V1ZG86JyArIG5hbWU7CglpZiAodGhpc1twc2V1ZG9OYW1lXSkgcmV0dXJuIHRoaXNbcHNldWRvTmFtZV0obm9kZSwgYXJndW1lbnQpOwoJdmFyIGF0dHJpYnV0ZSA9IHRoaXMuZ2V0QXR0cmlidXRlKG5vZGUsIG5hbWUpOwoJcmV0dXJuIChhcmd1bWVudCkgPyBhcmd1bWVudCA9PSBhdHRyaWJ1dGUgOiAhIWF0dHJpYnV0ZTsKfTsKCmxvY2FsLm1hdGNoU2VsZWN0b3IgPSBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsKCWlmICh0YWcpewoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGUubm9kZU5hbWUgPCAnQCcpIHJldHVybiBmYWxzZTsgLy8gRml4IGZvciBjb21tZW50IG5vZGVzIGFuZCBjbG9zZWQgbm9kZXMKCQl9IGVsc2UgewoJCQlpZiAobm9kZS5ub2RlTmFtZSAhPSB0YWcpIHJldHVybiBmYWxzZTsKCQl9Cgl9CgoJaWYgKGlkICYmIG5vZGUuZ2V0QXR0cmlidXRlKCdpZCcpICE9IGlkKSByZXR1cm4gZmFsc2U7CgoJdmFyIGksIHBhcnQsIGNsczsKCWlmIChjbGFzc2VzKSBmb3IgKGkgPSBjbGFzc2VzLmxlbmd0aDsgaS0tOyl7CgkJY2xzID0gKCdjbGFzc05hbWUnIGluIG5vZGUpID8gbm9kZS5jbGFzc05hbWUgOiBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgaWYgKGl0ZW0uZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgPT0gaWQpewoJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJYnJlYWs7CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LCBub2RlKSkgcmV0dXJuOwoJCQkJCWVsc2UgYnJlYWsgZ2V0QnlJZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5kb2N1bWVudCAhPT0gbm9kZSAmJiAhdGhpcy5jb250YWlucyhub2RlLCBpdGVtKSkgcmV0dXJuOwoJCQkJdGhpcy5wdXNoKGl0ZW0sIHRhZywgbnVsbCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCQlyZXR1cm47CgkJCX0KCQkJZ2V0QnlDbGFzczogaWYgKGNsYXNzZXMgJiYgbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKGNsYXNzTGlzdC5qb2luKCcgJykpOwoJCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlDbGFzczsKCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIG51bGwsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoJCWdldEJ5VGFnOiB7CgkJCWNoaWxkcmVuID0gbm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSh0YWcpOwoJCQlpZiAoIShjaGlsZHJlbiAmJiBjaGlsZHJlbi5sZW5ndGgpKSBicmVhayBnZXRCeVRhZzsKCQkJaWYgKCF0aGlzLmJyb2tlblN0YXJHRUJUTikgdGFnID0gbnVsbDsKCQkJZm9yIChpID0gMDsgaXRlbSA9IGNoaWxkcmVuW2krK107KSB0aGlzLnB1c2goaXRlbSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfQoJfSwKCgknPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgY2hpbGRyZW4KCQlpZiAoKG5vZGUgPSBub2RlLmZpcnN0Q2hpbGQpKSBkbyB7CgkJCWlmIChub2RlLm5vZGVUeXBlID09PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSl7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJYnJlYWs7CgkJfQoJfSwKCgknXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBmaXJzdCBjaGlsZAoJCW5vZGUgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJ34nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gbmV4dCBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgIT09IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAgLy8gYWxsIHBhcmVudCBub2RlcyB1cCB0byBkb2N1bWVudAoJCXdoaWxlICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkpIGlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchPic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBkaXJlY3QgcGFyZW50IChvbmUgbGV2ZWwpCgkJbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCQlpZiAobm9kZSAhPT0gdGhpcy5kb2N1bWVudCkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISsnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gcHJldmlvdXMgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpewoJCQl0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJCWJyZWFrOwoJCX0KCX0sCgoJJyFeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGxhc3QgY2hpbGQKCQlub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgkJaWYgKG5vZGUpewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9PSAxKSBjb250aW51ZTsKCQkJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJCQlpZiAodGhpcy5iaXRVbmlxdWVzW3VpZF0pIGJyZWFrOwoJCQl0aGlzLmJpdFVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCXRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9Cgp9OwoKZm9yICh2YXIgYyBpbiBjb21iaW5hdG9ycykgbG9jYWxbJ2NvbWJpbmF0b3I6JyArIGNdID0gY29tYmluYXRvcnNbY107Cgp2YXIgcHNldWRvcyA9IHsKCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2VtcHR5JzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIGNoaWxkID0gbm9kZS5maXJzdENoaWxkOwoJCXJldHVybiAhKGNoaWxkICYmIGNoaWxkLm5vZGVUeXBlID09IDEpICYmICEobm9kZS5pbm5lclRleHQgfHwgbm9kZS50ZXh0Q29udGVudCB8fCAnJykubGVuZ3RoOwoJfSwKCgknbm90JzogZnVuY3Rpb24obm9kZSwgZXhwcmVzc2lvbil7CgkJcmV0dXJuICF0aGlzLm1hdGNoTm9kZShub2RlLCBleHByZXNzaW9uKTsKCX0sCgoJJ2NvbnRhaW5zJzogZnVuY3Rpb24obm9kZSwgdGV4dCl7CgkJcmV0dXJuIChub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5pbmRleE9mKHRleHQpID4gLTE7Cgl9LAoKCSdmaXJzdC1jaGlsZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3QtY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PT0gMSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZVR5cGUgPT09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgknbnRoLWNoaWxkJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USCcpLAoKCSdudGgtbGFzdC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhMYXN0JyksCgoJJ250aC1vZi10eXBlJzogbG9jYWwuY3JlYXRlTlRIUHNldWRvKCdmaXJzdENoaWxkJywgJ25leHRTaWJsaW5nJywgJ3Bvc05USFR5cGUnLCB0cnVlKSwKCgknbnRoLWxhc3Qtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnbGFzdENoaWxkJywgJ3ByZXZpb3VzU2libGluZycsICdwb3NOVEhUeXBlTGFzdCcsIHRydWUpLAoKCSdpbmRleCc6IGZ1bmN0aW9uKG5vZGUsIGluZGV4KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcnICsgaW5kZXggKyAxKTsKCX0sCgoJJ2V2ZW4nOiBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gdGhpc1sncHNldWRvOm50aC1jaGlsZCddKG5vZGUsICcybisxJyk7Cgl9LAoKCS8qPC9udGgtcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8qPG9mLXR5cGUtcHNldWRvLXNlbGVjdG9ycz4qLwoKCSdmaXJzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgknbGFzdC1vZi10eXBlJzogZnVuY3Rpb24obm9kZSl7CgkJdmFyIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXZhciBuZXh0ID0gbm9kZTsKCQl3aGlsZSAoKG5leHQgPSBuZXh0Lm5leHRTaWJsaW5nKSkgaWYgKG5leHQubm9kZU5hbWUgPT09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPC9vZi10eXBlLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjdXN0b20gcHNldWRvcwoKCSdlbmFibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIChub2RlLmRpc2FibGVkID09PSBmYWxzZSk7Cgl9LAoKCSdkaXNhYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZS5kaXNhYmxlZCA9PT0gdHJ1ZSk7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2NsYXNzTmFtZScgaW4gdGhpcykgPyB0aGlzLmNsYXNzTmFtZSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdjbGFzcycpOwoJfSwKCgknZm9yJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdodG1sRm9yJyBpbiB0aGlzKSA/IHRoaXMuaHRtbEZvciA6IHRoaXMuZ2V0QXR0cmlidXRlKCdmb3InKTsKCX0sCgoJJ2hyZWYnOiBmdW5jdGlvbigpewoJCXJldHVybiAoJ2hyZWYnIGluIHRoaXMpID8gdGhpcy5nZXRBdHRyaWJ1dGUoJ2hyZWYnLCAyKSA6IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJyk7Cgl9LAoKCSdzdHlsZSc6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnN0eWxlKSA/IHRoaXMuc3R5bGUuY3NzVGV4dCA6IHRoaXMuZ2V0QXR0cmlidXRlKCdzdHlsZScpOwoJfQoKfTsKCmxvY2FsLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJLy8gRklYTUU6IGNoZWNrIGlmIGdldEF0dHJpYnV0ZSgpIHdpbGwgZ2V0IGlucHV0IGVsZW1lbnRzIG9uIGEgZm9ybSBvbiB0aGlzIGJyb3dzZXIKCS8vIGdldEF0dHJpYnV0ZSBpcyBmYXN0ZXIgdGhhbiBnZXRBdHRyaWJ1dGVOb2RlKCkubm9kZVZhbHVlCgl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJaWYgKG1ldGhvZCkgcmV0dXJuIG1ldGhvZC5jYWxsKG5vZGUpOwoJdmFyIGF0dHJpYnV0ZU5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUobmFtZSk7CglyZXR1cm4gYXR0cmlidXRlTm9kZSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKfTsKCi8vIG92ZXJyaWRlcwoKbG9jYWwub3ZlcnJpZGVzID0gW107Cgpsb2NhbC5vdmVycmlkZSA9IGZ1bmN0aW9uKHJlZ2V4cCwgbWV0aG9kKXsKCXRoaXMub3ZlcnJpZGVzLnB1c2goe3JlZ2V4cDogcmVnZXhwLCBtZXRob2Q6IG1ldGhvZH0pOwp9OwoKLyo8b3ZlcnJpZGVzPiovCgovKjxxdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKdmFyIHJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuKlsqJF5dPSg/OlsiJ117Mn0pP1xdLzsKCmxvY2FsLm92ZXJyaWRlKC8uLywgZnVuY3Rpb24oZXhwcmVzc2lvbiwgZm91bmQsIGZpcnN0KXsgLy9xdWVyeVNlbGVjdG9yQWxsIG92ZXJyaWRlCgoJaWYgKCF0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwgfHwgdGhpcy5ub2RlVHlwZSAhPSA5IHx8ICFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCBsb2NhbC5icm9rZW5NaXhlZENhc2VRU0EgfHwKCShsb2NhbC5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKSB8fAoJKGxvY2FsLmJyb2tlbkVtcHR5QXR0cmlidXRlUVNBICYmIHJlRW1wdHlBdHRyaWJ1dGUudGVzdChleHByZXNzaW9uKSkgfHwgU2xpY2suZGlzYWJsZVFTQSkgcmV0dXJuIGZhbHNlOwoKCXZhciBub2Rlcywgbm9kZTsKCXRyeSB7CgkJaWYgKGZpcnN0KSByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yKGV4cHJlc3Npb24pIHx8IG51bGw7CgkJZWxzZSBub2RlcyA9IHRoaXMucXVlcnlTZWxlY3RvckFsbChleHByZXNzaW9uKTsKCX0gY2F0Y2goZXJyb3IpewoJCXJldHVybiBmYWxzZTsKCX0KCgl2YXIgaSwgaGFzT3RoZXJzID0gISEoZm91bmQubGVuZ3RoKTsKCglpZiAobG9jYWwuc3RhclNlbGVjdHNDbG9zZWRRU0EpIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKG5vZGUubm9kZU5hbWUgPiAnQCcgJiYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7Cgl9CgoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CgoJcmV0dXJuIHRydWU7Cgp9KTsKCi8qPC9xdWVyeS1zZWxlY3Rvci1vdmVycmlkZT4qLwoKLyo8dGFnLW92ZXJyaWRlPiovCgpsb2NhbC5vdmVycmlkZSgvXltcdy1dKyR8XlwqJC8sIGZ1bmN0aW9uKGV4cHJlc3Npb24sIGZvdW5kLCBmaXJzdCl7IC8vIHRhZyBvdmVycmlkZQoJdmFyIHRhZyA9IGV4cHJlc3Npb247CglpZiAodGFnID09ICcqJyAmJiBsb2NhbC5icm9rZW5TdGFyR0VCVE4pIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKHRhZyk7CgoJaWYgKGZpcnN0KSByZXR1cm4gbm9kZXNbMF0gfHwgbnVsbDsKCXZhciBpLCBub2RlLCBoYXNPdGhlcnMgPSAhIShmb3VuZC5sZW5ndGgpOwoKCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlEKG5vZGUpXSkgZm91bmQucHVzaChub2RlKTsKCX0KCglpZiAoaGFzT3RoZXJzKSBsb2NhbC5zb3J0KGZvdW5kKTsKCglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvdGFnLW92ZXJyaWRlPiovCgovKjxjbGFzcy1vdmVycmlkZT4qLwoKbG9jYWwub3ZlcnJpZGUoL15cLltcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBjbGFzcyBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCAoIXRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiB0aGlzLnF1ZXJ5U2VsZWN0b3JBbGwpKSByZXR1cm4gZmFsc2U7CgoJdmFyIG5vZGVzLCBub2RlLCBpLCBoYXNPdGhlcnMgPSAhIShmb3VuZCAmJiBmb3VuZC5sZW5ndGgpLCBjbGFzc05hbWUgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKTsKCWlmICh0aGlzLmdldEVsZW1lbnRzQnlDbGFzc05hbWUgJiYgIWxvY2FsLmJyb2tlbkdFQkNOKXsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc05hbWUpOwoJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfSBlbHNlIHsKCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAoY2xhc3NOYW1lKSArJyhcXHN8JCknKTsKCQlub2RlcyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQljbGFzc05hbWUgPSBub2RlLmNsYXNzTmFtZTsKCQkJaWYgKCFjbGFzc05hbWUgfHwgIW1hdGNoQ2xhc3MudGVzdChjbGFzc05hbWUpKSBjb250aW51ZTsKCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZTsKCQkJaWYgKCFoYXNPdGhlcnMgfHwgIWxvY2FsLnVuaXF1ZXNbbG9jYWwuZ2V0VUlESFRNTChub2RlKV0pIGZvdW5kLnB1c2gobm9kZSk7CgkJfQoJfQoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gKGZpcnN0KSA/IG51bGwgOiB0cnVlOwp9KTsKCi8qPC9jbGFzcy1vdmVycmlkZT4qLwoKLyo8aWQtb3ZlcnJpZGU+Ki8KCmxvY2FsLm92ZXJyaWRlKC9eI1tcdy1dKyQvLCBmdW5jdGlvbihleHByZXNzaW9uLCBmb3VuZCwgZmlyc3QpeyAvLyBJRCBvdmVycmlkZQoJaWYgKCFsb2NhbC5pc0hUTUxEb2N1bWVudCB8fCB0aGlzLm5vZGVUeXBlICE9IDkpIHJldHVybiBmYWxzZTsKCgl2YXIgaWQgPSBleHByZXNzaW9uLnN1YnN0cmluZygxKSwgZWwgPSB0aGlzLmdldEVsZW1lbnRCeUlkKGlkKTsKCWlmICghZWwpIHJldHVybiBmb3VuZDsKCWlmIChsb2NhbC5pZEdldHNOYW1lICYmIGVsLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSByZXR1cm4gZmFsc2U7CglpZiAoZmlyc3QpIHJldHVybiBlbCB8fCBudWxsOwoJdmFyIGhhc090aGVycyA9ICEhKGZvdW5kLmxlbmd0aCk7CglpZiAoIWhhc090aGVycyB8fCAhbG9jYWwudW5pcXVlc1tsb2NhbC5nZXRVSURIVE1MKGVsKV0pIGZvdW5kLnB1c2goZWwpOwoJaWYgKGhhc090aGVycykgbG9jYWwuc29ydChmb3VuZCk7CglyZXR1cm4gdHJ1ZTsKfSk7CgovKjwvaWQtb3ZlcnJpZGU+Ki8KCi8qPC9vdmVycmlkZXM+Ki8KCmlmICh0eXBlb2YgZG9jdW1lbnQgIT0gJ3VuZGVmaW5lZCcpIGxvY2FsLnNldERvY3VtZW50KGRvY3VtZW50KTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMC45ZGV2JzsKCi8vIFNsaWNrIGZpbmRlcgoKU2xpY2suc2VhcmNoID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgYXBwZW5kKTsKfTsKClNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCXJldHVybiBsb2NhbC5zZWFyY2goY29udGV4dCwgZXhwcmVzc2lvbiwgbnVsbCwgdHJ1ZSk7Cn07CgovLyBTbGljayBjb250YWlubWVudCBjaGVja2VyCgpTbGljay5jb250YWlucyA9IGZ1bmN0aW9uKGNvbnRhaW5lciwgbm9kZSl7Cglsb2NhbC5zZXREb2N1bWVudChjb250YWluZXIpOwoJcmV0dXJuIGxvY2FsLmNvbnRhaW5zKGNvbnRhaW5lciwgbm9kZSk7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgZ2V0dGVyCgpTbGljay5nZXRBdHRyaWJ1dGUgPSBmdW5jdGlvbihub2RlLCBuYW1lKXsKCXJldHVybiBsb2NhbC5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7Cn07CgovLyBTbGljayBtYXRjaGVyCgpTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCWlmICghKG5vZGUgJiYgc2VsZWN0b3IpKSByZXR1cm4gZmFsc2U7CglpZiAoIXNlbGVjdG9yIHx8IHNlbGVjdG9yID09PSBub2RlKSByZXR1cm4gdHJ1ZTsKCWlmICh0eXBlb2Ygc2VsZWN0b3IgIT0gJ3N0cmluZycpIHJldHVybiBmYWxzZTsKCWxvY2FsLnNldERvY3VtZW50KG5vZGUpOwoJcmV0dXJuIGxvY2FsLm1hdGNoTm9kZShub2RlLCBzZWxlY3Rvcik7Cn07CgovLyBTbGljayBhdHRyaWJ1dGUgYWNjZXNzb3IKClNsaWNrLmRlZmluZUF0dHJpYnV0ZUdldHRlciA9IGZ1bmN0aW9uKG5hbWUsIGZuKXsKCWxvY2FsLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV0gPSBmbjsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSl7CglyZXR1cm4gbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXTsKfTsKCi8vIFNsaWNrIHBzZXVkbyBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lUHNldWRvID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWxbJ3BzZXVkbzonICsgbmFtZV0gPSBmdW5jdGlvbihub2RlLCBhcmd1bWVudCl7CgkJcmV0dXJuIGZuLmNhbGwobm9kZSwgYXJndW1lbnQpOwoJfTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2subG9va3VwUHNldWRvID0gZnVuY3Rpb24obmFtZSl7Cgl2YXIgcHNldWRvID0gbG9jYWxbJ3BzZXVkbzonICsgbmFtZV07CglpZiAocHNldWRvKSByZXR1cm4gZnVuY3Rpb24oYXJndW1lbnQpewoJCXJldHVybiBwc2V1ZG8uY2FsbCh0aGlzLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIG51bGw7Cn07CgovLyBTbGljayBvdmVycmlkZXMgYWNjZXNzb3IKClNsaWNrLm92ZXJyaWRlID0gZnVuY3Rpb24ocmVnZXhwLCBmbil7Cglsb2NhbC5vdmVycmlkZShyZWdleHAsIGZuKTsKCXJldHVybiB0aGlzOwp9OwoKU2xpY2suaXNYTUwgPSBsb2NhbC5pc1hNTDsKClNsaWNrLnVpZE9mID0gZnVuY3Rpb24obm9kZSl7CglyZXR1cm4gbG9jYWwuZ2V0VUlESFRNTChub2RlKTsKfTsKCmlmICghdGhpcy5TbGljaykgdGhpcy5TbGljayA9IFNsaWNrOwoKfSkuYXBwbHkoLyo8Q29tbW9uSlM+Ki8odHlwZW9mIGV4cG9ydHMgIT0gJ3VuZGVmaW5lZCcpID8gZXhwb3J0cyA6IC8qPC9Db21tb25KUz4qL3RoaXMpOwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudAoKZGVzY3JpcHRpb246IE9uZSBvZiB0aGUgbW9zdCBpbXBvcnRhbnQgaXRlbXMgaW4gTW9vVG9vbHMuIENvbnRhaW5zIHRoZSBkb2xsYXIgZnVuY3Rpb24sIHRoZSBkb2xsYXJzIGZ1bmN0aW9uLCBhbmQgYW4gaGFuZGZ1bCBvZiBjcm9zcy1icm93c2VyLCB0aW1lLXNhdmVyIG1ldGhvZHMgdG8gbGV0IHlvdSBlYXNpbHkgd29yayB3aXRoIEhUTUwgRWxlbWVudHMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbV2luZG93LCBEb2N1bWVudCwgQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlciwgU2xpY2suUGFyc2VyLCBTbGljay5GaW5kZXJdCgpwcm92aWRlczogW0VsZW1lbnQsIEVsZW1lbnRzLCAkLCAkJCwgSWZyYW1lLCBTZWxlY3RvcnNdCgouLi4KKi8KCnZhciBFbGVtZW50ID0gZnVuY3Rpb24odGFnLCBwcm9wcyl7Cgl2YXIga29uc3RydWN0b3IgPSBFbGVtZW50LkNvbnN0cnVjdG9yc1t0YWddOwoJaWYgKGtvbnN0cnVjdG9yKSByZXR1cm4ga29uc3RydWN0b3IocHJvcHMpOwoJaWYgKHR5cGVvZiB0YWcgIT0gJ3N0cmluZycpIHJldHVybiBkb2N1bWVudC5pZCh0YWcpLnNldChwcm9wcyk7CgoJaWYgKCFwcm9wcykgcHJvcHMgPSB7fTsKCglpZiAoIXRhZy50ZXN0KC9eW1x3LV0rJC8pKXsKCQl2YXIgcGFyc2VkID0gU2xpY2sucGFyc2UodGFnKS5leHByZXNzaW9uc1swXVswXTsKCQl0YWcgPSAocGFyc2VkLnRhZyA9PSAnKicpID8gJ2RpdicgOiBwYXJzZWQudGFnOwoJCWlmIChwYXJzZWQuaWQgJiYgcHJvcHMuaWQgPT0gbnVsbCkgcHJvcHMuaWQgPSBwYXJzZWQuaWQ7CgoJCXZhciBhdHRyaWJ1dGVzID0gcGFyc2VkLmF0dHJpYnV0ZXM7CgkJaWYgKGF0dHJpYnV0ZXMpIGZvciAodmFyIGkgPSAwLCBsID0gYXR0cmlidXRlcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgYXR0ciA9IGF0dHJpYnV0ZXNbaV07CgkJCWlmIChhdHRyLnZhbHVlICE9IG51bGwgJiYgYXR0ci5vcGVyYXRvciA9PSAnPScgJiYgcHJvcHNbYXR0ci5rZXldID09IG51bGwpCgkJCQlwcm9wc1thdHRyLmtleV0gPSBhdHRyLnZhbHVlOwoJCX0KCgkJaWYgKHBhcnNlZC5jbGFzc0xpc3QgJiYgcHJvcHNbJ2NsYXNzJ10gPT0gbnVsbCkgcHJvcHNbJ2NsYXNzJ10gPSBwYXJzZWQuY2xhc3NMaXN0LmpvaW4oJyAnKTsKCX0KCglyZXR1cm4gZG9jdW1lbnQubmV3RWxlbWVudCh0YWcsIHByb3BzKTsKfTsKCmlmIChCcm93c2VyLkVsZW1lbnQpIEVsZW1lbnQucHJvdG90eXBlID0gQnJvd3Nlci5FbGVtZW50LnByb3RvdHlwZTsKCm5ldyBUeXBlKCdFbGVtZW50JywgRWxlbWVudCkubWlycm9yKGZ1bmN0aW9uKG5hbWUpewoJaWYgKEFycmF5LnByb3RvdHlwZVtuYW1lXSkgcmV0dXJuOwoKCXZhciBvYmogPSB7fTsKCW9ialtuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJdmFyIHJlc3VsdHMgPSBbXSwgYXJncyA9IGFyZ3VtZW50cywgZWxlbWVudHMgPSB0cnVlOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgZWxlbWVudCA9IHRoaXNbaV0sIHJlc3VsdCA9IHJlc3VsdHNbaV0gPSBlbGVtZW50W25hbWVdLmFwcGx5KGVsZW1lbnQsIGFyZ3MpOwoJCQllbGVtZW50cyA9IChlbGVtZW50cyAmJiB0eXBlT2YocmVzdWx0KSA9PSAnZWxlbWVudCcpOwoJCX0KCQlyZXR1cm4gKGVsZW1lbnRzKSA/IG5ldyBFbGVtZW50cyhyZXN1bHRzKSA6IHJlc3VsdHM7Cgl9OwoKCUVsZW1lbnRzLmltcGxlbWVudChvYmopOwp9KTsKCmlmICghQnJvd3Nlci5FbGVtZW50KXsKCUVsZW1lbnQucGFyZW50ID0gT2JqZWN0OwoKCUVsZW1lbnQuUHJvdG90eXBlID0geyckZmFtaWx5JzogRnVuY3Rpb24uZnJvbSgnZWxlbWVudCcpLmhpZGUoKX07CgoJRWxlbWVudC5taXJyb3IoZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCQlFbGVtZW50LlByb3RvdHlwZVtuYW1lXSA9IG1ldGhvZDsKCX0pOwp9CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Db25zdHJ1Y3RvcnMgPSBuZXcgSGFzaDsKCi8vPC8xLjJjb21wYXQ+Cgp2YXIgSUZyYW1lID0gbmV3IFR5cGUoJ0lGcmFtZScsIGZ1bmN0aW9uKCl7Cgl2YXIgcGFyYW1zID0gQXJyYXkubGluayhhcmd1bWVudHMsIHsKCQlwcm9wZXJ0aWVzOiBUeXBlLmlzT2JqZWN0LAoJCWlmcmFtZTogZnVuY3Rpb24ob2JqKXsKCQkJcmV0dXJuIChvYmogIT0gbnVsbCk7CgkJfQoJfSk7CgoJdmFyIHByb3BzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge30sIGlmcmFtZTsKCWlmIChwYXJhbXMuaWZyYW1lKSBpZnJhbWUgPSBkb2N1bWVudC5pZChwYXJhbXMuaWZyYW1lKTsKCXZhciBvbmxvYWQgPSBwcm9wcy5vbmxvYWQgfHwgZnVuY3Rpb24oKXt9OwoJZGVsZXRlIHByb3BzLm9ubG9hZDsKCXByb3BzLmlkID0gcHJvcHMubmFtZSA9IFtwcm9wcy5pZCwgcHJvcHMubmFtZSwgaWZyYW1lID8gKGlmcmFtZS5pZCB8fCBpZnJhbWUubmFtZSkgOiAnSUZyYW1lXycgKyBTdHJpbmcuZ2VuZXJhdGVVSUQoKV0ucGljaygpOwoJaWZyYW1lID0gbmV3IEVsZW1lbnQoaWZyYW1lIHx8ICdpZnJhbWUnLCBwcm9wcyk7CgoJdmFyIG9uTG9hZCA9IGZ1bmN0aW9uKCl7CgkJb25sb2FkLmNhbGwoaWZyYW1lLmNvbnRlbnRXaW5kb3cpOwoJfTsKCQoJaWYgKHdpbmRvdy5mcmFtZXNbcHJvcHMuaWRdKSBvbkxvYWQoKTsKCWVsc2UgaWZyYW1lLmFkZExpc3RlbmVyKCdsb2FkJywgb25Mb2FkKTsKCXJldHVybiBpZnJhbWU7Cn0pOwoKdmFyIEVsZW1lbnRzID0gdGhpcy5FbGVtZW50cyA9IGZ1bmN0aW9uKG5vZGVzKXsKCWlmIChub2RlcyAmJiBub2Rlcy5sZW5ndGgpewoJCXZhciB1bmlxdWVzID0ge30sIG5vZGU7CgkJZm9yICh2YXIgaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCXZhciB1aWQgPSBTbGljay51aWRPZihub2RlKTsKCQkJaWYgKCF1bmlxdWVzW3VpZF0pewoJCQkJdW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJCXRoaXMucHVzaChub2RlKTsKCQkJfQoJCX0KCX0KfTsKCkVsZW1lbnRzLnByb3RvdHlwZSA9IHtsZW5ndGg6IDB9OwpFbGVtZW50cy5wYXJlbnQgPSBBcnJheTsKCm5ldyBUeXBlKCdFbGVtZW50cycsIEVsZW1lbnRzKS5pbXBsZW1lbnQoewoKCWZpbHRlcjogZnVuY3Rpb24oZmlsdGVyLCBiaW5kKXsKCQlpZiAoIWZpbHRlcikgcmV0dXJuIHRoaXM7CgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5maWx0ZXIodGhpcywgKHR5cGVPZihmaWx0ZXIpID09ICdzdHJpbmcnKSA/IGZ1bmN0aW9uKGl0ZW0pewoJCQlyZXR1cm4gaXRlbS5tYXRjaChmaWx0ZXIpOwoJCX0gOiBmaWx0ZXIsIGJpbmQpKTsKCX0ucHJvdGVjdCgpLAoKCXB1c2g6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gZG9jdW1lbnQuaWQoYXJndW1lbnRzW2ldKTsKCQkJaWYgKGl0ZW0pIHRoaXNbbGVuZ3RoKytdID0gaXRlbTsKCQl9CgkJcmV0dXJuICh0aGlzLmxlbmd0aCA9IGxlbmd0aCk7Cgl9LnByb3RlY3QoKSwKCgljb25jYXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG5ld0VsZW1lbnRzID0gbmV3IEVsZW1lbnRzKHRoaXMpOwoJCWZvciAodmFyIGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBpdGVtID0gYXJndW1lbnRzW2ldOwoJCQlpZiAoVHlwZS5pc0VudW1lcmFibGUoaXRlbSkpIG5ld0VsZW1lbnRzLmFwcGVuZChpdGVtKTsKCQkJZWxzZSBuZXdFbGVtZW50cy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gbmV3RWxlbWVudHM7Cgl9LnByb3RlY3QoKSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGNvbGxlY3Rpb24pewoJCWZvciAodmFyIGkgPSAwLCBsID0gY29sbGVjdGlvbi5sZW5ndGg7IGkgPCBsOyBpKyspIHRoaXMucHVzaChjb2xsZWN0aW9uW2ldKTsKCQlyZXR1cm4gdGhpczsKCX0ucHJvdGVjdCgpLAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXdoaWxlICh0aGlzLmxlbmd0aCkgZGVsZXRlIHRoaXNbLS10aGlzLmxlbmd0aF07CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKQoKfSk7CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL15vYmplY3R8ZW1iZWQkL2kpLnRlc3QoZWwudGFnTmFtZSkpewoJCQkJCU9iamVjdC5hcHBlbmQoZWwsIEVsZW1lbnQuUHJvdG90eXBlKTsKCQkJCX0KCQkJCXJldHVybiBlbDsKCQkJfSwKCgkJCW9iamVjdDogZnVuY3Rpb24ob2JqLCBub2Nhc2gsIGRvYyl7CgkJCQlpZiAob2JqLnRvRWxlbWVudCkgcmV0dXJuIHR5cGVzLmVsZW1lbnQob2JqLnRvRWxlbWVudChkb2MpLCBub2Nhc2gpOwoJCQkJcmV0dXJuIG51bGw7CgkJCX0KCgkJfTsKCgkJdHlwZXMudGV4dG5vZGUgPSB0eXBlcy53aGl0ZXNwYWNlID0gdHlwZXMud2luZG93ID0gdHlwZXMuZG9jdW1lbnQgPSBmdW5jdGlvbih6ZXJvKXsKCQkJcmV0dXJuIHplcm87CgkJfTsKCgkJcmV0dXJuIGZ1bmN0aW9uKGVsLCBub2Nhc2gsIGRvYyl7CgkJCWlmIChlbCAmJiBlbC4kZmFtaWx5ICYmIGVsLnVpZCkgcmV0dXJuIGVsOwoJCQl2YXIgdHlwZSA9IHR5cGVPZihlbCk7CgkJCXJldHVybiAodHlwZXNbdHlwZV0pID8gdHlwZXNbdHlwZV0oZWwsIG5vY2FzaCwgZG9jIHx8IGRvY3VtZW50KSA6IG51bGw7CgkJfTsKCgl9KSgpCgp9KTsKCmlmICh3aW5kb3cuJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJywgZnVuY3Rpb24oZWwsIG5jKXsKCXJldHVybiBkb2N1bWVudC5pZChlbCwgbmMsIHRoaXMuZG9jdW1lbnQpOwp9KTsKCldpbmRvdy5pbXBsZW1lbnQoewoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmRvY3VtZW50OwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCltEb2N1bWVudCwgRWxlbWVudF0uaW52b2tlKCdpbXBsZW1lbnQnLCB7CgoJZ2V0RWxlbWVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgZXhwcmVzc2lvbiwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0RWxlbWVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgZXhwcmVzc2lvbikpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgooZnVuY3Rpb24oc2VhcmNoLCBmaW5kLCBtYXRjaCl7CgoJdGhpcy5TZWxlY3RvcnMgPSB7fTsKCXZhciBwc2V1ZG9zID0gdGhpcy5TZWxlY3RvcnMuUHNldWRvID0gbmV3IEhhc2goKTsKCgl2YXIgYWRkU2xpY2tQc2V1ZG9zID0gZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBuYW1lIGluIHBzZXVkb3MpIGlmIChwc2V1ZG9zLmhhc093blByb3BlcnR5KG5hbWUpKXsKCQkJU2xpY2suZGVmaW5lUHNldWRvKG5hbWUsIHBzZXVkb3NbbmFtZV0pOwoJCQlkZWxldGUgcHNldWRvc1tuYW1lXTsKCQl9Cgl9OwoKCVNsaWNrLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCl7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIHNlYXJjaC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCk7Cgl9OwoKCVNsaWNrLmZpbmQgPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gZmluZC5jYWxsKHRoaXMsIGNvbnRleHQsIGV4cHJlc3Npb24pOwoJfTsKCglTbGljay5tYXRjaCA9IGZ1bmN0aW9uKG5vZGUsIHNlbGVjdG9yKXsKCQlhZGRTbGlja1BzZXVkb3MoKTsKCQlyZXR1cm4gbWF0Y2guY2FsbCh0aGlzLCBub2RlLCBzZWxlY3Rvcik7Cgl9OwoKfSkoU2xpY2suc2VhcmNoLCBTbGljay5maW5kLCBTbGljay5tYXRjaCk7CgppZiAod2luZG93LiQkID09IG51bGwpIFdpbmRvdy5pbXBsZW1lbnQoJyQkJywgZnVuY3Rpb24oc2VsZWN0b3IpewoJdmFyIGVsZW1lbnRzID0gbmV3IEVsZW1lbnRzOwoJaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIGVsZW1lbnRzKTsKCXZhciBhcmdzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpOwoJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmdzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJdmFyIGl0ZW0gPSBhcmdzW2ldOwoJCXN3aXRjaCAodHlwZU9mKGl0ZW0pKXsKCQkJY2FzZSAnZWxlbWVudCc6IGVsZW1lbnRzLnB1c2goaXRlbSk7IGJyZWFrOwoJCQljYXNlICdzdHJpbmcnOiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgaXRlbSwgZWxlbWVudHMpOwoJCX0KCX0KCXJldHVybiBlbGVtZW50czsKfSk7CgovLzwvMS4yY29tcGF0PgoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpewoJCWlmICh0eXBlb2Ygc2VsZWN0b3IgPT0gJ3N0cmluZycpIHJldHVybiBTbGljay5zZWFyY2godGhpcy5kb2N1bWVudCwgc2VsZWN0b3IsIG5ldyBFbGVtZW50cyk7CgkJZWxzZSBpZiAoVHlwZS5pc0VudW1lcmFibGUoc2VsZWN0b3IpKSByZXR1cm4gbmV3IEVsZW1lbnRzKHNlbGVjdG9yKTsKCX0KCXJldHVybiBuZXcgRWxlbWVudHMoYXJndW1lbnRzKTsKfSk7CgooZnVuY3Rpb24oKXsKCnZhciBjb2xsZWN0ZWQgPSB7fSwgc3RvcmFnZSA9IHt9Owp2YXIgcHJvcHMgPSB7aW5wdXQ6ICdjaGVja2VkJywgb3B0aW9uOiAnc2VsZWN0ZWQnLCB0ZXh0YXJlYTogJ3ZhbHVlJ307Cgp2YXIgZ2V0ID0gZnVuY3Rpb24odWlkKXsKCXJldHVybiAoc3RvcmFnZVt1aWRdIHx8IChzdG9yYWdlW3VpZF0gPSB7fSkpOwp9OwoKdmFyIGNsZWFuID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbS5yZW1vdmVFdmVudHMpIGl0ZW0ucmVtb3ZlRXZlbnRzKCk7CglpZiAoaXRlbS5jbGVhckF0dHJpYnV0ZXMpIGl0ZW0uY2xlYXJBdHRyaWJ1dGVzKCk7Cgl2YXIgdWlkID0gaXRlbS51aWQ7CglpZiAodWlkICE9IG51bGwpewoJCWRlbGV0ZSBjb2xsZWN0ZWRbdWlkXTsKCQlkZWxldGUgc3RvcmFnZVt1aWRdOwoJfQoJcmV0dXJuIGl0ZW07Cn07Cgp2YXIgY2FtZWxzID0gWydkZWZhdWx0VmFsdWUnLCAnYWNjZXNzS2V5JywgJ2NlbGxQYWRkaW5nJywgJ2NlbGxTcGFjaW5nJywgJ2NvbFNwYW4nLCAnZnJhbWVCb3JkZXInLCAnbWF4TGVuZ3RoJywgJ3JlYWRPbmx5JywKCSdyb3dTcGFuJywgJ3RhYkluZGV4JywgJ3VzZU1hcCcKXTsKdmFyIGJvb2xzID0gWydjb21wYWN0JywgJ25vd3JhcCcsICdpc21hcCcsICdkZWNsYXJlJywgJ25vc2hhZGUnLCAnY2hlY2tlZCcsICdkaXNhYmxlZCcsICdyZWFkT25seScsICdtdWx0aXBsZScsICdzZWxlY3RlZCcsCgknbm9yZXNpemUnLCAnZGVmZXInCl07CiB2YXIgYXR0cmlidXRlcyA9IHsKCSdodG1sJzogJ2lubmVySFRNTCcsCgknY2xhc3MnOiAnY2xhc3NOYW1lJywKCSdmb3InOiAnaHRtbEZvcicsCgkndGV4dCc6IChmdW5jdGlvbigpewoJCXZhciB0ZW1wID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkJcmV0dXJuICh0ZW1wLmlubmVyVGV4dCA9PSBudWxsKSA/ICd0ZXh0Q29udGVudCcgOiAnaW5uZXJUZXh0JzsKCX0pKCkKfTsKdmFyIHJlYWRPbmx5ID0gWyd0eXBlJ107CnZhciBleHBhbmRvcyA9IFsndmFsdWUnLCAnZGVmYXVsdFZhbHVlJ107CnZhciB1cmlBdHRycyA9IC9eKD86aHJlZnxzcmN8dXNlbWFwKSQvaTsKCmJvb2xzID0gYm9vbHMuYXNzb2NpYXRlKGJvb2xzKTsKY2FtZWxzID0gY2FtZWxzLmFzc29jaWF0ZShjYW1lbHMubWFwKFN0cmluZy50b0xvd2VyQ2FzZSkpOwpyZWFkT25seSA9IHJlYWRPbmx5LmFzc29jaWF0ZShyZWFkT25seSk7CgpPYmplY3QuYXBwZW5kKGF0dHJpYnV0ZXMsIGV4cGFuZG9zLmFzc29jaWF0ZShleHBhbmRvcykpOwoKdmFyIGluc2VydGVycyA9IHsKCgliZWZvcmU6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50KTsKCX0sCgoJYWZ0ZXI6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCXZhciBwYXJlbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJaWYgKHBhcmVudCkgcGFyZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50Lm5leHRTaWJsaW5nKTsKCX0sCgoJYm90dG9tOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50LmFwcGVuZENoaWxkKGNvbnRleHQpOwoJfSwKCgl0b3A6IGZ1bmN0aW9uKGNvbnRleHQsIGVsZW1lbnQpewoJCWVsZW1lbnQuaW5zZXJ0QmVmb3JlKGNvbnRleHQsIGVsZW1lbnQuZmlyc3RDaGlsZCk7Cgl9Cgp9OwoKaW5zZXJ0ZXJzLmluc2lkZSA9IGluc2VydGVycy5ib3R0b207CgovLzwxLjJjb21wYXQ+CgpPYmplY3QuZWFjaChpbnNlcnRlcnMsIGZ1bmN0aW9uKGluc2VydGVyLCB3aGVyZSl7CgoJd2hlcmUgPSB3aGVyZS5jYXBpdGFsaXplKCk7CgoJdmFyIG1ldGhvZHMgPSB7fTsKCgltZXRob2RzWydpbmplY3QnICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKHRoaXMsIGRvY3VtZW50LmlkKGVsLCB0cnVlKSk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCW1ldGhvZHNbJ2dyYWInICsgd2hlcmVdID0gZnVuY3Rpb24oZWwpewoJCWluc2VydGVyKGRvY3VtZW50LmlkKGVsLCB0cnVlKSwgdGhpcyk7CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCUVsZW1lbnQuaW1wbGVtZW50KG1ldGhvZHMpOwoKfSk7CgovLzwvMS4yY29tcGF0PgoKdmFyIGluamVjdENvbWJpbmF0b3IgPSBmdW5jdGlvbihleHByZXNzaW9uLCBjb21iaW5hdG9yKXsKCWlmICghZXhwcmVzc2lvbikgcmV0dXJuIGNvbWJpbmF0b3I7CgoJZXhwcmVzc2lvbiA9IFNsaWNrLnBhcnNlKGV4cHJlc3Npb24pOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCgljbG9uZTogZnVuY3Rpb24oY29udGVudHMsIGtlZXBpZCl7CgkJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7CgkJdmFyIGNsb25lID0gdGhpcy5jbG9uZU5vZGUoY29udGVudHMpOwoJCXZhciBjbGVhbiA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQpewoJCQlpZiAoIWtlZXBpZCkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCWlmIChCcm93c2VyLmllKXsKCQkJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJCQlub2RlLm1lcmdlQXR0cmlidXRlcyhlbGVtZW50KTsKCQkJCW5vZGUucmVtb3ZlQXR0cmlidXRlKCd1aWQnKTsKCQkJCWlmIChub2RlLm9wdGlvbnMpewoJCQkJCXZhciBubyA9IG5vZGUub3B0aW9ucywgZW8gPSBlbGVtZW50Lm9wdGlvbnM7CgkJCQkJZm9yICh2YXIgaiA9IG5vLmxlbmd0aDsgai0tOykgbm9bal0uc2VsZWN0ZWQgPSBlb1tqXS5zZWxlY3RlZDsKCQkJCX0KCQkJfQoJCQl2YXIgcHJvcCA9IHByb3BzW2VsZW1lbnQudGFnTmFtZS50b0xvd2VyQ2FzZSgpXTsKCQkJaWYgKHByb3AgJiYgZWxlbWVudFtwcm9wXSkgbm9kZVtwcm9wXSA9IGVsZW1lbnRbcHJvcF07CgkJfTsKCgkJdmFyIGk7CgkJaWYgKGNvbnRlbnRzKXsKCQkJdmFyIGNlID0gY2xvbmUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSwgdGUgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCWZvciAoaSA9IGNlLmxlbmd0aDsgaS0tOykgY2xlYW4oY2VbaV0sIHRlW2ldKTsKCQl9CgoJCWNsZWFuKGNsb25lLCB0aGlzKTsKCQlpZiAoQnJvd3Nlci5pZSl7CgkJCXZhciB0cyA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ29iamVjdCcpLAoJCQkJY3MgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnb2JqZWN0JyksCgkJCQl0bCA9IHRzLmxlbmd0aCwgY2wgPSBjcy5sZW5ndGg7CgkJCWZvciAoaSA9IDA7IGkgPCB0bCAmJiBpIDwgY2w7IGkrKykKCQkJCWNzW2ldLm91dGVySFRNTCA9IHRzW2ldLm91dGVySFRNTDsKCQl9CgkJcmV0dXJuIGRvY3VtZW50LmlkKGNsb25lKTsKCX0sCgoJZGVzdHJveTogZnVuY3Rpb24oKXsKCQl2YXIgY2hpbGRyZW4gPSBjbGVhbih0aGlzKS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCUFycmF5LmVhY2goY2hpbGRyZW4sIGNsZWFuKTsKCQlFbGVtZW50LmRpc3Bvc2UodGhpcyk7CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCUFycmF5LmZyb20odGhpcy5jaGlsZE5vZGVzKS5lYWNoKEVsZW1lbnQuZGlzcG9zZSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWRpc3Bvc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLnBhcmVudE5vZGUpID8gdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpIDogdGhpczsKCX0sCgoJbWF0Y2g6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiAhZXhwcmVzc2lvbiB8fCBTbGljay5tYXRjaCh0aGlzLCBleHByZXNzaW9uKTsKCX0KCn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkW3RoaXMudWlkXSA9IHRoaXM7CgkJfQoJCWlmICh0aGlzLmFkZEV2ZW50TGlzdGVuZXIpIHRoaXMuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5hdHRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0aGlzLnJlbW92ZUV2ZW50TGlzdGVuZXIpIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBmbiwgZmFsc2UpOwoJCWVsc2UgdGhpcy5kZXRhY2hFdmVudCgnb24nICsgdHlwZSwgZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXRyaWV2ZTogZnVuY3Rpb24ocHJvcGVydHksIGRmbHQpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKSwgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldOwoJCWlmIChkZmx0ICE9IG51bGwgJiYgcHJvcCA9PSBudWxsKSBwcm9wID0gc3RvcmFnZVtwcm9wZXJ0eV0gPSBkZmx0OwoJCXJldHVybiBwcm9wICE9IG51bGwgPyBwcm9wIDogbnVsbDsKCX0sCgoJc3RvcmU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQodGhpcy51aWQpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KHRoaXMudWlkKTsKCQlkZWxldGUgc3RvcmFnZVtwcm9wZXJ0eV07CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCi8vIElFIHB1cmdlCmlmICh3aW5kb3cuYXR0YWNoRXZlbnQgJiYgIXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKSB3aW5kb3cuYWRkTGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uKCl7CglPYmplY3QuZWFjaChjb2xsZWN0ZWQsIGNsZWFuKTsKCWlmICh3aW5kb3cuQ29sbGVjdEdhcmJhZ2UpIENvbGxlY3RHYXJiYWdlKCk7Cn0pOwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwoKCi8qCi0tLQoKbmFtZTogT2JqZWN0CgpkZXNjcmlwdGlvbjogT2JqZWN0IGdlbmVyaWMgbWV0aG9kcwoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFtPYmplY3QsIEhhc2hdCgouLi4KKi8KCgpPYmplY3QuZXh0ZW5kKHsKCglzdWJzZXQ6IGZ1bmN0aW9uKG9iamVjdCwga2V5cyl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGtleXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGsgPSBrZXlzW2ldOwoJCQlyZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlPYmplY3QuZWFjaChvYmplY3QsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlpZiAoZm4uY2FsbChiaW5kLCB2YWx1ZSwga2V5LCBvYmplY3QpKSByZXN1bHRzW2tleV0gPSB2YWx1ZTsKCQl9KTsKCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAob2JqZWN0Lmhhc093blByb3BlcnR5KGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKG9iamVjdC5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIEV2ZW50IENsYXNzLCB0byBtYWtlIHRoZSBldmVudCBvYmplY3QgY3Jvc3MtYnJvd3Nlci4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgRnVuY3Rpb24sIFN0cmluZywgT2JqZWN0XQoKcHJvdmlkZXM6IEV2ZW50CgouLi4KKi8KCnZhciBFdmVudCA9IG5ldyBUeXBlKCdFdmVudCcsIGZ1bmN0aW9uKGV2ZW50LCB3aW4pewoJaWYgKCF3aW4pIHdpbiA9IHdpbmRvdzsKCXZhciBkb2MgPSB3aW4uZG9jdW1lbnQ7CglldmVudCA9IGV2ZW50IHx8IHdpbi5ldmVudDsKCWlmIChldmVudC4kZXh0ZW5kZWQpIHJldHVybiBldmVudDsKCXRoaXMuJGV4dGVuZGVkID0gdHJ1ZTsKCXZhciB0eXBlID0gZXZlbnQudHlwZSwKCQl0YXJnZXQgPSBldmVudC50YXJnZXQgfHwgZXZlbnQuc3JjRWxlbWVudCwKCQlwYWdlID0ge30sCgkJY2xpZW50ID0ge307Cgl3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PSAzKSB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCglpZiAodHlwZS5pbmRleE9mKCdrZXknKSAhPSAtMSl7CgkJdmFyIGNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCXZhciBrZXkgPSBPYmplY3Qua2V5T2YoRXZlbnQuS2V5cywgY29kZSk7CgkJaWYgKHR5cGUgPT0gJ2tleWRvd24nKXsKCQkJdmFyIGZLZXkgPSBjb2RlIC0gMTExOwoJCQlpZiAoZktleSA+IDAgJiYgZktleSA8IDEzKSBrZXkgPSAnZicgKyBmS2V5OwoJCX0KCQlpZiAoIWtleSkga2V5ID0gU3RyaW5nLmZyb21DaGFyQ29kZShjb2RlKS50b0xvd2VyQ2FzZSgpOwoJfSBlbHNlIGlmICh0eXBlLnRlc3QoL2NsaWNrfG1vdXNlfG1lbnUvaSkpewoJCWRvYyA9ICghZG9jLmNvbXBhdE1vZGUgfHwgZG9jLmNvbXBhdE1vZGUgPT0gJ0NTUzFDb21wYXQnKSA/IGRvYy5odG1sIDogZG9jLmJvZHk7CgkJcGFnZSA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggOiBldmVudC5jbGllbnRYICsgZG9jLnNjcm9sbExlZnQsCgkJCXk6IChldmVudC5wYWdlWSAhPSBudWxsKSA/IGV2ZW50LnBhZ2VZIDogZXZlbnQuY2xpZW50WSArIGRvYy5zY3JvbGxUb3AKCQl9OwoJCWNsaWVudCA9IHsKCQkJeDogKGV2ZW50LnBhZ2VYICE9IG51bGwpID8gZXZlbnQucGFnZVggLSB3aW4ucGFnZVhPZmZzZXQgOiBldmVudC5jbGllbnRYLAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSAtIHdpbi5wYWdlWU9mZnNldCA6IGV2ZW50LmNsaWVudFkKCQl9OwoJCWlmICh0eXBlLnRlc3QoL0RPTU1vdXNlU2Nyb2xsfG1vdXNld2hlZWwvKSl7CgkJCXZhciB3aGVlbCA9IChldmVudC53aGVlbERlbHRhKSA/IGV2ZW50LndoZWVsRGVsdGEgLyAxMjAgOiAtKGV2ZW50LmRldGFpbCB8fCAwKSAvIDM7CgkJfQoJCXZhciByaWdodENsaWNrID0gKGV2ZW50LndoaWNoID09IDMpIHx8IChldmVudC5idXR0b24gPT0gMiksCgkJCXJlbGF0ZWQgPSBudWxsOwoJCWlmICh0eXBlLnRlc3QoL292ZXJ8b3V0LykpewoJCQlyZWxhdGVkID0gZXZlbnQucmVsYXRlZFRhcmdldCB8fCBldmVudFsodHlwZSA9PSAnbW91c2VvdmVyJyA/ICdmcm9tJyA6ICd0bycpICsgJ0VsZW1lbnQnXTsKCQkJdmFyIHRlc3RSZWxhdGVkID0gZnVuY3Rpb24oKXsKCQkJCXdoaWxlIChyZWxhdGVkICYmIHJlbGF0ZWQubm9kZVR5cGUgPT0gMykgcmVsYXRlZCA9IHJlbGF0ZWQucGFyZW50Tm9kZTsKCQkJCXJldHVybiB0cnVlOwoJCQl9OwoJCQl2YXIgaGFzUmVsYXRlZCA9IChCcm93c2VyLmZpcmVmb3gyKSA/IHRlc3RSZWxhdGVkLmF0dGVtcHQoKSA6IHRlc3RSZWxhdGVkKCk7CgkJCXJlbGF0ZWQgPSAoaGFzUmVsYXRlZCkgPyByZWxhdGVkIDogbnVsbDsKCQl9Cgl9IGVsc2UgaWYgKHR5cGUudGVzdCgvZ2VzdHVyZXx0b3VjaC9pKSl7CgkJdGhpcy5yb3RhdGlvbiA9IGV2ZW50LnJvdGF0aW9uOwoJCXRoaXMuc2NhbGUgPSBldmVudC5zY2FsZTsKCQl0aGlzLnRhcmdldFRvdWNoZXMgPSBldmVudC50YXJnZXRUb3VjaGVzOwoJCXRoaXMuY2hhbmdlZFRvdWNoZXMgPSBldmVudC5jaGFuZ2VkVG91Y2hlczsKCQl2YXIgdG91Y2hlcyA9IHRoaXMudG91Y2hlcyA9IGV2ZW50LnRvdWNoZXM7CgkJaWYgKHRvdWNoZXMgJiYgdG91Y2hlc1swXSl7CgkJCXZhciB0b3VjaCA9IHRvdWNoZXNbMF07CgkJCXBhZ2UgPSB7eDogdG91Y2gucGFnZVgsIHk6IHRvdWNoLnBhZ2VZfTsKCQkJY2xpZW50ID0ge3g6IHRvdWNoLmNsaWVudFgsIHk6IHRvdWNoLmNsaWVudFl9OwoJCX0KCX0KCglyZXR1cm4gT2JqZWN0LmFwcGVuZCh0aGlzLCB7CgkJZXZlbnQ6IGV2ZW50LAoJCXR5cGU6IHR5cGUsCgoJCXBhZ2U6IHBhZ2UsCgkJY2xpZW50OiBjbGllbnQsCgkJcmlnaHRDbGljazogcmlnaHRDbGljaywKCgkJd2hlZWw6IHdoZWVsLAoKCQlyZWxhdGVkVGFyZ2V0OiBkb2N1bWVudC5pZChyZWxhdGVkKSwKCQl0YXJnZXQ6IGRvY3VtZW50LmlkKHRhcmdldCksCgoJCWNvZGU6IGNvZGUsCgkJa2V5OiBrZXksCgoJCXNoaWZ0OiBldmVudC5zaGlmdEtleSwKCQljb250cm9sOiBldmVudC5jdHJsS2V5LAoJCWFsdDogZXZlbnQuYWx0S2V5LAoJCW1ldGE6IGV2ZW50Lm1ldGFLZXkKCX0pOwp9KTsKCkV2ZW50LktleXMgPSB7CgknZW50ZXInOiAxMywKCSd1cCc6IDM4LAoJJ2Rvd24nOiA0MCwKCSdsZWZ0JzogMzcsCgkncmlnaHQnOiAzOSwKCSdlc2MnOiAyNywKCSdzcGFjZSc6IDMyLAoJJ2JhY2tzcGFjZSc6IDgsCgkndGFiJzogOSwKCSdkZWxldGUnOiA0Ngp9OwoKLy88MS4yY29tcGF0PgoKRXZlbnQuS2V5cyA9IG5ldyBIYXNoKEV2ZW50LktleXMpOwoKLy88LzEuMmNvbXBhdD4KCkV2ZW50LmltcGxlbWVudCh7CgoJc3RvcDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5zdG9wUHJvcGFnYXRpb24oKS5wcmV2ZW50RGVmYXVsdCgpOwoJfSwKCglzdG9wUHJvcGFnYXRpb246IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQuc3RvcFByb3BhZ2F0aW9uKSB0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCWVsc2UgdGhpcy5ldmVudC5jYW5jZWxCdWJibGUgPSB0cnVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglwcmV2ZW50RGVmYXVsdDogZnVuY3Rpb24oKXsKCQlpZiAodGhpcy5ldmVudC5wcmV2ZW50RGVmYXVsdCkgdGhpcy5ldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCWVsc2UgdGhpcy5ldmVudC5yZXR1cm5WYWx1ZSA9IGZhbHNlOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkV2ZW50CgpkZXNjcmlwdGlvbjogQ29udGFpbnMgRWxlbWVudCBtZXRob2RzIGZvciBkZWFsaW5nIHdpdGggZXZlbnRzLiBUaGlzIGZpbGUgYWxzbyBpbmNsdWRlcyBtb3VzZWVudGVyIGFuZCBtb3VzZWxlYXZlIGN1c3RvbSBFbGVtZW50IEV2ZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtFbGVtZW50LCBFdmVudF0KCnByb3ZpZGVzOiBFbGVtZW50LkV2ZW50CgouLi4KKi8KCihmdW5jdGlvbigpewoKRWxlbWVudC5Qcm9wZXJ0aWVzLmV2ZW50cyA9IHtzZXQ6IGZ1bmN0aW9uKGV2ZW50cyl7Cgl0aGlzLmFkZEV2ZW50cyhldmVudHMpOwp9fTsKCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnLCB7fSk7CgkJaWYgKCFldmVudHNbdHlwZV0pIGV2ZW50c1t0eXBlXSA9IHtrZXlzOiBbXSwgdmFsdWVzOiBbXX07CgkJaWYgKGV2ZW50c1t0eXBlXS5rZXlzLmNvbnRhaW5zKGZuKSkgcmV0dXJuIHRoaXM7CgkJZXZlbnRzW3R5cGVdLmtleXMucHVzaChmbik7CgkJdmFyIHJlYWxUeXBlID0gdHlwZSwKCQkJY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV0sCgkJCWNvbmRpdGlvbiA9IGZuLAoJCQlzZWxmID0gdGhpczsKCQlpZiAoY3VzdG9tKXsKCQkJaWYgKGN1c3RvbS5vbkFkZCkgY3VzdG9tLm9uQWRkLmNhbGwodGhpcywgZm4pOwoJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbil7CgkJCQljb25kaXRpb24gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJaWYgKGN1c3RvbS5jb25kaXRpb24uY2FsbCh0aGlzLCBldmVudCkpIHJldHVybiBmbi5jYWxsKHRoaXMsIGV2ZW50KTsKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCX07CgkJCX0KCQkJcmVhbFR5cGUgPSBjdXN0b20uYmFzZSB8fCByZWFsVHlwZTsKCQl9CgkJdmFyIGRlZm4gPSBmdW5jdGlvbigpewoJCQlyZXR1cm4gZm4uY2FsbChzZWxmKTsKCQl9OwoJCXZhciBuYXRpdmVFdmVudCA9IEVsZW1lbnQuTmF0aXZlRXZlbnRzW3JlYWxUeXBlXTsKCQlpZiAobmF0aXZlRXZlbnQpewoJCQlpZiAobmF0aXZlRXZlbnQgPT0gMil7CgkJCQlkZWZuID0gZnVuY3Rpb24oZXZlbnQpewoJCQkJCWV2ZW50ID0gbmV3IEV2ZW50KGV2ZW50LCBzZWxmLmdldFdpbmRvdygpKTsKCQkJCQlpZiAoY29uZGl0aW9uLmNhbGwoc2VsZiwgZXZlbnQpID09PSBmYWxzZSkgZXZlbnQuc3RvcCgpOwoJCQkJfTsKCQkJfQoJCQl0aGlzLmFkZExpc3RlbmVyKHJlYWxUeXBlLCBkZWZuKTsKCQl9CgkJZXZlbnRzW3R5cGVdLnZhbHVlcy5wdXNoKGRlZm4pOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudDogZnVuY3Rpb24odHlwZSwgZm4pewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQl2YXIgbGlzdCA9IGV2ZW50c1t0eXBlXTsKCQl2YXIgaW5kZXggPSBsaXN0LmtleXMuaW5kZXhPZihmbik7CgkJaWYgKGluZGV4ID09IC0xKSByZXR1cm4gdGhpczsKCQl2YXIgdmFsdWUgPSBsaXN0LnZhbHVlc1tpbmRleF07CgkJZGVsZXRlIGxpc3Qua2V5c1tpbmRleF07CgkJZGVsZXRlIGxpc3QudmFsdWVzW2luZGV4XTsKCQl2YXIgY3VzdG9tID0gRWxlbWVudC5FdmVudHNbdHlwZV07CgkJaWYgKGN1c3RvbSl7CgkJCWlmIChjdXN0b20ub25SZW1vdmUpIGN1c3RvbS5vblJlbW92ZS5jYWxsKHRoaXMsIGZuKTsKCQkJdHlwZSA9IGN1c3RvbS5iYXNlIHx8IHR5cGU7CgkJfQoJCXJldHVybiAoRWxlbWVudC5OYXRpdmVFdmVudHNbdHlwZV0pID8gdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCB2YWx1ZSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBJRTkKdHJ5IHsKCWlmICh0eXBlb2YgSFRNTEVsZW1lbnQgIT0gJ3VuZGVmaW5lZCcpCgkJSFRNTEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudCA9IEVsZW1lbnQucHJvdG90eXBlLmZpcmVFdmVudDsKfSBjYXRjaChlKXt9CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBET01SZWFkeQoKZGVzY3JpcHRpb246IENvbnRhaW5zIHRoZSBjdXN0b20gZXZlbnQgZG9tcmVhZHkuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQnJvd3NlciwgRWxlbWVudCwgRWxlbWVudC5FdmVudF0KCnByb3ZpZGVzOiBbRE9NUmVhZHksIERvbVJlYWR5XQoKLi4uCiovCgooZnVuY3Rpb24od2luZG93LCBkb2N1bWVudCl7Cgp2YXIgcmVhZHksCglsb2FkZWQsCgljaGVja3MgPSBbXSwKCXNob3VsZFBvbGwsCgl0aW1lciwKCWlzRnJhbWVkID0gdHJ1ZTsKCi8vIFRoYW5rcyB0byBSaWNoIERvdWdoZXJ0eSA8aHR0cDovL3d3dy5yaWNoZG91Z2hlcnR5LmNvbS8+CnRyeSB7Cglpc0ZyYW1lZCA9IHdpbmRvdy5mcmFtZUVsZW1lbnQgIT0gbnVsbDsKfSBjYXRjaChlKXt9Cgp2YXIgZG9tcmVhZHkgPSBmdW5jdGlvbigpewoJY2xlYXJUaW1lb3V0KHRpbWVyKTsKCWlmIChyZWFkeSkgcmV0dXJuOwoJQnJvd3Nlci5sb2FkZWQgPSByZWFkeSA9IHRydWU7Cglkb2N1bWVudC5yZW1vdmVMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KS5yZW1vdmVMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKCQoJZG9jdW1lbnQuZmlyZUV2ZW50KCdkb21yZWFkeScpOwoJd2luZG93LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKfTsKCnZhciBjaGVjayA9IGZ1bmN0aW9uKCl7Cglmb3IgKHZhciBpID0gY2hlY2tzLmxlbmd0aDsgaS0tOykgaWYgKGNoZWNrc1tpXSgpKXsKCQlkb21yZWFkeSgpOwoJCXJldHVybiB0cnVlOwoJfQoKCXJldHVybiBmYWxzZTsKfTsKCnZhciBwb2xsID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAoIWNoZWNrKCkpIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCAxMCk7Cn07Cgpkb2N1bWVudC5hZGRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KTsKCi8vIGRvU2Nyb2xsIHRlY2huaXF1ZSBieSBEaWVnbyBQZXJpbmkgaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KdmFyIHRlc3RFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CmlmICh0ZXN0RWxlbWVudC5kb1Njcm9sbCAmJiAhaXNGcmFtZWQpewoJY2hlY2tzLnB1c2goZnVuY3Rpb24oKXsKCQl0cnkgewoJCQl0ZXN0RWxlbWVudC5kb1Njcm9sbCgpOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9IGNhdGNoIChlKXt9CgoJCXJldHVybiBmYWxzZTsKCX0pOwoJc2hvdWxkUG9sbCA9IHRydWU7Cn0KCmlmIChkb2N1bWVudC5yZWFkeVN0YXRlKSBjaGVja3MucHVzaChmdW5jdGlvbigpewoJdmFyIHN0YXRlID0gZG9jdW1lbnQucmVhZHlTdGF0ZTsKCXJldHVybiAoc3RhdGUgPT0gJ2xvYWRlZCcgfHwgc3RhdGUgPT0gJ2NvbXBsZXRlJyk7Cn0pOwoKaWYgKCdvbnJlYWR5c3RhdGVjaGFuZ2UnIGluIGRvY3VtZW50KSBkb2N1bWVudC5hZGRMaXN0ZW5lcigncmVhZHlzdGF0ZWNoYW5nZScsIGNoZWNrKTsKZWxzZSBzaG91bGRQb2xsID0gdHJ1ZTsKCmlmIChzaG91bGRQb2xsKSBwb2xsKCk7CgpFbGVtZW50LkV2ZW50cy5kb21yZWFkeSA9IHsKCW9uQWRkOiBmdW5jdGlvbihmbil7CgkJaWYgKHJlYWR5KSBmbi5jYWxsKHRoaXMpOwoJfQp9OwoKLy8gTWFrZSBzdXJlIHRoYXQgZG9tcmVhZHkgZmlyZXMgYmVmb3JlIGxvYWQKRWxlbWVudC5FdmVudHMubG9hZCA9IHsKCWJhc2U6ICdsb2FkJywKCW9uQWRkOiBmdW5jdGlvbihmbil7CgkJaWYgKGxvYWRlZCAmJiB0aGlzID09IHdpbmRvdykgZm4uY2FsbCh0aGlzKTsKCX0sCgljb25kaXRpb246IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMgPT0gd2luZG93KXsKCQkJZG9tcmVhZHkoKTsKCQkJZGVsZXRlIEVsZW1lbnQuRXZlbnRzLmxvYWQ7CgkJfQoJCQoJCXJldHVybiB0cnVlOwoJfQp9OwoKLy8gVGhpcyBpcyBiYXNlZCBvbiB0aGUgY3VzdG9tIGxvYWQgZXZlbnQKd2luZG93LmFkZEV2ZW50KCdsb2FkJywgZnVuY3Rpb24oKXsKCWxvYWRlZCA9IHRydWU7Cn0pOwoKfSkod2luZG93LCBkb2N1bWVudCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSB0aGlzLnJlbW92ZUV2ZW50KHR5cGUsIGZuc1tpXSk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAoIXRoaXMuYWRkRXZlbnQpIHJldHVybiB0aGlzOwoJCWZvciAodmFyIG9wdGlvbiBpbiBvcHRpb25zKXsKCQkJaWYgKHR5cGVPZihvcHRpb25zW29wdGlvbl0pICE9ICdmdW5jdGlvbicgfHwgISgvXm9uW0EtWl0vKS50ZXN0KG9wdGlvbikpIGNvbnRpbnVlOwoJCQl0aGlzLmFkZEV2ZW50KG9wdGlvbiwgb3B0aW9uc1tvcHRpb25dKTsKCQkJZGVsZXRlIG9wdGlvbnNbb3B0aW9uXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBwcm9ncmVzc1N1cHBvcnQgPSAoJ29ucHJvZ3Jlc3MnIGluIG5ldyBCcm93c2VyLlJlcXVlc3QpOwoKdmFyIFJlcXVlc3QgPSB0aGlzLlJlcXVlc3QgPSBuZXcgQ2xhc3MoewoKCUltcGxlbWVudHM6IFtDaGFpbiwgRXZlbnRzLCBPcHRpb25zXSwKCglvcHRpb25zOiB7LyoKCQlvblJlcXVlc3Q6IGZ1bmN0aW9uKCl7fSwKCQlvbkxvYWRzdGFydDogZnVuY3Rpb24oZXZlbnQsIHhocil7fSwKCQlvblByb2dyZXNzOiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uQ29tcGxldGU6IGZ1bmN0aW9uKCl7fSwKCQlvbkNhbmNlbDogZnVuY3Rpb24oKXt9LAoJCW9uU3VjY2VzczogZnVuY3Rpb24ocmVzcG9uc2VUZXh0LCByZXNwb25zZVhNTCl7fSwKCQlvbkZhaWx1cmU6IGZ1bmN0aW9uKHhocil7fSwKCQlvbkV4Y2VwdGlvbjogZnVuY3Rpb24oaGVhZGVyTmFtZSwgdmFsdWUpe30sCgkJb25UaW1lb3V0OiBmdW5jdGlvbigpe30sCgkJdXNlcjogJycsCgkJcGFzc3dvcmQ6ICcnLCovCgkJdXJsOiAnJywKCQlkYXRhOiAnJywKCQloZWFkZXJzOiB7CgkJCSdYLVJlcXVlc3RlZC1XaXRoJzogJ1hNTEh0dHBSZXF1ZXN0JywKCQkJJ0FjY2VwdCc6ICd0ZXh0L2phdmFzY3JpcHQsIHRleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0sCgkJYXN5bmM6IHRydWUsCgkJZm9ybWF0OiBmYWxzZSwKCQltZXRob2Q6ICdwb3N0JywKCQlsaW5rOiAnaWdub3JlJywKCQlpc1N1Y2Nlc3M6IG51bGwsCgkJZW11bGF0aW9uOiB0cnVlLAoJCXVybEVuY29kZWQ6IHRydWUsCgkJZW5jb2Rpbmc6ICd1dGYtOCcsCgkJZXZhbFNjcmlwdHM6IGZhbHNlLAoJCWV2YWxSZXNwb25zZTogZmFsc2UsCgkJdGltZW91dDogMCwKCQlub0NhY2hlOiBmYWxzZQoJfSwKCglpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLnhociA9IG5ldyBCcm93c2VyLlJlcXVlc3QoKTsKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJdGhpcy5oZWFkZXJzID0gdGhpcy5vcHRpb25zLmhlYWRlcnM7Cgl9LAoKCW9uU3RhdGVDaGFuZ2U6IGZ1bmN0aW9uKCl7CgkJdmFyIHhociA9IHRoaXMueGhyOwoJCWlmICh4aHIucmVhZHlTdGF0ZSAhPSA0IHx8ICF0aGlzLnJ1bm5pbmcpIHJldHVybjsKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCQl0aGlzLnN0YXR1cyA9IDA7CgkJRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCQl2YXIgc3RhdHVzID0geGhyLnN0YXR1czsKCQkJdGhpcy5zdGF0dXMgPSAoc3RhdHVzID09IDEyMjMpID8gMjA0IDogc3RhdHVzOwoJCX0uYmluZCh0aGlzKSk7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7fTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJCgkJdGhpcy5yZXNwb25zZSA9IHt0ZXh0OiB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHhtbDogdGhpcy54aHIucmVzcG9uc2VYTUx9OwoJCWlmICh0aGlzLm9wdGlvbnMuaXNTdWNjZXNzLmNhbGwodGhpcywgdGhpcy5zdGF0dXMpKQoJCQl0aGlzLnN1Y2Nlc3ModGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLnJlc3BvbnNlLnhtbCk7CgkJZWxzZQoJCQl0aGlzLmZhaWx1cmUoKTsKCX0sCgoJaXNTdWNjZXNzOiBmdW5jdGlvbigpewoJCXZhciBzdGF0dXMgPSB0aGlzLnN0YXR1czsKCQlyZXR1cm4gKHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwKTsKCX0sCgoJaXNSdW5uaW5nOiBmdW5jdGlvbigpewoJCXJldHVybiAhIXRoaXMucnVubmluZzsKCX0sCgoJcHJvY2Vzc1NjcmlwdHM6IGZ1bmN0aW9uKHRleHQpewoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFJlc3BvbnNlIHx8ICgvKGVjbWF8amF2YSlzY3JpcHQvKS50ZXN0KHRoaXMuZ2V0SGVhZGVyKCdDb250ZW50LXR5cGUnKSkpIHJldHVybiBCcm93c2VyLmV4ZWModGV4dCk7CgkJcmV0dXJuIHRleHQuc3RyaXBTY3JpcHRzKHRoaXMub3B0aW9ucy5ldmFsU2NyaXB0cyk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQsIHhtbCl7CgkJdGhpcy5vblN1Y2Nlc3ModGhpcy5wcm9jZXNzU2NyaXB0cyh0ZXh0KSwgeG1sKTsKCX0sCgoJb25TdWNjZXNzOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIGFyZ3VtZW50cykuZmlyZUV2ZW50KCdzdWNjZXNzJywgYXJndW1lbnRzKS5jYWxsQ2hhaW4oKTsKCX0sCgoJZmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLm9uRmFpbHVyZSgpOwoJfSwKCglvbkZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJykuZmlyZUV2ZW50KCdmYWlsdXJlJywgdGhpcy54aHIpOwoJfSwKCQoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgkKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJdGltZW91dDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgndGltZW91dCcsIHRoaXMueGhyKTsKCX0sCgoJc2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpOwoJCX0uYmluZCh0aGlzKSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgkKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgkJCgkJdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpOwoJCWlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pOwoKCQlpZiAodGhpcy5vcHRpb25zLm5vQ2FjaGUpCgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgU3RyaW5nLmdlbmVyYXRlVUlEKCk7CgoJCWlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCl7CgkJCXhoci5vbmxvYWRzdGFydCA9IHRoaXMubG9hZHN0YXJ0LmJpbmQodGhpcyk7CgkJCXhoci5vbnByb2dyZXNzID0gdGhpcy5wcm9ncmVzcy5iaW5kKHRoaXMpOwoJCX0KCgkJeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgdGhpcy5vcHRpb25zLmFzeW5jLCB0aGlzLm9wdGlvbnMudXNlciwgdGhpcy5vcHRpb25zLnBhc3N3b3JkKTsKCQlpZiAodGhpcy5vcHRpb25zLnVzZXIgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyKSB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKCQkKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLnRpbWVvdXQuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQl4aHIuYWJvcnQoKTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZnVuY3Rpb24oKXt9OwoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuZmlyZUV2ZW50KCdjYW5jZWwnKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIG1ldGhvZHMgPSB7fTsKWydnZXQnLCAncG9zdCcsICdwdXQnLCAnZGVsZXRlJywgJ0dFVCcsICdQT1NUJywgJ1BVVCcsICdERUxFVEUnXS5lYWNoKGZ1bmN0aW9uKG1ldGhvZCl7CgltZXRob2RzW21ldGhvZF0gPSBmdW5jdGlvbihkYXRhKXsKCQlyZXR1cm4gdGhpcy5zZW5kKHsKCQkJZGF0YTogZGF0YSwKCQkJbWV0aG9kOiBtZXRob2QKCQl9KTsKCX07Cn0pOwoKUmVxdWVzdC5pbXBsZW1lbnQobWV0aG9kcyk7CgpFbGVtZW50LlByb3BlcnRpZXMuc2VuZCA9IHsKCglzZXQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXZhciBzZW5kID0gdGhpcy5nZXQoJ3NlbmQnKS5jYW5jZWwoKTsKCQlzZW5kLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldDogZnVuY3Rpb24oKXsKCQl2YXIgc2VuZCA9IHRoaXMucmV0cmlldmUoJ3NlbmQnKTsKCQlpZiAoIXNlbmQpewoJCQlzZW5kID0gbmV3IFJlcXVlc3QoewoJCQkJZGF0YTogdGhpcywgbGluazogJ2NhbmNlbCcsIG1ldGhvZDogdGhpcy5nZXQoJ21ldGhvZCcpIHx8ICdwb3N0JywgdXJsOiB0aGlzLmdldCgnYWN0aW9uJykKCQkJfSk7CgkJCXRoaXMuc3RvcmUoJ3NlbmQnLCBzZW5kKTsKCQl9CgkJcmV0dXJuIHNlbmQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNlbmQ6IGZ1bmN0aW9uKHVybCl7CgkJdmFyIHNlbmRlciA9IHRoaXMuZ2V0KCdzZW5kJyk7CgkJc2VuZGVyLnNlbmQoe2RhdGE6IHRoaXMsIHVybDogdXJsIHx8IHNlbmRlci5vcHRpb25zLnVybH0pOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp9KSgpOwoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0LkhUTUwKCmRlc2NyaXB0aW9uOiBFeHRlbmRzIHRoZSBiYXNpYyBSZXF1ZXN0IENsYXNzIHdpdGggYWRkaXRpb25hbCBtZXRob2RzIGZvciBpbnRlcmFjdGluZyB3aXRoIEhUTUwgcmVzcG9uc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIFJlcXVlc3RdCgpwcm92aWRlczogUmVxdWVzdC5IVE1MCgouLi4KKi8KClJlcXVlc3QuSFRNTCA9IG5ldyBDbGFzcyh7CgoJRXh0ZW5kczogUmVxdWVzdCwKCglvcHRpb25zOiB7CgkJdXBkYXRlOiBmYWxzZSwKCQlhcHBlbmQ6IGZhbHNlLAoJCWV2YWxTY3JpcHRzOiB0cnVlLAoJCWZpbHRlcjogZmFsc2UsCgkJaGVhZGVyczogewoJCQlBY2NlcHQ6ICd0ZXh0L2h0bWwsIGFwcGxpY2F0aW9uL3htbCwgdGV4dC94bWwsICovKicKCQl9Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQpewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLCByZXNwb25zZSA9IHRoaXMucmVzcG9uc2U7CgoJCXJlc3BvbnNlLmh0bWwgPSB0ZXh0LnN0cmlwU2NyaXB0cyhmdW5jdGlvbihzY3JpcHQpewoJCQlyZXNwb25zZS5qYXZhc2NyaXB0ID0gc2NyaXB0OwoJCX0pOwoKCQl2YXIgbWF0Y2ggPSByZXNwb25zZS5odG1sLm1hdGNoKC88Ym9keVtePl0qPihbXHNcU10qPyk8XC9ib2R5Pi9pKTsKCQlpZiAobWF0Y2gpIHJlc3BvbnNlLmh0bWwgPSBtYXRjaFsxXTsKCQl2YXIgdGVtcCA9IG5ldyBFbGVtZW50KCdkaXYnKS5zZXQoJ2h0bWwnLCByZXNwb25zZS5odG1sKTsKCgkJcmVzcG9uc2UudHJlZSA9IHRlbXAuY2hpbGROb2RlczsKCQlyZXNwb25zZS5lbGVtZW50cyA9IHRlbXAuZ2V0RWxlbWVudHMoJyonKTsKCgkJaWYgKG9wdGlvbnMuZmlsdGVyKSByZXNwb25zZS50cmVlID0gcmVzcG9uc2UuZWxlbWVudHMuZmlsdGVyKG9wdGlvbnMuZmlsdGVyKTsKCQlpZiAob3B0aW9ucy51cGRhdGUpIGRvY3VtZW50LmlkKG9wdGlvbnMudXBkYXRlKS5lbXB0eSgpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoJCWVsc2UgaWYgKG9wdGlvbnMuYXBwZW5kKSBkb2N1bWVudC5pZChvcHRpb25zLmFwcGVuZCkuYWRvcHQodGVtcC5nZXRDaGlsZHJlbigpKTsKCQlpZiAob3B0aW9ucy5ldmFsU2NyaXB0cykgQnJvd3Nlci5leGVjKHJlc3BvbnNlLmphdmFzY3JpcHQpOwoKCQl0aGlzLm9uU3VjY2VzcyhyZXNwb25zZS50cmVlLCByZXNwb25zZS5lbGVtZW50cywgcmVzcG9uc2UuaHRtbCwgcmVzcG9uc2UuamF2YXNjcmlwdCk7Cgl9Cgp9KTsKCkVsZW1lbnQuUHJvcGVydGllcy5sb2FkID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIGxvYWQgPSB0aGlzLmdldCgnbG9hZCcpLmNhbmNlbCgpOwoJCWxvYWQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBsb2FkID0gdGhpcy5yZXRyaWV2ZSgnbG9hZCcpOwoJCWlmICghbG9hZCl7CgkJCWxvYWQgPSBuZXcgUmVxdWVzdC5IVE1MKHtkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgdXBkYXRlOiB0aGlzLCBtZXRob2Q6ICdnZXQnfSk7CgkJCXRoaXMuc3RvcmUoJ2xvYWQnLCBsb2FkKTsKCQl9CgkJcmV0dXJuIGxvYWQ7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCWxvYWQ6IGZ1bmN0aW9uKCl7CgkJdGhpcy5nZXQoJ2xvYWQnKS5zZW5kKEFycmF5LmxpbmsoYXJndW1lbnRzLCB7ZGF0YTogVHlwZS5pc09iamVjdCwgdXJsOiBUeXBlLmlzU3RyaW5nfSkpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 16:29:21 GMT",
                    "Content-Length": "108875",
                    "Date": "Fri, 07 Nov 2014 16:29:21 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}