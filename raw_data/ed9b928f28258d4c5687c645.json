{
    "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax-mobile.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>location.href</b> and written to <b>location.replace()</b> via the following statements:<ul><li>var href = location.href.replace(/(javascript:|#).*$/, '');</li><li>location.replace(href + '#' + fragment);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax-mobile.js",
                "path": "/oieduardorabelo/sawpf/src/js/thorax/2.0.0rc3/thorax-mobile.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9vaWVkdWFyZG9yYWJlbG8vc2F3cGYvc3JjL2pzL3Rob3JheC8yLjAuMHJjMy90aG9yYXgtbW9iaWxlLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjk0NTU4DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBTYXQsIDA4IE5vdiAyMDE0IDAzOjU1OjM1IEdNVA0KTGFzdC1Nb2RpZmllZDogU2F0LCAwOCBOb3YgMjAxNCAwMzo1NDo1OSBHTVQNCg0KLyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgIG9wdGlvbnMuZGF0YSA9IHRydWU7CiAgfQogIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcigpLmNvbXBpbGUoZW52aXJvbm1lbnQsIG9wdGlvbnMpOwp9OwoKSGFuZGxlYmFycy5jb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgY29tcGlsZWQ7CiAgZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICAgIHZhciB0ZW1wbGF0ZVNwZWMgPSBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zLCB1bmRlZmluZWQsIHRydWUpOwogICAgcmV0dXJuIEhhbmRsZWJhcnMudGVtcGxhdGUodGVtcGxhdGVTcGVjKTsKICB9CgogIC8vIFRlbXBsYXRlIGlzIG9ubHkgY29tcGlsZWQgb24gZmlyc3QgdXNlIGFuZCBjYWNoZWQgYWZ0ZXIgdGhhdCBwb2ludC4KICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgaWYgKCFjb21waWxlZCkgewogICAgICBjb21waWxlZCA9IGNvbXBpbGUoKTsKICAgIH0KICAgIHJldHVybiBjb21waWxlZC5jYWxsKHRoaXMsIGNvbnRleHQsIG9wdGlvbnMpOwogIH07Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvcnVudGltZS5qcwpIYW5kbGViYXJzLlZNID0gewogIHRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZVNwZWMpIHsKICAgIC8vIEp1c3QgYWRkIHdhdGVyCiAgICB2YXIgY29udGFpbmVyID0gewogICAgICBlc2NhcGVFeHByZXNzaW9uOiBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCiAgICAgIGludm9rZVBhcnRpYWw6IEhhbmRsZWJhcnMuVk0uaW52b2tlUGFydGlhbCwKICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICBwcm9ncmFtOiBmdW5jdGlvbihpLCBmbiwgZGF0YSkgewogICAgICAgIHZhciBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV07CiAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIgPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4sIGRhdGEpOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShmbik7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlci5wcm9ncmFtID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW1XcmFwcGVyOwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcAogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgcmV0dXJuIHRlbXBsYXRlU3BlYy5jYWxsKGNvbnRhaW5lciwgSGFuZGxlYmFycywgY29udGV4dCwgb3B0aW9ucy5oZWxwZXJzLCBvcHRpb25zLnBhcnRpYWxzLCBvcHRpb25zLmRhdGEpOwogICAgfTsKICB9LAoKICBwcm9ncmFtV2l0aERlcHRoOiBmdW5jdGlvbihmbiwgZGF0YSwgJGRlcHRoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGZuLCBkYXRhKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHJldHVybiBmbihjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YSk7CiAgICB9OwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC4yCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdW5zaGlmdCAgICAgICAgICA9IEFycmF5UHJvdG8udW5zaGlmdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290WydfJ10gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuMic7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMiA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZvdW5kOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgZm91bmQgPSBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogICAgcmV0dXJuIGZvdW5kOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChfLmlzRnVuY3Rpb24obWV0aG9kKSA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYG1hcGA6IGZldGNoaW5nIGEgcHJvcGVydHkuCiAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiB2YWx1ZVtrZXldOyB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gd2l0aCBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSB2YWx1ZVtrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIHZhciBrZXkgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgICAoXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiAocmVzdWx0W2tleV0gPSBbXSkpLnB1c2godmFsdWUpOwogICAgfSk7CiAgfTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiAobiAhPSBudWxsKSAmJiAhZ3VhcmQgPyBzbGljZS5jYWxsKGFycmF5LCAwLCBuKSA6IGFycmF5WzBdOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbikpOwogIH07CgogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuICEhdmFsdWU7IH0pOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKICAvLyBvcHRpb25hbGx5KS4gQmluZGluZyB3aXRoIGFyZ3VtZW50cyBpcyBhbHNvIGtub3duIGFzIGBjdXJyeWAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYEZ1bmN0aW9uLmJpbmRgIGlmIGF2YWlsYWJsZS4KICAvLyBXZSBjaGVjayBmb3IgYGZ1bmMuYmluZGAgZmlyc3QsIHRvIGZhaWwgZmFzdCB3aGVuIGBmdW5jYCBpcyB1bmRlZmluZWQuCiAgXy5iaW5kID0gZnVuY3Rpb24gYmluZChmdW5jLCBjb250ZXh0KSB7CiAgICB2YXIgYm91bmQsIGFyZ3M7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3I7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PSAwKSBmdW5jcyA9IF8uZnVuY3Rpb25zKG9iaik7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHRocm90dGxpbmcsIG1vcmUsIHJlc3VsdDsKICAgIHZhciB3aGVuRG9uZSA9IF8uZGVib3VuY2UoZnVuY3Rpb24oKXsgbW9yZSA9IHRocm90dGxpbmcgPSBmYWxzZTsgfSwgd2FpdCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOyBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAobW9yZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgd2hlbkRvbmUoKTsKICAgICAgfTsKICAgICAgaWYgKCF0aW1lb3V0KSB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmICh0aHJvdHRsaW5nKSB7CiAgICAgICAgbW9yZSA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3R0bGluZyA9IHRydWU7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfQogICAgICB3aGVuRG9uZSgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwogICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKICB9OwoKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3Iob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewogICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgogICAgLy8gU2VlIHRoZSBIYXJtb255IGBlZ2FsYCBwcm9wb3NhbDogaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgICAvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgogICAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSBhbiBvYmplY3Q/CiAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKCiAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCiAgZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CiAgICB9OwogIH0pOwoKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gISEob2JqICYmIF8uaGFzKG9iaiwgJ2NhbGxlZScpKTsKICAgIH07CiAgfQoKICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAoLy4vKSAhPT0gJ2Z1bmN0aW9uJykgewogICAgXy5pc0Z1bmN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CgogIC8vIElzIGEgZ2l2ZW4gb2JqZWN0IGEgZmluaXRlIG51bWJlcj8KICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIGlzRmluaXRlKG9iaik7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgKDAgfCBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycsCiAgICAgICcvJzogJyYjeDJGOycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgcHJvcGVydHkgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdDsKICAvLyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKXsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gaWRDb3VudGVyKys7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CiAgICAgIHNvdXJjZSArPQogICAgICAgIGVzY2FwZSA/ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIiA6CiAgICAgICAgaW50ZXJwb2xhdGUgPyAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciIDoKICAgICAgICBldmFsdWF0ZSA/ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIiA6ICcnOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7Cgp9KS5jYWxsKHRoaXMpOwoKLy8gICAgIEJhY2tib25lLmpzIDAuOS45CgovLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgYSBsb2NhbCByZWZlcmVuY2UgdG8gYXJyYXkgbWV0aG9kcy4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCiAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgQmFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggQ29tbW9uSlMgYW5kIHRoZSBicm93c2VyLgogIHZhciBCYWNrYm9uZTsKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBCYWNrYm9uZSA9IGV4cG9ydHM7CiAgfSBlbHNlIHsKICAgIEJhY2tib25lID0gcm9vdC5CYWNrYm9uZSA9IHt9OwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KICBCYWNrYm9uZS5WRVJTSU9OID0gJzAuOS45JzsKCiAgLy8gUmVxdWlyZSBVbmRlcnNjb3JlLCBpZiB3ZSdyZSBvbiB0aGUgc2VydmVyLCBhbmQgaXQncyBub3QgYWxyZWFkeSBwcmVzZW50LgogIHZhciBfID0gcm9vdC5fOwogIGlmICghXyAmJiAodHlwZW9mIHJlcXVpcmUgIT09ICd1bmRlZmluZWQnKSkgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKCiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIG9yIEVuZGVyIG93bnMgdGhlIGAkYCB2YXJpYWJsZS4KICBCYWNrYm9uZS4kID0gcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CiAgLy8gYGFwcGxpY2F0aW9uL2pzb25gIHJlcXVlc3RzIC4uLiB3aWxsIGVuY29kZSB0aGUgYm9keSBhcwogIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQogIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KICBCYWNrYm9uZS5lbXVsYXRlSlNPTiA9IGZhbHNlOwoKICAvLyBCYWNrYm9uZS5FdmVudHMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwoKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIC8vIE9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IgdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvCiAgLy8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGg7CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsKICAgIHJldHVybjsKICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0pOwogICAgcmV0dXJuOwogICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICByZXR1cm47CiAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgIHJldHVybjsKICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKICAgIC8vIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgb3IgYW4gZXZlbnRzIG1hcCwKICAgIC8vIHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8KICAgIC8vIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgbGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwogICAgICBsaXN0LnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgZXZlbnRzIHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgJiYgY2FsbGJhY2spKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBldmVudHNgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciBsaXN0LCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOwogICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChsaXN0ID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICBldmVudHMgPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBsaXN0Lmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gbGlzdFtqXTsKICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSAoZXYuY2FsbGJhY2suX2NhbGxiYWNrIHx8IGV2LmNhbGxiYWNrKSkgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIGV2ZW50cy5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IGV2ZW50czsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKHRoaXMsIGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEFuIGludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb24gb2YgYG9uYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvIGxpc3RlbiB0bwogICAgLy8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzIGxpc3RlbmluZyB0by4KICAgIGxpc3RlblRvOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOwogICAgICB2YXIgaWQgPSBvYmplY3QuX2xpc3RlbmVySWQgfHwgKG9iamVjdC5fbGlzdGVuZXJJZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmplY3Q7CiAgICAgIG9iamVjdC5vbihldmVudHMsIGNhbGxiYWNrIHx8IHRoaXMsIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgogICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnRzLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuOwogICAgICBpZiAob2JqZWN0KSB7CiAgICAgICAgb2JqZWN0Lm9mZihldmVudHMsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAoIWV2ZW50cyAmJiAhY2FsbGJhY2spIGRlbGV0ZSBsaXN0ZW5lcnNbb2JqZWN0Ll9saXN0ZW5lcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5lcnMpIHsKICAgICAgICAgIGxpc3RlbmVyc1tpZF0ub2ZmKG51bGwsIG51bGwsIHRoaXMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwoKICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBFdmVudHMuYmluZCAgID0gRXZlbnRzLm9uOwogIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCiAgLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLgogIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKICAvLyBCYWNrYm9uZS5Nb2RlbAogIC8vIC0tLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCwgd2l0aCBkZWZpbmVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBkZWZhdWx0czsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICB0aGlzLl9jaGFuZ2VzID0gW107CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycyk7CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgXy5kZWZhdWx0cyhhdHRycywgZGVmYXVsdHMpOwogICAgdGhpcy5zZXQoYXR0cnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgIHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB3aG9zZSBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIuCiAgICBjaGFuZ2VkOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzCiAgICAvLyB5b3UgY2hvb3NlIHRvIHNpbGVuY2UgaXQuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRyczsKICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB2YXIgc2lsZW50ID0gb3B0aW9ucyAmJiBvcHRpb25zLnNpbGVudDsKICAgICAgdmFyIHVuc2V0ID0gb3B0aW9ucyAmJiBvcHRpb25zLnVuc2V0OwoKICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgdmFyIG5vdyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZS4uLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKCiAgICAgICAgLy8gVXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZSwgYW5kIHRyYWNrIHRoZSBjaGFuZ2UuCiAgICAgICAgdW5zZXQgPyBkZWxldGUgbm93W2F0dHJdIDogbm93W2F0dHJdID0gdmFsOwogICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaChhdHRyLCB2YWwpOwogICAgICB9CgogICAgICAvLyBTaWduYWwgdGhhdCB0aGUgbW9kZWwncyBzdGF0ZSBoYXMgcG90ZW50aWFsbHkgY2hhbmdlZCwgYW5kIHdlIG5lZWQKICAgICAgLy8gdG8gcmVjb21wdXRlIHRoZSBhY3R1YWwgY2hhbmdlcy4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSBmYWxzZTsKCiAgICAgIC8vIEZpcmUgdGhlIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoIXNpbGVudCkgdGhpcy5jaGFuZ2Uob3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4gYHVuc2V0YCBpcyBhIG5vb3AgaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3ApLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBjdXJyZW50LCBkb25lOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCBfLmlzT2JqZWN0KGtleSkpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgaWYgKGtleSAhPSBudWxsKSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgogICAgICAvLyBJZiB3ZSdyZSAid2FpdCItaW5nIHRvIHNldCBjaGFuZ2VkIGF0dHJpYnV0ZXMsIHZhbGlkYXRlIGVhcmx5LgogICAgICBpZiAob3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKGF0dHJzICYmICF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBjdXJyZW50ID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICAvLyBSZWd1bGFyIHNhdmVzIGBzZXRgIGF0dHJpYnV0ZXMgYmVmb3JlIHBlcnNpc3RpbmcgdG8gdGhlIHNlcnZlci4KICAgICAgdmFyIHNpbGVudE9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3NpbGVudDogdHJ1ZX0pOwogICAgICBpZiAoYXR0cnMgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zLndhaXQgPyBzaWxlbnRPcHRpb25zIDogb3B0aW9ucykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIERvIG5vdCBwZXJzaXN0IGludmFsaWQgbW9kZWxzLgogICAgICBpZiAoIWF0dHJzICYmICF0aGlzLl92YWxpZGF0ZShudWxsLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3ApOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICAvLyBGaW5pc2ggY29uZmlndXJpbmcgYW5kIHNlbmRpbmcgdGhlIEFqYXggcmVxdWVzdC4KICAgICAgdmFyIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgdmFyIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gV2hlbiB1c2luZyBgd2FpdGAsIHJlc2V0IGF0dHJpYnV0ZXMgdG8gb3JpZ2luYWwgdmFsdWVzIHVubGVzcwogICAgICAvLyBgc3VjY2Vzc2AgaGFzIGJlZW4gY2FsbGVkIGFscmVhZHkuCiAgICAgIGlmICghZG9uZSAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmNsZWFyKHNpbGVudE9wdGlvbnMpOwogICAgICAgIHRoaXMuc2V0KGN1cnJlbnQsIHNpbGVudE9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7CiAgICB9LAoKICAgIC8vIENhbGwgdGhpcyBtZXRob2QgdG8gbWFudWFsbHkgZmlyZSBhIGAiY2hhbmdlImAgZXZlbnQgZm9yIHRoaXMgbW9kZWwgYW5kCiAgICAvLyBhIGAiY2hhbmdlOmF0dHJpYnV0ZSJgIGV2ZW50IGZvciBlYWNoIGNoYW5nZWQgYXR0cmlidXRlLgogICAgLy8gQ2FsbGluZyB0aGlzIHdpbGwgY2F1c2UgYWxsIG9iamVjdHMgb2JzZXJ2aW5nIHRoZSBtb2RlbCB0byB1cGRhdGUuCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGNoYW5naW5nID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsKCiAgICAgIC8vIEdlbmVyYXRlIHRoZSBjaGFuZ2VzIHRvIGJlIHRyaWdnZXJlZCBvbiB0aGUgbW9kZWwuCiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuX2NvbXB1dGVDaGFuZ2VzKHRydWUpOwoKICAgICAgdGhpcy5fcGVuZGluZyA9ICEhdHJpZ2dlcnMubGVuZ3RoOwoKICAgICAgZm9yICh2YXIgaSA9IHRyaWdnZXJzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIHRyaWdnZXJzW2ldLCB0aGlzLCB0cmlnZ2Vyc1tpICsgMV0sIG9wdGlvbnMpOwogICAgICB9CgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwoKICAgICAgLy8gVHJpZ2dlciBhIGBjaGFuZ2VgIHdoaWxlIHRoZXJlIGhhdmUgYmVlbiBjaGFuZ2VzLgogICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmICghdGhpcy5faGFzQ29tcHV0ZWQpIHRoaXMuX2NvbXB1dGVDaGFuZ2VzKCk7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2UsIG9sZCA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gTG9va2luZyBhdCB0aGUgYnVpbHQgdXAgbGlzdCBvZiBgc2V0YCBhdHRyaWJ1dGUgY2hhbmdlcywgY29tcHV0ZSBob3cKICAgIC8vIG1hbnkgb2YgdGhlIGF0dHJpYnV0ZXMgaGF2ZSBhY3R1YWxseSBjaGFuZ2VkLiBJZiBgbG91ZGAsIHJldHVybiBhCiAgICAvLyBib2lsZWQtZG93biBsaXN0IG9mIG9ubHkgdGhlIHJlYWwgY2hhbmdlcy4KICAgIF9jb21wdXRlQ2hhbmdlczogZnVuY3Rpb24obG91ZCkgewogICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgdmFyIGFscmVhZHkgPSB7fTsKICAgICAgdmFyIHRyaWdnZXJzID0gW107CiAgICAgIC8vIFdBUk46IG1vbmtleSBwYXRjaCBmb3IgMC45LjksIHdpbGwgZ28gYXdheSB3aGVuIHVwZ3JhZGluZwogICAgICAvLyB0byBmdXR1cmUgdmVyc2lvbiBvZiBiYWNrYm9uZQogICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzIHx8IHt9OwogICAgICB2YXIgY2hhbmdlcyA9IHRoaXMuX2NoYW5nZXM7CgogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGN1cnJlbnQgcXVldWUgb2YgcG90ZW50aWFsIG1vZGVsIGNoYW5nZXMuCiAgICAgIGZvciAodmFyIGkgPSBjaGFuZ2VzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV0sIHZhbCA9IGNoYW5nZXNbaSArIDFdOwogICAgICAgIGlmIChhbHJlYWR5W2tleV0pIGNvbnRpbnVlOwogICAgICAgIGFscmVhZHlba2V5XSA9IHRydWU7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgdGhlIGxhc3QgY2hhbmdlLAogICAgICAgIC8vIGFuZCB1cGRhdGUgYHRoaXMuY2hhbmdlZGAgYWNjb3JkaW5nbHkuIElmIHdlJ3JlIGluc2lkZSBvZiBhIGBjaGFuZ2VgCiAgICAgICAgLy8gY2FsbCwgYWxzbyBhZGQgYSB0cmlnZ2VyIHRvIHRoZSBsaXN0LgogICAgICAgIGlmIChjdXJyZW50W2tleV0gIT09IHZhbCkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2tleV0gPSB2YWw7CiAgICAgICAgICBpZiAoIWxvdWQpIGNvbnRpbnVlOwogICAgICAgICAgdHJpZ2dlcnMucHVzaChrZXksIHZhbCk7CiAgICAgICAgICBjdXJyZW50W2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChsb3VkKSB0aGlzLl9jaGFuZ2VzID0gW107CgogICAgICAvLyBTaWduYWxzIGB0aGlzLmNoYW5nZWRgIGlzIGN1cnJlbnQgdG8gcHJldmVudCBkdXBsaWNhdGUgY2FsbHMgZnJvbSBgdGhpcy5oYXNDaGFuZ2VkYC4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSB0cnVlOwogICAgICByZXR1cm4gdHJpZ2dlcnM7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcwogICAgLy8gYmVlbiBwYXNzZWQsIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpIG9wdGlvbnMuZXJyb3IodGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGBhZGRgIGV2ZW50IGZvciBldmVyeSBuZXcgbW9kZWwuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgYXJncywgbGVuZ3RoLCBtb2RlbCwgZXhpc3RpbmcsIG5lZWRzU29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmF0OwogICAgICB2YXIgc29ydCA9ICgob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpID09IG51bGwgPyB0cnVlIDogb3B0aW9ucy5zb3J0KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSBtb2RlbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBpZighKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImVycm9yIiwgdGhpcywgbW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbW9kZWxzW2ldID0gbW9kZWw7CgogICAgICAgIGV4aXN0aW5nID0gbW9kZWwuaWQgIT0gbnVsbCAmJiB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nIHx8IHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0pIHsKICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpIHsKICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgICAgICAgICBuZWVkc1NvcnQgPSBzb3J0OwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUNpZFttb2RlbC5jaWRdID0gbW9kZWw7CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKG1vZGVscy5sZW5ndGgpIG5lZWRzU29ydCA9IHNvcnQ7CiAgICAgIHRoaXMubGVuZ3RoICs9IG1vZGVscy5sZW5ndGg7CiAgICAgIGFyZ3MgPSBbYXQgIT0gbnVsbCA/IGF0IDogdGhpcy5tb2RlbHMubGVuZ3RoLCAwXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBtb2RlbHMpOwogICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3MpOwoKICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKG5lZWRzU29ydCAmJiB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICB3aGlsZSAobW9kZWwgPSBtb2RlbHMuc2hpZnQoKSkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYHJlbW92ZWAgZXZlbnQgZm9yIGV2ZXJ5IG1vZGVsIHJlbW92ZWQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcG9wOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICB1bnNoaWZ0OiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVscy5zbGljZShiZWdpbiwgZW5kKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgIT0gbnVsbCA/IG9iai5pZCA6IG9ial0gfHwgdGhpcy5fYnlDaWRbb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KCiAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKICAgICAgfQoKICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAoKICAgIC8vIFNtYXJ0bHkgdXBkYXRlIGEgY29sbGVjdGlvbiB3aXRoIGEgY2hhbmdlIHNldCBvZiBtb2RlbHMsIGFkZGluZywKICAgIC8vIHJlbW92aW5nLCBhbmQgbWVyZ2luZyBhcyBuZWNlc3NhcnkuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgbW9kZWwsIGksIGwsIGV4aXN0aW5nOwogICAgICB2YXIgYWRkID0gW10sIHJlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgaWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGU7CiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7YWRkOiB0cnVlLCBtZXJnZTogdHJ1ZSwgcmVtb3ZlOiB0cnVlfSwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7CgogICAgICAvLyBBbGxvdyBhIHNpbmdsZSBtb2RlbCAob3Igbm8gYXJndW1lbnQpIHRvIGJlIHBhc3NlZC4KICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKCiAgICAgIC8vIFByb3h5IHRvIGBhZGRgIGZvciB0aGlzIGNhc2UsIG5vIG5lZWQgdG8gaXRlcmF0ZS4uLgogICAgICBpZiAob3B0aW9ucy5hZGQgJiYgIW9wdGlvbnMucmVtb3ZlKSByZXR1cm4gdGhpcy5hZGQobW9kZWxzLCBvcHRpb25zKTsKCiAgICAgIC8vIERldGVybWluZSB3aGljaCBtb2RlbHMgdG8gYWRkIGFuZCBtZXJnZSwgYW5kIHdoaWNoIHRvIHJlbW92ZS4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXTsKICAgICAgICBleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsLmlkIHx8IG1vZGVsLmNpZCB8fCBtb2RlbFtpZEF0dHJdKTsKICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmUgJiYgZXhpc3RpbmcpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIGlmICgob3B0aW9ucy5hZGQgJiYgIWV4aXN0aW5nKSB8fCAob3B0aW9ucy5tZXJnZSAmJiBleGlzdGluZykpIHsKICAgICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbW9kZWwgPSB0aGlzLm1vZGVsc1tpXTsKICAgICAgICAgIGlmICghbW9kZWxNYXBbbW9kZWwuY2lkXSkgcmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIG1vZGVscyAoaWYgYXBwbGljYWJsZSkgYmVmb3JlIHdlIGFkZCBhbmQgbWVyZ2UgdGhlIHJlc3QuCiAgICAgIGlmIChyZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZShyZW1vdmUsIG9wdGlvbnMpOwogICAgICBpZiAoYWRkLmxlbmd0aCkgdGhpcy5hZGQoYWRkLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBpZiAobW9kZWxzKSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQogICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgYWRkOiB0cnVlYCBpcyBwYXNzZWQsIGFwcGVuZHMgdGhlCiAgICAvLyBtb2RlbHMgdG8gdGhlIGNvbGxlY3Rpb24gaW5zdGVhZCBvZiByZXNldHRpbmcuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMudXBkYXRlID8gJ3VwZGF0ZScgOiAncmVzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByb3h5IHRvIF8ncyBjaGFpbi4gQ2FuJ3QgYmUgcHJveGllZCB0aGUgc2FtZSB3YXkgdGhlIHJlc3Qgb2YgdGhlCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUKICAgIC8vIGNvbnN0cnVjdG9yLgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsKICAgIH0sCgogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgICAgdGhpcy5fYnlDaWQgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAogICAgJ2luamVjdCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywKICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKICAgICdtYXgnLCAnbWluJywgJ3NvcnRlZEluZGV4JywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLAogICAgJ2luaXRpYWwnLCAncmVzdCcsICd0YWlsJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIF8uYmluZChmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gdGhpcy5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgnaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICB2YXIgYXRSb290ID0gbG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoKICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkIGJyb3dzZXIsCiAgICAgIC8vIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmIHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAogICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLnVuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS51bmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCkgfHwgdGhpcy5sb2FkVXJsKHRoaXMuZ2V0SGFzaCgpKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlKSB7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50T3ZlcnJpZGUpOwogICAgICB2YXIgbWF0Y2hlZCA9IF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogb3B0aW9uc307CiAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOwogICAgdGhpcy5fY29uZmlndXJlKG9wdGlvbnMgfHwge30pOwogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndAogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuCiAgICAvLwogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7CiAgICAvLwogICAgbWFrZTogZnVuY3Rpb24odGFnTmFtZSwgYXR0cmlidXRlcywgY29udGVudCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgaWYgKGNvbnRlbnQgIT0gbnVsbCkgQmFja2JvbmUuJChlbCkuaHRtbChjb250ZW50KTsKICAgICAgcmV0dXJuIGVsOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybjsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MocmVzcCwgc3RhdHVzLCB4aHIpOwogICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKCiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHhociwgc3RhdHVzLCB0aHJvd24pIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjByYzEnLAogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgdGVtcGxhdGVzOiB7fSwKICAvL3ZpZXcgY2xhc3NlcwogIFZpZXdzOiB7fSwKICAvL2NlcnRhaW4gZXJyb3IgcHJvbmUgcGllY2VzIG9mIGNvZGUgKG9uIEFuZHJvaWQgb25seSBpdCBzZWVtcykKICAvL2FyZSB3cmFwcGVkIGluIGEgdHJ5IGNhdGNoIGJsb2NrLCB0aGVuIHRyaWdnZXIgdGhpcyBoYW5kbGVyIGluCiAgLy90aGUgY2F0Y2gsIHdpdGggdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIG9yIGV2ZW50IHRoYXQgd2FzCiAgLy90cnlpbmcgdG8gYmUgZXhlY3V0ZWQuIE92ZXJyaWRlIHRoaXMgd2l0aCBhIGN1c3RvbSBoYW5kbGVyCiAgLy90byBkZWJ1ZyAvIGxvZyAvIGV0YwogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIpIHsKICAgIHRocm93IGVycjsKICB9Cn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqLmN0b3IpIHsKICAgICAgICBvYmouY3Rvci5jYWxsKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQgPSB7fTsKCiAgICAvLyBTZXR1cCBvYmplY3QgZXZlbnQgdHJhY2tpbmcKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9KTsKCiAgICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogICAgdGhpcy5jaGlsZHJlbiA9IHt9OwogICAgdGhpcy5fcmVuZGVyQ291bnQgPSAwOwoKICAgIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogICAgLy9wcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGggdGhlIHZpZXcgYW5kIHRlbXBsYXRlIGNvbnRleHQKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMgfHwge30pOwoKICAgIC8vIFNldHVwIGhlbHBlcnMKICAgIGJpbmRIZWxwZXJzLmNhbGwodGhpcyk7CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIF8uZWFjaCh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQsIHRoaXMudW5iaW5kRGF0YU9iamVjdCwgdGhpcyk7CiAgICB0aGlzLnRyaWdnZXIoJ2Rlc3Ryb3llZCcpOwogICAgZGVsZXRlIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5fcmVtb3ZlQ2hpbGQodGhpcyk7CiAgICB9CiAgICB0aGlzLnJlbW92ZSgpOyAvLyBXaWxsIGNhbGwgc3RvcExpc3RlbmluZygpCiAgfSwKCiAgcmVuZGVyOiBmdW5jdGlvbihvdXRwdXQpIHsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IF8uZmlsdGVyKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7IHJldHVybiBjaGlsZC5faGVscGVyT3B0aW9uczsgfSk7CgogICAgdmFyIGNoaWxkcmVuID0ge307CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQsIGtleSkgewogICAgICBpZiAoIWNoaWxkLl9oZWxwZXJPcHRpb25zKSB7CiAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICBpZiAoXy5pc1VuZGVmaW5lZChvdXRwdXQpIHx8ICghXy5pc0VsZW1lbnQob3V0cHV0KSAmJiAhVGhvcmF4LlV0aWwuaXMkKG91dHB1dCkgJiYgIShvdXRwdXQgJiYgb3V0cHV0LmVsKSAmJiAhXy5pc1N0cmluZyhvdXRwdXQpICYmICFfLmlzRnVuY3Rpb24ob3V0cHV0KSkpIHsKICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgLy8geWV0IGhhdmUgb25lIHdlIG11c3QgcmFpc2UKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAndGVtcGxhdGUnLCB7CiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy50ZW1wbGF0ZSk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmF0dHJpYnV0ZXMpIHx8IHt9KTsKICB9LAoKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sIHRoaXMsIGdldFZhbHVlKHRoaXMsICdjb250ZXh0JykgfHwge30pOwogIH0sCgogIC8vIFByaXZhdGUgdmFyaWFibGVzIGluIGhhbmRsZWJhcnMgLyBvcHRpb25zLmRhdGEgaW4gdGVtcGxhdGUgaGVscGVycwogIF9nZXREYXRhOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gewogICAgICB2aWV3OiB0aGlzLAogICAgICBjaWQ6IF8udW5pcXVlSWQoJ3QnKSwKICAgICAgeWllbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGZuIGlzIHNlZWRlZCBieSB0ZW1wbGF0ZSBoZWxwZXIgcGFzc2luZyBjb250ZXh0IHRvIGRhdGEKICAgICAgICByZXR1cm4gZGF0YS5mbiAmJiBkYXRhLmZuKGRhdGEpOwogICAgICB9CiAgICB9OwogIH0sCgogIF9nZXRIZWxwZXJzOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCBIYW5kbGViYXJzLmhlbHBlcnMsIHRoaXMuaGVscGVycyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzOwogICAgfQoKICB9LAoKICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgY29udGV4dCwgaWdub3JlRXJyb3JzKSB7CiAgICB2YXIgdGVtcGxhdGU7CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbGUpKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSwgaWdub3JlRXJyb3JzKTsKICAgIH0KICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRlbXBsYXRlKGNvbnRleHQsIHsKICAgICAgICBoZWxwZXJzOiB0aGlzLl9nZXRIZWxwZXJzKCksCiAgICAgICAgZGF0YTogdGhpcy5fZ2V0RGF0YShjb250ZXh0KQogICAgICB9KTsKICAgIH0KICB9LAoKICBlbnN1cmVSZW5kZXJlZDogZnVuY3Rpb24oKSB7CiAgICAhdGhpcy5fcmVuZGVyQ291bnQgJiYgdGhpcy5yZW5kZXIoKTsKICB9LAoKICBhcHBlbmRUbzogZnVuY3Rpb24oZWwpIHsKICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgICQoZWwpLmFwcGVuZCh0aGlzLmVsKTsKICAgIHRoaXMudHJpZ2dlcigncmVhZHknLCB7dGFyZ2V0OiB0aGlzfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKF8uaXNVbmRlZmluZWQoaHRtbCkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWwuaW5uZXJIVE1MOwogICAgfSBlbHNlIHsKICAgICAgLy8gRXZlbnQgZm9yIElFIGVsZW1lbnQgZml4ZXMKICAgICAgdGhpcy50cmlnZ2VyKCdiZWZvcmU6YXBwZW5kJyk7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fcmVwbGFjZUhUTUwoaHRtbCk7CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAiIjsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gYmluZEhlbHBlcnMoKSB7CiAgaWYgKHRoaXMuaGVscGVycykgewogICAgXy5lYWNoKHRoaXMuaGVscGVycywgZnVuY3Rpb24oaGVscGVyLCBuYW1lKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpczsKICAgICAgdGhpcy5oZWxwZXJzW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgb3B0aW9ucyA9IF8ubGFzdChhcmdzKTsKICAgICAgICBvcHRpb25zLmNvbnRleHQgPSB0aGlzOwogICAgICAgIHJldHVybiBoZWxwZXIuYXBwbHkodmlldywgYXJncyk7CiAgICAgIH07CiAgICB9LCB0aGlzKTsKICB9Cn0KCi8vJChzZWxlY3RvcikudmlldygpIGhlbHBlcgokLmZuLnZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgaGVscGVyOiB0cnVlCiAgfSk7CiAgdmFyIHNlbGVjdG9yID0gJ1snICsgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKyAnXSc7CiAgaWYgKCFvcHRpb25zLmhlbHBlcikgewogICAgc2VsZWN0b3IgKz0gJzpub3QoWycgKyB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSArICddKSc7CiAgfQogIHZhciBlbCA9ICQodGhpcykuY2xvc2VzdChzZWxlY3Rvcik7CiAgcmV0dXJuIChlbCAmJiB2aWV3c0luZGV4ZWRCeUNpZFtlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKV0pIHx8IGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyOnRydWUsIGNsb25lRXZlbnRzOiB0cnVlICovCmZ1bmN0aW9uIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihrbGFzcywgaGFzaCkgewogIHZhciAkc3VwZXIgPSBrbGFzcy5leHRlbmQ7CiAga2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2hpbGQgPSAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChjaGlsZC5wcm90b3R5cGUubmFtZSkgewogICAgICBoYXNoW2NoaWxkLnByb3RvdHlwZS5uYW1lXSA9IGNoaWxkOwogICAgfQogICAgcmV0dXJuIGNoaWxkOwogIH07Cn0KCmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJyByZXF1aXJlczogJyArIGF0dHJpYnV0ZU5hbWUpOwogIH0KfQoKLy8gZ2V0VmFsdWUgaXMgdXNlZCBpbnN0ZWFkIG9mIF8ucmVzdWx0IGJlY2F1c2Ugd2UKLy8gbmVlZCBhbiBleHRyYSBzY29wZSBwYXJhbWV0ZXIsIGFuZCB3aWxsIG1pbmlmeQovLyBiZXR0ZXIgdGhhbiBfLnJlc3VsdApmdW5jdGlvbiBnZXRWYWx1ZShvYmplY3QsIHByb3AsIHNjb3BlKSB7CiAgaWYgKCEob2JqZWN0ICYmIG9iamVjdFtwcm9wXSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkKICAgID8gb2JqZWN0W3Byb3BdLmNhbGwoc2NvcGUgfHwgb2JqZWN0KQogICAgOiBvYmplY3RbcHJvcF07Cn0KCnZhciBpbmhlcml0VmFycyA9IHt9OwpmdW5jdGlvbiBjcmVhdGVJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFzZWxmW29iai5uYW1lXSkgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIHJlc2V0SW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgfSk7Cn0KZnVuY3Rpb24gd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgZmllbGROYW1lLCBpc1N0YXRpYywgY2FsbGJhY2spIHsKICB2YXIgdHJlZSA9IFtdOwogIGlmIChfLmhhcyhzb3VyY2UsIGZpZWxkTmFtZSkpIHsKICAgIHRyZWUucHVzaChzb3VyY2UpOwogIH0KICB2YXIgaXRlcmF0ZSA9IHNvdXJjZTsKICBpZiAoaXNTdGF0aWMpIHsKICAgIHdoaWxlIChpdGVyYXRlID0gaXRlcmF0ZS5fX3BhcmVudF9fKSB7CiAgICAgIGlmIChfLmhhcyhpdGVyYXRlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGl0ZXJhdGUgPSBpdGVyYXRlLmNvbnN0cnVjdG9yOwogICAgd2hpbGUgKGl0ZXJhdGUpIHsKICAgICAgaWYgKGl0ZXJhdGUucHJvdG90eXBlICYmIF8uaGFzKGl0ZXJhdGUucHJvdG90eXBlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUucHJvdG90eXBlKTsKICAgICAgfQogICAgICBpdGVyYXRlID0gaXRlcmF0ZS5fX3N1cGVyX18gJiYgaXRlcmF0ZS5fX3N1cGVyX18uY29uc3RydWN0b3I7CiAgICB9CiAgfQoKICB2YXIgaSA9IHRyZWUubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIF8uZWFjaChnZXRWYWx1ZSh0cmVlW2ldLCBmaWVsZE5hbWUsIHNvdXJjZSksIGNhbGxiYWNrKTsKICB9Cn0KCmZ1bmN0aW9uIG9iamVjdEV2ZW50cyh0YXJnZXQsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc09iamVjdChjYWxsYmFjaykpIHsKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbZXZlbnROYW1lXTsKICAgIGlmIChzcGVjICYmIHNwZWMuZXZlbnQpIHsKICAgICAgYWRkRXZlbnRzKHRhcmdldFsnXycgKyBldmVudE5hbWUgKyAnRXZlbnRzJ10sIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCkgewogIF8uZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYiwgY29udGV4dF0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0XSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpIHsKICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuZGF0YSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdIYW5kbGViYXJzIHRlbXBsYXRlIGNvbXBpbGVkIHdpdGhvdXQgZGF0YSwgdXNlOiBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSknKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gVGhlc2Ugd2hpdGVsaXN0ZWQgYXR0cmlidXRlcyB3aWxsIGJlIHRoZSBvbmx5IG9uZXMgcGFzc2VkCi8vIGZyb20gdGhlIG9wdGlvbnMgaGFzaCB0byBUaG9yYXguVXRpbC50YWcKdmFyIGh0bWxBdHRyaWJ1dGVzVG9Db3B5ID0gWydpZCcsICdjbGFzc05hbWUnLCAndGFnTmFtZSddOwoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgaWYgKF8uaXNTdHJpbmcobmFtZSkpIHsKICAgICAgdmFyIEtsYXNzID0gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBmYWxzZSk7CiAgICAgIHJldHVybiBLbGFzcy5jaWQgPyBfLmV4dGVuZChLbGFzcywgYXR0cmlidXRlcyB8fCB7fSkgOiBuZXcgS2xhc3MoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZ05hbWUnKSwKICAgICAgICB0YWcgPSBhdHRyaWJ1dGVzLnRhZ05hbWUgfHwgJ2Rpdic7CiAgICByZXR1cm4gJzwnICsgdGFnICsgJyAnICsgXy5tYXAoaHRtbEF0dHJpYnV0ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIChrZXkgPT09ICdjbGFzc05hbWUnID8gJ2NsYXNzJyA6IGtleSkgKyAnPSInICsgSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKGZvcm1hdHRlZFZhbHVlKSArICciJzsKICAgIH0pLmpvaW4oJyAnKSArICc+JyArIChfLmlzVW5kZWZpbmVkKGNvbnRlbnQpID8gJycgOiBjb250ZW50KSArICc8LycgKyB0YWcgKyAnPic7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgbmFtZS5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG1peGluID0gVGhvcmF4Lk1peGluc1tuYW1lXTsKICAgICAgXy5leHRlbmQodGhpcywgbWl4aW5bMV0pOwogICAgICAvL21peGluIGNhbGxiYWNrIG1heSBiZSBhbiBhcnJheSBvZiBbY2FsbGJhY2ssIGFyZ3VtZW50c10KICAgICAgaWYgKF8uaXNBcnJheShtaXhpblswXSkpIHsKICAgICAgICBtaXhpblswXVswXS5hcHBseSh0aGlzLCBtaXhpblswXVsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWl4aW5bMF0uYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBvYmplY3RFdmVudHMsIHdhbGtJbmhlcml0VHJlZSAqLwovLyBTYXZlIGEgY29weSBvZiB0aGUgX29uIG1ldGhvZCB0byBjYWxsIGFzIGEgJHN1cGVyIG1ldGhvZAp2YXIgX29uID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLm9uOwoKaW5oZXJpdFZhcnMuZXZlbnQgPSB7CiAgbmFtZTogJ19ldmVudHMnLAoKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMuY29uc3RydWN0b3IsICdfZXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgc2VsZi5vbi5hcHBseShzZWxmLCBldmVudCk7CiAgICB9KTsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLCAnZXZlbnRzJywgZmFsc2UsIGZ1bmN0aW9uKGhhbmRsZXIsIGV2ZW50TmFtZSkgewogICAgICBzZWxmLm9uKGV2ZW50TmFtZSwgaGFuZGxlciwgc2VsZik7CiAgICB9KTsKICB9Cn07CgpfLmV4dGVuZChUaG9yYXguVmlldywgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2spKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBoYW5kbGVyfSkKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkpIHsKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IFtoYW5kbGVyLCBoYW5kbGVyXX0pCiAgICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2JdKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgaGFuZGxlcikKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMucHVzaChbZXZlbnROYW1lLCBjYWxsYmFja10pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKF8uaXNPYmplY3QoZXZlbnROYW1lKSAmJiBhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogY2FsbGJhY2t9KQogICAgICBfLmVhY2goZXZlbnROYW1lLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdGhpcy5vbihrZXksIHZhbHVlLCBjYWxsYmFjayB8fCB0aGlzKTsgICAgLy8gY2FsbGJhY2sgaXMgY29udGV4dCBpbiB0aGlzIGZvcm0gb2YgdGhlIGNhbGwKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvL2FjY2VwdCBvbigicmVuZGVyZWQiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgLy9hY2NlcHQgb24oImNsaWNrIGEiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgXy5lYWNoKChfLmlzQXJyYXkoY2FsbGJhY2spID8gY2FsbGJhY2sgOiBbY2FsbGJhY2tdKSwgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgcGFyYW1zID0gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtLmNhbGwodGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCB8fCB0aGlzKTsKICAgICAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdET00nKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgfSwKICAvL3BhcmFtcyBtYXkgY29udGFpbjoKICAvLy0gbmFtZQogIC8vLSBvcmlnaW5hbE5hbWUKICAvLy0gc2VsZWN0b3IKICAvLy0gdHlwZSAidmlldyIgfHwgIkRPTSIKICAvLy0gaGFuZGxlcgogIF9hZGRFdmVudDogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICBfLmVhY2gocGFyYW1zLm5hbWUuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgX29uLmNhbGwodGhpcywgbmFtZSwgYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICd2aWV3LWV2ZW50OicsIHBhcmFtcykpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBib3VuZEhhbmRsZXIgPSBiaW5kRXZlbnRIYW5kbGVyLmNhbGwodGhpcywgJ2RvbS1ldmVudDonLCBwYXJhbXMpOwogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQogICAgICBpZiAocGFyYW1zLnNlbGVjdG9yKSB7CiAgICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgcGFyYW1zLnNlbGVjdG9yLCBib3VuZEhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVsLm9uKHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IF8uaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IHRoaXNbY2FsbGJhY2tdOwogIGlmICghbWV0aG9kKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0V2ZW50ICInICsgY2FsbGJhY2sgKyAnIiBkb2VzIG5vdCBleGlzdCAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUpOwogIH0KICByZXR1cm4gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIFRob3JheC5vbkV4Y2VwdGlvbigndGhvcmF4LWV4Y2VwdGlvbjogJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lLCBlKTsKICAgIH0KICB9LCBwYXJhbXMuY29udGV4dCB8fCB0aGlzKTsKfQoKZnVuY3Rpb24gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICB2YXIgcGFyYW1zID0gewogICAgb3JpZ2luYWxOYW1lOiBuYW1lLAogICAgaGFuZGxlcjogXy5pc1N0cmluZyhoYW5kbGVyKSA/IHRoaXNbaGFuZGxlcl0gOiBoYW5kbGVyCiAgfTsKICBpZiAobmFtZS5tYXRjaChkb21FdmVudFJlZ2V4cCkpIHsKICAgIHZhciBtYXRjaCA9IGV2ZW50U3BsaXR0ZXIuZXhlYyhuYW1lKTsKICAgIHBhcmFtcy5uZXN0ZWQgPSAhIW1hdGNoWzFdOwogICAgcGFyYW1zLm5hbWUgPSBtYXRjaFsyXTsKICAgIHBhcmFtcy50eXBlID0gJ0RPTSc7CiAgICBwYXJhbXMuc2VsZWN0b3IgPSBtYXRjaFszXTsKICB9IGVsc2UgewogICAgcGFyYW1zLm5hbWUgPSBuYW1lOwogICAgcGFyYW1zLnR5cGUgPSAndmlldyc7CiAgfQogIHBhcmFtcy5jb250ZXh0ID0gY29udGV4dDsKICByZXR1cm4gcGFyYW1zOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgaHRtbEF0dHJpYnV0ZXNUb0NvcHksIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zLCB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSAqLwp2YXIgdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctdG1wJywKICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyA9IHt9OwoKLy8gV2lsbCBiZSBzaGFyZWQgYnkgSGVscGVyVmlldyBhbmQgQ29sbGVjdGlvbkhlbHBlclZpZXcKdmFyIGhlbHBlclZpZXdQcm90b3R5cGUgPSB7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9Cn07CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZChoZWxwZXJWaWV3UHJvdG90eXBlKTsKCi8vIEVuc3VyZSBuZXN0ZWQgaW5saW5lIGhlbHBlcnMgd2lsbCBhbHdheXMgaGF2ZSB0aGlzLnBhcmVudAovLyBzZXQgdG8gdGhlIHZpZXcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUKZnVuY3Rpb24gZ2V0UGFyZW50KHBhcmVudCkgewogIC8vIFRoZSBgdmlld2AgaGVscGVyIGlzIGEgc3BlY2lhbCBjYXNlIGFzIGl0IGVtYmVkcwogIC8vIGEgdmlldyBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9uZQogIHdoaWxlIChwYXJlbnQuX2hlbHBlck5hbWUgJiYgcGFyZW50Ll9oZWxwZXJOYW1lICE9PSAndmlldycpIHsKICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgfQogIHJldHVybiBwYXJlbnQ7Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyID0gZnVuY3Rpb24obmFtZSwgVmlld0NsYXNzLCBjYWxsYmFjaykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICBpZiAoVmlld0NsYXNzLmZhY3RvcnkpIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3MuY2FsbGJhY2s7CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9IFZpZXdDbGFzczsKICAgICAgVmlld0NsYXNzID0gVGhvcmF4LkhlbHBlclZpZXc7CiAgICB9CiAgfQogIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIobmFtZSwgZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICAgIG9wdGlvbnMgPSBhcmdzLnBvcCgpLAogICAgICAgIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwoKICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgdGVtcGxhdGU6IG9wdGlvbnMuZm4gfHwgSGFuZGxlYmFycy5WTS5ub29wLAogICAgICBpbnZlcnNlOiBvcHRpb25zLmludmVyc2UsCiAgICAgIG9wdGlvbnM6IG9wdGlvbnMuaGFzaCwKICAgICAgZGVjbGFyaW5nVmlldzogZGVjbGFyaW5nVmlldywKICAgICAgcGFyZW50OiBnZXRQYXJlbnQoZGVjbGFyaW5nVmlldyksCiAgICAgIF9oZWxwZXJOYW1lOiBuYW1lLAogICAgICBfaGVscGVyT3B0aW9uczogewogICAgICAgIG9wdGlvbnM6IGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSwKICAgICAgICBhcmdzOiBfLmNsb25lKGFyZ3MpCiAgICAgIH0KICAgIH07CgogICAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICAgIF8uZXh0ZW5kKHZpZXdPcHRpb25zLCBfLnBpY2sob3B0aW9ucy5oYXNoLCBodG1sQXR0cmlidXRlc1RvQ29weSkpOwoKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGFuIGV4aXN0aW5nIGluc3RhbmNlIHRoYXQgd2UgY2FuIHJldXNlCiAgICB2YXIgaW5zdGFuY2UgPSBfLmZpbmQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBmdW5jdGlvbihjaGlsZCkgewogICAgICByZXR1cm4gY29tcGFyZUhlbHBlck9wdGlvbnModmlld09wdGlvbnMsIGNoaWxkKTsKICAgIH0pOwoKICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UgaWYgd2UgZG9uJ3QgYWxyZWFkeSBoYXZlIG9uZQogICAgaWYgKCFpbnN0YW5jZSkgewogICAgICBpZiAoVmlld0NsYXNzLmZhY3RvcnkpIHsKICAgICAgICBpbnN0YW5jZSA9IFZpZXdDbGFzcy5mYWN0b3J5KGFyZ3MsIHZpZXdPcHRpb25zKTsKICAgICAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQoKICAgICAgICBpbnN0YW5jZS5faGVscGVyTmFtZSA9IHZpZXdPcHRpb25zLl9oZWxwZXJOYW1lOwogICAgICAgIGluc3RhbmNlLl9oZWxwZXJPcHRpb25zID0gdmlld09wdGlvbnMuX2hlbHBlck9wdGlvbnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5zdGFuY2UgPSBuZXcgVmlld0NsYXNzKHZpZXdPcHRpb25zKTsKICAgICAgfQoKICAgICAgYXJncy5wdXNoKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICBkZWNsYXJpbmdWaWV3LnRyaWdnZXIuYXBwbHkoZGVjbGFyaW5nVmlldywgWydoZWxwZXInLCBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICBkZWNsYXJpbmdWaWV3LnRyaWdnZXIuYXBwbHkoZGVjbGFyaW5nVmlldywgWydoZWxwZXI6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CgogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5jaGlsZHJlbltpbnN0YW5jZS5jaWRdID0gaW5zdGFuY2U7CiAgICB9CgogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpOwogICAgaHRtbEF0dHJpYnV0ZXNbdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBpbnN0YW5jZS5jaWQ7CgogICAgdmFyIGV4cGFuZFRva2VucyA9IG9wdGlvbnMuaGFzaFsnZXhwYW5kLXRva2VucyddOwogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzLCAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKICB9KTsKICB2YXIgaGVscGVyID0gSGFuZGxlYmFycy5oZWxwZXJzW25hbWVdOwogIHJldHVybiBoZWxwZXI7Cn07CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciBwbGFjZWhvbGRlcklkID0gZWwuZ2V0QXR0cmlidXRlKHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIHZpZXcgPSB0aGlzLmNoaWxkcmVuW3BsYWNlaG9sZGVySWRdOwogICAgaWYgKHZpZXcpIHsKICAgICAgLy9zZWUgaWYgdGhlIHZpZXcgaGVscGVyIGRlY2xhcmVkIGFuIG92ZXJyaWRlIGZvciB0aGUgdmlldwogICAgICAvL2lmIG5vdCwgZW5zdXJlIHRoZSB2aWV3IGhhcyBiZWVuIHJlbmRlcmVkIGF0IGxlYXN0IG9uY2UKICAgICAgaWYgKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSkgewogICAgICAgIHZpZXcucmVuZGVyKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSk7CiAgICAgICAgZGVsZXRlIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIH0KICAgICAgJChlbCkucmVwbGFjZVdpdGgodmlldy5lbCk7CiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKHZpZXcuZWwpOwogICAgfQogIH0sIHRoaXMpOwp9KTsKCgovKioKICogQ2xvbmVzIHRoZSBoZWxwZXIgb3B0aW9ucywgZHJvcHBpbmcgaXRlbXMgdGhhdCBhcmUga25vd24gdG8gY2hhbmdlCiAqIGJldHdlZW4gcmVuZGVyaW5nIGN5Y2xlcyBhcyBhcHByb3ByaWF0ZS4KICovCmZ1bmN0aW9uIGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSB7CiAgdmFyIHJldCA9IF8ucGljayhvcHRpb25zLCAnZm4nLCAnaW52ZXJzZScsICdoYXNoJywgJ2RhdGEnKTsKICByZXQuZGF0YSA9IF8ub21pdChvcHRpb25zLmRhdGEsICdjaWQnLCAndmlldycsICd5aWVsZCcpOwogIHJldHVybiByZXQ7Cn0KCi8qKgogKiBDaGVja3MgZm9yIGJhc2ljIGVxdWFsaXR5IGJldHdlZW4gdHdvIHNldHMgb2YgcGFyYW1ldGVycyBmb3IgYSBoZWxwZXIgdmlldy4KICoKICogQ2hlY2tlZCBmaWVsZHMgaW5jbHVkZToKICogIC0gX2hlbHBlck5hbWUKICogIC0gQWxsIGFyZ3MKICogIC0gSGFzaAogKiAgLSBEYXRhCiAqICAtIEZ1bmN0aW9uIGFuZCBJbnZlcnQgKGlkIGJhc2VkIGlmIHBvc3NpYmxlKQogKgogKiBUaGlzIG1ldGhvZCBhbGxvd3MgdXMgdG8gZGV0ZXJtaW5lIGlmIHRoZSBpbnB1dHMgdG8gYSBnaXZlbiB2aWV3IGFyZSB0aGUgc2FtZS4gSWYgdGhleQogKiBhcmUgdGhlbiB3ZSBtYWtlIHRoZSBhc3N1bXB0aW9uIHRoYXQgdGhlIHJlbmRlcmluZyB3aWxsIGJlIHRoZSBzYW1lIChvciB0aGUgY2hpbGQgdmlldyB3aWxsCiAqIG90aGVyd2lzZSByZXJlbmRlcmluZyBpdCBieSBtb25pdG9yaW5nIGl0J3MgcGFyYW1ldGVycyBhcyBuZWNlc3NhcnkpIGFuZCByZXVzZSB0aGUgdmlldyBvbgogKiByZXJlbmRlciBvZiB0aGUgcGFyZW50IHZpZXcuCiAqLwpmdW5jdGlvbiBjb21wYXJlSGVscGVyT3B0aW9ucyhhLCBiKSB7CiAgZnVuY3Rpb24gY29tcGFyZVZhbHVlcyhhLCBiKSB7CiAgICByZXR1cm4gXy5ldmVyeShhLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIHJldHVybiBiW2tleV0gPT09IHZhbHVlOwogICAgfSk7CiAgfQoKICBpZiAoYS5faGVscGVyTmFtZSAhPT0gYi5faGVscGVyTmFtZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgYSA9IGEuX2hlbHBlck9wdGlvbnM7CiAgYiA9IGIuX2hlbHBlck9wdGlvbnM7CgogIC8vIEltcGxlbWVudHMgYSBmaXJzdCBsZXZlbCBkZXB0aCBjb21wYXJpc29uCiAgcmV0dXJuIGEuYXJncy5sZW5ndGggPT09IGIuYXJncy5sZW5ndGgKICAgICAgJiYgY29tcGFyZVZhbHVlcyhhLmFyZ3MsIGIuYXJncykKICAgICAgJiYgXy5pc0VxdWFsKF8ua2V5cyhhLm9wdGlvbnMpLCBfLmtleXMoYi5vcHRpb25zKSkKICAgICAgJiYgXy5ldmVyeShhLm9wdGlvbnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGlmIChrZXkgPT09ICdkYXRhJyB8fCBrZXkgPT09ICdoYXNoJykgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyhhLm9wdGlvbnNba2V5XSwgYi5vcHRpb25zW2tleV0pOwogICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdmbicgfHwga2V5ID09PSAnaW52ZXJzZScpIHsKICAgICAgICAgICAgaWYgKGIub3B0aW9uc1trZXldID09PSB2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3RoZXIgPSBiLm9wdGlvbnNba2V5XSB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlICYmIF8uaGFzKHZhbHVlLCAncHJvZ3JhbScpICYmICF2YWx1ZS5kZXB0aCAmJiBvdGhlci5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGIub3B0aW9uc1trZXldID09PSB2YWx1ZTsKICAgICAgICB9KTsKfQoKOzsKLypnbG9iYWwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzLCB3YWxrSW5oZXJpdFRyZWUgKi8KCmZ1bmN0aW9uIGRhdGFPYmplY3QodHlwZSwgc3BlYykgewogIHNwZWMgPSBpbmhlcml0VmFyc1t0eXBlXSA9IF8uZGVmYXVsdHMoewogICAgbmFtZTogJ18nICsgdHlwZSArICdFdmVudHMnLAogICAgZXZlbnQ6IHRydWUKICB9LCBzcGVjKTsKCiAgLy8gQWRkIGEgY2FsbGJhY2sgaW4gdGhlIHZpZXcgY29uc3RydWN0b3IKICBzcGVjLmN0b3IgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzW3R5cGVdKSB7CiAgICAgIC8vIE5lZWQgdG8gbnVsbCB0aGlzLm1vZGVsL2NvbGxlY3Rpb24gc28gc2V0TW9kZWwvQ29sbGVjdGlvbiB3aWxsCiAgICAgIC8vIG5vdCB0cmVhdCBpdCBhcyB0aGUgb2xkIG1vZGVsL2NvbGxlY3Rpb24gYW5kIGltbWVkaWF0ZWx5IHJldHVybgogICAgICB2YXIgb2JqZWN0ID0gdGhpc1t0eXBlXTsKICAgICAgdGhpc1t0eXBlXSA9IG51bGw7CiAgICAgIHRoaXNbc3BlYy5zZXRdKG9iamVjdCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gc2V0T2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHZhciBvbGQgPSB0aGlzW3R5cGVdLAogICAgICAgICRlbCA9IGdldFZhbHVlKHRoaXMsIHNwZWMuJGVsKTsKCiAgICBpZiAoZGF0YU9iamVjdCA9PT0gb2xkKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKG9sZCkgewogICAgICB0aGlzLnVuYmluZERhdGFPYmplY3Qob2xkKTsKICAgIH0KCiAgICBpZiAoZGF0YU9iamVjdCkgewogICAgICB0aGlzW3R5cGVdID0gZGF0YU9iamVjdDsKCiAgICAgIGlmIChzcGVjLmxvYWRpbmcpIHsKICAgICAgICBzcGVjLmxvYWRpbmcuY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5iaW5kRGF0YU9iamVjdCh0eXBlLCBkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKSk7CiAgICAgICRlbCAmJiAkZWwuYXR0cihzcGVjLmNpZEF0dHJOYW1lLCBkYXRhT2JqZWN0LmNpZCk7CiAgICAgIGRhdGFPYmplY3QudHJpZ2dlcignc2V0JywgZGF0YU9iamVjdCwgb2xkKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXNbdHlwZV0gPSBmYWxzZTsKICAgICAgaWYgKHNwZWMuY2hhbmdlKSB7CiAgICAgICAgc3BlYy5jaGFuZ2UuY2FsbCh0aGlzLCBmYWxzZSk7CiAgICAgIH0KICAgICAgJGVsICYmICRlbC5yZW1vdmVBdHRyKHNwZWMuY2lkQXR0ck5hbWUpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6ZGF0YS1vYmplY3QnLCB0eXBlLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBUaG9yYXguVmlldy5wcm90b3R5cGVbc3BlYy5zZXRdID0gc2V0T2JqZWN0Owp9CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBiaW5kRGF0YU9iamVjdDogZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgaWYgKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IGRhdGFPYmplY3Q7CgogICAgdmFyIG9wdGlvbnMgPSB0aGlzLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyhkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgaW5oZXJpdFZhcnNbdHlwZV0uZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBvcHRpb25zOwoKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzKTsKCiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdOwogICAgc3BlYy5iaW5kQ2FsbGJhY2sgJiYgc3BlYy5iaW5kQ2FsbGJhY2suY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKCiAgICBpZiAoZGF0YU9iamVjdC5zaG91bGRGZXRjaCAmJiBkYXRhT2JqZWN0LnNob3VsZEZldGNoKG9wdGlvbnMpKSB7CiAgICAgIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAvLyB3YW50IHRvIHRyaWdnZXIgYnVpbHQgaW4gcmVuZGVyaW5nIHdpdGhvdXQgdHJpZ2dlcmluZyBldmVudCBvbiBtb2RlbAogICAgICBpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UuY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgdGhpcy5zdG9wTGlzdGVuaW5nKGRhdGFPYmplY3QpOwogICAgZGVsZXRlIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBfbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnM6IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zOwogIH0KfSk7CgpmdW5jdGlvbiBiaW5kRXZlbnRzKHR5cGUsIHRhcmdldCwgc291cmNlKSB7CiAgdmFyIGNvbnRleHQgPSB0aGlzOwogIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsICdfJyArIHR5cGUgKyAnRXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIC8vIGdldEV2ZW50Q2FsbGJhY2sgd2lsbCByZXNvbHZlIGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbWV0aG9kCiAgICAvLyBhbmQgcmV0dXJuIGEgbWV0aG9kCiAgICBjb250ZXh0Lmxpc3RlblRvKHRhcmdldCwgZXZlbnRbMF0sIF8uYmluZChnZXRFdmVudENhbGxiYWNrKGV2ZW50WzFdLCBjb250ZXh0KSwgZXZlbnRbMl0gfHwgY29udGV4dCkpOwogIH0pOwp9CgpmdW5jdGlvbiBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBpZiAoZGF0YU9iamVjdC5sb2FkKSB7CiAgICBkYXRhT2JqZWN0LmxvYWQoZnVuY3Rpb24oKSB7CiAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5zdWNjZXNzICYmIG9wdGlvbnMuc3VjY2VzcyhkYXRhT2JqZWN0KTsKICAgIH0sIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICBkYXRhT2JqZWN0LmZldGNoKG9wdGlvbnMpOwogIH0KfQoKZnVuY3Rpb24gZ2V0RXZlbnRDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzRnVuY3Rpb24oY2FsbGJhY2spKSB7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjb250ZXh0W2NhbGxiYWNrXTsKICB9Cn0KCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0VmFsdWUgKi8KdmFyIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLW1vZGVsLWNpZCc7CgpUaG9yYXguTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICAvLyBXZSBhcmUgcG9wdWxhdGVkIGlmIHdlIGhhdmUgYXR0cmlidXRlcyBzZXQKICAgIHZhciBhdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpLAogICAgICAgIGRlZmF1bHRzID0gZ2V0VmFsdWUodGhpcywgJ2RlZmF1bHRzJykgfHwge307CiAgICBmb3IgKHZhciBkZWZhdWx0X2tleSBpbiBkZWZhdWx0cykgewogICAgICBpZiAoYXR0cmlidXRlc1tkZWZhdWx0X2tleV0gIT0gZGVmYXVsdHNbZGVmYXVsdF9rZXldKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgZGVsZXRlIGF0dHJpYnV0ZXNbZGVmYXVsdF9rZXldOwogICAgfQogICAgdmFyIGtleXMgPSBfLmtleXMoYXR0cmlidXRlcyk7CiAgICByZXR1cm4ga2V5cy5sZW5ndGggPiAxIHx8IChrZXlzLmxlbmd0aCA9PT0gMSAmJiBrZXlzWzBdICE9PSB0aGlzLmlkQXR0cmlidXRlKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAvLyB1cmwoKSB3aWxsIHRocm93IGlmIG1vZGVsIGhhcyBubyBgdXJsUm9vdGAgYW5kIG5vIGBjb2xsZWN0aW9uYAogICAgLy8gb3IgaGFzIGBjb2xsZWN0aW9uYCBhbmQgYGNvbGxlY3Rpb25gIGhhcyBubyBgdXJsYAogICAgdmFyIHVybDsKICAgIHRyeSB7CiAgICAgIHVybCA9IGdldFZhbHVlKHRoaXMsICd1cmwnKTsKICAgIH0gY2F0Y2goZSkgewogICAgICB1cmwgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiBvcHRpb25zLmZldGNoICYmICEhdXJsICYmICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfQp9KTsKClRob3JheC5Nb2RlbHMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Nb2RlbCwgVGhvcmF4Lk1vZGVscyk7CgpkYXRhT2JqZWN0KCdtb2RlbCcsIHsKICBzZXQ6ICdzZXRNb2RlbCcsCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdHJ1ZSwKICAgIGZldGNoOiB0cnVlLAogICAgc3VjY2VzczogZmFsc2UsCiAgICBlcnJvcnM6IHRydWUKICB9LAogIGNoYW5nZTogb25Nb2RlbENoYW5nZSwKICAkZWw6ICckZWwnLAogIGNpZEF0dHJOYW1lOiBtb2RlbENpZEF0dHJpYnV0ZU5hbWUKfSk7CgpmdW5jdGlvbiBvbk1vZGVsQ2hhbmdlKG1vZGVsKSB7CiAgdmFyIG1vZGVsT3B0aW9ucyA9IG1vZGVsICYmIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdOwogIC8vICFtb2RlbE9wdGlvbnMgd2lsbCBiZSB0cnVlIHdoZW4gc2V0TW9kZWwoZmFsc2UpIGlzIGNhbGxlZAogIGlmICghbW9kZWxPcHRpb25zIHx8IChtb2RlbE9wdGlvbnMgJiYgbW9kZWxPcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyKCk7CiAgfQp9CgpUaG9yYXguVmlldy5vbih7CiAgbW9kZWw6IHsKICAgIGVycm9yOiBmdW5jdGlvbihtb2RlbCwgZXJyb3JzKSB7CiAgICAgIGlmICh0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbbW9kZWwuY2lkXS5lcnJvcnMpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzLCBtb2RlbCk7CiAgICAgIH0KICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIG9uTW9kZWxDaGFuZ2UuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9CiAgfQp9KTsKCiQuZm4ubW9kZWwgPSBmdW5jdGlvbih2aWV3KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgbW9kZWxFbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBtb2RlbENpZCA9IG1vZGVsRWxlbWVudCAmJiBtb2RlbEVsZW1lbnQuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChtb2RlbENpZCkgewogICAgdmFyIHZpZXcgPSB2aWV3IHx8ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3ICYmIHZpZXcubW9kZWwgJiYgdmlldy5tb2RlbC5jaWQgPT09IG1vZGVsQ2lkKSB7CiAgICAgIHJldHVybiB2aWV3Lm1vZGVsIHx8IGZhbHNlOwogICAgfQogICAgdmFyIGNvbGxlY3Rpb24gPSAkdGhpcy5jb2xsZWN0aW9uKHZpZXcpOwogICAgaWYgKGNvbGxlY3Rpb24pIHsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZ2V0KG1vZGVsQ2lkKTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRFdmVudENhbGxiYWNrLCBnZXRWYWx1ZSwgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCB2aWV3Q2lkQXR0cmlidXRlTmFtZSAqLwp2YXIgX2ZldGNoID0gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuZmV0Y2gsCiAgICBfcmVzZXQgPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5yZXNldCwKICAgIF9yZXBsYWNlSFRNTCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fcmVwbGFjZUhUTUwsCiAgICBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tY2lkJywKICAgIGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVtcHR5JywKICAgIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZWxlbWVudCcsCiAgICBFTEVNRU5UX05PREVfVFlQRSA9IDE7CgpUaG9yYXguQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICBtb2RlbDogVGhvcmF4Lk1vZGVsIHx8IEJhY2tib25lLk1vZGVsLAogIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjb2xsZWN0aW9uJyk7CiAgICByZXR1cm4gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICB0aGlzLl9mZXRjaGVkID0gISFtb2RlbHM7CiAgICByZXR1cm4gX3Jlc2V0LmNhbGwodGhpcywgbW9kZWxzLCBvcHRpb25zKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgYmluZENhbGxiYWNrOiBvblNldENvbGxlY3Rpb24sCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdHJ1ZSwKICAgIGZldGNoOiB0cnVlLAogICAgc3VjY2VzczogZmFsc2UsCiAgICBlcnJvcnM6IHRydWUKICB9LAogIGNoYW5nZTogb25Db2xsZWN0aW9uUmVzZXQsCiAgJGVsOiAnZ2V0Q29sbGVjdGlvbkVsZW1lbnQnLAogIGNpZEF0dHJOYW1lOiBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2RlZmF1bHRUZW1wbGF0ZTogSGFuZGxlYmFycy5WTS5ub29wLAogIF9jb2xsZWN0aW9uU2VsZWN0b3I6ICdbJyArIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSArICddJywKCiAgLy8gcHJlc2VydmUgY29sbGVjdGlvbiBlbGVtZW50IGlmIGl0IHdhcyBub3QgY3JlYXRlZCB3aXRoIHt7Y29sbGVjdGlvbn19IGhlbHBlcgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9LAoKICAvL2FwcGVuZEl0ZW0obW9kZWwgWyxpbmRleF0pCiAgLy9hcHBlbmRJdGVtKGh0bWxfc3RyaW5nLCBpbmRleCkKICAvL2FwcGVuZEl0ZW0odmlldywgaW5kZXgpCiAgYXBwZW5kSXRlbTogZnVuY3Rpb24obW9kZWwsIGluZGV4LCBvcHRpb25zKSB7CiAgICAvL2VtcHR5IGl0ZW0KICAgIGlmICghbW9kZWwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGl0ZW1WaWV3LAogICAgICAgICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZmlsdGVyOiB0cnVlCiAgICB9KTsKICAgIC8vaWYgaW5kZXggYXJndW1lbnQgaXMgYSB2aWV3CiAgICBpbmRleCAmJiBpbmRleC5lbCAmJiAoaW5kZXggPSAkZWwuY2hpbGRyZW4oKS5pbmRleE9mKGluZGV4LmVsKSArIDEpOwogICAgLy9pZiBhcmd1bWVudCBpcyBhIHZpZXcsIG9yIGh0bWwgc3RyaW5nCiAgICBpZiAobW9kZWwuZWwgfHwgXy5pc1N0cmluZyhtb2RlbCkpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpIHx8IDA7CiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtKG1vZGVsLCBpbmRleCk7CiAgICB9CiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaXRlbVZpZXcuY2lkICYmIHRoaXMuX2FkZENoaWxkKGl0ZW1WaWV3KTsKICAgICAgLy9pZiB0aGUgcmVuZGVyZXIncyBvdXRwdXQgd2Fzbid0IGNvbnRhaW5lZCBpbiBhIHRhZywgd3JhcCBpdCBpbiBhIGRpdgogICAgICAvL3BsYWluIHRleHQsIG9yIGEgbWl4dHVyZSBvZiB0b3AgbGV2ZWwgdGV4dCBub2RlcyBhbmQgZWxlbWVudCBub2RlcwogICAgICAvL3dpbGwgZ2V0IHdyYXBwZWQKICAgICAgaWYgKF8uaXNTdHJpbmcoaXRlbVZpZXcpICYmICFpdGVtVmlldy5tYXRjaCgvXlxzKjwvbSkpIHsKICAgICAgICBpdGVtVmlldyA9ICc8ZGl2PicgKyBpdGVtVmlldyArICc8L2Rpdj4nOwogICAgICB9CiAgICAgIHZhciBpdGVtRWxlbWVudCA9IGl0ZW1WaWV3LmVsID8gW2l0ZW1WaWV3LmVsXSA6IF8uZmlsdGVyKCQoJC50cmltKGl0ZW1WaWV3KSksIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvL2ZpbHRlciBvdXQgdG9wIGxldmVsIHdoaXRlc3BhY2Ugbm9kZXMKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFX1RZUEU7CiAgICAgIH0pOwogICAgICBtb2RlbCAmJiAkKGl0ZW1FbGVtZW50KS5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgdmFyIHByZXZpb3VzTW9kZWwgPSBpbmRleCA+IDAgPyB0aGlzLmNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5jaGlsZHJlbignWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgcHJldmlvdXNNb2RlbC5jaWQgKyAnIl0nKS5sYXN0KCk7CiAgICAgICAgbGFzdC5hZnRlcihpdGVtRWxlbWVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJywgbnVsbCwgZnVuY3Rpb24oZWwpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB9KTsKCiAgICAgICFvcHRpb25zLnNpbGVudCAmJiB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOml0ZW0nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24sIG1vZGVsLCBpdGVtRWxlbWVudCwgaW5kZXgpOwogICAgICBvcHRpb25zLmZpbHRlciAmJiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9CiAgICByZXR1cm4gaXRlbVZpZXc7CiAgfSwKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwpOwogIH0sCiAgcmVtb3ZlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwogICAgaWYgKCF2aWV3RWwubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZpZXdFbC5yZW1vdmUoKTsKICAgIHZhciB2aWV3Q2lkID0gdmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGNoaWxkID0gdGhpcy5jaGlsZHJlblt2aWV3Q2lkXTsKICAgIGlmIChjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgcmVuZGVyQ29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24uaXNFbXB0eSgpKSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmNvbGxlY3Rpb24uZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgICB0aGlzLmFwcGVuZEl0ZW0oaXRlbSwgaSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDpjb2xsZWN0aW9uJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICAgICAgYXBwbHlWaXNpYmlsaXR5RmlsdGVyLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICB9CiAgfSwKICBlbXB0eUNsYXNzOiAnZW1wdHknLAogIHJlbmRlckVtcHR5OiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlICYmICF0aGlzLmVtcHR5VmlldykgewogICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHRoaXMsICdlbXB0eVRlbXBsYXRlJywgewogICAgICAgIGV4dGVuc2lvbjogJy1lbXB0eScsCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHt9OwogICAgICBpZiAodGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLmVtcHR5VGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5lbXB0eVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmVtcHR5VGVtcGxhdGUgJiYgdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLmVtcHR5VGVtcGxhdGUpOwogICAgfQogIH0sCiAgcmVuZGVySXRlbTogZnVuY3Rpb24obW9kZWwsIGkpIHsKICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUgJiYgIXRoaXMuaXRlbVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnaXRlbVRlbXBsYXRlJywgewogICAgICAgIGV4dGVuc2lvbjogJy1pdGVtJywKICAgICAgICAvLyBvbmx5IHJlcXVpcmUgYW4gaXRlbVRlbXBsYXRlIGlmIGFuIGl0ZW1WaWV3CiAgICAgICAgLy8gaXMgbm90IHByZXNlbnQKICAgICAgICByZXF1aXJlZDogIXRoaXMuaXRlbVZpZXcKICAgICAgfSk7CiAgICB9CiAgICBpZiAodGhpcy5pdGVtVmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgICAgbW9kZWw6IG1vZGVsCiAgICAgIH07CiAgICAgIGlmICh0aGlzLml0ZW1UZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5pdGVtVGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5pdGVtVmlldywgdmlld09wdGlvbnMpOwogICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIHJldHVybiB2aWV3OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5pdGVtVGVtcGxhdGUsIHRoaXMuaXRlbUNvbnRleHQobW9kZWwsIGkpKTsKICAgIH0KICB9LAogIGl0ZW1Db250ZXh0OiBmdW5jdGlvbihtb2RlbCAvKiwgaSAqLykgewogICAgcmV0dXJuIG1vZGVsLmF0dHJpYnV0ZXM7CiAgfSwKICBhcHBlbmRFbXB0eTogZnVuY3Rpb24oKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgJGVsLmVtcHR5KCk7CiAgICB2YXIgZW1wdHlDb250ZW50ID0gdGhpcy5yZW5kZXJFbXB0eSgpOwogICAgZW1wdHlDb250ZW50ICYmIHRoaXMuYXBwZW5kSXRlbShlbXB0eUNvbnRlbnQsIDAsIHsKICAgICAgc2lsZW50OiB0cnVlLAogICAgICBmaWx0ZXI6IGZhbHNlCiAgICB9KTsKICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6ZW1wdHknLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogIH0sCiAgZ2V0Q29sbGVjdGlvbkVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGVsZW1lbnQgPSB0aGlzLiQodGhpcy5fY29sbGVjdGlvblNlbGVjdG9yKTsKICAgIHJldHVybiBlbGVtZW50Lmxlbmd0aCA9PT0gMCA/IHRoaXMuJGVsIDogZWxlbWVudDsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICByZXNldDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBzb3J0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIGZpbHRlcjogZnVuY3Rpb24oKSB7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgLy8gSWYgd2UgcmVuZGVyZWQgd2l0aCBpdGVtIHZpZXdzLCBtb2RlbCBjaGFuZ2VzIHdpbGwgYmUgb2JzZXJ2ZWQKICAgICAgLy8gYnkgdGhlIGdlbmVyYXRlZCBpdGVtIHZpZXcgYnV0IGlmIHdlIHJlbmRlcmVkIHdpdGggdGVtcGxhdGVzCiAgICAgIC8vIHRoZW4gbW9kZWwgY2hhbmdlcyBuZWVkIHRvIGJlIGJvdW5kIGFzIG5vdGhpbmcgaXMgd2F0Y2hpbmcKICAgICAgIXRoaXMuaXRlbVZpZXcgJiYgdGhpcy51cGRhdGVJdGVtKG1vZGVsKTsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMSAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgaWYgKCRlbC5sZW5ndGgpIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbGxlY3Rpb24uaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsLCBpbmRleCk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDAgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICBlcnJvcjogZnVuY3Rpb24oY29sbGVjdGlvbiwgbWVzc2FnZSkgewogICAgICBpZiAodGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXS5lcnJvcnMpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgbWVzc2FnZSwgY29sbGVjdGlvbik7CiAgICAgIH0KICAgIH0KICB9Cn0pOwoKZnVuY3Rpb24gb25Db2xsZWN0aW9uUmVzZXQoY29sbGVjdGlvbikgewogIHZhciBvcHRpb25zID0gY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbY29sbGVjdGlvbi5jaWRdOwogIC8vIHdlIHdvdWxkIHdhbnQgdG8gc3RpbGwgcmVuZGVyIGluIHRoZSBjYXNlIHRoYXQgdGhlCiAgLy8gY29sbGVjdGlvbiBoYXMgdHJhbnNpdGlvbmVkIHRvIGJlaW5nIGZhbHN5CiAgaWYgKCFjb2xsZWN0aW9uIHx8IChvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uICYmIHRoaXMucmVuZGVyQ29sbGVjdGlvbigpOwogIH0KfQoKLy8gRXZlbiBpZiB0aGUgdmlldyBpcyBub3QgYSBDb2xsZWN0aW9uVmlldwovLyBlbnN1cmVSZW5kZXJlZCgpIHRvIHByb3ZpZGUgc2ltaWxhciBiZWhhdmlvcgovLyB0byBhIG1vZGVsCmZ1bmN0aW9uIG9uU2V0Q29sbGVjdGlvbigpIHsKICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7Cn0KCmZ1bmN0aW9uIGFwcGx5VmlzaWJpbGl0eUZpbHRlcigpIHsKICBpZiAodGhpcy5pdGVtRmlsdGVyKSB7CiAgICB0aGlzLmNvbGxlY3Rpb24uZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9LCB0aGlzKTsKICB9Cn0KCmZ1bmN0aW9uIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlcihtb2RlbCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5pdGVtRmlsdGVyICYmICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKVtpdGVtU2hvdWxkQmVWaXNpYmxlLmNhbGwodGhpcywgbW9kZWwpID8gJ3Nob3cnIDogJ2hpZGUnXSgpOwp9CgpmdW5jdGlvbiBpdGVtU2hvdWxkQmVWaXNpYmxlKG1vZGVsKSB7CiAgcmV0dXJuIHRoaXMuaXRlbUZpbHRlcihtb2RlbCwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpKTsKfQoKZnVuY3Rpb24gaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eSgpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuZW1wdHlDbGFzcyAmJiAkZWwucmVtb3ZlQ2xhc3ModGhpcy5lbXB0eUNsYXNzKTsKICAkZWwucmVtb3ZlQXR0cihjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lKTsKICAkZWwuZW1wdHkoKTsKfQoKZnVuY3Rpb24gaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eSgpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuZW1wdHlDbGFzcyAmJiAkZWwuYWRkQ2xhc3ModGhpcy5lbXB0eUNsYXNzKTsKICAkZWwuYXR0cihjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lLCB0cnVlKTsKICB0aGlzLmFwcGVuZEVtcHR5KCk7Cn0KCi8vJChzZWxlY3RvcikuY29sbGVjdGlvbigpIGhlbHBlcgokLmZuLmNvbGxlY3Rpb24gPSBmdW5jdGlvbih2aWV3KSB7CiAgaWYgKHZpZXcgJiYgdmlldy5jb2xsZWN0aW9uKSB7CiAgICByZXR1cm4gdmlldy5jb2xsZWN0aW9uOwogIH0KICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBjb2xsZWN0aW9uRWxlbWVudCA9ICR0aGlzLmNsb3Nlc3QoJ1snICsgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBjb2xsZWN0aW9uQ2lkID0gY29sbGVjdGlvbkVsZW1lbnQgJiYgY29sbGVjdGlvbkVsZW1lbnQuYXR0cihjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKGNvbGxlY3Rpb25DaWQpIHsKICAgIHZpZXcgPSAkdGhpcy52aWV3KCk7CiAgICBpZiAodmlldykgewogICAgICByZXR1cm4gdmlldy5jb2xsZWN0aW9uOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBpbmhlcml0VmFycyAqLwoKaW5oZXJpdFZhcnMubW9kZWwuZGVmYXVsdE9wdGlvbnMucG9wdWxhdGUgPSB0cnVlOwoKdmFyIG9sZE1vZGVsQ2hhbmdlID0gaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlOwppbmhlcml0VmFycy5tb2RlbC5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICBvbGRNb2RlbENoYW5nZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIC8vIFRPRE8gOiBXaGF0IGNhbiB3ZSBkbyB0byByZW1vdmUgdGhpcyBkdXBsaWNhdGlvbj8KICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5tb2RlbCAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5tb2RlbC5jaWRdOwogIGlmIChtb2RlbE9wdGlvbnMgJiYgbW9kZWxPcHRpb25zLnBvcHVsYXRlKSB7CiAgICB0aGlzLnBvcHVsYXRlKHRoaXMubW9kZWwuYXR0cmlidXRlcywgbW9kZWxPcHRpb25zLnBvcHVsYXRlID09PSB0cnVlID8ge30gOiBtb2RlbE9wdGlvbnMucG9wdWxhdGUpOwogIH0KfTsKaW5oZXJpdFZhcnMubW9kZWwuZGVmYXVsdE9wdGlvbnMucG9wdWxhdGUgPSB0cnVlOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgLy9zZXJpYWxpemVzIGEgZm9ybSBwcmVzZW50IGluIHRoZSB2aWV3LCByZXR1cm5pbmcgdGhlIHNlcmlhbGl6ZWQgZGF0YQogIC8vYXMgYW4gb2JqZWN0CiAgLy9wYXNzIHtzZXQ6ZmFsc2V9IHRvIG5vdCB1cGRhdGUgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgLy9jYW4gcGFzcyBvcHRpb25zLCBjYWxsYmFjayBvciBldmVudCBpbiBhbnkgb3JkZXIKICBzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrLCBvcHRpb25zLCBldmVudDsKICAgIC8vaWdub3JlIHVuZGVmaW5lZCBhcmd1bWVudHMgaW4gY2FzZSBldmVudCB3YXMgbnVsbAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgaWYgKCdzdG9wUHJvcGFnYXRpb24nIGluIGFyZ3VtZW50c1tpXSAmJiAncHJldmVudERlZmF1bHQnIGluIGFyZ3VtZW50c1tpXSkgewogICAgICAgICAgZXZlbnQgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGV2ZW50ICYmICF0aGlzLl9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbihldmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNldDogdHJ1ZSwKICAgICAgdmFsaWRhdGU6IHRydWUsCiAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICBzaWxlbnQ6IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgIHZhciBhdHRyaWJ1dGVzID0gb3B0aW9ucy5hdHRyaWJ1dGVzIHx8IHt9OwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgdmFyIHZpZXcgPSB0aGlzOwogICAgdmFyIGVycm9ycyA9IFtdOwogICAgZWFjaE5hbWVkSW5wdXQuY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdmlldy5fZ2V0SW5wdXRWYWx1ZSh0aGlzLCBvcHRpb25zLCBlcnJvcnMpOwogICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3NlcmlhbGl6ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkob2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldLnB1c2godmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSBbb2JqZWN0W2tleV0sIHZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdzZXJpYWxpemUnLCBhdHRyaWJ1dGVzLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy52YWxpZGF0ZSkgewogICAgICB2YXIgdmFsaWRhdGVJbnB1dEVycm9ycyA9IHRoaXMudmFsaWRhdGVJbnB1dChhdHRyaWJ1dGVzKTsKICAgICAgaWYgKHZhbGlkYXRlSW5wdXRFcnJvcnMgJiYgdmFsaWRhdGVJbnB1dEVycm9ycy5sZW5ndGgpIHsKICAgICAgICBlcnJvcnMgPSBlcnJvcnMuY29uY2F0KHZhbGlkYXRlSW5wdXRFcnJvcnMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigndmFsaWRhdGUnLCBhdHRyaWJ1dGVzLCBlcnJvcnMsIG9wdGlvbnMpOwogICAgICBpZiAoZXJyb3JzLmxlbmd0aCkgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnR9KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcywgYXR0cmlidXRlcywgXy5iaW5kKHJlc2V0U3VibWl0U3RhdGUsIHRoaXMpKTsKICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0sCgogIF9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbjogZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIHZhciBmb3JtID0gJChldmVudC50YXJnZXQpOwogICAgaWYgKChldmVudC50YXJnZXQudGFnTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSAhPT0gJ2Zvcm0nKSB7CiAgICAgIC8vIEhhbmRsZSBub24tc3VibWl0IGV2ZW50cyBieSBnYXRpbmcgb24gdGhlIGZvcm0KICAgICAgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCdmb3JtJyk7CiAgICB9CgogICAgaWYgKCFmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKSkgewogICAgICBmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnLCAndHJ1ZScpOwogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvL3BvcHVsYXRlIGEgZm9ybSBmcm9tIHRoZSBwYXNzZWQgYXR0cmlidXRlcyBvciB0aGlzLm1vZGVsIGlmIHByZXNlbnQKICBwb3B1bGF0ZTogZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgY2hpbGRyZW46IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgIHZhciB2YWx1ZSwKICAgICAgICBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CgogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUuY2FsbCh0aGlzLCBhdHRyaWJ1dGVzLCB0aGlzLm5hbWUsIHttb2RlOiAncG9wdWxhdGUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICB2YWx1ZSA9IG9iamVjdCAmJiBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgLy93aWxsIG9ubHkgZXhlY3V0ZSBpZiB3ZSBoYXZlIGEgbmFtZSB0aGF0IG1hdGNoZXMgdGhlIHN0cnVjdHVyZSBpbiBhdHRyaWJ1dGVzCiAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnICYmIF8uaXNCb29sZWFuKHZhbHVlKSkgewogICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnIHx8IHRoaXMudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSB2YWx1ZSA9PSB0aGlzLnZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICB0aGlzLnRyaWdnZXIoJ3BvcHVsYXRlJywgYXR0cmlidXRlcyk7CiAgfSwKCiAgLy9wZXJmb3JtIGZvcm0gdmFsaWRhdGlvbiwgaW1wbGVtZW50ZWQgYnkgY2hpbGQgY2xhc3MKICB2YWxpZGF0ZUlucHV0OiBmdW5jdGlvbigvKiBhdHRyaWJ1dGVzLCBvcHRpb25zLCBlcnJvcnMgKi8pIHt9LAoKICBfZ2V0SW5wdXRWYWx1ZTogZnVuY3Rpb24oaW5wdXQgLyogLCBvcHRpb25zLCBlcnJvcnMgKi8pIHsKICAgIGlmIChpbnB1dC50eXBlID09PSAnY2hlY2tib3gnIHx8IGlucHV0LnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgaWYgKGlucHV0LmNoZWNrZWQpIHsKICAgICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaW5wdXQubXVsdGlwbGUgPT09IHRydWUpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAkKCdvcHRpb24nLCBpbnB1dCkuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZCkgewogICAgICAgICAgdmFsdWVzLnB1c2godGhpcy52YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnB1dC52YWx1ZTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGVycm9yOiBmdW5jdGlvbigpIHsKICAgIHJlc2V0U3VibWl0U3RhdGUuY2FsbCh0aGlzKTsKCiAgICAvLyBJZiB3ZSBlcnJvcmVkIHdpdGggYSBtb2RlbCB3ZSB3YW50IHRvIHJlc2V0IHRoZSBjb250ZW50IGJ1dCBsZWF2ZSB0aGUgVUkKICAgIC8vIGludGFjdC4gSWYgdGhlIHVzZXIgdXBkYXRlcyB0aGUgZGF0YSBhbmQgc2VyaWFsaXplcyBhbnkgb3ZlcndyaXR0ZW4gZGF0YQogICAgLy8gd2lsbCBiZSByZXN0b3JlZC4KICAgIGlmICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKCksIHsKICAgICAgICBzaWxlbnQ6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSwKICBkZWFjdGl2YXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CiAgfQp9KTsKCmZ1bmN0aW9uIGVhY2hOYW1lZElucHV0KG9wdGlvbnMsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIGkgPSAwLAogICAgICBzZWxmID0gdGhpczsKCiAgdGhpcy4kKCdzZWxlY3QsaW5wdXQsdGV4dGFyZWEnLCBvcHRpb25zLnJvb3QgfHwgdGhpcy5lbCkuZWFjaChmdW5jdGlvbigpIHsKICAgIGlmICghb3B0aW9ucy5jaGlsZHJlbikgewogICAgICBpZiAoc2VsZiAhPT0gJCh0aGlzKS52aWV3KHtoZWxwZXI6IGZhbHNlfSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnR5cGUgIT09ICdidXR0b24nICYmIHRoaXMudHlwZSAhPT0gJ2NhbmNlbCcgJiYgdGhpcy50eXBlICE9PSAnc3VibWl0JyAmJiB0aGlzLm5hbWUgJiYgdGhpcy5uYW1lICE9PSAnJykgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgaSwgdGhpcyk7CiAgICAgICsraTsKICAgIH0KICB9KTsKfQoKLy9jYWxscyBhIGNhbGxiYWNrIHdpdGggdGhlIGNvcnJlY3Qgb2JqZWN0IGZyYWdtZW50IGFuZCBrZXkgZnJvbSBhIGNvbXBvdW5kIG5hbWUKZnVuY3Rpb24gb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgdmFyIGtleSwKICAgICAgb2JqZWN0ID0gYXR0cmlidXRlcywKICAgICAga2V5cyA9IG5hbWUuc3BsaXQoJ1snKSwKICAgICAgbW9kZSA9IG9wdGlvbnMubW9kZTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aCAtIDE7ICsraSkgewogICAga2V5ID0ga2V5c1tpXS5yZXBsYWNlKCddJywgJycpOwogICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICBpZiAobW9kZSA9PT0gJ3NlcmlhbGl6ZScpIHsKICAgICAgICBvYmplY3Rba2V5XSA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIGZhbHNlLCBrZXkpOwogICAgICB9CiAgICB9CiAgICBvYmplY3QgPSBvYmplY3Rba2V5XTsKICB9CiAga2V5ID0ga2V5c1trZXlzLmxlbmd0aCAtIDFdLnJlcGxhY2UoJ10nLCAnJyk7CiAgY2FsbGJhY2suY2FsbCh0aGlzLCBvYmplY3QsIGtleSk7Cn0KCmZ1bmN0aW9uIHJlc2V0U3VibWl0U3RhdGUoKSB7CiAgdGhpcy4kKCdmb3JtJykucmVtb3ZlQXR0cignZGF0YS1zdWJtaXQtd2FpdCcpOwp9Cgo7Owp2YXIgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWxheW91dC1jaWQnOwoKVGhvcmF4LkxheW91dFZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMudGVtcGxhdGUgPT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICAvLyBpZiB0aGVyZSBpcyBubyB0ZW1wbGF0ZSBzZXRWaWV3IHdpbGwgYXBwZW5kIHRvIHRoaXMuJGVsCiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYSB0ZW1wbGF0ZSB3YXMgc3BlY2lmaWVkIGlzIG11c3QgZGVjbGFyZSBhIGxheW91dC1lbGVtZW50CiAgICAgIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlLAogICAgICBkZXN0cm95OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmIChfLmlzU3RyaW5nKHZpZXcpKSB7CiAgICAgIHZpZXcgPSBuZXcgKFRob3JheC5VdGlsLnJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgdmlldywgZmFsc2UpKSgpOwogICAgfQogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgdmFyIG9sZFZpZXcgPSB0aGlzLl92aWV3OwogICAgaWYgKHZpZXcgPT09IG9sZFZpZXcpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKG9wdGlvbnMuZGVzdHJveSAmJiB2aWV3KSB7CiAgICAgIHZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3ID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OnN0YXJ0Jywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CgogICAgaWYgKG9sZFZpZXcpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQob2xkVmlldyk7CiAgICAgIG9sZFZpZXcuJGVsLnJlbW92ZSgpOwogICAgICB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQuY2FsbChvbGRWaWV3LCAnZGVhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgaWYgKG9sZFZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3KSB7CiAgICAgICAgb2xkVmlldy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodmlldykgewogICAgICB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQuY2FsbCh0aGlzLCAnYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIHZpZXcudHJpZ2dlcignYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIHRoaXMuX2FkZENoaWxkKHZpZXcpOwogICAgICB0aGlzLl92aWV3ID0gdmlldzsKICAgICAgdGhpcy5fdmlldy5hcHBlbmRUbyhnZXRMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQuY2FsbCh0aGlzKSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl92aWV3ID0gdW5kZWZpbmVkOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6ZW5kJywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBnZXRWaWV3OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl92aWV3OwogIH0KfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsYXlvdXQtZWxlbWVudCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgLy8gZHVjayB0eXBlIGNoZWNrIGZvciBMYXlvdXRWaWV3CiAgaWYgKCF2aWV3LmdldFZpZXcpIHsKICAgIHRocm93IG5ldyBFcnJvcignbGF5b3V0LWVsZW1lbnQgbXVzdCBiZSB1c2VkIHdpdGhpbiBhIExheW91dFZpZXcnKTsKICB9CiAgb3B0aW9ucy5oYXNoW2xheW91dENpZEF0dHJpYnV0ZU5hbWVdID0gdmlldy5jaWQ7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBvcHRpb25zLmhhc2gsICcnLCB0aGlzKSk7Cn0pOwoKZnVuY3Rpb24gdHJpZ2dlckxpZmVjeWNsZUV2ZW50KGV2ZW50TmFtZSwgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIG9wdGlvbnMudGFyZ2V0ID0gdGhpczsKICB0aGlzLnRyaWdnZXIoZXZlbnROYW1lLCBvcHRpb25zKTsKICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgIGNoaWxkLnRyaWdnZXIoZXZlbnROYW1lLCBvcHRpb25zKTsKICB9KTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Q2lkKCkgewogICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgLy9zZXQgdGhlIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgb24gdGhpcy4kZWwgaWYgdGhlcmUgd2FzIG5vIHRlbXBsYXRlCiAgdGhpcy4kZWwuYXR0cihsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lLCB0aGlzLmNpZCk7Cn0KCmZ1bmN0aW9uIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudCgpIHsKICBpZiAoIXRoaXMuJCgnWycgKyBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHRoaXMuY2lkICsgJyJdJylbMF0pIHsKICAgIHRocm93IG5ldyBFcnJvcignTm8gbGF5b3V0IGVsZW1lbnQgZm91bmQgaW4gJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpKTsKICB9Cn0KCmZ1bmN0aW9uIGdldExheW91dFZpZXdzVGFyZ2V0RWxlbWVudCgpIHsKICByZXR1cm4gdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSB8fCB0aGlzLmVsWzBdIHx8IHRoaXMuZWw7Cn0KCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciAqLwoKLy9Sb3V0ZXIKZnVuY3Rpb24gaW5pdGlhbGl6ZVJvdXRlcigpIHsKICBCYWNrYm9uZS5oaXN0b3J5IHx8IChCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEJhY2tib25lLkhpc3RvcnkoKSk7CiAgQmFja2JvbmUuaGlzdG9yeS5vbigncm91dGUnLCBvblJvdXRlLCB0aGlzKTsKICAvL3JvdXRlciBkb2VzIG5vdCBoYXZlIGEgYnVpbHQgaW4gZGVzdHJveSBldmVudAogIC8vYnV0IFZpZXdDb250cm9sbGVyIGRvZXMKICB0aGlzLm9uKCdkZXN0cm95ZWQnLCBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIH0pOwp9CgpUaG9yYXguUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlJvdXRlci5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGluaXRpYWxpemVSb3V0ZXIuY2FsbCh0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgfQogICAgLy9hZGQgYSByb3V0ZTpiZWZvcmUgZXZlbnQgdGhhdCBpcyBmaXJlZCBiZWZvcmUgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAgcmV0dXJuIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUucm91dGUuY2FsbCh0aGlzLCByb3V0ZSwgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOmJlZm9yZScsIHJvdXRlLCBuYW1lXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0pOwogIH0KfSk7CgpUaG9yYXguUm91dGVycyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4LlJvdXRlciwgVGhvcmF4LlJvdXRlcnMpOwoKZnVuY3Rpb24gb25Sb3V0ZShyb3V0ZXIgLyogLCBuYW1lICovKSB7CiAgaWYgKHRoaXMgPT09IHJvdXRlcikgewogICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGUnXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH0KfQoKOzsKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3ID0gVGhvcmF4LkNvbGxlY3Rpb25WaWV3LmV4dGVuZCh7CiAgLy8gRm9yd2FyZCByZW5kZXIgZXZlbnRzIHRvIHRoZSBwYXJlbnQKICBldmVudHM6IHsKICAgICdyZW5kZXJlZDppdGVtJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDppdGVtJyksCiAgICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6Y29sbGVjdGlvbicpLAogICAgJ3JlbmRlcmVkOmVtcHR5JzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDplbXB0eScpCiAgfSwKCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIF8uZWFjaChjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGZ1bmN0aW9uKHZpZXdBdHRyaWJ1dGVOYW1lLCBoZWxwZXJPcHRpb25OYW1lKSB7CiAgICAgIGlmIChvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV0pIHsKICAgICAgICB2YXIgdmFsdWUgPSBvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV07CiAgICAgICAgaWYgKHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnaXRlbVRlbXBsYXRlJyB8fCB2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2VtcHR5VGVtcGxhdGUnKSB7CiAgICAgICAgICB2YWx1ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9uc1t2aWV3QXR0cmlidXRlTmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguSGVscGVyVmlldy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgaWYgKHRoaXMucGFyZW50Lm5hbWUpIHsKICAgICAgaWYgKCF0aGlzLmVtcHR5VGVtcGxhdGUpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICAvLyBpdGVtIHRlbXBsYXRlIG11c3QgYmUgcHJlc2VudCBpZiBhbiBpdGVtVmlldyBpcyBub3QKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCAhIXRoaXMuaXRlbVZpZXcpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oKSB7CiAgICBfLmVhY2goZm9yd2FyZGFibGVQcm9wZXJ0aWVzLCBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudC5pdGVtRmlsdGVyICYmICF0aGlzLml0ZW1GaWx0ZXIpIHsKICAgICAgdGhpcy5pdGVtRmlsdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy5wYXJlbnQuaXRlbUNvbnRleHQpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5pdGVtQ29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgaGVscGVyVmlld1Byb3RvdHlwZSk7Cgp2YXIgY29sbGVjdGlvbk9wdGlvbk5hbWVzID0gewogICdpdGVtLXRlbXBsYXRlJzogJ2l0ZW1UZW1wbGF0ZScsCiAgJ2VtcHR5LXRlbXBsYXRlJzogJ2VtcHR5VGVtcGxhdGUnLAogICdpdGVtLXZpZXcnOiAnaXRlbVZpZXcnLAogICdlbXB0eS12aWV3JzogJ2VtcHR5VmlldycsCiAgJ2VtcHR5LWNsYXNzJzogJ2VtcHR5Q2xhc3MnCn07CgpmdW5jdGlvbiBmb3J3YXJkUmVuZGVyRXZlbnQoZXZlbnROYW1lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKTsKICAgIGFyZ3MudW5zaGlmdChldmVudE5hbWUpOwogICAgdGhpcy5wYXJlbnQudHJpZ2dlci5hcHBseSh0aGlzLnBhcmVudCwgYXJncyk7CiAgfQp9Cgp2YXIgZm9yd2FyZGFibGVQcm9wZXJ0aWVzID0gWwogICdpdGVtVGVtcGxhdGUnLAogICdpdGVtVmlldycsCiAgJ2VtcHR5VGVtcGxhdGUnLAogICdlbXB0eVZpZXcnCl07CgpmdW5jdGlvbiBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5KHByb3BlcnR5TmFtZSkgewogIHZhciBwYXJlbnQgPSBnZXRQYXJlbnQodGhpcyk7CiAgaWYgKCF0aGlzW3Byb3BlcnR5TmFtZV0pIHsKICAgIHZhciBwcm9wID0gcGFyZW50W3Byb3BlcnR5TmFtZV07CiAgICBpZiAocHJvcCl7CiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHByb3A7CiAgICB9CiAgfQp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignY29sbGVjdGlvbicsIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldywgZnVuY3Rpb24oY29sbGVjdGlvbiwgdmlldykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSB2aWV3LnBhcmVudC5jb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiAmJiB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogICAgLy8gcHJvcGFnYXRlIGZ1dHVyZSBjaGFuZ2VzIHRvIHRoZSBwYXJlbnQncyBjb2xsZWN0aW9uIG9iamVjdAogICAgLy8gdG8gdGhlIGhlbHBlciB2aWV3CiAgICB2aWV3Lmxpc3RlblRvKHZpZXcucGFyZW50LCAnY2hhbmdlOmRhdGEtb2JqZWN0JywgZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCkgewogICAgICBpZiAodHlwZSA9PT0gJ2NvbGxlY3Rpb24nKSB7CiAgICAgICAgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICAgICAgdmlldy5zZXRDb2xsZWN0aW9uKGRhdGFPYmplY3QpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29sbGVjdGlvbiAmJiB2aWV3LnNldENvbGxlY3Rpb24oY29sbGVjdGlvbik7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY29sbGVjdGlvbi1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIGlmICghZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJDb2xsZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImNvbGxlY3Rpb24tZWxlbWVudCBoZWxwZXIgbXVzdCBiZSBkZWNsYXJlZCBpbnNpZGUgb2YgYSBDb2xsZWN0aW9uVmlldyIpOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgaGFzaFtjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBoYXNoLCAnJywgdGhpcykpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VtcHR5JywgZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gZGF0YU9iamVjdDsKICB9CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBkYXRhT2JqZWN0ID0gdmlldy5tb2RlbDsKICB9CiAgLy8gbGlzdGVuZXJzIGZvciB0aGUgZW1wdHkgaGVscGVyIHJhdGhlciB0aGFuIGxpc3RlbmVycwogIC8vIHRoYXQgYXJlIHRoZW1zZWx2ZXMgZW1wdHkKICBpZiAoIXZpZXcuX2VtcHR5TGlzdGVuZXJzKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVycyA9IHt9OwogIH0KICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIGNvbGxlY3Rpb24KICBpZiAoZGF0YU9iamVjdCAmJiAhdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdICYmIGRhdGFPYmplY3QubW9kZWxzICYmICgnbGVuZ3RoJyBpbiBkYXRhT2JqZWN0KSkgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdID0gdHJ1ZTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3JlbW92ZScsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDApIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3Jlc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICB9KTsKICB9CiAgcmV0dXJuICFkYXRhT2JqZWN0IHx8IGRhdGFPYmplY3QuaXNFbXB0eSgpID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB2YXIgZnJhZ21lbnQ7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICBmcmFnbWVudCA9IF8ubWFwKF8uaGVhZChhcmd1bWVudHMsIGFyZ3VtZW50cy5sZW5ndGggLSAxKSwgZW5jb2RlVVJJQ29tcG9uZW50KS5qb2luKCcvJyk7CiAgfSBlbHNlIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdLAogICAgICAgIGhhc2ggPSAob3B0aW9ucyAmJiBvcHRpb25zLmhhc2gpIHx8IG9wdGlvbnM7CiAgICBpZiAoaGFzaCAmJiBoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgICAgZnJhZ21lbnQgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih1cmwsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgZnJhZ21lbnQgPSB1cmw7CiAgICB9CiAgfQogIHJldHVybiAoQmFja2JvbmUuaGlzdG9yeS5faGFzUHVzaFN0YXRlID8gQmFja2JvbmUuaGlzdG9yeS5vcHRpb25zLnJvb3QgOiAnIycpICsgZnJhZ21lbnQ7Cn0pOwoKOzsKLypnbG9iYWwgdmlld1RlbXBsYXRlT3ZlcnJpZGVzICovCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCd2aWV3JywgewogIGZhY3Rvcnk6IGZ1bmN0aW9uKGFyZ3MsIG9wdGlvbnMpIHsKICAgIHZhciBWaWV3ID0gYXJncy5sZW5ndGggPj0gMSA/IGFyZ3NbMF0gOiBUaG9yYXguVmlldzsKICAgIHJldHVybiBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UoVmlldywgb3B0aW9ucy5vcHRpb25zKTsKICB9LAogIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgdmlld1RlbXBsYXRlT3ZlcnJpZGVzW3BsYWNlaG9sZGVySWRdID0gb3B0aW9ucy5mbjsKICAgIH0KICB9Cn0pOwoKOzsKdmFyIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY2FsbC1tZXRob2QnLAogICAgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLXRyaWdnZXItZXZlbnQnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYnV0dG9uJywgZnVuY3Rpb24obWV0aG9kLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBtZXRob2Q7CiAgICBtZXRob2QgPSBvcHRpb25zLmhhc2gubWV0aG9kOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCFtZXRob2QgJiYgIW9wdGlvbnMuaGFzaC50cmlnZ2VyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImJ1dHRvbiBoZWxwZXIgbXVzdCBoYXZlIGEgbWV0aG9kIG5hbWUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGEgJ3RyaWdnZXInLCBvciBhICdtZXRob2QnIGF0dHJpYnV0ZSBzcGVjaWZpZWQuIik7CiAgfQogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYnV0dG9uJzsKICBoYXNoLnRyaWdnZXIgJiYgKGhhc2hbdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZV0gPSBoYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgbWV0aG9kICYmIChoYXNoW2NhbGxNZXRob2RBdHRyaWJ1dGVOYW1lXSA9IG1ldGhvZCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGhhc2gsIG9wdGlvbnMuZm4gPyBvcHRpb25zLmZuKHRoaXMpIDogJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGluaycsIGZ1bmN0aW9uKCkgewogIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgIG9wdGlvbnMgPSBhcmdzLnBvcCgpLAogICAgICBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICAvLyB1cmwgaXMgYW4gYXJyYXkgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgdXJsIGhlbHBlcgogICAgICB1cmwgPSBhcmdzLmxlbmd0aCA9PT0gMCA/IFtoYXNoLmhyZWZdIDogYXJncywKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCF1cmxbMF0gJiYgdXJsWzBdICE9PSAnJykgewogICAgdGhyb3cgbmV3IEVycm9yKCJsaW5rIGhlbHBlciByZXF1aXJlcyBhbiBocmVmIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhbiAnaHJlZicgYXR0cmlidXRlIik7CiAgfQogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIHVybC5wdXNoKG9wdGlvbnMpOwogIGhhc2guaHJlZiA9IEhhbmRsZWJhcnMuaGVscGVycy51cmwuYXBwbHkodGhpcywgdXJsKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2EnOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IG9wdGlvbnMuaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gJ19hbmNob3JDbGljayc7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGhhc2gsIG9wdGlvbnMuZm4gPyBvcHRpb25zLmZuKHRoaXMpIDogJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7Cn0pOwoKdmFyIGNsaWNrU2VsZWN0b3IgPSAnWycgKyBjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSArICddLCBbJyArIHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUgKyAnXSc7CgpmdW5jdGlvbiBoYW5kbGVDbGljayhldmVudCkgewogIHZhciB0YXJnZXQgPSAkKGV2ZW50LnRhcmdldCksCiAgICAgIHZpZXcgPSB0YXJnZXQudmlldyh7aGVscGVyOiBmYWxzZX0pLAogICAgICBtZXRob2ROYW1lID0gdGFyZ2V0LmF0dHIoY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUpLAogICAgICBldmVudE5hbWUgPSB0YXJnZXQuYXR0cih0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lKSwKICAgICAgbWV0aG9kUmVzcG9uc2UgPSBmYWxzZTsKICBtZXRob2ROYW1lICYmIChtZXRob2RSZXNwb25zZSA9IHZpZXdbbWV0aG9kTmFtZV0uY2FsbCh2aWV3LCBldmVudCkpOwogIGV2ZW50TmFtZSAmJiB2aWV3LnRyaWdnZXIoZXZlbnROYW1lLCBldmVudCk7CiAgdGFyZ2V0LnRhZ05hbWUgPT09ICJBIiAmJiBtZXRob2RSZXNwb25zZSA9PT0gZmFsc2UgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKdmFyIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWU7CgpmdW5jdGlvbiByZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSA9IFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lIHx8ICdjbGljayc7CiAgJChkb2N1bWVudCkub24obGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgpmdW5jdGlvbiB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgJiYgJChkb2N1bWVudCkub2ZmKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgaWYgKCFUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSkgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0pOwoKOzsKdmFyIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1lbGVtZW50LXRtcCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbGVtZW50JywgZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIGh0bWxBdHRyaWJ1dGVzID0gXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpOwogIGh0bWxBdHRyaWJ1dGVzW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaHRtbEF0dHJpYnV0ZXMpKTsKfSk7CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciAkZWwgPSAkKGVsKSwKICAgICAgICBjaWQgPSAkZWwuYXR0cihlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBlbGVtZW50ID0gdGhpcy5fZWxlbWVudHNCeUNpZFtjaWRdOwogICAgLy8gQSBjYWxsYmFjayBmdW5jdGlvbiBtYXkgYmUgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZQogICAgaWYgKF8uaXNGdW5jdGlvbihlbGVtZW50KSkgewogICAgICBlbGVtZW50ID0gZWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgJGVsLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZWxlbWVudCk7CiAgfSwgdGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3VwZXInLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBwYXJlbnQgPSBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yICYmIGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IuX19zdXBlcl9fOwogIGlmIChwYXJlbnQpIHsKICAgIHZhciB0ZW1wbGF0ZSA9IHBhcmVudC50ZW1wbGF0ZTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgaWYgKCFwYXJlbnQubmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSBzdXBlciBoZWxwZXIgd2hlbiBwYXJlbnQgaGFzIG5vIG5hbWUgb3IgdGVtcGxhdGUuJyk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBwYXJlbnQubmFtZTsKICAgIH0KICAgIGlmIChfLmlzU3RyaW5nKHRlbXBsYXRlKSkgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRlbXBsYXRlLCBmYWxzZSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycyAqLwoKdmFyIGxvYWRTdGFydCA9ICdsb2FkOnN0YXJ0JywKICAgIGxvYWRFbmQgPSAnbG9hZDplbmQnLAogICAgcm9vdE9iamVjdDsKClRob3JheC5zZXRSb290T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgcm9vdE9iamVjdCA9IG9iajsKfTsKClRob3JheC5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIGNvbnRleHQpIHsKICB2YXIgbG9hZENvdW50ZXIgPSBfLnVuaXF1ZUlkKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgdmFyIHNlbGYgPSBjb250ZXh0IHx8IHRoaXM7CiAgICBzZWxmLl9sb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvIHx8IFtdOwogICAgdmFyIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdOwoKICAgIGZ1bmN0aW9uIHN0YXJ0TG9hZFRpbWVvdXQoKSB7CgogICAgICAvLyBJZiB0aGUgdGltZW91dCBoYXMgYmVlbiBzZXQgYWxyZWFkeSBidXQgaGFzIG5vdCB0cmlnZ2VyZWQgeWV0IGRvIG5vdGhpbmcKICAgICAgLy8gT3RoZXJ3aXNlIHNldCBhIG5ldyB0aW1lb3V0IChlaXRoZXIgaW5pdGlhbCBvciBmb3IgZ29pbmcgZnJvbSBiYWNrZ3JvdW5kIHRvCiAgICAgIC8vIG5vbi1iYWNrZ3JvdW5kIGxvYWRpbmcpCiAgICAgIGlmIChsb2FkSW5mby50aW1lb3V0ICYmICFsb2FkSW5mby5ydW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsb2FkaW5nVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gIT09IHVuZGVmaW5lZCA/CiAgICAgICAgc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiA6IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbjsKICAgICAgbG9hZEluZm8udGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICBzdGFydC5jYWxsKHNlbGYsIGxvYWRJbmZvLm1lc3NhZ2UsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkU3RhcnQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBQcmV2ZW50IGJpbmRzIHRvIHRoZSBzYW1lIG9iamVjdCBtdWx0aXBsZSB0aW1lcyBhcyB0aGlzIGNhbiBjYXVzZSB2ZXJ5IGJhZCB0aGluZ3MKICAgIC8vIHRvIGhhcHBlbiBmb3IgdGhlIGxvYWQ7bG9hZDtlbmQ7ZW5kIGV4ZWN1dGlvbiBmbG93LgogICAgaWYgKGxvYWRJbmZvLmV2ZW50cy5pbmRleE9mKG9iamVjdCkgPj0gMCkgewogICAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwogICAgICByZXR1cm47CiAgICB9CgogICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKCiAgICBvYmplY3Qub24obG9hZEVuZCwgZnVuY3Rpb24gZW5kQ2FsbGJhY2soKSB7CiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IGV2ZW50cy5pbmRleE9mKG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgZXZlbnRzLnNwbGljZShpbmRleCwgMSk7CgogICAgICAgIGlmIChldmVudHMuaW5kZXhPZihvYmplY3QpIDwgMCkgewogICAgICAgICAgLy8gTGFzdCBjYWxsYmFjayBmb3IgdGhpcyBwYXJ0aWNsYXIgb2JqZWN0LCByZW1vdmUgdGhlIGJpbmQKICAgICAgICAgIG9iamVjdC5vZmYobG9hZEVuZCwgZW5kQ2FsbGJhY2spOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLmVuZFRpbWVvdXQpOwogICAgICAgIGxvYWRJbmZvLmVuZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIHJ1biA9IGxvYWRJbmZvLnJ1bjsKCiAgICAgICAgICAgICAgaWYgKHJ1bikgewogICAgICAgICAgICAgICAgLy8gRW1pdCB0aGUgZW5kIGJlaGF2aW9yLCBidXQgb25seSBpZiB0aGVyZSBpcyBhIHBhaXJlZCBzdGFydAogICAgICAgICAgICAgICAgZW5kLmNhbGwoc2VsZiwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgICAgICAgbG9hZEluZm8udHJpZ2dlcihsb2FkRW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBJZiBzdG9wcGluZyBtYWtlIHN1cmUgd2UgZG9uJ3QgcnVuIGEgc3RhcnQKICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8udGltZW91dCk7CiAgICAgICAgICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkRW5kJywgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgbG9hZGluZ0VuZFRpbWVvdXQgKiAxMDAwKTsKICAgICAgfQogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBIZWxwZXIgbWV0aG9kIGZvciBwcm9wYWdhdGluZyBsb2FkOnN0YXJ0IGV2ZW50cyB0byBvdGhlciBvYmplY3RzLgogKgogKiBGb3J3YXJkcyBsb2FkOnN0YXJ0IGV2ZW50cyB0aGF0IG9jY3VyIG9uIGBzb3VyY2VgIHRvIGBkZXN0YC4KICovClRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyA9IGZ1bmN0aW9uKHNvdXJjZSwgZGVzdCwgb25jZSkgewogIGZ1bmN0aW9uIGxvYWQobWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpIHsKICAgIGlmIChvbmNlKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICAgIGRlc3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KTsKICB9CiAgc291cmNlLm9uKGxvYWRTdGFydCwgbG9hZCk7CiAgcmV0dXJuIHsKICAgIG9mZjogZnVuY3Rpb24oKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICB9Owp9OwoKLy8KLy8gRGF0YSBsb2FkIGV2ZW50IGdlbmVyYXRpb24KLy8KCi8qKgogKiBNaXhpbmcgZm9yIGdlbmVyYXRpbmcgbG9hZDpzdGFydCBhbmQgbG9hZDplbmQgZXZlbnRzLgogKi8KVGhvcmF4Lm1peGluTG9hZGFibGUgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgLy9sb2FkaW5nIGNvbmZpZwogICAgX2xvYWRpbmdDbGFzc05hbWU6ICdsb2FkaW5nJywKICAgIF9sb2FkaW5nVGltZW91dER1cmF0aW9uOiAwLjMzLAogICAgX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb246IDAuMTAsCgogICAgLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgogICAgb25Mb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgdGhhdC5faXNMb2FkaW5nID0gdHJ1ZTsKICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcnMKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdzdGFydCcpOwogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IGZhbHNlOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVyCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnZW5kJyk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIHRoYXQpOwogICAgfSwKICAgIGxvYWRFbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRFbmQsIHRoYXQpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKCgppZiAoVGhvcmF4LkhlbHBlclZpZXcpIHsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KCmlmIChUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcpIHsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKfQoKVGhvcmF4LnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIGRhdGFPYmosIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgc2VsZi5fcmVxdWVzdCA9IHVuZGVmaW5lZDsKICAgIHNlbGYuX2Fib3J0ZWQgPSBmYWxzZTsKCiAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgdGhpcy5fcmVxdWVzdCA9IEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgcmV0dXJuIHRoaXMuX3JlcXVlc3Q7Cn07CgpmdW5jdGlvbiBiaW5kVG9Sb3V0ZShjYWxsYmFjaywgZmFpbGJhY2spIHsKICB2YXIgZnJhZ21lbnQgPSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCksCiAgICAgIHJvdXRlQ2hhbmdlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiByb3V0ZUhhbmRsZXIoKSB7CiAgICBpZiAoZnJhZ21lbnQgPT09IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb3V0ZUNoYW5nZWQgPSB0cnVlOwogICAgcmVzLmNhbmNlbCgpOwogICAgZmFpbGJhY2sgJiYgZmFpbGJhY2soKTsKICB9CgogIEJhY2tib25lLmhpc3Rvcnkub24oJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKCiAgZnVuY3Rpb24gZmluYWxpemVyKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKICAgIGlmICghcm91dGVDaGFuZ2VkKSB7CiAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQoKICB2YXIgcmVzID0gXy5iaW5kKGZpbmFsaXplciwgdGhpcyk7CiAgcmVzLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKICB9OwoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBsb2FkRGF0YShjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpIHsKICBpZiAodGhpcy5pc1BvcHVsYXRlZCgpKSB7CiAgICByZXR1cm4gY2FsbGJhY2sodGhpcyk7CiAgfQoKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiAhXy5pc0Z1bmN0aW9uKGZhaWxiYWNrKSAmJiBfLmlzT2JqZWN0KGZhaWxiYWNrKSkgewogICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgZmFpbGJhY2sgPSBmYWxzZTsKICB9CgogIHZhciBzZWxmID0gdGhpcywKICAgICAgcm91dGVDaGFuZ2VkID0gZmFsc2UsCiAgICAgIHN1Y2Nlc3NDYWxsYmFjayA9IGJpbmRUb1JvdXRlKF8uYmluZChjYWxsYmFjaywgc2VsZiksIGZ1bmN0aW9uKCkgewogICAgICAgIHJvdXRlQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgaWYgKHNlbGYuX3JlcXVlc3QpIHsKICAgICAgICAgIHNlbGYuX2Fib3J0ZWQgPSB0cnVlOwogICAgICAgICAgc2VsZi5fcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIH0KICAgICAgICBmYWlsYmFjayAmJiBmYWlsYmFjay5jYWxsKHNlbGYsIGZhbHNlKTsKICAgICAgfSk7CgogIHRoaXMuZmV0Y2goXy5kZWZhdWx0cyh7CiAgICBzdWNjZXNzOiBzdWNjZXNzQ2FsbGJhY2ssCiAgICBlcnJvcjogZmFpbGJhY2sgJiYgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghcm91dGVDaGFuZ2VkKSB7CiAgICAgICAgZmFpbGJhY2suYXBwbHkoc2VsZiwgW3RydWVdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICB9CiAgICB9LAogICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICBzdWNjZXNzQ2FsbGJhY2suY2FuY2VsKCk7CiAgICB9CiAgfSwgb3B0aW9ucykpOwp9CgpmdW5jdGlvbiBmZXRjaFF1ZXVlKG9wdGlvbnMsICRzdXBlcikgewogIGlmIChvcHRpb25zLnJlc2V0UXVldWUpIHsKICAgIC8vIFdBUk46IFNob3VsZCBlbnN1cmUgdGhhdCBsb2FkZXJzIGFyZSBwcm90ZWN0ZWQgZnJvbSBvdXQgb2YgYmFuZCBkYXRhCiAgICAvLyAgICB3aGVuIHVzaW5nIHRoaXMgb3B0aW9uCiAgICB0aGlzLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAoIXRoaXMuZmV0Y2hRdWV1ZSkgewogICAgLy8gS2ljayBvZmYgdGhlIHJlcXVlc3QKICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IFtvcHRpb25zXTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHsKICAgICAgc3VjY2VzczogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdzdWNjZXNzJyksCiAgICAgIGVycm9yOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2Vycm9yJyksCiAgICAgIGNvbXBsZXRlOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2NvbXBsZXRlJykKICAgIH0sIG9wdGlvbnMpOwogICAgJHN1cGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfSBlbHNlIHsKICAgIC8vIEN1cnJlbnRseSBmZXRjaGluZy4gUXVldWUgYW5kIHByb2Nlc3Mgb25jZSBjb21wbGV0ZQogICAgdGhpcy5mZXRjaFF1ZXVlLnB1c2gob3B0aW9ucyk7CiAgfQp9CgpmdW5jdGlvbiBmbHVzaFF1ZXVlKHNlbGYsIGZldGNoUXVldWUsIGhhbmRsZXIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCiAgICAvLyBGbHVzaCB0aGUgcXVldWUuIEV4ZWN1dGVzIGFueSBjYWxsYmFjayBoYW5kbGVycyB0aGF0CiAgICAvLyBtYXkgaGF2ZSBiZWVuIHBhc3NlZCBpbiB0aGUgZmV0Y2ggb3B0aW9ucy4KICAgIF8uZWFjaChmZXRjaFF1ZXVlLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zW2hhbmRsZXJdKSB7CiAgICAgICAgb3B0aW9uc1toYW5kbGVyXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSwgdGhpcyk7CgogICAgLy8gUmVzZXQgdGhlIHF1ZXVlIGlmIHdlIGFyZSBzdGlsbCB0aGUgYWN0aXZlIHJlcXVlc3QKICAgIGlmIChzZWxmLmZldGNoUXVldWUgPT09IGZldGNoUXVldWUpIHsKICAgICAgc2VsZi5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogICAgfQogIH07Cn0KCnZhciBrbGFzc2VzID0gW107ClRob3JheC5Nb2RlbCAmJiBrbGFzc2VzLnB1c2goVGhvcmF4Lk1vZGVsKTsKVGhvcmF4LkNvbGxlY3Rpb24gJiYga2xhc3Nlcy5wdXNoKFRob3JheC5Db2xsZWN0aW9uKTsKCl8uZWFjaChrbGFzc2VzLCBmdW5jdGlvbihEYXRhQ2xhc3MpIHsKICB2YXIgJGZldGNoID0gRGF0YUNsYXNzLnByb3RvdHlwZS5mZXRjaDsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhEYXRhQ2xhc3MucHJvdG90eXBlLCBmYWxzZSk7CiAgXy5leHRlbmQoRGF0YUNsYXNzLnByb3RvdHlwZSwgewogICAgc3luYzogVGhvcmF4LnN5bmMsCgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogICAgICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBzZWxmLmxvYWRFbmQoKTsKICAgICAgfTsKICAgICAgc2VsZi5sb2FkU3RhcnQodW5kZWZpbmVkLCBvcHRpb25zLmJhY2tncm91bmQpOwogICAgICByZXR1cm4gZmV0Y2hRdWV1ZS5jYWxsKHRoaXMsIG9wdGlvbnMgfHwge30sICRmZXRjaCk7CiAgICB9LAoKICAgIGxvYWQ6IGZ1bmN0aW9uKGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiAhXy5pc0Z1bmN0aW9uKGZhaWxiYWNrKSkgewogICAgICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgICAgICBmYWlsYmFjayA9IGZhbHNlOwogICAgICB9CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKCFvcHRpb25zLmJhY2tncm91bmQgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKSAmJiByb290T2JqZWN0KSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGdsb2JhbCBzY29wZSBzZWVzIHRoZSBwcm9wZXIgbG9hZCBldmVudHMgaGVyZQogICAgICAgIC8vIGlmIHdlIGFyZSBsb2FkaW5nIGluIHN0YW5kYWxvbmUgbW9kZQogICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgfQoKICAgICAgbG9hZERhdGEuY2FsbCh0aGlzLCBjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpOwogICAgfQogIH0pOwp9KTsKClRob3JheC5VdGlsLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7CgppZiAoVGhvcmF4LlJvdXRlcikgewogIFRob3JheC5Sb3V0ZXIuYmluZFRvUm91dGUgPSBUaG9yYXguUm91dGVyLnByb3RvdHlwZS5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwp9CgovLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyClRob3JheC5WaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07CgovLyBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgaW5oZXJpdHMgZnJvbSBDb2xsZWN0aW9uVmlldwovLyBub3QgSGVscGVyVmlldyBzbyBuZWVkIHRvIHNldCBpdCBtYW51YWxseQpUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLnBhcmVudC5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMucGFyZW50Lm5vbkJsb2NraW5nTG9hZDsKICByZXR1cm4gb3B0aW9uczsKfTsKCmluaGVyaXRWYXJzLmNvbGxlY3Rpb24ubG9hZGluZyA9IGZ1bmN0aW9uKCkgewogIHZhciBsb2FkaW5nVmlldyA9IHRoaXMubG9hZGluZ1ZpZXcsCiAgICAgIGxvYWRpbmdUZW1wbGF0ZSA9IHRoaXMubG9hZGluZ1RlbXBsYXRlLAogICAgICBsb2FkaW5nUGxhY2VtZW50ID0gdGhpcy5sb2FkaW5nUGxhY2VtZW50OwogIC8vYWRkICJsb2FkaW5nLXZpZXciIGFuZCAibG9hZGluZy10ZW1wbGF0ZSIgb3B0aW9ucyB0byBjb2xsZWN0aW9uIGhlbHBlcgogIGlmIChsb2FkaW5nVmlldyB8fCBsb2FkaW5nVGVtcGxhdGUpIHsKICAgIHZhciBjYWxsYmFjayA9IFRob3JheC5sb2FkSGFuZGxlcihfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtOwogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuJGVsLmVtcHR5KCk7CiAgICAgIH0KICAgICAgaWYgKGxvYWRpbmdWaWV3KSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKGxvYWRpbmdWaWV3KTsKICAgICAgICB0aGlzLl9hZGRDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgaWYgKGxvYWRpbmdUZW1wbGF0ZSkgewogICAgICAgICAgaW5zdGFuY2UucmVuZGVyKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgIH0KICAgICAgICBpdGVtID0gaW5zdGFuY2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXRlbSA9IHRoaXMucmVuZGVyVGVtcGxhdGUobG9hZGluZ1RlbXBsYXRlKTsKICAgICAgfQogICAgICB2YXIgaW5kZXggPSBsb2FkaW5nUGxhY2VtZW50CiAgICAgICAgPyBsb2FkaW5nUGxhY2VtZW50LmNhbGwodGhpcykKICAgICAgICA6IHRoaXMuY29sbGVjdGlvbi5sZW5ndGgKICAgICAgOwogICAgICB0aGlzLmFwcGVuZEl0ZW0oaXRlbSwgaW5kZXgpOwogICAgICB0aGlzLiRlbC5jaGlsZHJlbigpLmVxKGluZGV4KS5hdHRyKCdkYXRhLWxvYWRpbmctZWxlbWVudCcsIHRoaXMuY29sbGVjdGlvbi5jaWQpOwogICAgfSwgdGhpcyksIF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuZmluZCgnW2RhdGEtbG9hZGluZy1lbGVtZW50PSInICsgdGhpcy5jb2xsZWN0aW9uLmNpZCArICciXScpLnJlbW92ZSgpOwogICAgfSwgdGhpcyksCiAgICB0aGlzLmNvbGxlY3Rpb24pOwoKICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnbG9hZDpzdGFydCcsIGNhbGxiYWNrKTsKICB9Cn07CgppZiAoY29sbGVjdGlvbk9wdGlvbk5hbWVzKSB7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXRlbXBsYXRlJ10gPSAnbG9hZGluZ1RlbXBsYXRlJzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdmlldyddID0gJ2xvYWRpbmdWaWV3JzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctcGxhY2VtZW50J10gPSAnbG9hZGluZ1BsYWNlbWVudCc7Cn0KClRob3JheC5WaWV3Lm9uKHsKICAnbG9hZDpzdGFydCc6IFRob3JheC5sb2FkSGFuZGxlcigKICAgICAgZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRTdGFydChtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9LAogICAgICBmdW5jdGlvbihiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZEVuZChvYmplY3QpOwogICAgICB9KSwKCiAgY29sbGVjdGlvbjogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9LAogIG1vZGVsOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0KfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2FkaW5nJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICB2aWV3Lm9mZignY2hhbmdlOmxvYWQtc3RhdGUnLCBvbkxvYWRTdGF0ZUNoYW5nZSwgdmlldyk7CiAgdmlldy5vbignY2hhbmdlOmxvYWQtc3RhdGUnLCBvbkxvYWRTdGF0ZUNoYW5nZSwgdmlldyk7CiAgcmV0dXJuIHZpZXcuX2lzTG9hZGluZyA/IG9wdGlvbnMuZm4odGhpcykgOiBvcHRpb25zLmludmVyc2UodGhpcyk7Cn0pOwoKZnVuY3Rpb24gb25Mb2FkU3RhdGVDaGFuZ2UoKSB7CiAgdGhpcy5yZW5kZXIoKTsKfQo7OwovKmdsb2JhbCBwdXNoRG9tRXZlbnRzICovCnZhciBpc2lPUyA9IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhpUGhvbmV8aVBvZHxpUGFkKS9pKSwKICAgIGlzQW5kcm9pZCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJhbmRyb2lkIikgPiAtMSA/IDEgOiAwLAogICAgbWluaW11bVNjcm9sbFlPZmZzZXQgPSBpc0FuZHJvaWQgPyAxIDogMDsKClRob3JheC5VdGlsLnNjcm9sbFRvID0gZnVuY3Rpb24oeCwgeSkgewogIHkgPSB5IHx8IG1pbmltdW1TY3JvbGxZT2Zmc2V0OwogIGZ1bmN0aW9uIF9zY3JvbGxUbygpIHsKICAgIHdpbmRvdy5zY3JvbGxUbyh4LCB5KTsKICB9CiAgaWYgKGlzaU9TKSB7CiAgICAvLyBhIGRlZmVyIGlzIHJlcXVpcmVkIGZvciBpb3MKICAgIF8uZGVmZXIoX3Njcm9sbFRvKTsKICB9IGVsc2UgewogICAgX3Njcm9sbFRvKCk7CiAgfQogIHJldHVybiBbeCwgeV07Cn07CgpUaG9yYXguTGF5b3V0Vmlldy5vbignY2hhbmdlOnZpZXc6ZW5kJywgZnVuY3Rpb24obmV3Vmlldywgb2xkVmlldywgb3B0aW9ucykgewogIG9wdGlvbnMuc2Nyb2xsICYmIFRob3JheC5VdGlsLnNjcm9sbFRvKDAsIDApOwp9KTsKClRob3JheC5VdGlsLnNjcm9sbFRvVG9wID0gZnVuY3Rpb24oKSB7CiAgLy8gYW5kcm9pZCB3aWxsIHVzZSBoZWlnaHQgb2YgMSBiZWNhdXNlIG9mIG1pbmltdW1TY3JvbGxZT2Zmc2V0IGluIHNjcm9sbFRvKCkKICByZXR1cm4gdGhpcy5zY3JvbGxUbygwLCAwKTsKfTsKCnB1c2hEb21FdmVudHMoWwogICdzaW5nbGVUYXAnLCAnZG91YmxlVGFwJywgJ2xvbmdUYXAnLAogICdzd2lwZScsCiAgJ3N3aXBlVXAnLCAnc3dpcGVEb3duJywKICAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnCl0pOwoKLy9idWlsdCBpbiBkb20gZXZlbnRzClRob3JheC5WaWV3Lm9uKHsKICAnc3VibWl0IGZvcm0nOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgLy8gSGlkZSBhbnkgdmlydHVhbCBrZXlib2FyZHMgdGhhdCBtYXkgYmUgbGluZ2VyaW5nIGFyb3VuZAogICAgdmFyIGZvY3VzZWQgPSAkKCc6Zm9jdXMnKVswXTsKICAgIGZvY3VzZWQgJiYgZm9jdXNlZC5ibHVyKCk7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCAqLwoKJC5mbi50YXBIb2xkQW5kRW5kID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNhbGxiYWNrU3RhcnQsIGNhbGxiYWNrRW5kKSB7CiAgZnVuY3Rpb24gdHJpZ2dlckV2ZW50KG9iaiwgZXZlbnRUeXBlLCBjYWxsYmFjaywgZXZlbnQpIHsKICAgIHZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlLAogICAgICAgIHJlc3VsdDsKCiAgICBldmVudC50eXBlID0gZXZlbnRUeXBlOwogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwob2JqLCBldmVudCk7CiAgICB9CiAgICBldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIHZhciB0aW1lcnMgPSBbXTsKICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgdmFyIHRoaXNPYmplY3QgPSB0aGlzLAogICAgICAgIHRhcEhvbGRTdGFydCA9IGZhbHNlLAogICAgICAgICR0aGlzID0gJCh0aGlzT2JqZWN0KTsKCiAgICAkdGhpcy5vbigndG91Y2hzdGFydCcsIHNlbGVjdG9yLCBmdW5jdGlvbihldmVudCkgewogICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZTsKICAgICAgdmFyIG9yaWdFdmVudCA9IGV2ZW50LAogICAgICAgICAgdGltZXI7CgogICAgICBmdW5jdGlvbiBjbGVhclRhcFRpbWVyKGV2ZW50KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKCiAgICAgICAgaWYgKHRhcEhvbGRTdGFydCkgewogICAgICAgICAgdmFyIHJldHZhbCA9IGZhbHNlOwogICAgICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgICAgIC8vIFdlIGFyZW4ndCBzZW5kaW5nIGFueSBlbmQgZXZlbnRzIGZvciB0b3VjaGNhbmNlbCBjYXNlcywKICAgICAgICAgICAgLy8gcHJldmVudCBhbiBleGNlcHRpb24KICAgICAgICAgICAgcmV0dmFsID0gdHJpZ2dlckV2ZW50KHRoaXNPYmplY3QsICd0YXBIb2xkRW5kJywgY2FsbGJhY2tFbmQsIGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXR2YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIF8uZWFjaCh0aW1lcnMsIGNsZWFyVGltZW91dCk7CiAgICAgICAgICAgIHRpbWVycyA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgJChkb2N1bWVudCkub25lKCd0b3VjaGNhbmNlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFyVGFwVGltZXIoKTsKCiAgICAgICAgJHRoaXMub2ZmKCd0b3VjaG1vdmUnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgICAgJHRoaXMub2ZmKCd0b3VjaGVuZCcsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgfSk7CgogICAgICAkdGhpcy5vbigndG91Y2hlbmQnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgICR0aGlzLm9uKCd0b3VjaG1vdmUnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CgogICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgdGFwSG9sZFN0YXJ0ID0gdHJ1ZTsKICAgICAgICB2YXIgcmV0dmFsID0gdHJpZ2dlckV2ZW50KHRoaXNPYmplY3QsICd0YXBIb2xkU3RhcnQnLCBjYWxsYmFja1N0YXJ0LCBvcmlnRXZlbnQpOwogICAgICAgIGlmIChyZXR2YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICBfLmVhY2godGltZXJzLCBjbGVhclRpbWVvdXQpOwogICAgICAgICAgdGltZXJzID0gW107CiAgICAgICAgfQogICAgICB9LCAxNTApOwogICAgICB0aW1lcnMucHVzaCh0aW1lcik7CiAgICB9KTsKICB9KTsKfTsKCi8vb25seSBlbmFibGUgb24gYW5kcm9pZAp2YXIgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gIWlzQW5kcm9pZDsKVGhvcmF4LmNvbmZpZ3VyZVRhcEhpZ2hsaWdodCA9IGZ1bmN0aW9uKHVzZU5hdGl2ZSkgewogIHVzZU5hdGl2ZUhpZ2hsaWdodCA9IHVzZU5hdGl2ZTsKfTsKCnZhciBOQVRJVkVfVEFQUEFCTEUgPSB7CiAgJ0EnOiB0cnVlLAogICdJTlBVVCc6IHRydWUsCiAgJ0JVVFRPTic6IHRydWUsCiAgJ1NFTEVDVCc6IHRydWUsCiAgJ1RFWFRBUkVBJzogdHJ1ZQp9OwoKZnVuY3Rpb24gZml4dXBUYXBIaWdobGlnaHQoc2NvcGUpIHsKICBfLmVhY2godGhpcy5fZG9tRXZlbnRzIHx8IFtdLCBmdW5jdGlvbihiaW5kKSB7CiAgICB2YXIgY29tcG9uZW50cyA9IGJpbmQuc3BsaXQoJyAnKSwKICAgICAgICBzZWxlY3RvciA9IGNvbXBvbmVudHMuc2xpY2UoMSkuam9pbignICcpIHx8IHVuZGVmaW5lZDsgIC8vIE5lZWRlZCB0byBtYWtlIHplcHRvIGhhcHB5CgogICAgaWYgKGNvbXBvbmVudHNbMF0gPT09ICdjbGljaycpIHsKICAgICAgLy8gIXNlbGVjdG9yIGNhc2UgaXMgZm9yIHJvb3QgY2xpY2sgaGFuZGxlcnMgb24gdGhlIHZpZXcsIGkuZS4gJ2NsaWNrJwogICAgICAkKHNlbGVjdG9yIHx8IHRoaXMuZWwsIHNlbGVjdG9yICYmIChzY29wZSB8fCB0aGlzLmVsKSkuZm9yRWFjaChmdW5jdGlvbihlbCkgewogICAgICAgIHZhciAkZWwgPSAkKGVsKS5kYXRhKCd0YXBwYWJsZScsIHRydWUpOwoKICAgICAgICBpZiAodXNlTmF0aXZlSGlnaGxpZ2h0ICYmICFOQVRJVkVfVEFQUEFCTEVbZWwudGFnTmFtZV0pIHsKICAgICAgICAgIC8vIEFkZCBhbiBleHBsaWNpdCBOT1AgYmluZCB0byBhbGxvdyB0YXAtaGlnaGxpZ2h0IHN1cHBvcnQKICAgICAgICAgICRlbC5vbignY2xpY2snLCBmdW5jdGlvbigpIHt9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHRoaXMpOwp9CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBfdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lOiAnYWN0aXZlJywKICBfdGFwSGlnaGxpZ2h0U3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCwKICAgICAgICB0YWdOYW1lID0gdGFyZ2V0ICYmIHRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgLy8gVXNlciBpbnB1dCBjb250cm9scyBtYXkgYmUgdmlzdWFsbHkgcGFydCBvZiBhIGxhcmdlciBncm91cC4gRm9yIHRoZXNlIGNhc2VzCiAgICAvLyB3ZSB3YW50IHRvIGdpdmUgcHJpb3JpdHkgdG8gYW55IHBhcmVudCB0aGF0IG1heSBwcm92aWRlIGEgZm9jdXMgb3BlcmF0aW9uLgogICAgaWYgKHRhZ05hbWUgPT09ICdpbnB1dCcgfHwgdGFnTmFtZSA9PT0gJ3NlbGVjdCcgfHwgdGFnTmFtZSA9PT0gJ3RleHRhcmVhJykgewogICAgICB0YXJnZXQgPSAkKHRhcmdldCkuY2xvc2VzdCgnW2RhdGEtdGFwcGFibGU9dHJ1ZV0nKVswXSB8fCB0YXJnZXQ7CiAgICB9CgogICAgaWYgKHRhcmdldCkgewogICAgICAkKHRhcmdldCkuYWRkQ2xhc3ModGhpcy5fdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sCiAgX3RhcEhpZ2hsaWdodEVuZDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKICAgICQoJy4nICsgdGhpcy5fdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lKS5yZW1vdmVDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogIH0KfSk7CgovL1RPRE86IGV4YW1pbmUgaWYgdGhlc2UgYXJlIHN0aWxsIG5lZWRlZAp2YXIgZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogIGZpeHVwVGFwSGlnaGxpZ2h0LmNhbGwodGhpcyk7Cn07CgpUaG9yYXguVmlldy5vbih7CiAgJ3JlbmRlcmVkJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOml0ZW0nOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDplbXB0eSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2sKfSk7Cgp2YXIgX3NldEVsZW1lbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudCwKICAgIHRhcEhpZ2hsaWdodFNlbGVjdG9yID0gJ1tkYXRhLXRhcHBhYmxlPXRydWVdLCBhLCBpbnB1dCwgYnV0dG9uLCBzZWxlY3QsIHRleHRhcmVhJzsKClRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50ID0gZnVuY3Rpb24oKSB7CiAgdmFyIHJlc3BvbnNlID0gX3NldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoIXRoaXMubm9UYXBIaWdobGlnaHQpIHsKICAgIGlmICghdXNlTmF0aXZlSGlnaGxpZ2h0KSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgZnVuY3Rpb24gZXhlYyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2VsZltuYW1lXS5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbihuYW1lLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIHRoaXMuJGVsLnRhcEhvbGRBbmRFbmQodGFwSGlnaGxpZ2h0U2VsZWN0b3IsIGV4ZWMoJ190YXBIaWdobGlnaHRTdGFydCcpLCBleGVjKCdfdGFwSGlnaGxpZ2h0RW5kJykpOwogICAgfQogIH0KICByZXR1cm4gcmVzcG9uc2U7Cn07Cgp2YXIgX2FkZEV2ZW50ID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9hZGRFdmVudDsKVGhvcmF4LlZpZXcucHJvdG90eXBlLl9hZGRFdmVudCA9IGZ1bmN0aW9uKHBhcmFtcykgewogIHRoaXMuX2RvbUV2ZW50cyA9IHRoaXMuX2RvbUV2ZW50cyB8fCBbXTsKICBpZiAocGFyYW1zLnR5cGUgPT09ICJET00iKSB7CiAgICB0aGlzLl9kb21FdmVudHMucHVzaChwYXJhbXMub3JpZ2luYWxOYW1lKTsKICB9CiAgcmV0dXJuIF9hZGRFdmVudC5jYWxsKHRoaXMsIHBhcmFtcyk7Cn07Cgo7OwoKCn0pKCk7CgovL0Agc291cmNlTWFwcGluZ1VSTD10aG9yYXgtbW9iaWxlLmpzLm1hcAoK",
                "body": "LyogWmVwdG8gdjEuMHJjMSAtIHBvbHlmaWxsIHplcHRvIGV2ZW50IGRldGVjdCBmeCBhamF4IGZvcm0gdG91Y2ggLSB6ZXB0b2pzLmNvbS9saWNlbnNlICovCjsoZnVuY3Rpb24odW5kZWZpbmVkKXsKICBpZiAoU3RyaW5nLnByb3RvdHlwZS50cmltID09PSB1bmRlZmluZWQpIC8vIGZpeCBmb3IgaU9TIDMuMgogICAgU3RyaW5nLnByb3RvdHlwZS50cmltID0gZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzKy8sICcnKS5yZXBsYWNlKC9ccyskLywgJycpIH0KCiAgLy8gRm9yIGlPUyAzLngKICAvLyBmcm9tIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuL0phdmFTY3JpcHQvUmVmZXJlbmNlL0dsb2JhbF9PYmplY3RzL0FycmF5L3JlZHVjZQogIGlmIChBcnJheS5wcm90b3R5cGUucmVkdWNlID09PSB1bmRlZmluZWQpCiAgICBBcnJheS5wcm90b3R5cGUucmVkdWNlID0gZnVuY3Rpb24oZnVuKXsKICAgICAgaWYodGhpcyA9PT0gdm9pZCAwIHx8IHRoaXMgPT09IG51bGwpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICB2YXIgdCA9IE9iamVjdCh0aGlzKSwgbGVuID0gdC5sZW5ndGggPj4+IDAsIGsgPSAwLCBhY2N1bXVsYXRvcgogICAgICBpZih0eXBlb2YgZnVuICE9ICdmdW5jdGlvbicpIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICBpZihsZW4gPT0gMCAmJiBhcmd1bWVudHMubGVuZ3RoID09IDEpIHRocm93IG5ldyBUeXBlRXJyb3IoKQoKICAgICAgaWYoYXJndW1lbnRzLmxlbmd0aCA+PSAyKQogICAgICAgYWNjdW11bGF0b3IgPSBhcmd1bWVudHNbMV0KICAgICAgZWxzZQogICAgICAgIGRvewogICAgICAgICAgaWYoayBpbiB0KXsKICAgICAgICAgICAgYWNjdW11bGF0b3IgPSB0W2srK10KICAgICAgICAgICAgYnJlYWsKICAgICAgICAgIH0KICAgICAgICAgIGlmKCsrayA+PSBsZW4pIHRocm93IG5ldyBUeXBlRXJyb3IoKQogICAgICAgIH0gd2hpbGUgKHRydWUpCgogICAgICB3aGlsZSAoayA8IGxlbil7CiAgICAgICAgaWYoayBpbiB0KSBhY2N1bXVsYXRvciA9IGZ1bi5jYWxsKHVuZGVmaW5lZCwgYWNjdW11bGF0b3IsIHRba10sIGssIHQpCiAgICAgICAgaysrCiAgICAgIH0KICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yCiAgICB9Cgp9KSgpCnZhciBaZXB0byA9IChmdW5jdGlvbigpIHsKICB2YXIgdW5kZWZpbmVkLCBrZXksICQsIGNsYXNzTGlzdCwgZW1wdHlBcnJheSA9IFtdLCBzbGljZSA9IGVtcHR5QXJyYXkuc2xpY2UsCiAgICBkb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCwKICAgIGVsZW1lbnREaXNwbGF5ID0ge30sIGNsYXNzQ2FjaGUgPSB7fSwKICAgIGdldENvbXB1dGVkU3R5bGUgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlLAogICAgY3NzTnVtYmVyID0geyAnY29sdW1uLWNvdW50JzogMSwgJ2NvbHVtbnMnOiAxLCAnZm9udC13ZWlnaHQnOiAxLCAnbGluZS1oZWlnaHQnOiAxLCdvcGFjaXR5JzogMSwgJ3otaW5kZXgnOiAxLCAnem9vbSc6IDEgfSwKICAgIGZyYWdtZW50UkUgPSAvXlxzKjwoXHcrfCEpW14+XSo+LywKCiAgICAvLyBVc2VkIGJ5IGAkLnplcHRvLmluaXRgIHRvIHdyYXAgZWxlbWVudHMsIHRleHQvY29tbWVudCBub2RlcywgZG9jdW1lbnQsCiAgICAvLyBhbmQgZG9jdW1lbnQgZnJhZ21lbnQgbm9kZSB0eXBlcy4KICAgIGVsZW1lbnRUeXBlcyA9IFsxLCAzLCA4LCA5LCAxMV0sCgogICAgYWRqYWNlbmN5T3BlcmF0b3JzID0gWyAnYWZ0ZXInLCAncHJlcGVuZCcsICdiZWZvcmUnLCAnYXBwZW5kJyBdLAogICAgdGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0YWJsZScpLAogICAgdGFibGVSb3cgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpLAogICAgY29udGFpbmVycyA9IHsKICAgICAgJ3RyJzogZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGJvZHknKSwKICAgICAgJ3Rib2R5JzogdGFibGUsICd0aGVhZCc6IHRhYmxlLCAndGZvb3QnOiB0YWJsZSwKICAgICAgJ3RkJzogdGFibGVSb3csICd0aCc6IHRhYmxlUm93LAogICAgICAnKic6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpCiAgICB9LAogICAgcmVhZHlSRSA9IC9jb21wbGV0ZXxsb2FkZWR8aW50ZXJhY3RpdmUvLAogICAgY2xhc3NTZWxlY3RvclJFID0gL15cLihbXHctXSspJC8sCiAgICBpZFNlbGVjdG9yUkUgPSAvXiMoW1x3LV0rKSQvLAogICAgdGFnU2VsZWN0b3JSRSA9IC9eW1x3LV0rJC8sCiAgICB0b1N0cmluZyA9ICh7fSkudG9TdHJpbmcsCiAgICB6ZXB0byA9IHt9LAogICAgY2FtZWxpemUsIHVuaXEsCiAgICB0ZW1wUGFyZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JykKCiAgemVwdG8ubWF0Y2hlcyA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKSB7CiAgICBpZiAoIWVsZW1lbnQgfHwgZWxlbWVudC5ub2RlVHlwZSAhPT0gMSkgcmV0dXJuIGZhbHNlCiAgICB2YXIgbWF0Y2hlc1NlbGVjdG9yID0gZWxlbWVudC53ZWJraXRNYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tb3pNYXRjaGVzU2VsZWN0b3IgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBlbGVtZW50Lm9NYXRjaGVzU2VsZWN0b3IgfHwgZWxlbWVudC5tYXRjaGVzU2VsZWN0b3IKICAgIGlmIChtYXRjaGVzU2VsZWN0b3IpIHJldHVybiBtYXRjaGVzU2VsZWN0b3IuY2FsbChlbGVtZW50LCBzZWxlY3RvcikKICAgIC8vIGZhbGwgYmFjayB0byBwZXJmb3JtaW5nIGEgc2VsZWN0b3I6CiAgICB2YXIgbWF0Y2gsIHBhcmVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSwgdGVtcCA9ICFwYXJlbnQKICAgIGlmICh0ZW1wKSAocGFyZW50ID0gdGVtcFBhcmVudCkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgIG1hdGNoID0gfnplcHRvLnFzYShwYXJlbnQsIHNlbGVjdG9yKS5pbmRleE9mKGVsZW1lbnQpCiAgICB0ZW1wICYmIHRlbXBQYXJlbnQucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgIHJldHVybiBtYXRjaAogIH0KCiAgZnVuY3Rpb24gaXNGdW5jdGlvbih2YWx1ZSkgeyByZXR1cm4gdG9TdHJpbmcuY2FsbCh2YWx1ZSkgPT0gIltvYmplY3QgRnVuY3Rpb25dIiB9CiAgZnVuY3Rpb24gaXNPYmplY3QodmFsdWUpIHsgcmV0dXJuIHZhbHVlIGluc3RhbmNlb2YgT2JqZWN0IH0KICBmdW5jdGlvbiBpc1BsYWluT2JqZWN0KHZhbHVlKSB7CiAgICB2YXIga2V5LCBjdG9yCiAgICBpZiAodG9TdHJpbmcuY2FsbCh2YWx1ZSkgIT09ICJbb2JqZWN0IE9iamVjdF0iKSByZXR1cm4gZmFsc2UKICAgIGN0b3IgPSAoaXNGdW5jdGlvbih2YWx1ZS5jb25zdHJ1Y3RvcikgJiYgdmFsdWUuY29uc3RydWN0b3IucHJvdG90eXBlKQogICAgaWYgKCFjdG9yIHx8ICFoYXNPd25Qcm9wZXJ0eS5jYWxsKGN0b3IsICdpc1Byb3RvdHlwZU9mJykpIHJldHVybiBmYWxzZQogICAgZm9yIChrZXkgaW4gdmFsdWUpOwogICAgcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093blByb3BlcnR5LmNhbGwodmFsdWUsIGtleSkKICB9CiAgZnVuY3Rpb24gaXNBcnJheSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgaW5zdGFuY2VvZiBBcnJheSB9CiAgZnVuY3Rpb24gbGlrZUFycmF5KG9iaikgeyByZXR1cm4gdHlwZW9mIG9iai5sZW5ndGggPT0gJ251bWJlcicgfQoKICBmdW5jdGlvbiBjb21wYWN0KGFycmF5KSB7IHJldHVybiBhcnJheS5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7IHJldHVybiBpdGVtICE9PSB1bmRlZmluZWQgJiYgaXRlbSAhPT0gbnVsbCB9KSB9CiAgZnVuY3Rpb24gZmxhdHRlbihhcnJheSkgeyByZXR1cm4gYXJyYXkubGVuZ3RoID4gMCA/IFtdLmNvbmNhdC5hcHBseShbXSwgYXJyYXkpIDogYXJyYXkgfQogIGNhbWVsaXplID0gZnVuY3Rpb24oc3RyKXsgcmV0dXJuIHN0ci5yZXBsYWNlKC8tKyguKT8vZywgZnVuY3Rpb24obWF0Y2gsIGNocil7IHJldHVybiBjaHIgPyBjaHIudG9VcHBlckNhc2UoKSA6ICcnIH0pIH0KICBmdW5jdGlvbiBkYXNoZXJpemUoc3RyKSB7CiAgICByZXR1cm4gc3RyLnJlcGxhY2UoLzo6L2csICcvJykKICAgICAgICAgICAucmVwbGFjZSgvKFtBLVpdKykoW0EtWl1bYS16XSkvZywgJyQxXyQyJykKICAgICAgICAgICAucmVwbGFjZSgvKFthLXpcZF0pKFtBLVpdKS9nLCAnJDFfJDInKQogICAgICAgICAgIC5yZXBsYWNlKC9fL2csICctJykKICAgICAgICAgICAudG9Mb3dlckNhc2UoKQogIH0KICB1bmlxID0gZnVuY3Rpb24oYXJyYXkpeyByZXR1cm4gYXJyYXkuZmlsdGVyKGZ1bmN0aW9uKGl0ZW0sIGlkeCl7IHJldHVybiBhcnJheS5pbmRleE9mKGl0ZW0pID09IGlkeCB9KSB9CgogIGZ1bmN0aW9uIGNsYXNzUkUobmFtZSkgewogICAgcmV0dXJuIG5hbWUgaW4gY2xhc3NDYWNoZSA/CiAgICAgIGNsYXNzQ2FjaGVbbmFtZV0gOiAoY2xhc3NDYWNoZVtuYW1lXSA9IG5ldyBSZWdFeHAoJyhefFxccyknICsgbmFtZSArICcoXFxzfCQpJykpCiAgfQoKICBmdW5jdGlvbiBtYXliZUFkZFB4KG5hbWUsIHZhbHVlKSB7CiAgICByZXR1cm4gKHR5cGVvZiB2YWx1ZSA9PSAibnVtYmVyIiAmJiAhY3NzTnVtYmVyW2Rhc2hlcml6ZShuYW1lKV0pID8gdmFsdWUgKyAicHgiIDogdmFsdWUKICB9CgogIGZ1bmN0aW9uIGRlZmF1bHREaXNwbGF5KG5vZGVOYW1lKSB7CiAgICB2YXIgZWxlbWVudCwgZGlzcGxheQogICAgaWYgKCFlbGVtZW50RGlzcGxheVtub2RlTmFtZV0pIHsKICAgICAgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpCiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9IGdldENvbXB1dGVkU3R5bGUoZWxlbWVudCwgJycpLmdldFByb3BlcnR5VmFsdWUoImRpc3BsYXkiKQogICAgICBlbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZWxlbWVudCkKICAgICAgZGlzcGxheSA9PSAibm9uZSIgJiYgKGRpc3BsYXkgPSAiYmxvY2siKQogICAgICBlbGVtZW50RGlzcGxheVtub2RlTmFtZV0gPSBkaXNwbGF5CiAgICB9CiAgICByZXR1cm4gZWxlbWVudERpc3BsYXlbbm9kZU5hbWVdCiAgfQoKICAvLyBgJC56ZXB0by5mcmFnbWVudGAgdGFrZXMgYSBodG1sIHN0cmluZyBhbmQgYW4gb3B0aW9uYWwgdGFnIG5hbWUKICAvLyB0byBnZW5lcmF0ZSBET00gbm9kZXMgbm9kZXMgZnJvbSB0aGUgZ2l2ZW4gaHRtbCBzdHJpbmcuCiAgLy8gVGhlIGdlbmVyYXRlZCBET00gbm9kZXMgYXJlIHJldHVybmVkIGFzIGFuIGFycmF5LgogIC8vIFRoaXMgZnVuY3Rpb24gY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zIGZvciBleGFtcGxlIHRvIG1ha2UKICAvLyBpdCBjb21wYXRpYmxlIHdpdGggYnJvd3NlcnMgdGhhdCBkb24ndCBzdXBwb3J0IHRoZSBET00gZnVsbHkuCiAgemVwdG8uZnJhZ21lbnQgPSBmdW5jdGlvbihodG1sLCBuYW1lKSB7CiAgICBpZiAobmFtZSA9PT0gdW5kZWZpbmVkKSBuYW1lID0gZnJhZ21lbnRSRS50ZXN0KGh0bWwpICYmIFJlZ0V4cC4kMQogICAgaWYgKCEobmFtZSBpbiBjb250YWluZXJzKSkgbmFtZSA9ICcqJwogICAgdmFyIGNvbnRhaW5lciA9IGNvbnRhaW5lcnNbbmFtZV0KICAgIGNvbnRhaW5lci5pbm5lckhUTUwgPSAnJyArIGh0bWwKICAgIHJldHVybiAkLmVhY2goc2xpY2UuY2FsbChjb250YWluZXIuY2hpbGROb2RlcyksIGZ1bmN0aW9uKCl7CiAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZCh0aGlzKQogICAgfSkKICB9CgogIC8vIGAkLnplcHRvLlpgIHN3YXBzIG91dCB0aGUgcHJvdG90eXBlIG9mIHRoZSBnaXZlbiBgZG9tYCBhcnJheQogIC8vIG9mIG5vZGVzIHdpdGggYCQuZm5gIGFuZCB0aHVzIHN1cHBseWluZyBhbGwgdGhlIFplcHRvIGZ1bmN0aW9ucwogIC8vIHRvIHRoZSBhcnJheS4gTm90ZSB0aGF0IGBfX3Byb3RvX19gIGlzIG5vdCBzdXBwb3J0ZWQgb24gSW50ZXJuZXQKICAvLyBFeHBsb3Jlci4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLlogPSBmdW5jdGlvbihkb20sIHNlbGVjdG9yKSB7CiAgICBkb20gPSBkb20gfHwgW10KICAgIGRvbS5fX3Byb3RvX18gPSBhcmd1bWVudHMuY2FsbGVlLnByb3RvdHlwZQogICAgZG9tLnNlbGVjdG9yID0gc2VsZWN0b3IgfHwgJycKICAgIHJldHVybiBkb20KICB9CgogIC8vIGAkLnplcHRvLmlzWmAgc2hvdWxkIHJldHVybiBgdHJ1ZWAgaWYgdGhlIGdpdmVuIG9iamVjdCBpcyBhIFplcHRvCiAgLy8gY29sbGVjdGlvbi4gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLmlzWiA9IGZ1bmN0aW9uKG9iamVjdCkgewogICAgcmV0dXJuIG9iamVjdCBpbnN0YW5jZW9mIHplcHRvLloKICB9CgogIC8vIGAkLnplcHRvLmluaXRgIGlzIFplcHRvJ3MgY291bnRlcnBhcnQgdG8galF1ZXJ5J3MgYCQuZm4uaW5pdGAgYW5kCiAgLy8gdGFrZXMgYSBDU1Mgc2VsZWN0b3IgYW5kIGFuIG9wdGlvbmFsIGNvbnRleHQgKGFuZCBoYW5kbGVzIHZhcmlvdXMKICAvLyBzcGVjaWFsIGNhc2VzKS4KICAvLyBUaGlzIG1ldGhvZCBjYW4gYmUgb3ZlcnJpZGVuIGluIHBsdWdpbnMuCiAgemVwdG8uaW5pdCA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBjb250ZXh0KSB7CiAgICAvLyBJZiBub3RoaW5nIGdpdmVuLCByZXR1cm4gYW4gZW1wdHkgWmVwdG8gY29sbGVjdGlvbgogICAgaWYgKCFzZWxlY3RvcikgcmV0dXJuIHplcHRvLlooKQogICAgLy8gSWYgYSBmdW5jdGlvbiBpcyBnaXZlbiwgY2FsbCBpdCB3aGVuIHRoZSBET00gaXMgcmVhZHkKICAgIGVsc2UgaWYgKGlzRnVuY3Rpb24oc2VsZWN0b3IpKSByZXR1cm4gJChkb2N1bWVudCkucmVhZHkoc2VsZWN0b3IpCiAgICAvLyBJZiBhIFplcHRvIGNvbGxlY3Rpb24gaXMgZ2l2ZW4sIGp1dHMgcmV0dXJuIGl0CiAgICBlbHNlIGlmICh6ZXB0by5pc1ooc2VsZWN0b3IpKSByZXR1cm4gc2VsZWN0b3IKICAgIGVsc2UgewogICAgICB2YXIgZG9tCiAgICAgIC8vIG5vcm1hbGl6ZSBhcnJheSBpZiBhbiBhcnJheSBvZiBub2RlcyBpcyBnaXZlbgogICAgICBpZiAoaXNBcnJheShzZWxlY3RvcikpIGRvbSA9IGNvbXBhY3Qoc2VsZWN0b3IpCiAgICAgIC8vIGlmIGEgSmF2YVNjcmlwdCBvYmplY3QgaXMgZ2l2ZW4sIHJldHVybiBhIGNvcHkgb2YgaXQKICAgICAgLy8gdGhpcyBpcyBhIHNvbWV3aGF0IHBlY3VsaWFyIG9wdGlvbiwgYnV0IHN1cHBvcnRlZCBieQogICAgICAvLyBqUXVlcnkgc28gd2UnbGwgZG8gaXQsIHRvbwogICAgICBlbHNlIGlmIChpc1BsYWluT2JqZWN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSBbJC5leHRlbmQoe30sIHNlbGVjdG9yKV0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyB3cmFwIHN0dWZmIGxpa2UgYGRvY3VtZW50YCBvciBgd2luZG93YAogICAgICBlbHNlIGlmIChlbGVtZW50VHlwZXMuaW5kZXhPZihzZWxlY3Rvci5ub2RlVHlwZSkgPj0gMCB8fCBzZWxlY3RvciA9PT0gd2luZG93KQogICAgICAgIGRvbSA9IFtzZWxlY3Rvcl0sIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiBpdCdzIGEgaHRtbCBmcmFnbWVudCwgY3JlYXRlIG5vZGVzIGZyb20gaXQKICAgICAgZWxzZSBpZiAoZnJhZ21lbnRSRS50ZXN0KHNlbGVjdG9yKSkKICAgICAgICBkb20gPSB6ZXB0by5mcmFnbWVudChzZWxlY3Rvci50cmltKCksIFJlZ0V4cC4kMSksIHNlbGVjdG9yID0gbnVsbAogICAgICAvLyBJZiB0aGVyZSdzIGEgY29udGV4dCwgY3JlYXRlIGEgY29sbGVjdGlvbiBvbiB0aGF0IGNvbnRleHQgZmlyc3QsIGFuZCBzZWxlY3QKICAgICAgLy8gbm9kZXMgZnJvbSB0aGVyZQogICAgICBlbHNlIGlmIChjb250ZXh0ICE9PSB1bmRlZmluZWQpIHJldHVybiAkKGNvbnRleHQpLmZpbmQoc2VsZWN0b3IpCiAgICAgIC8vIEFuZCBsYXN0IGJ1dCBubyBsZWFzdCwgaWYgaXQncyBhIENTUyBzZWxlY3RvciwgdXNlIGl0IHRvIHNlbGVjdCBub2Rlcy4KICAgICAgZWxzZSBkb20gPSB6ZXB0by5xc2EoZG9jdW1lbnQsIHNlbGVjdG9yKQogICAgICAvLyBjcmVhdGUgYSBuZXcgWmVwdG8gY29sbGVjdGlvbiBmcm9tIHRoZSBub2RlcyBmb3VuZAogICAgICByZXR1cm4gemVwdG8uWihkb20sIHNlbGVjdG9yKQogICAgfQogIH0KCiAgLy8gYCRgIHdpbGwgYmUgdGhlIGJhc2UgYFplcHRvYCBvYmplY3QuIFdoZW4gY2FsbGluZyB0aGlzCiAgLy8gZnVuY3Rpb24ganVzdCBjYWxsIGAkLnplcHRvLmluaXQsIHdoaWNocyBtYWtlcyB0aGUgaW1wbGVtZW50YXRpb24KICAvLyBkZXRhaWxzIG9mIHNlbGVjdGluZyBub2RlcyBhbmQgY3JlYXRpbmcgWmVwdG8gY29sbGVjdGlvbnMKICAvLyBwYXRjaGFibGUgaW4gcGx1Z2lucy4KICAkID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNvbnRleHQpewogICAgcmV0dXJuIHplcHRvLmluaXQoc2VsZWN0b3IsIGNvbnRleHQpCiAgfQoKICAvLyBDb3B5IGFsbCBidXQgdW5kZWZpbmVkIHByb3BlcnRpZXMgZnJvbSBvbmUgb3IgbW9yZQogIC8vIG9iamVjdHMgdG8gdGhlIGB0YXJnZXRgIG9iamVjdC4KICAkLmV4dGVuZCA9IGZ1bmN0aW9uKHRhcmdldCl7CiAgICBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkuZm9yRWFjaChmdW5jdGlvbihzb3VyY2UpIHsKICAgICAgZm9yIChrZXkgaW4gc291cmNlKQogICAgICAgIGlmIChzb3VyY2Vba2V5XSAhPT0gdW5kZWZpbmVkKQogICAgICAgICAgdGFyZ2V0W2tleV0gPSBzb3VyY2Vba2V5XQogICAgfSkKICAgIHJldHVybiB0YXJnZXQKICB9CgogIC8vIGAkLnplcHRvLnFzYWAgaXMgWmVwdG8ncyBDU1Mgc2VsZWN0b3IgaW1wbGVtZW50YXRpb24gd2hpY2gKICAvLyB1c2VzIGBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsYCBhbmQgb3B0aW1pemVzIGZvciBzb21lIHNwZWNpYWwgY2FzZXMsIGxpa2UgYCNpZGAuCiAgLy8gVGhpcyBtZXRob2QgY2FuIGJlIG92ZXJyaWRlbiBpbiBwbHVnaW5zLgogIHplcHRvLnFzYSA9IGZ1bmN0aW9uKGVsZW1lbnQsIHNlbGVjdG9yKXsKICAgIHZhciBmb3VuZAogICAgcmV0dXJuIChlbGVtZW50ID09PSBkb2N1bWVudCAmJiBpZFNlbGVjdG9yUkUudGVzdChzZWxlY3RvcikpID8KICAgICAgKCAoZm91bmQgPSBlbGVtZW50LmdldEVsZW1lbnRCeUlkKFJlZ0V4cC4kMSkpID8gW2ZvdW5kXSA6IGVtcHR5QXJyYXkgKSA6CiAgICAgIChlbGVtZW50Lm5vZGVUeXBlICE9PSAxICYmIGVsZW1lbnQubm9kZVR5cGUgIT09IDkpID8gZW1wdHlBcnJheSA6CiAgICAgIHNsaWNlLmNhbGwoCiAgICAgICAgY2xhc3NTZWxlY3RvclJFLnRlc3Qoc2VsZWN0b3IpID8gZWxlbWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFJlZ0V4cC4kMSkgOgogICAgICAgIHRhZ1NlbGVjdG9yUkUudGVzdChzZWxlY3RvcikgPyBlbGVtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKHNlbGVjdG9yKSA6CiAgICAgICAgZWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKHNlbGVjdG9yKQogICAgICApCiAgfQoKICBmdW5jdGlvbiBmaWx0ZXJlZChub2Rlcywgc2VsZWN0b3IpIHsKICAgIHJldHVybiBzZWxlY3RvciA9PT0gdW5kZWZpbmVkID8gJChub2RlcykgOiAkKG5vZGVzKS5maWx0ZXIoc2VsZWN0b3IpCiAgfQoKICBmdW5jdGlvbiBmdW5jQXJnKGNvbnRleHQsIGFyZywgaWR4LCBwYXlsb2FkKSB7CiAgIHJldHVybiBpc0Z1bmN0aW9uKGFyZykgPyBhcmcuY2FsbChjb250ZXh0LCBpZHgsIHBheWxvYWQpIDogYXJnCiAgfQoKICAkLmlzRnVuY3Rpb24gPSBpc0Z1bmN0aW9uCiAgJC5pc09iamVjdCA9IGlzT2JqZWN0CiAgJC5pc0FycmF5ID0gaXNBcnJheQogICQuaXNQbGFpbk9iamVjdCA9IGlzUGxhaW5PYmplY3QKCiAgJC5pbkFycmF5ID0gZnVuY3Rpb24oZWxlbSwgYXJyYXksIGkpewogICAgcmV0dXJuIGVtcHR5QXJyYXkuaW5kZXhPZi5jYWxsKGFycmF5LCBlbGVtLCBpKQogIH0KCiAgJC50cmltID0gZnVuY3Rpb24oc3RyKSB7IHJldHVybiBzdHIudHJpbSgpIH0KCiAgLy8gcGx1Z2luIGNvbXBhdGliaWxpdHkKICAkLnV1aWQgPSAwCgogICQubWFwID0gZnVuY3Rpb24oZWxlbWVudHMsIGNhbGxiYWNrKXsKICAgIHZhciB2YWx1ZSwgdmFsdWVzID0gW10sIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpCiAgICAgIGZvciAoaSA9IDA7IGkgPCBlbGVtZW50cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhbHVlID0gY2FsbGJhY2soZWxlbWVudHNbaV0sIGkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICBlbHNlCiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKSB7CiAgICAgICAgdmFsdWUgPSBjYWxsYmFjayhlbGVtZW50c1trZXldLCBrZXkpCiAgICAgICAgaWYgKHZhbHVlICE9IG51bGwpIHZhbHVlcy5wdXNoKHZhbHVlKQogICAgICB9CiAgICByZXR1cm4gZmxhdHRlbih2YWx1ZXMpCiAgfQoKICAkLmVhY2ggPSBmdW5jdGlvbihlbGVtZW50cywgY2FsbGJhY2spewogICAgdmFyIGksIGtleQogICAgaWYgKGxpa2VBcnJheShlbGVtZW50cykpIHsKICAgICAgZm9yIChpID0gMDsgaSA8IGVsZW1lbnRzLmxlbmd0aDsgaSsrKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2ldLCBpLCBlbGVtZW50c1tpXSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0gZWxzZSB7CiAgICAgIGZvciAoa2V5IGluIGVsZW1lbnRzKQogICAgICAgIGlmIChjYWxsYmFjay5jYWxsKGVsZW1lbnRzW2tleV0sIGtleSwgZWxlbWVudHNba2V5XSkgPT09IGZhbHNlKSByZXR1cm4gZWxlbWVudHMKICAgIH0KCiAgICByZXR1cm4gZWxlbWVudHMKICB9CgogIC8vIERlZmluZSBtZXRob2RzIHRoYXQgd2lsbCBiZSBhdmFpbGFibGUgb24gYWxsCiAgLy8gWmVwdG8gY29sbGVjdGlvbnMKICAkLmZuID0gewogICAgLy8gQmVjYXVzZSBhIGNvbGxlY3Rpb24gYWN0cyBsaWtlIGFuIGFycmF5CiAgICAvLyBjb3B5IG92ZXIgdGhlc2UgdXNlZnVsIGFycmF5IGZ1bmN0aW9ucy4KICAgIGZvckVhY2g6IGVtcHR5QXJyYXkuZm9yRWFjaCwKICAgIHJlZHVjZTogZW1wdHlBcnJheS5yZWR1Y2UsCiAgICBwdXNoOiBlbXB0eUFycmF5LnB1c2gsCiAgICBpbmRleE9mOiBlbXB0eUFycmF5LmluZGV4T2YsCiAgICBjb25jYXQ6IGVtcHR5QXJyYXkuY29uY2F0LAoKICAgIC8vIGBtYXBgIGFuZCBgc2xpY2VgIGluIHRoZSBqUXVlcnkgQVBJIHdvcmsgZGlmZmVyZW50bHkKICAgIC8vIGZyb20gdGhlaXIgYXJyYXkgY291bnRlcnBhcnRzCiAgICBtYXA6IGZ1bmN0aW9uKGZuKXsKICAgICAgcmV0dXJuICQubWFwKHRoaXMsIGZ1bmN0aW9uKGVsLCBpKXsgcmV0dXJuIGZuLmNhbGwoZWwsIGksIGVsKSB9KQogICAgfSwKICAgIHNsaWNlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gJChzbGljZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpKQogICAgfSwKCiAgICByZWFkeTogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICBpZiAocmVhZHlSRS50ZXN0KGRvY3VtZW50LnJlYWR5U3RhdGUpKSBjYWxsYmFjaygkKQogICAgICBlbHNlIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBmdW5jdGlvbigpeyBjYWxsYmFjaygkKSB9LCBmYWxzZSkKICAgICAgcmV0dXJuIHRoaXMKICAgIH0sCiAgICBnZXQ6IGZ1bmN0aW9uKGlkeCl7CiAgICAgIHJldHVybiBpZHggPT09IHVuZGVmaW5lZCA/IHNsaWNlLmNhbGwodGhpcykgOiB0aGlzW2lkeF0KICAgIH0sCiAgICB0b0FycmF5OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5nZXQoKSB9LAogICAgc2l6ZTogZnVuY3Rpb24oKXsKICAgICAgcmV0dXJuIHRoaXMubGVuZ3RoCiAgICB9LAogICAgcmVtb3ZlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgaWYgKHRoaXMucGFyZW50Tm9kZSAhPSBudWxsKQogICAgICAgICAgdGhpcy5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMpCiAgICAgIH0pCiAgICB9LAogICAgZWFjaDogZnVuY3Rpb24oY2FsbGJhY2spewogICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwsIGlkeCl7IGNhbGxiYWNrLmNhbGwoZWwsIGlkeCwgZWwpIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgZmlsdGVyOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiAkKFtdLmZpbHRlci5jYWxsKHRoaXMsIGZ1bmN0aW9uKGVsZW1lbnQpewogICAgICAgIHJldHVybiB6ZXB0by5tYXRjaGVzKGVsZW1lbnQsIHNlbGVjdG9yKQogICAgICB9KSkKICAgIH0sCiAgICBhZGQ6IGZ1bmN0aW9uKHNlbGVjdG9yLGNvbnRleHQpewogICAgICByZXR1cm4gJCh1bmlxKHRoaXMuY29uY2F0KCQoc2VsZWN0b3IsY29udGV4dCkpKSkKICAgIH0sCiAgICBpczogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICByZXR1cm4gdGhpcy5sZW5ndGggPiAwICYmIHplcHRvLm1hdGNoZXModGhpc1swXSwgc2VsZWN0b3IpCiAgICB9LAogICAgbm90OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHZhciBub2Rlcz1bXQogICAgICBpZiAoaXNGdW5jdGlvbihzZWxlY3RvcikgJiYgc2VsZWN0b3IuY2FsbCAhPT0gdW5kZWZpbmVkKQogICAgICAgIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgICAgaWYgKCFzZWxlY3Rvci5jYWxsKHRoaXMsaWR4KSkgbm9kZXMucHVzaCh0aGlzKQogICAgICAgIH0pCiAgICAgIGVsc2UgewogICAgICAgIHZhciBleGNsdWRlcyA9IHR5cGVvZiBzZWxlY3RvciA9PSAnc3RyaW5nJyA/IHRoaXMuZmlsdGVyKHNlbGVjdG9yKSA6CiAgICAgICAgICAobGlrZUFycmF5KHNlbGVjdG9yKSAmJiBpc0Z1bmN0aW9uKHNlbGVjdG9yLml0ZW0pKSA/IHNsaWNlLmNhbGwoc2VsZWN0b3IpIDogJChzZWxlY3RvcikKICAgICAgICB0aGlzLmZvckVhY2goZnVuY3Rpb24oZWwpewogICAgICAgICAgaWYgKGV4Y2x1ZGVzLmluZGV4T2YoZWwpIDwgMCkgbm9kZXMucHVzaChlbCkKICAgICAgICB9KQogICAgICB9CiAgICAgIHJldHVybiAkKG5vZGVzKQogICAgfSwKICAgIGVxOiBmdW5jdGlvbihpZHgpewogICAgICByZXR1cm4gaWR4ID09PSAtMSA/IHRoaXMuc2xpY2UoaWR4KSA6IHRoaXMuc2xpY2UoaWR4LCArIGlkeCArIDEpCiAgICB9LAogICAgZmlyc3Q6IGZ1bmN0aW9uKCl7CiAgICAgIHZhciBlbCA9IHRoaXNbMF0KICAgICAgcmV0dXJuIGVsICYmICFpc09iamVjdChlbCkgPyBlbCA6ICQoZWwpCiAgICB9LAogICAgbGFzdDogZnVuY3Rpb24oKXsKICAgICAgdmFyIGVsID0gdGhpc1t0aGlzLmxlbmd0aCAtIDFdCiAgICAgIHJldHVybiBlbCAmJiAhaXNPYmplY3QoZWwpID8gZWwgOiAkKGVsKQogICAgfSwKICAgIGZpbmQ6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgdmFyIHJlc3VsdAogICAgICBpZiAodGhpcy5sZW5ndGggPT0gMSkgcmVzdWx0ID0gemVwdG8ucXNhKHRoaXNbMF0sIHNlbGVjdG9yKQogICAgICBlbHNlIHJlc3VsdCA9IHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB6ZXB0by5xc2EodGhpcywgc2VsZWN0b3IpIH0pCiAgICAgIHJldHVybiAkKHJlc3VsdCkKICAgIH0sCiAgICBjbG9zZXN0OiBmdW5jdGlvbihzZWxlY3RvciwgY29udGV4dCl7CiAgICAgIHZhciBub2RlID0gdGhpc1swXQogICAgICB3aGlsZSAobm9kZSAmJiAhemVwdG8ubWF0Y2hlcyhub2RlLCBzZWxlY3RvcikpCiAgICAgICAgbm9kZSA9IG5vZGUgIT09IGNvbnRleHQgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgbm9kZS5wYXJlbnROb2RlCiAgICAgIHJldHVybiAkKG5vZGUpCiAgICB9LAogICAgcGFyZW50czogZnVuY3Rpb24oc2VsZWN0b3IpewogICAgICB2YXIgYW5jZXN0b3JzID0gW10sIG5vZGVzID0gdGhpcwogICAgICB3aGlsZSAobm9kZXMubGVuZ3RoID4gMCkKICAgICAgICBub2RlcyA9ICQubWFwKG5vZGVzLCBmdW5jdGlvbihub2RlKXsKICAgICAgICAgIGlmICgobm9kZSA9IG5vZGUucGFyZW50Tm9kZSkgJiYgbm9kZSAhPT0gZG9jdW1lbnQgJiYgYW5jZXN0b3JzLmluZGV4T2Yobm9kZSkgPCAwKSB7CiAgICAgICAgICAgIGFuY2VzdG9ycy5wdXNoKG5vZGUpCiAgICAgICAgICAgIHJldHVybiBub2RlCiAgICAgICAgICB9CiAgICAgICAgfSkKICAgICAgcmV0dXJuIGZpbHRlcmVkKGFuY2VzdG9ycywgc2VsZWN0b3IpCiAgICB9LAogICAgcGFyZW50OiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh1bmlxKHRoaXMucGx1Y2soJ3BhcmVudE5vZGUnKSksIHNlbGVjdG9yKQogICAgfSwKICAgIGNoaWxkcmVuOiBmdW5jdGlvbihzZWxlY3Rvcil7CiAgICAgIHJldHVybiBmaWx0ZXJlZCh0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gc2xpY2UuY2FsbCh0aGlzLmNoaWxkcmVuKSB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgc2libGluZ3M6IGZ1bmN0aW9uKHNlbGVjdG9yKXsKICAgICAgcmV0dXJuIGZpbHRlcmVkKHRoaXMubWFwKGZ1bmN0aW9uKGksIGVsKXsKICAgICAgICByZXR1cm4gc2xpY2UuY2FsbChlbC5wYXJlbnROb2RlLmNoaWxkcmVuKS5maWx0ZXIoZnVuY3Rpb24oY2hpbGQpeyByZXR1cm4gY2hpbGQhPT1lbCB9KQogICAgICB9KSwgc2VsZWN0b3IpCiAgICB9LAogICAgZW1wdHk6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5pbm5lckhUTUwgPSAnJyB9KQogICAgfSwKICAgIC8vIGBwbHVja2AgaXMgYm9ycm93ZWQgZnJvbSBQcm90b3R5cGUuanMKICAgIHBsdWNrOiBmdW5jdGlvbihwcm9wZXJ0eSl7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbigpeyByZXR1cm4gdGhpc1twcm9wZXJ0eV0gfSkKICAgIH0sCiAgICBzaG93OiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgdGhpcy5zdHlsZS5kaXNwbGF5ID09ICJub25lIiAmJiAodGhpcy5zdHlsZS5kaXNwbGF5ID0gbnVsbCkKICAgICAgICBpZiAoZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCAnJykuZ2V0UHJvcGVydHlWYWx1ZSgiZGlzcGxheSIpID09ICJub25lIikKICAgICAgICAgIHRoaXMuc3R5bGUuZGlzcGxheSA9IGRlZmF1bHREaXNwbGF5KHRoaXMubm9kZU5hbWUpCiAgICAgIH0pCiAgICB9LAogICAgcmVwbGFjZVdpdGg6IGZ1bmN0aW9uKG5ld0NvbnRlbnQpewogICAgICByZXR1cm4gdGhpcy5iZWZvcmUobmV3Q29udGVudCkucmVtb3ZlKCkKICAgIH0sCiAgICB3cmFwOiBmdW5jdGlvbihuZXdDb250ZW50KXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAgICQodGhpcykud3JhcEFsbCgkKG5ld0NvbnRlbnQpWzBdLmNsb25lTm9kZShmYWxzZSkpCiAgICAgIH0pCiAgICB9LAogICAgd3JhcEFsbDogZnVuY3Rpb24obmV3Q29udGVudCl7CiAgICAgIGlmICh0aGlzWzBdKSB7CiAgICAgICAgJCh0aGlzWzBdKS5iZWZvcmUobmV3Q29udGVudCA9ICQobmV3Q29udGVudCkpCiAgICAgICAgbmV3Q29udGVudC5hcHBlbmQodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdGhpcwogICAgfSwKICAgIHVud3JhcDogZnVuY3Rpb24oKXsKICAgICAgdGhpcy5wYXJlbnQoKS5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgICAgJCh0aGlzKS5yZXBsYWNlV2l0aCgkKHRoaXMpLmNoaWxkcmVuKCkpCiAgICAgIH0pCiAgICAgIHJldHVybiB0aGlzCiAgICB9LAogICAgY2xvbmU6IGZ1bmN0aW9uKCl7CiAgICAgIHJldHVybiAkKHRoaXMubWFwKGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLmNsb25lTm9kZSh0cnVlKSB9KSkKICAgIH0sCiAgICBoaWRlOiBmdW5jdGlvbigpewogICAgICByZXR1cm4gdGhpcy5jc3MoImRpc3BsYXkiLCAibm9uZSIpCiAgICB9LAogICAgdG9nZ2xlOiBmdW5jdGlvbihzZXR0aW5nKXsKICAgICAgcmV0dXJuIChzZXR0aW5nID09PSB1bmRlZmluZWQgPyB0aGlzLmNzcygiZGlzcGxheSIpID09ICJub25lIiA6IHNldHRpbmcpID8gdGhpcy5zaG93KCkgOiB0aGlzLmhpZGUoKQogICAgfSwKICAgIHByZXY6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ3ByZXZpb3VzRWxlbWVudFNpYmxpbmcnKSkgfSwKICAgIG5leHQ6IGZ1bmN0aW9uKCl7IHJldHVybiAkKHRoaXMucGx1Y2soJ25leHRFbGVtZW50U2libGluZycpKSB9LAogICAgaHRtbDogZnVuY3Rpb24oaHRtbCl7CiAgICAgIHJldHVybiBodG1sID09PSB1bmRlZmluZWQgPwogICAgICAgICh0aGlzLmxlbmd0aCA+IDAgPyB0aGlzWzBdLmlubmVySFRNTCA6IG51bGwpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHZhciBvcmlnaW5IdG1sID0gdGhpcy5pbm5lckhUTUwKICAgICAgICAgICQodGhpcykuZW1wdHkoKS5hcHBlbmQoIGZ1bmNBcmcodGhpcywgaHRtbCwgaWR4LCBvcmlnaW5IdG1sKSApCiAgICAgICAgfSkKICAgIH0sCiAgICB0ZXh0OiBmdW5jdGlvbih0ZXh0KXsKICAgICAgcmV0dXJuIHRleHQgPT09IHVuZGVmaW5lZCA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udGV4dENvbnRlbnQgOiBudWxsKSA6CiAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMudGV4dENvbnRlbnQgPSB0ZXh0IH0pCiAgICB9LAogICAgYXR0cjogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICB2YXIgcmVzdWx0CiAgICAgIHJldHVybiAodHlwZW9mIG5hbWUgPT0gJ3N0cmluZycgJiYgdmFsdWUgPT09IHVuZGVmaW5lZCkgPwogICAgICAgICh0aGlzLmxlbmd0aCA9PSAwIHx8IHRoaXNbMF0ubm9kZVR5cGUgIT09IDEgPyB1bmRlZmluZWQgOgogICAgICAgICAgKG5hbWUgPT0gJ3ZhbHVlJyAmJiB0aGlzWzBdLm5vZGVOYW1lID09ICdJTlBVVCcpID8gdGhpcy52YWwoKSA6CiAgICAgICAgICAoIShyZXN1bHQgPSB0aGlzWzBdLmdldEF0dHJpYnV0ZShuYW1lKSkgJiYgbmFtZSBpbiB0aGlzWzBdKSA/IHRoaXNbMF1bbmFtZV0gOiByZXN1bHQKICAgICAgICApIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIGlmICh0aGlzLm5vZGVUeXBlICE9PSAxKSByZXR1cm4KICAgICAgICAgIGlmIChpc09iamVjdChuYW1lKSkgZm9yIChrZXkgaW4gbmFtZSkgdGhpcy5zZXRBdHRyaWJ1dGUoa2V5LCBuYW1lW2tleV0pCiAgICAgICAgICBlbHNlIHRoaXMuc2V0QXR0cmlidXRlKG5hbWUsIGZ1bmNBcmcodGhpcywgdmFsdWUsIGlkeCwgdGhpcy5nZXRBdHRyaWJ1dGUobmFtZSkpKQogICAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQXR0cjogZnVuY3Rpb24obmFtZSl7CiAgICAgIHJldHVybiB0aGlzLmVhY2goZnVuY3Rpb24oKXsgaWYgKHRoaXMubm9kZVR5cGUgPT09IDEpIHRoaXMucmVtb3ZlQXR0cmlidXRlKG5hbWUpIH0pCiAgICB9LAogICAgcHJvcDogZnVuY3Rpb24obmFtZSwgdmFsdWUpewogICAgICByZXR1cm4gKHZhbHVlID09PSB1bmRlZmluZWQpID8KICAgICAgICAodGhpc1swXSA/IHRoaXNbMF1bbmFtZV0gOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXNbbmFtZV0gPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXNbbmFtZV0pCiAgICAgICAgfSkKICAgIH0sCiAgICBkYXRhOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CiAgICAgIHZhciBkYXRhID0gdGhpcy5hdHRyKCdkYXRhLScgKyBkYXNoZXJpemUobmFtZSksIHZhbHVlKQogICAgICByZXR1cm4gZGF0YSAhPT0gbnVsbCA/IGRhdGEgOiB1bmRlZmluZWQKICAgIH0sCiAgICB2YWw6IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgcmV0dXJuICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSA/CiAgICAgICAgKHRoaXMubGVuZ3RoID4gMCA/IHRoaXNbMF0udmFsdWUgOiB1bmRlZmluZWQpIDoKICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oaWR4KXsKICAgICAgICAgIHRoaXMudmFsdWUgPSBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIHRoaXMudmFsdWUpCiAgICAgICAgfSkKICAgIH0sCiAgICBvZmZzZXQ6IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh0aGlzLmxlbmd0aD09MCkgcmV0dXJuIG51bGwKICAgICAgdmFyIG9iaiA9IHRoaXNbMF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkKICAgICAgcmV0dXJuIHsKICAgICAgICBsZWZ0OiBvYmoubGVmdCArIHdpbmRvdy5wYWdlWE9mZnNldCwKICAgICAgICB0b3A6IG9iai50b3AgKyB3aW5kb3cucGFnZVlPZmZzZXQsCiAgICAgICAgd2lkdGg6IG9iai53aWR0aCwKICAgICAgICBoZWlnaHQ6IG9iai5oZWlnaHQKICAgICAgfQogICAgfSwKICAgIGNzczogZnVuY3Rpb24ocHJvcGVydHksIHZhbHVlKXsKICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIHByb3BlcnR5ID09ICdzdHJpbmcnKQogICAgICAgIHJldHVybiAoCiAgICAgICAgICB0aGlzLmxlbmd0aCA9PSAwCiAgICAgICAgICAgID8gdW5kZWZpbmVkCiAgICAgICAgICAgIDogdGhpc1swXS5zdHlsZVtjYW1lbGl6ZShwcm9wZXJ0eSldIHx8IGdldENvbXB1dGVkU3R5bGUodGhpc1swXSwgJycpLmdldFByb3BlcnR5VmFsdWUocHJvcGVydHkpKQoKICAgICAgdmFyIGNzcyA9ICcnCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnR5KQogICAgICAgIGlmKHR5cGVvZiBwcm9wZXJ0eVtrZXldID09ICdzdHJpbmcnICYmIHByb3BlcnR5W2tleV0gPT0gJycpCiAgICAgICAgICB0aGlzLmVhY2goZnVuY3Rpb24oKXsgdGhpcy5zdHlsZS5yZW1vdmVQcm9wZXJ0eShkYXNoZXJpemUoa2V5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgKz0gZGFzaGVyaXplKGtleSkgKyAnOicgKyBtYXliZUFkZFB4KGtleSwgcHJvcGVydHlba2V5XSkgKyAnOycKCiAgICAgIGlmICh0eXBlb2YgcHJvcGVydHkgPT0gJ3N0cmluZycpCiAgICAgICAgaWYgKHZhbHVlID09ICcnKQogICAgICAgICAgdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUucmVtb3ZlUHJvcGVydHkoZGFzaGVyaXplKHByb3BlcnR5KSkgfSkKICAgICAgICBlbHNlCiAgICAgICAgICBjc3MgPSBkYXNoZXJpemUocHJvcGVydHkpICsgIjoiICsgbWF5YmVBZGRQeChwcm9wZXJ0eSwgdmFsdWUpCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7IHRoaXMuc3R5bGUuY3NzVGV4dCArPSAnOycgKyBjc3MgfSkKICAgIH0sCiAgICBpbmRleDogZnVuY3Rpb24oZWxlbWVudCl7CiAgICAgIHJldHVybiBlbGVtZW50ID8gdGhpcy5pbmRleE9mKCQoZWxlbWVudClbMF0pIDogdGhpcy5wYXJlbnQoKS5jaGlsZHJlbigpLmluZGV4T2YodGhpc1swXSkKICAgIH0sCiAgICBoYXNDbGFzczogZnVuY3Rpb24obmFtZSl7CiAgICAgIGlmICh0aGlzLmxlbmd0aCA8IDEpIHJldHVybiBmYWxzZQogICAgICBlbHNlIHJldHVybiBjbGFzc1JFKG5hbWUpLnRlc3QodGhpc1swXS5jbGFzc05hbWUpCiAgICB9LAogICAgYWRkQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgY2xhc3NMaXN0ID0gW10KICAgICAgICB2YXIgY2xzID0gdGhpcy5jbGFzc05hbWUsIG5ld05hbWUgPSBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xzKQogICAgICAgIG5ld05hbWUuc3BsaXQoL1xzKy9nKS5mb3JFYWNoKGZ1bmN0aW9uKGtsYXNzKXsKICAgICAgICAgIGlmICghJCh0aGlzKS5oYXNDbGFzcyhrbGFzcykpIGNsYXNzTGlzdC5wdXNoKGtsYXNzKQogICAgICAgIH0sIHRoaXMpCiAgICAgICAgY2xhc3NMaXN0Lmxlbmd0aCAmJiAodGhpcy5jbGFzc05hbWUgKz0gKGNscyA/ICIgIiA6ICIiKSArIGNsYXNzTGlzdC5qb2luKCIgIikpCiAgICAgIH0pCiAgICB9LAogICAgcmVtb3ZlQ2xhc3M6IGZ1bmN0aW9uKG5hbWUpewogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGlkeCl7CiAgICAgICAgaWYgKG5hbWUgPT09IHVuZGVmaW5lZCkKICAgICAgICAgIHJldHVybiB0aGlzLmNsYXNzTmFtZSA9ICcnCiAgICAgICAgY2xhc3NMaXN0ID0gdGhpcy5jbGFzc05hbWUKICAgICAgICBmdW5jQXJnKHRoaXMsIG5hbWUsIGlkeCwgY2xhc3NMaXN0KS5zcGxpdCgvXHMrL2cpLmZvckVhY2goZnVuY3Rpb24oa2xhc3MpewogICAgICAgICAgY2xhc3NMaXN0ID0gY2xhc3NMaXN0LnJlcGxhY2UoY2xhc3NSRShrbGFzcyksICIgIikKICAgICAgICB9KQogICAgICAgIHRoaXMuY2xhc3NOYW1lID0gY2xhc3NMaXN0LnRyaW0oKQogICAgICB9KQogICAgfSwKICAgIHRvZ2dsZUNsYXNzOiBmdW5jdGlvbihuYW1lLCB3aGVuKXsKICAgICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBuZXdOYW1lID0gZnVuY0FyZyh0aGlzLCBuYW1lLCBpZHgsIHRoaXMuY2xhc3NOYW1lKQogICAgICAgIDsod2hlbiA9PT0gdW5kZWZpbmVkID8gISQodGhpcykuaGFzQ2xhc3MobmV3TmFtZSkgOiB3aGVuKSA/CiAgICAgICAgICAkKHRoaXMpLmFkZENsYXNzKG5ld05hbWUpIDogJCh0aGlzKS5yZW1vdmVDbGFzcyhuZXdOYW1lKQogICAgICB9KQogICAgfQogIH0KCiAgLy8gR2VuZXJhdGUgdGhlIGB3aWR0aGAgYW5kIGBoZWlnaHRgIGZ1bmN0aW9ucwogIDtbJ3dpZHRoJywgJ2hlaWdodCddLmZvckVhY2goZnVuY3Rpb24oZGltZW5zaW9uKXsKICAgICQuZm5bZGltZW5zaW9uXSA9IGZ1bmN0aW9uKHZhbHVlKXsKICAgICAgdmFyIG9mZnNldCwgRGltZW5zaW9uID0gZGltZW5zaW9uLnJlcGxhY2UoLy4vLCBmdW5jdGlvbihtKXsgcmV0dXJuIG1bMF0udG9VcHBlckNhc2UoKSB9KQogICAgICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHRoaXNbMF0gPT0gd2luZG93ID8gd2luZG93Wydpbm5lcicgKyBEaW1lbnNpb25dIDoKICAgICAgICB0aGlzWzBdID09IGRvY3VtZW50ID8gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50WydvZmZzZXQnICsgRGltZW5zaW9uXSA6CiAgICAgICAgKG9mZnNldCA9IHRoaXMub2Zmc2V0KCkpICYmIG9mZnNldFtkaW1lbnNpb25dCiAgICAgIGVsc2UgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpZHgpewogICAgICAgIHZhciBlbCA9ICQodGhpcykKICAgICAgICBlbC5jc3MoZGltZW5zaW9uLCBmdW5jQXJnKHRoaXMsIHZhbHVlLCBpZHgsIGVsW2RpbWVuc2lvbl0oKSkpCiAgICAgIH0pCiAgICB9CiAgfSkKCiAgZnVuY3Rpb24gaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpIHsKICAgIHZhciBwYXJlbnQgPSAob3BlcmF0b3IgJSAyKSA/IHRhcmdldCA6IHRhcmdldC5wYXJlbnROb2RlCiAgICBwYXJlbnQgPyBwYXJlbnQuaW5zZXJ0QmVmb3JlKG5vZGUsCiAgICAgICFvcGVyYXRvciA/IHRhcmdldC5uZXh0U2libGluZyA6ICAgICAgLy8gYWZ0ZXIKICAgICAgb3BlcmF0b3IgPT0gMSA/IHBhcmVudC5maXJzdENoaWxkIDogICAvLyBwcmVwZW5kCiAgICAgIG9wZXJhdG9yID09IDIgPyB0YXJnZXQgOiAgICAgICAgICAgICAgLy8gYmVmb3JlCiAgICAgIG51bGwpIDogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYXBwZW5kCiAgICAgICQobm9kZSkucmVtb3ZlKCkKICB9CgogIGZ1bmN0aW9uIHRyYXZlcnNlTm9kZShub2RlLCBmdW4pIHsKICAgIGZ1bihub2RlKQogICAgZm9yICh2YXIga2V5IGluIG5vZGUuY2hpbGROb2RlcykgdHJhdmVyc2VOb2RlKG5vZGUuY2hpbGROb2Rlc1trZXldLCBmdW4pCiAgfQoKICAvLyBHZW5lcmF0ZSB0aGUgYGFmdGVyYCwgYHByZXBlbmRgLCBgYmVmb3JlYCwgYGFwcGVuZGAsCiAgLy8gYGluc2VydEFmdGVyYCwgYGluc2VydEJlZm9yZWAsIGBhcHBlbmRUb2AsIGFuZCBgcHJlcGVuZFRvYCBtZXRob2RzLgogIGFkamFjZW5jeU9wZXJhdG9ycy5mb3JFYWNoKGZ1bmN0aW9uKGtleSwgb3BlcmF0b3IpIHsKICAgICQuZm5ba2V5XSA9IGZ1bmN0aW9uKCl7CiAgICAgIC8vIGFyZ3VtZW50cyBjYW4gYmUgbm9kZXMsIGFycmF5cyBvZiBub2RlcywgWmVwdG8gb2JqZWN0cyBhbmQgSFRNTCBzdHJpbmdzCiAgICAgIHZhciBub2RlcyA9ICQubWFwKGFyZ3VtZW50cywgZnVuY3Rpb24obil7IHJldHVybiBpc09iamVjdChuKSA/IG4gOiB6ZXB0by5mcmFnbWVudChuKSB9KQogICAgICBpZiAobm9kZXMubGVuZ3RoIDwgMSkgcmV0dXJuIHRoaXMKICAgICAgdmFyIHNpemUgPSB0aGlzLmxlbmd0aCwgY29weUJ5Q2xvbmUgPSBzaXplID4gMSwgaW5SZXZlcnNlID0gb3BlcmF0b3IgPCAyCgogICAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKGluZGV4LCB0YXJnZXQpewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIHZhciBub2RlID0gbm9kZXNbaW5SZXZlcnNlID8gbm9kZXMubGVuZ3RoLWktMSA6IGldCiAgICAgICAgICB0cmF2ZXJzZU5vZGUobm9kZSwgZnVuY3Rpb24obm9kZSl7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVOYW1lICE9IG51bGwgJiYgbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpID09PSAnU0NSSVBUJyAmJiAoIW5vZGUudHlwZSB8fCBub2RlLnR5cGUgPT09ICd0ZXh0L2phdmFzY3JpcHQnKSkKICAgICAgICAgICAgICB3aW5kb3dbJ2V2YWwnXS5jYWxsKHdpbmRvdywgbm9kZS5pbm5lckhUTUwpCiAgICAgICAgICB9KQogICAgICAgICAgaWYgKGNvcHlCeUNsb25lICYmIGluZGV4IDwgc2l6ZSAtIDEpIG5vZGUgPSBub2RlLmNsb25lTm9kZSh0cnVlKQogICAgICAgICAgaW5zZXJ0KG9wZXJhdG9yLCB0YXJnZXQsIG5vZGUpCiAgICAgICAgfQogICAgICB9KQogICAgfQoKICAgICQuZm5bKG9wZXJhdG9yICUgMikgPyBrZXkrJ1RvJyA6ICdpbnNlcnQnKyhvcGVyYXRvciA/ICdCZWZvcmUnIDogJ0FmdGVyJyldID0gZnVuY3Rpb24oaHRtbCl7CiAgICAgICQoaHRtbClba2V5XSh0aGlzKQogICAgICByZXR1cm4gdGhpcwogICAgfQogIH0pCgogIHplcHRvLloucHJvdG90eXBlID0gJC5mbgoKICAvLyBFeHBvcnQgaW50ZXJuYWwgQVBJIGZ1bmN0aW9ucyBpbiB0aGUgYCQuemVwdG9gIG5hbWVzcGFjZQogIHplcHRvLmNhbWVsaXplID0gY2FtZWxpemUKICB6ZXB0by51bmlxID0gdW5pcQogICQuemVwdG8gPSB6ZXB0bwoKICByZXR1cm4gJAp9KSgpCgovLyBJZiBgJGAgaXMgbm90IHlldCBkZWZpbmVkLCBwb2ludCBpdCB0byBgWmVwdG9gCndpbmRvdy5aZXB0byA9IFplcHRvCickJyBpbiB3aW5kb3cgfHwgKHdpbmRvdy4kID0gWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyICQkID0gJC56ZXB0by5xc2EsIGhhbmRsZXJzID0ge30sIF96aWQgPSAxLCBzcGVjaWFsRXZlbnRzPXt9CgogIHNwZWNpYWxFdmVudHMuY2xpY2sgPSBzcGVjaWFsRXZlbnRzLm1vdXNlZG93biA9IHNwZWNpYWxFdmVudHMubW91c2V1cCA9IHNwZWNpYWxFdmVudHMubW91c2Vtb3ZlID0gJ01vdXNlRXZlbnRzJwoKICBmdW5jdGlvbiB6aWQoZWxlbWVudCkgewogICAgcmV0dXJuIGVsZW1lbnQuX3ppZCB8fCAoZWxlbWVudC5femlkID0gX3ppZCsrKQogIH0KICBmdW5jdGlvbiBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikgewogICAgZXZlbnQgPSBwYXJzZShldmVudCkKICAgIGlmIChldmVudC5ucykgdmFyIG1hdGNoZXIgPSBtYXRjaGVyRm9yKGV2ZW50Lm5zKQogICAgcmV0dXJuIChoYW5kbGVyc1t6aWQoZWxlbWVudCldIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaGFuZGxlcikgewogICAgICByZXR1cm4gaGFuZGxlcgogICAgICAgICYmICghZXZlbnQuZSAgfHwgaGFuZGxlci5lID09IGV2ZW50LmUpCiAgICAgICAgJiYgKCFldmVudC5ucyB8fCBtYXRjaGVyLnRlc3QoaGFuZGxlci5ucykpCiAgICAgICAgJiYgKCFmbiAgICAgICB8fCB6aWQoaGFuZGxlci5mbikgPT09IHppZChmbikpCiAgICAgICAgJiYgKCFzZWxlY3RvciB8fCBoYW5kbGVyLnNlbCA9PSBzZWxlY3RvcikKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHBhcnNlKGV2ZW50KSB7CiAgICB2YXIgcGFydHMgPSAoJycgKyBldmVudCkuc3BsaXQoJy4nKQogICAgcmV0dXJuIHtlOiBwYXJ0c1swXSwgbnM6IHBhcnRzLnNsaWNlKDEpLnNvcnQoKS5qb2luKCcgJyl9CiAgfQogIGZ1bmN0aW9uIG1hdGNoZXJGb3IobnMpIHsKICAgIHJldHVybiBuZXcgUmVnRXhwKCcoPzpefCApJyArIG5zLnJlcGxhY2UoJyAnLCAnIC4qID8nKSArICcoPzogfCQpJykKICB9CgogIGZ1bmN0aW9uIGVhY2hFdmVudChldmVudHMsIGZuLCBpdGVyYXRvcil7CiAgICBpZiAoJC5pc09iamVjdChldmVudHMpKSAkLmVhY2goZXZlbnRzLCBpdGVyYXRvcikKICAgIGVsc2UgZXZlbnRzLnNwbGl0KC9ccy8pLmZvckVhY2goZnVuY3Rpb24odHlwZSl7IGl0ZXJhdG9yKHR5cGUsIGZuKSB9KQogIH0KCiAgLy8gV0FSTiBmaXggbmFtZXNwYWNlZCBmb2N1cyAmIGJsdXIgZXZlbnRzIGRlbGVnYXRpb24uIElzc3VlcyAjNTUyICYgIzU5NyBwYXRjaGVkIGZyb20gdGhlIHVwc3RyZWFtIGNoYW5nZXM6CiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC9iYmI1Y2ExN2Q3YzE4NzRjZmYyYTlhN2MzZWE5NGE4YzhkNzlhNzkxCiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL21hZHJvYmJ5L3plcHRvL2NvbW1pdC83NGJkNmY1MzFjNWJhMTU0YmU0OGU0OGZmMjIzOTI5YTBmNTdjMmZhCiAgZnVuY3Rpb24gZXZlbnRDYXB0dXJlKGhhbmRsZXIsIGNhcHR1cmVTZXR0aW5nKSB7CiAgICByZXR1cm4gaGFuZGxlci5kZWwgJiYKICAgICAgKGhhbmRsZXIuZSA9PSAnZm9jdXMnIHx8IGhhbmRsZXIuZSA9PSAnYmx1cicpIHx8CiAgICAgICEhY2FwdHVyZVNldHRpbmcKICB9CgogIGZ1bmN0aW9uIGFkZChlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgZ2V0RGVsZWdhdGUsIGNhcHR1cmUpewogICAgdmFyIGlkID0gemlkKGVsZW1lbnQpLCBzZXQgPSAoaGFuZGxlcnNbaWRdIHx8IChoYW5kbGVyc1tpZF0gPSBbXSkpCiAgICBlYWNoRXZlbnQoZXZlbnRzLCBmbiwgZnVuY3Rpb24oZXZlbnQsIGZuKXsKICAgICAgdmFyIGRlbGVnYXRlID0gZ2V0RGVsZWdhdGUgJiYgZ2V0RGVsZWdhdGUoZm4sIGV2ZW50KSwKICAgICAgICBjYWxsYmFjayA9IGRlbGVnYXRlIHx8IGZuCiAgICAgIHZhciBwcm94eWZuID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmFwcGx5KGVsZW1lbnQsIFtldmVudF0uY29uY2F0KGV2ZW50LmRhdGEpKQogICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSBldmVudC5wcmV2ZW50RGVmYXVsdCgpCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICB9CiAgICAgIHZhciBoYW5kbGVyID0gJC5leHRlbmQocGFyc2UoZXZlbnQpLCB7Zm46IGZuLCBwcm94eTogcHJveHlmbiwgc2VsOiBzZWxlY3RvciwgZGVsOiBkZWxlZ2F0ZSwgaTogc2V0Lmxlbmd0aH0pCiAgICAgIHNldC5wdXNoKGhhbmRsZXIpCiAgICAgIGVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihoYW5kbGVyLmUsIHByb3h5Zm4sIGV2ZW50Q2FwdHVyZShoYW5kbGVyLCBjYXB0dXJlKSkKICAgIH0pCiAgfQogIGZ1bmN0aW9uIHJlbW92ZShlbGVtZW50LCBldmVudHMsIGZuLCBzZWxlY3RvciwgY2FwdHVyZSl7CiAgICB2YXIgaWQgPSB6aWQoZWxlbWVudCkKICAgIGVhY2hFdmVudChldmVudHMgfHwgJycsIGZuLCBmdW5jdGlvbihldmVudCwgZm4pewogICAgICBmaW5kSGFuZGxlcnMoZWxlbWVudCwgZXZlbnQsIGZuLCBzZWxlY3RvcikuZm9yRWFjaChmdW5jdGlvbihoYW5kbGVyKXsKICAgICAgICBkZWxldGUgaGFuZGxlcnNbaWRdW2hhbmRsZXIuaV0KICAgICAgICBlbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoaGFuZGxlci5lLCBoYW5kbGVyLnByb3h5LCBldmVudENhcHR1cmUoaGFuZGxlciwgY2FwdHVyZSkpCiAgICAgIH0pCiAgICB9KQogIH0KCiAgJC5ldmVudCA9IHsgYWRkOiBhZGQsIHJlbW92ZTogcmVtb3ZlIH0KCiAgJC5wcm94eSA9IGZ1bmN0aW9uKGZuLCBjb250ZXh0KSB7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGZuKSkgewogICAgICB2YXIgcHJveHlGbiA9IGZ1bmN0aW9uKCl7IHJldHVybiBmbi5hcHBseShjb250ZXh0LCBhcmd1bWVudHMpIH0KICAgICAgcHJveHlGbi5femlkID0gemlkKGZuKQogICAgICByZXR1cm4gcHJveHlGbgogICAgfSBlbHNlIGlmICh0eXBlb2YgY29udGV4dCA9PSAnc3RyaW5nJykgewogICAgICByZXR1cm4gJC5wcm94eShmbltjb250ZXh0XSwgZm4pCiAgICB9IGVsc2UgewogICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCJleHBlY3RlZCBmdW5jdGlvbiIpCiAgICB9CiAgfQoKICAkLmZuLmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICBhZGQodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi51bmJpbmQgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICByZW1vdmUodGhpcywgZXZlbnQsIGNhbGxiYWNrKQogICAgfSkKICB9CiAgJC5mbi5vbmUgPSBmdW5jdGlvbihldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKHRoaXMsIGV2ZW50LCBjYWxsYmFjaywgbnVsbCwgZnVuY3Rpb24oZm4sIHR5cGUpewogICAgICAgIHJldHVybiBmdW5jdGlvbigpewogICAgICAgICAgdmFyIHJlc3VsdCA9IGZuLmFwcGx5KGVsZW1lbnQsIGFyZ3VtZW50cykKICAgICAgICAgIHJlbW92ZShlbGVtZW50LCB0eXBlLCBmbikKICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICB9CiAgICAgIH0pCiAgICB9KQogIH0KCiAgdmFyIHJldHVyblRydWUgPSBmdW5jdGlvbigpe3JldHVybiB0cnVlfSwKICAgICAgcmV0dXJuRmFsc2UgPSBmdW5jdGlvbigpe3JldHVybiBmYWxzZX0sCiAgICAgIGV2ZW50TWV0aG9kcyA9IHsKICAgICAgICBwcmV2ZW50RGVmYXVsdDogJ2lzRGVmYXVsdFByZXZlbnRlZCcsCiAgICAgICAgc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uOiAnaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQnLAogICAgICAgIHN0b3BQcm9wYWdhdGlvbjogJ2lzUHJvcGFnYXRpb25TdG9wcGVkJwogICAgICB9CiAgZnVuY3Rpb24gY3JlYXRlUHJveHkoZXZlbnQpIHsKICAgIHZhciBwcm94eSA9ICQuZXh0ZW5kKHtvcmlnaW5hbEV2ZW50OiBldmVudH0sIGV2ZW50KQogICAgJC5lYWNoKGV2ZW50TWV0aG9kcywgZnVuY3Rpb24obmFtZSwgcHJlZGljYXRlKSB7CiAgICAgIHByb3h5W25hbWVdID0gZnVuY3Rpb24oKXsKICAgICAgICB0aGlzW3ByZWRpY2F0ZV0gPSByZXR1cm5UcnVlCiAgICAgICAgcmV0dXJuIGV2ZW50W25hbWVdLmFwcGx5KGV2ZW50LCBhcmd1bWVudHMpCiAgICAgIH0KICAgICAgcHJveHlbcHJlZGljYXRlXSA9IHJldHVybkZhbHNlCiAgICB9KQogICAgcmV0dXJuIHByb3h5CiAgfQoKICAvLyBlbXVsYXRlcyB0aGUgJ2RlZmF1bHRQcmV2ZW50ZWQnIHByb3BlcnR5IGZvciBicm93c2VycyB0aGF0IGhhdmUgbm9uZQogIGZ1bmN0aW9uIGZpeChldmVudCkgewogICAgaWYgKCEoJ2RlZmF1bHRQcmV2ZW50ZWQnIGluIGV2ZW50KSkgewogICAgICBldmVudC5kZWZhdWx0UHJldmVudGVkID0gZmFsc2UKICAgICAgdmFyIHByZXZlbnQgPSBldmVudC5wcmV2ZW50RGVmYXVsdAogICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMuZGVmYXVsdFByZXZlbnRlZCA9IHRydWUKICAgICAgICBwcmV2ZW50LmNhbGwodGhpcykKICAgICAgfQogICAgfQogIH0KCiAgJC5mbi5kZWxlZ2F0ZSA9IGZ1bmN0aW9uKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spewogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbihpLCBlbGVtZW50KXsKICAgICAgYWRkKGVsZW1lbnQsIGV2ZW50LCBjYWxsYmFjaywgc2VsZWN0b3IsIGZ1bmN0aW9uKGZuKXsKICAgICAgICByZXR1cm4gZnVuY3Rpb24oZSl7CiAgICAgICAgICB2YXIgZXZ0LCBtYXRjaCA9ICQoZS50YXJnZXQpLmNsb3Nlc3Qoc2VsZWN0b3IsIGVsZW1lbnQpLmdldCgwKQogICAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIGV2dCA9ICQuZXh0ZW5kKGNyZWF0ZVByb3h5KGUpLCB7Y3VycmVudFRhcmdldDogbWF0Y2gsIGxpdmVGaXJlZDogZWxlbWVudH0pCiAgICAgICAgICAgIHJldHVybiBmbi5hcHBseShtYXRjaCwgW2V2dF0uY29uY2F0KFtdLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KQogICAgfSkKICB9CiAgJC5mbi51bmRlbGVnYXRlID0gZnVuY3Rpb24oc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjayl7CiAgICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCl7CiAgICAgIHJlbW92ZSh0aGlzLCBldmVudCwgY2FsbGJhY2ssIHNlbGVjdG9yKQogICAgfSkKICB9CgogICQuZm4ubGl2ZSA9IGZ1bmN0aW9uKGV2ZW50LCBjYWxsYmFjayl7CiAgICAkKGRvY3VtZW50LmJvZHkpLmRlbGVnYXRlKHRoaXMuc2VsZWN0b3IsIGV2ZW50LCBjYWxsYmFjaykKICAgIHJldHVybiB0aGlzCiAgfQogICQuZm4uZGllID0gZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKXsKICAgICQoZG9jdW1lbnQuYm9keSkudW5kZWxlZ2F0ZSh0aGlzLnNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgICByZXR1cm4gdGhpcwogIH0KCiAgJC5mbi5vbiA9IGZ1bmN0aW9uKGV2ZW50LCBzZWxlY3RvciwgY2FsbGJhY2spewogICAgcmV0dXJuIHNlbGVjdG9yID09IHVuZGVmaW5lZCB8fCAkLmlzRnVuY3Rpb24oc2VsZWN0b3IpID8KICAgICAgdGhpcy5iaW5kKGV2ZW50LCBzZWxlY3RvcikgOiB0aGlzLmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQogICQuZm4ub2ZmID0gZnVuY3Rpb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjayl7CiAgICByZXR1cm4gc2VsZWN0b3IgPT0gdW5kZWZpbmVkIHx8ICQuaXNGdW5jdGlvbihzZWxlY3RvcikgPwogICAgICB0aGlzLnVuYmluZChldmVudCwgc2VsZWN0b3IpIDogdGhpcy51bmRlbGVnYXRlKHNlbGVjdG9yLCBldmVudCwgY2FsbGJhY2spCiAgfQoKICAkLmZuLnRyaWdnZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICBpZiAodHlwZW9mIGV2ZW50ID09ICdzdHJpbmcnKSBldmVudCA9ICQuRXZlbnQoZXZlbnQpCiAgICBmaXgoZXZlbnQpCiAgICBldmVudC5kYXRhID0gZGF0YQogICAgcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpewogICAgICAvLyBpdGVtcyBpbiB0aGUgY29sbGVjdGlvbiBtaWdodCBub3QgYmUgRE9NIGVsZW1lbnRzCiAgICAgIC8vICh0b2RvOiBwb3NzaWJseSBzdXBwb3J0IGV2ZW50cyBvbiBwbGFpbiBvbGQgb2JqZWN0cykKICAgICAgaWYoJ2Rpc3BhdGNoRXZlbnQnIGluIHRoaXMpIHRoaXMuZGlzcGF0Y2hFdmVudChldmVudCkKICAgIH0pCiAgfQoKICAvLyB0cmlnZ2VycyBldmVudCBoYW5kbGVycyBvbiBjdXJyZW50IGVsZW1lbnQganVzdCBhcyBpZiBhbiBldmVudCBvY2N1cnJlZCwKICAvLyBkb2Vzbid0IHRyaWdnZXIgYW4gYWN0dWFsIGV2ZW50LCBkb2Vzbid0IGJ1YmJsZQogICQuZm4udHJpZ2dlckhhbmRsZXIgPSBmdW5jdGlvbihldmVudCwgZGF0YSl7CiAgICB2YXIgZSwgcmVzdWx0CiAgICB0aGlzLmVhY2goZnVuY3Rpb24oaSwgZWxlbWVudCl7CiAgICAgIGUgPSBjcmVhdGVQcm94eSh0eXBlb2YgZXZlbnQgPT0gJ3N0cmluZycgPyAkLkV2ZW50KGV2ZW50KSA6IGV2ZW50KQogICAgICBlLmRhdGEgPSBkYXRhCiAgICAgIGUudGFyZ2V0ID0gZWxlbWVudAogICAgICAkLmVhY2goZmluZEhhbmRsZXJzKGVsZW1lbnQsIGV2ZW50LnR5cGUgfHwgZXZlbnQpLCBmdW5jdGlvbihpLCBoYW5kbGVyKXsKICAgICAgICByZXN1bHQgPSBoYW5kbGVyLnByb3h5KGUpCiAgICAgICAgaWYgKGUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSkgcmV0dXJuIGZhbHNlCiAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgLy8gc2hvcnRjdXQgbWV0aG9kcyBmb3IgYC5iaW5kKGV2ZW50LCBmbilgIGZvciBlYWNoIGV2ZW50IHR5cGUKICA7KCdmb2N1c2luIGZvY3Vzb3V0IGxvYWQgcmVzaXplIHNjcm9sbCB1bmxvYWQgY2xpY2sgZGJsY2xpY2sgJysKICAnbW91c2Vkb3duIG1vdXNldXAgbW91c2Vtb3ZlIG1vdXNlb3ZlciBtb3VzZW91dCAnKwogICdjaGFuZ2Ugc2VsZWN0IGtleWRvd24ga2V5cHJlc3Mga2V5dXAgZXJyb3InKS5zcGxpdCgnICcpLmZvckVhY2goZnVuY3Rpb24oZXZlbnQpIHsKICAgICQuZm5bZXZlbnRdID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKGV2ZW50LCBjYWxsYmFjaykgfQogIH0pCgogIDtbJ2ZvY3VzJywgJ2JsdXInXS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHsKICAgICQuZm5bbmFtZV0gPSBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZChuYW1lLCBjYWxsYmFjaykKICAgICAgZWxzZSBpZiAodGhpcy5sZW5ndGgpIHRyeSB7IHRoaXMuZ2V0KDApW25hbWVdKCkgfSBjYXRjaChlKXt9CiAgICAgIHJldHVybiB0aGlzCiAgICB9CiAgfSkKCiAgJC5FdmVudCA9IGZ1bmN0aW9uKHR5cGUsIHByb3BzKSB7CiAgICB2YXIgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudChzcGVjaWFsRXZlbnRzW3R5cGVdIHx8ICdFdmVudHMnKSwgYnViYmxlcyA9IHRydWUKICAgIGlmIChwcm9wcykgZm9yICh2YXIgbmFtZSBpbiBwcm9wcykgKG5hbWUgPT0gJ2J1YmJsZXMnKSA/IChidWJibGVzID0gISFwcm9wc1tuYW1lXSkgOiAoZXZlbnRbbmFtZV0gPSBwcm9wc1tuYW1lXSkKICAgIGV2ZW50LmluaXRFdmVudCh0eXBlLCBidWJibGVzLCB0cnVlLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsLCBudWxsKQogICAgcmV0dXJuIGV2ZW50CiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgZnVuY3Rpb24gZGV0ZWN0KHVhKXsKICAgIHZhciBvcyA9IHRoaXMub3MgPSB7fSwgYnJvd3NlciA9IHRoaXMuYnJvd3NlciA9IHt9LAogICAgICB3ZWJraXQgPSB1YS5tYXRjaCgvV2ViS2l0XC8oW1xkLl0rKS8pLAogICAgICBhbmRyb2lkID0gdWEubWF0Y2goLyhBbmRyb2lkKVxzKyhbXGQuXSspLyksCiAgICAgIGlwYWQgPSB1YS5tYXRjaCgvKGlQYWQpLipPU1xzKFtcZF9dKykvKSwKICAgICAgaXBob25lID0gIWlwYWQgJiYgdWEubWF0Y2goLyhpUGhvbmVcc09TKVxzKFtcZF9dKykvKSwKICAgICAgd2Vib3MgPSB1YS5tYXRjaCgvKHdlYk9TfGhwd09TKVtcc1wvXShbXGQuXSspLyksCiAgICAgIHRvdWNocGFkID0gd2Vib3MgJiYgdWEubWF0Y2goL1RvdWNoUGFkLyksCiAgICAgIGtpbmRsZSA9IHVhLm1hdGNoKC9LaW5kbGVcLyhbXGQuXSspLyksCiAgICAgIHNpbGsgPSB1YS5tYXRjaCgvU2lsa1wvKFtcZC5fXSspLyksCiAgICAgIGJsYWNrYmVycnkgPSB1YS5tYXRjaCgvKEJsYWNrQmVycnkpLipWZXJzaW9uXC8oW1xkLl0rKS8pCgogICAgLy8gdG9kbyBjbGVhbiB0aGlzIHVwIHdpdGggYSBiZXR0ZXIgT1MvYnJvd3NlcgogICAgLy8gc2VwYXJhdGlvbi4gd2UgbmVlZCB0byBkaXNjZXJuIGJldHdlZW4gbXVsdGlwbGUKICAgIC8vIGJyb3dzZXJzIG9uIGFuZHJvaWQsIGFuZCBkZWNpZGUgaWYga2luZGxlIGZpcmUgaW4KICAgIC8vIHNpbGsgbW9kZSBpcyBhbmRyb2lkIG9yIG5vdAoKICAgIGlmIChicm93c2VyLndlYmtpdCA9ICEhd2Via2l0KSBicm93c2VyLnZlcnNpb24gPSB3ZWJraXRbMV0KCiAgICBpZiAoYW5kcm9pZCkgb3MuYW5kcm9pZCA9IHRydWUsIG9zLnZlcnNpb24gPSBhbmRyb2lkWzJdCiAgICBpZiAoaXBob25lKSBvcy5pb3MgPSBvcy5pcGhvbmUgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBob25lWzJdLnJlcGxhY2UoL18vZywgJy4nKQogICAgaWYgKGlwYWQpIG9zLmlvcyA9IG9zLmlwYWQgPSB0cnVlLCBvcy52ZXJzaW9uID0gaXBhZFsyXS5yZXBsYWNlKC9fL2csICcuJykKICAgIGlmICh3ZWJvcykgb3Mud2Vib3MgPSB0cnVlLCBvcy52ZXJzaW9uID0gd2Vib3NbMl0KICAgIGlmICh0b3VjaHBhZCkgb3MudG91Y2hwYWQgPSB0cnVlCiAgICBpZiAoYmxhY2tiZXJyeSkgb3MuYmxhY2tiZXJyeSA9IHRydWUsIG9zLnZlcnNpb24gPSBibGFja2JlcnJ5WzJdCiAgICBpZiAoa2luZGxlKSBvcy5raW5kbGUgPSB0cnVlLCBvcy52ZXJzaW9uID0ga2luZGxlWzFdCiAgICBpZiAoc2lsaykgYnJvd3Nlci5zaWxrID0gdHJ1ZSwgYnJvd3Nlci52ZXJzaW9uID0gc2lsa1sxXQogICAgaWYgKCFzaWxrICYmIG9zLmFuZHJvaWQgJiYgdWEubWF0Y2goL0tpbmRsZSBGaXJlLykpIGJyb3dzZXIuc2lsayA9IHRydWUKICB9CgogIGRldGVjdC5jYWxsKCQsIG5hdmlnYXRvci51c2VyQWdlbnQpCiAgLy8gbWFrZSBhdmFpbGFibGUgdG8gdW5pdCB0ZXN0cwogICQuX19kZXRlY3QgPSBkZXRlY3QKCn0pKFplcHRvKQo7KGZ1bmN0aW9uKCQsIHVuZGVmaW5lZCl7CiAgdmFyIHByZWZpeCA9ICcnLCBldmVudFByZWZpeCwgZW5kRXZlbnROYW1lLCBlbmRBbmltYXRpb25OYW1lLAogICAgdmVuZG9ycyA9IHsgV2Via2l0OiAnd2Via2l0JywgTW96OiAnJywgTzogJ28nLCBtczogJ01TJyB9LAogICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsIHRlc3RFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLAogICAgc3VwcG9ydGVkVHJhbnNmb3JtcyA9IC9eKCh0cmFuc2xhdGV8cm90YXRlfHNjYWxlKShYfFl8WnwzZCk/fG1hdHJpeCgzZCk/fHBlcnNwZWN0aXZlfHNrZXcoWHxZKT8pJC9pLAogICAgY2xlYXJQcm9wZXJ0aWVzID0ge30KCiAgZnVuY3Rpb24gZG93bmNhc2Uoc3RyKSB7IHJldHVybiBzdHIudG9Mb3dlckNhc2UoKSB9CiAgZnVuY3Rpb24gbm9ybWFsaXplRXZlbnQobmFtZSkgeyByZXR1cm4gZXZlbnRQcmVmaXggPyBldmVudFByZWZpeCArIG5hbWUgOiBkb3duY2FzZShuYW1lKSB9CgogICQuZWFjaCh2ZW5kb3JzLCBmdW5jdGlvbih2ZW5kb3IsIGV2ZW50KXsKICAgIGlmICh0ZXN0RWwuc3R5bGVbdmVuZG9yICsgJ1RyYW5zaXRpb25Qcm9wZXJ0eSddICE9PSB1bmRlZmluZWQpIHsKICAgICAgcHJlZml4ID0gJy0nICsgZG93bmNhc2UodmVuZG9yKSArICctJwogICAgICBldmVudFByZWZpeCA9IGV2ZW50CiAgICAgIHJldHVybiBmYWxzZQogICAgfQogIH0pCgogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1wcm9wZXJ0eSddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zaXRpb24tZHVyYXRpb24nXSA9CiAgY2xlYXJQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0KICBjbGVhclByb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPQogIGNsZWFyUHJvcGVydGllc1twcmVmaXggKyAnYW5pbWF0aW9uLWR1cmF0aW9uJ10gPSAnJwoKICAkLmZ4ID0gewogICAgb2ZmOiAoZXZlbnRQcmVmaXggPT09IHVuZGVmaW5lZCAmJiB0ZXN0RWwuc3R5bGUudHJhbnNpdGlvblByb3BlcnR5ID09PSB1bmRlZmluZWQpLAogICAgY3NzUHJlZml4OiBwcmVmaXgsCiAgICB0cmFuc2l0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnVHJhbnNpdGlvbkVuZCcpLAogICAgYW5pbWF0aW9uRW5kOiBub3JtYWxpemVFdmVudCgnQW5pbWF0aW9uRW5kJykKICB9CgogICQuZm4uYW5pbWF0ZSA9IGZ1bmN0aW9uKHByb3BlcnRpZXMsIGR1cmF0aW9uLCBlYXNlLCBjYWxsYmFjayl7CiAgICBpZiAoJC5pc09iamVjdChkdXJhdGlvbikpCiAgICAgIGVhc2UgPSBkdXJhdGlvbi5lYXNpbmcsIGNhbGxiYWNrID0gZHVyYXRpb24uY29tcGxldGUsIGR1cmF0aW9uID0gZHVyYXRpb24uZHVyYXRpb24KICAgIGlmIChkdXJhdGlvbikgZHVyYXRpb24gPSBkdXJhdGlvbiAvIDEwMDAKICAgIHJldHVybiB0aGlzLmFuaW0ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKQogIH0KCiAgJC5mbi5hbmltID0gZnVuY3Rpb24ocHJvcGVydGllcywgZHVyYXRpb24sIGVhc2UsIGNhbGxiYWNrKXsKICAgIHZhciB0cmFuc2Zvcm1zLCBjc3NQcm9wZXJ0aWVzID0ge30sIGtleSwgdGhhdCA9IHRoaXMsIHdyYXBwZWRDYWxsYmFjaywgZW5kRXZlbnQgPSAkLmZ4LnRyYW5zaXRpb25FbmQKICAgIGlmIChkdXJhdGlvbiA9PT0gdW5kZWZpbmVkKSBkdXJhdGlvbiA9IDAuNAogICAgaWYgKCQuZngub2ZmKSBkdXJhdGlvbiA9IDAKCiAgICBpZiAodHlwZW9mIHByb3BlcnRpZXMgPT0gJ3N0cmluZycpIHsKICAgICAgLy8ga2V5ZnJhbWUgYW5pbWF0aW9uCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1uYW1lJ10gPSBwcm9wZXJ0aWVzCiAgICAgIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ2FuaW1hdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgZW5kRXZlbnQgPSAkLmZ4LmFuaW1hdGlvbkVuZAogICAgfSBlbHNlIHsKICAgICAgLy8gQ1NTIHRyYW5zaXRpb25zCiAgICAgIGZvciAoa2V5IGluIHByb3BlcnRpZXMpCiAgICAgICAgaWYgKHN1cHBvcnRlZFRyYW5zZm9ybXMudGVzdChrZXkpKSB7CiAgICAgICAgICB0cmFuc2Zvcm1zIHx8ICh0cmFuc2Zvcm1zID0gW10pCiAgICAgICAgICB0cmFuc2Zvcm1zLnB1c2goa2V5ICsgJygnICsgcHJvcGVydGllc1trZXldICsgJyknKQogICAgICAgIH0KICAgICAgICBlbHNlIGNzc1Byb3BlcnRpZXNba2V5XSA9IHByb3BlcnRpZXNba2V5XQoKICAgICAgaWYgKHRyYW5zZm9ybXMpIGNzc1Byb3BlcnRpZXNbcHJlZml4ICsgJ3RyYW5zZm9ybSddID0gdHJhbnNmb3Jtcy5qb2luKCcgJykKICAgICAgaWYgKCEkLmZ4Lm9mZiAmJiB0eXBlb2YgcHJvcGVydGllcyA9PT0gJ29iamVjdCcpIHsKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXByb3BlcnR5J10gPSBPYmplY3Qua2V5cyhwcm9wZXJ0aWVzKS5qb2luKCcsICcpCiAgICAgICAgY3NzUHJvcGVydGllc1twcmVmaXggKyAndHJhbnNpdGlvbi1kdXJhdGlvbiddID0gZHVyYXRpb24gKyAncycKICAgICAgICBjc3NQcm9wZXJ0aWVzW3ByZWZpeCArICd0cmFuc2l0aW9uLXRpbWluZy1mdW5jdGlvbiddID0gKGVhc2UgfHwgJ2xpbmVhcicpCiAgICAgIH0KICAgIH0KCiAgICB3cmFwcGVkQ2FsbGJhY2sgPSBmdW5jdGlvbihldmVudCl7CiAgICAgIGlmICh0eXBlb2YgZXZlbnQgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgaWYgKGV2ZW50LnRhcmdldCAhPT0gZXZlbnQuY3VycmVudFRhcmdldCkgcmV0dXJuIC8vIG1ha2VzIHN1cmUgdGhlIGV2ZW50IGRpZG4ndCBidWJibGUgZnJvbSAiYmVsb3ciCiAgICAgICAgJChldmVudC50YXJnZXQpLnVuYmluZChlbmRFdmVudCwgYXJndW1lbnRzLmNhbGxlZSkKICAgICAgfQogICAgICAkKHRoaXMpLmNzcyhjbGVhclByb3BlcnRpZXMpCiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcykKICAgIH0KICAgIGlmIChkdXJhdGlvbiA+IDApIHRoaXMuYmluZChlbmRFdmVudCwgd3JhcHBlZENhbGxiYWNrKQoKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgIHRoYXQuY3NzKGNzc1Byb3BlcnRpZXMpCiAgICAgIGlmIChkdXJhdGlvbiA8PSAwKSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgIHRoYXQuZWFjaChmdW5jdGlvbigpeyB3cmFwcGVkQ2FsbGJhY2suY2FsbCh0aGlzKSB9KQogICAgICB9LCAwKQogICAgfSwgMCkKCiAgICByZXR1cm4gdGhpcwogIH0KCiAgdGVzdEVsID0gbnVsbAp9KShaZXB0bykKOyhmdW5jdGlvbigkKXsKICB2YXIganNvbnBJRCA9IDAsCiAgICAgIGlzT2JqZWN0ID0gJC5pc09iamVjdCwKICAgICAgZG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQsCiAgICAgIGtleSwKICAgICAgbmFtZSwKICAgICAgcnNjcmlwdCA9IC88c2NyaXB0XGJbXjxdKig/Oig/ITxcL3NjcmlwdD4pPFtePF0qKSo8XC9zY3JpcHQ+L2dpLAogICAgICBzY3JpcHRUeXBlUkUgPSAvXig/OnRleHR8YXBwbGljYXRpb24pXC9qYXZhc2NyaXB0L2ksCiAgICAgIHhtbFR5cGVSRSA9IC9eKD86dGV4dHxhcHBsaWNhdGlvbilcL3htbC9pLAogICAgICBqc29uVHlwZSA9ICdhcHBsaWNhdGlvbi9qc29uJywKICAgICAgaHRtbFR5cGUgPSAndGV4dC9odG1sJywKICAgICAgYmxhbmtSRSA9IC9eXHMqJC8KCiAgLy8gdHJpZ2dlciBhIGN1c3RvbSBldmVudCBhbmQgcmV0dXJuIGZhbHNlIGlmIGl0IHdhcyBjYW5jZWxsZWQKICBmdW5jdGlvbiB0cmlnZ2VyQW5kUmV0dXJuKGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgdmFyIGV2ZW50ID0gJC5FdmVudChldmVudE5hbWUpCiAgICAkKGNvbnRleHQpLnRyaWdnZXIoZXZlbnQsIGRhdGEpCiAgICByZXR1cm4gIWV2ZW50LmRlZmF1bHRQcmV2ZW50ZWQKICB9CgogIC8vIHRyaWdnZXIgYW4gQWpheCAiZ2xvYmFsIiBldmVudAogIGZ1bmN0aW9uIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsIGV2ZW50TmFtZSwgZGF0YSkgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCkgcmV0dXJuIHRyaWdnZXJBbmRSZXR1cm4oY29udGV4dCB8fCBkb2N1bWVudCwgZXZlbnROYW1lLCBkYXRhKQogIH0KCiAgLy8gTnVtYmVyIG9mIGFjdGl2ZSBBamF4IHJlcXVlc3RzCiAgJC5hY3RpdmUgPSAwCgogIGZ1bmN0aW9uIGFqYXhTdGFydChzZXR0aW5ncykgewogICAgaWYgKHNldHRpbmdzLmdsb2JhbCAmJiAkLmFjdGl2ZSsrID09PSAwKSB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBudWxsLCAnYWpheFN0YXJ0JykKICB9CiAgZnVuY3Rpb24gYWpheFN0b3Aoc2V0dGluZ3MpIHsKICAgIGlmIChzZXR0aW5ncy5nbG9iYWwgJiYgISgtLSQuYWN0aXZlKSkgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgbnVsbCwgJ2FqYXhTdG9wJykKICB9CgogIC8vIHRyaWdnZXJzIGFuIGV4dHJhIGdsb2JhbCBldmVudCAiYWpheEJlZm9yZVNlbmQiIHRoYXQncyBsaWtlICJhamF4U2VuZCIgYnV0IGNhbmNlbGFibGUKICBmdW5jdGlvbiBhamF4QmVmb3JlU2VuZCh4aHIsIHNldHRpbmdzKSB7CiAgICB2YXIgY29udGV4dCA9IHNldHRpbmdzLmNvbnRleHQKICAgIGlmIChzZXR0aW5ncy5iZWZvcmVTZW5kLmNhbGwoY29udGV4dCwgeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlIHx8CiAgICAgICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhCZWZvcmVTZW5kJywgW3hociwgc2V0dGluZ3NdKSA9PT0gZmFsc2UpCiAgICAgIHJldHVybiBmYWxzZQoKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U2VuZCcsIFt4aHIsIHNldHRpbmdzXSkKICB9CiAgZnVuY3Rpb24gYWpheFN1Y2Nlc3MoZGF0YSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0LCBzdGF0dXMgPSAnc3VjY2VzcycKICAgIHNldHRpbmdzLnN1Y2Nlc3MuY2FsbChjb250ZXh0LCBkYXRhLCBzdGF0dXMsIHhocikKICAgIHRyaWdnZXJHbG9iYWwoc2V0dGluZ3MsIGNvbnRleHQsICdhamF4U3VjY2VzcycsIFt4aHIsIHNldHRpbmdzLCBkYXRhXSkKICAgIGFqYXhDb21wbGV0ZShzdGF0dXMsIHhociwgc2V0dGluZ3MpCiAgfQogIC8vIHR5cGU6ICJ0aW1lb3V0IiwgImVycm9yIiwgImFib3J0IiwgInBhcnNlcmVycm9yIgogIGZ1bmN0aW9uIGFqYXhFcnJvcihlcnJvciwgdHlwZSwgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5lcnJvci5jYWxsKGNvbnRleHQsIHhociwgdHlwZSwgZXJyb3IpCiAgICB0cmlnZ2VyR2xvYmFsKHNldHRpbmdzLCBjb250ZXh0LCAnYWpheEVycm9yJywgW3hociwgc2V0dGluZ3MsIGVycm9yXSkKICAgIGFqYXhDb21wbGV0ZSh0eXBlLCB4aHIsIHNldHRpbmdzKQogIH0KICAvLyBzdGF0dXM6ICJzdWNjZXNzIiwgIm5vdG1vZGlmaWVkIiwgImVycm9yIiwgInRpbWVvdXQiLCAiYWJvcnQiLCAicGFyc2VyZXJyb3IiCiAgZnVuY3Rpb24gYWpheENvbXBsZXRlKHN0YXR1cywgeGhyLCBzZXR0aW5ncykgewogICAgdmFyIGNvbnRleHQgPSBzZXR0aW5ncy5jb250ZXh0CiAgICBzZXR0aW5ncy5jb21wbGV0ZS5jYWxsKGNvbnRleHQsIHhociwgc3RhdHVzKQogICAgdHJpZ2dlckdsb2JhbChzZXR0aW5ncywgY29udGV4dCwgJ2FqYXhDb21wbGV0ZScsIFt4aHIsIHNldHRpbmdzXSkKICAgIGFqYXhTdG9wKHNldHRpbmdzKQogIH0KCiAgLy8gRW1wdHkgZnVuY3Rpb24sIHVzZWQgYXMgZGVmYXVsdCBjYWxsYmFjawogIGZ1bmN0aW9uIGVtcHR5KCkge30KCiAgJC5hamF4SlNPTlAgPSBmdW5jdGlvbihvcHRpb25zKXsKICAgIHZhciBjYWxsYmFja05hbWUgPSAnanNvbnAnICsgKCsranNvbnBJRCksCiAgICAgIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpLAogICAgICBhYm9ydCA9IGZ1bmN0aW9uKCl7CiAgICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgICAgaWYgKGNhbGxiYWNrTmFtZSBpbiB3aW5kb3cpIHdpbmRvd1tjYWxsYmFja05hbWVdID0gZW1wdHkKICAgICAgICBhamF4Q29tcGxldGUoJ2Fib3J0JywgeGhyLCBvcHRpb25zKQogICAgICB9LAogICAgICB4aHIgPSB7IGFib3J0OiBhYm9ydCB9LCBhYm9ydFRpbWVvdXQKCiAgICBpZiAob3B0aW9ucy5lcnJvcikgc2NyaXB0Lm9uZXJyb3IgPSBmdW5jdGlvbigpIHsKICAgICAgeGhyLmFib3J0KCkKICAgICAgb3B0aW9ucy5lcnJvcigpCiAgICB9CgogICAgd2luZG93W2NhbGxiYWNrTmFtZV0gPSBmdW5jdGlvbihkYXRhKXsKICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgJChzY3JpcHQpLnJlbW92ZSgpCiAgICAgIGRlbGV0ZSB3aW5kb3dbY2FsbGJhY2tOYW1lXQogICAgICBhamF4U3VjY2VzcyhkYXRhLCB4aHIsIG9wdGlvbnMpCiAgICB9CgogICAgc2VyaWFsaXplRGF0YShvcHRpb25zKQogICAgc2NyaXB0LnNyYyA9IG9wdGlvbnMudXJsLnJlcGxhY2UoLz1cPy8sICc9JyArIGNhbGxiYWNrTmFtZSkKICAgICQoJ2hlYWQnKS5hcHBlbmQoc2NyaXB0KQoKICAgIGlmIChvcHRpb25zLnRpbWVvdXQgPiAwKSBhYm9ydFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgeGhyLmFib3J0KCkKICAgICAgICBhamF4Q29tcGxldGUoJ3RpbWVvdXQnLCB4aHIsIG9wdGlvbnMpCiAgICAgIH0sIG9wdGlvbnMudGltZW91dCkKCiAgICByZXR1cm4geGhyCiAgfQoKICAkLmFqYXhTZXR0aW5ncyA9IHsKICAgIC8vIERlZmF1bHQgdHlwZSBvZiByZXF1ZXN0CiAgICB0eXBlOiAnR0VUJywKICAgIC8vIENhbGxiYWNrIHRoYXQgaXMgZXhlY3V0ZWQgYmVmb3JlIHJlcXVlc3QKICAgIGJlZm9yZVNlbmQ6IGVtcHR5LAogICAgLy8gQ2FsbGJhY2sgdGhhdCBpcyBleGVjdXRlZCBpZiB0aGUgcmVxdWVzdCBzdWNjZWVkcwogICAgc3VjY2VzczogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIHRoZSB0aGUgc2VydmVyIGRyb3BzIGVycm9yCiAgICBlcnJvcjogZW1wdHksCiAgICAvLyBDYWxsYmFjayB0aGF0IGlzIGV4ZWN1dGVkIG9uIHJlcXVlc3QgY29tcGxldGUgKGJvdGg6IGVycm9yIGFuZCBzdWNjZXNzKQogICAgY29tcGxldGU6IGVtcHR5LAogICAgLy8gVGhlIGNvbnRleHQgZm9yIHRoZSBjYWxsYmFja3MKICAgIGNvbnRleHQ6IG51bGwsCiAgICAvLyBXaGV0aGVyIHRvIHRyaWdnZXIgImdsb2JhbCIgQWpheCBldmVudHMKICAgIGdsb2JhbDogdHJ1ZSwKICAgIC8vIFRyYW5zcG9ydAogICAgeGhyOiBmdW5jdGlvbiAoKSB7CiAgICAgIHJldHVybiBuZXcgd2luZG93LlhNTEh0dHBSZXF1ZXN0KCkKICAgIH0sCiAgICAvLyBNSU1FIHR5cGVzIG1hcHBpbmcKICAgIGFjY2VwdHM6IHsKICAgICAgc2NyaXB0OiAndGV4dC9qYXZhc2NyaXB0LCBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0JywKICAgICAganNvbjogICBqc29uVHlwZSwKICAgICAgeG1sOiAgICAnYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCcsCiAgICAgIGh0bWw6ICAgaHRtbFR5cGUsCiAgICAgIHRleHQ6ICAgJ3RleHQvcGxhaW4nCiAgICB9LAogICAgLy8gV2hldGhlciB0aGUgcmVxdWVzdCBpcyB0byBhbm90aGVyIGRvbWFpbgogICAgY3Jvc3NEb21haW46IGZhbHNlLAogICAgLy8gRGVmYXVsdCB0aW1lb3V0CiAgICB0aW1lb3V0OiAwCiAgfQoKICBmdW5jdGlvbiBtaW1lVG9EYXRhVHlwZShtaW1lKSB7CiAgICByZXR1cm4gbWltZSAmJiAoIG1pbWUgPT0gaHRtbFR5cGUgPyAnaHRtbCcgOgogICAgICBtaW1lID09IGpzb25UeXBlID8gJ2pzb24nIDoKICAgICAgc2NyaXB0VHlwZVJFLnRlc3QobWltZSkgPyAnc2NyaXB0JyA6CiAgICAgIHhtbFR5cGVSRS50ZXN0KG1pbWUpICYmICd4bWwnICkgfHwgJ3RleHQnCiAgfQoKICBmdW5jdGlvbiBhcHBlbmRRdWVyeSh1cmwsIHF1ZXJ5KSB7CiAgICByZXR1cm4gKHVybCArICcmJyArIHF1ZXJ5KS5yZXBsYWNlKC9bJj9dezEsMn0vLCAnPycpCiAgfQoKICAvLyBzZXJpYWxpemUgcGF5bG9hZCBhbmQgYXBwZW5kIGl0IHRvIHRoZSBVUkwgZm9yIEdFVCByZXF1ZXN0cwogIGZ1bmN0aW9uIHNlcmlhbGl6ZURhdGEob3B0aW9ucykgewogICAgaWYgKGlzT2JqZWN0KG9wdGlvbnMuZGF0YSkpIG9wdGlvbnMuZGF0YSA9ICQucGFyYW0ob3B0aW9ucy5kYXRhKQogICAgaWYgKG9wdGlvbnMuZGF0YSAmJiAoIW9wdGlvbnMudHlwZSB8fCBvcHRpb25zLnR5cGUudG9VcHBlckNhc2UoKSA9PSAnR0VUJykpCiAgICAgIG9wdGlvbnMudXJsID0gYXBwZW5kUXVlcnkob3B0aW9ucy51cmwsIG9wdGlvbnMuZGF0YSkKICB9CgogICQuYWpheCA9IGZ1bmN0aW9uKG9wdGlvbnMpewogICAgdmFyIHNldHRpbmdzID0gJC5leHRlbmQoe30sIG9wdGlvbnMgfHwge30pCiAgICBmb3IgKGtleSBpbiAkLmFqYXhTZXR0aW5ncykgaWYgKHNldHRpbmdzW2tleV0gPT09IHVuZGVmaW5lZCkgc2V0dGluZ3Nba2V5XSA9ICQuYWpheFNldHRpbmdzW2tleV0KCiAgICBhamF4U3RhcnQoc2V0dGluZ3MpCgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgc2V0dGluZ3MuY3Jvc3NEb21haW4gPSAvXihbXHctXSs6KT9cL1wvKFteXC9dKykvLnRlc3Qoc2V0dGluZ3MudXJsKSAmJgogICAgICBSZWdFeHAuJDIgIT0gd2luZG93LmxvY2F0aW9uLmhvc3QKCiAgICB2YXIgZGF0YVR5cGUgPSBzZXR0aW5ncy5kYXRhVHlwZSwgaGFzUGxhY2Vob2xkZXIgPSAvPVw/Ly50ZXN0KHNldHRpbmdzLnVybCkKICAgIGlmIChkYXRhVHlwZSA9PSAnanNvbnAnIHx8IGhhc1BsYWNlaG9sZGVyKSB7CiAgICAgIGlmICghaGFzUGxhY2Vob2xkZXIpIHNldHRpbmdzLnVybCA9IGFwcGVuZFF1ZXJ5KHNldHRpbmdzLnVybCwgJ2NhbGxiYWNrPT8nKQogICAgICByZXR1cm4gJC5hamF4SlNPTlAoc2V0dGluZ3MpCiAgICB9CgogICAgaWYgKCFzZXR0aW5ncy51cmwpIHNldHRpbmdzLnVybCA9IHdpbmRvdy5sb2NhdGlvbi50b1N0cmluZygpCiAgICBzZXJpYWxpemVEYXRhKHNldHRpbmdzKQoKICAgIHZhciBtaW1lID0gc2V0dGluZ3MuYWNjZXB0c1tkYXRhVHlwZV0sCiAgICAgICAgYmFzZUhlYWRlcnMgPSB7IH0sCiAgICAgICAgcHJvdG9jb2wgPSAvXihbXHctXSs6KVwvXC8vLnRlc3Qoc2V0dGluZ3MudXJsKSA/IFJlZ0V4cC4kMSA6IHdpbmRvdy5sb2NhdGlvbi5wcm90b2NvbCwKICAgICAgICB4aHIgPSAkLmFqYXhTZXR0aW5ncy54aHIoKSwgYWJvcnRUaW1lb3V0CgogICAgaWYgKCFzZXR0aW5ncy5jcm9zc0RvbWFpbikgYmFzZUhlYWRlcnNbJ1gtUmVxdWVzdGVkLVdpdGgnXSA9ICdYTUxIdHRwUmVxdWVzdCcKICAgIGlmIChtaW1lKSB7CiAgICAgIGJhc2VIZWFkZXJzWydBY2NlcHQnXSA9IG1pbWUKICAgICAgaWYgKG1pbWUuaW5kZXhPZignLCcpID4gLTEpIG1pbWUgPSBtaW1lLnNwbGl0KCcsJywgMilbMF0KICAgICAgeGhyLm92ZXJyaWRlTWltZVR5cGUgJiYgeGhyLm92ZXJyaWRlTWltZVR5cGUobWltZSkKICAgIH0KICAgIGlmIChzZXR0aW5ncy5jb250ZW50VHlwZSB8fCAoc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlLnRvVXBwZXJDYXNlKCkgIT0gJ0dFVCcpKQogICAgICBiYXNlSGVhZGVyc1snQ29udGVudC1UeXBlJ10gPSAoc2V0dGluZ3MuY29udGVudFR5cGUgfHwgJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpCiAgICBzZXR0aW5ncy5oZWFkZXJzID0gJC5leHRlbmQoYmFzZUhlYWRlcnMsIHNldHRpbmdzLmhlYWRlcnMgfHwge30pCgogICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGFib3J0VGltZW91dCkKICAgICAgICB2YXIgcmVzdWx0LCBlcnJvciA9IGZhbHNlCiAgICAgICAgaWYgKCh4aHIuc3RhdHVzID49IDIwMCAmJiB4aHIuc3RhdHVzIDwgMzAwKSB8fCB4aHIuc3RhdHVzID09IDMwNCB8fCAoeGhyLnN0YXR1cyA9PSAwICYmIHByb3RvY29sID09ICdmaWxlOicpKSB7CiAgICAgICAgICBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IG1pbWVUb0RhdGFUeXBlKHhoci5nZXRSZXNwb25zZUhlYWRlcignY29udGVudC10eXBlJykpCiAgICAgICAgICByZXN1bHQgPSB4aHIucmVzcG9uc2VUZXh0CgogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGRhdGFUeXBlID09ICdzY3JpcHQnKSAgICAoMSxldmFsKShyZXN1bHQpCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICd4bWwnKSAgcmVzdWx0ID0geGhyLnJlc3BvbnNlWE1MCiAgICAgICAgICAgIGVsc2UgaWYgKGRhdGFUeXBlID09ICdqc29uJykgcmVzdWx0ID0gYmxhbmtSRS50ZXN0KHJlc3VsdCkgPyBudWxsIDogSlNPTi5wYXJzZShyZXN1bHQpCiAgICAgICAgICB9IGNhdGNoIChlKSB7IGVycm9yID0gZSB9CgogICAgICAgICAgaWYgKGVycm9yKSBhamF4RXJyb3IoZXJyb3IsICdwYXJzZXJlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgICBlbHNlIGFqYXhTdWNjZXNzKHJlc3VsdCwgeGhyLCBzZXR0aW5ncykKICAgICAgICB9IGVsc2UgewogICAgICAgICAgYWpheEVycm9yKG51bGwsICdlcnJvcicsIHhociwgc2V0dGluZ3MpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdmFyIGFzeW5jID0gJ2FzeW5jJyBpbiBzZXR0aW5ncyA/IHNldHRpbmdzLmFzeW5jIDogdHJ1ZQogICAgeGhyLm9wZW4oc2V0dGluZ3MudHlwZSwgc2V0dGluZ3MudXJsLCBhc3luYykKCiAgICBmb3IgKG5hbWUgaW4gc2V0dGluZ3MuaGVhZGVycykgeGhyLnNldFJlcXVlc3RIZWFkZXIobmFtZSwgc2V0dGluZ3MuaGVhZGVyc1tuYW1lXSkKCiAgICBpZiAoYWpheEJlZm9yZVNlbmQoeGhyLCBzZXR0aW5ncykgPT09IGZhbHNlKSB7CiAgICAgIHhoci5hYm9ydCgpCiAgICAgIHJldHVybiBmYWxzZQogICAgfQoKICAgIGlmIChzZXR0aW5ncy50aW1lb3V0ID4gMCkgYWJvcnRUaW1lb3V0ID0gc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgIHhoci5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBlbXB0eQogICAgICAgIHhoci5hYm9ydCgpCiAgICAgICAgYWpheEVycm9yKG51bGwsICd0aW1lb3V0JywgeGhyLCBzZXR0aW5ncykKICAgICAgfSwgc2V0dGluZ3MudGltZW91dCkKCiAgICAvLyBhdm9pZCBzZW5kaW5nIGVtcHR5IHN0cmluZyAoIzMxOSkKICAgIHhoci5zZW5kKHNldHRpbmdzLmRhdGEgPyBzZXR0aW5ncy5kYXRhIDogbnVsbCkKICAgIHJldHVybiB4aHIKICB9CgogICQuZ2V0ID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsgcmV0dXJuICQuYWpheCh7IHVybDogdXJsLCBzdWNjZXNzOiBzdWNjZXNzIH0pIH0KCiAgJC5wb3N0ID0gZnVuY3Rpb24odXJsLCBkYXRhLCBzdWNjZXNzLCBkYXRhVHlwZSl7CiAgICBpZiAoJC5pc0Z1bmN0aW9uKGRhdGEpKSBkYXRhVHlwZSA9IGRhdGFUeXBlIHx8IHN1Y2Nlc3MsIHN1Y2Nlc3MgPSBkYXRhLCBkYXRhID0gbnVsbAogICAgcmV0dXJuICQuYWpheCh7IHR5cGU6ICdQT1NUJywgdXJsOiB1cmwsIGRhdGE6IGRhdGEsIHN1Y2Nlc3M6IHN1Y2Nlc3MsIGRhdGFUeXBlOiBkYXRhVHlwZSB9KQogIH0KCiAgJC5nZXRKU09OID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIHJldHVybiAkLmFqYXgoeyB1cmw6IHVybCwgc3VjY2Vzczogc3VjY2VzcywgZGF0YVR5cGU6ICdqc29uJyB9KQogIH0KCiAgJC5mbi5sb2FkID0gZnVuY3Rpb24odXJsLCBzdWNjZXNzKXsKICAgIGlmICghdGhpcy5sZW5ndGgpIHJldHVybiB0aGlzCiAgICB2YXIgc2VsZiA9IHRoaXMsIHBhcnRzID0gdXJsLnNwbGl0KC9ccy8pLCBzZWxlY3RvcgogICAgaWYgKHBhcnRzLmxlbmd0aCA+IDEpIHVybCA9IHBhcnRzWzBdLCBzZWxlY3RvciA9IHBhcnRzWzFdCiAgICAkLmdldCh1cmwsIGZ1bmN0aW9uKHJlc3BvbnNlKXsKICAgICAgc2VsZi5odG1sKHNlbGVjdG9yID8KICAgICAgICAkKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpKS5odG1sKHJlc3BvbnNlLnJlcGxhY2UocnNjcmlwdCwgIiIpKS5maW5kKHNlbGVjdG9yKS5odG1sKCkKICAgICAgICA6IHJlc3BvbnNlKQogICAgICBzdWNjZXNzICYmIHN1Y2Nlc3MuY2FsbChzZWxmKQogICAgfSkKICAgIHJldHVybiB0aGlzCiAgfQoKICB2YXIgZXNjYXBlID0gZW5jb2RlVVJJQ29tcG9uZW50CgogIGZ1bmN0aW9uIHNlcmlhbGl6ZShwYXJhbXMsIG9iaiwgdHJhZGl0aW9uYWwsIHNjb3BlKXsKICAgIHZhciBhcnJheSA9ICQuaXNBcnJheShvYmopCiAgICAkLmVhY2gob2JqLCBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgIGlmIChzY29wZSkga2V5ID0gdHJhZGl0aW9uYWwgPyBzY29wZSA6IHNjb3BlICsgJ1snICsgKGFycmF5ID8gJycgOiBrZXkpICsgJ10nCiAgICAgIC8vIGhhbmRsZSBkYXRhIGluIHNlcmlhbGl6ZUFycmF5KCkgZm9ybWF0CiAgICAgIGlmICghc2NvcGUgJiYgYXJyYXkpIHBhcmFtcy5hZGQodmFsdWUubmFtZSwgdmFsdWUudmFsdWUpCiAgICAgIC8vIHJlY3Vyc2UgaW50byBuZXN0ZWQgb2JqZWN0cwogICAgICBlbHNlIGlmICh0cmFkaXRpb25hbCA/ICQuaXNBcnJheSh2YWx1ZSkgOiBpc09iamVjdCh2YWx1ZSkpCiAgICAgICAgc2VyaWFsaXplKHBhcmFtcywgdmFsdWUsIHRyYWRpdGlvbmFsLCBrZXkpCiAgICAgIGVsc2UgcGFyYW1zLmFkZChrZXksIHZhbHVlKQogICAgfSkKICB9CgogICQucGFyYW0gPSBmdW5jdGlvbihvYmosIHRyYWRpdGlvbmFsKXsKICAgIHZhciBwYXJhbXMgPSBbXQogICAgcGFyYW1zLmFkZCA9IGZ1bmN0aW9uKGssIHYpeyB0aGlzLnB1c2goZXNjYXBlKGspICsgJz0nICsgZXNjYXBlKHYpKSB9CiAgICBzZXJpYWxpemUocGFyYW1zLCBvYmosIHRyYWRpdGlvbmFsKQogICAgcmV0dXJuIHBhcmFtcy5qb2luKCcmJykucmVwbGFjZSgnJTIwJywgJysnKQogIH0KfSkoWmVwdG8pCjsoZnVuY3Rpb24gKCQpIHsKICAkLmZuLnNlcmlhbGl6ZUFycmF5ID0gZnVuY3Rpb24gKCkgewogICAgdmFyIHJlc3VsdCA9IFtdLCBlbAogICAgJCggQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwodGhpcy5nZXQoMCkuZWxlbWVudHMpICkuZWFjaChmdW5jdGlvbiAoKSB7CiAgICAgIGVsID0gJCh0aGlzKQogICAgICB2YXIgdHlwZSA9IGVsLmF0dHIoJ3R5cGUnKQogICAgICBpZiAodGhpcy5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICdmaWVsZHNldCcgJiYKICAgICAgICAhdGhpcy5kaXNhYmxlZCAmJiB0eXBlICE9ICdzdWJtaXQnICYmIHR5cGUgIT0gJ3Jlc2V0JyAmJiB0eXBlICE9ICdidXR0b24nICYmCiAgICAgICAgKCh0eXBlICE9ICdyYWRpbycgJiYgdHlwZSAhPSAnY2hlY2tib3gnKSB8fCB0aGlzLmNoZWNrZWQpKQogICAgICAgIHJlc3VsdC5wdXNoKHsKICAgICAgICAgIG5hbWU6IGVsLmF0dHIoJ25hbWUnKSwKICAgICAgICAgIHZhbHVlOiBlbC52YWwoKQogICAgICAgIH0pCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdAogIH0KCiAgJC5mbi5zZXJpYWxpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcmVzdWx0ID0gW10KICAgIHRoaXMuc2VyaWFsaXplQXJyYXkoKS5mb3JFYWNoKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgcmVzdWx0LnB1c2goIGVuY29kZVVSSUNvbXBvbmVudChlbG0ubmFtZSkgKyAnPScgKyBlbmNvZGVVUklDb21wb25lbnQoZWxtLnZhbHVlKSApCiAgICB9KQogICAgcmV0dXJuIHJlc3VsdC5qb2luKCcmJykKICB9CgogICQuZm4uc3VibWl0ID0gZnVuY3Rpb24gKGNhbGxiYWNrKSB7CiAgICBpZiAoY2FsbGJhY2spIHRoaXMuYmluZCgnc3VibWl0JywgY2FsbGJhY2spCiAgICBlbHNlIGlmICh0aGlzLmxlbmd0aCkgewogICAgICB2YXIgZXZlbnQgPSAkLkV2ZW50KCdzdWJtaXQnKQogICAgICB0aGlzLmVxKDApLnRyaWdnZXIoZXZlbnQpCiAgICAgIGlmICghZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkgdGhpcy5nZXQoMCkuc3VibWl0KCkKICAgIH0KICAgIHJldHVybiB0aGlzCiAgfQoKfSkoWmVwdG8pCjsoZnVuY3Rpb24oJCl7CiAgdmFyIHRvdWNoID0ge30sIHRvdWNoVGltZW91dAoKICBmdW5jdGlvbiBwYXJlbnRJZlRleHQobm9kZSl7CiAgICByZXR1cm4gJ3RhZ05hbWUnIGluIG5vZGUgPyBub2RlIDogbm9kZS5wYXJlbnROb2RlCiAgfQoKICBmdW5jdGlvbiBzd2lwZURpcmVjdGlvbih4MSwgeDIsIHkxLCB5Mil7CiAgICB2YXIgeERlbHRhID0gTWF0aC5hYnMoeDEgLSB4MiksIHlEZWx0YSA9IE1hdGguYWJzKHkxIC0geTIpCiAgICByZXR1cm4geERlbHRhID49IHlEZWx0YSA/ICh4MSAtIHgyID4gMCA/ICdMZWZ0JyA6ICdSaWdodCcpIDogKHkxIC0geTIgPiAwID8gJ1VwJyA6ICdEb3duJykKICB9CgogIHZhciBsb25nVGFwRGVsYXkgPSA3NTAsIGxvbmdUYXBUaW1lb3V0CgogIGZ1bmN0aW9uIGxvbmdUYXAoKXsKICAgIGxvbmdUYXBUaW1lb3V0ID0gbnVsbAogICAgaWYgKHRvdWNoLmxhc3QpIHsKICAgICAgdG91Y2guZWwudHJpZ2dlcignbG9uZ1RhcCcpCiAgICAgIHRvdWNoID0ge30KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNhbmNlbExvbmdUYXAoKXsKICAgIGlmIChsb25nVGFwVGltZW91dCkgY2xlYXJUaW1lb3V0KGxvbmdUYXBUaW1lb3V0KQogICAgbG9uZ1RhcFRpbWVvdXQgPSBudWxsCiAgfQoKICAkKGRvY3VtZW50KS5yZWFkeShmdW5jdGlvbigpewogICAgdmFyIG5vdywgZGVsdGEKCiAgICAkKGRvY3VtZW50LmJvZHkpLmJpbmQoJ3RvdWNoc3RhcnQnLCBmdW5jdGlvbihlKXsKICAgICAgbm93ID0gRGF0ZS5ub3coKQogICAgICBkZWx0YSA9IG5vdyAtICh0b3VjaC5sYXN0IHx8IG5vdykKICAgICAgdG91Y2guZWwgPSAkKHBhcmVudElmVGV4dChlLnRvdWNoZXNbMF0udGFyZ2V0KSkKICAgICAgdG91Y2hUaW1lb3V0ICYmIGNsZWFyVGltZW91dCh0b3VjaFRpbWVvdXQpCiAgICAgIHRvdWNoLngxID0gZS50b3VjaGVzWzBdLnBhZ2VYCiAgICAgIHRvdWNoLnkxID0gZS50b3VjaGVzWzBdLnBhZ2VZCiAgICAgIGlmIChkZWx0YSA+IDAgJiYgZGVsdGEgPD0gMjUwKSB0b3VjaC5pc0RvdWJsZVRhcCA9IHRydWUKICAgICAgdG91Y2gubGFzdCA9IG5vdwogICAgICBsb25nVGFwVGltZW91dCA9IHNldFRpbWVvdXQobG9uZ1RhcCwgbG9uZ1RhcERlbGF5KQogICAgfSkuYmluZCgndG91Y2htb3ZlJywgZnVuY3Rpb24oZSl7CiAgICAgIGNhbmNlbExvbmdUYXAoKQogICAgICB0b3VjaC54MiA9IGUudG91Y2hlc1swXS5wYWdlWAogICAgICB0b3VjaC55MiA9IGUudG91Y2hlc1swXS5wYWdlWQogICAgfSkuYmluZCgndG91Y2hlbmQnLCBmdW5jdGlvbihlKXsKICAgICAgIGNhbmNlbExvbmdUYXAoKQoKICAgICAgLy8gZG91YmxlIHRhcCAodGFwcGVkIHR3aWNlIHdpdGhpbiAyNTBtcykKICAgICAgaWYgKHRvdWNoLmlzRG91YmxlVGFwKSB7CiAgICAgICAgdG91Y2guZWwudHJpZ2dlcignZG91YmxlVGFwJykKICAgICAgICB0b3VjaCA9IHt9CgogICAgICAvLyBzd2lwZQogICAgICB9IGVsc2UgaWYgKCh0b3VjaC54MiAmJiBNYXRoLmFicyh0b3VjaC54MSAtIHRvdWNoLngyKSA+IDMwKSB8fAogICAgICAgICAgICAgICAgICh0b3VjaC55MiAmJiBNYXRoLmFicyh0b3VjaC55MSAtIHRvdWNoLnkyKSA+IDMwKSkgewogICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJykgJiYKICAgICAgICAgIHRvdWNoLmVsLnRyaWdnZXIoJ3N3aXBlJyArIChzd2lwZURpcmVjdGlvbih0b3VjaC54MSwgdG91Y2gueDIsIHRvdWNoLnkxLCB0b3VjaC55MikpKQogICAgICAgIHRvdWNoID0ge30KCiAgICAgIC8vIG5vcm1hbCB0YXAKICAgICAgfSBlbHNlIGlmICgnbGFzdCcgaW4gdG91Y2gpIHsKICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCd0YXAnKQoKICAgICAgICB0b3VjaFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgICAgICB0b3VjaC5lbC50cmlnZ2VyKCdzaW5nbGVUYXAnKQogICAgICAgICAgdG91Y2ggPSB7fQogICAgICAgIH0sIDI1MCkKICAgICAgfQogICAgfSkuYmluZCgndG91Y2hjYW5jZWwnLCBmdW5jdGlvbigpewogICAgICBpZiAodG91Y2hUaW1lb3V0KSBjbGVhclRpbWVvdXQodG91Y2hUaW1lb3V0KQogICAgICBpZiAobG9uZ1RhcFRpbWVvdXQpIGNsZWFyVGltZW91dChsb25nVGFwVGltZW91dCkKICAgICAgbG9uZ1RhcFRpbWVvdXQgPSB0b3VjaFRpbWVvdXQgPSBudWxsCiAgICAgIHRvdWNoID0ge30KICAgIH0pCiAgfSkKCiAgO1snc3dpcGUnLCAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnLCAnc3dpcGVVcCcsICdzd2lwZURvd24nLCAnZG91YmxlVGFwJywgJ3RhcCcsICdzaW5nbGVUYXAnLCAnbG9uZ1RhcCddLmZvckVhY2goZnVuY3Rpb24obSl7CiAgICAkLmZuW21dID0gZnVuY3Rpb24oY2FsbGJhY2speyByZXR1cm4gdGhpcy5iaW5kKG0sIGNhbGxiYWNrKSB9CiAgfSkKfSkoWmVwdG8pCgovLyBsaWIvaGFuZGxlYmFycy9iYXNlLmpzCgovKmpzaGludCBlcW51bGw6dHJ1ZSovCnRoaXMuSGFuZGxlYmFycyA9IHt9OwoKKGZ1bmN0aW9uKEhhbmRsZWJhcnMpIHsKCkhhbmRsZWJhcnMuVkVSU0lPTiA9ICIxLjAucmMuMSI7CgpIYW5kbGViYXJzLmhlbHBlcnMgID0ge307CkhhbmRsZWJhcnMucGFydGlhbHMgPSB7fTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIgPSBmdW5jdGlvbihuYW1lLCBmbiwgaW52ZXJzZSkgewogIGlmKGludmVyc2UpIHsgZm4ubm90ID0gaW52ZXJzZTsgfQogIHRoaXMuaGVscGVyc1tuYW1lXSA9IGZuOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlclBhcnRpYWwgPSBmdW5jdGlvbihuYW1lLCBzdHIpIHsKICB0aGlzLnBhcnRpYWxzW25hbWVdID0gc3RyOwp9OwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaGVscGVyTWlzc2luZycsIGZ1bmN0aW9uKGFyZykgewogIGlmKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHsKICAgIHJldHVybiB1bmRlZmluZWQ7CiAgfSBlbHNlIHsKICAgIHRocm93IG5ldyBFcnJvcigiQ291bGQgbm90IGZpbmQgcHJvcGVydHkgJyIgKyBhcmcgKyAiJyIpOwogIH0KfSk7Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLCBmdW5jdGlvblR5cGUgPSAiW29iamVjdCBGdW5jdGlvbl0iOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYmxvY2tIZWxwZXJNaXNzaW5nJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBpbnZlcnNlID0gb3B0aW9ucy5pbnZlcnNlIHx8IGZ1bmN0aW9uKCkge30sIGZuID0gb3B0aW9ucy5mbjsKCgogIHZhciByZXQgPSAiIjsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CgogIGlmKHR5cGUgPT09IGZ1bmN0aW9uVHlwZSkgeyBjb250ZXh0ID0gY29udGV4dC5jYWxsKHRoaXMpOyB9CgogIGlmKGNvbnRleHQgPT09IHRydWUpIHsKICAgIHJldHVybiBmbih0aGlzKTsKICB9IGVsc2UgaWYoY29udGV4dCA9PT0gZmFsc2UgfHwgY29udGV4dCA9PSBudWxsKSB7CiAgICByZXR1cm4gaW52ZXJzZSh0aGlzKTsKICB9IGVsc2UgaWYodHlwZSA9PT0gIltvYmplY3QgQXJyYXldIikgewogICAgaWYoY29udGV4dC5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnMuZWFjaChjb250ZXh0LCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnZlcnNlKHRoaXMpOwogICAgfQogIH0gZWxzZSB7CiAgICByZXR1cm4gZm4oY29udGV4dCk7CiAgfQp9KTsKCkhhbmRsZWJhcnMuSyA9IGZ1bmN0aW9uKCkge307CgpIYW5kbGViYXJzLmNyZWF0ZUZyYW1lID0gT2JqZWN0LmNyZWF0ZSB8fCBmdW5jdGlvbihvYmplY3QpIHsKICBIYW5kbGViYXJzLksucHJvdG90eXBlID0gb2JqZWN0OwogIHZhciBvYmogPSBuZXcgSGFuZGxlYmFycy5LKCk7CiAgSGFuZGxlYmFycy5LLnByb3RvdHlwZSA9IG51bGw7CiAgcmV0dXJuIG9iajsKfTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VhY2gnLCBmdW5jdGlvbihjb250ZXh0LCBvcHRpb25zKSB7CiAgdmFyIGZuID0gb3B0aW9ucy5mbiwgaW52ZXJzZSA9IG9wdGlvbnMuaW52ZXJzZTsKICB2YXIgcmV0ID0gIiIsIGRhdGE7CgogIGlmIChvcHRpb25zLmRhdGEpIHsKICAgIGRhdGEgPSBIYW5kbGViYXJzLmNyZWF0ZUZyYW1lKG9wdGlvbnMuZGF0YSk7CiAgfQoKICBpZihjb250ZXh0ICYmIGNvbnRleHQubGVuZ3RoID4gMCkgewogICAgZm9yKHZhciBpPTAsIGo9Y29udGV4dC5sZW5ndGg7IGk8ajsgaSsrKSB7CiAgICAgIGlmIChkYXRhKSB7IGRhdGEuaW5kZXggPSBpOyB9CiAgICAgIHJldCA9IHJldCArIGZuKGNvbnRleHRbaV0sIHsgZGF0YTogZGF0YSB9KTsKICAgIH0KICB9IGVsc2UgewogICAgcmV0ID0gaW52ZXJzZSh0aGlzKTsKICB9CiAgcmV0dXJuIHJldDsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZicsIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICB2YXIgdHlwZSA9IHRvU3RyaW5nLmNhbGwoY29udGV4dCk7CiAgaWYodHlwZSA9PT0gZnVuY3Rpb25UeXBlKSB7IGNvbnRleHQgPSBjb250ZXh0LmNhbGwodGhpcyk7IH0KCiAgaWYoIWNvbnRleHQgfHwgSGFuZGxlYmFycy5VdGlscy5pc0VtcHR5KGNvbnRleHQpKSB7CiAgICByZXR1cm4gb3B0aW9ucy5pbnZlcnNlKHRoaXMpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gb3B0aW9ucy5mbih0aGlzKTsKICB9Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcigndW5sZXNzJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHZhciBmbiA9IG9wdGlvbnMuZm4sIGludmVyc2UgPSBvcHRpb25zLmludmVyc2U7CiAgb3B0aW9ucy5mbiA9IGludmVyc2U7CiAgb3B0aW9ucy5pbnZlcnNlID0gZm47CgogIHJldHVybiBIYW5kbGViYXJzLmhlbHBlcnNbJ2lmJ10uY2FsbCh0aGlzLCBjb250ZXh0LCBvcHRpb25zKTsKfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd3aXRoJywgZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogIHJldHVybiBvcHRpb25zLmZuKGNvbnRleHQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2xvZycsIGZ1bmN0aW9uKGNvbnRleHQpIHsKICBIYW5kbGViYXJzLmxvZyhjb250ZXh0KTsKfSk7Cgp9KHRoaXMuSGFuZGxlYmFycykpOwo7Ci8vIGxpYi9oYW5kbGViYXJzL2NvbXBpbGVyL3BhcnNlci5qcwovKiBKaXNvbiBnZW5lcmF0ZWQgcGFyc2VyICovCnZhciBoYW5kbGViYXJzID0gKGZ1bmN0aW9uKCl7CnZhciBwYXJzZXIgPSB7dHJhY2U6IGZ1bmN0aW9uIHRyYWNlKCkgeyB9LAp5eToge30sCnN5bWJvbHNfOiB7ImVycm9yIjoyLCJyb290IjozLCJwcm9ncmFtIjo0LCJFT0YiOjUsInN0YXRlbWVudHMiOjYsInNpbXBsZUludmVyc2UiOjcsInN0YXRlbWVudCI6OCwib3BlbkludmVyc2UiOjksImNsb3NlQmxvY2siOjEwLCJvcGVuQmxvY2siOjExLCJtdXN0YWNoZSI6MTIsInBhcnRpYWwiOjEzLCJDT05URU5UIjoxNCwiQ09NTUVOVCI6MTUsIk9QRU5fQkxPQ0siOjE2LCJpbk11c3RhY2hlIjoxNywiQ0xPU0UiOjE4LCJPUEVOX0lOVkVSU0UiOjE5LCJPUEVOX0VOREJMT0NLIjoyMCwicGF0aCI6MjEsIk9QRU4iOjIyLCJPUEVOX1VORVNDQVBFRCI6MjMsIk9QRU5fUEFSVElBTCI6MjQsInBhcmFtcyI6MjUsImhhc2giOjI2LCJEQVRBIjoyNywicGFyYW0iOjI4LCJTVFJJTkciOjI5LCJJTlRFR0VSIjozMCwiQk9PTEVBTiI6MzEsImhhc2hTZWdtZW50cyI6MzIsImhhc2hTZWdtZW50IjozMywiSUQiOjM0LCJFUVVBTFMiOjM1LCJwYXRoU2VnbWVudHMiOjM2LCJTRVAiOjM3LCIkYWNjZXB0IjowLCIkZW5kIjoxfSwKdGVybWluYWxzXzogezI6ImVycm9yIiw1OiJFT0YiLDE0OiJDT05URU5UIiwxNToiQ09NTUVOVCIsMTY6Ik9QRU5fQkxPQ0siLDE4OiJDTE9TRSIsMTk6Ik9QRU5fSU5WRVJTRSIsMjA6Ik9QRU5fRU5EQkxPQ0siLDIyOiJPUEVOIiwyMzoiT1BFTl9VTkVTQ0FQRUQiLDI0OiJPUEVOX1BBUlRJQUwiLDI3OiJEQVRBIiwyOToiU1RSSU5HIiwzMDoiSU5URUdFUiIsMzE6IkJPT0xFQU4iLDM0OiJJRCIsMzU6IkVRVUFMUyIsMzc6IlNFUCJ9LApwcm9kdWN0aW9uc186IFswLFszLDJdLFs0LDNdLFs0LDFdLFs0LDBdLFs2LDFdLFs2LDJdLFs4LDNdLFs4LDNdLFs4LDFdLFs4LDFdLFs4LDFdLFs4LDFdLFsxMSwzXSxbOSwzXSxbMTAsM10sWzEyLDNdLFsxMiwzXSxbMTMsM10sWzEzLDRdLFs3LDJdLFsxNywzXSxbMTcsMl0sWzE3LDJdLFsxNywxXSxbMTcsMV0sWzI1LDJdLFsyNSwxXSxbMjgsMV0sWzI4LDFdLFsyOCwxXSxbMjgsMV0sWzI4LDFdLFsyNiwxXSxbMzIsMl0sWzMyLDFdLFszMywzXSxbMzMsM10sWzMzLDNdLFszMywzXSxbMzMsM10sWzIxLDFdLFszNiwzXSxbMzYsMV1dLApwZXJmb3JtQWN0aW9uOiBmdW5jdGlvbiBhbm9ueW1vdXMoeXl0ZXh0LHl5bGVuZyx5eWxpbmVubyx5eSx5eXN0YXRlLCQkLF8kKSB7Cgp2YXIgJDAgPSAkJC5sZW5ndGggLSAxOwpzd2l0Y2ggKHl5c3RhdGUpIHsKY2FzZSAxOiByZXR1cm4gJCRbJDAtMV07IApicmVhazsKY2FzZSAyOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDAtMl0sICQkWyQwXSk7IApicmVhazsKY2FzZSAzOiB0aGlzLiQgPSBuZXcgeXkuUHJvZ3JhbU5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDQ6IHRoaXMuJCA9IG5ldyB5eS5Qcm9ncmFtTm9kZShbXSk7IApicmVhazsKY2FzZSA1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSA3OiB0aGlzLiQgPSBuZXcgeXkuQmxvY2tOb2RlKCQkWyQwLTJdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMC0xXSwgJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDg6IHRoaXMuJCA9IG5ldyB5eS5CbG9ja05vZGUoJCRbJDAtMl0sICQkWyQwLTFdLCAkJFskMC0xXS5pbnZlcnNlLCAkJFskMF0pOyAKYnJlYWs7CmNhc2UgOTogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMTA6IHRoaXMuJCA9ICQkWyQwXTsgCmJyZWFrOwpjYXNlIDExOiB0aGlzLiQgPSBuZXcgeXkuQ29udGVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEyOiB0aGlzLiQgPSBuZXcgeXkuQ29tbWVudE5vZGUoJCRbJDBdKTsgCmJyZWFrOwpjYXNlIDEzOiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSk7IApicmVhazsKY2FzZSAxNDogdGhpcy4kID0gbmV3IHl5Lk11c3RhY2hlTm9kZSgkJFskMC0xXVswXSwgJCRbJDAtMV1bMV0pOyAKYnJlYWs7CmNhc2UgMTU6IHRoaXMuJCA9ICQkWyQwLTFdOyAKYnJlYWs7CmNhc2UgMTY6IHRoaXMuJCA9IG5ldyB5eS5NdXN0YWNoZU5vZGUoJCRbJDAtMV1bMF0sICQkWyQwLTFdWzFdKTsgCmJyZWFrOwpjYXNlIDE3OiB0aGlzLiQgPSBuZXcgeXkuTXVzdGFjaGVOb2RlKCQkWyQwLTFdWzBdLCAkJFskMC0xXVsxXSwgdHJ1ZSk7IApicmVhazsKY2FzZSAxODogdGhpcy4kID0gbmV3IHl5LlBhcnRpYWxOb2RlKCQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDE5OiB0aGlzLiQgPSBuZXcgeXkuUGFydGlhbE5vZGUoJCRbJDAtMl0sICQkWyQwLTFdKTsgCmJyZWFrOwpjYXNlIDIwOiAKYnJlYWs7CmNhc2UgMjE6IHRoaXMuJCA9IFtbJCRbJDAtMl1dLmNvbmNhdCgkJFskMC0xXSksICQkWyQwXV07IApicmVhazsKY2FzZSAyMjogdGhpcy4kID0gW1skJFskMC0xXV0uY29uY2F0KCQkWyQwXSksIG51bGxdOyAKYnJlYWs7CmNhc2UgMjM6IHRoaXMuJCA9IFtbJCRbJDAtMV1dLCAkJFskMF1dOyAKYnJlYWs7CmNhc2UgMjQ6IHRoaXMuJCA9IFtbJCRbJDBdXSwgbnVsbF07IApicmVhazsKY2FzZSAyNTogdGhpcy4kID0gW1tuZXcgeXkuRGF0YU5vZGUoJCRbJDBdKV0sIG51bGxdOyAKYnJlYWs7CmNhc2UgMjY6ICQkWyQwLTFdLnB1c2goJCRbJDBdKTsgdGhpcy4kID0gJCRbJDAtMV07IApicmVhazsKY2FzZSAyNzogdGhpcy4kID0gWyQkWyQwXV07IApicmVhazsKY2FzZSAyODogdGhpcy4kID0gJCRbJDBdOyAKYnJlYWs7CmNhc2UgMjk6IHRoaXMuJCA9IG5ldyB5eS5TdHJpbmdOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMDogdGhpcy4kID0gbmV3IHl5LkludGVnZXJOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMTogdGhpcy4kID0gbmV3IHl5LkJvb2xlYW5Ob2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMjogdGhpcy4kID0gbmV3IHl5LkRhdGFOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzMzogdGhpcy4kID0gbmV3IHl5Lkhhc2hOb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSAzNDogJCRbJDAtMV0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0xXTsgCmJyZWFrOwpjYXNlIDM1OiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwpjYXNlIDM2OiB0aGlzLiQgPSBbJCRbJDAtMl0sICQkWyQwXV07IApicmVhazsKY2FzZSAzNzogdGhpcy4kID0gWyQkWyQwLTJdLCBuZXcgeXkuU3RyaW5nTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM4OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5JbnRlZ2VyTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDM5OiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5Cb29sZWFuTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQwOiB0aGlzLiQgPSBbJCRbJDAtMl0sIG5ldyB5eS5EYXRhTm9kZSgkJFskMF0pXTsgCmJyZWFrOwpjYXNlIDQxOiB0aGlzLiQgPSBuZXcgeXkuSWROb2RlKCQkWyQwXSk7IApicmVhazsKY2FzZSA0MjogJCRbJDAtMl0ucHVzaCgkJFskMF0pOyB0aGlzLiQgPSAkJFskMC0yXTsgCmJyZWFrOwpjYXNlIDQzOiB0aGlzLiQgPSBbJCRbJDBdXTsgCmJyZWFrOwp9Cn0sCnRhYmxlOiBbezM6MSw0OjIsNTpbMiw0XSw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezE6WzNdfSx7NTpbMSwxNl19LHs1OlsyLDNdLDc6MTcsODoxOCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxOV0sMjA6WzIsM10sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDVdLDE0OlsyLDVdLDE1OlsyLDVdLDE2OlsyLDVdLDE5OlsyLDVdLDIwOlsyLDVdLDIyOlsyLDVdLDIzOlsyLDVdLDI0OlsyLDVdfSx7NDoyMCw2OjMsODo0LDk6NSwxMTo2LDEyOjcsMTM6OCwxNDpbMSw5XSwxNTpbMSwxMF0sMTY6WzEsMTJdLDE5OlsxLDExXSwyMDpbMiw0XSwyMjpbMSwxM10sMjM6WzEsMTRdLDI0OlsxLDE1XX0sezQ6MjEsNjozLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjA6WzIsNF0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDldLDE0OlsyLDldLDE1OlsyLDldLDE2OlsyLDldLDE5OlsyLDldLDIwOlsyLDldLDIyOlsyLDldLDIzOlsyLDldLDI0OlsyLDldfSx7NTpbMiwxMF0sMTQ6WzIsMTBdLDE1OlsyLDEwXSwxNjpbMiwxMF0sMTk6WzIsMTBdLDIwOlsyLDEwXSwyMjpbMiwxMF0sMjM6WzIsMTBdLDI0OlsyLDEwXX0sezU6WzIsMTFdLDE0OlsyLDExXSwxNTpbMiwxMV0sMTY6WzIsMTFdLDE5OlsyLDExXSwyMDpbMiwxMV0sMjI6WzIsMTFdLDIzOlsyLDExXSwyNDpbMiwxMV19LHs1OlsyLDEyXSwxNDpbMiwxMl0sMTU6WzIsMTJdLDE2OlsyLDEyXSwxOTpbMiwxMl0sMjA6WzIsMTJdLDIyOlsyLDEyXSwyMzpbMiwxMl0sMjQ6WzIsMTJdfSx7MTc6MjIsMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezE3OjI3LDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxNzoyOCwyMToyMywyNzpbMSwyNF0sMzQ6WzEsMjZdLDM2OjI1fSx7MTc6MjksMjE6MjMsMjc6WzEsMjRdLDM0OlsxLDI2XSwzNjoyNX0sezIxOjMwLDM0OlsxLDI2XSwzNjoyNX0sezE6WzIsMV19LHs2OjMxLDg6NCw5OjUsMTE6NiwxMjo3LDEzOjgsMTQ6WzEsOV0sMTU6WzEsMTBdLDE2OlsxLDEyXSwxOTpbMSwxMV0sMjI6WzEsMTNdLDIzOlsxLDE0XSwyNDpbMSwxNV19LHs1OlsyLDZdLDE0OlsyLDZdLDE1OlsyLDZdLDE2OlsyLDZdLDE5OlsyLDZdLDIwOlsyLDZdLDIyOlsyLDZdLDIzOlsyLDZdLDI0OlsyLDZdfSx7MTc6MjIsMTg6WzEsMzJdLDIxOjIzLDI3OlsxLDI0XSwzNDpbMSwyNl0sMzY6MjV9LHsxMDozMywyMDpbMSwzNF19LHsxMDozNSwyMDpbMSwzNF19LHsxODpbMSwzNl19LHsxODpbMiwyNF0sMjE6NDEsMjU6MzcsMjY6MzgsMjc6WzEsNDVdLDI4OjM5LDI5OlsxLDQyXSwzMDpbMSw0M10sMzE6WzEsNDRdLDMyOjQwLDMzOjQ2LDM0OlsxLDQ3XSwzNjoyNX0sezE4OlsyLDI1XX0sezE4OlsyLDQxXSwyNzpbMiw0MV0sMjk6WzIsNDFdLDMwOlsyLDQxXSwzMTpbMiw0MV0sMzQ6WzIsNDFdLDM3OlsxLDQ4XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM3OlsyLDQzXX0sezE4OlsxLDQ5XX0sezE4OlsxLDUwXX0sezE4OlsxLDUxXX0sezE4OlsxLDUyXSwyMTo1MywzNDpbMSwyNl0sMzY6MjV9LHs1OlsyLDJdLDg6MTgsOTo1LDExOjYsMTI6NywxMzo4LDE0OlsxLDldLDE1OlsxLDEwXSwxNjpbMSwxMl0sMTk6WzEsMTFdLDIwOlsyLDJdLDIyOlsxLDEzXSwyMzpbMSwxNF0sMjQ6WzEsMTVdfSx7MTQ6WzIsMjBdLDE1OlsyLDIwXSwxNjpbMiwyMF0sMTk6WzIsMjBdLDIyOlsyLDIwXSwyMzpbMiwyMF0sMjQ6WzIsMjBdfSx7NTpbMiw3XSwxNDpbMiw3XSwxNTpbMiw3XSwxNjpbMiw3XSwxOTpbMiw3XSwyMDpbMiw3XSwyMjpbMiw3XSwyMzpbMiw3XSwyNDpbMiw3XX0sezIxOjU0LDM0OlsxLDI2XSwzNjoyNX0sezU6WzIsOF0sMTQ6WzIsOF0sMTU6WzIsOF0sMTY6WzIsOF0sMTk6WzIsOF0sMjA6WzIsOF0sMjI6WzIsOF0sMjM6WzIsOF0sMjQ6WzIsOF19LHsxNDpbMiwxNF0sMTU6WzIsMTRdLDE2OlsyLDE0XSwxOTpbMiwxNF0sMjA6WzIsMTRdLDIyOlsyLDE0XSwyMzpbMiwxNF0sMjQ6WzIsMTRdfSx7MTg6WzIsMjJdLDIxOjQxLDI2OjU1LDI3OlsxLDQ1XSwyODo1NiwyOTpbMSw0Ml0sMzA6WzEsNDNdLDMxOlsxLDQ0XSwzMjo0MCwzMzo0NiwzNDpbMSw0N10sMzY6MjV9LHsxODpbMiwyM119LHsxODpbMiwyN10sMjc6WzIsMjddLDI5OlsyLDI3XSwzMDpbMiwyN10sMzE6WzIsMjddLDM0OlsyLDI3XX0sezE4OlsyLDMzXSwzMzo1NywzNDpbMSw1OF19LHsxODpbMiwyOF0sMjc6WzIsMjhdLDI5OlsyLDI4XSwzMDpbMiwyOF0sMzE6WzIsMjhdLDM0OlsyLDI4XX0sezE4OlsyLDI5XSwyNzpbMiwyOV0sMjk6WzIsMjldLDMwOlsyLDI5XSwzMTpbMiwyOV0sMzQ6WzIsMjldfSx7MTg6WzIsMzBdLDI3OlsyLDMwXSwyOTpbMiwzMF0sMzA6WzIsMzBdLDMxOlsyLDMwXSwzNDpbMiwzMF19LHsxODpbMiwzMV0sMjc6WzIsMzFdLDI5OlsyLDMxXSwzMDpbMiwzMV0sMzE6WzIsMzFdLDM0OlsyLDMxXX0sezE4OlsyLDMyXSwyNzpbMiwzMl0sMjk6WzIsMzJdLDMwOlsyLDMyXSwzMTpbMiwzMl0sMzQ6WzIsMzJdfSx7MTg6WzIsMzVdLDM0OlsyLDM1XX0sezE4OlsyLDQzXSwyNzpbMiw0M10sMjk6WzIsNDNdLDMwOlsyLDQzXSwzMTpbMiw0M10sMzQ6WzIsNDNdLDM1OlsxLDU5XSwzNzpbMiw0M119LHszNDpbMSw2MF19LHsxNDpbMiwxM10sMTU6WzIsMTNdLDE2OlsyLDEzXSwxOTpbMiwxM10sMjA6WzIsMTNdLDIyOlsyLDEzXSwyMzpbMiwxM10sMjQ6WzIsMTNdfSx7NTpbMiwxNl0sMTQ6WzIsMTZdLDE1OlsyLDE2XSwxNjpbMiwxNl0sMTk6WzIsMTZdLDIwOlsyLDE2XSwyMjpbMiwxNl0sMjM6WzIsMTZdLDI0OlsyLDE2XX0sezU6WzIsMTddLDE0OlsyLDE3XSwxNTpbMiwxN10sMTY6WzIsMTddLDE5OlsyLDE3XSwyMDpbMiwxN10sMjI6WzIsMTddLDIzOlsyLDE3XSwyNDpbMiwxN119LHs1OlsyLDE4XSwxNDpbMiwxOF0sMTU6WzIsMThdLDE2OlsyLDE4XSwxOTpbMiwxOF0sMjA6WzIsMThdLDIyOlsyLDE4XSwyMzpbMiwxOF0sMjQ6WzIsMThdfSx7MTg6WzEsNjFdfSx7MTg6WzEsNjJdfSx7MTg6WzIsMjFdfSx7MTg6WzIsMjZdLDI3OlsyLDI2XSwyOTpbMiwyNl0sMzA6WzIsMjZdLDMxOlsyLDI2XSwzNDpbMiwyNl19LHsxODpbMiwzNF0sMzQ6WzIsMzRdfSx7MzU6WzEsNTldfSx7MjE6NjMsMjc6WzEsNjddLDI5OlsxLDY0XSwzMDpbMSw2NV0sMzE6WzEsNjZdLDM0OlsxLDI2XSwzNjoyNX0sezE4OlsyLDQyXSwyNzpbMiw0Ml0sMjk6WzIsNDJdLDMwOlsyLDQyXSwzMTpbMiw0Ml0sMzQ6WzIsNDJdLDM3OlsyLDQyXX0sezU6WzIsMTldLDE0OlsyLDE5XSwxNTpbMiwxOV0sMTY6WzIsMTldLDE5OlsyLDE5XSwyMDpbMiwxOV0sMjI6WzIsMTldLDIzOlsyLDE5XSwyNDpbMiwxOV19LHs1OlsyLDE1XSwxNDpbMiwxNV0sMTU6WzIsMTVdLDE2OlsyLDE1XSwxOTpbMiwxNV0sMjA6WzIsMTVdLDIyOlsyLDE1XSwyMzpbMiwxNV0sMjQ6WzIsMTVdfSx7MTg6WzIsMzZdLDM0OlsyLDM2XX0sezE4OlsyLDM3XSwzNDpbMiwzN119LHsxODpbMiwzOF0sMzQ6WzIsMzhdfSx7MTg6WzIsMzldLDM0OlsyLDM5XX0sezE4OlsyLDQwXSwzNDpbMiw0MF19XSwKZGVmYXVsdEFjdGlvbnM6IHsxNjpbMiwxXSwyNDpbMiwyNV0sMzg6WzIsMjNdLDU1OlsyLDIxXX0sCnBhcnNlRXJyb3I6IGZ1bmN0aW9uIHBhcnNlRXJyb3Ioc3RyLCBoYXNoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3Ioc3RyKTsKfSwKcGFyc2U6IGZ1bmN0aW9uIHBhcnNlKGlucHV0KSB7CiAgICB2YXIgc2VsZiA9IHRoaXMsIHN0YWNrID0gWzBdLCB2c3RhY2sgPSBbbnVsbF0sIGxzdGFjayA9IFtdLCB0YWJsZSA9IHRoaXMudGFibGUsIHl5dGV4dCA9ICIiLCB5eWxpbmVubyA9IDAsIHl5bGVuZyA9IDAsIHJlY292ZXJpbmcgPSAwLCBURVJST1IgPSAyLCBFT0YgPSAxOwogICAgdGhpcy5sZXhlci5zZXRJbnB1dChpbnB1dCk7CiAgICB0aGlzLmxleGVyLnl5ID0gdGhpcy55eTsKICAgIHRoaXMueXkubGV4ZXIgPSB0aGlzLmxleGVyOwogICAgdGhpcy55eS5wYXJzZXIgPSB0aGlzOwogICAgaWYgKHR5cGVvZiB0aGlzLmxleGVyLnl5bGxvYyA9PSAidW5kZWZpbmVkIikKICAgICAgICB0aGlzLmxleGVyLnl5bGxvYyA9IHt9OwogICAgdmFyIHl5bG9jID0gdGhpcy5sZXhlci55eWxsb2M7CiAgICBsc3RhY2sucHVzaCh5eWxvYyk7CiAgICB2YXIgcmFuZ2VzID0gdGhpcy5sZXhlci5vcHRpb25zICYmIHRoaXMubGV4ZXIub3B0aW9ucy5yYW5nZXM7CiAgICBpZiAodHlwZW9mIHRoaXMueXkucGFyc2VFcnJvciA9PT0gImZ1bmN0aW9uIikKICAgICAgICB0aGlzLnBhcnNlRXJyb3IgPSB0aGlzLnl5LnBhcnNlRXJyb3I7CiAgICBmdW5jdGlvbiBwb3BTdGFjayhuKSB7CiAgICAgICAgc3RhY2subGVuZ3RoID0gc3RhY2subGVuZ3RoIC0gMiAqIG47CiAgICAgICAgdnN0YWNrLmxlbmd0aCA9IHZzdGFjay5sZW5ndGggLSBuOwogICAgICAgIGxzdGFjay5sZW5ndGggPSBsc3RhY2subGVuZ3RoIC0gbjsKICAgIH0KICAgIGZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgdG9rZW47CiAgICAgICAgdG9rZW4gPSBzZWxmLmxleGVyLmxleCgpIHx8IDE7CiAgICAgICAgaWYgKHR5cGVvZiB0b2tlbiAhPT0gIm51bWJlciIpIHsKICAgICAgICAgICAgdG9rZW4gPSBzZWxmLnN5bWJvbHNfW3Rva2VuXSB8fCB0b2tlbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRva2VuOwogICAgfQogICAgdmFyIHN5bWJvbCwgcHJlRXJyb3JTeW1ib2wsIHN0YXRlLCBhY3Rpb24sIGEsIHIsIHl5dmFsID0ge30sIHAsIGxlbiwgbmV3U3RhdGUsIGV4cGVjdGVkOwogICAgd2hpbGUgKHRydWUpIHsKICAgICAgICBzdGF0ZSA9IHN0YWNrW3N0YWNrLmxlbmd0aCAtIDFdOwogICAgICAgIGlmICh0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXSkgewogICAgICAgICAgICBhY3Rpb24gPSB0aGlzLmRlZmF1bHRBY3Rpb25zW3N0YXRlXTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoc3ltYm9sID09PSBudWxsIHx8IHR5cGVvZiBzeW1ib2wgPT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IGxleCgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGFjdGlvbiA9IHRhYmxlW3N0YXRlXSAmJiB0YWJsZVtzdGF0ZV1bc3ltYm9sXTsKICAgICAgICB9CiAgICAgICAgaWYgKHR5cGVvZiBhY3Rpb24gPT09ICJ1bmRlZmluZWQiIHx8ICFhY3Rpb24ubGVuZ3RoIHx8ICFhY3Rpb25bMF0pIHsKICAgICAgICAgICAgdmFyIGVyclN0ciA9ICIiOwogICAgICAgICAgICBpZiAoIXJlY292ZXJpbmcpIHsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gW107CiAgICAgICAgICAgICAgICBmb3IgKHAgaW4gdGFibGVbc3RhdGVdKQogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnRlcm1pbmFsc19bcF0gJiYgcCA+IDIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXhwZWN0ZWQucHVzaCgiJyIgKyB0aGlzLnRlcm1pbmFsc19bcF0gKyAiJyIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmxleGVyLnNob3dQb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgIGVyclN0ciA9ICJQYXJzZSBlcnJvciBvbiBsaW5lICIgKyAoeXlsaW5lbm8gKyAxKSArICI6XG4iICsgdGhpcy5sZXhlci5zaG93UG9zaXRpb24oKSArICJcbkV4cGVjdGluZyAiICsgZXhwZWN0ZWQuam9pbigiLCAiKSArICIsIGdvdCAnIiArICh0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wpICsgIiciOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBlcnJTdHIgPSAiUGFyc2UgZXJyb3Igb24gbGluZSAiICsgKHl5bGluZW5vICsgMSkgKyAiOiBVbmV4cGVjdGVkICIgKyAoc3ltYm9sID09IDE/ImVuZCBvZiBpbnB1dCI6IiciICsgKHRoaXMudGVybWluYWxzX1tzeW1ib2xdIHx8IHN5bWJvbCkgKyAiJyIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5wYXJzZUVycm9yKGVyclN0ciwge3RleHQ6IHRoaXMubGV4ZXIubWF0Y2gsIHRva2VuOiB0aGlzLnRlcm1pbmFsc19bc3ltYm9sXSB8fCBzeW1ib2wsIGxpbmU6IHRoaXMubGV4ZXIueXlsaW5lbm8sIGxvYzogeXlsb2MsIGV4cGVjdGVkOiBleHBlY3RlZH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChhY3Rpb25bMF0gaW5zdGFuY2VvZiBBcnJheSAmJiBhY3Rpb24ubGVuZ3RoID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBhcnNlIEVycm9yOiBtdWx0aXBsZSBhY3Rpb25zIHBvc3NpYmxlIGF0IHN0YXRlOiAiICsgc3RhdGUgKyAiLCB0b2tlbjogIiArIHN5bWJvbCk7CiAgICAgICAgfQogICAgICAgIHN3aXRjaCAoYWN0aW9uWzBdKSB7CiAgICAgICAgY2FzZSAxOgogICAgICAgICAgICBzdGFjay5wdXNoKHN5bWJvbCk7CiAgICAgICAgICAgIHZzdGFjay5wdXNoKHRoaXMubGV4ZXIueXl0ZXh0KTsKICAgICAgICAgICAgbHN0YWNrLnB1c2godGhpcy5sZXhlci55eWxsb2MpOwogICAgICAgICAgICBzdGFjay5wdXNoKGFjdGlvblsxXSk7CiAgICAgICAgICAgIHN5bWJvbCA9IG51bGw7CiAgICAgICAgICAgIGlmICghcHJlRXJyb3JTeW1ib2wpIHsKICAgICAgICAgICAgICAgIHl5bGVuZyA9IHRoaXMubGV4ZXIueXlsZW5nOwogICAgICAgICAgICAgICAgeXl0ZXh0ID0gdGhpcy5sZXhlci55eXRleHQ7CiAgICAgICAgICAgICAgICB5eWxpbmVubyA9IHRoaXMubGV4ZXIueXlsaW5lbm87CiAgICAgICAgICAgICAgICB5eWxvYyA9IHRoaXMubGV4ZXIueXlsbG9jOwogICAgICAgICAgICAgICAgaWYgKHJlY292ZXJpbmcgPiAwKQogICAgICAgICAgICAgICAgICAgIHJlY292ZXJpbmctLTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN5bWJvbCA9IHByZUVycm9yU3ltYm9sOwogICAgICAgICAgICAgICAgcHJlRXJyb3JTeW1ib2wgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgbGVuID0gdGhpcy5wcm9kdWN0aW9uc19bYWN0aW9uWzFdXVsxXTsKICAgICAgICAgICAgeXl2YWwuJCA9IHZzdGFja1t2c3RhY2subGVuZ3RoIC0gbGVuXTsKICAgICAgICAgICAgeXl2YWwuXyQgPSB7Zmlyc3RfbGluZTogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAobGVuIHx8IDEpXS5maXJzdF9saW5lLCBsYXN0X2xpbmU6IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ubGFzdF9saW5lLCBmaXJzdF9jb2x1bW46IGxzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0uZmlyc3RfY29sdW1uLCBsYXN0X2NvbHVtbjogbHN0YWNrW2xzdGFjay5sZW5ndGggLSAxXS5sYXN0X2NvbHVtbn07CiAgICAgICAgICAgIGlmIChyYW5nZXMpIHsKICAgICAgICAgICAgICAgIHl5dmFsLl8kLnJhbmdlID0gW2xzdGFja1tsc3RhY2subGVuZ3RoIC0gKGxlbiB8fCAxKV0ucmFuZ2VbMF0sIGxzdGFja1tsc3RhY2subGVuZ3RoIC0gMV0ucmFuZ2VbMV1dOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHIgPSB0aGlzLnBlcmZvcm1BY3Rpb24uY2FsbCh5eXZhbCwgeXl0ZXh0LCB5eWxlbmcsIHl5bGluZW5vLCB0aGlzLnl5LCBhY3Rpb25bMV0sIHZzdGFjaywgbHN0YWNrKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiByICE9PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGxlbikgewogICAgICAgICAgICAgICAgc3RhY2sgPSBzdGFjay5zbGljZSgwLCAtMSAqIGxlbiAqIDIpOwogICAgICAgICAgICAgICAgdnN0YWNrID0gdnN0YWNrLnNsaWNlKDAsIC0xICogbGVuKTsKICAgICAgICAgICAgICAgIGxzdGFjayA9IGxzdGFjay5zbGljZSgwLCAtMSAqIGxlbik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RhY2sucHVzaCh0aGlzLnByb2R1Y3Rpb25zX1thY3Rpb25bMV1dWzBdKTsKICAgICAgICAgICAgdnN0YWNrLnB1c2goeXl2YWwuJCk7CiAgICAgICAgICAgIGxzdGFjay5wdXNoKHl5dmFsLl8kKTsKICAgICAgICAgICAgbmV3U3RhdGUgPSB0YWJsZVtzdGFja1tzdGFjay5sZW5ndGggLSAyXV1bc3RhY2tbc3RhY2subGVuZ3RoIC0gMV1dOwogICAgICAgICAgICBzdGFjay5wdXNoKG5ld1N0YXRlKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAzOgogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQp9OwovKiBKaXNvbiBnZW5lcmF0ZWQgbGV4ZXIgKi8KdmFyIGxleGVyID0gKGZ1bmN0aW9uKCl7CnZhciBsZXhlciA9ICh7RU9GOjEsCnBhcnNlRXJyb3I6ZnVuY3Rpb24gcGFyc2VFcnJvcihzdHIsIGhhc2gpIHsKICAgICAgICBpZiAodGhpcy55eS5wYXJzZXIpIHsKICAgICAgICAgICAgdGhpcy55eS5wYXJzZXIucGFyc2VFcnJvcihzdHIsIGhhc2gpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihzdHIpOwogICAgICAgIH0KICAgIH0sCnNldElucHV0OmZ1bmN0aW9uIChpbnB1dCkgewogICAgICAgIHRoaXMuX2lucHV0ID0gaW5wdXQ7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRoaXMuX2xlc3MgPSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICB0aGlzLnl5bGluZW5vID0gdGhpcy55eWxlbmcgPSAwOwogICAgICAgIHRoaXMueXl0ZXh0ID0gdGhpcy5tYXRjaGVkID0gdGhpcy5tYXRjaCA9ICcnOwogICAgICAgIHRoaXMuY29uZGl0aW9uU3RhY2sgPSBbJ0lOSVRJQUwnXTsKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOjEsZmlyc3RfY29sdW1uOjAsbGFzdF9saW5lOjEsbGFzdF9jb2x1bW46MH07CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlID0gWzAsMF07CiAgICAgICAgdGhpcy5vZmZzZXQgPSAwOwogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKaW5wdXQ6ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBjaCA9IHRoaXMuX2lucHV0WzBdOwogICAgICAgIHRoaXMueXl0ZXh0ICs9IGNoOwogICAgICAgIHRoaXMueXlsZW5nKys7CiAgICAgICAgdGhpcy5vZmZzZXQrKzsKICAgICAgICB0aGlzLm1hdGNoICs9IGNoOwogICAgICAgIHRoaXMubWF0Y2hlZCArPSBjaDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgaWYgKGxpbmVzKSB7CiAgICAgICAgICAgIHRoaXMueXlsaW5lbm8rKzsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9saW5lKys7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy55eWxsb2MubGFzdF9jb2x1bW4rKzsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5yYW5nZXMpIHRoaXMueXlsbG9jLnJhbmdlWzFdKys7CgogICAgICAgIHRoaXMuX2lucHV0ID0gdGhpcy5faW5wdXQuc2xpY2UoMSk7CiAgICAgICAgcmV0dXJuIGNoOwogICAgfSwKdW5wdXQ6ZnVuY3Rpb24gKGNoKSB7CiAgICAgICAgdmFyIGxlbiA9IGNoLmxlbmd0aDsKICAgICAgICB2YXIgbGluZXMgPSBjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwoKICAgICAgICB0aGlzLl9pbnB1dCA9IGNoICsgdGhpcy5faW5wdXQ7CiAgICAgICAgdGhpcy55eXRleHQgPSB0aGlzLnl5dGV4dC5zdWJzdHIoMCwgdGhpcy55eXRleHQubGVuZ3RoLWxlbi0xKTsKICAgICAgICAvL3RoaXMueXlsZW5nIC09IGxlbjsKICAgICAgICB0aGlzLm9mZnNldCAtPSBsZW47CiAgICAgICAgdmFyIG9sZExpbmVzID0gdGhpcy5tYXRjaC5zcGxpdCgvKD86XHJcbj98XG4pL2cpOwogICAgICAgIHRoaXMubWF0Y2ggPSB0aGlzLm1hdGNoLnN1YnN0cigwLCB0aGlzLm1hdGNoLmxlbmd0aC0xKTsKICAgICAgICB0aGlzLm1hdGNoZWQgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGgtMSk7CgogICAgICAgIGlmIChsaW5lcy5sZW5ndGgtMSkgdGhpcy55eWxpbmVubyAtPSBsaW5lcy5sZW5ndGgtMTsKICAgICAgICB2YXIgciA9IHRoaXMueXlsbG9jLnJhbmdlOwoKICAgICAgICB0aGlzLnl5bGxvYyA9IHtmaXJzdF9saW5lOiB0aGlzLnl5bGxvYy5maXJzdF9saW5lLAogICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICBmaXJzdF9jb2x1bW46IHRoaXMueXlsbG9jLmZpcnN0X2NvbHVtbiwKICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/CiAgICAgICAgICAgICAgKGxpbmVzLmxlbmd0aCA9PT0gb2xkTGluZXMubGVuZ3RoID8gdGhpcy55eWxsb2MuZmlyc3RfY29sdW1uIDogMCkgKyBvbGRMaW5lc1tvbGRMaW5lcy5sZW5ndGggLSBsaW5lcy5sZW5ndGhdLmxlbmd0aCAtIGxpbmVzWzBdLmxlbmd0aDoKICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5maXJzdF9jb2x1bW4gLSBsZW4KICAgICAgICAgIH07CgogICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgIHRoaXMueXlsbG9jLnJhbmdlID0gW3JbMF0sIHJbMF0gKyB0aGlzLnl5bGVuZyAtIGxlbl07CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfSwKbW9yZTpmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpcy5fbW9yZSA9IHRydWU7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LApsZXNzOmZ1bmN0aW9uIChuKSB7CiAgICAgICAgdGhpcy51bnB1dCh0aGlzLm1hdGNoLnNsaWNlKG4pKTsKICAgIH0sCnBhc3RJbnB1dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIHBhc3QgPSB0aGlzLm1hdGNoZWQuc3Vic3RyKDAsIHRoaXMubWF0Y2hlZC5sZW5ndGggLSB0aGlzLm1hdGNoLmxlbmd0aCk7CiAgICAgICAgcmV0dXJuIChwYXN0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpICsgcGFzdC5zdWJzdHIoLTIwKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LAp1cGNvbWluZ0lucHV0OmZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbmV4dCA9IHRoaXMubWF0Y2g7CiAgICAgICAgaWYgKG5leHQubGVuZ3RoIDwgMjApIHsKICAgICAgICAgICAgbmV4dCArPSB0aGlzLl9pbnB1dC5zdWJzdHIoMCwgMjAtbmV4dC5sZW5ndGgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gKG5leHQuc3Vic3RyKDAsMjApKyhuZXh0Lmxlbmd0aCA+IDIwID8gJy4uLic6JycpKS5yZXBsYWNlKC9cbi9nLCAiIik7CiAgICB9LApzaG93UG9zaXRpb246ZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBwcmUgPSB0aGlzLnBhc3RJbnB1dCgpOwogICAgICAgIHZhciBjID0gbmV3IEFycmF5KHByZS5sZW5ndGggKyAxKS5qb2luKCItIik7CiAgICAgICAgcmV0dXJuIHByZSArIHRoaXMudXBjb21pbmdJbnB1dCgpICsgIlxuIiArIGMrIl4iOwogICAgfSwKbmV4dDpmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXMuZG9uZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5FT0Y7CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faW5wdXQpIHRoaXMuZG9uZSA9IHRydWU7CgogICAgICAgIHZhciB0b2tlbiwKICAgICAgICAgICAgbWF0Y2gsCiAgICAgICAgICAgIHRlbXBNYXRjaCwKICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgIGNvbCwKICAgICAgICAgICAgbGluZXM7CiAgICAgICAgaWYgKCF0aGlzLl9tb3JlKSB7CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ID0gJyc7CiAgICAgICAgICAgIHRoaXMubWF0Y2ggPSAnJzsKICAgICAgICB9CiAgICAgICAgdmFyIHJ1bGVzID0gdGhpcy5fY3VycmVudFJ1bGVzKCk7CiAgICAgICAgZm9yICh2YXIgaT0wO2kgPCBydWxlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICB0ZW1wTWF0Y2ggPSB0aGlzLl9pbnB1dC5tYXRjaCh0aGlzLnJ1bGVzW3J1bGVzW2ldXSk7CiAgICAgICAgICAgIGlmICh0ZW1wTWF0Y2ggJiYgKCFtYXRjaCB8fCB0ZW1wTWF0Y2hbMF0ubGVuZ3RoID4gbWF0Y2hbMF0ubGVuZ3RoKSkgewogICAgICAgICAgICAgICAgbWF0Y2ggPSB0ZW1wTWF0Y2g7CiAgICAgICAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5mbGV4KSBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbGluZXMgPSBtYXRjaFswXS5tYXRjaCgvKD86XHJcbj98XG4pLiovZyk7CiAgICAgICAgICAgIGlmIChsaW5lcykgdGhpcy55eWxpbmVubyArPSBsaW5lcy5sZW5ndGg7CiAgICAgICAgICAgIHRoaXMueXlsbG9jID0ge2ZpcnN0X2xpbmU6IHRoaXMueXlsbG9jLmxhc3RfbGluZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFzdF9saW5lOiB0aGlzLnl5bGluZW5vKzEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2NvbHVtbjogdGhpcy55eWxsb2MubGFzdF9jb2x1bW4sCiAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhc3RfY29sdW1uOiBsaW5lcyA/IGxpbmVzW2xpbmVzLmxlbmd0aC0xXS5sZW5ndGgtbGluZXNbbGluZXMubGVuZ3RoLTFdLm1hdGNoKC9ccj9cbj8vKVswXS5sZW5ndGggOiB0aGlzLnl5bGxvYy5sYXN0X2NvbHVtbiArIG1hdGNoWzBdLmxlbmd0aH07CiAgICAgICAgICAgIHRoaXMueXl0ZXh0ICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoICs9IG1hdGNoWzBdOwogICAgICAgICAgICB0aGlzLm1hdGNoZXMgPSBtYXRjaDsKICAgICAgICAgICAgdGhpcy55eWxlbmcgPSB0aGlzLnl5dGV4dC5sZW5ndGg7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMucmFuZ2VzKSB7CiAgICAgICAgICAgICAgICB0aGlzLnl5bGxvYy5yYW5nZSA9IFt0aGlzLm9mZnNldCwgdGhpcy5vZmZzZXQgKz0gdGhpcy55eWxlbmddOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21vcmUgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5faW5wdXQgPSB0aGlzLl9pbnB1dC5zbGljZShtYXRjaFswXS5sZW5ndGgpOwogICAgICAgICAgICB0aGlzLm1hdGNoZWQgKz0gbWF0Y2hbMF07CiAgICAgICAgICAgIHRva2VuID0gdGhpcy5wZXJmb3JtQWN0aW9uLmNhbGwodGhpcywgdGhpcy55eSwgdGhpcywgcnVsZXNbaW5kZXhdLHRoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV0pOwogICAgICAgICAgICBpZiAodGhpcy5kb25lICYmIHRoaXMuX2lucHV0KSB0aGlzLmRvbmUgPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRva2VuKSByZXR1cm4gdG9rZW47CiAgICAgICAgICAgIGVsc2UgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5wdXQgPT09ICIiKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkVPRjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJzZUVycm9yKCdMZXhpY2FsIGVycm9yIG9uIGxpbmUgJysodGhpcy55eWxpbmVubysxKSsnLiBVbnJlY29nbml6ZWQgdGV4dC5cbicrdGhpcy5zaG93UG9zaXRpb24oKSwKICAgICAgICAgICAgICAgICAgICB7dGV4dDogIiIsIHRva2VuOiBudWxsLCBsaW5lOiB0aGlzLnl5bGluZW5vfSk7CiAgICAgICAgfQogICAgfSwKbGV4OmZ1bmN0aW9uIGxleCgpIHsKICAgICAgICB2YXIgciA9IHRoaXMubmV4dCgpOwogICAgICAgIGlmICh0eXBlb2YgciAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMubGV4KCk7CiAgICAgICAgfQogICAgfSwKYmVnaW46ZnVuY3Rpb24gYmVnaW4oY29uZGl0aW9uKSB7CiAgICAgICAgdGhpcy5jb25kaXRpb25TdGFjay5wdXNoKGNvbmRpdGlvbik7CiAgICB9LApwb3BTdGF0ZTpmdW5jdGlvbiBwb3BTdGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25TdGFjay5wb3AoKTsKICAgIH0sCl9jdXJyZW50UnVsZXM6ZnVuY3Rpb24gX2N1cnJlbnRSdWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jb25kaXRpb25zW3RoaXMuY29uZGl0aW9uU3RhY2tbdGhpcy5jb25kaXRpb25TdGFjay5sZW5ndGgtMV1dLnJ1bGVzOwogICAgfSwKdG9wU3RhdGU6ZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbmRpdGlvblN0YWNrW3RoaXMuY29uZGl0aW9uU3RhY2subGVuZ3RoLTJdOwogICAgfSwKcHVzaFN0YXRlOmZ1bmN0aW9uIGJlZ2luKGNvbmRpdGlvbikgewogICAgICAgIHRoaXMuYmVnaW4oY29uZGl0aW9uKTsKICAgIH19KTsKbGV4ZXIub3B0aW9ucyA9IHt9OwpsZXhlci5wZXJmb3JtQWN0aW9uID0gZnVuY3Rpb24gYW5vbnltb3VzKHl5LHl5XywkYXZvaWRpbmdfbmFtZV9jb2xsaXNpb25zLFlZX1NUQVJUKSB7Cgp2YXIgWVlTVEFURT1ZWV9TVEFSVApzd2l0Y2goJGF2b2lkaW5nX25hbWVfY29sbGlzaW9ucykgewpjYXNlIDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMuYmVnaW4oIm11Iik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgPT09ICJcXCIpIHl5Xy55eXRleHQgPSB5eV8ueXl0ZXh0LnN1YnN0cigwLHl5Xy55eWxlbmctMSksIHRoaXMuYmVnaW4oImVtdSIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHl5Xy55eXRleHQpIHJldHVybiAxNDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCmJyZWFrOwpjYXNlIDE6IHJldHVybiAxNDsgCmJyZWFrOwpjYXNlIDI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoeXlfLnl5dGV4dC5zbGljZSgtMSkgIT09ICJcXCIpIHRoaXMucG9wU3RhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZih5eV8ueXl0ZXh0LnNsaWNlKC0xKSA9PT0gIlxcIikgeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDAseXlfLnl5bGVuZy0xKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMTQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIApicmVhazsKY2FzZSAzOiByZXR1cm4gMjQ7IApicmVhazsKY2FzZSA0OiByZXR1cm4gMTY7IApicmVhazsKY2FzZSA1OiByZXR1cm4gMjA7IApicmVhazsKY2FzZSA2OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA3OiByZXR1cm4gMTk7IApicmVhazsKY2FzZSA4OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSA5OiByZXR1cm4gMjM7IApicmVhazsKY2FzZSAxMDogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDMseXlfLnl5bGVuZy01KTsgdGhpcy5wb3BTdGF0ZSgpOyByZXR1cm4gMTU7IApicmVhazsKY2FzZSAxMTogcmV0dXJuIDIyOyAKYnJlYWs7CmNhc2UgMTI6IHJldHVybiAzNTsgCmJyZWFrOwpjYXNlIDEzOiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAxNDogcmV0dXJuIDM0OyAKYnJlYWs7CmNhc2UgMTU6IHJldHVybiAzNzsgCmJyZWFrOwpjYXNlIDE2OiAvKmlnbm9yZSB3aGl0ZXNwYWNlKi8gCmJyZWFrOwpjYXNlIDE3OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE4OiB0aGlzLnBvcFN0YXRlKCk7IHJldHVybiAxODsgCmJyZWFrOwpjYXNlIDE5OiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIwOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSx5eV8ueXlsZW5nLTIpLnJlcGxhY2UoL1xcIi9nLCciJyk7IHJldHVybiAyOTsgCmJyZWFrOwpjYXNlIDIxOiB5eV8ueXl0ZXh0ID0geXlfLnl5dGV4dC5zdWJzdHIoMSk7IHJldHVybiAyNzsgCmJyZWFrOwpjYXNlIDIyOiByZXR1cm4gMzE7IApicmVhazsKY2FzZSAyMzogcmV0dXJuIDMxOyAKYnJlYWs7CmNhc2UgMjQ6IHJldHVybiAzMDsgCmJyZWFrOwpjYXNlIDI1OiByZXR1cm4gMzQ7IApicmVhazsKY2FzZSAyNjogeXlfLnl5dGV4dCA9IHl5Xy55eXRleHQuc3Vic3RyKDEsIHl5Xy55eWxlbmctMik7IHJldHVybiAzNDsgCmJyZWFrOwpjYXNlIDI3OiByZXR1cm4gJ0lOVkFMSUQnOyAKYnJlYWs7CmNhc2UgMjg6IHJldHVybiA1OyAKYnJlYWs7Cn0KfTsKbGV4ZXIucnVsZXMgPSBbL14oPzpbXlx4MDBdKj8oPz0oXHtceykpKS8sL14oPzpbXlx4MDBdKykvLC9eKD86W15ceDAwXXsyLH0/KD89KFx7XHt8JCkpKS8sL14oPzpce1x7PikvLC9eKD86XHtceyMpLywvXig/Olx7XHtcLykvLC9eKD86XHtce1xeKS8sL14oPzpce1x7XHMqZWxzZVxiKS8sL14oPzpce1x7XHspLywvXig/Olx7XHsmKS8sL14oPzpce1x7IVtcc1xTXSo/XH1cfSkvLC9eKD86XHtceykvLC9eKD86PSkvLC9eKD86XC4oPz1bfSBdKSkvLC9eKD86XC5cLikvLC9eKD86W1wvLl0pLywvXig/OlxzKykvLC9eKD86XH1cfVx9KS8sL14oPzpcfVx9KS8sL14oPzoiKFxcWyJdfFteIl0pKiIpLywvXig/OicoXFxbJ118W14nXSkqJykvLC9eKD86QFthLXpBLVpdKykvLC9eKD86dHJ1ZSg/PVt9XHNdKSkvLC9eKD86ZmFsc2UoPz1bfVxzXSkpLywvXig/OlswLTldKyg/PVt9XHNdKSkvLC9eKD86W2EtekEtWjAtOV8kLV0rKD89Wz19XHNcLy5dKSkvLC9eKD86XFtbXlxdXSpcXSkvLC9eKD86LikvLC9eKD86JCkvXTsKbGV4ZXIuY29uZGl0aW9ucyA9IHsibXUiOnsicnVsZXMiOlszLDQsNSw2LDcsOCw5LDEwLDExLDEyLDEzLDE0LDE1LDE2LDE3LDE4LDE5LDIwLDIxLDIyLDIzLDI0LDI1LDI2LDI3LDI4XSwiaW5jbHVzaXZlIjpmYWxzZX0sImVtdSI6eyJydWxlcyI6WzJdLCJpbmNsdXNpdmUiOmZhbHNlfSwiSU5JVElBTCI6eyJydWxlcyI6WzAsMSwyOF0sImluY2x1c2l2ZSI6dHJ1ZX19OwpyZXR1cm4gbGV4ZXI7fSkoKQpwYXJzZXIubGV4ZXIgPSBsZXhlcjsKZnVuY3Rpb24gUGFyc2VyICgpIHsgdGhpcy55eSA9IHt9OyB9UGFyc2VyLnByb3RvdHlwZSA9IHBhcnNlcjtwYXJzZXIuUGFyc2VyID0gUGFyc2VyOwpyZXR1cm4gbmV3IFBhcnNlcjsKfSkoKTsKaWYgKHR5cGVvZiByZXF1aXJlICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgZXhwb3J0cyAhPT0gJ3VuZGVmaW5lZCcpIHsKZXhwb3J0cy5wYXJzZXIgPSBoYW5kbGViYXJzOwpleHBvcnRzLlBhcnNlciA9IGhhbmRsZWJhcnMuUGFyc2VyOwpleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24gKCkgeyByZXR1cm4gaGFuZGxlYmFycy5wYXJzZS5hcHBseShoYW5kbGViYXJzLCBhcmd1bWVudHMpOyB9CmV4cG9ydHMubWFpbiA9IGZ1bmN0aW9uIGNvbW1vbmpzTWFpbihhcmdzKSB7CiAgICBpZiAoIWFyZ3NbMV0pCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVc2FnZTogJythcmdzWzBdKycgRklMRScpOwogICAgdmFyIHNvdXJjZSwgY3dkOwogICAgaWYgKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJykgewogICAgICAgIHNvdXJjZSA9IHJlcXVpcmUoJ2ZzJykucmVhZEZpbGVTeW5jKHJlcXVpcmUoJ3BhdGgnKS5yZXNvbHZlKGFyZ3NbMV0pLCAidXRmOCIpOwogICAgfSBlbHNlIHsKICAgICAgICBzb3VyY2UgPSByZXF1aXJlKCJmaWxlIikucGF0aChyZXF1aXJlKCJmaWxlIikuY3dkKCkpLmpvaW4oYXJnc1sxXSkucmVhZCh7Y2hhcnNldDogInV0Zi04In0pOwogICAgfQogICAgcmV0dXJuIGV4cG9ydHMucGFyc2VyLnBhcnNlKHNvdXJjZSk7Cn0KaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIHJlcXVpcmUubWFpbiA9PT0gbW9kdWxlKSB7CiAgZXhwb3J0cy5tYWluKHR5cGVvZiBwcm9jZXNzICE9PSAndW5kZWZpbmVkJyA/IHByb2Nlc3MuYXJndi5zbGljZSgxKSA6IHJlcXVpcmUoInN5c3RlbSIpLmFyZ3MpOwp9Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYmFzZS5qcwpIYW5kbGViYXJzLlBhcnNlciA9IGhhbmRsZWJhcnM7CgpIYW5kbGViYXJzLnBhcnNlID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgSGFuZGxlYmFycy5QYXJzZXIueXkgPSBIYW5kbGViYXJzLkFTVDsKICByZXR1cm4gSGFuZGxlYmFycy5QYXJzZXIucGFyc2Uoc3RyaW5nKTsKfTsKCkhhbmRsZWJhcnMucHJpbnQgPSBmdW5jdGlvbihhc3QpIHsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuUHJpbnRWaXNpdG9yKCkuYWNjZXB0KGFzdCk7Cn07CgpIYW5kbGViYXJzLmxvZ2dlciA9IHsKICBERUJVRzogMCwgSU5GTzogMSwgV0FSTjogMiwgRVJST1I6IDMsIGxldmVsOiAzLAoKICAvLyBvdmVycmlkZSBpbiB0aGUgaG9zdCBlbnZpcm9ubWVudAogIGxvZzogZnVuY3Rpb24obGV2ZWwsIHN0cikge30KfTsKCkhhbmRsZWJhcnMubG9nID0gZnVuY3Rpb24obGV2ZWwsIHN0cikgeyBIYW5kbGViYXJzLmxvZ2dlci5sb2cobGV2ZWwsIHN0cik7IH07CjsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvYXN0LmpzCihmdW5jdGlvbigpIHsKCiAgSGFuZGxlYmFycy5BU1QgPSB7fTsKCiAgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUgPSBmdW5jdGlvbihzdGF0ZW1lbnRzLCBpbnZlcnNlKSB7CiAgICB0aGlzLnR5cGUgPSAicHJvZ3JhbSI7CiAgICB0aGlzLnN0YXRlbWVudHMgPSBzdGF0ZW1lbnRzOwogICAgaWYoaW52ZXJzZSkgeyB0aGlzLmludmVyc2UgPSBuZXcgSGFuZGxlYmFycy5BU1QuUHJvZ3JhbU5vZGUoaW52ZXJzZSk7IH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5NdXN0YWNoZU5vZGUgPSBmdW5jdGlvbihyYXdQYXJhbXMsIGhhc2gsIHVuZXNjYXBlZCkgewogICAgdGhpcy50eXBlID0gIm11c3RhY2hlIjsKICAgIHRoaXMuZXNjYXBlZCA9ICF1bmVzY2FwZWQ7CiAgICB0aGlzLmhhc2ggPSBoYXNoOwoKICAgIHZhciBpZCA9IHRoaXMuaWQgPSByYXdQYXJhbXNbMF07CiAgICB2YXIgcGFyYW1zID0gdGhpcy5wYXJhbXMgPSByYXdQYXJhbXMuc2xpY2UoMSk7CgogICAgLy8gYSBtdXN0YWNoZSBpcyBhbiBlbGlnaWJsZSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0cyBpZCBpcyBzaW1wbGUgKGEgc2luZ2xlIHBhcnQsIG5vdCBgdGhpc2Agb3IgYC4uYCkKICAgIHZhciBlbGlnaWJsZUhlbHBlciA9IHRoaXMuZWxpZ2libGVIZWxwZXIgPSBpZC5pc1NpbXBsZTsKCiAgICAvLyBhIG11c3RhY2hlIGlzIGRlZmluaXRlbHkgYSBoZWxwZXIgaWY6CiAgICAvLyAqIGl0IGlzIGFuIGVsaWdpYmxlIGhlbHBlciwgYW5kCiAgICAvLyAqIGl0IGhhcyBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyIG9yIGhhc2ggc2VnbWVudAogICAgdGhpcy5pc0hlbHBlciA9IGVsaWdpYmxlSGVscGVyICYmIChwYXJhbXMubGVuZ3RoIHx8IGhhc2gpOwoKICAgIC8vIGlmIGEgbXVzdGFjaGUgaXMgYW4gZWxpZ2libGUgaGVscGVyIGJ1dCBub3QgYSBkZWZpbml0ZQogICAgLy8gaGVscGVyLCBpdCBpcyBhbWJpZ3VvdXMsIGFuZCB3aWxsIGJlIHJlc29sdmVkIGluIGEgbGF0ZXIKICAgIC8vIHBhc3Mgb3IgYXQgcnVudGltZS4KICB9OwoKICBIYW5kbGViYXJzLkFTVC5QYXJ0aWFsTm9kZSA9IGZ1bmN0aW9uKGlkLCBjb250ZXh0KSB7CiAgICB0aGlzLnR5cGUgICAgPSAicGFydGlhbCI7CgogICAgLy8gVE9ETzogZGlzYWxsb3cgY29tcGxleCBJRHMKCiAgICB0aGlzLmlkICAgICAgPSBpZDsKICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgfTsKCiAgdmFyIHZlcmlmeU1hdGNoID0gZnVuY3Rpb24ob3BlbiwgY2xvc2UpIHsKICAgIGlmKG9wZW4ub3JpZ2luYWwgIT09IGNsb3NlLm9yaWdpbmFsKSB7CiAgICAgIHRocm93IG5ldyBIYW5kbGViYXJzLkV4Y2VwdGlvbihvcGVuLm9yaWdpbmFsICsgIiBkb2Vzbid0IG1hdGNoICIgKyBjbG9zZS5vcmlnaW5hbCk7CiAgICB9CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQmxvY2tOb2RlID0gZnVuY3Rpb24obXVzdGFjaGUsIHByb2dyYW0sIGludmVyc2UsIGNsb3NlKSB7CiAgICB2ZXJpZnlNYXRjaChtdXN0YWNoZS5pZCwgY2xvc2UpOwogICAgdGhpcy50eXBlID0gImJsb2NrIjsKICAgIHRoaXMubXVzdGFjaGUgPSBtdXN0YWNoZTsKICAgIHRoaXMucHJvZ3JhbSAgPSBwcm9ncmFtOwogICAgdGhpcy5pbnZlcnNlICA9IGludmVyc2U7CgogICAgaWYgKHRoaXMuaW52ZXJzZSAmJiAhdGhpcy5wcm9ncmFtKSB7CiAgICAgIHRoaXMuaXNJbnZlcnNlID0gdHJ1ZTsKICAgIH0KICB9OwoKICBIYW5kbGViYXJzLkFTVC5Db250ZW50Tm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gImNvbnRlbnQiOwogICAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuSGFzaE5vZGUgPSBmdW5jdGlvbihwYWlycykgewogICAgdGhpcy50eXBlID0gImhhc2giOwogICAgdGhpcy5wYWlycyA9IHBhaXJzOwogIH07CgogIEhhbmRsZWJhcnMuQVNULklkTm9kZSA9IGZ1bmN0aW9uKHBhcnRzKSB7CiAgICB0aGlzLnR5cGUgPSAiSUQiOwogICAgdGhpcy5vcmlnaW5hbCA9IHBhcnRzLmpvaW4oIi4iKTsKCiAgICB2YXIgZGlnID0gW10sIGRlcHRoID0gMDsKCiAgICBmb3IodmFyIGk9MCxsPXBhcnRzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgdmFyIHBhcnQgPSBwYXJ0c1tpXTsKCiAgICAgIGlmKHBhcnQgPT09ICIuLiIpIHsgZGVwdGgrKzsgfQogICAgICBlbHNlIGlmKHBhcnQgPT09ICIuIiB8fCBwYXJ0ID09PSAidGhpcyIpIHsgdGhpcy5pc1Njb3BlZCA9IHRydWU7IH0KICAgICAgZWxzZSB7IGRpZy5wdXNoKHBhcnQpOyB9CiAgICB9CgogICAgdGhpcy5wYXJ0cyAgICA9IGRpZzsKICAgIHRoaXMuc3RyaW5nICAgPSBkaWcuam9pbignLicpOwogICAgdGhpcy5kZXB0aCAgICA9IGRlcHRoOwoKICAgIC8vIGFuIElEIGlzIHNpbXBsZSBpZiBpdCBvbmx5IGhhcyBvbmUgcGFydCwgYW5kIHRoYXQgcGFydCBpcyBub3QKICAgIC8vIGAuLmAgb3IgYHRoaXNgLgogICAgdGhpcy5pc1NpbXBsZSA9IHBhcnRzLmxlbmd0aCA9PT0gMSAmJiAhdGhpcy5pc1Njb3BlZCAmJiBkZXB0aCA9PT0gMDsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5EYXRhTm9kZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICB0aGlzLnR5cGUgPSAiREFUQSI7CiAgICB0aGlzLmlkID0gaWQ7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuU3RyaW5nTm9kZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgdGhpcy50eXBlID0gIlNUUklORyI7CiAgICB0aGlzLnN0cmluZyA9IHN0cmluZzsKICB9OwoKICBIYW5kbGViYXJzLkFTVC5JbnRlZ2VyTm9kZSA9IGZ1bmN0aW9uKGludGVnZXIpIHsKICAgIHRoaXMudHlwZSA9ICJJTlRFR0VSIjsKICAgIHRoaXMuaW50ZWdlciA9IGludGVnZXI7CiAgfTsKCiAgSGFuZGxlYmFycy5BU1QuQm9vbGVhbk5vZGUgPSBmdW5jdGlvbihib29sKSB7CiAgICB0aGlzLnR5cGUgPSAiQk9PTEVBTiI7CiAgICB0aGlzLmJvb2wgPSBib29sOwogIH07CgogIEhhbmRsZWJhcnMuQVNULkNvbW1lbnROb2RlID0gZnVuY3Rpb24oY29tbWVudCkgewogICAgdGhpcy50eXBlID0gImNvbW1lbnQiOwogICAgdGhpcy5jb21tZW50ID0gY29tbWVudDsKICB9OwoKfSkoKTs7Ci8vIGxpYi9oYW5kbGViYXJzL3V0aWxzLmpzCkhhbmRsZWJhcnMuRXhjZXB0aW9uID0gZnVuY3Rpb24obWVzc2FnZSkgewogIHZhciB0bXAgPSBFcnJvci5wcm90b3R5cGUuY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgZm9yICh2YXIgcCBpbiB0bXApIHsKICAgIGlmICh0bXAuaGFzT3duUHJvcGVydHkocCkpIHsgdGhpc1twXSA9IHRtcFtwXTsgfQogIH0KCiAgdGhpcy5tZXNzYWdlID0gdG1wLm1lc3NhZ2U7Cn07CkhhbmRsZWJhcnMuRXhjZXB0aW9uLnByb3RvdHlwZSA9IG5ldyBFcnJvcigpOwoKLy8gQnVpbGQgb3V0IG91ciBiYXNpYyBTYWZlU3RyaW5nIHR5cGUKSGFuZGxlYmFycy5TYWZlU3RyaW5nID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgdGhpcy5zdHJpbmcgPSBzdHJpbmc7Cn07CkhhbmRsZWJhcnMuU2FmZVN0cmluZy5wcm90b3R5cGUudG9TdHJpbmcgPSBmdW5jdGlvbigpIHsKICByZXR1cm4gdGhpcy5zdHJpbmcudG9TdHJpbmcoKTsKfTsKCihmdW5jdGlvbigpIHsKICB2YXIgZXNjYXBlID0gewogICAgIiYiOiAiJmFtcDsiLAogICAgIjwiOiAiJmx0OyIsCiAgICAiPiI6ICImZ3Q7IiwKICAgICciJzogIiZxdW90OyIsCiAgICAiJyI6ICImI3gyNzsiLAogICAgImAiOiAiJiN4NjA7IgogIH07CgogIHZhciBiYWRDaGFycyA9IC9bJjw+IidgXS9nOwogIHZhciBwb3NzaWJsZSA9IC9bJjw+IidgXS87CgogIHZhciBlc2NhcGVDaGFyID0gZnVuY3Rpb24oY2hyKSB7CiAgICByZXR1cm4gZXNjYXBlW2Nocl0gfHwgIiZhbXA7IjsKICB9OwoKICBIYW5kbGViYXJzLlV0aWxzID0gewogICAgZXNjYXBlRXhwcmVzc2lvbjogZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIC8vIGRvbid0IGVzY2FwZSBTYWZlU3RyaW5ncywgc2luY2UgdGhleSdyZSBhbHJlYWR5IHNhZmUKICAgICAgaWYgKHN0cmluZyBpbnN0YW5jZW9mIEhhbmRsZWJhcnMuU2FmZVN0cmluZykgewogICAgICAgIHJldHVybiBzdHJpbmcudG9TdHJpbmcoKTsKICAgICAgfSBlbHNlIGlmIChzdHJpbmcgPT0gbnVsbCB8fCBzdHJpbmcgPT09IGZhbHNlKSB7CiAgICAgICAgcmV0dXJuICIiOwogICAgICB9CgogICAgICBpZighcG9zc2libGUudGVzdChzdHJpbmcpKSB7IHJldHVybiBzdHJpbmc7IH0KICAgICAgcmV0dXJuIHN0cmluZy5yZXBsYWNlKGJhZENoYXJzLCBlc2NhcGVDaGFyKTsKICAgIH0sCgogICAgaXNFbXB0eTogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBmYWxzZSkgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9IGVsc2UgaWYoT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKSA9PT0gIltvYmplY3QgQXJyYXldIiAmJiB2YWx1ZS5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9Owp9KSgpOzsKLy8gbGliL2hhbmRsZWJhcnMvY29tcGlsZXIvY29tcGlsZXIuanMKCi8qanNoaW50IGVxbnVsbDp0cnVlKi8KSGFuZGxlYmFycy5Db21waWxlciA9IGZ1bmN0aW9uKCkge307CkhhbmRsZWJhcnMuSmF2YVNjcmlwdENvbXBpbGVyID0gZnVuY3Rpb24oKSB7fTsKCihmdW5jdGlvbihDb21waWxlciwgSmF2YVNjcmlwdENvbXBpbGVyKSB7CiAgLy8gdGhlIGZvdW5kSGVscGVyIHJlZ2lzdGVyIHdpbGwgZGlzYW1iaWd1YXRlIGhlbHBlciBsb29rdXAgZnJvbSBmaW5kaW5nIGEKICAvLyBmdW5jdGlvbiBpbiBhIGNvbnRleHQuIFRoaXMgaXMgbmVjZXNzYXJ5IGZvciBtdXN0YWNoZSBjb21wYXRpYmlsaXR5LCB3aGljaAogIC8vIHJlcXVpcmVzIHRoYXQgY29udGV4dCBmdW5jdGlvbnMgaW4gYmxvY2tzIGFyZSBldmFsdWF0ZWQgYnkgYmxvY2tIZWxwZXJNaXNzaW5nLAogIC8vIGFuZCB0aGVuIHByb2NlZWQgYXMgaWYgdGhlIHJlc3VsdGluZyB2YWx1ZSB3YXMgcHJvdmlkZWQgdG8gYmxvY2tIZWxwZXJNaXNzaW5nLgoKICBDb21waWxlci5wcm90b3R5cGUgPSB7CiAgICBjb21waWxlcjogQ29tcGlsZXIsCgogICAgZGlzYXNzZW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3Bjb2RlcyA9IHRoaXMub3Bjb2Rlcywgb3Bjb2RlLCBvdXQgPSBbXSwgcGFyYW1zLCBwYXJhbTsKCiAgICAgIGZvciAodmFyIGk9MCwgbD1vcGNvZGVzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW2ldOwoKICAgICAgICBpZiAob3Bjb2RlLm9wY29kZSA9PT0gJ0RFQ0xBUkUnKSB7CiAgICAgICAgICBvdXQucHVzaCgiREVDTEFSRSAiICsgb3Bjb2RlLm5hbWUgKyAiPSIgKyBvcGNvZGUudmFsdWUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBwYXJhbXMgPSBbXTsKICAgICAgICAgIGZvciAodmFyIGo9MDsgajxvcGNvZGUuYXJncy5sZW5ndGg7IGorKykgewogICAgICAgICAgICBwYXJhbSA9IG9wY29kZS5hcmdzW2pdOwogICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgIHBhcmFtID0gIlwiIiArIHBhcmFtLnJlcGxhY2UoIlxuIiwgIlxcbiIpICsgIlwiIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJhbXMucHVzaChwYXJhbSk7CiAgICAgICAgICB9CiAgICAgICAgICBvdXQucHVzaChvcGNvZGUub3Bjb2RlICsgIiAiICsgcGFyYW1zLmpvaW4oIiAiKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gb3V0LmpvaW4oIlxuIik7CiAgICB9LAoKICAgIGd1aWQ6IDAsCgogICAgY29tcGlsZTogZnVuY3Rpb24ocHJvZ3JhbSwgb3B0aW9ucykgewogICAgICB0aGlzLmNoaWxkcmVuID0gW107CiAgICAgIHRoaXMuZGVwdGhzID0ge2xpc3Q6IFtdfTsKICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKCiAgICAgIC8vIFRoZXNlIGNoYW5nZXMgd2lsbCBwcm9wYWdhdGUgdG8gdGhlIG90aGVyIGNvbXBpbGVyIGNvbXBvbmVudHMKICAgICAgdmFyIGtub3duSGVscGVycyA9IHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnM7CiAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnMgPSB7CiAgICAgICAgJ2hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdibG9ja0hlbHBlck1pc3NpbmcnOiB0cnVlLAogICAgICAgICdlYWNoJzogdHJ1ZSwKICAgICAgICAnaWYnOiB0cnVlLAogICAgICAgICd1bmxlc3MnOiB0cnVlLAogICAgICAgICd3aXRoJzogdHJ1ZSwKICAgICAgICAnbG9nJzogdHJ1ZQogICAgICB9OwogICAgICBpZiAoa25vd25IZWxwZXJzKSB7CiAgICAgICAgZm9yICh2YXIgbmFtZSBpbiBrbm93bkhlbHBlcnMpIHsKICAgICAgICAgIHRoaXMub3B0aW9ucy5rbm93bkhlbHBlcnNbbmFtZV0gPSBrbm93bkhlbHBlcnNbbmFtZV07CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGhpcy5wcm9ncmFtKHByb2dyYW0pOwogICAgfSwKCiAgICBhY2NlcHQ6IGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgcmV0dXJuIHRoaXNbbm9kZS50eXBlXShub2RlKTsKICAgIH0sCgogICAgcHJvZ3JhbTogZnVuY3Rpb24ocHJvZ3JhbSkgewogICAgICB2YXIgc3RhdGVtZW50cyA9IHByb2dyYW0uc3RhdGVtZW50cywgc3RhdGVtZW50OwogICAgICB0aGlzLm9wY29kZXMgPSBbXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXN0YXRlbWVudHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHN0YXRlbWVudCA9IHN0YXRlbWVudHNbaV07CiAgICAgICAgdGhpc1tzdGF0ZW1lbnQudHlwZV0oc3RhdGVtZW50KTsKICAgICAgfQogICAgICB0aGlzLmlzU2ltcGxlID0gbCA9PT0gMTsKCiAgICAgIHRoaXMuZGVwdGhzLmxpc3QgPSB0aGlzLmRlcHRocy5saXN0LnNvcnQoZnVuY3Rpb24oYSwgYikgewogICAgICAgIHJldHVybiBhIC0gYjsKICAgICAgfSk7CgogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgY29tcGlsZVByb2dyYW06IGZ1bmN0aW9uKHByb2dyYW0pIHsKICAgICAgdmFyIHJlc3VsdCA9IG5ldyB0aGlzLmNvbXBpbGVyKCkuY29tcGlsZShwcm9ncmFtLCB0aGlzLm9wdGlvbnMpOwogICAgICB2YXIgZ3VpZCA9IHRoaXMuZ3VpZCsrLCBkZXB0aDsKCiAgICAgIHRoaXMudXNlUGFydGlhbCA9IHRoaXMudXNlUGFydGlhbCB8fCByZXN1bHQudXNlUGFydGlhbDsKCiAgICAgIHRoaXMuY2hpbGRyZW5bZ3VpZF0gPSByZXN1bHQ7CgogICAgICBmb3IodmFyIGk9MCwgbD1yZXN1bHQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gcmVzdWx0LmRlcHRocy5saXN0W2ldOwoKICAgICAgICBpZihkZXB0aCA8IDIpIHsgY29udGludWU7IH0KICAgICAgICBlbHNlIHsgdGhpcy5hZGREZXB0aChkZXB0aCAtIDEpOyB9CiAgICAgIH0KCiAgICAgIHJldHVybiBndWlkOwogICAgfSwKCiAgICBibG9jazogZnVuY3Rpb24oYmxvY2spIHsKICAgICAgdmFyIG11c3RhY2hlID0gYmxvY2subXVzdGFjaGUsCiAgICAgICAgICBwcm9ncmFtID0gYmxvY2sucHJvZ3JhbSwKICAgICAgICAgIGludmVyc2UgPSBibG9jay5pbnZlcnNlOwoKICAgICAgaWYgKHByb2dyYW0pIHsKICAgICAgICBwcm9ncmFtID0gdGhpcy5jb21waWxlUHJvZ3JhbShwcm9ncmFtKTsKICAgICAgfQoKICAgICAgaWYgKGludmVyc2UpIHsKICAgICAgICBpbnZlcnNlID0gdGhpcy5jb21waWxlUHJvZ3JhbShpbnZlcnNlKTsKICAgICAgfQoKICAgICAgdmFyIHR5cGUgPSB0aGlzLmNsYXNzaWZ5TXVzdGFjaGUobXVzdGFjaGUpOwoKICAgICAgaWYgKHR5cGUgPT09ICJoZWxwZXIiKSB7CiAgICAgICAgdGhpcy5oZWxwZXJNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CiAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKCiAgICAgICAgLy8gbm93IHRoYXQgdGhlIHNpbXBsZSBtdXN0YWNoZSBpcyByZXNvbHZlZCwgd2UgbmVlZCB0bwogICAgICAgIC8vIGV2YWx1YXRlIGl0IGJ5IGV4ZWN1dGluZyBgYmxvY2tIZWxwZXJNaXNzaW5nYAogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICAgIHRoaXMub3Bjb2RlKCdibG9ja1ZhbHVlJyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hbWJpZ3VvdXNNdXN0YWNoZShtdXN0YWNoZSwgcHJvZ3JhbSwgaW52ZXJzZSk7CgogICAgICAgIC8vIG5vdyB0aGF0IHRoZSBzaW1wbGUgbXVzdGFjaGUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8KICAgICAgICAvLyBldmFsdWF0ZSBpdCBieSBleGVjdXRpbmcgYGJsb2NrSGVscGVyTWlzc2luZ2AKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBwcm9ncmFtKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgICB0aGlzLm9wY29kZSgnYW1iaWd1b3VzQmxvY2tWYWx1ZScpOwogICAgICB9CgogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICB9LAoKICAgIGhhc2g6IGZ1bmN0aW9uKGhhc2gpIHsKICAgICAgdmFyIHBhaXJzID0gaGFzaC5wYWlycywgcGFpciwgdmFsOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2gnLCAne30nKTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXBhaXJzLmxlbmd0aDsgaTxsOyBpKyspIHsKICAgICAgICBwYWlyID0gcGFpcnNbaV07CiAgICAgICAgdmFsICA9IHBhaXJbMV07CgogICAgICAgIHRoaXMuYWNjZXB0KHZhbCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2Fzc2lnblRvSGFzaCcsIHBhaXJbMF0pOwogICAgICB9CiAgICB9LAoKICAgIHBhcnRpYWw6IGZ1bmN0aW9uKHBhcnRpYWwpIHsKICAgICAgdmFyIGlkID0gcGFydGlhbC5pZDsKICAgICAgdGhpcy51c2VQYXJ0aWFsID0gdHJ1ZTsKCiAgICAgIGlmKHBhcnRpYWwuY29udGV4dCkgewogICAgICAgIHRoaXMuSUQocGFydGlhbC5jb250ZXh0KTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaCcsICdkZXB0aDAnKTsKICAgICAgfQoKICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZVBhcnRpYWwnLCBpZC5vcmlnaW5hbCk7CiAgICAgIHRoaXMub3Bjb2RlKCdhcHBlbmQnKTsKICAgIH0sCgogICAgY29udGVudDogZnVuY3Rpb24oY29udGVudCkgewogICAgICB0aGlzLm9wY29kZSgnYXBwZW5kQ29udGVudCcsIGNvbnRlbnQuc3RyaW5nKTsKICAgIH0sCgogICAgbXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlKSB7CiAgICAgIHZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zOwogICAgICB2YXIgdHlwZSA9IHRoaXMuY2xhc3NpZnlNdXN0YWNoZShtdXN0YWNoZSk7CgogICAgICBpZiAodHlwZSA9PT0gInNpbXBsZSIpIHsKICAgICAgICB0aGlzLnNpbXBsZU11c3RhY2hlKG11c3RhY2hlKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAiaGVscGVyIikgewogICAgICAgIHRoaXMuaGVscGVyTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYW1iaWd1b3VzTXVzdGFjaGUobXVzdGFjaGUpOwogICAgICB9CgogICAgICBpZihtdXN0YWNoZS5lc2NhcGVkICYmICFvcHRpb25zLm5vRXNjYXBlKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2FwcGVuZEVzY2FwZWQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnYXBwZW5kJyk7CiAgICAgIH0KICAgIH0sCgogICAgYW1iaWd1b3VzTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkLCBuYW1lID0gaWQucGFydHNbMF07CgogICAgICB0aGlzLm9wY29kZSgnZ2V0Q29udGV4dCcsIGlkLmRlcHRoKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIHByb2dyYW0pOwogICAgICB0aGlzLm9wY29kZSgncHVzaFByb2dyYW0nLCBpbnZlcnNlKTsKCiAgICAgIHRoaXMub3Bjb2RlKCdpbnZva2VBbWJpZ3VvdXMnLCBuYW1lKTsKICAgIH0sCgogICAgc2ltcGxlTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBpZCA9IG11c3RhY2hlLmlkOwoKICAgICAgaWYgKGlkLnR5cGUgPT09ICdEQVRBJykgewogICAgICAgIHRoaXMuREFUQShpZCk7CiAgICAgIH0gZWxzZSBpZiAoaWQucGFydHMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5JRChpZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU2ltcGxpZmllZCBJRCBmb3IgYHRoaXNgCiAgICAgICAgdGhpcy5hZGREZXB0aChpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CiAgICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hDb250ZXh0Jyk7CiAgICAgIH0KCiAgICAgIHRoaXMub3Bjb2RlKCdyZXNvbHZlUG9zc2libGVMYW1iZGEnKTsKICAgIH0sCgogICAgaGVscGVyTXVzdGFjaGU6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSB0aGlzLnNldHVwRnVsbE11c3RhY2hlUGFyYW1zKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSwKICAgICAgICAgIG5hbWUgPSBtdXN0YWNoZS5pZC5wYXJ0c1swXTsKCiAgICAgIGlmICh0aGlzLm9wdGlvbnMua25vd25IZWxwZXJzW25hbWVdKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUtub3duSGVscGVyJywgcGFyYW1zLmxlbmd0aCwgbmFtZSk7CiAgICAgIH0gZWxzZSBpZiAodGhpcy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJZb3Ugc3BlY2lmaWVkIGtub3duSGVscGVyc09ubHksIGJ1dCB1c2VkIHRoZSB1bmtub3duIGhlbHBlciAiICsgbmFtZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2ludm9rZUhlbHBlcicsIHBhcmFtcy5sZW5ndGgsIG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIElEOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLmFkZERlcHRoKGlkLmRlcHRoKTsKICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBpZC5kZXB0aCk7CgogICAgICB2YXIgbmFtZSA9IGlkLnBhcnRzWzBdOwogICAgICBpZiAoIW5hbWUpIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaENvbnRleHQnKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgnbG9va3VwT25Db250ZXh0JywgaWQucGFydHNbMF0pOwogICAgICB9CgogICAgICBmb3IodmFyIGk9MSwgbD1pZC5wYXJ0cy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cCcsIGlkLnBhcnRzW2ldKTsKICAgICAgfQogICAgfSwKCiAgICBEQVRBOiBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHRoaXMub3B0aW9ucy5kYXRhID0gdHJ1ZTsKICAgICAgdGhpcy5vcGNvZGUoJ2xvb2t1cERhdGEnLCBkYXRhLmlkKTsKICAgIH0sCgogICAgU1RSSU5HOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hTdHJpbmcnLCBzdHJpbmcuc3RyaW5nKTsKICAgIH0sCgogICAgSU5URUdFUjogZnVuY3Rpb24oaW50ZWdlcikgewogICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCBpbnRlZ2VyLmludGVnZXIpOwogICAgfSwKCiAgICBCT09MRUFOOiBmdW5jdGlvbihib29sKSB7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsIGJvb2wuYm9vbCk7CiAgICB9LAoKICAgIGNvbW1lbnQ6IGZ1bmN0aW9uKCkge30sCgogICAgLy8gSEVMUEVSUwogICAgb3Bjb2RlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiBuYW1lLCBhcmdzOiBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSkgfSk7CiAgICB9LAoKICAgIGRlY2xhcmU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgIHRoaXMub3Bjb2Rlcy5wdXNoKHsgb3Bjb2RlOiAnREVDTEFSRScsIG5hbWU6IG5hbWUsIHZhbHVlOiB2YWx1ZSB9KTsKICAgIH0sCgogICAgYWRkRGVwdGg6IGZ1bmN0aW9uKGRlcHRoKSB7CiAgICAgIGlmKGlzTmFOKGRlcHRoKSkgeyB0aHJvdyBuZXcgRXJyb3IoIkVXT1QiKTsgfQogICAgICBpZihkZXB0aCA9PT0gMCkgeyByZXR1cm47IH0KCiAgICAgIGlmKCF0aGlzLmRlcHRoc1tkZXB0aF0pIHsKICAgICAgICB0aGlzLmRlcHRoc1tkZXB0aF0gPSB0cnVlOwogICAgICAgIHRoaXMuZGVwdGhzLmxpc3QucHVzaChkZXB0aCk7CiAgICAgIH0KICAgIH0sCgogICAgY2xhc3NpZnlNdXN0YWNoZTogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIGlzSGVscGVyICAgPSBtdXN0YWNoZS5pc0hlbHBlcjsKICAgICAgdmFyIGlzRWxpZ2libGUgPSBtdXN0YWNoZS5lbGlnaWJsZUhlbHBlcjsKICAgICAgdmFyIG9wdGlvbnMgICAgPSB0aGlzLm9wdGlvbnM7CgogICAgICAvLyBpZiBhbWJpZ3VvdXMsIHdlIGNhbiBwb3NzaWJseSByZXNvbHZlIHRoZSBhbWJpZ3VpdHkgbm93CiAgICAgIGlmIChpc0VsaWdpYmxlICYmICFpc0hlbHBlcikgewogICAgICAgIHZhciBuYW1lID0gbXVzdGFjaGUuaWQucGFydHNbMF07CgogICAgICAgIGlmIChvcHRpb25zLmtub3duSGVscGVyc1tuYW1lXSkgewogICAgICAgICAgaXNIZWxwZXIgPSB0cnVlOwogICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5rbm93bkhlbHBlcnNPbmx5KSB7CiAgICAgICAgICBpc0VsaWdpYmxlID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoaXNIZWxwZXIpIHsgcmV0dXJuICJoZWxwZXIiOyB9CiAgICAgIGVsc2UgaWYgKGlzRWxpZ2libGUpIHsgcmV0dXJuICJhbWJpZ3VvdXMiOyB9CiAgICAgIGVsc2UgeyByZXR1cm4gInNpbXBsZSI7IH0KICAgIH0sCgogICAgcHVzaFBhcmFtczogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICAgIHZhciBpID0gcGFyYW1zLmxlbmd0aCwgcGFyYW07CgogICAgICB3aGlsZShpLS0pIHsKICAgICAgICBwYXJhbSA9IHBhcmFtc1tpXTsKCiAgICAgICAgaWYodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgICAgaWYocGFyYW0uZGVwdGgpIHsKICAgICAgICAgICAgdGhpcy5hZGREZXB0aChwYXJhbS5kZXB0aCk7CiAgICAgICAgICB9CgogICAgICAgICAgdGhpcy5vcGNvZGUoJ2dldENvbnRleHQnLCBwYXJhbS5kZXB0aCB8fCAwKTsKICAgICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoU3RyaW5nUGFyYW0nLCBwYXJhbS5zdHJpbmcpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICB0aGlzW3BhcmFtLnR5cGVdKHBhcmFtKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgc2V0dXBNdXN0YWNoZVBhcmFtczogZnVuY3Rpb24obXVzdGFjaGUpIHsKICAgICAgdmFyIHBhcmFtcyA9IG11c3RhY2hlLnBhcmFtczsKICAgICAgdGhpcy5wdXNoUGFyYW1zKHBhcmFtcyk7CgogICAgICBpZihtdXN0YWNoZS5oYXNoKSB7CiAgICAgICAgdGhpcy5oYXNoKG11c3RhY2hlLmhhc2gpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMub3Bjb2RlKCdwdXNoTGl0ZXJhbCcsICd7fScpOwogICAgICB9CgogICAgICByZXR1cm4gcGFyYW1zOwogICAgfSwKCiAgICAvLyB0aGlzIHdpbGwgcmVwbGFjZSBzZXR1cE11c3RhY2hlUGFyYW1zIHdoZW4gd2UncmUgZG9uZQogICAgc2V0dXBGdWxsTXVzdGFjaGVQYXJhbXM6IGZ1bmN0aW9uKG11c3RhY2hlLCBwcm9ncmFtLCBpbnZlcnNlKSB7CiAgICAgIHZhciBwYXJhbXMgPSBtdXN0YWNoZS5wYXJhbXM7CiAgICAgIHRoaXMucHVzaFBhcmFtcyhwYXJhbXMpOwoKICAgICAgdGhpcy5vcGNvZGUoJ3B1c2hQcm9ncmFtJywgcHJvZ3JhbSk7CiAgICAgIHRoaXMub3Bjb2RlKCdwdXNoUHJvZ3JhbScsIGludmVyc2UpOwoKICAgICAgaWYobXVzdGFjaGUuaGFzaCkgewogICAgICAgIHRoaXMuaGFzaChtdXN0YWNoZS5oYXNoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm9wY29kZSgncHVzaExpdGVyYWwnLCAne30nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHBhcmFtczsKICAgIH0KICB9OwoKICB2YXIgTGl0ZXJhbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgfTsKCiAgSmF2YVNjcmlwdENvbXBpbGVyLnByb3RvdHlwZSA9IHsKICAgIC8vIFBVQkxJQyBBUEk6IFlvdSBjYW4gb3ZlcnJpZGUgdGhlc2UgbWV0aG9kcyBpbiBhIHN1YmNsYXNzIHRvIHByb3ZpZGUKICAgIC8vIGFsdGVybmF0aXZlIGNvbXBpbGVkIGZvcm1zIGZvciBuYW1lIGxvb2t1cCBhbmQgYnVmZmVyaW5nIHNlbWFudGljcwogICAgbmFtZUxvb2t1cDogZnVuY3Rpb24ocGFyZW50LCBuYW1lLCB0eXBlKSB7CiAgICAgIGlmICgvXlswLTldKyQvLnRlc3QobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsiICsgbmFtZSArICJdIjsKICAgICAgfSBlbHNlIGlmIChKYXZhU2NyaXB0Q29tcGlsZXIuaXNWYWxpZEphdmFTY3JpcHRWYXJpYWJsZU5hbWUobmFtZSkpIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIi4iICsgbmFtZTsKICAgICAgfQogICAgICBlbHNlIHsKICAgICAgICByZXR1cm4gcGFyZW50ICsgIlsnIiArIG5hbWUgKyAiJ10iOwogICAgICB9CiAgICB9LAoKICAgIGFwcGVuZFRvQnVmZmVyOiBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgaWYgKHRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICByZXR1cm4gInJldHVybiAiICsgc3RyaW5nICsgIjsiOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAiYnVmZmVyICs9ICIgKyBzdHJpbmcgKyAiOyI7CiAgICAgIH0KICAgIH0sCgogICAgaW5pdGlhbGl6ZUJ1ZmZlcjogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLnF1b3RlZFN0cmluZygiIik7CiAgICB9LAoKICAgIG5hbWVzcGFjZTogIkhhbmRsZWJhcnMiLAogICAgLy8gRU5EIFBVQkxJQyBBUEkKCiAgICBjb21waWxlOiBmdW5jdGlvbihlbnZpcm9ubWVudCwgb3B0aW9ucywgY29udGV4dCwgYXNPYmplY3QpIHsKICAgICAgdGhpcy5lbnZpcm9ubWVudCA9IGVudmlyb25tZW50OwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIHRoaXMuZW52aXJvbm1lbnQuZGlzYXNzZW1ibGUoKSArICJcblxuIik7CgogICAgICB0aGlzLm5hbWUgPSB0aGlzLmVudmlyb25tZW50Lm5hbWU7CiAgICAgIHRoaXMuaXNDaGlsZCA9ICEhY29udGV4dDsKICAgICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCB7CiAgICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICAgIGFsaWFzZXM6IHsgfQogICAgICB9OwoKICAgICAgdGhpcy5wcmVhbWJsZSgpOwoKICAgICAgdGhpcy5zdGFja1Nsb3QgPSAwOwogICAgICB0aGlzLnN0YWNrVmFycyA9IFtdOwogICAgICB0aGlzLnJlZ2lzdGVycyA9IHsgbGlzdDogW10gfTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sgPSBbXTsKCiAgICAgIHRoaXMuY29tcGlsZUNoaWxkcmVuKGVudmlyb25tZW50LCBvcHRpb25zKTsKCiAgICAgIHZhciBvcGNvZGVzID0gZW52aXJvbm1lbnQub3Bjb2Rlcywgb3Bjb2RlOwoKICAgICAgdGhpcy5pID0gMDsKCiAgICAgIGZvcihsPW9wY29kZXMubGVuZ3RoOyB0aGlzLmk8bDsgdGhpcy5pKyspIHsKICAgICAgICBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaV07CgogICAgICAgIGlmKG9wY29kZS5vcGNvZGUgPT09ICdERUNMQVJFJykgewogICAgICAgICAgdGhpc1tvcGNvZGUubmFtZV0gPSBvcGNvZGUudmFsdWU7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRoaXNbb3Bjb2RlLm9wY29kZV0uYXBwbHkodGhpcywgb3Bjb2RlLmFyZ3MpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlRnVuY3Rpb25Db250ZXh0KGFzT2JqZWN0KTsKICAgIH0sCgogICAgbmV4dE9wY29kZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBvcGNvZGVzID0gdGhpcy5lbnZpcm9ubWVudC5vcGNvZGVzLCBvcGNvZGUgPSBvcGNvZGVzW3RoaXMuaSArIDFdOwogICAgICByZXR1cm4gb3Bjb2Rlc1t0aGlzLmkgKyAxXTsKICAgIH0sCgogICAgZWF0OiBmdW5jdGlvbihvcGNvZGUpIHsKICAgICAgdGhpcy5pID0gdGhpcy5pICsgMTsKICAgIH0sCgogICAgcHJlYW1ibGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb3V0ID0gW107CgogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBuYW1lc3BhY2UgPSB0aGlzLm5hbWVzcGFjZTsKICAgICAgICB2YXIgY29waWVzID0gImhlbHBlcnMgPSBoZWxwZXJzIHx8ICIgKyBuYW1lc3BhY2UgKyAiLmhlbHBlcnM7IjsKICAgICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC51c2VQYXJ0aWFsKSB7IGNvcGllcyA9IGNvcGllcyArICIgcGFydGlhbHMgPSBwYXJ0aWFscyB8fCAiICsgbmFtZXNwYWNlICsgIi5wYXJ0aWFsczsiOyB9CiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5kYXRhKSB7IGNvcGllcyA9IGNvcGllcyArICIgZGF0YSA9IGRhdGEgfHwge307IjsgfQogICAgICAgIG91dC5wdXNoKGNvcGllcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgb3V0LnB1c2goJycpOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICBvdXQucHVzaCgiLCBidWZmZXIgPSAiICsgdGhpcy5pbml0aWFsaXplQnVmZmVyKCkpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dC5wdXNoKCIiKTsKICAgICAgfQoKICAgICAgLy8gdHJhY2sgdGhlIGxhc3QgY29udGV4dCBwdXNoZWQgaW50byBwbGFjZSB0byBhbGxvdyBza2lwcGluZyB0aGUKICAgICAgLy8gZ2V0Q29udGV4dCBvcGNvZGUgd2hlbiBpdCB3b3VsZCBiZSBhIG5vb3AKICAgICAgdGhpcy5sYXN0Q29udGV4dCA9IDA7CiAgICAgIHRoaXMuc291cmNlID0gb3V0OwogICAgfSwKCiAgICBjcmVhdGVGdW5jdGlvbkNvbnRleHQ6IGZ1bmN0aW9uKGFzT2JqZWN0KSB7CiAgICAgIHZhciBsb2NhbHMgPSB0aGlzLnN0YWNrVmFycy5jb25jYXQodGhpcy5yZWdpc3RlcnMubGlzdCk7CgogICAgICBpZihsb2NhbHMubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAiLCAiICsgbG9jYWxzLmpvaW4oIiwgIik7CiAgICAgIH0KCiAgICAgIC8vIEdlbmVyYXRlIG1pbmltaXplciBhbGlhcyBtYXBwaW5ncwogICAgICBpZiAoIXRoaXMuaXNDaGlsZCkgewogICAgICAgIHZhciBhbGlhc2VzID0gW107CiAgICAgICAgZm9yICh2YXIgYWxpYXMgaW4gdGhpcy5jb250ZXh0LmFsaWFzZXMpIHsKICAgICAgICAgIHRoaXMuc291cmNlWzFdID0gdGhpcy5zb3VyY2VbMV0gKyAnLCAnICsgYWxpYXMgKyAnPScgKyB0aGlzLmNvbnRleHQuYWxpYXNlc1thbGlhc107CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5zb3VyY2VbMV0pIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSA9ICJ2YXIgIiArIHRoaXMuc291cmNlWzFdLnN1YnN0cmluZygyKSArICI7IjsKICAgICAgfQoKICAgICAgLy8gTWVyZ2UgY2hpbGRyZW4KICAgICAgaWYgKCF0aGlzLmlzQ2hpbGQpIHsKICAgICAgICB0aGlzLnNvdXJjZVsxXSArPSAnXG4nICsgdGhpcy5jb250ZXh0LnByb2dyYW1zLmpvaW4oJ1xuJykgKyAnXG4nOwogICAgICB9CgogICAgICBpZiAoIXRoaXMuZW52aXJvbm1lbnQuaXNTaW1wbGUpIHsKICAgICAgICB0aGlzLnNvdXJjZS5wdXNoKCJyZXR1cm4gYnVmZmVyOyIpOwogICAgICB9CgogICAgICB2YXIgcGFyYW1zID0gdGhpcy5pc0NoaWxkID8gWyJkZXB0aDAiLCAiZGF0YSJdIDogWyJIYW5kbGViYXJzIiwgImRlcHRoMCIsICJoZWxwZXJzIiwgInBhcnRpYWxzIiwgImRhdGEiXTsKCiAgICAgIGZvcih2YXIgaT0wLCBsPXRoaXMuZW52aXJvbm1lbnQuZGVwdGhzLmxpc3QubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIHBhcmFtcy5wdXNoKCJkZXB0aCIgKyB0aGlzLmVudmlyb25tZW50LmRlcHRocy5saXN0W2ldKTsKICAgICAgfQoKICAgICAgaWYgKGFzT2JqZWN0KSB7CiAgICAgICAgcGFyYW1zLnB1c2godGhpcy5zb3VyY2Uuam9pbigiXG4gICIpKTsKCiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uLmFwcGx5KHRoaXMsIHBhcmFtcyk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdmFyIGZ1bmN0aW9uU291cmNlID0gJ2Z1bmN0aW9uICcgKyAodGhpcy5uYW1lIHx8ICcnKSArICcoJyArIHBhcmFtcy5qb2luKCcsJykgKyAnKSB7XG4gICcgKyB0aGlzLnNvdXJjZS5qb2luKCJcbiAgIikgKyAnfSc7CiAgICAgICAgSGFuZGxlYmFycy5sb2coSGFuZGxlYmFycy5sb2dnZXIuREVCVUcsIGZ1bmN0aW9uU291cmNlICsgIlxuXG4iKTsKICAgICAgICByZXR1cm4gZnVuY3Rpb25Tb3VyY2U7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2Jsb2NrVmFsdWVdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogaGFzaCwgaW52ZXJzZSwgcHJvZ3JhbSwgdmFsdWUKICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogcmV0dXJuIHZhbHVlIG9mIGJsb2NrSGVscGVyTWlzc2luZwogICAgLy8KICAgIC8vIFRoZSBwdXJwb3NlIG9mIHRoaXMgb3Bjb2RlIGlzIHRvIHRha2UgYSBibG9jayBvZiB0aGUgZm9ybQogICAgLy8gYHt7I2Zvb319Li4ue3svZm9vfX1gLCByZXNvbHZlIHRoZSB2YWx1ZSBvZiBgZm9vYCwgYW5kCiAgICAvLyByZXBsYWNlIGl0IG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgcHJvcGVybHkKICAgIC8vIGludm9raW5nIGJsb2NrSGVscGVyTWlzc2luZy4KICAgIGJsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwogICAgICAgIHJldHVybiBjdXJyZW50ICsgIiA9IGJsb2NrSGVscGVyTWlzc2luZy5jYWxsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpIjsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFthbWJpZ3VvdXNCbG9ja1ZhbHVlXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IGhhc2gsIGludmVyc2UsIHByb2dyYW0sIHZhbHVlCiAgICAvLyBDb21waWxlciB2YWx1ZSwgYmVmb3JlOiBsYXN0SGVscGVyPXZhbHVlIG9mIGxhc3QgZm91bmQgaGVscGVyLCBpZiBhbnkKICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbm8gbGFzdEhlbHBlcjogc2FtZSBhcyBbYmxvY2tWYWx1ZV0KICAgIC8vIE9uIHN0YWNrLCBhZnRlciwgaWYgbGFzdEhlbHBlcjogdmFsdWUKICAgIGFtYmlndW91c0Jsb2NrVmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5ibG9ja0hlbHBlck1pc3NpbmcgPSAnaGVscGVycy5ibG9ja0hlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIHBhcmFtcyA9IFsiZGVwdGgwIl07CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMoMCwgcGFyYW1zKTsKCiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy50b3BTdGFjaygpOwogICAgICBwYXJhbXMuc3BsaWNlKDEsIDAsIGN1cnJlbnQpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYgKCEiICsgdGhpcy5sYXN0SGVscGVyICsgIikgeyAiICsgY3VycmVudCArICIgPSBibG9ja0hlbHBlck1pc3NpbmcuY2FsbCgiICsgcGFyYW1zLmpvaW4oIiwgIikgKyAiKTsgfSIpOwogICAgfSwKCiAgICAvLyBbYXBwZW5kQ29udGVudF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gQXBwZW5kcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGBjb250ZW50YCB0byB0aGUgY3VycmVudCBidWZmZXIKICAgIGFwcGVuZENvbnRlbnQ6IGZ1bmN0aW9uKGNvbnRlbnQpIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmFwcGVuZFRvQnVmZmVyKHRoaXMucXVvdGVkU3RyaW5nKGNvbnRlbnQpKSk7CiAgICB9LAoKICAgIC8vIFthcHBlbmRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vCiAgICAvLyBDb2VyY2VzIGB2YWx1ZWAgdG8gYSBTdHJpbmcgYW5kIGFwcGVuZHMgaXQgdG8gdGhlIGN1cnJlbnQgYnVmZmVyLgogICAgLy8KICAgIC8vIElmIGB2YWx1ZWAgaXMgdHJ1dGh5LCBvciAwLCBpdCBpcyBjb2VyY2VkIGludG8gYSBzdHJpbmcgYW5kIGFwcGVuZGVkCiAgICAvLyBPdGhlcndpc2UsIHRoZSBlbXB0eSBzdHJpbmcgaXMgYXBwZW5kZWQKICAgIGFwcGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBsb2NhbCA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaCgiaWYoIiArIGxvY2FsICsgIiB8fCAiICsgbG9jYWwgKyAiID09PSAwKSB7ICIgKyB0aGlzLmFwcGVuZFRvQnVmZmVyKGxvY2FsKSArICIgfSIpOwogICAgICBpZiAodGhpcy5lbnZpcm9ubWVudC5pc1NpbXBsZSkgewogICAgICAgIHRoaXMuc291cmNlLnB1c2goImVsc2UgeyAiICsgdGhpcy5hcHBlbmRUb0J1ZmZlcigiJyciKSArICIgfSIpOwogICAgICB9CiAgICB9LAoKICAgIC8vIFthcHBlbmRFc2NhcGVkXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogLi4uCiAgICAvLwogICAgLy8gRXNjYXBlIGB2YWx1ZWAgYW5kIGFwcGVuZCBpdCB0byB0aGUgYnVmZmVyCiAgICBhcHBlbmRFc2NhcGVkOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIG9wY29kZSA9IHRoaXMubmV4dE9wY29kZSgpLCBleHRyYSA9ICIiOwogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5lc2NhcGVFeHByZXNzaW9uID0gJ3RoaXMuZXNjYXBlRXhwcmVzc2lvbic7CgogICAgICBpZihvcGNvZGUgJiYgb3Bjb2RlLm9wY29kZSA9PT0gJ2FwcGVuZENvbnRlbnQnKSB7CiAgICAgICAgZXh0cmEgPSAiICsgIiArIHRoaXMucXVvdGVkU3RyaW5nKG9wY29kZS5hcmdzWzBdKTsKICAgICAgICB0aGlzLmVhdChvcGNvZGUpOwogICAgICB9CgogICAgICB0aGlzLnNvdXJjZS5wdXNoKHRoaXMuYXBwZW5kVG9CdWZmZXIoImVzY2FwZUV4cHJlc3Npb24oIiArIHRoaXMucG9wU3RhY2soKSArICIpIiArIGV4dHJhKSk7CiAgICB9LAoKICAgIC8vIFtnZXRDb250ZXh0XQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiAuLi4KICAgIC8vIENvbXBpbGVyIHZhbHVlLCBhZnRlcjogbGFzdENvbnRleHQ9ZGVwdGgKICAgIC8vCiAgICAvLyBTZXQgdGhlIHZhbHVlIG9mIHRoZSBgbGFzdENvbnRleHRgIGNvbXBpbGVyIHZhbHVlIHRvIHRoZSBkZXB0aAogICAgZ2V0Q29udGV4dDogZnVuY3Rpb24oZGVwdGgpIHsKICAgICAgaWYodGhpcy5sYXN0Q29udGV4dCAhPT0gZGVwdGgpIHsKICAgICAgICB0aGlzLmxhc3RDb250ZXh0ID0gZGVwdGg7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2xvb2t1cE9uQ29udGV4dF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogY3VycmVudENvbnRleHRbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIExvb2tzIHVwIHRoZSB2YWx1ZSBvZiBgbmFtZWAgb24gdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgcHVzaGVzCiAgICAvLyBpdCBvbnRvIHRoZSBzdGFjay4KICAgIGxvb2t1cE9uQ29udGV4dDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0JykpOwogICAgfSwKCiAgICAvLyBbcHVzaENvbnRleHRdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IGN1cnJlbnRDb250ZXh0LCAuLi4KICAgIC8vCiAgICAvLyBQdXNoZXMgdGhlIHZhbHVlIG9mIHRoZSBjdXJyZW50IGNvbnRleHQgb250byB0aGUgc3RhY2suCiAgICBwdXNoQ29udGV4dDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgnZGVwdGgnICsgdGhpcy5sYXN0Q29udGV4dCk7CiAgICB9LAoKICAgIC8vIFtyZXNvbHZlUG9zc2libGVMYW1iZGFdCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogdmFsdWUsIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXNvbHZlZCB2YWx1ZSwgLi4uCiAgICAvLwogICAgLy8gSWYgdGhlIGB2YWx1ZWAgaXMgYSBsYW1iZGEsIHJlcGxhY2UgaXQgb24gdGhlIHN0YWNrIGJ5CiAgICAvLyB0aGUgcmV0dXJuIHZhbHVlIG9mIHRoZSBsYW1iZGEKICAgIHJlc29sdmVQb3NzaWJsZUxhbWJkYTogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucmVwbGFjZVN0YWNrKGZ1bmN0aW9uKGN1cnJlbnQpIHsKICAgICAgICByZXR1cm4gInR5cGVvZiAiICsgY3VycmVudCArICIgPT09IGZ1bmN0aW9uVHlwZSA/ICIgKyBjdXJyZW50ICsgIigpIDogIiArIGN1cnJlbnQ7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBbbG9va3VwXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWVbbmFtZV0sIC4uLgogICAgLy8KICAgIC8vIFJlcGxhY2UgdGhlIHZhbHVlIG9uIHRoZSBzdGFjayB3aXRoIHRoZSByZXN1bHQgb2YgbG9va2luZwogICAgLy8gdXAgYG5hbWVgIG9uIGB2YWx1ZWAKICAgIGxvb2t1cDogZnVuY3Rpb24obmFtZSkgewogICAgICB0aGlzLnJlcGxhY2VTdGFjayhmdW5jdGlvbihjdXJyZW50KSB7CiAgICAgICAgcmV0dXJuIGN1cnJlbnQgKyAiID09IG51bGwgfHwgIiArIGN1cnJlbnQgKyAiID09PSBmYWxzZSA/ICIgKyBjdXJyZW50ICsgIiA6ICIgKyB0aGlzLm5hbWVMb29rdXAoY3VycmVudCwgbmFtZSwgJ2NvbnRleHQnKTsKICAgICAgfSk7CiAgICB9LAoKICAgIC8vIFtsb29rdXBEYXRhXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBkYXRhW2lkXSwgLi4uCiAgICAvLwogICAgLy8gUHVzaCB0aGUgcmVzdWx0IG9mIGxvb2tpbmcgdXAgYGlkYCBvbiB0aGUgY3VycmVudCBkYXRhCiAgICBsb29rdXBEYXRhOiBmdW5jdGlvbihpZCkgewogICAgICB0aGlzLnB1c2hTdGFjayh0aGlzLm5hbWVMb29rdXAoJ2RhdGEnLCBpZCwgJ2RhdGEnKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoU3RyaW5nUGFyYW1dCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHN0cmluZywgY3VycmVudENvbnRleHQsIC4uLgogICAgLy8KICAgIC8vIFRoaXMgb3Bjb2RlIGlzIGRlc2lnbmVkIGZvciB1c2UgaW4gc3RyaW5nIG1vZGUsIHdoaWNoCiAgICAvLyBwcm92aWRlcyB0aGUgc3RyaW5nIHZhbHVlIG9mIGEgcGFyYW1ldGVyIGFsb25nIHdpdGggaXRzCiAgICAvLyBkZXB0aCByYXRoZXIgdGhhbiByZXNvbHZpbmcgaXQgaW1tZWRpYXRlbHkuCiAgICBwdXNoU3RyaW5nUGFyYW06IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQpOwogICAgICB0aGlzLnB1c2hTdHJpbmcoc3RyaW5nKTsKICAgIH0sCgogICAgLy8gW3B1c2hTdHJpbmddCiAgICAvLwogICAgLy8gT24gc3RhY2ssIGJlZm9yZTogLi4uCiAgICAvLyBPbiBzdGFjaywgYWZ0ZXI6IHF1b3RlZFN0cmluZyhzdHJpbmcpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcXVvdGVkIHZlcnNpb24gb2YgYHN0cmluZ2Agb250byB0aGUgc3RhY2sKICAgIHB1c2hTdHJpbmc6IGZ1bmN0aW9uKHN0cmluZykgewogICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwodGhpcy5xdW90ZWRTdHJpbmcoc3RyaW5nKSk7CiAgICB9LAoKICAgIC8vIFtwdXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBleHByLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGFuIGV4cHJlc3Npb24gb250byB0aGUgc3RhY2sKICAgIHB1c2g6IGZ1bmN0aW9uKGV4cHIpIHsKICAgICAgdGhpcy5wdXNoU3RhY2soZXhwcik7CiAgICB9LAoKICAgIC8vIFtwdXNoTGl0ZXJhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogdmFsdWUsIC4uLgogICAgLy8KICAgIC8vIFB1c2hlcyBhIHZhbHVlIG9udG8gdGhlIHN0YWNrLiBUaGlzIG9wZXJhdGlvbiBwcmV2ZW50cwogICAgLy8gdGhlIGNvbXBpbGVyIGZyb20gY3JlYXRpbmcgYSB0ZW1wb3JhcnkgdmFyaWFibGUgdG8gaG9sZAogICAgLy8gaXQuCiAgICBwdXNoTGl0ZXJhbDogZnVuY3Rpb24odmFsdWUpIHsKICAgICAgdGhpcy5wdXNoU3RhY2tMaXRlcmFsKHZhbHVlKTsKICAgIH0sCgogICAgLy8gW3B1c2hQcm9ncmFtXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiBwcm9ncmFtKGd1aWQpLCAuLi4KICAgIC8vCiAgICAvLyBQdXNoIGEgcHJvZ3JhbSBleHByZXNzaW9uIG9udG8gdGhlIHN0YWNrLiBUaGlzIHRha2VzCiAgICAvLyBhIGNvbXBpbGUtdGltZSBndWlkIGFuZCBjb252ZXJ0cyBpdCBpbnRvIGEgcnVudGltZS1hY2Nlc3NpYmxlCiAgICAvLyBleHByZXNzaW9uLgogICAgcHVzaFByb2dyYW06IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgaWYgKGd1aWQgIT0gbnVsbCkgewogICAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCh0aGlzLnByb2dyYW1FeHByZXNzaW9uKGd1aWQpKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnB1c2hTdGFja0xpdGVyYWwobnVsbCk7CiAgICAgIH0KICAgIH0sCgogICAgLy8gW2ludm9rZUhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBQb3BzIG9mZiB0aGUgaGVscGVyJ3MgcGFyYW1ldGVycywgaW52b2tlcyB0aGUgaGVscGVyLAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGVscGVyJ3MgcmV0dXJuIHZhbHVlIG9udG8gdGhlIHN0YWNrLgogICAgLy8KICAgIC8vIElmIHRoZSBoZWxwZXIgaXMgbm90IGZvdW5kLCBgaGVscGVyTWlzc2luZ2AgaXMgY2FsbGVkLgogICAgaW52b2tlSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuaGVscGVyTWlzc2luZyA9ICdoZWxwZXJzLmhlbHBlck1pc3NpbmcnOwoKICAgICAgdmFyIGhlbHBlciA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXIubmFtZSk7CgogICAgICB0aGlzLnB1c2hTdGFjaygiZm91bmRIZWxwZXIgPyBmb3VuZEhlbHBlci5jYWxsKCIgKwogICAgICAgIGhlbHBlci5jYWxsUGFyYW1zICsgIikgIiArICI6IGhlbHBlck1pc3NpbmcuY2FsbCgiICsKICAgICAgICBoZWxwZXIuaGVscGVyTWlzc2luZ1BhcmFtcyArICIpIik7CiAgICB9LAoKICAgIC8vIFtpbnZva2VLbm93bkhlbHBlcl0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgaGVscGVyIGludm9jYXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gdGhlIGhlbHBlciBpcyBrbm93biB0byBleGlzdCwKICAgIC8vIHNvIGEgYGhlbHBlck1pc3NpbmdgIGZhbGxiYWNrIGlzIG5vdCByZXF1aXJlZC4KICAgIGludm9rZUtub3duSGVscGVyOiBmdW5jdGlvbihwYXJhbVNpemUsIG5hbWUpIHsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIocGFyYW1TaXplLCBuYW1lKTsKICAgICAgdGhpcy5wdXNoU3RhY2soaGVscGVyLm5hbWUgKyAiLmNhbGwoIiArIGhlbHBlci5jYWxsUGFyYW1zICsgIikiKTsKICAgIH0sCgogICAgLy8gW2ludm9rZUFtYmlndW91c10KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBoYXNoLCBpbnZlcnNlLCBwcm9ncmFtLCBwYXJhbXMuLi4sIC4uLgogICAgLy8gT24gc3RhY2ssIGFmdGVyOiByZXN1bHQgb2YgZGlzYW1iaWd1YXRpb24KICAgIC8vCiAgICAvLyBUaGlzIG9wZXJhdGlvbiBpcyB1c2VkIHdoZW4gYW4gZXhwcmVzc2lvbiBsaWtlIGB7e2Zvb319YAogICAgLy8gaXMgcHJvdmlkZWQsIGJ1dCB3ZSBkb24ndCBrbm93IGF0IGNvbXBpbGUtdGltZSB3aGV0aGVyIGl0CiAgICAvLyBpcyBhIGhlbHBlciBvciBhIHBhdGguCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gZW1pdHMgbW9yZSBjb2RlIHRoYW4gdGhlIG90aGVyIG9wdGlvbnMsCiAgICAvLyBhbmQgY2FuIGJlIGF2b2lkZWQgYnkgcGFzc2luZyB0aGUgYGtub3duSGVscGVyc2AgYW5kCiAgICAvLyBga25vd25IZWxwZXJzT25seWAgZmxhZ3MgYXQgY29tcGlsZS10aW1lLgogICAgaW52b2tlQW1iaWd1b3VzOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLmZ1bmN0aW9uVHlwZSA9ICciZnVuY3Rpb24iJzsKCiAgICAgIHRoaXMucHVzaFN0YWNrTGl0ZXJhbCgne30nKTsKICAgICAgdmFyIGhlbHBlciA9IHRoaXMuc2V0dXBIZWxwZXIoMCwgbmFtZSk7CgogICAgICB2YXIgaGVscGVyTmFtZSA9IHRoaXMubGFzdEhlbHBlciA9IHRoaXMubmFtZUxvb2t1cCgnaGVscGVycycsIG5hbWUsICdoZWxwZXInKTsKICAgICAgdGhpcy5yZWdpc3RlcignZm91bmRIZWxwZXInLCBoZWxwZXJOYW1lKTsKCiAgICAgIHZhciBub25IZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2RlcHRoJyArIHRoaXMubGFzdENvbnRleHQsIG5hbWUsICdjb250ZXh0Jyk7CiAgICAgIHZhciBuZXh0U3RhY2sgPSB0aGlzLm5leHRTdGFjaygpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCgnaWYgKGZvdW5kSGVscGVyKSB7ICcgKyBuZXh0U3RhY2sgKyAnID0gZm91bmRIZWxwZXIuY2FsbCgnICsgaGVscGVyLmNhbGxQYXJhbXMgKyAnKTsgfScpOwogICAgICB0aGlzLnNvdXJjZS5wdXNoKCdlbHNlIHsgJyArIG5leHRTdGFjayArICcgPSAnICsgbm9uSGVscGVyICsgJzsgJyArIG5leHRTdGFjayArICcgPSB0eXBlb2YgJyArIG5leHRTdGFjayArICcgPT09IGZ1bmN0aW9uVHlwZSA/ICcgKyBuZXh0U3RhY2sgKyAnKCkgOiAnICsgbmV4dFN0YWNrICsgJzsgfScpOwogICAgfSwKCiAgICAvLyBbaW52b2tlUGFydGlhbF0KICAgIC8vCiAgICAvLyBPbiBzdGFjaywgYmVmb3JlOiBjb250ZXh0LCAuLi4KICAgIC8vIE9uIHN0YWNrIGFmdGVyOiByZXN1bHQgb2YgcGFydGlhbCBpbnZvY2F0aW9uCiAgICAvLwogICAgLy8gVGhpcyBvcGVyYXRpb24gcG9wcyBvZmYgYSBjb250ZXh0LCBpbnZva2VzIGEgcGFydGlhbCB3aXRoIHRoYXQgY29udGV4dCwKICAgIC8vIGFuZCBwdXNoZXMgdGhlIHJlc3VsdCBvZiB0aGUgaW52b2NhdGlvbiBiYWNrLgogICAgaW52b2tlUGFydGlhbDogZnVuY3Rpb24obmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW3RoaXMubmFtZUxvb2t1cCgncGFydGlhbHMnLCBuYW1lLCAncGFydGlhbCcpLCAiJyIgKyBuYW1lICsgIiciLCB0aGlzLnBvcFN0YWNrKCksICJoZWxwZXJzIiwgInBhcnRpYWxzIl07CgogICAgICBpZiAodGhpcy5vcHRpb25zLmRhdGEpIHsKICAgICAgICBwYXJhbXMucHVzaCgiZGF0YSIpOwogICAgICB9CgogICAgICB0aGlzLmNvbnRleHQuYWxpYXNlcy5zZWxmID0gInRoaXMiOwogICAgICB0aGlzLnB1c2hTdGFjaygic2VsZi5pbnZva2VQYXJ0aWFsKCIgKyBwYXJhbXMuam9pbigiLCAiKSArICIpOyIpOwogICAgfSwKCiAgICAvLyBbYXNzaWduVG9IYXNoXQogICAgLy8KICAgIC8vIE9uIHN0YWNrLCBiZWZvcmU6IHZhbHVlLCBoYXNoLCAuLi4KICAgIC8vIE9uIHN0YWNrLCBhZnRlcjogaGFzaCwgLi4uCiAgICAvLwogICAgLy8gUG9wcyBhIHZhbHVlIGFuZCBoYXNoIG9mZiB0aGUgc3RhY2ssIGFzc2lnbnMgYGhhc2hba2V5XSA9IHZhbHVlYAogICAgLy8gYW5kIHB1c2hlcyB0aGUgaGFzaCBiYWNrIG9udG8gdGhlIHN0YWNrLgogICAgYXNzaWduVG9IYXNoOiBmdW5jdGlvbihrZXkpIHsKICAgICAgdmFyIHZhbHVlID0gdGhpcy5wb3BTdGFjaygpOwogICAgICB2YXIgaGFzaCA9IHRoaXMudG9wU3RhY2soKTsKCiAgICAgIHRoaXMuc291cmNlLnB1c2goaGFzaCArICJbJyIgKyBrZXkgKyAiJ10gPSAiICsgdmFsdWUgKyAiOyIpOwogICAgfSwKCiAgICAvLyBIRUxQRVJTCgogICAgY29tcGlsZXI6IEphdmFTY3JpcHRDb21waWxlciwKCiAgICBjb21waWxlQ2hpbGRyZW46IGZ1bmN0aW9uKGVudmlyb25tZW50LCBvcHRpb25zKSB7CiAgICAgIHZhciBjaGlsZHJlbiA9IGVudmlyb25tZW50LmNoaWxkcmVuLCBjaGlsZCwgY29tcGlsZXI7CgogICAgICBmb3IodmFyIGk9MCwgbD1jaGlsZHJlbi5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICAgICAgY2hpbGQgPSBjaGlsZHJlbltpXTsKICAgICAgICBjb21waWxlciA9IG5ldyB0aGlzLmNvbXBpbGVyKCk7CgogICAgICAgIHRoaXMuY29udGV4dC5wcm9ncmFtcy5wdXNoKCcnKTsgICAgIC8vIFBsYWNlaG9sZGVyIHRvIHByZXZlbnQgbmFtZSBjb25mbGljdHMgZm9yIG5lc3RlZCBjaGlsZHJlbgogICAgICAgIHZhciBpbmRleCA9IHRoaXMuY29udGV4dC5wcm9ncmFtcy5sZW5ndGg7CiAgICAgICAgY2hpbGQuaW5kZXggPSBpbmRleDsKICAgICAgICBjaGlsZC5uYW1lID0gJ3Byb2dyYW0nICsgaW5kZXg7CiAgICAgICAgdGhpcy5jb250ZXh0LnByb2dyYW1zW2luZGV4XSA9IGNvbXBpbGVyLmNvbXBpbGUoY2hpbGQsIG9wdGlvbnMsIHRoaXMuY29udGV4dCk7CiAgICAgIH0KICAgIH0sCgogICAgcHJvZ3JhbUV4cHJlc3Npb246IGZ1bmN0aW9uKGd1aWQpIHsKICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKCiAgICAgIGlmKGd1aWQgPT0gbnVsbCkgewogICAgICAgIHJldHVybiAic2VsZi5ub29wIjsKICAgICAgfQoKICAgICAgdmFyIGNoaWxkID0gdGhpcy5lbnZpcm9ubWVudC5jaGlsZHJlbltndWlkXSwKICAgICAgICAgIGRlcHRocyA9IGNoaWxkLmRlcHRocy5saXN0LCBkZXB0aDsKCiAgICAgIHZhciBwcm9ncmFtUGFyYW1zID0gW2NoaWxkLmluZGV4LCBjaGlsZC5uYW1lLCAiZGF0YSJdOwoKICAgICAgZm9yKHZhciBpPTAsIGwgPSBkZXB0aHMubGVuZ3RoOyBpPGw7IGkrKykgewogICAgICAgIGRlcHRoID0gZGVwdGhzW2ldOwoKICAgICAgICBpZihkZXB0aCA9PT0gMSkgeyBwcm9ncmFtUGFyYW1zLnB1c2goImRlcHRoMCIpOyB9CiAgICAgICAgZWxzZSB7IHByb2dyYW1QYXJhbXMucHVzaCgiZGVwdGgiICsgKGRlcHRoIC0gMSkpOyB9CiAgICAgIH0KCiAgICAgIGlmKGRlcHRocy5sZW5ndGggPT09IDApIHsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbSgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9IGVsc2UgewogICAgICAgIHByb2dyYW1QYXJhbXMuc2hpZnQoKTsKICAgICAgICByZXR1cm4gInNlbGYucHJvZ3JhbVdpdGhEZXB0aCgiICsgcHJvZ3JhbVBhcmFtcy5qb2luKCIsICIpICsgIikiOwogICAgICB9CiAgICB9LAoKICAgIHJlZ2lzdGVyOiBmdW5jdGlvbihuYW1lLCB2YWwpIHsKICAgICAgdGhpcy51c2VSZWdpc3RlcihuYW1lKTsKICAgICAgdGhpcy5zb3VyY2UucHVzaChuYW1lICsgIiA9ICIgKyB2YWwgKyAiOyIpOwogICAgfSwKCiAgICB1c2VSZWdpc3RlcjogZnVuY3Rpb24obmFtZSkgewogICAgICBpZighdGhpcy5yZWdpc3RlcnNbbmFtZV0pIHsKICAgICAgICB0aGlzLnJlZ2lzdGVyc1tuYW1lXSA9IHRydWU7CiAgICAgICAgdGhpcy5yZWdpc3RlcnMubGlzdC5wdXNoKG5hbWUpOwogICAgICB9CiAgICB9LAoKICAgIHB1c2hTdGFja0xpdGVyYWw6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaChuZXcgTGl0ZXJhbChpdGVtKSk7CiAgICAgIHJldHVybiBpdGVtOwogICAgfSwKCiAgICBwdXNoU3RhY2s6IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLmluY3JTdGFjaygpICsgIiA9ICIgKyBpdGVtICsgIjsiKTsKICAgICAgdGhpcy5jb21waWxlU3RhY2sucHVzaCgic3RhY2siICsgdGhpcy5zdGFja1Nsb3QpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICByZXBsYWNlU3RhY2s6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7CiAgICAgIHZhciBpdGVtID0gY2FsbGJhY2suY2FsbCh0aGlzLCB0aGlzLnRvcFN0YWNrKCkpOwoKICAgICAgdGhpcy5zb3VyY2UucHVzaCh0aGlzLnRvcFN0YWNrKCkgKyAiID0gIiArIGl0ZW0gKyAiOyIpOwogICAgICByZXR1cm4gInN0YWNrIiArIHRoaXMuc3RhY2tTbG90OwogICAgfSwKCiAgICBuZXh0U3RhY2s6IGZ1bmN0aW9uKHNraXBDb21waWxlU3RhY2spIHsKICAgICAgdmFyIG5hbWUgPSB0aGlzLmluY3JTdGFjaygpOwogICAgICB0aGlzLmNvbXBpbGVTdGFjay5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7CiAgICAgIHJldHVybiBuYW1lOwogICAgfSwKCiAgICBpbmNyU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnN0YWNrU2xvdCsrOwogICAgICBpZih0aGlzLnN0YWNrU2xvdCA+IHRoaXMuc3RhY2tWYXJzLmxlbmd0aCkgeyB0aGlzLnN0YWNrVmFycy5wdXNoKCJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdCk7IH0KICAgICAgcmV0dXJuICJzdGFjayIgKyB0aGlzLnN0YWNrU2xvdDsKICAgIH0sCgogICAgcG9wU3RhY2s6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgaXRlbSA9IHRoaXMuY29tcGlsZVN0YWNrLnBvcCgpOwoKICAgICAgaWYgKGl0ZW0gaW5zdGFuY2VvZiBMaXRlcmFsKSB7CiAgICAgICAgcmV0dXJuIGl0ZW0udmFsdWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zdGFja1Nsb3QtLTsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICB0b3BTdGFjazogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtID0gdGhpcy5jb21waWxlU3RhY2tbdGhpcy5jb21waWxlU3RhY2subGVuZ3RoIC0gMV07CgogICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIExpdGVyYWwpIHsKICAgICAgICByZXR1cm4gaXRlbS52YWx1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gaXRlbTsKICAgICAgfQogICAgfSwKCiAgICBxdW90ZWRTdHJpbmc6IGZ1bmN0aW9uKHN0cikgewogICAgICByZXR1cm4gJyInICsgc3RyCiAgICAgICAgLnJlcGxhY2UoL1xcL2csICdcXFxcJykKICAgICAgICAucmVwbGFjZSgvIi9nLCAnXFwiJykKICAgICAgICAucmVwbGFjZSgvXG4vZywgJ1xcbicpCiAgICAgICAgLnJlcGxhY2UoL1xyL2csICdcXHInKSArICciJzsKICAgIH0sCgogICAgc2V0dXBIZWxwZXI6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgbmFtZSkgewogICAgICB2YXIgcGFyYW1zID0gW107CiAgICAgIHRoaXMuc2V0dXBQYXJhbXMocGFyYW1TaXplLCBwYXJhbXMpOwogICAgICB2YXIgZm91bmRIZWxwZXIgPSB0aGlzLm5hbWVMb29rdXAoJ2hlbHBlcnMnLCBuYW1lLCAnaGVscGVyJyk7CgogICAgICByZXR1cm4gewogICAgICAgIHBhcmFtczogcGFyYW1zLAogICAgICAgIG5hbWU6IGZvdW5kSGVscGVyLAogICAgICAgIGNhbGxQYXJhbXM6IFsiZGVwdGgwIl0uY29uY2F0KHBhcmFtcykuam9pbigiLCAiKSwKICAgICAgICBoZWxwZXJNaXNzaW5nUGFyYW1zOiBbImRlcHRoMCIsIHRoaXMucXVvdGVkU3RyaW5nKG5hbWUpXS5jb25jYXQocGFyYW1zKS5qb2luKCIsICIpCiAgICAgIH07CiAgICB9LAoKICAgIC8vIHRoZSBwYXJhbXMgYW5kIGNvbnRleHRzIGFyZ3VtZW50cyBhcmUgcGFzc2VkIGluIGFycmF5cwogICAgLy8gdG8gZmlsbCBpbgogICAgc2V0dXBQYXJhbXM6IGZ1bmN0aW9uKHBhcmFtU2l6ZSwgcGFyYW1zKSB7CiAgICAgIHZhciBvcHRpb25zID0gW10sIGNvbnRleHRzID0gW10sIHBhcmFtLCBpbnZlcnNlLCBwcm9ncmFtOwoKICAgICAgb3B0aW9ucy5wdXNoKCJoYXNoOiIgKyB0aGlzLnBvcFN0YWNrKCkpOwoKICAgICAgaW52ZXJzZSA9IHRoaXMucG9wU3RhY2soKTsKICAgICAgcHJvZ3JhbSA9IHRoaXMucG9wU3RhY2soKTsKCiAgICAgIC8vIEF2b2lkIHNldHRpbmcgZm4gYW5kIGludmVyc2UgaWYgbmVpdGhlciBhcmUgc2V0LiBUaGlzIGFsbG93cwogICAgICAvLyBoZWxwZXJzIHRvIGRvIGEgY2hlY2sgZm9yIGBpZiAob3B0aW9ucy5mbilgCiAgICAgIGlmIChwcm9ncmFtIHx8IGludmVyc2UpIHsKICAgICAgICBpZiAoIXByb2dyYW0pIHsKICAgICAgICAgIHRoaXMuY29udGV4dC5hbGlhc2VzLnNlbGYgPSAidGhpcyI7CiAgICAgICAgICBwcm9ncmFtID0gInNlbGYubm9vcCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWludmVyc2UpIHsKICAgICAgICAgdGhpcy5jb250ZXh0LmFsaWFzZXMuc2VsZiA9ICJ0aGlzIjsKICAgICAgICAgIGludmVyc2UgPSAic2VsZi5ub29wIjsKICAgICAgICB9CgogICAgICAgIG9wdGlvbnMucHVzaCgiaW52ZXJzZToiICsgaW52ZXJzZSk7CiAgICAgICAgb3B0aW9ucy5wdXNoKCJmbjoiICsgcHJvZ3JhbSk7CiAgICAgIH0KCiAgICAgIGZvcih2YXIgaT0wOyBpPHBhcmFtU2l6ZTsgaSsrKSB7CiAgICAgICAgcGFyYW0gPSB0aGlzLnBvcFN0YWNrKCk7CiAgICAgICAgcGFyYW1zLnB1c2gocGFyYW0pOwoKICAgICAgICBpZih0aGlzLm9wdGlvbnMuc3RyaW5nUGFyYW1zKSB7CiAgICAgICAgICBjb250ZXh0cy5wdXNoKHRoaXMucG9wU3RhY2soKSk7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAodGhpcy5vcHRpb25zLnN0cmluZ1BhcmFtcykgewogICAgICAgIG9wdGlvbnMucHVzaCgiY29udGV4dHM6WyIgKyBjb250ZXh0cy5qb2luKCIsIikgKyAiXSIpOwogICAgICB9CgogICAgICBpZih0aGlzLm9wdGlvbnMuZGF0YSkgewogICAgICAgIG9wdGlvbnMucHVzaCgiZGF0YTpkYXRhIik7CiAgICAgIH0KCiAgICAgIHBhcmFtcy5wdXNoKCJ7IiArIG9wdGlvbnMuam9pbigiLCIpICsgIn0iKTsKICAgICAgcmV0dXJuIHBhcmFtcy5qb2luKCIsICIpOwogICAgfQogIH07CgogIHZhciByZXNlcnZlZFdvcmRzID0gKAogICAgImJyZWFrIGVsc2UgbmV3IHZhciIgKwogICAgIiBjYXNlIGZpbmFsbHkgcmV0dXJuIHZvaWQiICsKICAgICIgY2F0Y2ggZm9yIHN3aXRjaCB3aGlsZSIgKwogICAgIiBjb250aW51ZSBmdW5jdGlvbiB0aGlzIHdpdGgiICsKICAgICIgZGVmYXVsdCBpZiB0aHJvdyIgKwogICAgIiBkZWxldGUgaW4gdHJ5IiArCiAgICAiIGRvIGluc3RhbmNlb2YgdHlwZW9mIiArCiAgICAiIGFic3RyYWN0IGVudW0gaW50IHNob3J0IiArCiAgICAiIGJvb2xlYW4gZXhwb3J0IGludGVyZmFjZSBzdGF0aWMiICsKICAgICIgYnl0ZSBleHRlbmRzIGxvbmcgc3VwZXIiICsKICAgICIgY2hhciBmaW5hbCBuYXRpdmUgc3luY2hyb25pemVkIiArCiAgICAiIGNsYXNzIGZsb2F0IHBhY2thZ2UgdGhyb3dzIiArCiAgICAiIGNvbnN0IGdvdG8gcHJpdmF0ZSB0cmFuc2llbnQiICsKICAgICIgZGVidWdnZXIgaW1wbGVtZW50cyBwcm90ZWN0ZWQgdm9sYXRpbGUiICsKICAgICIgZG91YmxlIGltcG9ydCBwdWJsaWMgbGV0IHlpZWxkIgogICkuc3BsaXQoIiAiKTsKCiAgdmFyIGNvbXBpbGVyV29yZHMgPSBKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFMgPSB7fTsKCiAgZm9yKHZhciBpPTAsIGw9cmVzZXJ2ZWRXb3Jkcy5sZW5ndGg7IGk8bDsgaSsrKSB7CiAgICBjb21waWxlcldvcmRzW3Jlc2VydmVkV29yZHNbaV1dID0gdHJ1ZTsKICB9CgogIEphdmFTY3JpcHRDb21waWxlci5pc1ZhbGlkSmF2YVNjcmlwdFZhcmlhYmxlTmFtZSA9IGZ1bmN0aW9uKG5hbWUpIHsKICAgIGlmKCFKYXZhU2NyaXB0Q29tcGlsZXIuUkVTRVJWRURfV09SRFNbbmFtZV0gJiYgL15bYS16QS1aXyRdWzAtOWEtekEtWl8kXSskLy50ZXN0KG5hbWUpKSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgcmV0dXJuIGZhbHNlOwogIH07Cgp9KShIYW5kbGViYXJzLkNvbXBpbGVyLCBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcik7CgpIYW5kbGViYXJzLnByZWNvbXBpbGUgPSBmdW5jdGlvbihzdHJpbmcsIG9wdGlvbnMpIHsKICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICBpZiAoISgnZGF0YScgaW4gb3B0aW9ucykpIHsKICAgIG9wdGlvbnMuZGF0YSA9IHRydWU7CiAgfQogIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgdmFyIGVudmlyb25tZW50ID0gbmV3IEhhbmRsZWJhcnMuQ29tcGlsZXIoKS5jb21waWxlKGFzdCwgb3B0aW9ucyk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLkphdmFTY3JpcHRDb21waWxlcigpLmNvbXBpbGUoZW52aXJvbm1lbnQsIG9wdGlvbnMpOwp9OwoKSGFuZGxlYmFycy5jb21waWxlID0gZnVuY3Rpb24oc3RyaW5nLCBvcHRpb25zKSB7CiAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CiAgaWYgKCEoJ2RhdGEnIGluIG9wdGlvbnMpKSB7CiAgICBvcHRpb25zLmRhdGEgPSB0cnVlOwogIH0KICB2YXIgY29tcGlsZWQ7CiAgZnVuY3Rpb24gY29tcGlsZSgpIHsKICAgIHZhciBhc3QgPSBIYW5kbGViYXJzLnBhcnNlKHN0cmluZyk7CiAgICB2YXIgZW52aXJvbm1lbnQgPSBuZXcgSGFuZGxlYmFycy5Db21waWxlcigpLmNvbXBpbGUoYXN0LCBvcHRpb25zKTsKICAgIHZhciB0ZW1wbGF0ZVNwZWMgPSBuZXcgSGFuZGxlYmFycy5KYXZhU2NyaXB0Q29tcGlsZXIoKS5jb21waWxlKGVudmlyb25tZW50LCBvcHRpb25zLCB1bmRlZmluZWQsIHRydWUpOwogICAgcmV0dXJuIEhhbmRsZWJhcnMudGVtcGxhdGUodGVtcGxhdGVTcGVjKTsKICB9CgogIC8vIFRlbXBsYXRlIGlzIG9ubHkgY29tcGlsZWQgb24gZmlyc3QgdXNlIGFuZCBjYWNoZWQgYWZ0ZXIgdGhhdCBwb2ludC4KICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgaWYgKCFjb21waWxlZCkgewogICAgICBjb21waWxlZCA9IGNvbXBpbGUoKTsKICAgIH0KICAgIHJldHVybiBjb21waWxlZC5jYWxsKHRoaXMsIGNvbnRleHQsIG9wdGlvbnMpOwogIH07Cn07CjsKLy8gbGliL2hhbmRsZWJhcnMvcnVudGltZS5qcwpIYW5kbGViYXJzLlZNID0gewogIHRlbXBsYXRlOiBmdW5jdGlvbih0ZW1wbGF0ZVNwZWMpIHsKICAgIC8vIEp1c3QgYWRkIHdhdGVyCiAgICB2YXIgY29udGFpbmVyID0gewogICAgICBlc2NhcGVFeHByZXNzaW9uOiBIYW5kbGViYXJzLlV0aWxzLmVzY2FwZUV4cHJlc3Npb24sCiAgICAgIGludm9rZVBhcnRpYWw6IEhhbmRsZWJhcnMuVk0uaW52b2tlUGFydGlhbCwKICAgICAgcHJvZ3JhbXM6IFtdLAogICAgICBwcm9ncmFtOiBmdW5jdGlvbihpLCBmbiwgZGF0YSkgewogICAgICAgIHZhciBwcm9ncmFtV3JhcHBlciA9IHRoaXMucHJvZ3JhbXNbaV07CiAgICAgICAgaWYoZGF0YSkgewogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIgPSBIYW5kbGViYXJzLlZNLnByb2dyYW0oZm4sIGRhdGEpOwogICAgICAgICAgcHJvZ3JhbVdyYXBwZXIucHJvZ3JhbSA9IGk7CiAgICAgICAgfSBlbHNlIGlmICghcHJvZ3JhbVdyYXBwZXIpIHsKICAgICAgICAgIHByb2dyYW1XcmFwcGVyID0gdGhpcy5wcm9ncmFtc1tpXSA9IEhhbmRsZWJhcnMuVk0ucHJvZ3JhbShmbik7CiAgICAgICAgICBwcm9ncmFtV3JhcHBlci5wcm9ncmFtID0gaTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByb2dyYW1XcmFwcGVyOwogICAgICB9LAogICAgICBwcm9ncmFtV2l0aERlcHRoOiBIYW5kbGViYXJzLlZNLnByb2dyYW1XaXRoRGVwdGgsCiAgICAgIG5vb3A6IEhhbmRsZWJhcnMuVk0ubm9vcAogICAgfTsKCiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgcmV0dXJuIHRlbXBsYXRlU3BlYy5jYWxsKGNvbnRhaW5lciwgSGFuZGxlYmFycywgY29udGV4dCwgb3B0aW9ucy5oZWxwZXJzLCBvcHRpb25zLnBhcnRpYWxzLCBvcHRpb25zLmRhdGEpOwogICAgfTsKICB9LAoKICBwcm9ncmFtV2l0aERlcHRoOiBmdW5jdGlvbihmbiwgZGF0YSwgJGRlcHRoKSB7CiAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CgogICAgcmV0dXJuIGZ1bmN0aW9uKGNvbnRleHQsIG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgW2NvbnRleHQsIG9wdGlvbnMuZGF0YSB8fCBkYXRhXS5jb25jYXQoYXJncykpOwogICAgfTsKICB9LAogIHByb2dyYW06IGZ1bmN0aW9uKGZuLCBkYXRhKSB7CiAgICByZXR1cm4gZnVuY3Rpb24oY29udGV4dCwgb3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCiAgICAgIHJldHVybiBmbihjb250ZXh0LCBvcHRpb25zLmRhdGEgfHwgZGF0YSk7CiAgICB9OwogIH0sCiAgbm9vcDogZnVuY3Rpb24oKSB7IHJldHVybiAiIjsgfSwKICBpbnZva2VQYXJ0aWFsOiBmdW5jdGlvbihwYXJ0aWFsLCBuYW1lLCBjb250ZXh0LCBoZWxwZXJzLCBwYXJ0aWFscywgZGF0YSkgewogICAgdmFyIG9wdGlvbnMgPSB7IGhlbHBlcnM6IGhlbHBlcnMsIHBhcnRpYWxzOiBwYXJ0aWFscywgZGF0YTogZGF0YSB9OwoKICAgIGlmKHBhcnRpYWwgPT09IHVuZGVmaW5lZCkgewogICAgICB0aHJvdyBuZXcgSGFuZGxlYmFycy5FeGNlcHRpb24oIlRoZSBwYXJ0aWFsICIgKyBuYW1lICsgIiBjb3VsZCBub3QgYmUgZm91bmQiKTsKICAgIH0gZWxzZSBpZihwYXJ0aWFsIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgcmV0dXJuIHBhcnRpYWwoY29udGV4dCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKCFIYW5kbGViYXJzLmNvbXBpbGUpIHsKICAgICAgdGhyb3cgbmV3IEhhbmRsZWJhcnMuRXhjZXB0aW9uKCJUaGUgcGFydGlhbCAiICsgbmFtZSArICIgY291bGQgbm90IGJlIGNvbXBpbGVkIHdoZW4gcnVubmluZyBpbiBydW50aW1lLW9ubHkgbW9kZSIpOwogICAgfSBlbHNlIHsKICAgICAgcGFydGlhbHNbbmFtZV0gPSBIYW5kbGViYXJzLmNvbXBpbGUocGFydGlhbCwge2RhdGE6IGRhdGEgIT09IHVuZGVmaW5lZH0pOwogICAgICByZXR1cm4gcGFydGlhbHNbbmFtZV0oY29udGV4dCwgb3B0aW9ucyk7CiAgICB9CiAgfQp9OwoKSGFuZGxlYmFycy50ZW1wbGF0ZSA9IEhhbmRsZWJhcnMuVk0udGVtcGxhdGU7CjsKCi8vICAgICBVbmRlcnNjb3JlLmpzIDEuNC4yCi8vICAgICBodHRwOi8vdW5kZXJzY29yZWpzLm9yZwovLyAgICAgKGMpIDIwMDktMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgVW5kZXJzY29yZSBtYXkgYmUgZnJlZWx5IGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KCihmdW5jdGlvbigpIHsKCiAgLy8gQmFzZWxpbmUgc2V0dXAKICAvLyAtLS0tLS0tLS0tLS0tLQoKICAvLyBFc3RhYmxpc2ggdGhlIHJvb3Qgb2JqZWN0LCBgd2luZG93YCBpbiB0aGUgYnJvd3Nlciwgb3IgYGdsb2JhbGAgb24gdGhlIHNlcnZlci4KICB2YXIgcm9vdCA9IHRoaXM7CgogIC8vIFNhdmUgdGhlIHByZXZpb3VzIHZhbHVlIG9mIHRoZSBgX2AgdmFyaWFibGUuCiAgdmFyIHByZXZpb3VzVW5kZXJzY29yZSA9IHJvb3QuXzsKCiAgLy8gRXN0YWJsaXNoIHRoZSBvYmplY3QgdGhhdCBnZXRzIHJldHVybmVkIHRvIGJyZWFrIG91dCBvZiBhIGxvb3AgaXRlcmF0aW9uLgogIHZhciBicmVha2VyID0ge307CgogIC8vIFNhdmUgYnl0ZXMgaW4gdGhlIG1pbmlmaWVkIChidXQgbm90IGd6aXBwZWQpIHZlcnNpb246CiAgdmFyIEFycmF5UHJvdG8gPSBBcnJheS5wcm90b3R5cGUsIE9ialByb3RvID0gT2JqZWN0LnByb3RvdHlwZSwgRnVuY1Byb3RvID0gRnVuY3Rpb24ucHJvdG90eXBlOwoKICAvLyBDcmVhdGUgcXVpY2sgcmVmZXJlbmNlIHZhcmlhYmxlcyBmb3Igc3BlZWQgYWNjZXNzIHRvIGNvcmUgcHJvdG90eXBlcy4KICB2YXIgcHVzaCAgICAgICAgICAgICA9IEFycmF5UHJvdG8ucHVzaCwKICAgICAgc2xpY2UgICAgICAgICAgICA9IEFycmF5UHJvdG8uc2xpY2UsCiAgICAgIGNvbmNhdCAgICAgICAgICAgPSBBcnJheVByb3RvLmNvbmNhdCwKICAgICAgdW5zaGlmdCAgICAgICAgICA9IEFycmF5UHJvdG8udW5zaGlmdCwKICAgICAgdG9TdHJpbmcgICAgICAgICA9IE9ialByb3RvLnRvU3RyaW5nLAogICAgICBoYXNPd25Qcm9wZXJ0eSAgID0gT2JqUHJvdG8uaGFzT3duUHJvcGVydHk7CgogIC8vIEFsbCAqKkVDTUFTY3JpcHQgNSoqIG5hdGl2ZSBmdW5jdGlvbiBpbXBsZW1lbnRhdGlvbnMgdGhhdCB3ZSBob3BlIHRvIHVzZQogIC8vIGFyZSBkZWNsYXJlZCBoZXJlLgogIHZhcgogICAgbmF0aXZlRm9yRWFjaCAgICAgID0gQXJyYXlQcm90by5mb3JFYWNoLAogICAgbmF0aXZlTWFwICAgICAgICAgID0gQXJyYXlQcm90by5tYXAsCiAgICBuYXRpdmVSZWR1Y2UgICAgICAgPSBBcnJheVByb3RvLnJlZHVjZSwKICAgIG5hdGl2ZVJlZHVjZVJpZ2h0ICA9IEFycmF5UHJvdG8ucmVkdWNlUmlnaHQsCiAgICBuYXRpdmVGaWx0ZXIgICAgICAgPSBBcnJheVByb3RvLmZpbHRlciwKICAgIG5hdGl2ZUV2ZXJ5ICAgICAgICA9IEFycmF5UHJvdG8uZXZlcnksCiAgICBuYXRpdmVTb21lICAgICAgICAgPSBBcnJheVByb3RvLnNvbWUsCiAgICBuYXRpdmVJbmRleE9mICAgICAgPSBBcnJheVByb3RvLmluZGV4T2YsCiAgICBuYXRpdmVMYXN0SW5kZXhPZiAgPSBBcnJheVByb3RvLmxhc3RJbmRleE9mLAogICAgbmF0aXZlSXNBcnJheSAgICAgID0gQXJyYXkuaXNBcnJheSwKICAgIG5hdGl2ZUtleXMgICAgICAgICA9IE9iamVjdC5rZXlzLAogICAgbmF0aXZlQmluZCAgICAgICAgID0gRnVuY1Byb3RvLmJpbmQ7CgogIC8vIENyZWF0ZSBhIHNhZmUgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdCBmb3IgdXNlIGJlbG93LgogIHZhciBfID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAob2JqIGluc3RhbmNlb2YgXykgcmV0dXJuIG9iajsKICAgIGlmICghKHRoaXMgaW5zdGFuY2VvZiBfKSkgcmV0dXJuIG5ldyBfKG9iaik7CiAgICB0aGlzLl93cmFwcGVkID0gb2JqOwogIH07CgogIC8vIEV4cG9ydCB0aGUgVW5kZXJzY29yZSBvYmplY3QgZm9yICoqTm9kZS5qcyoqLCB3aXRoCiAgLy8gYmFja3dhcmRzLWNvbXBhdGliaWxpdHkgZm9yIHRoZSBvbGQgYHJlcXVpcmUoKWAgQVBJLiBJZiB3ZSdyZSBpbgogIC8vIHRoZSBicm93c2VyLCBhZGQgYF9gIGFzIGEgZ2xvYmFsIG9iamVjdCB2aWEgYSBzdHJpbmcgaWRlbnRpZmllciwKICAvLyBmb3IgQ2xvc3VyZSBDb21waWxlciAiYWR2YW5jZWQiIG1vZGUuCiAgaWYgKHR5cGVvZiBleHBvcnRzICE9PSAndW5kZWZpbmVkJykgewogICAgaWYgKHR5cGVvZiBtb2R1bGUgIT09ICd1bmRlZmluZWQnICYmIG1vZHVsZS5leHBvcnRzKSB7CiAgICAgIGV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF87CiAgICB9CiAgICBleHBvcnRzLl8gPSBfOwogIH0gZWxzZSB7CiAgICByb290WydfJ10gPSBfOwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uLgogIF8uVkVSU0lPTiA9ICcxLjQuMic7CgogIC8vIENvbGxlY3Rpb24gRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gVGhlIGNvcm5lcnN0b25lLCBhbiBgZWFjaGAgaW1wbGVtZW50YXRpb24sIGFrYSBgZm9yRWFjaGAuCiAgLy8gSGFuZGxlcyBvYmplY3RzIHdpdGggdGhlIGJ1aWx0LWluIGBmb3JFYWNoYCwgYXJyYXlzLCBhbmQgcmF3IG9iamVjdHMuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZvckVhY2hgIGlmIGF2YWlsYWJsZS4KICB2YXIgZWFjaCA9IF8uZWFjaCA9IF8uZm9yRWFjaCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuOwogICAgaWYgKG5hdGl2ZUZvckVhY2ggJiYgb2JqLmZvckVhY2ggPT09IG5hdGl2ZUZvckVhY2gpIHsKICAgICAgb2JqLmZvckVhY2goaXRlcmF0b3IsIGNvbnRleHQpOwogICAgfSBlbHNlIGlmIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgewogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IG9iai5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBpZiAoaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmpbaV0sIGksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICAgIGlmIChfLmhhcyhvYmosIGtleSkpIHsKICAgICAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIG9ialtrZXldLCBrZXksIG9iaikgPT09IGJyZWFrZXIpIHJldHVybjsKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9OwoKICAvLyBSZXR1cm4gdGhlIHJlc3VsdHMgb2YgYXBwbHlpbmcgdGhlIGl0ZXJhdG9yIHRvIGVhY2ggZWxlbWVudC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgbWFwYCBpZiBhdmFpbGFibGUuCiAgXy5tYXAgPSBfLmNvbGxlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0czsKICAgIGlmIChuYXRpdmVNYXAgJiYgb2JqLm1hcCA9PT0gbmF0aXZlTWFwKSByZXR1cm4gb2JqLm1hcChpdGVyYXRvciwgY29udGV4dCk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJlc3VsdHNbcmVzdWx0cy5sZW5ndGhdID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0czsKICB9OwoKICAvLyAqKlJlZHVjZSoqIGJ1aWxkcyB1cCBhIHNpbmdsZSByZXN1bHQgZnJvbSBhIGxpc3Qgb2YgdmFsdWVzLCBha2EgYGluamVjdGAsCiAgLy8gb3IgYGZvbGRsYC4gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZWAgaWYgYXZhaWxhYmxlLgogIF8ucmVkdWNlID0gXy5mb2xkbCA9IF8uaW5qZWN0ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgbWVtbywgY29udGV4dCkgewogICAgdmFyIGluaXRpYWwgPSBhcmd1bWVudHMubGVuZ3RoID4gMjsKICAgIGlmIChvYmogPT0gbnVsbCkgb2JqID0gW107CiAgICBpZiAobmF0aXZlUmVkdWNlICYmIG9iai5yZWR1Y2UgPT09IG5hdGl2ZVJlZHVjZSkgewogICAgICBpZiAoY29udGV4dCkgaXRlcmF0b3IgPSBfLmJpbmQoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgICByZXR1cm4gaW5pdGlhbCA/IG9iai5yZWR1Y2UoaXRlcmF0b3IsIG1lbW8pIDogb2JqLnJlZHVjZShpdGVyYXRvcik7CiAgICB9CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmICghaW5pdGlhbCkgewogICAgICAgIG1lbW8gPSB2YWx1ZTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCB2YWx1ZSwgaW5kZXgsIGxpc3QpOwogICAgICB9CiAgICB9KTsKICAgIGlmICghaW5pdGlhbCkgdGhyb3cgbmV3IFR5cGVFcnJvcignUmVkdWNlIG9mIGVtcHR5IGFycmF5IHdpdGggbm8gaW5pdGlhbCB2YWx1ZScpOwogICAgcmV0dXJuIG1lbW87CiAgfTsKCiAgLy8gVGhlIHJpZ2h0LWFzc29jaWF0aXZlIHZlcnNpb24gb2YgcmVkdWNlLCBhbHNvIGtub3duIGFzIGBmb2xkcmAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYHJlZHVjZVJpZ2h0YCBpZiBhdmFpbGFibGUuCiAgXy5yZWR1Y2VSaWdodCA9IF8uZm9sZHIgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBtZW1vLCBjb250ZXh0KSB7CiAgICB2YXIgaW5pdGlhbCA9IGFyZ3VtZW50cy5sZW5ndGggPiAyOwogICAgaWYgKG9iaiA9PSBudWxsKSBvYmogPSBbXTsKICAgIGlmIChuYXRpdmVSZWR1Y2VSaWdodCAmJiBvYmoucmVkdWNlUmlnaHQgPT09IG5hdGl2ZVJlZHVjZVJpZ2h0KSB7CiAgICAgIGlmIChjb250ZXh0KSBpdGVyYXRvciA9IF8uYmluZChpdGVyYXRvciwgY29udGV4dCk7CiAgICAgIHJldHVybiBhcmd1bWVudHMubGVuZ3RoID4gMiA/IG9iai5yZWR1Y2VSaWdodChpdGVyYXRvciwgbWVtbykgOiBvYmoucmVkdWNlUmlnaHQoaXRlcmF0b3IpOwogICAgfQogICAgdmFyIGxlbmd0aCA9IG9iai5sZW5ndGg7CiAgICBpZiAobGVuZ3RoICE9PSArbGVuZ3RoKSB7CiAgICAgIHZhciBrZXlzID0gXy5rZXlzKG9iaik7CiAgICAgIGxlbmd0aCA9IGtleXMubGVuZ3RoOwogICAgfQogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpbmRleCA9IGtleXMgPyBrZXlzWy0tbGVuZ3RoXSA6IC0tbGVuZ3RoOwogICAgICBpZiAoIWluaXRpYWwpIHsKICAgICAgICBtZW1vID0gb2JqW2luZGV4XTsKICAgICAgICBpbml0aWFsID0gdHJ1ZTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtZW1vID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBtZW1vLCBvYmpbaW5kZXhdLCBpbmRleCwgbGlzdCk7CiAgICAgIH0KICAgIH0pOwogICAgaWYgKCFpbml0aWFsKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdSZWR1Y2Ugb2YgZW1wdHkgYXJyYXkgd2l0aCBubyBpbml0aWFsIHZhbHVlJyk7CiAgICByZXR1cm4gbWVtbzsKICB9OwoKICAvLyBSZXR1cm4gdGhlIGZpcnN0IHZhbHVlIHdoaWNoIHBhc3NlcyBhIHRydXRoIHRlc3QuIEFsaWFzZWQgYXMgYGRldGVjdGAuCiAgXy5maW5kID0gXy5kZXRlY3QgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICB2YXIgcmVzdWx0OwogICAgYW55KG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIGlmIChpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkpIHsKICAgICAgICByZXN1bHQgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFJldHVybiBhbGwgdGhlIGVsZW1lbnRzIHRoYXQgcGFzcyBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGZpbHRlcmAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYHNlbGVjdGAuCiAgXy5maWx0ZXIgPSBfLnNlbGVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgaWYgKG5hdGl2ZUZpbHRlciAmJiBvYmouZmlsdGVyID09PSBuYXRpdmVGaWx0ZXIpIHJldHVybiBvYmouZmlsdGVyKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gUmV0dXJuIGFsbCB0aGUgZWxlbWVudHMgZm9yIHdoaWNoIGEgdHJ1dGggdGVzdCBmYWlscy4KICBfLnJlamVjdCA9IGZ1bmN0aW9uKG9iaiwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciByZXN1bHRzID0gW107CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHRzOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIWl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSkgcmVzdWx0c1tyZXN1bHRzLmxlbmd0aF0gPSB2YWx1ZTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdHM7CiAgfTsKCiAgLy8gRGV0ZXJtaW5lIHdoZXRoZXIgYWxsIG9mIHRoZSBlbGVtZW50cyBtYXRjaCBhIHRydXRoIHRlc3QuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGV2ZXJ5YCBpZiBhdmFpbGFibGUuCiAgLy8gQWxpYXNlZCBhcyBgYWxsYC4KICBfLmV2ZXJ5ID0gXy5hbGwgPSBmdW5jdGlvbihvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciB8fCAoaXRlcmF0b3IgPSBfLmlkZW50aXR5KTsKICAgIHZhciByZXN1bHQgPSB0cnVlOwogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gcmVzdWx0OwogICAgaWYgKG5hdGl2ZUV2ZXJ5ICYmIG9iai5ldmVyeSA9PT0gbmF0aXZlRXZlcnkpIHJldHVybiBvYmouZXZlcnkoaXRlcmF0b3IsIGNvbnRleHQpOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICBpZiAoIShyZXN1bHQgPSByZXN1bHQgJiYgaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgYXQgbGVhc3Qgb25lIGVsZW1lbnQgaW4gdGhlIG9iamVjdCBtYXRjaGVzIGEgdHJ1dGggdGVzdC4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgc29tZWAgaWYgYXZhaWxhYmxlLgogIC8vIEFsaWFzZWQgYXMgYGFueWAuCiAgdmFyIGFueSA9IF8uc29tZSA9IF8uYW55ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaXRlcmF0b3IgfHwgKGl0ZXJhdG9yID0gXy5pZGVudGl0eSk7CiAgICB2YXIgcmVzdWx0ID0gZmFsc2U7CiAgICBpZiAob2JqID09IG51bGwpIHJldHVybiByZXN1bHQ7CiAgICBpZiAobmF0aXZlU29tZSAmJiBvYmouc29tZSA9PT0gbmF0aXZlU29tZSkgcmV0dXJuIG9iai5zb21lKGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgaWYgKHJlc3VsdCB8fCAocmVzdWx0ID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpKSkgcmV0dXJuIGJyZWFrZXI7CiAgICB9KTsKICAgIHJldHVybiAhIXJlc3VsdDsKICB9OwoKICAvLyBEZXRlcm1pbmUgaWYgdGhlIGFycmF5IG9yIG9iamVjdCBjb250YWlucyBhIGdpdmVuIHZhbHVlICh1c2luZyBgPT09YCkuCiAgLy8gQWxpYXNlZCBhcyBgaW5jbHVkZWAuCiAgXy5jb250YWlucyA9IF8uaW5jbHVkZSA9IGZ1bmN0aW9uKG9iaiwgdGFyZ2V0KSB7CiAgICB2YXIgZm91bmQgPSBmYWxzZTsKICAgIGlmIChvYmogPT0gbnVsbCkgcmV0dXJuIGZvdW5kOwogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgb2JqLmluZGV4T2YgPT09IG5hdGl2ZUluZGV4T2YpIHJldHVybiBvYmouaW5kZXhPZih0YXJnZXQpICE9IC0xOwogICAgZm91bmQgPSBhbnkob2JqLCBmdW5jdGlvbih2YWx1ZSkgewogICAgICByZXR1cm4gdmFsdWUgPT09IHRhcmdldDsKICAgIH0pOwogICAgcmV0dXJuIGZvdW5kOwogIH07CgogIC8vIEludm9rZSBhIG1ldGhvZCAod2l0aCBhcmd1bWVudHMpIG9uIGV2ZXJ5IGl0ZW0gaW4gYSBjb2xsZWN0aW9uLgogIF8uaW52b2tlID0gZnVuY3Rpb24ob2JqLCBtZXRob2QpIHsKICAgIHZhciBhcmdzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDIpOwogICAgcmV0dXJuIF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUpIHsKICAgICAgcmV0dXJuIChfLmlzRnVuY3Rpb24obWV0aG9kKSA/IG1ldGhvZCA6IHZhbHVlW21ldGhvZF0pLmFwcGx5KHZhbHVlLCBhcmdzKTsKICAgIH0pOwogIH07CgogIC8vIENvbnZlbmllbmNlIHZlcnNpb24gb2YgYSBjb21tb24gdXNlIGNhc2Ugb2YgYG1hcGA6IGZldGNoaW5nIGEgcHJvcGVydHkuCiAgXy5wbHVjayA9IGZ1bmN0aW9uKG9iaiwga2V5KSB7CiAgICByZXR1cm4gXy5tYXAob2JqLCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiB2YWx1ZVtrZXldOyB9KTsKICB9OwoKICAvLyBDb252ZW5pZW5jZSB2ZXJzaW9uIG9mIGEgY29tbW9uIHVzZSBjYXNlIG9mIGBmaWx0ZXJgOiBzZWxlY3Rpbmcgb25seSBvYmplY3RzCiAgLy8gd2l0aCBzcGVjaWZpYyBga2V5OnZhbHVlYCBwYWlycy4KICBfLndoZXJlID0gZnVuY3Rpb24ob2JqLCBhdHRycykgewogICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgIHJldHVybiBfLmZpbHRlcihvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBhdHRycykgewogICAgICAgIGlmIChhdHRyc1trZXldICE9PSB2YWx1ZVtrZXldKSByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9KTsKICB9OwoKICAvLyBSZXR1cm4gdGhlIG1heGltdW0gZWxlbWVudCBvciAoZWxlbWVudC1iYXNlZCBjb21wdXRhdGlvbikuCiAgLy8gQ2FuJ3Qgb3B0aW1pemUgYXJyYXlzIG9mIGludGVnZXJzIGxvbmdlciB0aGFuIDY1LDUzNSBlbGVtZW50cy4KICAvLyBTZWU6IGh0dHBzOi8vYnVncy53ZWJraXQub3JnL3Nob3dfYnVnLmNnaT9pZD04MDc5NwogIF8ubWF4ID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1heC5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIC1JbmZpbml0eTsKICAgIHZhciByZXN1bHQgPSB7Y29tcHV0ZWQgOiAtSW5maW5pdHl9OwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlLCBpbmRleCwgbGlzdCkgewogICAgICB2YXIgY29tcHV0ZWQgPSBpdGVyYXRvciA/IGl0ZXJhdG9yLmNhbGwoY29udGV4dCwgdmFsdWUsIGluZGV4LCBsaXN0KSA6IHZhbHVlOwogICAgICBjb21wdXRlZCA+PSByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBtaW5pbXVtIGVsZW1lbnQgKG9yIGVsZW1lbnQtYmFzZWQgY29tcHV0YXRpb24pLgogIF8ubWluID0gZnVuY3Rpb24ob2JqLCBpdGVyYXRvciwgY29udGV4dCkgewogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzQXJyYXkob2JqKSAmJiBvYmpbMF0gPT09ICtvYmpbMF0gJiYgb2JqLmxlbmd0aCA8IDY1NTM1KSB7CiAgICAgIHJldHVybiBNYXRoLm1pbi5hcHBseShNYXRoLCBvYmopOwogICAgfQogICAgaWYgKCFpdGVyYXRvciAmJiBfLmlzRW1wdHkob2JqKSkgcmV0dXJuIEluZmluaXR5OwogICAgdmFyIHJlc3VsdCA9IHtjb21wdXRlZCA6IEluZmluaXR5fTsKICAgIGVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwgaW5kZXgsIGxpc3QpIHsKICAgICAgdmFyIGNvbXB1dGVkID0gaXRlcmF0b3IgPyBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgbGlzdCkgOiB2YWx1ZTsKICAgICAgY29tcHV0ZWQgPCByZXN1bHQuY29tcHV0ZWQgJiYgKHJlc3VsdCA9IHt2YWx1ZSA6IHZhbHVlLCBjb21wdXRlZCA6IGNvbXB1dGVkfSk7CiAgICB9KTsKICAgIHJldHVybiByZXN1bHQudmFsdWU7CiAgfTsKCiAgLy8gU2h1ZmZsZSBhbiBhcnJheS4KICBfLnNodWZmbGUgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciByYW5kOwogICAgdmFyIGluZGV4ID0gMDsKICAgIHZhciBzaHVmZmxlZCA9IFtdOwogICAgZWFjaChvYmosIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIHJhbmQgPSBfLnJhbmRvbShpbmRleCsrKTsKICAgICAgc2h1ZmZsZWRbaW5kZXggLSAxXSA9IHNodWZmbGVkW3JhbmRdOwogICAgICBzaHVmZmxlZFtyYW5kXSA9IHZhbHVlOwogICAgfSk7CiAgICByZXR1cm4gc2h1ZmZsZWQ7CiAgfTsKCiAgLy8gQW4gaW50ZXJuYWwgZnVuY3Rpb24gdG8gZ2VuZXJhdGUgbG9va3VwIGl0ZXJhdG9ycy4KICB2YXIgbG9va3VwSXRlcmF0b3IgPSBmdW5jdGlvbih2YWx1ZSkgewogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG9iail7IHJldHVybiBvYmpbdmFsdWVdOyB9OwogIH07CgogIC8vIFNvcnQgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbiBwcm9kdWNlZCBieSBhbiBpdGVyYXRvci4KICBfLnNvcnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHZhciBpdGVyYXRvciA9IGxvb2t1cEl0ZXJhdG9yKHZhbHVlKTsKICAgIHJldHVybiBfLnBsdWNrKF8ubWFwKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4LCBsaXN0KSB7CiAgICAgIHJldHVybiB7CiAgICAgICAgdmFsdWUgOiB2YWx1ZSwKICAgICAgICBpbmRleCA6IGluZGV4LAogICAgICAgIGNyaXRlcmlhIDogaXRlcmF0b3IuY2FsbChjb250ZXh0LCB2YWx1ZSwgaW5kZXgsIGxpc3QpCiAgICAgIH07CiAgICB9KS5zb3J0KGZ1bmN0aW9uKGxlZnQsIHJpZ2h0KSB7CiAgICAgIHZhciBhID0gbGVmdC5jcml0ZXJpYTsKICAgICAgdmFyIGIgPSByaWdodC5jcml0ZXJpYTsKICAgICAgaWYgKGEgIT09IGIpIHsKICAgICAgICBpZiAoYSA+IGIgfHwgYSA9PT0gdm9pZCAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYSA8IGIgfHwgYiA9PT0gdm9pZCAwKSByZXR1cm4gLTE7CiAgICAgIH0KICAgICAgcmV0dXJuIGxlZnQuaW5kZXggPCByaWdodC5pbmRleCA/IC0xIDogMTsKICAgIH0pLCAndmFsdWUnKTsKICB9OwoKICAvLyBBbiBpbnRlcm5hbCBmdW5jdGlvbiB1c2VkIGZvciBhZ2dyZWdhdGUgImdyb3VwIGJ5IiBvcGVyYXRpb25zLgogIHZhciBncm91cCA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQsIGJlaGF2aW9yKSB7CiAgICB2YXIgcmVzdWx0ID0ge307CiAgICB2YXIgaXRlcmF0b3IgPSBsb29rdXBJdGVyYXRvcih2YWx1ZSk7CiAgICBlYWNoKG9iaiwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIHZhciBrZXkgPSBpdGVyYXRvci5jYWxsKGNvbnRleHQsIHZhbHVlLCBpbmRleCwgb2JqKTsKICAgICAgYmVoYXZpb3IocmVzdWx0LCBrZXksIHZhbHVlKTsKICAgIH0pOwogICAgcmV0dXJuIHJlc3VsdDsKICB9OwoKICAvLyBHcm91cHMgdGhlIG9iamVjdCdzIHZhbHVlcyBieSBhIGNyaXRlcmlvbi4gUGFzcyBlaXRoZXIgYSBzdHJpbmcgYXR0cmlidXRlCiAgLy8gdG8gZ3JvdXAgYnksIG9yIGEgZnVuY3Rpb24gdGhhdCByZXR1cm5zIHRoZSBjcml0ZXJpb24uCiAgXy5ncm91cEJ5ID0gZnVuY3Rpb24ob2JqLCB2YWx1ZSwgY29udGV4dCkgewogICAgcmV0dXJuIGdyb3VwKG9iaiwgdmFsdWUsIGNvbnRleHQsIGZ1bmN0aW9uKHJlc3VsdCwga2V5LCB2YWx1ZSkgewogICAgICAoXy5oYXMocmVzdWx0LCBrZXkpID8gcmVzdWx0W2tleV0gOiAocmVzdWx0W2tleV0gPSBbXSkpLnB1c2godmFsdWUpOwogICAgfSk7CiAgfTsKCiAgLy8gQ291bnRzIGluc3RhbmNlcyBvZiBhbiBvYmplY3QgdGhhdCBncm91cCBieSBhIGNlcnRhaW4gY3JpdGVyaW9uLiBQYXNzCiAgLy8gZWl0aGVyIGEgc3RyaW5nIGF0dHJpYnV0ZSB0byBjb3VudCBieSwgb3IgYSBmdW5jdGlvbiB0aGF0IHJldHVybnMgdGhlCiAgLy8gY3JpdGVyaW9uLgogIF8uY291bnRCeSA9IGZ1bmN0aW9uKG9iaiwgdmFsdWUsIGNvbnRleHQpIHsKICAgIHJldHVybiBncm91cChvYmosIHZhbHVlLCBjb250ZXh0LCBmdW5jdGlvbihyZXN1bHQsIGtleSwgdmFsdWUpIHsKICAgICAgaWYgKCFfLmhhcyhyZXN1bHQsIGtleSkpIHJlc3VsdFtrZXldID0gMDsKICAgICAgcmVzdWx0W2tleV0rKzsKICAgIH0pOwogIH07CgogIC8vIFVzZSBhIGNvbXBhcmF0b3IgZnVuY3Rpb24gdG8gZmlndXJlIG91dCB0aGUgc21hbGxlc3QgaW5kZXggYXQgd2hpY2gKICAvLyBhbiBvYmplY3Qgc2hvdWxkIGJlIGluc2VydGVkIHNvIGFzIHRvIG1haW50YWluIG9yZGVyLiBVc2VzIGJpbmFyeSBzZWFyY2guCiAgXy5zb3J0ZWRJbmRleCA9IGZ1bmN0aW9uKGFycmF5LCBvYmosIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBpdGVyYXRvciA9IGl0ZXJhdG9yID09IG51bGwgPyBfLmlkZW50aXR5IDogbG9va3VwSXRlcmF0b3IoaXRlcmF0b3IpOwogICAgdmFyIHZhbHVlID0gaXRlcmF0b3IuY2FsbChjb250ZXh0LCBvYmopOwogICAgdmFyIGxvdyA9IDAsIGhpZ2ggPSBhcnJheS5sZW5ndGg7CiAgICB3aGlsZSAobG93IDwgaGlnaCkgewogICAgICB2YXIgbWlkID0gKGxvdyArIGhpZ2gpID4+PiAxOwogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQsIGFycmF5W21pZF0pIDwgdmFsdWUgPyBsb3cgPSBtaWQgKyAxIDogaGlnaCA9IG1pZDsKICAgIH0KICAgIHJldHVybiBsb3c7CiAgfTsKCiAgLy8gU2FmZWx5IGNvbnZlcnQgYW55dGhpbmcgaXRlcmFibGUgaW50byBhIHJlYWwsIGxpdmUgYXJyYXkuCiAgXy50b0FycmF5ID0gZnVuY3Rpb24ob2JqKSB7CiAgICBpZiAoIW9iaikgcmV0dXJuIFtdOwogICAgaWYgKG9iai5sZW5ndGggPT09ICtvYmoubGVuZ3RoKSByZXR1cm4gc2xpY2UuY2FsbChvYmopOwogICAgcmV0dXJuIF8udmFsdWVzKG9iaik7CiAgfTsKCiAgLy8gUmV0dXJuIHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gYW4gb2JqZWN0LgogIF8uc2l6ZSA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIChvYmoubGVuZ3RoID09PSArb2JqLmxlbmd0aCkgPyBvYmoubGVuZ3RoIDogXy5rZXlzKG9iaikubGVuZ3RoOwogIH07CgogIC8vIEFycmF5IEZ1bmN0aW9ucwogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBHZXQgdGhlIGZpcnN0IGVsZW1lbnQgb2YgYW4gYXJyYXkuIFBhc3NpbmcgKipuKiogd2lsbCByZXR1cm4gdGhlIGZpcnN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBBbGlhc2VkIGFzIGBoZWFkYCBhbmQgYHRha2VgLiBUaGUgKipndWFyZCoqIGNoZWNrCiAgLy8gYWxsb3dzIGl0IHRvIHdvcmsgd2l0aCBgXy5tYXBgLgogIF8uZmlyc3QgPSBfLmhlYWQgPSBfLnRha2UgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiAobiAhPSBudWxsKSAmJiAhZ3VhcmQgPyBzbGljZS5jYWxsKGFycmF5LCAwLCBuKSA6IGFycmF5WzBdOwogIH07CgogIC8vIFJldHVybnMgZXZlcnl0aGluZyBidXQgdGhlIGxhc3QgZW50cnkgb2YgdGhlIGFycmF5LiBFc3BlY2lhbGx5IHVzZWZ1bCBvbgogIC8vIHRoZSBhcmd1bWVudHMgb2JqZWN0LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIGFsbCB0aGUgdmFsdWVzIGluCiAgLy8gdGhlIGFycmF5LCBleGNsdWRpbmcgdGhlIGxhc3QgTi4gVGhlICoqZ3VhcmQqKiBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoCiAgLy8gYF8ubWFwYC4KICBfLmluaXRpYWwgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIHJldHVybiBzbGljZS5jYWxsKGFycmF5LCAwLCBhcnJheS5sZW5ndGggLSAoKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbikpOwogIH07CgogIC8vIEdldCB0aGUgbGFzdCBlbGVtZW50IG9mIGFuIGFycmF5LiBQYXNzaW5nICoqbioqIHdpbGwgcmV0dXJuIHRoZSBsYXN0IE4KICAvLyB2YWx1ZXMgaW4gdGhlIGFycmF5LiBUaGUgKipndWFyZCoqIGNoZWNrIGFsbG93cyBpdCB0byB3b3JrIHdpdGggYF8ubWFwYC4KICBfLmxhc3QgPSBmdW5jdGlvbihhcnJheSwgbiwgZ3VhcmQpIHsKICAgIGlmICgobiAhPSBudWxsKSAmJiAhZ3VhcmQpIHsKICAgICAgcmV0dXJuIHNsaWNlLmNhbGwoYXJyYXksIE1hdGgubWF4KGFycmF5Lmxlbmd0aCAtIG4sIDApKTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBhcnJheVthcnJheS5sZW5ndGggLSAxXTsKICAgIH0KICB9OwoKICAvLyBSZXR1cm5zIGV2ZXJ5dGhpbmcgYnV0IHRoZSBmaXJzdCBlbnRyeSBvZiB0aGUgYXJyYXkuIEFsaWFzZWQgYXMgYHRhaWxgIGFuZCBgZHJvcGAuCiAgLy8gRXNwZWNpYWxseSB1c2VmdWwgb24gdGhlIGFyZ3VtZW50cyBvYmplY3QuIFBhc3NpbmcgYW4gKipuKiogd2lsbCByZXR1cm4KICAvLyB0aGUgcmVzdCBOIHZhbHVlcyBpbiB0aGUgYXJyYXkuIFRoZSAqKmd1YXJkKioKICAvLyBjaGVjayBhbGxvd3MgaXQgdG8gd29yayB3aXRoIGBfLm1hcGAuCiAgXy5yZXN0ID0gXy50YWlsID0gXy5kcm9wID0gZnVuY3Rpb24oYXJyYXksIG4sIGd1YXJkKSB7CiAgICByZXR1cm4gc2xpY2UuY2FsbChhcnJheSwgKG4gPT0gbnVsbCkgfHwgZ3VhcmQgPyAxIDogbik7CiAgfTsKCiAgLy8gVHJpbSBvdXQgYWxsIGZhbHN5IHZhbHVlcyBmcm9tIGFuIGFycmF5LgogIF8uY29tcGFjdCA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICByZXR1cm4gXy5maWx0ZXIoYXJyYXksIGZ1bmN0aW9uKHZhbHVlKXsgcmV0dXJuICEhdmFsdWU7IH0pOwogIH07CgogIC8vIEludGVybmFsIGltcGxlbWVudGF0aW9uIG9mIGEgcmVjdXJzaXZlIGBmbGF0dGVuYCBmdW5jdGlvbi4KICB2YXIgZmxhdHRlbiA9IGZ1bmN0aW9uKGlucHV0LCBzaGFsbG93LCBvdXRwdXQpIHsKICAgIGVhY2goaW5wdXQsIGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgIGlmIChfLmlzQXJyYXkodmFsdWUpKSB7CiAgICAgICAgc2hhbGxvdyA/IHB1c2guYXBwbHkob3V0cHV0LCB2YWx1ZSkgOiBmbGF0dGVuKHZhbHVlLCBzaGFsbG93LCBvdXRwdXQpOwogICAgICB9IGVsc2UgewogICAgICAgIG91dHB1dC5wdXNoKHZhbHVlKTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb3V0cHV0OwogIH07CgogIC8vIFJldHVybiBhIGNvbXBsZXRlbHkgZmxhdHRlbmVkIHZlcnNpb24gb2YgYW4gYXJyYXkuCiAgXy5mbGF0dGVuID0gZnVuY3Rpb24oYXJyYXksIHNoYWxsb3cpIHsKICAgIHJldHVybiBmbGF0dGVuKGFycmF5LCBzaGFsbG93LCBbXSk7CiAgfTsKCiAgLy8gUmV0dXJuIGEgdmVyc2lvbiBvZiB0aGUgYXJyYXkgdGhhdCBkb2VzIG5vdCBjb250YWluIHRoZSBzcGVjaWZpZWQgdmFsdWUocykuCiAgXy53aXRob3V0ID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHJldHVybiBfLmRpZmZlcmVuY2UoYXJyYXksIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgfTsKCiAgLy8gUHJvZHVjZSBhIGR1cGxpY2F0ZS1mcmVlIHZlcnNpb24gb2YgdGhlIGFycmF5LiBJZiB0aGUgYXJyYXkgaGFzIGFscmVhZHkKICAvLyBiZWVuIHNvcnRlZCwgeW91IGhhdmUgdGhlIG9wdGlvbiBvZiB1c2luZyBhIGZhc3RlciBhbGdvcml0aG0uCiAgLy8gQWxpYXNlZCBhcyBgdW5pcXVlYC4KICBfLnVuaXEgPSBfLnVuaXF1ZSA9IGZ1bmN0aW9uKGFycmF5LCBpc1NvcnRlZCwgaXRlcmF0b3IsIGNvbnRleHQpIHsKICAgIHZhciBpbml0aWFsID0gaXRlcmF0b3IgPyBfLm1hcChhcnJheSwgaXRlcmF0b3IsIGNvbnRleHQpIDogYXJyYXk7CiAgICB2YXIgcmVzdWx0cyA9IFtdOwogICAgdmFyIHNlZW4gPSBbXTsKICAgIGVhY2goaW5pdGlhbCwgZnVuY3Rpb24odmFsdWUsIGluZGV4KSB7CiAgICAgIGlmIChpc1NvcnRlZCA/ICghaW5kZXggfHwgc2VlbltzZWVuLmxlbmd0aCAtIDFdICE9PSB2YWx1ZSkgOiAhXy5jb250YWlucyhzZWVuLCB2YWx1ZSkpIHsKICAgICAgICBzZWVuLnB1c2godmFsdWUpOwogICAgICAgIHJlc3VsdHMucHVzaChhcnJheVtpbmRleF0pOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyB0aGUgdW5pb246IGVhY2ggZGlzdGluY3QgZWxlbWVudCBmcm9tIGFsbCBvZgogIC8vIHRoZSBwYXNzZWQtaW4gYXJyYXlzLgogIF8udW5pb24gPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBfLnVuaXEoY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIGFyZ3VtZW50cykpOwogIH07CgogIC8vIFByb2R1Y2UgYW4gYXJyYXkgdGhhdCBjb250YWlucyBldmVyeSBpdGVtIHNoYXJlZCBiZXR3ZWVuIGFsbCB0aGUKICAvLyBwYXNzZWQtaW4gYXJyYXlzLgogIF8uaW50ZXJzZWN0aW9uID0gZnVuY3Rpb24oYXJyYXkpIHsKICAgIHZhciByZXN0ID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgcmV0dXJuIF8uZmlsdGVyKF8udW5pcShhcnJheSksIGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgcmV0dXJuIF8uZXZlcnkocmVzdCwgZnVuY3Rpb24ob3RoZXIpIHsKICAgICAgICByZXR1cm4gXy5pbmRleE9mKG90aGVyLCBpdGVtKSA+PSAwOwogICAgICB9KTsKICAgIH0pOwogIH07CgogIC8vIFRha2UgdGhlIGRpZmZlcmVuY2UgYmV0d2VlbiBvbmUgYXJyYXkgYW5kIGEgbnVtYmVyIG9mIG90aGVyIGFycmF5cy4KICAvLyBPbmx5IHRoZSBlbGVtZW50cyBwcmVzZW50IGluIGp1c3QgdGhlIGZpcnN0IGFycmF5IHdpbGwgcmVtYWluLgogIF8uZGlmZmVyZW5jZSA9IGZ1bmN0aW9uKGFycmF5KSB7CiAgICB2YXIgcmVzdCA9IGNvbmNhdC5hcHBseShBcnJheVByb3RvLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwogICAgcmV0dXJuIF8uZmlsdGVyKGFycmF5LCBmdW5jdGlvbih2YWx1ZSl7IHJldHVybiAhXy5jb250YWlucyhyZXN0LCB2YWx1ZSk7IH0pOwogIH07CgogIC8vIFppcCB0b2dldGhlciBtdWx0aXBsZSBsaXN0cyBpbnRvIGEgc2luZ2xlIGFycmF5IC0tIGVsZW1lbnRzIHRoYXQgc2hhcmUKICAvLyBhbiBpbmRleCBnbyB0b2dldGhlci4KICBfLnppcCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICB2YXIgbGVuZ3RoID0gXy5tYXgoXy5wbHVjayhhcmdzLCAnbGVuZ3RoJykpOwogICAgdmFyIHJlc3VsdHMgPSBuZXcgQXJyYXkobGVuZ3RoKTsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgcmVzdWx0c1tpXSA9IF8ucGx1Y2soYXJncywgIiIgKyBpKTsKICAgIH0KICAgIHJldHVybiByZXN1bHRzOwogIH07CgogIC8vIENvbnZlcnRzIGxpc3RzIGludG8gb2JqZWN0cy4gUGFzcyBlaXRoZXIgYSBzaW5nbGUgYXJyYXkgb2YgYFtrZXksIHZhbHVlXWAKICAvLyBwYWlycywgb3IgdHdvIHBhcmFsbGVsIGFycmF5cyBvZiB0aGUgc2FtZSBsZW5ndGggLS0gb25lIG9mIGtleXMsIGFuZCBvbmUgb2YKICAvLyB0aGUgY29ycmVzcG9uZGluZyB2YWx1ZXMuCiAgXy5vYmplY3QgPSBmdW5jdGlvbihsaXN0LCB2YWx1ZXMpIHsKICAgIHZhciByZXN1bHQgPSB7fTsKICAgIGZvciAodmFyIGkgPSAwLCBsID0gbGlzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgaWYgKHZhbHVlcykgewogICAgICAgIHJlc3VsdFtsaXN0W2ldXSA9IHZhbHVlc1tpXTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXN1bHRbbGlzdFtpXVswXV0gPSBsaXN0W2ldWzFdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIElmIHRoZSBicm93c2VyIGRvZXNuJ3Qgc3VwcGx5IHVzIHdpdGggaW5kZXhPZiAoSSdtIGxvb2tpbmcgYXQgeW91LCAqKk1TSUUqKiksCiAgLy8gd2UgbmVlZCB0aGlzIGZ1bmN0aW9uLiBSZXR1cm4gdGhlIHBvc2l0aW9uIG9mIHRoZSBmaXJzdCBvY2N1cnJlbmNlIG9mIGFuCiAgLy8gaXRlbSBpbiBhbiBhcnJheSwgb3IgLTEgaWYgdGhlIGl0ZW0gaXMgbm90IGluY2x1ZGVkIGluIHRoZSBhcnJheS4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgaW5kZXhPZmAgaWYgYXZhaWxhYmxlLgogIC8vIElmIHRoZSBhcnJheSBpcyBsYXJnZSBhbmQgYWxyZWFkeSBpbiBzb3J0IG9yZGVyLCBwYXNzIGB0cnVlYAogIC8vIGZvciAqKmlzU29ydGVkKiogdG8gdXNlIGJpbmFyeSBzZWFyY2guCiAgXy5pbmRleE9mID0gZnVuY3Rpb24oYXJyYXksIGl0ZW0sIGlzU29ydGVkKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGkgPSAwLCBsID0gYXJyYXkubGVuZ3RoOwogICAgaWYgKGlzU29ydGVkKSB7CiAgICAgIGlmICh0eXBlb2YgaXNTb3J0ZWQgPT0gJ251bWJlcicpIHsKICAgICAgICBpID0gKGlzU29ydGVkIDwgMCA/IE1hdGgubWF4KDAsIGwgKyBpc1NvcnRlZCkgOiBpc1NvcnRlZCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaSA9IF8uc29ydGVkSW5kZXgoYXJyYXksIGl0ZW0pOwogICAgICAgIHJldHVybiBhcnJheVtpXSA9PT0gaXRlbSA/IGkgOiAtMTsKICAgICAgfQogICAgfQogICAgaWYgKG5hdGl2ZUluZGV4T2YgJiYgYXJyYXkuaW5kZXhPZiA9PT0gbmF0aXZlSW5kZXhPZikgcmV0dXJuIGFycmF5LmluZGV4T2YoaXRlbSwgaXNTb3J0ZWQpOwogICAgZm9yICg7IGkgPCBsOyBpKyspIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYGxhc3RJbmRleE9mYCBpZiBhdmFpbGFibGUuCiAgXy5sYXN0SW5kZXhPZiA9IGZ1bmN0aW9uKGFycmF5LCBpdGVtLCBmcm9tKSB7CiAgICBpZiAoYXJyYXkgPT0gbnVsbCkgcmV0dXJuIC0xOwogICAgdmFyIGhhc0luZGV4ID0gZnJvbSAhPSBudWxsOwogICAgaWYgKG5hdGl2ZUxhc3RJbmRleE9mICYmIGFycmF5Lmxhc3RJbmRleE9mID09PSBuYXRpdmVMYXN0SW5kZXhPZikgewogICAgICByZXR1cm4gaGFzSW5kZXggPyBhcnJheS5sYXN0SW5kZXhPZihpdGVtLCBmcm9tKSA6IGFycmF5Lmxhc3RJbmRleE9mKGl0ZW0pOwogICAgfQogICAgdmFyIGkgPSAoaGFzSW5kZXggPyBmcm9tIDogYXJyYXkubGVuZ3RoKTsKICAgIHdoaWxlIChpLS0pIGlmIChhcnJheVtpXSA9PT0gaXRlbSkgcmV0dXJuIGk7CiAgICByZXR1cm4gLTE7CiAgfTsKCiAgLy8gR2VuZXJhdGUgYW4gaW50ZWdlciBBcnJheSBjb250YWluaW5nIGFuIGFyaXRobWV0aWMgcHJvZ3Jlc3Npb24uIEEgcG9ydCBvZgogIC8vIHRoZSBuYXRpdmUgUHl0aG9uIGByYW5nZSgpYCBmdW5jdGlvbi4gU2VlCiAgLy8gW3RoZSBQeXRob24gZG9jdW1lbnRhdGlvbl0oaHR0cDovL2RvY3MucHl0aG9uLm9yZy9saWJyYXJ5L2Z1bmN0aW9ucy5odG1sI3JhbmdlKS4KICBfLnJhbmdlID0gZnVuY3Rpb24oc3RhcnQsIHN0b3AsIHN0ZXApIHsKICAgIGlmIChhcmd1bWVudHMubGVuZ3RoIDw9IDEpIHsKICAgICAgc3RvcCA9IHN0YXJ0IHx8IDA7CiAgICAgIHN0YXJ0ID0gMDsKICAgIH0KICAgIHN0ZXAgPSBhcmd1bWVudHNbMl0gfHwgMTsKCiAgICB2YXIgbGVuID0gTWF0aC5tYXgoTWF0aC5jZWlsKChzdG9wIC0gc3RhcnQpIC8gc3RlcCksIDApOwogICAgdmFyIGlkeCA9IDA7CiAgICB2YXIgcmFuZ2UgPSBuZXcgQXJyYXkobGVuKTsKCiAgICB3aGlsZShpZHggPCBsZW4pIHsKICAgICAgcmFuZ2VbaWR4KytdID0gc3RhcnQ7CiAgICAgIHN0YXJ0ICs9IHN0ZXA7CiAgICB9CgogICAgcmV0dXJuIHJhbmdlOwogIH07CgogIC8vIEZ1bmN0aW9uIChhaGVtKSBGdW5jdGlvbnMKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmV1c2FibGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHByb3RvdHlwZSBzZXR0aW5nLgogIHZhciBjdG9yID0gZnVuY3Rpb24oKXt9OwoKICAvLyBDcmVhdGUgYSBmdW5jdGlvbiBib3VuZCB0byBhIGdpdmVuIG9iamVjdCAoYXNzaWduaW5nIGB0aGlzYCwgYW5kIGFyZ3VtZW50cywKICAvLyBvcHRpb25hbGx5KS4gQmluZGluZyB3aXRoIGFyZ3VtZW50cyBpcyBhbHNvIGtub3duIGFzIGBjdXJyeWAuCiAgLy8gRGVsZWdhdGVzIHRvICoqRUNNQVNjcmlwdCA1KioncyBuYXRpdmUgYEZ1bmN0aW9uLmJpbmRgIGlmIGF2YWlsYWJsZS4KICAvLyBXZSBjaGVjayBmb3IgYGZ1bmMuYmluZGAgZmlyc3QsIHRvIGZhaWwgZmFzdCB3aGVuIGBmdW5jYCBpcyB1bmRlZmluZWQuCiAgXy5iaW5kID0gZnVuY3Rpb24gYmluZChmdW5jLCBjb250ZXh0KSB7CiAgICB2YXIgYm91bmQsIGFyZ3M7CiAgICBpZiAoZnVuYy5iaW5kID09PSBuYXRpdmVCaW5kICYmIG5hdGl2ZUJpbmQpIHJldHVybiBuYXRpdmVCaW5kLmFwcGx5KGZ1bmMsIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBpZiAoIV8uaXNGdW5jdGlvbihmdW5jKSkgdGhyb3cgbmV3IFR5cGVFcnJvcjsKICAgIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gYm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgaWYgKCEodGhpcyBpbnN0YW5jZW9mIGJvdW5kKSkgcmV0dXJuIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncy5jb25jYXQoc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgIGN0b3IucHJvdG90eXBlID0gZnVuYy5wcm90b3R5cGU7CiAgICAgIHZhciBzZWxmID0gbmV3IGN0b3I7CiAgICAgIHZhciByZXN1bHQgPSBmdW5jLmFwcGx5KHNlbGYsIGFyZ3MuY29uY2F0KHNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICBpZiAoT2JqZWN0KHJlc3VsdCkgPT09IHJlc3VsdCkgcmV0dXJuIHJlc3VsdDsKICAgICAgcmV0dXJuIHNlbGY7CiAgICB9OwogIH07CgogIC8vIEJpbmQgYWxsIG9mIGFuIG9iamVjdCdzIG1ldGhvZHMgdG8gdGhhdCBvYmplY3QuIFVzZWZ1bCBmb3IgZW5zdXJpbmcgdGhhdAogIC8vIGFsbCBjYWxsYmFja3MgZGVmaW5lZCBvbiBhbiBvYmplY3QgYmVsb25nIHRvIGl0LgogIF8uYmluZEFsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGZ1bmNzID0gc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwogICAgaWYgKGZ1bmNzLmxlbmd0aCA9PSAwKSBmdW5jcyA9IF8uZnVuY3Rpb25zKG9iaik7CiAgICBlYWNoKGZ1bmNzLCBmdW5jdGlvbihmKSB7IG9ialtmXSA9IF8uYmluZChvYmpbZl0sIG9iaik7IH0pOwogICAgcmV0dXJuIG9iajsKICB9OwoKICAvLyBNZW1vaXplIGFuIGV4cGVuc2l2ZSBmdW5jdGlvbiBieSBzdG9yaW5nIGl0cyByZXN1bHRzLgogIF8ubWVtb2l6ZSA9IGZ1bmN0aW9uKGZ1bmMsIGhhc2hlcikgewogICAgdmFyIG1lbW8gPSB7fTsKICAgIGhhc2hlciB8fCAoaGFzaGVyID0gXy5pZGVudGl0eSk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIHZhciBrZXkgPSBoYXNoZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIF8uaGFzKG1lbW8sIGtleSkgPyBtZW1vW2tleV0gOiAobWVtb1trZXldID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgIH07CiAgfTsKCiAgLy8gRGVsYXlzIGEgZnVuY3Rpb24gZm9yIHRoZSBnaXZlbiBudW1iZXIgb2YgbWlsbGlzZWNvbmRzLCBhbmQgdGhlbiBjYWxscwogIC8vIGl0IHdpdGggdGhlIGFyZ3VtZW50cyBzdXBwbGllZC4KICBfLmRlbGF5ID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMik7CiAgICByZXR1cm4gc2V0VGltZW91dChmdW5jdGlvbigpeyByZXR1cm4gZnVuYy5hcHBseShudWxsLCBhcmdzKTsgfSwgd2FpdCk7CiAgfTsKCiAgLy8gRGVmZXJzIGEgZnVuY3Rpb24sIHNjaGVkdWxpbmcgaXQgdG8gcnVuIGFmdGVyIHRoZSBjdXJyZW50IGNhbGwgc3RhY2sgaGFzCiAgLy8gY2xlYXJlZC4KICBfLmRlZmVyID0gZnVuY3Rpb24oZnVuYykgewogICAgcmV0dXJuIF8uZGVsYXkuYXBwbHkoXywgW2Z1bmMsIDFdLmNvbmNhdChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpKTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIHdoZW4gaW52b2tlZCwgd2lsbCBvbmx5IGJlIHRyaWdnZXJlZCBhdCBtb3N0IG9uY2UKICAvLyBkdXJpbmcgYSBnaXZlbiB3aW5kb3cgb2YgdGltZS4KICBfLnRocm90dGxlID0gZnVuY3Rpb24oZnVuYywgd2FpdCkgewogICAgdmFyIGNvbnRleHQsIGFyZ3MsIHRpbWVvdXQsIHRocm90dGxpbmcsIG1vcmUsIHJlc3VsdDsKICAgIHZhciB3aGVuRG9uZSA9IF8uZGVib3VuY2UoZnVuY3Rpb24oKXsgbW9yZSA9IHRocm90dGxpbmcgPSBmYWxzZTsgfSwgd2FpdCk7CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGNvbnRleHQgPSB0aGlzOyBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAobW9yZSkgewogICAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9CiAgICAgICAgd2hlbkRvbmUoKTsKICAgICAgfTsKICAgICAgaWYgKCF0aW1lb3V0KSB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgIGlmICh0aHJvdHRsaW5nKSB7CiAgICAgICAgbW9yZSA9IHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3R0bGluZyA9IHRydWU7CiAgICAgICAgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfQogICAgICB3aGVuRG9uZSgpOwogICAgICByZXR1cm4gcmVzdWx0OwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24sIHRoYXQsIGFzIGxvbmcgYXMgaXQgY29udGludWVzIHRvIGJlIGludm9rZWQsIHdpbGwgbm90CiAgLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgogIC8vIE4gbWlsbGlzZWNvbmRzLiBJZiBgaW1tZWRpYXRlYCBpcyBwYXNzZWQsIHRyaWdnZXIgdGhlIGZ1bmN0aW9uIG9uIHRoZQogIC8vIGxlYWRpbmcgZWRnZSwgaW5zdGVhZCBvZiB0aGUgdHJhaWxpbmcuCiAgXy5kZWJvdW5jZSA9IGZ1bmN0aW9uKGZ1bmMsIHdhaXQsIGltbWVkaWF0ZSkgewogICAgdmFyIHRpbWVvdXQsIHJlc3VsdDsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGNvbnRleHQgPSB0aGlzLCBhcmdzID0gYXJndW1lbnRzOwogICAgICB2YXIgbGF0ZXIgPSBmdW5jdGlvbigpIHsKICAgICAgICB0aW1lb3V0ID0gbnVsbDsKICAgICAgICBpZiAoIWltbWVkaWF0ZSkgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgfTsKICAgICAgdmFyIGNhbGxOb3cgPSBpbW1lZGlhdGUgJiYgIXRpbWVvdXQ7CiAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgdGltZW91dCA9IHNldFRpbWVvdXQobGF0ZXIsIHdhaXQpOwogICAgICBpZiAoY2FsbE5vdykgcmVzdWx0ID0gZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgcmV0dXJuIHJlc3VsdDsKICAgIH07CiAgfTsKCiAgLy8gUmV0dXJucyBhIGZ1bmN0aW9uIHRoYXQgd2lsbCBiZSBleGVjdXRlZCBhdCBtb3N0IG9uZSB0aW1lLCBubyBtYXR0ZXIgaG93CiAgLy8gb2Z0ZW4geW91IGNhbGwgaXQuIFVzZWZ1bCBmb3IgbGF6eSBpbml0aWFsaXphdGlvbi4KICBfLm9uY2UgPSBmdW5jdGlvbihmdW5jKSB7CiAgICB2YXIgcmFuID0gZmFsc2UsIG1lbW87CiAgICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICAgIGlmIChyYW4pIHJldHVybiBtZW1vOwogICAgICByYW4gPSB0cnVlOwogICAgICBtZW1vID0gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICBmdW5jID0gbnVsbDsKICAgICAgcmV0dXJuIG1lbW87CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgdGhlIGZpcnN0IGZ1bmN0aW9uIHBhc3NlZCBhcyBhbiBhcmd1bWVudCB0byB0aGUgc2Vjb25kLAogIC8vIGFsbG93aW5nIHlvdSB0byBhZGp1c3QgYXJndW1lbnRzLCBydW4gY29kZSBiZWZvcmUgYW5kIGFmdGVyLCBhbmQKICAvLyBjb25kaXRpb25hbGx5IGV4ZWN1dGUgdGhlIG9yaWdpbmFsIGZ1bmN0aW9uLgogIF8ud3JhcCA9IGZ1bmN0aW9uKGZ1bmMsIHdyYXBwZXIpIHsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBbZnVuY107CiAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHdyYXBwZXIuYXBwbHkodGhpcywgYXJncyk7CiAgICB9OwogIH07CgogIC8vIFJldHVybnMgYSBmdW5jdGlvbiB0aGF0IGlzIHRoZSBjb21wb3NpdGlvbiBvZiBhIGxpc3Qgb2YgZnVuY3Rpb25zLCBlYWNoCiAgLy8gY29uc3VtaW5nIHRoZSByZXR1cm4gdmFsdWUgb2YgdGhlIGZ1bmN0aW9uIHRoYXQgZm9sbG93cy4KICBfLmNvbXBvc2UgPSBmdW5jdGlvbigpIHsKICAgIHZhciBmdW5jcyA9IGFyZ3VtZW50czsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgIGZvciAodmFyIGkgPSBmdW5jcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkgewogICAgICAgIGFyZ3MgPSBbZnVuY3NbaV0uYXBwbHkodGhpcywgYXJncyldOwogICAgICB9CiAgICAgIHJldHVybiBhcmdzWzBdOwogICAgfTsKICB9OwoKICAvLyBSZXR1cm5zIGEgZnVuY3Rpb24gdGhhdCB3aWxsIG9ubHkgYmUgZXhlY3V0ZWQgYWZ0ZXIgYmVpbmcgY2FsbGVkIE4gdGltZXMuCiAgXy5hZnRlciA9IGZ1bmN0aW9uKHRpbWVzLCBmdW5jKSB7CiAgICBpZiAodGltZXMgPD0gMCkgcmV0dXJuIGZ1bmMoKTsKICAgIHJldHVybiBmdW5jdGlvbigpIHsKICAgICAgaWYgKC0tdGltZXMgPCAxKSB7CiAgICAgICAgcmV0dXJuIGZ1bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfQogICAgfTsKICB9OwoKICAvLyBPYmplY3QgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBSZXRyaWV2ZSB0aGUgbmFtZXMgb2YgYW4gb2JqZWN0J3MgcHJvcGVydGllcy4KICAvLyBEZWxlZ2F0ZXMgdG8gKipFQ01BU2NyaXB0IDUqKidzIG5hdGl2ZSBgT2JqZWN0LmtleXNgCiAgXy5rZXlzID0gbmF0aXZlS2V5cyB8fCBmdW5jdGlvbihvYmopIHsKICAgIGlmIChvYmogIT09IE9iamVjdChvYmopKSB0aHJvdyBuZXcgVHlwZUVycm9yKCdJbnZhbGlkIG9iamVjdCcpOwogICAgdmFyIGtleXMgPSBbXTsKICAgIGZvciAodmFyIGtleSBpbiBvYmopIGlmIChfLmhhcyhvYmosIGtleSkpIGtleXNba2V5cy5sZW5ndGhdID0ga2V5OwogICAgcmV0dXJuIGtleXM7CiAgfTsKCiAgLy8gUmV0cmlldmUgdGhlIHZhbHVlcyBvZiBhbiBvYmplY3QncyBwcm9wZXJ0aWVzLgogIF8udmFsdWVzID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgdmFsdWVzID0gW107CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSBpZiAoXy5oYXMob2JqLCBrZXkpKSB2YWx1ZXMucHVzaChvYmpba2V5XSk7CiAgICByZXR1cm4gdmFsdWVzOwogIH07CgogIC8vIENvbnZlcnQgYW4gb2JqZWN0IGludG8gYSBsaXN0IG9mIGBba2V5LCB2YWx1ZV1gIHBhaXJzLgogIF8ucGFpcnMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBwYWlycyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcGFpcnMucHVzaChba2V5LCBvYmpba2V5XV0pOwogICAgcmV0dXJuIHBhaXJzOwogIH07CgogIC8vIEludmVydCB0aGUga2V5cyBhbmQgdmFsdWVzIG9mIGFuIG9iamVjdC4gVGhlIHZhbHVlcyBtdXN0IGJlIHNlcmlhbGl6YWJsZS4KICBfLmludmVydCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIHJlc3VsdCA9IHt9OwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmVzdWx0W29ialtrZXldXSA9IGtleTsKICAgIHJldHVybiByZXN1bHQ7CiAgfTsKCiAgLy8gUmV0dXJuIGEgc29ydGVkIGxpc3Qgb2YgdGhlIGZ1bmN0aW9uIG5hbWVzIGF2YWlsYWJsZSBvbiB0aGUgb2JqZWN0LgogIC8vIEFsaWFzZWQgYXMgYG1ldGhvZHNgCiAgXy5mdW5jdGlvbnMgPSBfLm1ldGhvZHMgPSBmdW5jdGlvbihvYmopIHsKICAgIHZhciBuYW1lcyA9IFtdOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgewogICAgICBpZiAoXy5pc0Z1bmN0aW9uKG9ialtrZXldKSkgbmFtZXMucHVzaChrZXkpOwogICAgfQogICAgcmV0dXJuIG5hbWVzLnNvcnQoKTsKICB9OwoKICAvLyBFeHRlbmQgYSBnaXZlbiBvYmplY3Qgd2l0aCBhbGwgdGhlIHByb3BlcnRpZXMgaW4gcGFzc2VkLWluIG9iamVjdChzKS4KICBfLmV4dGVuZCA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIG9ialtwcm9wXSA9IHNvdXJjZVtwcm9wXTsKICAgICAgfQogICAgfSk7CiAgICByZXR1cm4gb2JqOwogIH07CgogIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCBvbmx5IGNvbnRhaW5pbmcgdGhlIHdoaXRlbGlzdGVkIHByb3BlcnRpZXMuCiAgXy5waWNrID0gZnVuY3Rpb24ob2JqKSB7CiAgICB2YXIgY29weSA9IHt9OwogICAgdmFyIGtleXMgPSBjb25jYXQuYXBwbHkoQXJyYXlQcm90bywgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKICAgIGVhY2goa2V5cywgZnVuY3Rpb24oa2V5KSB7CiAgICAgIGlmIChrZXkgaW4gb2JqKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0pOwogICAgcmV0dXJuIGNvcHk7CiAgfTsKCiAgIC8vIFJldHVybiBhIGNvcHkgb2YgdGhlIG9iamVjdCB3aXRob3V0IHRoZSBibGFja2xpc3RlZCBwcm9wZXJ0aWVzLgogIF8ub21pdCA9IGZ1bmN0aW9uKG9iaikgewogICAgdmFyIGNvcHkgPSB7fTsKICAgIHZhciBrZXlzID0gY29uY2F0LmFwcGx5KEFycmF5UHJvdG8sIHNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSk7CiAgICBmb3IgKHZhciBrZXkgaW4gb2JqKSB7CiAgICAgIGlmICghXy5jb250YWlucyhrZXlzLCBrZXkpKSBjb3B5W2tleV0gPSBvYmpba2V5XTsKICAgIH0KICAgIHJldHVybiBjb3B5OwogIH07CgogIC8vIEZpbGwgaW4gYSBnaXZlbiBvYmplY3Qgd2l0aCBkZWZhdWx0IHByb3BlcnRpZXMuCiAgXy5kZWZhdWx0cyA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChzbGljZS5jYWxsKGFyZ3VtZW50cywgMSksIGZ1bmN0aW9uKHNvdXJjZSkgewogICAgICBmb3IgKHZhciBwcm9wIGluIHNvdXJjZSkgewogICAgICAgIGlmIChvYmpbcHJvcF0gPT0gbnVsbCkgb2JqW3Byb3BdID0gc291cmNlW3Byb3BdOwogICAgICB9CiAgICB9KTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gQ3JlYXRlIGEgKHNoYWxsb3ctY2xvbmVkKSBkdXBsaWNhdGUgb2YgYW4gb2JqZWN0LgogIF8uY2xvbmUgPSBmdW5jdGlvbihvYmopIHsKICAgIGlmICghXy5pc09iamVjdChvYmopKSByZXR1cm4gb2JqOwogICAgcmV0dXJuIF8uaXNBcnJheShvYmopID8gb2JqLnNsaWNlKCkgOiBfLmV4dGVuZCh7fSwgb2JqKTsKICB9OwoKICAvLyBJbnZva2VzIGludGVyY2VwdG9yIHdpdGggdGhlIG9iaiwgYW5kIHRoZW4gcmV0dXJucyBvYmouCiAgLy8gVGhlIHByaW1hcnkgcHVycG9zZSBvZiB0aGlzIG1ldGhvZCBpcyB0byAidGFwIGludG8iIGEgbWV0aG9kIGNoYWluLCBpbgogIC8vIG9yZGVyIHRvIHBlcmZvcm0gb3BlcmF0aW9ucyBvbiBpbnRlcm1lZGlhdGUgcmVzdWx0cyB3aXRoaW4gdGhlIGNoYWluLgogIF8udGFwID0gZnVuY3Rpb24ob2JqLCBpbnRlcmNlcHRvcikgewogICAgaW50ZXJjZXB0b3Iob2JqKTsKICAgIHJldHVybiBvYmo7CiAgfTsKCiAgLy8gSW50ZXJuYWwgcmVjdXJzaXZlIGNvbXBhcmlzb24gZnVuY3Rpb24gZm9yIGBpc0VxdWFsYC4KICB2YXIgZXEgPSBmdW5jdGlvbihhLCBiLCBhU3RhY2ssIGJTdGFjaykgewogICAgLy8gSWRlbnRpY2FsIG9iamVjdHMgYXJlIGVxdWFsLiBgMCA9PT0gLTBgLCBidXQgdGhleSBhcmVuJ3QgaWRlbnRpY2FsLgogICAgLy8gU2VlIHRoZSBIYXJtb255IGBlZ2FsYCBwcm9wb3NhbDogaHR0cDovL3dpa2kuZWNtYXNjcmlwdC5vcmcvZG9rdS5waHA/aWQ9aGFybW9ueTplZ2FsLgogICAgaWYgKGEgPT09IGIpIHJldHVybiBhICE9PSAwIHx8IDEgLyBhID09IDEgLyBiOwogICAgLy8gQSBzdHJpY3QgY29tcGFyaXNvbiBpcyBuZWNlc3NhcnkgYmVjYXVzZSBgbnVsbCA9PSB1bmRlZmluZWRgLgogICAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiOwogICAgLy8gVW53cmFwIGFueSB3cmFwcGVkIG9iamVjdHMuCiAgICBpZiAoYSBpbnN0YW5jZW9mIF8pIGEgPSBhLl93cmFwcGVkOwogICAgaWYgKGIgaW5zdGFuY2VvZiBfKSBiID0gYi5fd3JhcHBlZDsKICAgIC8vIENvbXBhcmUgYFtbQ2xhc3NdXWAgbmFtZXMuCiAgICB2YXIgY2xhc3NOYW1lID0gdG9TdHJpbmcuY2FsbChhKTsKICAgIGlmIChjbGFzc05hbWUgIT0gdG9TdHJpbmcuY2FsbChiKSkgcmV0dXJuIGZhbHNlOwogICAgc3dpdGNoIChjbGFzc05hbWUpIHsKICAgICAgLy8gU3RyaW5ncywgbnVtYmVycywgZGF0ZXMsIGFuZCBib29sZWFucyBhcmUgY29tcGFyZWQgYnkgdmFsdWUuCiAgICAgIGNhc2UgJ1tvYmplY3QgU3RyaW5nXSc6CiAgICAgICAgLy8gUHJpbWl0aXZlcyBhbmQgdGhlaXIgY29ycmVzcG9uZGluZyBvYmplY3Qgd3JhcHBlcnMgYXJlIGVxdWl2YWxlbnQ7IHRodXMsIGAiNSJgIGlzCiAgICAgICAgLy8gZXF1aXZhbGVudCB0byBgbmV3IFN0cmluZygiNSIpYC4KICAgICAgICByZXR1cm4gYSA9PSBTdHJpbmcoYik7CiAgICAgIGNhc2UgJ1tvYmplY3QgTnVtYmVyXSc6CiAgICAgICAgLy8gYE5hTmBzIGFyZSBlcXVpdmFsZW50LCBidXQgbm9uLXJlZmxleGl2ZS4gQW4gYGVnYWxgIGNvbXBhcmlzb24gaXMgcGVyZm9ybWVkIGZvcgogICAgICAgIC8vIG90aGVyIG51bWVyaWMgdmFsdWVzLgogICAgICAgIHJldHVybiBhICE9ICthID8gYiAhPSArYiA6IChhID09IDAgPyAxIC8gYSA9PSAxIC8gYiA6IGEgPT0gK2IpOwogICAgICBjYXNlICdbb2JqZWN0IERhdGVdJzoKICAgICAgY2FzZSAnW29iamVjdCBCb29sZWFuXSc6CiAgICAgICAgLy8gQ29lcmNlIGRhdGVzIGFuZCBib29sZWFucyB0byBudW1lcmljIHByaW1pdGl2ZSB2YWx1ZXMuIERhdGVzIGFyZSBjb21wYXJlZCBieSB0aGVpcgogICAgICAgIC8vIG1pbGxpc2Vjb25kIHJlcHJlc2VudGF0aW9ucy4gTm90ZSB0aGF0IGludmFsaWQgZGF0ZXMgd2l0aCBtaWxsaXNlY29uZCByZXByZXNlbnRhdGlvbnMKICAgICAgICAvLyBvZiBgTmFOYCBhcmUgbm90IGVxdWl2YWxlbnQuCiAgICAgICAgcmV0dXJuICthID09ICtiOwogICAgICAvLyBSZWdFeHBzIGFyZSBjb21wYXJlZCBieSB0aGVpciBzb3VyY2UgcGF0dGVybnMgYW5kIGZsYWdzLgogICAgICBjYXNlICdbb2JqZWN0IFJlZ0V4cF0nOgogICAgICAgIHJldHVybiBhLnNvdXJjZSA9PSBiLnNvdXJjZSAmJgogICAgICAgICAgICAgICBhLmdsb2JhbCA9PSBiLmdsb2JhbCAmJgogICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PSBiLm11bHRpbGluZSAmJgogICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT0gYi5pZ25vcmVDYXNlOwogICAgfQogICAgaWYgKHR5cGVvZiBhICE9ICdvYmplY3QnIHx8IHR5cGVvZiBiICE9ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyBBc3N1bWUgZXF1YWxpdHkgZm9yIGN5Y2xpYyBzdHJ1Y3R1cmVzLiBUaGUgYWxnb3JpdGhtIGZvciBkZXRlY3RpbmcgY3ljbGljCiAgICAvLyBzdHJ1Y3R1cmVzIGlzIGFkYXB0ZWQgZnJvbSBFUyA1LjEgc2VjdGlvbiAxNS4xMi4zLCBhYnN0cmFjdCBvcGVyYXRpb24gYEpPYC4KICAgIHZhciBsZW5ndGggPSBhU3RhY2subGVuZ3RoOwogICAgd2hpbGUgKGxlbmd0aC0tKSB7CiAgICAgIC8vIExpbmVhciBzZWFyY2guIFBlcmZvcm1hbmNlIGlzIGludmVyc2VseSBwcm9wb3J0aW9uYWwgdG8gdGhlIG51bWJlciBvZgogICAgICAvLyB1bmlxdWUgbmVzdGVkIHN0cnVjdHVyZXMuCiAgICAgIGlmIChhU3RhY2tbbGVuZ3RoXSA9PSBhKSByZXR1cm4gYlN0YWNrW2xlbmd0aF0gPT0gYjsKICAgIH0KICAgIC8vIEFkZCB0aGUgZmlyc3Qgb2JqZWN0IHRvIHRoZSBzdGFjayBvZiB0cmF2ZXJzZWQgb2JqZWN0cy4KICAgIGFTdGFjay5wdXNoKGEpOwogICAgYlN0YWNrLnB1c2goYik7CiAgICB2YXIgc2l6ZSA9IDAsIHJlc3VsdCA9IHRydWU7CiAgICAvLyBSZWN1cnNpdmVseSBjb21wYXJlIG9iamVjdHMgYW5kIGFycmF5cy4KICAgIGlmIChjbGFzc05hbWUgPT0gJ1tvYmplY3QgQXJyYXldJykgewogICAgICAvLyBDb21wYXJlIGFycmF5IGxlbmd0aHMgdG8gZGV0ZXJtaW5lIGlmIGEgZGVlcCBjb21wYXJpc29uIGlzIG5lY2Vzc2FyeS4KICAgICAgc2l6ZSA9IGEubGVuZ3RoOwogICAgICByZXN1bHQgPSBzaXplID09IGIubGVuZ3RoOwogICAgICBpZiAocmVzdWx0KSB7CiAgICAgICAgLy8gRGVlcCBjb21wYXJlIHRoZSBjb250ZW50cywgaWdub3Jpbmcgbm9uLW51bWVyaWMgcHJvcGVydGllcy4KICAgICAgICB3aGlsZSAoc2l6ZS0tKSB7CiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBlcShhW3NpemVdLCBiW3NpemVdLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIC8vIE9iamVjdHMgd2l0aCBkaWZmZXJlbnQgY29uc3RydWN0b3JzIGFyZSBub3QgZXF1aXZhbGVudCwgYnV0IGBPYmplY3RgcwogICAgICAvLyBmcm9tIGRpZmZlcmVudCBmcmFtZXMgYXJlLgogICAgICB2YXIgYUN0b3IgPSBhLmNvbnN0cnVjdG9yLCBiQ3RvciA9IGIuY29uc3RydWN0b3I7CiAgICAgIGlmIChhQ3RvciAhPT0gYkN0b3IgJiYgIShfLmlzRnVuY3Rpb24oYUN0b3IpICYmIChhQ3RvciBpbnN0YW5jZW9mIGFDdG9yKSAmJgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0Z1bmN0aW9uKGJDdG9yKSAmJiAoYkN0b3IgaW5zdGFuY2VvZiBiQ3RvcikpKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIC8vIERlZXAgY29tcGFyZSBvYmplY3RzLgogICAgICBmb3IgKHZhciBrZXkgaW4gYSkgewogICAgICAgIGlmIChfLmhhcyhhLCBrZXkpKSB7CiAgICAgICAgICAvLyBDb3VudCB0aGUgZXhwZWN0ZWQgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgICAgICBzaXplKys7CiAgICAgICAgICAvLyBEZWVwIGNvbXBhcmUgZWFjaCBtZW1iZXIuCiAgICAgICAgICBpZiAoIShyZXN1bHQgPSBfLmhhcyhiLCBrZXkpICYmIGVxKGFba2V5XSwgYltrZXldLCBhU3RhY2ssIGJTdGFjaykpKSBicmVhazsKICAgICAgICB9CiAgICAgIH0KICAgICAgLy8gRW5zdXJlIHRoYXQgYm90aCBvYmplY3RzIGNvbnRhaW4gdGhlIHNhbWUgbnVtYmVyIG9mIHByb3BlcnRpZXMuCiAgICAgIGlmIChyZXN1bHQpIHsKICAgICAgICBmb3IgKGtleSBpbiBiKSB7CiAgICAgICAgICBpZiAoXy5oYXMoYiwga2V5KSAmJiAhKHNpemUtLSkpIGJyZWFrOwogICAgICAgIH0KICAgICAgICByZXN1bHQgPSAhc2l6ZTsKICAgICAgfQogICAgfQogICAgLy8gUmVtb3ZlIHRoZSBmaXJzdCBvYmplY3QgZnJvbSB0aGUgc3RhY2sgb2YgdHJhdmVyc2VkIG9iamVjdHMuCiAgICBhU3RhY2sucG9wKCk7CiAgICBiU3RhY2sucG9wKCk7CiAgICByZXR1cm4gcmVzdWx0OwogIH07CgogIC8vIFBlcmZvcm0gYSBkZWVwIGNvbXBhcmlzb24gdG8gY2hlY2sgaWYgdHdvIG9iamVjdHMgYXJlIGVxdWFsLgogIF8uaXNFcXVhbCA9IGZ1bmN0aW9uKGEsIGIpIHsKICAgIHJldHVybiBlcShhLCBiLCBbXSwgW10pOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gYXJyYXksIHN0cmluZywgb3Igb2JqZWN0IGVtcHR5PwogIC8vIEFuICJlbXB0eSIgb2JqZWN0IGhhcyBubyBlbnVtZXJhYmxlIG93bi1wcm9wZXJ0aWVzLgogIF8uaXNFbXB0eSA9IGZ1bmN0aW9uKG9iaikgewogICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdHJ1ZTsKICAgIGlmIChfLmlzQXJyYXkob2JqKSB8fCBfLmlzU3RyaW5nKG9iaikpIHJldHVybiBvYmoubGVuZ3RoID09PSAwOwogICAgZm9yICh2YXIga2V5IGluIG9iaikgaWYgKF8uaGFzKG9iaiwga2V5KSkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIERPTSBlbGVtZW50PwogIF8uaXNFbGVtZW50ID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gISEob2JqICYmIG9iai5ub2RlVHlwZSA9PT0gMSk7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhbiBhcnJheT8KICAvLyBEZWxlZ2F0ZXMgdG8gRUNNQTUncyBuYXRpdmUgQXJyYXkuaXNBcnJheQogIF8uaXNBcnJheSA9IG5hdGl2ZUlzQXJyYXkgfHwgZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gdG9TdHJpbmcuY2FsbChvYmopID09ICdbb2JqZWN0IEFycmF5XSc7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YXJpYWJsZSBhbiBvYmplY3Q/CiAgXy5pc09iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gT2JqZWN0KG9iaik7CiAgfTsKCiAgLy8gQWRkIHNvbWUgaXNUeXBlIG1ldGhvZHM6IGlzQXJndW1lbnRzLCBpc0Z1bmN0aW9uLCBpc1N0cmluZywgaXNOdW1iZXIsIGlzRGF0ZSwgaXNSZWdFeHAuCiAgZWFjaChbJ0FyZ3VtZW50cycsICdGdW5jdGlvbicsICdTdHJpbmcnLCAnTnVtYmVyJywgJ0RhdGUnLCAnUmVnRXhwJ10sIGZ1bmN0aW9uKG5hbWUpIHsKICAgIF9bJ2lzJyArIG5hbWVdID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgJyArIG5hbWUgKyAnXSc7CiAgICB9OwogIH0pOwoKICAvLyBEZWZpbmUgYSBmYWxsYmFjayB2ZXJzaW9uIG9mIHRoZSBtZXRob2QgaW4gYnJvd3NlcnMgKGFoZW0sIElFKSwgd2hlcmUKICAvLyB0aGVyZSBpc24ndCBhbnkgaW5zcGVjdGFibGUgIkFyZ3VtZW50cyIgdHlwZS4KICBpZiAoIV8uaXNBcmd1bWVudHMoYXJndW1lbnRzKSkgewogICAgXy5pc0FyZ3VtZW50cyA9IGZ1bmN0aW9uKG9iaikgewogICAgICByZXR1cm4gISEob2JqICYmIF8uaGFzKG9iaiwgJ2NhbGxlZScpKTsKICAgIH07CiAgfQoKICAvLyBPcHRpbWl6ZSBgaXNGdW5jdGlvbmAgaWYgYXBwcm9wcmlhdGUuCiAgaWYgKHR5cGVvZiAoLy4vKSAhPT0gJ2Z1bmN0aW9uJykgewogICAgXy5pc0Z1bmN0aW9uID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnZnVuY3Rpb24nOwogICAgfTsKICB9CgogIC8vIElzIGEgZ2l2ZW4gb2JqZWN0IGEgZmluaXRlIG51bWJlcj8KICBfLmlzRmluaXRlID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc051bWJlcihvYmopICYmIGlzRmluaXRlKG9iaik7CiAgfTsKCiAgLy8gSXMgdGhlIGdpdmVuIHZhbHVlIGBOYU5gPyAoTmFOIGlzIHRoZSBvbmx5IG51bWJlciB3aGljaCBkb2VzIG5vdCBlcXVhbCBpdHNlbGYpLgogIF8uaXNOYU4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfLmlzTnVtYmVyKG9iaikgJiYgb2JqICE9ICtvYmo7CiAgfTsKCiAgLy8gSXMgYSBnaXZlbiB2YWx1ZSBhIGJvb2xlYW4/CiAgXy5pc0Jvb2xlYW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBvYmogPT09IHRydWUgfHwgb2JqID09PSBmYWxzZSB8fCB0b1N0cmluZy5jYWxsKG9iaikgPT0gJ1tvYmplY3QgQm9vbGVhbl0nOwogIH07CgogIC8vIElzIGEgZ2l2ZW4gdmFsdWUgZXF1YWwgdG8gbnVsbD8KICBfLmlzTnVsbCA9IGZ1bmN0aW9uKG9iaikgewogICAgcmV0dXJuIG9iaiA9PT0gbnVsbDsKICB9OwoKICAvLyBJcyBhIGdpdmVuIHZhcmlhYmxlIHVuZGVmaW5lZD8KICBfLmlzVW5kZWZpbmVkID0gZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gb2JqID09PSB2b2lkIDA7CiAgfTsKCiAgLy8gU2hvcnRjdXQgZnVuY3Rpb24gZm9yIGNoZWNraW5nIGlmIGFuIG9iamVjdCBoYXMgYSBnaXZlbiBwcm9wZXJ0eSBkaXJlY3RseQogIC8vIG9uIGl0c2VsZiAoaW4gb3RoZXIgd29yZHMsIG5vdCBvbiBhIHByb3RvdHlwZSkuCiAgXy5oYXMgPSBmdW5jdGlvbihvYmosIGtleSkgewogICAgcmV0dXJuIGhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpOwogIH07CgogIC8vIFV0aWxpdHkgRnVuY3Rpb25zCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0KCiAgLy8gUnVuIFVuZGVyc2NvcmUuanMgaW4gKm5vQ29uZmxpY3QqIG1vZGUsIHJldHVybmluZyB0aGUgYF9gIHZhcmlhYmxlIHRvIGl0cwogIC8vIHByZXZpb3VzIG93bmVyLiBSZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBVbmRlcnNjb3JlIG9iamVjdC4KICBfLm5vQ29uZmxpY3QgPSBmdW5jdGlvbigpIHsKICAgIHJvb3QuXyA9IHByZXZpb3VzVW5kZXJzY29yZTsKICAgIHJldHVybiB0aGlzOwogIH07CgogIC8vIEtlZXAgdGhlIGlkZW50aXR5IGZ1bmN0aW9uIGFyb3VuZCBmb3IgZGVmYXVsdCBpdGVyYXRvcnMuCiAgXy5pZGVudGl0eSA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfTsKCiAgLy8gUnVuIGEgZnVuY3Rpb24gKipuKiogdGltZXMuCiAgXy50aW1lcyA9IGZ1bmN0aW9uKG4sIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG47IGkrKykgaXRlcmF0b3IuY2FsbChjb250ZXh0LCBpKTsKICB9OwoKICAvLyBSZXR1cm4gYSByYW5kb20gaW50ZWdlciBiZXR3ZWVuIG1pbiBhbmQgbWF4IChpbmNsdXNpdmUpLgogIF8ucmFuZG9tID0gZnVuY3Rpb24obWluLCBtYXgpIHsKICAgIGlmIChtYXggPT0gbnVsbCkgewogICAgICBtYXggPSBtaW47CiAgICAgIG1pbiA9IDA7CiAgICB9CiAgICByZXR1cm4gbWluICsgKDAgfCBNYXRoLnJhbmRvbSgpICogKG1heCAtIG1pbiArIDEpKTsKICB9OwoKICAvLyBMaXN0IG9mIEhUTUwgZW50aXRpZXMgZm9yIGVzY2FwaW5nLgogIHZhciBlbnRpdHlNYXAgPSB7CiAgICBlc2NhcGU6IHsKICAgICAgJyYnOiAnJmFtcDsnLAogICAgICAnPCc6ICcmbHQ7JywKICAgICAgJz4nOiAnJmd0OycsCiAgICAgICciJzogJyZxdW90OycsCiAgICAgICInIjogJyYjeDI3OycsCiAgICAgICcvJzogJyYjeDJGOycKICAgIH0KICB9OwogIGVudGl0eU1hcC51bmVzY2FwZSA9IF8uaW52ZXJ0KGVudGl0eU1hcC5lc2NhcGUpOwoKICAvLyBSZWdleGVzIGNvbnRhaW5pbmcgdGhlIGtleXMgYW5kIHZhbHVlcyBsaXN0ZWQgaW1tZWRpYXRlbHkgYWJvdmUuCiAgdmFyIGVudGl0eVJlZ2V4ZXMgPSB7CiAgICBlc2NhcGU6ICAgbmV3IFJlZ0V4cCgnWycgKyBfLmtleXMoZW50aXR5TWFwLmVzY2FwZSkuam9pbignJykgKyAnXScsICdnJyksCiAgICB1bmVzY2FwZTogbmV3IFJlZ0V4cCgnKCcgKyBfLmtleXMoZW50aXR5TWFwLnVuZXNjYXBlKS5qb2luKCd8JykgKyAnKScsICdnJykKICB9OwoKICAvLyBGdW5jdGlvbnMgZm9yIGVzY2FwaW5nIGFuZCB1bmVzY2FwaW5nIHN0cmluZ3MgdG8vZnJvbSBIVE1MIGludGVycG9sYXRpb24uCiAgXy5lYWNoKFsnZXNjYXBlJywgJ3VuZXNjYXBlJ10sIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgX1ttZXRob2RdID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgIGlmIChzdHJpbmcgPT0gbnVsbCkgcmV0dXJuICcnOwogICAgICByZXR1cm4gKCcnICsgc3RyaW5nKS5yZXBsYWNlKGVudGl0eVJlZ2V4ZXNbbWV0aG9kXSwgZnVuY3Rpb24obWF0Y2gpIHsKICAgICAgICByZXR1cm4gZW50aXR5TWFwW21ldGhvZF1bbWF0Y2hdOwogICAgICB9KTsKICAgIH07CiAgfSk7CgogIC8vIElmIHRoZSB2YWx1ZSBvZiB0aGUgbmFtZWQgcHJvcGVydHkgaXMgYSBmdW5jdGlvbiB0aGVuIGludm9rZSBpdDsKICAvLyBvdGhlcndpc2UsIHJldHVybiBpdC4KICBfLnJlc3VsdCA9IGZ1bmN0aW9uKG9iamVjdCwgcHJvcGVydHkpIHsKICAgIGlmIChvYmplY3QgPT0gbnVsbCkgcmV0dXJuIG51bGw7CiAgICB2YXIgdmFsdWUgPSBvYmplY3RbcHJvcGVydHldOwogICAgcmV0dXJuIF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZS5jYWxsKG9iamVjdCkgOiB2YWx1ZTsKICB9OwoKICAvLyBBZGQgeW91ciBvd24gY3VzdG9tIGZ1bmN0aW9ucyB0byB0aGUgVW5kZXJzY29yZSBvYmplY3QuCiAgXy5taXhpbiA9IGZ1bmN0aW9uKG9iaikgewogICAgZWFjaChfLmZ1bmN0aW9ucyhvYmopLCBmdW5jdGlvbihuYW1lKXsKICAgICAgdmFyIGZ1bmMgPSBfW25hbWVdID0gb2JqW25hbWVdOwogICAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBhcmdzID0gW3RoaXMuX3dyYXBwZWRdOwogICAgICAgIHB1c2guYXBwbHkoYXJncywgYXJndW1lbnRzKTsKICAgICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgZnVuYy5hcHBseShfLCBhcmdzKSk7CiAgICAgIH07CiAgICB9KTsKICB9OwoKICAvLyBHZW5lcmF0ZSBhIHVuaXF1ZSBpbnRlZ2VyIGlkICh1bmlxdWUgd2l0aGluIHRoZSBlbnRpcmUgY2xpZW50IHNlc3Npb24pLgogIC8vIFVzZWZ1bCBmb3IgdGVtcG9yYXJ5IERPTSBpZHMuCiAgdmFyIGlkQ291bnRlciA9IDA7CiAgXy51bmlxdWVJZCA9IGZ1bmN0aW9uKHByZWZpeCkgewogICAgdmFyIGlkID0gaWRDb3VudGVyKys7CiAgICByZXR1cm4gcHJlZml4ID8gcHJlZml4ICsgaWQgOiBpZDsKICB9OwoKICAvLyBCeSBkZWZhdWx0LCBVbmRlcnNjb3JlIHVzZXMgRVJCLXN0eWxlIHRlbXBsYXRlIGRlbGltaXRlcnMsIGNoYW5nZSB0aGUKICAvLyBmb2xsb3dpbmcgdGVtcGxhdGUgc2V0dGluZ3MgdG8gdXNlIGFsdGVybmF0aXZlIGRlbGltaXRlcnMuCiAgXy50ZW1wbGF0ZVNldHRpbmdzID0gewogICAgZXZhbHVhdGUgICAgOiAvPCUoW1xzXFNdKz8pJT4vZywKICAgIGludGVycG9sYXRlIDogLzwlPShbXHNcU10rPyklPi9nLAogICAgZXNjYXBlICAgICAgOiAvPCUtKFtcc1xTXSs/KSU+L2cKICB9OwoKICAvLyBXaGVuIGN1c3RvbWl6aW5nIGB0ZW1wbGF0ZVNldHRpbmdzYCwgaWYgeW91IGRvbid0IHdhbnQgdG8gZGVmaW5lIGFuCiAgLy8gaW50ZXJwb2xhdGlvbiwgZXZhbHVhdGlvbiBvciBlc2NhcGluZyByZWdleCwgd2UgbmVlZCBvbmUgdGhhdCBpcwogIC8vIGd1YXJhbnRlZWQgbm90IHRvIG1hdGNoLgogIHZhciBub01hdGNoID0gLyguKV4vOwoKICAvLyBDZXJ0YWluIGNoYXJhY3RlcnMgbmVlZCB0byBiZSBlc2NhcGVkIHNvIHRoYXQgdGhleSBjYW4gYmUgcHV0IGludG8gYQogIC8vIHN0cmluZyBsaXRlcmFsLgogIHZhciBlc2NhcGVzID0gewogICAgIiciOiAgICAgICInIiwKICAgICdcXCc6ICAgICAnXFwnLAogICAgJ1xyJzogICAgICdyJywKICAgICdcbic6ICAgICAnbicsCiAgICAnXHQnOiAgICAgJ3QnLAogICAgJ1x1MjAyOCc6ICd1MjAyOCcsCiAgICAnXHUyMDI5JzogJ3UyMDI5JwogIH07CgogIHZhciBlc2NhcGVyID0gL1xcfCd8XHJ8XG58XHR8XHUyMDI4fFx1MjAyOS9nOwoKICAvLyBKYXZhU2NyaXB0IG1pY3JvLXRlbXBsYXRpbmcsIHNpbWlsYXIgdG8gSm9obiBSZXNpZydzIGltcGxlbWVudGF0aW9uLgogIC8vIFVuZGVyc2NvcmUgdGVtcGxhdGluZyBoYW5kbGVzIGFyYml0cmFyeSBkZWxpbWl0ZXJzLCBwcmVzZXJ2ZXMgd2hpdGVzcGFjZSwKICAvLyBhbmQgY29ycmVjdGx5IGVzY2FwZXMgcXVvdGVzIHdpdGhpbiBpbnRlcnBvbGF0ZWQgY29kZS4KICBfLnRlbXBsYXRlID0gZnVuY3Rpb24odGV4dCwgZGF0YSwgc2V0dGluZ3MpIHsKICAgIHNldHRpbmdzID0gXy5kZWZhdWx0cyh7fSwgc2V0dGluZ3MsIF8udGVtcGxhdGVTZXR0aW5ncyk7CgogICAgLy8gQ29tYmluZSBkZWxpbWl0ZXJzIGludG8gb25lIHJlZ3VsYXIgZXhwcmVzc2lvbiB2aWEgYWx0ZXJuYXRpb24uCiAgICB2YXIgbWF0Y2hlciA9IG5ldyBSZWdFeHAoWwogICAgICAoc2V0dGluZ3MuZXNjYXBlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmludGVycG9sYXRlIHx8IG5vTWF0Y2gpLnNvdXJjZSwKICAgICAgKHNldHRpbmdzLmV2YWx1YXRlIHx8IG5vTWF0Y2gpLnNvdXJjZQogICAgXS5qb2luKCd8JykgKyAnfCQnLCAnZycpOwoKICAgIC8vIENvbXBpbGUgdGhlIHRlbXBsYXRlIHNvdXJjZSwgZXNjYXBpbmcgc3RyaW5nIGxpdGVyYWxzIGFwcHJvcHJpYXRlbHkuCiAgICB2YXIgaW5kZXggPSAwOwogICAgdmFyIHNvdXJjZSA9ICJfX3ArPSciOwogICAgdGV4dC5yZXBsYWNlKG1hdGNoZXIsIGZ1bmN0aW9uKG1hdGNoLCBlc2NhcGUsIGludGVycG9sYXRlLCBldmFsdWF0ZSwgb2Zmc2V0KSB7CiAgICAgIHNvdXJjZSArPSB0ZXh0LnNsaWNlKGluZGV4LCBvZmZzZXQpCiAgICAgICAgLnJlcGxhY2UoZXNjYXBlciwgZnVuY3Rpb24obWF0Y2gpIHsgcmV0dXJuICdcXCcgKyBlc2NhcGVzW21hdGNoXTsgfSk7CiAgICAgIHNvdXJjZSArPQogICAgICAgIGVzY2FwZSA/ICInK1xuKChfX3Q9KCIgKyBlc2NhcGUgKyAiKSk9PW51bGw/Jyc6Xy5lc2NhcGUoX190KSkrXG4nIiA6CiAgICAgICAgaW50ZXJwb2xhdGUgPyAiJytcbigoX190PSgiICsgaW50ZXJwb2xhdGUgKyAiKSk9PW51bGw/Jyc6X190KStcbiciIDoKICAgICAgICBldmFsdWF0ZSA/ICInO1xuIiArIGV2YWx1YXRlICsgIlxuX19wKz0nIiA6ICcnOwogICAgICBpbmRleCA9IG9mZnNldCArIG1hdGNoLmxlbmd0aDsKICAgIH0pOwogICAgc291cmNlICs9ICInO1xuIjsKCiAgICAvLyBJZiBhIHZhcmlhYmxlIGlzIG5vdCBzcGVjaWZpZWQsIHBsYWNlIGRhdGEgdmFsdWVzIGluIGxvY2FsIHNjb3BlLgogICAgaWYgKCFzZXR0aW5ncy52YXJpYWJsZSkgc291cmNlID0gJ3dpdGgob2JqfHx7fSl7XG4nICsgc291cmNlICsgJ31cbic7CgogICAgc291cmNlID0gInZhciBfX3QsX19wPScnLF9faj1BcnJheS5wcm90b3R5cGUuam9pbiwiICsKICAgICAgInByaW50PWZ1bmN0aW9uKCl7X19wKz1fX2ouY2FsbChhcmd1bWVudHMsJycpO307XG4iICsKICAgICAgc291cmNlICsgInJldHVybiBfX3A7XG4iOwoKICAgIHRyeSB7CiAgICAgIHZhciByZW5kZXIgPSBuZXcgRnVuY3Rpb24oc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicsICdfJywgc291cmNlKTsKICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgZS5zb3VyY2UgPSBzb3VyY2U7CiAgICAgIHRocm93IGU7CiAgICB9CgogICAgaWYgKGRhdGEpIHJldHVybiByZW5kZXIoZGF0YSwgXyk7CiAgICB2YXIgdGVtcGxhdGUgPSBmdW5jdGlvbihkYXRhKSB7CiAgICAgIHJldHVybiByZW5kZXIuY2FsbCh0aGlzLCBkYXRhLCBfKTsKICAgIH07CgogICAgLy8gUHJvdmlkZSB0aGUgY29tcGlsZWQgZnVuY3Rpb24gc291cmNlIGFzIGEgY29udmVuaWVuY2UgZm9yIHByZWNvbXBpbGF0aW9uLgogICAgdGVtcGxhdGUuc291cmNlID0gJ2Z1bmN0aW9uKCcgKyAoc2V0dGluZ3MudmFyaWFibGUgfHwgJ29iaicpICsgJyl7XG4nICsgc291cmNlICsgJ30nOwoKICAgIHJldHVybiB0ZW1wbGF0ZTsKICB9OwoKICAvLyBBZGQgYSAiY2hhaW4iIGZ1bmN0aW9uLCB3aGljaCB3aWxsIGRlbGVnYXRlIHRvIHRoZSB3cmFwcGVyLgogIF8uY2hhaW4gPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiBfKG9iaikuY2hhaW4oKTsKICB9OwoKICAvLyBPT1AKICAvLyAtLS0tLS0tLS0tLS0tLS0KICAvLyBJZiBVbmRlcnNjb3JlIGlzIGNhbGxlZCBhcyBhIGZ1bmN0aW9uLCBpdCByZXR1cm5zIGEgd3JhcHBlZCBvYmplY3QgdGhhdAogIC8vIGNhbiBiZSB1c2VkIE9PLXN0eWxlLiBUaGlzIHdyYXBwZXIgaG9sZHMgYWx0ZXJlZCB2ZXJzaW9ucyBvZiBhbGwgdGhlCiAgLy8gdW5kZXJzY29yZSBmdW5jdGlvbnMuIFdyYXBwZWQgb2JqZWN0cyBtYXkgYmUgY2hhaW5lZC4KCiAgLy8gSGVscGVyIGZ1bmN0aW9uIHRvIGNvbnRpbnVlIGNoYWluaW5nIGludGVybWVkaWF0ZSByZXN1bHRzLgogIHZhciByZXN1bHQgPSBmdW5jdGlvbihvYmopIHsKICAgIHJldHVybiB0aGlzLl9jaGFpbiA/IF8ob2JqKS5jaGFpbigpIDogb2JqOwogIH07CgogIC8vIEFkZCBhbGwgb2YgdGhlIFVuZGVyc2NvcmUgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyIG9iamVjdC4KICBfLm1peGluKF8pOwoKICAvLyBBZGQgYWxsIG11dGF0b3IgQXJyYXkgZnVuY3Rpb25zIHRvIHRoZSB3cmFwcGVyLgogIGVhY2goWydwb3AnLCAncHVzaCcsICdyZXZlcnNlJywgJ3NoaWZ0JywgJ3NvcnQnLCAnc3BsaWNlJywgJ3Vuc2hpZnQnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICB2YXIgb2JqID0gdGhpcy5fd3JhcHBlZDsKICAgICAgbWV0aG9kLmFwcGx5KG9iaiwgYXJndW1lbnRzKTsKICAgICAgaWYgKChuYW1lID09ICdzaGlmdCcgfHwgbmFtZSA9PSAnc3BsaWNlJykgJiYgb2JqLmxlbmd0aCA9PT0gMCkgZGVsZXRlIG9ialswXTsKICAgICAgcmV0dXJuIHJlc3VsdC5jYWxsKHRoaXMsIG9iaik7CiAgICB9OwogIH0pOwoKICAvLyBBZGQgYWxsIGFjY2Vzc29yIEFycmF5IGZ1bmN0aW9ucyB0byB0aGUgd3JhcHBlci4KICBlYWNoKFsnY29uY2F0JywgJ2pvaW4nLCAnc2xpY2UnXSwgZnVuY3Rpb24obmFtZSkgewogICAgdmFyIG1ldGhvZCA9IEFycmF5UHJvdG9bbmFtZV07CiAgICBfLnByb3RvdHlwZVtuYW1lXSA9IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gcmVzdWx0LmNhbGwodGhpcywgbWV0aG9kLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cykpOwogICAgfTsKICB9KTsKCiAgXy5leHRlbmQoXy5wcm90b3R5cGUsIHsKCiAgICAvLyBTdGFydCBjaGFpbmluZyBhIHdyYXBwZWQgVW5kZXJzY29yZSBvYmplY3QuCiAgICBjaGFpbjogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuX2NoYWluID0gdHJ1ZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEV4dHJhY3RzIHRoZSByZXN1bHQgZnJvbSBhIHdyYXBwZWQgYW5kIGNoYWluZWQgb2JqZWN0LgogICAgdmFsdWU6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gdGhpcy5fd3JhcHBlZDsKICAgIH0KCiAgfSk7Cgp9KS5jYWxsKHRoaXMpOwoKLy8gICAgIEJhY2tib25lLmpzIDAuOS45CgovLyAgICAgKGMpIDIwMTAtMjAxMiBKZXJlbXkgQXNoa2VuYXMsIERvY3VtZW50Q2xvdWQgSW5jLgovLyAgICAgQmFja2JvbmUgbWF5IGJlIGZyZWVseSBkaXN0cmlidXRlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCi8vICAgICBGb3IgYWxsIGRldGFpbHMgYW5kIGRvY3VtZW50YXRpb246Ci8vICAgICBodHRwOi8vYmFja2JvbmVqcy5vcmcKCihmdW5jdGlvbigpewoKICAvLyBJbml0aWFsIFNldHVwCiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBTYXZlIGEgcmVmZXJlbmNlIHRvIHRoZSBnbG9iYWwgb2JqZWN0IChgd2luZG93YCBpbiB0aGUgYnJvd3NlciwgYGV4cG9ydHNgCiAgLy8gb24gdGhlIHNlcnZlcikuCiAgdmFyIHJvb3QgPSB0aGlzOwoKICAvLyBTYXZlIHRoZSBwcmV2aW91cyB2YWx1ZSBvZiB0aGUgYEJhY2tib25lYCB2YXJpYWJsZSwgc28gdGhhdCBpdCBjYW4gYmUKICAvLyByZXN0b3JlZCBsYXRlciBvbiwgaWYgYG5vQ29uZmxpY3RgIGlzIHVzZWQuCiAgdmFyIHByZXZpb3VzQmFja2JvbmUgPSByb290LkJhY2tib25lOwoKICAvLyBDcmVhdGUgYSBsb2NhbCByZWZlcmVuY2UgdG8gYXJyYXkgbWV0aG9kcy4KICB2YXIgYXJyYXkgPSBbXTsKICB2YXIgcHVzaCA9IGFycmF5LnB1c2g7CiAgdmFyIHNsaWNlID0gYXJyYXkuc2xpY2U7CiAgdmFyIHNwbGljZSA9IGFycmF5LnNwbGljZTsKCiAgLy8gVGhlIHRvcC1sZXZlbCBuYW1lc3BhY2UuIEFsbCBwdWJsaWMgQmFja2JvbmUgY2xhc3NlcyBhbmQgbW9kdWxlcyB3aWxsCiAgLy8gYmUgYXR0YWNoZWQgdG8gdGhpcy4gRXhwb3J0ZWQgZm9yIGJvdGggQ29tbW9uSlMgYW5kIHRoZSBicm93c2VyLgogIHZhciBCYWNrYm9uZTsKICBpZiAodHlwZW9mIGV4cG9ydHMgIT09ICd1bmRlZmluZWQnKSB7CiAgICBCYWNrYm9uZSA9IGV4cG9ydHM7CiAgfSBlbHNlIHsKICAgIEJhY2tib25lID0gcm9vdC5CYWNrYm9uZSA9IHt9OwogIH0KCiAgLy8gQ3VycmVudCB2ZXJzaW9uIG9mIHRoZSBsaWJyYXJ5LiBLZWVwIGluIHN5bmMgd2l0aCBgcGFja2FnZS5qc29uYC4KICBCYWNrYm9uZS5WRVJTSU9OID0gJzAuOS45JzsKCiAgLy8gUmVxdWlyZSBVbmRlcnNjb3JlLCBpZiB3ZSdyZSBvbiB0aGUgc2VydmVyLCBhbmQgaXQncyBub3QgYWxyZWFkeSBwcmVzZW50LgogIHZhciBfID0gcm9vdC5fOwogIGlmICghXyAmJiAodHlwZW9mIHJlcXVpcmUgIT09ICd1bmRlZmluZWQnKSkgXyA9IHJlcXVpcmUoJ3VuZGVyc2NvcmUnKTsKCiAgLy8gRm9yIEJhY2tib25lJ3MgcHVycG9zZXMsIGpRdWVyeSwgWmVwdG8sIG9yIEVuZGVyIG93bnMgdGhlIGAkYCB2YXJpYWJsZS4KICBCYWNrYm9uZS4kID0gcm9vdC5qUXVlcnkgfHwgcm9vdC5aZXB0byB8fCByb290LmVuZGVyOwoKICAvLyBSdW5zIEJhY2tib25lLmpzIGluICpub0NvbmZsaWN0KiBtb2RlLCByZXR1cm5pbmcgdGhlIGBCYWNrYm9uZWAgdmFyaWFibGUKICAvLyB0byBpdHMgcHJldmlvdXMgb3duZXIuIFJldHVybnMgYSByZWZlcmVuY2UgdG8gdGhpcyBCYWNrYm9uZSBvYmplY3QuCiAgQmFja2JvbmUubm9Db25mbGljdCA9IGZ1bmN0aW9uKCkgewogICAgcm9vdC5CYWNrYm9uZSA9IHByZXZpb3VzQmFja2JvbmU7CiAgICByZXR1cm4gdGhpczsKICB9OwoKICAvLyBUdXJuIG9uIGBlbXVsYXRlSFRUUGAgdG8gc3VwcG9ydCBsZWdhY3kgSFRUUCBzZXJ2ZXJzLiBTZXR0aW5nIHRoaXMgb3B0aW9uCiAgLy8gd2lsbCBmYWtlIGAiUFVUImAgYW5kIGAiREVMRVRFImAgcmVxdWVzdHMgdmlhIHRoZSBgX21ldGhvZGAgcGFyYW1ldGVyIGFuZAogIC8vIHNldCBhIGBYLUh0dHAtTWV0aG9kLU92ZXJyaWRlYCBoZWFkZXIuCiAgQmFja2JvbmUuZW11bGF0ZUhUVFAgPSBmYWxzZTsKCiAgLy8gVHVybiBvbiBgZW11bGF0ZUpTT05gIHRvIHN1cHBvcnQgbGVnYWN5IHNlcnZlcnMgdGhhdCBjYW4ndCBkZWFsIHdpdGggZGlyZWN0CiAgLy8gYGFwcGxpY2F0aW9uL2pzb25gIHJlcXVlc3RzIC4uLiB3aWxsIGVuY29kZSB0aGUgYm9keSBhcwogIC8vIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgIGluc3RlYWQgYW5kIHdpbGwgc2VuZCB0aGUgbW9kZWwgaW4gYQogIC8vIGZvcm0gcGFyYW0gbmFtZWQgYG1vZGVsYC4KICBCYWNrYm9uZS5lbXVsYXRlSlNPTiA9IGZhbHNlOwoKICAvLyBCYWNrYm9uZS5FdmVudHMKICAvLyAtLS0tLS0tLS0tLS0tLS0KCiAgLy8gUmVndWxhciBleHByZXNzaW9uIHVzZWQgdG8gc3BsaXQgZXZlbnQgc3RyaW5ncy4KICB2YXIgZXZlbnRTcGxpdHRlciA9IC9ccysvOwoKICAvLyBJbXBsZW1lbnQgZmFuY3kgZmVhdHVyZXMgb2YgdGhlIEV2ZW50cyBBUEkgc3VjaCBhcyBtdWx0aXBsZSBldmVudAogIC8vIG5hbWVzIGAiY2hhbmdlIGJsdXIiYCBhbmQgalF1ZXJ5LXN0eWxlIGV2ZW50IG1hcHMgYHtjaGFuZ2U6IGFjdGlvbn1gCiAgLy8gaW4gdGVybXMgb2YgdGhlIGV4aXN0aW5nIEFQSS4KICB2YXIgZXZlbnRzQXBpID0gZnVuY3Rpb24ob2JqLCBhY3Rpb24sIG5hbWUsIHJlc3QpIHsKICAgIGlmICghbmFtZSkgcmV0dXJuIHRydWU7CiAgICBpZiAodHlwZW9mIG5hbWUgPT09ICdvYmplY3QnKSB7CiAgICAgIGZvciAodmFyIGtleSBpbiBuYW1lKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBba2V5LCBuYW1lW2tleV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZXZlbnRTcGxpdHRlci50ZXN0KG5hbWUpKSB7CiAgICAgIHZhciBuYW1lcyA9IG5hbWUuc3BsaXQoZXZlbnRTcGxpdHRlcik7CiAgICAgIGZvciAodmFyIGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgb2JqW2FjdGlvbl0uYXBwbHkob2JqLCBbbmFtZXNbaV1dLmNvbmNhdChyZXN0KSk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0cnVlOwogICAgfQogIH07CgogIC8vIE9wdGltaXplZCBpbnRlcm5hbCBkaXNwYXRjaCBmdW5jdGlvbiBmb3IgdHJpZ2dlcmluZyBldmVudHMuIFRyaWVzIHRvCiAgLy8ga2VlcCB0aGUgdXN1YWwgY2FzZXMgc3BlZWR5IChtb3N0IEJhY2tib25lIGV2ZW50cyBoYXZlIDMgYXJndW1lbnRzKS4KICB2YXIgdHJpZ2dlckV2ZW50cyA9IGZ1bmN0aW9uKG9iaiwgZXZlbnRzLCBhcmdzKSB7CiAgICB2YXIgZXYsIGkgPSAtMSwgbCA9IGV2ZW50cy5sZW5ndGg7CiAgICBzd2l0Y2ggKGFyZ3MubGVuZ3RoKSB7CiAgICBjYXNlIDA6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4KTsKICAgIHJldHVybjsKICAgIGNhc2UgMTogd2hpbGUgKCsraSA8IGwpIChldiA9IGV2ZW50c1tpXSkuY2FsbGJhY2suY2FsbChldi5jdHgsIGFyZ3NbMF0pOwogICAgcmV0dXJuOwogICAgY2FzZSAyOiB3aGlsZSAoKytpIDwgbCkgKGV2ID0gZXZlbnRzW2ldKS5jYWxsYmFjay5jYWxsKGV2LmN0eCwgYXJnc1swXSwgYXJnc1sxXSk7CiAgICByZXR1cm47CiAgICBjYXNlIDM6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmNhbGwoZXYuY3R4LCBhcmdzWzBdLCBhcmdzWzFdLCBhcmdzWzJdKTsKICAgIHJldHVybjsKICAgIGRlZmF1bHQ6IHdoaWxlICgrK2kgPCBsKSAoZXYgPSBldmVudHNbaV0pLmNhbGxiYWNrLmFwcGx5KGV2LmN0eCwgYXJncyk7CiAgICB9CiAgfTsKCiAgLy8gQSBtb2R1bGUgdGhhdCBjYW4gYmUgbWl4ZWQgaW4gdG8gKmFueSBvYmplY3QqIGluIG9yZGVyIHRvIHByb3ZpZGUgaXQgd2l0aAogIC8vIGN1c3RvbSBldmVudHMuIFlvdSBtYXkgYmluZCB3aXRoIGBvbmAgb3IgcmVtb3ZlIHdpdGggYG9mZmAgY2FsbGJhY2sKICAvLyBmdW5jdGlvbnMgdG8gYW4gZXZlbnQ7IGB0cmlnZ2VyYC1pbmcgYW4gZXZlbnQgZmlyZXMgYWxsIGNhbGxiYWNrcyBpbgogIC8vIHN1Y2Nlc3Npb24uCiAgLy8KICAvLyAgICAgdmFyIG9iamVjdCA9IHt9OwogIC8vICAgICBfLmV4dGVuZChvYmplY3QsIEJhY2tib25lLkV2ZW50cyk7CiAgLy8gICAgIG9iamVjdC5vbignZXhwYW5kJywgZnVuY3Rpb24oKXsgYWxlcnQoJ2V4cGFuZGVkJyk7IH0pOwogIC8vICAgICBvYmplY3QudHJpZ2dlcignZXhwYW5kJyk7CiAgLy8KICB2YXIgRXZlbnRzID0gQmFja2JvbmUuRXZlbnRzID0gewoKICAgIC8vIEJpbmQgb25lIG9yIG1vcmUgc3BhY2Ugc2VwYXJhdGVkIGV2ZW50cywgb3IgYW4gZXZlbnRzIG1hcCwKICAgIC8vIHRvIGEgYGNhbGxiYWNrYCBmdW5jdGlvbi4gUGFzc2luZyBgImFsbCJgIHdpbGwgYmluZCB0aGUgY2FsbGJhY2sgdG8KICAgIC8vIGFsbCBldmVudHMgZmlyZWQuCiAgICBvbjogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbicsIG5hbWUsIFtjYWxsYmFjaywgY29udGV4dF0pICYmIGNhbGxiYWNrKSkgcmV0dXJuIHRoaXM7CiAgICAgIHRoaXMuX2V2ZW50cyB8fCAodGhpcy5fZXZlbnRzID0ge30pOwogICAgICB2YXIgbGlzdCA9IHRoaXMuX2V2ZW50c1tuYW1lXSB8fCAodGhpcy5fZXZlbnRzW25hbWVdID0gW10pOwogICAgICBsaXN0LnB1c2goe2NhbGxiYWNrOiBjYWxsYmFjaywgY29udGV4dDogY29udGV4dCwgY3R4OiBjb250ZXh0IHx8IHRoaXN9KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEJpbmQgZXZlbnRzIHRvIG9ubHkgYmUgdHJpZ2dlcmVkIGEgc2luZ2xlIHRpbWUuIEFmdGVyIHRoZSBmaXJzdCB0aW1lCiAgICAvLyB0aGUgY2FsbGJhY2sgaXMgaW52b2tlZCwgaXQgd2lsbCBiZSByZW1vdmVkLgogICAgb25jZTogZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgICAgaWYgKCEoZXZlbnRzQXBpKHRoaXMsICdvbmNlJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkgJiYgY2FsbGJhY2spKSByZXR1cm4gdGhpczsKICAgICAgdmFyIHNlbGYgPSB0aGlzOwogICAgICB2YXIgb25jZSA9IF8ub25jZShmdW5jdGlvbigpIHsKICAgICAgICBzZWxmLm9mZihuYW1lLCBvbmNlKTsKICAgICAgICBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICB9KTsKICAgICAgb25jZS5fY2FsbGJhY2sgPSBjYWxsYmFjazsKICAgICAgdGhpcy5vbihuYW1lLCBvbmNlLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBvbmUgb3IgbWFueSBjYWxsYmFja3MuIElmIGBjb250ZXh0YCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIHdpdGggdGhhdCBmdW5jdGlvbi4gSWYgYGNhbGxiYWNrYCBpcyBudWxsLCByZW1vdmVzIGFsbAogICAgLy8gY2FsbGJhY2tzIGZvciB0aGUgZXZlbnQuIElmIGBldmVudHNgIGlzIG51bGwsIHJlbW92ZXMgYWxsIGJvdW5kCiAgICAvLyBjYWxsYmFja3MgZm9yIGFsbCBldmVudHMuCiAgICBvZmY6IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBjb250ZXh0KSB7CiAgICAgIHZhciBsaXN0LCBldiwgZXZlbnRzLCBuYW1lcywgaSwgbCwgaiwgazsKICAgICAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIWV2ZW50c0FwaSh0aGlzLCAnb2ZmJywgbmFtZSwgW2NhbGxiYWNrLCBjb250ZXh0XSkpIHJldHVybiB0aGlzOwogICAgICBpZiAoIW5hbWUgJiYgIWNhbGxiYWNrICYmICFjb250ZXh0KSB7CiAgICAgICAgdGhpcy5fZXZlbnRzID0ge307CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KCiAgICAgIG5hbWVzID0gbmFtZSA/IFtuYW1lXSA6IF8ua2V5cyh0aGlzLl9ldmVudHMpOwogICAgICBmb3IgKGkgPSAwLCBsID0gbmFtZXMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbmFtZSA9IG5hbWVzW2ldOwogICAgICAgIGlmIChsaXN0ID0gdGhpcy5fZXZlbnRzW25hbWVdKSB7CiAgICAgICAgICBldmVudHMgPSBbXTsKICAgICAgICAgIGlmIChjYWxsYmFjayB8fCBjb250ZXh0KSB7CiAgICAgICAgICAgIGZvciAoaiA9IDAsIGsgPSBsaXN0Lmxlbmd0aDsgaiA8IGs7IGorKykgewogICAgICAgICAgICAgIGV2ID0gbGlzdFtqXTsKICAgICAgICAgICAgICBpZiAoKGNhbGxiYWNrICYmIGNhbGxiYWNrICE9PSAoZXYuY2FsbGJhY2suX2NhbGxiYWNrIHx8IGV2LmNhbGxiYWNrKSkgfHwKICAgICAgICAgICAgICAgICAgKGNvbnRleHQgJiYgY29udGV4dCAhPT0gZXYuY29udGV4dCkpIHsKICAgICAgICAgICAgICAgIGV2ZW50cy5wdXNoKGV2KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHRoaXMuX2V2ZW50c1tuYW1lXSA9IGV2ZW50czsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBUcmlnZ2VyIG9uZSBvciBtYW55IGV2ZW50cywgZmlyaW5nIGFsbCBib3VuZCBjYWxsYmFja3MuIENhbGxiYWNrcyBhcmUKICAgIC8vIHBhc3NlZCB0aGUgc2FtZSBhcmd1bWVudHMgYXMgYHRyaWdnZXJgIGlzLCBhcGFydCBmcm9tIHRoZSBldmVudCBuYW1lCiAgICAvLyAodW5sZXNzIHlvdSdyZSBsaXN0ZW5pbmcgb24gYCJhbGwiYCwgd2hpY2ggd2lsbCBjYXVzZSB5b3VyIGNhbGxiYWNrIHRvCiAgICAvLyByZWNlaXZlIHRoZSB0cnVlIG5hbWUgb2YgdGhlIGV2ZW50IGFzIHRoZSBmaXJzdCBhcmd1bWVudCkuCiAgICB0cmlnZ2VyOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgIGlmICghdGhpcy5fZXZlbnRzKSByZXR1cm4gdGhpczsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CiAgICAgIGlmICghZXZlbnRzQXBpKHRoaXMsICd0cmlnZ2VyJywgbmFtZSwgYXJncykpIHJldHVybiB0aGlzOwogICAgICB2YXIgZXZlbnRzID0gdGhpcy5fZXZlbnRzW25hbWVdOwogICAgICB2YXIgYWxsRXZlbnRzID0gdGhpcy5fZXZlbnRzLmFsbDsKICAgICAgaWYgKGV2ZW50cykgdHJpZ2dlckV2ZW50cyh0aGlzLCBldmVudHMsIGFyZ3MpOwogICAgICBpZiAoYWxsRXZlbnRzKSB0cmlnZ2VyRXZlbnRzKHRoaXMsIGFsbEV2ZW50cywgYXJndW1lbnRzKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEFuIGludmVyc2lvbi1vZi1jb250cm9sIHZlcnNpb24gb2YgYG9uYC4gVGVsbCAqdGhpcyogb2JqZWN0IHRvIGxpc3RlbiB0bwogICAgLy8gYW4gZXZlbnQgaW4gYW5vdGhlciBvYmplY3QgLi4uIGtlZXBpbmcgdHJhY2sgb2Ygd2hhdCBpdCdzIGxpc3RlbmluZyB0by4KICAgIGxpc3RlblRvOiBmdW5jdGlvbihvYmplY3QsIGV2ZW50cywgY2FsbGJhY2spIHsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVycyB8fCAodGhpcy5fbGlzdGVuZXJzID0ge30pOwogICAgICB2YXIgaWQgPSBvYmplY3QuX2xpc3RlbmVySWQgfHwgKG9iamVjdC5fbGlzdGVuZXJJZCA9IF8udW5pcXVlSWQoJ2wnKSk7CiAgICAgIGxpc3RlbmVyc1tpZF0gPSBvYmplY3Q7CiAgICAgIG9iamVjdC5vbihldmVudHMsIGNhbGxiYWNrIHx8IHRoaXMsIHRoaXMpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gVGVsbCB0aGlzIG9iamVjdCB0byBzdG9wIGxpc3RlbmluZyB0byBlaXRoZXIgc3BlY2lmaWMgZXZlbnRzIC4uLiBvcgogICAgLy8gdG8gZXZlcnkgb2JqZWN0IGl0J3MgY3VycmVudGx5IGxpc3RlbmluZyB0by4KICAgIHN0b3BMaXN0ZW5pbmc6IGZ1bmN0aW9uKG9iamVjdCwgZXZlbnRzLCBjYWxsYmFjaykgewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fbGlzdGVuZXJzOwogICAgICBpZiAoIWxpc3RlbmVycykgcmV0dXJuOwogICAgICBpZiAob2JqZWN0KSB7CiAgICAgICAgb2JqZWN0Lm9mZihldmVudHMsIGNhbGxiYWNrLCB0aGlzKTsKICAgICAgICBpZiAoIWV2ZW50cyAmJiAhY2FsbGJhY2spIGRlbGV0ZSBsaXN0ZW5lcnNbb2JqZWN0Ll9saXN0ZW5lcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICBmb3IgKHZhciBpZCBpbiBsaXN0ZW5lcnMpIHsKICAgICAgICAgIGxpc3RlbmVyc1tpZF0ub2ZmKG51bGwsIG51bGwsIHRoaXMpOwogICAgICAgIH0KICAgICAgICB0aGlzLl9saXN0ZW5lcnMgPSB7fTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0KICB9OwoKICAvLyBBbGlhc2VzIGZvciBiYWNrd2FyZHMgY29tcGF0aWJpbGl0eS4KICBFdmVudHMuYmluZCAgID0gRXZlbnRzLm9uOwogIEV2ZW50cy51bmJpbmQgPSBFdmVudHMub2ZmOwoKICAvLyBBbGxvdyB0aGUgYEJhY2tib25lYCBvYmplY3QgdG8gc2VydmUgYXMgYSBnbG9iYWwgZXZlbnQgYnVzLCBmb3IgZm9sa3Mgd2hvCiAgLy8gd2FudCBnbG9iYWwgInB1YnN1YiIgaW4gYSBjb252ZW5pZW50IHBsYWNlLgogIF8uZXh0ZW5kKEJhY2tib25lLCBFdmVudHMpOwoKICAvLyBCYWNrYm9uZS5Nb2RlbAogIC8vIC0tLS0tLS0tLS0tLS0tCgogIC8vIENyZWF0ZSBhIG5ldyBtb2RlbCwgd2l0aCBkZWZpbmVkIGF0dHJpYnV0ZXMuIEEgY2xpZW50IGlkIChgY2lkYCkKICAvLyBpcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBhbmQgYXNzaWduZWQgZm9yIHlvdS4KICB2YXIgTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbCA9IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIG9wdGlvbnMpIHsKICAgIHZhciBkZWZhdWx0czsKICAgIHZhciBhdHRycyA9IGF0dHJpYnV0ZXMgfHwge307CiAgICB0aGlzLmNpZCA9IF8udW5pcXVlSWQoJ2MnKTsKICAgIHRoaXMuY2hhbmdlZCA9IHt9OwogICAgdGhpcy5hdHRyaWJ1dGVzID0ge307CiAgICB0aGlzLl9jaGFuZ2VzID0gW107CiAgICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLmNvbGxlY3Rpb24pIHRoaXMuY29sbGVjdGlvbiA9IG9wdGlvbnMuY29sbGVjdGlvbjsKICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMucGFyc2UpIGF0dHJzID0gdGhpcy5wYXJzZShhdHRycyk7CiAgICBpZiAoZGVmYXVsdHMgPSBfLnJlc3VsdCh0aGlzLCAnZGVmYXVsdHMnKSkgXy5kZWZhdWx0cyhhdHRycywgZGVmYXVsdHMpOwogICAgdGhpcy5zZXQoYXR0cnMsIHtzaWxlbnQ6IHRydWV9KTsKICAgIHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfTsKCiAgLy8gQXR0YWNoIGFsbCBpbmhlcml0YWJsZSBtZXRob2RzIHRvIHRoZSBNb2RlbCBwcm90b3R5cGUuCiAgXy5leHRlbmQoTW9kZWwucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBBIGhhc2ggb2YgYXR0cmlidXRlcyB3aG9zZSBjdXJyZW50IGFuZCBwcmV2aW91cyB2YWx1ZSBkaWZmZXIuCiAgICBjaGFuZ2VkOiBudWxsLAoKICAgIC8vIFRoZSBkZWZhdWx0IG5hbWUgZm9yIHRoZSBKU09OIGBpZGAgYXR0cmlidXRlIGlzIGAiaWQiYC4gTW9uZ29EQiBhbmQKICAgIC8vIENvdWNoREIgdXNlcnMgbWF5IHdhbnQgdG8gc2V0IHRoaXMgdG8gYCJfaWQiYC4KICAgIGlkQXR0cmlidXRlOiAnaWQnLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gUmV0dXJuIGEgY29weSBvZiB0aGUgbW9kZWwncyBgYXR0cmlidXRlc2Agb2JqZWN0LgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiBfLmNsb25lKHRoaXMuYXR0cmlidXRlcyk7CiAgICB9LAoKICAgIC8vIFByb3h5IGBCYWNrYm9uZS5zeW5jYCBieSBkZWZhdWx0LgogICAgc3luYzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBCYWNrYm9uZS5zeW5jLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgdmFsdWUgb2YgYW4gYXR0cmlidXRlLgogICAgZ2V0OiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbYXR0cl07CiAgICB9LAoKICAgIC8vIEdldCB0aGUgSFRNTC1lc2NhcGVkIHZhbHVlIG9mIGFuIGF0dHJpYnV0ZS4KICAgIGVzY2FwZTogZnVuY3Rpb24oYXR0cikgewogICAgICByZXR1cm4gXy5lc2NhcGUodGhpcy5nZXQoYXR0cikpOwogICAgfSwKCiAgICAvLyBSZXR1cm5zIGB0cnVlYCBpZiB0aGUgYXR0cmlidXRlIGNvbnRhaW5zIGEgdmFsdWUgdGhhdCBpcyBub3QgbnVsbAogICAgLy8gb3IgdW5kZWZpbmVkLgogICAgaGFzOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIHJldHVybiB0aGlzLmdldChhdHRyKSAhPSBudWxsOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMgb24gdGhlIG9iamVjdCwgZmlyaW5nIGAiY2hhbmdlImAgdW5sZXNzCiAgICAvLyB5b3UgY2hvb3NlIHRvIHNpbGVuY2UgaXQuCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBvcHRpb25zKSB7CiAgICAgIHZhciBhdHRyLCBhdHRyczsKICAgICAgaWYgKGtleSA9PSBudWxsKSByZXR1cm4gdGhpczsKCiAgICAgIC8vIEhhbmRsZSBib3RoIGAia2V5IiwgdmFsdWVgIGFuZCBge2tleTogdmFsdWV9YCAtc3R5bGUgYXJndW1lbnRzLgogICAgICBpZiAoXy5pc09iamVjdChrZXkpKSB7CiAgICAgICAgYXR0cnMgPSBrZXk7CiAgICAgICAgb3B0aW9ucyA9IHZhbDsKICAgICAgfSBlbHNlIHsKICAgICAgICAoYXR0cnMgPSB7fSlba2V5XSA9IHZhbDsKICAgICAgfQoKICAgICAgLy8gRXh0cmFjdCBhdHRyaWJ1dGVzIGFuZCBvcHRpb25zLgogICAgICB2YXIgc2lsZW50ID0gb3B0aW9ucyAmJiBvcHRpb25zLnNpbGVudDsKICAgICAgdmFyIHVuc2V0ID0gb3B0aW9ucyAmJiBvcHRpb25zLnVuc2V0OwoKICAgICAgLy8gUnVuIHZhbGlkYXRpb24uCiAgICAgIGlmICghdGhpcy5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CgogICAgICAvLyBDaGVjayBmb3IgY2hhbmdlcyBvZiBgaWRgLgogICAgICBpZiAodGhpcy5pZEF0dHJpYnV0ZSBpbiBhdHRycykgdGhpcy5pZCA9IGF0dHJzW3RoaXMuaWRBdHRyaWJ1dGVdOwoKICAgICAgdmFyIG5vdyA9IHRoaXMuYXR0cmlidXRlczsKCiAgICAgIC8vIEZvciBlYWNoIGBzZXRgIGF0dHJpYnV0ZS4uLgogICAgICBmb3IgKGF0dHIgaW4gYXR0cnMpIHsKICAgICAgICB2YWwgPSBhdHRyc1thdHRyXTsKCiAgICAgICAgLy8gVXBkYXRlIG9yIGRlbGV0ZSB0aGUgY3VycmVudCB2YWx1ZSwgYW5kIHRyYWNrIHRoZSBjaGFuZ2UuCiAgICAgICAgdW5zZXQgPyBkZWxldGUgbm93W2F0dHJdIDogbm93W2F0dHJdID0gdmFsOwogICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaChhdHRyLCB2YWwpOwogICAgICB9CgogICAgICAvLyBTaWduYWwgdGhhdCB0aGUgbW9kZWwncyBzdGF0ZSBoYXMgcG90ZW50aWFsbHkgY2hhbmdlZCwgYW5kIHdlIG5lZWQKICAgICAgLy8gdG8gcmVjb21wdXRlIHRoZSBhY3R1YWwgY2hhbmdlcy4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSBmYWxzZTsKCiAgICAgIC8vIEZpcmUgdGhlIGAiY2hhbmdlImAgZXZlbnRzLgogICAgICBpZiAoIXNpbGVudCkgdGhpcy5jaGFuZ2Uob3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBSZW1vdmUgYW4gYXR0cmlidXRlIGZyb20gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4gYHVuc2V0YCBpcyBhIG5vb3AgaWYgdGhlIGF0dHJpYnV0ZSBkb2Vzbid0IGV4aXN0LgogICAgdW5zZXQ6IGZ1bmN0aW9uKGF0dHIsIG9wdGlvbnMpIHsKICAgICAgcmV0dXJuIHRoaXMuc2V0KGF0dHIsIHZvaWQgMCwgXy5leHRlbmQoe30sIG9wdGlvbnMsIHt1bnNldDogdHJ1ZX0pKTsKICAgIH0sCgogICAgLy8gQ2xlYXIgYWxsIGF0dHJpYnV0ZXMgb24gdGhlIG1vZGVsLCBmaXJpbmcgYCJjaGFuZ2UiYCB1bmxlc3MgeW91IGNob29zZQogICAgLy8gdG8gc2lsZW5jZSBpdC4KICAgIGNsZWFyOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBhdHRycyA9IHt9OwogICAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5hdHRyaWJ1dGVzKSBhdHRyc1trZXldID0gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5zZXQoYXR0cnMsIF8uZXh0ZW5kKHt9LCBvcHRpb25zLCB7dW5zZXQ6IHRydWV9KSk7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBtb2RlbCBmcm9tIHRoZSBzZXJ2ZXIuIElmIHRoZSBzZXJ2ZXIncyByZXByZXNlbnRhdGlvbiBvZiB0aGUKICAgIC8vIG1vZGVsIGRpZmZlcnMgZnJvbSBpdHMgY3VycmVudCBhdHRyaWJ1dGVzLCB0aGV5IHdpbGwgYmUgb3ZlcnJpZGVuLAogICAgLy8gdHJpZ2dlcmluZyBhIGAiY2hhbmdlImAgZXZlbnQuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGlmICghbW9kZWwuc2V0KG1vZGVsLnBhcnNlKHJlc3ApLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBTZXQgYSBoYXNoIG9mIG1vZGVsIGF0dHJpYnV0ZXMsIGFuZCBzeW5jIHRoZSBtb2RlbCB0byB0aGUgc2VydmVyLgogICAgLy8gSWYgdGhlIHNlcnZlciByZXR1cm5zIGFuIGF0dHJpYnV0ZXMgaGFzaCB0aGF0IGRpZmZlcnMsIHRoZSBtb2RlbCdzCiAgICAvLyBzdGF0ZSB3aWxsIGJlIGBzZXRgIGFnYWluLgogICAgc2F2ZTogZnVuY3Rpb24oa2V5LCB2YWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGF0dHJzLCBjdXJyZW50LCBkb25lOwoKICAgICAgLy8gSGFuZGxlIGJvdGggYCJrZXkiLCB2YWx1ZWAgYW5kIGB7a2V5OiB2YWx1ZX1gIC1zdHlsZSBhcmd1bWVudHMuCiAgICAgIGlmIChrZXkgPT0gbnVsbCB8fCBfLmlzT2JqZWN0KGtleSkpIHsKICAgICAgICBhdHRycyA9IGtleTsKICAgICAgICBvcHRpb25zID0gdmFsOwogICAgICB9IGVsc2UgaWYgKGtleSAhPSBudWxsKSB7CiAgICAgICAgKGF0dHJzID0ge30pW2tleV0gPSB2YWw7CiAgICAgIH0KICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CgogICAgICAvLyBJZiB3ZSdyZSAid2FpdCItaW5nIHRvIHNldCBjaGFuZ2VkIGF0dHJpYnV0ZXMsIHZhbGlkYXRlIGVhcmx5LgogICAgICBpZiAob3B0aW9ucy53YWl0KSB7CiAgICAgICAgaWYgKGF0dHJzICYmICF0aGlzLl92YWxpZGF0ZShhdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBjdXJyZW50ID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpOwogICAgICB9CgogICAgICAvLyBSZWd1bGFyIHNhdmVzIGBzZXRgIGF0dHJpYnV0ZXMgYmVmb3JlIHBlcnNpc3RpbmcgdG8gdGhlIHNlcnZlci4KICAgICAgdmFyIHNpbGVudE9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgb3B0aW9ucywge3NpbGVudDogdHJ1ZX0pOwogICAgICBpZiAoYXR0cnMgJiYgIXRoaXMuc2V0KGF0dHJzLCBvcHRpb25zLndhaXQgPyBzaWxlbnRPcHRpb25zIDogb3B0aW9ucykpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIC8vIERvIG5vdCBwZXJzaXN0IGludmFsaWQgbW9kZWxzLgogICAgICBpZiAoIWF0dHJzICYmICF0aGlzLl92YWxpZGF0ZShudWxsLCBvcHRpb25zKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgLy8gQWZ0ZXIgYSBzdWNjZXNzZnVsIHNlcnZlci1zaWRlIHNhdmUsIHRoZSBjbGllbnQgaXMgKG9wdGlvbmFsbHkpCiAgICAgIC8vIHVwZGF0ZWQgd2l0aCB0aGUgc2VydmVyLXNpZGUgc3RhdGUuCiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihyZXNwLCBzdGF0dXMsIHhocikgewogICAgICAgIGRvbmUgPSB0cnVlOwogICAgICAgIHZhciBzZXJ2ZXJBdHRycyA9IG1vZGVsLnBhcnNlKHJlc3ApOwogICAgICAgIGlmIChvcHRpb25zLndhaXQpIHNlcnZlckF0dHJzID0gXy5leHRlbmQoYXR0cnMgfHwge30sIHNlcnZlckF0dHJzKTsKICAgICAgICBpZiAoIW1vZGVsLnNldChzZXJ2ZXJBdHRycywgb3B0aW9ucykpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CgogICAgICAvLyBGaW5pc2ggY29uZmlndXJpbmcgYW5kIHNlbmRpbmcgdGhlIEFqYXggcmVxdWVzdC4KICAgICAgdmFyIG1ldGhvZCA9IHRoaXMuaXNOZXcoKSA/ICdjcmVhdGUnIDogKG9wdGlvbnMucGF0Y2ggPyAncGF0Y2gnIDogJ3VwZGF0ZScpOwogICAgICBpZiAobWV0aG9kID09ICdwYXRjaCcpIG9wdGlvbnMuYXR0cnMgPSBhdHRyczsKICAgICAgdmFyIHhociA9IHRoaXMuc3luYyhtZXRob2QsIHRoaXMsIG9wdGlvbnMpOwoKICAgICAgLy8gV2hlbiB1c2luZyBgd2FpdGAsIHJlc2V0IGF0dHJpYnV0ZXMgdG8gb3JpZ2luYWwgdmFsdWVzIHVubGVzcwogICAgICAvLyBgc3VjY2Vzc2AgaGFzIGJlZW4gY2FsbGVkIGFscmVhZHkuCiAgICAgIGlmICghZG9uZSAmJiBvcHRpb25zLndhaXQpIHsKICAgICAgICB0aGlzLmNsZWFyKHNpbGVudE9wdGlvbnMpOwogICAgICAgIHRoaXMuc2V0KGN1cnJlbnQsIHNpbGVudE9wdGlvbnMpOwogICAgICB9CgogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZXN0cm95IHRoaXMgbW9kZWwgb24gdGhlIHNlcnZlciBpZiBpdCB3YXMgYWxyZWFkeSBwZXJzaXN0ZWQuCiAgICAvLyBPcHRpbWlzdGljYWxseSByZW1vdmVzIHRoZSBtb2RlbCBmcm9tIGl0cyBjb2xsZWN0aW9uLCBpZiBpdCBoYXMgb25lLgogICAgLy8gSWYgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgd2FpdHMgZm9yIHRoZSBzZXJ2ZXIgdG8gcmVzcG9uZCBiZWZvcmUgcmVtb3ZhbC4KICAgIGRlc3Ryb3k6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgPyBfLmNsb25lKG9wdGlvbnMpIDoge307CiAgICAgIHZhciBtb2RlbCA9IHRoaXM7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwoKICAgICAgdmFyIGRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgICAgICBtb2RlbC50cmlnZ2VyKCdkZXN0cm95JywgbW9kZWwsIG1vZGVsLmNvbGxlY3Rpb24sIG9wdGlvbnMpOwogICAgICB9OwoKICAgICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCkgewogICAgICAgIGlmIChvcHRpb25zLndhaXQgfHwgbW9kZWwuaXNOZXcoKSkgZGVzdHJveSgpOwogICAgICAgIGlmIChzdWNjZXNzKSBzdWNjZXNzKG1vZGVsLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmlzTmV3KCkpIHsKICAgICAgICBvcHRpb25zLnN1Y2Nlc3MoKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHZhciB4aHIgPSB0aGlzLnN5bmMoJ2RlbGV0ZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICBpZiAoIW9wdGlvbnMud2FpdCkgZGVzdHJveSgpOwogICAgICByZXR1cm4geGhyOwogICAgfSwKCiAgICAvLyBEZWZhdWx0IFVSTCBmb3IgdGhlIG1vZGVsJ3MgcmVwcmVzZW50YXRpb24gb24gdGhlIHNlcnZlciAtLSBpZiB5b3UncmUKICAgIC8vIHVzaW5nIEJhY2tib25lJ3MgcmVzdGZ1bCBtZXRob2RzLCBvdmVycmlkZSB0aGlzIHRvIGNoYW5nZSB0aGUgZW5kcG9pbnQKICAgIC8vIHRoYXQgd2lsbCBiZSBjYWxsZWQuCiAgICB1cmw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgYmFzZSA9IF8ucmVzdWx0KHRoaXMsICd1cmxSb290JykgfHwgXy5yZXN1bHQodGhpcy5jb2xsZWN0aW9uLCAndXJsJykgfHwgdXJsRXJyb3IoKTsKICAgICAgaWYgKHRoaXMuaXNOZXcoKSkgcmV0dXJuIGJhc2U7CiAgICAgIHJldHVybiBiYXNlICsgKGJhc2UuY2hhckF0KGJhc2UubGVuZ3RoIC0gMSkgPT09ICcvJyA/ICcnIDogJy8nKSArIGVuY29kZVVSSUNvbXBvbmVudCh0aGlzLmlkKTsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byB0aGUgaGFzaCBvZiBhdHRyaWJ1dGVzIHRvIGJlIGBzZXRgIG9uCiAgICAvLyB0aGUgbW9kZWwuIFRoZSBkZWZhdWx0IGltcGxlbWVudGF0aW9uIGlzIGp1c3QgdG8gcGFzcyB0aGUgcmVzcG9uc2UgYWxvbmcuCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IG1vZGVsIHdpdGggaWRlbnRpY2FsIGF0dHJpYnV0ZXMgdG8gdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLmF0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBBIG1vZGVsIGlzIG5ldyBpZiBpdCBoYXMgbmV2ZXIgYmVlbiBzYXZlZCB0byB0aGUgc2VydmVyLCBhbmQgbGFja3MgYW4gaWQuCiAgICBpc05ldzogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiB0aGlzLmlkID09IG51bGw7CiAgICB9LAoKICAgIC8vIENhbGwgdGhpcyBtZXRob2QgdG8gbWFudWFsbHkgZmlyZSBhIGAiY2hhbmdlImAgZXZlbnQgZm9yIHRoaXMgbW9kZWwgYW5kCiAgICAvLyBhIGAiY2hhbmdlOmF0dHJpYnV0ZSJgIGV2ZW50IGZvciBlYWNoIGNoYW5nZWQgYXR0cmlidXRlLgogICAgLy8gQ2FsbGluZyB0aGlzIHdpbGwgY2F1c2UgYWxsIG9iamVjdHMgb2JzZXJ2aW5nIHRoZSBtb2RlbCB0byB1cGRhdGUuCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIGNoYW5naW5nID0gdGhpcy5fY2hhbmdpbmc7CiAgICAgIHRoaXMuX2NoYW5naW5nID0gdHJ1ZTsKCiAgICAgIC8vIEdlbmVyYXRlIHRoZSBjaGFuZ2VzIHRvIGJlIHRyaWdnZXJlZCBvbiB0aGUgbW9kZWwuCiAgICAgIHZhciB0cmlnZ2VycyA9IHRoaXMuX2NvbXB1dGVDaGFuZ2VzKHRydWUpOwoKICAgICAgdGhpcy5fcGVuZGluZyA9ICEhdHJpZ2dlcnMubGVuZ3RoOwoKICAgICAgZm9yICh2YXIgaSA9IHRyaWdnZXJzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6JyArIHRyaWdnZXJzW2ldLCB0aGlzLCB0cmlnZ2Vyc1tpICsgMV0sIG9wdGlvbnMpOwogICAgICB9CgogICAgICBpZiAoY2hhbmdpbmcpIHJldHVybiB0aGlzOwoKICAgICAgLy8gVHJpZ2dlciBhIGBjaGFuZ2VgIHdoaWxlIHRoZXJlIGhhdmUgYmVlbiBjaGFuZ2VzLgogICAgICB3aGlsZSAodGhpcy5fcGVuZGluZykgewogICAgICAgIHRoaXMuX3BlbmRpbmcgPSBmYWxzZTsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZScsIHRoaXMsIG9wdGlvbnMpOwogICAgICAgIHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlcyA9IF8uY2xvbmUodGhpcy5hdHRyaWJ1dGVzKTsKICAgICAgfQoKICAgICAgdGhpcy5fY2hhbmdpbmcgPSBmYWxzZTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIERldGVybWluZSBpZiB0aGUgbW9kZWwgaGFzIGNoYW5nZWQgc2luY2UgdGhlIGxhc3QgYCJjaGFuZ2UiYCBldmVudC4KICAgIC8vIElmIHlvdSBzcGVjaWZ5IGFuIGF0dHJpYnV0ZSBuYW1lLCBkZXRlcm1pbmUgaWYgdGhhdCBhdHRyaWJ1dGUgaGFzIGNoYW5nZWQuCiAgICBoYXNDaGFuZ2VkOiBmdW5jdGlvbihhdHRyKSB7CiAgICAgIGlmICghdGhpcy5faGFzQ29tcHV0ZWQpIHRoaXMuX2NvbXB1dGVDaGFuZ2VzKCk7CiAgICAgIGlmIChhdHRyID09IG51bGwpIHJldHVybiAhXy5pc0VtcHR5KHRoaXMuY2hhbmdlZCk7CiAgICAgIHJldHVybiBfLmhhcyh0aGlzLmNoYW5nZWQsIGF0dHIpOwogICAgfSwKCiAgICAvLyBSZXR1cm4gYW4gb2JqZWN0IGNvbnRhaW5pbmcgYWxsIHRoZSBhdHRyaWJ1dGVzIHRoYXQgaGF2ZSBjaGFuZ2VkLCBvcgogICAgLy8gZmFsc2UgaWYgdGhlcmUgYXJlIG5vIGNoYW5nZWQgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBkZXRlcm1pbmluZyB3aGF0CiAgICAvLyBwYXJ0cyBvZiBhIHZpZXcgbmVlZCB0byBiZSB1cGRhdGVkIGFuZC9vciB3aGF0IGF0dHJpYnV0ZXMgbmVlZCB0byBiZQogICAgLy8gcGVyc2lzdGVkIHRvIHRoZSBzZXJ2ZXIuIFVuc2V0IGF0dHJpYnV0ZXMgd2lsbCBiZSBzZXQgdG8gdW5kZWZpbmVkLgogICAgLy8gWW91IGNhbiBhbHNvIHBhc3MgYW4gYXR0cmlidXRlcyBvYmplY3QgdG8gZGlmZiBhZ2FpbnN0IHRoZSBtb2RlbCwKICAgIC8vIGRldGVybWluaW5nIGlmIHRoZXJlICp3b3VsZCBiZSogYSBjaGFuZ2UuCiAgICBjaGFuZ2VkQXR0cmlidXRlczogZnVuY3Rpb24oZGlmZikgewogICAgICBpZiAoIWRpZmYpIHJldHVybiB0aGlzLmhhc0NoYW5nZWQoKSA/IF8uY2xvbmUodGhpcy5jaGFuZ2VkKSA6IGZhbHNlOwogICAgICB2YXIgdmFsLCBjaGFuZ2VkID0gZmFsc2UsIG9sZCA9IHRoaXMuX3ByZXZpb3VzQXR0cmlidXRlczsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBkaWZmKSB7CiAgICAgICAgaWYgKF8uaXNFcXVhbChvbGRbYXR0cl0sICh2YWwgPSBkaWZmW2F0dHJdKSkpIGNvbnRpbnVlOwogICAgICAgIChjaGFuZ2VkIHx8IChjaGFuZ2VkID0ge30pKVthdHRyXSA9IHZhbDsKICAgICAgfQogICAgICByZXR1cm4gY2hhbmdlZDsKICAgIH0sCgogICAgLy8gTG9va2luZyBhdCB0aGUgYnVpbHQgdXAgbGlzdCBvZiBgc2V0YCBhdHRyaWJ1dGUgY2hhbmdlcywgY29tcHV0ZSBob3cKICAgIC8vIG1hbnkgb2YgdGhlIGF0dHJpYnV0ZXMgaGF2ZSBhY3R1YWxseSBjaGFuZ2VkLiBJZiBgbG91ZGAsIHJldHVybiBhCiAgICAvLyBib2lsZWQtZG93biBsaXN0IG9mIG9ubHkgdGhlIHJlYWwgY2hhbmdlcy4KICAgIF9jb21wdXRlQ2hhbmdlczogZnVuY3Rpb24obG91ZCkgewogICAgICB0aGlzLmNoYW5nZWQgPSB7fTsKICAgICAgdmFyIGFscmVhZHkgPSB7fTsKICAgICAgdmFyIHRyaWdnZXJzID0gW107CiAgICAgIC8vIFdBUk46IG1vbmtleSBwYXRjaCBmb3IgMC45LjksIHdpbGwgZ28gYXdheSB3aGVuIHVwZ3JhZGluZwogICAgICAvLyB0byBmdXR1cmUgdmVyc2lvbiBvZiBiYWNrYm9uZQogICAgICB2YXIgY3VycmVudCA9IHRoaXMuX2N1cnJlbnRBdHRyaWJ1dGVzIHx8IHt9OwogICAgICB2YXIgY2hhbmdlcyA9IHRoaXMuX2NoYW5nZXM7CgogICAgICAvLyBMb29wIHRocm91Z2ggdGhlIGN1cnJlbnQgcXVldWUgb2YgcG90ZW50aWFsIG1vZGVsIGNoYW5nZXMuCiAgICAgIGZvciAodmFyIGkgPSBjaGFuZ2VzLmxlbmd0aCAtIDI7IGkgPj0gMDsgaSAtPSAyKSB7CiAgICAgICAgdmFyIGtleSA9IGNoYW5nZXNbaV0sIHZhbCA9IGNoYW5nZXNbaSArIDFdOwogICAgICAgIGlmIChhbHJlYWR5W2tleV0pIGNvbnRpbnVlOwogICAgICAgIGFscmVhZHlba2V5XSA9IHRydWU7CgogICAgICAgIC8vIENoZWNrIGlmIHRoZSBhdHRyaWJ1dGUgaGFzIGJlZW4gbW9kaWZpZWQgc2luY2UgdGhlIGxhc3QgY2hhbmdlLAogICAgICAgIC8vIGFuZCB1cGRhdGUgYHRoaXMuY2hhbmdlZGAgYWNjb3JkaW5nbHkuIElmIHdlJ3JlIGluc2lkZSBvZiBhIGBjaGFuZ2VgCiAgICAgICAgLy8gY2FsbCwgYWxzbyBhZGQgYSB0cmlnZ2VyIHRvIHRoZSBsaXN0LgogICAgICAgIGlmIChjdXJyZW50W2tleV0gIT09IHZhbCkgewogICAgICAgICAgdGhpcy5jaGFuZ2VkW2tleV0gPSB2YWw7CiAgICAgICAgICBpZiAoIWxvdWQpIGNvbnRpbnVlOwogICAgICAgICAgdHJpZ2dlcnMucHVzaChrZXksIHZhbCk7CiAgICAgICAgICBjdXJyZW50W2tleV0gPSB2YWw7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChsb3VkKSB0aGlzLl9jaGFuZ2VzID0gW107CgogICAgICAvLyBTaWduYWxzIGB0aGlzLmNoYW5nZWRgIGlzIGN1cnJlbnQgdG8gcHJldmVudCBkdXBsaWNhdGUgY2FsbHMgZnJvbSBgdGhpcy5oYXNDaGFuZ2VkYC4KICAgICAgdGhpcy5faGFzQ29tcHV0ZWQgPSB0cnVlOwogICAgICByZXR1cm4gdHJpZ2dlcnM7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgcHJldmlvdXMgdmFsdWUgb2YgYW4gYXR0cmlidXRlLCByZWNvcmRlZCBhdCB0aGUgdGltZSB0aGUgbGFzdAogICAgLy8gYCJjaGFuZ2UiYCBldmVudCB3YXMgZmlyZWQuCiAgICBwcmV2aW91czogZnVuY3Rpb24oYXR0cikgewogICAgICBpZiAoYXR0ciA9PSBudWxsIHx8ICF0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gdGhpcy5fcHJldmlvdXNBdHRyaWJ1dGVzW2F0dHJdOwogICAgfSwKCiAgICAvLyBHZXQgYWxsIG9mIHRoZSBhdHRyaWJ1dGVzIG9mIHRoZSBtb2RlbCBhdCB0aGUgdGltZSBvZiB0aGUgcHJldmlvdXMKICAgIC8vIGAiY2hhbmdlImAgZXZlbnQuCiAgICBwcmV2aW91c0F0dHJpYnV0ZXM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXy5jbG9uZSh0aGlzLl9wcmV2aW91c0F0dHJpYnV0ZXMpOwogICAgfSwKCiAgICAvLyBSdW4gdmFsaWRhdGlvbiBhZ2FpbnN0IHRoZSBuZXh0IGNvbXBsZXRlIHNldCBvZiBtb2RlbCBhdHRyaWJ1dGVzLAogICAgLy8gcmV0dXJuaW5nIGB0cnVlYCBpZiBhbGwgaXMgd2VsbC4gSWYgYSBzcGVjaWZpYyBgZXJyb3JgIGNhbGxiYWNrIGhhcwogICAgLy8gYmVlbiBwYXNzZWQsIGNhbGwgdGhhdCBpbnN0ZWFkIG9mIGZpcmluZyB0aGUgZ2VuZXJhbCBgImVycm9yImAgZXZlbnQuCiAgICBfdmFsaWRhdGU6IGZ1bmN0aW9uKGF0dHJzLCBvcHRpb25zKSB7CiAgICAgIGlmICghdGhpcy52YWxpZGF0ZSkgcmV0dXJuIHRydWU7CiAgICAgIGF0dHJzID0gXy5leHRlbmQoe30sIHRoaXMuYXR0cmlidXRlcywgYXR0cnMpOwogICAgICB2YXIgZXJyb3IgPSB0aGlzLnZhbGlkYXRlKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFlcnJvcikgcmV0dXJuIHRydWU7CiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuZXJyb3IpIG9wdGlvbnMuZXJyb3IodGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgdGhpcywgZXJyb3IsIG9wdGlvbnMpOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogIH0pOwoKICAvLyBCYWNrYm9uZS5Db2xsZWN0aW9uCiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLQoKICAvLyBQcm92aWRlcyBhIHN0YW5kYXJkIGNvbGxlY3Rpb24gY2xhc3MgZm9yIG91ciBzZXRzIG9mIG1vZGVscywgb3JkZXJlZAogIC8vIG9yIHVub3JkZXJlZC4gSWYgYSBgY29tcGFyYXRvcmAgaXMgc3BlY2lmaWVkLCB0aGUgQ29sbGVjdGlvbiB3aWxsIG1haW50YWluCiAgLy8gaXRzIG1vZGVscyBpbiBzb3J0IG9yZGVyLCBhcyB0aGV5J3JlIGFkZGVkIGFuZCByZW1vdmVkLgogIHZhciBDb2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbiA9IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgb3B0aW9ucyB8fCAob3B0aW9ucyA9IHt9KTsKICAgIGlmIChvcHRpb25zLm1vZGVsKSB0aGlzLm1vZGVsID0gb3B0aW9ucy5tb2RlbDsKICAgIGlmIChvcHRpb25zLmNvbXBhcmF0b3IgIT09IHZvaWQgMCkgdGhpcy5jb21wYXJhdG9yID0gb3B0aW9ucy5jb21wYXJhdG9yOwogICAgdGhpcy5fcmVzZXQoKTsKICAgIHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKG1vZGVscykgdGhpcy5yZXNldChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgfTsKCiAgLy8gRGVmaW5lIHRoZSBDb2xsZWN0aW9uJ3MgaW5oZXJpdGFibGUgbWV0aG9kcy4KICBfLmV4dGVuZChDb2xsZWN0aW9uLnByb3RvdHlwZSwgRXZlbnRzLCB7CgogICAgLy8gVGhlIGRlZmF1bHQgbW9kZWwgZm9yIGEgY29sbGVjdGlvbiBpcyBqdXN0IGEgKipCYWNrYm9uZS5Nb2RlbCoqLgogICAgLy8gVGhpcyBzaG91bGQgYmUgb3ZlcnJpZGRlbiBpbiBtb3N0IGNhc2VzLgogICAgbW9kZWw6IE1vZGVsLAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gVGhlIEpTT04gcmVwcmVzZW50YXRpb24gb2YgYSBDb2xsZWN0aW9uIGlzIGFuIGFycmF5IG9mIHRoZQogICAgLy8gbW9kZWxzJyBhdHRyaWJ1dGVzLgogICAgdG9KU09OOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHJldHVybiB0aGlzLm1hcChmdW5jdGlvbihtb2RlbCl7IHJldHVybiBtb2RlbC50b0pTT04ob3B0aW9ucyk7IH0pOwogICAgfSwKCiAgICAvLyBQcm94eSBgQmFja2JvbmUuc3luY2AgYnkgZGVmYXVsdC4KICAgIHN5bmM6IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gQmFja2JvbmUuc3luYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfSwKCiAgICAvLyBBZGQgYSBtb2RlbCwgb3IgbGlzdCBvZiBtb2RlbHMgdG8gdGhlIHNldC4gUGFzcyAqKnNpbGVudCoqIHRvIGF2b2lkCiAgICAvLyBmaXJpbmcgdGhlIGBhZGRgIGV2ZW50IGZvciBldmVyeSBuZXcgbW9kZWwuCiAgICBhZGQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgYXJncywgbGVuZ3RoLCBtb2RlbCwgZXhpc3RpbmcsIG5lZWRzU29ydDsKICAgICAgdmFyIGF0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmF0OwogICAgICB2YXIgc29ydCA9ICgob3B0aW9ucyAmJiBvcHRpb25zLnNvcnQpID09IG51bGwgPyB0cnVlIDogb3B0aW9ucy5zb3J0KTsKICAgICAgbW9kZWxzID0gXy5pc0FycmF5KG1vZGVscykgPyBtb2RlbHMuc2xpY2UoKSA6IFttb2RlbHNdOwoKICAgICAgLy8gVHVybiBiYXJlIG9iamVjdHMgaW50byBtb2RlbCByZWZlcmVuY2VzLCBhbmQgcHJldmVudCBpbnZhbGlkIG1vZGVscwogICAgICAvLyBmcm9tIGJlaW5nIGFkZGVkLgogICAgICBmb3IgKGkgPSBtb2RlbHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgICAgICBpZighKG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsc1tpXSwgb3B0aW9ucykpKSB7CiAgICAgICAgICB0aGlzLnRyaWdnZXIoImVycm9yIiwgdGhpcywgbW9kZWxzW2ldLCBvcHRpb25zKTsKICAgICAgICAgIG1vZGVscy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgbW9kZWxzW2ldID0gbW9kZWw7CgogICAgICAgIGV4aXN0aW5nID0gbW9kZWwuaWQgIT0gbnVsbCAmJiB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICAvLyBJZiBhIGR1cGxpY2F0ZSBpcyBmb3VuZCwgcHJldmVudCBpdCBmcm9tIGJlaW5nIGFkZGVkIGFuZAogICAgICAgIC8vIG9wdGlvbmFsbHkgbWVyZ2UgaXQgaW50byB0aGUgZXhpc3RpbmcgbW9kZWwuCiAgICAgICAgaWYgKGV4aXN0aW5nIHx8IHRoaXMuX2J5Q2lkW21vZGVsLmNpZF0pIHsKICAgICAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMubWVyZ2UgJiYgZXhpc3RpbmcpIHsKICAgICAgICAgICAgZXhpc3Rpbmcuc2V0KG1vZGVsLmF0dHJpYnV0ZXMsIG9wdGlvbnMpOwogICAgICAgICAgICBuZWVkc1NvcnQgPSBzb3J0OwogICAgICAgICAgfQogICAgICAgICAgbW9kZWxzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KCiAgICAgICAgLy8gTGlzdGVuIHRvIGFkZGVkIG1vZGVscycgZXZlbnRzLCBhbmQgaW5kZXggbW9kZWxzIGZvciBsb29rdXAgYnkKICAgICAgICAvLyBgaWRgIGFuZCBieSBgY2lkYC4KICAgICAgICBtb2RlbC5vbignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgICAgICB0aGlzLl9ieUNpZFttb2RlbC5jaWRdID0gbW9kZWw7CiAgICAgICAgaWYgKG1vZGVsLmlkICE9IG51bGwpIHRoaXMuX2J5SWRbbW9kZWwuaWRdID0gbW9kZWw7CiAgICAgIH0KCiAgICAgIC8vIFNlZSBpZiBzb3J0aW5nIGlzIG5lZWRlZCwgdXBkYXRlIGBsZW5ndGhgIGFuZCBzcGxpY2UgaW4gbmV3IG1vZGVscy4KICAgICAgaWYgKG1vZGVscy5sZW5ndGgpIG5lZWRzU29ydCA9IHNvcnQ7CiAgICAgIHRoaXMubGVuZ3RoICs9IG1vZGVscy5sZW5ndGg7CiAgICAgIGFyZ3MgPSBbYXQgIT0gbnVsbCA/IGF0IDogdGhpcy5tb2RlbHMubGVuZ3RoLCAwXTsKICAgICAgcHVzaC5hcHBseShhcmdzLCBtb2RlbHMpOwogICAgICBzcGxpY2UuYXBwbHkodGhpcy5tb2RlbHMsIGFyZ3MpOwoKICAgICAgLy8gU29ydCB0aGUgY29sbGVjdGlvbiBpZiBhcHByb3ByaWF0ZS4KICAgICAgaWYgKG5lZWRzU29ydCAmJiB0aGlzLmNvbXBhcmF0b3IgJiYgYXQgPT0gbnVsbCkgdGhpcy5zb3J0KHtzaWxlbnQ6IHRydWV9KTsKCiAgICAgIGlmIChvcHRpb25zICYmIG9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpczsKCiAgICAgIC8vIFRyaWdnZXIgYGFkZGAgZXZlbnRzLgogICAgICB3aGlsZSAobW9kZWwgPSBtb2RlbHMuc2hpZnQoKSkgewogICAgICAgIG1vZGVsLnRyaWdnZXIoJ2FkZCcsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSBhIG1vZGVsLCBvciBhIGxpc3Qgb2YgbW9kZWxzIGZyb20gdGhlIHNldC4gUGFzcyBzaWxlbnQgdG8gYXZvaWQKICAgIC8vIGZpcmluZyB0aGUgYHJlbW92ZWAgZXZlbnQgZm9yIGV2ZXJ5IG1vZGVsIHJlbW92ZWQuCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgaSwgbCwgaW5kZXgsIG1vZGVsOwogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBtb2RlbHMgPSBfLmlzQXJyYXkobW9kZWxzKSA/IG1vZGVscy5zbGljZSgpIDogW21vZGVsc107CiAgICAgIGZvciAoaSA9IDAsIGwgPSBtb2RlbHMubGVuZ3RoOyBpIDwgbDsgaSsrKSB7CiAgICAgICAgbW9kZWwgPSB0aGlzLmdldChtb2RlbHNbaV0pOwogICAgICAgIGlmICghbW9kZWwpIGNvbnRpbnVlOwogICAgICAgIGRlbGV0ZSB0aGlzLl9ieUlkW21vZGVsLmlkXTsKICAgICAgICBkZWxldGUgdGhpcy5fYnlDaWRbbW9kZWwuY2lkXTsKICAgICAgICBpbmRleCA9IHRoaXMuaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5tb2RlbHMuc3BsaWNlKGluZGV4LCAxKTsKICAgICAgICB0aGlzLmxlbmd0aC0tOwogICAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHsKICAgICAgICAgIG9wdGlvbnMuaW5kZXggPSBpbmRleDsKICAgICAgICAgIG1vZGVsLnRyaWdnZXIoJ3JlbW92ZScsIG1vZGVsLCB0aGlzLCBvcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fcmVtb3ZlUmVmZXJlbmNlKG1vZGVsKTsKICAgICAgfQogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gQWRkIGEgbW9kZWwgdG8gdGhlIGVuZCBvZiB0aGUgY29sbGVjdGlvbi4KICAgIHB1c2g6IGZ1bmN0aW9uKG1vZGVsLCBvcHRpb25zKSB7CiAgICAgIG1vZGVsID0gdGhpcy5fcHJlcGFyZU1vZGVsKG1vZGVsLCBvcHRpb25zKTsKICAgICAgdGhpcy5hZGQobW9kZWwsIF8uZXh0ZW5kKHthdDogdGhpcy5sZW5ndGh9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgZW5kIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgcG9wOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIHZhciBtb2RlbCA9IHRoaXMuYXQodGhpcy5sZW5ndGggLSAxKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIEFkZCBhIG1vZGVsIHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIGNvbGxlY3Rpb24uCiAgICB1bnNoaWZ0OiBmdW5jdGlvbihtb2RlbCwgb3B0aW9ucykgewogICAgICBtb2RlbCA9IHRoaXMuX3ByZXBhcmVNb2RlbChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHRoaXMuYWRkKG1vZGVsLCBfLmV4dGVuZCh7YXQ6IDB9LCBvcHRpb25zKSk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gUmVtb3ZlIGEgbW9kZWwgZnJvbSB0aGUgYmVnaW5uaW5nIG9mIHRoZSBjb2xsZWN0aW9uLgogICAgc2hpZnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgdmFyIG1vZGVsID0gdGhpcy5hdCgwKTsKICAgICAgdGhpcy5yZW1vdmUobW9kZWwsIG9wdGlvbnMpOwogICAgICByZXR1cm4gbW9kZWw7CiAgICB9LAoKICAgIC8vIFNsaWNlIG91dCBhIHN1Yi1hcnJheSBvZiBtb2RlbHMgZnJvbSB0aGUgY29sbGVjdGlvbi4KICAgIHNsaWNlOiBmdW5jdGlvbihiZWdpbiwgZW5kKSB7CiAgICAgIHJldHVybiB0aGlzLm1vZGVscy5zbGljZShiZWdpbiwgZW5kKTsKICAgIH0sCgogICAgLy8gR2V0IGEgbW9kZWwgZnJvbSB0aGUgc2V0IGJ5IGlkLgogICAgZ2V0OiBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iaiA9PSBudWxsKSByZXR1cm4gdm9pZCAwOwogICAgICByZXR1cm4gdGhpcy5fYnlJZFtvYmouaWQgIT0gbnVsbCA/IG9iai5pZCA6IG9ial0gfHwgdGhpcy5fYnlDaWRbb2JqLmNpZCB8fCBvYmpdOwogICAgfSwKCiAgICAvLyBHZXQgdGhlIG1vZGVsIGF0IHRoZSBnaXZlbiBpbmRleC4KICAgIGF0OiBmdW5jdGlvbihpbmRleCkgewogICAgICByZXR1cm4gdGhpcy5tb2RlbHNbaW5kZXhdOwogICAgfSwKCiAgICAvLyBSZXR1cm4gbW9kZWxzIHdpdGggbWF0Y2hpbmcgYXR0cmlidXRlcy4gVXNlZnVsIGZvciBzaW1wbGUgY2FzZXMgb2YgYGZpbHRlcmAuCiAgICB3aGVyZTogZnVuY3Rpb24oYXR0cnMpIHsKICAgICAgaWYgKF8uaXNFbXB0eShhdHRycykpIHJldHVybiBbXTsKICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgZm9yICh2YXIga2V5IGluIGF0dHJzKSB7CiAgICAgICAgICBpZiAoYXR0cnNba2V5XSAhPT0gbW9kZWwuZ2V0KGtleSkpIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0pOwogICAgfSwKCiAgICAvLyBGb3JjZSB0aGUgY29sbGVjdGlvbiB0byByZS1zb3J0IGl0c2VsZi4gWW91IGRvbid0IG5lZWQgdG8gY2FsbCB0aGlzIHVuZGVyCiAgICAvLyBub3JtYWwgY2lyY3Vtc3RhbmNlcywgYXMgdGhlIHNldCB3aWxsIG1haW50YWluIHNvcnQgb3JkZXIgYXMgZWFjaCBpdGVtCiAgICAvLyBpcyBhZGRlZC4KICAgIHNvcnQ6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgaWYgKCF0aGlzLmNvbXBhcmF0b3IpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBzb3J0IGEgc2V0IHdpdGhvdXQgYSBjb21wYXJhdG9yJyk7CiAgICAgIH0KCiAgICAgIGlmIChfLmlzU3RyaW5nKHRoaXMuY29tcGFyYXRvcikgfHwgdGhpcy5jb21wYXJhdG9yLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHRoaXMubW9kZWxzID0gdGhpcy5zb3J0QnkodGhpcy5jb21wYXJhdG9yLCB0aGlzKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLm1vZGVscy5zb3J0KF8uYmluZCh0aGlzLmNvbXBhcmF0b3IsIHRoaXMpKTsKICAgICAgfQoKICAgICAgaWYgKCFvcHRpb25zIHx8ICFvcHRpb25zLnNpbGVudCkgdGhpcy50cmlnZ2VyKCdzb3J0JywgdGhpcywgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBQbHVjayBhbiBhdHRyaWJ1dGUgZnJvbSBlYWNoIG1vZGVsIGluIHRoZSBjb2xsZWN0aW9uLgogICAgcGx1Y2s6IGZ1bmN0aW9uKGF0dHIpIHsKICAgICAgcmV0dXJuIF8uaW52b2tlKHRoaXMubW9kZWxzLCAnZ2V0JywgYXR0cik7CiAgICB9LAoKICAgIC8vIFNtYXJ0bHkgdXBkYXRlIGEgY29sbGVjdGlvbiB3aXRoIGEgY2hhbmdlIHNldCBvZiBtb2RlbHMsIGFkZGluZywKICAgIC8vIHJlbW92aW5nLCBhbmQgbWVyZ2luZyBhcyBuZWNlc3NhcnkuCiAgICB1cGRhdGU6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICB2YXIgbW9kZWwsIGksIGwsIGV4aXN0aW5nOwogICAgICB2YXIgYWRkID0gW10sIHJlbW92ZSA9IFtdLCBtb2RlbE1hcCA9IHt9OwogICAgICB2YXIgaWRBdHRyID0gdGhpcy5tb2RlbC5wcm90b3R5cGUuaWRBdHRyaWJ1dGU7CiAgICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7YWRkOiB0cnVlLCBtZXJnZTogdHJ1ZSwgcmVtb3ZlOiB0cnVlfSwgb3B0aW9ucyk7CiAgICAgIGlmIChvcHRpb25zLnBhcnNlKSBtb2RlbHMgPSB0aGlzLnBhcnNlKG1vZGVscyk7CgogICAgICAvLyBBbGxvdyBhIHNpbmdsZSBtb2RlbCAob3Igbm8gYXJndW1lbnQpIHRvIGJlIHBhc3NlZC4KICAgICAgaWYgKCFfLmlzQXJyYXkobW9kZWxzKSkgbW9kZWxzID0gbW9kZWxzID8gW21vZGVsc10gOiBbXTsKCiAgICAgIC8vIFByb3h5IHRvIGBhZGRgIGZvciB0aGlzIGNhc2UsIG5vIG5lZWQgdG8gaXRlcmF0ZS4uLgogICAgICBpZiAob3B0aW9ucy5hZGQgJiYgIW9wdGlvbnMucmVtb3ZlKSByZXR1cm4gdGhpcy5hZGQobW9kZWxzLCBvcHRpb25zKTsKCiAgICAgIC8vIERldGVybWluZSB3aGljaCBtb2RlbHMgdG8gYWRkIGFuZCBtZXJnZSwgYW5kIHdoaWNoIHRvIHJlbW92ZS4KICAgICAgZm9yIChpID0gMCwgbCA9IG1vZGVscy5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgICBtb2RlbCA9IG1vZGVsc1tpXTsKICAgICAgICBleGlzdGluZyA9IHRoaXMuZ2V0KG1vZGVsLmlkIHx8IG1vZGVsLmNpZCB8fCBtb2RlbFtpZEF0dHJdKTsKICAgICAgICBpZiAob3B0aW9ucy5yZW1vdmUgJiYgZXhpc3RpbmcpIG1vZGVsTWFwW2V4aXN0aW5nLmNpZF0gPSB0cnVlOwogICAgICAgIGlmICgob3B0aW9ucy5hZGQgJiYgIWV4aXN0aW5nKSB8fCAob3B0aW9ucy5tZXJnZSAmJiBleGlzdGluZykpIHsKICAgICAgICAgIGFkZC5wdXNoKG1vZGVsKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKG9wdGlvbnMucmVtb3ZlKSB7CiAgICAgICAgZm9yIChpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgICAgbW9kZWwgPSB0aGlzLm1vZGVsc1tpXTsKICAgICAgICAgIGlmICghbW9kZWxNYXBbbW9kZWwuY2lkXSkgcmVtb3ZlLnB1c2gobW9kZWwpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gUmVtb3ZlIG1vZGVscyAoaWYgYXBwbGljYWJsZSkgYmVmb3JlIHdlIGFkZCBhbmQgbWVyZ2UgdGhlIHJlc3QuCiAgICAgIGlmIChyZW1vdmUubGVuZ3RoKSB0aGlzLnJlbW92ZShyZW1vdmUsIG9wdGlvbnMpOwogICAgICBpZiAoYWRkLmxlbmd0aCkgdGhpcy5hZGQoYWRkLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFdoZW4geW91IGhhdmUgbW9yZSBpdGVtcyB0aGFuIHlvdSB3YW50IHRvIGFkZCBvciByZW1vdmUgaW5kaXZpZHVhbGx5LAogICAgLy8geW91IGNhbiByZXNldCB0aGUgZW50aXJlIHNldCB3aXRoIGEgbmV3IGxpc3Qgb2YgbW9kZWxzLCB3aXRob3V0IGZpcmluZwogICAgLy8gYW55IGBhZGRgIG9yIGByZW1vdmVgIGV2ZW50cy4gRmlyZXMgYHJlc2V0YCB3aGVuIGZpbmlzaGVkLgogICAgcmVzZXQ6IGZ1bmN0aW9uKG1vZGVscywgb3B0aW9ucykgewogICAgICBvcHRpb25zIHx8IChvcHRpb25zID0ge30pOwogICAgICBpZiAob3B0aW9ucy5wYXJzZSkgbW9kZWxzID0gdGhpcy5wYXJzZShtb2RlbHMpOwogICAgICBmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubW9kZWxzLmxlbmd0aDsgaSA8IGw7IGkrKykgewogICAgICAgIHRoaXMuX3JlbW92ZVJlZmVyZW5jZSh0aGlzLm1vZGVsc1tpXSk7CiAgICAgIH0KICAgICAgb3B0aW9ucy5wcmV2aW91c01vZGVscyA9IHRoaXMubW9kZWxzOwogICAgICB0aGlzLl9yZXNldCgpOwogICAgICBpZiAobW9kZWxzKSB0aGlzLmFkZChtb2RlbHMsIF8uZXh0ZW5kKHtzaWxlbnQ6IHRydWV9LCBvcHRpb25zKSk7CiAgICAgIGlmICghb3B0aW9ucy5zaWxlbnQpIHRoaXMudHJpZ2dlcigncmVzZXQnLCB0aGlzLCBvcHRpb25zKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIEZldGNoIHRoZSBkZWZhdWx0IHNldCBvZiBtb2RlbHMgZm9yIHRoaXMgY29sbGVjdGlvbiwgcmVzZXR0aW5nIHRoZQogICAgLy8gY29sbGVjdGlvbiB3aGVuIHRoZXkgYXJyaXZlLiBJZiBgYWRkOiB0cnVlYCBpcyBwYXNzZWQsIGFwcGVuZHMgdGhlCiAgICAvLyBtb2RlbHMgdG8gdGhlIGNvbGxlY3Rpb24gaW5zdGVhZCBvZiByZXNldHRpbmcuCiAgICBmZXRjaDogZnVuY3Rpb24ob3B0aW9ucykgewogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgaWYgKG9wdGlvbnMucGFyc2UgPT09IHZvaWQgMCkgb3B0aW9ucy5wYXJzZSA9IHRydWU7CiAgICAgIHZhciBjb2xsZWN0aW9uID0gdGhpczsKICAgICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICAgIG9wdGlvbnMuc3VjY2VzcyA9IGZ1bmN0aW9uKHJlc3AsIHN0YXR1cywgeGhyKSB7CiAgICAgICAgdmFyIG1ldGhvZCA9IG9wdGlvbnMudXBkYXRlID8gJ3VwZGF0ZScgOiAncmVzZXQnOwogICAgICAgIGNvbGxlY3Rpb25bbWV0aG9kXShyZXNwLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhjb2xsZWN0aW9uLCByZXNwLCBvcHRpb25zKTsKICAgICAgfTsKICAgICAgcmV0dXJuIHRoaXMuc3luYygncmVhZCcsIHRoaXMsIG9wdGlvbnMpOwogICAgfSwKCiAgICAvLyBDcmVhdGUgYSBuZXcgaW5zdGFuY2Ugb2YgYSBtb2RlbCBpbiB0aGlzIGNvbGxlY3Rpb24uIEFkZCB0aGUgbW9kZWwgdG8gdGhlCiAgICAvLyBjb2xsZWN0aW9uIGltbWVkaWF0ZWx5LCB1bmxlc3MgYHdhaXQ6IHRydWVgIGlzIHBhc3NlZCwgaW4gd2hpY2ggY2FzZSB3ZQogICAgLy8gd2FpdCBmb3IgdGhlIHNlcnZlciB0byBhZ3JlZS4KICAgIGNyZWF0ZTogZnVuY3Rpb24obW9kZWwsIG9wdGlvbnMpIHsKICAgICAgdmFyIGNvbGxlY3Rpb24gPSB0aGlzOwogICAgICBvcHRpb25zID0gb3B0aW9ucyA/IF8uY2xvbmUob3B0aW9ucykgOiB7fTsKICAgICAgbW9kZWwgPSB0aGlzLl9wcmVwYXJlTW9kZWwobW9kZWwsIG9wdGlvbnMpOwogICAgICBpZiAoIW1vZGVsKSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICghb3B0aW9ucy53YWl0KSBjb2xsZWN0aW9uLmFkZChtb2RlbCwgb3B0aW9ucyk7CiAgICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihtb2RlbCwgcmVzcCwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLndhaXQpIGNvbGxlY3Rpb24uYWRkKG1vZGVsLCBvcHRpb25zKTsKICAgICAgICBpZiAoc3VjY2Vzcykgc3VjY2Vzcyhtb2RlbCwgcmVzcCwgb3B0aW9ucyk7CiAgICAgIH07CiAgICAgIG1vZGVsLnNhdmUobnVsbCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gKipwYXJzZSoqIGNvbnZlcnRzIGEgcmVzcG9uc2UgaW50byBhIGxpc3Qgb2YgbW9kZWxzIHRvIGJlIGFkZGVkIHRvIHRoZQogICAgLy8gY29sbGVjdGlvbi4gVGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gaXMganVzdCB0byBwYXNzIGl0IHRocm91Z2guCiAgICBwYXJzZTogZnVuY3Rpb24ocmVzcCkgewogICAgICByZXR1cm4gcmVzcDsKICAgIH0sCgogICAgLy8gQ3JlYXRlIGEgbmV3IGNvbGxlY3Rpb24gd2l0aCBhbiBpZGVudGljYWwgbGlzdCBvZiBtb2RlbHMgYXMgdGhpcyBvbmUuCiAgICBjbG9uZTogZnVuY3Rpb24oKSB7CiAgICAgIHJldHVybiBuZXcgdGhpcy5jb25zdHJ1Y3Rvcih0aGlzLm1vZGVscyk7CiAgICB9LAoKICAgIC8vIFByb3h5IHRvIF8ncyBjaGFpbi4gQ2FuJ3QgYmUgcHJveGllZCB0aGUgc2FtZSB3YXkgdGhlIHJlc3Qgb2YgdGhlCiAgICAvLyB1bmRlcnNjb3JlIG1ldGhvZHMgYXJlIHByb3hpZWQgYmVjYXVzZSBpdCByZWxpZXMgb24gdGhlIHVuZGVyc2NvcmUKICAgIC8vIGNvbnN0cnVjdG9yLgogICAgY2hhaW46IGZ1bmN0aW9uKCkgewogICAgICByZXR1cm4gXyh0aGlzLm1vZGVscykuY2hhaW4oKTsKICAgIH0sCgogICAgLy8gUmVzZXQgYWxsIGludGVybmFsIHN0YXRlLiBDYWxsZWQgd2hlbiB0aGUgY29sbGVjdGlvbiBpcyByZXNldC4KICAgIF9yZXNldDogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMubGVuZ3RoID0gMDsKICAgICAgdGhpcy5tb2RlbHMgPSBbXTsKICAgICAgdGhpcy5fYnlJZCAgPSB7fTsKICAgICAgdGhpcy5fYnlDaWQgPSB7fTsKICAgIH0sCgogICAgLy8gUHJlcGFyZSBhIG1vZGVsIG9yIGhhc2ggb2YgYXR0cmlidXRlcyB0byBiZSBhZGRlZCB0byB0aGlzIGNvbGxlY3Rpb24uCiAgICBfcHJlcGFyZU1vZGVsOiBmdW5jdGlvbihhdHRycywgb3B0aW9ucykgewogICAgICBpZiAoYXR0cnMgaW5zdGFuY2VvZiBNb2RlbCkgewogICAgICAgIGlmICghYXR0cnMuY29sbGVjdGlvbikgYXR0cnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgICB9CiAgICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICAgIG9wdGlvbnMuY29sbGVjdGlvbiA9IHRoaXM7CiAgICAgIHZhciBtb2RlbCA9IG5ldyB0aGlzLm1vZGVsKGF0dHJzLCBvcHRpb25zKTsKICAgICAgaWYgKCFtb2RlbC5fdmFsaWRhdGUoYXR0cnMsIG9wdGlvbnMpKSByZXR1cm4gZmFsc2U7CiAgICAgIHJldHVybiBtb2RlbDsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIHRvIHJlbW92ZSBhIG1vZGVsJ3MgdGllcyB0byBhIGNvbGxlY3Rpb24uCiAgICBfcmVtb3ZlUmVmZXJlbmNlOiBmdW5jdGlvbihtb2RlbCkgewogICAgICBpZiAodGhpcyA9PT0gbW9kZWwuY29sbGVjdGlvbikgZGVsZXRlIG1vZGVsLmNvbGxlY3Rpb247CiAgICAgIG1vZGVsLm9mZignYWxsJywgdGhpcy5fb25Nb2RlbEV2ZW50LCB0aGlzKTsKICAgIH0sCgogICAgLy8gSW50ZXJuYWwgbWV0aG9kIGNhbGxlZCBldmVyeSB0aW1lIGEgbW9kZWwgaW4gdGhlIHNldCBmaXJlcyBhbiBldmVudC4KICAgIC8vIFNldHMgbmVlZCB0byB1cGRhdGUgdGhlaXIgaW5kZXhlcyB3aGVuIG1vZGVscyBjaGFuZ2UgaWRzLiBBbGwgb3RoZXIKICAgIC8vIGV2ZW50cyBzaW1wbHkgcHJveHkgdGhyb3VnaC4gImFkZCIgYW5kICJyZW1vdmUiIGV2ZW50cyB0aGF0IG9yaWdpbmF0ZQogICAgLy8gaW4gb3RoZXIgY29sbGVjdGlvbnMgYXJlIGlnbm9yZWQuCiAgICBfb25Nb2RlbEV2ZW50OiBmdW5jdGlvbihldmVudCwgbW9kZWwsIGNvbGxlY3Rpb24sIG9wdGlvbnMpIHsKICAgICAgaWYgKChldmVudCA9PT0gJ2FkZCcgfHwgZXZlbnQgPT09ICdyZW1vdmUnKSAmJiBjb2xsZWN0aW9uICE9PSB0aGlzKSByZXR1cm47CiAgICAgIGlmIChldmVudCA9PT0gJ2Rlc3Ryb3knKSB0aGlzLnJlbW92ZShtb2RlbCwgb3B0aW9ucyk7CiAgICAgIGlmIChtb2RlbCAmJiBldmVudCA9PT0gJ2NoYW5nZTonICsgbW9kZWwuaWRBdHRyaWJ1dGUpIHsKICAgICAgICBkZWxldGUgdGhpcy5fYnlJZFttb2RlbC5wcmV2aW91cyhtb2RlbC5pZEF0dHJpYnV0ZSldOwogICAgICAgIGlmIChtb2RlbC5pZCAhPSBudWxsKSB0aGlzLl9ieUlkW21vZGVsLmlkXSA9IG1vZGVsOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfQoKICB9KTsKCiAgLy8gVW5kZXJzY29yZSBtZXRob2RzIHRoYXQgd2Ugd2FudCB0byBpbXBsZW1lbnQgb24gdGhlIENvbGxlY3Rpb24uCiAgdmFyIG1ldGhvZHMgPSBbJ2ZvckVhY2gnLCAnZWFjaCcsICdtYXAnLCAnY29sbGVjdCcsICdyZWR1Y2UnLCAnZm9sZGwnLAogICAgJ2luamVjdCcsICdyZWR1Y2VSaWdodCcsICdmb2xkcicsICdmaW5kJywgJ2RldGVjdCcsICdmaWx0ZXInLCAnc2VsZWN0JywKICAgICdyZWplY3QnLCAnZXZlcnknLCAnYWxsJywgJ3NvbWUnLCAnYW55JywgJ2luY2x1ZGUnLCAnY29udGFpbnMnLCAnaW52b2tlJywKICAgICdtYXgnLCAnbWluJywgJ3NvcnRlZEluZGV4JywgJ3RvQXJyYXknLCAnc2l6ZScsICdmaXJzdCcsICdoZWFkJywgJ3Rha2UnLAogICAgJ2luaXRpYWwnLCAncmVzdCcsICd0YWlsJywgJ2xhc3QnLCAnd2l0aG91dCcsICdpbmRleE9mJywgJ3NodWZmbGUnLAogICAgJ2xhc3RJbmRleE9mJywgJ2lzRW1wdHknXTsKCiAgLy8gTWl4IGluIGVhY2ggVW5kZXJzY29yZSBtZXRob2QgYXMgYSBwcm94eSB0byBgQ29sbGVjdGlvbiNtb2RlbHNgLgogIF8uZWFjaChtZXRob2RzLCBmdW5jdGlvbihtZXRob2QpIHsKICAgIENvbGxlY3Rpb24ucHJvdG90eXBlW21ldGhvZF0gPSBmdW5jdGlvbigpIHsKICAgICAgdmFyIGFyZ3MgPSBzbGljZS5jYWxsKGFyZ3VtZW50cyk7CiAgICAgIGFyZ3MudW5zaGlmdCh0aGlzLm1vZGVscyk7CiAgICAgIHJldHVybiBfW21ldGhvZF0uYXBwbHkoXywgYXJncyk7CiAgICB9OwogIH0pOwoKICAvLyBVbmRlcnNjb3JlIG1ldGhvZHMgdGhhdCB0YWtlIGEgcHJvcGVydHkgbmFtZSBhcyBhbiBhcmd1bWVudC4KICB2YXIgYXR0cmlidXRlTWV0aG9kcyA9IFsnZ3JvdXBCeScsICdjb3VudEJ5JywgJ3NvcnRCeSddOwoKICAvLyBVc2UgYXR0cmlidXRlcyBpbnN0ZWFkIG9mIHByb3BlcnRpZXMuCiAgXy5lYWNoKGF0dHJpYnV0ZU1ldGhvZHMsIGZ1bmN0aW9uKG1ldGhvZCkgewogICAgQ29sbGVjdGlvbi5wcm90b3R5cGVbbWV0aG9kXSA9IGZ1bmN0aW9uKHZhbHVlLCBjb250ZXh0KSB7CiAgICAgIHZhciBpdGVyYXRvciA9IF8uaXNGdW5jdGlvbih2YWx1ZSkgPyB2YWx1ZSA6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgICAgcmV0dXJuIG1vZGVsLmdldCh2YWx1ZSk7CiAgICAgIH07CiAgICAgIHJldHVybiBfW21ldGhvZF0odGhpcy5tb2RlbHMsIGl0ZXJhdG9yLCBjb250ZXh0KTsKICAgIH07CiAgfSk7CgogIC8vIEJhY2tib25lLlJvdXRlcgogIC8vIC0tLS0tLS0tLS0tLS0tLQoKICAvLyBSb3V0ZXJzIG1hcCBmYXV4LVVSTHMgdG8gYWN0aW9ucywgYW5kIGZpcmUgZXZlbnRzIHdoZW4gcm91dGVzIGFyZQogIC8vIG1hdGNoZWQuIENyZWF0aW5nIGEgbmV3IG9uZSBzZXRzIGl0cyBgcm91dGVzYCBoYXNoLCBpZiBub3Qgc2V0IHN0YXRpY2FsbHkuCiAgdmFyIFJvdXRlciA9IEJhY2tib25lLlJvdXRlciA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSk7CiAgICBpZiAob3B0aW9ucy5yb3V0ZXMpIHRoaXMucm91dGVzID0gb3B0aW9ucy5yb3V0ZXM7CiAgICB0aGlzLl9iaW5kUm91dGVzKCk7CiAgICB0aGlzLmluaXRpYWxpemUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICB9OwoKICAvLyBDYWNoZWQgcmVndWxhciBleHByZXNzaW9ucyBmb3IgbWF0Y2hpbmcgbmFtZWQgcGFyYW0gcGFydHMgYW5kIHNwbGF0dGVkCiAgLy8gcGFydHMgb2Ygcm91dGUgc3RyaW5ncy4KICB2YXIgb3B0aW9uYWxQYXJhbSA9IC9cKCguKj8pXCkvZzsKICB2YXIgbmFtZWRQYXJhbSAgICA9IC86XHcrL2c7CiAgdmFyIHNwbGF0UGFyYW0gICAgPSAvXCpcdysvZzsKICB2YXIgZXNjYXBlUmVnRXhwICA9IC9bXC17fVxbXF0rPy4sXFxcXiR8I1xzXS9nOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuUm91dGVyKiogcHJvcGVydGllcyBhbmQgbWV0aG9kcy4KICBfLmV4dGVuZChSb3V0ZXIucHJvdG90eXBlLCBFdmVudHMsIHsKCiAgICAvLyBJbml0aWFsaXplIGlzIGFuIGVtcHR5IGZ1bmN0aW9uIGJ5IGRlZmF1bHQuIE92ZXJyaWRlIGl0IHdpdGggeW91ciBvd24KICAgIC8vIGluaXRpYWxpemF0aW9uIGxvZ2ljLgogICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24oKXt9LAoKICAgIC8vIE1hbnVhbGx5IGJpbmQgYSBzaW5nbGUgbmFtZWQgcm91dGUgdG8gYSBjYWxsYmFjay4gRm9yIGV4YW1wbGU6CiAgICAvLwogICAgLy8gICAgIHRoaXMucm91dGUoJ3NlYXJjaC86cXVlcnkvcDpudW0nLCAnc2VhcmNoJywgZnVuY3Rpb24ocXVlcnksIG51bSkgewogICAgLy8gICAgICAgLi4uCiAgICAvLyAgICAgfSk7CiAgICAvLwogICAgcm91dGU6IGZ1bmN0aW9uKHJvdXRlLCBuYW1lLCBjYWxsYmFjaykgewogICAgICBpZiAoIV8uaXNSZWdFeHAocm91dGUpKSByb3V0ZSA9IHRoaXMuX3JvdXRlVG9SZWdFeHAocm91dGUpOwogICAgICBpZiAoIWNhbGxiYWNrKSBjYWxsYmFjayA9IHRoaXNbbmFtZV07CiAgICAgIEJhY2tib25lLmhpc3Rvcnkucm91dGUocm91dGUsIF8uYmluZChmdW5jdGlvbihmcmFnbWVudCkgewogICAgICAgIHZhciBhcmdzID0gdGhpcy5fZXh0cmFjdFBhcmFtZXRlcnMocm91dGUsIGZyYWdtZW50KTsKICAgICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgICB0aGlzLnRyaWdnZXIuYXBwbHkodGhpcywgWydyb3V0ZTonICsgbmFtZV0uY29uY2F0KGFyZ3MpKTsKICAgICAgICBCYWNrYm9uZS5oaXN0b3J5LnRyaWdnZXIoJ3JvdXRlJywgdGhpcywgbmFtZSwgYXJncyk7CiAgICAgIH0sIHRoaXMpKTsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFNpbXBsZSBwcm94eSB0byBgQmFja2JvbmUuaGlzdG9yeWAgdG8gc2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShmcmFnbWVudCwgb3B0aW9ucyk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBCaW5kIGFsbCBkZWZpbmVkIHJvdXRlcyB0byBgQmFja2JvbmUuaGlzdG9yeWAuIFdlIGhhdmUgdG8gcmV2ZXJzZSB0aGUKICAgIC8vIG9yZGVyIG9mIHRoZSByb3V0ZXMgaGVyZSB0byBzdXBwb3J0IGJlaGF2aW9yIHdoZXJlIHRoZSBtb3N0IGdlbmVyYWwKICAgIC8vIHJvdXRlcyBjYW4gYmUgZGVmaW5lZCBhdCB0aGUgYm90dG9tIG9mIHRoZSByb3V0ZSBtYXAuCiAgICBfYmluZFJvdXRlczogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5yb3V0ZXMpIHJldHVybjsKICAgICAgdmFyIHJvdXRlLCByb3V0ZXMgPSBfLmtleXModGhpcy5yb3V0ZXMpOwogICAgICB3aGlsZSAoKHJvdXRlID0gcm91dGVzLnBvcCgpKSAhPSBudWxsKSB7CiAgICAgICAgdGhpcy5yb3V0ZShyb3V0ZSwgdGhpcy5yb3V0ZXNbcm91dGVdKTsKICAgICAgfQogICAgfSwKCiAgICAvLyBDb252ZXJ0IGEgcm91dGUgc3RyaW5nIGludG8gYSByZWd1bGFyIGV4cHJlc3Npb24sIHN1aXRhYmxlIGZvciBtYXRjaGluZwogICAgLy8gYWdhaW5zdCB0aGUgY3VycmVudCBsb2NhdGlvbiBoYXNoLgogICAgX3JvdXRlVG9SZWdFeHA6IGZ1bmN0aW9uKHJvdXRlKSB7CiAgICAgIHJvdXRlID0gcm91dGUucmVwbGFjZShlc2NhcGVSZWdFeHAsICdcXCQmJykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG9wdGlvbmFsUGFyYW0sICcoPzokMSk/JykKICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKG5hbWVkUGFyYW0sICcoW15cL10rKScpCiAgICAgICAgICAgICAgICAgICAucmVwbGFjZShzcGxhdFBhcmFtLCAnKC4qPyknKTsKICAgICAgcmV0dXJuIG5ldyBSZWdFeHAoJ14nICsgcm91dGUgKyAnJCcpOwogICAgfSwKCiAgICAvLyBHaXZlbiBhIHJvdXRlLCBhbmQgYSBVUkwgZnJhZ21lbnQgdGhhdCBpdCBtYXRjaGVzLCByZXR1cm4gdGhlIGFycmF5IG9mCiAgICAvLyBleHRyYWN0ZWQgcGFyYW1ldGVycy4KICAgIF9leHRyYWN0UGFyYW1ldGVyczogZnVuY3Rpb24ocm91dGUsIGZyYWdtZW50KSB7CiAgICAgIHJldHVybiByb3V0ZS5leGVjKGZyYWdtZW50KS5zbGljZSgxKTsKICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLkhpc3RvcnkKICAvLyAtLS0tLS0tLS0tLS0tLS0tCgogIC8vIEhhbmRsZXMgY3Jvc3MtYnJvd3NlciBoaXN0b3J5IG1hbmFnZW1lbnQsIGJhc2VkIG9uIFVSTCBmcmFnbWVudHMuIElmIHRoZQogIC8vIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBgb25oYXNoY2hhbmdlYCwgZmFsbHMgYmFjayB0byBwb2xsaW5nLgogIHZhciBIaXN0b3J5ID0gQmFja2JvbmUuSGlzdG9yeSA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5oYW5kbGVycyA9IFtdOwogICAgXy5iaW5kQWxsKHRoaXMsICdjaGVja1VybCcpOwoKICAgIC8vIEVuc3VyZSB0aGF0IGBIaXN0b3J5YCBjYW4gYmUgdXNlZCBvdXRzaWRlIG9mIHRoZSBicm93c2VyLgogICAgaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgIHRoaXMubG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb247CiAgICAgIHRoaXMuaGlzdG9yeSA9IHdpbmRvdy5oaXN0b3J5OwogICAgfQogIH07CgogIC8vIENhY2hlZCByZWdleCBmb3Igc3RyaXBwaW5nIGEgbGVhZGluZyBoYXNoL3NsYXNoIGFuZCB0cmFpbGluZyBzcGFjZS4KICB2YXIgcm91dGVTdHJpcHBlciA9IC9eWyNcL118XHMrJC9nOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHN0cmlwcGluZyBsZWFkaW5nIGFuZCB0cmFpbGluZyBzbGFzaGVzLgogIHZhciByb290U3RyaXBwZXIgPSAvXlwvK3xcLyskL2c7CgogIC8vIENhY2hlZCByZWdleCBmb3IgZGV0ZWN0aW5nIE1TSUUuCiAgdmFyIGlzRXhwbG9yZXIgPSAvbXNpZSBbXHcuXSsvOwoKICAvLyBDYWNoZWQgcmVnZXggZm9yIHJlbW92aW5nIGEgdHJhaWxpbmcgc2xhc2guCiAgdmFyIHRyYWlsaW5nU2xhc2ggPSAvXC8kLzsKCiAgLy8gSGFzIHRoZSBoaXN0b3J5IGhhbmRsaW5nIGFscmVhZHkgYmVlbiBzdGFydGVkPwogIEhpc3Rvcnkuc3RhcnRlZCA9IGZhbHNlOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuSGlzdG9yeSoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoSGlzdG9yeS5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGludGVydmFsIHRvIHBvbGwgZm9yIGhhc2ggY2hhbmdlcywgaWYgbmVjZXNzYXJ5LCBpcwogICAgLy8gdHdlbnR5IHRpbWVzIGEgc2Vjb25kLgogICAgaW50ZXJ2YWw6IDUwLAoKICAgIC8vIEdldHMgdGhlIHRydWUgaGFzaCB2YWx1ZS4gQ2Fubm90IHVzZSBsb2NhdGlvbi5oYXNoIGRpcmVjdGx5IGR1ZSB0byBidWcKICAgIC8vIGluIEZpcmVmb3ggd2hlcmUgbG9jYXRpb24uaGFzaCB3aWxsIGFsd2F5cyBiZSBkZWNvZGVkLgogICAgZ2V0SGFzaDogZnVuY3Rpb24od2luZG93KSB7CiAgICAgIHZhciBtYXRjaCA9ICh3aW5kb3cgfHwgdGhpcykubG9jYXRpb24uaHJlZi5tYXRjaCgvIyguKikkLyk7CiAgICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogJyc7CiAgICB9LAoKICAgIC8vIEdldCB0aGUgY3Jvc3MtYnJvd3NlciBub3JtYWxpemVkIFVSTCBmcmFnbWVudCwgZWl0aGVyIGZyb20gdGhlIFVSTCwKICAgIC8vIHRoZSBoYXNoLCBvciB0aGUgb3ZlcnJpZGUuCiAgICBnZXRGcmFnbWVudDogZnVuY3Rpb24oZnJhZ21lbnQsIGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgIGlmIChmcmFnbWVudCA9PSBudWxsKSB7CiAgICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSB8fCAhdGhpcy5fd2FudHNIYXNoQ2hhbmdlIHx8IGZvcmNlUHVzaFN0YXRlKSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMubG9jYXRpb24ucGF0aG5hbWU7CiAgICAgICAgICB2YXIgcm9vdCA9IHRoaXMucm9vdC5yZXBsYWNlKHRyYWlsaW5nU2xhc2gsICcnKTsKICAgICAgICAgIGlmICghZnJhZ21lbnQuaW5kZXhPZihyb290KSkgZnJhZ21lbnQgPSBmcmFnbWVudC5zdWJzdHIocm9vdC5sZW5ndGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBmcmFnbWVudCA9IHRoaXMuZ2V0SGFzaCgpOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gZnJhZ21lbnQucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICB9LAoKICAgIC8vIFN0YXJ0IHRoZSBoYXNoIGNoYW5nZSBoYW5kbGluZywgcmV0dXJuaW5nIGB0cnVlYCBpZiB0aGUgY3VycmVudCBVUkwgbWF0Y2hlcwogICAgLy8gYW4gZXhpc3Rpbmcgcm91dGUsIGFuZCBgZmFsc2VgIG90aGVyd2lzZS4KICAgIHN0YXJ0OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChIaXN0b3J5LnN0YXJ0ZWQpIHRocm93IG5ldyBFcnJvcigiQmFja2JvbmUuaGlzdG9yeSBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQiKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gdHJ1ZTsKCiAgICAgIC8vIEZpZ3VyZSBvdXQgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbi4gRG8gd2UgbmVlZCBhbiBpZnJhbWU/CiAgICAgIC8vIElzIHB1c2hTdGF0ZSBkZXNpcmVkIC4uLiBpcyBpdCBhdmFpbGFibGU/CiAgICAgIHRoaXMub3B0aW9ucyAgICAgICAgICA9IF8uZXh0ZW5kKHt9LCB7cm9vdDogJy8nfSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKTsKICAgICAgdGhpcy5yb290ICAgICAgICAgICAgID0gdGhpcy5vcHRpb25zLnJvb3Q7CiAgICAgIHRoaXMuX3dhbnRzSGFzaENoYW5nZSA9IHRoaXMub3B0aW9ucy5oYXNoQ2hhbmdlICE9PSBmYWxzZTsKICAgICAgdGhpcy5fd2FudHNQdXNoU3RhdGUgID0gISF0aGlzLm9wdGlvbnMucHVzaFN0YXRlOwogICAgICB0aGlzLl9oYXNQdXNoU3RhdGUgICAgPSAhISh0aGlzLm9wdGlvbnMucHVzaFN0YXRlICYmIHRoaXMuaGlzdG9yeSAmJiB0aGlzLmhpc3RvcnkucHVzaFN0YXRlKTsKICAgICAgdmFyIGZyYWdtZW50ICAgICAgICAgID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICB2YXIgZG9jTW9kZSAgICAgICAgICAgPSBkb2N1bWVudC5kb2N1bWVudE1vZGU7CiAgICAgIHZhciBvbGRJRSAgICAgICAgICAgICA9IChpc0V4cGxvcmVyLmV4ZWMobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpKSAmJiAoIWRvY01vZGUgfHwgZG9jTW9kZSA8PSA3KSk7CgogICAgICAvLyBOb3JtYWxpemUgcm9vdCB0byBhbHdheXMgaW5jbHVkZSBhIGxlYWRpbmcgYW5kIHRyYWlsaW5nIHNsYXNoLgogICAgICB0aGlzLnJvb3QgPSAoJy8nICsgdGhpcy5yb290ICsgJy8nKS5yZXBsYWNlKHJvb3RTdHJpcHBlciwgJy8nKTsKCiAgICAgIGlmIChvbGRJRSAmJiB0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLmlmcmFtZSA9IEJhY2tib25lLiQoJzxpZnJhbWUgc3JjPSJqYXZhc2NyaXB0OjAiIHRhYmluZGV4PSItMSIgLz4nKS5oaWRlKCkuYXBwZW5kVG8oJ2JvZHknKVswXS5jb250ZW50V2luZG93OwogICAgICAgIHRoaXMubmF2aWdhdGUoZnJhZ21lbnQpOwogICAgICB9CgogICAgICAvLyBEZXBlbmRpbmcgb24gd2hldGhlciB3ZSdyZSB1c2luZyBwdXNoU3RhdGUgb3IgaGFzaGVzLCBhbmQgd2hldGhlcgogICAgICAvLyAnb25oYXNoY2hhbmdlJyBpcyBzdXBwb3J0ZWQsIGRldGVybWluZSBob3cgd2UgY2hlY2sgdGhlIFVSTCBzdGF0ZS4KICAgICAgaWYgKHRoaXMuX2hhc1B1c2hTdGF0ZSkgewogICAgICAgIEJhY2tib25lLiQod2luZG93KS5iaW5kKCdwb3BzdGF0ZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSAmJiAoJ29uaGFzaGNoYW5nZScgaW4gd2luZG93KSAmJiAhb2xkSUUpIHsKICAgICAgICBCYWNrYm9uZS4kKHdpbmRvdykuYmluZCgnaGFzaGNoYW5nZScsIHRoaXMuY2hlY2tVcmwpOwogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzSGFzaENoYW5nZSkgewogICAgICAgIHRoaXMuX2NoZWNrVXJsSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCh0aGlzLmNoZWNrVXJsLCB0aGlzLmludGVydmFsKTsKICAgICAgfQoKICAgICAgLy8gRGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSBiYXNlIHVybCwgZm9yIGEgcHVzaFN0YXRlIGxpbmsKICAgICAgLy8gb3BlbmVkIGJ5IGEgbm9uLXB1c2hTdGF0ZSBicm93c2VyLgogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciBsb2MgPSB0aGlzLmxvY2F0aW9uOwogICAgICB2YXIgYXRSb290ID0gbG9jLnBhdGhuYW1lLnJlcGxhY2UoL1teXC9dJC8sICckJi8nKSA9PT0gdGhpcy5yb290OwoKICAgICAgLy8gSWYgd2UndmUgc3RhcnRlZCBvZmYgd2l0aCBhIHJvdXRlIGZyb20gYSBgcHVzaFN0YXRlYC1lbmFibGVkIGJyb3dzZXIsCiAgICAgIC8vIGJ1dCB3ZSdyZSBjdXJyZW50bHkgaW4gYSBicm93c2VyIHRoYXQgZG9lc24ndCBzdXBwb3J0IGl0Li4uCiAgICAgIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UgJiYgdGhpcy5fd2FudHNQdXNoU3RhdGUgJiYgIXRoaXMuX2hhc1B1c2hTdGF0ZSAmJiAhYXRSb290KSB7CiAgICAgICAgdGhpcy5mcmFnbWVudCA9IHRoaXMuZ2V0RnJhZ21lbnQobnVsbCwgdHJ1ZSk7CiAgICAgICAgdGhpcy5sb2NhdGlvbi5yZXBsYWNlKHRoaXMucm9vdCArIHRoaXMubG9jYXRpb24uc2VhcmNoICsgJyMnICsgdGhpcy5mcmFnbWVudCk7CiAgICAgICAgLy8gUmV0dXJuIGltbWVkaWF0ZWx5IGFzIGJyb3dzZXIgd2lsbCBkbyByZWRpcmVjdCB0byBuZXcgdXJsCiAgICAgICAgcmV0dXJuIHRydWU7CgogICAgICAvLyBPciBpZiB3ZSd2ZSBzdGFydGVkIG91dCB3aXRoIGEgaGFzaC1iYXNlZCByb3V0ZSwgYnV0IHdlJ3JlIGN1cnJlbnRseQogICAgICAvLyBpbiBhIGJyb3dzZXIgd2hlcmUgaXQgY291bGQgYmUgYHB1c2hTdGF0ZWAtYmFzZWQgaW5zdGVhZC4uLgogICAgICB9IGVsc2UgaWYgKHRoaXMuX3dhbnRzUHVzaFN0YXRlICYmIHRoaXMuX2hhc1B1c2hTdGF0ZSAmJiBhdFJvb3QgJiYgbG9jLmhhc2gpIHsKICAgICAgICB0aGlzLmZyYWdtZW50ID0gdGhpcy5nZXRIYXNoKCkucmVwbGFjZShyb3V0ZVN0cmlwcGVyLCAnJyk7CiAgICAgICAgdGhpcy5oaXN0b3J5LnJlcGxhY2VTdGF0ZSh7fSwgZG9jdW1lbnQudGl0bGUsIHRoaXMucm9vdCArIHRoaXMuZnJhZ21lbnQgKyBsb2Muc2VhcmNoKTsKICAgICAgfQoKICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuc2lsZW50KSByZXR1cm4gdGhpcy5sb2FkVXJsKCk7CiAgICB9LAoKICAgIC8vIERpc2FibGUgQmFja2JvbmUuaGlzdG9yeSwgcGVyaGFwcyB0ZW1wb3JhcmlseS4gTm90IHVzZWZ1bCBpbiBhIHJlYWwgYXBwLAogICAgLy8gYnV0IHBvc3NpYmx5IHVzZWZ1bCBmb3IgdW5pdCB0ZXN0aW5nIFJvdXRlcnMuCiAgICBzdG9wOiBmdW5jdGlvbigpIHsKICAgICAgQmFja2JvbmUuJCh3aW5kb3cpLnVuYmluZCgncG9wc3RhdGUnLCB0aGlzLmNoZWNrVXJsKS51bmJpbmQoJ2hhc2hjaGFuZ2UnLCB0aGlzLmNoZWNrVXJsKTsKICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLl9jaGVja1VybEludGVydmFsKTsKICAgICAgSGlzdG9yeS5zdGFydGVkID0gZmFsc2U7CiAgICB9LAoKICAgIC8vIEFkZCBhIHJvdXRlIHRvIGJlIHRlc3RlZCB3aGVuIHRoZSBmcmFnbWVudCBjaGFuZ2VzLiBSb3V0ZXMgYWRkZWQgbGF0ZXIKICAgIC8vIG1heSBvdmVycmlkZSBwcmV2aW91cyByb3V0ZXMuCiAgICByb3V0ZTogZnVuY3Rpb24ocm91dGUsIGNhbGxiYWNrKSB7CiAgICAgIHRoaXMuaGFuZGxlcnMudW5zaGlmdCh7cm91dGU6IHJvdXRlLCBjYWxsYmFjazogY2FsbGJhY2t9KTsKICAgIH0sCgogICAgLy8gQ2hlY2tzIHRoZSBjdXJyZW50IFVSTCB0byBzZWUgaWYgaXQgaGFzIGNoYW5nZWQsIGFuZCBpZiBpdCBoYXMsCiAgICAvLyBjYWxscyBgbG9hZFVybGAsIG5vcm1hbGl6aW5nIGFjcm9zcyB0aGUgaGlkZGVuIGlmcmFtZS4KICAgIGNoZWNrVXJsOiBmdW5jdGlvbihlKSB7CiAgICAgIHZhciBjdXJyZW50ID0gdGhpcy5nZXRGcmFnbWVudCgpOwogICAgICBpZiAoY3VycmVudCA9PT0gdGhpcy5mcmFnbWVudCAmJiB0aGlzLmlmcmFtZSkgewogICAgICAgIGN1cnJlbnQgPSB0aGlzLmdldEZyYWdtZW50KHRoaXMuZ2V0SGFzaCh0aGlzLmlmcmFtZSkpOwogICAgICB9CiAgICAgIGlmIChjdXJyZW50ID09PSB0aGlzLmZyYWdtZW50KSByZXR1cm4gZmFsc2U7CiAgICAgIGlmICh0aGlzLmlmcmFtZSkgdGhpcy5uYXZpZ2F0ZShjdXJyZW50KTsKICAgICAgdGhpcy5sb2FkVXJsKCkgfHwgdGhpcy5sb2FkVXJsKHRoaXMuZ2V0SGFzaCgpKTsKICAgIH0sCgogICAgLy8gQXR0ZW1wdCB0byBsb2FkIHRoZSBjdXJyZW50IFVSTCBmcmFnbWVudC4gSWYgYSByb3V0ZSBzdWNjZWVkcyB3aXRoIGEKICAgIC8vIG1hdGNoLCByZXR1cm5zIGB0cnVlYC4gSWYgbm8gZGVmaW5lZCByb3V0ZXMgbWF0Y2hlcyB0aGUgZnJhZ21lbnQsCiAgICAvLyByZXR1cm5zIGBmYWxzZWAuCiAgICBsb2FkVXJsOiBmdW5jdGlvbihmcmFnbWVudE92ZXJyaWRlKSB7CiAgICAgIHZhciBmcmFnbWVudCA9IHRoaXMuZnJhZ21lbnQgPSB0aGlzLmdldEZyYWdtZW50KGZyYWdtZW50T3ZlcnJpZGUpOwogICAgICB2YXIgbWF0Y2hlZCA9IF8uYW55KHRoaXMuaGFuZGxlcnMsIGZ1bmN0aW9uKGhhbmRsZXIpIHsKICAgICAgICBpZiAoaGFuZGxlci5yb3V0ZS50ZXN0KGZyYWdtZW50KSkgewogICAgICAgICAgaGFuZGxlci5jYWxsYmFjayhmcmFnbWVudCk7CiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0pOwogICAgICByZXR1cm4gbWF0Y2hlZDsKICAgIH0sCgogICAgLy8gU2F2ZSBhIGZyYWdtZW50IGludG8gdGhlIGhhc2ggaGlzdG9yeSwgb3IgcmVwbGFjZSB0aGUgVVJMIHN0YXRlIGlmIHRoZQogICAgLy8gJ3JlcGxhY2UnIG9wdGlvbiBpcyBwYXNzZWQuIFlvdSBhcmUgcmVzcG9uc2libGUgZm9yIHByb3Blcmx5IFVSTC1lbmNvZGluZwogICAgLy8gdGhlIGZyYWdtZW50IGluIGFkdmFuY2UuCiAgICAvLwogICAgLy8gVGhlIG9wdGlvbnMgb2JqZWN0IGNhbiBjb250YWluIGB0cmlnZ2VyOiB0cnVlYCBpZiB5b3Ugd2lzaCB0byBoYXZlIHRoZQogICAgLy8gcm91dGUgY2FsbGJhY2sgYmUgZmlyZWQgKG5vdCB1c3VhbGx5IGRlc2lyYWJsZSksIG9yIGByZXBsYWNlOiB0cnVlYCwgaWYKICAgIC8vIHlvdSB3aXNoIHRvIG1vZGlmeSB0aGUgY3VycmVudCBVUkwgd2l0aG91dCBhZGRpbmcgYW4gZW50cnkgdG8gdGhlIGhpc3RvcnkuCiAgICBuYXZpZ2F0ZTogZnVuY3Rpb24oZnJhZ21lbnQsIG9wdGlvbnMpIHsKICAgICAgaWYgKCFIaXN0b3J5LnN0YXJ0ZWQpIHJldHVybiBmYWxzZTsKICAgICAgaWYgKCFvcHRpb25zIHx8IG9wdGlvbnMgPT09IHRydWUpIG9wdGlvbnMgPSB7dHJpZ2dlcjogb3B0aW9uc307CiAgICAgIGZyYWdtZW50ID0gdGhpcy5nZXRGcmFnbWVudChmcmFnbWVudCB8fCAnJyk7CiAgICAgIGlmICh0aGlzLmZyYWdtZW50ID09PSBmcmFnbWVudCkgcmV0dXJuOwogICAgICB0aGlzLmZyYWdtZW50ID0gZnJhZ21lbnQ7CiAgICAgIHZhciB1cmwgPSB0aGlzLnJvb3QgKyBmcmFnbWVudDsKCiAgICAgIC8vIElmIHB1c2hTdGF0ZSBpcyBhdmFpbGFibGUsIHdlIHVzZSBpdCB0byBzZXQgdGhlIGZyYWdtZW50IGFzIGEgcmVhbCBVUkwuCiAgICAgIGlmICh0aGlzLl9oYXNQdXNoU3RhdGUpIHsKICAgICAgICB0aGlzLmhpc3Rvcnlbb3B0aW9ucy5yZXBsYWNlID8gJ3JlcGxhY2VTdGF0ZScgOiAncHVzaFN0YXRlJ10oe30sIGRvY3VtZW50LnRpdGxlLCB1cmwpOwoKICAgICAgLy8gSWYgaGFzaCBjaGFuZ2VzIGhhdmVuJ3QgYmVlbiBleHBsaWNpdGx5IGRpc2FibGVkLCB1cGRhdGUgdGhlIGhhc2gKICAgICAgLy8gZnJhZ21lbnQgdG8gc3RvcmUgaGlzdG9yeS4KICAgICAgfSBlbHNlIGlmICh0aGlzLl93YW50c0hhc2hDaGFuZ2UpIHsKICAgICAgICB0aGlzLl91cGRhdGVIYXNoKHRoaXMubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIGlmICh0aGlzLmlmcmFtZSAmJiAoZnJhZ21lbnQgIT09IHRoaXMuZ2V0RnJhZ21lbnQodGhpcy5nZXRIYXNoKHRoaXMuaWZyYW1lKSkpKSB7CiAgICAgICAgICAvLyBPcGVuaW5nIGFuZCBjbG9zaW5nIHRoZSBpZnJhbWUgdHJpY2tzIElFNyBhbmQgZWFybGllciB0byBwdXNoIGEKICAgICAgICAgIC8vIGhpc3RvcnkgZW50cnkgb24gaGFzaC10YWcgY2hhbmdlLiAgV2hlbiByZXBsYWNlIGlzIHRydWUsIHdlIGRvbid0CiAgICAgICAgICAvLyB3YW50IHRoaXMuCiAgICAgICAgICBpZighb3B0aW9ucy5yZXBsYWNlKSB0aGlzLmlmcmFtZS5kb2N1bWVudC5vcGVuKCkuY2xvc2UoKTsKICAgICAgICAgIHRoaXMuX3VwZGF0ZUhhc2godGhpcy5pZnJhbWUubG9jYXRpb24sIGZyYWdtZW50LCBvcHRpb25zLnJlcGxhY2UpOwogICAgICAgIH0KCiAgICAgIC8vIElmIHlvdSd2ZSB0b2xkIHVzIHRoYXQgeW91IGV4cGxpY2l0bHkgZG9uJ3Qgd2FudCBmYWxsYmFjayBoYXNoY2hhbmdlLQogICAgICAvLyBiYXNlZCBoaXN0b3J5LCB0aGVuIGBuYXZpZ2F0ZWAgYmVjb21lcyBhIHBhZ2UgcmVmcmVzaC4KICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5sb2NhdGlvbi5hc3NpZ24odXJsKTsKICAgICAgfQogICAgICBpZiAob3B0aW9ucy50cmlnZ2VyKSB0aGlzLmxvYWRVcmwoZnJhZ21lbnQpOwogICAgfSwKCiAgICAvLyBVcGRhdGUgdGhlIGhhc2ggbG9jYXRpb24sIGVpdGhlciByZXBsYWNpbmcgdGhlIGN1cnJlbnQgZW50cnksIG9yIGFkZGluZwogICAgLy8gYSBuZXcgb25lIHRvIHRoZSBicm93c2VyIGhpc3RvcnkuCiAgICBfdXBkYXRlSGFzaDogZnVuY3Rpb24obG9jYXRpb24sIGZyYWdtZW50LCByZXBsYWNlKSB7CiAgICAgIGlmIChyZXBsYWNlKSB7CiAgICAgICAgdmFyIGhyZWYgPSBsb2NhdGlvbi5ocmVmLnJlcGxhY2UoLyhqYXZhc2NyaXB0OnwjKS4qJC8sICcnKTsKICAgICAgICBsb2NhdGlvbi5yZXBsYWNlKGhyZWYgKyAnIycgKyBmcmFnbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gU29tZSBicm93c2VycyByZXF1aXJlIHRoYXQgYGhhc2hgIGNvbnRhaW5zIGEgbGVhZGluZyAjLgogICAgICAgIGxvY2F0aW9uLmhhc2ggPSAnIycgKyBmcmFnbWVudDsKICAgICAgfQogICAgfQoKICB9KTsKCiAgLy8gQ3JlYXRlIHRoZSBkZWZhdWx0IEJhY2tib25lLmhpc3RvcnkuCiAgQmFja2JvbmUuaGlzdG9yeSA9IG5ldyBIaXN0b3J5OwoKICAvLyBCYWNrYm9uZS5WaWV3CiAgLy8gLS0tLS0tLS0tLS0tLQoKICAvLyBDcmVhdGluZyBhIEJhY2tib25lLlZpZXcgY3JlYXRlcyBpdHMgaW5pdGlhbCBlbGVtZW50IG91dHNpZGUgb2YgdGhlIERPTSwKICAvLyBpZiBhbiBleGlzdGluZyBlbGVtZW50IGlzIG5vdCBwcm92aWRlZC4uLgogIHZhciBWaWV3ID0gQmFja2JvbmUuVmlldyA9IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIHRoaXMuY2lkID0gXy51bmlxdWVJZCgndmlldycpOwogICAgdGhpcy5fY29uZmlndXJlKG9wdGlvbnMgfHwge30pOwogICAgdGhpcy5fZW5zdXJlRWxlbWVudCgpOwogICAgdGhpcy5pbml0aWFsaXplLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLmRlbGVnYXRlRXZlbnRzKCk7CiAgfTsKCiAgLy8gQ2FjaGVkIHJlZ2V4IHRvIHNwbGl0IGtleXMgZm9yIGBkZWxlZ2F0ZWAuCiAgdmFyIGRlbGVnYXRlRXZlbnRTcGxpdHRlciA9IC9eKFxTKylccyooLiopJC87CgogIC8vIExpc3Qgb2YgdmlldyBvcHRpb25zIHRvIGJlIG1lcmdlZCBhcyBwcm9wZXJ0aWVzLgogIHZhciB2aWV3T3B0aW9ucyA9IFsnbW9kZWwnLCAnY29sbGVjdGlvbicsICdlbCcsICdpZCcsICdhdHRyaWJ1dGVzJywgJ2NsYXNzTmFtZScsICd0YWdOYW1lJywgJ2V2ZW50cyddOwoKICAvLyBTZXQgdXAgYWxsIGluaGVyaXRhYmxlICoqQmFja2JvbmUuVmlldyoqIHByb3BlcnRpZXMgYW5kIG1ldGhvZHMuCiAgXy5leHRlbmQoVmlldy5wcm90b3R5cGUsIEV2ZW50cywgewoKICAgIC8vIFRoZSBkZWZhdWx0IGB0YWdOYW1lYCBvZiBhIFZpZXcncyBlbGVtZW50IGlzIGAiZGl2ImAuCiAgICB0YWdOYW1lOiAnZGl2JywKCiAgICAvLyBqUXVlcnkgZGVsZWdhdGUgZm9yIGVsZW1lbnQgbG9va3VwLCBzY29wZWQgdG8gRE9NIGVsZW1lbnRzIHdpdGhpbiB0aGUKICAgIC8vIGN1cnJlbnQgdmlldy4gVGhpcyBzaG91bGQgYmUgcHJlZmVyZWQgdG8gZ2xvYmFsIGxvb2t1cHMgd2hlcmUgcG9zc2libGUuCiAgICAkOiBmdW5jdGlvbihzZWxlY3RvcikgewogICAgICByZXR1cm4gdGhpcy4kZWwuZmluZChzZWxlY3Rvcik7CiAgICB9LAoKICAgIC8vIEluaXRpYWxpemUgaXMgYW4gZW1wdHkgZnVuY3Rpb24gYnkgZGVmYXVsdC4gT3ZlcnJpZGUgaXQgd2l0aCB5b3VyIG93bgogICAgLy8gaW5pdGlhbGl6YXRpb24gbG9naWMuCiAgICBpbml0aWFsaXplOiBmdW5jdGlvbigpe30sCgogICAgLy8gKipyZW5kZXIqKiBpcyB0aGUgY29yZSBmdW5jdGlvbiB0aGF0IHlvdXIgdmlldyBzaG91bGQgb3ZlcnJpZGUsIGluIG9yZGVyCiAgICAvLyB0byBwb3B1bGF0ZSBpdHMgZWxlbWVudCAoYHRoaXMuZWxgKSwgd2l0aCB0aGUgYXBwcm9wcmlhdGUgSFRNTC4gVGhlCiAgICAvLyBjb252ZW50aW9uIGlzIGZvciAqKnJlbmRlcioqIHRvIGFsd2F5cyByZXR1cm4gYHRoaXNgLgogICAgcmVuZGVyOiBmdW5jdGlvbigpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9LAoKICAgIC8vIFJlbW92ZSB0aGlzIHZpZXcgYnkgdGFraW5nIHRoZSBlbGVtZW50IG91dCBvZiB0aGUgRE9NLCBhbmQgcmVtb3ZpbmcgYW55CiAgICAvLyBhcHBsaWNhYmxlIEJhY2tib25lLkV2ZW50cyBsaXN0ZW5lcnMuCiAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLiRlbC5yZW1vdmUoKTsKICAgICAgdGhpcy5zdG9wTGlzdGVuaW5nKCk7CiAgICAgIHJldHVybiB0aGlzOwogICAgfSwKCiAgICAvLyBGb3Igc21hbGwgYW1vdW50cyBvZiBET00gRWxlbWVudHMsIHdoZXJlIGEgZnVsbC1ibG93biB0ZW1wbGF0ZSBpc24ndAogICAgLy8gbmVlZGVkLCB1c2UgKiptYWtlKiogdG8gbWFudWZhY3R1cmUgZWxlbWVudHMsIG9uZSBhdCBhIHRpbWUuCiAgICAvLwogICAgLy8gICAgIHZhciBlbCA9IHRoaXMubWFrZSgnbGknLCB7J2NsYXNzJzogJ3Jvdyd9LCB0aGlzLm1vZGVsLmVzY2FwZSgndGl0bGUnKSk7CiAgICAvLwogICAgbWFrZTogZnVuY3Rpb24odGFnTmFtZSwgYXR0cmlidXRlcywgY29udGVudCkgewogICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KHRhZ05hbWUpOwogICAgICBpZiAoYXR0cmlidXRlcykgQmFja2JvbmUuJChlbCkuYXR0cihhdHRyaWJ1dGVzKTsKICAgICAgaWYgKGNvbnRlbnQgIT0gbnVsbCkgQmFja2JvbmUuJChlbCkuaHRtbChjb250ZW50KTsKICAgICAgcmV0dXJuIGVsOwogICAgfSwKCiAgICAvLyBDaGFuZ2UgdGhlIHZpZXcncyBlbGVtZW50IChgdGhpcy5lbGAgcHJvcGVydHkpLCBpbmNsdWRpbmcgZXZlbnQKICAgIC8vIHJlLWRlbGVnYXRpb24uCiAgICBzZXRFbGVtZW50OiBmdW5jdGlvbihlbGVtZW50LCBkZWxlZ2F0ZSkgewogICAgICBpZiAodGhpcy4kZWwpIHRoaXMudW5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICB0aGlzLiRlbCA9IGVsZW1lbnQgaW5zdGFuY2VvZiBCYWNrYm9uZS4kID8gZWxlbWVudCA6IEJhY2tib25lLiQoZWxlbWVudCk7CiAgICAgIHRoaXMuZWwgPSB0aGlzLiRlbFswXTsKICAgICAgaWYgKGRlbGVnYXRlICE9PSBmYWxzZSkgdGhpcy5kZWxlZ2F0ZUV2ZW50cygpOwogICAgICByZXR1cm4gdGhpczsKICAgIH0sCgogICAgLy8gU2V0IGNhbGxiYWNrcywgd2hlcmUgYHRoaXMuZXZlbnRzYCBpcyBhIGhhc2ggb2YKICAgIC8vCiAgICAvLyAqeyJldmVudCBzZWxlY3RvciI6ICJjYWxsYmFjayJ9KgogICAgLy8KICAgIC8vICAgICB7CiAgICAvLyAgICAgICAnbW91c2Vkb3duIC50aXRsZSc6ICAnZWRpdCcsCiAgICAvLyAgICAgICAnY2xpY2sgLmJ1dHRvbic6ICAgICAnc2F2ZScKICAgIC8vICAgICAgICdjbGljayAub3Blbic6ICAgICAgIGZ1bmN0aW9uKGUpIHsgLi4uIH0KICAgIC8vICAgICB9CiAgICAvLwogICAgLy8gcGFpcnMuIENhbGxiYWNrcyB3aWxsIGJlIGJvdW5kIHRvIHRoZSB2aWV3LCB3aXRoIGB0aGlzYCBzZXQgcHJvcGVybHkuCiAgICAvLyBVc2VzIGV2ZW50IGRlbGVnYXRpb24gZm9yIGVmZmljaWVuY3kuCiAgICAvLyBPbWl0dGluZyB0aGUgc2VsZWN0b3IgYmluZHMgdGhlIGV2ZW50IHRvIGB0aGlzLmVsYC4KICAgIC8vIFRoaXMgb25seSB3b3JrcyBmb3IgZGVsZWdhdGUtYWJsZSBldmVudHM6IG5vdCBgZm9jdXNgLCBgYmx1cmAsIGFuZAogICAgLy8gbm90IGBjaGFuZ2VgLCBgc3VibWl0YCwgYW5kIGByZXNldGAgaW4gSW50ZXJuZXQgRXhwbG9yZXIuCiAgICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICAgIGlmICghKGV2ZW50cyB8fCAoZXZlbnRzID0gXy5yZXN1bHQodGhpcywgJ2V2ZW50cycpKSkpIHJldHVybjsKICAgICAgdGhpcy51bmRlbGVnYXRlRXZlbnRzKCk7CiAgICAgIGZvciAodmFyIGtleSBpbiBldmVudHMpIHsKICAgICAgICB2YXIgbWV0aG9kID0gZXZlbnRzW2tleV07CiAgICAgICAgaWYgKCFfLmlzRnVuY3Rpb24obWV0aG9kKSkgbWV0aG9kID0gdGhpc1tldmVudHNba2V5XV07CiAgICAgICAgaWYgKCFtZXRob2QpIHRocm93IG5ldyBFcnJvcignTWV0aG9kICInICsgZXZlbnRzW2tleV0gKyAnIiBkb2VzIG5vdCBleGlzdCcpOwogICAgICAgIHZhciBtYXRjaCA9IGtleS5tYXRjaChkZWxlZ2F0ZUV2ZW50U3BsaXR0ZXIpOwogICAgICAgIHZhciBldmVudE5hbWUgPSBtYXRjaFsxXSwgc2VsZWN0b3IgPSBtYXRjaFsyXTsKICAgICAgICBtZXRob2QgPSBfLmJpbmQobWV0aG9kLCB0aGlzKTsKICAgICAgICBldmVudE5hbWUgKz0gJy5kZWxlZ2F0ZUV2ZW50cycgKyB0aGlzLmNpZDsKICAgICAgICBpZiAoc2VsZWN0b3IgPT09ICcnKSB7CiAgICAgICAgICB0aGlzLiRlbC5iaW5kKGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy4kZWwuZGVsZWdhdGUoc2VsZWN0b3IsIGV2ZW50TmFtZSwgbWV0aG9kKTsKICAgICAgICB9CiAgICAgIH0KICAgIH0sCgogICAgLy8gQ2xlYXJzIGFsbCBjYWxsYmFja3MgcHJldmlvdXNseSBib3VuZCB0byB0aGUgdmlldyB3aXRoIGBkZWxlZ2F0ZUV2ZW50c2AuCiAgICAvLyBZb3UgdXN1YWxseSBkb24ndCBuZWVkIHRvIHVzZSB0aGlzLCBidXQgbWF5IHdpc2ggdG8gaWYgeW91IGhhdmUgbXVsdGlwbGUKICAgIC8vIEJhY2tib25lIHZpZXdzIGF0dGFjaGVkIHRvIHRoZSBzYW1lIERPTSBlbGVtZW50LgogICAgdW5kZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMuJGVsLnVuYmluZCgnLmRlbGVnYXRlRXZlbnRzJyArIHRoaXMuY2lkKTsKICAgIH0sCgogICAgLy8gUGVyZm9ybXMgdGhlIGluaXRpYWwgY29uZmlndXJhdGlvbiBvZiBhIFZpZXcgd2l0aCBhIHNldCBvZiBvcHRpb25zLgogICAgLy8gS2V5cyB3aXRoIHNwZWNpYWwgbWVhbmluZyAqKG1vZGVsLCBjb2xsZWN0aW9uLCBpZCwgY2xhc3NOYW1lKSosIGFyZQogICAgLy8gYXR0YWNoZWQgZGlyZWN0bHkgdG8gdGhlIHZpZXcuCiAgICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmICh0aGlzLm9wdGlvbnMpIG9wdGlvbnMgPSBfLmV4dGVuZCh7fSwgXy5yZXN1bHQodGhpcywgJ29wdGlvbnMnKSwgb3B0aW9ucyk7CiAgICAgIF8uZXh0ZW5kKHRoaXMsIF8ucGljayhvcHRpb25zLCB2aWV3T3B0aW9ucykpOwogICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfSwKCiAgICAvLyBFbnN1cmUgdGhhdCB0aGUgVmlldyBoYXMgYSBET00gZWxlbWVudCB0byByZW5kZXIgaW50by4KICAgIC8vIElmIGB0aGlzLmVsYCBpcyBhIHN0cmluZywgcGFzcyBpdCB0aHJvdWdoIGAkKClgLCB0YWtlIHRoZSBmaXJzdAogICAgLy8gbWF0Y2hpbmcgZWxlbWVudCwgYW5kIHJlLWFzc2lnbiBpdCB0byBgZWxgLiBPdGhlcndpc2UsIGNyZWF0ZQogICAgLy8gYW4gZWxlbWVudCBmcm9tIHRoZSBgaWRgLCBgY2xhc3NOYW1lYCBhbmQgYHRhZ05hbWVgIHByb3BlcnRpZXMuCiAgICBfZW5zdXJlRWxlbWVudDogZnVuY3Rpb24oKSB7CiAgICAgIGlmICghdGhpcy5lbCkgewogICAgICAgIHZhciBhdHRycyA9IF8uZXh0ZW5kKHt9LCBfLnJlc3VsdCh0aGlzLCAnYXR0cmlidXRlcycpKTsKICAgICAgICBpZiAodGhpcy5pZCkgYXR0cnMuaWQgPSBfLnJlc3VsdCh0aGlzLCAnaWQnKTsKICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUpIGF0dHJzWydjbGFzcyddID0gXy5yZXN1bHQodGhpcywgJ2NsYXNzTmFtZScpOwogICAgICAgIHRoaXMuc2V0RWxlbWVudCh0aGlzLm1ha2UoXy5yZXN1bHQodGhpcywgJ3RhZ05hbWUnKSwgYXR0cnMpLCBmYWxzZSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5zZXRFbGVtZW50KF8ucmVzdWx0KHRoaXMsICdlbCcpLCBmYWxzZSk7CiAgICAgIH0KICAgIH0KCiAgfSk7CgogIC8vIEJhY2tib25lLnN5bmMKICAvLyAtLS0tLS0tLS0tLS0tCgogIC8vIE1hcCBmcm9tIENSVUQgdG8gSFRUUCBmb3Igb3VyIGRlZmF1bHQgYEJhY2tib25lLnN5bmNgIGltcGxlbWVudGF0aW9uLgogIHZhciBtZXRob2RNYXAgPSB7CiAgICAnY3JlYXRlJzogJ1BPU1QnLAogICAgJ3VwZGF0ZSc6ICdQVVQnLAogICAgJ3BhdGNoJzogICdQQVRDSCcsCiAgICAnZGVsZXRlJzogJ0RFTEVURScsCiAgICAncmVhZCc6ICAgJ0dFVCcKICB9OwoKICAvLyBPdmVycmlkZSB0aGlzIGZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgbWFubmVyIGluIHdoaWNoIEJhY2tib25lIHBlcnNpc3RzCiAgLy8gbW9kZWxzIHRvIHRoZSBzZXJ2ZXIuIFlvdSB3aWxsIGJlIHBhc3NlZCB0aGUgdHlwZSBvZiByZXF1ZXN0LCBhbmQgdGhlCiAgLy8gbW9kZWwgaW4gcXVlc3Rpb24uIEJ5IGRlZmF1bHQsIG1ha2VzIGEgUkVTVGZ1bCBBamF4IHJlcXVlc3QKICAvLyB0byB0aGUgbW9kZWwncyBgdXJsKClgLiBTb21lIHBvc3NpYmxlIGN1c3RvbWl6YXRpb25zIGNvdWxkIGJlOgogIC8vCiAgLy8gKiBVc2UgYHNldFRpbWVvdXRgIHRvIGJhdGNoIHJhcGlkLWZpcmUgdXBkYXRlcyBpbnRvIGEgc2luZ2xlIHJlcXVlc3QuCiAgLy8gKiBTZW5kIHVwIHRoZSBtb2RlbHMgYXMgWE1MIGluc3RlYWQgb2YgSlNPTi4KICAvLyAqIFBlcnNpc3QgbW9kZWxzIHZpYSBXZWJTb2NrZXRzIGluc3RlYWQgb2YgQWpheC4KICAvLwogIC8vIFR1cm4gb24gYEJhY2tib25lLmVtdWxhdGVIVFRQYCBpbiBvcmRlciB0byBzZW5kIGBQVVRgIGFuZCBgREVMRVRFYCByZXF1ZXN0cwogIC8vIGFzIGBQT1NUYCwgd2l0aCBhIGBfbWV0aG9kYCBwYXJhbWV0ZXIgY29udGFpbmluZyB0aGUgdHJ1ZSBIVFRQIG1ldGhvZCwKICAvLyBhcyB3ZWxsIGFzIGFsbCByZXF1ZXN0cyB3aXRoIHRoZSBib2R5IGFzIGBhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWRgCiAgLy8gaW5zdGVhZCBvZiBgYXBwbGljYXRpb24vanNvbmAgd2l0aCB0aGUgbW9kZWwgaW4gYSBwYXJhbSBuYW1lZCBgbW9kZWxgLgogIC8vIFVzZWZ1bCB3aGVuIGludGVyZmFjaW5nIHdpdGggc2VydmVyLXNpZGUgbGFuZ3VhZ2VzIGxpa2UgKipQSFAqKiB0aGF0IG1ha2UKICAvLyBpdCBkaWZmaWN1bHQgdG8gcmVhZCB0aGUgYm9keSBvZiBgUFVUYCByZXF1ZXN0cy4KICBCYWNrYm9uZS5zeW5jID0gZnVuY3Rpb24obWV0aG9kLCBtb2RlbCwgb3B0aW9ucykgewogICAgdmFyIHR5cGUgPSBtZXRob2RNYXBbbWV0aG9kXTsKCiAgICAvLyBEZWZhdWx0IG9wdGlvbnMsIHVubGVzcyBzcGVjaWZpZWQuCiAgICBfLmRlZmF1bHRzKG9wdGlvbnMgfHwgKG9wdGlvbnMgPSB7fSksIHsKICAgICAgZW11bGF0ZUhUVFA6IEJhY2tib25lLmVtdWxhdGVIVFRQLAogICAgICBlbXVsYXRlSlNPTjogQmFja2JvbmUuZW11bGF0ZUpTT04KICAgIH0pOwoKICAgIC8vIERlZmF1bHQgSlNPTi1yZXF1ZXN0IG9wdGlvbnMuCiAgICB2YXIgcGFyYW1zID0ge3R5cGU6IHR5cGUsIGRhdGFUeXBlOiAnanNvbid9OwoKICAgIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgYSBVUkwuCiAgICBpZiAoIW9wdGlvbnMudXJsKSB7CiAgICAgIHBhcmFtcy51cmwgPSBfLnJlc3VsdChtb2RlbCwgJ3VybCcpIHx8IHVybEVycm9yKCk7CiAgICB9CgogICAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSB0aGUgYXBwcm9wcmlhdGUgcmVxdWVzdCBkYXRhLgogICAgaWYgKG9wdGlvbnMuZGF0YSA9PSBudWxsICYmIG1vZGVsICYmIChtZXRob2QgPT09ICdjcmVhdGUnIHx8IG1ldGhvZCA9PT0gJ3VwZGF0ZScgfHwgbWV0aG9kID09PSAncGF0Y2gnKSkgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24vanNvbic7CiAgICAgIHBhcmFtcy5kYXRhID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5hdHRycyB8fCBtb2RlbC50b0pTT04ob3B0aW9ucykpOwogICAgfQoKICAgIC8vIEZvciBvbGRlciBzZXJ2ZXJzLCBlbXVsYXRlIEpTT04gYnkgZW5jb2RpbmcgdGhlIHJlcXVlc3QgaW50byBhbiBIVE1MLWZvcm0uCiAgICBpZiAob3B0aW9ucy5lbXVsYXRlSlNPTikgewogICAgICBwYXJhbXMuY29udGVudFR5cGUgPSAnYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkJzsKICAgICAgcGFyYW1zLmRhdGEgPSBwYXJhbXMuZGF0YSA/IHttb2RlbDogcGFyYW1zLmRhdGF9IDoge307CiAgICB9CgogICAgLy8gRm9yIG9sZGVyIHNlcnZlcnMsIGVtdWxhdGUgSFRUUCBieSBtaW1pY2tpbmcgdGhlIEhUVFAgbWV0aG9kIHdpdGggYF9tZXRob2RgCiAgICAvLyBBbmQgYW4gYFgtSFRUUC1NZXRob2QtT3ZlcnJpZGVgIGhlYWRlci4KICAgIGlmIChvcHRpb25zLmVtdWxhdGVIVFRQICYmICh0eXBlID09PSAnUFVUJyB8fCB0eXBlID09PSAnREVMRVRFJyB8fCB0eXBlID09PSAnUEFUQ0gnKSkgewogICAgICBwYXJhbXMudHlwZSA9ICdQT1NUJzsKICAgICAgaWYgKG9wdGlvbnMuZW11bGF0ZUpTT04pIHBhcmFtcy5kYXRhLl9tZXRob2QgPSB0eXBlOwogICAgICB2YXIgYmVmb3JlU2VuZCA9IG9wdGlvbnMuYmVmb3JlU2VuZDsKICAgICAgb3B0aW9ucy5iZWZvcmVTZW5kID0gZnVuY3Rpb24oeGhyKSB7CiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1gtSFRUUC1NZXRob2QtT3ZlcnJpZGUnLCB0eXBlKTsKICAgICAgICBpZiAoYmVmb3JlU2VuZCkgcmV0dXJuIGJlZm9yZVNlbmQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KCiAgICAvLyBEb24ndCBwcm9jZXNzIGRhdGEgb24gYSBub24tR0VUIHJlcXVlc3QuCiAgICBpZiAocGFyYW1zLnR5cGUgIT09ICdHRVQnICYmICFvcHRpb25zLmVtdWxhdGVKU09OKSB7CiAgICAgIHBhcmFtcy5wcm9jZXNzRGF0YSA9IGZhbHNlOwogICAgfQoKICAgIHZhciBzdWNjZXNzID0gb3B0aW9ucy5zdWNjZXNzOwogICAgb3B0aW9ucy5zdWNjZXNzID0gZnVuY3Rpb24ocmVzcCwgc3RhdHVzLCB4aHIpIHsKICAgICAgaWYgKHN1Y2Nlc3MpIHN1Y2Nlc3MocmVzcCwgc3RhdHVzLCB4aHIpOwogICAgICBtb2RlbC50cmlnZ2VyKCdzeW5jJywgbW9kZWwsIHJlc3AsIG9wdGlvbnMpOwogICAgfTsKCiAgICB2YXIgZXJyb3IgPSBvcHRpb25zLmVycm9yOwogICAgb3B0aW9ucy5lcnJvciA9IGZ1bmN0aW9uKHhociwgc3RhdHVzLCB0aHJvd24pIHsKICAgICAgaWYgKGVycm9yKSBlcnJvcihtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgICAgbW9kZWwudHJpZ2dlcignZXJyb3InLCBtb2RlbCwgeGhyLCBvcHRpb25zKTsKICAgIH07CgogICAgLy8gTWFrZSB0aGUgcmVxdWVzdCwgYWxsb3dpbmcgdGhlIHVzZXIgdG8gb3ZlcnJpZGUgYW55IEFqYXggb3B0aW9ucy4KICAgIHZhciB4aHIgPSBCYWNrYm9uZS5hamF4KF8uZXh0ZW5kKHBhcmFtcywgb3B0aW9ucykpOwogICAgbW9kZWwudHJpZ2dlcigncmVxdWVzdCcsIG1vZGVsLCB4aHIsIG9wdGlvbnMpOwogICAgcmV0dXJuIHhocjsKICB9OwoKICAvLyBTZXQgdGhlIGRlZmF1bHQgaW1wbGVtZW50YXRpb24gb2YgYEJhY2tib25lLmFqYXhgIHRvIHByb3h5IHRocm91Z2ggdG8gYCRgLgogIEJhY2tib25lLmFqYXggPSBmdW5jdGlvbigpIHsKICAgIHJldHVybiBCYWNrYm9uZS4kLmFqYXguYXBwbHkoQmFja2JvbmUuJCwgYXJndW1lbnRzKTsKICB9OwoKICAvLyBIZWxwZXJzCiAgLy8gLS0tLS0tLQoKICAvLyBIZWxwZXIgZnVuY3Rpb24gdG8gY29ycmVjdGx5IHNldCB1cCB0aGUgcHJvdG90eXBlIGNoYWluLCBmb3Igc3ViY2xhc3Nlcy4KICAvLyBTaW1pbGFyIHRvIGBnb29nLmluaGVyaXRzYCwgYnV0IHVzZXMgYSBoYXNoIG9mIHByb3RvdHlwZSBwcm9wZXJ0aWVzIGFuZAogIC8vIGNsYXNzIHByb3BlcnRpZXMgdG8gYmUgZXh0ZW5kZWQuCiAgdmFyIGV4dGVuZCA9IGZ1bmN0aW9uKHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7CiAgICB2YXIgcGFyZW50ID0gdGhpczsKICAgIHZhciBjaGlsZDsKCiAgICAvLyBUaGUgY29uc3RydWN0b3IgZnVuY3Rpb24gZm9yIHRoZSBuZXcgc3ViY2xhc3MgaXMgZWl0aGVyIGRlZmluZWQgYnkgeW91CiAgICAvLyAodGhlICJjb25zdHJ1Y3RvciIgcHJvcGVydHkgaW4geW91ciBgZXh0ZW5kYCBkZWZpbml0aW9uKSwgb3IgZGVmYXVsdGVkCiAgICAvLyBieSB1cyB0byBzaW1wbHkgY2FsbCB0aGUgcGFyZW50J3MgY29uc3RydWN0b3IuCiAgICBpZiAocHJvdG9Qcm9wcyAmJiBfLmhhcyhwcm90b1Byb3BzLCAnY29uc3RydWN0b3InKSkgewogICAgICBjaGlsZCA9IHByb3RvUHJvcHMuY29uc3RydWN0b3I7CiAgICB9IGVsc2UgewogICAgICBjaGlsZCA9IGZ1bmN0aW9uKCl7IHBhcmVudC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOyB9OwogICAgfQoKICAgIC8vIEFkZCBzdGF0aWMgcHJvcGVydGllcyB0byB0aGUgY29uc3RydWN0b3IgZnVuY3Rpb24sIGlmIHN1cHBsaWVkLgogICAgXy5leHRlbmQoY2hpbGQsIHBhcmVudCwgc3RhdGljUHJvcHMpOwoKICAgIC8vIFNldCB0aGUgcHJvdG90eXBlIGNoYWluIHRvIGluaGVyaXQgZnJvbSBgcGFyZW50YCwgd2l0aG91dCBjYWxsaW5nCiAgICAvLyBgcGFyZW50YCdzIGNvbnN0cnVjdG9yIGZ1bmN0aW9uLgogICAgdmFyIFN1cnJvZ2F0ZSA9IGZ1bmN0aW9uKCl7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfTsKICAgIFN1cnJvZ2F0ZS5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOwogICAgY2hpbGQucHJvdG90eXBlID0gbmV3IFN1cnJvZ2F0ZTsKCiAgICAvLyBBZGQgcHJvdG90eXBlIHByb3BlcnRpZXMgKGluc3RhbmNlIHByb3BlcnRpZXMpIHRvIHRoZSBzdWJjbGFzcywKICAgIC8vIGlmIHN1cHBsaWVkLgogICAgaWYgKHByb3RvUHJvcHMpIF8uZXh0ZW5kKGNoaWxkLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7CgogICAgLy8gU2V0IGEgY29udmVuaWVuY2UgcHJvcGVydHkgaW4gY2FzZSB0aGUgcGFyZW50J3MgcHJvdG90eXBlIGlzIG5lZWRlZAogICAgLy8gbGF0ZXIuCiAgICBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOwoKICAgIHJldHVybiBjaGlsZDsKICB9OwoKICAvLyBTZXQgdXAgaW5oZXJpdGFuY2UgZm9yIHRoZSBtb2RlbCwgY29sbGVjdGlvbiwgcm91dGVyLCB2aWV3IGFuZCBoaXN0b3J5LgogIE1vZGVsLmV4dGVuZCA9IENvbGxlY3Rpb24uZXh0ZW5kID0gUm91dGVyLmV4dGVuZCA9IFZpZXcuZXh0ZW5kID0gSGlzdG9yeS5leHRlbmQgPSBleHRlbmQ7CgogIC8vIFRocm93IGFuIGVycm9yIHdoZW4gYSBVUkwgaXMgbmVlZGVkLCBhbmQgbm9uZSBpcyBzdXBwbGllZC4KICB2YXIgdXJsRXJyb3IgPSBmdW5jdGlvbigpIHsKICAgIHRocm93IG5ldyBFcnJvcignQSAidXJsIiBwcm9wZXJ0eSBvciBmdW5jdGlvbiBtdXN0IGJlIHNwZWNpZmllZCcpOwogIH07Cgp9KS5jYWxsKHRoaXMpOwovKgpDb3B5cmlnaHQgKGMpIDIwMTEtMjAxMyBAV2FsbWFydExhYnMKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvCmRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlCnJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vcgpzZWxsIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcKRlJPTSwgT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUgpERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCiovCgo7OwooZnVuY3Rpb24oKSB7CgovKmdsb2JhbCBjbG9uZUluaGVyaXRWYXJzLCBjcmVhdGVJbmhlcml0VmFycywgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBnZXRWYWx1ZSwgaW5oZXJpdFZhcnMgKi8KCi8vc3VwcG9ydCB6ZXB0by5mb3JFYWNoIG9uIGpRdWVyeQppZiAoISQuZm4uZm9yRWFjaCkgewogICQuZm4uZm9yRWFjaCA9IGZ1bmN0aW9uKGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgICAkLmZuLmVhY2guY2FsbCh0aGlzLCBmdW5jdGlvbihpbmRleCkgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgdGhpcywgaW5kZXgpOwogICAgfSk7CiAgfTsKfQoKdmFyIHZpZXdOYW1lQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctbmFtZScsCiAgICB2aWV3Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctY2lkJywKICAgIHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtdmlldy1oZWxwZXInOwoKLy92aWV3IGluc3RhbmNlcwp2YXIgdmlld3NJbmRleGVkQnlDaWQgPSB7fTsKCnZhciBUaG9yYXggPSB0aGlzLlRob3JheCA9IHsKICBWRVJTSU9OOiAnMi4wLjByYzEnLAogIHRlbXBsYXRlUGF0aFByZWZpeDogJycsCiAgdGVtcGxhdGVzOiB7fSwKICAvL3ZpZXcgY2xhc3NlcwogIFZpZXdzOiB7fSwKICAvL2NlcnRhaW4gZXJyb3IgcHJvbmUgcGllY2VzIG9mIGNvZGUgKG9uIEFuZHJvaWQgb25seSBpdCBzZWVtcykKICAvL2FyZSB3cmFwcGVkIGluIGEgdHJ5IGNhdGNoIGJsb2NrLCB0aGVuIHRyaWdnZXIgdGhpcyBoYW5kbGVyIGluCiAgLy90aGUgY2F0Y2gsIHdpdGggdGhlIG5hbWUgb2YgdGhlIGZ1bmN0aW9uIG9yIGV2ZW50IHRoYXQgd2FzCiAgLy90cnlpbmcgdG8gYmUgZXhlY3V0ZWQuIE92ZXJyaWRlIHRoaXMgd2l0aCBhIGN1c3RvbSBoYW5kbGVyCiAgLy90byBkZWJ1ZyAvIGxvZyAvIGV0YwogIG9uRXhjZXB0aW9uOiBmdW5jdGlvbihuYW1lLCBlcnIpIHsKICAgIHRocm93IGVycjsKICB9Cn07CgpUaG9yYXguVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHsKICBjb25zdHJ1Y3RvcjogZnVuY3Rpb24oKSB7CiAgICB2YXIgcmVzcG9uc2UgPSBCYWNrYm9uZS5WaWV3LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgICBpZiAob2JqLmN0b3IpIHsKICAgICAgICBvYmouY3Rvci5jYWxsKHRoaXMsIHJlc3BvbnNlKTsKICAgICAgfQogICAgfSwgdGhpcyk7CiAgICByZXR1cm4gcmVzcG9uc2U7CiAgfSwKICBfY29uZmlndXJlOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICB2YXIgc2VsZiA9IHRoaXM7CgogICAgdGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkID0ge307CiAgICB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQgPSB7fTsKCiAgICAvLyBTZXR1cCBvYmplY3QgZXZlbnQgdHJhY2tpbmcKICAgIF8uZWFjaChpbmhlcml0VmFycywgZnVuY3Rpb24ob2JqKSB7CiAgICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgICB9KTsKCiAgICB2aWV3c0luZGV4ZWRCeUNpZFt0aGlzLmNpZF0gPSB0aGlzOwogICAgdGhpcy5jaGlsZHJlbiA9IHt9OwogICAgdGhpcy5fcmVuZGVyQ291bnQgPSAwOwoKICAgIC8vdGhpcy5vcHRpb25zIGlzIHJlbW92ZWQgaW4gVGhvcmF4LlZpZXcsIHdlIG1lcmdlIHBhc3NlZAogICAgLy9wcm9wZXJ0aWVzIGRpcmVjdGx5IHdpdGggdGhlIHZpZXcgYW5kIHRlbXBsYXRlIGNvbnRleHQKICAgIF8uZXh0ZW5kKHRoaXMsIG9wdGlvbnMgfHwge30pOwoKICAgIC8vIFNldHVwIGhlbHBlcnMKICAgIGJpbmRIZWxwZXJzLmNhbGwodGhpcyk7CgogICAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgICAgaWYgKG9iai5jb25maWd1cmUpIHsKICAgICAgICBvYmouY29uZmlndXJlLmNhbGwodGhpcyk7CiAgICAgIH0KICAgIH0sIHRoaXMpOwogIH0sCgogIHNldEVsZW1lbnQgOiBmdW5jdGlvbigpIHsKICAgIHZhciByZXNwb25zZSA9IEJhY2tib25lLlZpZXcucHJvdG90eXBlLnNldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIHRoaXMubmFtZSAmJiB0aGlzLiRlbC5hdHRyKHZpZXdOYW1lQXR0cmlidXRlTmFtZSwgdGhpcy5uYW1lKTsKICAgIHRoaXMuJGVsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUsIHRoaXMuY2lkKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAoKICBfYWRkQ2hpbGQ6IGZ1bmN0aW9uKHZpZXcpIHsKICAgIHRoaXMuY2hpbGRyZW5bdmlldy5jaWRdID0gdmlldzsKICAgIGlmICghdmlldy5wYXJlbnQpIHsKICAgICAgdmlldy5wYXJlbnQgPSB0aGlzOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGlsZCcsIHZpZXcpOwogICAgcmV0dXJuIHZpZXc7CiAgfSwKCiAgX3JlbW92ZUNoaWxkOiBmdW5jdGlvbih2aWV3KSB7CiAgICBkZWxldGUgdGhpcy5jaGlsZHJlblt2aWV3LmNpZF07CiAgICB2aWV3LnBhcmVudCA9IG51bGw7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBkZXN0cm95OiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICBvcHRpb25zID0gXy5kZWZhdWx0cyhvcHRpb25zIHx8IHt9LCB7CiAgICAgIGNoaWxkcmVuOiB0cnVlCiAgICB9KTsKICAgIF8uZWFjaCh0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWQsIHRoaXMudW5iaW5kRGF0YU9iamVjdCwgdGhpcyk7CiAgICB0aGlzLnRyaWdnZXIoJ2Rlc3Ryb3llZCcpOwogICAgZGVsZXRlIHZpZXdzSW5kZXhlZEJ5Q2lkW3RoaXMuY2lkXTsKICAgIF8uZWFjaCh0aGlzLmNoaWxkcmVuLCBmdW5jdGlvbihjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGlmIChvcHRpb25zLmNoaWxkcmVuKSB7CiAgICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICB9CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudCkgewogICAgICB0aGlzLnBhcmVudC5fcmVtb3ZlQ2hpbGQodGhpcyk7CiAgICB9CiAgICB0aGlzLnJlbW92ZSgpOyAvLyBXaWxsIGNhbGwgc3RvcExpc3RlbmluZygpCiAgfSwKCiAgcmVuZGVyOiBmdW5jdGlvbihvdXRwdXQpIHsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IF8uZmlsdGVyKHRoaXMuY2hpbGRyZW4sIGZ1bmN0aW9uKGNoaWxkKSB7IHJldHVybiBjaGlsZC5faGVscGVyT3B0aW9uczsgfSk7CgogICAgdmFyIGNoaWxkcmVuID0ge307CiAgICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQsIGtleSkgewogICAgICBpZiAoIWNoaWxkLl9oZWxwZXJPcHRpb25zKSB7CiAgICAgICAgY2hpbGRyZW5ba2V5XSA9IGNoaWxkOwogICAgICB9CiAgICB9KTsKICAgIHRoaXMuY2hpbGRyZW4gPSBjaGlsZHJlbjsKCiAgICBpZiAoXy5pc1VuZGVmaW5lZChvdXRwdXQpIHx8ICghXy5pc0VsZW1lbnQob3V0cHV0KSAmJiAhVGhvcmF4LlV0aWwuaXMkKG91dHB1dCkgJiYgIShvdXRwdXQgJiYgb3V0cHV0LmVsKSAmJiAhXy5pc1N0cmluZyhvdXRwdXQpICYmICFfLmlzRnVuY3Rpb24ob3V0cHV0KSkpIHsKICAgICAgLy8gdHJ5IG9uZSBtb3JlIHRpbWUgdG8gYXNzaWduIHRoZSB0ZW1wbGF0ZSwgaWYgd2UgZG9uJ3QKICAgICAgLy8geWV0IGhhdmUgb25lIHdlIG11c3QgcmFpc2UKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAndGVtcGxhdGUnLCB7CiAgICAgICAgcmVxdWlyZWQ6IHRydWUKICAgICAgfSk7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy50ZW1wbGF0ZSk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihvdXRwdXQpKSB7CiAgICAgIG91dHB1dCA9IHRoaXMucmVuZGVyVGVtcGxhdGUob3V0cHV0KTsKICAgIH0KCiAgICAvLyBEZXN0cm95IGFueSBoZWxwZXJzIHRoYXQgbWF5IGJlIGxpbmdlcmluZwogICAgXy5lYWNoKHRoaXMuX3ByZXZpb3VzSGVscGVycywgZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgY2hpbGQuZGVzdHJveSgpOwogICAgICBjaGlsZC5wYXJlbnQgPSB1bmRlZmluZWQ7CiAgICB9KTsKICAgIHRoaXMuX3ByZXZpb3VzSGVscGVycyA9IHVuZGVmaW5lZDsKCiAgICAvL2FjY2VwdCBhIHZpZXcsIHN0cmluZywgSGFuZGxlYmFycy5TYWZlU3RyaW5nIG9yIERPTSBlbGVtZW50CiAgICB0aGlzLmh0bWwoKG91dHB1dCAmJiBvdXRwdXQuZWwpIHx8IChvdXRwdXQgJiYgb3V0cHV0LnN0cmluZykgfHwgb3V0cHV0KTsKICAgICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgICB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkJyk7CiAgICByZXR1cm4gb3V0cHV0OwogIH0sCgogIGNvbnRleHQ6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCAodGhpcy5tb2RlbCAmJiB0aGlzLm1vZGVsLmF0dHJpYnV0ZXMpIHx8IHt9KTsKICB9LAoKICBfZ2V0Q29udGV4dDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gXy5leHRlbmQoe30sIHRoaXMsIGdldFZhbHVlKHRoaXMsICdjb250ZXh0JykgfHwge30pOwogIH0sCgogIC8vIFByaXZhdGUgdmFyaWFibGVzIGluIGhhbmRsZWJhcnMgLyBvcHRpb25zLmRhdGEgaW4gdGVtcGxhdGUgaGVscGVycwogIF9nZXREYXRhOiBmdW5jdGlvbihkYXRhKSB7CiAgICByZXR1cm4gewogICAgICB2aWV3OiB0aGlzLAogICAgICBjaWQ6IF8udW5pcXVlSWQoJ3QnKSwKICAgICAgeWllbGQ6IGZ1bmN0aW9uKCkgewogICAgICAgIC8vIGZuIGlzIHNlZWRlZCBieSB0ZW1wbGF0ZSBoZWxwZXIgcGFzc2luZyBjb250ZXh0IHRvIGRhdGEKICAgICAgICByZXR1cm4gZGF0YS5mbiAmJiBkYXRhLmZuKGRhdGEpOwogICAgICB9CiAgICB9OwogIH0sCgogIF9nZXRIZWxwZXJzOiBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmhlbHBlcnMpIHsKICAgICAgcmV0dXJuIF8uZXh0ZW5kKHt9LCBIYW5kbGViYXJzLmhlbHBlcnMsIHRoaXMuaGVscGVycyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gSGFuZGxlYmFycy5oZWxwZXJzOwogICAgfQoKICB9LAoKICByZW5kZXJUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgY29udGV4dCwgaWdub3JlRXJyb3JzKSB7CiAgICB2YXIgdGVtcGxhdGU7CiAgICBjb250ZXh0ID0gY29udGV4dCB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CiAgICBpZiAoXy5pc0Z1bmN0aW9uKGZpbGUpKSB7CiAgICAgIHRlbXBsYXRlID0gZmlsZTsKICAgIH0gZWxzZSB7CiAgICAgIHRlbXBsYXRlID0gVGhvcmF4LlV0aWwuZ2V0VGVtcGxhdGUoZmlsZSwgaWdub3JlRXJyb3JzKTsKICAgIH0KICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgcmV0dXJuICcnOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRlbXBsYXRlKGNvbnRleHQsIHsKICAgICAgICBoZWxwZXJzOiB0aGlzLl9nZXRIZWxwZXJzKCksCiAgICAgICAgZGF0YTogdGhpcy5fZ2V0RGF0YShjb250ZXh0KQogICAgICB9KTsKICAgIH0KICB9LAoKICBlbnN1cmVSZW5kZXJlZDogZnVuY3Rpb24oKSB7CiAgICAhdGhpcy5fcmVuZGVyQ291bnQgJiYgdGhpcy5yZW5kZXIoKTsKICB9LAoKICBhcHBlbmRUbzogZnVuY3Rpb24oZWwpIHsKICAgIHRoaXMuZW5zdXJlUmVuZGVyZWQoKTsKICAgICQoZWwpLmFwcGVuZCh0aGlzLmVsKTsKICAgIHRoaXMudHJpZ2dlcigncmVhZHknLCB7dGFyZ2V0OiB0aGlzfSk7CiAgfSwKCiAgaHRtbDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKF8uaXNVbmRlZmluZWQoaHRtbCkpIHsKICAgICAgcmV0dXJuIHRoaXMuZWwuaW5uZXJIVE1MOwogICAgfSBlbHNlIHsKICAgICAgLy8gRXZlbnQgZm9yIElFIGVsZW1lbnQgZml4ZXMKICAgICAgdGhpcy50cmlnZ2VyKCdiZWZvcmU6YXBwZW5kJyk7CiAgICAgIHZhciBlbGVtZW50ID0gdGhpcy5fcmVwbGFjZUhUTUwoaHRtbCk7CiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJyk7CiAgICAgIHJldHVybiBlbGVtZW50OwogICAgfQogIH0sCgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgdGhpcy5lbC5pbm5lckhUTUwgPSAiIjsKICAgIHJldHVybiB0aGlzLiRlbC5hcHBlbmQoaHRtbCk7CiAgfSwKCiAgX2FuY2hvckNsaWNrOiBmdW5jdGlvbihldmVudCkgewogICAgdmFyIHRhcmdldCA9ICQoZXZlbnQuY3VycmVudFRhcmdldCksCiAgICAgICAgaHJlZiA9IHRhcmdldC5hdHRyKCdocmVmJyk7CiAgICAvLyBSb3V0ZSBhbnl0aGluZyB0aGF0IHN0YXJ0cyB3aXRoICMgb3IgLyAoZXhjbHVkaW5nIC8vZG9tYWluIHVybHMpCiAgICBpZiAoaHJlZiAmJiAoaHJlZlswXSA9PT0gJyMnIHx8IChocmVmWzBdID09PSAnLycgJiYgaHJlZlsxXSAhPT0gJy8nKSkpIHsKICAgICAgQmFja2JvbmUuaGlzdG9yeS5uYXZpZ2F0ZShocmVmLCB7CiAgICAgICAgdHJpZ2dlcjogdHJ1ZQogICAgICB9KTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHRydWU7CiAgfQp9KTsKClRob3JheC5WaWV3LmV4dGVuZCA9IGZ1bmN0aW9uKCkgewogIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwoKICB2YXIgY2hpbGQgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIGNoaWxkLl9fcGFyZW50X18gPSB0aGlzOwoKICByZXNldEluaGVyaXRWYXJzKGNoaWxkKTsKCiAgcmV0dXJuIGNoaWxkOwp9OwoKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5WaWV3LCBUaG9yYXguVmlld3MpOwoKZnVuY3Rpb24gYmluZEhlbHBlcnMoKSB7CiAgaWYgKHRoaXMuaGVscGVycykgewogICAgXy5lYWNoKHRoaXMuaGVscGVycywgZnVuY3Rpb24oaGVscGVyLCBuYW1lKSB7CiAgICAgIHZhciB2aWV3ID0gdGhpczsKICAgICAgdGhpcy5oZWxwZXJzW25hbWVdID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKSwKICAgICAgICAgICAgb3B0aW9ucyA9IF8ubGFzdChhcmdzKTsKICAgICAgICBvcHRpb25zLmNvbnRleHQgPSB0aGlzOwogICAgICAgIHJldHVybiBoZWxwZXIuYXBwbHkodmlldywgYXJncyk7CiAgICAgIH07CiAgICB9LCB0aGlzKTsKICB9Cn0KCi8vJChzZWxlY3RvcikudmlldygpIGhlbHBlcgokLmZuLnZpZXcgPSBmdW5jdGlvbihvcHRpb25zKSB7CiAgb3B0aW9ucyA9IF8uZGVmYXVsdHMob3B0aW9ucyB8fCB7fSwgewogICAgaGVscGVyOiB0cnVlCiAgfSk7CiAgdmFyIHNlbGVjdG9yID0gJ1snICsgdmlld0NpZEF0dHJpYnV0ZU5hbWUgKyAnXSc7CiAgaWYgKCFvcHRpb25zLmhlbHBlcikgewogICAgc2VsZWN0b3IgKz0gJzpub3QoWycgKyB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSArICddKSc7CiAgfQogIHZhciBlbCA9ICQodGhpcykuY2xvc2VzdChzZWxlY3Rvcik7CiAgcmV0dXJuIChlbCAmJiB2aWV3c0luZGV4ZWRCeUNpZFtlbC5hdHRyKHZpZXdDaWRBdHRyaWJ1dGVOYW1lKV0pIHx8IGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyOnRydWUsIGNsb25lRXZlbnRzOiB0cnVlICovCmZ1bmN0aW9uIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihrbGFzcywgaGFzaCkgewogIHZhciAkc3VwZXIgPSBrbGFzcy5leHRlbmQ7CiAga2xhc3MuZXh0ZW5kID0gZnVuY3Rpb24oKSB7CiAgICB2YXIgY2hpbGQgPSAkc3VwZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGlmIChjaGlsZC5wcm90b3R5cGUubmFtZSkgewogICAgICBoYXNoW2NoaWxkLnByb3RvdHlwZS5uYW1lXSA9IGNoaWxkOwogICAgfQogICAgcmV0dXJuIGNoaWxkOwogIH07Cn0KCmZ1bmN0aW9uIHJlZ2lzdHJ5R2V0KG9iamVjdCwgdHlwZSwgbmFtZSwgaWdub3JlRXJyb3JzKSB7CiAgdmFyIHRhcmdldCA9IG9iamVjdFt0eXBlXSwKICAgICAgdmFsdWU7CiAgaWYgKG5hbWUuaW5kZXhPZignLicpID49IDApIHsKICAgIHZhciBiaXRzID0gbmFtZS5zcGxpdCgvXC4vKTsKICAgIG5hbWUgPSBiaXRzLnBvcCgpOwogICAgXy5lYWNoKGJpdHMsIGZ1bmN0aW9uKGtleSkgewogICAgICB0YXJnZXQgPSB0YXJnZXRba2V5XTsKICAgIH0pOwogIH0KICB0YXJnZXQgJiYgKHZhbHVlID0gdGFyZ2V0W25hbWVdKTsKICBpZiAoIXZhbHVlICYmICFpZ25vcmVFcnJvcnMpIHsKICAgIHRocm93IG5ldyBFcnJvcih0eXBlICsgJzogJyArIG5hbWUgKyAnIGRvZXMgbm90IGV4aXN0LicpOwogIH0gZWxzZSB7CiAgICByZXR1cm4gdmFsdWU7CiAgfQp9CgpmdW5jdGlvbiBhc3NpZ25UZW1wbGF0ZShhdHRyaWJ1dGVOYW1lLCBvcHRpb25zKSB7CiAgdmFyIHRlbXBsYXRlOwogIC8vIGlmIGF0dHJpYnV0ZSBpcyB0aGUgbmFtZSBvZiB0ZW1wbGF0ZSB0byBmZXRjaAogIGlmIChfLmlzU3RyaW5nKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXNbYXR0cmlidXRlTmFtZV0sIHRydWUpOwogIC8vIGVsc2UgdHJ5IGFuZCBmZXRjaCB0aGUgdGVtcGxhdGUgYmFzZWQgb24gdGhlIG5hbWUKICB9IGVsc2UgaWYgKHRoaXMubmFtZSAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMubmFtZSArIChvcHRpb25zLmV4dGVuc2lvbiB8fCAnJyksIHRydWUpOwogIH0KICAvLyBDb2xsZWN0aW9uVmlldyBhbmQgTGF5b3V0VmlldyBoYXZlIGEgZGVmYXVsdFRlbXBsYXRlIHRoYXQgbWF5IGJlIHVzZWQgaWYgbm9uZQogIC8vIHdhcyBmb3VuZCwgcmVndWxhciB2aWV3cyBtdXN0IGhhdmUgYSB0ZW1wbGF0ZSBpZiByZW5kZXIoKSBpcyBjYWxsZWQKICBpZiAoIXRlbXBsYXRlICYmIGF0dHJpYnV0ZU5hbWUgPT09ICd0ZW1wbGF0ZScgJiYgdGhpcy5fZGVmYXVsdFRlbXBsYXRlKSB7CiAgICB0ZW1wbGF0ZSA9IHRoaXMuX2RlZmF1bHRUZW1wbGF0ZTsKICB9CiAgLy8gaWYgd2UgZm91bmQgc29tZXRoaW5nLCBhc3NpZ24gaXQKICBpZiAodGVtcGxhdGUgJiYgIV8uaXNGdW5jdGlvbih0aGlzW2F0dHJpYnV0ZU5hbWVdKSkgewogICAgdGhpc1thdHRyaWJ1dGVOYW1lXSA9IHRlbXBsYXRlOwogIH0KICAvLyBpZiBub3RoaW5nIHdhcyBmb3VuZCBhbmQgaXQncyByZXF1aXJlZCwgdGhyb3cKICBpZiAob3B0aW9ucy5yZXF1aXJlZCAmJiAhXy5pc0Z1bmN0aW9uKHRoaXNbYXR0cmlidXRlTmFtZV0pKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1ZpZXcgJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJyByZXF1aXJlczogJyArIGF0dHJpYnV0ZU5hbWUpOwogIH0KfQoKLy8gZ2V0VmFsdWUgaXMgdXNlZCBpbnN0ZWFkIG9mIF8ucmVzdWx0IGJlY2F1c2Ugd2UKLy8gbmVlZCBhbiBleHRyYSBzY29wZSBwYXJhbWV0ZXIsIGFuZCB3aWxsIG1pbmlmeQovLyBiZXR0ZXIgdGhhbiBfLnJlc3VsdApmdW5jdGlvbiBnZXRWYWx1ZShvYmplY3QsIHByb3AsIHNjb3BlKSB7CiAgaWYgKCEob2JqZWN0ICYmIG9iamVjdFtwcm9wXSkpIHsKICAgIHJldHVybiBudWxsOwogIH0KICByZXR1cm4gXy5pc0Z1bmN0aW9uKG9iamVjdFtwcm9wXSkKICAgID8gb2JqZWN0W3Byb3BdLmNhbGwoc2NvcGUgfHwgb2JqZWN0KQogICAgOiBvYmplY3RbcHJvcF07Cn0KCnZhciBpbmhlcml0VmFycyA9IHt9OwpmdW5jdGlvbiBjcmVhdGVJbmhlcml0VmFycyhzZWxmKSB7CiAgLy8gRW5zdXJlIHRoYXQgd2UgaGF2ZSBvdXIgc3RhdGljIGV2ZW50IG9iamVjdHMKICBfLmVhY2goaW5oZXJpdFZhcnMsIGZ1bmN0aW9uKG9iaikgewogICAgaWYgKCFzZWxmW29iai5uYW1lXSkgewogICAgICBzZWxmW29iai5uYW1lXSA9IFtdOwogICAgfQogIH0pOwp9CmZ1bmN0aW9uIHJlc2V0SW5oZXJpdFZhcnMoc2VsZikgewogIC8vIEVuc3VyZSB0aGF0IHdlIGhhdmUgb3VyIHN0YXRpYyBldmVudCBvYmplY3RzCiAgXy5lYWNoKGluaGVyaXRWYXJzLCBmdW5jdGlvbihvYmopIHsKICAgIHNlbGZbb2JqLm5hbWVdID0gW107CiAgfSk7Cn0KZnVuY3Rpb24gd2Fsa0luaGVyaXRUcmVlKHNvdXJjZSwgZmllbGROYW1lLCBpc1N0YXRpYywgY2FsbGJhY2spIHsKICB2YXIgdHJlZSA9IFtdOwogIGlmIChfLmhhcyhzb3VyY2UsIGZpZWxkTmFtZSkpIHsKICAgIHRyZWUucHVzaChzb3VyY2UpOwogIH0KICB2YXIgaXRlcmF0ZSA9IHNvdXJjZTsKICBpZiAoaXNTdGF0aWMpIHsKICAgIHdoaWxlIChpdGVyYXRlID0gaXRlcmF0ZS5fX3BhcmVudF9fKSB7CiAgICAgIGlmIChfLmhhcyhpdGVyYXRlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUpOwogICAgICB9CiAgICB9CiAgfSBlbHNlIHsKICAgIGl0ZXJhdGUgPSBpdGVyYXRlLmNvbnN0cnVjdG9yOwogICAgd2hpbGUgKGl0ZXJhdGUpIHsKICAgICAgaWYgKGl0ZXJhdGUucHJvdG90eXBlICYmIF8uaGFzKGl0ZXJhdGUucHJvdG90eXBlLCBmaWVsZE5hbWUpKSB7CiAgICAgICAgdHJlZS5wdXNoKGl0ZXJhdGUucHJvdG90eXBlKTsKICAgICAgfQogICAgICBpdGVyYXRlID0gaXRlcmF0ZS5fX3N1cGVyX18gJiYgaXRlcmF0ZS5fX3N1cGVyX18uY29uc3RydWN0b3I7CiAgICB9CiAgfQoKICB2YXIgaSA9IHRyZWUubGVuZ3RoOwogIHdoaWxlIChpLS0pIHsKICAgIF8uZWFjaChnZXRWYWx1ZSh0cmVlW2ldLCBmaWVsZE5hbWUsIHNvdXJjZSksIGNhbGxiYWNrKTsKICB9Cn0KCmZ1bmN0aW9uIG9iamVjdEV2ZW50cyh0YXJnZXQsIGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICBpZiAoXy5pc09iamVjdChjYWxsYmFjaykpIHsKICAgIHZhciBzcGVjID0gaW5oZXJpdFZhcnNbZXZlbnROYW1lXTsKICAgIGlmIChzcGVjICYmIHNwZWMuZXZlbnQpIHsKICAgICAgYWRkRXZlbnRzKHRhcmdldFsnXycgKyBldmVudE5hbWUgKyAnRXZlbnRzJ10sIGNhbGxiYWNrLCBjb250ZXh0KTsKICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfQp9CmZ1bmN0aW9uIGFkZEV2ZW50cyh0YXJnZXQsIHNvdXJjZSwgY29udGV4dCkgewogIF8uZWFjaChzb3VyY2UsIGZ1bmN0aW9uKGNhbGxiYWNrLCBldmVudE5hbWUpIHsKICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgIF8uZWFjaChjYWxsYmFjaywgZnVuY3Rpb24oY2IpIHsKICAgICAgICB0YXJnZXQucHVzaChbZXZlbnROYW1lLCBjYiwgY29udGV4dF0pOwogICAgICB9KTsKICAgIH0gZWxzZSB7CiAgICAgIHRhcmdldC5wdXNoKFtldmVudE5hbWUsIGNhbGxiYWNrLCBjb250ZXh0XSk7CiAgICB9CiAgfSk7Cn0KCmZ1bmN0aW9uIGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpIHsKICBpZiAoIW9wdGlvbnMgfHwgIW9wdGlvbnMuZGF0YSkgewogICAgdGhyb3cgbmV3IEVycm9yKCdIYW5kbGViYXJzIHRlbXBsYXRlIGNvbXBpbGVkIHdpdGhvdXQgZGF0YSwgdXNlOiBIYW5kbGViYXJzLmNvbXBpbGUodGVtcGxhdGUsIHtkYXRhOiB0cnVlfSknKTsKICB9CiAgcmV0dXJuIG9wdGlvbnMuZGF0YTsKfQoKLy8gVGhlc2Ugd2hpdGVsaXN0ZWQgYXR0cmlidXRlcyB3aWxsIGJlIHRoZSBvbmx5IG9uZXMgcGFzc2VkCi8vIGZyb20gdGhlIG9wdGlvbnMgaGFzaCB0byBUaG9yYXguVXRpbC50YWcKdmFyIGh0bWxBdHRyaWJ1dGVzVG9Db3B5ID0gWydpZCcsICdjbGFzc05hbWUnLCAndGFnTmFtZSddOwoKLy8gSW4gaGVscGVycyAidGFnTmFtZSIgb3IgInRhZyIgbWF5IGJlIHNwZWNpZmllZCwgYXMgd2VsbAovLyBhcyAiY2xhc3MiIG9yICJjbGFzc05hbWUiLiBOb3JtYWxpemUgdG8gInRhZ05hbWUiIGFuZAovLyAiY2xhc3NOYW1lIiB0byBtYXRjaCB0aGUgcHJvcGVydHkgbmFtZXMgdXNlZCBieSBCYWNrYm9uZQovLyBqUXVlcnksIGV0Yy4gU3BlY2lhbCBjYXNlIGZvciAiY2xhc3NOYW1lIiBpbgovLyBUaG9yYXguVXRpbC50YWc6IHdpbGwgYmUgcmV3cml0dGVuIGFzICJjbGFzcyIgaW4KLy8gZ2VuZXJhdGVkIEhUTUwuCmZ1bmN0aW9uIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMpIHsKICBpZiAob3B0aW9ucy50YWcpIHsKICAgIG9wdGlvbnMudGFnTmFtZSA9IG9wdGlvbnMudGFnOwogICAgZGVsZXRlIG9wdGlvbnMudGFnOwogIH0KICBpZiAob3B0aW9uc1snY2xhc3MnXSkgewogICAgb3B0aW9ucy5jbGFzc05hbWUgPSBvcHRpb25zWydjbGFzcyddOwogICAgZGVsZXRlIG9wdGlvbnNbJ2NsYXNzJ107CiAgfQp9CgpUaG9yYXguVXRpbCA9IHsKICBnZXRWaWV3SW5zdGFuY2U6IGZ1bmN0aW9uKG5hbWUsIGF0dHJpYnV0ZXMpIHsKICAgIGF0dHJpYnV0ZXMgPSBhdHRyaWJ1dGVzIHx8IHt9OwogICAgaWYgKF8uaXNTdHJpbmcobmFtZSkpIHsKICAgICAgdmFyIEtsYXNzID0gcmVnaXN0cnlHZXQoVGhvcmF4LCAnVmlld3MnLCBuYW1lLCBmYWxzZSk7CiAgICAgIHJldHVybiBLbGFzcy5jaWQgPyBfLmV4dGVuZChLbGFzcywgYXR0cmlidXRlcyB8fCB7fSkgOiBuZXcgS2xhc3MoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgaWYgKF8uaXNGdW5jdGlvbihuYW1lKSkgewogICAgICByZXR1cm4gbmV3IG5hbWUoYXR0cmlidXRlcyk7CiAgICB9IGVsc2UgewogICAgICByZXR1cm4gbmFtZTsKICAgIH0KICB9LAoKICBnZXRUZW1wbGF0ZTogZnVuY3Rpb24oZmlsZSwgaWdub3JlRXJyb3JzKSB7CiAgICAvL2FwcGVuZCB0aGUgdGVtcGxhdGUgcGF0aCBwcmVmaXggaWYgaXQgaXMgbWlzc2luZwogICAgdmFyIHBhdGhQcmVmaXggPSBUaG9yYXgudGVtcGxhdGVQYXRoUHJlZml4LAogICAgICAgIHRlbXBsYXRlOwogICAgaWYgKHBhdGhQcmVmaXggJiYgZmlsZS5zdWJzdHIoMCwgcGF0aFByZWZpeC5sZW5ndGgpICE9PSBwYXRoUHJlZml4KSB7CiAgICAgIGZpbGUgPSBwYXRoUHJlZml4ICsgZmlsZTsKICAgIH0KCiAgICAvLyBXaXRob3V0IGV4dGVuc2lvbgogICAgZmlsZSA9IGZpbGUucmVwbGFjZSgvXC5oYW5kbGViYXJzJC8sICcnKTsKICAgIHRlbXBsYXRlID0gVGhvcmF4LnRlbXBsYXRlc1tmaWxlXTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgLy8gV2l0aCBleHRlbnNpb24KICAgICAgZmlsZSA9IGZpbGUgKyAnLmhhbmRsZWJhcnMnOwogICAgICB0ZW1wbGF0ZSA9IFRob3JheC50ZW1wbGF0ZXNbZmlsZV07CiAgICB9CgogICAgaWYgKCF0ZW1wbGF0ZSAmJiAhaWdub3JlRXJyb3JzKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcigndGVtcGxhdGVzOiAnICsgZmlsZSArICcgZG9lcyBub3QgZXhpc3QuJyk7CiAgICB9CiAgICByZXR1cm4gdGVtcGxhdGU7CiAgfSwKCiAgLy8nc2VsZWN0b3InIGlzIG5vdCBwcmVzZW50IGluICQoJzxwPjwvcD4nKQogIC8vVE9ETzogaW52ZXN0aWdhZ2UgYSBiZXR0ZXIgZGV0ZWN0aW9uIG1ldGhvZAogIGlzJDogZnVuY3Rpb24ob2JqKSB7CiAgICByZXR1cm4gXy5pc09iamVjdChvYmopICYmICgnbGVuZ3RoJyBpbiBvYmopOwogIH0sCiAgZXhwYW5kVG9rZW46IGZ1bmN0aW9uKGlucHV0LCBzY29wZSkgewogICAgaWYgKGlucHV0ICYmIGlucHV0LmluZGV4T2YgJiYgaW5wdXQuaW5kZXhPZigne3snKSA+PSAwKSB7CiAgICAgIHZhciByZSA9IC8oPzpcez9bXntdKyl8KD86XHtceyhbXn1dKylcfVx9KS9nLAogICAgICAgICAgbWF0Y2gsCiAgICAgICAgICByZXQgPSBbXTsKICAgICAgZnVuY3Rpb24gZGVyZWYodG9rZW4sIHNjb3BlKSB7CiAgICAgICAgaWYgKHRva2VuLm1hdGNoKC9eKCJ8JykvKSAmJiB0b2tlbi5tYXRjaCgvKCJ8JykkLykpIHsKICAgICAgICAgIHJldHVybiB0b2tlbi5yZXBsYWNlKC8oXigifCcpfCgnfCIpJCkvZywgJycpOwogICAgICAgIH0KICAgICAgICB2YXIgc2VnbWVudHMgPSB0b2tlbi5zcGxpdCgnLicpLAogICAgICAgICAgICBsZW4gPSBzZWdtZW50cy5sZW5ndGg7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IHNjb3BlICYmIGkgPCBsZW47IGkrKykgewogICAgICAgICAgaWYgKHNlZ21lbnRzW2ldICE9PSAndGhpcycpIHsKICAgICAgICAgICAgc2NvcGUgPSBzY29wZVtzZWdtZW50c1tpXV07CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBzY29wZTsKICAgICAgfQogICAgICB3aGlsZSAobWF0Y2ggPSByZS5leGVjKGlucHV0KSkgewogICAgICAgIGlmIChtYXRjaFsxXSkgewogICAgICAgICAgdmFyIHBhcmFtcyA9IG1hdGNoWzFdLnNwbGl0KC9ccysvKTsKICAgICAgICAgIGlmIChwYXJhbXMubGVuZ3RoID4gMSkgewogICAgICAgICAgICB2YXIgaGVscGVyID0gcGFyYW1zLnNoaWZ0KCk7CiAgICAgICAgICAgIHBhcmFtcyA9IF8ubWFwKHBhcmFtcywgZnVuY3Rpb24ocGFyYW0pIHsgcmV0dXJuIGRlcmVmKHBhcmFtLCBzY29wZSk7IH0pOwogICAgICAgICAgICBpZiAoSGFuZGxlYmFycy5oZWxwZXJzW2hlbHBlcl0pIHsKICAgICAgICAgICAgICByZXQucHVzaChIYW5kbGViYXJzLmhlbHBlcnNbaGVscGVyXS5hcHBseShzY29wZSwgcGFyYW1zKSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgLy8gSWYgdGhlIGhlbHBlciBpcyBub3QgZGVmaW5lZCBkbyBub3RoaW5nCiAgICAgICAgICAgICAgcmV0LnB1c2gobWF0Y2hbMF0pOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXQucHVzaChkZXJlZihwYXJhbXNbMF0sIHNjb3BlKSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldC5wdXNoKG1hdGNoWzBdKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaW5wdXQgPSByZXQuam9pbignJyk7CiAgICB9CiAgICByZXR1cm4gaW5wdXQ7CiAgfSwKICB0YWc6IGZ1bmN0aW9uKGF0dHJpYnV0ZXMsIGNvbnRlbnQsIHNjb3BlKSB7CiAgICB2YXIgaHRtbEF0dHJpYnV0ZXMgPSBfLm9taXQoYXR0cmlidXRlcywgJ3RhZ05hbWUnKSwKICAgICAgICB0YWcgPSBhdHRyaWJ1dGVzLnRhZ05hbWUgfHwgJ2Rpdic7CiAgICByZXR1cm4gJzwnICsgdGFnICsgJyAnICsgXy5tYXAoaHRtbEF0dHJpYnV0ZXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgaWYgKF8uaXNVbmRlZmluZWQodmFsdWUpIHx8IGtleSA9PT0gJ2V4cGFuZC10b2tlbnMnKSB7CiAgICAgICAgcmV0dXJuICcnOwogICAgICB9CiAgICAgIHZhciBmb3JtYXR0ZWRWYWx1ZSA9IHZhbHVlOwogICAgICBpZiAoc2NvcGUpIHsKICAgICAgICBmb3JtYXR0ZWRWYWx1ZSA9IFRob3JheC5VdGlsLmV4cGFuZFRva2VuKHZhbHVlLCBzY29wZSk7CiAgICAgIH0KICAgICAgcmV0dXJuIChrZXkgPT09ICdjbGFzc05hbWUnID8gJ2NsYXNzJyA6IGtleSkgKyAnPSInICsgSGFuZGxlYmFycy5VdGlscy5lc2NhcGVFeHByZXNzaW9uKGZvcm1hdHRlZFZhbHVlKSArICciJzsKICAgIH0pLmpvaW4oJyAnKSArICc+JyArIChfLmlzVW5kZWZpbmVkKGNvbnRlbnQpID8gJycgOiBjb250ZW50KSArICc8LycgKyB0YWcgKyAnPic7CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzICovClRob3JheC5NaXhpbnMgPSB7fTsKCmluaGVyaXRWYXJzLm1peGlucyA9IHsKICBuYW1lOiAnbWl4aW5zJywKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgXy5lYWNoKHRoaXMuY29uc3RydWN0b3IubWl4aW5zLCB0aGlzLm1peGluLCB0aGlzKTsKICAgIF8uZWFjaCh0aGlzLm1peGlucywgdGhpcy5taXhpbiwgdGhpcyk7CiAgfQp9OwoKXy5leHRlbmQoVGhvcmF4LlZpZXcsIHsKICBtaXhpbjogZnVuY3Rpb24obWl4aW4pIHsKICAgIGNyZWF0ZUluaGVyaXRWYXJzKHRoaXMpOwogICAgdGhpcy5taXhpbnMucHVzaChtaXhpbik7CiAgfSwKICByZWdpc3Rlck1peGluOiBmdW5jdGlvbihuYW1lLCBjYWxsYmFjaywgbWV0aG9kcykgewogICAgVGhvcmF4Lk1peGluc1tuYW1lXSA9IFtjYWxsYmFjaywgbWV0aG9kc107CiAgfQp9KTsKClRob3JheC5WaWV3LnByb3RvdHlwZS5taXhpbiA9IGZ1bmN0aW9uKG5hbWUpIHsKICBpZiAoIXRoaXMuX2FwcGxpZWRNaXhpbnMpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMgPSBbXTsKICB9CiAgaWYgKHRoaXMuX2FwcGxpZWRNaXhpbnMuaW5kZXhPZihuYW1lKSA9PT0gLTEpIHsKICAgIHRoaXMuX2FwcGxpZWRNaXhpbnMucHVzaChuYW1lKTsKICAgIGlmIChfLmlzRnVuY3Rpb24obmFtZSkpIHsKICAgICAgbmFtZS5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgdmFyIG1peGluID0gVGhvcmF4Lk1peGluc1tuYW1lXTsKICAgICAgXy5leHRlbmQodGhpcywgbWl4aW5bMV0pOwogICAgICAvL21peGluIGNhbGxiYWNrIG1heSBiZSBhbiBhcnJheSBvZiBbY2FsbGJhY2ssIGFyZ3VtZW50c10KICAgICAgaWYgKF8uaXNBcnJheShtaXhpblswXSkpIHsKICAgICAgICBtaXhpblswXVswXS5hcHBseSh0aGlzLCBtaXhpblswXVsxXSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgbWl4aW5bMF0uYXBwbHkodGhpcywgXy50b0FycmF5KGFyZ3VtZW50cykuc2xpY2UoMSkpOwogICAgICB9CiAgICB9CiAgfQp9OwoKOzsKLypnbG9iYWwgY3JlYXRlSW5oZXJpdFZhcnMsIGluaGVyaXRWYXJzLCBvYmplY3RFdmVudHMsIHdhbGtJbmhlcml0VHJlZSAqLwovLyBTYXZlIGEgY29weSBvZiB0aGUgX29uIG1ldGhvZCB0byBjYWxsIGFzIGEgJHN1cGVyIG1ldGhvZAp2YXIgX29uID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLm9uOwoKaW5oZXJpdFZhcnMuZXZlbnQgPSB7CiAgbmFtZTogJ19ldmVudHMnLAoKICBjb25maWd1cmU6IGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB0aGlzOwogICAgd2Fsa0luaGVyaXRUcmVlKHRoaXMuY29uc3RydWN0b3IsICdfZXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgc2VsZi5vbi5hcHBseShzZWxmLCBldmVudCk7CiAgICB9KTsKICAgIHdhbGtJbmhlcml0VHJlZSh0aGlzLCAnZXZlbnRzJywgZmFsc2UsIGZ1bmN0aW9uKGhhbmRsZXIsIGV2ZW50TmFtZSkgewogICAgICBzZWxmLm9uKGV2ZW50TmFtZSwgaGFuZGxlciwgc2VsZik7CiAgICB9KTsKICB9Cn07CgpfLmV4dGVuZChUaG9yYXguVmlldywgewogIG9uOiBmdW5jdGlvbihldmVudE5hbWUsIGNhbGxiYWNrKSB7CiAgICBjcmVhdGVJbmhlcml0VmFycyh0aGlzKTsKCiAgICBpZiAob2JqZWN0RXZlbnRzKHRoaXMsIGV2ZW50TmFtZSwgY2FsbGJhY2spKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQoKICAgIC8vYWNjZXB0IG9uKHsicmVuZGVyZWQiOiBoYW5kbGVyfSkKICAgIGlmIChfLmlzT2JqZWN0KGV2ZW50TmFtZSkpIHsKICAgICAgXy5lYWNoKGV2ZW50TmFtZSwgZnVuY3Rpb24odmFsdWUsIGtleSkgewogICAgICAgIHRoaXMub24oa2V5LCB2YWx1ZSk7CiAgICAgIH0sIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy9hY2NlcHQgb24oeyJyZW5kZXJlZCI6IFtoYW5kbGVyLCBoYW5kbGVyXX0pCiAgICAgIGlmIChfLmlzQXJyYXkoY2FsbGJhY2spKSB7CiAgICAgICAgXy5lYWNoKGNhbGxiYWNrLCBmdW5jdGlvbihjYikgewogICAgICAgICAgdGhpcy5fZXZlbnRzLnB1c2goW2V2ZW50TmFtZSwgY2JdKTsKICAgICAgICB9LCB0aGlzKTsKICAgICAgLy9hY2NlcHQgb24oInJlbmRlcmVkIiwgaGFuZGxlcikKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLl9ldmVudHMucHVzaChbZXZlbnROYW1lLCBjYWxsYmFja10pOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gdGhpczsKICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgb246IGZ1bmN0aW9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNvbnRleHQpIHsKICAgIGlmIChvYmplY3RFdmVudHModGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCkpIHsKICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CgogICAgaWYgKF8uaXNPYmplY3QoZXZlbnROYW1lKSAmJiBhcmd1bWVudHMubGVuZ3RoIDwgMykgewogICAgICAvL2FjY2VwdCBvbih7InJlbmRlcmVkIjogY2FsbGJhY2t9KQogICAgICBfLmVhY2goZXZlbnROYW1lLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgdGhpcy5vbihrZXksIHZhbHVlLCBjYWxsYmFjayB8fCB0aGlzKTsgICAgLy8gY2FsbGJhY2sgaXMgY29udGV4dCBpbiB0aGlzIGZvcm0gb2YgdGhlIGNhbGwKICAgICAgfSwgdGhpcyk7CiAgICB9IGVsc2UgewogICAgICAvL2FjY2VwdCBvbigicmVuZGVyZWQiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgLy9hY2NlcHQgb24oImNsaWNrIGEiLCBjYWxsYmFjaywgY29udGV4dCkKICAgICAgXy5lYWNoKChfLmlzQXJyYXkoY2FsbGJhY2spID8gY2FsbGJhY2sgOiBbY2FsbGJhY2tdKSwgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICB2YXIgcGFyYW1zID0gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtLmNhbGwodGhpcywgZXZlbnROYW1lLCBjYWxsYmFjaywgY29udGV4dCB8fCB0aGlzKTsKICAgICAgICBpZiAocGFyYW1zLnR5cGUgPT09ICdET00nKSB7CiAgICAgICAgICAvL3dpbGwgY2FsbCBfYWRkRXZlbnQgZHVyaW5nIGRlbGVnYXRlRXZlbnRzKCkKICAgICAgICAgIGlmICghdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSkgewogICAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlID0gW107CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlLnB1c2gocGFyYW1zKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdGhpcy5fYWRkRXZlbnQocGFyYW1zKTsKICAgICAgICB9CiAgICAgIH0sIHRoaXMpOwogICAgfQogICAgcmV0dXJuIHRoaXM7CiAgfSwKICBkZWxlZ2F0ZUV2ZW50czogZnVuY3Rpb24oZXZlbnRzKSB7CiAgICB0aGlzLnVuZGVsZWdhdGVFdmVudHMoKTsKICAgIGlmIChldmVudHMpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihldmVudHMpKSB7CiAgICAgICAgZXZlbnRzID0gZXZlbnRzLmNhbGwodGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzVG9EZWxlZ2F0ZSA9IFtdOwogICAgICB0aGlzLm9uKGV2ZW50cyk7CiAgICB9CiAgICB0aGlzLl9ldmVudHNUb0RlbGVnYXRlICYmIF8uZWFjaCh0aGlzLl9ldmVudHNUb0RlbGVnYXRlLCB0aGlzLl9hZGRFdmVudCwgdGhpcyk7CiAgfSwKICAvL3BhcmFtcyBtYXkgY29udGFpbjoKICAvLy0gbmFtZQogIC8vLSBvcmlnaW5hbE5hbWUKICAvLy0gc2VsZWN0b3IKICAvLy0gdHlwZSAidmlldyIgfHwgIkRPTSIKICAvLy0gaGFuZGxlcgogIF9hZGRFdmVudDogZnVuY3Rpb24ocGFyYW1zKSB7CiAgICBpZiAocGFyYW1zLnR5cGUgPT09ICd2aWV3JykgewogICAgICBfLmVhY2gocGFyYW1zLm5hbWUuc3BsaXQoL1xzKy8pLCBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgX29uLmNhbGwodGhpcywgbmFtZSwgYmluZEV2ZW50SGFuZGxlci5jYWxsKHRoaXMsICd2aWV3LWV2ZW50OicsIHBhcmFtcykpOwogICAgICB9LCB0aGlzKTsKICAgIH0gZWxzZSB7CiAgICAgIHZhciBib3VuZEhhbmRsZXIgPSBiaW5kRXZlbnRIYW5kbGVyLmNhbGwodGhpcywgJ2RvbS1ldmVudDonLCBwYXJhbXMpOwogICAgICBpZiAoIXBhcmFtcy5uZXN0ZWQpIHsKICAgICAgICBib3VuZEhhbmRsZXIgPSBjb250YWluSGFuZGxlclRvQ3VyZW50Vmlldyhib3VuZEhhbmRsZXIsIHRoaXMuY2lkKTsKICAgICAgfQogICAgICBpZiAocGFyYW1zLnNlbGVjdG9yKSB7CiAgICAgICAgdmFyIG5hbWUgPSBwYXJhbXMubmFtZSArICcuZGVsZWdhdGVFdmVudHMnICsgdGhpcy5jaWQ7CiAgICAgICAgdGhpcy4kZWwub24obmFtZSwgcGFyYW1zLnNlbGVjdG9yLCBib3VuZEhhbmRsZXIpOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVsLm9uKHBhcmFtcy5uYW1lLCBib3VuZEhhbmRsZXIpOwogICAgICB9CiAgICB9CiAgfQp9KTsKCi8vIFdoZW4gdmlldyBpcyByZWFkeSB0cmlnZ2VyIHJlYWR5IGV2ZW50IG9uIGFsbAovLyBjaGlsZHJlbiB0aGF0IGFyZSBwcmVzZW50LCB0aGVuIHJlZ2lzdGVyIGFuCi8vIGV2ZW50IHRoYXQgd2lsbCB0cmlnZ2VyIHJlYWR5IG9uIG5ldyBjaGlsZHJlbgovLyB3aGVuIHRoZXkgYXJlIGFkZGVkClRob3JheC5WaWV3Lm9uKCdyZWFkeScsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICBpZiAoIXRoaXMuX2lzUmVhZHkpIHsKICAgIHRoaXMuX2lzUmVhZHkgPSB0cnVlOwogICAgZnVuY3Rpb24gdHJpZ2dlclJlYWR5T25DaGlsZChjaGlsZCkgewogICAgICBjaGlsZC50cmlnZ2VyKCdyZWFkeScsIG9wdGlvbnMpOwogICAgfQogICAgXy5lYWNoKHRoaXMuY2hpbGRyZW4sIHRyaWdnZXJSZWFkeU9uQ2hpbGQpOwogICAgdGhpcy5vbignY2hpbGQnLCB0cmlnZ2VyUmVhZHlPbkNoaWxkKTsKICB9Cn0pOwoKdmFyIGV2ZW50U3BsaXR0ZXIgPSAvXihuZXN0ZWRccyspPyhcUyspKD86XHMrKC4rKSk/LzsKCnZhciBkb21FdmVudHMgPSBbXSwKICAgIGRvbUV2ZW50UmVnZXhwOwpmdW5jdGlvbiBwdXNoRG9tRXZlbnRzKGV2ZW50cykgewogIGRvbUV2ZW50cy5wdXNoLmFwcGx5KGRvbUV2ZW50cywgZXZlbnRzKTsKICBkb21FdmVudFJlZ2V4cCA9IG5ldyBSZWdFeHAoJ14obmVzdGVkXFxzKyk/KCcgKyBkb21FdmVudHMuam9pbignfCcpICsgJykoPzpcXHN8JCknKTsKfQpwdXNoRG9tRXZlbnRzKFsKICAnbW91c2Vkb3duJywgJ21vdXNldXAnLCAnbW91c2Vtb3ZlJywgJ21vdXNlb3ZlcicsICdtb3VzZW91dCcsCiAgJ3RvdWNoc3RhcnQnLCAndG91Y2hlbmQnLCAndG91Y2htb3ZlJywKICAnY2xpY2snLCAnZGJsY2xpY2snLAogICdrZXl1cCcsICdrZXlkb3duJywgJ2tleXByZXNzJywKICAnc3VibWl0JywgJ2NoYW5nZScsCiAgJ2ZvY3VzJywgJ2JsdXInCl0pOwoKZnVuY3Rpb24gY29udGFpbkhhbmRsZXJUb0N1cmVudFZpZXcoaGFuZGxlciwgY2lkKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdmlldyA9ICQoZXZlbnQudGFyZ2V0KS52aWV3KHtoZWxwZXI6IGZhbHNlfSk7CiAgICBpZiAodmlldyAmJiB2aWV3LmNpZCA9PT0gY2lkKSB7CiAgICAgIGV2ZW50Lm9yaWdpbmFsQ29udGV4dCA9IHRoaXM7CiAgICAgIGhhbmRsZXIoZXZlbnQpOwogICAgfQogIH07Cn0KCmZ1bmN0aW9uIGJpbmRFdmVudEhhbmRsZXIoZXZlbnROYW1lLCBwYXJhbXMpIHsKICBldmVudE5hbWUgKz0gcGFyYW1zLm9yaWdpbmFsTmFtZTsKCiAgdmFyIGNhbGxiYWNrID0gcGFyYW1zLmhhbmRsZXIsCiAgICAgIG1ldGhvZCA9IF8uaXNGdW5jdGlvbihjYWxsYmFjaykgPyBjYWxsYmFjayA6IHRoaXNbY2FsbGJhY2tdOwogIGlmICghbWV0aG9kKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ0V2ZW50ICInICsgY2FsbGJhY2sgKyAnIiBkb2VzIG5vdCBleGlzdCAnICsgKHRoaXMubmFtZSB8fCB0aGlzLmNpZCkgKyAnOicgKyBldmVudE5hbWUpOwogIH0KICByZXR1cm4gXy5iaW5kKGZ1bmN0aW9uKCkgewogICAgdHJ5IHsKICAgICAgbWV0aG9kLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIFRob3JheC5vbkV4Y2VwdGlvbigndGhvcmF4LWV4Y2VwdGlvbjogJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpICsgJzonICsgZXZlbnROYW1lLCBlKTsKICAgIH0KICB9LCBwYXJhbXMuY29udGV4dCB8fCB0aGlzKTsKfQoKZnVuY3Rpb24gZXZlbnRQYXJhbXNGcm9tRXZlbnRJdGVtKG5hbWUsIGhhbmRsZXIsIGNvbnRleHQpIHsKICB2YXIgcGFyYW1zID0gewogICAgb3JpZ2luYWxOYW1lOiBuYW1lLAogICAgaGFuZGxlcjogXy5pc1N0cmluZyhoYW5kbGVyKSA/IHRoaXNbaGFuZGxlcl0gOiBoYW5kbGVyCiAgfTsKICBpZiAobmFtZS5tYXRjaChkb21FdmVudFJlZ2V4cCkpIHsKICAgIHZhciBtYXRjaCA9IGV2ZW50U3BsaXR0ZXIuZXhlYyhuYW1lKTsKICAgIHBhcmFtcy5uZXN0ZWQgPSAhIW1hdGNoWzFdOwogICAgcGFyYW1zLm5hbWUgPSBtYXRjaFsyXTsKICAgIHBhcmFtcy50eXBlID0gJ0RPTSc7CiAgICBwYXJhbXMuc2VsZWN0b3IgPSBtYXRjaFszXTsKICB9IGVsc2UgewogICAgcGFyYW1zLm5hbWUgPSBuYW1lOwogICAgcGFyYW1zLnR5cGUgPSAndmlldyc7CiAgfQogIHBhcmFtcy5jb250ZXh0ID0gY29udGV4dDsKICByZXR1cm4gcGFyYW1zOwp9Cgo7OwovKmdsb2JhbCBnZXRPcHRpb25zRGF0YSwgaHRtbEF0dHJpYnV0ZXNUb0NvcHksIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zLCB2aWV3SGVscGVyQXR0cmlidXRlTmFtZSAqLwp2YXIgdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZSA9ICdkYXRhLXZpZXctdG1wJywKICAgIHZpZXdUZW1wbGF0ZU92ZXJyaWRlcyA9IHt9OwoKLy8gV2lsbCBiZSBzaGFyZWQgYnkgSGVscGVyVmlldyBhbmQgQ29sbGVjdGlvbkhlbHBlclZpZXcKdmFyIGhlbHBlclZpZXdQcm90b3R5cGUgPSB7CiAgX2Vuc3VyZUVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgVGhvcmF4LlZpZXcucHJvdG90eXBlLl9lbnN1cmVFbGVtZW50LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB0aGlzLiRlbC5hdHRyKHZpZXdIZWxwZXJBdHRyaWJ1dGVOYW1lLCB0aGlzLl9oZWxwZXJOYW1lKTsKICB9LAogIF9nZXRDb250ZXh0OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLnBhcmVudC5fZ2V0Q29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICB9Cn07CgpUaG9yYXguSGVscGVyVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZChoZWxwZXJWaWV3UHJvdG90eXBlKTsKCi8vIEVuc3VyZSBuZXN0ZWQgaW5saW5lIGhlbHBlcnMgd2lsbCBhbHdheXMgaGF2ZSB0aGlzLnBhcmVudAovLyBzZXQgdG8gdGhlIHZpZXcgY29udGFpbmluZyB0aGUgdGVtcGxhdGUKZnVuY3Rpb24gZ2V0UGFyZW50KHBhcmVudCkgewogIC8vIFRoZSBgdmlld2AgaGVscGVyIGlzIGEgc3BlY2lhbCBjYXNlIGFzIGl0IGVtYmVkcwogIC8vIGEgdmlldyBpbnN0ZWFkIG9mIGNyZWF0aW5nIGEgbmV3IG9uZQogIHdoaWxlIChwYXJlbnQuX2hlbHBlck5hbWUgJiYgcGFyZW50Ll9oZWxwZXJOYW1lICE9PSAndmlldycpIHsKICAgIHBhcmVudCA9IHBhcmVudC5wYXJlbnQ7CiAgfQogIHJldHVybiBwYXJlbnQ7Cn0KCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyID0gZnVuY3Rpb24obmFtZSwgVmlld0NsYXNzLCBjYWxsYmFjaykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAyKSB7CiAgICBpZiAoVmlld0NsYXNzLmZhY3RvcnkpIHsKICAgICAgY2FsbGJhY2sgPSBWaWV3Q2xhc3MuY2FsbGJhY2s7CiAgICB9IGVsc2UgewogICAgICBjYWxsYmFjayA9IFZpZXdDbGFzczsKICAgICAgVmlld0NsYXNzID0gVGhvcmF4LkhlbHBlclZpZXc7CiAgICB9CiAgfQogIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIobmFtZSwgZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IF8udG9BcnJheShhcmd1bWVudHMpLAogICAgICAgIG9wdGlvbnMgPSBhcmdzLnBvcCgpLAogICAgICAgIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwoKICAgIHZhciB2aWV3T3B0aW9ucyA9IHsKICAgICAgdGVtcGxhdGU6IG9wdGlvbnMuZm4gfHwgSGFuZGxlYmFycy5WTS5ub29wLAogICAgICBpbnZlcnNlOiBvcHRpb25zLmludmVyc2UsCiAgICAgIG9wdGlvbnM6IG9wdGlvbnMuaGFzaCwKICAgICAgZGVjbGFyaW5nVmlldzogZGVjbGFyaW5nVmlldywKICAgICAgcGFyZW50OiBnZXRQYXJlbnQoZGVjbGFyaW5nVmlldyksCiAgICAgIF9oZWxwZXJOYW1lOiBuYW1lLAogICAgICBfaGVscGVyT3B0aW9uczogewogICAgICAgIG9wdGlvbnM6IGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSwKICAgICAgICBhcmdzOiBfLmNsb25lKGFyZ3MpCiAgICAgIH0KICAgIH07CgogICAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICAgIF8uZXh0ZW5kKHZpZXdPcHRpb25zLCBfLnBpY2sob3B0aW9ucy5oYXNoLCBodG1sQXR0cmlidXRlc1RvQ29weSkpOwoKICAgIC8vIENoZWNrIHRvIHNlZSBpZiB3ZSBoYXZlIGFuIGV4aXN0aW5nIGluc3RhbmNlIHRoYXQgd2UgY2FuIHJldXNlCiAgICB2YXIgaW5zdGFuY2UgPSBfLmZpbmQoZGVjbGFyaW5nVmlldy5fcHJldmlvdXNIZWxwZXJzLCBmdW5jdGlvbihjaGlsZCkgewogICAgICByZXR1cm4gY29tcGFyZUhlbHBlck9wdGlvbnModmlld09wdGlvbnMsIGNoaWxkKTsKICAgIH0pOwoKICAgIC8vIENyZWF0ZSB0aGUgaW5zdGFuY2UgaWYgd2UgZG9uJ3QgYWxyZWFkeSBoYXZlIG9uZQogICAgaWYgKCFpbnN0YW5jZSkgewogICAgICBpZiAoVmlld0NsYXNzLmZhY3RvcnkpIHsKICAgICAgICBpbnN0YW5jZSA9IFZpZXdDbGFzcy5mYWN0b3J5KGFyZ3MsIHZpZXdPcHRpb25zKTsKICAgICAgICBpZiAoIWluc3RhbmNlKSB7CiAgICAgICAgICByZXR1cm4gJyc7CiAgICAgICAgfQoKICAgICAgICBpbnN0YW5jZS5faGVscGVyTmFtZSA9IHZpZXdPcHRpb25zLl9oZWxwZXJOYW1lOwogICAgICAgIGluc3RhbmNlLl9oZWxwZXJPcHRpb25zID0gdmlld09wdGlvbnMuX2hlbHBlck9wdGlvbnM7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaW5zdGFuY2UgPSBuZXcgVmlld0NsYXNzKHZpZXdPcHRpb25zKTsKICAgICAgfQoKICAgICAgYXJncy5wdXNoKGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5fYWRkQ2hpbGQoaW5zdGFuY2UpOwogICAgICBkZWNsYXJpbmdWaWV3LnRyaWdnZXIuYXBwbHkoZGVjbGFyaW5nVmlldywgWydoZWxwZXInLCBuYW1lXS5jb25jYXQoYXJncykpOwogICAgICBkZWNsYXJpbmdWaWV3LnRyaWdnZXIuYXBwbHkoZGVjbGFyaW5nVmlldywgWydoZWxwZXI6JyArIG5hbWVdLmNvbmNhdChhcmdzKSk7CgogICAgICBjYWxsYmFjayAmJiBjYWxsYmFjay5hcHBseSh0aGlzLCBhcmdzKTsKICAgIH0gZWxzZSB7CiAgICAgIGRlY2xhcmluZ1ZpZXcuX3ByZXZpb3VzSGVscGVycyA9IF8ud2l0aG91dChkZWNsYXJpbmdWaWV3Ll9wcmV2aW91c0hlbHBlcnMsIGluc3RhbmNlKTsKICAgICAgZGVjbGFyaW5nVmlldy5jaGlsZHJlbltpbnN0YW5jZS5jaWRdID0gaW5zdGFuY2U7CiAgICB9CgogICAgdmFyIGh0bWxBdHRyaWJ1dGVzID0gXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpOwogICAgaHRtbEF0dHJpYnV0ZXNbdmlld1BsYWNlaG9sZGVyQXR0cmlidXRlTmFtZV0gPSBpbnN0YW5jZS5jaWQ7CgogICAgdmFyIGV4cGFuZFRva2VucyA9IG9wdGlvbnMuaGFzaFsnZXhwYW5kLXRva2VucyddOwogICAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGh0bWxBdHRyaWJ1dGVzLCAnJywgZXhwYW5kVG9rZW5zID8gdGhpcyA6IG51bGwpKTsKICB9KTsKICB2YXIgaGVscGVyID0gSGFuZGxlYmFycy5oZWxwZXJzW25hbWVdOwogIHJldHVybiBoZWxwZXI7Cn07CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciBwbGFjZWhvbGRlcklkID0gZWwuZ2V0QXR0cmlidXRlKHZpZXdQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUpLAogICAgICAgIHZpZXcgPSB0aGlzLmNoaWxkcmVuW3BsYWNlaG9sZGVySWRdOwogICAgaWYgKHZpZXcpIHsKICAgICAgLy9zZWUgaWYgdGhlIHZpZXcgaGVscGVyIGRlY2xhcmVkIGFuIG92ZXJyaWRlIGZvciB0aGUgdmlldwogICAgICAvL2lmIG5vdCwgZW5zdXJlIHRoZSB2aWV3IGhhcyBiZWVuIHJlbmRlcmVkIGF0IGxlYXN0IG9uY2UKICAgICAgaWYgKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSkgewogICAgICAgIHZpZXcucmVuZGVyKHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXSk7CiAgICAgICAgZGVsZXRlIHZpZXdUZW1wbGF0ZU92ZXJyaWRlc1twbGFjZWhvbGRlcklkXTsKICAgICAgfSBlbHNlIHsKICAgICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIH0KICAgICAgJChlbCkucmVwbGFjZVdpdGgodmlldy5lbCk7CiAgICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrKHZpZXcuZWwpOwogICAgfQogIH0sIHRoaXMpOwp9KTsKCgovKioKICogQ2xvbmVzIHRoZSBoZWxwZXIgb3B0aW9ucywgZHJvcHBpbmcgaXRlbXMgdGhhdCBhcmUga25vd24gdG8gY2hhbmdlCiAqIGJldHdlZW4gcmVuZGVyaW5nIGN5Y2xlcyBhcyBhcHByb3ByaWF0ZS4KICovCmZ1bmN0aW9uIGNsb25lSGVscGVyT3B0aW9ucyhvcHRpb25zKSB7CiAgdmFyIHJldCA9IF8ucGljayhvcHRpb25zLCAnZm4nLCAnaW52ZXJzZScsICdoYXNoJywgJ2RhdGEnKTsKICByZXQuZGF0YSA9IF8ub21pdChvcHRpb25zLmRhdGEsICdjaWQnLCAndmlldycsICd5aWVsZCcpOwogIHJldHVybiByZXQ7Cn0KCi8qKgogKiBDaGVja3MgZm9yIGJhc2ljIGVxdWFsaXR5IGJldHdlZW4gdHdvIHNldHMgb2YgcGFyYW1ldGVycyBmb3IgYSBoZWxwZXIgdmlldy4KICoKICogQ2hlY2tlZCBmaWVsZHMgaW5jbHVkZToKICogIC0gX2hlbHBlck5hbWUKICogIC0gQWxsIGFyZ3MKICogIC0gSGFzaAogKiAgLSBEYXRhCiAqICAtIEZ1bmN0aW9uIGFuZCBJbnZlcnQgKGlkIGJhc2VkIGlmIHBvc3NpYmxlKQogKgogKiBUaGlzIG1ldGhvZCBhbGxvd3MgdXMgdG8gZGV0ZXJtaW5lIGlmIHRoZSBpbnB1dHMgdG8gYSBnaXZlbiB2aWV3IGFyZSB0aGUgc2FtZS4gSWYgdGhleQogKiBhcmUgdGhlbiB3ZSBtYWtlIHRoZSBhc3N1bXB0aW9uIHRoYXQgdGhlIHJlbmRlcmluZyB3aWxsIGJlIHRoZSBzYW1lIChvciB0aGUgY2hpbGQgdmlldyB3aWxsCiAqIG90aGVyd2lzZSByZXJlbmRlcmluZyBpdCBieSBtb25pdG9yaW5nIGl0J3MgcGFyYW1ldGVycyBhcyBuZWNlc3NhcnkpIGFuZCByZXVzZSB0aGUgdmlldyBvbgogKiByZXJlbmRlciBvZiB0aGUgcGFyZW50IHZpZXcuCiAqLwpmdW5jdGlvbiBjb21wYXJlSGVscGVyT3B0aW9ucyhhLCBiKSB7CiAgZnVuY3Rpb24gY29tcGFyZVZhbHVlcyhhLCBiKSB7CiAgICByZXR1cm4gXy5ldmVyeShhLCBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgIHJldHVybiBiW2tleV0gPT09IHZhbHVlOwogICAgfSk7CiAgfQoKICBpZiAoYS5faGVscGVyTmFtZSAhPT0gYi5faGVscGVyTmFtZSkgewogICAgcmV0dXJuIGZhbHNlOwogIH0KCiAgYSA9IGEuX2hlbHBlck9wdGlvbnM7CiAgYiA9IGIuX2hlbHBlck9wdGlvbnM7CgogIC8vIEltcGxlbWVudHMgYSBmaXJzdCBsZXZlbCBkZXB0aCBjb21wYXJpc29uCiAgcmV0dXJuIGEuYXJncy5sZW5ndGggPT09IGIuYXJncy5sZW5ndGgKICAgICAgJiYgY29tcGFyZVZhbHVlcyhhLmFyZ3MsIGIuYXJncykKICAgICAgJiYgXy5pc0VxdWFsKF8ua2V5cyhhLm9wdGlvbnMpLCBfLmtleXMoYi5vcHRpb25zKSkKICAgICAgJiYgXy5ldmVyeShhLm9wdGlvbnMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpIHsKICAgICAgICAgIGlmIChrZXkgPT09ICdkYXRhJyB8fCBrZXkgPT09ICdoYXNoJykgewogICAgICAgICAgICByZXR1cm4gY29tcGFyZVZhbHVlcyhhLm9wdGlvbnNba2V5XSwgYi5vcHRpb25zW2tleV0pOwogICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdmbicgfHwga2V5ID09PSAnaW52ZXJzZScpIHsKICAgICAgICAgICAgaWYgKGIub3B0aW9uc1trZXldID09PSB2YWx1ZSkgewogICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgb3RoZXIgPSBiLm9wdGlvbnNba2V5XSB8fCB7fTsKICAgICAgICAgICAgcmV0dXJuIHZhbHVlICYmIF8uaGFzKHZhbHVlLCAncHJvZ3JhbScpICYmICF2YWx1ZS5kZXB0aCAmJiBvdGhlci5wcm9ncmFtID09PSB2YWx1ZS5wcm9ncmFtOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIGIub3B0aW9uc1trZXldID09PSB2YWx1ZTsKICAgICAgICB9KTsKfQoKOzsKLypnbG9iYWwgZ2V0VmFsdWUsIGluaGVyaXRWYXJzLCB3YWxrSW5oZXJpdFRyZWUgKi8KCmZ1bmN0aW9uIGRhdGFPYmplY3QodHlwZSwgc3BlYykgewogIHNwZWMgPSBpbmhlcml0VmFyc1t0eXBlXSA9IF8uZGVmYXVsdHMoewogICAgbmFtZTogJ18nICsgdHlwZSArICdFdmVudHMnLAogICAgZXZlbnQ6IHRydWUKICB9LCBzcGVjKTsKCiAgLy8gQWRkIGEgY2FsbGJhY2sgaW4gdGhlIHZpZXcgY29uc3RydWN0b3IKICBzcGVjLmN0b3IgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzW3R5cGVdKSB7CiAgICAgIC8vIE5lZWQgdG8gbnVsbCB0aGlzLm1vZGVsL2NvbGxlY3Rpb24gc28gc2V0TW9kZWwvQ29sbGVjdGlvbiB3aWxsCiAgICAgIC8vIG5vdCB0cmVhdCBpdCBhcyB0aGUgb2xkIG1vZGVsL2NvbGxlY3Rpb24gYW5kIGltbWVkaWF0ZWx5IHJldHVybgogICAgICB2YXIgb2JqZWN0ID0gdGhpc1t0eXBlXTsKICAgICAgdGhpc1t0eXBlXSA9IG51bGw7CiAgICAgIHRoaXNbc3BlYy5zZXRdKG9iamVjdCk7CiAgICB9CiAgfTsKCiAgZnVuY3Rpb24gc2V0T2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHZhciBvbGQgPSB0aGlzW3R5cGVdLAogICAgICAgICRlbCA9IGdldFZhbHVlKHRoaXMsIHNwZWMuJGVsKTsKCiAgICBpZiAoZGF0YU9iamVjdCA9PT0gb2xkKSB7CiAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgaWYgKG9sZCkgewogICAgICB0aGlzLnVuYmluZERhdGFPYmplY3Qob2xkKTsKICAgIH0KCiAgICBpZiAoZGF0YU9iamVjdCkgewogICAgICB0aGlzW3R5cGVdID0gZGF0YU9iamVjdDsKCiAgICAgIGlmIChzcGVjLmxvYWRpbmcpIHsKICAgICAgICBzcGVjLmxvYWRpbmcuY2FsbCh0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5iaW5kRGF0YU9iamVjdCh0eXBlLCBkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgdGhpcy5vcHRpb25zLCBvcHRpb25zKSk7CiAgICAgICRlbCAmJiAkZWwuYXR0cihzcGVjLmNpZEF0dHJOYW1lLCBkYXRhT2JqZWN0LmNpZCk7CiAgICAgIGRhdGFPYmplY3QudHJpZ2dlcignc2V0JywgZGF0YU9iamVjdCwgb2xkKTsKICAgIH0gZWxzZSB7CiAgICAgIHRoaXNbdHlwZV0gPSBmYWxzZTsKICAgICAgaWYgKHNwZWMuY2hhbmdlKSB7CiAgICAgICAgc3BlYy5jaGFuZ2UuY2FsbCh0aGlzLCBmYWxzZSk7CiAgICAgIH0KICAgICAgJGVsICYmICRlbC5yZW1vdmVBdHRyKHNwZWMuY2lkQXR0ck5hbWUpOwogICAgfQogICAgdGhpcy50cmlnZ2VyKCdjaGFuZ2U6ZGF0YS1vYmplY3QnLCB0eXBlLCBkYXRhT2JqZWN0LCBvbGQpOwogICAgcmV0dXJuIHRoaXM7CiAgfQoKICBUaG9yYXguVmlldy5wcm90b3R5cGVbc3BlYy5zZXRdID0gc2V0T2JqZWN0Owp9CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBiaW5kRGF0YU9iamVjdDogZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCwgb3B0aW9ucykgewogICAgaWYgKHRoaXMuX2JvdW5kRGF0YU9iamVjdHNCeUNpZFtkYXRhT2JqZWN0LmNpZF0pIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgdGhpcy5fYm91bmREYXRhT2JqZWN0c0J5Q2lkW2RhdGFPYmplY3QuY2lkXSA9IGRhdGFPYmplY3Q7CgogICAgdmFyIG9wdGlvbnMgPSB0aGlzLl9tb2RpZnlEYXRhT2JqZWN0T3B0aW9ucyhkYXRhT2JqZWN0LCBfLmV4dGVuZCh7fSwgaW5oZXJpdFZhcnNbdHlwZV0uZGVmYXVsdE9wdGlvbnMsIG9wdGlvbnMpKTsKICAgIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF0gPSBvcHRpb25zOwoKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzLmNvbnN0cnVjdG9yKTsKICAgIGJpbmRFdmVudHMuY2FsbCh0aGlzLCB0eXBlLCBkYXRhT2JqZWN0LCB0aGlzKTsKCiAgICB2YXIgc3BlYyA9IGluaGVyaXRWYXJzW3R5cGVdOwogICAgc3BlYy5iaW5kQ2FsbGJhY2sgJiYgc3BlYy5iaW5kQ2FsbGJhY2suY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKCiAgICBpZiAoZGF0YU9iamVjdC5zaG91bGRGZXRjaCAmJiBkYXRhT2JqZWN0LnNob3VsZEZldGNoKG9wdGlvbnMpKSB7CiAgICAgIGxvYWRPYmplY3QoZGF0YU9iamVjdCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgaWYgKGluaGVyaXRWYXJzW3R5cGVdLmNoYW5nZSkgewogICAgICAvLyB3YW50IHRvIHRyaWdnZXIgYnVpbHQgaW4gcmVuZGVyaW5nIHdpdGhvdXQgdHJpZ2dlcmluZyBldmVudCBvbiBtb2RlbAogICAgICBpbmhlcml0VmFyc1t0eXBlXS5jaGFuZ2UuY2FsbCh0aGlzLCBkYXRhT2JqZWN0LCBvcHRpb25zKTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICB1bmJpbmREYXRhT2JqZWN0OiBmdW5jdGlvbiAoZGF0YU9iamVjdCkgewogICAgaWYgKCF0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIGRlbGV0ZSB0aGlzLl9ib3VuZERhdGFPYmplY3RzQnlDaWRbZGF0YU9iamVjdC5jaWRdOwogICAgdGhpcy5zdG9wTGlzdGVuaW5nKGRhdGFPYmplY3QpOwogICAgZGVsZXRlIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFtkYXRhT2JqZWN0LmNpZF07CiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBfbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnM6IGZ1bmN0aW9uKGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICAgIHJldHVybiBvcHRpb25zOwogIH0KfSk7CgpmdW5jdGlvbiBiaW5kRXZlbnRzKHR5cGUsIHRhcmdldCwgc291cmNlKSB7CiAgdmFyIGNvbnRleHQgPSB0aGlzOwogIHdhbGtJbmhlcml0VHJlZShzb3VyY2UsICdfJyArIHR5cGUgKyAnRXZlbnRzJywgdHJ1ZSwgZnVuY3Rpb24oZXZlbnQpIHsKICAgIC8vIGdldEV2ZW50Q2FsbGJhY2sgd2lsbCByZXNvbHZlIGlmIGl0IGlzIGEgc3RyaW5nIG9yIGEgbWV0aG9kCiAgICAvLyBhbmQgcmV0dXJuIGEgbWV0aG9kCiAgICBjb250ZXh0Lmxpc3RlblRvKHRhcmdldCwgZXZlbnRbMF0sIF8uYmluZChnZXRFdmVudENhbGxiYWNrKGV2ZW50WzFdLCBjb250ZXh0KSwgZXZlbnRbMl0gfHwgY29udGV4dCkpOwogIH0pOwp9CgpmdW5jdGlvbiBsb2FkT2JqZWN0KGRhdGFPYmplY3QsIG9wdGlvbnMpIHsKICBpZiAoZGF0YU9iamVjdC5sb2FkKSB7CiAgICBkYXRhT2JqZWN0LmxvYWQoZnVuY3Rpb24oKSB7CiAgICAgIG9wdGlvbnMgJiYgb3B0aW9ucy5zdWNjZXNzICYmIG9wdGlvbnMuc3VjY2VzcyhkYXRhT2JqZWN0KTsKICAgIH0sIG9wdGlvbnMpOwogIH0gZWxzZSB7CiAgICBkYXRhT2JqZWN0LmZldGNoKG9wdGlvbnMpOwogIH0KfQoKZnVuY3Rpb24gZ2V0RXZlbnRDYWxsYmFjayhjYWxsYmFjaywgY29udGV4dCkgewogIGlmIChfLmlzRnVuY3Rpb24oY2FsbGJhY2spKSB7CiAgICByZXR1cm4gY2FsbGJhY2s7CiAgfSBlbHNlIHsKICAgIHJldHVybiBjb250ZXh0W2NhbGxiYWNrXTsKICB9Cn0KCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciwgZGF0YU9iamVjdCwgZ2V0VmFsdWUgKi8KdmFyIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLW1vZGVsLWNpZCc7CgpUaG9yYXguTW9kZWwgPSBCYWNrYm9uZS5Nb2RlbC5leHRlbmQoewogIGlzRW1wdHk6IGZ1bmN0aW9uKCkgewogICAgcmV0dXJuICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICAvLyBXZSBhcmUgcG9wdWxhdGVkIGlmIHdlIGhhdmUgYXR0cmlidXRlcyBzZXQKICAgIHZhciBhdHRyaWJ1dGVzID0gXy5jbG9uZSh0aGlzLmF0dHJpYnV0ZXMpLAogICAgICAgIGRlZmF1bHRzID0gZ2V0VmFsdWUodGhpcywgJ2RlZmF1bHRzJykgfHwge307CiAgICBmb3IgKHZhciBkZWZhdWx0X2tleSBpbiBkZWZhdWx0cykgewogICAgICBpZiAoYXR0cmlidXRlc1tkZWZhdWx0X2tleV0gIT0gZGVmYXVsdHNbZGVmYXVsdF9rZXldKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0KICAgICAgZGVsZXRlIGF0dHJpYnV0ZXNbZGVmYXVsdF9rZXldOwogICAgfQogICAgdmFyIGtleXMgPSBfLmtleXMoYXR0cmlidXRlcyk7CiAgICByZXR1cm4ga2V5cy5sZW5ndGggPiAxIHx8IChrZXlzLmxlbmd0aCA9PT0gMSAmJiBrZXlzWzBdICE9PSB0aGlzLmlkQXR0cmlidXRlKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAvLyB1cmwoKSB3aWxsIHRocm93IGlmIG1vZGVsIGhhcyBubyBgdXJsUm9vdGAgYW5kIG5vIGBjb2xsZWN0aW9uYAogICAgLy8gb3IgaGFzIGBjb2xsZWN0aW9uYCBhbmQgYGNvbGxlY3Rpb25gIGhhcyBubyBgdXJsYAogICAgdmFyIHVybDsKICAgIHRyeSB7CiAgICAgIHVybCA9IGdldFZhbHVlKHRoaXMsICd1cmwnKTsKICAgIH0gY2F0Y2goZSkgewogICAgICB1cmwgPSBmYWxzZTsKICAgIH0KICAgIHJldHVybiBvcHRpb25zLmZldGNoICYmICEhdXJsICYmICF0aGlzLmlzUG9wdWxhdGVkKCk7CiAgfQp9KTsKClRob3JheC5Nb2RlbHMgPSB7fTsKY3JlYXRlUmVnaXN0cnlXcmFwcGVyKFRob3JheC5Nb2RlbCwgVGhvcmF4Lk1vZGVscyk7CgpkYXRhT2JqZWN0KCdtb2RlbCcsIHsKICBzZXQ6ICdzZXRNb2RlbCcsCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdHJ1ZSwKICAgIGZldGNoOiB0cnVlLAogICAgc3VjY2VzczogZmFsc2UsCiAgICBlcnJvcnM6IHRydWUKICB9LAogIGNoYW5nZTogb25Nb2RlbENoYW5nZSwKICAkZWw6ICckZWwnLAogIGNpZEF0dHJOYW1lOiBtb2RlbENpZEF0dHJpYnV0ZU5hbWUKfSk7CgpmdW5jdGlvbiBvbk1vZGVsQ2hhbmdlKG1vZGVsKSB7CiAgdmFyIG1vZGVsT3B0aW9ucyA9IG1vZGVsICYmIHRoaXMuX29iamVjdE9wdGlvbnNCeUNpZFttb2RlbC5jaWRdOwogIC8vICFtb2RlbE9wdGlvbnMgd2lsbCBiZSB0cnVlIHdoZW4gc2V0TW9kZWwoZmFsc2UpIGlzIGNhbGxlZAogIGlmICghbW9kZWxPcHRpb25zIHx8IChtb2RlbE9wdGlvbnMgJiYgbW9kZWxPcHRpb25zLnJlbmRlcikpIHsKICAgIHRoaXMucmVuZGVyKCk7CiAgfQp9CgpUaG9yYXguVmlldy5vbih7CiAgbW9kZWw6IHsKICAgIGVycm9yOiBmdW5jdGlvbihtb2RlbCwgZXJyb3JzKSB7CiAgICAgIGlmICh0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbbW9kZWwuY2lkXS5lcnJvcnMpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgZXJyb3JzLCBtb2RlbCk7CiAgICAgIH0KICAgIH0sCiAgICBjaGFuZ2U6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIG9uTW9kZWxDaGFuZ2UuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9CiAgfQp9KTsKCiQuZm4ubW9kZWwgPSBmdW5jdGlvbih2aWV3KSB7CiAgdmFyICR0aGlzID0gJCh0aGlzKSwKICAgICAgbW9kZWxFbGVtZW50ID0gJHRoaXMuY2xvc2VzdCgnWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBtb2RlbENpZCA9IG1vZGVsRWxlbWVudCAmJiBtb2RlbEVsZW1lbnQuYXR0cihtb2RlbENpZEF0dHJpYnV0ZU5hbWUpOwogIGlmIChtb2RlbENpZCkgewogICAgdmFyIHZpZXcgPSB2aWV3IHx8ICR0aGlzLnZpZXcoKTsKICAgIGlmICh2aWV3ICYmIHZpZXcubW9kZWwgJiYgdmlldy5tb2RlbC5jaWQgPT09IG1vZGVsQ2lkKSB7CiAgICAgIHJldHVybiB2aWV3Lm1vZGVsIHx8IGZhbHNlOwogICAgfQogICAgdmFyIGNvbGxlY3Rpb24gPSAkdGhpcy5jb2xsZWN0aW9uKHZpZXcpOwogICAgaWYgKGNvbGxlY3Rpb24pIHsKICAgICAgcmV0dXJuIGNvbGxlY3Rpb24uZ2V0KG1vZGVsQ2lkKTsKICAgIH0KICB9CiAgcmV0dXJuIGZhbHNlOwp9OwoKOzsKLypnbG9iYWwgY3JlYXRlUmVnaXN0cnlXcmFwcGVyLCBkYXRhT2JqZWN0LCBnZXRFdmVudENhbGxiYWNrLCBnZXRWYWx1ZSwgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCB2aWV3Q2lkQXR0cmlidXRlTmFtZSAqLwp2YXIgX2ZldGNoID0gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuZmV0Y2gsCiAgICBfcmVzZXQgPSBCYWNrYm9uZS5Db2xsZWN0aW9uLnByb3RvdHlwZS5yZXNldCwKICAgIF9yZXBsYWNlSFRNTCA9IFRob3JheC5WaWV3LnByb3RvdHlwZS5fcmVwbGFjZUhUTUwsCiAgICBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tY2lkJywKICAgIGNvbGxlY3Rpb25FbXB0eUF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1jb2xsZWN0aW9uLWVtcHR5JywKICAgIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLWNvbGxlY3Rpb24tZWxlbWVudCcsCiAgICBFTEVNRU5UX05PREVfVFlQRSA9IDE7CgpUaG9yYXguQ29sbGVjdGlvbiA9IEJhY2tib25lLkNvbGxlY3Rpb24uZXh0ZW5kKHsKICBtb2RlbDogVGhvcmF4Lk1vZGVsIHx8IEJhY2tib25lLk1vZGVsLAogIGluaXRpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdGhpcy5jaWQgPSBfLnVuaXF1ZUlkKCdjb2xsZWN0aW9uJyk7CiAgICByZXR1cm4gQmFja2JvbmUuQ29sbGVjdGlvbi5wcm90b3R5cGUuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH0sCiAgaXNFbXB0eTogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5sZW5ndGggPiAwKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLmlzUG9wdWxhdGVkKCk7CiAgICB9CiAgfSwKICBpc1BvcHVsYXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXR1cm4gdGhpcy5fZmV0Y2hlZCB8fCB0aGlzLmxlbmd0aCA+IDAgfHwgKCF0aGlzLmxlbmd0aCAmJiAhZ2V0VmFsdWUodGhpcywgJ3VybCcpKTsKICB9LAogIHNob3VsZEZldGNoOiBmdW5jdGlvbihvcHRpb25zKSB7CiAgICByZXR1cm4gb3B0aW9ucy5mZXRjaCAmJiAhIWdldFZhbHVlKHRoaXMsICd1cmwnKSAmJiAhdGhpcy5pc1BvcHVsYXRlZCgpOwogIH0sCiAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogICAgdmFyIHN1Y2Nlc3MgPSBvcHRpb25zLnN1Y2Nlc3M7CiAgICBvcHRpb25zLnN1Y2Nlc3MgPSBmdW5jdGlvbihjb2xsZWN0aW9uLCByZXNwb25zZSkgewogICAgICBjb2xsZWN0aW9uLl9mZXRjaGVkID0gdHJ1ZTsKICAgICAgc3VjY2VzcyAmJiBzdWNjZXNzKGNvbGxlY3Rpb24sIHJlc3BvbnNlKTsKICAgIH07CiAgICByZXR1cm4gX2ZldGNoLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgfSwKICByZXNldDogZnVuY3Rpb24obW9kZWxzLCBvcHRpb25zKSB7CiAgICB0aGlzLl9mZXRjaGVkID0gISFtb2RlbHM7CiAgICByZXR1cm4gX3Jlc2V0LmNhbGwodGhpcywgbW9kZWxzLCBvcHRpb25zKTsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25zID0ge307CmNyZWF0ZVJlZ2lzdHJ5V3JhcHBlcihUaG9yYXguQ29sbGVjdGlvbiwgVGhvcmF4LkNvbGxlY3Rpb25zKTsKCmRhdGFPYmplY3QoJ2NvbGxlY3Rpb24nLCB7CiAgc2V0OiAnc2V0Q29sbGVjdGlvbicsCiAgYmluZENhbGxiYWNrOiBvblNldENvbGxlY3Rpb24sCiAgZGVmYXVsdE9wdGlvbnM6IHsKICAgIHJlbmRlcjogdHJ1ZSwKICAgIGZldGNoOiB0cnVlLAogICAgc3VjY2VzczogZmFsc2UsCiAgICBlcnJvcnM6IHRydWUKICB9LAogIGNoYW5nZTogb25Db2xsZWN0aW9uUmVzZXQsCiAgJGVsOiAnZ2V0Q29sbGVjdGlvbkVsZW1lbnQnLAogIGNpZEF0dHJOYW1lOiBjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZQp9KTsKClRob3JheC5Db2xsZWN0aW9uVmlldyA9IFRob3JheC5WaWV3LmV4dGVuZCh7CiAgX2RlZmF1bHRUZW1wbGF0ZTogSGFuZGxlYmFycy5WTS5ub29wLAogIF9jb2xsZWN0aW9uU2VsZWN0b3I6ICdbJyArIGNvbGxlY3Rpb25FbGVtZW50QXR0cmlidXRlTmFtZSArICddJywKCiAgLy8gcHJlc2VydmUgY29sbGVjdGlvbiBlbGVtZW50IGlmIGl0IHdhcyBub3QgY3JlYXRlZCB3aXRoIHt7Y29sbGVjdGlvbn19IGhlbHBlcgogIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oaHRtbCkgewogICAgaWYgKHRoaXMuY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5jb2xsZWN0aW9uLmNpZF0gJiYgdGhpcy5fcmVuZGVyQ291bnQpIHsKICAgICAgdmFyIGVsZW1lbnQ7CiAgICAgIHZhciBvbGRDb2xsZWN0aW9uRWxlbWVudCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgZWxlbWVudCA9IF9yZXBsYWNlSFRNTC5jYWxsKHRoaXMsIGh0bWwpOwogICAgICBpZiAoIW9sZENvbGxlY3Rpb25FbGVtZW50LmF0dHIoJ2RhdGEtdmlldy1jaWQnKSkgewogICAgICAgIHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKS5yZXBsYWNlV2l0aChvbGRDb2xsZWN0aW9uRWxlbWVudCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBfcmVwbGFjZUhUTUwuY2FsbCh0aGlzLCBodG1sKTsKICAgIH0KICB9LAoKICAvL2FwcGVuZEl0ZW0obW9kZWwgWyxpbmRleF0pCiAgLy9hcHBlbmRJdGVtKGh0bWxfc3RyaW5nLCBpbmRleCkKICAvL2FwcGVuZEl0ZW0odmlldywgaW5kZXgpCiAgYXBwZW5kSXRlbTogZnVuY3Rpb24obW9kZWwsIGluZGV4LCBvcHRpb25zKSB7CiAgICAvL2VtcHR5IGl0ZW0KICAgIGlmICghbW9kZWwpIHsKICAgICAgcmV0dXJuOwogICAgfQogICAgdmFyIGl0ZW1WaWV3LAogICAgICAgICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKG9wdGlvbnMgfHwge30sIHsKICAgICAgZmlsdGVyOiB0cnVlCiAgICB9KTsKICAgIC8vaWYgaW5kZXggYXJndW1lbnQgaXMgYSB2aWV3CiAgICBpbmRleCAmJiBpbmRleC5lbCAmJiAoaW5kZXggPSAkZWwuY2hpbGRyZW4oKS5pbmRleE9mKGluZGV4LmVsKSArIDEpOwogICAgLy9pZiBhcmd1bWVudCBpcyBhIHZpZXcsIG9yIGh0bWwgc3RyaW5nCiAgICBpZiAobW9kZWwuZWwgfHwgXy5pc1N0cmluZyhtb2RlbCkpIHsKICAgICAgaXRlbVZpZXcgPSBtb2RlbDsKICAgICAgbW9kZWwgPSBmYWxzZTsKICAgIH0gZWxzZSB7CiAgICAgIGluZGV4ID0gaW5kZXggfHwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpIHx8IDA7CiAgICAgIGl0ZW1WaWV3ID0gdGhpcy5yZW5kZXJJdGVtKG1vZGVsLCBpbmRleCk7CiAgICB9CiAgICBpZiAoaXRlbVZpZXcpIHsKICAgICAgaXRlbVZpZXcuY2lkICYmIHRoaXMuX2FkZENoaWxkKGl0ZW1WaWV3KTsKICAgICAgLy9pZiB0aGUgcmVuZGVyZXIncyBvdXRwdXQgd2Fzbid0IGNvbnRhaW5lZCBpbiBhIHRhZywgd3JhcCBpdCBpbiBhIGRpdgogICAgICAvL3BsYWluIHRleHQsIG9yIGEgbWl4dHVyZSBvZiB0b3AgbGV2ZWwgdGV4dCBub2RlcyBhbmQgZWxlbWVudCBub2RlcwogICAgICAvL3dpbGwgZ2V0IHdyYXBwZWQKICAgICAgaWYgKF8uaXNTdHJpbmcoaXRlbVZpZXcpICYmICFpdGVtVmlldy5tYXRjaCgvXlxzKjwvbSkpIHsKICAgICAgICBpdGVtVmlldyA9ICc8ZGl2PicgKyBpdGVtVmlldyArICc8L2Rpdj4nOwogICAgICB9CiAgICAgIHZhciBpdGVtRWxlbWVudCA9IGl0ZW1WaWV3LmVsID8gW2l0ZW1WaWV3LmVsXSA6IF8uZmlsdGVyKCQoJC50cmltKGl0ZW1WaWV3KSksIGZ1bmN0aW9uKG5vZGUpIHsKICAgICAgICAvL2ZpbHRlciBvdXQgdG9wIGxldmVsIHdoaXRlc3BhY2Ugbm9kZXMKICAgICAgICByZXR1cm4gbm9kZS5ub2RlVHlwZSA9PT0gRUxFTUVOVF9OT0RFX1RZUEU7CiAgICAgIH0pOwogICAgICBtb2RlbCAmJiAkKGl0ZW1FbGVtZW50KS5hdHRyKG1vZGVsQ2lkQXR0cmlidXRlTmFtZSwgbW9kZWwuY2lkKTsKICAgICAgdmFyIHByZXZpb3VzTW9kZWwgPSBpbmRleCA+IDAgPyB0aGlzLmNvbGxlY3Rpb24uYXQoaW5kZXggLSAxKSA6IGZhbHNlOwogICAgICBpZiAoIXByZXZpb3VzTW9kZWwpIHsKICAgICAgICAkZWwucHJlcGVuZChpdGVtRWxlbWVudCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy91c2UgbGFzdCgpIGFzIGFwcGVuZEl0ZW0gY2FuIGFjY2VwdCBtdWx0aXBsZSBub2RlcyBmcm9tIGEgdGVtcGxhdGUKICAgICAgICB2YXIgbGFzdCA9ICRlbC5jaGlsZHJlbignWycgKyBtb2RlbENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgcHJldmlvdXNNb2RlbC5jaWQgKyAnIl0nKS5sYXN0KCk7CiAgICAgICAgbGFzdC5hZnRlcihpdGVtRWxlbWVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMudHJpZ2dlcignYXBwZW5kJywgbnVsbCwgZnVuY3Rpb24oZWwpIHsKICAgICAgICBlbC5zZXRBdHRyaWJ1dGUobW9kZWxDaWRBdHRyaWJ1dGVOYW1lLCBtb2RlbC5jaWQpOwogICAgICB9KTsKCiAgICAgICFvcHRpb25zLnNpbGVudCAmJiB0aGlzLnRyaWdnZXIoJ3JlbmRlcmVkOml0ZW0nLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24sIG1vZGVsLCBpdGVtRWxlbWVudCwgaW5kZXgpOwogICAgICBvcHRpb25zLmZpbHRlciAmJiBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9CiAgICByZXR1cm4gaXRlbVZpZXc7CiAgfSwKICAvL8KgdXBkYXRlSXRlbSBvbmx5IHVzZWZ1bCBpZiB0aGVyZSBpcyBubyBpdGVtIHZpZXcsIG90aGVyd2lzZQogIC8vwqBpdGVtVmlldy5yZW5kZXIoKSBwcm92aWRlcyB0aGUgc2FtZSBmdW5jdGlvbmFsaXR5CiAgdXBkYXRlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICB0aGlzLmFwcGVuZEl0ZW0obW9kZWwpOwogIH0sCiAgcmVtb3ZlSXRlbTogZnVuY3Rpb24obW9kZWwpIHsKICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCksCiAgICAgICAgdmlld0VsID0gJGVsLmZpbmQoJ1snICsgbW9kZWxDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIG1vZGVsLmNpZCArICciXScpOwogICAgaWYgKCF2aWV3RWwubGVuZ3RoKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHZpZXdFbC5yZW1vdmUoKTsKICAgIHZhciB2aWV3Q2lkID0gdmlld0VsLmF0dHIodmlld0NpZEF0dHJpYnV0ZU5hbWUpLAogICAgICAgIGNoaWxkID0gdGhpcy5jaGlsZHJlblt2aWV3Q2lkXTsKICAgIGlmIChjaGlsZCkgewogICAgICB0aGlzLl9yZW1vdmVDaGlsZChjaGlsZCk7CiAgICAgIGNoaWxkLmRlc3Ryb3koKTsKICAgIH0KICAgIHJldHVybiB0cnVlOwogIH0sCiAgcmVuZGVyQ29sbGVjdGlvbjogZnVuY3Rpb24oKSB7CiAgICBpZiAodGhpcy5jb2xsZWN0aW9uKSB7CiAgICAgIGlmICh0aGlzLmNvbGxlY3Rpb24uaXNFbXB0eSgpKSB7CiAgICAgICAgaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eS5jYWxsKHRoaXMpOwogICAgICB9IGVsc2UgewogICAgICAgIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgICB0aGlzLmNvbGxlY3Rpb24uZm9yRWFjaChmdW5jdGlvbihpdGVtLCBpKSB7CiAgICAgICAgICB0aGlzLmFwcGVuZEl0ZW0oaXRlbSwgaSk7CiAgICAgICAgfSwgdGhpcyk7CiAgICAgIH0KICAgICAgdGhpcy50cmlnZ2VyKCdyZW5kZXJlZDpjb2xsZWN0aW9uJywgdGhpcywgdGhpcy5jb2xsZWN0aW9uKTsKICAgICAgYXBwbHlWaXNpYmlsaXR5RmlsdGVyLmNhbGwodGhpcyk7CiAgICB9IGVsc2UgewogICAgICBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICB9CiAgfSwKICBlbXB0eUNsYXNzOiAnZW1wdHknLAogIHJlbmRlckVtcHR5OiBmdW5jdGlvbigpIHsKICAgIGlmICghdGhpcy5lbXB0eVRlbXBsYXRlICYmICF0aGlzLmVtcHR5VmlldykgewogICAgICBhc3NpZ25UZW1wbGF0ZS5jYWxsKHRoaXMsICdlbXB0eVRlbXBsYXRlJywgewogICAgICAgIGV4dGVuc2lvbjogJy1lbXB0eScsCiAgICAgICAgcmVxdWlyZWQ6IGZhbHNlCiAgICAgIH0pOwogICAgfQogICAgaWYgKHRoaXMuZW1wdHlWaWV3KSB7CiAgICAgIHZhciB2aWV3T3B0aW9ucyA9IHt9OwogICAgICBpZiAodGhpcy5lbXB0eVRlbXBsYXRlKSB7CiAgICAgICAgdmlld09wdGlvbnMudGVtcGxhdGUgPSB0aGlzLmVtcHR5VGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5lbXB0eVZpZXcsIHZpZXdPcHRpb25zKTsKICAgICAgdmlldy5lbnN1cmVSZW5kZXJlZCgpOwogICAgICByZXR1cm4gdmlldzsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmVtcHR5VGVtcGxhdGUgJiYgdGhpcy5yZW5kZXJUZW1wbGF0ZSh0aGlzLmVtcHR5VGVtcGxhdGUpOwogICAgfQogIH0sCiAgcmVuZGVySXRlbTogZnVuY3Rpb24obW9kZWwsIGkpIHsKICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUgJiYgIXRoaXMuaXRlbVZpZXcpIHsKICAgICAgYXNzaWduVGVtcGxhdGUuY2FsbCh0aGlzLCAnaXRlbVRlbXBsYXRlJywgewogICAgICAgIGV4dGVuc2lvbjogJy1pdGVtJywKICAgICAgICAvLyBvbmx5IHJlcXVpcmUgYW4gaXRlbVRlbXBsYXRlIGlmIGFuIGl0ZW1WaWV3CiAgICAgICAgLy8gaXMgbm90IHByZXNlbnQKICAgICAgICByZXF1aXJlZDogIXRoaXMuaXRlbVZpZXcKICAgICAgfSk7CiAgICB9CiAgICBpZiAodGhpcy5pdGVtVmlldykgewogICAgICB2YXIgdmlld09wdGlvbnMgPSB7CiAgICAgICAgbW9kZWw6IG1vZGVsCiAgICAgIH07CiAgICAgIGlmICh0aGlzLml0ZW1UZW1wbGF0ZSkgewogICAgICAgIHZpZXdPcHRpb25zLnRlbXBsYXRlID0gdGhpcy5pdGVtVGVtcGxhdGU7CiAgICAgIH0KICAgICAgdmFyIHZpZXcgPSBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UodGhpcy5pdGVtVmlldywgdmlld09wdGlvbnMpOwogICAgICB2aWV3LmVuc3VyZVJlbmRlcmVkKCk7CiAgICAgIHJldHVybiB2aWV3OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMucmVuZGVyVGVtcGxhdGUodGhpcy5pdGVtVGVtcGxhdGUsIHRoaXMuaXRlbUNvbnRleHQobW9kZWwsIGkpKTsKICAgIH0KICB9LAogIGl0ZW1Db250ZXh0OiBmdW5jdGlvbihtb2RlbCAvKiwgaSAqLykgewogICAgcmV0dXJuIG1vZGVsLmF0dHJpYnV0ZXM7CiAgfSwKICBhcHBlbmRFbXB0eTogZnVuY3Rpb24oKSB7CiAgICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogICAgJGVsLmVtcHR5KCk7CiAgICB2YXIgZW1wdHlDb250ZW50ID0gdGhpcy5yZW5kZXJFbXB0eSgpOwogICAgZW1wdHlDb250ZW50ICYmIHRoaXMuYXBwZW5kSXRlbShlbXB0eUNvbnRlbnQsIDAsIHsKICAgICAgc2lsZW50OiB0cnVlLAogICAgICBmaWx0ZXI6IGZhbHNlCiAgICB9KTsKICAgIHRoaXMudHJpZ2dlcigncmVuZGVyZWQ6ZW1wdHknLCB0aGlzLCB0aGlzLmNvbGxlY3Rpb24pOwogIH0sCiAgZ2V0Q29sbGVjdGlvbkVsZW1lbnQ6IGZ1bmN0aW9uKCkgewogICAgdmFyIGVsZW1lbnQgPSB0aGlzLiQodGhpcy5fY29sbGVjdGlvblNlbGVjdG9yKTsKICAgIHJldHVybiBlbGVtZW50Lmxlbmd0aCA9PT0gMCA/IHRoaXMuJGVsIDogZWxlbWVudDsKICB9Cn0pOwoKVGhvcmF4LkNvbGxlY3Rpb25WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICByZXNldDogb25Db2xsZWN0aW9uUmVzZXQsCiAgICBzb3J0OiBvbkNvbGxlY3Rpb25SZXNldCwKICAgIGZpbHRlcjogZnVuY3Rpb24oKSB7CiAgICAgIGFwcGx5VmlzaWJpbGl0eUZpbHRlci5jYWxsKHRoaXMpOwogICAgfSwKICAgIGNoYW5nZTogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgLy8gSWYgd2UgcmVuZGVyZWQgd2l0aCBpdGVtIHZpZXdzLCBtb2RlbCBjaGFuZ2VzIHdpbGwgYmUgb2JzZXJ2ZWQKICAgICAgLy8gYnkgdGhlIGdlbmVyYXRlZCBpdGVtIHZpZXcgYnV0IGlmIHdlIHJlbmRlcmVkIHdpdGggdGVtcGxhdGVzCiAgICAgIC8vIHRoZW4gbW9kZWwgY2hhbmdlcyBuZWVkIHRvIGJlIGJvdW5kIGFzIG5vdGhpbmcgaXMgd2F0Y2hpbmcKICAgICAgIXRoaXMuaXRlbVZpZXcgJiYgdGhpcy51cGRhdGVJdGVtKG1vZGVsKTsKICAgICAgYXBwbHlJdGVtVmlzaWJsaXR5RmlsdGVyLmNhbGwodGhpcywgbW9kZWwpOwogICAgfSwKICAgIGFkZDogZnVuY3Rpb24obW9kZWwpIHsKICAgICAgdmFyICRlbCA9IHRoaXMuZ2V0Q29sbGVjdGlvbkVsZW1lbnQoKTsKICAgICAgdGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMSAmJiAkZWwubGVuZ3RoICYmIGhhbmRsZUNoYW5nZUZyb21FbXB0eVRvTm90RW1wdHkuY2FsbCh0aGlzKTsKICAgICAgaWYgKCRlbC5sZW5ndGgpIHsKICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmNvbGxlY3Rpb24uaW5kZXhPZihtb2RlbCk7CiAgICAgICAgdGhpcy5hcHBlbmRJdGVtKG1vZGVsLCBpbmRleCk7CiAgICAgIH0KICAgIH0sCiAgICByZW1vdmU6IGZ1bmN0aW9uKG1vZGVsKSB7CiAgICAgIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgICAgIHRoaXMucmVtb3ZlSXRlbShtb2RlbCk7CiAgICAgIHRoaXMuY29sbGVjdGlvbi5sZW5ndGggPT09IDAgJiYgJGVsLmxlbmd0aCAmJiBoYW5kbGVDaGFuZ2VGcm9tTm90RW1wdHlUb0VtcHR5LmNhbGwodGhpcyk7CiAgICB9CiAgfQp9KTsKClRob3JheC5WaWV3Lm9uKHsKICBjb2xsZWN0aW9uOiB7CiAgICBlcnJvcjogZnVuY3Rpb24oY29sbGVjdGlvbiwgbWVzc2FnZSkgewogICAgICBpZiAodGhpcy5fb2JqZWN0T3B0aW9uc0J5Q2lkW2NvbGxlY3Rpb24uY2lkXS5lcnJvcnMpIHsKICAgICAgICB0aGlzLnRyaWdnZXIoJ2Vycm9yJywgbWVzc2FnZSwgY29sbGVjdGlvbik7CiAgICAgIH0KICAgIH0KICB9Cn0pOwoKZnVuY3Rpb24gb25Db2xsZWN0aW9uUmVzZXQoY29sbGVjdGlvbikgewogIHZhciBvcHRpb25zID0gY29sbGVjdGlvbiAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbY29sbGVjdGlvbi5jaWRdOwogIC8vIHdlIHdvdWxkIHdhbnQgdG8gc3RpbGwgcmVuZGVyIGluIHRoZSBjYXNlIHRoYXQgdGhlCiAgLy8gY29sbGVjdGlvbiBoYXMgdHJhbnNpdGlvbmVkIHRvIGJlaW5nIGZhbHN5CiAgaWYgKCFjb2xsZWN0aW9uIHx8IChvcHRpb25zICYmIG9wdGlvbnMucmVuZGVyKSkgewogICAgdGhpcy5yZW5kZXJDb2xsZWN0aW9uICYmIHRoaXMucmVuZGVyQ29sbGVjdGlvbigpOwogIH0KfQoKLy8gRXZlbiBpZiB0aGUgdmlldyBpcyBub3QgYSBDb2xsZWN0aW9uVmlldwovLyBlbnN1cmVSZW5kZXJlZCgpIHRvIHByb3ZpZGUgc2ltaWxhciBiZWhhdmlvcgovLyB0byBhIG1vZGVsCmZ1bmN0aW9uIG9uU2V0Q29sbGVjdGlvbigpIHsKICB0aGlzLmVuc3VyZVJlbmRlcmVkKCk7Cn0KCmZ1bmN0aW9uIGFwcGx5VmlzaWJpbGl0eUZpbHRlcigpIHsKICBpZiAodGhpcy5pdGVtRmlsdGVyKSB7CiAgICB0aGlzLmNvbGxlY3Rpb24uZm9yRWFjaChmdW5jdGlvbihtb2RlbCkgewogICAgICBhcHBseUl0ZW1WaXNpYmxpdHlGaWx0ZXIuY2FsbCh0aGlzLCBtb2RlbCk7CiAgICB9LCB0aGlzKTsKICB9Cn0KCmZ1bmN0aW9uIGFwcGx5SXRlbVZpc2libGl0eUZpbHRlcihtb2RlbCkgewogIHZhciAkZWwgPSB0aGlzLmdldENvbGxlY3Rpb25FbGVtZW50KCk7CiAgdGhpcy5pdGVtRmlsdGVyICYmICRlbC5maW5kKCdbJyArIG1vZGVsQ2lkQXR0cmlidXRlTmFtZSArICc9IicgKyBtb2RlbC5jaWQgKyAnIl0nKVtpdGVtU2hvdWxkQmVWaXNpYmxlLmNhbGwodGhpcywgbW9kZWwpID8gJ3Nob3cnIDogJ2hpZGUnXSgpOwp9CgpmdW5jdGlvbiBpdGVtU2hvdWxkQmVWaXNpYmxlKG1vZGVsKSB7CiAgcmV0dXJuIHRoaXMuaXRlbUZpbHRlcihtb2RlbCwgdGhpcy5jb2xsZWN0aW9uLmluZGV4T2YobW9kZWwpKTsKfQoKZnVuY3Rpb24gaGFuZGxlQ2hhbmdlRnJvbUVtcHR5VG9Ob3RFbXB0eSgpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuZW1wdHlDbGFzcyAmJiAkZWwucmVtb3ZlQ2xhc3ModGhpcy5lbXB0eUNsYXNzKTsKICAkZWwucmVtb3ZlQXR0cihjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lKTsKICAkZWwuZW1wdHkoKTsKfQoKZnVuY3Rpb24gaGFuZGxlQ2hhbmdlRnJvbU5vdEVtcHR5VG9FbXB0eSgpIHsKICB2YXIgJGVsID0gdGhpcy5nZXRDb2xsZWN0aW9uRWxlbWVudCgpOwogIHRoaXMuZW1wdHlDbGFzcyAmJiAkZWwuYWRkQ2xhc3ModGhpcy5lbXB0eUNsYXNzKTsKICAkZWwuYXR0cihjb2xsZWN0aW9uRW1wdHlBdHRyaWJ1dGVOYW1lLCB0cnVlKTsKICB0aGlzLmFwcGVuZEVtcHR5KCk7Cn0KCi8vJChzZWxlY3RvcikuY29sbGVjdGlvbigpIGhlbHBlcgokLmZuLmNvbGxlY3Rpb24gPSBmdW5jdGlvbih2aWV3KSB7CiAgaWYgKHZpZXcgJiYgdmlldy5jb2xsZWN0aW9uKSB7CiAgICByZXR1cm4gdmlldy5jb2xsZWN0aW9uOwogIH0KICB2YXIgJHRoaXMgPSAkKHRoaXMpLAogICAgICBjb2xsZWN0aW9uRWxlbWVudCA9ICR0aGlzLmNsb3Nlc3QoJ1snICsgY29sbGVjdGlvbkNpZEF0dHJpYnV0ZU5hbWUgKyAnXScpLAogICAgICBjb2xsZWN0aW9uQ2lkID0gY29sbGVjdGlvbkVsZW1lbnQgJiYgY29sbGVjdGlvbkVsZW1lbnQuYXR0cihjb2xsZWN0aW9uQ2lkQXR0cmlidXRlTmFtZSk7CiAgaWYgKGNvbGxlY3Rpb25DaWQpIHsKICAgIHZpZXcgPSAkdGhpcy52aWV3KCk7CiAgICBpZiAodmlldykgewogICAgICByZXR1cm4gdmlldy5jb2xsZWN0aW9uOwogICAgfQogIH0KICByZXR1cm4gZmFsc2U7Cn07Cgo7OwovKmdsb2JhbCBpbmhlcml0VmFycyAqLwoKaW5oZXJpdFZhcnMubW9kZWwuZGVmYXVsdE9wdGlvbnMucG9wdWxhdGUgPSB0cnVlOwoKdmFyIG9sZE1vZGVsQ2hhbmdlID0gaW5oZXJpdFZhcnMubW9kZWwuY2hhbmdlOwppbmhlcml0VmFycy5tb2RlbC5jaGFuZ2UgPSBmdW5jdGlvbigpIHsKICBvbGRNb2RlbENoYW5nZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIC8vIFRPRE8gOiBXaGF0IGNhbiB3ZSBkbyB0byByZW1vdmUgdGhpcyBkdXBsaWNhdGlvbj8KICB2YXIgbW9kZWxPcHRpb25zID0gdGhpcy5tb2RlbCAmJiB0aGlzLl9vYmplY3RPcHRpb25zQnlDaWRbdGhpcy5tb2RlbC5jaWRdOwogIGlmIChtb2RlbE9wdGlvbnMgJiYgbW9kZWxPcHRpb25zLnBvcHVsYXRlKSB7CiAgICB0aGlzLnBvcHVsYXRlKHRoaXMubW9kZWwuYXR0cmlidXRlcywgbW9kZWxPcHRpb25zLnBvcHVsYXRlID09PSB0cnVlID8ge30gOiBtb2RlbE9wdGlvbnMucG9wdWxhdGUpOwogIH0KfTsKaW5oZXJpdFZhcnMubW9kZWwuZGVmYXVsdE9wdGlvbnMucG9wdWxhdGUgPSB0cnVlOwoKXy5leHRlbmQoVGhvcmF4LlZpZXcucHJvdG90eXBlLCB7CiAgLy9zZXJpYWxpemVzIGEgZm9ybSBwcmVzZW50IGluIHRoZSB2aWV3LCByZXR1cm5pbmcgdGhlIHNlcmlhbGl6ZWQgZGF0YQogIC8vYXMgYW4gb2JqZWN0CiAgLy9wYXNzIHtzZXQ6ZmFsc2V9IHRvIG5vdCB1cGRhdGUgdGhpcy5tb2RlbCBpZiBwcmVzZW50CiAgLy9jYW4gcGFzcyBvcHRpb25zLCBjYWxsYmFjayBvciBldmVudCBpbiBhbnkgb3JkZXIKICBzZXJpYWxpemU6IGZ1bmN0aW9uKCkgewogICAgdmFyIGNhbGxiYWNrLCBvcHRpb25zLCBldmVudDsKICAgIC8vaWdub3JlIHVuZGVmaW5lZCBhcmd1bWVudHMgaW4gY2FzZSBldmVudCB3YXMgbnVsbAogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyArK2kpIHsKICAgICAgaWYgKF8uaXNGdW5jdGlvbihhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgY2FsbGJhY2sgPSBhcmd1bWVudHNbaV07CiAgICAgIH0gZWxzZSBpZiAoXy5pc09iamVjdChhcmd1bWVudHNbaV0pKSB7CiAgICAgICAgaWYgKCdzdG9wUHJvcGFnYXRpb24nIGluIGFyZ3VtZW50c1tpXSAmJiAncHJldmVudERlZmF1bHQnIGluIGFyZ3VtZW50c1tpXSkgewogICAgICAgICAgZXZlbnQgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIG9wdGlvbnMgPSBhcmd1bWVudHNbaV07CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgaWYgKGV2ZW50ICYmICF0aGlzLl9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbihldmVudCkpIHsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIG9wdGlvbnMgPSBfLmV4dGVuZCh7CiAgICAgIHNldDogdHJ1ZSwKICAgICAgdmFsaWRhdGU6IHRydWUsCiAgICAgIGNoaWxkcmVuOiB0cnVlLAogICAgICBzaWxlbnQ6IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgIHZhciBhdHRyaWJ1dGVzID0gb3B0aW9ucy5hdHRyaWJ1dGVzIHx8IHt9OwoKICAgIC8vY2FsbGJhY2sgaGFzIGNvbnRleHQgb2YgZWxlbWVudAogICAgdmFyIHZpZXcgPSB0aGlzOwogICAgdmFyIGVycm9ycyA9IFtdOwogICAgZWFjaE5hbWVkSW5wdXQuY2FsbCh0aGlzLCBvcHRpb25zLCBmdW5jdGlvbigpIHsKICAgICAgdmFyIHZhbHVlID0gdmlldy5fZ2V0SW5wdXRWYWx1ZSh0aGlzLCBvcHRpb25zLCBlcnJvcnMpOwogICAgICBpZiAoIV8uaXNVbmRlZmluZWQodmFsdWUpKSB7CiAgICAgICAgb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lLmNhbGwodGhpcywgYXR0cmlidXRlcywgdGhpcy5uYW1lLCB7bW9kZTogJ3NlcmlhbGl6ZSd9LCBmdW5jdGlvbihvYmplY3QsIGtleSkgewogICAgICAgICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICAgICAgICBvYmplY3Rba2V5XSA9IHZhbHVlOwogICAgICAgICAgfSBlbHNlIGlmIChfLmlzQXJyYXkob2JqZWN0W2tleV0pKSB7CiAgICAgICAgICAgIG9iamVjdFtrZXldLnB1c2godmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgb2JqZWN0W2tleV0gPSBbb2JqZWN0W2tleV0sIHZhbHVlXTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgfQogICAgfSk7CgogICAgdGhpcy50cmlnZ2VyKCdzZXJpYWxpemUnLCBhdHRyaWJ1dGVzLCBvcHRpb25zKTsKCiAgICBpZiAob3B0aW9ucy52YWxpZGF0ZSkgewogICAgICB2YXIgdmFsaWRhdGVJbnB1dEVycm9ycyA9IHRoaXMudmFsaWRhdGVJbnB1dChhdHRyaWJ1dGVzKTsKICAgICAgaWYgKHZhbGlkYXRlSW5wdXRFcnJvcnMgJiYgdmFsaWRhdGVJbnB1dEVycm9ycy5sZW5ndGgpIHsKICAgICAgICBlcnJvcnMgPSBlcnJvcnMuY29uY2F0KHZhbGlkYXRlSW5wdXRFcnJvcnMpOwogICAgICB9CiAgICAgIHRoaXMudHJpZ2dlcigndmFsaWRhdGUnLCBhdHRyaWJ1dGVzLCBlcnJvcnMsIG9wdGlvbnMpOwogICAgICBpZiAoZXJyb3JzLmxlbmd0aCkgewogICAgICAgIHRoaXMudHJpZ2dlcignZXJyb3InLCBlcnJvcnMpOwogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIGlmIChvcHRpb25zLnNldCAmJiB0aGlzLm1vZGVsKSB7CiAgICAgIGlmICghdGhpcy5tb2RlbC5zZXQoYXR0cmlidXRlcywge3NpbGVudDogb3B0aW9ucy5zaWxlbnR9KSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgfQoKICAgIGNhbGxiYWNrICYmIGNhbGxiYWNrLmNhbGwodGhpcywgYXR0cmlidXRlcywgXy5iaW5kKHJlc2V0U3VibWl0U3RhdGUsIHRoaXMpKTsKICAgIHJldHVybiBhdHRyaWJ1dGVzOwogIH0sCgogIF9wcmV2ZW50RHVwbGljYXRlU3VibWlzc2lvbjogZnVuY3Rpb24oZXZlbnQsIGNhbGxiYWNrKSB7CiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoKICAgIHZhciBmb3JtID0gJChldmVudC50YXJnZXQpOwogICAgaWYgKChldmVudC50YXJnZXQudGFnTmFtZSB8fCAnJykudG9Mb3dlckNhc2UoKSAhPT0gJ2Zvcm0nKSB7CiAgICAgIC8vIEhhbmRsZSBub24tc3VibWl0IGV2ZW50cyBieSBnYXRpbmcgb24gdGhlIGZvcm0KICAgICAgZm9ybSA9ICQoZXZlbnQudGFyZ2V0KS5jbG9zZXN0KCdmb3JtJyk7CiAgICB9CgogICAgaWYgKCFmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnKSkgewogICAgICBmb3JtLmF0dHIoJ2RhdGEtc3VibWl0LXdhaXQnLCAndHJ1ZScpOwogICAgICBpZiAoY2FsbGJhY2spIHsKICAgICAgICBjYWxsYmFjay5jYWxsKHRoaXMsIGV2ZW50KTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9LAoKICAvL3BvcHVsYXRlIGEgZm9ybSBmcm9tIHRoZSBwYXNzZWQgYXR0cmlidXRlcyBvciB0aGlzLm1vZGVsIGlmIHByZXNlbnQKICBwb3B1bGF0ZTogZnVuY3Rpb24oYXR0cmlidXRlcywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgY2hpbGRyZW46IHRydWUKICAgIH0sIG9wdGlvbnMgfHwge30pOwoKICAgIHZhciB2YWx1ZSwKICAgICAgICBhdHRyaWJ1dGVzID0gYXR0cmlidXRlcyB8fCB0aGlzLl9nZXRDb250ZXh0KCk7CgogICAgLy9jYWxsYmFjayBoYXMgY29udGV4dCBvZiBlbGVtZW50CiAgICBlYWNoTmFtZWRJbnB1dC5jYWxsKHRoaXMsIG9wdGlvbnMsIGZ1bmN0aW9uKCkgewogICAgICBvYmplY3RBbmRLZXlGcm9tQXR0cmlidXRlc0FuZE5hbWUuY2FsbCh0aGlzLCBhdHRyaWJ1dGVzLCB0aGlzLm5hbWUsIHttb2RlOiAncG9wdWxhdGUnfSwgZnVuY3Rpb24ob2JqZWN0LCBrZXkpIHsKICAgICAgICB2YWx1ZSA9IG9iamVjdCAmJiBvYmplY3Rba2V5XTsKCiAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHZhbHVlKSkgewogICAgICAgICAgLy93aWxsIG9ubHkgZXhlY3V0ZSBpZiB3ZSBoYXZlIGEgbmFtZSB0aGF0IG1hdGNoZXMgdGhlIHN0cnVjdHVyZSBpbiBhdHRyaWJ1dGVzCiAgICAgICAgICBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnICYmIF8uaXNCb29sZWFuKHZhbHVlKSkgewogICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSB2YWx1ZTsKICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50eXBlID09PSAnY2hlY2tib3gnIHx8IHRoaXMudHlwZSA9PT0gJ3JhZGlvJykgewogICAgICAgICAgICB0aGlzLmNoZWNrZWQgPSB2YWx1ZSA9PSB0aGlzLnZhbHVlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9KTsKCiAgICB0aGlzLnRyaWdnZXIoJ3BvcHVsYXRlJywgYXR0cmlidXRlcyk7CiAgfSwKCiAgLy9wZXJmb3JtIGZvcm0gdmFsaWRhdGlvbiwgaW1wbGVtZW50ZWQgYnkgY2hpbGQgY2xhc3MKICB2YWxpZGF0ZUlucHV0OiBmdW5jdGlvbigvKiBhdHRyaWJ1dGVzLCBvcHRpb25zLCBlcnJvcnMgKi8pIHt9LAoKICBfZ2V0SW5wdXRWYWx1ZTogZnVuY3Rpb24oaW5wdXQgLyogLCBvcHRpb25zLCBlcnJvcnMgKi8pIHsKICAgIGlmIChpbnB1dC50eXBlID09PSAnY2hlY2tib3gnIHx8IGlucHV0LnR5cGUgPT09ICdyYWRpbycpIHsKICAgICAgaWYgKGlucHV0LmNoZWNrZWQpIHsKICAgICAgICByZXR1cm4gaW5wdXQudmFsdWU7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoaW5wdXQubXVsdGlwbGUgPT09IHRydWUpIHsKICAgICAgdmFyIHZhbHVlcyA9IFtdOwogICAgICAkKCdvcHRpb24nLCBpbnB1dCkuZWFjaChmdW5jdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5zZWxlY3RlZCkgewogICAgICAgICAgdmFsdWVzLnB1c2godGhpcy52YWx1ZSk7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgcmV0dXJuIHZhbHVlczsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiBpbnB1dC52YWx1ZTsKICAgIH0KICB9Cn0pOwoKVGhvcmF4LlZpZXcub24oewogIGVycm9yOiBmdW5jdGlvbigpIHsKICAgIHJlc2V0U3VibWl0U3RhdGUuY2FsbCh0aGlzKTsKCiAgICAvLyBJZiB3ZSBlcnJvcmVkIHdpdGggYSBtb2RlbCB3ZSB3YW50IHRvIHJlc2V0IHRoZSBjb250ZW50IGJ1dCBsZWF2ZSB0aGUgVUkKICAgIC8vIGludGFjdC4gSWYgdGhlIHVzZXIgdXBkYXRlcyB0aGUgZGF0YSBhbmQgc2VyaWFsaXplcyBhbnkgb3ZlcndyaXR0ZW4gZGF0YQogICAgLy8gd2lsbCBiZSByZXN0b3JlZC4KICAgIGlmICh0aGlzLm1vZGVsICYmIHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKSB7CiAgICAgIHRoaXMubW9kZWwuc2V0KHRoaXMubW9kZWwucHJldmlvdXNBdHRyaWJ1dGVzKCksIHsKICAgICAgICBzaWxlbnQ6IHRydWUKICAgICAgfSk7CiAgICB9CiAgfSwKICBkZWFjdGl2YXRlZDogZnVuY3Rpb24oKSB7CiAgICByZXNldFN1Ym1pdFN0YXRlLmNhbGwodGhpcyk7CiAgfQp9KTsKCmZ1bmN0aW9uIGVhY2hOYW1lZElucHV0KG9wdGlvbnMsIGl0ZXJhdG9yLCBjb250ZXh0KSB7CiAgdmFyIGkgPSAwLAogICAgICBzZWxmID0gdGhpczsKCiAgdGhpcy4kKCdzZWxlY3QsaW5wdXQsdGV4dGFyZWEnLCBvcHRpb25zLnJvb3QgfHwgdGhpcy5lbCkuZWFjaChmdW5jdGlvbigpIHsKICAgIGlmICghb3B0aW9ucy5jaGlsZHJlbikgewogICAgICBpZiAoc2VsZiAhPT0gJCh0aGlzKS52aWV3KHtoZWxwZXI6IGZhbHNlfSkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgIH0KICAgIGlmICh0aGlzLnR5cGUgIT09ICdidXR0b24nICYmIHRoaXMudHlwZSAhPT0gJ2NhbmNlbCcgJiYgdGhpcy50eXBlICE9PSAnc3VibWl0JyAmJiB0aGlzLm5hbWUgJiYgdGhpcy5uYW1lICE9PSAnJykgewogICAgICBpdGVyYXRvci5jYWxsKGNvbnRleHQgfHwgdGhpcywgaSwgdGhpcyk7CiAgICAgICsraTsKICAgIH0KICB9KTsKfQoKLy9jYWxscyBhIGNhbGxiYWNrIHdpdGggdGhlIGNvcnJlY3Qgb2JqZWN0IGZyYWdtZW50IGFuZCBrZXkgZnJvbSBhIGNvbXBvdW5kIG5hbWUKZnVuY3Rpb24gb2JqZWN0QW5kS2V5RnJvbUF0dHJpYnV0ZXNBbmROYW1lKGF0dHJpYnV0ZXMsIG5hbWUsIG9wdGlvbnMsIGNhbGxiYWNrKSB7CiAgdmFyIGtleSwKICAgICAgb2JqZWN0ID0gYXR0cmlidXRlcywKICAgICAga2V5cyA9IG5hbWUuc3BsaXQoJ1snKSwKICAgICAgbW9kZSA9IG9wdGlvbnMubW9kZTsKCiAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aCAtIDE7ICsraSkgewogICAga2V5ID0ga2V5c1tpXS5yZXBsYWNlKCddJywgJycpOwogICAgaWYgKCFvYmplY3Rba2V5XSkgewogICAgICBpZiAobW9kZSA9PT0gJ3NlcmlhbGl6ZScpIHsKICAgICAgICBvYmplY3Rba2V5XSA9IHt9OwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjYWxsYmFjay5jYWxsKHRoaXMsIGZhbHNlLCBrZXkpOwogICAgICB9CiAgICB9CiAgICBvYmplY3QgPSBvYmplY3Rba2V5XTsKICB9CiAga2V5ID0ga2V5c1trZXlzLmxlbmd0aCAtIDFdLnJlcGxhY2UoJ10nLCAnJyk7CiAgY2FsbGJhY2suY2FsbCh0aGlzLCBvYmplY3QsIGtleSk7Cn0KCmZ1bmN0aW9uIHJlc2V0U3VibWl0U3RhdGUoKSB7CiAgdGhpcy4kKCdmb3JtJykucmVtb3ZlQXR0cignZGF0YS1zdWJtaXQtd2FpdCcpOwp9Cgo7Owp2YXIgbGF5b3V0Q2lkQXR0cmlidXRlTmFtZSA9ICdkYXRhLWxheW91dC1jaWQnOwoKVGhvcmF4LkxheW91dFZpZXcgPSBUaG9yYXguVmlldy5leHRlbmQoewogIF9kZWZhdWx0VGVtcGxhdGU6IEhhbmRsZWJhcnMuVk0ubm9vcCwKICByZW5kZXI6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLnJlbmRlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgaWYgKHRoaXMudGVtcGxhdGUgPT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICAvLyBpZiB0aGVyZSBpcyBubyB0ZW1wbGF0ZSBzZXRWaWV3IHdpbGwgYXBwZW5kIHRvIHRoaXMuJGVsCiAgICAgIGVuc3VyZUxheW91dENpZC5jYWxsKHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgLy8gaWYgYSB0ZW1wbGF0ZSB3YXMgc3BlY2lmaWVkIGlzIG11c3QgZGVjbGFyZSBhIGxheW91dC1lbGVtZW50CiAgICAgIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0VmlldzogZnVuY3Rpb24odmlldywgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IF8uZXh0ZW5kKHsKICAgICAgc2Nyb2xsOiB0cnVlLAogICAgICBkZXN0cm95OiB0cnVlCiAgICB9LCBvcHRpb25zIHx8IHt9KTsKICAgIGlmIChfLmlzU3RyaW5nKHZpZXcpKSB7CiAgICAgIHZpZXcgPSBuZXcgKFRob3JheC5VdGlsLnJlZ2lzdHJ5R2V0KFRob3JheCwgJ1ZpZXdzJywgdmlldywgZmFsc2UpKSgpOwogICAgfQogICAgdGhpcy5lbnN1cmVSZW5kZXJlZCgpOwogICAgdmFyIG9sZFZpZXcgPSB0aGlzLl92aWV3OwogICAgaWYgKHZpZXcgPT09IG9sZFZpZXcpIHsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgaWYgKG9wdGlvbnMuZGVzdHJveSAmJiB2aWV3KSB7CiAgICAgIHZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3ID0gdHJ1ZTsKICAgIH0KCiAgICB0aGlzLnRyaWdnZXIoJ2NoYW5nZTp2aWV3OnN0YXJ0Jywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CgogICAgaWYgKG9sZFZpZXcpIHsKICAgICAgdGhpcy5fcmVtb3ZlQ2hpbGQob2xkVmlldyk7CiAgICAgIG9sZFZpZXcuJGVsLnJlbW92ZSgpOwogICAgICB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQuY2FsbChvbGRWaWV3LCAnZGVhY3RpdmF0ZWQnLCBvcHRpb25zKTsKICAgICAgaWYgKG9sZFZpZXcuX3Nob3VsZERlc3Ryb3lPbk5leHRTZXRWaWV3KSB7CiAgICAgICAgb2xkVmlldy5kZXN0cm95KCk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAodmlldykgewogICAgICB0cmlnZ2VyTGlmZWN5Y2xlRXZlbnQuY2FsbCh0aGlzLCAnYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIHZpZXcudHJpZ2dlcignYWN0aXZhdGVkJywgb3B0aW9ucyk7CiAgICAgIHRoaXMuX2FkZENoaWxkKHZpZXcpOwogICAgICB0aGlzLl92aWV3ID0gdmlldzsKICAgICAgdGhpcy5fdmlldy5hcHBlbmRUbyhnZXRMYXlvdXRWaWV3c1RhcmdldEVsZW1lbnQuY2FsbCh0aGlzKSk7CiAgICB9IGVsc2UgewogICAgICB0aGlzLl92aWV3ID0gdW5kZWZpbmVkOwogICAgfQoKICAgIHRoaXMudHJpZ2dlcignY2hhbmdlOnZpZXc6ZW5kJywgdmlldywgb2xkVmlldywgb3B0aW9ucyk7CiAgICByZXR1cm4gdmlldzsKICB9LAoKICBnZXRWaWV3OiBmdW5jdGlvbigpIHsKICAgIHJldHVybiB0aGlzLl92aWV3OwogIH0KfSk7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsYXlvdXQtZWxlbWVudCcsIGZ1bmN0aW9uKG9wdGlvbnMpIHsKICB2YXIgdmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXc7CiAgLy8gZHVjayB0eXBlIGNoZWNrIGZvciBMYXlvdXRWaWV3CiAgaWYgKCF2aWV3LmdldFZpZXcpIHsKICAgIHRocm93IG5ldyBFcnJvcignbGF5b3V0LWVsZW1lbnQgbXVzdCBiZSB1c2VkIHdpdGhpbiBhIExheW91dFZpZXcnKTsKICB9CiAgb3B0aW9ucy5oYXNoW2xheW91dENpZEF0dHJpYnV0ZU5hbWVdID0gdmlldy5jaWQ7CiAgbm9ybWFsaXplSFRNTEF0dHJpYnV0ZU9wdGlvbnMob3B0aW9ucy5oYXNoKTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBvcHRpb25zLmhhc2gsICcnLCB0aGlzKSk7Cn0pOwoKZnVuY3Rpb24gdHJpZ2dlckxpZmVjeWNsZUV2ZW50KGV2ZW50TmFtZSwgb3B0aW9ucykgewogIG9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwogIG9wdGlvbnMudGFyZ2V0ID0gdGhpczsKICB0aGlzLnRyaWdnZXIoZXZlbnROYW1lLCBvcHRpb25zKTsKICBfLmVhY2godGhpcy5jaGlsZHJlbiwgZnVuY3Rpb24oY2hpbGQpIHsKICAgIGNoaWxkLnRyaWdnZXIoZXZlbnROYW1lLCBvcHRpb25zKTsKICB9KTsKfQoKZnVuY3Rpb24gZW5zdXJlTGF5b3V0Q2lkKCkgewogICsrdGhpcy5fcmVuZGVyQ291bnQ7CiAgLy9zZXQgdGhlIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgb24gdGhpcy4kZWwgaWYgdGhlcmUgd2FzIG5vIHRlbXBsYXRlCiAgdGhpcy4kZWwuYXR0cihsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lLCB0aGlzLmNpZCk7Cn0KCmZ1bmN0aW9uIGVuc3VyZUxheW91dFZpZXdzVGFyZ2V0RWxlbWVudCgpIHsKICBpZiAoIXRoaXMuJCgnWycgKyBsYXlvdXRDaWRBdHRyaWJ1dGVOYW1lICsgJz0iJyArIHRoaXMuY2lkICsgJyJdJylbMF0pIHsKICAgIHRocm93IG5ldyBFcnJvcignTm8gbGF5b3V0IGVsZW1lbnQgZm91bmQgaW4gJyArICh0aGlzLm5hbWUgfHwgdGhpcy5jaWQpKTsKICB9Cn0KCmZ1bmN0aW9uIGdldExheW91dFZpZXdzVGFyZ2V0RWxlbWVudCgpIHsKICByZXR1cm4gdGhpcy4kKCdbJyArIGxheW91dENpZEF0dHJpYnV0ZU5hbWUgKyAnPSInICsgdGhpcy5jaWQgKyAnIl0nKVswXSB8fCB0aGlzLmVsWzBdIHx8IHRoaXMuZWw7Cn0KCjs7Ci8qZ2xvYmFsIGNyZWF0ZVJlZ2lzdHJ5V3JhcHBlciAqLwoKLy9Sb3V0ZXIKZnVuY3Rpb24gaW5pdGlhbGl6ZVJvdXRlcigpIHsKICBCYWNrYm9uZS5oaXN0b3J5IHx8IChCYWNrYm9uZS5oaXN0b3J5ID0gbmV3IEJhY2tib25lLkhpc3RvcnkoKSk7CiAgQmFja2JvbmUuaGlzdG9yeS5vbigncm91dGUnLCBvblJvdXRlLCB0aGlzKTsKICAvL3JvdXRlciBkb2VzIG5vdCBoYXZlIGEgYnVpbHQgaW4gZGVzdHJveSBldmVudAogIC8vYnV0IFZpZXdDb250cm9sbGVyIGRvZXMKICB0aGlzLm9uKCdkZXN0cm95ZWQnLCBmdW5jdGlvbigpIHsKICAgIEJhY2tib25lLmhpc3Rvcnkub2ZmKCdyb3V0ZScsIG9uUm91dGUsIHRoaXMpOwogIH0pOwp9CgpUaG9yYXguUm91dGVyID0gQmFja2JvbmUuUm91dGVyLmV4dGVuZCh7CiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKCkgewogICAgdmFyIHJlc3BvbnNlID0gVGhvcmF4LlJvdXRlci5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIGluaXRpYWxpemVSb3V0ZXIuY2FsbCh0aGlzKTsKICAgIHJldHVybiByZXNwb25zZTsKICB9LAogIHJvdXRlOiBmdW5jdGlvbihyb3V0ZSwgbmFtZSwgY2FsbGJhY2spIHsKICAgIGlmICghY2FsbGJhY2spIHsKICAgICAgY2FsbGJhY2sgPSB0aGlzW25hbWVdOwogICAgfQogICAgLy9hZGQgYSByb3V0ZTpiZWZvcmUgZXZlbnQgdGhhdCBpcyBmaXJlZCBiZWZvcmUgdGhlIGNhbGxiYWNrIGlzIGNhbGxlZAogICAgcmV0dXJuIEJhY2tib25lLlJvdXRlci5wcm90b3R5cGUucm91dGUuY2FsbCh0aGlzLCByb3V0ZSwgbmFtZSwgZnVuY3Rpb24oKSB7CiAgICAgIHRoaXMudHJpZ2dlci5hcHBseSh0aGlzLCBbJ3JvdXRlOmJlZm9yZScsIHJvdXRlLCBuYW1lXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICByZXR1cm4gY2FsbGJhY2suYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgIH0pOwogIH0KfSk7CgpUaG9yYXguUm91dGVycyA9IHt9OwpjcmVhdGVSZWdpc3RyeVdyYXBwZXIoVGhvcmF4LlJvdXRlciwgVGhvcmF4LlJvdXRlcnMpOwoKZnVuY3Rpb24gb25Sb3V0ZShyb3V0ZXIgLyogLCBuYW1lICovKSB7CiAgaWYgKHRoaXMgPT09IHJvdXRlcikgewogICAgdGhpcy50cmlnZ2VyLmFwcGx5KHRoaXMsIFsncm91dGUnXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSkpOwogIH0KfQoKOzsKVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3ID0gVGhvcmF4LkNvbGxlY3Rpb25WaWV3LmV4dGVuZCh7CiAgLy8gRm9yd2FyZCByZW5kZXIgZXZlbnRzIHRvIHRoZSBwYXJlbnQKICBldmVudHM6IHsKICAgICdyZW5kZXJlZDppdGVtJzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDppdGVtJyksCiAgICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZvcndhcmRSZW5kZXJFdmVudCgncmVuZGVyZWQ6Y29sbGVjdGlvbicpLAogICAgJ3JlbmRlcmVkOmVtcHR5JzogZm9yd2FyZFJlbmRlckV2ZW50KCdyZW5kZXJlZDplbXB0eScpCiAgfSwKCiAgY29uc3RydWN0b3I6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgIF8uZWFjaChjb2xsZWN0aW9uT3B0aW9uTmFtZXMsIGZ1bmN0aW9uKHZpZXdBdHRyaWJ1dGVOYW1lLCBoZWxwZXJPcHRpb25OYW1lKSB7CiAgICAgIGlmIChvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV0pIHsKICAgICAgICB2YXIgdmFsdWUgPSBvcHRpb25zLm9wdGlvbnNbaGVscGVyT3B0aW9uTmFtZV07CiAgICAgICAgaWYgKHZpZXdBdHRyaWJ1dGVOYW1lID09PSAnaXRlbVRlbXBsYXRlJyB8fCB2aWV3QXR0cmlidXRlTmFtZSA9PT0gJ2VtcHR5VGVtcGxhdGUnKSB7CiAgICAgICAgICB2YWx1ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgb3B0aW9uc1t2aWV3QXR0cmlidXRlTmFtZV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSk7CiAgICAvLyBIYW5kbGViYXJzLlZNLm5vb3AgaXMgcGFzc2VkIGluIHRoZSBoYW5kbGViYXJzIG9wdGlvbnMgb2JqZWN0IGFzCiAgICAvLyBhIGRlZmF1bHQgZm9yIGZuIGFuZCBpbnZlcnNlLCBpZiBhIGJsb2NrIHdhcyBwcmVzZW50LiBOZWVkIHRvCiAgICAvLyBjaGVjayB0byBlbnN1cmUgd2UgZG9uJ3QgcGljayB0aGUgZW1wdHkgLyBudWxsIGJsb2NrIHVwLgogICAgaWYgKCFvcHRpb25zLml0ZW1UZW1wbGF0ZSAmJiBvcHRpb25zLnRlbXBsYXRlICYmIG9wdGlvbnMudGVtcGxhdGUgIT09IEhhbmRsZWJhcnMuVk0ubm9vcCkgewogICAgICBvcHRpb25zLml0ZW1UZW1wbGF0ZSA9IG9wdGlvbnMudGVtcGxhdGU7CiAgICAgIG9wdGlvbnMudGVtcGxhdGUgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICBpZiAoIW9wdGlvbnMuZW1wdHlUZW1wbGF0ZSAmJiBvcHRpb25zLmludmVyc2UgJiYgb3B0aW9ucy5pbnZlcnNlICE9PSBIYW5kbGViYXJzLlZNLm5vb3ApIHsKICAgICAgb3B0aW9ucy5lbXB0eVRlbXBsYXRlID0gb3B0aW9ucy5pbnZlcnNlOwogICAgICBvcHRpb25zLmludmVyc2UgPSBIYW5kbGViYXJzLlZNLm5vb3A7CiAgICB9CiAgICB2YXIgcmVzcG9uc2UgPSBUaG9yYXguSGVscGVyVmlldy5jYWxsKHRoaXMsIG9wdGlvbnMpOwogICAgaWYgKHRoaXMucGFyZW50Lm5hbWUpIHsKICAgICAgaWYgKCF0aGlzLmVtcHR5VGVtcGxhdGUpIHsKICAgICAgICB0aGlzLmVtcHR5VGVtcGxhdGUgPSBUaG9yYXguVXRpbC5nZXRUZW1wbGF0ZSh0aGlzLnBhcmVudC5uYW1lICsgJy1lbXB0eScsIHRydWUpOwogICAgICB9CiAgICAgIGlmICghdGhpcy5pdGVtVGVtcGxhdGUpIHsKICAgICAgICAvLyBpdGVtIHRlbXBsYXRlIG11c3QgYmUgcHJlc2VudCBpZiBhbiBpdGVtVmlldyBpcyBub3QKICAgICAgICB0aGlzLml0ZW1UZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRoaXMucGFyZW50Lm5hbWUgKyAnLWl0ZW0nLCAhIXRoaXMuaXRlbVZpZXcpOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIHJlc3BvbnNlOwogIH0sCiAgc2V0QXNQcmltYXJ5Q29sbGVjdGlvbkhlbHBlcjogZnVuY3Rpb24oKSB7CiAgICBfLmVhY2goZm9yd2FyZGFibGVQcm9wZXJ0aWVzLCBmdW5jdGlvbihwcm9wZXJ0eU5hbWUpIHsKICAgICAgZm9yd2FyZE1pc3NpbmdQcm9wZXJ0eS5jYWxsKHRoaXMsIHByb3BlcnR5TmFtZSk7CiAgICB9LCB0aGlzKTsKICAgIGlmICh0aGlzLnBhcmVudC5pdGVtRmlsdGVyICYmICF0aGlzLml0ZW1GaWx0ZXIpIHsKICAgICAgdGhpcy5pdGVtRmlsdGVyID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMucGFyZW50Lml0ZW1GaWx0ZXIuYXBwbHkodGhpcy5wYXJlbnQsIGFyZ3VtZW50cyk7CiAgICAgIH07CiAgICB9CiAgICBpZiAodGhpcy5wYXJlbnQuaXRlbUNvbnRleHQpIHsKICAgICAgdGhpcy5pdGVtQ29udGV4dCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiB0aGlzLnBhcmVudC5pdGVtQ29udGV4dC5hcHBseSh0aGlzLnBhcmVudCwgYXJndW1lbnRzKTsKICAgICAgfTsKICAgIH0KICB9Cn0pOwoKXy5leHRlbmQoVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZSwgaGVscGVyVmlld1Byb3RvdHlwZSk7Cgp2YXIgY29sbGVjdGlvbk9wdGlvbk5hbWVzID0gewogICdpdGVtLXRlbXBsYXRlJzogJ2l0ZW1UZW1wbGF0ZScsCiAgJ2VtcHR5LXRlbXBsYXRlJzogJ2VtcHR5VGVtcGxhdGUnLAogICdpdGVtLXZpZXcnOiAnaXRlbVZpZXcnLAogICdlbXB0eS12aWV3JzogJ2VtcHR5VmlldycsCiAgJ2VtcHR5LWNsYXNzJzogJ2VtcHR5Q2xhc3MnCn07CgpmdW5jdGlvbiBmb3J3YXJkUmVuZGVyRXZlbnQoZXZlbnROYW1lKSB7CiAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgdmFyIGFyZ3MgPSBfLnRvQXJyYXkoYXJndW1lbnRzKTsKICAgIGFyZ3MudW5zaGlmdChldmVudE5hbWUpOwogICAgdGhpcy5wYXJlbnQudHJpZ2dlci5hcHBseSh0aGlzLnBhcmVudCwgYXJncyk7CiAgfQp9Cgp2YXIgZm9yd2FyZGFibGVQcm9wZXJ0aWVzID0gWwogICdpdGVtVGVtcGxhdGUnLAogICdpdGVtVmlldycsCiAgJ2VtcHR5VGVtcGxhdGUnLAogICdlbXB0eVZpZXcnCl07CgpmdW5jdGlvbiBmb3J3YXJkTWlzc2luZ1Byb3BlcnR5KHByb3BlcnR5TmFtZSkgewogIHZhciBwYXJlbnQgPSBnZXRQYXJlbnQodGhpcyk7CiAgaWYgKCF0aGlzW3Byb3BlcnR5TmFtZV0pIHsKICAgIHZhciBwcm9wID0gcGFyZW50W3Byb3BlcnR5TmFtZV07CiAgICBpZiAocHJvcCl7CiAgICAgIHRoaXNbcHJvcGVydHlOYW1lXSA9IHByb3A7CiAgICB9CiAgfQp9CgpIYW5kbGViYXJzLnJlZ2lzdGVyVmlld0hlbHBlcignY29sbGVjdGlvbicsIFRob3JheC5Db2xsZWN0aW9uSGVscGVyVmlldywgZnVuY3Rpb24oY29sbGVjdGlvbiwgdmlldykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICB2aWV3ID0gY29sbGVjdGlvbjsKICAgIGNvbGxlY3Rpb24gPSB2aWV3LnBhcmVudC5jb2xsZWN0aW9uOwogICAgY29sbGVjdGlvbiAmJiB2aWV3LnNldEFzUHJpbWFyeUNvbGxlY3Rpb25IZWxwZXIoKTsKICAgIHZpZXcuJGVsLmF0dHIoY29sbGVjdGlvbkVsZW1lbnRBdHRyaWJ1dGVOYW1lLCAndHJ1ZScpOwogICAgLy8gcHJvcGFnYXRlIGZ1dHVyZSBjaGFuZ2VzIHRvIHRoZSBwYXJlbnQncyBjb2xsZWN0aW9uIG9iamVjdAogICAgLy8gdG8gdGhlIGhlbHBlciB2aWV3CiAgICB2aWV3Lmxpc3RlblRvKHZpZXcucGFyZW50LCAnY2hhbmdlOmRhdGEtb2JqZWN0JywgZnVuY3Rpb24odHlwZSwgZGF0YU9iamVjdCkgewogICAgICBpZiAodHlwZSA9PT0gJ2NvbGxlY3Rpb24nKSB7CiAgICAgICAgdmlldy5zZXRBc1ByaW1hcnlDb2xsZWN0aW9uSGVscGVyKCk7CiAgICAgICAgdmlldy5zZXRDb2xsZWN0aW9uKGRhdGFPYmplY3QpOwogICAgICB9CiAgICB9KTsKICB9CiAgY29sbGVjdGlvbiAmJiB2aWV3LnNldENvbGxlY3Rpb24oY29sbGVjdGlvbik7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignY29sbGVjdGlvbi1lbGVtZW50JywgZnVuY3Rpb24ob3B0aW9ucykgewogIGlmICghZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJDb2xsZWN0aW9uKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImNvbGxlY3Rpb24tZWxlbWVudCBoZWxwZXIgbXVzdCBiZSBkZWNsYXJlZCBpbnNpZGUgb2YgYSBDb2xsZWN0aW9uVmlldyIpOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaDsKICBub3JtYWxpemVIVE1MQXR0cmlidXRlT3B0aW9ucyhoYXNoKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2Rpdic7CiAgaGFzaFtjb2xsZWN0aW9uRWxlbWVudEF0dHJpYnV0ZU5hbWVdID0gdHJ1ZTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcuY2FsbCh0aGlzLCBoYXNoLCAnJywgdGhpcykpOwp9KTsKCjs7CkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2VtcHR5JywgZnVuY3Rpb24oZGF0YU9iamVjdCwgb3B0aW9ucykgewogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBvcHRpb25zID0gZGF0YU9iamVjdDsKICB9CiAgdmFyIHZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3OwogIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAxKSB7CiAgICBkYXRhT2JqZWN0ID0gdmlldy5tb2RlbDsKICB9CiAgLy8gbGlzdGVuZXJzIGZvciB0aGUgZW1wdHkgaGVscGVyIHJhdGhlciB0aGFuIGxpc3RlbmVycwogIC8vIHRoYXQgYXJlIHRoZW1zZWx2ZXMgZW1wdHkKICBpZiAoIXZpZXcuX2VtcHR5TGlzdGVuZXJzKSB7CiAgICB2aWV3Ll9lbXB0eUxpc3RlbmVycyA9IHt9OwogIH0KICAvLyBkdWNrIHR5cGUgY2hlY2sgZm9yIGNvbGxlY3Rpb24KICBpZiAoZGF0YU9iamVjdCAmJiAhdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdICYmIGRhdGFPYmplY3QubW9kZWxzICYmICgnbGVuZ3RoJyBpbiBkYXRhT2JqZWN0KSkgewogICAgdmlldy5fZW1wdHlMaXN0ZW5lcnNbZGF0YU9iamVjdC5jaWRdID0gdHJ1ZTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3JlbW92ZScsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDApIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ2FkZCcsIGZ1bmN0aW9uKCkgewogICAgICBpZiAoZGF0YU9iamVjdC5sZW5ndGggPT09IDEpIHsKICAgICAgICB2aWV3LnJlbmRlcigpOwogICAgICB9CiAgICB9KTsKICAgIHZpZXcubGlzdGVuVG8oZGF0YU9iamVjdCwgJ3Jlc2V0JywgZnVuY3Rpb24oKSB7CiAgICAgIHZpZXcucmVuZGVyKCk7CiAgICB9KTsKICB9CiAgcmV0dXJuICFkYXRhT2JqZWN0IHx8IGRhdGFPYmplY3QuaXNFbXB0eSgpID8gb3B0aW9ucy5mbih0aGlzKSA6IG9wdGlvbnMuaW52ZXJzZSh0aGlzKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZW1wbGF0ZScsIGZ1bmN0aW9uKG5hbWUsIG9wdGlvbnMpIHsKICB2YXIgY29udGV4dCA9IF8uZXh0ZW5kKHtmbjogb3B0aW9ucyAmJiBvcHRpb25zLmZufSwgdGhpcywgb3B0aW9ucyA/IG9wdGlvbnMuaGFzaCA6IHt9KTsKICB2YXIgb3V0cHV0ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldy5yZW5kZXJUZW1wbGF0ZShuYW1lLCBjb250ZXh0KTsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhvdXRwdXQpOwp9KTsKCkhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3lpZWxkJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHJldHVybiBnZXRPcHRpb25zRGF0YShvcHRpb25zKS55aWVsZCAmJiBvcHRpb25zLmRhdGEueWllbGQoKTsKfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd1cmwnLCBmdW5jdGlvbih1cmwpIHsKICB2YXIgZnJhZ21lbnQ7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAyKSB7CiAgICBmcmFnbWVudCA9IF8ubWFwKF8uaGVhZChhcmd1bWVudHMsIGFyZ3VtZW50cy5sZW5ndGggLSAxKSwgZW5jb2RlVVJJQ29tcG9uZW50KS5qb2luKCcvJyk7CiAgfSBlbHNlIHsKICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzWzFdLAogICAgICAgIGhhc2ggPSAob3B0aW9ucyAmJiBvcHRpb25zLmhhc2gpIHx8IG9wdGlvbnM7CiAgICBpZiAoaGFzaCAmJiBoYXNoWydleHBhbmQtdG9rZW5zJ10pIHsKICAgICAgZnJhZ21lbnQgPSBUaG9yYXguVXRpbC5leHBhbmRUb2tlbih1cmwsIHRoaXMpOwogICAgfSBlbHNlIHsKICAgICAgZnJhZ21lbnQgPSB1cmw7CiAgICB9CiAgfQogIHJldHVybiAoQmFja2JvbmUuaGlzdG9yeS5faGFzUHVzaFN0YXRlID8gQmFja2JvbmUuaGlzdG9yeS5vcHRpb25zLnJvb3QgOiAnIycpICsgZnJhZ21lbnQ7Cn0pOwoKOzsKLypnbG9iYWwgdmlld1RlbXBsYXRlT3ZlcnJpZGVzICovCkhhbmRsZWJhcnMucmVnaXN0ZXJWaWV3SGVscGVyKCd2aWV3JywgewogIGZhY3Rvcnk6IGZ1bmN0aW9uKGFyZ3MsIG9wdGlvbnMpIHsKICAgIHZhciBWaWV3ID0gYXJncy5sZW5ndGggPj0gMSA/IGFyZ3NbMF0gOiBUaG9yYXguVmlldzsKICAgIHJldHVybiBUaG9yYXguVXRpbC5nZXRWaWV3SW5zdGFuY2UoVmlldywgb3B0aW9ucy5vcHRpb25zKTsKICB9LAogIGNhbGxiYWNrOiBmdW5jdGlvbigpIHsKICAgIHZhciBpbnN0YW5jZSA9IGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoLTFdLAogICAgICAgIG9wdGlvbnMgPSBpbnN0YW5jZS5faGVscGVyT3B0aW9ucy5vcHRpb25zLAogICAgICAgIHBsYWNlaG9sZGVySWQgPSBpbnN0YW5jZS5jaWQ7CgogICAgaWYgKG9wdGlvbnMuZm4pIHsKICAgICAgdmlld1RlbXBsYXRlT3ZlcnJpZGVzW3BsYWNlaG9sZGVySWRdID0gb3B0aW9ucy5mbjsKICAgIH0KICB9Cn0pOwoKOzsKdmFyIGNhbGxNZXRob2RBdHRyaWJ1dGVOYW1lID0gJ2RhdGEtY2FsbC1tZXRob2QnLAogICAgdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZSA9ICdkYXRhLXRyaWdnZXItZXZlbnQnOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignYnV0dG9uJywgZnVuY3Rpb24obWV0aG9kLCBvcHRpb25zKSB7CiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDEpIHsKICAgIG9wdGlvbnMgPSBtZXRob2Q7CiAgICBtZXRob2QgPSBvcHRpb25zLmhhc2gubWV0aG9kOwogIH0KICB2YXIgaGFzaCA9IG9wdGlvbnMuaGFzaCwKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCFtZXRob2QgJiYgIW9wdGlvbnMuaGFzaC50cmlnZ2VyKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImJ1dHRvbiBoZWxwZXIgbXVzdCBoYXZlIGEgbWV0aG9kIG5hbWUgYXMgdGhlIGZpcnN0IGFyZ3VtZW50IG9yIGEgJ3RyaWdnZXInLCBvciBhICdtZXRob2QnIGF0dHJpYnV0ZSBzcGVjaWZpZWQuIik7CiAgfQogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIGhhc2gudGFnTmFtZSA9IGhhc2gudGFnTmFtZSB8fCAnYnV0dG9uJzsKICBoYXNoLnRyaWdnZXIgJiYgKGhhc2hbdHJpZ2dlckV2ZW50QXR0cmlidXRlTmFtZV0gPSBoYXNoLnRyaWdnZXIpOwogIGRlbGV0ZSBoYXNoLnRyaWdnZXI7CiAgbWV0aG9kICYmIChoYXNoW2NhbGxNZXRob2RBdHRyaWJ1dGVOYW1lXSA9IG1ldGhvZCk7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGhhc2gsIG9wdGlvbnMuZm4gPyBvcHRpb25zLmZuKHRoaXMpIDogJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7Cn0pOwoKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignbGluaycsIGZ1bmN0aW9uKCkgewogIHZhciBhcmdzID0gXy50b0FycmF5KGFyZ3VtZW50cyksCiAgICAgIG9wdGlvbnMgPSBhcmdzLnBvcCgpLAogICAgICBoYXNoID0gb3B0aW9ucy5oYXNoLAogICAgICAvLyB1cmwgaXMgYW4gYXJyYXkgdGhhdCB3aWxsIGJlIHBhc3NlZCB0byB0aGUgdXJsIGhlbHBlcgogICAgICB1cmwgPSBhcmdzLmxlbmd0aCA9PT0gMCA/IFtoYXNoLmhyZWZdIDogYXJncywKICAgICAgZXhwYW5kVG9rZW5zID0gaGFzaFsnZXhwYW5kLXRva2VucyddOwogIGRlbGV0ZSBoYXNoWydleHBhbmQtdG9rZW5zJ107CiAgaWYgKCF1cmxbMF0gJiYgdXJsWzBdICE9PSAnJykgewogICAgdGhyb3cgbmV3IEVycm9yKCJsaW5rIGhlbHBlciByZXF1aXJlcyBhbiBocmVmIGFzIHRoZSBmaXJzdCBhcmd1bWVudCBvciBhbiAnaHJlZicgYXR0cmlidXRlIik7CiAgfQogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKGhhc2gpOwogIHVybC5wdXNoKG9wdGlvbnMpOwogIGhhc2guaHJlZiA9IEhhbmRsZWJhcnMuaGVscGVycy51cmwuYXBwbHkodGhpcywgdXJsKTsKICBoYXNoLnRhZ05hbWUgPSBoYXNoLnRhZ05hbWUgfHwgJ2EnOwogIGhhc2gudHJpZ2dlciAmJiAoaGFzaFt0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lXSA9IG9wdGlvbnMuaGFzaC50cmlnZ2VyKTsKICBkZWxldGUgaGFzaC50cmlnZ2VyOwogIGhhc2hbY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWVdID0gJ19hbmNob3JDbGljayc7CiAgcmV0dXJuIG5ldyBIYW5kbGViYXJzLlNhZmVTdHJpbmcoVGhvcmF4LlV0aWwudGFnKGhhc2gsIG9wdGlvbnMuZm4gPyBvcHRpb25zLmZuKHRoaXMpIDogJycsIGV4cGFuZFRva2VucyA/IHRoaXMgOiBudWxsKSk7Cn0pOwoKdmFyIGNsaWNrU2VsZWN0b3IgPSAnWycgKyBjYWxsTWV0aG9kQXR0cmlidXRlTmFtZSArICddLCBbJyArIHRyaWdnZXJFdmVudEF0dHJpYnV0ZU5hbWUgKyAnXSc7CgpmdW5jdGlvbiBoYW5kbGVDbGljayhldmVudCkgewogIHZhciB0YXJnZXQgPSAkKGV2ZW50LnRhcmdldCksCiAgICAgIHZpZXcgPSB0YXJnZXQudmlldyh7aGVscGVyOiBmYWxzZX0pLAogICAgICBtZXRob2ROYW1lID0gdGFyZ2V0LmF0dHIoY2FsbE1ldGhvZEF0dHJpYnV0ZU5hbWUpLAogICAgICBldmVudE5hbWUgPSB0YXJnZXQuYXR0cih0cmlnZ2VyRXZlbnRBdHRyaWJ1dGVOYW1lKSwKICAgICAgbWV0aG9kUmVzcG9uc2UgPSBmYWxzZTsKICBtZXRob2ROYW1lICYmIChtZXRob2RSZXNwb25zZSA9IHZpZXdbbWV0aG9kTmFtZV0uY2FsbCh2aWV3LCBldmVudCkpOwogIGV2ZW50TmFtZSAmJiB2aWV3LnRyaWdnZXIoZXZlbnROYW1lLCBldmVudCk7CiAgdGFyZ2V0LnRhZ05hbWUgPT09ICJBIiAmJiBtZXRob2RSZXNwb25zZSA9PT0gZmFsc2UgJiYgZXZlbnQucHJldmVudERlZmF1bHQoKTsKfQoKdmFyIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWU7CgpmdW5jdGlvbiByZWdpc3RlckNsaWNrSGFuZGxlcigpIHsKICB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCk7CiAgbGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSA9IFRob3JheC5fZmFzdENsaWNrRXZlbnROYW1lIHx8ICdjbGljayc7CiAgJChkb2N1bWVudCkub24obGFzdENsaWNrSGFuZGxlckV2ZW50TmFtZSwgY2xpY2tTZWxlY3RvciwgaGFuZGxlQ2xpY2spOwp9CgpmdW5jdGlvbiB1bnJlZ2lzdGVyQ2xpY2tIYW5kbGVyKCkgewogIGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUgJiYgJChkb2N1bWVudCkub2ZmKGxhc3RDbGlja0hhbmRsZXJFdmVudE5hbWUsIGNsaWNrU2VsZWN0b3IsIGhhbmRsZUNsaWNrKTsKfQoKJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24oKSB7CiAgaWYgKCFUaG9yYXguX2Zhc3RDbGlja0V2ZW50TmFtZSkgewogICAgcmVnaXN0ZXJDbGlja0hhbmRsZXIoKTsKICB9Cn0pOwoKOzsKdmFyIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgPSAnZGF0YS1lbGVtZW50LXRtcCc7CgpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdlbGVtZW50JywgZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucykgewogIG5vcm1hbGl6ZUhUTUxBdHRyaWJ1dGVPcHRpb25zKG9wdGlvbnMuaGFzaCk7CiAgdmFyIGNpZCA9IF8udW5pcXVlSWQoJ2VsZW1lbnQnKSwKICAgICAgZGVjbGFyaW5nVmlldyA9IGdldE9wdGlvbnNEYXRhKG9wdGlvbnMpLnZpZXcsCiAgICAgIGh0bWxBdHRyaWJ1dGVzID0gXy5waWNrKG9wdGlvbnMuaGFzaCwgaHRtbEF0dHJpYnV0ZXNUb0NvcHkpOwogIGh0bWxBdHRyaWJ1dGVzW2VsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWVdID0gY2lkOwogIGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgfHwgKGRlY2xhcmluZ1ZpZXcuX2VsZW1lbnRzQnlDaWQgPSB7fSk7CiAgZGVjbGFyaW5nVmlldy5fZWxlbWVudHNCeUNpZFtjaWRdID0gZWxlbWVudDsKICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyhUaG9yYXguVXRpbC50YWcoaHRtbEF0dHJpYnV0ZXMpKTsKfSk7CgpUaG9yYXguVmlldy5vbignYXBwZW5kJywgZnVuY3Rpb24oc2NvcGUsIGNhbGxiYWNrKSB7CiAgKHNjb3BlIHx8IHRoaXMuJGVsKS5maW5kKCdbJyArIGVsZW1lbnRQbGFjZWhvbGRlckF0dHJpYnV0ZU5hbWUgKyAnXScpLmZvckVhY2goZnVuY3Rpb24oZWwpIHsKICAgIHZhciAkZWwgPSAkKGVsKSwKICAgICAgICBjaWQgPSAkZWwuYXR0cihlbGVtZW50UGxhY2Vob2xkZXJBdHRyaWJ1dGVOYW1lKSwKICAgICAgICBlbGVtZW50ID0gdGhpcy5fZWxlbWVudHNCeUNpZFtjaWRdOwogICAgLy8gQSBjYWxsYmFjayBmdW5jdGlvbiBtYXkgYmUgc3BlY2lmaWVkIGFzIHRoZSB2YWx1ZQogICAgaWYgKF8uaXNGdW5jdGlvbihlbGVtZW50KSkgewogICAgICBlbGVtZW50ID0gZWxlbWVudC5jYWxsKHRoaXMpOwogICAgfQogICAgJGVsLnJlcGxhY2VXaXRoKGVsZW1lbnQpOwogICAgY2FsbGJhY2sgJiYgY2FsbGJhY2soZWxlbWVudCk7CiAgfSwgdGhpcyk7Cn0pOwoKOzsKSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignc3VwZXInLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgdmFyIGRlY2xhcmluZ1ZpZXcgPSBnZXRPcHRpb25zRGF0YShvcHRpb25zKS52aWV3LAogICAgICBwYXJlbnQgPSBkZWNsYXJpbmdWaWV3LmNvbnN0cnVjdG9yICYmIGRlY2xhcmluZ1ZpZXcuY29uc3RydWN0b3IuX19zdXBlcl9fOwogIGlmIChwYXJlbnQpIHsKICAgIHZhciB0ZW1wbGF0ZSA9IHBhcmVudC50ZW1wbGF0ZTsKICAgIGlmICghdGVtcGxhdGUpIHsKICAgICAgaWYgKCFwYXJlbnQubmFtZSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHVzZSBzdXBlciBoZWxwZXIgd2hlbiBwYXJlbnQgaGFzIG5vIG5hbWUgb3IgdGVtcGxhdGUuJyk7CiAgICAgIH0KICAgICAgdGVtcGxhdGUgPSBwYXJlbnQubmFtZTsKICAgIH0KICAgIGlmIChfLmlzU3RyaW5nKHRlbXBsYXRlKSkgewogICAgICB0ZW1wbGF0ZSA9IFRob3JheC5VdGlsLmdldFRlbXBsYXRlKHRlbXBsYXRlLCBmYWxzZSk7CiAgICB9CiAgICByZXR1cm4gbmV3IEhhbmRsZWJhcnMuU2FmZVN0cmluZyh0ZW1wbGF0ZSh0aGlzLCBvcHRpb25zKSk7CiAgfSBlbHNlIHsKICAgIHJldHVybiAnJzsKICB9Cn0pOwoKOzsKLypnbG9iYWwgY29sbGVjdGlvbk9wdGlvbk5hbWVzLCBpbmhlcml0VmFycyAqLwoKdmFyIGxvYWRTdGFydCA9ICdsb2FkOnN0YXJ0JywKICAgIGxvYWRFbmQgPSAnbG9hZDplbmQnLAogICAgcm9vdE9iamVjdDsKClRob3JheC5zZXRSb290T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgcm9vdE9iamVjdCA9IG9iajsKfTsKClRob3JheC5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKHN0YXJ0LCBlbmQsIGNvbnRleHQpIHsKICB2YXIgbG9hZENvdW50ZXIgPSBfLnVuaXF1ZUlkKCk7CiAgcmV0dXJuIGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgdmFyIHNlbGYgPSBjb250ZXh0IHx8IHRoaXM7CiAgICBzZWxmLl9sb2FkSW5mbyA9IHNlbGYuX2xvYWRJbmZvIHx8IFtdOwogICAgdmFyIGxvYWRJbmZvID0gc2VsZi5fbG9hZEluZm9bbG9hZENvdW50ZXJdOwoKICAgIGZ1bmN0aW9uIHN0YXJ0TG9hZFRpbWVvdXQoKSB7CgogICAgICAvLyBJZiB0aGUgdGltZW91dCBoYXMgYmVlbiBzZXQgYWxyZWFkeSBidXQgaGFzIG5vdCB0cmlnZ2VyZWQgeWV0IGRvIG5vdGhpbmcKICAgICAgLy8gT3RoZXJ3aXNlIHNldCBhIG5ldyB0aW1lb3V0IChlaXRoZXIgaW5pdGlhbCBvciBmb3IgZ29pbmcgZnJvbSBiYWNrZ3JvdW5kIHRvCiAgICAgIC8vIG5vbi1iYWNrZ3JvdW5kIGxvYWRpbmcpCiAgICAgIGlmIChsb2FkSW5mby50aW1lb3V0ICYmICFsb2FkSW5mby5ydW4pIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KCiAgICAgIHZhciBsb2FkaW5nVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RHVyYXRpb24gIT09IHVuZGVmaW5lZCA/CiAgICAgICAgc2VsZi5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbiA6IFRob3JheC5WaWV3LnByb3RvdHlwZS5fbG9hZGluZ1RpbWVvdXREdXJhdGlvbjsKICAgICAgbG9hZEluZm8udGltZW91dCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBsb2FkSW5mby5ydW4gPSB0cnVlOwogICAgICAgICAgICBzdGFydC5jYWxsKHNlbGYsIGxvYWRJbmZvLm1lc3NhZ2UsIGxvYWRJbmZvLmJhY2tncm91bmQsIGxvYWRJbmZvKTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkU3RhcnQnLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9LCBsb2FkaW5nVGltZW91dCAqIDEwMDApOwogICAgfQoKICAgIGlmICghbG9hZEluZm8pIHsKICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSBfLmV4dGVuZCh7CiAgICAgICAgZXZlbnRzOiBbXSwKICAgICAgICB0aW1lb3V0OiAwLAogICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgYmFja2dyb3VuZDogISFiYWNrZ3JvdW5kCiAgICAgIH0sIEJhY2tib25lLkV2ZW50cyk7CiAgICAgIHN0YXJ0TG9hZFRpbWVvdXQoKTsKICAgIH0gZWxzZSB7CiAgICAgIGNsZWFyVGltZW91dChsb2FkSW5mby5lbmRUaW1lb3V0KTsKCiAgICAgIGxvYWRJbmZvLm1lc3NhZ2UgPSBtZXNzYWdlOwogICAgICBpZiAoIWJhY2tncm91bmQgJiYgbG9hZEluZm8uYmFja2dyb3VuZCkgewogICAgICAgIGxvYWRJbmZvLmJhY2tncm91bmQgPSBmYWxzZTsKICAgICAgICBzdGFydExvYWRUaW1lb3V0KCk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBQcmV2ZW50IGJpbmRzIHRvIHRoZSBzYW1lIG9iamVjdCBtdWx0aXBsZSB0aW1lcyBhcyB0aGlzIGNhbiBjYXVzZSB2ZXJ5IGJhZCB0aGluZ3MKICAgIC8vIHRvIGhhcHBlbiBmb3IgdGhlIGxvYWQ7bG9hZDtlbmQ7ZW5kIGV4ZWN1dGlvbiBmbG93LgogICAgaWYgKGxvYWRJbmZvLmV2ZW50cy5pbmRleE9mKG9iamVjdCkgPj0gMCkgewogICAgICBsb2FkSW5mby5ldmVudHMucHVzaChvYmplY3QpOwogICAgICByZXR1cm47CiAgICB9CgogICAgbG9hZEluZm8uZXZlbnRzLnB1c2gob2JqZWN0KTsKCiAgICBvYmplY3Qub24obG9hZEVuZCwgZnVuY3Rpb24gZW5kQ2FsbGJhY2soKSB7CiAgICAgIHZhciBsb2FkaW5nRW5kVGltZW91dCA9IHNlbGYuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIGlmIChsb2FkaW5nRW5kVGltZW91dCA9PT0gdm9pZCAwKSB7CiAgICAgICAgLy8gSWYgd2UgYXJlIHJ1bm5pbmcgb24gYSBub24tdmlldyBvYmplY3QgcHVsbCB0aGUgZGVmYXVsdCB0aW1lb3V0CiAgICAgICAgbG9hZGluZ0VuZFRpbWVvdXQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb247CiAgICAgIH0KCiAgICAgIHZhciBldmVudHMgPSBsb2FkSW5mby5ldmVudHMsCiAgICAgICAgICBpbmRleCA9IGV2ZW50cy5pbmRleE9mKG9iamVjdCk7CiAgICAgIGlmIChpbmRleCA+PSAwKSB7CiAgICAgICAgZXZlbnRzLnNwbGljZShpbmRleCwgMSk7CgogICAgICAgIGlmIChldmVudHMuaW5kZXhPZihvYmplY3QpIDwgMCkgewogICAgICAgICAgLy8gTGFzdCBjYWxsYmFjayBmb3IgdGhpcyBwYXJ0aWNsYXIgb2JqZWN0LCByZW1vdmUgdGhlIGJpbmQKICAgICAgICAgIG9iamVjdC5vZmYobG9hZEVuZCwgZW5kQ2FsbGJhY2spOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KGxvYWRJbmZvLmVuZFRpbWVvdXQpOwogICAgICAgIGxvYWRJbmZvLmVuZFRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKCFldmVudHMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgdmFyIHJ1biA9IGxvYWRJbmZvLnJ1bjsKCiAgICAgICAgICAgICAgaWYgKHJ1bikgewogICAgICAgICAgICAgICAgLy8gRW1pdCB0aGUgZW5kIGJlaGF2aW9yLCBidXQgb25seSBpZiB0aGVyZSBpcyBhIHBhaXJlZCBzdGFydAogICAgICAgICAgICAgICAgZW5kLmNhbGwoc2VsZiwgbG9hZEluZm8uYmFja2dyb3VuZCwgbG9hZEluZm8pOwogICAgICAgICAgICAgICAgbG9hZEluZm8udHJpZ2dlcihsb2FkRW5kLCBsb2FkSW5mbyk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBJZiBzdG9wcGluZyBtYWtlIHN1cmUgd2UgZG9uJ3QgcnVuIGEgc3RhcnQKICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobG9hZEluZm8udGltZW91dCk7CiAgICAgICAgICAgICAgbG9hZEluZm8gPSBzZWxmLl9sb2FkSW5mb1tsb2FkQ291bnRlcl0gPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgVGhvcmF4Lm9uRXhjZXB0aW9uKCdsb2FkRW5kJywgZSk7CiAgICAgICAgICB9CiAgICAgICAgfSwgbG9hZGluZ0VuZFRpbWVvdXQgKiAxMDAwKTsKICAgICAgfQogICAgfSk7CiAgfTsKfTsKCi8qKgogKiBIZWxwZXIgbWV0aG9kIGZvciBwcm9wYWdhdGluZyBsb2FkOnN0YXJ0IGV2ZW50cyB0byBvdGhlciBvYmplY3RzLgogKgogKiBGb3J3YXJkcyBsb2FkOnN0YXJ0IGV2ZW50cyB0aGF0IG9jY3VyIG9uIGBzb3VyY2VgIHRvIGBkZXN0YC4KICovClRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyA9IGZ1bmN0aW9uKHNvdXJjZSwgZGVzdCwgb25jZSkgewogIGZ1bmN0aW9uIGxvYWQobWVzc2FnZSwgYmFja2dvdW5kLCBvYmplY3QpIHsKICAgIGlmIChvbmNlKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICAgIGRlc3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tnb3VuZCwgb2JqZWN0KTsKICB9CiAgc291cmNlLm9uKGxvYWRTdGFydCwgbG9hZCk7CiAgcmV0dXJuIHsKICAgIG9mZjogZnVuY3Rpb24oKSB7CiAgICAgIHNvdXJjZS5vZmYobG9hZFN0YXJ0LCBsb2FkKTsKICAgIH0KICB9Owp9OwoKLy8KLy8gRGF0YSBsb2FkIGV2ZW50IGdlbmVyYXRpb24KLy8KCi8qKgogKiBNaXhpbmcgZm9yIGdlbmVyYXRpbmcgbG9hZDpzdGFydCBhbmQgbG9hZDplbmQgZXZlbnRzLgogKi8KVGhvcmF4Lm1peGluTG9hZGFibGUgPSBmdW5jdGlvbih0YXJnZXQsIHVzZVBhcmVudCkgewogIF8uZXh0ZW5kKHRhcmdldCwgewogICAgLy9sb2FkaW5nIGNvbmZpZwogICAgX2xvYWRpbmdDbGFzc05hbWU6ICdsb2FkaW5nJywKICAgIF9sb2FkaW5nVGltZW91dER1cmF0aW9uOiAwLjMzLAogICAgX2xvYWRpbmdUaW1lb3V0RW5kRHVyYXRpb246IDAuMTAsCgogICAgLy8gUHJvcGFnYXRlcyBsb2FkaW5nIHZpZXcgcGFyYW1ldGVycyB0byB0aGUgQUpBWCBsYXllcgogICAgb25Mb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKCiAgICAgIC8vIFByb3RlY3QgYWdhaW5zdCByYWNlIGNvbmRpdGlvbnMKICAgICAgaWYgKCF0aGF0IHx8ICF0aGF0LmVsKSB7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBpZiAoIXRoYXQubm9uQmxvY2tpbmdMb2FkICYmICFiYWNrZ3JvdW5kICYmIHJvb3RPYmplY3QgJiYgcm9vdE9iamVjdCAhPT0gdGhpcykgewogICAgICAgIHJvb3RPYmplY3QudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCk7CiAgICAgIH0KICAgICAgdGhhdC5faXNMb2FkaW5nID0gdHJ1ZTsKICAgICAgJCh0aGF0LmVsKS5hZGRDbGFzcyh0aGF0Ll9sb2FkaW5nQ2xhc3NOYW1lKTsKICAgICAgLy8gdXNlZCBieSBsb2FkaW5nIGhlbHBlcnMKICAgICAgdGhhdC50cmlnZ2VyKCdjaGFuZ2U6bG9hZC1zdGF0ZScsICdzdGFydCcpOwogICAgfSwKICAgIG9uTG9hZEVuZDogZnVuY3Rpb24oLyogYmFja2dyb3VuZCwgb2JqZWN0ICovKSB7CiAgICAgIHZhciB0aGF0ID0gdXNlUGFyZW50ID8gdGhpcy5wYXJlbnQgOiB0aGlzOwoKICAgICAgLy8gUHJvdGVjdCBhZ2FpbnN0IHJhY2UgY29uZGl0aW9ucwogICAgICBpZiAoIXRoYXQgfHwgIXRoYXQuZWwpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgCiAgICAgIHRoYXQuX2lzTG9hZGluZyA9IGZhbHNlOwogICAgICAkKHRoYXQuZWwpLnJlbW92ZUNsYXNzKHRoYXQuX2xvYWRpbmdDbGFzc05hbWUpOwogICAgICAvLyB1c2VkIGJ5IGxvYWRpbmcgaGVscGVyCiAgICAgIHRoYXQudHJpZ2dlcignY2hhbmdlOmxvYWQtc3RhdGUnLCAnZW5kJyk7CiAgICB9CiAgfSk7Cn07CgpUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyA9IGZ1bmN0aW9uKHRhcmdldCwgdXNlUGFyZW50KSB7CiAgXy5leHRlbmQodGFyZ2V0LCB7CiAgICBsb2FkU3RhcnQ6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQpIHsKICAgICAgdmFyIHRoYXQgPSB1c2VQYXJlbnQgPyB0aGlzLnBhcmVudCA6IHRoaXM7CiAgICAgIHRoYXQudHJpZ2dlcihsb2FkU3RhcnQsIG1lc3NhZ2UsIGJhY2tncm91bmQsIHRoYXQpOwogICAgfSwKICAgIGxvYWRFbmQ6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGhhdCA9IHVzZVBhcmVudCA/IHRoaXMucGFyZW50IDogdGhpczsKICAgICAgdGhhdC50cmlnZ2VyKGxvYWRFbmQsIHRoYXQpOwogICAgfQogIH0pOwp9OwoKVGhvcmF4Lm1peGluTG9hZGFibGUoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKVGhvcmF4Lm1peGluTG9hZGFibGVFdmVudHMoVGhvcmF4LlZpZXcucHJvdG90eXBlKTsKCgppZiAoVGhvcmF4LkhlbHBlclZpZXcpIHsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUsIHRydWUpOwogIFRob3JheC5taXhpbkxvYWRhYmxlRXZlbnRzKFRob3JheC5IZWxwZXJWaWV3LnByb3RvdHlwZSwgdHJ1ZSk7Cn0KCmlmIChUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcpIHsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZShUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcucHJvdG90eXBlLCB0cnVlKTsKfQoKVGhvcmF4LnN5bmMgPSBmdW5jdGlvbihtZXRob2QsIGRhdGFPYmosIG9wdGlvbnMpIHsKICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgIGNvbXBsZXRlID0gb3B0aW9ucy5jb21wbGV0ZTsKCiAgb3B0aW9ucy5jb21wbGV0ZSA9IGZ1bmN0aW9uKCkgewogICAgc2VsZi5fcmVxdWVzdCA9IHVuZGVmaW5lZDsKICAgIHNlbGYuX2Fib3J0ZWQgPSBmYWxzZTsKCiAgICBjb21wbGV0ZSAmJiBjb21wbGV0ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogIH07CiAgdGhpcy5fcmVxdWVzdCA9IEJhY2tib25lLnN5bmMuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCiAgcmV0dXJuIHRoaXMuX3JlcXVlc3Q7Cn07CgpmdW5jdGlvbiBiaW5kVG9Sb3V0ZShjYWxsYmFjaywgZmFpbGJhY2spIHsKICB2YXIgZnJhZ21lbnQgPSBCYWNrYm9uZS5oaXN0b3J5LmdldEZyYWdtZW50KCksCiAgICAgIHJvdXRlQ2hhbmdlZCA9IGZhbHNlOwoKICBmdW5jdGlvbiByb3V0ZUhhbmRsZXIoKSB7CiAgICBpZiAoZnJhZ21lbnQgPT09IEJhY2tib25lLmhpc3RvcnkuZ2V0RnJhZ21lbnQoKSkgewogICAgICByZXR1cm47CiAgICB9CiAgICByb3V0ZUNoYW5nZWQgPSB0cnVlOwogICAgcmVzLmNhbmNlbCgpOwogICAgZmFpbGJhY2sgJiYgZmFpbGJhY2soKTsKICB9CgogIEJhY2tib25lLmhpc3Rvcnkub24oJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKCiAgZnVuY3Rpb24gZmluYWxpemVyKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKICAgIGlmICghcm91dGVDaGFuZ2VkKSB7CiAgICAgIGNhbGxiYWNrLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICB9CiAgfQoKICB2YXIgcmVzID0gXy5iaW5kKGZpbmFsaXplciwgdGhpcyk7CiAgcmVzLmNhbmNlbCA9IGZ1bmN0aW9uKCkgewogICAgQmFja2JvbmUuaGlzdG9yeS5vZmYoJ3JvdXRlJywgcm91dGVIYW5kbGVyKTsKICB9OwoKICByZXR1cm4gcmVzOwp9CgpmdW5jdGlvbiBsb2FkRGF0YShjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpIHsKICBpZiAodGhpcy5pc1BvcHVsYXRlZCgpKSB7CiAgICByZXR1cm4gY2FsbGJhY2sodGhpcyk7CiAgfQoKICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiAhXy5pc0Z1bmN0aW9uKGZhaWxiYWNrKSAmJiBfLmlzT2JqZWN0KGZhaWxiYWNrKSkgewogICAgb3B0aW9ucyA9IGZhaWxiYWNrOwogICAgZmFpbGJhY2sgPSBmYWxzZTsKICB9CgogIHZhciBzZWxmID0gdGhpcywKICAgICAgcm91dGVDaGFuZ2VkID0gZmFsc2UsCiAgICAgIHN1Y2Nlc3NDYWxsYmFjayA9IGJpbmRUb1JvdXRlKF8uYmluZChjYWxsYmFjaywgc2VsZiksIGZ1bmN0aW9uKCkgewogICAgICAgIHJvdXRlQ2hhbmdlZCA9IHRydWU7CiAgICAgICAgaWYgKHNlbGYuX3JlcXVlc3QpIHsKICAgICAgICAgIHNlbGYuX2Fib3J0ZWQgPSB0cnVlOwogICAgICAgICAgc2VsZi5fcmVxdWVzdC5hYm9ydCgpOwogICAgICAgIH0KICAgICAgICBmYWlsYmFjayAmJiBmYWlsYmFjay5jYWxsKHNlbGYsIGZhbHNlKTsKICAgICAgfSk7CgogIHRoaXMuZmV0Y2goXy5kZWZhdWx0cyh7CiAgICBzdWNjZXNzOiBzdWNjZXNzQ2FsbGJhY2ssCiAgICBlcnJvcjogZmFpbGJhY2sgJiYgZnVuY3Rpb24oKSB7CiAgICAgIGlmICghcm91dGVDaGFuZ2VkKSB7CiAgICAgICAgZmFpbGJhY2suYXBwbHkoc2VsZiwgW3RydWVdLmNvbmNhdChfLnRvQXJyYXkoYXJndW1lbnRzKSkpOwogICAgICB9CiAgICB9LAogICAgY29tcGxldGU6IGZ1bmN0aW9uKCkgewogICAgICBzdWNjZXNzQ2FsbGJhY2suY2FuY2VsKCk7CiAgICB9CiAgfSwgb3B0aW9ucykpOwp9CgpmdW5jdGlvbiBmZXRjaFF1ZXVlKG9wdGlvbnMsICRzdXBlcikgewogIGlmIChvcHRpb25zLnJlc2V0UXVldWUpIHsKICAgIC8vIFdBUk46IFNob3VsZCBlbnN1cmUgdGhhdCBsb2FkZXJzIGFyZSBwcm90ZWN0ZWQgZnJvbSBvdXQgb2YgYmFuZCBkYXRhCiAgICAvLyAgICB3aGVuIHVzaW5nIHRoaXMgb3B0aW9uCiAgICB0aGlzLmZldGNoUXVldWUgPSB1bmRlZmluZWQ7CiAgfQoKICBpZiAoIXRoaXMuZmV0Y2hRdWV1ZSkgewogICAgLy8gS2ljayBvZmYgdGhlIHJlcXVlc3QKICAgIHRoaXMuZmV0Y2hRdWV1ZSA9IFtvcHRpb25zXTsKICAgIG9wdGlvbnMgPSBfLmRlZmF1bHRzKHsKICAgICAgc3VjY2VzczogZmx1c2hRdWV1ZSh0aGlzLCB0aGlzLmZldGNoUXVldWUsICdzdWNjZXNzJyksCiAgICAgIGVycm9yOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2Vycm9yJyksCiAgICAgIGNvbXBsZXRlOiBmbHVzaFF1ZXVlKHRoaXMsIHRoaXMuZmV0Y2hRdWV1ZSwgJ2NvbXBsZXRlJykKICAgIH0sIG9wdGlvbnMpOwogICAgJHN1cGVyLmNhbGwodGhpcywgb3B0aW9ucyk7CiAgfSBlbHNlIHsKICAgIC8vIEN1cnJlbnRseSBmZXRjaGluZy4gUXVldWUgYW5kIHByb2Nlc3Mgb25jZSBjb21wbGV0ZQogICAgdGhpcy5mZXRjaFF1ZXVlLnB1c2gob3B0aW9ucyk7CiAgfQp9CgpmdW5jdGlvbiBmbHVzaFF1ZXVlKHNlbGYsIGZldGNoUXVldWUsIGhhbmRsZXIpIHsKICByZXR1cm4gZnVuY3Rpb24oKSB7CiAgICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCiAgICAvLyBGbHVzaCB0aGUgcXVldWUuIEV4ZWN1dGVzIGFueSBjYWxsYmFjayBoYW5kbGVycyB0aGF0CiAgICAvLyBtYXkgaGF2ZSBiZWVuIHBhc3NlZCBpbiB0aGUgZmV0Y2ggb3B0aW9ucy4KICAgIF8uZWFjaChmZXRjaFF1ZXVlLCBmdW5jdGlvbihvcHRpb25zKSB7CiAgICAgIGlmIChvcHRpb25zW2hhbmRsZXJdKSB7CiAgICAgICAgb3B0aW9uc1toYW5kbGVyXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfSwgdGhpcyk7CgogICAgLy8gUmVzZXQgdGhlIHF1ZXVlIGlmIHdlIGFyZSBzdGlsbCB0aGUgYWN0aXZlIHJlcXVlc3QKICAgIGlmIChzZWxmLmZldGNoUXVldWUgPT09IGZldGNoUXVldWUpIHsKICAgICAgc2VsZi5mZXRjaFF1ZXVlID0gdW5kZWZpbmVkOwogICAgfQogIH07Cn0KCnZhciBrbGFzc2VzID0gW107ClRob3JheC5Nb2RlbCAmJiBrbGFzc2VzLnB1c2goVGhvcmF4Lk1vZGVsKTsKVGhvcmF4LkNvbGxlY3Rpb24gJiYga2xhc3Nlcy5wdXNoKFRob3JheC5Db2xsZWN0aW9uKTsKCl8uZWFjaChrbGFzc2VzLCBmdW5jdGlvbihEYXRhQ2xhc3MpIHsKICB2YXIgJGZldGNoID0gRGF0YUNsYXNzLnByb3RvdHlwZS5mZXRjaDsKICBUaG9yYXgubWl4aW5Mb2FkYWJsZUV2ZW50cyhEYXRhQ2xhc3MucHJvdG90eXBlLCBmYWxzZSk7CiAgXy5leHRlbmQoRGF0YUNsYXNzLnByb3RvdHlwZSwgewogICAgc3luYzogVGhvcmF4LnN5bmMsCgogICAgZmV0Y2g6IGZ1bmN0aW9uKG9wdGlvbnMpIHsKICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgogICAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAgICBjb21wbGV0ZSA9IG9wdGlvbnMuY29tcGxldGU7CgogICAgICBvcHRpb25zLmNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgY29tcGxldGUgJiYgY29tcGxldGUuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgICBzZWxmLmxvYWRFbmQoKTsKICAgICAgfTsKICAgICAgc2VsZi5sb2FkU3RhcnQodW5kZWZpbmVkLCBvcHRpb25zLmJhY2tncm91bmQpOwogICAgICByZXR1cm4gZmV0Y2hRdWV1ZS5jYWxsKHRoaXMsIG9wdGlvbnMgfHwge30sICRmZXRjaCk7CiAgICB9LAoKICAgIGxvYWQ6IGZ1bmN0aW9uKGNhbGxiYWNrLCBmYWlsYmFjaywgb3B0aW9ucykgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMiAmJiAhXy5pc0Z1bmN0aW9uKGZhaWxiYWNrKSkgewogICAgICAgIG9wdGlvbnMgPSBmYWlsYmFjazsKICAgICAgICBmYWlsYmFjayA9IGZhbHNlOwogICAgICB9CgogICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKICAgICAgaWYgKCFvcHRpb25zLmJhY2tncm91bmQgJiYgIXRoaXMuaXNQb3B1bGF0ZWQoKSAmJiByb290T2JqZWN0KSB7CiAgICAgICAgLy8gTWFrZSBzdXJlIHRoYXQgdGhlIGdsb2JhbCBzY29wZSBzZWVzIHRoZSBwcm9wZXIgbG9hZCBldmVudHMgaGVyZQogICAgICAgIC8vIGlmIHdlIGFyZSBsb2FkaW5nIGluIHN0YW5kYWxvbmUgbW9kZQogICAgICAgIFRob3JheC5mb3J3YXJkTG9hZEV2ZW50cyh0aGlzLCByb290T2JqZWN0LCB0cnVlKTsKICAgICAgfQoKICAgICAgbG9hZERhdGEuY2FsbCh0aGlzLCBjYWxsYmFjaywgZmFpbGJhY2ssIG9wdGlvbnMpOwogICAgfQogIH0pOwp9KTsKClRob3JheC5VdGlsLmJpbmRUb1JvdXRlID0gYmluZFRvUm91dGU7CgppZiAoVGhvcmF4LlJvdXRlcikgewogIFRob3JheC5Sb3V0ZXIuYmluZFRvUm91dGUgPSBUaG9yYXguUm91dGVyLnByb3RvdHlwZS5iaW5kVG9Sb3V0ZSA9IGJpbmRUb1JvdXRlOwp9CgovLyBQcm9wYWdhdGVzIGxvYWRpbmcgdmlldyBwYXJhbWV0ZXJzIHRvIHRoZSBBSkFYIGxheWVyClRob3JheC5WaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLmlnbm9yZUZldGNoRXJyb3I7CiAgb3B0aW9ucy5iYWNrZ3JvdW5kID0gdGhpcy5ub25CbG9ja2luZ0xvYWQ7CiAgcmV0dXJuIG9wdGlvbnM7Cn07CgovLyBUaG9yYXguQ29sbGVjdGlvbkhlbHBlclZpZXcgaW5oZXJpdHMgZnJvbSBDb2xsZWN0aW9uVmlldwovLyBub3QgSGVscGVyVmlldyBzbyBuZWVkIHRvIHNldCBpdCBtYW51YWxseQpUaG9yYXguSGVscGVyVmlldy5wcm90b3R5cGUuX21vZGlmeURhdGFPYmplY3RPcHRpb25zID0gVGhvcmF4LkNvbGxlY3Rpb25IZWxwZXJWaWV3LnByb3RvdHlwZS5fbW9kaWZ5RGF0YU9iamVjdE9wdGlvbnMgPSBmdW5jdGlvbihkYXRhT2JqZWN0LCBvcHRpb25zKSB7CiAgb3B0aW9ucy5pZ25vcmVFcnJvcnMgPSB0aGlzLnBhcmVudC5pZ25vcmVGZXRjaEVycm9yOwogIG9wdGlvbnMuYmFja2dyb3VuZCA9IHRoaXMucGFyZW50Lm5vbkJsb2NraW5nTG9hZDsKICByZXR1cm4gb3B0aW9uczsKfTsKCmluaGVyaXRWYXJzLmNvbGxlY3Rpb24ubG9hZGluZyA9IGZ1bmN0aW9uKCkgewogIHZhciBsb2FkaW5nVmlldyA9IHRoaXMubG9hZGluZ1ZpZXcsCiAgICAgIGxvYWRpbmdUZW1wbGF0ZSA9IHRoaXMubG9hZGluZ1RlbXBsYXRlLAogICAgICBsb2FkaW5nUGxhY2VtZW50ID0gdGhpcy5sb2FkaW5nUGxhY2VtZW50OwogIC8vYWRkICJsb2FkaW5nLXZpZXciIGFuZCAibG9hZGluZy10ZW1wbGF0ZSIgb3B0aW9ucyB0byBjb2xsZWN0aW9uIGhlbHBlcgogIGlmIChsb2FkaW5nVmlldyB8fCBsb2FkaW5nVGVtcGxhdGUpIHsKICAgIHZhciBjYWxsYmFjayA9IFRob3JheC5sb2FkSGFuZGxlcihfLmJpbmQoZnVuY3Rpb24oKSB7CiAgICAgIHZhciBpdGVtOwogICAgICBpZiAodGhpcy5jb2xsZWN0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICAgIHRoaXMuJGVsLmVtcHR5KCk7CiAgICAgIH0KICAgICAgaWYgKGxvYWRpbmdWaWV3KSB7CiAgICAgICAgdmFyIGluc3RhbmNlID0gVGhvcmF4LlV0aWwuZ2V0Vmlld0luc3RhbmNlKGxvYWRpbmdWaWV3KTsKICAgICAgICB0aGlzLl9hZGRDaGlsZChpbnN0YW5jZSk7CiAgICAgICAgaWYgKGxvYWRpbmdUZW1wbGF0ZSkgewogICAgICAgICAgaW5zdGFuY2UucmVuZGVyKGxvYWRpbmdUZW1wbGF0ZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGluc3RhbmNlLnJlbmRlcigpOwogICAgICAgIH0KICAgICAgICBpdGVtID0gaW5zdGFuY2U7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaXRlbSA9IHRoaXMucmVuZGVyVGVtcGxhdGUobG9hZGluZ1RlbXBsYXRlKTsKICAgICAgfQogICAgICB2YXIgaW5kZXggPSBsb2FkaW5nUGxhY2VtZW50CiAgICAgICAgPyBsb2FkaW5nUGxhY2VtZW50LmNhbGwodGhpcykKICAgICAgICA6IHRoaXMuY29sbGVjdGlvbi5sZW5ndGgKICAgICAgOwogICAgICB0aGlzLmFwcGVuZEl0ZW0oaXRlbSwgaW5kZXgpOwogICAgICB0aGlzLiRlbC5jaGlsZHJlbigpLmVxKGluZGV4KS5hdHRyKCdkYXRhLWxvYWRpbmctZWxlbWVudCcsIHRoaXMuY29sbGVjdGlvbi5jaWQpOwogICAgfSwgdGhpcyksIF8uYmluZChmdW5jdGlvbigpIHsKICAgICAgdGhpcy4kZWwuZmluZCgnW2RhdGEtbG9hZGluZy1lbGVtZW50PSInICsgdGhpcy5jb2xsZWN0aW9uLmNpZCArICciXScpLnJlbW92ZSgpOwogICAgfSwgdGhpcyksCiAgICB0aGlzLmNvbGxlY3Rpb24pOwoKICAgIHRoaXMubGlzdGVuVG8odGhpcy5jb2xsZWN0aW9uLCAnbG9hZDpzdGFydCcsIGNhbGxiYWNrKTsKICB9Cn07CgppZiAoY29sbGVjdGlvbk9wdGlvbk5hbWVzKSB7CiAgY29sbGVjdGlvbk9wdGlvbk5hbWVzWydsb2FkaW5nLXRlbXBsYXRlJ10gPSAnbG9hZGluZ1RlbXBsYXRlJzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctdmlldyddID0gJ2xvYWRpbmdWaWV3JzsKICBjb2xsZWN0aW9uT3B0aW9uTmFtZXNbJ2xvYWRpbmctcGxhY2VtZW50J10gPSAnbG9hZGluZ1BsYWNlbWVudCc7Cn0KClRob3JheC5WaWV3Lm9uKHsKICAnbG9hZDpzdGFydCc6IFRob3JheC5sb2FkSGFuZGxlcigKICAgICAgZnVuY3Rpb24obWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KSB7CiAgICAgICAgdGhpcy5vbkxvYWRTdGFydChtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgICB9LAogICAgICBmdW5jdGlvbihiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgICB0aGlzLm9uTG9hZEVuZChvYmplY3QpOwogICAgICB9KSwKCiAgY29sbGVjdGlvbjogewogICAgJ2xvYWQ6c3RhcnQnOiBmdW5jdGlvbihtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpIHsKICAgICAgdGhpcy50cmlnZ2VyKGxvYWRTdGFydCwgbWVzc2FnZSwgYmFja2dyb3VuZCwgb2JqZWN0KTsKICAgIH0KICB9LAogIG1vZGVsOiB7CiAgICAnbG9hZDpzdGFydCc6IGZ1bmN0aW9uKG1lc3NhZ2UsIGJhY2tncm91bmQsIG9iamVjdCkgewogICAgICB0aGlzLnRyaWdnZXIobG9hZFN0YXJ0LCBtZXNzYWdlLCBiYWNrZ3JvdW5kLCBvYmplY3QpOwogICAgfQogIH0KfSk7Cgo7OwpIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2FkaW5nJywgZnVuY3Rpb24ob3B0aW9ucykgewogIHZhciB2aWV3ID0gZ2V0T3B0aW9uc0RhdGEob3B0aW9ucykudmlldzsKICB2aWV3Lm9mZignY2hhbmdlOmxvYWQtc3RhdGUnLCBvbkxvYWRTdGF0ZUNoYW5nZSwgdmlldyk7CiAgdmlldy5vbignY2hhbmdlOmxvYWQtc3RhdGUnLCBvbkxvYWRTdGF0ZUNoYW5nZSwgdmlldyk7CiAgcmV0dXJuIHZpZXcuX2lzTG9hZGluZyA/IG9wdGlvbnMuZm4odGhpcykgOiBvcHRpb25zLmludmVyc2UodGhpcyk7Cn0pOwoKZnVuY3Rpb24gb25Mb2FkU3RhdGVDaGFuZ2UoKSB7CiAgdGhpcy5yZW5kZXIoKTsKfQo7OwovKmdsb2JhbCBwdXNoRG9tRXZlbnRzICovCnZhciBpc2lPUyA9IG5hdmlnYXRvci51c2VyQWdlbnQubWF0Y2goLyhpUGhvbmV8aVBvZHxpUGFkKS9pKSwKICAgIGlzQW5kcm9pZCA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmRleE9mKCJhbmRyb2lkIikgPiAtMSA/IDEgOiAwLAogICAgbWluaW11bVNjcm9sbFlPZmZzZXQgPSBpc0FuZHJvaWQgPyAxIDogMDsKClRob3JheC5VdGlsLnNjcm9sbFRvID0gZnVuY3Rpb24oeCwgeSkgewogIHkgPSB5IHx8IG1pbmltdW1TY3JvbGxZT2Zmc2V0OwogIGZ1bmN0aW9uIF9zY3JvbGxUbygpIHsKICAgIHdpbmRvdy5zY3JvbGxUbyh4LCB5KTsKICB9CiAgaWYgKGlzaU9TKSB7CiAgICAvLyBhIGRlZmVyIGlzIHJlcXVpcmVkIGZvciBpb3MKICAgIF8uZGVmZXIoX3Njcm9sbFRvKTsKICB9IGVsc2UgewogICAgX3Njcm9sbFRvKCk7CiAgfQogIHJldHVybiBbeCwgeV07Cn07CgpUaG9yYXguTGF5b3V0Vmlldy5vbignY2hhbmdlOnZpZXc6ZW5kJywgZnVuY3Rpb24obmV3Vmlldywgb2xkVmlldywgb3B0aW9ucykgewogIG9wdGlvbnMuc2Nyb2xsICYmIFRob3JheC5VdGlsLnNjcm9sbFRvKDAsIDApOwp9KTsKClRob3JheC5VdGlsLnNjcm9sbFRvVG9wID0gZnVuY3Rpb24oKSB7CiAgLy8gYW5kcm9pZCB3aWxsIHVzZSBoZWlnaHQgb2YgMSBiZWNhdXNlIG9mIG1pbmltdW1TY3JvbGxZT2Zmc2V0IGluIHNjcm9sbFRvKCkKICByZXR1cm4gdGhpcy5zY3JvbGxUbygwLCAwKTsKfTsKCnB1c2hEb21FdmVudHMoWwogICdzaW5nbGVUYXAnLCAnZG91YmxlVGFwJywgJ2xvbmdUYXAnLAogICdzd2lwZScsCiAgJ3N3aXBlVXAnLCAnc3dpcGVEb3duJywKICAnc3dpcGVMZWZ0JywgJ3N3aXBlUmlnaHQnCl0pOwoKLy9idWlsdCBpbiBkb20gZXZlbnRzClRob3JheC5WaWV3Lm9uKHsKICAnc3VibWl0IGZvcm0nOiBmdW5jdGlvbigvKiBldmVudCAqLykgewogICAgLy8gSGlkZSBhbnkgdmlydHVhbCBrZXlib2FyZHMgdGhhdCBtYXkgYmUgbGluZ2VyaW5nIGFyb3VuZAogICAgdmFyIGZvY3VzZWQgPSAkKCc6Zm9jdXMnKVswXTsKICAgIGZvY3VzZWQgJiYgZm9jdXNlZC5ibHVyKCk7CiAgfQp9KTsKCjs7Ci8qZ2xvYmFsIGlzQW5kcm9pZCAqLwoKJC5mbi50YXBIb2xkQW5kRW5kID0gZnVuY3Rpb24oc2VsZWN0b3IsIGNhbGxiYWNrU3RhcnQsIGNhbGxiYWNrRW5kKSB7CiAgZnVuY3Rpb24gdHJpZ2dlckV2ZW50KG9iaiwgZXZlbnRUeXBlLCBjYWxsYmFjaywgZXZlbnQpIHsKICAgIHZhciBvcmlnaW5hbFR5cGUgPSBldmVudC50eXBlLAogICAgICAgIHJlc3VsdDsKCiAgICBldmVudC50eXBlID0gZXZlbnRUeXBlOwogICAgaWYgKGNhbGxiYWNrKSB7CiAgICAgIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwob2JqLCBldmVudCk7CiAgICB9CiAgICBldmVudC50eXBlID0gb3JpZ2luYWxUeXBlOwogICAgcmV0dXJuIHJlc3VsdDsKICB9CgogIHZhciB0aW1lcnMgPSBbXTsKICByZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewogICAgdmFyIHRoaXNPYmplY3QgPSB0aGlzLAogICAgICAgIHRhcEhvbGRTdGFydCA9IGZhbHNlLAogICAgICAgICR0aGlzID0gJCh0aGlzT2JqZWN0KTsKCiAgICAkdGhpcy5vbigndG91Y2hzdGFydCcsIHNlbGVjdG9yLCBmdW5jdGlvbihldmVudCkgewogICAgICB0YXBIb2xkU3RhcnQgPSBmYWxzZTsKICAgICAgdmFyIG9yaWdFdmVudCA9IGV2ZW50LAogICAgICAgICAgdGltZXI7CgogICAgICBmdW5jdGlvbiBjbGVhclRhcFRpbWVyKGV2ZW50KSB7CiAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTsKCiAgICAgICAgaWYgKHRhcEhvbGRTdGFydCkgewogICAgICAgICAgdmFyIHJldHZhbCA9IGZhbHNlOwogICAgICAgICAgaWYgKGV2ZW50KSB7CiAgICAgICAgICAgIC8vIFdlIGFyZW4ndCBzZW5kaW5nIGFueSBlbmQgZXZlbnRzIGZvciB0b3VjaGNhbmNlbCBjYXNlcywKICAgICAgICAgICAgLy8gcHJldmVudCBhbiBleGNlcHRpb24KICAgICAgICAgICAgcmV0dmFsID0gdHJpZ2dlckV2ZW50KHRoaXNPYmplY3QsICd0YXBIb2xkRW5kJywgY2FsbGJhY2tFbmQsIGV2ZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChyZXR2YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIF8uZWFjaCh0aW1lcnMsIGNsZWFyVGltZW91dCk7CiAgICAgICAgICAgIHRpbWVycyA9IFtdOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgJChkb2N1bWVudCkub25lKCd0b3VjaGNhbmNlbCcsIGZ1bmN0aW9uKCkgewogICAgICAgIGNsZWFyVGFwVGltZXIoKTsKCiAgICAgICAgJHRoaXMub2ZmKCd0b3VjaG1vdmUnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgICAgJHRoaXMub2ZmKCd0b3VjaGVuZCcsIHNlbGVjdG9yLCBjbGVhclRhcFRpbWVyKTsKICAgICAgfSk7CgogICAgICAkdGhpcy5vbigndG91Y2hlbmQnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CiAgICAgICR0aGlzLm9uKCd0b3VjaG1vdmUnLCBzZWxlY3RvciwgY2xlYXJUYXBUaW1lcik7CgogICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgdGFwSG9sZFN0YXJ0ID0gdHJ1ZTsKICAgICAgICB2YXIgcmV0dmFsID0gdHJpZ2dlckV2ZW50KHRoaXNPYmplY3QsICd0YXBIb2xkU3RhcnQnLCBjYWxsYmFja1N0YXJ0LCBvcmlnRXZlbnQpOwogICAgICAgIGlmIChyZXR2YWwgPT09IGZhbHNlKSB7CiAgICAgICAgICBfLmVhY2godGltZXJzLCBjbGVhclRpbWVvdXQpOwogICAgICAgICAgdGltZXJzID0gW107CiAgICAgICAgfQogICAgICB9LCAxNTApOwogICAgICB0aW1lcnMucHVzaCh0aW1lcik7CiAgICB9KTsKICB9KTsKfTsKCi8vb25seSBlbmFibGUgb24gYW5kcm9pZAp2YXIgdXNlTmF0aXZlSGlnaGxpZ2h0ID0gIWlzQW5kcm9pZDsKVGhvcmF4LmNvbmZpZ3VyZVRhcEhpZ2hsaWdodCA9IGZ1bmN0aW9uKHVzZU5hdGl2ZSkgewogIHVzZU5hdGl2ZUhpZ2hsaWdodCA9IHVzZU5hdGl2ZTsKfTsKCnZhciBOQVRJVkVfVEFQUEFCTEUgPSB7CiAgJ0EnOiB0cnVlLAogICdJTlBVVCc6IHRydWUsCiAgJ0JVVFRPTic6IHRydWUsCiAgJ1NFTEVDVCc6IHRydWUsCiAgJ1RFWFRBUkVBJzogdHJ1ZQp9OwoKZnVuY3Rpb24gZml4dXBUYXBIaWdobGlnaHQoc2NvcGUpIHsKICBfLmVhY2godGhpcy5fZG9tRXZlbnRzIHx8IFtdLCBmdW5jdGlvbihiaW5kKSB7CiAgICB2YXIgY29tcG9uZW50cyA9IGJpbmQuc3BsaXQoJyAnKSwKICAgICAgICBzZWxlY3RvciA9IGNvbXBvbmVudHMuc2xpY2UoMSkuam9pbignICcpIHx8IHVuZGVmaW5lZDsgIC8vIE5lZWRlZCB0byBtYWtlIHplcHRvIGhhcHB5CgogICAgaWYgKGNvbXBvbmVudHNbMF0gPT09ICdjbGljaycpIHsKICAgICAgLy8gIXNlbGVjdG9yIGNhc2UgaXMgZm9yIHJvb3QgY2xpY2sgaGFuZGxlcnMgb24gdGhlIHZpZXcsIGkuZS4gJ2NsaWNrJwogICAgICAkKHNlbGVjdG9yIHx8IHRoaXMuZWwsIHNlbGVjdG9yICYmIChzY29wZSB8fCB0aGlzLmVsKSkuZm9yRWFjaChmdW5jdGlvbihlbCkgewogICAgICAgIHZhciAkZWwgPSAkKGVsKS5kYXRhKCd0YXBwYWJsZScsIHRydWUpOwoKICAgICAgICBpZiAodXNlTmF0aXZlSGlnaGxpZ2h0ICYmICFOQVRJVkVfVEFQUEFCTEVbZWwudGFnTmFtZV0pIHsKICAgICAgICAgIC8vIEFkZCBhbiBleHBsaWNpdCBOT1AgYmluZCB0byBhbGxvdyB0YXAtaGlnaGxpZ2h0IHN1cHBvcnQKICAgICAgICAgICRlbC5vbignY2xpY2snLCBmdW5jdGlvbigpIHt9KTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfQogIH0sIHRoaXMpOwp9CgpfLmV4dGVuZChUaG9yYXguVmlldy5wcm90b3R5cGUsIHsKICBfdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lOiAnYWN0aXZlJywKICBfdGFwSGlnaGxpZ2h0U3RhcnQ6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICB2YXIgdGFyZ2V0ID0gZXZlbnQuY3VycmVudFRhcmdldCwKICAgICAgICB0YWdOYW1lID0gdGFyZ2V0ICYmIHRhcmdldC50YWdOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgLy8gVXNlciBpbnB1dCBjb250cm9scyBtYXkgYmUgdmlzdWFsbHkgcGFydCBvZiBhIGxhcmdlciBncm91cC4gRm9yIHRoZXNlIGNhc2VzCiAgICAvLyB3ZSB3YW50IHRvIGdpdmUgcHJpb3JpdHkgdG8gYW55IHBhcmVudCB0aGF0IG1heSBwcm92aWRlIGEgZm9jdXMgb3BlcmF0aW9uLgogICAgaWYgKHRhZ05hbWUgPT09ICdpbnB1dCcgfHwgdGFnTmFtZSA9PT0gJ3NlbGVjdCcgfHwgdGFnTmFtZSA9PT0gJ3RleHRhcmVhJykgewogICAgICB0YXJnZXQgPSAkKHRhcmdldCkuY2xvc2VzdCgnW2RhdGEtdGFwcGFibGU9dHJ1ZV0nKVswXSB8fCB0YXJnZXQ7CiAgICB9CgogICAgaWYgKHRhcmdldCkgewogICAgICAkKHRhcmdldCkuYWRkQ2xhc3ModGhpcy5fdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lKTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogIH0sCiAgX3RhcEhpZ2hsaWdodEVuZDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKICAgICQoJy4nICsgdGhpcy5fdGFwSGlnaGxpZ2h0Q2xhc3NOYW1lKS5yZW1vdmVDbGFzcyh0aGlzLl90YXBIaWdobGlnaHRDbGFzc05hbWUpOwogIH0KfSk7CgovL1RPRE86IGV4YW1pbmUgaWYgdGhlc2UgYXJlIHN0aWxsIG5lZWRlZAp2YXIgZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjayA9IGZ1bmN0aW9uKCkgewogIGZpeHVwVGFwSGlnaGxpZ2h0LmNhbGwodGhpcyk7Cn07CgpUaG9yYXguVmlldy5vbih7CiAgJ3JlbmRlcmVkJzogZml4dXBUYXBIaWdobGlnaHRDYWxsYmFjaywKICAncmVuZGVyZWQ6Y29sbGVjdGlvbic6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2ssCiAgJ3JlbmRlcmVkOml0ZW0nOiBmaXh1cFRhcEhpZ2hsaWdodENhbGxiYWNrLAogICdyZW5kZXJlZDplbXB0eSc6IGZpeHVwVGFwSGlnaGxpZ2h0Q2FsbGJhY2sKfSk7Cgp2YXIgX3NldEVsZW1lbnQgPSBUaG9yYXguVmlldy5wcm90b3R5cGUuc2V0RWxlbWVudCwKICAgIHRhcEhpZ2hsaWdodFNlbGVjdG9yID0gJ1tkYXRhLXRhcHBhYmxlPXRydWVdLCBhLCBpbnB1dCwgYnV0dG9uLCBzZWxlY3QsIHRleHRhcmVhJzsKClRob3JheC5WaWV3LnByb3RvdHlwZS5zZXRFbGVtZW50ID0gZnVuY3Rpb24oKSB7CiAgdmFyIHJlc3BvbnNlID0gX3NldEVsZW1lbnQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICBpZiAoIXRoaXMubm9UYXBIaWdobGlnaHQpIHsKICAgIGlmICghdXNlTmF0aXZlSGlnaGxpZ2h0KSB7CiAgICAgIHZhciBzZWxmID0gdGhpczsKICAgICAgZnVuY3Rpb24gZXhlYyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKCkgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgc2VsZltuYW1lXS5hcHBseShzZWxmLCBhcmd1bWVudHMpOwogICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgIFRob3JheC5vbkV4Y2VwdGlvbihuYW1lLCBlKTsKICAgICAgICAgIH0KICAgICAgICB9OwogICAgICB9CiAgICAgIHRoaXMuJGVsLnRhcEhvbGRBbmRFbmQodGFwSGlnaGxpZ2h0U2VsZWN0b3IsIGV4ZWMoJ190YXBIaWdobGlnaHRTdGFydCcpLCBleGVjKCdfdGFwSGlnaGxpZ2h0RW5kJykpOwogICAgfQogIH0KICByZXR1cm4gcmVzcG9uc2U7Cn07Cgp2YXIgX2FkZEV2ZW50ID0gVGhvcmF4LlZpZXcucHJvdG90eXBlLl9hZGRFdmVudDsKVGhvcmF4LlZpZXcucHJvdG90eXBlLl9hZGRFdmVudCA9IGZ1bmN0aW9uKHBhcmFtcykgewogIHRoaXMuX2RvbUV2ZW50cyA9IHRoaXMuX2RvbUV2ZW50cyB8fCBbXTsKICBpZiAocGFyYW1zLnR5cGUgPT09ICJET00iKSB7CiAgICB0aGlzLl9kb21FdmVudHMucHVzaChwYXJhbXMub3JpZ2luYWxOYW1lKTsKICB9CiAgcmV0dXJuIF9hZGRFdmVudC5jYWxsKHRoaXMsIHBhcmFtcyk7Cn07Cgo7OwoKCn0pKCk7CgovL0Agc291cmNlTWFwcGluZ1VSTD10aG9yYXgtbW9iaWxlLmpzLm1hcAoK",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sat, 08 Nov 2014 03:54:59 GMT",
                    "Content-Length": "294558",
                    "Date": "Sat, 08 Nov 2014 03:55:35 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}