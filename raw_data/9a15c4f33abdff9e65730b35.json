{
    "url": "http://localhost:9999/feedhenry/fh-js-sdk/src/appforms/tests/000-api-v2.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>window.location</b> and written to <b>the 'setAttribute()' function of a DOM element</b> via the following statements:<ul><li>var xir = (xiRedirectUrl) ? xiRedirectUrl : window.location;</li><li>this.setAttribute('xiRedirectUrl', xir);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/feedhenry/fh-js-sdk/src/appforms/tests/000-api-v2.js",
                "path": "/feedhenry/fh-js-sdk/src/appforms/tests/000-api-v2.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9mZWVkaGVucnkvZmgtanMtc2RrL3NyYy9hcHBmb3Jtcy90ZXN0cy8wMDAtYXBpLXYyLmpzIEhUVFAvMS4xDQpIb3N0OiBsb2NhbGhvc3Q6OTk5OQ0KDQo=",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNzgxNzkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDA6MTQ6MTUgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAwOjE0OjE0IEdNVA0KDQo7CihmdW5jdGlvbihyb290KSB7CgogICAgLy8hISFsaWIgc3RhcnQhISEKICAgIC8qCiAgICBqc29uMi5qcwogICAgMjAwOC0wMy0yNAoKICAgIFB1YmxpYyBEb21haW4uCgogICAgTk8gV0FSUkFOVFkgRVhQUkVTU0VEIE9SIElNUExJRUQuIFVTRSBBVCBZT1VSIE9XTiBSSVNLLgoKICAgIFNlZSBodHRwOi8vd3d3LkpTT04ub3JnL2pzLmh0bWwKCiAgICBUaGlzIGZpbGUgY3JlYXRlcyBhIGdsb2JhbCBKU09OIG9iamVjdCBjb250YWluaW5nIHRocmVlIG1ldGhvZHM6IHN0cmluZ2lmeSwKICAgIHBhcnNlLCBhbmQgcXVvdGUuCgoKICAgICAgICBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgcmVwbGFjZXIsIHNwYWNlKQogICAgICAgICAgICB2YWx1ZSAgICAgICBhbnkgSmF2YVNjcmlwdCB2YWx1ZSwgdXN1YWxseSBhbiBvYmplY3Qgb3IgYXJyYXkuCgogICAgICAgICAgICByZXBsYWNlciAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBkZXRlcm1pbmVzIGhvdyBvYmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWVzIGFyZSBzdHJpbmdpZmllZCBmb3Igb2JqZWN0cyB3aXRob3V0IGEgdG9KU09OCiAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZC4gSXQgY2FuIGJlIGEgZnVuY3Rpb24gb3IgYW4gYXJyYXkuCgogICAgICAgICAgICBzcGFjZSAgICAgICBhbiBvcHRpb25hbCBwYXJhbWV0ZXIgdGhhdCBzcGVjaWZpZXMgdGhlIGluZGVudGF0aW9uCiAgICAgICAgICAgICAgICAgICAgICAgIG9mIG5lc3RlZCBzdHJ1Y3R1cmVzLiBJZiBpdCBpcyBvbWl0dGVkLCB0aGUgdGV4dCB3aWxsCiAgICAgICAgICAgICAgICAgICAgICAgIGJlIHBhY2tlZCB3aXRob3V0IGV4dHJhIHdoaXRlc3BhY2UuIElmIGl0IGlzIGEgbnVtYmVyLAogICAgICAgICAgICAgICAgICAgICAgICBpdCB3aWxsIHNwZWNpZnkgdGhlIG51bWJlciBvZiBzcGFjZXMgdG8gaW5kZW50IGF0IGVhY2gKICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWwuIElmIGl0IGlzIGEgc3RyaW5nIChzdWNoIGFzICdcdCcpLCBpdCBjb250YWlucyB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgY2hhcmFjdGVycyB1c2VkIHRvIGluZGVudCBhdCBlYWNoIGxldmVsLgoKICAgICAgICAgICAgVGhpcyBtZXRob2QgcHJvZHVjZXMgYSBKU09OIHRleHQgZnJvbSBhIEphdmFTY3JpcHQgdmFsdWUuCgogICAgICAgICAgICBXaGVuIGFuIG9iamVjdCB2YWx1ZSBpcyBmb3VuZCwgaWYgdGhlIG9iamVjdCBjb250YWlucyBhIHRvSlNPTgogICAgICAgICAgICBtZXRob2QsIGl0cyB0b0pTT04gbWV0aG9kIHdpdGggYmUgY2FsbGVkIGFuZCB0aGUgcmVzdWx0IHdpbGwgYmUKICAgICAgICAgICAgc3RyaW5naWZpZWQuIEEgdG9KU09OIG1ldGhvZCBkb2VzIG5vdCBzZXJpYWxpemU6IGl0IHJldHVybnMgdGhlCiAgICAgICAgICAgIHZhbHVlIHJlcHJlc2VudGVkIGJ5IHRoZSBuYW1lL3ZhbHVlIHBhaXIgdGhhdCBzaG91bGQgYmUgc2VyaWFsaXplZCwKICAgICAgICAgICAgb3IgdW5kZWZpbmVkIGlmIG5vdGhpbmcgc2hvdWxkIGJlIHNlcmlhbGl6ZWQuIFRoZSB0b0pTT04gbWV0aG9kIHdpbGwKICAgICAgICAgICAgYmUgcGFzc2VkIHRoZSBrZXkgYXNzb2NpYXRlZCB3aXRoIHRoZSB2YWx1ZSwgYW5kIHRoaXMgd2lsbCBiZSBib3VuZAogICAgICAgICAgICB0byB0aGUgb2JqZWN0IGhvbGRpbmcgdGhlIGtleS4KCiAgICAgICAgICAgIFRoaXMgaXMgdGhlIHRvSlNPTiBtZXRob2QgYWRkZWQgdG8gRGF0ZXM6CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gdG9KU09OKGtleSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmdldFVUQ0Z1bGxZZWFyKCkgICArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENEYXRlKCkpICAgICAgKyAnVCcgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICAgICArICc6JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSAgICsgJzonICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICAgKyAnWic7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICBZb3UgY2FuIHByb3ZpZGUgYW4gb3B0aW9uYWwgcmVwbGFjZXIgbWV0aG9kLiBJdCB3aWxsIGJlIHBhc3NlZCB0aGUKICAgICAgICAgICAga2V5IGFuZCB2YWx1ZSBvZiBlYWNoIG1lbWJlciwgd2l0aCB0aGlzIGJvdW5kIHRvIHRoZSBjb250YWluaW5nCiAgICAgICAgICAgIG9iamVjdC4gVGhlIHZhbHVlIHRoYXQgaXMgcmV0dXJuZWQgZnJvbSB5b3VyIG1ldGhvZCB3aWxsIGJlCiAgICAgICAgICAgIHNlcmlhbGl6ZWQuIElmIHlvdXIgbWV0aG9kIHJldHVybnMgdW5kZWZpbmVkLCB0aGVuIHRoZSBtZW1iZXIgd2lsbAogICAgICAgICAgICBiZSBleGNsdWRlZCBmcm9tIHRoZSBzZXJpYWxpemF0aW9uLgoKICAgICAgICAgICAgSWYgbm8gcmVwbGFjZXIgcGFyYW1ldGVyIGlzIHByb3ZpZGVkLCB0aGVuIGEgZGVmYXVsdCByZXBsYWNlcgogICAgICAgICAgICB3aWxsIGJlIHVzZWQ6CgogICAgICAgICAgICAgICAgZnVuY3Rpb24gcmVwbGFjZXIoa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBrZXkpID8KICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWUgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICBUaGUgZGVmYXVsdCByZXBsYWNlciBpcyBwYXNzZWQgdGhlIGtleSBhbmQgdmFsdWUgZm9yIGVhY2ggaXRlbSBpbgogICAgICAgICAgICB0aGUgc3RydWN0dXJlLiBJdCBleGNsdWRlcyBpbmhlcml0ZWQgbWVtYmVycy4KCiAgICAgICAgICAgIElmIHRoZSByZXBsYWNlciBwYXJhbWV0ZXIgaXMgYW4gYXJyYXksIHRoZW4gaXQgd2lsbCBiZSB1c2VkIHRvCiAgICAgICAgICAgIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZSBzZXJpYWxpemVkLiBJdCBmaWx0ZXJzIHRoZSByZXN1bHRzIHN1Y2gKICAgICAgICAgICAgdGhhdCBvbmx5IG1lbWJlcnMgd2l0aCBrZXlzIGxpc3RlZCBpbiB0aGUgcmVwbGFjZXIgYXJyYXkgYXJlCiAgICAgICAgICAgIHN0cmluZ2lmaWVkLgoKICAgICAgICAgICAgVmFsdWVzIHRoYXQgZG8gbm90IGhhdmUgSlNPTiByZXByZXNlbnRhaW9ucywgc3VjaCBhcyB1bmRlZmluZWQgb3IKICAgICAgICAgICAgZnVuY3Rpb25zLCB3aWxsIG5vdCBiZSBzZXJpYWxpemVkLiBTdWNoIHZhbHVlcyBpbiBvYmplY3RzIHdpbGwgYmUKICAgICAgICAgICAgZHJvcHBlZDsgaW4gYXJyYXlzIHRoZXkgd2lsbCBiZSByZXBsYWNlZCB3aXRoIG51bGwuIFlvdSBjYW4gdXNlCiAgICAgICAgICAgIGEgcmVwbGFjZXIgZnVuY3Rpb24gdG8gcmVwbGFjZSB0aG9zZSB3aXRoIEpTT04gdmFsdWVzLgogICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh1bmRlZmluZWQpIHJldHVybnMgdW5kZWZpbmVkLgoKICAgICAgICAgICAgVGhlIG9wdGlvbmFsIHNwYWNlIHBhcmFtZXRlciBwcm9kdWNlcyBhIHN0cmluZ2lmaWNhdGlvbiBvZiB0aGUgdmFsdWUKICAgICAgICAgICAgdGhhdCBpcyBmaWxsZWQgd2l0aCBsaW5lIGJyZWFrcyBhbmQgaW5kZW50YXRpb24gdG8gbWFrZSBpdCBlYXNpZXIgdG8KICAgICAgICAgICAgcmVhZC4KCiAgICAgICAgICAgIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBub24tZW1wdHkgc3RyaW5nLCB0aGVuIHRoYXQgc3RyaW5nIHdpbGwKICAgICAgICAgICAgYmUgdXNlZCBmb3IgaW5kZW50YXRpb24uIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIHRoZW4KICAgICAgICAgICAgdGhlbiBpbmRlbnRhdGlvbiB3aWxsIGJlIHRoYXQgbWFueSBzcGFjZXMuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgdGV4dCA9IEpTT04uc3RyaW5naWZ5KFsnZScsIHtwbHVyaWJ1czogJ3VudW0nfV0pOwogICAgICAgICAgICAvLyB0ZXh0IGlzICdbImUiLHsicGx1cmlidXMiOiJ1bnVtIn1dJwoKCiAgICAgICAgICAgIHRleHQgPSBKU09OLnN0cmluZ2lmeShbJ2UnLCB7cGx1cmlidXM6ICd1bnVtJ31dLCBudWxsLCAnXHQnKTsKICAgICAgICAgICAgLy8gdGV4dCBpcyAnW1xuXHQiZSIsXG5cdHtcblx0XHQicGx1cmlidXMiOiAidW51bSJcblx0fVxuXScKCgogICAgICAgIEpTT04ucGFyc2UodGV4dCwgcmV2aXZlcikKICAgICAgICAgICAgVGhpcyBtZXRob2QgcGFyc2VzIGEgSlNPTiB0ZXh0IHRvIHByb2R1Y2UgYW4gb2JqZWN0IG9yIGFycmF5LgogICAgICAgICAgICBJdCBjYW4gdGhyb3cgYSBTeW50YXhFcnJvciBleGNlcHRpb24uCgogICAgICAgICAgICBUaGUgb3B0aW9uYWwgcmV2aXZlciBwYXJhbWV0ZXIgaXMgYSBmdW5jdGlvbiB0aGF0IGNhbiBmaWx0ZXIgYW5kCiAgICAgICAgICAgIHRyYW5zZm9ybSB0aGUgcmVzdWx0cy4gSXQgcmVjZWl2ZXMgZWFjaCBvZiB0aGUga2V5cyBhbmQgdmFsdWVzLCBhbmQKICAgICAgICAgICAgaXRzIHJldHVybiB2YWx1ZSBpcyB1c2VkIGluc3RlYWQgb2YgdGhlIG9yaWdpbmFsIHZhbHVlLiBJZiBpdAogICAgICAgICAgICByZXR1cm5zIHdoYXQgaXQgcmVjZWl2ZWQsIHRoZW4gc3RydWN0dXJlIGlzIG5vdCBtb2RpZmllZC4gSWYgaXQKICAgICAgICAgICAgcmV0dXJucyB1bmRlZmluZWQgdGhlbiB0aGUgbWVtYmVyIGlzIGRlbGV0ZWQuCgogICAgICAgICAgICBFeGFtcGxlOgoKICAgICAgICAgICAgLy8gUGFyc2UgdGhlIHRleHQuIFZhbHVlcyB0aGF0IGxvb2sgbGlrZSBJU08gZGF0ZSBzdHJpbmdzIHdpbGwKICAgICAgICAgICAgLy8gYmUgY29udmVydGVkIHRvIERhdGUgb2JqZWN0cy4KCiAgICAgICAgICAgIG15RGF0YSA9IEpTT04ucGFyc2UodGV4dCwgZnVuY3Rpb24gKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhID0KL14oXGR7NH0pLShcZHsyfSktKFxkezJ9KVQoXGR7Mn0pOihcZHsyfSk6KFxkezJ9KD86XC5cZCopPylaJC8uZXhlYyh2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKERhdGUuVVRDKCthWzFdLCArYVsyXSAtIDEsICthWzNdLCArYVs0XSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICthWzVdLCArYVs2XSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgfSk7CgoKICAgICAgICBKU09OLnF1b3RlKHRleHQpCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIHdyYXBzIGEgc3RyaW5nIGluIHF1b3RlcywgZXNjYXBpbmcgc29tZSBjaGFyYWN0ZXJzCiAgICAgICAgICAgIGFzIG5lZWRlZC4KCgogICAgVGhpcyBpcyBhIHJlZmVyZW5jZSBpbXBsZW1lbnRhdGlvbi4gWW91IGFyZSBmcmVlIHRvIGNvcHksIG1vZGlmeSwgb3IKICAgIHJlZGlzdHJpYnV0ZS4KCiAgICBVU0UgWU9VUiBPV04gQ09QWS4gSVQgSVMgRVhUUkVNRUxZIFVOV0lTRSBUTyBMT0FEIFRISVJEIFBBUlRZCiAgICBDT0RFIElOVE8gWU9VUiBQQUdFUy4KKi8KCiAgICAvKmpzbGludCByZWdleHA6IHRydWUsIGZvcmluOiB0cnVlLCBldmlsOiB0cnVlICovCgogICAgLypnbG9iYWwgSlNPTiAqLwoKICAgIC8qbWVtYmVycyAiIiwgIlxiIiwgIlx0IiwgIlxuIiwgIlxmIiwgIlxyIiwgIlwiIiwgSlNPTiwgIlxcIiwgYXBwbHksCiAgICBjYWxsLCBjaGFyQ29kZUF0LCBmbG9vciwgZ2V0VVRDRGF0ZSwgZ2V0VVRDRnVsbFllYXIsIGdldFVUQ0hvdXJzLAogICAgZ2V0VVRDTWludXRlcywgZ2V0VVRDTW9udGgsIGdldFVUQ1NlY29uZHMsIGhhc093blByb3BlcnR5LCBqb2luLCBsZW5ndGgsCiAgICBwYXJzZSwgcHJvcGVydHlJc0VudW1lcmFibGUsIHByb3RvdHlwZSwgcHVzaCwgcXVvdGUsIHJlcGxhY2UsIHN0cmluZ2lmeSwKICAgIHRlc3QsIHRvSlNPTiwgdG9TdHJpbmcKKi8KCiAgICBpZiAoIUpTT04pIHsKCiAgICAgICAgLy8gQ3JlYXRlIGEgSlNPTiBvYmplY3Qgb25seSBpZiBvbmUgZG9lcyBub3QgYWxyZWFkeSBleGlzdC4gV2UgY3JlYXRlIHRoZQogICAgICAgIC8vIG9iamVjdCBpbiBhIGNsb3N1cmUgdG8gYXZvaWQgZ2xvYmFsIHZhcmlhYmxlcy4KCiAgICAgICAgdmFyIEpTT04gPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgIGZ1bmN0aW9uIGYobikgeyAvLyBGb3JtYXQgaW50ZWdlcnMgdG8gaGF2ZSBhdCBsZWFzdCB0d28gZGlnaXRzLgogICAgICAgICAgICAgICAgcmV0dXJuIG4gPCAxMCA/ICcwJyArIG4gOiBuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEYXRlLnByb3RvdHlwZS50b0pTT04gPSBmdW5jdGlvbigpIHsKCiAgICAgICAgICAgICAgICAvLyBFdmVudHVhbGx5LCB0aGlzIG1ldGhvZCB3aWxsIGJlIGJhc2VkIG9uIHRoZSBkYXRlLnRvSVNPU3RyaW5nIG1ldGhvZC4KCiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRVVENGdWxsWWVhcigpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTW9udGgoKSArIDEpICsgJy0nICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDRGF0ZSgpKSArICdUJyArCiAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0hvdXJzKCkpICsgJzonICsKICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDTWludXRlcygpKSArICc6JyArCiAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ1NlY29uZHMoKSkgKyAnWic7CiAgICAgICAgICAgIH07CgoKICAgICAgICAgICAgdmFyIGVzY2FwZWFibGUgPSAvWyJcXFx4MDAtXHgxZlx4N2YtXHg5Zl0vZywKICAgICAgICAgICAgICAgIGdhcCwKICAgICAgICAgICAgICAgIGluZGVudCwKICAgICAgICAgICAgICAgIG1ldGEgPSB7IC8vIHRhYmxlIG9mIGNoYXJhY3RlciBzdWJzdGl0dXRpb25zCiAgICAgICAgICAgICAgICAgICAgJ1xiJzogJ1xcYicsCiAgICAgICAgICAgICAgICAgICAgJ1x0JzogJ1xcdCcsCiAgICAgICAgICAgICAgICAgICAgJ1xuJzogJ1xcbicsCiAgICAgICAgICAgICAgICAgICAgJ1xmJzogJ1xcZicsCiAgICAgICAgICAgICAgICAgICAgJ1xyJzogJ1xccicsCiAgICAgICAgICAgICAgICAgICAgJyInOiAnXFwiJywKICAgICAgICAgICAgICAgICAgICAnXFwnOiAnXFxcXCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZXA7CgoKICAgICAgICAgICAgZnVuY3Rpb24gcXVvdGUoc3RyaW5nKSB7CgogICAgICAgICAgICAgICAgLy8gSWYgdGhlIHN0cmluZyBjb250YWlucyBubyBjb250cm9sIGNoYXJhY3RlcnMsIG5vIHF1b3RlIGNoYXJhY3RlcnMsIGFuZCBubwogICAgICAgICAgICAgICAgLy8gYmFja3NsYXNoIGNoYXJhY3RlcnMsIHRoZW4gd2UgY2FuIHNhZmVseSBzbGFwIHNvbWUgcXVvdGVzIGFyb3VuZCBpdC4KICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSB3ZSBtdXN0IGFsc28gcmVwbGFjZSB0aGUgb2ZmZW5kaW5nIGNoYXJhY3RlcnMgd2l0aCBzYWZlIGVzY2FwZQogICAgICAgICAgICAgICAgLy8gc2VxdWVuY2VzLgoKICAgICAgICAgICAgICAgIHJldHVybiBlc2NhcGVhYmxlLnRlc3Qoc3RyaW5nKSA/CiAgICAgICAgICAgICAgICAgICAgJyInICsgc3RyaW5nLnJlcGxhY2UoZXNjYXBlYWJsZSwgZnVuY3Rpb24oYSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IG1ldGFbYV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBjOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBhLmNoYXJDb2RlQXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdcXHUwMCcgKyBNYXRoLmZsb29yKGMgLyAxNikudG9TdHJpbmcoMTYpICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIChjICUgMTYpLnRvU3RyaW5nKDE2KTsKICAgICAgICAgICAgICAgICAgICB9KSArICciJyA6CiAgICAgICAgICAgICAgICAgICAgJyInICsgc3RyaW5nICsgJyInOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgZnVuY3Rpb24gc3RyKGtleSwgaG9sZGVyKSB7CgogICAgICAgICAgICAgICAgLy8gUHJvZHVjZSBhIHN0cmluZyBmcm9tIGhvbGRlcltrZXldLgoKICAgICAgICAgICAgICAgIHZhciBpLCAvLyBUaGUgbG9vcCBjb3VudGVyLgogICAgICAgICAgICAgICAgICAgIGssIC8vIFRoZSBtZW1iZXIga2V5LgogICAgICAgICAgICAgICAgICAgIHYsIC8vIFRoZSBtZW1iZXIgdmFsdWUuCiAgICAgICAgICAgICAgICAgICAgbGVuZ3RoLAogICAgICAgICAgICAgICAgICAgIG1pbmQgPSBnYXAsCiAgICAgICAgICAgICAgICAgICAgcGFydGlhbCwKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhvbGRlcltrZXldOwoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSB2YWx1ZSBoYXMgYSB0b0pTT04gbWV0aG9kLCBjYWxsIGl0IHRvIG9idGFpbiBhIHJlcGxhY2VtZW50IHZhbHVlLgoKICAgICAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgICAgICAgICAgdHlwZW9mIHZhbHVlLnRvSlNPTiA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUudG9KU09OKGtleSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gSWYgd2Ugd2VyZSBjYWxsZWQgd2l0aCBhIHJlcGxhY2VyIGZ1bmN0aW9uLCB0aGVuIGNhbGwgdGhlIHJlcGxhY2VyIHRvCiAgICAgICAgICAgICAgICAvLyBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAgICAgICAgIHZhbHVlID0gcmVwLmNhbGwoaG9sZGVyLCBrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBXaGF0IGhhcHBlbnMgbmV4dCBkZXBlbmRzIG9uIHRoZSB2YWx1ZSdzIHR5cGUuCgogICAgICAgICAgICAgICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlICdzdHJpbmcnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcXVvdGUodmFsdWUpOwoKICAgICAgICAgICAgICAgICAgICBjYXNlICdudW1iZXInOgoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSlNPTiBudW1iZXJzIG11c3QgYmUgZmluaXRlLiBFbmNvZGUgbm9uLWZpbml0ZSBudW1iZXJzIGFzIG51bGwuCgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNGaW5pdGUodmFsdWUpID8gU3RyaW5nKHZhbHVlKSA6ICdudWxsJzsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbnVsbCc6CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaXMgYSBib29sZWFuIG9yIG51bGwsIGNvbnZlcnQgaXQgdG8gYSBzdHJpbmcuIE5vdGU6CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHR5cGVvZiBudWxsIGRvZXMgbm90IHByb2R1Y2UgJ251bGwnLiBUaGUgY2FzZSBpcyBpbmNsdWRlZCBoZXJlIGluCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoZSByZW1vdGUgY2hhbmNlIHRoYXQgdGhpcyBnZXRzIGZpeGVkIHNvbWVkYXkuCgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSB0eXBlIGlzICdvYmplY3QnLCB3ZSBtaWdodCBiZSBkZWFsaW5nIHdpdGggYW4gb2JqZWN0IG9yIGFuIGFycmF5IG9yCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIG51bGwuCgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ29iamVjdCc6CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBEdWUgdG8gYSBzcGVjaWZpY2F0aW9uIGJsdW5kZXIgaW4gRUNNQVNjcmlwdCwgdHlwZW9mIG51bGwgaXMgJ29iamVjdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNvIHdhdGNoIG91dCBmb3IgdGhhdCBjYXNlLgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdudWxsJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBhbiBhcnJheSB0byBob2xkIHRoZSBwYXJ0aWFsIHJlc3VsdHMgb2Ygc3RyaW5naWZ5aW5nIHRoaXMgb2JqZWN0IHZhbHVlLgoKICAgICAgICAgICAgICAgICAgICAgICAgZ2FwICs9IGluZGVudDsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbCA9IFtdOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIG9iamVjdCBoYXMgYSBkb250RW51bSBsZW5ndGggcHJvcGVydHksIHdlJ2xsIHRyZWF0IGl0IGFzIGFuIGFycmF5LgoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZS5sZW5ndGggPT09ICdudW1iZXInICYmICEodmFsdWUucHJvcGVydHlJc0VudW1lcmFibGUoJ2xlbmd0aCcpKSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSBvYmplY3QgaXMgYW4gYXJyYXkuIFN0cmluZ2lmeSBldmVyeSBlbGVtZW50LiBVc2UgbnVsbCBhcyBhIHBsYWNlaG9sZGVyCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBmb3Igbm9uLUpTT04gdmFsdWVzLgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHZhbHVlLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWxbaV0gPSBzdHIoaSwgdmFsdWUpIHx8ICdudWxsJzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBKb2luIGFsbCBvZiB0aGUgZWxlbWVudHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywgYW5kIHdyYXAgdGhlbSBpbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gYnJhY2tldHMuCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwID8gJ1tdJyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwID8gJ1tcbicgKyBnYXAgKyBwYXJ0aWFsLmpvaW4oJyxcbicgKyBnYXApICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXG4nICsgbWluZCArICddJyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1snICsgcGFydGlhbC5qb2luKCcsJykgKyAnXSc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXAgPSBtaW5kOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSByZXBsYWNlciBpcyBhbiBhcnJheSwgdXNlIGl0IHRvIHNlbGVjdCB0aGUgbWVtYmVycyB0byBiZSBzdHJpbmdpZmllZC4KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGVuZ3RoID0gcmVwLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGsgPSByZXBbaV07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBrID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gc3RyKGssIHZhbHVlLCByZXApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBpdGVyYXRlIHRocm91Z2ggYWxsIG9mIHRoZSBrZXlzIGluIHRoZSBvYmplY3QuCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSwgcmVwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsLnB1c2gocXVvdGUoaykgKyAoZ2FwID8gJzogJyA6ICc6JykgKyB2KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEpvaW4gYWxsIG9mIHRoZSBtZW1iZXIgdGV4dHMgdG9nZXRoZXIsIHNlcGFyYXRlZCB3aXRoIGNvbW1hcywKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYW5kIHdyYXAgdGhlbSBpbiBicmFjZXMuCgogICAgICAgICAgICAgICAgICAgICAgICB2ID0gcGFydGlhbC5sZW5ndGggPT09IDAgPyAne30nIDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhcCA/ICd7XG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXG4nICsgbWluZCArICd9JyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAneycgKyBwYXJ0aWFsLmpvaW4oJywnKSArICd9JzsKICAgICAgICAgICAgICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCgogICAgICAgICAgICAvLyBSZXR1cm4gdGhlIEpTT04gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHN0cmluZ2lmeSwgcGFyc2UsIGFuZCBxdW90ZSBtZXRob2RzLgoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIHN0cmluZ2lmeTogZnVuY3Rpb24odmFsdWUsIHJlcGxhY2VyLCBzcGFjZSkgewoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgc3RyaW5naWZ5IG1ldGhvZCB0YWtlcyBhIHZhbHVlIGFuZCBhbiBvcHRpb25hbCByZXBsYWNlciwgYW5kIGFuIG9wdGlvbmFsCiAgICAgICAgICAgICAgICAgICAgLy8gc3BhY2UgcGFyYW1ldGVyLCBhbmQgcmV0dXJucyBhIEpTT04gdGV4dC4gVGhlIHJlcGxhY2VyIGNhbiBiZSBhIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gdGhhdCBjYW4gcmVwbGFjZSB2YWx1ZXMsIG9yIGFuIGFycmF5IG9mIHN0cmluZ3MgdGhhdCB3aWxsIHNlbGVjdCB0aGUga2V5cy4KICAgICAgICAgICAgICAgICAgICAvLyBBIGRlZmF1bHQgcmVwbGFjZXIgbWV0aG9kIGNhbiBiZSBwcm92aWRlZC4gVXNlIG9mIHRoZSBzcGFjZSBwYXJhbWV0ZXIgY2FuCiAgICAgICAgICAgICAgICAgICAgLy8gcHJvZHVjZSB0ZXh0IHRoYXQgaXMgbW9yZSBlYXNpbHkgcmVhZGFibGUuCgogICAgICAgICAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICAgICAgICAgIGdhcCA9ICcnOwogICAgICAgICAgICAgICAgICAgIGluZGVudCA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmIChzcGFjZSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIG51bWJlciwgbWFrZSBhbiBpbmRlbnQgc3RyaW5nIGNvbnRhaW5pbmcgdGhhdAogICAgICAgICAgICAgICAgICAgICAgICAvLyBtYW55IHNwYWNlcy4KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdudW1iZXInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgc3BhY2U7IGkgKz0gMSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGVudCArPSAnICc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHNwYWNlIHBhcmFtZXRlciBpcyBhIHN0cmluZywgaXQgd2lsbCBiZSB1c2VkIGFzIHRoZSBpbmRlbnQgc3RyaW5nLgoKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygc3BhY2UgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQgPSBzcGFjZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gcmVwbGFjZXIgcGFyYW1ldGVyLCB1c2UgdGhlIGRlZmF1bHQgcmVwbGFjZXIuCgogICAgICAgICAgICAgICAgICAgIGlmICghcmVwbGFjZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh0aGlzLCBrZXkpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbiBvciBhbiBhcnJheS4gT3RoZXJ3aXNlLCB0aHJvdyBhbiBlcnJvci4KCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcmVwbGFjZXIgPT09ICdmdW5jdGlvbicgfHwKICAgICAgICAgICAgICAgICAgICAgICAgKHR5cGVvZiByZXBsYWNlciA9PT0gJ29iamVjdCcgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiByZXBsYWNlci5sZW5ndGggPT09ICdudW1iZXInKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXAgPSByZXBsYWNlcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0pTT04uc3RyaW5naWZ5Jyk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBNYWtlIGEgZmFrZSByb290IG9iamVjdCBjb250YWluaW5nIG91ciB2YWx1ZSB1bmRlciB0aGUga2V5IG9mICcnLgogICAgICAgICAgICAgICAgICAgIC8vIFJldHVybiB0aGUgcmVzdWx0IG9mIHN0cmluZ2lmeWluZyB0aGUgdmFsdWUuCgogICAgICAgICAgICAgICAgICAgIHJldHVybiBzdHIoJycsIHsKICAgICAgICAgICAgICAgICAgICAgICAgJyc6IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9LAoKCiAgICAgICAgICAgICAgICBwYXJzZTogZnVuY3Rpb24odGV4dCwgcmV2aXZlcikgewoKICAgICAgICAgICAgICAgICAgICAvLyBUaGUgcGFyc2UgbWV0aG9kIHRha2VzIGEgdGV4dCBhbmQgYW4gb3B0aW9uYWwgcmV2aXZlciBmdW5jdGlvbiwgYW5kIHJldHVybnMKICAgICAgICAgICAgICAgICAgICAvLyBhIEphdmFTY3JpcHQgdmFsdWUgaWYgdGhlIHRleHQgaXMgYSB2YWxpZCBKU09OIHRleHQuCgogICAgICAgICAgICAgICAgICAgIHZhciBqOwoKICAgICAgICAgICAgICAgICAgICBmdW5jdGlvbiB3YWxrKGhvbGRlciwga2V5KSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgd2FsayBtZXRob2QgaXMgdXNlZCB0byByZWN1cnNpdmVseSB3YWxrIHRoZSByZXN1bHRpbmcgc3RydWN0dXJlIHNvCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRoYXQgbW9kaWZpY2F0aW9ucyBjYW4gYmUgbWFkZS4KCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBrLCB2LCB2YWx1ZSA9IGhvbGRlcltrZXldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrIGluIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKE9iamVjdC5oYXNPd25Qcm9wZXJ0eS5jYWxsKHZhbHVlLCBrKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2ID0gd2Fsayh2YWx1ZSwgayk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh2ICE9PSB1bmRlZmluZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlW2tdID0gdjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSB2YWx1ZVtrXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV2aXZlci5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKCiAgICAgICAgICAgICAgICAgICAgLy8gUGFyc2luZyBoYXBwZW5zIGluIHRocmVlIHN0YWdlcy4gSW4gdGhlIGZpcnN0IHN0YWdlLCB3ZSBydW4gdGhlIHRleHQgYWdhaW5zdAogICAgICAgICAgICAgICAgICAgIC8vIHJlZ3VsYXIgZXhwcmVzc2lvbnMgdGhhdCBsb29rIGZvciBub24tSlNPTiBwYXR0ZXJucy4gV2UgYXJlIGVzcGVjaWFsbHkKICAgICAgICAgICAgICAgICAgICAvLyBjb25jZXJuZWQgd2l0aCAnKCknIGFuZCAnbmV3JyBiZWNhdXNlIHRoZXkgY2FuIGNhdXNlIGludm9jYXRpb24sIGFuZCAnPScKICAgICAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIGl0IGNhbiBjYXVzZSBtdXRhdGlvbi4gQnV0IGp1c3QgdG8gYmUgc2FmZSwgd2Ugd2FudCB0byByZWplY3QgYWxsCiAgICAgICAgICAgICAgICAgICAgLy8gdW5leHBlY3RlZCBmb3Jtcy4KCiAgICAgICAgICAgICAgICAgICAgLy8gV2Ugc3BsaXQgdGhlIGZpcnN0IHN0YWdlIGludG8gNCByZWdleHAgb3BlcmF0aW9ucyBpbiBvcmRlciB0byB3b3JrIGFyb3VuZAogICAgICAgICAgICAgICAgICAgIC8vIGNyaXBwbGluZyBpbmVmZmljaWVuY2llcyBpbiBJRSdzIGFuZCBTYWZhcmkncyByZWdleHAgZW5naW5lcy4gRmlyc3Qgd2UKICAgICAgICAgICAgICAgICAgICAvLyByZXBsYWNlIGFsbCBiYWNrc2xhc2ggcGFpcnMgd2l0aCAnQCcgKGEgbm9uLUpTT04gY2hhcmFjdGVyKS4gU2Vjb25kLCB3ZQogICAgICAgICAgICAgICAgICAgIC8vIHJlcGxhY2UgYWxsIHNpbXBsZSB2YWx1ZSB0b2tlbnMgd2l0aCAnXScgY2hhcmFjdGVycy4gVGhpcmQsIHdlIGRlbGV0ZSBhbGwKICAgICAgICAgICAgICAgICAgICAvLyBvcGVuIGJyYWNrZXRzIHRoYXQgZm9sbG93IGEgY29sb24gb3IgY29tbWEgb3IgdGhhdCBiZWdpbiB0aGUgdGV4dC4gRmluYWxseSwKICAgICAgICAgICAgICAgICAgICAvLyB3ZSBsb29rIHRvIHNlZSB0aGF0IHRoZSByZW1haW5pbmcgY2hhcmFjdGVycyBhcmUgb25seSB3aGl0ZXNwYWNlIG9yICddJyBvcgogICAgICAgICAgICAgICAgICAgIC8vICcsJyBvciAnOicgb3IgJ3snIG9yICd9Jy4gSWYgdGhhdCBpcyBzbywgdGhlbiB0aGUgdGV4dCBpcyBzYWZlIGZvciBldmFsLgoKICAgICAgICAgICAgICAgICAgICBpZiAoL15bXF0sOnt9XHNdKiQvLnRlc3QodGV4dC5yZXBsYWNlKC9cXFsiXFxcL2JmbnJ0dV0vZywgJ0AnKS5yZXBsYWNlKC8iW14iXFxcblxyXSoifHRydWV8ZmFsc2V8bnVsbHwtP1xkKyg/OlwuXGQqKT8oPzpbZUVdWytcLV0/XGQrKT8vZywgJ10nKS5yZXBsYWNlKC8oPzpefDp8LCkoPzpccypcWykrL2csICcnKSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIHRoZSBzZWNvbmQgc3RhZ2Ugd2UgdXNlIHRoZSBldmFsIGZ1bmN0aW9uIHRvIGNvbXBpbGUgdGhlIHRleHQgaW50byBhCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEphdmFTY3JpcHQgc3RydWN0dXJlLiBUaGUgJ3snIG9wZXJhdG9yIGlzIHN1YmplY3QgdG8gYSBzeW50YWN0aWMgYW1iaWd1aXR5CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIEphdmFTY3JpcHQ6IGl0IGNhbiBiZWdpbiBhIGJsb2NrIG9yIGFuIG9iamVjdCBsaXRlcmFsLiBXZSB3cmFwIHRoZSB0ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGluIHBhcmVucyB0byBlbGltaW5hdGUgdGhlIGFtYmlndWl0eS4KCiAgICAgICAgICAgICAgICAgICAgICAgIGogPSBldmFsKCcoJyArIHRleHQgKyAnKScpOwoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSW4gdGhlIG9wdGlvbmFsIHRoaXJkIHN0YWdlLCB3ZSByZWN1cnNpdmVseSB3YWxrIHRoZSBuZXcgc3RydWN0dXJlLCBwYXNzaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGVhY2ggbmFtZS92YWx1ZSBwYWlyIHRvIGEgcmV2aXZlciBmdW5jdGlvbiBmb3IgcG9zc2libGUgdHJhbnNmb3JtYXRpb24uCgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHJldml2ZXIgPT09ICdmdW5jdGlvbicgPwogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2Fsayh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJyc6IGoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sICcnKSA6IGo7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdGV4dCBpcyBub3QgSlNPTiBwYXJzZWFibGUsIHRoZW4gYSBTeW50YXhFcnJvciBpcyB0aHJvd24uCgogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcignSlNPTi5wYXJzZScpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICBxdW90ZTogcXVvdGUKICAgICAgICAgICAgfTsKICAgICAgICB9KCk7CiAgICB9CgogICAgLy9qc29uIGVuZAoKICAgIC8vcGVyc2lzdC1taW4gc3RhcnQKCiAgICAoZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKHdpbmRvdy5nb29nbGUgJiYgZ29vZ2xlLmdlYXJzKQogICAgICAgICAgICByZXR1cm47CiAgICAgICAgdmFyIEYgPSBudWxsOwogICAgICAgIGlmICh0eXBlb2YgR2VhcnNGYWN0b3J5ICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIEYgPSBuZXcgR2VhcnNGYWN0b3J5KCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIEYgPSBuZXcgQWN0aXZlWE9iamVjdCgnR2VhcnMuRmFjdG9yeScpOwogICAgICAgICAgICAgICAgaWYgKEYuZ2V0QnVpbGRJbmZvKCkuaW5kZXhPZignaWVfbW9iaWxlJykgIT0gLTEpCiAgICAgICAgICAgICAgICAgICAgRi5wcml2YXRlU2V0R2xvYmFsT2JqZWN0KHRoaXMpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBpZiAoKHR5cGVvZiBuYXZpZ2F0b3IubWltZVR5cGVzICE9ICd1bmRlZmluZWQnKSAmJiBuYXZpZ2F0b3IubWltZVR5cGVzWyJhcHBsaWNhdGlvbi94LWdvb2dsZWdlYXJzIl0pIHsKICAgICAgICAgICAgICAgICAgICBGID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2JqZWN0Iik7CiAgICAgICAgICAgICAgICAgICAgRi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICAgICAgICAgIEYud2lkdGggPSAwOwogICAgICAgICAgICAgICAgICAgIEYuaGVpZ2h0ID0gMDsKICAgICAgICAgICAgICAgICAgICBGLnR5cGUgPSAiYXBwbGljYXRpb24veC1nb29nbGVnZWFycyI7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmFwcGVuZENoaWxkKEYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghRikKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIGlmICghd2luZG93Lmdvb2dsZSkKICAgICAgICAgICAgZ29vZ2xlID0ge307CiAgICAgICAgaWYgKCFnb29nbGUuZ2VhcnMpCiAgICAgICAgICAgIGdvb2dsZS5nZWFycyA9IHsKICAgICAgICAgICAgICAgIGZhY3Rvcnk6IEYKICAgICAgICAgICAgfTsKICAgIH0pKCk7CiAgICBQZXJzaXN0ID0gKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBWRVJTSU9OID0gJzAuMi4wJywKICAgICAgICAgICAgUCwgQiwgZXNjLCBpbml0LCBlbXB0eSwgZWM7CiAgICAgICAgZWMgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBFUE9DSCA9ICdUaHUsIDAxLUphbi0xOTcwIDAwOjAwOjAxIEdNVCcsCiAgICAgICAgICAgICAgICBSQVRJTyA9IDEwMDAgKiA2MCAqIDYwICogMjQsCiAgICAgICAgICAgICAgICBLRVlTID0gWydleHBpcmVzJywgJ3BhdGgnLCAnZG9tYWluJ10sCiAgICAgICAgICAgICAgICBlc2MgPSBlc2NhcGUsCiAgICAgICAgICAgICAgICB1biA9IHVuZXNjYXBlLAogICAgICAgICAgICAgICAgZG9jID0gZG9jdW1lbnQsCiAgICAgICAgICAgICAgICBtZTsKICAgICAgICAgICAgdmFyIGdldF9ub3cgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciByID0gbmV3IERhdGUoKTsKICAgICAgICAgICAgICAgIHIuc2V0VGltZShyLmdldFRpbWUoKSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgY29va2lmeSA9IGZ1bmN0aW9uKGNfa2V5LCBjX3ZhbCkgewogICAgICAgICAgICAgICAgdmFyIGksIGtleSwgdmFsLCByID0gW10sCiAgICAgICAgICAgICAgICAgICAgb3B0ID0gKGFyZ3VtZW50cy5sZW5ndGggPiAyKSA/IGFyZ3VtZW50c1syXSA6IHt9OwogICAgICAgICAgICAgICAgci5wdXNoKGVzYyhjX2tleSkgKyAnPScgKyBlc2MoY192YWwpKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBLRVlTLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gS0VZU1tpXTsKICAgICAgICAgICAgICAgICAgICBpZiAodmFsID0gb3B0W2tleV0pCiAgICAgICAgICAgICAgICAgICAgICAgIHIucHVzaChrZXkgKyAnPScgKyB2YWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdC5zZWN1cmUpCiAgICAgICAgICAgICAgICAgICAgci5wdXNoKCdzZWN1cmUnKTsKICAgICAgICAgICAgICAgIHJldHVybiByLmpvaW4oJzsgJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFsaXZlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgayA9ICdfX0VDX1RFU1RfXycsCiAgICAgICAgICAgICAgICAgICAgdiA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICB2ID0gdi50b0dNVFN0cmluZygpOwogICAgICAgICAgICAgICAgdGhpcy5zZXQoaywgdik7CiAgICAgICAgICAgICAgICB0aGlzLmVuYWJsZWQgPSAodGhpcy5yZW1vdmUoaykgPT0gdik7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbmFibGVkOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1lID0gewogICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCkgewogICAgICAgICAgICAgICAgICAgIHZhciBvcHQgPSAoYXJndW1lbnRzLmxlbmd0aCA+IDIpID8gYXJndW1lbnRzWzJdIDoge30sIG5vdyA9IGdldF9ub3coKSwKICAgICAgICAgICAgICAgICAgICAgICAgZXhwaXJlX2F0LCBjZmcgPSB7fTsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0LmV4cGlyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb3B0LmV4cGlyZXMgKj0gUkFUSU87CiAgICAgICAgICAgICAgICAgICAgICAgIGNmZy5leHBpcmVzID0gbmV3IERhdGUobm93LmdldFRpbWUoKSArIG9wdC5leHBpcmVzKTsKICAgICAgICAgICAgICAgICAgICAgICAgY2ZnLmV4cGlyZXMgPSBjZmcuZXhwaXJlcy50b0dNVFN0cmluZygpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB2YXIga2V5cyA9IFsncGF0aCcsICdkb21haW4nLCAnc2VjdXJlJ107CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRba2V5c1tpXV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZmdba2V5c1tpXV0gPSBvcHRba2V5c1tpXV07CiAgICAgICAgICAgICAgICAgICAgdmFyIHIgPSBjb29raWZ5KGtleSwgdmFsLCBjZmcpOwogICAgICAgICAgICAgICAgICAgIGRvYy5jb29raWUgPSByOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgaGFzOiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mcyA9IGMuaW5kZXhPZihrZXkgKyAnPScpLAogICAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBvZnMgKyBrZXkubGVuZ3RoICsgMSwKICAgICAgICAgICAgICAgICAgICAgICAgc3ViID0gYy5zdWJzdHJpbmcoMCwga2V5Lmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICgoIW9mcyAmJiBrZXkgIT0gc3ViKSB8fCBvZnMgPCAwKSA/IGZhbHNlIDogdHJ1ZTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgIHZhciBjID0gZG9jLmNvb2tpZSwKICAgICAgICAgICAgICAgICAgICAgICAgb2ZzID0gYy5pbmRleE9mKGtleSArICc9JyksCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbiA9IG9mcyArIGtleS5sZW5ndGggKyAxLAogICAgICAgICAgICAgICAgICAgICAgICBzdWIgPSBjLnN1YnN0cmluZygwLCBrZXkubGVuZ3RoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZW5kOwogICAgICAgICAgICAgICAgICAgIGlmICgoIW9mcyAmJiBrZXkgIT0gc3ViKSB8fCBvZnMgPCAwKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgICBlbmQgPSBjLmluZGV4T2YoJzsnLCBsZW4pOwogICAgICAgICAgICAgICAgICAgIGlmIChlbmQgPCAwKQogICAgICAgICAgICAgICAgICAgICAgICBlbmQgPSBjLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW4oYy5zdWJzdHJpbmcobGVuLCBlbmQpKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGspIHsKICAgICAgICAgICAgICAgICAgICB2YXIgciA9IG1lLmdldChrKSwKICAgICAgICAgICAgICAgICAgICAgICAgb3B0ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhwaXJlczogRVBPQ0gKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBkb2MuY29va2llID0gY29va2lmeShrLCAnJywgb3B0KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBrZXlzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHBzID0gYy5zcGxpdCgnOyAnKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSwgcCwgciA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gcHNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgci5wdXNoKHVuKHBbMF0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYWxsOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHBzID0gYy5zcGxpdCgnOyAnKSwKICAgICAgICAgICAgICAgICAgICAgICAgaSwgcCwgciA9IFtdOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBwcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgICAgICBwID0gcHNbaV0uc3BsaXQoJz0nKTsKICAgICAgICAgICAgICAgICAgICAgICAgci5wdXNoKFt1bihwWzBdKSwgdW4ocFsxXSldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgdmVyc2lvbjogJzAuMi4xJywKICAgICAgICAgICAgICAgIGVuYWJsZWQ6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIG1lLmVuYWJsZWQgPSBhbGl2ZS5jYWxsKG1lKTsKICAgICAgICAgICAgcmV0dXJuIG1lOwogICAgICAgIH0oKSk7CiAgICAgICAgdmFyIGluZGV4X29mID0gKGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAoQXJyYXkucHJvdG90eXBlLmluZGV4T2YpCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJ5LCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkucHJvdG90eXBlLmluZGV4T2YuY2FsbChhcnksIHZhbCk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24oYXJ5LCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwgbDsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gYXJ5Lmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFyeVtpXSA9PSB2YWwpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgICAgICAgICB9OwogICAgICAgIH0pKCk7CiAgICAgICAgZW1wdHkgPSBmdW5jdGlvbigpIHt9OwogICAgICAgIGVzYyA9IGZ1bmN0aW9uKHN0cikgewogICAgICAgICAgICByZXR1cm4gJ1BTJyArIHN0ci5yZXBsYWNlKC9fL2csICdfXycpLnJlcGxhY2UoLyAvZywgJ19zJyk7CiAgICAgICAgfTsKICAgICAgICBDID0gewogICAgICAgICAgICBzZWFyY2hfb3JkZXI6IFsnbG9jYWxzdG9yYWdlJywgJ3doYXR3Z19kYicsICdnbG9iYWxzdG9yYWdlJywgJ2dlYXJzJywgJ2llJywgJ2ZsYXNoJywgJ2Nvb2tpZSddLAogICAgICAgICAgICBuYW1lX3JlOiAvXlthLXpdW2EtejAtOV8gLV0rJC9pLAogICAgICAgICAgICBtZXRob2RzOiBbJ2luaXQnLCAnZ2V0JywgJ3NldCcsICdyZW1vdmUnLCAnbG9hZCcsICdzYXZlJ10sCiAgICAgICAgICAgIHNxbDogewogICAgICAgICAgICAgICAgdmVyc2lvbjogJzEnLAogICAgICAgICAgICAgICAgY3JlYXRlOiAiQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgcGVyc2lzdF9kYXRhIChrIFRFWFQgVU5JUVVFIE5PVCBOVUxMIFBSSU1BUlkgS0VZLCB2IFRFWFQgTk9UIE5VTEwpIiwKICAgICAgICAgICAgICAgIGdldDogIlNFTEVDVCB2IEZST00gcGVyc2lzdF9kYXRhIFdIRVJFIGsgPSA/IiwKICAgICAgICAgICAgICAgIHNldDogIklOU0VSVCBJTlRPIHBlcnNpc3RfZGF0YShrLCB2KSBWQUxVRVMgKD8sID8pIiwKICAgICAgICAgICAgICAgIHJlbW92ZTogIkRFTEVURSBGUk9NIHBlcnNpc3RfZGF0YSBXSEVSRSBrID0gPyIKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmxhc2g6IHsKICAgICAgICAgICAgICAgIGRpdl9pZDogJ19wZXJzaXN0X2ZsYXNoX3dyYXAnLAogICAgICAgICAgICAgICAgaWQ6ICdfcGVyc2lzdF9mbGFzaCcsCiAgICAgICAgICAgICAgICBwYXRoOiAncGVyc2lzdC5zd2YnLAogICAgICAgICAgICAgICAgc2l6ZTogewogICAgICAgICAgICAgICAgICAgIHc6IDEsCiAgICAgICAgICAgICAgICAgICAgaDogMQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGFyZ3M6IHsKICAgICAgICAgICAgICAgICAgICBhdXRvc3RhcnQ6IHRydWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgQiA9IHsKICAgICAgICAgICAgZ2VhcnM6IHsKICAgICAgICAgICAgICAgIHNpemU6IC0xLAogICAgICAgICAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICh3aW5kb3cuZ29vZ2xlICYmIHdpbmRvdy5nb29nbGUuZ2VhcnMpID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWV0aG9kczogewogICAgICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uOiBmdW5jdGlvbihmbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGIgPSB0aGlzLmRiOwogICAgICAgICAgICAgICAgICAgICAgICBkYi5leGVjdXRlKCdCRUdJTicpLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwodGhpcywgZGIpOwogICAgICAgICAgICAgICAgICAgICAgICBkYi5leGVjdXRlKCdDT01NSVQnKS5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYjsKICAgICAgICAgICAgICAgICAgICAgICAgZGIgPSB0aGlzLmRiID0gZ29vZ2xlLmdlYXJzLmZhY3RvcnkuY3JlYXRlKCdiZXRhLmRhdGFiYXNlJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGRiLm9wZW4oZXNjKHRoaXMubmFtZSkpOwogICAgICAgICAgICAgICAgICAgICAgICBkYi5leGVjdXRlKEMuc3FsLmNyZWF0ZSkuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHIsIHNxbCA9IEMuc3FsLmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaXNfdmFsaWQsIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIgPSB0LmV4ZWN1dGUoc3FsLCBba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc192YWxpZCA9IHIuaXNWYWxpZFJvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gaXNfdmFsaWQgPyByLmZpZWxkKDApIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgaXNfdmFsaWQsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBybV9zcWwgPSBDLnNxbC5yZW1vdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcWwgPSBDLnNxbC5zZXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZShybV9zcWwsIFtrZXldKS5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlKHNxbCwgW2tleSwgdmFsXSkuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0X3NxbCA9IEMuc3FsLmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgc3FsID0gQy5zcWwucmVtb3ZlLCByLCB2YWwgPSBudWxsLCBpc192YWxpZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHIgPSB0LmV4ZWN1dGUoZ2V0X3NxbCwgW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX3ZhbGlkID0gci5pc1ZhbGlkUm93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gaXNfdmFsaWQgPyByLmZpZWxkKDApIDogbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZuIHx8IGlzX3ZhbGlkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlKHNxbCwgW2tleV0pLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCBpc192YWxpZCwgdmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICB3aGF0d2dfZGI6IHsKICAgICAgICAgICAgICAgIHNpemU6IDIwMCAqIDEwMjQsCiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9ICdQZXJzaXN0SlMgVGVzdCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGRlc2MgPSAnUGVyc2lzdGVudCBkYXRhYmFzZSB0ZXN0Lic7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd2luZG93Lm9wZW5EYXRhYmFzZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF3aW5kb3cub3BlbkRhdGFiYXNlKG5hbWUsIEMuc3FsLnZlcnNpb24sIGRlc2MsIEIud2hhdHdnX2RiLnNpemUpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbjogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmRiX2NyZWF0ZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGIudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChDLnNxbC5jcmVhdGUsIFtdLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYl9jcmVhdGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sIGVtcHR5KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLnRyYW5zYWN0aW9uKGZuKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiID0gb3BlbkRhdGFiYXNlKHRoaXMubmFtZSwgQy5zcWwudmVyc2lvbiwgdGhpcy5vLmFib3V0IHx8ICgiUGVyc2lzdGVudCBzdG9yYWdlIGZvciAiICsgdGhpcy5uYW1lKSwgdGhpcy5vLnNpemUgfHwgQi53aGF0d2dfZGIuc2l6ZSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlID0gc2NvcGUgfHwgdGhpczsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoc3FsLCBba2V5XSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyLnJvd3MubGVuZ3RoID4gMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSwgdHJ1ZSwgci5yb3dzLml0ZW0oMClbJ3YnXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJtX3NxbCA9IEMuc3FsLnJlbW92ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNxbCA9IEMuc3FsLnNldDsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwocm1fc3FsLCBba2V5XSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleSwgdmFsXSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBnZXRfc3FsID0gQy5zcWwuZ2V0OwogICAgICAgICAgICAgICAgICAgICAgICBzcWwgPSBDLnNxbC5yZW1vdmU7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKGdldF9zcWwsIFtrZXldLCBmdW5jdGlvbih0LCByKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyLnJvd3MubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IHIucm93cy5pdGVtKDApWyd2J107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoc3FsLCBba2V5XSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCBmYWxzZSwgbnVsbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdsb2JhbHN0b3JhZ2U6IHsKICAgICAgICAgICAgICAgIHNpemU6IDUgKiAxMDI0ICogMTAyNCwKICAgICAgICAgICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3cuZ2xvYmFsU3RvcmFnZSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXNjKHRoaXMubmFtZSkgKyBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgnZG9tYWluID0gJyArIHRoaXMuby5kb21haW4pOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlID0gZ2xvYmFsU3RvcmFnZVt0aGlzLm8uZG9tYWluXTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB0aGlzLnN0b3JlLmdldEl0ZW0oa2V5KSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5zZXRJdGVtKGtleSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnN0b3JlW2tleV07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUucmVtb3ZlSXRlbShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsICh2YWwgIT09IG51bGwpLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgbG9jYWxzdG9yYWdlOiB7CiAgICAgICAgICAgICAgICBzaXplOiAtMSwKICAgICAgICAgICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdy5sb2NhbFN0b3JhZ2UgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICBrZXk6IGZ1bmN0aW9uKGtleSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZXNjKHRoaXMubmFtZSkgKyBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlID0gbG9jYWxTdG9yYWdlOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHRoaXMuc3RvcmUuZ2V0SXRlbShrZXkpKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnNldEl0ZW0oa2V5LCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuc3RvcmUuZ2V0SXRlbShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnJlbW92ZUl0ZW0oa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCAodmFsICE9PSBudWxsKSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGllOiB7CiAgICAgICAgICAgICAgICBwcmVmaXg6ICdfcGVyc2lzdF9kYXRhLScsCiAgICAgICAgICAgICAgICBzaXplOiA2NCAqIDEwMjQsCiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3cuQWN0aXZlWE9iamVjdCA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWFrZV91c2VyZGF0YTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICBlbC5pZCA9IGlkOwogICAgICAgICAgICAgICAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgICAgICAgICAgZWwuYWRkQmVoYXZpb3IoJyNkZWZhdWx0I3VzZXJkYXRhJyk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlbCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlkID0gQi5pZS5wcmVmaXggKyBlc2ModGhpcy5uYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbCA9IEIuaWUubWFrZV91c2VyZGF0YShpZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm8uZGVmZXIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxvYWQoKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZWwuZ2V0QXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsID8gdHJ1ZSA6IGZhbHNlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnNldEF0dHJpYnV0ZShrZXksIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZWwuZ2V0QXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWwucmVtb3ZlQXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsID8gdHJ1ZSA6IGZhbHNlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgbG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWwubG9hZChlc2ModGhpcy5uYW1lKSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zYXZlKGVzYyh0aGlzLm5hbWUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvb2tpZTogewogICAgICAgICAgICAgICAgZGVsaW06ICc6JywKICAgICAgICAgICAgICAgIHNpemU6IDQwMDAsCiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQLkNvb2tpZS5lbmFibGVkID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMubmFtZSArIEIuY29va2llLmRlbGltICsga2V5OwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBlYy5nZXQoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB2YWwgIT0gbnVsbCwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBlYy5zZXQoa2V5LCB2YWwsIHRoaXMubyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSBlYy5yZW1vdmUoa2V5KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCAhPSBudWxsLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgZmxhc2g6IHsKICAgICAgICAgICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFkZWNvbmNlcHQgfHwgIWRlY29uY2VwdC5TV0ZPYmplY3RVdGlsKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBtYWpvciA9IGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmdldFBsYXllclZlcnNpb24oKS5tYWpvcjsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIChtYWpvciA+PSA4KSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWV0aG9kczogewogICAgICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIUIuZmxhc2guZWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvLCBrZXksIGVsLCBjZmcgPSBDLmZsYXNoOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsLmlkID0gY2ZnLmRpdl9pZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbyA9IG5ldyBkZWNvbmNlcHQuU1dGT2JqZWN0KHRoaXMuby5zd2ZfcGF0aCB8fCBjZmcucGF0aCwgY2ZnLmlkLCBjZmcuc2l6ZS53LCBjZmcuc2l6ZS5oLCAnOCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChrZXkgaW4gY2ZnLmFyZ3MpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgby5hZGRWYXJpYWJsZShrZXksIGNmZy5hcmdzW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgby53cml0ZShlbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBCLmZsYXNoLmVsID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoY2ZnLmlkKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsID0gQi5mbGFzaC5lbDsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZWwuZ2V0KHRoaXMubmFtZSwga2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB2YWwgIT09IG51bGwsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG9sZF92YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBvbGRfdmFsID0gdGhpcy5lbC5zZXQodGhpcy5uYW1lLCBrZXksIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IHRoaXMuZWwucmVtb3ZlKHRoaXMubmFtZSwga2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgdmFyIGluaXQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIGksIGwsIGIsIGtleSwgZm5zID0gQy5tZXRob2RzLAogICAgICAgICAgICAgICAga2V5cyA9IEMuc2VhcmNoX29yZGVyOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0gZm5zLmxlbmd0aDsgaSA8IGw7IGkrKykKICAgICAgICAgICAgICAgIFAuU3RvcmUucHJvdG90eXBlW2Zuc1tpXV0gPSBlbXB0eTsKICAgICAgICAgICAgUC50eXBlID0gbnVsbDsKICAgICAgICAgICAgUC5zaXplID0gLTE7CiAgICAgICAgICAgIGZvciAoaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgIVAudHlwZSAmJiBpIDwgbDsgaSsrKSB7CiAgICAgICAgICAgICAgICBiID0gQltrZXlzW2ldXTsKICAgICAgICAgICAgICAgIGlmIChiLnRlc3QoKSkgewogICAgICAgICAgICAgICAgICAgIFAudHlwZSA9IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgUC5zaXplID0gYi5zaXplOwogICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGIubWV0aG9kcykKICAgICAgICAgICAgICAgICAgICAgICAgUC5TdG9yZS5wcm90b3R5cGVba2V5XSA9IGIubWV0aG9kc1trZXldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIFAuX2luaXQgPSB0cnVlOwogICAgICAgIH07CiAgICAgICAgUCA9IHsKICAgICAgICAgICAgVkVSU0lPTjogVkVSU0lPTiwKICAgICAgICAgICAgdHlwZTogbnVsbCwKICAgICAgICAgICAgc2l6ZTogMCwKICAgICAgICAgICAgYWRkOiBmdW5jdGlvbihvKSB7CiAgICAgICAgICAgICAgICBCW28uaWRdID0gbzsKICAgICAgICAgICAgICAgIEMuc2VhcmNoX29yZGVyID0gW28uaWRdLmNvbmNhdChDLnNlYXJjaF9vcmRlcik7CiAgICAgICAgICAgICAgICBpbml0KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgICAgIHZhciBvZnMgPSBpbmRleF9vZihDLnNlYXJjaF9vcmRlciwgaWQpOwogICAgICAgICAgICAgICAgaWYgKG9mcyA8IDApCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgQy5zZWFyY2hfb3JkZXIuc3BsaWNlKG9mcywgMSk7CiAgICAgICAgICAgICAgICBkZWxldGUgQltpZF07CiAgICAgICAgICAgICAgICBpbml0KCk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIENvb2tpZTogZWMsCiAgICAgICAgICAgIFN0b3JlOiBmdW5jdGlvbihuYW1lLCBvKSB7CiAgICAgICAgICAgICAgICBpZiAoIUMubmFtZV9yZS5leGVjKG5hbWUpKQogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiSW52YWxpZCBuYW1lIik7CiAgICAgICAgICAgICAgICBpZiAoIVAudHlwZSkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIHN1aXRhYmxlIHN0b3JhZ2UgZm91bmQiKTsKICAgICAgICAgICAgICAgIG8gPSBvIHx8IHt9OwogICAgICAgICAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICAgICAgICAgIG8uZG9tYWluID0gby5kb21haW4gfHwgbG9jYXRpb24uaG9zdCB8fCAnbG9jYWxob3N0JzsKICAgICAgICAgICAgICAgIG8uZG9tYWluID0gby5kb21haW4ucmVwbGFjZSgvOlxkKyQvLCAnJykKICAgICAgICAgICAgICAgIHRoaXMubyA9IG87CiAgICAgICAgICAgICAgICBvLmV4cGlyZXMgPSBvLmV4cGlyZXMgfHwgMzY1ICogMjsKICAgICAgICAgICAgICAgIG8ucGF0aCA9IG8ucGF0aCB8fCAnLyc7CiAgICAgICAgICAgICAgICB0aGlzLmluaXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgaW5pdCgpOwogICAgICAgIHJldHVybiBQOwogICAgfSkoKTsKICAgIC8vcGVyc2lzdC1taW4gZW5kCgogICAgLy9zd2ZvYmplY3QtbWluIHN0YXJ0CgogICAgaWYgKHR5cGVvZiBkZWNvbmNlcHQgPT0gInVuZGVmaW5lZCIpIHZhciBkZWNvbmNlcHQgPSBuZXcgT2JqZWN0KCk7CiAgICBpZiAodHlwZW9mIGRlY29uY2VwdC51dGlsID09ICJ1bmRlZmluZWQiKSBkZWNvbmNlcHQudXRpbCA9IG5ldyBPYmplY3QoKTsKICAgIGlmICh0eXBlb2YgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwgPT0gInVuZGVmaW5lZCIpIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsID0gbmV3IE9iamVjdCgpOwogICAgZGVjb25jZXB0LlNXRk9iamVjdCA9IGZ1bmN0aW9uKHN3ZiwgaWQsIHcsIGgsIHZlciwgYywgcXVhbGl0eSwgeGlSZWRpcmVjdFVybCwgcmVkaXJlY3RVcmwsIGRldGVjdEtleSkgewogICAgICAgIGlmICghZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLkRFVEVDVF9LRVkgPSBkZXRlY3RLZXkgPyBkZXRlY3RLZXkgOiAnZGV0ZWN0Zmxhc2gnOwogICAgICAgIHRoaXMuc2tpcERldGVjdCA9IGRlY29uY2VwdC51dGlsLmdldFJlcXVlc3RQYXJhbWV0ZXIodGhpcy5ERVRFQ1RfS0VZKTsKICAgICAgICB0aGlzLnBhcmFtcyA9IG5ldyBPYmplY3QoKTsKICAgICAgICB0aGlzLnZhcmlhYmxlcyA9IG5ldyBPYmplY3QoKTsKICAgICAgICB0aGlzLmF0dHJpYnV0ZXMgPSBuZXcgQXJyYXkoKTsKICAgICAgICBpZiAoc3dmKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdzd2YnLCBzd2YpOwogICAgICAgIH0KICAgICAgICBpZiAoaWQpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ2lkJywgaWQpOwogICAgICAgIH0KICAgICAgICBpZiAodykgewogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnd2lkdGgnLCB3KTsKICAgICAgICB9CiAgICAgICAgaWYgKGgpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ2hlaWdodCcsIGgpOwogICAgICAgIH0KICAgICAgICBpZiAodmVyKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCd2ZXJzaW9uJywgbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKHZlci50b1N0cmluZygpLnNwbGl0KCIuIikpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5pbnN0YWxsZWRWZXIgPSBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5nZXRQbGF5ZXJWZXJzaW9uKCk7CiAgICAgICAgaWYgKCF3aW5kb3cub3BlcmEgJiYgZG9jdW1lbnQuYWxsICYmIHRoaXMuaW5zdGFsbGVkVmVyLm1ham9yID4gNykgewogICAgICAgICAgICBkZWNvbmNlcHQuU1dGT2JqZWN0LmRvUHJlcFVubG9hZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIGlmIChjKSB7CiAgICAgICAgICAgIHRoaXMuYWRkUGFyYW0oJ2JnY29sb3InLCBjKTsKICAgICAgICB9CiAgICAgICAgdmFyIHEgPSBxdWFsaXR5ID8gcXVhbGl0eSA6ICdoaWdoJzsKICAgICAgICB0aGlzLmFkZFBhcmFtKCdxdWFsaXR5JywgcSk7CiAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3VzZUV4cHJlc3NJbnN0YWxsJywgZmFsc2UpOwogICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdkb0V4cHJlc3NJbnN0YWxsJywgZmFsc2UpOwogICAgICAgIHZhciB4aXIgPSAoeGlSZWRpcmVjdFVybCkgPyB4aVJlZGlyZWN0VXJsIDogd2luZG93LmxvY2F0aW9uOwogICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCd4aVJlZGlyZWN0VXJsJywgeGlyKTsKICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnLCAnJyk7CiAgICAgICAgaWYgKHJlZGlyZWN0VXJsKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdyZWRpcmVjdFVybCcsIHJlZGlyZWN0VXJsKTsKICAgICAgICB9CiAgICB9CiAgICBkZWNvbmNlcHQuU1dGT2JqZWN0LnByb3RvdHlwZSA9IHsKICAgICAgICB1c2VFeHByZXNzSW5zdGFsbDogZnVuY3Rpb24ocGF0aCkgewogICAgICAgICAgICB0aGlzLnhpU1dGUGF0aCA9ICFwYXRoID8gImV4cHJlc3NpbnN0YWxsLnN3ZiIgOiBwYXRoOwogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgndXNlRXhwcmVzc0luc3RhbGwnLCB0cnVlKTsKICAgICAgICB9LAogICAgICAgIHNldEF0dHJpYnV0ZTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5hdHRyaWJ1dGVzW25hbWVdID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuYXR0cmlidXRlc1tuYW1lXTsKICAgICAgICB9LAogICAgICAgIGFkZFBhcmFtOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnBhcmFtc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgZ2V0UGFyYW1zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMucGFyYW1zOwogICAgICAgIH0sCiAgICAgICAgYWRkVmFyaWFibGU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMudmFyaWFibGVzW25hbWVdID0gdmFsdWU7CiAgICAgICAgfSwKICAgICAgICBnZXRWYXJpYWJsZTogZnVuY3Rpb24obmFtZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52YXJpYWJsZXNbbmFtZV07CiAgICAgICAgfSwKICAgICAgICBnZXRWYXJpYWJsZXM6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gdGhpcy52YXJpYWJsZXM7CiAgICAgICAgfSwKICAgICAgICBnZXRWYXJpYWJsZVBhaXJzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHZhcmlhYmxlUGFpcnMgPSBuZXcgQXJyYXkoKTsKICAgICAgICAgICAgdmFyIGtleTsKICAgICAgICAgICAgdmFyIHZhcmlhYmxlcyA9IHRoaXMuZ2V0VmFyaWFibGVzKCk7CiAgICAgICAgICAgIGZvciAoa2V5IGluIHZhcmlhYmxlcykgewogICAgICAgICAgICAgICAgdmFyaWFibGVQYWlycy5wdXNoKGtleSArICI9IiArIHZhcmlhYmxlc1trZXldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdmFyaWFibGVQYWlyczsKICAgICAgICB9LAogICAgICAgIGdldFNXRkhUTUw6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgc3dmTm9kZSA9ICIiOwogICAgICAgICAgICBpZiAobmF2aWdhdG9yLnBsdWdpbnMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcyAmJiBuYXZpZ2F0b3IubWltZVR5cGVzLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0QXR0cmlidXRlKCJkb0V4cHJlc3NJbnN0YWxsIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFZhcmlhYmxlKCJNTXBsYXllclR5cGUiLCAiUGx1Z0luIik7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3N3ZicsIHRoaXMueGlTV0ZQYXRoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3Zk5vZGUgPSAnPGVtYmVkIHR5cGU9ImFwcGxpY2F0aW9uL3gtc2hvY2t3YXZlLWZsYXNoIiBzcmM9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnc3dmJykgKyAnIiB3aWR0aD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCd3aWR0aCcpICsgJyIgaGVpZ2h0PSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2hlaWdodCcpICsgJyInOwogICAgICAgICAgICAgICAgc3dmTm9kZSArPSAnIGlkPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2lkJykgKyAnIiBuYW1lPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2lkJykgKyAnIiAnOwogICAgICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgc3dmTm9kZSArPSBba2V5XSArICc9IicgKyBwYXJhbXNba2V5XSArICciICc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB2YXIgcGFpcnMgPSB0aGlzLmdldFZhcmlhYmxlUGFpcnMoKS5qb2luKCImIik7CiAgICAgICAgICAgICAgICBpZiAocGFpcnMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gJ2ZsYXNodmFycz0iJyArIHBhaXJzICsgJyInOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dmTm9kZSArPSAnLz4nOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKHRoaXMuZ2V0QXR0cmlidXRlKCJkb0V4cHJlc3NJbnN0YWxsIikpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFZhcmlhYmxlKCJNTXBsYXllclR5cGUiLCAiQWN0aXZlWCIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdzd2YnLCB0aGlzLnhpU1dGUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2ZOb2RlID0gJzxvYmplY3QgaWQ9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaWQnKSArICciIGNsYXNzaWQ9ImNsc2lkOkQyN0NEQjZFLUFFNkQtMTFjZi05NkI4LTQ0NDU1MzU0MDAwMCIgd2lkdGg9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSArICciIGhlaWdodD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSArICciPic7CiAgICAgICAgICAgICAgICBzd2ZOb2RlICs9ICc8cGFyYW0gbmFtZT0ibW92aWUiIHZhbHVlPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3N3ZicpICsgJyIgLz4nOwogICAgICAgICAgICAgICAgdmFyIHBhcmFtcyA9IHRoaXMuZ2V0UGFyYW1zKCk7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBrZXkgaW4gcGFyYW1zKSB7CiAgICAgICAgICAgICAgICAgICAgc3dmTm9kZSArPSAnPHBhcmFtIG5hbWU9IicgKyBrZXkgKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1trZXldICsgJyIgLz4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBhaXJzID0gdGhpcy5nZXRWYXJpYWJsZVBhaXJzKCkuam9pbigiJiIpOwogICAgICAgICAgICAgICAgaWYgKHBhaXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBzd2ZOb2RlICs9ICc8cGFyYW0gbmFtZT0iZmxhc2h2YXJzIiB2YWx1ZT0iJyArIHBhaXJzICsgJyIgLz4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dmTm9kZSArPSAiPC9vYmplY3Q+IjsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3dmTm9kZTsKICAgICAgICB9LAogICAgICAgIHdyaXRlOiBmdW5jdGlvbihlbGVtZW50SWQpIHsKICAgICAgICAgICAgaWYgKHRoaXMuZ2V0QXR0cmlidXRlKCd1c2VFeHByZXNzSW5zdGFsbCcpKSB7CiAgICAgICAgICAgICAgICB2YXIgZXhwcmVzc0luc3RhbGxSZXFWZXIgPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oWzYsIDAsIDY1XSk7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5pbnN0YWxsZWRWZXIudmVyc2lvbklzVmFsaWQoZXhwcmVzc0luc3RhbGxSZXFWZXIpICYmICF0aGlzLmluc3RhbGxlZFZlci52ZXJzaW9uSXNWYWxpZCh0aGlzLmdldEF0dHJpYnV0ZSgndmVyc2lvbicpKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdkb0V4cHJlc3NJbnN0YWxsJywgdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1yZWRpcmVjdFVSTCIsIGVzY2FwZSh0aGlzLmdldEF0dHJpYnV0ZSgneGlSZWRpcmVjdFVybCcpKSk7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBkb2N1bWVudC50aXRsZS5zbGljZSgwLCA0NykgKyAiIC0gRmxhc2ggUGxheWVyIEluc3RhbGxhdGlvbiI7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1kb2N0aXRsZSIsIGRvY3VtZW50LnRpdGxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5za2lwRGV0ZWN0IHx8IHRoaXMuZ2V0QXR0cmlidXRlKCdkb0V4cHJlc3NJbnN0YWxsJykgfHwgdGhpcy5pbnN0YWxsZWRWZXIudmVyc2lvbklzVmFsaWQodGhpcy5nZXRBdHRyaWJ1dGUoJ3ZlcnNpb24nKSkpIHsKICAgICAgICAgICAgICAgIHZhciBuID0gKHR5cGVvZiBlbGVtZW50SWQgPT0gJ3N0cmluZycpID8gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZWxlbWVudElkKSA6IGVsZW1lbnRJZDsKICAgICAgICAgICAgICAgIG4uaW5uZXJIVE1MID0gdGhpcy5nZXRTV0ZIVE1MKCk7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnKSAhPSAiIikgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmxvY2F0aW9uLnJlcGxhY2UodGhpcy5nZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJykpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9CiAgICB9CiAgICBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5nZXRQbGF5ZXJWZXJzaW9uID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oWzAsIDAsIDBdKTsKICAgICAgICBpZiAobmF2aWdhdG9yLnBsdWdpbnMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgdmFyIHggPSBuYXZpZ2F0b3IucGx1Z2luc1siU2hvY2t3YXZlIEZsYXNoIl07CiAgICAgICAgICAgIGlmICh4ICYmIHguZGVzY3JpcHRpb24pIHsKICAgICAgICAgICAgICAgIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oeC5kZXNjcmlwdGlvbi5yZXBsYWNlKC8oW2EtekEtWl18XHMpKy8sICIiKS5yZXBsYWNlKC8oXHMrcnxccytiWzAtOV0rKS8sICIuIikuc3BsaXQoIi4iKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgdmFyIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaC43Iik7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaC42Iik7CiAgICAgICAgICAgICAgICAgICAgUGxheWVyVmVyc2lvbiA9IG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbihbNiwgMCwgMjFdKTsKICAgICAgICAgICAgICAgICAgICBheG8uQWxsb3dTY3JpcHRBY2Nlc3MgPSAiYWx3YXlzIjsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoUGxheWVyVmVyc2lvbi5tYWpvciA9PSA2KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBQbGF5ZXJWZXJzaW9uOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgYXhvID0gbmV3IEFjdGl2ZVhPYmplY3QoIlNob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoIik7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChheG8gIT0gbnVsbCkgewogICAgICAgICAgICAgICAgUGxheWVyVmVyc2lvbiA9IG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbihheG8uR2V0VmFyaWFibGUoIiR2ZXJzaW9uIikuc3BsaXQoIiAiKVsxXS5zcGxpdCgiLCIpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gUGxheWVyVmVyc2lvbjsKICAgIH0KICAgIGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uID0gZnVuY3Rpb24oYXJyVmVyc2lvbikgewogICAgICAgIHRoaXMubWFqb3IgPSBhcnJWZXJzaW9uWzBdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzBdKSA6IDA7CiAgICAgICAgdGhpcy5taW5vciA9IGFyclZlcnNpb25bMV0gIT0gbnVsbCA/IHBhcnNlSW50KGFyclZlcnNpb25bMV0pIDogMDsKICAgICAgICB0aGlzLnJldiA9IGFyclZlcnNpb25bMl0gIT0gbnVsbCA/IHBhcnNlSW50KGFyclZlcnNpb25bMl0pIDogMDsKICAgIH0KICAgIGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uLnByb3RvdHlwZS52ZXJzaW9uSXNWYWxpZCA9IGZ1bmN0aW9uKGZ2KSB7CiAgICAgICAgaWYgKHRoaXMubWFqb3IgPCBmdi5tYWpvcikgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmICh0aGlzLm1ham9yID4gZnYubWFqb3IpIHJldHVybiB0cnVlOwogICAgICAgIGlmICh0aGlzLm1pbm9yIDwgZnYubWlub3IpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAodGhpcy5taW5vciA+IGZ2Lm1pbm9yKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAodGhpcy5yZXYgPCBmdi5yZXYpIHJldHVybiBmYWxzZTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KICAgIGRlY29uY2VwdC51dGlsID0gewogICAgICAgIGdldFJlcXVlc3RQYXJhbWV0ZXI6IGZ1bmN0aW9uKHBhcmFtKSB7CiAgICAgICAgICAgIHZhciBxID0gZG9jdW1lbnQubG9jYXRpb24uc2VhcmNoIHx8IGRvY3VtZW50LmxvY2F0aW9uLmhhc2g7CiAgICAgICAgICAgIGlmIChxKSB7CiAgICAgICAgICAgICAgICB2YXIgcGFpcnMgPSBxLnN1YnN0cmluZygxKS5zcGxpdCgiJiIpOwogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBwYWlycy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChwYWlyc1tpXS5zdWJzdHJpbmcoMCwgcGFpcnNbaV0uaW5kZXhPZigiPSIpKSA9PSBwYXJhbSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGFpcnNbaV0uc3Vic3RyaW5nKChwYWlyc1tpXS5pbmRleE9mKCI9IikgKyAxKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9CiAgICBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5jbGVhbnVwU1dGcyA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBvYmplY3RzID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIk9CSkVDVCIpOwogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICBvYmplY3RzW2ldLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGZvciAodmFyIHggaW4gb2JqZWN0c1tpXSkgewogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmplY3RzW2ldW3hdID09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICBvYmplY3RzW2ldW3hdID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmIChkZWNvbmNlcHQuU1dGT2JqZWN0LmRvUHJlcFVubG9hZCkgewogICAgICAgIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLnByZXBVbmxvYWQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgX19mbGFzaF91bmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICAgICAgX19mbGFzaF9zYXZlZFVubG9hZEhhbmRsZXIgPSBmdW5jdGlvbigpIHt9OwogICAgICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9udW5sb2FkIiwgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuY2xlYW51cFNXRnMpOwogICAgICAgIH0KICAgICAgICB3aW5kb3cuYXR0YWNoRXZlbnQoIm9uYmVmb3JldW5sb2FkIiwgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwucHJlcFVubG9hZCk7CiAgICB9CiAgICBpZiAoQXJyYXkucHJvdG90eXBlLnB1c2ggPT0gbnVsbCkgewogICAgICAgIEFycmF5LnByb3RvdHlwZS5wdXNoID0gZnVuY3Rpb24oaXRlbSkgewogICAgICAgICAgICB0aGlzW3RoaXMubGVuZ3RoXSA9IGl0ZW07CiAgICAgICAgICAgIHJldHVybiB0aGlzLmxlbmd0aDsKICAgICAgICB9CiAgICB9CiAgICB2YXIgZ2V0UXVlcnlQYXJhbVZhbHVlID0gZGVjb25jZXB0LnV0aWwuZ2V0UmVxdWVzdFBhcmFtZXRlcjsKICAgIHZhciBGbGFzaE9iamVjdCA9IGRlY29uY2VwdC5TV0ZPYmplY3Q7CiAgICB2YXIgU1dGT2JqZWN0ID0gZGVjb25jZXB0LlNXRk9iamVjdDsKICAgIC8vc3dmb2JqZWN0LW1pbiBlbmQKCiAgICAvLyEhIWxpYiBlbmQhISEKCiAgICB2YXIgJGZoID0gcm9vdC4kZmggfHwge307CiAgICBpZiAodHlwZW9mIGZoX2FwcF9wcm9wcyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAkZmguYXBwX3Byb3BzID0gZmhfYXBwX3Byb3BzOwogICAgfQoKICAgICRmaC5sZWdhY3kgPSB7fTsKCiAgICB2YXIgZGVmYXVsdGFyZ3MgPSB7CiAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7fSwKICAgICAgICBmYWlsdXJlOiBmdW5jdGlvbigpIHt9LAogICAgICAgIHBhcmFtczoge30KICAgIH07CgogICAgdmFyIGhhbmRsZWFyZ3MgPSBmdW5jdGlvbihpbmFyZ3MsIGRlZmF1bHRwYXJhbXMsIGFwcGx5dG8pIHsKICAgICAgICB2YXIgb3V0YXJncyA9IFtudWxsLCBudWxsLCBudWxsXTsKICAgICAgICB2YXIgb3JpZ2FyZ3MgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgdmFyIG51bWFyZ3MgPSBpbmFyZ3MubGVuZ3RoOwoKICAgICAgICBpZiAoMiA8IG51bWFyZ3MpIHsKICAgICAgICAgICAgb3JpZ2FyZ3NbMF0gPSBpbmFyZ3NbbnVtYXJncyAtIDNdOwogICAgICAgICAgICBvcmlnYXJnc1sxXSA9IGluYXJnc1tudW1hcmdzIC0gMl07CiAgICAgICAgICAgIG9yaWdhcmdzWzJdID0gaW5hcmdzW251bWFyZ3MgLSAxXTsKICAgICAgICB9IGVsc2UgaWYgKDIgPT0gbnVtYXJncykgewogICAgICAgICAgICBvcmlnYXJnc1sxXSA9IGluYXJnc1swXTsKICAgICAgICAgICAgb3JpZ2FyZ3NbMl0gPSBpbmFyZ3NbMV07CiAgICAgICAgfSBlbHNlIGlmICgxID09IG51bWFyZ3MpIHsKICAgICAgICAgICAgb3JpZ2FyZ3NbMl0gPSBpbmFyZ3NbMF07CiAgICAgICAgfQoKICAgICAgICB2YXIgaSA9IDAsCiAgICAgICAgICAgIGogPSAwOwogICAgICAgIGZvciAoOyBpIDwgMzsgaSsrKSB7CiAgICAgICAgICAgIHZhciBhID0gb3JpZ2FyZ3NbaV07CiAgICAgICAgICAgIHZhciB0YSA9IHR5cGVvZiBhOwogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdpdGVyIGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgICAgICAgaWYgKGEgJiYgMCA9PSBqICYmICgnb2JqZWN0JyA9PSB0YSB8fCAnYm9vbGVhbicgPT0gdGEpKSB7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdvYmplY3QgaTonK2krJyBqOicraisnIHRhOicrdGEpOwogICAgICAgICAgICAgICAgb3V0YXJnc1tqKytdID0gYTsKICAgICAgICAgICAgfSBlbHNlIGlmIChhICYmICdmdW5jdGlvbicgPT0gdGEpIHsKICAgICAgICAgICAgICAgIGogPSAwID09IGogPyAxIDogajsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coJ2Z1bmN0aW9uIGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgICAgICAgICAgIG91dGFyZ3NbaisrXSA9IGE7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmIChudWxsID09IG91dGFyZ3NbMF0pIHsKICAgICAgICAgICAgb3V0YXJnc1swXSA9IGRlZmF1bHRwYXJhbXMgPyBkZWZhdWx0cGFyYW1zIDogZGVmYXVsdGFyZ3MucGFyYW1zOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHZhciBwYXJhbXNhcmcgPSBvdXRhcmdzWzBdOwogICAgICAgICAgICBwYXJhbXNhcmcuX2RlZmF1bHRzID0gW107CiAgICAgICAgICAgIGZvciAodmFyIG4gaW4gZGVmYXVsdHBhcmFtcykgewogICAgICAgICAgICAgICAgaWYgKGRlZmF1bHRwYXJhbXMuaGFzT3duUHJvcGVydHkobikpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhcmFtc2FyZ1tuXSA9PT0gInVuZGVmaW5lZCIpIHsgLy93ZSBkb24ndCB3YW50IHRvIHVzZSAhcGFyYW1zYXJnW25dIGhlcmUgYmVjYXVzZSB0aGUgcGFyYW1ldGVyIGNvdWxkIGV4aXN0cyBpbiB0aGUgYXJndW1lbnQgYW5kIGl0IGNvdWxkIGJlIGZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc2FyZ1tuXSA9IGRlZmF1bHRwYXJhbXNbbl07CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmFtc2FyZy5fZGVmYXVsdHMucHVzaChuKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIG91dGFyZ3NbMV0gPSBudWxsID09IG91dGFyZ3NbMV0gPyBkZWZhdWx0YXJncy5zdWNjZXNzIDogb3V0YXJnc1sxXTsKICAgICAgICBvdXRhcmdzWzJdID0gbnVsbCA9PSBvdXRhcmdzWzJdID8gZGVmYXVsdGFyZ3MuZmFpbHVyZSA6IG91dGFyZ3NbMl07CgogICAgICAgIGFwcGx5dG8ob3V0YXJnc1swXSwgb3V0YXJnc1sxXSwgb3V0YXJnc1syXSk7CiAgICB9CgogICAgdmFyIGV2ZW50U3VwcG9ydGVkID0gZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgICB2YXIgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2knKTsKICAgICAgICByZXR1cm4gZXZlbnQgaW4gZWxlbWVudCB8fCBlbGVtZW50LnNldEF0dHJpYnV0ZSAmJiBlbGVtZW50LnNldEF0dHJpYnV0ZShldmVudCwgInJldHVybjsiKSB8fCBmYWxzZTsKICAgIH0KCiAgICB2YXIgX19pc19yZWFkeSA9IGZhbHNlOwogICAgdmFyIF9fcmVhZHlfbGlzdCA9IFtdOwogICAgdmFyIF9fcmVhZHlfYm91bmQgPSBmYWxzZTsKICAgIHZhciBib3hwcmVmaXggPSAiL2JveC9zcnYvMS4xLyI7CgogICAgX2dldEhvc3RQcmVmaXggPSBmdW5jdGlvbigpIHsKICAgICAgICByZXR1cm4gJGZoLmFwcF9wcm9wcy5ob3N0ICsgYm94cHJlZml4OwogICAgfQoKICAgIHZhciBfX3JlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKCFfX2lzX3JlYWR5KSB7CiAgICAgICAgICAgIF9faXNfcmVhZHkgPSB0cnVlOwogICAgICAgICAgICBpZiAoX19yZWFkeV9saXN0KSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChfX3JlYWR5X2xpc3RbMF0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgX19yZWFkeV9saXN0LnNoaWZ0KCkuYXBwbHkoZG9jdW1lbnQsIFtdKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgfSBmaW5hbGx5IHsKCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBfX3JlYWR5X2xpc3QgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICB2YXIgX19iaW5kX3JlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKF9fcmVhZHlfYm91bmQpIHJldHVybjsKICAgICAgICBfX3JlYWR5X2JvdW5kID0gdHJ1ZTsKCiAgICAgICAgLy8gTW96aWxsYSwgT3BlcmEgYW5kIHdlYmtpdCBuaWdodGxpZXMgY3VycmVudGx5IHN1cHBvcnQgdGhpcyBldmVudAogICAgICAgIGlmIChkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSB7CiAgICAgICAgICAgIC8vIFVzZSB0aGUgaGFuZHkgZXZlbnQgY2FsbGJhY2sKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIGFyZ3VtZW50cy5jYWxsZWUsIGZhbHNlKTsKICAgICAgICAgICAgICAgIF9fcmVhZHkoKTsKICAgICAgICAgICAgfSwgZmFsc2UpOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoImxvYWQiLCBfX3JlYWR5LCBmYWxzZSk7CgogICAgICAgICAgICAvLyBJZiBJRSBldmVudCBtb2RlbCBpcyB1c2VkCiAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5hdHRhY2hFdmVudCkgewogICAgICAgICAgICAvLyBlbnN1cmUgZmlyaW5nIGJlZm9yZSBvbmxvYWQsCiAgICAgICAgICAgIC8vIG1heWJlIGxhdGUgYnV0IHNhZmUgYWxzbyBmb3IgaWZyYW1lcwogICAgICAgICAgICBkb2N1bWVudC5hdHRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIikgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRldGFjaEV2ZW50KCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCBhcmd1bWVudHMuY2FsbGVlKTsKICAgICAgICAgICAgICAgICAgICBfX3JlYWR5KCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBfX3JlYWR5KTsKCiAgICAgICAgICAgIC8vIElmIElFIGFuZCBub3QgYW4gaWZyYW1lCiAgICAgICAgICAgIC8vIGNvbnRpbnVhbGx5IGNoZWNrIHRvIHNlZSBpZiB0aGUgZG9jdW1lbnQgaXMgcmVhZHkKICAgICAgICAgICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCAmJiB3aW5kb3cgPT0gd2luZG93LnRvcCkoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoX19pc19yZWFkeSkgcmV0dXJuOwoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgLy8gSWYgSUUgaXMgdXNlZCwgdXNlIHRoZSB0cmljayBieSBEaWVnbyBQZXJpbmkKICAgICAgICAgICAgICAgICAgICAvLyBodHRwOi8vamF2YXNjcmlwdC5ud2JveC5jb20vSUVDb250ZW50TG9hZGVkLwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5kb1Njcm9sbCgibGVmdCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHsKICAgICAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGFyZ3VtZW50cy5jYWxsZWUsIDApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhbmQgZXhlY3V0ZSBhbnkgd2FpdGluZyBmdW5jdGlvbnMKICAgICAgICAgICAgICAgIF9fcmVhZHkoKTsKICAgICAgICAgICAgfSkoKTsKICAgICAgICB9CiAgICB9OwoKICAgIF9fYmluZF9yZWFkeSgpOwoKICAgIC8vIGRlc3RpbmF0aW9uIGZ1bmN0aW9ucwogICAgdmFyIF9tYXBTY3JpcHRMb2FkZWQgPSAodHlwZW9mIGdvb2dsZSAhPSAidW5kZWZpbmVkIikgJiYgKHR5cGVvZiBnb29nbGUubWFwcyAhPSAidW5kZWZpbmVkIikgJiYgKHR5cGVvZiBnb29nbGUubWFwcy5NYXAgIT0gInVuZGVmaW5lZCIpOwogICAgdmFyIF9sb2FkTWFwU2NyaXB0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInNjcmlwdCIpOwogICAgICAgIHNjcmlwdC50eXBlID0gInRleHQvamF2YXNjcmlwdCI7CiAgICAgICAgdmFyIHByb3RvY29sID0gZG9jdW1lbnQubG9jYXRpb24ucHJvdG9jb2w7CiAgICAgICAgcHJvdG9jb2wgPSAocHJvdG9jb2wgPT09ICJodHRwOiIgfHwgcHJvdG9jb2wgPT09ICJodHRwczoiKSA/IHByb3RvY29sIDogImh0dHBzOiI7CiAgICAgICAgc2NyaXB0LnNyYyA9IHByb3RvY29sICsgIi8vbWFwcy5nb29nbGUuY29tL21hcHMvYXBpL2pzP3NlbnNvcj10cnVlJmNhbGxiYWNrPSRmaC5fbWFwTG9hZGVkIjsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHNjcmlwdCk7CiAgICB9OwoKICAgIHZhciBhdWRpb19vYmogPSBudWxsOwogICAgdmFyIGF1ZGlvX2lzX3BsYXlpbmcgPSBmYWxzZTsKCiAgICAkZmguX19kZXN0X18gPSB7CiAgICAgICAgc2VuZDogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdzZW5kX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgbm90aWZ5OiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ25vdGlmeV9ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIGNvbnRhY3RzOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ2NvbnRhY3RzX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgYWNjOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ2FjY19ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIGdlbzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdnZW9fbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBjYW06IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignY2FtX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgZGV2aWNlOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ2RldmljZV9ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIGxpc3RlbjogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdsaXN0ZW5fbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBoYW5kbGVyczogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdoYW5kbGVyc19ub19zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBmaWxlOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ2ZpbGVfbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBwdXNoOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ3B1c2hfbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBlbnY6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgcyh7CiAgICAgICAgICAgICAgICBoZWlnaHQ6IHdpbmRvdy5pbm5lckhlaWdodCwKICAgICAgICAgICAgICAgIHdpZHRoOiB3aW5kb3cuaW5uZXJXaWR0aAogICAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgICwKICAgICAgICBkYXRhOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGlmICghJGZoLl9wZXJzaXN0KSB7CiAgICAgICAgICAgICAgICAkZmguX3BlcnNpc3QgPSBuZXcgUGVyc2lzdC5TdG9yZSgnRkgnICsgJGZoLmFwcF9wcm9wcy5hcHBpZCwgewogICAgICAgICAgICAgICAgICAgIHN3Zl9wYXRoOiAnL3N0YXRpYy9jL3N0YXJ0L3N3Zi9wZXJzaXN0LnN3ZicKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXAua2V5KSB7CiAgICAgICAgICAgICAgICBmKCdkYXRhX25va2V5Jyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBhY3RzID0gewogICAgICAgICAgICAgICAgbG9hZDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJGZoLl9wZXJzaXN0LmdldChwLmtleSwgZnVuY3Rpb24ob2ssIHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBvayA/IHMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbDogdmFsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHAua2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsOiBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHNhdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghcC52YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZignZGF0YV9ub3ZhbCcpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRmaC5fcGVyc2lzdC5zZXQocC5rZXksIHAudmFsKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGYoJ2RhdGFfZXJyb3InLCB7fSwgcCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcygpOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgJGZoLl9wZXJzaXN0LnJlbW92ZShwLmtleSwgZnVuY3Rpb24ob2ssIHZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBvayA/IHMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbDogdmFsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pIDogcyh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrZXk6IHAua2V5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsOiBudWxsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwoKICAgICAgICAgICAgYWN0c1twLmFjdF0gPyBhY3RzW3AuYWN0XSgpIDogZignZGF0YV9iYWRhY3QnLCBwKTsKICAgICAgICB9CgogICAgICAgICwKICAgICAgICBsb2c6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgdHlwZW9mIGNvbnNvbGUgPT09ICJ1bmRlZmluZWQiID8gZignbG9nX25vc3VwcG9ydCcpIDogY29uc29sZS5sb2cocC5tZXNzYWdlKTsKICAgICAgICB9CgogICAgICAgICwKICAgICAgICBvcmk6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwLmFjdCA9PSAidW5kZWZpbmVkIiB8fCBwLmFjdCA9PSAibGlzdGVuIikgewogICAgICAgICAgICAgICAgaWYgKGV2ZW50U3VwcG9ydGVkKCdvbm9yaWVudGF0aW9uY2hhbmdlJykpIHsKICAgICAgICAgICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignb3JpZW50YXRpb25jaGFuZ2UnLCBzLCBmYWxzZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGYoJ29yaV9ub3N1cHBvcnQnLCB7fSwgcCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAocC5hY3QgPT0gInNldCIpIHsKICAgICAgICAgICAgICAgIGlmICghcC52YWx1ZSkgewogICAgICAgICAgICAgICAgICAgIGYoJ29yaV9ub192YWx1ZScsIHt9LCBwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocC52YWx1ZSA9PSAicG9ydHJhaXQiKSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLW1vei10cmFuc2Zvcm0nXSA9ICIiOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy13ZWJraXQtdHJhbnNmb3JtJ10gPSAiIjsKICAgICAgICAgICAgICAgICAgICBzKHsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZW50YXRpb246ICdwb3J0cmFpdCcKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLW1vei10cmFuc2Zvcm0nXSA9ICdyb3RhdGUoOTBkZWcpJzsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLnN0eWxlWyctd2Via2l0LXRyYW5zZm9ybSddID0gJ3JvdGF0ZSg5MGRlZyknOwogICAgICAgICAgICAgICAgICAgIHMoewogICAgICAgICAgICAgICAgICAgICAgICBvcmllbnRhdGlvbjogJ2xhbmRzY2FwZScKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGYoJ29yaV9iYWRhY3QnLCB7fSwgcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICwKICAgICAgICBtYXA6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgaWYgKCFwLnRhcmdldCkgewogICAgICAgICAgICAgICAgZignbWFwX25vdGFyZ2V0Jywge30sIHApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghcC5sYXQpIHsKICAgICAgICAgICAgICAgIGYoJ21hcF9ub2xhdGl0dWRlJywge30sIHApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghcC5sb24pIHsKICAgICAgICAgICAgICAgIGYoJ21hcF9ub2xvZ2l0dWRlJywge30sIHApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciB0YXJnZXQgPSBwLnRhcmdldDsKICAgICAgICAgICAgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0X2RvbSA9IG51bGw7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGpRdWVyeSAhPSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBqcV9vYmogPSBqUXVlcnkodGFyZ2V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGpxX29iai5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfZG9tID0ganFfb2JqWzBdOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfZG9tID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobnVsbCA9PSB0YXJnZXRfZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X2RvbSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHRhcmdldCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXRfZG9tOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB0YXJnZXQgPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICBpZiAodGFyZ2V0Lm5vZGVUeXBlID09PSAxICYmIHR5cGVvZiB0YXJnZXQubm9kZU5hbWUgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gQSBET00gRWxlbWVudCwgZG8gbm90aGluZwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAvL0EgalF1ZXJ5IG5vZGUKICAgICAgICAgICAgICAgICAgICB0YXJnZXQgPSB0YXJnZXRbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0YXJnZXQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIXRhcmdldCkgewogICAgICAgICAgICAgICAgZignbWFwX25vY29udGFpbmVyJywge30sIHApOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIV9tYXBTY3JpcHRMb2FkZWQpIHsKICAgICAgICAgICAgICAgICRmaC5fbWFwTG9hZGVkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgX21hcFNjcmlwdExvYWRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcE9wdGlvbnMgPSB7fTsKICAgICAgICAgICAgICAgICAgICBtYXBPcHRpb25zLnpvb20gPSBwLnpvb20gPyBwLnpvb20gOiA4OwogICAgICAgICAgICAgICAgICAgIG1hcE9wdGlvbnMuY2VudGVyID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwLmxhdCwgcC5sb24pOwogICAgICAgICAgICAgICAgICAgIG1hcE9wdGlvbnMubWFwVHlwZUlkID0gZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVA7CiAgICAgICAgICAgICAgICAgICAgdmFyIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAodGFyZ2V0LCBtYXBPcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBzKHsKICAgICAgICAgICAgICAgICAgICAgICAgbWFwOiBtYXAKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBfbG9hZE1hcFNjcmlwdCgpOwogICAgICAgICAgICAgICAgLy9hZnRlciAyMCBzZWNzLCBpZiB0aGUgbWFwIHNjcmlwdCBpcyBzdGlsbCBub3QgbG9hZGVkLCBydW4gdGhlIGZhaWwgZnVuY3Rpb24KICAgICAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFfbWFwU2NyaXB0TG9hZGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGYoJ21hcF90aW1lb3V0Jywge30sIHApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDIwMDAwKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhciBtYXBPcHRpb25zID0ge307CiAgICAgICAgICAgICAgICBtYXBPcHRpb25zLnpvb20gPSBwLnpvb20gPyBwLnpvb20gOiA4OwogICAgICAgICAgICAgICAgbWFwT3B0aW9ucy5jZW50ZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHAubGF0LCBwLmxvbik7CiAgICAgICAgICAgICAgICBtYXBPcHRpb25zLm1hcFR5cGVJZCA9IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQOwogICAgICAgICAgICAgICAgdmFyIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAodGFyZ2V0LCBtYXBPcHRpb25zKTsKICAgICAgICAgICAgICAgIHMoewogICAgICAgICAgICAgICAgICAgIG1hcDogbWFwCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLAogICAgICAgIGF1ZGlvOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGlmICghYXVkaW9fb2JqID09IG51bGwgJiYgcC5hY3QgPT0gInBsYXkiICYmICghcC5wYXRoIHx8IHAucGF0aCA9PSAiIikpIHsKICAgICAgICAgICAgICAgIGYoJ25vX2F1ZGlvX3BhdGgnKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgYWN0cyA9IHsKICAgICAgICAgICAgICAgICdwbGF5JzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bGwgPT0gYXVkaW9fb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iaiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImF1ZGlvIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghKChhdWRpb19vYmoucGxheSkgPyB0cnVlIDogZmFsc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmKCdhdWRpb19ub3Rfc3VwcG9ydCcpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLnR5cGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjYW5wbGF5ID0gYXVkaW9fb2JqLmNhblBsYXlUeXBlKHAudHlwZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2FucGxheSA9PSAibm8iIHx8IGNhbnBsYXkgPT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmKCJhdWRpb190eXBlX25vdF9zdXBwb3J0ZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnNyYyA9IHAucGF0aDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuY29udHJvbHMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5jb250cm9scyA9ICJjb250cm9scyI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAuYXV0b3BsYXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5hdXRvcGxheSA9ICJhdXRvcGxheSI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAubG9vcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLmxvb3AgPSAibG9vcCI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhdWRpb19vYmopOwogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmoucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgcygpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIC8vcGxheWluZyBhIG5ldyBhdWRpbwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC5wYXRoICYmIChwLnBhdGggIT0gYXVkaW9fb2JqLnNyYykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhdWRpb19pc19wbGF5aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0c1snc3RvcCddKHRydWUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0c1sncGxheSddKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3Jlc3VtZSB0aGUgZXhpc3RpbmcgYXVkaW8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghYXVkaW9faXNfcGxheWluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5wbGF5KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAncGF1c2UnOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbCAhPSBhdWRpb19vYmogJiYgYXVkaW9faXNfcGxheWluZykgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGF1ZGlvX29iai5wYXVzZSA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmoucGF1c2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXVkaW9fb2JqLnN0b3AgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBmKCdub19hdWRpb19wbGF5aW5nJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAnc3RvcCc6IGZ1bmN0aW9uKG5vY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICBpZiAobnVsbCAhPSBhdWRpb19vYmopIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdWRpb19vYmouc3RvcCA9PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmouc3RvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhdWRpb19vYmoucGF1c2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhdWRpb19vYmopOwogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmogPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghbm9jYWxsYmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcygpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZignbm9fYXVkaW8nKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGFjdHNbcC5hY3RdID8gYWN0c1twLmFjdF0oKSA6IGYoJ2RhdGFfYmFkYWN0JywgcCk7CiAgICAgICAgfQoKICAgICAgICAsCiAgICAgICAgd2VidmlldzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCd3ZWJ2aWV3X25vc3VwcG9ydCcpOwogICAgICAgIH0sCgogICAgICAgIHJlYWR5OiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIF9fYmluZF9yZWFkeSgpOwogICAgICAgICAgICBpZiAoX19pc19yZWFkeSkgewogICAgICAgICAgICAgICAgcy5hcHBseShkb2N1bWVudCwgW10pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgX19yZWFkeV9saXN0LnB1c2gocyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgJGZoLnNlbmQgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICB0eXBlOiAnZW1haWwnCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLnNlbmQpOwogICAgfQoKICAgICRmaC5ub3RpZnkgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICB0eXBlOiAndmlicmF0ZScKICAgICAgICB9LCAkZmguX19kZXN0X18ubm90aWZ5KTsKICAgIH0KCiAgICAkZmguY29udGFjdHMgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBhY3Q6ICdsaXN0JwogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5jb250YWN0cyk7CiAgICB9CgogICAgJGZoLmFjYyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIGFjdDogJ3JlZ2lzdGVyJywKICAgICAgICAgICAgaW50ZXJ2YWw6IDAKICAgICAgICB9LCAkZmguX19kZXN0X18uYWNjKTsKICAgIH0KCiAgICAkZmguZ2VvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAncmVnaXN0ZXInLAogICAgICAgICAgICBpbnRlcnZhbDogMAogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5nZW8pOwogICAgfQoKICAgICRmaC5jYW0gPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBhY3Q6ICdwaWN0dXJlJwogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5jYW0pOwogICAgfQoKICAgICRmaC5kYXRhID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAnbG9hZCcKICAgICAgICB9LCAkZmguX19kZXN0X18uZGF0YSk7CiAgICB9CgogICAgJGZoLmxvZyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIG1lc3NhZ2U6ICdub25lJwogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5sb2cpOwogICAgfQoKICAgICRmaC5kZXZpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5kZXZpY2UpOwogICAgfQoKICAgICRmaC5saXN0ZW4gPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBhY3Q6ICdhZGQnCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLmxpc3Rlbik7CiAgICB9CgogICAgJGZoLm9yaSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLm9yaSk7CiAgICB9CgogICAgJGZoLm1hcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLm1hcCk7CiAgICB9CgogICAgJGZoLmF1ZGlvID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18uYXVkaW8pOwogICAgfQoKICAgICRmaC53ZWJ2aWV3ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ud2Vidmlldyk7CiAgICB9CgogICAgJGZoLnJlYWR5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ucmVhZHkpOwogICAgfTsKCiAgICAkZmguaGFuZGxlcnMgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICB0eXBlOiAnYmFjaycKICAgICAgICB9LCAkZmguX19kZXN0X18uaGFuZGxlcnMpOwogICAgfTsKCiAgICAkZmguZmlsZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIGFjdDogJ3VwbG9hZCcKICAgICAgICB9LCAkZmguX19kZXN0X18uZmlsZSk7CiAgICB9OwoKICAgICRmaC5wdXNoID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18ucHVzaCk7CiAgICB9OwoKICAgIC8vIG5ldyBmdW5jdGlvbnMKICAgICRmaC5lbnYgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgLy8gZmxhdCBwcm9wZXJ0eSBzZXQgLSBubyBzdWIgb2JqZWN0cyEKICAgICAgICAgICAgJGZoLl9fZGVzdF9fLmVudih7fSwgZnVuY3Rpb24oZGVzdEVudikgewogICAgICAgICAgICAgICAgZGVzdEVudi5hcHBsaWNhdGlvbiA9ICRmaC5hcHBfcHJvcHMuYXBwaWQ7CiAgICAgICAgICAgICAgICBpZiAoJGZoLl9nZXREZXZpY2VJZCkgewogICAgICAgICAgICAgICAgICAgIGRlc3RFbnYudXVpZCA9ICRmaC5fZ2V0RGV2aWNlSWQoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRlc3RFbnYuYWdlbnQgPSBuYXZpZ2F0b3IudXNlckFnZW50IHx8ICd1bmtub3duJzsKICAgICAgICAgICAgICAgIHMoZGVzdEVudik7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pOwogICAgfQoKICAgICRmaC5kZXZpY2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKCiAgICAgICAgfSk7CiAgICB9CgoKICAgIC8vIGRlZmF1bHRzOiAKICAgIC8vICAgIHthY3Q6J2dldCd9IC0+IHtnZW9pcDp7Li4ufX0KICAgIC8vICBmYWlsdXJlczogZ2VvaXBfYmFkYWN0CiAgICAvLwogICAgJGZoLmdlb2lwID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAnZ2V0JwogICAgICAgIH0sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgaWYgKCdnZXQnID09IHAuYWN0KSB7CiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICBpbnN0YW5jZTogJGZoLmFwcF9wcm9wcy5hcHBpZCwKICAgICAgICAgICAgICAgICAgICBkb21haW46ICRmaC5jbG91ZF9wcm9wcy5kb21haW4KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICRmaC5fX2FqYXgoewogICAgICAgICAgICAgICAgICAgICJ1cmwiOiBfZ2V0SG9zdFByZWZpeCgpICsgImFjdC93aWQvZ2VvaXAvcmVzb2x2ZSIsCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiUE9TVCIsCiAgICAgICAgICAgICAgICAgICAgImRhdGEiOiBKU09OLnN0cmluZ2lmeShkYXRhKSwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAgICAgICAgICAgICAvLyBiYWNrd2FyZHMgY29tcGF0CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIG4gaW4gcmVzLmdlb2lwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNbbl0gPSByZXNbJ2dlb2lwJ11bbl07CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcyhyZXMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZignZ2VvaXBfYmFkYWN0JywgcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CgogICAgJGZoLndlYiA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBtZXRob2Q6ICdHRVQnCiAgICAgICAgfSwgZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBpZiAoIXAudXJsKSB7CiAgICAgICAgICAgICAgICBmKCdiYWRfdXJsJyk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwLmlzX2xvY2FsKSB7CiAgICAgICAgICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgICAgICAgICAgICB1cmw6IHAudXJsLAogICAgICAgICAgICAgICAgICAgIHR5cGU6ICJHRVQiLAogICAgICAgICAgICAgICAgICAgIGRhdGFUeXBlOiAiaHRtbCIsCiAgICAgICAgICAgICAgICAgICAgLy94aHI6ICRmaC54aHIsCiAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0ge307CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5zdGF0dXMgPSAyMDA7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcy5ib2R5ID0gZGF0YTsKICAgICAgICAgICAgICAgICAgICAgICAgcyhyZXMpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICRmaC5fX2FqYXgoewogICAgICAgICAgICAgICAgICAgICJ1cmwiOiBfZ2V0SG9zdFByZWZpeCgpICsgImFjdC93aWQvd2ViIiwKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJQT1NUIiwKICAgICAgICAgICAgICAgICAgICAiZGF0YSI6IEpTT04uc3RyaW5naWZ5KHApLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogZnVuY3Rpb24ocmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfTsKCiAgICAkZmguX193ZWJ2aWV3X3dpbiA9IHVuZGVmaW5lZDsKICAgICRmaC5fX2Rlc3RfXy53ZWJ2aWV3ID0gZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgIGlmICghKCdhY3QnIGluIHApIHx8IHAuYWN0ID09PSAnb3BlbicpIHsKICAgICAgICAgICAgaWYgKCFwLnVybCkgewogICAgICAgICAgICAgICAgZignbm9fdXJsJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG9sZF91cmwgPSBwLnVybDsKICAgICAgICAgICAgJGZoLl9fd2Vidmlld193aW4gPSB3aW5kb3cub3BlbihwLnVybCwgJ19ibGFuaycpOwogICAgICAgICAgICBzKCJvcGVuZWQiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAocC5hY3QgPT09ICdjbG9zZScpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgJGZoLl9fd2Vidmlld193aW4gIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgICAgICAgICAkZmguX193ZWJ2aWV3X3dpbi5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICRmaC5fX3dlYnZpZXdfd2luID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcygiY2xvc2VkIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwoKICAgICRmaC5fX2Rlc3RfXy5nZW8gPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgaWYgKHR5cGVvZiBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24gIT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgICAgICAgaWYgKCFwLmFjdCB8fCBwLmFjdCA9PSAicmVnaXN0ZXIiKSB7CiAgICAgICAgICAgICAgICBpZiAoJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyKSB7CiAgICAgICAgICAgICAgICAgICAgZignZ2VvX2ludXNlJywge30sIHApOwogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwLmludGVydmFsID09IDApIHsKICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uZ2V0Q3VycmVudFBvc2l0aW9uKGZ1bmN0aW9uKHBvc2l0aW9uKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBjb29yZHMgPSBwb3NpdGlvbi5jb29yZHM7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByZXNkYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9uOiBjb29yZHMubG9uZ2l0dWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGF0OiBjb29yZHMubGF0aXR1ZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbHQ6IGNvb3Jkcy5hbHRpdHVkZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjYzogY29vcmRzLmFjY3VyYWN5LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhZDogY29vcmRzLmhlYWRpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcGVlZDogY29vcmRzLnNwZWVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2hlbjogcG9zaXRpb24udGltZXN0YW1wCiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIHMocmVzZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgfSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGYoJ2Vycm9yX2dlbycsIHt9LCBwKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIGlmIChwLmludGVydmFsID4gMCkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbnRlcm5hbFdhdGNoZXIgPSBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24ud2F0Y2hQb3NpdGlvbihmdW5jdGlvbihwb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29vcmRzID0gcG9zaXRpb24uY29vcmRzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvbjogY29vcmRzLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhdDogY29vcmRzLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0OiBjb29yZHMuYWx0aXR1ZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2M6IGNvb3Jkcy5hY2N1cmFjeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWQ6IGNvb3Jkcy5oZWFkaW5nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlZWQ6IGNvb3Jkcy5zcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW46IHBvc2l0aW9uLnRpbWVzdGFtcAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBzKHJlc2RhdGEpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmKCdlcnJvcl9nZW8nLCB7fSwgcCk7CiAgICAgICAgICAgICAgICAgICAgfSwgewogICAgICAgICAgICAgICAgICAgICAgICBmcmVxdWVuY3k6IHAuaW50ZXJ2YWwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAkZmguX19kZXN0X18uX2dlb1dhdGNoZXIgPSBpbnRlcm5hbFdhdGNoZXI7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9IGVsc2UgaWYgKHAuYWN0ID09ICJ1bnJlZ2lzdGVyIikgewogICAgICAgICAgICAgICAgaWYgKCRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlcikgewogICAgICAgICAgICAgICAgICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5jbGVhcldhdGNoKCRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlcik7CiAgICAgICAgICAgICAgICAgICAgJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyID0gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGYoJ2dlb19iYWRhY3QnLCB7fSwgcCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmKCdnZW9fbm9zdXBwb3J0Jywge30sIHApOwogICAgICAgIH0KICAgIH07CgogICAgJGZoLl9fZGVzdF9fLmFjYyA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICBzKHsKICAgICAgICAgICAgeDogKE1hdGgucmFuZG9tKCkgKiA0KSAtIDIsCiAgICAgICAgICAgIHk6IChNYXRoLnJhbmRvbSgpICogNCkgLSAyLAogICAgICAgICAgICB6OiAoTWF0aC5yYW5kb20oKSAqIDQpIC0gMiwKICAgICAgICAgICAgd2hlbjogbmV3IERhdGUoKS5nZXRUaW1lKCkKICAgICAgICB9KTsKICAgIH0KCiAgICByb290LiRmaCA9ICRmaDsKCn0pKHRoaXMpOw==",
                "body": "OwooZnVuY3Rpb24ocm9vdCkgewoKICAgIC8vISEhbGliIHN0YXJ0ISEhCiAgICAvKgogICAganNvbjIuanMKICAgIDIwMDgtMDMtMjQKCiAgICBQdWJsaWMgRG9tYWluLgoKICAgIE5PIFdBUlJBTlRZIEVYUFJFU1NFRCBPUiBJTVBMSUVELiBVU0UgQVQgWU9VUiBPV04gUklTSy4KCiAgICBTZWUgaHR0cDovL3d3dy5KU09OLm9yZy9qcy5odG1sCgogICAgVGhpcyBmaWxlIGNyZWF0ZXMgYSBnbG9iYWwgSlNPTiBvYmplY3QgY29udGFpbmluZyB0aHJlZSBtZXRob2RzOiBzdHJpbmdpZnksCiAgICBwYXJzZSwgYW5kIHF1b3RlLgoKCiAgICAgICAgSlNPTi5zdHJpbmdpZnkodmFsdWUsIHJlcGxhY2VyLCBzcGFjZSkKICAgICAgICAgICAgdmFsdWUgICAgICAgYW55IEphdmFTY3JpcHQgdmFsdWUsIHVzdWFsbHkgYW4gb2JqZWN0IG9yIGFycmF5LgoKICAgICAgICAgICAgcmVwbGFjZXIgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgZGV0ZXJtaW5lcyBob3cgb2JqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlcyBhcmUgc3RyaW5naWZpZWQgZm9yIG9iamVjdHMgd2l0aG91dCBhIHRvSlNPTgogICAgICAgICAgICAgICAgICAgICAgICBtZXRob2QuIEl0IGNhbiBiZSBhIGZ1bmN0aW9uIG9yIGFuIGFycmF5LgoKICAgICAgICAgICAgc3BhY2UgICAgICAgYW4gb3B0aW9uYWwgcGFyYW1ldGVyIHRoYXQgc3BlY2lmaWVzIHRoZSBpbmRlbnRhdGlvbgogICAgICAgICAgICAgICAgICAgICAgICBvZiBuZXN0ZWQgc3RydWN0dXJlcy4gSWYgaXQgaXMgb21pdHRlZCwgdGhlIHRleHQgd2lsbAogICAgICAgICAgICAgICAgICAgICAgICBiZSBwYWNrZWQgd2l0aG91dCBleHRyYSB3aGl0ZXNwYWNlLiBJZiBpdCBpcyBhIG51bWJlciwKICAgICAgICAgICAgICAgICAgICAgICAgaXQgd2lsbCBzcGVjaWZ5IHRoZSBudW1iZXIgb2Ygc3BhY2VzIHRvIGluZGVudCBhdCBlYWNoCiAgICAgICAgICAgICAgICAgICAgICAgIGxldmVsLiBJZiBpdCBpcyBhIHN0cmluZyAoc3VjaCBhcyAnXHQnKSwgaXQgY29udGFpbnMgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgIGNoYXJhY3RlcnMgdXNlZCB0byBpbmRlbnQgYXQgZWFjaCBsZXZlbC4KCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIHByb2R1Y2VzIGEgSlNPTiB0ZXh0IGZyb20gYSBKYXZhU2NyaXB0IHZhbHVlLgoKICAgICAgICAgICAgV2hlbiBhbiBvYmplY3QgdmFsdWUgaXMgZm91bmQsIGlmIHRoZSBvYmplY3QgY29udGFpbnMgYSB0b0pTT04KICAgICAgICAgICAgbWV0aG9kLCBpdHMgdG9KU09OIG1ldGhvZCB3aXRoIGJlIGNhbGxlZCBhbmQgdGhlIHJlc3VsdCB3aWxsIGJlCiAgICAgICAgICAgIHN0cmluZ2lmaWVkLiBBIHRvSlNPTiBtZXRob2QgZG9lcyBub3Qgc2VyaWFsaXplOiBpdCByZXR1cm5zIHRoZQogICAgICAgICAgICB2YWx1ZSByZXByZXNlbnRlZCBieSB0aGUgbmFtZS92YWx1ZSBwYWlyIHRoYXQgc2hvdWxkIGJlIHNlcmlhbGl6ZWQsCiAgICAgICAgICAgIG9yIHVuZGVmaW5lZCBpZiBub3RoaW5nIHNob3VsZCBiZSBzZXJpYWxpemVkLiBUaGUgdG9KU09OIG1ldGhvZCB3aWxsCiAgICAgICAgICAgIGJlIHBhc3NlZCB0aGUga2V5IGFzc29jaWF0ZWQgd2l0aCB0aGUgdmFsdWUsIGFuZCB0aGlzIHdpbGwgYmUgYm91bmQKICAgICAgICAgICAgdG8gdGhlIG9iamVjdCBob2xkaW5nIHRoZSBrZXkuCgogICAgICAgICAgICBUaGlzIGlzIHRoZSB0b0pTT04gbWV0aG9kIGFkZGVkIHRvIERhdGVzOgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHRvSlNPTihrZXkpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRVVENGdWxsWWVhcigpICAgKyAnLScgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ01vbnRoKCkgKyAxKSArICctJyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDRGF0ZSgpKSAgICAgICsgJ1QnICsKICAgICAgICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENIb3VycygpKSAgICAgKyAnOicgKwogICAgICAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ01pbnV0ZXMoKSkgICArICc6JyArCiAgICAgICAgICAgICAgICAgICAgICAgICBmKHRoaXMuZ2V0VVRDU2Vjb25kcygpKSAgICsgJ1onOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgWW91IGNhbiBwcm92aWRlIGFuIG9wdGlvbmFsIHJlcGxhY2VyIG1ldGhvZC4gSXQgd2lsbCBiZSBwYXNzZWQgdGhlCiAgICAgICAgICAgIGtleSBhbmQgdmFsdWUgb2YgZWFjaCBtZW1iZXIsIHdpdGggdGhpcyBib3VuZCB0byB0aGUgY29udGFpbmluZwogICAgICAgICAgICBvYmplY3QuIFRoZSB2YWx1ZSB0aGF0IGlzIHJldHVybmVkIGZyb20geW91ciBtZXRob2Qgd2lsbCBiZQogICAgICAgICAgICBzZXJpYWxpemVkLiBJZiB5b3VyIG1ldGhvZCByZXR1cm5zIHVuZGVmaW5lZCwgdGhlbiB0aGUgbWVtYmVyIHdpbGwKICAgICAgICAgICAgYmUgZXhjbHVkZWQgZnJvbSB0aGUgc2VyaWFsaXphdGlvbi4KCiAgICAgICAgICAgIElmIG5vIHJlcGxhY2VyIHBhcmFtZXRlciBpcyBwcm92aWRlZCwgdGhlbiBhIGRlZmF1bHQgcmVwbGFjZXIKICAgICAgICAgICAgd2lsbCBiZSB1c2VkOgoKICAgICAgICAgICAgICAgIGZ1bmN0aW9uIHJlcGxhY2VyKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwodGhpcywga2V5KSA/CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgVGhlIGRlZmF1bHQgcmVwbGFjZXIgaXMgcGFzc2VkIHRoZSBrZXkgYW5kIHZhbHVlIGZvciBlYWNoIGl0ZW0gaW4KICAgICAgICAgICAgdGhlIHN0cnVjdHVyZS4gSXQgZXhjbHVkZXMgaW5oZXJpdGVkIG1lbWJlcnMuCgogICAgICAgICAgICBJZiB0aGUgcmVwbGFjZXIgcGFyYW1ldGVyIGlzIGFuIGFycmF5LCB0aGVuIGl0IHdpbGwgYmUgdXNlZCB0bwogICAgICAgICAgICBzZWxlY3QgdGhlIG1lbWJlcnMgdG8gYmUgc2VyaWFsaXplZC4gSXQgZmlsdGVycyB0aGUgcmVzdWx0cyBzdWNoCiAgICAgICAgICAgIHRoYXQgb25seSBtZW1iZXJzIHdpdGgga2V5cyBsaXN0ZWQgaW4gdGhlIHJlcGxhY2VyIGFycmF5IGFyZQogICAgICAgICAgICBzdHJpbmdpZmllZC4KCiAgICAgICAgICAgIFZhbHVlcyB0aGF0IGRvIG5vdCBoYXZlIEpTT04gcmVwcmVzZW50YWlvbnMsIHN1Y2ggYXMgdW5kZWZpbmVkIG9yCiAgICAgICAgICAgIGZ1bmN0aW9ucywgd2lsbCBub3QgYmUgc2VyaWFsaXplZC4gU3VjaCB2YWx1ZXMgaW4gb2JqZWN0cyB3aWxsIGJlCiAgICAgICAgICAgIGRyb3BwZWQ7IGluIGFycmF5cyB0aGV5IHdpbGwgYmUgcmVwbGFjZWQgd2l0aCBudWxsLiBZb3UgY2FuIHVzZQogICAgICAgICAgICBhIHJlcGxhY2VyIGZ1bmN0aW9uIHRvIHJlcGxhY2UgdGhvc2Ugd2l0aCBKU09OIHZhbHVlcy4KICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodW5kZWZpbmVkKSByZXR1cm5zIHVuZGVmaW5lZC4KCiAgICAgICAgICAgIFRoZSBvcHRpb25hbCBzcGFjZSBwYXJhbWV0ZXIgcHJvZHVjZXMgYSBzdHJpbmdpZmljYXRpb24gb2YgdGhlIHZhbHVlCiAgICAgICAgICAgIHRoYXQgaXMgZmlsbGVkIHdpdGggbGluZSBicmVha3MgYW5kIGluZGVudGF0aW9uIHRvIG1ha2UgaXQgZWFzaWVyIHRvCiAgICAgICAgICAgIHJlYWQuCgogICAgICAgICAgICBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgbm9uLWVtcHR5IHN0cmluZywgdGhlbiB0aGF0IHN0cmluZyB3aWxsCiAgICAgICAgICAgIGJlIHVzZWQgZm9yIGluZGVudGF0aW9uLiBJZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGlzIGEgbnVtYmVyLCB0aGVuCiAgICAgICAgICAgIHRoZW4gaW5kZW50YXRpb24gd2lsbCBiZSB0aGF0IG1hbnkgc3BhY2VzLgoKICAgICAgICAgICAgRXhhbXBsZToKCiAgICAgICAgICAgIHRleHQgPSBKU09OLnN0cmluZ2lmeShbJ2UnLCB7cGx1cmlidXM6ICd1bnVtJ31dKTsKICAgICAgICAgICAgLy8gdGV4dCBpcyAnWyJlIix7InBsdXJpYnVzIjoidW51bSJ9XScKCgogICAgICAgICAgICB0ZXh0ID0gSlNPTi5zdHJpbmdpZnkoWydlJywge3BsdXJpYnVzOiAndW51bSd9XSwgbnVsbCwgJ1x0Jyk7CiAgICAgICAgICAgIC8vIHRleHQgaXMgJ1tcblx0ImUiLFxuXHR7XG5cdFx0InBsdXJpYnVzIjogInVudW0iXG5cdH1cbl0nCgoKICAgICAgICBKU09OLnBhcnNlKHRleHQsIHJldml2ZXIpCiAgICAgICAgICAgIFRoaXMgbWV0aG9kIHBhcnNlcyBhIEpTT04gdGV4dCB0byBwcm9kdWNlIGFuIG9iamVjdCBvciBhcnJheS4KICAgICAgICAgICAgSXQgY2FuIHRocm93IGEgU3ludGF4RXJyb3IgZXhjZXB0aW9uLgoKICAgICAgICAgICAgVGhlIG9wdGlvbmFsIHJldml2ZXIgcGFyYW1ldGVyIGlzIGEgZnVuY3Rpb24gdGhhdCBjYW4gZmlsdGVyIGFuZAogICAgICAgICAgICB0cmFuc2Zvcm0gdGhlIHJlc3VsdHMuIEl0IHJlY2VpdmVzIGVhY2ggb2YgdGhlIGtleXMgYW5kIHZhbHVlcywgYW5kCiAgICAgICAgICAgIGl0cyByZXR1cm4gdmFsdWUgaXMgdXNlZCBpbnN0ZWFkIG9mIHRoZSBvcmlnaW5hbCB2YWx1ZS4gSWYgaXQKICAgICAgICAgICAgcmV0dXJucyB3aGF0IGl0IHJlY2VpdmVkLCB0aGVuIHN0cnVjdHVyZSBpcyBub3QgbW9kaWZpZWQuIElmIGl0CiAgICAgICAgICAgIHJldHVybnMgdW5kZWZpbmVkIHRoZW4gdGhlIG1lbWJlciBpcyBkZWxldGVkLgoKICAgICAgICAgICAgRXhhbXBsZToKCiAgICAgICAgICAgIC8vIFBhcnNlIHRoZSB0ZXh0LiBWYWx1ZXMgdGhhdCBsb29rIGxpa2UgSVNPIGRhdGUgc3RyaW5ncyB3aWxsCiAgICAgICAgICAgIC8vIGJlIGNvbnZlcnRlZCB0byBEYXRlIG9iamVjdHMuCgogICAgICAgICAgICBteURhdGEgPSBKU09OLnBhcnNlKHRleHQsIGZ1bmN0aW9uIChrZXksIHZhbHVlKSB7CiAgICAgICAgICAgICAgICB2YXIgYTsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgYSA9Ci9eKFxkezR9KS0oXGR7Mn0pLShcZHsyfSlUKFxkezJ9KTooXGR7Mn0pOihcZHsyfSg/OlwuXGQqKT8pWiQvLmV4ZWModmFsdWUpOwogICAgICAgICAgICAgICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShEYXRlLlVUQygrYVsxXSwgK2FbMl0gLSAxLCArYVszXSwgK2FbNF0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICArYVs1XSwgK2FbNl0pKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgIH0pOwoKCiAgICAgICAgSlNPTi5xdW90ZSh0ZXh0KQogICAgICAgICAgICBUaGlzIG1ldGhvZCB3cmFwcyBhIHN0cmluZyBpbiBxdW90ZXMsIGVzY2FwaW5nIHNvbWUgY2hhcmFjdGVycwogICAgICAgICAgICBhcyBuZWVkZWQuCgoKICAgIFRoaXMgaXMgYSByZWZlcmVuY2UgaW1wbGVtZW50YXRpb24uIFlvdSBhcmUgZnJlZSB0byBjb3B5LCBtb2RpZnksIG9yCiAgICByZWRpc3RyaWJ1dGUuCgogICAgVVNFIFlPVVIgT1dOIENPUFkuIElUIElTIEVYVFJFTUVMWSBVTldJU0UgVE8gTE9BRCBUSElSRCBQQVJUWQogICAgQ09ERSBJTlRPIFlPVVIgUEFHRVMuCiovCgogICAgLypqc2xpbnQgcmVnZXhwOiB0cnVlLCBmb3JpbjogdHJ1ZSwgZXZpbDogdHJ1ZSAqLwoKICAgIC8qZ2xvYmFsIEpTT04gKi8KCiAgICAvKm1lbWJlcnMgIiIsICJcYiIsICJcdCIsICJcbiIsICJcZiIsICJcciIsICJcIiIsIEpTT04sICJcXCIsIGFwcGx5LAogICAgY2FsbCwgY2hhckNvZGVBdCwgZmxvb3IsIGdldFVUQ0RhdGUsIGdldFVUQ0Z1bGxZZWFyLCBnZXRVVENIb3VycywKICAgIGdldFVUQ01pbnV0ZXMsIGdldFVUQ01vbnRoLCBnZXRVVENTZWNvbmRzLCBoYXNPd25Qcm9wZXJ0eSwgam9pbiwgbGVuZ3RoLAogICAgcGFyc2UsIHByb3BlcnR5SXNFbnVtZXJhYmxlLCBwcm90b3R5cGUsIHB1c2gsIHF1b3RlLCByZXBsYWNlLCBzdHJpbmdpZnksCiAgICB0ZXN0LCB0b0pTT04sIHRvU3RyaW5nCiovCgogICAgaWYgKCFKU09OKSB7CgogICAgICAgIC8vIENyZWF0ZSBhIEpTT04gb2JqZWN0IG9ubHkgaWYgb25lIGRvZXMgbm90IGFscmVhZHkgZXhpc3QuIFdlIGNyZWF0ZSB0aGUKICAgICAgICAvLyBvYmplY3QgaW4gYSBjbG9zdXJlIHRvIGF2b2lkIGdsb2JhbCB2YXJpYWJsZXMuCgogICAgICAgIHZhciBKU09OID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgICBmdW5jdGlvbiBmKG4pIHsgLy8gRm9ybWF0IGludGVnZXJzIHRvIGhhdmUgYXQgbGVhc3QgdHdvIGRpZ2l0cy4KICAgICAgICAgICAgICAgIHJldHVybiBuIDwgMTAgPyAnMCcgKyBuIDogbjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgRGF0ZS5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgLy8gRXZlbnR1YWxseSwgdGhpcyBtZXRob2Qgd2lsbCBiZSBiYXNlZCBvbiB0aGUgZGF0ZS50b0lTT1N0cmluZyBtZXRob2QuCgogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VVRDRnVsbFllYXIoKSArICctJyArCiAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ01vbnRoKCkgKyAxKSArICctJyArCiAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ0RhdGUoKSkgKyAnVCcgKwogICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENIb3VycygpKSArICc6JyArCiAgICAgICAgICAgICAgICAgICAgZih0aGlzLmdldFVUQ01pbnV0ZXMoKSkgKyAnOicgKwogICAgICAgICAgICAgICAgICAgIGYodGhpcy5nZXRVVENTZWNvbmRzKCkpICsgJ1onOwogICAgICAgICAgICB9OwoKCiAgICAgICAgICAgIHZhciBlc2NhcGVhYmxlID0gL1siXFxceDAwLVx4MWZceDdmLVx4OWZdL2csCiAgICAgICAgICAgICAgICBnYXAsCiAgICAgICAgICAgICAgICBpbmRlbnQsCiAgICAgICAgICAgICAgICBtZXRhID0geyAvLyB0YWJsZSBvZiBjaGFyYWN0ZXIgc3Vic3RpdHV0aW9ucwogICAgICAgICAgICAgICAgICAgICdcYic6ICdcXGInLAogICAgICAgICAgICAgICAgICAgICdcdCc6ICdcXHQnLAogICAgICAgICAgICAgICAgICAgICdcbic6ICdcXG4nLAogICAgICAgICAgICAgICAgICAgICdcZic6ICdcXGYnLAogICAgICAgICAgICAgICAgICAgICdccic6ICdcXHInLAogICAgICAgICAgICAgICAgICAgICciJzogJ1xcIicsCiAgICAgICAgICAgICAgICAgICAgJ1xcJzogJ1xcXFwnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVwOwoKCiAgICAgICAgICAgIGZ1bmN0aW9uIHF1b3RlKHN0cmluZykgewoKICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzdHJpbmcgY29udGFpbnMgbm8gY29udHJvbCBjaGFyYWN0ZXJzLCBubyBxdW90ZSBjaGFyYWN0ZXJzLCBhbmQgbm8KICAgICAgICAgICAgICAgIC8vIGJhY2tzbGFzaCBjaGFyYWN0ZXJzLCB0aGVuIHdlIGNhbiBzYWZlbHkgc2xhcCBzb21lIHF1b3RlcyBhcm91bmQgaXQuCiAgICAgICAgICAgICAgICAvLyBPdGhlcndpc2Ugd2UgbXVzdCBhbHNvIHJlcGxhY2UgdGhlIG9mZmVuZGluZyBjaGFyYWN0ZXJzIHdpdGggc2FmZSBlc2NhcGUKICAgICAgICAgICAgICAgIC8vIHNlcXVlbmNlcy4KCiAgICAgICAgICAgICAgICByZXR1cm4gZXNjYXBlYWJsZS50ZXN0KHN0cmluZykgPwogICAgICAgICAgICAgICAgICAgICciJyArIHN0cmluZy5yZXBsYWNlKGVzY2FwZWFibGUsIGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBtZXRhW2FdOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjID0gYS5jaGFyQ29kZUF0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnXFx1MDAnICsgTWF0aC5mbG9vcihjIC8gMTYpLnRvU3RyaW5nKDE2KSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYyAlIDE2KS50b1N0cmluZygxNik7CiAgICAgICAgICAgICAgICAgICAgfSkgKyAnIicgOgogICAgICAgICAgICAgICAgICAgICciJyArIHN0cmluZyArICciJzsKICAgICAgICAgICAgfQoKCiAgICAgICAgICAgIGZ1bmN0aW9uIHN0cihrZXksIGhvbGRlcikgewoKICAgICAgICAgICAgICAgIC8vIFByb2R1Y2UgYSBzdHJpbmcgZnJvbSBob2xkZXJba2V5XS4KCiAgICAgICAgICAgICAgICB2YXIgaSwgLy8gVGhlIGxvb3AgY291bnRlci4KICAgICAgICAgICAgICAgICAgICBrLCAvLyBUaGUgbWVtYmVyIGtleS4KICAgICAgICAgICAgICAgICAgICB2LCAvLyBUaGUgbWVtYmVyIHZhbHVlLgogICAgICAgICAgICAgICAgICAgIGxlbmd0aCwKICAgICAgICAgICAgICAgICAgICBtaW5kID0gZ2FwLAogICAgICAgICAgICAgICAgICAgIHBhcnRpYWwsCiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSBob2xkZXJba2V5XTsKCiAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdmFsdWUgaGFzIGEgdG9KU09OIG1ldGhvZCwgY2FsbCBpdCB0byBvYnRhaW4gYSByZXBsYWNlbWVudCB2YWx1ZS4KCiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJgogICAgICAgICAgICAgICAgICAgIHR5cGVvZiB2YWx1ZS50b0pTT04gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnRvSlNPTihrZXkpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIElmIHdlIHdlcmUgY2FsbGVkIHdpdGggYSByZXBsYWNlciBmdW5jdGlvbiwgdGhlbiBjYWxsIHRoZSByZXBsYWNlciB0bwogICAgICAgICAgICAgICAgLy8gb2J0YWluIGEgcmVwbGFjZW1lbnQgdmFsdWUuCgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiByZXAgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHJlcC5jYWxsKGhvbGRlciwga2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gV2hhdCBoYXBwZW5zIG5leHQgZGVwZW5kcyBvbiB0aGUgdmFsdWUncyB0eXBlLgoKICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZW9mIHZhbHVlKSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAnc3RyaW5nJzoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHF1b3RlKHZhbHVlKTsKCiAgICAgICAgICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzoKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEpTT04gbnVtYmVycyBtdXN0IGJlIGZpbml0ZS4gRW5jb2RlIG5vbi1maW5pdGUgbnVtYmVycyBhcyBudWxsLgoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzRmluaXRlKHZhbHVlKSA/IFN0cmluZyh2YWx1ZSkgOiAnbnVsbCc7CgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ2Jvb2xlYW4nOgogICAgICAgICAgICAgICAgICAgIGNhc2UgJ251bGwnOgoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHZhbHVlIGlzIGEgYm9vbGVhbiBvciBudWxsLCBjb252ZXJ0IGl0IHRvIGEgc3RyaW5nLiBOb3RlOgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0eXBlb2YgbnVsbCBkb2VzIG5vdCBwcm9kdWNlICdudWxsJy4gVGhlIGNhc2UgaXMgaW5jbHVkZWQgaGVyZSBpbgogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgcmVtb3RlIGNoYW5jZSB0aGF0IHRoaXMgZ2V0cyBmaXhlZCBzb21lZGF5LgoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgdHlwZSBpcyAnb2JqZWN0Jywgd2UgbWlnaHQgYmUgZGVhbGluZyB3aXRoIGFuIG9iamVjdCBvciBhbiBhcnJheSBvcgogICAgICAgICAgICAgICAgICAgICAgICAvLyBudWxsLgoKICAgICAgICAgICAgICAgICAgICBjYXNlICdvYmplY3QnOgoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gRHVlIHRvIGEgc3BlY2lmaWNhdGlvbiBibHVuZGVyIGluIEVDTUFTY3JpcHQsIHR5cGVvZiBudWxsIGlzICdvYmplY3QnLAogICAgICAgICAgICAgICAgICAgICAgICAvLyBzbyB3YXRjaCBvdXQgZm9yIHRoYXQgY2FzZS4KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbnVsbCc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIE1ha2UgYW4gYXJyYXkgdG8gaG9sZCB0aGUgcGFydGlhbCByZXN1bHRzIG9mIHN0cmluZ2lmeWluZyB0aGlzIG9iamVjdCB2YWx1ZS4KCiAgICAgICAgICAgICAgICAgICAgICAgIGdhcCArPSBpbmRlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwgPSBbXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBvYmplY3QgaGFzIGEgZG9udEVudW0gbGVuZ3RoIHByb3BlcnR5LCB3ZSdsbCB0cmVhdCBpdCBhcyBhbiBhcnJheS4KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUubGVuZ3RoID09PSAnbnVtYmVyJyAmJiAhKHZhbHVlLnByb3BlcnR5SXNFbnVtZXJhYmxlKCdsZW5ndGgnKSkpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgb2JqZWN0IGlzIGFuIGFycmF5LiBTdHJpbmdpZnkgZXZlcnkgZWxlbWVudC4gVXNlIG51bGwgYXMgYSBwbGFjZWhvbGRlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gZm9yIG5vbi1KU09OIHZhbHVlcy4KCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZW5ndGggPSB2YWx1ZS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJ0aWFsW2ldID0gc3RyKGksIHZhbHVlKSB8fCAnbnVsbCc7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gSm9pbiBhbGwgb2YgdGhlIGVsZW1lbnRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsIGFuZCB3cmFwIHRoZW0gaW4KICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGJyYWNrZXRzLgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBwYXJ0aWFsLmxlbmd0aCA9PT0gMCA/ICdbXScgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdhcCA/ICdbXG4nICsgZ2FwICsgcGFydGlhbC5qb2luKCcsXG4nICsgZ2FwKSArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1xuJyArIG1pbmQgKyAnXScgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdbJyArIHBhcnRpYWwuam9pbignLCcpICsgJ10nOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ2FwID0gbWluZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJZiB0aGUgcmVwbGFjZXIgaXMgYW4gYXJyYXksIHVzZSBpdCB0byBzZWxlY3QgdGhlIG1lbWJlcnMgdG8gYmUgc3RyaW5naWZpZWQuCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHJlcCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aCA9IHJlcC5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuZ3RoOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrID0gcmVwW2ldOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgayA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHN0cihrLCB2YWx1ZSwgcmVwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRpYWwucHVzaChxdW90ZShrKSArIChnYXAgPyAnOiAnIDogJzonKSArIHYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIE90aGVyd2lzZSwgaXRlcmF0ZSB0aHJvdWdoIGFsbCBvZiB0aGUga2V5cyBpbiB0aGUgb2JqZWN0LgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHYgPSBzdHIoaywgdmFsdWUsIHJlcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHYpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFydGlhbC5wdXNoKHF1b3RlKGspICsgKGdhcCA/ICc6ICcgOiAnOicpICsgdik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBKb2luIGFsbCBvZiB0aGUgbWVtYmVyIHRleHRzIHRvZ2V0aGVyLCBzZXBhcmF0ZWQgd2l0aCBjb21tYXMsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFuZCB3cmFwIHRoZW0gaW4gYnJhY2VzLgoKICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHBhcnRpYWwubGVuZ3RoID09PSAwID8gJ3t9JyA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnYXAgPyAne1xuJyArIGdhcCArIHBhcnRpYWwuam9pbignLFxuJyArIGdhcCkgKwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1xuJyArIG1pbmQgKyAnfScgOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3snICsgcGFydGlhbC5qb2luKCcsJykgKyAnfSc7CiAgICAgICAgICAgICAgICAgICAgICAgIGdhcCA9IG1pbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAgICAgLy8gUmV0dXJuIHRoZSBKU09OIG9iamVjdCBjb250YWluaW5nIHRoZSBzdHJpbmdpZnksIHBhcnNlLCBhbmQgcXVvdGUgbWV0aG9kcy4KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBzdHJpbmdpZnk6IGZ1bmN0aW9uKHZhbHVlLCByZXBsYWNlciwgc3BhY2UpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHN0cmluZ2lmeSBtZXRob2QgdGFrZXMgYSB2YWx1ZSBhbmQgYW4gb3B0aW9uYWwgcmVwbGFjZXIsIGFuZCBhbiBvcHRpb25hbAogICAgICAgICAgICAgICAgICAgIC8vIHNwYWNlIHBhcmFtZXRlciwgYW5kIHJldHVybnMgYSBKU09OIHRleHQuIFRoZSByZXBsYWNlciBjYW4gYmUgYSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgIC8vIHRoYXQgY2FuIHJlcGxhY2UgdmFsdWVzLCBvciBhbiBhcnJheSBvZiBzdHJpbmdzIHRoYXQgd2lsbCBzZWxlY3QgdGhlIGtleXMuCiAgICAgICAgICAgICAgICAgICAgLy8gQSBkZWZhdWx0IHJlcGxhY2VyIG1ldGhvZCBjYW4gYmUgcHJvdmlkZWQuIFVzZSBvZiB0aGUgc3BhY2UgcGFyYW1ldGVyIGNhbgogICAgICAgICAgICAgICAgICAgIC8vIHByb2R1Y2UgdGV4dCB0aGF0IGlzIG1vcmUgZWFzaWx5IHJlYWRhYmxlLgoKICAgICAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgICAgICBnYXAgPSAnJzsKICAgICAgICAgICAgICAgICAgICBpbmRlbnQgPSAnJzsKICAgICAgICAgICAgICAgICAgICBpZiAoc3BhY2UpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBudW1iZXIsIG1ha2UgYW4gaW5kZW50IHN0cmluZyBjb250YWluaW5nIHRoYXQKICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWFueSBzcGFjZXMuCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNwYWNlID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IHNwYWNlOyBpICs9IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRlbnQgKz0gJyAnOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZSBzcGFjZSBwYXJhbWV0ZXIgaXMgYSBzdHJpbmcsIGl0IHdpbGwgYmUgdXNlZCBhcyB0aGUgaW5kZW50IHN0cmluZy4KCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHNwYWNlID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZW50ID0gc3BhY2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIElmIHRoZXJlIGlzIG5vIHJlcGxhY2VyIHBhcmFtZXRlciwgdXNlIHRoZSBkZWZhdWx0IHJlcGxhY2VyLgoKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlcGxhY2VyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlcCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghT2JqZWN0Lmhhc093blByb3BlcnR5LmNhbGwodGhpcywga2V5KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBUaGUgcmVwbGFjZXIgY2FuIGJlIGEgZnVuY3Rpb24gb3IgYW4gYXJyYXkuIE90aGVyd2lzZSwgdGhyb3cgYW4gZXJyb3IuCgogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHJlcGxhY2VyID09PSAnZnVuY3Rpb24nIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICh0eXBlb2YgcmVwbGFjZXIgPT09ICdvYmplY3QnICYmCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgcmVwbGFjZXIubGVuZ3RoID09PSAnbnVtYmVyJykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmVwID0gcmVwbGFjZXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdKU09OLnN0cmluZ2lmeScpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gTWFrZSBhIGZha2Ugcm9vdCBvYmplY3QgY29udGFpbmluZyBvdXIgdmFsdWUgdW5kZXIgdGhlIGtleSBvZiAnJy4KICAgICAgICAgICAgICAgICAgICAvLyBSZXR1cm4gdGhlIHJlc3VsdCBvZiBzdHJpbmdpZnlpbmcgdGhlIHZhbHVlLgoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3RyKCcnLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICcnOiB2YWx1ZQogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSwKCgogICAgICAgICAgICAgICAgcGFyc2U6IGZ1bmN0aW9uKHRleHQsIHJldml2ZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHBhcnNlIG1ldGhvZCB0YWtlcyBhIHRleHQgYW5kIGFuIG9wdGlvbmFsIHJldml2ZXIgZnVuY3Rpb24sIGFuZCByZXR1cm5zCiAgICAgICAgICAgICAgICAgICAgLy8gYSBKYXZhU2NyaXB0IHZhbHVlIGlmIHRoZSB0ZXh0IGlzIGEgdmFsaWQgSlNPTiB0ZXh0LgoKICAgICAgICAgICAgICAgICAgICB2YXIgajsKCiAgICAgICAgICAgICAgICAgICAgZnVuY3Rpb24gd2Fsayhob2xkZXIsIGtleSkgewoKICAgICAgICAgICAgICAgICAgICAgICAgLy8gVGhlIHdhbGsgbWV0aG9kIGlzIHVzZWQgdG8gcmVjdXJzaXZlbHkgd2FsayB0aGUgcmVzdWx0aW5nIHN0cnVjdHVyZSBzbwogICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGF0IG1vZGlmaWNhdGlvbnMgY2FuIGJlIG1hZGUuCgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgaywgdiwgdmFsdWUgPSBob2xkZXJba2V5XTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoayBpbiB2YWx1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbCh2YWx1ZSwgaykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdiA9IHdhbGsodmFsdWUsIGspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodiAhPT0gdW5kZWZpbmVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZVtrXSA9IHY7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgdmFsdWVba107CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldml2ZXIuY2FsbChob2xkZXIsIGtleSwgdmFsdWUpOwogICAgICAgICAgICAgICAgICAgIH0KCgogICAgICAgICAgICAgICAgICAgIC8vIFBhcnNpbmcgaGFwcGVucyBpbiB0aHJlZSBzdGFnZXMuIEluIHRoZSBmaXJzdCBzdGFnZSwgd2UgcnVuIHRoZSB0ZXh0IGFnYWluc3QKICAgICAgICAgICAgICAgICAgICAvLyByZWd1bGFyIGV4cHJlc3Npb25zIHRoYXQgbG9vayBmb3Igbm9uLUpTT04gcGF0dGVybnMuIFdlIGFyZSBlc3BlY2lhbGx5CiAgICAgICAgICAgICAgICAgICAgLy8gY29uY2VybmVkIHdpdGggJygpJyBhbmQgJ25ldycgYmVjYXVzZSB0aGV5IGNhbiBjYXVzZSBpbnZvY2F0aW9uLCBhbmQgJz0nCiAgICAgICAgICAgICAgICAgICAgLy8gYmVjYXVzZSBpdCBjYW4gY2F1c2UgbXV0YXRpb24uIEJ1dCBqdXN0IHRvIGJlIHNhZmUsIHdlIHdhbnQgdG8gcmVqZWN0IGFsbAogICAgICAgICAgICAgICAgICAgIC8vIHVuZXhwZWN0ZWQgZm9ybXMuCgogICAgICAgICAgICAgICAgICAgIC8vIFdlIHNwbGl0IHRoZSBmaXJzdCBzdGFnZSBpbnRvIDQgcmVnZXhwIG9wZXJhdGlvbnMgaW4gb3JkZXIgdG8gd29yayBhcm91bmQKICAgICAgICAgICAgICAgICAgICAvLyBjcmlwcGxpbmcgaW5lZmZpY2llbmNpZXMgaW4gSUUncyBhbmQgU2FmYXJpJ3MgcmVnZXhwIGVuZ2luZXMuIEZpcnN0IHdlCiAgICAgICAgICAgICAgICAgICAgLy8gcmVwbGFjZSBhbGwgYmFja3NsYXNoIHBhaXJzIHdpdGggJ0AnIChhIG5vbi1KU09OIGNoYXJhY3RlcikuIFNlY29uZCwgd2UKICAgICAgICAgICAgICAgICAgICAvLyByZXBsYWNlIGFsbCBzaW1wbGUgdmFsdWUgdG9rZW5zIHdpdGggJ10nIGNoYXJhY3RlcnMuIFRoaXJkLCB3ZSBkZWxldGUgYWxsCiAgICAgICAgICAgICAgICAgICAgLy8gb3BlbiBicmFja2V0cyB0aGF0IGZvbGxvdyBhIGNvbG9uIG9yIGNvbW1hIG9yIHRoYXQgYmVnaW4gdGhlIHRleHQuIEZpbmFsbHksCiAgICAgICAgICAgICAgICAgICAgLy8gd2UgbG9vayB0byBzZWUgdGhhdCB0aGUgcmVtYWluaW5nIGNoYXJhY3RlcnMgYXJlIG9ubHkgd2hpdGVzcGFjZSBvciAnXScgb3IKICAgICAgICAgICAgICAgICAgICAvLyAnLCcgb3IgJzonIG9yICd7JyBvciAnfScuIElmIHRoYXQgaXMgc28sIHRoZW4gdGhlIHRleHQgaXMgc2FmZSBmb3IgZXZhbC4KCiAgICAgICAgICAgICAgICAgICAgaWYgKC9eW1xdLDp7fVxzXSokLy50ZXN0KHRleHQucmVwbGFjZSgvXFxbIlxcXC9iZm5ydHVdL2csICdAJykucmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykucmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJykpKSB7CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBJbiB0aGUgc2Vjb25kIHN0YWdlIHdlIHVzZSB0aGUgZXZhbCBmdW5jdGlvbiB0byBjb21waWxlIHRoZSB0ZXh0IGludG8gYQogICAgICAgICAgICAgICAgICAgICAgICAvLyBKYXZhU2NyaXB0IHN0cnVjdHVyZS4gVGhlICd7JyBvcGVyYXRvciBpcyBzdWJqZWN0IHRvIGEgc3ludGFjdGljIGFtYmlndWl0eQogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBKYXZhU2NyaXB0OiBpdCBjYW4gYmVnaW4gYSBibG9jayBvciBhbiBvYmplY3QgbGl0ZXJhbC4gV2Ugd3JhcCB0aGUgdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAvLyBpbiBwYXJlbnMgdG8gZWxpbWluYXRlIHRoZSBhbWJpZ3VpdHkuCgogICAgICAgICAgICAgICAgICAgICAgICBqID0gZXZhbCgnKCcgKyB0ZXh0ICsgJyknKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIEluIHRoZSBvcHRpb25hbCB0aGlyZCBzdGFnZSwgd2UgcmVjdXJzaXZlbHkgd2FsayB0aGUgbmV3IHN0cnVjdHVyZSwgcGFzc2luZwogICAgICAgICAgICAgICAgICAgICAgICAvLyBlYWNoIG5hbWUvdmFsdWUgcGFpciB0byBhIHJldml2ZXIgZnVuY3Rpb24gZm9yIHBvc3NpYmxlIHRyYW5zZm9ybWF0aW9uLgoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiByZXZpdmVyID09PSAnZnVuY3Rpb24nID8KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdhbGsoewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICcnOiBqCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCAnJykgOiBqOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gSWYgdGhlIHRleHQgaXMgbm90IEpTT04gcGFyc2VhYmxlLCB0aGVuIGEgU3ludGF4RXJyb3IgaXMgdGhyb3duLgoKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoJ0pTT04ucGFyc2UnKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgcXVvdGU6IHF1b3RlCiAgICAgICAgICAgIH07CiAgICAgICAgfSgpOwogICAgfQoKICAgIC8vanNvbiBlbmQKCiAgICAvL3BlcnNpc3QtbWluIHN0YXJ0CgogICAgKGZ1bmN0aW9uKCkgewogICAgICAgIGlmICh3aW5kb3cuZ29vZ2xlICYmIGdvb2dsZS5nZWFycykKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIHZhciBGID0gbnVsbDsKICAgICAgICBpZiAodHlwZW9mIEdlYXJzRmFjdG9yeSAhPSAndW5kZWZpbmVkJykgewogICAgICAgICAgICBGID0gbmV3IEdlYXJzRmFjdG9yeSgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBGID0gbmV3IEFjdGl2ZVhPYmplY3QoJ0dlYXJzLkZhY3RvcnknKTsKICAgICAgICAgICAgICAgIGlmIChGLmdldEJ1aWxkSW5mbygpLmluZGV4T2YoJ2llX21vYmlsZScpICE9IC0xKQogICAgICAgICAgICAgICAgICAgIEYucHJpdmF0ZVNldEdsb2JhbE9iamVjdCh0aGlzKTsKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgaWYgKCh0eXBlb2YgbmF2aWdhdG9yLm1pbWVUeXBlcyAhPSAndW5kZWZpbmVkJykgJiYgbmF2aWdhdG9yLm1pbWVUeXBlc1siYXBwbGljYXRpb24veC1nb29nbGVnZWFycyJdKSB7CiAgICAgICAgICAgICAgICAgICAgRiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9iamVjdCIpOwogICAgICAgICAgICAgICAgICAgIEYuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgICAgICBGLndpZHRoID0gMDsKICAgICAgICAgICAgICAgICAgICBGLmhlaWdodCA9IDA7CiAgICAgICAgICAgICAgICAgICAgRi50eXBlID0gImFwcGxpY2F0aW9uL3gtZ29vZ2xlZ2VhcnMiOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZChGKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIUYpCiAgICAgICAgICAgIHJldHVybjsKICAgICAgICBpZiAoIXdpbmRvdy5nb29nbGUpCiAgICAgICAgICAgIGdvb2dsZSA9IHt9OwogICAgICAgIGlmICghZ29vZ2xlLmdlYXJzKQogICAgICAgICAgICBnb29nbGUuZ2VhcnMgPSB7CiAgICAgICAgICAgICAgICBmYWN0b3J5OiBGCiAgICAgICAgICAgIH07CiAgICB9KSgpOwogICAgUGVyc2lzdCA9IChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgVkVSU0lPTiA9ICcwLjIuMCcsCiAgICAgICAgICAgIFAsIEIsIGVzYywgaW5pdCwgZW1wdHksIGVjOwogICAgICAgIGVjID0gKGZ1bmN0aW9uKCkgewogICAgICAgICAgICB2YXIgRVBPQ0ggPSAnVGh1LCAwMS1KYW4tMTk3MCAwMDowMDowMSBHTVQnLAogICAgICAgICAgICAgICAgUkFUSU8gPSAxMDAwICogNjAgKiA2MCAqIDI0LAogICAgICAgICAgICAgICAgS0VZUyA9IFsnZXhwaXJlcycsICdwYXRoJywgJ2RvbWFpbiddLAogICAgICAgICAgICAgICAgZXNjID0gZXNjYXBlLAogICAgICAgICAgICAgICAgdW4gPSB1bmVzY2FwZSwKICAgICAgICAgICAgICAgIGRvYyA9IGRvY3VtZW50LAogICAgICAgICAgICAgICAgbWU7CiAgICAgICAgICAgIHZhciBnZXRfbm93ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgciA9IG5ldyBEYXRlKCk7CiAgICAgICAgICAgICAgICByLnNldFRpbWUoci5nZXRUaW1lKCkpOwogICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGNvb2tpZnkgPSBmdW5jdGlvbihjX2tleSwgY192YWwpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBrZXksIHZhbCwgciA9IFtdLAogICAgICAgICAgICAgICAgICAgIG9wdCA9IChhcmd1bWVudHMubGVuZ3RoID4gMikgPyBhcmd1bWVudHNbMl0gOiB7fTsKICAgICAgICAgICAgICAgIHIucHVzaChlc2MoY19rZXkpICsgJz0nICsgZXNjKGNfdmFsKSk7CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgS0VZUy5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGtleSA9IEtFWVNbaV07CiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbCA9IG9wdFtrZXldKQogICAgICAgICAgICAgICAgICAgICAgICByLnB1c2goa2V5ICsgJz0nICsgdmFsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHQuc2VjdXJlKQogICAgICAgICAgICAgICAgICAgIHIucHVzaCgnc2VjdXJlJyk7CiAgICAgICAgICAgICAgICByZXR1cm4gci5qb2luKCc7ICcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBhbGl2ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGsgPSAnX19FQ19URVNUX18nLAogICAgICAgICAgICAgICAgICAgIHYgPSBuZXcgRGF0ZSgpOwogICAgICAgICAgICAgICAgdiA9IHYudG9HTVRTdHJpbmcoKTsKICAgICAgICAgICAgICAgIHRoaXMuc2V0KGssIHYpOwogICAgICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gKHRoaXMucmVtb3ZlKGspID09IHYpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW5hYmxlZDsKICAgICAgICAgICAgfQogICAgICAgICAgICBtZSA9IHsKICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb3B0ID0gKGFyZ3VtZW50cy5sZW5ndGggPiAyKSA/IGFyZ3VtZW50c1syXSA6IHt9LCBub3cgPSBnZXRfbm93KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGV4cGlyZV9hdCwgY2ZnID0ge307CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdC5leHBpcmVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG9wdC5leHBpcmVzICo9IFJBVElPOwogICAgICAgICAgICAgICAgICAgICAgICBjZmcuZXhwaXJlcyA9IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgKyBvcHQuZXhwaXJlcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNmZy5leHBpcmVzID0gY2ZnLmV4cGlyZXMudG9HTVRTdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdmFyIGtleXMgPSBbJ3BhdGgnLCAnZG9tYWluJywgJ3NlY3VyZSddOwogICAgICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0W2tleXNbaV1dKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2ZnW2tleXNbaV1dID0gb3B0W2tleXNbaV1dOwogICAgICAgICAgICAgICAgICAgIHZhciByID0gY29va2lmeShrZXksIHZhbCwgY2ZnKTsKICAgICAgICAgICAgICAgICAgICBkb2MuY29va2llID0gcjsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGhhczogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAga2V5ID0gZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICAgICAgICAgICAgICBvZnMgPSBjLmluZGV4T2Yoa2V5ICsgJz0nKSwKICAgICAgICAgICAgICAgICAgICAgICAgbGVuID0gb2ZzICsga2V5Lmxlbmd0aCArIDEsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YiA9IGMuc3Vic3RyaW5nKDAsIGtleS5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAoKCFvZnMgJiYga2V5ICE9IHN1YikgfHwgb2ZzIDwgMCkgPyBmYWxzZSA6IHRydWU7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICB2YXIgYyA9IGRvYy5jb29raWUsCiAgICAgICAgICAgICAgICAgICAgICAgIG9mcyA9IGMuaW5kZXhPZihrZXkgKyAnPScpLAogICAgICAgICAgICAgICAgICAgICAgICBsZW4gPSBvZnMgKyBrZXkubGVuZ3RoICsgMSwKICAgICAgICAgICAgICAgICAgICAgICAgc3ViID0gYy5zdWJzdHJpbmcoMCwga2V5Lmxlbmd0aCksCiAgICAgICAgICAgICAgICAgICAgICAgIGVuZDsKICAgICAgICAgICAgICAgICAgICBpZiAoKCFvZnMgJiYga2V5ICE9IHN1YikgfHwgb2ZzIDwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgICAgICAgICAgICAgICAgZW5kID0gYy5pbmRleE9mKCc7JywgbGVuKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZW5kIDwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgZW5kID0gYy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVuKGMuc3Vic3RyaW5nKGxlbiwgZW5kKSk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHIgPSBtZS5nZXQoayksCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4cGlyZXM6IEVQT0NICiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgZG9jLmNvb2tpZSA9IGNvb2tpZnkoaywgJycsIG9wdCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAga2V5czogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICAgICAgICAgICAgICBwcyA9IGMuc3BsaXQoJzsgJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGksIHAsIHIgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcCA9IHBzW2ldLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHIucHVzaCh1bihwWzBdKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGFsbDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGMgPSBkb2MuY29va2llLAogICAgICAgICAgICAgICAgICAgICAgICBwcyA9IGMuc3BsaXQoJzsgJyksCiAgICAgICAgICAgICAgICAgICAgICAgIGksIHAsIHIgPSBbXTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgcHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgcCA9IHBzW2ldLnNwbGl0KCc9Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHIucHVzaChbdW4ocFswXSksIHVuKHBbMV0pXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiByOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHZlcnNpb246ICcwLjIuMScsCiAgICAgICAgICAgICAgICBlbmFibGVkOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgICAgICBtZS5lbmFibGVkID0gYWxpdmUuY2FsbChtZSk7CiAgICAgICAgICAgIHJldHVybiBtZTsKICAgICAgICB9KCkpOwogICAgICAgIHZhciBpbmRleF9vZiA9IChmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKEFycmF5LnByb3RvdHlwZS5pbmRleE9mKQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyeSwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEFycmF5LnByb3RvdHlwZS5pbmRleE9mLmNhbGwoYXJ5LCB2YWwpOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGFyeSwgdmFsKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGksIGw7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IGFyeS5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhcnlbaV0gPT0gdmFsKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICAgICAgfTsKICAgICAgICB9KSgpOwogICAgICAgIGVtcHR5ID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICBlc2MgPSBmdW5jdGlvbihzdHIpIHsKICAgICAgICAgICAgcmV0dXJuICdQUycgKyBzdHIucmVwbGFjZSgvXy9nLCAnX18nKS5yZXBsYWNlKC8gL2csICdfcycpOwogICAgICAgIH07CiAgICAgICAgQyA9IHsKICAgICAgICAgICAgc2VhcmNoX29yZGVyOiBbJ2xvY2Fsc3RvcmFnZScsICd3aGF0d2dfZGInLCAnZ2xvYmFsc3RvcmFnZScsICdnZWFycycsICdpZScsICdmbGFzaCcsICdjb29raWUnXSwKICAgICAgICAgICAgbmFtZV9yZTogL15bYS16XVthLXowLTlfIC1dKyQvaSwKICAgICAgICAgICAgbWV0aG9kczogWydpbml0JywgJ2dldCcsICdzZXQnLCAncmVtb3ZlJywgJ2xvYWQnLCAnc2F2ZSddLAogICAgICAgICAgICBzcWw6IHsKICAgICAgICAgICAgICAgIHZlcnNpb246ICcxJywKICAgICAgICAgICAgICAgIGNyZWF0ZTogIkNSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIHBlcnNpc3RfZGF0YSAoayBURVhUIFVOSVFVRSBOT1QgTlVMTCBQUklNQVJZIEtFWSwgdiBURVhUIE5PVCBOVUxMKSIsCiAgICAgICAgICAgICAgICBnZXQ6ICJTRUxFQ1QgdiBGUk9NIHBlcnNpc3RfZGF0YSBXSEVSRSBrID0gPyIsCiAgICAgICAgICAgICAgICBzZXQ6ICJJTlNFUlQgSU5UTyBwZXJzaXN0X2RhdGEoaywgdikgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgICAgICAgICByZW1vdmU6ICJERUxFVEUgRlJPTSBwZXJzaXN0X2RhdGEgV0hFUkUgayA9ID8iCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZsYXNoOiB7CiAgICAgICAgICAgICAgICBkaXZfaWQ6ICdfcGVyc2lzdF9mbGFzaF93cmFwJywKICAgICAgICAgICAgICAgIGlkOiAnX3BlcnNpc3RfZmxhc2gnLAogICAgICAgICAgICAgICAgcGF0aDogJ3BlcnNpc3Quc3dmJywKICAgICAgICAgICAgICAgIHNpemU6IHsKICAgICAgICAgICAgICAgICAgICB3OiAxLAogICAgICAgICAgICAgICAgICAgIGg6IDEKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhcmdzOiB7CiAgICAgICAgICAgICAgICAgICAgYXV0b3N0YXJ0OiB0cnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIEIgPSB7CiAgICAgICAgICAgIGdlYXJzOiB7CiAgICAgICAgICAgICAgICBzaXplOiAtMSwKICAgICAgICAgICAgICAgIHRlc3Q6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIHRyeXsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAod2luZG93Lmdvb2dsZSAmJiB3aW5kb3cuZ29vZ2xlLmdlYXJzKSA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICB0cmFuc2FjdGlvbjogZnVuY3Rpb24oZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRiID0gdGhpcy5kYjsKICAgICAgICAgICAgICAgICAgICAgICAgZGIuZXhlY3V0ZSgnQkVHSU4nKS5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHRoaXMsIGRiKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGIuZXhlY3V0ZSgnQ09NTUlUJykuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGI7CiAgICAgICAgICAgICAgICAgICAgICAgIGRiID0gdGhpcy5kYiA9IGdvb2dsZS5nZWFycy5mYWN0b3J5LmNyZWF0ZSgnYmV0YS5kYXRhYmFzZScpOwogICAgICAgICAgICAgICAgICAgICAgICBkYi5vcGVuKGVzYyh0aGlzLm5hbWUpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZGIuZXhlY3V0ZShDLnNxbC5jcmVhdGUpLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciByLCBzcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGlzX3ZhbGlkLCB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gdC5leGVjdXRlKHNxbCwgW2tleV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfdmFsaWQgPSByLmlzVmFsaWRSb3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGlzX3ZhbGlkID8gci5maWVsZCgwKSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIGlzX3ZhbGlkLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcm1fc3FsID0gQy5zcWwucmVtb3ZlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3FsID0gQy5zcWwuc2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcjsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmV4ZWN1dGUocm1fc3FsLCBba2V5XSkuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZShzcWwsIFtrZXksIHZhbF0pLmNsb3NlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGdldF9zcWwgPSBDLnNxbC5nZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHNxbCA9IEMuc3FsLnJlbW92ZSwgciwgdmFsID0gbnVsbCwgaXNfdmFsaWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50cmFuc2FjdGlvbihmdW5jdGlvbih0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByID0gdC5leGVjdXRlKGdldF9zcWwsIFtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc192YWxpZCA9IHIuaXNWYWxpZFJvdygpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbCA9IGlzX3ZhbGlkID8gci5maWVsZCgwKSA6IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgci5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFmbiB8fCBpc192YWxpZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZShzcWwsIFtrZXldKS5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgaXNfdmFsaWQsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgd2hhdHdnX2RiOiB7CiAgICAgICAgICAgICAgICBzaXplOiAyMDAgKiAxMDI0LAogICAgICAgICAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSAnUGVyc2lzdEpTIFRlc3QnLAogICAgICAgICAgICAgICAgICAgICAgICBkZXNjID0gJ1BlcnNpc3RlbnQgZGF0YWJhc2UgdGVzdC4nOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXdpbmRvdy5vcGVuRGF0YWJhc2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghd2luZG93Lm9wZW5EYXRhYmFzZShuYW1lLCBDLnNxbC52ZXJzaW9uLCBkZXNjLCBCLndoYXR3Z19kYi5zaXplKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb246IGZ1bmN0aW9uKGZuKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5kYl9jcmVhdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRiLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0LmV4ZWN1dGVTcWwoQy5zcWwuY3JlYXRlLCBbXSwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZGJfY3JlYXRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LCBlbXB0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYi50cmFuc2FjdGlvbihmbik7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kYiA9IG9wZW5EYXRhYmFzZSh0aGlzLm5hbWUsIEMuc3FsLnZlcnNpb24sIHRoaXMuby5hYm91dCB8fCAoIlBlcnNpc3RlbnQgc3RvcmFnZSBmb3IgIiArIHRoaXMubmFtZSksIHRoaXMuby5zaXplIHx8IEIud2hhdHdnX2RiLnNpemUpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3FsID0gQy5zcWwuZ2V0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBzY29wZSA9IHNjb3BlIHx8IHRoaXM7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleV0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoci5yb3dzLmxlbmd0aCA+IDApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUsIHRydWUsIHIucm93cy5pdGVtKDApWyd2J10pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSwgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBybV9zcWwgPSBDLnNxbC5yZW1vdmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzcWwgPSBDLnNxbC5zZXQ7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudHJhbnNhY3Rpb24oZnVuY3Rpb24odCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHJtX3NxbCwgW2tleV0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXksIHZhbF0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZ2V0X3NxbCA9IEMuc3FsLmdldDsKICAgICAgICAgICAgICAgICAgICAgICAgc3FsID0gQy5zcWwucmVtb3ZlOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnRyYW5zYWN0aW9uKGZ1bmN0aW9uKHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChnZXRfc3FsLCBba2V5XSwgZnVuY3Rpb24odCwgcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoci5yb3dzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWwgPSByLnJvd3MuaXRlbSgwKVsndiddOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdC5leGVjdXRlU3FsKHNxbCwgW2tleV0sIGZ1bmN0aW9uKHQsIHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgZmFsc2UsIG51bGwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHQuZXhlY3V0ZVNxbChzcWwsIFtrZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBnbG9iYWxzdG9yYWdlOiB7CiAgICAgICAgICAgICAgICBzaXplOiA1ICogMTAyNCAqIDEwMjQsCiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93Lmdsb2JhbFN0b3JhZ2UgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzYyh0aGlzLm5hbWUpICsgZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ2RvbWFpbiA9ICcgKyB0aGlzLm8uZG9tYWluKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZSA9IGdsb2JhbFN0b3JhZ2VbdGhpcy5vLmRvbWFpbl07CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdGhpcy5zdG9yZS5nZXRJdGVtKGtleSkpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IHRoaXMua2V5KGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcmUuc2V0SXRlbShrZXksIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHJlbW92ZTogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gdGhpcy5zdG9yZVtrZXldOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0b3JlLnJlbW92ZUl0ZW0oa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCAodmFsICE9PSBudWxsKSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGxvY2Fsc3RvcmFnZTogewogICAgICAgICAgICAgICAgc2l6ZTogLTEsCiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3cubG9jYWxTdG9yYWdlID8gdHJ1ZSA6IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH1jYXRjaChlKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgICAgICAgICAga2V5OiBmdW5jdGlvbihrZXkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVzYyh0aGlzLm5hbWUpICsgZXNjKGtleSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZSA9IGxvY2FsU3RvcmFnZTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB0aGlzLnN0b3JlLmdldEl0ZW0oa2V5KSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5zZXRJdGVtKGtleSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB0cnVlLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgcmVtb3ZlOiBmdW5jdGlvbihrZXksIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsOwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSB0aGlzLmtleShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLnN0b3JlLmdldEl0ZW0oa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yZS5yZW1vdmVJdGVtKGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgKHZhbCAhPT0gbnVsbCksIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBpZTogewogICAgICAgICAgICAgICAgcHJlZml4OiAnX3BlcnNpc3RfZGF0YS0nLAogICAgICAgICAgICAgICAgc2l6ZTogNjQgKiAxMDI0LAogICAgICAgICAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93LkFjdGl2ZVhPYmplY3QgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ha2VfdXNlcmRhdGE6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgZWwuaWQgPSBpZDsKICAgICAgICAgICAgICAgICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICAgICAgICAgIGVsLmFkZEJlaGF2aW9yKCcjZGVmYXVsdCN1c2VyZGF0YScpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoZWwpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBlbDsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBtZXRob2RzOiB7CiAgICAgICAgICAgICAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpZCA9IEIuaWUucHJlZml4ICsgZXNjKHRoaXMubmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWwgPSBCLmllLm1ha2VfdXNlcmRhdGEoaWQpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5vLmRlZmVyKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2FkKCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCA/IHRydWUgOiBmYWxzZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIHNldDogZnVuY3Rpb24oa2V5LCB2YWwsIGZuLCBzY29wZSkgewogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbC5zZXRBdHRyaWJ1dGUoa2V5LCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubG9hZCgpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldEF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLnJlbW92ZUF0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuby5kZWZlcikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHZhbCA/IHRydWUgOiBmYWxzZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVsLmxvYWQoZXNjKHRoaXMubmFtZSkpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2F2ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuZWwuc2F2ZShlc2ModGhpcy5uYW1lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgICAgICBjb29raWU6IHsKICAgICAgICAgICAgICAgIGRlbGltOiAnOicsCiAgICAgICAgICAgICAgICBzaXplOiA0MDAwLAogICAgICAgICAgICAgICAgdGVzdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdHJ5ewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUC5Db29raWUuZW5hYmxlZCA/IHRydWUgOiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9Y2F0Y2goZSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgbWV0aG9kczogewogICAgICAgICAgICAgICAgICAgIGtleTogZnVuY3Rpb24oa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm5hbWUgKyBCLmNvb2tpZS5kZWxpbSArIGtleTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGdldDogZnVuY3Rpb24oa2V5LCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZWMuZ2V0KGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsICE9IG51bGwsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgZWMuc2V0KGtleSwgdmFsLCB0aGlzLm8pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgdmFsLCBmbiwgc2NvcGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbDsKICAgICAgICAgICAgICAgICAgICAgICAga2V5ID0gdGhpcy5rZXkoa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsID0gZWMucmVtb3ZlKGtleSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZuKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4uY2FsbChzY29wZSB8fCB0aGlzLCB2YWwgIT0gbnVsbCwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGZsYXNoOiB7CiAgICAgICAgICAgICAgICB0ZXN0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0cnl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZGVjb25jZXB0IHx8ICFkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbWFqb3IgPSBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5nZXRQbGF5ZXJWZXJzaW9uKCkubWFqb3I7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAobWFqb3IgPj0gOCkgPyB0cnVlIDogZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfWNhdGNoKGUpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG1ldGhvZHM6IHsKICAgICAgICAgICAgICAgICAgICBpbml0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFCLmZsYXNoLmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbywga2V5LCBlbCwgY2ZnID0gQy5mbGFzaDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbC5pZCA9IGNmZy5kaXZfaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGVsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8gPSBuZXcgZGVjb25jZXB0LlNXRk9iamVjdCh0aGlzLm8uc3dmX3BhdGggfHwgY2ZnLnBhdGgsIGNmZy5pZCwgY2ZnLnNpemUudywgY2ZnLnNpemUuaCwgJzgnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoa2V5IGluIGNmZy5hcmdzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8uYWRkVmFyaWFibGUoa2V5LCBjZmcuYXJnc1trZXldKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG8ud3JpdGUoZWwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgQi5mbGFzaC5lbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGNmZy5pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5lbCA9IEIuZmxhc2guZWw7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBnZXQ6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmVsLmdldCh0aGlzLm5hbWUsIGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdmFsICE9PSBudWxsLCB2YWwpOwogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbCwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBvbGRfdmFsOwogICAgICAgICAgICAgICAgICAgICAgICBrZXkgPSBlc2Moa2V5KTsKICAgICAgICAgICAgICAgICAgICAgICAgb2xkX3ZhbCA9IHRoaXMuZWwuc2V0KHRoaXMubmFtZSwga2V5LCB2YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZm4pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbi5jYWxsKHNjb3BlIHx8IHRoaXMsIHRydWUsIHZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGtleSwgZm4sIHNjb3BlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB2YWw7CiAgICAgICAgICAgICAgICAgICAgICAgIGtleSA9IGVzYyhrZXkpOwogICAgICAgICAgICAgICAgICAgICAgICB2YWwgPSB0aGlzLmVsLnJlbW92ZSh0aGlzLm5hbWUsIGtleSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChmbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuLmNhbGwoc2NvcGUgfHwgdGhpcywgdHJ1ZSwgdmFsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHZhciBpbml0ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciBpLCBsLCBiLCBrZXksIGZucyA9IEMubWV0aG9kcywKICAgICAgICAgICAgICAgIGtleXMgPSBDLnNlYXJjaF9vcmRlcjsKICAgICAgICAgICAgZm9yIChpID0gMCwgbCA9IGZucy5sZW5ndGg7IGkgPCBsOyBpKyspCiAgICAgICAgICAgICAgICBQLlN0b3JlLnByb3RvdHlwZVtmbnNbaV1dID0gZW1wdHk7CiAgICAgICAgICAgIFAudHlwZSA9IG51bGw7CiAgICAgICAgICAgIFAuc2l6ZSA9IC0xOwogICAgICAgICAgICBmb3IgKGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7ICFQLnR5cGUgJiYgaSA8IGw7IGkrKykgewogICAgICAgICAgICAgICAgYiA9IEJba2V5c1tpXV07CiAgICAgICAgICAgICAgICBpZiAoYi50ZXN0KCkpIHsKICAgICAgICAgICAgICAgICAgICBQLnR5cGUgPSBrZXlzW2ldOwogICAgICAgICAgICAgICAgICAgIFAuc2l6ZSA9IGIuc2l6ZTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGtleSBpbiBiLm1ldGhvZHMpCiAgICAgICAgICAgICAgICAgICAgICAgIFAuU3RvcmUucHJvdG90eXBlW2tleV0gPSBiLm1ldGhvZHNba2V5XTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBQLl9pbml0ID0gdHJ1ZTsKICAgICAgICB9OwogICAgICAgIFAgPSB7CiAgICAgICAgICAgIFZFUlNJT046IFZFUlNJT04sCiAgICAgICAgICAgIHR5cGU6IG51bGwsCiAgICAgICAgICAgIHNpemU6IDAsCiAgICAgICAgICAgIGFkZDogZnVuY3Rpb24obykgewogICAgICAgICAgICAgICAgQltvLmlkXSA9IG87CiAgICAgICAgICAgICAgICBDLnNlYXJjaF9vcmRlciA9IFtvLmlkXS5jb25jYXQoQy5zZWFyY2hfb3JkZXIpOwogICAgICAgICAgICAgICAgaW5pdCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICAgICAgICB2YXIgb2ZzID0gaW5kZXhfb2YoQy5zZWFyY2hfb3JkZXIsIGlkKTsKICAgICAgICAgICAgICAgIGlmIChvZnMgPCAwKQogICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIEMuc2VhcmNoX29yZGVyLnNwbGljZShvZnMsIDEpOwogICAgICAgICAgICAgICAgZGVsZXRlIEJbaWRdOwogICAgICAgICAgICAgICAgaW5pdCgpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBDb29raWU6IGVjLAogICAgICAgICAgICBTdG9yZTogZnVuY3Rpb24obmFtZSwgbykgewogICAgICAgICAgICAgICAgaWYgKCFDLm5hbWVfcmUuZXhlYyhuYW1lKSkKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkludmFsaWQgbmFtZSIpOwogICAgICAgICAgICAgICAgaWYgKCFQLnR5cGUpCiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJObyBzdWl0YWJsZSBzdG9yYWdlIGZvdW5kIik7CiAgICAgICAgICAgICAgICBvID0gbyB8fCB7fTsKICAgICAgICAgICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBvLmRvbWFpbiA9IG8uZG9tYWluIHx8IGxvY2F0aW9uLmhvc3QgfHwgJ2xvY2FsaG9zdCc7CiAgICAgICAgICAgICAgICBvLmRvbWFpbiA9IG8uZG9tYWluLnJlcGxhY2UoLzpcZCskLywgJycpCiAgICAgICAgICAgICAgICB0aGlzLm8gPSBvOwogICAgICAgICAgICAgICAgby5leHBpcmVzID0gby5leHBpcmVzIHx8IDM2NSAqIDI7CiAgICAgICAgICAgICAgICBvLnBhdGggPSBvLnBhdGggfHwgJy8nOwogICAgICAgICAgICAgICAgdGhpcy5pbml0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGluaXQoKTsKICAgICAgICByZXR1cm4gUDsKICAgIH0pKCk7CiAgICAvL3BlcnNpc3QtbWluIGVuZAoKICAgIC8vc3dmb2JqZWN0LW1pbiBzdGFydAoKICAgIGlmICh0eXBlb2YgZGVjb25jZXB0ID09ICJ1bmRlZmluZWQiKSB2YXIgZGVjb25jZXB0ID0gbmV3IE9iamVjdCgpOwogICAgaWYgKHR5cGVvZiBkZWNvbmNlcHQudXRpbCA9PSAidW5kZWZpbmVkIikgZGVjb25jZXB0LnV0aWwgPSBuZXcgT2JqZWN0KCk7CiAgICBpZiAodHlwZW9mIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsID09ICJ1bmRlZmluZWQiKSBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbCA9IG5ldyBPYmplY3QoKTsKICAgIGRlY29uY2VwdC5TV0ZPYmplY3QgPSBmdW5jdGlvbihzd2YsIGlkLCB3LCBoLCB2ZXIsIGMsIHF1YWxpdHksIHhpUmVkaXJlY3RVcmwsIHJlZGlyZWN0VXJsLCBkZXRlY3RLZXkpIHsKICAgICAgICBpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5ERVRFQ1RfS0VZID0gZGV0ZWN0S2V5ID8gZGV0ZWN0S2V5IDogJ2RldGVjdGZsYXNoJzsKICAgICAgICB0aGlzLnNraXBEZXRlY3QgPSBkZWNvbmNlcHQudXRpbC5nZXRSZXF1ZXN0UGFyYW1ldGVyKHRoaXMuREVURUNUX0tFWSk7CiAgICAgICAgdGhpcy5wYXJhbXMgPSBuZXcgT2JqZWN0KCk7CiAgICAgICAgdGhpcy52YXJpYWJsZXMgPSBuZXcgT2JqZWN0KCk7CiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzID0gbmV3IEFycmF5KCk7CiAgICAgICAgaWYgKHN3ZikgewogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3dmJywgc3dmKTsKICAgICAgICB9CiAgICAgICAgaWYgKGlkKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdpZCcsIGlkKTsKICAgICAgICB9CiAgICAgICAgaWYgKHcpIHsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3dpZHRoJywgdyk7CiAgICAgICAgfQogICAgICAgIGlmIChoKSB7CiAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdoZWlnaHQnLCBoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZlcikgewogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgndmVyc2lvbicsIG5ldyBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbih2ZXIudG9TdHJpbmcoKS5zcGxpdCgiLiIpKSk7CiAgICAgICAgfQogICAgICAgIHRoaXMuaW5zdGFsbGVkVmVyID0gZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuZ2V0UGxheWVyVmVyc2lvbigpOwogICAgICAgIGlmICghd2luZG93Lm9wZXJhICYmIGRvY3VtZW50LmFsbCAmJiB0aGlzLmluc3RhbGxlZFZlci5tYWpvciA+IDcpIHsKICAgICAgICAgICAgZGVjb25jZXB0LlNXRk9iamVjdC5kb1ByZXBVbmxvYWQgPSB0cnVlOwogICAgICAgIH0KICAgICAgICBpZiAoYykgewogICAgICAgICAgICB0aGlzLmFkZFBhcmFtKCdiZ2NvbG9yJywgYyk7CiAgICAgICAgfQogICAgICAgIHZhciBxID0gcXVhbGl0eSA/IHF1YWxpdHkgOiAnaGlnaCc7CiAgICAgICAgdGhpcy5hZGRQYXJhbSgncXVhbGl0eScsIHEpOwogICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCd1c2VFeHByZXNzSW5zdGFsbCcsIGZhbHNlKTsKICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnZG9FeHByZXNzSW5zdGFsbCcsIGZhbHNlKTsKICAgICAgICB2YXIgeGlyID0gKHhpUmVkaXJlY3RVcmwpID8geGlSZWRpcmVjdFVybCA6IHdpbmRvdy5sb2NhdGlvbjsKICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgneGlSZWRpcmVjdFVybCcsIHhpcik7CiAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJywgJycpOwogICAgICAgIGlmIChyZWRpcmVjdFVybCkgewogICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgncmVkaXJlY3RVcmwnLCByZWRpcmVjdFVybCk7CiAgICAgICAgfQogICAgfQogICAgZGVjb25jZXB0LlNXRk9iamVjdC5wcm90b3R5cGUgPSB7CiAgICAgICAgdXNlRXhwcmVzc0luc3RhbGw6IGZ1bmN0aW9uKHBhdGgpIHsKICAgICAgICAgICAgdGhpcy54aVNXRlBhdGggPSAhcGF0aCA/ICJleHByZXNzaW5zdGFsbC5zd2YiIDogcGF0aDsKICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoJ3VzZUV4cHJlc3NJbnN0YWxsJywgdHJ1ZSk7CiAgICAgICAgfSwKICAgICAgICBzZXRBdHRyaWJ1dGU6IGZ1bmN0aW9uKG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuYXR0cmlidXRlc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgZ2V0QXR0cmlidXRlOiBmdW5jdGlvbihuYW1lKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CiAgICAgICAgfSwKICAgICAgICBhZGRQYXJhbTogZnVuY3Rpb24obmFtZSwgdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5wYXJhbXNbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9LAogICAgICAgIGdldFBhcmFtczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcmFtczsKICAgICAgICB9LAogICAgICAgIGFkZFZhcmlhYmxlOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSkgewogICAgICAgICAgICB0aGlzLnZhcmlhYmxlc1tuYW1lXSA9IHZhbHVlOwogICAgICAgIH0sCiAgICAgICAgZ2V0VmFyaWFibGU6IGZ1bmN0aW9uKG5hbWUpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFyaWFibGVzW25hbWVdOwogICAgICAgIH0sCiAgICAgICAgZ2V0VmFyaWFibGVzOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIHRoaXMudmFyaWFibGVzOwogICAgICAgIH0sCiAgICAgICAgZ2V0VmFyaWFibGVQYWlyczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHZhciB2YXJpYWJsZVBhaXJzID0gbmV3IEFycmF5KCk7CiAgICAgICAgICAgIHZhciBrZXk7CiAgICAgICAgICAgIHZhciB2YXJpYWJsZXMgPSB0aGlzLmdldFZhcmlhYmxlcygpOwogICAgICAgICAgICBmb3IgKGtleSBpbiB2YXJpYWJsZXMpIHsKICAgICAgICAgICAgICAgIHZhcmlhYmxlUGFpcnMucHVzaChrZXkgKyAiPSIgKyB2YXJpYWJsZXNba2V5XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHZhcmlhYmxlUGFpcnM7CiAgICAgICAgfSwKICAgICAgICBnZXRTV0ZIVE1MOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdmFyIHN3Zk5vZGUgPSAiIjsKICAgICAgICAgICAgaWYgKG5hdmlnYXRvci5wbHVnaW5zICYmIG5hdmlnYXRvci5taW1lVHlwZXMgJiYgbmF2aWdhdG9yLm1pbWVUeXBlcy5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgiZG9FeHByZXNzSW5zdGFsbCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1wbGF5ZXJUeXBlIiwgIlBsdWdJbiIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0QXR0cmlidXRlKCdzd2YnLCB0aGlzLnhpU1dGUGF0aCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzd2ZOb2RlID0gJzxlbWJlZCB0eXBlPSJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCIgc3JjPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3N3ZicpICsgJyIgd2lkdGg9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSArICciIGhlaWdodD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdoZWlnaHQnKSArICciJzsKICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gJyBpZD0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdpZCcpICsgJyIgbmFtZT0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdpZCcpICsgJyIgJzsKICAgICAgICAgICAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gW2tleV0gKyAnPSInICsgcGFyYW1zW2tleV0gKyAnIiAnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdmFyIHBhaXJzID0gdGhpcy5nZXRWYXJpYWJsZVBhaXJzKCkuam9pbigiJiIpOwogICAgICAgICAgICAgICAgaWYgKHBhaXJzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBzd2ZOb2RlICs9ICdmbGFzaHZhcnM9IicgKyBwYWlycyArICciJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gJy8+JzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgiZG9FeHByZXNzSW5zdGFsbCIpKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRWYXJpYWJsZSgiTU1wbGF5ZXJUeXBlIiwgIkFjdGl2ZVgiKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnc3dmJywgdGhpcy54aVNXRlBhdGgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3dmTm9kZSA9ICc8b2JqZWN0IGlkPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ2lkJykgKyAnIiBjbGFzc2lkPSJjbHNpZDpEMjdDREI2RS1BRTZELTExY2YtOTZCOC00NDQ1NTM1NDAwMDAiIHdpZHRoPSInICsgdGhpcy5nZXRBdHRyaWJ1dGUoJ3dpZHRoJykgKyAnIiBoZWlnaHQ9IicgKyB0aGlzLmdldEF0dHJpYnV0ZSgnaGVpZ2h0JykgKyAnIj4nOwogICAgICAgICAgICAgICAgc3dmTm9kZSArPSAnPHBhcmFtIG5hbWU9Im1vdmllIiB2YWx1ZT0iJyArIHRoaXMuZ2V0QXR0cmlidXRlKCdzd2YnKSArICciIC8+JzsKICAgICAgICAgICAgICAgIHZhciBwYXJhbXMgPSB0aGlzLmdldFBhcmFtcygpOwogICAgICAgICAgICAgICAgZm9yICh2YXIga2V5IGluIHBhcmFtcykgewogICAgICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gJzxwYXJhbSBuYW1lPSInICsga2V5ICsgJyIgdmFsdWU9IicgKyBwYXJhbXNba2V5XSArICciIC8+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBwYWlycyA9IHRoaXMuZ2V0VmFyaWFibGVQYWlycygpLmpvaW4oIiYiKTsKICAgICAgICAgICAgICAgIGlmIChwYWlycy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgc3dmTm9kZSArPSAnPHBhcmFtIG5hbWU9ImZsYXNodmFycyIgdmFsdWU9IicgKyBwYWlycyArICciIC8+JzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN3Zk5vZGUgKz0gIjwvb2JqZWN0PiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN3Zk5vZGU7CiAgICAgICAgfSwKICAgICAgICB3cml0ZTogZnVuY3Rpb24oZWxlbWVudElkKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmdldEF0dHJpYnV0ZSgndXNlRXhwcmVzc0luc3RhbGwnKSkgewogICAgICAgICAgICAgICAgdmFyIGV4cHJlc3NJbnN0YWxsUmVxVmVyID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKFs2LCAwLCA2NV0pOwogICAgICAgICAgICAgICAgaWYgKHRoaXMuaW5zdGFsbGVkVmVyLnZlcnNpb25Jc1ZhbGlkKGV4cHJlc3NJbnN0YWxsUmVxVmVyKSAmJiAhdGhpcy5pbnN0YWxsZWRWZXIudmVyc2lvbklzVmFsaWQodGhpcy5nZXRBdHRyaWJ1dGUoJ3ZlcnNpb24nKSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZSgnZG9FeHByZXNzSW5zdGFsbCcsIHRydWUpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkVmFyaWFibGUoIk1NcmVkaXJlY3RVUkwiLCBlc2NhcGUodGhpcy5nZXRBdHRyaWJ1dGUoJ3hpUmVkaXJlY3RVcmwnKSkpOwogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnRpdGxlID0gZG9jdW1lbnQudGl0bGUuc2xpY2UoMCwgNDcpICsgIiAtIEZsYXNoIFBsYXllciBJbnN0YWxsYXRpb24iOwogICAgICAgICAgICAgICAgICAgIHRoaXMuYWRkVmFyaWFibGUoIk1NZG9jdGl0bGUiLCBkb2N1bWVudC50aXRsZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHRoaXMuc2tpcERldGVjdCB8fCB0aGlzLmdldEF0dHJpYnV0ZSgnZG9FeHByZXNzSW5zdGFsbCcpIHx8IHRoaXMuaW5zdGFsbGVkVmVyLnZlcnNpb25Jc1ZhbGlkKHRoaXMuZ2V0QXR0cmlidXRlKCd2ZXJzaW9uJykpKSB7CiAgICAgICAgICAgICAgICB2YXIgbiA9ICh0eXBlb2YgZWxlbWVudElkID09ICdzdHJpbmcnKSA/IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGVsZW1lbnRJZCkgOiBlbGVtZW50SWQ7CiAgICAgICAgICAgICAgICBuLmlubmVySFRNTCA9IHRoaXMuZ2V0U1dGSFRNTCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAodGhpcy5nZXRBdHRyaWJ1dGUoJ3JlZGlyZWN0VXJsJykgIT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5sb2NhdGlvbi5yZXBsYWNlKHRoaXMuZ2V0QXR0cmlidXRlKCdyZWRpcmVjdFVybCcpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgfQogICAgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuZ2V0UGxheWVyVmVyc2lvbiA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBQbGF5ZXJWZXJzaW9uID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKFswLCAwLCAwXSk7CiAgICAgICAgaWYgKG5hdmlnYXRvci5wbHVnaW5zICYmIG5hdmlnYXRvci5taW1lVHlwZXMubGVuZ3RoKSB7CiAgICAgICAgICAgIHZhciB4ID0gbmF2aWdhdG9yLnBsdWdpbnNbIlNob2Nrd2F2ZSBGbGFzaCJdOwogICAgICAgICAgICBpZiAoeCAmJiB4LmRlc2NyaXB0aW9uKSB7CiAgICAgICAgICAgICAgICBQbGF5ZXJWZXJzaW9uID0gbmV3IGRlY29uY2VwdC5QbGF5ZXJWZXJzaW9uKHguZGVzY3JpcHRpb24ucmVwbGFjZSgvKFthLXpBLVpdfFxzKSsvLCAiIikucmVwbGFjZSgvKFxzK3J8XHMrYlswLTldKykvLCAiLiIpLnNwbGl0KCIuIikpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIHZhciBheG8gPSBuZXcgQWN0aXZlWE9iamVjdCgiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2guNyIpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIHZhciBheG8gPSBuZXcgQWN0aXZlWE9iamVjdCgiU2hvY2t3YXZlRmxhc2guU2hvY2t3YXZlRmxhc2guNiIpOwogICAgICAgICAgICAgICAgICAgIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oWzYsIDAsIDIxXSk7CiAgICAgICAgICAgICAgICAgICAgYXhvLkFsbG93U2NyaXB0QWNjZXNzID0gImFsd2F5cyI7CiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKFBsYXllclZlcnNpb24ubWFqb3IgPT0gNikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gUGxheWVyVmVyc2lvbjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGF4byA9IG5ldyBBY3RpdmVYT2JqZWN0KCJTaG9ja3dhdmVGbGFzaC5TaG9ja3dhdmVGbGFzaCIpOwogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkge30KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoYXhvICE9IG51bGwpIHsKICAgICAgICAgICAgICAgIFBsYXllclZlcnNpb24gPSBuZXcgZGVjb25jZXB0LlBsYXllclZlcnNpb24oYXhvLkdldFZhcmlhYmxlKCIkdmVyc2lvbiIpLnNwbGl0KCIgIilbMV0uc3BsaXQoIiwiKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIFBsYXllclZlcnNpb247CiAgICB9CiAgICBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbiA9IGZ1bmN0aW9uKGFyclZlcnNpb24pIHsKICAgICAgICB0aGlzLm1ham9yID0gYXJyVmVyc2lvblswXSAhPSBudWxsID8gcGFyc2VJbnQoYXJyVmVyc2lvblswXSkgOiAwOwogICAgICAgIHRoaXMubWlub3IgPSBhcnJWZXJzaW9uWzFdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzFdKSA6IDA7CiAgICAgICAgdGhpcy5yZXYgPSBhcnJWZXJzaW9uWzJdICE9IG51bGwgPyBwYXJzZUludChhcnJWZXJzaW9uWzJdKSA6IDA7CiAgICB9CiAgICBkZWNvbmNlcHQuUGxheWVyVmVyc2lvbi5wcm90b3R5cGUudmVyc2lvbklzVmFsaWQgPSBmdW5jdGlvbihmdikgewogICAgICAgIGlmICh0aGlzLm1ham9yIDwgZnYubWFqb3IpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAodGhpcy5tYWpvciA+IGZ2Lm1ham9yKSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZiAodGhpcy5taW5vciA8IGZ2Lm1pbm9yKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKHRoaXMubWlub3IgPiBmdi5taW5vcikgcmV0dXJuIHRydWU7CiAgICAgICAgaWYgKHRoaXMucmV2IDwgZnYucmV2KSByZXR1cm4gZmFsc2U7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICBkZWNvbmNlcHQudXRpbCA9IHsKICAgICAgICBnZXRSZXF1ZXN0UGFyYW1ldGVyOiBmdW5jdGlvbihwYXJhbSkgewogICAgICAgICAgICB2YXIgcSA9IGRvY3VtZW50LmxvY2F0aW9uLnNlYXJjaCB8fCBkb2N1bWVudC5sb2NhdGlvbi5oYXNoOwogICAgICAgICAgICBpZiAocSkgewogICAgICAgICAgICAgICAgdmFyIHBhaXJzID0gcS5zdWJzdHJpbmcoMSkuc3BsaXQoIiYiKTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcGFpcnMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAocGFpcnNbaV0uc3Vic3RyaW5nKDAsIHBhaXJzW2ldLmluZGV4T2YoIj0iKSkgPT0gcGFyYW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBhaXJzW2ldLnN1YnN0cmluZygocGFpcnNbaV0uaW5kZXhPZigiPSIpICsgMSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQogICAgZGVjb25jZXB0LlNXRk9iamVjdFV0aWwuY2xlYW51cFNXRnMgPSBmdW5jdGlvbigpIHsKICAgICAgICB2YXIgb2JqZWN0cyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJPQkpFQ1QiKTsKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG9iamVjdHMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgb2JqZWN0c1tpXS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBmb3IgKHZhciB4IGluIG9iamVjdHNbaV0pIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqZWN0c1tpXVt4XSA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgICAgb2JqZWN0c1tpXVt4XSA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBpZiAoZGVjb25jZXB0LlNXRk9iamVjdC5kb1ByZXBVbmxvYWQpIHsKICAgICAgICBkZWNvbmNlcHQuU1dGT2JqZWN0VXRpbC5wcmVwVW5sb2FkID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIF9fZmxhc2hfdW5sb2FkSGFuZGxlciA9IGZ1bmN0aW9uKCkge307CiAgICAgICAgICAgIF9fZmxhc2hfc2F2ZWRVbmxvYWRIYW5kbGVyID0gZnVuY3Rpb24oKSB7fTsKICAgICAgICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbnVubG9hZCIsIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLmNsZWFudXBTV0ZzKTsKICAgICAgICB9CiAgICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbmJlZm9yZXVubG9hZCIsIGRlY29uY2VwdC5TV0ZPYmplY3RVdGlsLnByZXBVbmxvYWQpOwogICAgfQogICAgaWYgKEFycmF5LnByb3RvdHlwZS5wdXNoID09IG51bGwpIHsKICAgICAgICBBcnJheS5wcm90b3R5cGUucHVzaCA9IGZ1bmN0aW9uKGl0ZW0pIHsKICAgICAgICAgICAgdGhpc1t0aGlzLmxlbmd0aF0gPSBpdGVtOwogICAgICAgICAgICByZXR1cm4gdGhpcy5sZW5ndGg7CiAgICAgICAgfQogICAgfQogICAgdmFyIGdldFF1ZXJ5UGFyYW1WYWx1ZSA9IGRlY29uY2VwdC51dGlsLmdldFJlcXVlc3RQYXJhbWV0ZXI7CiAgICB2YXIgRmxhc2hPYmplY3QgPSBkZWNvbmNlcHQuU1dGT2JqZWN0OwogICAgdmFyIFNXRk9iamVjdCA9IGRlY29uY2VwdC5TV0ZPYmplY3Q7CiAgICAvL3N3Zm9iamVjdC1taW4gZW5kCgogICAgLy8hISFsaWIgZW5kISEhCgogICAgdmFyICRmaCA9IHJvb3QuJGZoIHx8IHt9OwogICAgaWYgKHR5cGVvZiBmaF9hcHBfcHJvcHMgPT09ICJvYmplY3QiKSB7CiAgICAgICAgJGZoLmFwcF9wcm9wcyA9IGZoX2FwcF9wcm9wczsKICAgIH0KCiAgICAkZmgubGVnYWN5ID0ge307CgogICAgdmFyIGRlZmF1bHRhcmdzID0gewogICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgZmFpbHVyZTogZnVuY3Rpb24oKSB7fSwKICAgICAgICBwYXJhbXM6IHt9CiAgICB9OwoKICAgIHZhciBoYW5kbGVhcmdzID0gZnVuY3Rpb24oaW5hcmdzLCBkZWZhdWx0cGFyYW1zLCBhcHBseXRvKSB7CiAgICAgICAgdmFyIG91dGFyZ3MgPSBbbnVsbCwgbnVsbCwgbnVsbF07CiAgICAgICAgdmFyIG9yaWdhcmdzID0gW251bGwsIG51bGwsIG51bGxdOwogICAgICAgIHZhciBudW1hcmdzID0gaW5hcmdzLmxlbmd0aDsKCiAgICAgICAgaWYgKDIgPCBudW1hcmdzKSB7CiAgICAgICAgICAgIG9yaWdhcmdzWzBdID0gaW5hcmdzW251bWFyZ3MgLSAzXTsKICAgICAgICAgICAgb3JpZ2FyZ3NbMV0gPSBpbmFyZ3NbbnVtYXJncyAtIDJdOwogICAgICAgICAgICBvcmlnYXJnc1syXSA9IGluYXJnc1tudW1hcmdzIC0gMV07CiAgICAgICAgfSBlbHNlIGlmICgyID09IG51bWFyZ3MpIHsKICAgICAgICAgICAgb3JpZ2FyZ3NbMV0gPSBpbmFyZ3NbMF07CiAgICAgICAgICAgIG9yaWdhcmdzWzJdID0gaW5hcmdzWzFdOwogICAgICAgIH0gZWxzZSBpZiAoMSA9PSBudW1hcmdzKSB7CiAgICAgICAgICAgIG9yaWdhcmdzWzJdID0gaW5hcmdzWzBdOwogICAgICAgIH0KCiAgICAgICAgdmFyIGkgPSAwLAogICAgICAgICAgICBqID0gMDsKICAgICAgICBmb3IgKDsgaSA8IDM7IGkrKykgewogICAgICAgICAgICB2YXIgYSA9IG9yaWdhcmdzW2ldOwogICAgICAgICAgICB2YXIgdGEgPSB0eXBlb2YgYTsKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnaXRlciBpOicraSsnIGo6JytqKycgdGE6Jyt0YSk7CiAgICAgICAgICAgIGlmIChhICYmIDAgPT0gaiAmJiAoJ29iamVjdCcgPT0gdGEgfHwgJ2Jvb2xlYW4nID09IHRhKSkgewogICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZygnb2JqZWN0IGk6JytpKycgajonK2orJyB0YTonK3RhKTsKICAgICAgICAgICAgICAgIG91dGFyZ3NbaisrXSA9IGE7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSAmJiAnZnVuY3Rpb24nID09IHRhKSB7CiAgICAgICAgICAgICAgICBqID0gMCA9PSBqID8gMSA6IGo7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKCdmdW5jdGlvbiBpOicraSsnIGo6JytqKycgdGE6Jyt0YSk7CiAgICAgICAgICAgICAgICBvdXRhcmdzW2orK10gPSBhOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAobnVsbCA9PSBvdXRhcmdzWzBdKSB7CiAgICAgICAgICAgIG91dGFyZ3NbMF0gPSBkZWZhdWx0cGFyYW1zID8gZGVmYXVsdHBhcmFtcyA6IGRlZmF1bHRhcmdzLnBhcmFtczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgcGFyYW1zYXJnID0gb3V0YXJnc1swXTsKICAgICAgICAgICAgcGFyYW1zYXJnLl9kZWZhdWx0cyA9IFtdOwogICAgICAgICAgICBmb3IgKHZhciBuIGluIGRlZmF1bHRwYXJhbXMpIHsKICAgICAgICAgICAgICAgIGlmIChkZWZhdWx0cGFyYW1zLmhhc093blByb3BlcnR5KG4pKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwYXJhbXNhcmdbbl0gPT09ICJ1bmRlZmluZWQiKSB7IC8vd2UgZG9uJ3Qgd2FudCB0byB1c2UgIXBhcmFtc2FyZ1tuXSBoZXJlIGJlY2F1c2UgdGhlIHBhcmFtZXRlciBjb3VsZCBleGlzdHMgaW4gdGhlIGFyZ3VtZW50IGFuZCBpdCBjb3VsZCBiZSBmYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNhcmdbbl0gPSBkZWZhdWx0cGFyYW1zW25dOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJhbXNhcmcuX2RlZmF1bHRzLnB1c2gobik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBvdXRhcmdzWzFdID0gbnVsbCA9PSBvdXRhcmdzWzFdID8gZGVmYXVsdGFyZ3Muc3VjY2VzcyA6IG91dGFyZ3NbMV07CiAgICAgICAgb3V0YXJnc1syXSA9IG51bGwgPT0gb3V0YXJnc1syXSA/IGRlZmF1bHRhcmdzLmZhaWx1cmUgOiBvdXRhcmdzWzJdOwoKICAgICAgICBhcHBseXRvKG91dGFyZ3NbMF0sIG91dGFyZ3NbMV0sIG91dGFyZ3NbMl0pOwogICAgfQoKICAgIHZhciBldmVudFN1cHBvcnRlZCA9IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgICAgdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpJyk7CiAgICAgICAgcmV0dXJuIGV2ZW50IGluIGVsZW1lbnQgfHwgZWxlbWVudC5zZXRBdHRyaWJ1dGUgJiYgZWxlbWVudC5zZXRBdHRyaWJ1dGUoZXZlbnQsICJyZXR1cm47IikgfHwgZmFsc2U7CiAgICB9CgogICAgdmFyIF9faXNfcmVhZHkgPSBmYWxzZTsKICAgIHZhciBfX3JlYWR5X2xpc3QgPSBbXTsKICAgIHZhciBfX3JlYWR5X2JvdW5kID0gZmFsc2U7CiAgICB2YXIgYm94cHJlZml4ID0gIi9ib3gvc3J2LzEuMS8iOwoKICAgIF9nZXRIb3N0UHJlZml4ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgcmV0dXJuICRmaC5hcHBfcHJvcHMuaG9zdCArIGJveHByZWZpeDsKICAgIH0KCiAgICB2YXIgX19yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmICghX19pc19yZWFkeSkgewogICAgICAgICAgICBfX2lzX3JlYWR5ID0gdHJ1ZTsKICAgICAgICAgICAgaWYgKF9fcmVhZHlfbGlzdCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICB3aGlsZSAoX19yZWFkeV9saXN0WzBdKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIF9fcmVhZHlfbGlzdC5zaGlmdCgpLmFwcGx5KGRvY3VtZW50LCBbXSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgX19yZWFkeV9saXN0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CgogICAgdmFyIF9fYmluZF9yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChfX3JlYWR5X2JvdW5kKSByZXR1cm47CiAgICAgICAgX19yZWFkeV9ib3VuZCA9IHRydWU7CgogICAgICAgIC8vIE1vemlsbGEsIE9wZXJhIGFuZCB3ZWJraXQgbmlnaHRsaWVzIGN1cnJlbnRseSBzdXBwb3J0IHRoaXMgZXZlbnQKICAgICAgICBpZiAoZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcikgewogICAgICAgICAgICAvLyBVc2UgdGhlIGhhbmR5IGV2ZW50IGNhbGxiYWNrCiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCBhcmd1bWVudHMuY2FsbGVlLCBmYWxzZSk7CiAgICAgICAgICAgICAgICBfX3JlYWR5KCk7CiAgICAgICAgICAgIH0sIGZhbHNlKTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJsb2FkIiwgX19yZWFkeSwgZmFsc2UpOwoKICAgICAgICAgICAgLy8gSWYgSUUgZXZlbnQgbW9kZWwgaXMgdXNlZAogICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuYXR0YWNoRXZlbnQpIHsKICAgICAgICAgICAgLy8gZW5zdXJlIGZpcmluZyBiZWZvcmUgb25sb2FkLAogICAgICAgICAgICAvLyBtYXliZSBsYXRlIGJ1dCBzYWZlIGFsc28gZm9yIGlmcmFtZXMKICAgICAgICAgICAgZG9jdW1lbnQuYXR0YWNoRXZlbnQoIm9ucmVhZHlzdGF0ZWNoYW5nZSIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIpIHsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kZXRhY2hFdmVudCgib25yZWFkeXN0YXRlY2hhbmdlIiwgYXJndW1lbnRzLmNhbGxlZSk7CiAgICAgICAgICAgICAgICAgICAgX19yZWFkeSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hdHRhY2hFdmVudCgib25sb2FkIiwgX19yZWFkeSk7CgogICAgICAgICAgICAvLyBJZiBJRSBhbmQgbm90IGFuIGlmcmFtZQogICAgICAgICAgICAvLyBjb250aW51YWxseSBjaGVjayB0byBzZWUgaWYgdGhlIGRvY3VtZW50IGlzIHJlYWR5CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwgJiYgd2luZG93ID09IHdpbmRvdy50b3ApKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKF9faXNfcmVhZHkpIHJldHVybjsKCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIC8vIElmIElFIGlzIHVzZWQsIHVzZSB0aGUgdHJpY2sgYnkgRGllZ28gUGVyaW5pCiAgICAgICAgICAgICAgICAgICAgLy8gaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZG9TY3JvbGwoImxlZnQiKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0VGltZW91dChhcmd1bWVudHMuY2FsbGVlLCAwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYW5kIGV4ZWN1dGUgYW55IHdhaXRpbmcgZnVuY3Rpb25zCiAgICAgICAgICAgICAgICBfX3JlYWR5KCk7CiAgICAgICAgICAgIH0pKCk7CiAgICAgICAgfQogICAgfTsKCiAgICBfX2JpbmRfcmVhZHkoKTsKCiAgICAvLyBkZXN0aW5hdGlvbiBmdW5jdGlvbnMKICAgIHZhciBfbWFwU2NyaXB0TG9hZGVkID0gKHR5cGVvZiBnb29nbGUgIT0gInVuZGVmaW5lZCIpICYmICh0eXBlb2YgZ29vZ2xlLm1hcHMgIT0gInVuZGVmaW5lZCIpICYmICh0eXBlb2YgZ29vZ2xlLm1hcHMuTWFwICE9ICJ1bmRlZmluZWQiKTsKICAgIHZhciBfbG9hZE1hcFNjcmlwdCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzY3JpcHQiKTsKICAgICAgICBzY3JpcHQudHlwZSA9ICJ0ZXh0L2phdmFzY3JpcHQiOwogICAgICAgIHZhciBwcm90b2NvbCA9IGRvY3VtZW50LmxvY2F0aW9uLnByb3RvY29sOwogICAgICAgIHByb3RvY29sID0gKHByb3RvY29sID09PSAiaHR0cDoiIHx8IHByb3RvY29sID09PSAiaHR0cHM6IikgPyBwcm90b2NvbCA6ICJodHRwczoiOwogICAgICAgIHNjcmlwdC5zcmMgPSBwcm90b2NvbCArICIvL21hcHMuZ29vZ2xlLmNvbS9tYXBzL2FwaS9qcz9zZW5zb3I9dHJ1ZSZjYWxsYmFjaz0kZmguX21hcExvYWRlZCI7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzY3JpcHQpOwogICAgfTsKCiAgICB2YXIgYXVkaW9fb2JqID0gbnVsbDsKICAgIHZhciBhdWRpb19pc19wbGF5aW5nID0gZmFsc2U7CgogICAgJGZoLl9fZGVzdF9fID0gewogICAgICAgIHNlbmQ6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignc2VuZF9ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIG5vdGlmeTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdub3RpZnlfbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBjb250YWN0czogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdjb250YWN0c19ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIGFjYzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdhY2Nfbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBnZW86IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignZ2VvX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgY2FtOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGYoJ2NhbV9ub3N1cHBvcnQnKTsKICAgICAgICB9LAogICAgICAgIGRldmljZTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdkZXZpY2Vfbm9zdXBwb3J0Jyk7CiAgICAgICAgfSwKICAgICAgICBsaXN0ZW46IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignbGlzdGVuX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgaGFuZGxlcnM6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignaGFuZGxlcnNfbm9fc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgZmlsZTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdmaWxlX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgcHVzaDogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBmKCdwdXNoX25vc3VwcG9ydCcpOwogICAgICAgIH0sCiAgICAgICAgZW52OiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIHMoewogICAgICAgICAgICAgICAgaGVpZ2h0OiB3aW5kb3cuaW5uZXJIZWlnaHQsCiAgICAgICAgICAgICAgICB3aWR0aDogd2luZG93LmlubmVyV2lkdGgKICAgICAgICAgICAgfSk7CiAgICAgICAgfQoKICAgICAgICAsCiAgICAgICAgZGF0YTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBpZiAoISRmaC5fcGVyc2lzdCkgewogICAgICAgICAgICAgICAgJGZoLl9wZXJzaXN0ID0gbmV3IFBlcnNpc3QuU3RvcmUoJ0ZIJyArICRmaC5hcHBfcHJvcHMuYXBwaWQsIHsKICAgICAgICAgICAgICAgICAgICBzd2ZfcGF0aDogJy9zdGF0aWMvYy9zdGFydC9zd2YvcGVyc2lzdC5zd2YnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFwLmtleSkgewogICAgICAgICAgICAgICAgZignZGF0YV9ub2tleScpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CgogICAgICAgICAgICB2YXIgYWN0cyA9IHsKICAgICAgICAgICAgICAgIGxvYWQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICRmaC5fcGVyc2lzdC5nZXQocC5rZXksIGZ1bmN0aW9uKG9rLCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2sgPyBzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleTogcC5rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWw6IHZhbAogICAgICAgICAgICAgICAgICAgICAgICB9KSA6IHMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbDogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBzYXZlOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXAudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGYoJ2RhdGFfbm92YWwnKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAkZmguX3BlcnNpc3Quc2V0KHAua2V5LCBwLnZhbCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBmKCdkYXRhX2Vycm9yJywge30sIHApOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICByZW1vdmU6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICRmaC5fcGVyc2lzdC5yZW1vdmUocC5rZXksIGZ1bmN0aW9uKG9rLCB2YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2sgPyBzKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleTogcC5rZXksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWw6IHZhbAogICAgICAgICAgICAgICAgICAgICAgICB9KSA6IHMoewogICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5OiBwLmtleSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbDogbnVsbAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIGFjdHNbcC5hY3RdID8gYWN0c1twLmFjdF0oKSA6IGYoJ2RhdGFfYmFkYWN0JywgcCk7CiAgICAgICAgfQoKICAgICAgICAsCiAgICAgICAgbG9nOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIHR5cGVvZiBjb25zb2xlID09PSAidW5kZWZpbmVkIiA/IGYoJ2xvZ19ub3N1cHBvcnQnKSA6IGNvbnNvbGUubG9nKHAubWVzc2FnZSk7CiAgICAgICAgfQoKICAgICAgICAsCiAgICAgICAgb3JpOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcC5hY3QgPT0gInVuZGVmaW5lZCIgfHwgcC5hY3QgPT0gImxpc3RlbiIpIHsKICAgICAgICAgICAgICAgIGlmIChldmVudFN1cHBvcnRlZCgnb25vcmllbnRhdGlvbmNoYW5nZScpKSB7CiAgICAgICAgICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ29yaWVudGF0aW9uY2hhbmdlJywgcywgZmFsc2UpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmKCdvcmlfbm9zdXBwb3J0Jywge30sIHApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHAuYWN0ID09ICJzZXQiKSB7CiAgICAgICAgICAgICAgICBpZiAoIXAudmFsdWUpIHsKICAgICAgICAgICAgICAgICAgICBmKCdvcmlfbm9fdmFsdWUnLCB7fSwgcCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHAudmFsdWUgPT0gInBvcnRyYWl0IikgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy1tb3otdHJhbnNmb3JtJ10gPSAiIjsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgiYm9keSIpWzBdLnN0eWxlWyctd2Via2l0LXRyYW5zZm9ybSddID0gIiI7CiAgICAgICAgICAgICAgICAgICAgcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIG9yaWVudGF0aW9uOiAncG9ydHJhaXQnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJib2R5IilbMF0uc3R5bGVbJy1tb3otdHJhbnNmb3JtJ10gPSAncm90YXRlKDkwZGVnKSc7CiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImJvZHkiKVswXS5zdHlsZVsnLXdlYmtpdC10cmFuc2Zvcm0nXSA9ICdyb3RhdGUoOTBkZWcpJzsKICAgICAgICAgICAgICAgICAgICBzKHsKICAgICAgICAgICAgICAgICAgICAgICAgb3JpZW50YXRpb246ICdsYW5kc2NhcGUnCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmKCdvcmlfYmFkYWN0Jywge30sIHApOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICAsCiAgICAgICAgbWFwOiBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGlmICghcC50YXJnZXQpIHsKICAgICAgICAgICAgICAgIGYoJ21hcF9ub3RhcmdldCcsIHt9LCBwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXAubGF0KSB7CiAgICAgICAgICAgICAgICBmKCdtYXBfbm9sYXRpdHVkZScsIHt9LCBwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXAubG9uKSB7CiAgICAgICAgICAgICAgICBmKCdtYXBfbm9sb2dpdHVkZScsIHt9LCBwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgdGFyZ2V0ID0gcC50YXJnZXQ7CiAgICAgICAgICAgIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgdmFyIHRhcmdldF9kb20gPSBudWxsOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBqUXVlcnkgIT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIganFfb2JqID0galF1ZXJ5KHRhcmdldCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChqcV9vYmoubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X2RvbSA9IGpxX29ialswXTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X2RvbSA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG51bGwgPT0gdGFyZ2V0X2RvbSkgewogICAgICAgICAgICAgICAgICAgIHRhcmdldF9kb20gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0YXJnZXQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0X2RvbTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdGFyZ2V0ID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgaWYgKHRhcmdldC5ub2RlVHlwZSA9PT0gMSAmJiB0eXBlb2YgdGFyZ2V0Lm5vZGVOYW1lID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIC8vIEEgRE9NIEVsZW1lbnQsIGRvIG5vdGhpbmcKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgLy9BIGpRdWVyeSBub2RlCiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0WzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0ID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCF0YXJnZXQpIHsKICAgICAgICAgICAgICAgIGYoJ21hcF9ub2NvbnRhaW5lcicsIHt9LCBwKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCFfbWFwU2NyaXB0TG9hZGVkKSB7CiAgICAgICAgICAgICAgICAkZmguX21hcExvYWRlZCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIF9tYXBTY3JpcHRMb2FkZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIHZhciBtYXBPcHRpb25zID0ge307CiAgICAgICAgICAgICAgICAgICAgbWFwT3B0aW9ucy56b29tID0gcC56b29tID8gcC56b29tIDogODsKICAgICAgICAgICAgICAgICAgICBtYXBPcHRpb25zLmNlbnRlciA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcocC5sYXQsIHAubG9uKTsKICAgICAgICAgICAgICAgICAgICBtYXBPcHRpb25zLm1hcFR5cGVJZCA9IGdvb2dsZS5tYXBzLk1hcFR5cGVJZC5ST0FETUFQOwogICAgICAgICAgICAgICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKHRhcmdldCwgbWFwT3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgcyh7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hcDogbWFwCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgX2xvYWRNYXBTY3JpcHQoKTsKICAgICAgICAgICAgICAgIC8vYWZ0ZXIgMjAgc2VjcywgaWYgdGhlIG1hcCBzY3JpcHQgaXMgc3RpbGwgbm90IGxvYWRlZCwgcnVuIHRoZSBmYWlsIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICghX21hcFNjcmlwdExvYWRlZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmKCdtYXBfdGltZW91dCcsIHt9LCBwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9LCAyMDAwMCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWFwT3B0aW9ucyA9IHt9OwogICAgICAgICAgICAgICAgbWFwT3B0aW9ucy56b29tID0gcC56b29tID8gcC56b29tIDogODsKICAgICAgICAgICAgICAgIG1hcE9wdGlvbnMuY2VudGVyID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwLmxhdCwgcC5sb24pOwogICAgICAgICAgICAgICAgbWFwT3B0aW9ucy5tYXBUeXBlSWQgPSBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUDsKICAgICAgICAgICAgICAgIHZhciBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKHRhcmdldCwgbWFwT3B0aW9ucyk7CiAgICAgICAgICAgICAgICBzKHsKICAgICAgICAgICAgICAgICAgICBtYXA6IG1hcAogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICwKICAgICAgICBhdWRpbzogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBpZiAoIWF1ZGlvX29iaiA9PSBudWxsICYmIHAuYWN0ID09ICJwbGF5IiAmJiAoIXAucGF0aCB8fCBwLnBhdGggPT0gIiIpKSB7CiAgICAgICAgICAgICAgICBmKCdub19hdWRpb19wYXRoJyk7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIGFjdHMgPSB7CiAgICAgICAgICAgICAgICAncGxheSc6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmIChudWxsID09IGF1ZGlvX29iaikgewogICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmogPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhdWRpbyIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoISgoYXVkaW9fb2JqLnBsYXkpID8gdHJ1ZSA6IGZhbHNlKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZignYXVkaW9fbm90X3N1cHBvcnQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocC50eXBlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgY2FucGxheSA9IGF1ZGlvX29iai5jYW5QbGF5VHlwZShwLnR5cGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNhbnBsYXkgPT0gIm5vIiB8fCBjYW5wbGF5ID09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZigiYXVkaW9fdHlwZV9ub3Rfc3VwcG9ydGVkIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5zcmMgPSBwLnBhdGg7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmNvbnRyb2xzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmouY29udHJvbHMgPSAiY29udHJvbHMiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmF1dG9wbGF5KSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmouYXV0b3BsYXkgPSAiYXV0b3BsYXkiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwLmxvb3ApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5sb29wID0gImxvb3AiOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoYXVkaW9fb2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnBsYXkoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAvL3BsYXlpbmcgYSBuZXcgYXVkaW8KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHAucGF0aCAmJiAocC5wYXRoICE9IGF1ZGlvX29iai5zcmMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXVkaW9faXNfcGxheWluZykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdHNbJ3N0b3AnXSh0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdHNbJ3BsYXknXSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9yZXN1bWUgdGhlIGV4aXN0aW5nIGF1ZGlvCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWF1ZGlvX2lzX3BsYXlpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdWRpb19vYmoucGxheSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX2lzX3BsYXlpbmcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgJ3BhdXNlJzogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bGwgIT0gYXVkaW9fb2JqICYmIGF1ZGlvX2lzX3BsYXlpbmcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhdWRpb19vYmoucGF1c2UgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnBhdXNlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGF1ZGlvX29iai5zdG9wID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5zdG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBzKCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgZignbm9fYXVkaW9fcGxheWluZycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgJ3N0b3AnOiBmdW5jdGlvbihub2NhbGxiYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG51bGwgIT0gYXVkaW9fb2JqKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgYXVkaW9fb2JqLnN0b3AgPT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqLnN0b3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXVkaW9fb2JqLnBhdXNlID09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF1ZGlvX29iai5wYXVzZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQoYXVkaW9fb2JqKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fb2JqID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9faXNfcGxheWluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIW5vY2FsbGJhY2spIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGYoJ25vX2F1ZGlvJyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBhY3RzW3AuYWN0XSA/IGFjdHNbcC5hY3RdKCkgOiBmKCdkYXRhX2JhZGFjdCcsIHApOwogICAgICAgIH0KCiAgICAgICAgLAogICAgICAgIHdlYnZpZXc6IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgZignd2Vidmlld19ub3N1cHBvcnQnKTsKICAgICAgICB9LAoKICAgICAgICByZWFkeTogZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgICAgICBfX2JpbmRfcmVhZHkoKTsKICAgICAgICAgICAgaWYgKF9faXNfcmVhZHkpIHsKICAgICAgICAgICAgICAgIHMuYXBwbHkoZG9jdW1lbnQsIFtdKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIF9fcmVhZHlfbGlzdC5wdXNoKHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgICRmaC5zZW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgdHlwZTogJ2VtYWlsJwogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5zZW5kKTsKICAgIH0KCiAgICAkZmgubm90aWZ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgdHlwZTogJ3ZpYnJhdGUnCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLm5vdGlmeSk7CiAgICB9CgogICAgJGZoLmNvbnRhY3RzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAnbGlzdCcKICAgICAgICB9LCAkZmguX19kZXN0X18uY29udGFjdHMpOwogICAgfQoKICAgICRmaC5hY2MgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBhY3Q6ICdyZWdpc3RlcicsCiAgICAgICAgICAgIGludGVydmFsOiAwCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLmFjYyk7CiAgICB9CgogICAgJGZoLmdlbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIGFjdDogJ3JlZ2lzdGVyJywKICAgICAgICAgICAgaW50ZXJ2YWw6IDAKICAgICAgICB9LCAkZmguX19kZXN0X18uZ2VvKTsKICAgIH0KCiAgICAkZmguY2FtID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAncGljdHVyZScKICAgICAgICB9LCAkZmguX19kZXN0X18uY2FtKTsKICAgIH0KCiAgICAkZmguZGF0YSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIGFjdDogJ2xvYWQnCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLmRhdGEpOwogICAgfQoKICAgICRmaC5sb2cgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBtZXNzYWdlOiAnbm9uZScKICAgICAgICB9LCAkZmguX19kZXN0X18ubG9nKTsKICAgIH0KCiAgICAkZmguZGV2aWNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCAkZmguX19kZXN0X18uZGV2aWNlKTsKICAgIH0KCiAgICAkZmgubGlzdGVuID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgYWN0OiAnYWRkJwogICAgICAgIH0sICRmaC5fX2Rlc3RfXy5saXN0ZW4pOwogICAgfQoKICAgICRmaC5vcmkgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5vcmkpOwogICAgfQoKICAgICRmaC5tYXAgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywge30sICRmaC5fX2Rlc3RfXy5tYXApOwogICAgfQoKICAgICRmaC5hdWRpbyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLmF1ZGlvKTsKICAgIH0KCiAgICAkZmgud2VidmlldyA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLndlYnZpZXcpOwogICAgfQoKICAgICRmaC5yZWFkeSA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLnJlYWR5KTsKICAgIH07CgogICAgJGZoLmhhbmRsZXJzID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgdHlwZTogJ2JhY2snCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLmhhbmRsZXJzKTsKICAgIH07CgogICAgJGZoLmZpbGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBoYW5kbGVhcmdzKGFyZ3VtZW50cywgewogICAgICAgICAgICBhY3Q6ICd1cGxvYWQnCiAgICAgICAgfSwgJGZoLl9fZGVzdF9fLmZpbGUpOwogICAgfTsKCiAgICAkZmgucHVzaCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7fSwgJGZoLl9fZGVzdF9fLnB1c2gpOwogICAgfTsKCiAgICAvLyBuZXcgZnVuY3Rpb25zCiAgICAkZmguZW52ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIC8vIGZsYXQgcHJvcGVydHkgc2V0IC0gbm8gc3ViIG9iamVjdHMhCiAgICAgICAgICAgICRmaC5fX2Rlc3RfXy5lbnYoe30sIGZ1bmN0aW9uKGRlc3RFbnYpIHsKICAgICAgICAgICAgICAgIGRlc3RFbnYuYXBwbGljYXRpb24gPSAkZmguYXBwX3Byb3BzLmFwcGlkOwogICAgICAgICAgICAgICAgaWYgKCRmaC5fZ2V0RGV2aWNlSWQpIHsKICAgICAgICAgICAgICAgICAgICBkZXN0RW52LnV1aWQgPSAkZmguX2dldERldmljZUlkKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBkZXN0RW52LmFnZW50ID0gbmF2aWdhdG9yLnVzZXJBZ2VudCB8fCAndW5rbm93bic7CiAgICAgICAgICAgICAgICBzKGRlc3RFbnYpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgIH0KCiAgICAkZmguZGV2aWNlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHt9LCBmdW5jdGlvbihwLCBzLCBmKSB7CgogICAgICAgIH0pOwogICAgfQoKCiAgICAvLyBkZWZhdWx0czogCiAgICAvLyAgICB7YWN0OidnZXQnfSAtPiB7Z2VvaXA6ey4uLn19CiAgICAvLyAgZmFpbHVyZXM6IGdlb2lwX2JhZGFjdAogICAgLy8KICAgICRmaC5nZW9pcCA9IGZ1bmN0aW9uKCkgewogICAgICAgIGhhbmRsZWFyZ3MoYXJndW1lbnRzLCB7CiAgICAgICAgICAgIGFjdDogJ2dldCcKICAgICAgICB9LCBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgICAgIGlmICgnZ2V0JyA9PSBwLmFjdCkgewogICAgICAgICAgICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2U6ICRmaC5hcHBfcHJvcHMuYXBwaWQsCiAgICAgICAgICAgICAgICAgICAgZG9tYWluOiAkZmguY2xvdWRfcHJvcHMuZG9tYWluCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgICAgICAgICAgICAidXJsIjogX2dldEhvc3RQcmVmaXgoKSArICJhY3Qvd2lkL2dlb2lwL3Jlc29sdmUiLAogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIlBPU1QiLAogICAgICAgICAgICAgICAgICAgICJkYXRhIjogSlNPTi5zdHJpbmdpZnkoZGF0YSksCiAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBmdW5jdGlvbihyZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgLy8gYmFja3dhcmRzIGNvbXBhdAogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIHJlcy5nZW9pcCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzW25dID0gcmVzWydnZW9pcCddW25dOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGYoJ2dlb2lwX2JhZGFjdCcsIHApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9OwoKICAgICRmaC53ZWIgPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgaGFuZGxlYXJncyhhcmd1bWVudHMsIHsKICAgICAgICAgICAgbWV0aG9kOiAnR0VUJwogICAgICAgIH0sIGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICAgICAgaWYgKCFwLnVybCkgewogICAgICAgICAgICAgICAgZignYmFkX3VybCcpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAocC5pc19sb2NhbCkgewogICAgICAgICAgICAgICAgJGZoLl9fYWpheCh7CiAgICAgICAgICAgICAgICAgICAgdXJsOiBwLnVybCwKICAgICAgICAgICAgICAgICAgICB0eXBlOiAiR0VUIiwKICAgICAgICAgICAgICAgICAgICBkYXRhVHlwZTogImh0bWwiLAogICAgICAgICAgICAgICAgICAgIC8veGhyOiAkZmgueGhyLAogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHt9OwogICAgICAgICAgICAgICAgICAgICAgICByZXMuc3RhdHVzID0gMjAwOwogICAgICAgICAgICAgICAgICAgICAgICByZXMuYm9keSA9IGRhdGE7CiAgICAgICAgICAgICAgICAgICAgICAgIHMocmVzKTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZigpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAkZmguX19hamF4KHsKICAgICAgICAgICAgICAgICAgICAidXJsIjogX2dldEhvc3RQcmVmaXgoKSArICJhY3Qvd2lkL3dlYiIsCiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAiUE9TVCIsCiAgICAgICAgICAgICAgICAgICAgImRhdGEiOiBKU09OLnN0cmluZ2lmeShwKSwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IGZ1bmN0aW9uKHJlcykgewogICAgICAgICAgICAgICAgICAgICAgICBzKHJlcyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH07CgogICAgJGZoLl9fd2Vidmlld193aW4gPSB1bmRlZmluZWQ7CiAgICAkZmguX19kZXN0X18ud2VidmlldyA9IGZ1bmN0aW9uKHAsIHMsIGYpIHsKICAgICAgICBpZiAoISgnYWN0JyBpbiBwKSB8fCBwLmFjdCA9PT0gJ29wZW4nKSB7CiAgICAgICAgICAgIGlmICghcC51cmwpIHsKICAgICAgICAgICAgICAgIGYoJ25vX3VybCcpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHZhciBvbGRfdXJsID0gcC51cmw7CiAgICAgICAgICAgICRmaC5fX3dlYnZpZXdfd2luID0gd2luZG93Lm9wZW4ocC51cmwsICdfYmxhbmsnKTsKICAgICAgICAgICAgcygib3BlbmVkIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHAuYWN0ID09PSAnY2xvc2UnKSB7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mICRmaC5fX3dlYnZpZXdfd2luICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgJGZoLl9fd2Vidmlld193aW4uY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAkZmguX193ZWJ2aWV3X3dpbiA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHMoImNsb3NlZCIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKCiAgICAkZmguX19kZXN0X18uZ2VvID0gZnVuY3Rpb24ocCwgcywgZikgewogICAgICAgIGlmICh0eXBlb2YgbmF2aWdhdG9yLmdlb2xvY2F0aW9uICE9ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgIGlmICghcC5hY3QgfHwgcC5hY3QgPT0gInJlZ2lzdGVyIikgewogICAgICAgICAgICAgICAgaWYgKCRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlcikgewogICAgICAgICAgICAgICAgICAgIGYoJ2dlb19pbnVzZScsIHt9LCBwKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocC5pbnRlcnZhbCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbihwb3NpdGlvbikgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgY29vcmRzID0gcG9zaXRpb24uY29vcmRzOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmVzZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvbjogY29vcmRzLmxvbmdpdHVkZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhdDogY29vcmRzLmxhdGl0dWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWx0OiBjb29yZHMuYWx0aXR1ZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2M6IGNvb3Jkcy5hY2N1cmFjeSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhlYWQ6IGNvb3Jkcy5oZWFkaW5nLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3BlZWQ6IGNvb3Jkcy5zcGVlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoZW46IHBvc2l0aW9uLnRpbWVzdGFtcAogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBzKHJlc2RhdGEpOwogICAgICAgICAgICAgICAgICAgIH0sIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICBmKCdlcnJvcl9nZW8nLCB7fSwgcCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBpZiAocC5pbnRlcnZhbCA+IDApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaW50ZXJuYWxXYXRjaGVyID0gbmF2aWdhdG9yLmdlb2xvY2F0aW9uLndhdGNoUG9zaXRpb24oZnVuY3Rpb24ocG9zaXRpb24pIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGNvb3JkcyA9IHBvc2l0aW9uLmNvb3JkczsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJlc2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb246IGNvb3Jkcy5sb25naXR1ZGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYXQ6IGNvb3Jkcy5sYXRpdHVkZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFsdDogY29vcmRzLmFsdGl0dWRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjOiBjb29yZHMuYWNjdXJhY3ksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFkOiBjb29yZHMuaGVhZGluZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNwZWVkOiBjb29yZHMuc3BlZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aGVuOiBwb3NpdGlvbi50aW1lc3RhbXAKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgcyhyZXNkYXRhKTsKICAgICAgICAgICAgICAgICAgICB9LCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZignZXJyb3JfZ2VvJywge30sIHApOwogICAgICAgICAgICAgICAgICAgIH0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgZnJlcXVlbmN5OiBwLmludGVydmFsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgJGZoLl9fZGVzdF9fLl9nZW9XYXRjaGVyID0gaW50ZXJuYWxXYXRjaGVyOwogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgfSBlbHNlIGlmIChwLmFjdCA9PSAidW5yZWdpc3RlciIpIHsKICAgICAgICAgICAgICAgIGlmICgkZmguX19kZXN0X18uX2dlb1dhdGNoZXIpIHsKICAgICAgICAgICAgICAgICAgICBuYXZpZ2F0b3IuZ2VvbG9jYXRpb24uY2xlYXJXYXRjaCgkZmguX19kZXN0X18uX2dlb1dhdGNoZXIpOwogICAgICAgICAgICAgICAgICAgICRmaC5fX2Rlc3RfXy5fZ2VvV2F0Y2hlciA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBzKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmKCdnZW9fYmFkYWN0Jywge30sIHApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZignZ2VvX25vc3VwcG9ydCcsIHt9LCBwKTsKICAgICAgICB9CiAgICB9OwoKICAgICRmaC5fX2Rlc3RfXy5hY2MgPSBmdW5jdGlvbihwLCBzLCBmKSB7CiAgICAgICAgcyh7CiAgICAgICAgICAgIHg6IChNYXRoLnJhbmRvbSgpICogNCkgLSAyLAogICAgICAgICAgICB5OiAoTWF0aC5yYW5kb20oKSAqIDQpIC0gMiwKICAgICAgICAgICAgejogKE1hdGgucmFuZG9tKCkgKiA0KSAtIDIsCiAgICAgICAgICAgIHdoZW46IG5ldyBEYXRlKCkuZ2V0VGltZSgpCiAgICAgICAgfSk7CiAgICB9CgogICAgcm9vdC4kZmggPSAkZmg7Cgp9KSh0aGlzKTs=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 00:14:14 GMT",
                    "Content-Length": "78179",
                    "Date": "Fri, 07 Nov 2014 00:14:15 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}