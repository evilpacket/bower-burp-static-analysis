{
    "url": "http://localhost:9999/rafanami/persistencejs/test/browser/qunit/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>window.location.href</b> and written to <b>window.location.href</b> via the following statement:<ul><li>window.location.href = window.location.href.match(/^(.+?)(\\?.*)?$/)[1] + \"?\" + encodeURIComponent(text);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/rafanami/persistencejs/test/browser/qunit/qunit.js",
                "path": "/rafanami/persistencejs/test/browser/qunit/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9yYWZhbmFtaS9wZXJzaXN0ZW5jZWpzL3Rlc3QvYnJvd3Nlci9xdW5pdC9xdW5pdC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjkxMTcNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMjE6NDk6MDQgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDIxOjQ5OjA0IEdNVA0KDQovKgogKiBRVW5pdCAtIEEgSmF2YVNjcmlwdCBVbml0IFRlc3RpbmcgRnJhbWV3b3JrCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIFFVbml0ID0gewoKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwoJaW5pdDogZnVuY3Rpb24oKSB7CgkJY29uZmlnID0gewoJCQlzdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQltb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQlzdGFydGVkOiArbmV3IERhdGUsCgkJCXVwZGF0ZVJhdGU6IDEwMDAsCgkJCWJsb2NraW5nOiBmYWxzZSwKCQkJYXV0b3J1bjogZmFsc2UsCgkJCWFzc2VydGlvbnM6IFtdLAoJCQlmaWx0ZXJzOiBbXSwKCQkJcXVldWU6IFtdCgkJfTsKCgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCgkJCWJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKCQkJcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCgkJaWYgKCB0ZXN0cyApIHsKCQkJdGVzdHMuaW5uZXJIVE1MID0gIiI7CgkJfQoKCQlpZiAoIGJhbm5lciApIHsKCQkJYmFubmVyLmNsYXNzTmFtZSA9ICIiOwoJCX0KCgkJaWYgKCByZXN1bHQgKSB7CgkJCXJlc3VsdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCByZXN1bHQgKTsKCQl9Cgl9LAoJCgkvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKCW1vZHVsZTogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7CgkJY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOwoKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQkJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7CgkJCX0KCgkJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCQkJY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCQkJY29uZmlnLm1vZHVsZVN0YXRzID0geyBhbGw6IDAsIGJhZDogMCB9OwoKCQkJUVVuaXQubW9kdWxlU3RhcnQoIG5hbWUsIHRlc3RFbnZpcm9ubWVudCApOwoJCX0pOwoJfSwKCglhc3luY1Rlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2spIHsKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gMDsKCQl9CgoJCVFVbml0LnRlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSk7Cgl9LAoJCgl0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgewoJCXZhciBuYW1lID0gdGVzdE5hbWUsIHRlc3RFbnZpcm9ubWVudCwgdGVzdEVudmlyb25tZW50QXJnOwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgkJLy8gaXMgMm5kIGFyZ3VtZW50IGEgdGVzdEVudmlyb25tZW50PwoJCWlmICggZXhwZWN0ZWQgJiYgdHlwZW9mIGV4cGVjdGVkID09PSAnb2JqZWN0JykgewoJCQl0ZXN0RW52aXJvbm1lbnRBcmcgPSAgZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgoJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJCW5hbWUgPSBjb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiAiICsgbmFtZTsKCQl9CgoJCWlmICggIXZhbGlkVGVzdChuYW1lKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCVFVbml0LnRlc3RTdGFydCggdGVzdE5hbWUgKTsKCgkJCXRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7CgkJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwKCQkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9CgkJCX0sIGNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQpOwoJCQlpZiAodGVzdEVudmlyb25tZW50QXJnKSB7CgkJCQlleHRlbmQodGVzdEVudmlyb25tZW50LHRlc3RFbnZpcm9ubWVudEFyZyk7CgkJCX0KCgkJCS8vIGFsbG93IHV0aWxpdHkgZnVuY3Rpb25zIHRvIGFjY2VzcyB0aGUgY3VycmVudCB0ZXN0IGVudmlyb25tZW50CgkJCVFVbml0LmN1cnJlbnRfdGVzdEVudmlyb25tZW50ID0gdGVzdEVudmlyb25tZW50OwoJCQkKCQkJY29uZmlnLmFzc2VydGlvbnMgPSBbXTsKCQkJY29uZmlnLmV4cGVjdGVkID0gZXhwZWN0ZWQ7CgoJCQl0cnkgewoJCQkJaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKCQkJCQlzYXZlR2xvYmFsKCk7CgkJCQl9CgoJCQkJdGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGVzdEVudmlyb25tZW50KTsKCQkJfSBjYXRjaChlKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJCX0KICAgIH0pOwoKICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQlpZiAoIGFzeW5jICkgewoJCQkJUVVuaXQuc3RvcCgpOwoJCQl9CgoJCQl0cnkgewoJCQkJY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCWZhaWwoIlRlc3QgIiArIG5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIiwgZSwgY2FsbGJhY2spOwoJCQkJUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSApOwoJCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKCQkJCXNhdmVHbG9iYWwoKTsKCgkJCQkvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nCgkJCQlpZiAoIGNvbmZpZy5ibG9ja2luZyApIHsKCQkJCQlzdGFydCgpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQl0cnkgewoJCQkJY2hlY2tQb2xsdXRpb24oKTsKCQkJCXRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCQl9CiAgICB9KTsKCiAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJdHJ5IHsKCQkJCVFVbml0LnJlc2V0KCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJZmFpbCgicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyBuYW1lICsgIiwgZXhjZXB0aW9uIGFuZCByZXNldCBmbiBmb2xsb3dzIiwgZSwgcmVzZXQpOwoJCQl9CgoJCQlpZiAoIGNvbmZpZy5leHBlY3RlZCAmJiBjb25maWcuZXhwZWN0ZWQgIT0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiRXhwZWN0ZWQgIiArIGNvbmZpZy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOwoJCQl9CgoJCQl2YXIgZ29vZCA9IDAsIGJhZCA9IDAsCgkJCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoKCQkJY29uZmlnLnN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7CgkJCWNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoKCQkJaWYgKCB0ZXN0cyApIHsKCQkJCXZhciBvbCAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvbCIpOwoJCQkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCQl2YXIgYXNzZXJ0aW9uID0gY29uZmlnLmFzc2VydGlvbnNbaV07CgoJCQkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQkJbGkuY2xhc3NOYW1lID0gYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIjsKCQkJCQlsaS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShhc3NlcnRpb24ubWVzc2FnZSB8fCAiKG5vIG1lc3NhZ2UpIikpOwoJCQkJCW9sLmFwcGVuZENoaWxkKCBsaSApOwoKCQkJCQlpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7CgkJCQkJCWdvb2QrKzsKCQkJCQl9IGVsc2UgewoJCQkJCQliYWQrKzsKCQkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7CgkJCQkJfQoJCQkJfQoKCQkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJCQliLmlubmVySFRNTCA9IG5hbWUgKyAiIDxiIHN0eWxlPSdjb2xvcjpibGFjazsnPig8YiBjbGFzcz0nZmFpbCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzcyc+IiArIGdvb2QgKyAiPC9iPiwgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiI7CgkJCQkKCQkJCWFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJCXZhciBuZXh0ID0gYi5uZXh0U2libGluZywgZGlzcGxheSA9IG5leHQuc3R5bGUuZGlzcGxheTsKCQkJCQluZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwoJCQkJfSk7CgkJCQkKCQkJCWFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKGUpIHsKCQkJCQl2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7CgkJCQkJaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN0cm9uZyIgKSB7CgkJCQkJCXZhciB0ZXh0ID0gIiIsIG5vZGUgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCgkJCQkJCXdoaWxlICggbm9kZS5ub2RlVHlwZSA9PT0gMyApIHsKCQkJCQkJCXRleHQgKz0gbm9kZS5ub2RlVmFsdWU7CgkJCQkJCQlub2RlID0gbm9kZS5uZXh0U2libGluZzsKCQkJCQkJfQoKCQkJCQkJdGV4dCA9IHRleHQucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpOwoKCQkJCQkJaWYgKCB3aW5kb3cubG9jYXRpb24gKSB7CgkJCQkJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRleHQpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgoJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQkJCWxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKCQkJCWxpLmFwcGVuZENoaWxkKCBiICk7CgkJCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsKCQkJCXRlc3RzLmFwcGVuZENoaWxkKCBsaSApOwoKCQkJCWlmICggYmFkICkgewoJCQkJCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJCQkJCWlmICggdG9vbGJhciApIHsKCQkJCQkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQkJaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOwoJCQkJCQlpZCgicXVuaXQtZmlsdGVyLW1pc3NpbmciKS5kaXNhYmxlZCA9IG51bGw7CgkJCQkJfQoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJCWlmICggIWNvbmZpZy5hc3NlcnRpb25zW2ldLnJlc3VsdCApIHsKCQkJCQkJYmFkKys7CgkJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsKCQkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJUVVuaXQudGVzdERvbmUoIHRlc3ROYW1lLCBiYWQsIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApOwoKCQkJaWYgKCAhd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CgkJCQlkb25lKCk7CgkJCX0KCQl9KTsKCgkJaWYgKCB3aW5kb3cuc2V0VGltZW91dCAmJiAhY29uZmlnLmRvbmVUaW1lciApIHsKCQkJY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQlpZiAoICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJCWRvbmUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJc3luY2hyb25pemUoIGRvbmUgKTsKCQkJCX0KCQkJfSwgMTMpOwoJCX0KCX0sCgkKCS8qKgoJICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgoJICovCglleHBlY3Q6IGZ1bmN0aW9uKGFzc2VydHMpIHsKCQljb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwoJfSwKCgkvKioKCSAqIEFzc2VydHMgdHJ1ZS4KCSAqIEBleGFtcGxlIG9rKCAiYXNkZmFzZGYiLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnMiICk7CgkgKi8KCW9rOiBmdW5jdGlvbihhLCBtc2cpIHsKCQlRVW5pdC5sb2coYSwgbXNnKTsKCgkJY29uZmlnLmFzc2VydGlvbnMucHVzaCh7CgkJCXJlc3VsdDogISFhLAoJCQltZXNzYWdlOiBtc2cKCQl9KTsKCX0sCgoJLyoqCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KCSAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KCSAqCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKCSAqCgkgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsKCSAqCgkgKiBAcGFyYW0gT2JqZWN0IGFjdHVhbAoJICogQHBhcmFtIE9iamVjdCBleHBlY3RlZAoJICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKCSAqLwoJZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlwdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCW5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJcHVzaChleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCQoJZGVlcEVxdWFsOiBmdW5jdGlvbihhLCBiLCBtZXNzYWdlKSB7CgkJcHVzaChRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7Cgl9LAoKCW5vdERlZXBFcXVhbDogZnVuY3Rpb24oYSwgYiwgbWVzc2FnZSkgewoJCXB1c2goIVFVbml0LmVxdWl2KGEsIGIpLCBhLCBiLCBtZXNzYWdlKTsKCX0sCgoJc3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlwdXNoKGV4cGVjdGVkID09PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3RTdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCXB1c2goZXhwZWN0ZWQgIT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoJCglzdGFydDogZnVuY3Rpb24oKSB7CgkJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwoJCWlmICggd2luZG93LnNldFRpbWVvdXQgKSB7CgkJCXdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJaWYgKCBjb25maWcudGltZW91dCApIHsKCQkJCQljbGVhclRpbWVvdXQoY29uZmlnLnRpbWVvdXQpOwoJCQkJfQoKCQkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCQkJcHJvY2VzcygpOwoJCQl9LCAxMyk7CgkJfSBlbHNlIHsKCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgkJCXByb2Nlc3MoKTsKCQl9Cgl9LAoJCglzdG9wOiBmdW5jdGlvbih0aW1lb3V0KSB7CgkJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCgkJaWYgKCB0aW1lb3V0ICYmIHdpbmRvdy5zZXRUaW1lb3V0ICkgewoJCQljb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CgkJCQlRVW5pdC5zdGFydCgpOwoJCQl9LCB0aW1lb3V0KTsKCQl9Cgl9LAoJCgkvKioKCSAqIFJlc2V0cyB0aGUgdGVzdCBzZXR1cC4gVXNlZnVsIGZvciB0ZXN0cyB0aGF0IG1vZGlmeSB0aGUgRE9NLgoJICovCglyZXNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB3aW5kb3cualF1ZXJ5ICkgewoJCQlqUXVlcnkoIiNtYWluIikuaHRtbCggY29uZmlnLmZpeHR1cmUgKTsKCQkJalF1ZXJ5LmV2ZW50Lmdsb2JhbCA9IHt9OwoJCQlqUXVlcnkuYWpheFNldHRpbmdzID0gZXh0ZW5kKHt9LCBjb25maWcuYWpheFNldHRpbmdzKTsKCQl9Cgl9LAoJCgkvKioKCSAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KCSAqCgkgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKCSAqCgkgKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtCgkgKiBAcGFyYW0gU3RyaW5nIHR5cGUKCSAqLwoJdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZXZlbnQgKSB7CgkJaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudCApIHsKCQkJZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKCQkJZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LAoJCQkJMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOwoJCQllbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7CgoJCX0gZWxzZSBpZiAoIGVsZW0uZmlyZUV2ZW50ICkgewoJCQllbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOwoJCX0KCX0sCgkKCS8vIFNhZmUgb2JqZWN0IHR5cGUgY2hlY2tpbmcKCWlzOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgewoJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIG9iaiApID09PSAiW29iamVjdCAiKyB0eXBlICsiXSI7Cgl9LAoJCgkvLyBMb2dnaW5nIGNhbGxiYWNrcwoJZG9uZTogZnVuY3Rpb24oZmFpbHVyZXMsIHRvdGFsKSB7fSwKCWxvZzogZnVuY3Rpb24ocmVzdWx0LCBtZXNzYWdlKSB7fSwKCXRlc3RTdGFydDogZnVuY3Rpb24obmFtZSkge30sCgl0ZXN0RG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fSwKCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LAoJbW9kdWxlRG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fQp9OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGRlcHJlY2F0ZWQKUVVuaXQuZXF1YWxzID0gUVVuaXQuZXF1YWw7ClFVbml0LnNhbWUgPSBRVW5pdC5kZWVwRXF1YWw7CgovLyBNYWludGFpbiBpbnRlcm5hbCBzdGF0ZQp2YXIgY29uZmlnID0gewoJLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bgoJcXVldWU6IFtdLAoKCS8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5CglibG9ja2luZzogdHJ1ZQp9OwoKLy8gTG9hZCBwYXJhbWF0ZXJzCihmdW5jdGlvbigpIHsKCXZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDogIiIsIHByb3RvY29sOiAiZmlsZToiIH0sCgkJR0VUUGFyYW1zID0gbG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpLnNwbGl0KCcmJyk7CgoJZm9yICggdmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrICkgewoJCUdFVFBhcmFtc1tpXSA9IGRlY29kZVVSSUNvbXBvbmVudCggR0VUUGFyYW1zW2ldICk7CgkJaWYgKCBHRVRQYXJhbXNbaV0gPT09ICJub2dsb2JhbHMiICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQkJY29uZmlnLm5vZ2xvYmFscyA9IHRydWU7CgkJfSBlbHNlIGlmICggR0VUUGFyYW1zW2ldLnNlYXJjaCgnPScpID4gLTEgKSB7CgkJCUdFVFBhcmFtcy5zcGxpY2UoIGksIDEgKTsKCQkJaS0tOwoJCX0KCX0KCQoJLy8gcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycwoJY29uZmlnLmZpbHRlcnMgPSBHRVRQYXJhbXM7CgkKCS8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgcnVubmluZyB0aGUgdGVzdHMgZnJvbSBhIHNlcnZlciBvciBub3QKCVFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7Cn0pKCk7CgovLyBFeHBvc2UgdGhlIEFQSSBhcyBnbG9iYWwgdmFyaWFibGVzLCB1bmxlc3MgYW4gJ2V4cG9ydHMnCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMKaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHJlcXVpcmUgPT09ICJ1bmRlZmluZWQiICkgewoJZXh0ZW5kKHdpbmRvdywgUVVuaXQpOwoJd2luZG93LlFVbml0ID0gUVVuaXQ7Cn0gZWxzZSB7CglleHRlbmQoZXhwb3J0cywgUVVuaXQpOwoJZXhwb3J0cy5RVW5pdCA9IFFVbml0Owp9CgppZiAoIHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKfQoKYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgewoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQoJdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKCVFVbml0LmluaXQoKTsKCWV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7CgoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgoJdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKCWlmICggdXNlckFnZW50ICkgewoJCXVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJfQoJCgl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKCWlmICggdG9vbGJhciApIHsKCQl0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgkJCgkJdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkJZmlsdGVyLnR5cGUgPSAiY2hlY2tib3giOwoJCWZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7CgkJZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsKCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigicGFzcyIpID4gLTEgKSB7CgkJCQkJbGlbaV0uc3R5bGUuZGlzcGxheSA9IGZpbHRlci5jaGVja2VkID8gIm5vbmUiIDogIiI7CgkJCQl9CgkJCX0KCQl9KTsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsKCgkJdmFyIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOwoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsKCgkJdmFyIG1pc3NpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCW1pc3NpbmcudHlwZSA9ICJjaGVja2JveCI7CgkJbWlzc2luZy5pZCA9ICJxdW5pdC1maWx0ZXItbWlzc2luZyI7CgkJbWlzc2luZy5kaXNhYmxlZCA9IHRydWU7CgkJYWRkRXZlbnQoIG1pc3NpbmcsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJmYWlsIikgPiAtMSAmJiBsaVtpXS5pbm5lckhUTUwuaW5kZXhPZignbWlzc2luZyB0ZXN0IC0gdW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZScpID4gLSAxICkgewoJCQkJCWxpW2ldLnBhcmVudE5vZGUucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gbWlzc2luZy5jaGVja2VkID8gIm5vbmUiIDogImJsb2NrIjsKCQkJCX0KCQkJfQoJCX0pOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIG1pc3NpbmcgKTsKCgkJbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1taXNzaW5nIik7CgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgbWlzc2luZyB0ZXN0cyAodW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZSkiOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7Cgl9CgoJdmFyIG1haW4gPSBpZCgnbWFpbicpOwoJaWYgKCBtYWluICkgewoJCWNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7Cgl9CgoJaWYgKCB3aW5kb3cualF1ZXJ5ICkgewoJCWNvbmZpZy5hamF4U2V0dGluZ3MgPSB3aW5kb3cualF1ZXJ5LmFqYXhTZXR0aW5nczsKCX0KCglRVW5pdC5zdGFydCgpOwp9KTsKCmZ1bmN0aW9uIGRvbmUoKSB7CglpZiAoIGNvbmZpZy5kb25lVGltZXIgJiYgd2luZG93LmNsZWFyVGltZW91dCApIHsKCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCBjb25maWcuZG9uZVRpbWVyICk7CgkJY29uZmlnLmRvbmVUaW1lciA9IG51bGw7Cgl9CgoJaWYgKCBjb25maWcucXVldWUubGVuZ3RoICkgewoJCWNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewoJCQlpZiAoICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJZG9uZSgpOwoJCQl9IGVsc2UgewoJCQkJc3luY2hyb25pemUoIGRvbmUgKTsKCQkJfQoJCX0sIDEzKTsKCgkJcmV0dXJuOwoJfQoKCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKCgkvLyBMb2cgdGhlIGxhc3QgbW9kdWxlIHJlc3VsdHMKCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsKCX0KCgl2YXIgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAoJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCgkJaHRtbCA9IFsnVGVzdHMgY29tcGxldGVkIGluICcsCgkJK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywKCQknPHNwYW4gY2xhc3M9InBhc3NlZCI+JywgY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJ0b3RhbCI+JywgY29uZmlnLnN0YXRzLmFsbCwgJzwvc3Bhbj4gcGFzc2VkLCA8c3BhbiBjbGFzcz0iZmFpbGVkIj4nLCBjb25maWcuc3RhdHMuYmFkLCc8L3NwYW4+IGZhaWxlZC4nXS5qb2luKCcnKTsKCglpZiAoIGJhbm5lciApIHsKCQliYW5uZXIuY2xhc3NOYW1lID0gKGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIpOwoJfQoKCWlmICggdGVzdHMgKSB7CQoJCXZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKCQlpZiAoICFyZXN1bHQgKSB7CgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKCQkJcmVzdWx0LmlkID0gInF1bml0LXRlc3RyZXN1bHQiOwoJCQlyZXN1bHQuY2xhc3NOYW1lID0gInJlc3VsdCI7CgkJCXRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7CgkJfQoKCQlyZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsKCX0KCglRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoKCWlmICggIWkgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgkKCXdoaWxlICggaS0tICkgewoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7CgoJCWlmICggbm90ICkgewoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7CgkJfQoKCQlpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsKCQkJcmV0dXJuICFub3Q7CgkJfQoKCQlpZiAoIG5vdCApIHsKCQkJcnVuID0gdHJ1ZTsKCQl9Cgl9CgoJcmV0dXJuIHJ1bjsKfQoKZnVuY3Rpb24gcHVzaChyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCW1lc3NhZ2UgPSBtZXNzYWdlIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CglRVW5pdC5vayggcmVzdWx0LCByZXN1bHQgPyBtZXNzYWdlICsgIjogIiArIFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkgOiBtZXNzYWdlICsgIiwgZXhwZWN0ZWQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpICsgIiByZXN1bHQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSApOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7Cgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJcHJvY2VzcygpOwoJfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCkgewoJdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgl3aGlsZSAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQlpZiAoIGNvbmZpZy51cGRhdGVSYXRlIDw9IDAgfHwgKCgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQpIDwgY29uZmlnLnVwZGF0ZVJhdGUpICkgewoJCQljb25maWcucXVldWUuc2hpZnQoKSgpOwoKCQl9IGVsc2UgewoJCQlzZXRUaW1lb3V0KCBwcm9jZXNzLCAxMyApOwoJCQlicmVhazsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7Cgljb25maWcucG9sbHV0aW9uID0gW107CgkKCWlmICggY29uZmlnLm5vZ2xvYmFscyApIHsKCQlmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsKCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICkgewoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247CglzYXZlR2xvYmFsKCk7CgkKCXZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7CglpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIG5ld0dsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5leHBlY3RlZCsrOwoJfQoKCXZhciBkZWxldGVkR2xvYmFscyA9IGRpZmYoIGNvbmZpZy5wb2xsdXRpb24sIG9sZCApOwoJaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkRlbGV0ZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGVsZXRlZEdsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5leHBlY3RlZCsrOwoJfQp9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7Cgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrICkgewoJCWZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7CgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgewoJCQkJcmVzdWx0LnNwbGljZShpLCAxKTsKCQkJCWktLTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CglpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOwoJCWNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsKCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgoJfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsKCQlvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7Cgl9Cn0KCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7Cglmb3IgKCB2YXIgcHJvcCBpbiBiICkgewoJCWFbcHJvcF0gPSBiW3Byb3BdOwoJfQoKCXJldHVybiBhOwp9CgpmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7Cgl9IGVsc2UgewoJCWZuKCk7Cgl9Cn0KCmZ1bmN0aW9uIGlkKG5hbWUpIHsKCXJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJgoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7Cn0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwogICAgdmFyIHBhcmVudHMgPSBbXTsgLy8gc3RhY2sgdG8gYXZvaWRpbmcgbG9vcHMgZnJvbSBjaXJjdWxhciByZWZlcmVuY2luZwoKCiAgICAvLyBEZXRlcm1pbmUgd2hhdCBpcyBvLgogICAgZnVuY3Rpb24gaG9veml0KG8pIHsKICAgICAgICBpZiAoUVVuaXQuaXMoIlN0cmluZyIsIG8pKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKICAgICAgICAgICAgCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiQm9vbGVhbiIsIG8pKSB7CiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CgogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIk51bWJlciIsIG8pKSB7CgogICAgICAgICAgICBpZiAoaXNOYU4obykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gInVuZGVmaW5lZCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAibnVsbCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgW10gPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJBcnJheSIsIG8pKSB7CiAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwogICAgICAgIAogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbmV3IERhdGUoKSA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIkRhdGUiLCBvKSkgewogICAgICAgICAgICByZXR1cm4gImRhdGUiOwoKICAgICAgICAvLyBjb25zaWRlcjogLy4vIGluc3RhbmNlb2YgT2JqZWN0OwogICAgICAgIC8vICAgICAgICAgICAvLi8gaW5zdGFuY2VvZiBSZWdFeHA7CiAgICAgICAgLy8gICAgICAgICAgdHlwZW9mIC8uLyA9PT0gImZ1bmN0aW9uIjsgLy8gPT4gZmFsc2UgaW4gSUUgYW5kIE9wZXJhLAogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSBpbiBGRiBhbmQgU2FmYXJpCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIlJlZ0V4cCIsIG8pKSB7CiAgICAgICAgICAgIHJldHVybiAicmVnZXhwIjsKCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCAiRnVuY3Rpb24iLCBvKSkgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLgogICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICB2YXIgcHJvcCA9IGhvb3ppdChvKTsKICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBpZiAoaG9veml0KGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgCiAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyBmb3Igc3RyaW5nLCBib29sZWFuLCBudW1iZXIgYW5kIG51bGwKICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7CiAgICAgICAgICAgIGlmIChiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgLy8gdG8gY2F0Y2ggc2hvcnQgYW5ub3RhaW9uIFZTICduZXcnIGFubm90YXRpb24gb2YgYSBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7CiAgICAgICAgICAgICAgICAvLyAgICAgIHZhciBqID0gbmV3IE51bWJlcigxKTsKICAgICAgICAgICAgICAgIHJldHVybiBhID09IGI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVtYmVyIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICJuYW4iOiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKGIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImRhdGUiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGhvb3ppdChiKSA9PT0gInJlZ2V4cCIgJiYKICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZgogICAgICAgICAgICAgICAgICAgIGEuZ2xvYmFsID09PSBiLmdsb2JhbCAmJiAvLyBhbmQgaXRzIG1vZGlmZXJzIChnbWkpIC4uLgogICAgICAgICAgICAgICAgICAgIGEuaWdub3JlQ2FzZSA9PT0gYi5pZ25vcmVDYXNlICYmCiAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgLy8gLSBza2lwIHdoZW4gdGhlIHByb3BlcnR5IGlzIGEgbWV0aG9kIG9mIGFuIGluc3RhbmNlIChPT1ApCiAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5CiAgICAgICAgICAgICJmdW5jdGlvbiI6IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGksIGosIGxvb3A7CiAgICAgICAgICAgICAgICB2YXIgbGVuOwoKICAgICAgICAgICAgICAgIC8vIGIgY291bGQgYmUgYW4gb2JqZWN0IGxpdGVyYWwgaGVyZQogICAgICAgICAgICAgICAgaWYgKCAhIChob296aXQoYikgPT09ICJhcnJheSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfSAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChsZW4gIT09IGIubGVuZ3RoKSB7IC8vIHNhZmUgYW5kIGZhc3RlcgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOy8vZG9udCByZXdhbGsgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQKICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgaWYgKCBhLmNvbnN0cnVjdG9yICE9PSBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIChpIGluIGEpIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5IGFuZCBnbyBkZWVwCiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7IC8vZG9uJ3QgZ28gZG93biB0aGUgc2FtZSBwYXRoIHR3aWNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGVycy5wb3AoKTsgLy8gdW5zdGFjaywgd2UgYXJlIGRvbmUKICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7CgovKioKICoganNEdW1wCiAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQogKiBMaWNlbnNlZCB1bmRlciBCU0QgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvYnNkLWxpY2Vuc2UucGhwKQogKiBEYXRlOiA1LzE1LzIwMDgKICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuCiAqIEB2ZXJzaW9uIDEuMC4wCiAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcgogKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9CiAqLwpRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7CglmdW5jdGlvbiBxdW90ZSggc3RyICkgewoJCXJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKCX07CglmdW5jdGlvbiBsaXRlcmFsKCBvICkgewoJCXJldHVybiBvICsgJyc7CQoJfTsKCWZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgewoJCXZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAoJCQliYXNlID0ganNEdW1wLmluZGVudCgpLAoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CgkJaWYgKCBhcnIuam9pbiApCgkJCWFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsKCQlpZiAoICFhcnIgKQoJCQlyZXR1cm4gcHJlICsgcG9zdDsKCQlyZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7Cgl9OwoJZnVuY3Rpb24gYXJyYXkoIGFyciApIHsKCQl2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwkJCQkJCgkJdGhpcy51cCgpOwoJCXdoaWxlICggaS0tICkKCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CQkJCQoJCXRoaXMuZG93bigpOwoJCXJldHVybiBqb2luKCAnWycsIHJldCwgJ10nICk7Cgl9OwoJCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgkKCXZhciBqc0R1bXAgPSB7CgkJcGFyc2U6ZnVuY3Rpb24oIG9iaiwgdHlwZSApIHsgLy90eXBlIGlzIHVzZWQgbW9zdGx5IGludGVybmFsbHksIHlvdSBjYW4gZml4IGEgKGN1c3RvbSl0eXBlIGluIGFkdmFuY2UKCQkJdmFyCXBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07CgkJCXR5cGUgPSB0eXBlb2YgcGFyc2VyOwkJCQoJCQkKCQkJcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6CgkJCQkgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoKCQkJCSAgIHRoaXMucGFyc2Vycy5lcnJvcjsKCQl9LAoJCXR5cGVPZjpmdW5jdGlvbiggb2JqICkgewoJCQl2YXIgdHlwZTsKCQkJaWYgKCBvYmogPT09IG51bGwgKSB7CgkJCQl0eXBlID0gIm51bGwiOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CgkJCQl0eXBlID0gInVuZGVmaW5lZCI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG9iaikpIHsKCQkJCXR5cGUgPSAicmVnZXhwIjsKCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRGF0ZSIsIG9iaikpIHsKCQkJCXR5cGUgPSAiZGF0ZSI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIkZ1bmN0aW9uIiwgb2JqKSkgewoJCQkJdHlwZSA9ICJmdW5jdGlvbiI7CgkJCX0gZWxzZSBpZiAob2JqLnNldEludGVydmFsICYmIG9iai5kb2N1bWVudCAmJiAhb2JqLm5vZGVUeXBlKSB7CgkJCQl0eXBlID0gIndpbmRvdyI7CgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlID09PSA5KSB7CgkJCQl0eXBlID0gImRvY3VtZW50IjsKCQkJfSBlbHNlIGlmIChvYmoubm9kZVR5cGUpIHsKCQkJCXR5cGUgPSAibm9kZSI7CgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIG9iai5sZW5ndGggPj0gMCkgewoJCQkJdHlwZSA9ICJhcnJheSI7CgkJCX0gZWxzZSB7CgkJCQl0eXBlID0gdHlwZW9mIG9iajsKCQkJfQoJCQlyZXR1cm4gdHlwZTsKCQl9LAoJCXNlcGFyYXRvcjpmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMubXVsdGlsaW5lID8JdGhpcy5IVE1MID8gJzxiciAvPicgOiAnXG4nIDogdGhpcy5IVE1MID8gJyZuYnNwOycgOiAnICc7CgkJfSwKCQlpbmRlbnQ6ZnVuY3Rpb24oIGV4dHJhICkgey8vIGV4dHJhIGNhbiBiZSBhIG51bWJlciwgc2hvcnRjdXQgZm9yIGluY3JlYXNpbmctY2FsbGluZy1kZWNyZWFzaW5nCgkJCWlmICggIXRoaXMubXVsdGlsaW5lICkKCQkJCXJldHVybiAnJzsKCQkJdmFyIGNociA9IHRoaXMuaW5kZW50Q2hhcjsKCQkJaWYgKCB0aGlzLkhUTUwgKQoJCQkJY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csJyAgICcpLnJlcGxhY2UoLyAvZywnJm5ic3A7Jyk7CgkJCXJldHVybiBBcnJheSggdGhpcy5fZGVwdGhfICsgKGV4dHJhfHwwKSApLmpvaW4oY2hyKTsKCQl9LAoJCXVwOmZ1bmN0aW9uKCBhICkgewoJCQl0aGlzLl9kZXB0aF8gKz0gYSB8fCAxOwoJCX0sCgkJZG93bjpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfIC09IGEgfHwgMTsKCQl9LAoJCXNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgewoJCQl0aGlzLnBhcnNlcnNbbmFtZV0gPSBwYXJzZXI7CgkJfSwKCQkvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0KCQlxdW90ZTpxdW90ZSwgCgkJbGl0ZXJhbDpsaXRlcmFsLAoJCWpvaW46am9pbiwKCQkvLwoJCV9kZXB0aF86IDEsCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXIKCQlwYXJzZXJzOnsKCQkJd2luZG93OiAnW1dpbmRvd10nLAoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLAoJCQllcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KCQkJdW5rbm93bjogJ1tVbmtub3duXScsCgkJCSdudWxsJzonbnVsbCcsCgkJCXVuZGVmaW5lZDondW5kZWZpbmVkJywKCQkJJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7CgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCQkJCWlmICggbmFtZSApCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7CgkJCQlyZXQgKz0gJygnOwoJCQkJCgkJCQlyZXQgPSBbIHJldCwgdGhpcy5wYXJzZSggZm4sICdmdW5jdGlvbkFyZ3MnICksICcpeyddLmpvaW4oJycpOwoJCQkJcmV0dXJuIGpvaW4oIHJldCwgdGhpcy5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOwoJCQl9LAoJCQlhcnJheTogYXJyYXksCgkJCW5vZGVsaXN0OiBhcnJheSwKCQkJYXJndW1lbnRzOiBhcnJheSwKCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7CgkJCQl2YXIgcmV0ID0gWyBdOwoJCQkJdGhpcy51cCgpOwoJCQkJZm9yICggdmFyIGtleSBpbiBtYXAgKQoJCQkJCXJldC5wdXNoKCB0aGlzLnBhcnNlKGtleSwna2V5JykgKyAnOiAnICsgdGhpcy5wYXJzZShtYXBba2V5XSkgKTsKCQkJCXRoaXMuZG93bigpOwoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKCQkJfSwKCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsKCQkJCXZhciBvcGVuID0gdGhpcy5IVE1MID8gJyZsdDsnIDogJzwnLAoJCQkJCWNsb3NlID0gdGhpcy5IVE1MID8gJyZndDsnIDogJz4nOwoJCQkJCQoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJCQlyZXQgPSBvcGVuICsgdGFnOwoJCQkJCQoJCQkJZm9yICggdmFyIGEgaW4gdGhpcy5ET01BdHRycyApIHsKCQkJCQl2YXIgdmFsID0gbm9kZVt0aGlzLkRPTUF0dHJzW2FdXTsKCQkJCQlpZiAoIHZhbCApCgkJCQkJCXJldCArPSAnICcgKyBhICsgJz0nICsgdGhpcy5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOwoJCQkJfQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOwoJCQl9LAoJCQlmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24oIGZuICkgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uCgkJCQl2YXIgbCA9IGZuLmxlbmd0aDsKCQkJCWlmICggIWwgKSByZXR1cm4gJyc7CQkJCQoJCQkJCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOwoJCQkJd2hpbGUgKCBsLS0gKQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwoJCQl9LAoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCgkJCXN0cmluZzpxdW90ZSwKCQkJZGF0ZTpxdW90ZSwKCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKCQkJbnVtYmVyOmxpdGVyYWwsCgkJCSdib29sZWFuJzpsaXRlcmFsCgkJfSwKCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKCQkJaWQ6J2lkJywKCQkJbmFtZTonbmFtZScsCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScKCQl9LAoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQoJCWluZGVudENoYXI6JyAgICcsLy9pbmRlbnRhdGlvbiB1bml0CgkJbXVsdGlsaW5lOmZhbHNlIC8vaWYgdHJ1ZSwgaXRlbXMgaW4gYSBjb2xsZWN0aW9uLCBhcmUgc2VwYXJhdGVkIGJ5IGEgXG4sIGVsc2UganVzdCBhIHNwYWNlLgoJfTsKCglyZXR1cm4ganNEdW1wOwp9KSgpOwoKfSkodGhpcyk7Cg==",
                "body": "LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKiAKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDkgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCAoTUlULUxJQ0VOU0UudHh0KQogKiBhbmQgR1BMIChHUEwtTElDRU5TRS50eHQpIGxpY2Vuc2VzLgogKi8KCihmdW5jdGlvbih3aW5kb3cpIHsKCnZhciBRVW5pdCA9IHsKCgkvLyBJbml0aWFsaXplIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMKCWluaXQ6IGZ1bmN0aW9uKCkgewoJCWNvbmZpZyA9IHsKCQkJc3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJbW9kdWxlU3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJc3RhcnRlZDogK25ldyBEYXRlLAoJCQl1cGRhdGVSYXRlOiAxMDAwLAoJCQlibG9ja2luZzogZmFsc2UsCgkJCWF1dG9ydW46IGZhbHNlLAoJCQlhc3NlcnRpb25zOiBbXSwKCQkJZmlsdGVyczogW10sCgkJCXF1ZXVlOiBbXQoJCX07CgoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAoJCQliYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCgkJCXJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgoJCWlmICggdGVzdHMgKSB7CgkJCXRlc3RzLmlubmVySFRNTCA9ICIiOwoJCX0KCgkJaWYgKCBiYW5uZXIgKSB7CgkJCWJhbm5lci5jbGFzc05hbWUgPSAiIjsKCQl9CgoJCWlmICggcmVzdWx0ICkgewoJCQlyZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmVzdWx0ICk7CgkJfQoJfSwKCQoJLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCgltb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgewoJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJCQlRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOwoJCQl9CgoJCQljb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CgkJCWNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CgkJCWNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsKCgkJCVFVbml0Lm1vZHVsZVN0YXJ0KCBuYW1lLCB0ZXN0RW52aXJvbm1lbnQgKTsKCQl9KTsKCX0sCgoJYXN5bmNUZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IDA7CgkJfQoKCQlRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOwoJfSwKCQoJdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsKCQl2YXIgbmFtZSA9IHRlc3ROYW1lLCB0ZXN0RW52aXJvbm1lbnQsIHRlc3RFbnZpcm9ubWVudEFyZzsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoJCS8vIGlzIDJuZCBhcmd1bWVudCBhIHRlc3RFbnZpcm9ubWVudD8KCQlpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsKCQkJdGVzdEVudmlyb25tZW50QXJnID0gIGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoKCQlpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCQluYW1lID0gY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiIG1vZHVsZTogIiArIG5hbWU7CgkJfQoKCQlpZiAoICF2YWxpZFRlc3QobmFtZSkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQlRVW5pdC50ZXN0U3RhcnQoIHRlc3ROYW1lICk7CgoJCQl0ZXN0RW52aXJvbm1lbnQgPSBleHRlbmQoewoJCQkJc2V0dXA6IGZ1bmN0aW9uKCkge30sCgkJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7fQoJCQl9LCBjb25maWcubW9kdWxlVGVzdEVudmlyb25tZW50KTsKCQkJaWYgKHRlc3RFbnZpcm9ubWVudEFyZykgewoJCQkJZXh0ZW5kKHRlc3RFbnZpcm9ubWVudCx0ZXN0RW52aXJvbm1lbnRBcmcpOwoJCQl9CgoJCQkvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudAoJCQlRVW5pdC5jdXJyZW50X3Rlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCQkJCgkJCWNvbmZpZy5hc3NlcnRpb25zID0gW107CgkJCWNvbmZpZy5leHBlY3RlZCA9IGV4cGVjdGVkOwoKCQkJdHJ5IHsKCQkJCWlmICggIWNvbmZpZy5wb2xsdXRpb24gKSB7CgkJCQkJc2F2ZUdsb2JhbCgpOwoJCQkJfQoKCQkJCXRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCQl9CiAgICB9KTsKCiAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJaWYgKCBhc3luYyApIHsKCQkJCVFVbml0LnN0b3AoKTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWNhbGxiYWNrLmNhbGwodGVzdEVudmlyb25tZW50KTsKCQkJfSBjYXRjaChlKSB7CgkJCQlmYWlsKCJUZXN0ICIgKyBuYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIsIGUsIGNhbGxiYWNrKTsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArIChjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAxKSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQkJCS8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5CgkJCQlzYXZlR2xvYmFsKCk7CgoJCQkJLy8gUmVzdGFydCB0aGUgdGVzdHMgaWYgdGhleSdyZSBibG9ja2luZwoJCQkJaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7CgkJCQkJc3RhcnQoKTsKCQkJCX0KCQkJfQoJCX0pOwoKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJdHJ5IHsKCQkJCWNoZWNrUG9sbHV0aW9uKCk7CgkJCQl0ZXN0RW52aXJvbm1lbnQudGVhcmRvd24uY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQkJfQogICAgfSk7CgogICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCXRyeSB7CgkJCQlRVW5pdC5yZXNldCgpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCWZhaWwoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgbmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIHJlc2V0KTsKCQkJfQoKCQkJaWYgKCBjb25maWcuZXhwZWN0ZWQgJiYgY29uZmlnLmV4cGVjdGVkICE9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKCQkJfQoKCQkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwLAoJCQkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsKCgkJCWNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoJCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKCgkJCWlmICggdGVzdHMgKSB7CgkJCQl2YXIgb2wgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsKCQkJCW9sLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGFzc2VydGlvbiA9IGNvbmZpZy5hc3NlcnRpb25zW2ldOwoKCQkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJCWxpLmNsYXNzTmFtZSA9IGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCI7CgkJCQkJbGkuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgIihubyBtZXNzYWdlKSIpKTsKCQkJCQlvbC5hcHBlbmRDaGlsZCggbGkgKTsKCgkJCQkJaWYgKCBhc3NlcnRpb24ucmVzdWx0ICkgewoJCQkJCQlnb29kKys7CgkJCQkJfSBlbHNlIHsKCQkJCQkJYmFkKys7CgkJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsKCQkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwoJCQkJCX0KCQkJCX0KCgkJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwoJCQkJYi5pbm5lckhUTUwgPSBuYW1lICsgIiA8YiBzdHlsZT0nY29sb3I6YmxhY2s7Jz4oPGIgY2xhc3M9J2ZhaWwnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3MnPiIgKyBnb29kICsgIjwvYj4sICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOwoJCQkJCgkJCQlhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbmV4dCA9IGIubmV4dFNpYmxpbmcsIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7CgkJCQkJbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKCQkJCX0pOwoJCQkJCgkJCQlhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7CgkJCQkJdmFyIHRhcmdldCA9IGUgJiYgZS50YXJnZXQgPyBlLnRhcmdldCA6IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50OwoJCQkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgewoJCQkJCQl2YXIgdGV4dCA9ICIiLCBub2RlID0gdGFyZ2V0LmZpcnN0Q2hpbGQ7CgoJCQkJCQl3aGlsZSAoIG5vZGUubm9kZVR5cGUgPT09IDMgKSB7CgkJCQkJCQl0ZXh0ICs9IG5vZGUubm9kZVZhbHVlOwoJCQkJCQkJbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CgkJCQkJCX0KCgkJCQkJCXRleHQgPSB0ZXh0LnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKTsKCgkJCQkJCWlmICggd2luZG93LmxvY2F0aW9uICkgewoJCQkJCQkJd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCh0ZXh0KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoKCQkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQlsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7CgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCQkJbGkuYXBwZW5kQ2hpbGQoIG9sICk7CgkJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsKCgkJCQlpZiAoIGJhZCApIHsKCQkJCQl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKCQkJCQlpZiAoIHRvb2xiYXIgKSB7CgkJCQkJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQkJCWlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmRpc2FibGVkID0gbnVsbDsKCQkJCQkJaWQoInF1bml0LWZpbHRlci1taXNzaW5nIikuZGlzYWJsZWQgPSBudWxsOwoJCQkJCX0KCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCQlpZiAoICFjb25maWcuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7CgkJCQkJCWJhZCsrOwoJCQkJCQljb25maWcuc3RhdHMuYmFkKys7CgkJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCVFVbml0LnRlc3REb25lKCB0ZXN0TmFtZSwgYmFkLCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKTsKCgkJCWlmICggIXdpbmRvdy5zZXRUaW1lb3V0ICYmICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJZG9uZSgpOwoJCQl9CgkJfSk7CgoJCWlmICggd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5kb25lVGltZXIgKSB7CgkJCWNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsKCQkJCQlkb25lKCk7CgkJCQl9IGVsc2UgewoJCQkJCXN5bmNocm9uaXplKCBkb25lICk7CgkJCQl9CgkJCX0sIDEzKTsKCQl9Cgl9LAoJCgkvKioKCSAqIFNwZWNpZnkgdGhlIG51bWJlciBvZiBleHBlY3RlZCBhc3NlcnRpb25zIHRvIGd1cmFudGVlIHRoYXQgZmFpbGVkIHRlc3QgKG5vIGFzc2VydGlvbnMgYXJlIHJ1biBhdCBhbGwpIGRvbid0IHNsaXAgdGhyb3VnaC4KCSAqLwoJZXhwZWN0OiBmdW5jdGlvbihhc3NlcnRzKSB7CgkJY29uZmlnLmV4cGVjdGVkID0gYXNzZXJ0czsKCX0sCgoJLyoqCgkgKiBBc3NlcnRzIHRydWUuCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwoJICovCglvazogZnVuY3Rpb24oYSwgbXNnKSB7CgkJUVVuaXQubG9nKGEsIG1zZyk7CgoJCWNvbmZpZy5hc3NlcnRpb25zLnB1c2goewoJCQlyZXN1bHQ6ICEhYSwKCQkJbWVzc2FnZTogbXNnCgkJfSk7Cgl9LAoKCS8qKgoJICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuCgkgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCgkgKgoJICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApCgkgKgoJICogQGV4YW1wbGUgZXF1YWwoIGZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CgkgKgoJICogQHBhcmFtIE9iamVjdCBhY3R1YWwKCSAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKCSAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpCgkgKi8KCWVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJcHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCXB1c2goZXhwZWN0ZWQgIT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgkKCWRlZXBFcXVhbDogZnVuY3Rpb24oYSwgYiwgbWVzc2FnZSkgewoJCXB1c2goUVVuaXQuZXF1aXYoYSwgYiksIGEsIGIsIG1lc3NhZ2UpOwoJfSwKCglub3REZWVwRXF1YWw6IGZ1bmN0aW9uKGEsIGIsIG1lc3NhZ2UpIHsKCQlwdXNoKCFRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7Cgl9LAoKCXN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJcHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlwdXNoKGV4cGVjdGVkICE9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCQoJc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKCQlpZiAoIHdpbmRvdy5zZXRUaW1lb3V0ICkgewoJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWlmICggY29uZmlnLnRpbWVvdXQgKSB7CgkJCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKCQkJCX0KCgkJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJCXByb2Nlc3MoKTsKCQkJfSwgMTMpOwoJCX0gZWxzZSB7CgkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCQlwcm9jZXNzKCk7CgkJfQoJfSwKCQoJc3RvcDogZnVuY3Rpb24odGltZW91dCkgewoJCWNvbmZpZy5ibG9ja2luZyA9IHRydWU7CgoJCWlmICggdGltZW91dCAmJiB3aW5kb3cuc2V0VGltZW91dCApIHsKCQkJY29uZmlnLnRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwoJCQkJUVVuaXQuc3RhcnQoKTsKCQkJfSwgdGltZW91dCk7CgkJfQoJfSwKCQoJLyoqCgkgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KCSAqLwoJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggd2luZG93LmpRdWVyeSApIHsKCQkJalF1ZXJ5KCIjbWFpbiIpLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7CgkJCWpRdWVyeS5ldmVudC5nbG9iYWwgPSB7fTsKCQkJalF1ZXJ5LmFqYXhTZXR0aW5ncyA9IGV4dGVuZCh7fSwgY29uZmlnLmFqYXhTZXR0aW5ncyk7CgkJfQoJfSwKCQoJLyoqCgkgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCgkgKgoJICogQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7CgkgKgoJICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQoJICogQHBhcmFtIFN0cmluZyB0eXBlCgkgKi8KCXRyaWdnZXJFdmVudDogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGV2ZW50ICkgewoJCWlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnQgKSB7CgkJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CgkJCWV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKCQkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCQkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoKCQl9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsKCQkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsKCQl9Cgl9LAoJCgkvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCglpczogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBvYmogKSA9PT0gIltvYmplY3QgIisgdHlwZSArIl0iOwoJfSwKCQoJLy8gTG9nZ2luZyBjYWxsYmFja3MKCWRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCkge30sCglsb2c6IGZ1bmN0aW9uKHJlc3VsdCwgbWVzc2FnZSkge30sCgl0ZXN0U3RhcnQ6IGZ1bmN0aW9uKG5hbWUpIHt9LAoJdGVzdERvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30sCgltb2R1bGVTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwKCW1vZHVsZURvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30KfTsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkClFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOwpRVW5pdC5zYW1lID0gUVVuaXQuZGVlcEVxdWFsOwoKLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUKdmFyIGNvbmZpZyA9IHsKCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KCXF1ZXVlOiBbXSwKCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQoJYmxvY2tpbmc6IHRydWUKfTsKCi8vIExvYWQgcGFyYW1hdGVycwooZnVuY3Rpb24oKSB7Cgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoKCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsKCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOwoJCWlmICggR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIiApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJCWNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQl9Cgl9CgkKCS8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOwoJCgkvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90CglRVW5pdC5pc0xvY2FsID0gISEobG9jYXRpb24ucHJvdG9jb2wgPT09ICdmaWxlOicpOwp9KSgpOwoKLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJwovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsKCWV4dGVuZCh3aW5kb3csIFFVbml0KTsKCXdpbmRvdy5RVW5pdCA9IFFVbml0Owp9IGVsc2UgewoJZXh0ZW5kKGV4cG9ydHMsIFFVbml0KTsKCWV4cG9ydHMuUVVuaXQgPSBRVW5pdDsKfQoKaWYgKCB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7Cn0KCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKCXZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7CglRVW5pdC5pbml0KCk7CglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoKCXZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7CglpZiAoIHVzZXJBZ2VudCApIHsKCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCX0KCQoJdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7CglpZiAoIHRvb2xiYXIgKSB7CgkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJCQoJCXZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCWZpbHRlci50eXBlID0gImNoZWNrYm94IjsKCQlmaWx0ZXIuaWQgPSAicXVuaXQtZmlsdGVyLXBhc3MiOwoJCWZpbHRlci5kaXNhYmxlZCA9IHRydWU7CgkJYWRkRXZlbnQoIGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOwoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoInBhc3MiKSA+IC0xICkgewoJCQkJCWxpW2ldLnN0eWxlLmRpc3BsYXkgPSBmaWx0ZXIuY2hlY2tlZCA/ICJub25lIiA6ICIiOwoJCQkJfQoJCQl9CgkJfSk7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggZmlsdGVyICk7CgoJCXZhciBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CgkJbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCAicXVuaXQtZmlsdGVyLXBhc3MiKTsKCQlsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBwYXNzZWQgdGVzdHMiOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7CgoJCXZhciBtaXNzaW5nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCQltaXNzaW5nLnR5cGUgPSAiY2hlY2tib3giOwoJCW1pc3NpbmcuaWQgPSAicXVuaXQtZmlsdGVyLW1pc3NpbmciOwoJCW1pc3NpbmcuZGlzYWJsZWQgPSB0cnVlOwoJCWFkZEV2ZW50KCBtaXNzaW5nLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigiZmFpbCIpID4gLTEgJiYgbGlbaV0uaW5uZXJIVE1MLmluZGV4T2YoJ21pc3NpbmcgdGVzdCAtIHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUnKSA+IC0gMSApIHsKCQkJCQlsaVtpXS5wYXJlbnROb2RlLnBhcmVudE5vZGUuc3R5bGUuZGlzcGxheSA9IG1pc3NpbmcuY2hlY2tlZCA/ICJub25lIiA6ICJibG9jayI7CgkJCQl9CgkJCX0KCQl9KTsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBtaXNzaW5nICk7CgoJCWxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItbWlzc2luZyIpOwoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIG1pc3NpbmcgdGVzdHMgKHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUpIjsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoJfQoKCXZhciBtYWluID0gaWQoJ21haW4nKTsKCWlmICggbWFpbiApIHsKCQljb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOwoJfQoKCWlmICggd2luZG93LmpRdWVyeSApIHsKCQljb25maWcuYWpheFNldHRpbmdzID0gd2luZG93LmpRdWVyeS5hamF4U2V0dGluZ3M7Cgl9CgoJUVVuaXQuc3RhcnQoKTsKfSk7CgpmdW5jdGlvbiBkb25lKCkgewoJaWYgKCBjb25maWcuZG9uZVRpbWVyICYmIHdpbmRvdy5jbGVhclRpbWVvdXQgKSB7CgkJd2luZG93LmNsZWFyVGltZW91dCggY29uZmlnLmRvbmVUaW1lciApOwoJCWNvbmZpZy5kb25lVGltZXIgPSBudWxsOwoJfQoKCWlmICggY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsKCQljb25maWcuZG9uZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCQkJaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsKCQkJCWRvbmUoKTsKCQkJfSBlbHNlIHsKCQkJCXN5bmNocm9uaXplKCBkb25lICk7CgkJCX0KCQl9LCAxMyk7CgoJCXJldHVybjsKCX0KCgljb25maWcuYXV0b3J1biA9IHRydWU7CgoJLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzCglpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7Cgl9CgoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAoJCWh0bWwgPSBbJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLAoJCStuZXcgRGF0ZSAtIGNvbmZpZy5zdGFydGVkLCAnIG1pbGxpc2Vjb25kcy48YnIvPicsCgkJJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwnPC9zcGFuPiBmYWlsZWQuJ10uam9pbignJyk7CgoJaWYgKCBiYW5uZXIgKSB7CgkJYmFubmVyLmNsYXNzTmFtZSA9IChjb25maWcuc3RhdHMuYmFkID8gInF1bml0LWZhaWwiIDogInF1bml0LXBhc3MiKTsKCX0KCglpZiAoIHRlc3RzICkgewkKCQl2YXIgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCgkJaWYgKCAhcmVzdWx0ICkgewoJCQlyZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CgkJCXJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsKCQkJcmVzdWx0LmNsYXNzTmFtZSA9ICJyZXN1bHQiOwoJCQl0ZXN0cy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggcmVzdWx0LCB0ZXN0cy5uZXh0U2libGluZyApOwoJCX0KCgkJcmVzdWx0LmlubmVySFRNTCA9IGh0bWw7Cgl9CgoJUVVuaXQuZG9uZSggY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCApOwp9CgpmdW5jdGlvbiB2YWxpZFRlc3QoIG5hbWUgKSB7Cgl2YXIgaSA9IGNvbmZpZy5maWx0ZXJzLmxlbmd0aCwKCQlydW4gPSBmYWxzZTsKCglpZiAoICFpICkgewoJCXJldHVybiB0cnVlOwoJfQoJCgl3aGlsZSAoIGktLSApIHsKCQl2YXIgZmlsdGVyID0gY29uZmlnLmZpbHRlcnNbaV0sCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoKCQlpZiAoIG5vdCApIHsKCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwoJCX0KCgkJaWYgKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPT0gLTEgKSB7CgkJCXJldHVybiAhbm90OwoJCX0KCgkJaWYgKCBub3QgKSB7CgkJCXJ1biA9IHRydWU7CgkJfQoJfQoKCXJldHVybiBydW47Cn0KCmZ1bmN0aW9uIHB1c2gocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgltZXNzYWdlID0gbWVzc2FnZSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJUVVuaXQub2soIHJlc3VsdCwgcmVzdWx0ID8gbWVzc2FnZSArICI6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpIDogbWVzc2FnZSArICIsIGV4cGVjdGVkOiAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSArICIgcmVzdWx0OiAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGFjdHVhbCkgKTsKfQoKZnVuY3Rpb24gc3luY2hyb25pemUoIGNhbGxiYWNrICkgewoJY29uZmlnLnF1ZXVlLnB1c2goIGNhbGxiYWNrICk7CgoJaWYgKCBjb25maWcuYXV0b3J1biAmJiAhY29uZmlnLmJsb2NraW5nICkgewoJCXByb2Nlc3MoKTsKCX0KfQoKZnVuY3Rpb24gcHJvY2VzcygpIHsKCXZhciBzdGFydCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgoJd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJaWYgKCBjb25maWcudXBkYXRlUmF0ZSA8PSAwIHx8ICgoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHN0YXJ0KSA8IGNvbmZpZy51cGRhdGVSYXRlKSApIHsKCQkJY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsKCgkJfSBlbHNlIHsKCQkJc2V0VGltZW91dCggcHJvY2VzcywgMTMgKTsKCQkJYnJlYWs7CgkJfQoJfQp9CgpmdW5jdGlvbiBzYXZlR2xvYmFsKCkgewoJY29uZmlnLnBvbGx1dGlvbiA9IFtdOwoJCglpZiAoIGNvbmZpZy5ub2dsb2JhbHMgKSB7CgkJZm9yICggdmFyIGtleSBpbiB3aW5kb3cgKSB7CgkJCWNvbmZpZy5wb2xsdXRpb24ucHVzaCgga2V5ICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBjaGVja1BvbGx1dGlvbiggbmFtZSApIHsKCXZhciBvbGQgPSBjb25maWcucG9sbHV0aW9uOwoJc2F2ZUdsb2JhbCgpOwoJCgl2YXIgbmV3R2xvYmFscyA9IGRpZmYoIG9sZCwgY29uZmlnLnBvbGx1dGlvbiApOwoJaWYgKCBuZXdHbG9iYWxzLmxlbmd0aCA+IDAgKSB7CgkJb2soIGZhbHNlLCAiSW50cm9kdWNlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBuZXdHbG9iYWxzLmpvaW4oIiwgIikgKTsKCQljb25maWcuZXhwZWN0ZWQrKzsKCX0KCgl2YXIgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKCBjb25maWcucG9sbHV0aW9uLCBvbGQgKTsKCWlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsKCQljb25maWcuZXhwZWN0ZWQrKzsKCX0KfQoKLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYgpmdW5jdGlvbiBkaWZmKCBhLCBiICkgewoJdmFyIHJlc3VsdCA9IGEuc2xpY2UoKTsKCWZvciAoIHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKyApIHsKCQlmb3IgKCB2YXIgaiA9IDA7IGogPCBiLmxlbmd0aDsgaisrICkgewoJCQlpZiAoIHJlc3VsdFtpXSA9PT0gYltqXSApIHsKCQkJCXJlc3VsdC5zcGxpY2UoaSwgMSk7CgkJCQlpLS07CgkJCQlicmVhazsKCQkJfQoJCX0KCX0KCXJldHVybiByZXN1bHQ7Cn0KCmZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgewoJaWYgKCB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7CgkJY29uc29sZS5lcnJvcihtZXNzYWdlKTsKCQljb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7CgkJY29uc29sZS53YXJuKGNhbGxiYWNrLnRvU3RyaW5nKCkpOwoKCX0gZWxzZSBpZiAoIHdpbmRvdy5vcGVyYSAmJiBvcGVyYS5wb3N0RXJyb3IgKSB7CgkJb3BlcmEucG9zdEVycm9yKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2sudG9TdHJpbmcpOwoJfQp9CgpmdW5jdGlvbiBleHRlbmQoYSwgYikgewoJZm9yICggdmFyIHByb3AgaW4gYiApIHsKCQlhW3Byb3BdID0gYltwcm9wXTsKCX0KCglyZXR1cm4gYTsKfQoKZnVuY3Rpb24gYWRkRXZlbnQoZWxlbSwgdHlwZSwgZm4pIHsKCWlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewoJCWVsZW0uYWRkRXZlbnRMaXN0ZW5lciggdHlwZSwgZm4sIGZhbHNlICk7Cgl9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewoJCWVsZW0uYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBmbiApOwoJfSBlbHNlIHsKCQlmbigpOwoJfQp9CgpmdW5jdGlvbiBpZChuYW1lKSB7CglyZXR1cm4gISEodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgJiYKCQlkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggbmFtZSApOwp9CgovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLgovLyBEaXNjdXNzaW9ucyBhbmQgcmVmZXJlbmNlOiBodHRwOi8vcGhpbHJhdGhlLmNvbS9hcnRpY2xlcy9lcXVpdgovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYKLy8gQXV0aG9yOiBQaGlsaXBwZSBSYXRow6kgPHByYXRoZUBnbWFpbC5jb20+ClFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgIHZhciBpbm5lckVxdWl2OyAvLyB0aGUgcmVhbCBlcXVpdiBmdW5jdGlvbgogICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMKICAgIHZhciBwYXJlbnRzID0gW107IC8vIHN0YWNrIHRvIGF2b2lkaW5nIGxvb3BzIGZyb20gY2lyY3VsYXIgcmVmZXJlbmNpbmcKCgogICAgLy8gRGV0ZXJtaW5lIHdoYXQgaXMgby4KICAgIGZ1bmN0aW9uIGhvb3ppdChvKSB7CiAgICAgICAgaWYgKFFVbml0LmlzKCJTdHJpbmciLCBvKSkgewogICAgICAgICAgICByZXR1cm4gInN0cmluZyI7CiAgICAgICAgICAgIAogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkJvb2xlYW4iLCBvKSkgewogICAgICAgICAgICByZXR1cm4gImJvb2xlYW4iOwoKICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJOdW1iZXIiLCBvKSkgewoKICAgICAgICAgICAgaWYgKGlzTmFOKG8pKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm5hbiI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICAgIH0KCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgcmV0dXJuICJ1bmRlZmluZWQiOwoKICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG51bGwgPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAobyA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm4gIm51bGwiOwoKICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIFtdID09PSBvYmplY3QKICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCAiQXJyYXkiLCBvKSkgewogICAgICAgICAgICByZXR1cm4gImFycmF5IjsKICAgICAgICAKICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG5ldyBEYXRlKCkgPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJEYXRlIiwgbykpIHsKICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IC8uLyBpbnN0YW5jZW9mIE9iamVjdDsKICAgICAgICAvLyAgICAgICAgICAgLy4vIGluc3RhbmNlb2YgUmVnRXhwOwogICAgICAgIC8vICAgICAgICAgIHR5cGVvZiAvLi8gPT09ICJmdW5jdGlvbiI7IC8vID0+IGZhbHNlIGluIElFIGFuZCBPcGVyYSwKICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUgaW4gRkYgYW5kIFNhZmFyaQogICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoICJSZWdFeHAiLCBvKSkgewogICAgICAgICAgICByZXR1cm4gInJlZ2V4cCI7CgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKCiAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcyggIkZ1bmN0aW9uIiwgbykpIHsKICAgICAgICAgICAgcmV0dXJuICJmdW5jdGlvbiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9CgogICAgLy8gQ2FsbCB0aGUgbyByZWxhdGVkIGNhbGxiYWNrIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7CiAgICAgICAgdmFyIHByb3AgPSBob296aXQobyk7CiAgICAgICAgaWYgKHByb3ApIHsKICAgICAgICAgICAgaWYgKGhvb3ppdChjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIAogICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsCiAgICAgICAgZnVuY3Rpb24gdXNlU3RyaWN0RXF1YWxpdHkoYiwgYSkgewogICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgIC8vIHRvIGNhdGNoIHNob3J0IGFubm90YWlvbiBWUyAnbmV3JyBhbm5vdGF0aW9uIG9mIGEgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgIC8vIGUuZy4gdmFyIGkgPSAxOwogICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PSBiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJzdHJpbmciOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVsbCI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksCgogICAgICAgICAgICAibmFuIjogZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAicmVnZXhwIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwKICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgIGlmICggISAoaG9veml0KGIpID09PSAiYXJyYXkiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0gICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvL2RvbnQgcmV3YWxrIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgIm9iamVjdCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsKICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0CiAgICAgICAgICAgICAgICB2YXIgYVByb3BlcnRpZXMgPSBbXSwgYlByb3BlcnRpZXMgPSBbXTsgLy8gY29sbGVjdGlvbiBvZiBzdHJpbmdzCgogICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YKICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBjYWxsZXJzLnB1c2goYS5jb25zdHJ1Y3Rvcik7CiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOyAvL2Rvbid0IGdvIGRvd24gdGhlIHNhbWUgcGF0aCB0d2ljZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICghbG9vcCAmJiAhIGlubmVyRXF1aXYoYVtpXSwgYltpXSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0oKTsKCiAgICBpbm5lckVxdWl2ID0gZnVuY3Rpb24gKCkgeyAvLyBjYW4gdGFrZSBtdWx0aXBsZSBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGVuZCB0cmFuc2l0aW9uCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IGhvb3ppdChhKSAhPT0gaG9veml0KGIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7CiAgICB9OwoKICAgIHJldHVybiBpbm5lckVxdWl2OwoKfSgpOwoKLyoqCiAqIGpzRHVtcAogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkKICogRGF0ZTogNS8xNS8yMDA4CiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogKiBAdmVyc2lvbiAxLjAuMAogKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogKi8KUVVuaXQuanNEdW1wID0gKGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsKCQlyZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7Cgl9OwoJZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsKCQlyZXR1cm4gbyArICcnOwkKCX07CglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsKCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwKCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwoJCWlmICggYXJyLmpvaW4gKQoJCQlhcnIgPSBhcnIuam9pbiggJywnICsgcyArIGlubmVyICk7CgkJaWYgKCAhYXJyICkKCQkJcmV0dXJuIHByZSArIHBvc3Q7CgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwoJfTsKCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7CgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsJCQkJCQoJCXRoaXMudXAoKTsKCQl3aGlsZSAoIGktLSApCgkJCXJldFtpXSA9IHRoaXMucGFyc2UoIGFycltpXSApOwkJCQkKCQl0aGlzLmRvd24oKTsKCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOwoJfTsKCQoJdmFyIHJlTmFtZSA9IC9eZnVuY3Rpb24gKFx3KykvOwoJCgl2YXIganNEdW1wID0gewoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCgkJCXZhcglwYXJzZXIgPSB0aGlzLnBhcnNlcnNbIHR5cGUgfHwgdGhpcy50eXBlT2Yob2JqKSBdOwoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsJCQkKCQkJCgkJCXJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCggdGhpcywgb2JqICkgOgoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7CgkJfSwKCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApIHsKCQkJdmFyIHR5cGU7CgkJCWlmICggb2JqID09PSBudWxsICkgewoJCQkJdHlwZSA9ICJudWxsIjsKCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewoJCQkJdHlwZSA9ICJ1bmRlZmluZWQiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7CgkJCQl0eXBlID0gInJlZ2V4cCI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvYmopKSB7CgkJCQl0eXBlID0gImRhdGUiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsKCQkJCXR5cGUgPSAiZnVuY3Rpb24iOwoJCQl9IGVsc2UgaWYgKG9iai5zZXRJbnRlcnZhbCAmJiBvYmouZG9jdW1lbnQgJiYgIW9iai5ub2RlVHlwZSkgewoJCQkJdHlwZSA9ICJ3aW5kb3ciOwoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSA9PT0gOSkgewoJCQkJdHlwZSA9ICJkb2N1bWVudCI7CgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7CgkJCQl0eXBlID0gIm5vZGUiOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAibnVtYmVyIiAmJiBvYmoubGVuZ3RoID49IDApIHsKCQkJCXR5cGUgPSAiYXJyYXkiOwoJCQl9IGVsc2UgewoJCQkJdHlwZSA9IHR5cGVvZiBvYmo7CgkJCX0KCQkJcmV0dXJuIHR5cGU7CgkJfSwKCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwoJCX0sCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwoJCQlpZiAoICF0aGlzLm11bHRpbGluZSApCgkJCQlyZXR1cm4gJyc7CgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CgkJCWlmICggdGhpcy5IVE1MICkKCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOwoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CgkJfSwKCQl1cDpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKCQl9LAoJCWRvd246ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CgkJfSwKCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsKCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwoJCX0sCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtCgkJcXVvdGU6cXVvdGUsIAoJCWxpdGVyYWw6bGl0ZXJhbCwKCQlqb2luOmpvaW4sCgkJLy8KCQlfZGVwdGhfOiAxLAoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCgkJcGFyc2Vyczp7CgkJCXdpbmRvdzogJ1tXaW5kb3ddJywKCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuCgkJCXVua25vd246ICdbVW5rbm93bl0nLAoJCQknbnVsbCc6J251bGwnLAoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsCgkJCSdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICkgewoJCQkJdmFyIHJldCA9ICdmdW5jdGlvbicsCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFCgkJCQlpZiAoIG5hbWUgKQoJCQkJCXJldCArPSAnICcgKyBuYW1lOwoJCQkJcmV0ICs9ICcoJzsKCQkJCQoJCQkJcmV0ID0gWyByZXQsIHRoaXMucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsKCQkJCXJldHVybiBqb2luKCByZXQsIHRoaXMucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsKCQkJfSwKCQkJYXJyYXk6IGFycmF5LAoJCQlub2RlbGlzdDogYXJyYXksCgkJCWFyZ3VtZW50czogYXJyYXksCgkJCW9iamVjdDpmdW5jdGlvbiggbWFwICkgewoJCQkJdmFyIHJldCA9IFsgXTsKCQkJCXRoaXMudXAoKTsKCQkJCWZvciAoIHZhciBrZXkgaW4gbWFwICkKCQkJCQlyZXQucHVzaCggdGhpcy5wYXJzZShrZXksJ2tleScpICsgJzogJyArIHRoaXMucGFyc2UobWFwW2tleV0pICk7CgkJCQl0aGlzLmRvd24oKTsKCQkJCXJldHVybiBqb2luKCAneycsIHJldCwgJ30nICk7CgkJCX0sCgkJCW5vZGU6ZnVuY3Rpb24oIG5vZGUgKSB7CgkJCQl2YXIgb3BlbiA9IHRoaXMuSFRNTCA/ICcmbHQ7JyA6ICc8JywKCQkJCQljbG9zZSA9IHRoaXMuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsKCQkJCQkKCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsKCQkJCQkKCQkJCWZvciAoIHZhciBhIGluIHRoaXMuRE9NQXR0cnMgKSB7CgkJCQkJdmFyIHZhbCA9IG5vZGVbdGhpcy5ET01BdHRyc1thXV07CgkJCQkJaWYgKCB2YWwgKQoJCQkJCQlyZXQgKz0gJyAnICsgYSArICc9JyArIHRoaXMucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsKCQkJCX0KCQkJCXJldHVybiByZXQgKyBjbG9zZSArIG9wZW4gKyAnLycgKyB0YWcgKyBjbG9zZTsKCQkJfSwKCQkJZnVuY3Rpb25BcmdzOmZ1bmN0aW9uKCBmbiApIHsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbgoJCQkJdmFyIGwgPSBmbi5sZW5ndGg7CgkJCQlpZiAoICFsICkgcmV0dXJuICcnOwkJCQkKCQkJCQoJCQkJdmFyIGFyZ3MgPSBBcnJheShsKTsKCQkJCXdoaWxlICggbC0tICkKCQkJCQlhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJwoJCQkJcmV0dXJuICcgJyArIGFyZ3Muam9pbignLCAnKSArICcgJzsKCQkJfSwKCQkJa2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAoJCQlmdW5jdGlvbkNvZGU6J1tjb2RlXScsIC8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgY29udGVudCBvZiB0aGUgZnVuY3Rpb24KCQkJYXR0cmlidXRlOnF1b3RlLCAvL25vZGUgY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyBhbiBodG1sIGF0dHJpYnV0ZSB2YWx1ZQoJCQlzdHJpbmc6cXVvdGUsCgkJCWRhdGU6cXVvdGUsCgkJCXJlZ2V4cDpsaXRlcmFsLCAvL3JlZ2V4CgkJCW51bWJlcjpsaXRlcmFsLAoJCQknYm9vbGVhbic6bGl0ZXJhbAoJCX0sCgkJRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lCgkJCWlkOidpZCcsCgkJCW5hbWU6J25hbWUnLAoJCQknY2xhc3MnOidjbGFzc05hbWUnCgkJfSwKCQlIVE1MOmZhbHNlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkKCQlpbmRlbnRDaGFyOicgICAnLC8vaW5kZW50YXRpb24gdW5pdAoJCW11bHRpbGluZTpmYWxzZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KCX07CgoJcmV0dXJuIGpzRHVtcDsKfSkoKTsKCn0pKHRoaXMpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 21:49:04 GMT",
                    "Content-Length": "29117",
                    "Date": "Fri, 07 Nov 2014 21:49:04 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}