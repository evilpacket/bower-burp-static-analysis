{
    "url": "http://localhost:9999/gmmorris/birdwatcherjs/test/qunit/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.search</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var testName = decodeURIComponent(location.search.slice(1));</li><li>banner.innerHTML = '&lt;a href=\"' + mainPageLocation + '\"&gt;' + banner.innerHTML + '&lt;/a&gt; &amp;#8250; &lt;a href=\"\"&gt;' + testName + '&lt;/a&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/gmmorris/birdwatcherjs/test/qunit/qunit.js",
                "path": "/gmmorris/birdwatcherjs/test/qunit/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9nbW1vcnJpcy9iaXJkd2F0Y2hlcmpzL3Rlc3QvcXVuaXQvcXVuaXQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDU0OTkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTI6NDE6NDggR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDEyOjQxOjQ2IEdNVA0KDQovKgogKiBRVW5pdCAtIEEgSmF2YVNjcmlwdCBVbml0IFRlc3RpbmcgRnJhbWV3b3JrCiAqIAogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewoKICAgIHZhciBkZWZpbmVkID0gewogICAgICAgIHNldFRpbWVvdXQ6IHR5cGVvZiB3aW5kb3cuc2V0VGltZW91dCAhPT0gInVuZGVmaW5lZCIKICAgIH0KCiAgICB2YXIgUVVuaXQgPSB7CgogICAgICAgIC8vIGNhbGwgb24gc3RhcnQgb2YgbW9kdWxlIHRlc3QgdG8gcHJlcGVuZCBuYW1lIHRvIGFsbCB0ZXN0cwogICAgICAgIG1vZHVsZTogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7CiAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgaWYgKCBjb25maWcucHJldmlvdXNNb2R1bGUgKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjb25maWcucHJldmlvdXNNb2R1bGUgPSBjb25maWcuY3VycmVudE1vZHVsZTsKICAgICAgICAgICAgICAgIGNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CiAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlU3RhdHMgPSB7IGFsbDogMCwgYmFkOiAwIH07CgogICAgICAgICAgICAgICAgUVVuaXQubW9kdWxlU3RhcnQoIG5hbWUsIHRlc3RFbnZpcm9ubWVudCApOwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICBhc3luY1Rlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2spIHsKICAgICAgICAgICAgaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gMDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgUVVuaXQudGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCB0cnVlKTsKICAgICAgICB9LAoKICAgICAgICB0ZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgewogICAgICAgICAgICB2YXIgbmFtZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1uYW1lIj4nICsgdGVzdE5hbWUgKyAnPC9zcGFuPicsIHRlc3RFbnZpcm9ubWVudCwgdGVzdEVudmlyb25tZW50QXJnOwoKICAgICAgICAgICAgaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewogICAgICAgICAgICAgICAgY2FsbGJhY2sgPSBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBpcyAybmQgYXJndW1lbnQgYSB0ZXN0RW52aXJvbm1lbnQ/CiAgICAgICAgICAgIGlmICggZXhwZWN0ZWQgJiYgdHlwZW9mIGV4cGVjdGVkID09PSAnb2JqZWN0JykgewogICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50QXJnID0gIGV4cGVjdGVkOwogICAgICAgICAgICAgICAgZXhwZWN0ZWQgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewogICAgICAgICAgICAgICAgbmFtZSA9ICc8c3BhbiBjbGFzcz0ibW9kdWxlLW5hbWUiPicgKyBjb25maWcuY3VycmVudE1vZHVsZSArICI8L3NwYW4+OiAiICsgbmFtZTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCAhdmFsaWRUZXN0KGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjogIiArIHRlc3ROYW1lKSApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgogICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsKICAgICAgICAgICAgICAgICAgICBzZXR1cDogZnVuY3Rpb24oKSB7fSwKICAgICAgICAgICAgICAgICAgICB0ZWFyZG93bjogZnVuY3Rpb24oKSB7fQogICAgICAgICAgICAgICAgfSwgY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICBpZiAodGVzdEVudmlyb25tZW50QXJnKSB7CiAgICAgICAgICAgICAgICAgICAgZXh0ZW5kKHRlc3RFbnZpcm9ubWVudCx0ZXN0RW52aXJvbm1lbnRBcmcpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIFFVbml0LnRlc3RTdGFydCggdGVzdE5hbWUsIHRlc3RFbnZpcm9ubWVudCApOwoKICAgICAgICAgICAgICAgIC8vIGFsbG93IHV0aWxpdHkgZnVuY3Rpb25zIHRvIGFjY2VzcyB0aGUgY3VycmVudCB0ZXN0IGVudmlyb25tZW50CiAgICAgICAgICAgICAgICBRVW5pdC5jdXJyZW50X3Rlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCiAgICAgICAgICAgICAgICBjb25maWcuYXNzZXJ0aW9ucyA9IFtdOwogICAgICAgICAgICAgICAgY29uZmlnLmV4cGVjdGVkID0gZXhwZWN0ZWQ7CgogICAgICAgICAgICAgICAgdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CiAgICAgICAgICAgICAgICBpZiAodGVzdHMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwogICAgICAgICAgICAgICAgICAgIGIuaW5uZXJIVE1MID0gIlJ1bm5pbmcgIiArIG5hbWU7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKICAgICAgICAgICAgICAgICAgICBsaS5hcHBlbmRDaGlsZCggYiApOwogICAgICAgICAgICAgICAgICAgIGxpLmlkID0gImN1cnJlbnQtdGVzdC1vdXRwdXQiOwogICAgICAgICAgICAgICAgICAgIHRlc3RzLmFwcGVuZENoaWxkKCBsaSApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZUdsb2JhbCgpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKCBmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICggYXN5bmMgKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuc3RvcCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwogICAgICAgICAgICAgICAgfSBjYXRjaChlKSB7CiAgICAgICAgICAgICAgICAgICAgZmFpbCgiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCBjYWxsYmFjayk7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSArICIgLSAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGUpICk7CiAgICAgICAgICAgICAgICAgICAgLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKICAgICAgICAgICAgICAgICAgICBzYXZlR2xvYmFsKCk7CgogICAgICAgICAgICAgICAgICAgIC8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcKICAgICAgICAgICAgICAgICAgICBpZiAoIGNvbmZpZy5ibG9ja2luZyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNoZWNrUG9sbHV0aW9uKCk7CiAgICAgICAgICAgICAgICAgICAgdGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKCBmYWxzZSwgIlRlYXJkb3duIGZhaWxlZCBvbiAiICsgbmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICggY29uZmlnLmV4cGVjdGVkICYmIGNvbmZpZy5leHBlY3RlZCAhPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soIGZhbHNlLCAiRXhwZWN0ZWQgIiArIGNvbmZpZy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiIHdlcmUgcnVuIiApOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHZhciBnb29kID0gMCwgYmFkID0gMCwKICAgICAgICAgICAgICAgICAgICB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoKICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwogICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7CgogICAgICAgICAgICAgICAgaWYgKCB0ZXN0cyApIHsKICAgICAgICAgICAgICAgICAgICB2YXIgb2wgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBhc3NlcnRpb24gPSBjb25maWcuYXNzZXJ0aW9uc1tpXTsKCiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9IGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCI7CiAgICAgICAgICAgICAgICAgICAgICAgIGxpLmlubmVySFRNTCA9IGFzc2VydGlvbi5tZXNzYWdlIHx8IChhc3NlcnRpb24ucmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwogICAgICAgICAgICAgICAgICAgICAgICBvbC5hcHBlbmRDaGlsZCggbGkgKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggYXNzZXJ0aW9uLnJlc3VsdCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdvb2QrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChiYWQgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBvbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKICAgICAgICAgICAgICAgICAgICBiLmlubmVySFRNTCA9IG5hbWUgKyAiIDxiIGNsYXNzPSdjb3VudHMnPig8YiBjbGFzcz0nZmFpbGVkJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzZWQnPiIgKyBnb29kICsgIjwvYj4sICIgKyBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOwoKICAgICAgICAgICAgICAgICAgICBhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5OwogICAgICAgICAgICAgICAgICAgICAgICBuZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwogICAgICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgICAgICBhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0YXJnZXQgPSBlICYmIGUudGFyZ2V0ID8gZS50YXJnZXQgOiB3aW5kb3cuZXZlbnQuc3JjRWxlbWVudDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAic3BhbiIgfHwgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gImIiICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB3aW5kb3cubG9jYXRpb24gJiYgdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9ICI/IiArIGVuY29kZVVSSUNvbXBvbmVudChnZXRUZXh0KFt0YXJnZXRdKS5yZXBsYWNlKC9cKC4rXCkkLywgIiIpLnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgdmFyIGxpID0gaWQoImN1cnJlbnQtdGVzdC1vdXRwdXQiKTsKICAgICAgICAgICAgICAgICAgICBsaS5pZCA9ICIiOwogICAgICAgICAgICAgICAgICAgIGxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKICAgICAgICAgICAgICAgICAgICBsaS5zdHlsZS5kaXNwbGF5ID0gcmVzdWx0RGlzcGxheVN0eWxlKCFiYWQpOwogICAgICAgICAgICAgICAgICAgIGxpLnJlbW92ZUNoaWxkKCBsaS5maXJzdENoaWxkICk7CiAgICAgICAgICAgICAgICAgICAgbGkuYXBwZW5kQ2hpbGQoIGIgKTsKICAgICAgICAgICAgICAgICAgICBsaS5hcHBlbmRDaGlsZCggb2wgKTsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCBiYWQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHRvb2xiYXIgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWQoInF1bml0LWZpbHRlci1taXNzaW5nIikuZGlzYWJsZWQgPSBudWxsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggIWNvbmZpZy5hc3NlcnRpb25zW2ldLnJlc3VsdCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQucmVzZXQoKTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWwoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgbmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIFFVbml0LnJlc2V0KTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBRVW5pdC50ZXN0RG9uZSggdGVzdE5hbWUsIGJhZCwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc3luY2hyb25pemUoIGRvbmUgKTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCiAgICAgICAgICovCiAgICAgICAgZXhwZWN0OiBmdW5jdGlvbihhc3NlcnRzKSB7CiAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCA9IGFzc2VydHM7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQXNzZXJ0cyB0cnVlLgogICAgICAgICAqIEBleGFtcGxlIG9rKCAiYXNkZmFzZGYiLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnMiICk7CiAgICAgICAgICovCiAgICAgICAgb2s6IGZ1bmN0aW9uKGEsIG1zZykgewogICAgICAgICAgICBhID0gISFhOwogICAgICAgICAgICB2YXIgZGV0YWlscyA9IHsKICAgICAgICAgICAgICAgIHJlc3VsdDogYSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZwogICAgICAgICAgICB9OwogICAgICAgICAgICBtc2cgPSBlc2NhcGVIdG1sKG1zZyk7CiAgICAgICAgICAgIFFVbml0LmxvZyhhLCBtc2csIGRldGFpbHMpOwogICAgICAgICAgICBjb25maWcuYXNzZXJ0aW9ucy5wdXNoKHsKICAgICAgICAgICAgICAgIHJlc3VsdDogYSwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1zZwogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KICAgICAgICAgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCiAgICAgICAgICoKICAgICAgICAgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlIGVxdWFsKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIE9iamVjdCBhY3R1YWwKICAgICAgICAgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkCiAgICAgICAgICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKICAgICAgICAgKi8KICAgICAgICBlcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBRVW5pdC5wdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgUVVuaXQucHVzaChleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIGRlZXBFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBRVW5pdC5wdXNoKFFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBub3REZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgUVVuaXQucHVzaCghUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIHN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIFFVbml0LnB1c2goZXhwZWN0ZWQgPT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgUVVuaXQucHVzaChleHBlY3RlZCAhPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICByYWlzZXM6IGZ1bmN0aW9uKGZuLCAgbWVzc2FnZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgZm4oKTsKICAgICAgICAgICAgICAgIG9rKCBmYWxzZSwgbWVzc2FnZSApOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICBvayggdHJ1ZSwgbWVzc2FnZSApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc3RhcnQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAvLyBBIHNsaWdodCBkZWxheSwgdG8gYXZvaWQgYW55IGN1cnJlbnQgY2FsbGJhY2tzCiAgICAgICAgICAgIGlmICggZGVmaW5lZC5zZXRUaW1lb3V0ICkgewogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCBjb25maWcudGltZW91dCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgICAgIH0sIDEzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgcHJvY2VzcygpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgc3RvcDogZnVuY3Rpb24odGltZW91dCkgewogICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSB0cnVlOwoKICAgICAgICAgICAgaWYgKCB0aW1lb3V0ICYmIGRlZmluZWQuc2V0VGltZW91dCApIHsKICAgICAgICAgICAgICAgIGNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgICAgICAgICAgICAgIH0sIHRpbWVvdXQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgIH07CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgZGVwcmVjYXRlZAogICAgUVVuaXQuZXF1YWxzID0gUVVuaXQuZXF1YWw7CiAgICBRVW5pdC5zYW1lID0gUVVuaXQuZGVlcEVxdWFsOwoKLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUKICAgIHZhciBjb25maWcgPSB7CiAgICAgICAgLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bgogICAgICAgIHF1ZXVlOiBbXSwKCiAgICAgICAgLy8gYmxvY2sgdW50aWwgZG9jdW1lbnQgcmVhZHkKICAgICAgICBibG9ja2luZzogdHJ1ZQogICAgfTsKCi8vIExvYWQgcGFyYW1hdGVycwogICAgKGZ1bmN0aW9uKCkgewogICAgICAgIHZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDogIiIsIHByb3RvY29sOiAiZmlsZToiIH0sCiAgICAgICAgICAgIEdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoKICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBHRVRQYXJhbXMubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIEdFVFBhcmFtc1tpXSA9IGRlY29kZVVSSUNvbXBvbmVudCggR0VUUGFyYW1zW2ldICk7CiAgICAgICAgICAgIGlmICggR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIiApIHsKICAgICAgICAgICAgICAgIEdFVFBhcmFtcy5zcGxpY2UoIGksIDEgKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIGNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKCBHRVRQYXJhbXNbaV0uc2VhcmNoKCc9JykgPiAtMSApIHsKICAgICAgICAgICAgICAgIEdFVFBhcmFtcy5zcGxpY2UoIGksIDEgKTsKICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgLy8gcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycwogICAgICAgIGNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOwoKICAgICAgICAvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90CiAgICAgICAgUVVuaXQuaXNMb2NhbCA9ICEhKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKTsKICAgIH0pKCk7CgovLyBFeHBvc2UgdGhlIEFQSSBhcyBnbG9iYWwgdmFyaWFibGVzLCB1bmxlc3MgYW4gJ2V4cG9ydHMnCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMKICAgIGlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsKICAgICAgICBleHRlbmQod2luZG93LCBRVW5pdCk7CiAgICAgICAgd2luZG93LlFVbml0ID0gUVVuaXQ7CiAgICB9IGVsc2UgewogICAgICAgIGV4dGVuZChleHBvcnRzLCBRVW5pdCk7CiAgICAgICAgZXhwb3J0cy5RVW5pdCA9IFFVbml0OwogICAgfQoKLy8gZGVmaW5lIHRoZXNlIGFmdGVyIGV4cG9zaW5nIGdsb2JhbHMgdG8ga2VlcCB0aGVtIGluIHRoZXNlIFFVbml0IG5hbWVzcGFjZSBvbmx5CiAgICBleHRlbmQoUVVuaXQsIHsKICAgICAgICBjb25maWc6IGNvbmZpZywKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiBvcHRpb25zCiAgICAgICAgaW5pdDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGV4dGVuZChjb25maWcsIHsKICAgICAgICAgICAgICAgIHN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCiAgICAgICAgICAgICAgICBtb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAogICAgICAgICAgICAgICAgc3RhcnRlZDogK25ldyBEYXRlLAogICAgICAgICAgICAgICAgdXBkYXRlUmF0ZTogMTAwMCwKICAgICAgICAgICAgICAgIGJsb2NraW5nOiBmYWxzZSwKICAgICAgICAgICAgICAgIGF1dG9zdGFydDogdHJ1ZSwKICAgICAgICAgICAgICAgIGF1dG9ydW46IGZhbHNlLAogICAgICAgICAgICAgICAgYXNzZXJ0aW9uczogW10sCiAgICAgICAgICAgICAgICBmaWx0ZXJzOiBbXSwKICAgICAgICAgICAgICAgIHF1ZXVlOiBbXQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAogICAgICAgICAgICAgICAgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAogICAgICAgICAgICAgICAgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCiAgICAgICAgICAgIGlmICggdGVzdHMgKSB7CiAgICAgICAgICAgICAgICB0ZXN0cy5pbm5lckhUTUwgPSAiIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCBiYW5uZXIgKSB7CiAgICAgICAgICAgICAgICBiYW5uZXIuY2xhc3NOYW1lID0gIiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggcmVzdWx0ICkgewogICAgICAgICAgICAgICAgcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHJlc3VsdCApOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCiAgICAgICAgICoKICAgICAgICAgKiBJZiBqUXVlcnkgaXMgYXZhaWxhYmxlLCB1c2VzIGpRdWVyeSdzIGh0bWwoKSwgb3RoZXJ3aXNlIGp1c3QgaW5uZXJIVE1MLgogICAgICAgICAqLwogICAgICAgIHJlc2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgaWYgKCB3aW5kb3cualF1ZXJ5ICkgewogICAgICAgICAgICAgICAgalF1ZXJ5KCAiI21haW4sICNxdW5pdC1maXh0dXJlIiApLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YXIgbWFpbiA9IGlkKCAnbWFpbicgKSB8fCBpZCggJ3F1bml0LWZpeHR1cmUnICk7CiAgICAgICAgICAgICAgICBpZiAoIG1haW4gKSB7CiAgICAgICAgICAgICAgICAgICAgbWFpbi5pbm5lckhUTUwgPSBjb25maWcuZml4dHVyZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KICAgICAgICAgKgogICAgICAgICAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwogICAgICAgICAqCiAgICAgICAgICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQogICAgICAgICAqIEBwYXJhbSBTdHJpbmcgdHlwZQogICAgICAgICAqLwogICAgICAgIHRyaWdnZXJFdmVudDogZnVuY3Rpb24oIGVsZW0sIHR5cGUsIGV2ZW50ICkgewogICAgICAgICAgICBpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewogICAgICAgICAgICAgICAgZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKICAgICAgICAgICAgICAgIGV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKICAgICAgICAgICAgICAgICAgICAwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CiAgICAgICAgICAgICAgICBlbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7CgogICAgICAgICAgICB9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsKICAgICAgICAgICAgICAgIGVsZW0uZmlyZUV2ZW50KCJvbiIrdHlwZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCiAgICAgICAgaXM6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CiAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKCBvYmogKSA9PSB0eXBlOwogICAgICAgIH0sCgogICAgICAgIG9iamVjdFR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuICJ1bmRlZmluZWQiOwoKICAgICAgICAgICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKG9iaiA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIHR5cGUgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoIG9iaiApCiAgICAgICAgICAgICAgICAubWF0Y2goL15cW29iamVjdFxzKC4qKVxdJC8pWzFdIHx8ICcnOwoKICAgICAgICAgICAgc3dpdGNoICh0eXBlKSB7CiAgICAgICAgICAgICAgICBjYXNlICdOdW1iZXInOgogICAgICAgICAgICAgICAgICAgIGlmIChpc05hTihvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIm51bWJlciI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2FzZSAnU3RyaW5nJzoKICAgICAgICAgICAgICAgIGNhc2UgJ0Jvb2xlYW4nOgogICAgICAgICAgICAgICAgY2FzZSAnQXJyYXknOgogICAgICAgICAgICAgICAgY2FzZSAnRGF0ZSc6CiAgICAgICAgICAgICAgICBjYXNlICdSZWdFeHAnOgogICAgICAgICAgICAgICAgY2FzZSAnRnVuY3Rpb24nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB0eXBlLnRvTG93ZXJDYXNlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gIm9iamVjdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9LAoKICAgICAgICBwdXNoOiBmdW5jdGlvbihyZXN1bHQsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgdmFyIGRldGFpbHMgPSB7CiAgICAgICAgICAgICAgICByZXN1bHQ6IHJlc3VsdCwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCiAgICAgICAgICAgICAgICBhY3R1YWw6IGFjdHVhbCwKICAgICAgICAgICAgICAgIGV4cGVjdGVkOiBleHBlY3RlZAogICAgICAgICAgICB9OwoKICAgICAgICAgICAgbWVzc2FnZSA9IGVzY2FwZUh0bWwobWVzc2FnZSkgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKICAgICAgICAgICAgbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1tZXNzYWdlIj4nICsgbWVzc2FnZSArICI8L3NwYW4+IjsKICAgICAgICAgICAgZXhwZWN0ZWQgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkpOwogICAgICAgICAgICBhY3R1YWwgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpKTsKICAgICAgICAgICAgdmFyIG91dHB1dCA9IG1lc3NhZ2UgKyAnLCBleHBlY3RlZDogPHNwYW4gY2xhc3M9InRlc3QtZXhwZWN0ZWQiPicgKyBleHBlY3RlZCArICc8L3NwYW4+JzsKICAgICAgICAgICAgaWYgKGFjdHVhbCAhPSBleHBlY3RlZCkgewogICAgICAgICAgICAgICAgb3V0cHV0ICs9ICcgcmVzdWx0OiA8c3BhbiBjbGFzcz0idGVzdC1hY3R1YWwiPicgKyBhY3R1YWwgKyAnPC9zcGFuPiwgZGlmZjogJyArIFFVbml0LmRpZmYoZXhwZWN0ZWQsIGFjdHVhbCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFFVbml0LmxvZyhyZXN1bHQsIG1lc3NhZ2UsIGRldGFpbHMpOwoKICAgICAgICAgICAgY29uZmlnLmFzc2VydGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICByZXN1bHQ6ICEhcmVzdWx0LAogICAgICAgICAgICAgICAgbWVzc2FnZTogb3V0cHV0CiAgICAgICAgICAgIH0pOwogICAgICAgIH0sCgogICAgICAgIC8vIExvZ2dpbmcgY2FsbGJhY2tzCiAgICAgICAgYmVnaW46IGZ1bmN0aW9uKCkge30sCiAgICAgICAgZG9uZTogZnVuY3Rpb24oZmFpbHVyZXMsIHRvdGFsKSB7fSwKICAgICAgICBsb2c6IGZ1bmN0aW9uKHJlc3VsdCwgbWVzc2FnZSkge30sCiAgICAgICAgdGVzdFN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LAogICAgICAgIHRlc3REb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9LAogICAgICAgIG1vZHVsZVN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LAogICAgICAgIG1vZHVsZURvbmU6IGZ1bmN0aW9uKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30KICAgIH0pOwoKICAgIGlmICggdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewogICAgICAgIGNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKICAgIH0KCiAgICBhZGRFdmVudCh3aW5kb3csICJsb2FkIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgUVVuaXQuYmVnaW4oKTsKCiAgICAgICAgLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQogICAgICAgIHZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7CiAgICAgICAgUVVuaXQuaW5pdCgpOwogICAgICAgIGV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7CgogICAgICAgIGNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoKICAgICAgICB2YXIgdXNlckFnZW50ID0gaWQoInF1bml0LXVzZXJBZ2VudCIpOwogICAgICAgIGlmICggdXNlckFnZW50ICkgewogICAgICAgICAgICB1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKICAgICAgICB9CiAgICAgICAgdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1oZWFkZXIiKTsKICAgICAgICBpZiAoIGJhbm5lciApIHsKICAgICAgICAgICAgdmFyIHBhcmFtc0luZGV4ID0gbG9jYXRpb24uaHJlZi5sYXN0SW5kZXhPZihsb2NhdGlvbi5zZWFyY2gpOwogICAgICAgICAgICBpZiAoIHBhcmFtc0luZGV4ID4gLTEgKSB7CiAgICAgICAgICAgICAgICB2YXIgbWFpblBhZ2VMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYuc2xpY2UoMCwgcGFyYW1zSW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKCBtYWluUGFnZUxvY2F0aW9uID09IGxvY2F0aW9uLmhyZWYgKSB7CiAgICAgICAgICAgICAgICAgICAgYmFubmVyLmlubmVySFRNTCA9ICc8YSBocmVmPSIiPiAnICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICc7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhciB0ZXN0TmFtZSA9IGRlY29kZVVSSUNvbXBvbmVudChsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkpOwogICAgICAgICAgICAgICAgICAgIGJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iJyArIG1haW5QYWdlTG9jYXRpb24gKyAnIj4nICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICYjODI1MDsgPGEgaHJlZj0iIj4nICsgdGVzdE5hbWUgKyAnPC9hPic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwogICAgICAgIGlmICggdG9vbGJhciApIHsKICAgICAgICAgICAgdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgICAgICAgdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgIGZpbHRlci50eXBlID0gImNoZWNrYm94IjsKICAgICAgICAgICAgZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsKICAgICAgICAgICAgZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgYWRkRXZlbnQoIGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgICAgIGlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoInBhc3MiKSA+IC0xICkgewogICAgICAgICAgICAgICAgICAgICAgICBsaVtpXS5zdHlsZS5kaXNwbGF5ID0gZmlsdGVyLmNoZWNrZWQgPyAibm9uZSIgOiAiIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsKCiAgICAgICAgICAgIHZhciBsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CiAgICAgICAgICAgIGxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7CiAgICAgICAgICAgIGxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7CgogICAgICAgICAgICB2YXIgbWlzc2luZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CiAgICAgICAgICAgIG1pc3NpbmcudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgICAgIG1pc3NpbmcuaWQgPSAicXVuaXQtZmlsdGVyLW1pc3NpbmciOwogICAgICAgICAgICBtaXNzaW5nLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgICAgICAgYWRkRXZlbnQoIG1pc3NpbmcsICJjbGljayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJmYWlsIikgPiAtMSAmJiBsaVtpXS5pbm5lckhUTUwuaW5kZXhPZignbWlzc2luZyB0ZXN0IC0gdW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZScpID4gLSAxICkgewogICAgICAgICAgICAgICAgICAgICAgICBsaVtpXS5wYXJlbnROb2RlLnBhcmVudE5vZGUuc3R5bGUuZGlzcGxheSA9IG1pc3NpbmcuY2hlY2tlZCA/ICJub25lIiA6ICJibG9jayI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdG9vbGJhci5hcHBlbmRDaGlsZCggbWlzc2luZyApOwoKICAgICAgICAgICAgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItbWlzc2luZyIpOwogICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBtaXNzaW5nIHRlc3RzICh1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlKSI7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7CiAgICAgICAgfQoKICAgICAgICB2YXIgbWFpbiA9IGlkKCdtYWluJykgfHwgaWQoJ3F1bml0LWZpeHR1cmUnKTsKICAgICAgICBpZiAoIG1haW4gKSB7CiAgICAgICAgICAgIGNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7CiAgICAgICAgfQoKICAgICAgICBpZiAoY29uZmlnLmF1dG9zdGFydCkgewogICAgICAgICAgICBRVW5pdC5zdGFydCgpOwogICAgICAgIH0KICAgIH0pOwoKICAgIGZ1bmN0aW9uIGRvbmUoKSB7CiAgICAgICAgaWYgKCBjb25maWcuZG9uZVRpbWVyICYmIHdpbmRvdy5jbGVhclRpbWVvdXQgKSB7CiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQoIGNvbmZpZy5kb25lVGltZXIgKTsKICAgICAgICAgICAgY29uZmlnLmRvbmVUaW1lciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICBpZiAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CiAgICAgICAgICAgIGlmICggZGVmaW5lZC5zZXRUaW1lb3V0ICkgewogICAgICAgICAgICAgICAgY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CiAgICAgICAgICAgICAgICAgICAgaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSgpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN5bmNocm9uaXplKCBkb25lICk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwgMTMpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBjb25maWcuYXV0b3J1biA9IHRydWU7CgogICAgICAgIC8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cwogICAgICAgIGlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CiAgICAgICAgICAgIFFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7CiAgICAgICAgfQoKICAgICAgICB2YXIgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAogICAgICAgICAgICB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAogICAgICAgICAgICBodG1sID0gWydUZXN0cyBjb21wbGV0ZWQgaW4gJywKICAgICAgICAgICAgICAgICtuZXcgRGF0ZSAtIGNvbmZpZy5zdGFydGVkLCAnIG1pbGxpc2Vjb25kcy48YnIvPicsCiAgICAgICAgICAgICAgICAnPHNwYW4gY2xhc3M9InBhc3NlZCI+JywgY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJ0b3RhbCI+JywgY29uZmlnLnN0YXRzLmFsbCwgJzwvc3Bhbj4gcGFzc2VkLCA8c3BhbiBjbGFzcz0iZmFpbGVkIj4nLCBjb25maWcuc3RhdHMuYmFkLCc8L3NwYW4+IGZhaWxlZC4nXS5qb2luKCcnKTsKCiAgICAgICAgaWYgKCBiYW5uZXIgKSB7CiAgICAgICAgICAgIGJhbm5lci5jbGFzc05hbWUgPSAoY29uZmlnLnN0YXRzLmJhZCA/ICJxdW5pdC1mYWlsIiA6ICJxdW5pdC1wYXNzIik7CiAgICAgICAgfQoKICAgICAgICBpZiAoIHRlc3RzICkgewogICAgICAgICAgICB2YXIgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCiAgICAgICAgICAgIGlmICggIXJlc3VsdCApIHsKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKICAgICAgICAgICAgICAgIHJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsKICAgICAgICAgICAgICAgIHJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsKICAgICAgICAgICAgICAgIHRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJlc3VsdC5pbm5lckhUTUwgPSBodG1sOwogICAgICAgIH0KCiAgICAgICAgUVVuaXQuZG9uZSggY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCApOwogICAgfQoKICAgIGZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKICAgICAgICB2YXIgaSA9IGNvbmZpZy5maWx0ZXJzLmxlbmd0aCwKICAgICAgICAgICAgcnVuID0gZmFsc2U7CgogICAgICAgIGlmICggIWkgKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKCBpLS0gKSB7CiAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKICAgICAgICAgICAgICAgIG5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoKICAgICAgICAgICAgaWYgKCBub3QgKSB7CiAgICAgICAgICAgICAgICBmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggbmFtZS5pbmRleE9mKGZpbHRlcikgIT09IC0xICkgewogICAgICAgICAgICAgICAgcmV0dXJuICFub3Q7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggbm90ICkgewogICAgICAgICAgICAgICAgcnVuID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJ1bjsKICAgIH0KCiAgICBmdW5jdGlvbiByZXN1bHREaXNwbGF5U3R5bGUocGFzc2VkKSB7CiAgICAgICAgcmV0dXJuIHBhc3NlZCAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKSAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKS5jaGVja2VkID8gJ25vbmUnIDogJyc7CiAgICB9CgogICAgZnVuY3Rpb24gZXNjYXBlSHRtbChzKSB7CiAgICAgICAgaWYgKCFzKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgcyA9IHMgKyAiIjsKICAgICAgICByZXR1cm4gcy5yZXBsYWNlKC9bXCYiPD5cXF0vZywgZnVuY3Rpb24ocykgewogICAgICAgICAgICBzd2l0Y2gocykgewogICAgICAgICAgICAgICAgY2FzZSAiJiI6IHJldHVybiAiJmFtcDsiOwogICAgICAgICAgICAgICAgY2FzZSAiXFwiOiByZXR1cm4gIlxcXFwiOwogICAgICAgICAgICAgICAgY2FzZSAnIic6IHJldHVybiAnXCInOwogICAgICAgICAgICAgICAgY2FzZSAiPCI6IHJldHVybiAiJmx0OyI7CiAgICAgICAgICAgICAgICBjYXNlICI+IjogcmV0dXJuICImZ3Q7IjsKICAgICAgICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBzOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CgogICAgZnVuY3Rpb24gc3luY2hyb25pemUoIGNhbGxiYWNrICkgewogICAgICAgIGNvbmZpZy5xdWV1ZS5wdXNoKCBjYWxsYmFjayApOwoKICAgICAgICBpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CiAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gcHJvY2VzcygpIHsKICAgICAgICB2YXIgc3RhcnQgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpOwoKICAgICAgICB3aGlsZSAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKICAgICAgICAgICAgaWYgKCBjb25maWcudXBkYXRlUmF0ZSA8PSAwIHx8ICgoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHN0YXJ0KSA8IGNvbmZpZy51cGRhdGVSYXRlKSApIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5xdWV1ZS5zaGlmdCgpKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCggcHJvY2VzcywgMTMgKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7CiAgICAgICAgY29uZmlnLnBvbGx1dGlvbiA9IFtdOwoKICAgICAgICBpZiAoIGNvbmZpZy5ub2dsb2JhbHMgKSB7CiAgICAgICAgICAgIGZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgewogICAgICAgICAgICAgICAgY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBjaGVja1BvbGx1dGlvbiggbmFtZSApIHsKICAgICAgICB2YXIgb2xkID0gY29uZmlnLnBvbGx1dGlvbjsKICAgICAgICBzYXZlR2xvYmFsKCk7CgogICAgICAgIHZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7CiAgICAgICAgaWYgKCBuZXdHbG9iYWxzLmxlbmd0aCA+IDAgKSB7CiAgICAgICAgICAgIG9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7CiAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCsrOwogICAgICAgIH0KCiAgICAgICAgdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7CiAgICAgICAgaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgewogICAgICAgICAgICBvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsKICAgICAgICAgICAgY29uZmlnLmV4cGVjdGVkKys7CiAgICAgICAgfQogICAgfQoKLy8gcmV0dXJucyBhIG5ldyBBcnJheSB3aXRoIHRoZSBlbGVtZW50cyB0aGF0IGFyZSBpbiBhIGJ1dCBub3QgaW4gYgogICAgZnVuY3Rpb24gZGlmZiggYSwgYiApIHsKICAgICAgICB2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwogICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgZm9yICggdmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKyApIHsKICAgICAgICAgICAgICAgIGlmICggcmVzdWx0W2ldID09PSBiW2pdICkgewogICAgICAgICAgICAgICAgICAgIHJlc3VsdC5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXN1bHQ7CiAgICB9CgogICAgZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CiAgICAgICAgaWYgKCB0eXBlb2YgY29uc29sZSAhPT0gInVuZGVmaW5lZCIgJiYgY29uc29sZS5lcnJvciAmJiBjb25zb2xlLndhcm4gKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsKICAgICAgICAgICAgY29uc29sZS53YXJuKGNhbGxiYWNrLnRvU3RyaW5nKCkpOwoKICAgICAgICB9IGVsc2UgaWYgKCB3aW5kb3cub3BlcmEgJiYgb3BlcmEucG9zdEVycm9yICkgewogICAgICAgICAgICBvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7CiAgICAgICAgZm9yICggdmFyIHByb3AgaW4gYiApIHsKICAgICAgICAgICAgYVtwcm9wXSA9IGJbcHJvcF07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gYTsKICAgIH0KCiAgICBmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewogICAgICAgIGlmICggZWxlbS5hZGRFdmVudExpc3RlbmVyICkgewogICAgICAgICAgICBlbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwogICAgICAgIH0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CiAgICAgICAgICAgIGVsZW0uYXR0YWNoRXZlbnQoICJvbiIgKyB0eXBlLCBmbiApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZuKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGlkKG5hbWUpIHsKICAgICAgICByZXR1cm4gISEodHlwZW9mIGRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiBkb2N1bWVudCAmJiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCkgJiYKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG5hbWUgKTsKICAgIH0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KICAgIFFVbml0LmVxdWl2ID0gZnVuY3Rpb24gKCkgewoKICAgICAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24KICAgICAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwogICAgICAgIHZhciBwYXJlbnRzID0gW107IC8vIHN0YWNrIHRvIGF2b2lkaW5nIGxvb3BzIGZyb20gY2lyY3VsYXIgcmVmZXJlbmNpbmcKCiAgICAgICAgLy8gQ2FsbCB0aGUgbyByZWxhdGVkIGNhbGxiYWNrIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgICAgICBmdW5jdGlvbiBiaW5kQ2FsbGJhY2tzKG8sIGNhbGxiYWNrcywgYXJncykgewogICAgICAgICAgICB2YXIgcHJvcCA9IFFVbml0Lm9iamVjdFR5cGUobyk7CiAgICAgICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgICAgICBpZiAoUVVuaXQub2JqZWN0VHlwZShjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7CiAgICAgICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7CiAgICAgICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICAgICAibmFuIjogZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgICAgIH0sCgogICAgICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgICAgIGEuZ2xvYmFsID09PSBiLmdsb2JhbCAmJiAvLyBhbmQgaXRzIG1vZGlmZXJzIChnbWkpIC4uLgogICAgICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQogICAgICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgICAgICAvLyAgIGluaXRpYWwgPT09IHdvdWxkIGhhdmUgY2F0Y2ggaWRlbnRpY2FsIHJlZmVyZW5jZXMgYW55d2F5CiAgICAgICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGVyICE9PSBPYmplY3QgJiYKICAgICAgICAgICAgICAgICAgICAgICAgdHlwZW9mIGNhbGxlciAhPT0gInVuZGVmaW5lZCI7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGksIGosIGxvb3A7CiAgICAgICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICAgICAgaWYgKCAhIChRVW5pdC5vYmplY3RUeXBlKGIpID09PSAiYXJyYXkiKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOy8vZG9udCByZXdhbGsgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0CiAgICAgICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwogICAgICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAogICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsgLy9kb24ndCBnbyBkb3duIHRoZSBzYW1lIHBhdGggdHdpY2UKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCiAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKCiAgICAgICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIH0oKTsKCiAgICAgICAgaW5uZXJFcXVpdiA9IGZ1bmN0aW9uICgpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzCiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbgogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IFFVbml0Lm9iamVjdFR5cGUoYSkgIT09IFFVbml0Lm9iamVjdFR5cGUoYikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBiaW5kQ2FsbGJhY2tzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7CiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGlubmVyRXF1aXY7CgogICAgfSgpOwoKICAgIC8qKgogICAgICoganNEdW1wCiAgICAgKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICAgICAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApCiAgICAgKiBEYXRlOiA1LzE1LzIwMDgKICAgICAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogICAgICogQHZlcnNpb24gMS4wLjAKICAgICAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcgogICAgICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogICAgICovCiAgICBRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsKICAgICAgICAgICAgcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOwogICAgICAgIH07CiAgICAgICAgZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsKICAgICAgICAgICAgcmV0dXJuIG8gKyAnJzsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgewogICAgICAgICAgICB2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKICAgICAgICAgICAgICAgIGJhc2UgPSBqc0R1bXAuaW5kZW50KCksCiAgICAgICAgICAgICAgICBpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CiAgICAgICAgICAgIGlmICggYXJyLmpvaW4gKQogICAgICAgICAgICAgICAgYXJyID0gYXJyLmpvaW4oICcsJyArIHMgKyBpbm5lciApOwogICAgICAgICAgICBpZiAoICFhcnIgKQogICAgICAgICAgICAgICAgcmV0dXJuIHByZSArIHBvc3Q7CiAgICAgICAgICAgIHJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7CiAgICAgICAgICAgIHZhciBpID0gYXJyLmxlbmd0aCwJcmV0ID0gQXJyYXkoaSk7CiAgICAgICAgICAgIHRoaXMudXAoKTsKICAgICAgICAgICAgd2hpbGUgKCBpLS0gKQogICAgICAgICAgICAgICAgcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CiAgICAgICAgICAgIHRoaXMuZG93bigpOwogICAgICAgICAgICByZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOwogICAgICAgIH07CgogICAgICAgIHZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsKCiAgICAgICAgdmFyIGpzRHVtcCA9IHsKICAgICAgICAgICAgcGFyc2U6ZnVuY3Rpb24oIG9iaiwgdHlwZSApIHsgLy90eXBlIGlzIHVzZWQgbW9zdGx5IGludGVybmFsbHksIHlvdSBjYW4gZml4IGEgKGN1c3RvbSl0eXBlIGluIGFkdmFuY2UKICAgICAgICAgICAgICAgIHZhcglwYXJzZXIgPSB0aGlzLnBhcnNlcnNbIHR5cGUgfHwgdGhpcy50eXBlT2Yob2JqKSBdOwogICAgICAgICAgICAgICAgdHlwZSA9IHR5cGVvZiBwYXJzZXI7CgogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFyc2Vycy5lcnJvcjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdHlwZU9mOmZ1bmN0aW9uKCBvYmogKSB7CiAgICAgICAgICAgICAgICB2YXIgdHlwZTsKICAgICAgICAgICAgICAgIGlmICggb2JqID09PSBudWxsICkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAibnVsbCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChRVW5pdC5pcygiUmVnRXhwIiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAicmVnZXhwIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvYmopKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJkYXRlIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIkZ1bmN0aW9uIiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZnVuY3Rpb24iOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnNldEludGVydmFsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG9iai5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIG9iai5ub2RlVHlwZSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIndpbmRvdyI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSA9PT0gOSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZG9jdW1lbnQiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvYmoubm9kZVR5cGUpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIm5vZGUiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IiAmJiB0eXBlb2Ygb2JqLmxlbmd0aCA9PT0gIm51bWJlciIgJiYgb2JqLmxlbmd0aCA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJhcnJheSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2Ygb2JqOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHR5cGU7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNlcGFyYXRvcjpmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwogICAgICAgICAgICB9LAogICAgICAgICAgICBpbmRlbnQ6ZnVuY3Rpb24oIGV4dHJhICkgey8vIGV4dHJhIGNhbiBiZSBhIG51bWJlciwgc2hvcnRjdXQgZm9yIGluY3JlYXNpbmctY2FsbGluZy1kZWNyZWFzaW5nCiAgICAgICAgICAgICAgICBpZiAoICF0aGlzLm11bHRpbGluZSApCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcnOwogICAgICAgICAgICAgICAgdmFyIGNociA9IHRoaXMuaW5kZW50Q2hhcjsKICAgICAgICAgICAgICAgIGlmICggdGhpcy5IVE1MICkKICAgICAgICAgICAgICAgICAgICBjaHIgPSBjaHIucmVwbGFjZSgvXHQvZywnICAgJykucmVwbGFjZSgvIC9nLCcmbmJzcDsnKTsKICAgICAgICAgICAgICAgIHJldHVybiBBcnJheSggdGhpcy5fZGVwdGhfICsgKGV4dHJhfHwwKSApLmpvaW4oY2hyKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdXA6ZnVuY3Rpb24oIGEgKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9kZXB0aF8gKz0gYSB8fCAxOwogICAgICAgICAgICB9LAogICAgICAgICAgICBkb3duOmZ1bmN0aW9uKCBhICkgewogICAgICAgICAgICAgICAgdGhpcy5fZGVwdGhfIC09IGEgfHwgMTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0UGFyc2VyOmZ1bmN0aW9uKCBuYW1lLCBwYXJzZXIgKSB7CiAgICAgICAgICAgICAgICB0aGlzLnBhcnNlcnNbbmFtZV0gPSBwYXJzZXI7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIC8vIFRoZSBuZXh0IDMgYXJlIGV4cG9zZWQgc28geW91IGNhbiB1c2UgdGhlbQogICAgICAgICAgICBxdW90ZTpxdW90ZSwKICAgICAgICAgICAgbGl0ZXJhbDpsaXRlcmFsLAogICAgICAgICAgICBqb2luOmpvaW4sCiAgICAgICAgICAgIC8vCiAgICAgICAgICAgIF9kZXB0aF86IDEsCiAgICAgICAgICAgIC8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCiAgICAgICAgICAgIHBhcnNlcnM6ewogICAgICAgICAgICAgICAgd2luZG93OiAnW1dpbmRvd10nLAogICAgICAgICAgICAgICAgZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKICAgICAgICAgICAgICAgIGVycm9yOidbRVJST1JdJywgLy93aGVuIG5vIHBhcnNlciBpcyBmb3VuZCwgc2hvdWxkbid0IGhhcHBlbgogICAgICAgICAgICAgICAgdW5rbm93bjogJ1tVbmtub3duXScsCiAgICAgICAgICAgICAgICAnbnVsbCc6J251bGwnLAogICAgICAgICAgICAgICAgdW5kZWZpbmVkOid1bmRlZmluZWQnLAogICAgICAgICAgICAgICAgJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9ICdmdW5jdGlvbicsCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSAnbmFtZScgaW4gZm4gPyBmbi5uYW1lIDogKHJlTmFtZS5leGVjKGZuKXx8W10pWzFdOy8vZnVuY3Rpb25zIG5ldmVyIGhhdmUgbmFtZSBpbiBJRQogICAgICAgICAgICAgICAgICAgIGlmICggbmFtZSApCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCArPSAnICcgKyBuYW1lOwogICAgICAgICAgICAgICAgICAgIHJldCArPSAnKCc7CgogICAgICAgICAgICAgICAgICAgIHJldCA9IFsgcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gam9pbiggcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhcnJheTogYXJyYXksCiAgICAgICAgICAgICAgICBub2RlbGlzdDogYXJyYXksCiAgICAgICAgICAgICAgICBhcmd1bWVudHM6IGFycmF5LAogICAgICAgICAgICAgICAgb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIHJldCA9IFsgXTsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5qc0R1bXAudXAoKTsKICAgICAgICAgICAgICAgICAgICBmb3IgKCB2YXIga2V5IGluIG1hcCApCiAgICAgICAgICAgICAgICAgICAgICAgIHJldC5wdXNoKCBRVW5pdC5qc0R1bXAucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyBRVW5pdC5qc0R1bXAucGFyc2UobWFwW2tleV0pICk7CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuanNEdW1wLmRvd24oKTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gam9pbiggJ3snLCByZXQsICd9JyApOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIG5vZGU6ZnVuY3Rpb24oIG5vZGUgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9wZW4gPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmbHQ7JyA6ICc8JywKICAgICAgICAgICAgICAgICAgICAgICAgY2xvc2UgPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsKCiAgICAgICAgICAgICAgICAgICAgdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKICAgICAgICAgICAgICAgICAgICAgICAgcmV0ID0gb3BlbiArIHRhZzsKCiAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGEgaW4gUVVuaXQuanNEdW1wLkRPTUF0dHJzICkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdmFsID0gbm9kZVtRVW5pdC5qc0R1bXAuRE9NQXR0cnNbYV1dOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIHZhbCApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gJyAnICsgYSArICc9JyArIFFVbml0LmpzRHVtcC5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgZnVuY3Rpb25BcmdzOmZ1bmN0aW9uKCBmbiApIHsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgICAgIHZhciBsID0gZm4ubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGlmICggIWwgKSByZXR1cm4gJyc7CgogICAgICAgICAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkobCk7CiAgICAgICAgICAgICAgICAgICAgd2hpbGUgKCBsLS0gKQogICAgICAgICAgICAgICAgICAgICAgICBhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJwogICAgICAgICAgICAgICAgICAgIHJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAga2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAogICAgICAgICAgICAgICAgZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uCiAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCiAgICAgICAgICAgICAgICBzdHJpbmc6cXVvdGUsCiAgICAgICAgICAgICAgICBkYXRlOnF1b3RlLAogICAgICAgICAgICAgICAgcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKICAgICAgICAgICAgICAgIG51bWJlcjpsaXRlcmFsLAogICAgICAgICAgICAgICAgJ2Jvb2xlYW4nOmxpdGVyYWwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lCiAgICAgICAgICAgICAgICBpZDonaWQnLAogICAgICAgICAgICAgICAgbmFtZTonbmFtZScsCiAgICAgICAgICAgICAgICAnY2xhc3MnOidjbGFzc05hbWUnCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQogICAgICAgICAgICBpbmRlbnRDaGFyOicgICAnLC8vaW5kZW50YXRpb24gdW5pdAogICAgICAgICAgICBtdWx0aWxpbmU6ZmFsc2UgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuCiAgICAgICAgfTsKCiAgICAgICAgcmV0dXJuIGpzRHVtcDsKICAgIH0pKCk7CgovLyBmcm9tIFNpenpsZS5qcwogICAgZnVuY3Rpb24gZ2V0VGV4dCggZWxlbXMgKSB7CiAgICAgICAgdmFyIHJldCA9ICIiLCBlbGVtOwoKICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CiAgICAgICAgICAgIGVsZW0gPSBlbGVtc1tpXTsKCiAgICAgICAgICAgIC8vIEdldCB0aGUgdGV4dCBmcm9tIHRleHQgbm9kZXMgYW5kIENEQVRBIG5vZGVzCiAgICAgICAgICAgIGlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewogICAgICAgICAgICAgICAgcmV0ICs9IGVsZW0ubm9kZVZhbHVlOwoKICAgICAgICAgICAgICAgIC8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKICAgICAgICAgICAgfSBlbHNlIGlmICggZWxlbS5ub2RlVHlwZSAhPT0gOCApIHsKICAgICAgICAgICAgICAgIHJldCArPSBnZXRUZXh0KCBlbGVtLmNoaWxkTm9kZXMgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgLyoKICAgICAqIEphdmFzY3JpcHQgRGlmZiBBbGdvcml0aG0KICAgICAqICBCeSBKb2huIFJlc2lnIChodHRwOi8vZWpvaG4ub3JnLykKICAgICAqICBNb2RpZmllZCBieSBDaHUgQWxhbiAic3ByaXRlIgogICAgICoKICAgICAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICAgICAqCiAgICAgKiBNb3JlIEluZm86CiAgICAgKiAgaHR0cDovL2Vqb2huLm9yZy9wcm9qZWN0cy9qYXZhc2NyaXB0LWRpZmYtYWxnb3JpdGhtLwogICAgICoKICAgICAqIFVzYWdlOiBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpCiAgICAgKgogICAgICogUVVuaXQuZGlmZigidGhlIHF1aWNrIGJyb3duIGZveCBqdW1wZWQgb3ZlciIsICJ0aGUgcXVpY2sgZm94IGp1bXBzIG92ZXIiKSA9PSAidGhlICBxdWljayA8ZGVsPmJyb3duIDwvZGVsPiBmb3ggPGRlbD5qdW1wZWQgPC9kZWw+PGlucz5qdW1wcyA8L2lucz4gb3ZlciIKICAgICAqLwogICAgUVVuaXQuZGlmZiA9IChmdW5jdGlvbigpIHsKICAgICAgICBmdW5jdGlvbiBkaWZmKG8sIG4pewogICAgICAgICAgICB2YXIgbnMgPSBuZXcgT2JqZWN0KCk7CiAgICAgICAgICAgIHZhciBvcyA9IG5ldyBPYmplY3QoKTsKCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG5zW25baV1dID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgbnNbbltpXV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd3M6IG5ldyBBcnJheSgpLAogICAgICAgICAgICAgICAgICAgICAgICBvOiBudWxsCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG5zW25baV1dLnJvd3MucHVzaChpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAob3Nbb1tpXV0gPT0gbnVsbCkKICAgICAgICAgICAgICAgICAgICBvc1tvW2ldXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgcm93czogbmV3IEFycmF5KCksCiAgICAgICAgICAgICAgICAgICAgICAgIG46IG51bGwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgb3Nbb1tpXV0ucm93cy5wdXNoKGkpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpIGluIG5zKSB7CiAgICAgICAgICAgICAgICBpZiAobnNbaV0ucm93cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Yob3NbaV0pICE9ICJ1bmRlZmluZWQiICYmIG9zW2ldLnJvd3MubGVuZ3RoID09IDEpIHsKICAgICAgICAgICAgICAgICAgICBuW25zW2ldLnJvd3NbMF1dID0gewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBuW25zW2ldLnJvd3NbMF1dLAogICAgICAgICAgICAgICAgICAgICAgICByb3c6IG9zW2ldLnJvd3NbMF0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG9bb3NbaV0ucm93c1swXV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG9bb3NbaV0ucm93c1swXV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdzogbnNbaV0ucm93c1swXQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGggLSAxOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgKyAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgKyAxIDwgby5sZW5ndGggJiYgb1tuW2ldLnJvdyArIDFdLnRleHQgPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgIG5baSArIDFdID09IG9bbltpXS5yb3cgKyAxXSkgewogICAgICAgICAgICAgICAgICAgIG5baSArIDFdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBuW2kgKyAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgcm93OiBuW2ldLnJvdyArIDEKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG9bbltpXS5yb3cgKyAxXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogb1tuW2ldLnJvdyArIDFdLAogICAgICAgICAgICAgICAgICAgICAgICByb3c6IGkgKyAxCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSA9IG4ubGVuZ3RoIC0gMTsgaSA+IDA7IGktLSkgewogICAgICAgICAgICAgICAgaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSAtIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyA+IDAgJiYgb1tuW2ldLnJvdyAtIDFdLnRleHQgPT0gbnVsbCAmJgogICAgICAgICAgICAgICAgICAgIG5baSAtIDFdID09IG9bbltpXS5yb3cgLSAxXSkgewogICAgICAgICAgICAgICAgICAgIG5baSAtIDFdID0gewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBuW2kgLSAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgcm93OiBuW2ldLnJvdyAtIDEKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIG9bbltpXS5yb3cgLSAxXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogb1tuW2ldLnJvdyAtIDFdLAogICAgICAgICAgICAgICAgICAgICAgICByb3c6IGkgLSAxCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIG86IG8sCiAgICAgICAgICAgICAgICBuOiBuCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gZnVuY3Rpb24obywgbil7CiAgICAgICAgICAgIG8gPSBvLnJlcGxhY2UoL1xzKyQvLCAnJyk7CiAgICAgICAgICAgIG4gPSBuLnJlcGxhY2UoL1xzKyQvLCAnJyk7CiAgICAgICAgICAgIHZhciBvdXQgPSBkaWZmKG8gPT0gIiIgPyBbXSA6IG8uc3BsaXQoL1xzKy8pLCBuID09ICIiID8gW10gOiBuLnNwbGl0KC9ccysvKSk7CgogICAgICAgICAgICB2YXIgc3RyID0gIiI7CgogICAgICAgICAgICB2YXIgb1NwYWNlID0gby5tYXRjaCgvXHMrL2cpOwogICAgICAgICAgICBpZiAob1NwYWNlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIG9TcGFjZSA9IFsiICJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb1NwYWNlLnB1c2goIiAiKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB2YXIgblNwYWNlID0gbi5tYXRjaCgvXHMrL2cpOwogICAgICAgICAgICBpZiAoblNwYWNlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIG5TcGFjZSA9IFsiICJdOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgblNwYWNlLnB1c2goIiAiKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKG91dC5uLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG91dC5vLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgc3RyICs9ICc8ZGVsPicgKyBvdXQub1tpXSArIG9TcGFjZVtpXSArICI8L2RlbD4iOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgaWYgKG91dC5uWzBdLnRleHQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIGZvciAobiA9IDA7IG4gPCBvdXQuby5sZW5ndGggJiYgb3V0Lm9bbl0udGV4dCA9PSBudWxsOyBuKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyICs9ICc8ZGVsPicgKyBvdXQub1tuXSArIG9TcGFjZVtuXSArICI8L2RlbD4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG91dC5uLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG91dC5uW2ldLnRleHQgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdHIgKz0gJzxpbnM+JyArIG91dC5uW2ldICsgblNwYWNlW2ldICsgIjwvaW5zPiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgcHJlID0gIiI7CgogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSBvdXQubltpXS5yb3cgKyAxOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmUgKz0gJzxkZWw+JyArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc3RyICs9ICIgIiArIG91dC5uW2ldLnRleHQgKyBuU3BhY2VbaV0gKyBwcmU7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH07CiAgICB9KSgpOwoKfSkodGhpcyk7",
                "body": "LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKiAKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDkgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCAoTUlULUxJQ0VOU0UudHh0KQogKiBhbmQgR1BMIChHUEwtTElDRU5TRS50eHQpIGxpY2Vuc2VzLgogKi8KCihmdW5jdGlvbih3aW5kb3cpIHsKCiAgICB2YXIgZGVmaW5lZCA9IHsKICAgICAgICBzZXRUaW1lb3V0OiB0eXBlb2Ygd2luZG93LnNldFRpbWVvdXQgIT09ICJ1bmRlZmluZWQiCiAgICB9CgogICAgdmFyIFFVbml0ID0gewoKICAgICAgICAvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKICAgICAgICBtb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgewogICAgICAgICAgICBjb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CgogICAgICAgICAgICBzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIGlmICggY29uZmlnLnByZXZpb3VzTW9kdWxlICkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY29uZmlnLnByZXZpb3VzTW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7CiAgICAgICAgICAgICAgICBjb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CiAgICAgICAgICAgICAgICBjb25maWcubW9kdWxlVGVzdEVudmlyb25tZW50ID0gdGVzdEVudmlyb25tZW50OwogICAgICAgICAgICAgICAgY29uZmlnLm1vZHVsZVN0YXRzID0geyBhbGw6IDAsIGJhZDogMCB9OwoKICAgICAgICAgICAgICAgIFFVbml0Lm1vZHVsZVN0YXJ0KCBuYW1lLCB0ZXN0RW52aXJvbm1lbnQgKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgYXN5bmNUZXN0OiBmdW5jdGlvbih0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7CiAgICAgICAgICAgIGlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIFFVbml0LnRlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSk7CiAgICAgICAgfSwKCiAgICAgICAgdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsKICAgICAgICAgICAgdmFyIG5hbWUgPSAnPHNwYW4gY2xhc3M9InRlc3QtbmFtZSI+JyArIHRlc3ROYW1lICsgJzwvc3Bhbj4nLCB0ZXN0RW52aXJvbm1lbnQsIHRlc3RFbnZpcm9ubWVudEFyZzsKCiAgICAgICAgICAgIGlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrID0gZXhwZWN0ZWQ7CiAgICAgICAgICAgICAgICBleHBlY3RlZCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gaXMgMm5kIGFyZ3VtZW50IGEgdGVzdEVudmlyb25tZW50PwogICAgICAgICAgICBpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudEFyZyA9ICBleHBlY3RlZDsKICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gbnVsbDsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKICAgICAgICAgICAgICAgIG5hbWUgPSAnPHNwYW4gY2xhc3M9Im1vZHVsZS1uYW1lIj4nICsgY29uZmlnLmN1cnJlbnRNb2R1bGUgKyAiPC9zcGFuPjogIiArIG5hbWU7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggIXZhbGlkVGVzdChjb25maWcuY3VycmVudE1vZHVsZSArICI6ICIgKyB0ZXN0TmFtZSkgKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoKICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7CiAgICAgICAgICAgICAgICAgICAgc2V0dXA6IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICAgICAgICAgICAgdGVhcmRvd246IGZ1bmN0aW9uKCkge30KICAgICAgICAgICAgICAgIH0sIGNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQpOwogICAgICAgICAgICAgICAgaWYgKHRlc3RFbnZpcm9ubWVudEFyZykgewogICAgICAgICAgICAgICAgICAgIGV4dGVuZCh0ZXN0RW52aXJvbm1lbnQsdGVzdEVudmlyb25tZW50QXJnKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBRVW5pdC50ZXN0U3RhcnQoIHRlc3ROYW1lLCB0ZXN0RW52aXJvbm1lbnQgKTsKCiAgICAgICAgICAgICAgICAvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudAogICAgICAgICAgICAgICAgUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CgogICAgICAgICAgICAgICAgY29uZmlnLmFzc2VydGlvbnMgPSBbXTsKICAgICAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCA9IGV4cGVjdGVkOwoKICAgICAgICAgICAgICAgIHZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwogICAgICAgICAgICAgICAgaWYgKHRlc3RzKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKICAgICAgICAgICAgICAgICAgICBiLmlubmVySFRNTCA9ICJSdW5uaW5nICIgKyBuYW1lOwogICAgICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CiAgICAgICAgICAgICAgICAgICAgbGkuYXBwZW5kQ2hpbGQoIGIgKTsKICAgICAgICAgICAgICAgICAgICBsaS5pZCA9ICJjdXJyZW50LXRlc3Qtb3V0cHV0IjsKICAgICAgICAgICAgICAgICAgICB0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGlmICggIWNvbmZpZy5wb2xsdXRpb24gKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVHbG9iYWwoKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayggZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoIGFzeW5jICkgewogICAgICAgICAgICAgICAgICAgIFFVbml0LnN0b3AoKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrLmNhbGwodGVzdEVudmlyb25tZW50KTsKICAgICAgICAgICAgICAgIH0gY2F0Y2goZSkgewogICAgICAgICAgICAgICAgICAgIGZhaWwoIlRlc3QgIiArIG5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIiwgZSwgY2FsbGJhY2spOwogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKCBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArIChjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKyAxKSArICI6ICIgKyBlLm1lc3NhZ2UgKyAiIC0gIiArIFFVbml0LmpzRHVtcC5wYXJzZShlKSApOwogICAgICAgICAgICAgICAgICAgIC8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgc2F2ZUdsb2JhbCgpOwoKICAgICAgICAgICAgICAgICAgICAvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nCiAgICAgICAgICAgICAgICAgICAgaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0KCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICBjaGVja1BvbGx1dGlvbigpOwogICAgICAgICAgICAgICAgICAgIHRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICBRVW5pdC5vayggZmFsc2UsICJUZWFyZG93biBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBpZiAoIGNvbmZpZy5leHBlY3RlZCAmJiBjb25maWcuZXhwZWN0ZWQgIT0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB2YXIgZ29vZCA9IDAsIGJhZCA9IDAsCiAgICAgICAgICAgICAgICAgICAgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsKCiAgICAgICAgICAgICAgICBjb25maWcuc3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoKICAgICAgICAgICAgICAgIGlmICggdGVzdHMgKSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIG9sICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7CgogICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgYXNzZXJ0aW9uID0gY29uZmlnLmFzc2VydGlvbnNbaV07CgogICAgICAgICAgICAgICAgICAgICAgICB2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwogICAgICAgICAgICAgICAgICAgICAgICBsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOwogICAgICAgICAgICAgICAgICAgICAgICBsaS5pbm5lckhUTUwgPSBhc3NlcnRpb24ubWVzc2FnZSB8fCAoYXNzZXJ0aW9uLnJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKICAgICAgICAgICAgICAgICAgICAgICAgb2wuYXBwZW5kQ2hpbGQoIGxpICk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBnb29kKys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoYmFkID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CiAgICAgICAgICAgICAgICAgICAgYi5pbm5lckhUTUwgPSBuYW1lICsgIiA8YiBjbGFzcz0nY291bnRzJz4oPGIgY2xhc3M9J2ZhaWxlZCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzc2VkJz4iICsgZ29vZCArICI8L2I+LCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsKCiAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnQoYiwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBuZXh0ID0gYi5uZXh0U2libGluZywgZGlzcGxheSA9IG5leHQuc3R5bGUuZGlzcGxheTsKICAgICAgICAgICAgICAgICAgICAgICAgbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKICAgICAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICAgICAgYWRkRXZlbnQoYiwgImRibGNsaWNrIiwgZnVuY3Rpb24oZSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInNwYW4iIHx8IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJiIiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IHRhcmdldC5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICggd2luZG93LmxvY2F0aW9uICYmIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic3Ryb25nIiApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbi5zZWFyY2ggPSAiPyIgKyBlbmNvZGVVUklDb21wb25lbnQoZ2V0VGV4dChbdGFyZ2V0XSkucmVwbGFjZSgvXCguK1wpJC8sICIiKS5yZXBsYWNlKC8oXlxzKnxccyokKS9nLCAiIikpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgICAgIHZhciBsaSA9IGlkKCJjdXJyZW50LXRlc3Qtb3V0cHV0Iik7CiAgICAgICAgICAgICAgICAgICAgbGkuaWQgPSAiIjsKICAgICAgICAgICAgICAgICAgICBsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7CiAgICAgICAgICAgICAgICAgICAgbGkuc3R5bGUuZGlzcGxheSA9IHJlc3VsdERpc3BsYXlTdHlsZSghYmFkKTsKICAgICAgICAgICAgICAgICAgICBsaS5yZW1vdmVDaGlsZCggbGkuZmlyc3RDaGlsZCApOwogICAgICAgICAgICAgICAgICAgIGxpLmFwcGVuZENoaWxkKCBiICk7CiAgICAgICAgICAgICAgICAgICAgbGkuYXBwZW5kQ2hpbGQoIG9sICk7CgogICAgICAgICAgICAgICAgICAgIGlmICggYmFkICkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB0b29sYmFyICkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmRpc2FibGVkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkKCJxdW5pdC1maWx0ZXItbWlzc2luZyIpLmRpc2FibGVkID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoICFjb25maWcuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5zdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIFFVbml0LnJlc2V0KCk7CiAgICAgICAgICAgICAgICB9IGNhdGNoKGUpIHsKICAgICAgICAgICAgICAgICAgICBmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIG5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCBRVW5pdC5yZXNldCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgUVVuaXQudGVzdERvbmUoIHRlc3ROYW1lLCBiYWQsIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHN5bmNocm9uaXplKCBkb25lICk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgogICAgICAgICAqLwogICAgICAgIGV4cGVjdDogZnVuY3Rpb24oYXNzZXJ0cykgewogICAgICAgICAgICBjb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIEFzc2VydHMgdHJ1ZS4KICAgICAgICAgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwogICAgICAgICAqLwogICAgICAgIG9rOiBmdW5jdGlvbihhLCBtc2cpIHsKICAgICAgICAgICAgYSA9ICEhYTsKICAgICAgICAgICAgdmFyIGRldGFpbHMgPSB7CiAgICAgICAgICAgICAgICByZXN1bHQ6IGEsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtc2cKICAgICAgICAgICAgfTsKICAgICAgICAgICAgbXNnID0gZXNjYXBlSHRtbChtc2cpOwogICAgICAgICAgICBRVW5pdC5sb2coYSwgbXNnLCBkZXRhaWxzKTsKICAgICAgICAgICAgY29uZmlnLmFzc2VydGlvbnMucHVzaCh7CiAgICAgICAgICAgICAgICByZXN1bHQ6IGEsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtc2cKICAgICAgICAgICAgfSk7CiAgICAgICAgfSwKCiAgICAgICAgLyoqCiAgICAgICAgICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuCiAgICAgICAgICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLgogICAgICAgICAqCiAgICAgICAgICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBPYmplY3QgYWN0dWFsCiAgICAgICAgICogQHBhcmFtIE9iamVjdCBleHBlY3RlZAogICAgICAgICAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpCiAgICAgICAgICovCiAgICAgICAgZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgUVVuaXQucHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIG5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIFFVbml0LnB1c2goZXhwZWN0ZWQgIT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBkZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKICAgICAgICAgICAgUVVuaXQucHVzaChRVW5pdC5lcXVpdihhY3R1YWwsIGV4cGVjdGVkKSwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgbm90RGVlcEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIFFVbml0LnB1c2goIVFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKICAgICAgICB9LAoKICAgICAgICBzdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewogICAgICAgICAgICBRVW5pdC5wdXNoKGV4cGVjdGVkID09PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwogICAgICAgIH0sCgogICAgICAgIG5vdFN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIFFVbml0LnB1c2goZXhwZWN0ZWQgIT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7CiAgICAgICAgfSwKCiAgICAgICAgcmFpc2VzOiBmdW5jdGlvbihmbiwgIG1lc3NhZ2UpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGZuKCk7CiAgICAgICAgICAgICAgICBvayggZmFsc2UsIG1lc3NhZ2UgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgb2soIHRydWUsIG1lc3NhZ2UgKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHN0YXJ0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwogICAgICAgICAgICBpZiAoIGRlZmluZWQuc2V0VGltZW91dCApIHsKICAgICAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIGlmICggY29uZmlnLnRpbWVvdXQgKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzKCk7CiAgICAgICAgICAgICAgICB9LCAxMyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIHByb2Nlc3MoKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIHN0b3A6IGZ1bmN0aW9uKHRpbWVvdXQpIHsKICAgICAgICAgICAgY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmICggdGltZW91dCAmJiBkZWZpbmVkLnNldFRpbWVvdXQgKSB7CiAgICAgICAgICAgICAgICBjb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgIFFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwogICAgICAgICAgICAgICAgICAgIFFVbml0LnN0YXJ0KCk7CiAgICAgICAgICAgICAgICB9LCB0aW1lb3V0KTsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICB9OwoKLy8gQmFja3dhcmRzIGNvbXBhdGliaWxpdHksIGRlcHJlY2F0ZWQKICAgIFFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOwogICAgUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsKCi8vIE1haW50YWluIGludGVybmFsIHN0YXRlCiAgICB2YXIgY29uZmlnID0gewogICAgICAgIC8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KICAgICAgICBxdWV1ZTogW10sCgogICAgICAgIC8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5CiAgICAgICAgYmxvY2tpbmc6IHRydWUKICAgIH07CgovLyBMb2FkIHBhcmFtYXRlcnMKICAgIChmdW5jdGlvbigpIHsKICAgICAgICB2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAogICAgICAgICAgICBHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsKCiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrICkgewogICAgICAgICAgICBHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOwogICAgICAgICAgICBpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vZ2xvYmFscyIgKSB7CiAgICAgICAgICAgICAgICBHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICBjb25maWcubm9nbG9iYWxzID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICggR0VUUGFyYW1zW2ldLnNlYXJjaCgnPScpID4gLTEgKSB7CiAgICAgICAgICAgICAgICBHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CiAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIC8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKICAgICAgICBjb25maWcuZmlsdGVycyA9IEdFVFBhcmFtczsKCiAgICAgICAgLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdAogICAgICAgIFFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7CiAgICB9KSgpOwoKLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJwovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTCiAgICBpZiAoIHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gInVuZGVmaW5lZCIgKSB7CiAgICAgICAgZXh0ZW5kKHdpbmRvdywgUVVuaXQpOwogICAgICAgIHdpbmRvdy5RVW5pdCA9IFFVbml0OwogICAgfSBlbHNlIHsKICAgICAgICBleHRlbmQoZXhwb3J0cywgUVVuaXQpOwogICAgICAgIGV4cG9ydHMuUVVuaXQgPSBRVW5pdDsKICAgIH0KCi8vIGRlZmluZSB0aGVzZSBhZnRlciBleHBvc2luZyBnbG9iYWxzIHRvIGtlZXAgdGhlbSBpbiB0aGVzZSBRVW5pdCBuYW1lc3BhY2Ugb25seQogICAgZXh0ZW5kKFFVbml0LCB7CiAgICAgICAgY29uZmlnOiBjb25maWcsCgogICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwogICAgICAgIGluaXQ6IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBleHRlbmQoY29uZmlnLCB7CiAgICAgICAgICAgICAgICBzdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAogICAgICAgICAgICAgICAgbW9kdWxlU3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6ICtuZXcgRGF0ZSwKICAgICAgICAgICAgICAgIHVwZGF0ZVJhdGU6IDEwMDAsCiAgICAgICAgICAgICAgICBibG9ja2luZzogZmFsc2UsCiAgICAgICAgICAgICAgICBhdXRvc3RhcnQ6IHRydWUsCiAgICAgICAgICAgICAgICBhdXRvcnVuOiBmYWxzZSwKICAgICAgICAgICAgICAgIGFzc2VydGlvbnM6IFtdLAogICAgICAgICAgICAgICAgZmlsdGVyczogW10sCiAgICAgICAgICAgICAgICBxdWV1ZTogW10KICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB2YXIgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKICAgICAgICAgICAgICAgIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKICAgICAgICAgICAgICAgIHJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgogICAgICAgICAgICBpZiAoIHRlc3RzICkgewogICAgICAgICAgICAgICAgdGVzdHMuaW5uZXJIVE1MID0gIiI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICggYmFubmVyICkgewogICAgICAgICAgICAgICAgYmFubmVyLmNsYXNzTmFtZSA9ICIiOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIHJlc3VsdCApIHsKICAgICAgICAgICAgICAgIHJlc3VsdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCByZXN1bHQgKTsKICAgICAgICAgICAgfQogICAgICAgIH0sCgogICAgICAgIC8qKgogICAgICAgICAqIFJlc2V0cyB0aGUgdGVzdCBzZXR1cC4gVXNlZnVsIGZvciB0ZXN0cyB0aGF0IG1vZGlmeSB0aGUgRE9NLgogICAgICAgICAqCiAgICAgICAgICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgdXNlcyBqUXVlcnkncyBodG1sKCksIG90aGVyd2lzZSBqdXN0IGlubmVySFRNTC4KICAgICAgICAgKi8KICAgICAgICByZXNldDogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIGlmICggd2luZG93LmpRdWVyeSApIHsKICAgICAgICAgICAgICAgIGpRdWVyeSggIiNtYWluLCAjcXVuaXQtZml4dHVyZSIgKS5odG1sKCBjb25maWcuZml4dHVyZSApOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFyIG1haW4gPSBpZCggJ21haW4nICkgfHwgaWQoICdxdW5pdC1maXh0dXJlJyApOwogICAgICAgICAgICAgICAgaWYgKCBtYWluICkgewogICAgICAgICAgICAgICAgICAgIG1haW4uaW5uZXJIVE1MID0gY29uZmlnLmZpeHR1cmU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9LAoKICAgICAgICAvKioKICAgICAgICAgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCiAgICAgICAgICoKICAgICAgICAgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKICAgICAgICAgKgogICAgICAgICAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0KICAgICAgICAgKiBAcGFyYW0gU3RyaW5nIHR5cGUKICAgICAgICAgKi8KICAgICAgICB0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsKICAgICAgICAgICAgaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudCApIHsKICAgICAgICAgICAgICAgIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CiAgICAgICAgICAgICAgICBldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCiAgICAgICAgICAgICAgICAgICAgMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOwogICAgICAgICAgICAgICAgZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoKICAgICAgICAgICAgfSBlbHNlIGlmICggZWxlbS5maXJlRXZlbnQgKSB7CiAgICAgICAgICAgICAgICBlbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOwogICAgICAgICAgICB9CiAgICAgICAgfSwKCiAgICAgICAgLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZwogICAgICAgIGlzOiBmdW5jdGlvbiggdHlwZSwgb2JqICkgewogICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZSggb2JqICkgPT0gdHlwZTsKICAgICAgICB9LAoKICAgICAgICBvYmplY3RUeXBlOiBmdW5jdGlvbiggb2JqICkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIjsKCiAgICAgICAgICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG51bGwgPT09IG9iamVjdAogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvYmogPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVsbCI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciB0eXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBvYmogKQogICAgICAgICAgICAgICAgLm1hdGNoKC9eXFtvYmplY3RccyguKilcXSQvKVsxXSB8fCAnJzsKCiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkgewogICAgICAgICAgICAgICAgY2FzZSAnTnVtYmVyJzoKICAgICAgICAgICAgICAgICAgICBpZiAoaXNOYU4ob2JqKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gIm5hbiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNhc2UgJ1N0cmluZyc6CiAgICAgICAgICAgICAgICBjYXNlICdCb29sZWFuJzoKICAgICAgICAgICAgICAgIGNhc2UgJ0FycmF5JzoKICAgICAgICAgICAgICAgIGNhc2UgJ0RhdGUnOgogICAgICAgICAgICAgICAgY2FzZSAnUmVnRXhwJzoKICAgICAgICAgICAgICAgIGNhc2UgJ0Z1bmN0aW9uJzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHlwZS50b0xvd2VyQ2FzZSgpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfSwKCiAgICAgICAgcHVzaDogZnVuY3Rpb24ocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CiAgICAgICAgICAgIHZhciBkZXRhaWxzID0gewogICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHQsCiAgICAgICAgICAgICAgICBtZXNzYWdlOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgYWN0dWFsOiBhY3R1YWwsCiAgICAgICAgICAgICAgICBleHBlY3RlZDogZXhwZWN0ZWQKICAgICAgICAgICAgfTsKCiAgICAgICAgICAgIG1lc3NhZ2UgPSBlc2NhcGVIdG1sKG1lc3NhZ2UpIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CiAgICAgICAgICAgIG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9InRlc3QtbWVzc2FnZSI+JyArIG1lc3NhZ2UgKyAiPC9zcGFuPiI7CiAgICAgICAgICAgIGV4cGVjdGVkID0gZXNjYXBlSHRtbChRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpKTsKICAgICAgICAgICAgYWN0dWFsID0gZXNjYXBlSHRtbChRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSk7CiAgICAgICAgICAgIHZhciBvdXRwdXQgPSBtZXNzYWdlICsgJywgZXhwZWN0ZWQ6IDxzcGFuIGNsYXNzPSJ0ZXN0LWV4cGVjdGVkIj4nICsgZXhwZWN0ZWQgKyAnPC9zcGFuPic7CiAgICAgICAgICAgIGlmIChhY3R1YWwgIT0gZXhwZWN0ZWQpIHsKICAgICAgICAgICAgICAgIG91dHB1dCArPSAnIHJlc3VsdDogPHNwYW4gY2xhc3M9InRlc3QtYWN0dWFsIj4nICsgYWN0dWFsICsgJzwvc3Bhbj4sIGRpZmY6ICcgKyBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBRVW5pdC5sb2cocmVzdWx0LCBtZXNzYWdlLCBkZXRhaWxzKTsKCiAgICAgICAgICAgIGNvbmZpZy5hc3NlcnRpb25zLnB1c2goewogICAgICAgICAgICAgICAgcmVzdWx0OiAhIXJlc3VsdCwKICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG91dHB1dAogICAgICAgICAgICB9KTsKICAgICAgICB9LAoKICAgICAgICAvLyBMb2dnaW5nIGNhbGxiYWNrcwogICAgICAgIGJlZ2luOiBmdW5jdGlvbigpIHt9LAogICAgICAgIGRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCkge30sCiAgICAgICAgbG9nOiBmdW5jdGlvbihyZXN1bHQsIG1lc3NhZ2UpIHt9LAogICAgICAgIHRlc3RTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwKICAgICAgICB0ZXN0RG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fSwKICAgICAgICBtb2R1bGVTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwKICAgICAgICBtb2R1bGVEb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9CiAgICB9KTsKCiAgICBpZiAoIHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKICAgICAgICBjb25maWcuYXV0b3J1biA9IHRydWU7CiAgICB9CgogICAgYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgewogICAgICAgIFFVbml0LmJlZ2luKCk7CgogICAgICAgIC8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKICAgICAgICB2YXIgb2xkY29uZmlnID0gZXh0ZW5kKHt9LCBjb25maWcpOwogICAgICAgIFFVbml0LmluaXQoKTsKICAgICAgICBleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKICAgICAgICBjb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCiAgICAgICAgdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKICAgICAgICBpZiAoIHVzZXJBZ2VudCApIHsKICAgICAgICAgICAgdXNlckFnZW50LmlubmVySFRNTCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICAgICAgfQogICAgICAgIHZhciBiYW5uZXIgPSBpZCgicXVuaXQtaGVhZGVyIik7CiAgICAgICAgaWYgKCBiYW5uZXIgKSB7CiAgICAgICAgICAgIHZhciBwYXJhbXNJbmRleCA9IGxvY2F0aW9uLmhyZWYubGFzdEluZGV4T2YobG9jYXRpb24uc2VhcmNoKTsKICAgICAgICAgICAgaWYgKCBwYXJhbXNJbmRleCA+IC0xICkgewogICAgICAgICAgICAgICAgdmFyIG1haW5QYWdlTG9jYXRpb24gPSBsb2NhdGlvbi5ocmVmLnNsaWNlKDAsIHBhcmFtc0luZGV4KTsKICAgICAgICAgICAgICAgIGlmICggbWFpblBhZ2VMb2NhdGlvbiA9PSBsb2NhdGlvbi5ocmVmICkgewogICAgICAgICAgICAgICAgICAgIGJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iIj4gJyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAnOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YXIgdGVzdE5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQobG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpKTsKICAgICAgICAgICAgICAgICAgICBiYW5uZXIuaW5uZXJIVE1MID0gJzxhIGhyZWY9IicgKyBtYWluUGFnZUxvY2F0aW9uICsgJyI+JyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAmIzgyNTA7IDxhIGhyZWY9IiI+JyArIHRlc3ROYW1lICsgJzwvYT4nOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKICAgICAgICBpZiAoIHRvb2xiYXIgKSB7CiAgICAgICAgICAgIHRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgICAgICAgICAgIHZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICBmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7CiAgICAgICAgICAgIGZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7CiAgICAgICAgICAgIGZpbHRlci5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIGFkZEV2ZW50KCBmaWx0ZXIsICJjbGljayIsIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CiAgICAgICAgICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJwYXNzIikgPiAtMSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlbaV0uc3R5bGUuZGlzcGxheSA9IGZpbHRlci5jaGVja2VkID8gIm5vbmUiIDogIiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdG9vbGJhci5hcHBlbmRDaGlsZCggZmlsdGVyICk7CgogICAgICAgICAgICB2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgICAgICBsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOwogICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBwYXNzZWQgdGVzdHMiOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoKICAgICAgICAgICAgdmFyIG1pc3NpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICBtaXNzaW5nLnR5cGUgPSAiY2hlY2tib3giOwogICAgICAgICAgICBtaXNzaW5nLmlkID0gInF1bml0LWZpbHRlci1taXNzaW5nIjsKICAgICAgICAgICAgbWlzc2luZy5kaXNhYmxlZCA9IHRydWU7CiAgICAgICAgICAgIGFkZEV2ZW50KCBtaXNzaW5nLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOwogICAgICAgICAgICAgICAgZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigiZmFpbCIpID4gLTEgJiYgbGlbaV0uaW5uZXJIVE1MLmluZGV4T2YoJ21pc3NpbmcgdGVzdCAtIHVudGVzdGVkIGNvZGUgaXMgYnJva2VuIGNvZGUnKSA+IC0gMSApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGlbaV0ucGFyZW50Tm9kZS5wYXJlbnROb2RlLnN0eWxlLmRpc3BsYXkgPSBtaXNzaW5nLmNoZWNrZWQgPyAibm9uZSIgOiAiYmxvY2siOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRvb2xiYXIuYXBwZW5kQ2hpbGQoIG1pc3NpbmcgKTsKCiAgICAgICAgICAgIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKICAgICAgICAgICAgbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCAicXVuaXQtZmlsdGVyLW1pc3NpbmciKTsKICAgICAgICAgICAgbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgbWlzc2luZyB0ZXN0cyAodW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZSkiOwogICAgICAgICAgICB0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwogICAgICAgIH0KCiAgICAgICAgdmFyIG1haW4gPSBpZCgnbWFpbicpIHx8IGlkKCdxdW5pdC1maXh0dXJlJyk7CiAgICAgICAgaWYgKCBtYWluICkgewogICAgICAgICAgICBjb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOwogICAgICAgIH0KCiAgICAgICAgaWYgKGNvbmZpZy5hdXRvc3RhcnQpIHsKICAgICAgICAgICAgUVVuaXQuc3RhcnQoKTsKICAgICAgICB9CiAgICB9KTsKCiAgICBmdW5jdGlvbiBkb25lKCkgewogICAgICAgIGlmICggY29uZmlnLmRvbmVUaW1lciAmJiB3aW5kb3cuY2xlYXJUaW1lb3V0ICkgewogICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KCBjb25maWcuZG9uZVRpbWVyICk7CiAgICAgICAgICAgIGNvbmZpZy5kb25lVGltZXIgPSBudWxsOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBjb25maWcucXVldWUubGVuZ3RoICkgewogICAgICAgICAgICBpZiAoIGRlZmluZWQuc2V0VGltZW91dCApIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewogICAgICAgICAgICAgICAgICAgIGlmICggIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGRvbmUoKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBzeW5jaHJvbml6ZSggZG9uZSApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sIDEzKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgY29uZmlnLmF1dG9ydW4gPSB0cnVlOwoKICAgICAgICAvLyBMb2cgdGhlIGxhc3QgbW9kdWxlIHJlc3VsdHMKICAgICAgICBpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewogICAgICAgICAgICBRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOwogICAgICAgIH0KCiAgICAgICAgdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKICAgICAgICAgICAgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKICAgICAgICAgICAgaHRtbCA9IFsnVGVzdHMgY29tcGxldGVkIGluICcsCiAgICAgICAgICAgICAgICArbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAogICAgICAgICAgICAgICAgJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwnPC9zcGFuPiBmYWlsZWQuJ10uam9pbignJyk7CgogICAgICAgIGlmICggYmFubmVyICkgewogICAgICAgICAgICBiYW5uZXIuY2xhc3NOYW1lID0gKGNvbmZpZy5zdGF0cy5iYWQgPyAicXVuaXQtZmFpbCIgOiAicXVuaXQtcGFzcyIpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCB0ZXN0cyApIHsKICAgICAgICAgICAgdmFyIHJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgogICAgICAgICAgICBpZiAoICFyZXN1bHQgKSB7CiAgICAgICAgICAgICAgICByZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CiAgICAgICAgICAgICAgICByZXN1bHQuaWQgPSAicXVuaXQtdGVzdHJlc3VsdCI7CiAgICAgICAgICAgICAgICByZXN1bHQuY2xhc3NOYW1lID0gInJlc3VsdCI7CiAgICAgICAgICAgICAgICB0ZXN0cy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggcmVzdWx0LCB0ZXN0cy5uZXh0U2libGluZyApOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsKICAgICAgICB9CgogICAgICAgIFFVbml0LmRvbmUoIGNvbmZpZy5zdGF0cy5iYWQsIGNvbmZpZy5zdGF0cy5hbGwgKTsKICAgIH0KCiAgICBmdW5jdGlvbiB2YWxpZFRlc3QoIG5hbWUgKSB7CiAgICAgICAgdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsCiAgICAgICAgICAgIHJ1biA9IGZhbHNlOwoKICAgICAgICBpZiAoICFpICkgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CgogICAgICAgIHdoaWxlICggaS0tICkgewogICAgICAgICAgICB2YXIgZmlsdGVyID0gY29uZmlnLmZpbHRlcnNbaV0sCiAgICAgICAgICAgICAgICBub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCiAgICAgICAgICAgIGlmICggbm90ICkgewogICAgICAgICAgICAgICAgZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsKICAgICAgICAgICAgICAgIHJldHVybiAhbm90OwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIG5vdCApIHsKICAgICAgICAgICAgICAgIHJ1biA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBydW47CiAgICB9CgogICAgZnVuY3Rpb24gcmVzdWx0RGlzcGxheVN0eWxlKHBhc3NlZCkgewogICAgICAgIHJldHVybiBwYXNzZWQgJiYgaWQoInF1bml0LWZpbHRlci1wYXNzIikgJiYgaWQoInF1bml0LWZpbHRlci1wYXNzIikuY2hlY2tlZCA/ICdub25lJyA6ICcnOwogICAgfQoKICAgIGZ1bmN0aW9uIGVzY2FwZUh0bWwocykgewogICAgICAgIGlmICghcykgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIHMgPSBzICsgIiI7CiAgICAgICAgcmV0dXJuIHMucmVwbGFjZSgvW1wmIjw+XFxdL2csIGZ1bmN0aW9uKHMpIHsKICAgICAgICAgICAgc3dpdGNoKHMpIHsKICAgICAgICAgICAgICAgIGNhc2UgIiYiOiByZXR1cm4gIiZhbXA7IjsKICAgICAgICAgICAgICAgIGNhc2UgIlxcIjogcmV0dXJuICJcXFxcIjsKICAgICAgICAgICAgICAgIGNhc2UgJyInOiByZXR1cm4gJ1wiJzsKICAgICAgICAgICAgICAgIGNhc2UgIjwiOiByZXR1cm4gIiZsdDsiOwogICAgICAgICAgICAgICAgY2FzZSAiPiI6IHJldHVybiAiJmd0OyI7CiAgICAgICAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gczsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIGZ1bmN0aW9uIHN5bmNocm9uaXplKCBjYWxsYmFjayApIHsKICAgICAgICBjb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCiAgICAgICAgaWYgKCBjb25maWcuYXV0b3J1biAmJiAhY29uZmlnLmJsb2NraW5nICkgewogICAgICAgICAgICBwcm9jZXNzKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIHByb2Nlc3MoKSB7CiAgICAgICAgdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCiAgICAgICAgd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7CiAgICAgICAgICAgIGlmICggY29uZmlnLnVwZGF0ZVJhdGUgPD0gMCB8fCAoKChuZXcgRGF0ZSgpKS5nZXRUaW1lKCkgLSBzdGFydCkgPCBjb25maWcudXBkYXRlUmF0ZSkgKSB7CiAgICAgICAgICAgICAgICBjb25maWcucXVldWUuc2hpZnQoKSgpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQoIHByb2Nlc3MsIDEzICk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBzYXZlR2xvYmFsKCkgewogICAgICAgIGNvbmZpZy5wb2xsdXRpb24gPSBbXTsKCiAgICAgICAgaWYgKCBjb25maWcubm9nbG9iYWxzICkgewogICAgICAgICAgICBmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsKICAgICAgICAgICAgICAgIGNvbmZpZy5wb2xsdXRpb24ucHVzaCgga2V5ICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7CiAgICAgICAgdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247CiAgICAgICAgc2F2ZUdsb2JhbCgpOwoKICAgICAgICB2YXIgbmV3R2xvYmFscyA9IGRpZmYoIG9sZCwgY29uZmlnLnBvbGx1dGlvbiApOwogICAgICAgIGlmICggbmV3R2xvYmFscy5sZW5ndGggPiAwICkgewogICAgICAgICAgICBvayggZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIG5ld0dsb2JhbHMuam9pbigiLCAiKSApOwogICAgICAgICAgICBjb25maWcuZXhwZWN0ZWQrKzsKICAgICAgICB9CgogICAgICAgIHZhciBkZWxldGVkR2xvYmFscyA9IGRpZmYoIGNvbmZpZy5wb2xsdXRpb24sIG9sZCApOwogICAgICAgIGlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsKICAgICAgICAgICAgb2soIGZhbHNlLCAiRGVsZXRlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBkZWxldGVkR2xvYmFscy5qb2luKCIsICIpICk7CiAgICAgICAgICAgIGNvbmZpZy5leHBlY3RlZCsrOwogICAgICAgIH0KICAgIH0KCi8vIHJldHVybnMgYSBuZXcgQXJyYXkgd2l0aCB0aGUgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBidXQgbm90IGluIGIKICAgIGZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7CiAgICAgICAgdmFyIHJlc3VsdCA9IGEuc2xpY2UoKTsKICAgICAgICBmb3IgKCB2YXIgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKysgKSB7CiAgICAgICAgICAgIGZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7CiAgICAgICAgICAgICAgICBpZiAoIHJlc3VsdFtpXSA9PT0gYltqXSApIHsKICAgICAgICAgICAgICAgICAgICByZXN1bHQuc3BsaWNlKGksIDEpOwogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzdWx0OwogICAgfQoKICAgIGZ1bmN0aW9uIGZhaWwobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjaykgewogICAgICAgIGlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4Y2VwdGlvbik7CiAgICAgICAgICAgIGNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsKCiAgICAgICAgfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsKICAgICAgICAgICAgb3BlcmEucG9zdEVycm9yKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2sudG9TdHJpbmcpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBleHRlbmQoYSwgYikgewogICAgICAgIGZvciAoIHZhciBwcm9wIGluIGIgKSB7CiAgICAgICAgICAgIGFbcHJvcF0gPSBiW3Byb3BdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGE7CiAgICB9CgogICAgZnVuY3Rpb24gYWRkRXZlbnQoZWxlbSwgdHlwZSwgZm4pIHsKICAgICAgICBpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKICAgICAgICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKICAgICAgICB9IGVsc2UgaWYgKCBlbGVtLmF0dGFjaEV2ZW50ICkgewogICAgICAgICAgICBlbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZm4gKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmbigpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBpZChuYW1lKSB7CiAgICAgICAgcmV0dXJuICEhKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpICYmCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7CiAgICB9CgovLyBUZXN0IGZvciBlcXVhbGl0eSBhbnkgSmF2YVNjcmlwdCB0eXBlLgovLyBEaXNjdXNzaW9ucyBhbmQgcmVmZXJlbmNlOiBodHRwOi8vcGhpbHJhdGhlLmNvbS9hcnRpY2xlcy9lcXVpdgovLyBUZXN0IHN1aXRlczogaHR0cDovL3BoaWxyYXRoZS5jb20vdGVzdHMvZXF1aXYKLy8gQXV0aG9yOiBQaGlsaXBwZSBSYXRow6kgPHByYXRoZUBnbWFpbC5jb20+CiAgICBRVW5pdC5lcXVpdiA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICAgICAgdmFyIGNhbGxlcnMgPSBbXTsgLy8gc3RhY2sgdG8gZGVjaWRlIGJldHdlZW4gc2tpcC9hYm9ydCBmdW5jdGlvbnMKICAgICAgICB2YXIgcGFyZW50cyA9IFtdOyAvLyBzdGFjayB0byBhdm9pZGluZyBsb29wcyBmcm9tIGNpcmN1bGFyIHJlZmVyZW5jaW5nCgogICAgICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICAgICAgZnVuY3Rpb24gYmluZENhbGxiYWNrcyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICAgICAgdmFyIHByb3AgPSBRVW5pdC5vYmplY3RUeXBlKG8pOwogICAgICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICAgICAgaWYgKFFVbml0Lm9iamVjdFR5cGUoY2FsbGJhY2tzW3Byb3BdKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXTsgLy8gb3IgdW5kZWZpbmVkCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICAvLyBmb3Igc3RyaW5nLCBib29sZWFuLCBudW1iZXIgYW5kIG51bGwKICAgICAgICAgICAgZnVuY3Rpb24gdXNlU3RyaWN0RXF1YWxpdHkoYiwgYSkgewogICAgICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gdG8gY2F0Y2ggc2hvcnQgYW5ub3RhaW9uIFZTICduZXcnIGFubm90YXRpb24gb2YgYSBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgICAgIC8vIGUuZy4gdmFyIGkgPSAxOwogICAgICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBhID09IGI7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksCgogICAgICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKGIpOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7CiAgICAgICAgICAgICAgICB9LAoKICAgICAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgICAgICBhLnNvdXJjZSA9PT0gYi5zb3VyY2UgJiYgLy8gdGhlIHJlZ2V4IGl0c2VsZgogICAgICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICAgICAgYS5tdWx0aWxpbmUgPT09IGIubXVsdGlsaW5lOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgICAgIC8vIC0gYWJvcnQgb3RoZXJ3aXNlLAogICAgICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjYWxsZXIgPSBjYWxsZXJzW2NhbGxlcnMubGVuZ3RoIC0gMV07CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAiYXJyYXkiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgICAgIC8vIGIgY291bGQgYmUgYW4gb2JqZWN0IGxpdGVyYWwgaGVyZQogICAgICAgICAgICAgICAgICAgIGlmICggISAoUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvL2RvbnQgcmV3YWxrIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsKICAgICAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YKICAgICAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOwoKICAgICAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7IC8vZG9uJ3QgZ28gZG93biB0aGUgc2FtZSBwYXRoIHR3aWNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXEgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CgogICAgICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYidzIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgICAgIHJldHVybiBlcSAmJiBpbm5lckVxdWl2KGFQcm9wZXJ0aWVzLnNvcnQoKSwgYlByb3BlcnRpZXMuc29ydCgpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICB9KCk7CgogICAgICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhID09PSBudWxsIHx8IGIgPT09IG51bGwgfHwgdHlwZW9mIGEgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fCBRVW5pdC5vYmplY3RUeXBlKGEpICE9PSBRVW5pdC5vYmplY3RUeXBlKGIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBkb24ndCBsb3NlIHRpbWUgd2l0aCBlcnJvciBwcm9uZSBjYXNlcwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICAgICAgfSkoYXJnc1swXSwgYXJnc1sxXSkgJiYgYXJndW1lbnRzLmNhbGxlZS5hcHBseSh0aGlzLCBhcmdzLnNwbGljZSgxLCBhcmdzLmxlbmd0aCAtMSkpOwogICAgICAgIH07CgogICAgICAgIHJldHVybiBpbm5lckVxdWl2OwoKICAgIH0oKTsKCiAgICAvKioKICAgICAqIGpzRHVtcAogICAgICogQ29weXJpZ2h0IChjKSAyMDA4IEFyaWVsIEZsZXNsZXIgLSBhZmxlc2xlcihhdClnbWFpbChkb3QpY29tIHwgaHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tCiAgICAgKiBMaWNlbnNlZCB1bmRlciBCU0QgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvYnNkLWxpY2Vuc2UucGhwKQogICAgICogRGF0ZTogNS8xNS8yMDA4CiAgICAgKiBAcHJvamVjdERlc2NyaXB0aW9uIEFkdmFuY2VkIGFuZCBleHRlbnNpYmxlIGRhdGEgZHVtcGluZyBmb3IgSmF2YXNjcmlwdC4KICAgICAqIEB2ZXJzaW9uIDEuMC4wCiAgICAgKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICAgICAqIEBsaW5rIHtodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20vMjAwOC8wNS9qc2R1bXAtcHJldHR5LWR1bXAtb2YtYW55LWphdmFzY3JpcHQuaHRtbH0KICAgICAqLwogICAgUVVuaXQuanNEdW1wID0gKGZ1bmN0aW9uKCkgewogICAgICAgIGZ1bmN0aW9uIHF1b3RlKCBzdHIgKSB7CiAgICAgICAgICAgIHJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKICAgICAgICB9OwogICAgICAgIGZ1bmN0aW9uIGxpdGVyYWwoIG8gKSB7CiAgICAgICAgICAgIHJldHVybiBvICsgJyc7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsKICAgICAgICAgICAgdmFyIHMgPSBqc0R1bXAuc2VwYXJhdG9yKCksCiAgICAgICAgICAgICAgICBiYXNlID0ganNEdW1wLmluZGVudCgpLAogICAgICAgICAgICAgICAgaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwogICAgICAgICAgICBpZiAoIGFyci5qb2luICkKICAgICAgICAgICAgICAgIGFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsKICAgICAgICAgICAgaWYgKCAhYXJyICkKICAgICAgICAgICAgICAgIHJldHVybiBwcmUgKyBwb3N0OwogICAgICAgICAgICByZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7CiAgICAgICAgfTsKICAgICAgICBmdW5jdGlvbiBhcnJheSggYXJyICkgewogICAgICAgICAgICB2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwogICAgICAgICAgICB0aGlzLnVwKCk7CiAgICAgICAgICAgIHdoaWxlICggaS0tICkKICAgICAgICAgICAgICAgIHJldFtpXSA9IHRoaXMucGFyc2UoIGFycltpXSApOwogICAgICAgICAgICB0aGlzLmRvd24oKTsKICAgICAgICAgICAgcmV0dXJuIGpvaW4oICdbJywgcmV0LCAnXScgKTsKICAgICAgICB9OwoKICAgICAgICB2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgogICAgICAgIHZhciBqc0R1bXAgPSB7CiAgICAgICAgICAgIHBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCiAgICAgICAgICAgICAgICB2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKICAgICAgICAgICAgICAgIHR5cGUgPSB0eXBlb2YgcGFyc2VyOwoKICAgICAgICAgICAgICAgIHJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCggdGhpcywgb2JqICkgOgogICAgICAgICAgICAgICAgICAgIHR5cGUgPT0gJ3N0cmluZycgPyBwYXJzZXIgOgogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnNlcnMuZXJyb3I7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHR5cGVPZjpmdW5jdGlvbiggb2JqICkgewogICAgICAgICAgICAgICAgdmFyIHR5cGU7CiAgICAgICAgICAgICAgICBpZiAoIG9iaiA9PT0gbnVsbCApIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gIm51bGwiOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoUVVuaXQuaXMoIlJlZ0V4cCIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gInJlZ2V4cCI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJEYXRlIiwgb2JqKSkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiZGF0ZSI7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImZ1bmN0aW9uIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iai5zZXRJbnRlcnZhbCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBvYmouZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiBvYmoubm9kZVR5cGUgPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJ3aW5kb3ciOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvYmoubm9kZVR5cGUgPT09IDkpIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gImRvY3VtZW50IjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7CiAgICAgICAgICAgICAgICAgICAgdHlwZSA9ICJub2RlIjsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIG9iai5sZW5ndGggPT09ICJudW1iZXIiICYmIG9iai5sZW5ndGggPj0gMCkgewogICAgICAgICAgICAgICAgICAgIHR5cGUgPSAiYXJyYXkiOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0eXBlID0gdHlwZW9mIG9iajsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHJldHVybiB0eXBlOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwogICAgICAgICAgICAgICAgaWYgKCAhdGhpcy5tdWx0aWxpbmUgKQogICAgICAgICAgICAgICAgICAgIHJldHVybiAnJzsKICAgICAgICAgICAgICAgIHZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CiAgICAgICAgICAgICAgICBpZiAoIHRoaXMuSFRNTCApCiAgICAgICAgICAgICAgICAgICAgY2hyID0gY2hyLnJlcGxhY2UoL1x0L2csJyAgICcpLnJlcGxhY2UoLyAvZywnJm5ic3A7Jyk7CiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHVwOmZ1bmN0aW9uKCBhICkgewogICAgICAgICAgICAgICAgdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZG93bjpmdW5jdGlvbiggYSApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldFBhcnNlcjpmdW5jdGlvbiggbmFtZSwgcGFyc2VyICkgewogICAgICAgICAgICAgICAgdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwogICAgICAgICAgICB9LAogICAgICAgICAgICAvLyBUaGUgbmV4dCAzIGFyZSBleHBvc2VkIHNvIHlvdSBjYW4gdXNlIHRoZW0KICAgICAgICAgICAgcXVvdGU6cXVvdGUsCiAgICAgICAgICAgIGxpdGVyYWw6bGl0ZXJhbCwKICAgICAgICAgICAgam9pbjpqb2luLAogICAgICAgICAgICAvLwogICAgICAgICAgICBfZGVwdGhfOiAxLAogICAgICAgICAgICAvLyBUaGlzIGlzIHRoZSBsaXN0IG9mIHBhcnNlcnMsIHRvIG1vZGlmeSB0aGVtLCB1c2UganNEdW1wLnNldFBhcnNlcgogICAgICAgICAgICBwYXJzZXJzOnsKICAgICAgICAgICAgICAgIHdpbmRvdzogJ1tXaW5kb3ddJywKICAgICAgICAgICAgICAgIGRvY3VtZW50OiAnW0RvY3VtZW50XScsCiAgICAgICAgICAgICAgICBlcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KICAgICAgICAgICAgICAgIHVua25vd246ICdbVW5rbm93bl0nLAogICAgICAgICAgICAgICAgJ251bGwnOidudWxsJywKICAgICAgICAgICAgICAgIHVuZGVmaW5lZDondW5kZWZpbmVkJywKICAgICAgICAgICAgICAgICdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSAnZnVuY3Rpb24nLAogICAgICAgICAgICAgICAgICAgICAgICBuYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKICAgICAgICAgICAgICAgICAgICBpZiAoIG5hbWUgKQogICAgICAgICAgICAgICAgICAgICAgICByZXQgKz0gJyAnICsgbmFtZTsKICAgICAgICAgICAgICAgICAgICByZXQgKz0gJygnOwoKICAgICAgICAgICAgICAgICAgICByZXQgPSBbIHJldCwgUVVuaXQuanNEdW1wLnBhcnNlKCBmbiwgJ2Z1bmN0aW9uQXJncycgKSwgJyl7J10uam9pbignJyk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oIHJldCwgUVVuaXQuanNEdW1wLnBhcnNlKGZuLCdmdW5jdGlvbkNvZGUnKSwgJ30nICk7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXJyYXk6IGFycmF5LAogICAgICAgICAgICAgICAgbm9kZWxpc3Q6IGFycmF5LAogICAgICAgICAgICAgICAgYXJndW1lbnRzOiBhcnJheSwKICAgICAgICAgICAgICAgIG9iamVjdDpmdW5jdGlvbiggbWFwICkgewogICAgICAgICAgICAgICAgICAgIHZhciByZXQgPSBbIF07CiAgICAgICAgICAgICAgICAgICAgUVVuaXQuanNEdW1wLnVwKCk7CiAgICAgICAgICAgICAgICAgICAgZm9yICggdmFyIGtleSBpbiBtYXAgKQogICAgICAgICAgICAgICAgICAgICAgICByZXQucHVzaCggUVVuaXQuanNEdW1wLnBhcnNlKGtleSwna2V5JykgKyAnOiAnICsgUVVuaXQuanNEdW1wLnBhcnNlKG1hcFtrZXldKSApOwogICAgICAgICAgICAgICAgICAgIFFVbml0LmpzRHVtcC5kb3duKCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBub2RlOmZ1bmN0aW9uKCBub2RlICkgewogICAgICAgICAgICAgICAgICAgIHZhciBvcGVuID0gUVVuaXQuanNEdW1wLkhUTUwgPyAnJmx0OycgOiAnPCcsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsb3NlID0gUVVuaXQuanNEdW1wLkhUTUwgPyAnJmd0OycgOiAnPic7CgogICAgICAgICAgICAgICAgICAgIHZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCiAgICAgICAgICAgICAgICAgICAgICAgIHJldCA9IG9wZW4gKyB0YWc7CgogICAgICAgICAgICAgICAgICAgIGZvciAoIHZhciBhIGluIFFVbml0LmpzRHVtcC5ET01BdHRycyApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHZhbCA9IG5vZGVbUVVuaXQuanNEdW1wLkRPTUF0dHJzW2FdXTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCB2YWwgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0ICs9ICcgJyArIGEgKyAnPScgKyBRVW5pdC5qc0R1bXAucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24KICAgICAgICAgICAgICAgICAgICB2YXIgbCA9IGZuLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoICFsICkgcmV0dXJuICcnOwoKICAgICAgICAgICAgICAgICAgICB2YXIgYXJncyA9IEFycmF5KGwpOwogICAgICAgICAgICAgICAgICAgIHdoaWxlICggbC0tICkKICAgICAgICAgICAgICAgICAgICAgICAgYXJnc1tsXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcrbCk7Ly85NyBpcyAnYScKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGtleTpxdW90ZSwgLy9vYmplY3QgY2FsbHMgaXQgaW50ZXJuYWxseSwgdGhlIGtleSBwYXJ0IG9mIGFuIGl0ZW0gaW4gYSBtYXAKICAgICAgICAgICAgICAgIGZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgogICAgICAgICAgICAgICAgYXR0cmlidXRlOnF1b3RlLCAvL25vZGUgY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyBhbiBodG1sIGF0dHJpYnV0ZSB2YWx1ZQogICAgICAgICAgICAgICAgc3RyaW5nOnF1b3RlLAogICAgICAgICAgICAgICAgZGF0ZTpxdW90ZSwKICAgICAgICAgICAgICAgIHJlZ2V4cDpsaXRlcmFsLCAvL3JlZ2V4CiAgICAgICAgICAgICAgICBudW1iZXI6bGl0ZXJhbCwKICAgICAgICAgICAgICAgICdib29sZWFuJzpsaXRlcmFsCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIERPTUF0dHJzOnsvL2F0dHJpYnV0ZXMgdG8gZHVtcCBmcm9tIG5vZGVzLCBuYW1lPT5yZWFsTmFtZQogICAgICAgICAgICAgICAgaWQ6J2lkJywKICAgICAgICAgICAgICAgIG5hbWU6J25hbWUnLAogICAgICAgICAgICAgICAgJ2NsYXNzJzonY2xhc3NOYW1lJwogICAgICAgICAgICB9LAogICAgICAgICAgICBIVE1MOmZhbHNlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkKICAgICAgICAgICAgaW5kZW50Q2hhcjonICAgJywvL2luZGVudGF0aW9uIHVuaXQKICAgICAgICAgICAgbXVsdGlsaW5lOmZhbHNlIC8vaWYgdHJ1ZSwgaXRlbXMgaW4gYSBjb2xsZWN0aW9uLCBhcmUgc2VwYXJhdGVkIGJ5IGEgXG4sIGVsc2UganVzdCBhIHNwYWNlLgogICAgICAgIH07CgogICAgICAgIHJldHVybiBqc0R1bXA7CiAgICB9KSgpOwoKLy8gZnJvbSBTaXp6bGUuanMKICAgIGZ1bmN0aW9uIGdldFRleHQoIGVsZW1zICkgewogICAgICAgIHZhciByZXQgPSAiIiwgZWxlbTsKCiAgICAgICAgZm9yICggdmFyIGkgPSAwOyBlbGVtc1tpXTsgaSsrICkgewogICAgICAgICAgICBlbGVtID0gZWxlbXNbaV07CgogICAgICAgICAgICAvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwogICAgICAgICAgICBpZiAoIGVsZW0ubm9kZVR5cGUgPT09IDMgfHwgZWxlbS5ub2RlVHlwZSA9PT0gNCApIHsKICAgICAgICAgICAgICAgIHJldCArPSBlbGVtLm5vZGVWYWx1ZTsKCiAgICAgICAgICAgICAgICAvLyBUcmF2ZXJzZSBldmVyeXRoaW5nIGVsc2UsIGV4Y2VwdCBjb21tZW50IG5vZGVzCiAgICAgICAgICAgIH0gZWxzZSBpZiAoIGVsZW0ubm9kZVR5cGUgIT09IDggKSB7CiAgICAgICAgICAgICAgICByZXQgKz0gZ2V0VGV4dCggZWxlbS5jaGlsZE5vZGVzICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiByZXQ7CiAgICB9OwoKICAgIC8qCiAgICAgKiBKYXZhc2NyaXB0IERpZmYgQWxnb3JpdGhtCiAgICAgKiAgQnkgSm9obiBSZXNpZyAoaHR0cDovL2Vqb2huLm9yZy8pCiAgICAgKiAgTW9kaWZpZWQgYnkgQ2h1IEFsYW4gInNwcml0ZSIKICAgICAqCiAgICAgKiBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UuCiAgICAgKgogICAgICogTW9yZSBJbmZvOgogICAgICogIGh0dHA6Ly9lam9obi5vcmcvcHJvamVjdHMvamF2YXNjcmlwdC1kaWZmLWFsZ29yaXRobS8KICAgICAqCiAgICAgKiBVc2FnZTogUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKQogICAgICoKICAgICAqIFFVbml0LmRpZmYoInRoZSBxdWljayBicm93biBmb3gganVtcGVkIG92ZXIiLCAidGhlIHF1aWNrIGZveCBqdW1wcyBvdmVyIikgPT0gInRoZSAgcXVpY2sgPGRlbD5icm93biA8L2RlbD4gZm94IDxkZWw+anVtcGVkIDwvZGVsPjxpbnM+anVtcHMgPC9pbnM+IG92ZXIiCiAgICAgKi8KICAgIFFVbml0LmRpZmYgPSAoZnVuY3Rpb24oKSB7CiAgICAgICAgZnVuY3Rpb24gZGlmZihvLCBuKXsKICAgICAgICAgICAgdmFyIG5zID0gbmV3IE9iamVjdCgpOwogICAgICAgICAgICB2YXIgb3MgPSBuZXcgT2JqZWN0KCk7CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoOyBpKyspIHsKICAgICAgICAgICAgICAgIGlmIChuc1tuW2ldXSA9PSBudWxsKQogICAgICAgICAgICAgICAgICAgIG5zW25baV1dID0gewogICAgICAgICAgICAgICAgICAgICAgICByb3dzOiBuZXcgQXJyYXkoKSwKICAgICAgICAgICAgICAgICAgICAgICAgbzogbnVsbAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICBuc1tuW2ldXS5yb3dzLnB1c2goaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgby5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgaWYgKG9zW29baV1dID09IG51bGwpCiAgICAgICAgICAgICAgICAgICAgb3Nbb1tpXV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJvd3M6IG5ldyBBcnJheSgpLAogICAgICAgICAgICAgICAgICAgICAgICBuOiBudWxsCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIG9zW29baV1dLnJvd3MucHVzaChpKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZm9yICh2YXIgaSBpbiBucykgewogICAgICAgICAgICAgICAgaWYgKG5zW2ldLnJvd3MubGVuZ3RoID09IDEgJiYgdHlwZW9mKG9zW2ldKSAhPSAidW5kZWZpbmVkIiAmJiBvc1tpXS5yb3dzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgbltuc1tpXS5yb3dzWzBdXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogbltuc1tpXS5yb3dzWzBdXSwKICAgICAgICAgICAgICAgICAgICAgICAgcm93OiBvc1tpXS5yb3dzWzBdCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBvW29zW2ldLnJvd3NbMF1dID0gewogICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBvW29zW2ldLnJvd3NbMF1dLAogICAgICAgICAgICAgICAgICAgICAgICByb3c6IG5zW2ldLnJvd3NbMF0KICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoIC0gMTsgaSsrKSB7CiAgICAgICAgICAgICAgICBpZiAobltpXS50ZXh0ICE9IG51bGwgJiYgbltpICsgMV0udGV4dCA9PSBudWxsICYmIG5baV0ucm93ICsgMSA8IG8ubGVuZ3RoICYmIG9bbltpXS5yb3cgKyAxXS50ZXh0ID09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICBuW2kgKyAxXSA9PSBvW25baV0ucm93ICsgMV0pIHsKICAgICAgICAgICAgICAgICAgICBuW2kgKyAxXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogbltpICsgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdzogbltpXS5yb3cgKyAxCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBvW25baV0ucm93ICsgMV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG9bbltpXS5yb3cgKyAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgcm93OiBpICsgMQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciAodmFyIGkgPSBuLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKICAgICAgICAgICAgICAgIGlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgLSAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgPiAwICYmIG9bbltpXS5yb3cgLSAxXS50ZXh0ID09IG51bGwgJiYKICAgICAgICAgICAgICAgICAgICBuW2kgLSAxXSA9PSBvW25baV0ucm93IC0gMV0pIHsKICAgICAgICAgICAgICAgICAgICBuW2kgLSAxXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogbltpIC0gMV0sCiAgICAgICAgICAgICAgICAgICAgICAgIHJvdzogbltpXS5yb3cgLSAxCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBvW25baV0ucm93IC0gMV0gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG9bbltpXS5yb3cgLSAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgcm93OiBpIC0gMQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBvOiBvLAogICAgICAgICAgICAgICAgbjogbgogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKG8sIG4pewogICAgICAgICAgICBvID0gby5yZXBsYWNlKC9ccyskLywgJycpOwogICAgICAgICAgICBuID0gbi5yZXBsYWNlKC9ccyskLywgJycpOwogICAgICAgICAgICB2YXIgb3V0ID0gZGlmZihvID09ICIiID8gW10gOiBvLnNwbGl0KC9ccysvKSwgbiA9PSAiIiA/IFtdIDogbi5zcGxpdCgvXHMrLykpOwoKICAgICAgICAgICAgdmFyIHN0ciA9ICIiOwoKICAgICAgICAgICAgdmFyIG9TcGFjZSA9IG8ubWF0Y2goL1xzKy9nKTsKICAgICAgICAgICAgaWYgKG9TcGFjZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBvU3BhY2UgPSBbIiAiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG9TcGFjZS5wdXNoKCIgIik7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5TcGFjZSA9IG4ubWF0Y2goL1xzKy9nKTsKICAgICAgICAgICAgaWYgKG5TcGFjZSA9PSBudWxsKSB7CiAgICAgICAgICAgICAgICBuU3BhY2UgPSBbIiAiXTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG5TcGFjZS5wdXNoKCIgIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChvdXQubi5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQuby5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIHN0ciArPSAnPGRlbD4nICsgb3V0Lm9baV0gKyBvU3BhY2VbaV0gKyAiPC9kZWw+IjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChvdXQublswXS50ZXh0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKG4gPSAwOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQubi5sZW5ndGg7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmIChvdXQubltpXS50ZXh0ID09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyICs9ICc8aW5zPicgKyBvdXQubltpXSArIG5TcGFjZVtpXSArICI8L2lucz4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHByZSA9ICIiOwoKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChuID0gb3V0Lm5baV0ucm93ICsgMTsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlICs9ICc8ZGVsPicgKyBvdXQub1tuXSArIG9TcGFjZVtuXSArICI8L2RlbD4iOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciArPSAiICIgKyBvdXQubltpXS50ZXh0ICsgblNwYWNlW2ldICsgcHJlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9OwogICAgfSkoKTsKCn0pKHRoaXMpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 12:41:46 GMT",
                    "Content-Length": "45499",
                    "Date": "Thu, 06 Nov 2014 12:41:48 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}