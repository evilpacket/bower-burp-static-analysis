{
    "url": "http://localhost:9999/Esri/geotriggers-js/geotrigger.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var tmp =  document.cookie.match((new RegExp(key +'=[a-zA-Z0-9.()=|%/_]+($|;)','g')));</li><li>return JSON.parse(tmp[0].substring(key.length+1,tmp[0].length).replace(';','')) || null;</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/Esri/geotriggers-js/geotrigger.js",
                "path": "/Esri/geotriggers-js/geotrigger.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9Fc3JpL2dlb3RyaWdnZXJzLWpzL2dlb3RyaWdnZXIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTI2NDQNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDI6MTY6MzkgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDAyOjE2OjM5IEdNVA0KDQooZnVuY3Rpb24gKHJvb3QsIGZhY3RvcnkpIHsKCiAgLy8gTm9kZS4KICBpZih0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlLmV4cG9ydHMgPT09ICdvYmplY3QnKSB7CiAgICBYTUxIdHRwUmVxdWVzdCA9IHJlcXVpcmUoInhtbGh0dHByZXF1ZXN0IikuWE1MSHR0cFJlcXVlc3Q7CiAgICBleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBmYWN0b3J5KCk7CiAgfQoKICAvLyBCcm93c2VyIEdsb2JhbC4KICBpZih0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IikgewogICAgcm9vdC5HZW90cmlnZ2VyID0gZmFjdG9yeSgpOwogIH0KCn0odGhpcywgZnVuY3Rpb24oKSB7CgogIHZhciBnZW90cmlnZ2Vyc1VybCAgICA9ICJodHRwczovL2dlb3RyaWdnZXIuYXJjZ2lzLmNvbS8iOwogIHZhciB0b2tlblVybCAgICAgICAgICA9ICJodHRwczovL3d3dy5hcmNnaXMuY29tL3NoYXJpbmcvb2F1dGgyL3Rva2VuIjsKICB2YXIgcmVnaXN0ZXJEZXZpY2VVcmwgPSAiaHR0cHM6Ly93d3cuYXJjZ2lzLmNvbS9zaGFyaW5nL29hdXRoMi9yZWdpc3RlckRldmljZSI7CiAgdmFyIGV4cG9ydHMgICAgICAgICAgID0ge307CiAgdmFyIENPUlMgICAgICAgICAgICAgID0gdHJ1ZTsKCiAgaWYgKHR5cGVvZiB3aW5kb3cgPT09ICJvYmplY3QiKSB7CiAgICBDT1JTID0gISEod2luZG93LlhNTEh0dHBSZXF1ZXN0ICYmICd3aXRoQ3JlZGVudGlhbHMnIGluIG5ldyBYTUxIdHRwUmVxdWVzdCgpKTsKICB9CgogIGlmICghRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQpIHsKICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kID0gZnVuY3Rpb24gKG9UaGlzKSB7CiAgICAgIGlmICh0eXBlb2YgdGhpcyAhPT0gImZ1bmN0aW9uIikgewogICAgICAgIC8vIGNsb3Nlc3QgdGhpbmcgcG9zc2libGUgdG8gdGhlIEVDTUFTY3JpcHQgNSBpbnRlcm5hbCBJc0NhbGxhYmxlIGZ1bmN0aW9uCiAgICAgICAgdGhyb3cgbmV3IFR5cGVFcnJvcigiRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQgLSB3aGF0IGlzIHRyeWluZyB0byBiZSBib3VuZCBpcyBub3QgY2FsbGFibGUiKTsKICAgICAgfQoKICAgICAgdmFyIGFBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKSwKICAgICAgICAgIGZUb0JpbmQgPSB0aGlzLAogICAgICAgICAgRk5PUCA9IGZ1bmN0aW9uKCkge30sCiAgICAgICAgICBmQm91bmQgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZUb0JpbmQuYXBwbHkodGhpcyBpbnN0YW5jZW9mIEZOT1AgJiYgb1RoaXMgPyB0aGlzIDogb1RoaXMsIGFBcmdzLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpKSk7CiAgICAgICAgICB9OwoKICAgICAgRk5PUC5wcm90b3R5cGUgPSB0aGlzLnByb3RvdHlwZTsKICAgICAgZkJvdW5kLnByb3RvdHlwZSA9IG5ldyBGTk9QKCk7CgogICAgICByZXR1cm4gZkJvdW5kOwogICAgfTsKICB9CgogIGZ1bmN0aW9uIFNlc3Npb24ob3B0aW9ucyl7CiAgICB0aGlzLl9xdWV1ZSA9IFtdOwogICAgdGhpcy5fcmVxdWVzdFF1ZXVlID0gW107CiAgICB0aGlzLl9ldmVudHMgPSB7fTsKCiAgICB2YXIgZGVmYXVsdHMgPSB7CiAgICAgIHByZWZlckxvY2FsU3RvcmFnZTogdHJ1ZSwKICAgICAgcGVyc2lzdFNlc3Npb246ICh0eXBlb2YgbW9kdWxlICE9PSAndW5kZWZpbmVkJyAmJiBtb2R1bGUuZXhwb3J0cykgPyBmYWxzZSA6IHRydWUsCiAgICAgIGdlb3RyaWdnZXJzVXJsOiBnZW90cmlnZ2Vyc1VybCwKICAgICAgdG9rZW5Vcmw6IHRva2VuVXJsLAogICAgICByZWdpc3RlckRldmljZVVybDogcmVnaXN0ZXJEZXZpY2VVcmwsCiAgICAgIGF1dG9tYXRpY1JlZ2lzdGF0aW9uOiB0cnVlLAogICAgICBwcm94eTogZmFsc2UKICAgIH07CgogICAgLy8gc2V0IGFwcGxpY2F0aW9uIGlkCiAgICBpZighb3B0aW9ucyB8fCAhb3B0aW9ucy5jbGllbnRJZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIkdlb3RyaWdnZXIuU2Vzc2lvbiByZXF1aXJlcyBhbiBgY2xpZW50SWRgIG9yIGEgYHNlc3Npb25gIHBhcmFtZXRlci4iKTsKICAgIH0KCiAgICBpZighb3B0aW9ucy5wcm94eSAmJiAhQ09SUykgewogICAgICB0aHJvdyBuZXcgRXJyb3IoIlRoaXMgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IENPUlMgYW5kIGEgcHJveHkgaGFzIG5vdCBiZWVuIHNldC4iKTsKICAgIH0KCiAgICAvLyBtZXJnZSBkZWZhdWx0cyBhbmQgb3B0aW9ucyBpbnRvIGB0aGlzYAogICAgdXRpbC5tZXJnZSh0aGlzLCB1dGlsLm1lcmdlKGRlZmF1bHRzLCBvcHRpb25zKSk7CgogICAgdGhpcy5hdXRoZW50aWNhdGVkQXMgPSAodGhpcy5jbGllbnRJZCAmJiB0aGlzLmNsaWVudFNlY3JldCkgPyAiYXBwbGljYXRpb24iIDogImRldmljZSI7CgogICAgdGhpcy5rZXkgPSAiZ2VvdHJpZ2dlcnNfIiArIHRoaXMuYXV0aGVudGljYXRlZEFzICsgIl8iICsgdGhpcy5jbGllbnRJZDsKCiAgICAvL3Jlc3RvcmUgYSBzdG9yZWQgc2Vzc2lvbiBpZiB3ZSBoYXZlIG9uZQogICAgaWYodGhpcy5wZXJzaXN0U2Vzc2lvbikgewogICAgICBpZih0aGlzLnByZWZlckxvY2FsU3RvcmFnZSAmJiBoYXNMb2NhbFN0b3JhZ2UpewogICAgICAgIHV0aWwubWVyZ2UodGhpcywgbG9jYWxTdG9yYWdlLmdldCh0aGlzLmtleSkpOwogICAgICB9IGVsc2UgaWYgKGhhc0Nvb2tpZXMpIHsKICAgICAgICB1dGlsLm1lcmdlKHRoaXMsIGNvb2tpZS5nZXQodGhpcy5rZXkpKTsKICAgICAgfQogICAgfQoKICAgIC8vIGlmIHRoZXJlIGlzIGFuIGFjY2VzcyB0b2tlbiBhbmQgaXQgaXMgYWZ0ZXIgd2hlbiB0aGUgdG9rZW4gZXhwaXJlcyBvciB0aGVyZSBpcyBubyBhY2Nlc3MgdG9rZW4KICAgIGlmKCh0aGlzLnRva2VuICYmIChEYXRlLm5vdygpID4gbmV3IERhdGUodGhpcy5leHBpcmVzT24pLmdldFRpbWUoKSkpIHx8ICF0aGlzLnRva2VuKXsKICAgICAgLy8gcmVtb3ZlIHRva2VuIHRvIHByZXZlbnQgcXVldWVkIGZ1bmN0aW9ucyBmcm9tIGZpcmluZwogICAgICBkZWxldGUgdGhpcy50b2tlbjsKICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICB9CgogICAgLy8gaWYgdG9rZW4gZXhpc3RzLCBpcyBub3QgZXhwaXJlZCwgYW5kIHNlc3Npb24gaGFzIGJlZW4gcmVzdG9yZWQKICAgIGVsc2UgaWYgKHRoaXMucGVyc2lzdFNlc3Npb24pIHsKICAgICAgdGhpcy5lbWl0KCJhdXRoZW50aWNhdGlvbjpyZXN0b3JlZCIpOwogICAgfQogIH0KCiAgU2Vzc2lvbi5wcm90b3R5cGUuYXV0aGVudGljYXRlZCA9IGZ1bmN0aW9uKCl7CiAgICByZXR1cm4gISF0aGlzLnRva2VuOwogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbigpewogICAgaWYodGhpcy5yZWZyZXNoaW5nKXsKICAgICAgcmV0dXJuOwogICAgfQogICAgdGhpcy5yZWZyZXNoaW5nID0gdHJ1ZTsKICAgIHZhciB1cmwgPSB0aGlzLnRva2VuVXJsOwogICAgdmFyIHBhcmFtcyA9IHsKICAgICAgY2xpZW50X2lkOiB0aGlzLmNsaWVudElkLAogICAgICBmOiAianNvbiIKICAgIH07CgogICAgaWYodGhpcy5jbGllbnRTZWNyZXQpewogICAgICBwYXJhbXMuY2xpZW50X3NlY3JldCA9IHRoaXMuY2xpZW50U2VjcmV0OwogICAgICBwYXJhbXMuZ3JhbnRfdHlwZSA9ICAiY2xpZW50X2NyZWRlbnRpYWxzIjsKICAgIH0gZWxzZSBpZiAodGhpcy5yZWZyZXNoVG9rZW4pewogICAgICBwYXJhbXMucmVmcmVzaF90b2tlbiA9IHRoaXMucmVmcmVzaFRva2VuOwogICAgICBwYXJhbXMuZ3JhbnRfdHlwZSA9ICJyZWZyZXNoX3Rva2VuIjsKICAgIH0gZWxzZSBpZiAodGhpcy5hdXRvbWF0aWNSZWdpc3RhdGlvbikgewogICAgICB1cmwgPSB0aGlzLnJlZ2lzdGVyRGV2aWNlVXJsOwogICAgfQoKICAgIHRoaXMucmVxdWVzdCh1cmwsIHBhcmFtcywgZnVuY3Rpb24oZXJyb3IsIHJlc3BvbnNlLCB4aHIpewogICAgICB0aGlzLnJlZnJlc2hpbmcgPSBmYWxzZTsKCiAgICAgIGlmIChlcnJvcikgewogICAgICAgIHRoaXMuZW1pdCgiYXV0aGVudGljYXRpb246ZXJyb3IiLCBlcnJvciwgcmVzcG9uc2UsIHhocik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0aGlzLmV4cGlyZXNPbiA9IG5ldyBEYXRlKG5ldyBEYXRlKCkuZ2V0VGltZSgpICsgKChyZXNwb25zZS5leHBpcmVzX2luLSg2MCo1KSkgKjEwMDApKTsKCiAgICAgIGlmKHJlc3BvbnNlLmRldmljZVRva2VuKXsKICAgICAgICB0aGlzLnJlZnJlc2hUb2tlbiA9IHJlc3BvbnNlLmRldmljZVRva2VuLnJlZnJlc2hfdG9rZW47CiAgICAgICAgdGhpcy50b2tlbiA9IHJlc3BvbnNlLmRldmljZVRva2VuLmFjY2Vzc190b2tlbjsKICAgICAgICB0aGlzLmRldmljZUlkID0gcmVzcG9uc2UuZGV2aWNlLmRldmljZUlkOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9rZW4gPSByZXNwb25zZS5hY2Nlc3NfdG9rZW47CiAgICAgIH0KCiAgICAgIGlmKHRoaXMucGVyc2lzdFNlc3Npb24pewogICAgICAgIHRoaXMucGVyc2lzdCgpOwogICAgICB9CgogICAgICB3aGlsZSAodGhpcy5fcXVldWUubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5fcXVldWUuc2hpZnQoKS5hcHBseSh0aGlzKTsKICAgICAgfQoKICAgICAgdGhpcy5lbWl0KCJhdXRoZW50aWNhdGlvbjpzdWNjZXNzIik7CgogICAgICB3aGlsZSAodGhpcy5fcmVxdWVzdFF1ZXVlLmxlbmd0aCkgewogICAgICAgIHRoaXMucmVxdWVzdC5hcHBseSh0aGlzLCB0aGlzLl9yZXF1ZXN0UXVldWUuc2hpZnQoKSk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKSk7CiAgfTsKCiAgU2Vzc2lvbi5wcm90b3R5cGUudG9KU09OID0gZnVuY3Rpb24oKXsKICAgIHZhciBvYmogPSB7fTsKICAgIGZvciAodmFyIGtleSBpbiB0aGlzKSB7CiAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KGtleSkgJiYgdGhpc1trZXldICYmICFrZXkubWF0Y2goL15fLisvKSkgewogICAgICAgIG9ialtrZXldID0gdGhpc1trZXldOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gb2JqOwogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLm9uID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpewogICAgdmFyIHR5cGVzID0gdHlwZS5zcGxpdCgnICcpOwoKICAgIGZvciAodmFyIGk9MDsgaSA8IHR5cGVzLmxlbmd0aDsgaSsrKSB7CiAgICAgIGlmICh0eXBlb2YgdGhpcy5fZXZlbnRzW3R5cGVzW2ldXSA9PT0gInVuZGVmaW5lZCIpIHsKICAgICAgICB0aGlzLl9ldmVudHNbdHlwZXNbaV1dID0gW107CiAgICAgIH0KICAgICAgdGhpcy5fZXZlbnRzW3R5cGVzW2ldXS5wdXNoKGxpc3RlbmVyKTsKICAgIH0KICB9OwoKICBTZXNzaW9uLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24odHlwZSl7CiAgICB2YXIgYXJncyA9IFtdLnNwbGljZS5jYWxsKGFyZ3VtZW50cywxKTsKICAgIGlmICh0aGlzLl9ldmVudHNbdHlwZV0gaW5zdGFuY2VvZiBBcnJheSl7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIGZvciAodmFyIGk9MCwgbGVuPWxpc3RlbmVycy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOwogICAgICB9CiAgICB9CiAgfTsKCiAgU2Vzc2lvbi5wcm90b3R5cGUub2ZmID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpewogICAgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSBpbnN0YW5jZW9mIEFycmF5KXsKICAgICAgdmFyIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKICAgICAgZm9yICh2YXIgaT0wLCBsZW49bGlzdGVuZXJzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICBpZiAobGlzdGVuZXJzW2ldID09PSBsaXN0ZW5lcil7CiAgICAgICAgICBsaXN0ZW5lcnMuc3BsaWNlKGksIDEpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfTsKCiAgU2Vzc2lvbi5wcm90b3R5cGUucXVldWUgPSBmdW5jdGlvbihmbikgewogICAgaWYgKCF0aGlzLnRva2VuKSB7CiAgICAgIHRoaXMuX3F1ZXVlLnB1c2goZm4pOwogICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGZuLmFwcGx5KHRoaXMpOwogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLnJlcXVlc3QgPSBmdW5jdGlvbihtZXRob2QsIHBhcmFtcywgY2FsbGJhY2spewogICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsKICAgIHZhciBqc29uOwogICAgdmFyIGVycm9yOwogICAgdmFyIHJlc3BvbnNlOwogICAgdmFyIGh0dHBSZXF1ZXN0OwoKICAgIC8vIGFzc3VtZSB0aGlzIGlzIGEgcmVxdWVzdCB0byBnZXRyaWdnZXJzIGlzIGl0IGRvZXNuJ3Qgc3RhcnQgd2l0aCAoaHR0cHxodHRwcyk6Ly8KICAgIHZhciBnZW90cmlnZ2Vyc1JlcXVlc3QgPSAhbWV0aG9kLm1hdGNoKC9eaHR0cHM/OlwvXC8vKTsKCiAgICAvLyBjcmVhdGUgdGhlIHVybCBmb3IgdGhlIHJlcXVlc3QKICAgIHZhciB1cmwgPSAoZ2VvdHJpZ2dlcnNSZXF1ZXN0KSA/IHRoaXMuZ2VvdHJpZ2dlcnNVcmwgKyBtZXRob2QgOiBtZXRob2Q7CgogICAgaWYgKHRoaXMucHJveHkpIHsKICAgICAgdXJsID0gdGhpcy5wcm94eSArIHVybDsKICAgIH0KCiAgICBpZih0eXBlb2YgcGFyYW1zID09PSAiZnVuY3Rpb24iKXsKICAgICAgY2FsbGJhY2sgPSBwYXJhbXM7CiAgICAgIHBhcmFtcyA9IHt9OwogICAgfQoKICAgIGlmKGdlb3RyaWdnZXJzUmVxdWVzdCAmJiAhdGhpcy50b2tlbil7CiAgICAgIHRoaXMuX3JlcXVlc3RRdWV1ZS5wdXNoKGFyZ3MpOwogICAgICB0aGlzLnJlZnJlc2goKTsKICAgICAgcmV0dXJuOwogICAgfQoKICAgIC8vIGNhbGxiYWNrIGZvciBoYW5kbGluZyBhIHN1Y2Nlc3NmdWwgcmVxdWVzdAogICAgdmFyIGhhbmRsZVN1Y2Nlc3NmdWxSZXNwb25zZSA9IGZ1bmN0aW9uKCl7CgogICAgICB0cnkgewogICAgICAgIGpzb24gPSBKU09OLnBhcnNlKGh0dHBSZXF1ZXN0LnJlc3BvbnNlVGV4dCk7CiAgICAgICAgcmVzcG9uc2UgPSAoanNvbi5lcnJvcikgPyBudWxsIDoganNvbjsKICAgICAgICBlcnJvciA9IChqc29uLmVycm9yKSA/IGpzb24uZXJyb3IgOiBudWxsOwogICAgICB9IGNhdGNoIChlKXsKICAgICAgICByZXNwb25zZSA9IG51bGw7CiAgICAgICAgZXJyb3IgPSB7CiAgICAgICAgICB0eXBlOiAicGFyc2VfZXJyb3IiLAogICAgICAgICAgbWVzc2FnZTogImNvdW5kIG5vdCBwYXJzZSByZXNwb25zZSBhcyBKU09OIgogICAgICAgIH07CiAgICAgIH0KCiAgICAgIC8vIGRpZCBvdXIgdG9rZW4gZXhwaXJlPwogICAgICAvLyBpZiBpdCBkaWRuJ3QgcmVzb2x2ZSBvciByZWplY3QgdGhlIGNhbGxiYWNrCiAgICAgIC8vIGlmIGl0IGRpZCByZWZyZXNoIHRoZSBhdXRoIGFuZCBydW4gdGhlIHJlcXVlc3QgYWdhaW4KICAgICAgaWYoZXJyb3IgJiYgZXJyb3IudHlwZSA9PT0gImludmFsaWRIZWFkZXIiICYmIGVycm9yLmhlYWRlcnMuQXV0aG9yaXphdGlvbil7CiAgICAgICAgdGhpcy5fcmVxdWVzdFF1ZXVlLnB1c2goYXJncyk7CiAgICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKCFlcnJvcil7CiAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXNwb25zZSwgaHR0cFJlcXVlc3QpOwogICAgICAgIH0gZWxzZSBpZiAoZXJyb3IpewogICAgICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwsIGh0dHBSZXF1ZXN0KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIGVycm9yTWVzc2FnZSA9IHsKICAgICAgICAgICAgdHlwZTogInVuZXhwZWN0ZWRfcmVzcG9uc2UiLAogICAgICAgICAgICBtZXNzYWdlOiAidGhlIGFwaSByZXR1cm5lZCBhIG5vbiBKU09OIG9yIHVuZXhwZWN0ZWQgZGF0YSIKICAgICAgICAgIH07CiAgICAgICAgICBjYWxsYmFjayhlcnJvck1lc3NhZ2UsIG51bGwsIGh0dHBSZXF1ZXN0KTsKICAgICAgICB9CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICAvLyBjYWxsYmFjayBmb3IgaGFuZGxpbmcgYW4gaHR0cCBlcnJvcgogICAgdmFyIGhhbmRsZUVycm9yUmVzcG9uc2UgPSBmdW5jdGlvbigpewogICAgICB2YXIgZXJyb3IgPSB7CiAgICAgICAgdHlwZTogImh0dHBfZXJyb3IiCiAgICAgIH07CgogICAgICB0cnkgewogICAgICAgIGVycm9yLm1lc3NhZ2UgPSBKU09OLnBhcnNlKGh0dHBSZXF1ZXN0LnJlc3BvbnNlVGV4dCk7CiAgICAgIH0gY2F0Y2ggKGUpewogICAgICAgIGVycm9yLm1lc3NhZ2UgPSAiaHR0cCBlcnJvciBhbmQgY291bmQgbm90IHBhcnNlIHJlc3BvbnNlIGFzIEpTT04iOwogICAgICB9CgogICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCwgaHR0cFJlcXVlc3QpOwogICAgfS5iaW5kKHRoaXMpOwoKICAgIC8vIGNhbGxiYWNrIGZvciBoYW5kbGluZyBzdGF0ZSBjaGFuZ2UKICAgIHZhciBoYW5kbGVTdGF0ZUNoYW5nZSA9IGZ1bmN0aW9uKCl7CiAgICAgIGlmKGh0dHBSZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQgJiYgaHR0cFJlcXVlc3Quc3RhdHVzIDwgNDAwKXsKICAgICAgICBoYW5kbGVTdWNjZXNzZnVsUmVzcG9uc2UoKTsKICAgICAgfSBlbHNlIGlmKGh0dHBSZXF1ZXN0LnJlYWR5U3RhdGUgPT09IDQgJiYgaHR0cFJlcXVlc3Quc3RhdHVzID49IDQwMCkgewogICAgICAgIGhhbmRsZUVycm9yUmVzcG9uc2UoKTsKICAgICAgfQogICAgfS5iaW5kKHRoaXMpOwoKICAgIGh0dHBSZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7CiAgICBodHRwUmVxdWVzdC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBoYW5kbGVTdGF0ZUNoYW5nZTsKCiAgICB2YXIgYm9keTsKCiAgICAvLyBzZXQgdGhlIGFjY2VzcyB0b2tlbiBpbiB0aGUgYm9keQogICAgaWYoZ2VvdHJpZ2dlcnNSZXF1ZXN0KXsKICAgICAgcGFyYW1zLnRva2VuID0gdGhpcy50b2tlbjsKICAgICAgYm9keSA9IEpTT04uc3RyaW5naWZ5KHBhcmFtcyk7CiAgICB9IGVsc2UgewogICAgICBib2R5ID0gdXRpbC5zZXJpYWxpemUocGFyYW1zKTsKICAgIH0KCiAgICBodHRwUmVxdWVzdC5vcGVuKCJQT1NUIiwgdXJsKTsKICAgIGh0dHBSZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoJ0NvbnRlbnQtVHlwZScsIChnZW90cmlnZ2Vyc1JlcXVlc3QpID8gJ2FwcGxpY2F0aW9uL2pzb24nIDogJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpOwoKICAgIGlmKGdlb3RyaWdnZXJzUmVxdWVzdCl7CiAgICAgIGh0dHBSZXF1ZXN0LnNldFJlcXVlc3RIZWFkZXIoJ1gtR1QtQ2xpZW50LU5hbWUnLCAnZ2VvdHJpZ2dlci1qcycpOwogICAgICBodHRwUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdYLUdULUNsaWVudC1WZXJzaW9uJywgJzEuMC4wJyk7CiAgICB9CgogICAgaHR0cFJlcXVlc3Quc2VuZChib2R5KTsKCiAgfTsKCiAgU2Vzc2lvbi5wcm90b3R5cGUucGVyc2lzdCA9IGZ1bmN0aW9uKCkgewogICAgdmFyIHZhbHVlID0ge307CiAgICBpZih0aGlzLmNsaWVudElkKXsgdmFsdWUuY2xpZW50SWQgPSB0aGlzLmNsaWVudElkOyB9CiAgICBpZih0aGlzLmNsaWVudFNlY3JldCl7IHZhbHVlLmNsaWVudFNlY3JldCA9IHRoaXMuY2xpZW50U2VjcmV0OyB9CiAgICBpZih0aGlzLnRva2VuKXsgdmFsdWUudG9rZW4gPSB0aGlzLnRva2VuOyB9CiAgICBpZih0aGlzLnJlZnJlc2hUb2tlbil7IHZhbHVlLnJlZnJlc2hUb2tlbiA9IHRoaXMucmVmcmVzaFRva2VuOyB9CiAgICBpZih0aGlzLmRldmljZUlkKXsgdmFsdWUuZGV2aWNlSWQgPSB0aGlzLmRldmljZUlkOyB9CiAgICBpZih0aGlzLnByZWZlckxvY2FsU3RvcmFnZSAmJiBoYXNMb2NhbFN0b3JhZ2UpewogICAgICBsb2NhbFN0b3JhZ2Uuc2V0KHRoaXMua2V5LCB2YWx1ZSk7CiAgICB9IGVsc2UgaWYgKGhhc0Nvb2tpZXMpIHsKICAgICAgY29va2llLnNldCh0aGlzLmtleSwgdmFsdWUpOwogICAgfQogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLmRlc3Ryb3kgPSBmdW5jdGlvbigpIHsKICAgIGlmKHRoaXMucHJlZmVyTG9jYWxTdG9yYWdlICYmIGhhc0xvY2FsU3RvcmFnZSkgewogICAgICBsb2NhbFN0b3JhZ2UuZXJhc2UodGhpcy5rZXkpOwogICAgfSBlbHNlIGlmIChoYXNDb29raWVzKSB7CiAgICAgIGNvb2tpZS5lcmFzZSh0aGlzLmtleSk7CiAgICB9CiAgfTsKCiAgZXhwb3J0cy5TZXNzaW9uID0gU2Vzc2lvbjsKCiAgLyoKICBHZW5lcmFsIFB1cnBvc2UgVXRpbGl0aWVzCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICB2YXIgdXRpbCA9IHsKICAgIC8vIE1lcmdlIE9iamVjdCAxIGFuZCBPYmplY3QgMi4KICAgIC8vIFByb3BlcnRpZXMgZnJvbSBPYmplY3QgMiB3aWxsIG92ZXJyaWRlIHByb3BlcnRpZXMgaW4gT2JqZWN0IDEuCiAgICAvLyBSZXR1cm5zIE9iamVjdCAxCiAgICBtZXJnZTogZnVuY3Rpb24odGFyZ2V0LCBvYmopewogICAgICBmb3IgKHZhciBhdHRyIGluIG9iaikgewogICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShhdHRyKSl7CiAgICAgICAgICB0YXJnZXRbYXR0cl0gPSBvYmpbYXR0cl07CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0YXJnZXQ7CiAgICB9LAoKICAgIGlzT2JqZWN0OiBmdW5jdGlvbih0aGluZyl7CiAgICAgIHJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodGhpbmcpID09PSAnW29iamVjdCBPYmplY3RdJzsKICAgIH0sCgogICAgc2VyaWFsaXplOiBmdW5jdGlvbihvYmosIHByZWZpeCkgewoKICAgICAgdmFyIGVuYyA9IGVuY29kZVVSSUNvbXBvbmVudDsKCiAgICAgIC8vIG1ha2UgYW4gYXJyYXkgdG8gaG9sZCBlYWNoIHBlaWNlCiAgICAgIHZhciBzdHIgPSBbXTsKCiAgICAgIC8vIGZvciBldmVyeSBrZXkgaW4gb3VyIG9iamVjdAogICAgICBmb3IodmFyIHAgaW4gb2JqKSB7CiAgICAgICAgaWYob2JqLmhhc093blByb3BlcnR5KHApKXsKICAgICAgICAgIHZhciBlOwogICAgICAgICAgdmFyIGsgPSAocHJlZml4KSA/IHByZWZpeCArICJbIiArIHAgKyAiXSIgOiBwLCB2ID0gb2JqW3BdOwogICAgICAgICAgZSA9ICh1dGlsLmlzT2JqZWN0KHYpKSA/IHV0aWwuc2VyaWFsaXplKHYsIGspIDogZW5jKGspICsgIj0iICsgZW5jKHYpOwogICAgICAgICAgc3RyLnB1c2goZSk7CiAgICAgICAgfQogICAgICB9CgogICAgICAvLyBqb2luIHdpdGggYW1wZXJzYW5kcwogICAgICByZXR1cm4gc3RyLmpvaW4oIiYiKTsKICAgIH0KICB9OwoKICAvKgogIFV0aWxpdGllcyBmb3IgbWFuaXB1bGF0aW5nIHNlc3Npb25zCiAgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KICAqLwoKICB2YXIgaGFzTG9jYWxTdG9yYWdlID0gKHR5cGVvZiB3aW5kb3cgPT09ICJvYmplY3QiICYmIHR5cGVvZiB3aW5kb3cubG9jYWxTdG9yYWdlID09PSAib2JqZWN0IikgPyB0cnVlIDogZmFsc2U7CiAgdmFyIGhhc0Nvb2tpZXMgPSAodHlwZW9mIGRvY3VtZW50ID09PSAib2JqZWN0IiAmJiB0eXBlb2YgZG9jdW1lbnQuY29va2llID09PSAic3RyaW5nIikgPyB0cnVlIDogZmFsc2U7CgogIHZhciBsb2NhbFN0b3JhZ2UgPSB7CiAgICBzZXQ6ZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CiAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShrZXksIEpTT04uc3RyaW5naWZ5KHZhbHVlKSk7CiAgICB9LAogICAgZ2V0OiBmdW5jdGlvbihrZXkpewogICAgICByZXR1cm4gSlNPTi5wYXJzZSh3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oa2V5KSk7CiAgICB9LAogICAgZXJhc2U6IGZ1bmN0aW9uKGtleSl7CiAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShrZXkpOwogICAgfQogIH07CgogIHZhciBjb29raWUgPSB7CiAgICBnZXQ6IGZ1bmN0aW9uKGtleSkgewogICAgICAvLyBTdGlsbCBub3Qgc3VyZSB0aGF0ICJbYS16QS1aMC05LigpPXwlL19dKygkfDspIiBtYXRjaCAqYWxsKiBhbGxvd2VkIGNoYXJhY3RlcnMgaW4gY29va2llcwogICAgICB2YXIgdG1wID0gIGRvY3VtZW50LmNvb2tpZS5tYXRjaCgobmV3IFJlZ0V4cChrZXkgKyc9W2EtekEtWjAtOS4oKT18JS9fXSsoJHw7KScsJ2cnKSkpOwogICAgICBpZighdG1wIHx8ICF0bXBbMF0pewogICAgICAgIHJldHVybiBudWxsOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBKU09OLnBhcnNlKHRtcFswXS5zdWJzdHJpbmcoa2V5Lmxlbmd0aCsxLHRtcFswXS5sZW5ndGgpLnJlcGxhY2UoJzsnLCcnKSkgfHwgbnVsbDsKICAgICAgfQogICAgfSwKCiAgICBzZXQ6IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHNlY3VyZSkgewogICAgICB2YXIgY29va2llID0gWwogICAgICAgIGtleSsnPScrSlNPTi5zdHJpbmdpZnkodmFsdWUpLAogICAgICAgICdwYXRoPS8nLAogICAgICAgICdkb21haW49Jyt3aW5kb3cubG9jYXRpb24uaG9zdAogICAgICBdOwoKICAgICAgdmFyIGV4cGlyYXRpb25fZGF0ZSA9IG5ldyBEYXRlKCk7CiAgICAgIGV4cGlyYXRpb25fZGF0ZS5zZXRGdWxsWWVhcihleHBpcmF0aW9uX2RhdGUuZ2V0RnVsbFllYXIoKSArIDEpOwogICAgICBjb29raWUucHVzaChleHBpcmF0aW9uX2RhdGUudG9HTVRTdHJpbmcoKSk7CgogICAgICBpZiAoc2VjdXJlKXsKICAgICAgICBjb29raWUucHVzaCgnc2VjdXJlJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGRvY3VtZW50LmNvb2tpZSA9IGNvb2tpZS5qb2luKCc7ICcpOwogICAgfSwKCiAgICBlcmFzZTogZnVuY3Rpb24oa2V5KSB7CiAgICAgIGRvY3VtZW50LmNvb2tpZSA9IGtleSArICI7ICIgKyBuZXcgRGF0ZSgwKS50b1VUQ1N0cmluZygpOwogICAgfQogIH07CgogIHJldHVybiBleHBvcnRzOwp9KSk7Cg==",
                "body": "KGZ1bmN0aW9uIChyb290LCBmYWN0b3J5KSB7CgogIC8vIE5vZGUuCiAgaWYodHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZS5leHBvcnRzID09PSAnb2JqZWN0JykgewogICAgWE1MSHR0cFJlcXVlc3QgPSByZXF1aXJlKCJ4bWxodHRwcmVxdWVzdCIpLlhNTEh0dHBSZXF1ZXN0OwogICAgZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOwogIH0KCiAgLy8gQnJvd3NlciBHbG9iYWwuCiAgaWYodHlwZW9mIHdpbmRvdyA9PT0gIm9iamVjdCIpIHsKICAgIHJvb3QuR2VvdHJpZ2dlciA9IGZhY3RvcnkoKTsKICB9Cgp9KHRoaXMsIGZ1bmN0aW9uKCkgewoKICB2YXIgZ2VvdHJpZ2dlcnNVcmwgICAgPSAiaHR0cHM6Ly9nZW90cmlnZ2VyLmFyY2dpcy5jb20vIjsKICB2YXIgdG9rZW5VcmwgICAgICAgICAgPSAiaHR0cHM6Ly93d3cuYXJjZ2lzLmNvbS9zaGFyaW5nL29hdXRoMi90b2tlbiI7CiAgdmFyIHJlZ2lzdGVyRGV2aWNlVXJsID0gImh0dHBzOi8vd3d3LmFyY2dpcy5jb20vc2hhcmluZy9vYXV0aDIvcmVnaXN0ZXJEZXZpY2UiOwogIHZhciBleHBvcnRzICAgICAgICAgICA9IHt9OwogIHZhciBDT1JTICAgICAgICAgICAgICA9IHRydWU7CgogIGlmICh0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IikgewogICAgQ09SUyA9ICEhKHdpbmRvdy5YTUxIdHRwUmVxdWVzdCAmJiAnd2l0aENyZWRlbnRpYWxzJyBpbiBuZXcgWE1MSHR0cFJlcXVlc3QoKSk7CiAgfQoKICBpZiAoIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kKSB7CiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uIChvVGhpcykgewogICAgICBpZiAodHlwZW9mIHRoaXMgIT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAvLyBjbG9zZXN0IHRoaW5nIHBvc3NpYmxlIHRvIHRoZSBFQ01BU2NyaXB0IDUgaW50ZXJuYWwgSXNDYWxsYWJsZSBmdW5jdGlvbgogICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoIkZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kIC0gd2hhdCBpcyB0cnlpbmcgdG8gYmUgYm91bmQgaXMgbm90IGNhbGxhYmxlIik7CiAgICAgIH0KCiAgICAgIHZhciBhQXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSksCiAgICAgICAgICBmVG9CaW5kID0gdGhpcywKICAgICAgICAgIEZOT1AgPSBmdW5jdGlvbigpIHt9LAogICAgICAgICAgZkJvdW5kID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmVG9CaW5kLmFwcGx5KHRoaXMgaW5zdGFuY2VvZiBGTk9QICYmIG9UaGlzID8gdGhpcyA6IG9UaGlzLCBhQXJncy5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKSkpOwogICAgICAgICAgfTsKCiAgICAgIEZOT1AucHJvdG90eXBlID0gdGhpcy5wcm90b3R5cGU7CiAgICAgIGZCb3VuZC5wcm90b3R5cGUgPSBuZXcgRk5PUCgpOwoKICAgICAgcmV0dXJuIGZCb3VuZDsKICAgIH07CiAgfQoKICBmdW5jdGlvbiBTZXNzaW9uKG9wdGlvbnMpewogICAgdGhpcy5fcXVldWUgPSBbXTsKICAgIHRoaXMuX3JlcXVlc3RRdWV1ZSA9IFtdOwogICAgdGhpcy5fZXZlbnRzID0ge307CgogICAgdmFyIGRlZmF1bHRzID0gewogICAgICBwcmVmZXJMb2NhbFN0b3JhZ2U6IHRydWUsCiAgICAgIHBlcnNpc3RTZXNzaW9uOiAodHlwZW9mIG1vZHVsZSAhPT0gJ3VuZGVmaW5lZCcgJiYgbW9kdWxlLmV4cG9ydHMpID8gZmFsc2UgOiB0cnVlLAogICAgICBnZW90cmlnZ2Vyc1VybDogZ2VvdHJpZ2dlcnNVcmwsCiAgICAgIHRva2VuVXJsOiB0b2tlblVybCwKICAgICAgcmVnaXN0ZXJEZXZpY2VVcmw6IHJlZ2lzdGVyRGV2aWNlVXJsLAogICAgICBhdXRvbWF0aWNSZWdpc3RhdGlvbjogdHJ1ZSwKICAgICAgcHJveHk6IGZhbHNlCiAgICB9OwoKICAgIC8vIHNldCBhcHBsaWNhdGlvbiBpZAogICAgaWYoIW9wdGlvbnMgfHwgIW9wdGlvbnMuY2xpZW50SWQpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJHZW90cmlnZ2VyLlNlc3Npb24gcmVxdWlyZXMgYW4gYGNsaWVudElkYCBvciBhIGBzZXNzaW9uYCBwYXJhbWV0ZXIuIik7CiAgICB9CgogICAgaWYoIW9wdGlvbnMucHJveHkgJiYgIUNPUlMpIHsKICAgICAgdGhyb3cgbmV3IEVycm9yKCJUaGlzIGJyb3dzZXIgZG9lcyBub3Qgc3VwcG9ydCBDT1JTIGFuZCBhIHByb3h5IGhhcyBub3QgYmVlbiBzZXQuIik7CiAgICB9CgogICAgLy8gbWVyZ2UgZGVmYXVsdHMgYW5kIG9wdGlvbnMgaW50byBgdGhpc2AKICAgIHV0aWwubWVyZ2UodGhpcywgdXRpbC5tZXJnZShkZWZhdWx0cywgb3B0aW9ucykpOwoKICAgIHRoaXMuYXV0aGVudGljYXRlZEFzID0gKHRoaXMuY2xpZW50SWQgJiYgdGhpcy5jbGllbnRTZWNyZXQpID8gImFwcGxpY2F0aW9uIiA6ICJkZXZpY2UiOwoKICAgIHRoaXMua2V5ID0gImdlb3RyaWdnZXJzXyIgKyB0aGlzLmF1dGhlbnRpY2F0ZWRBcyArICJfIiArIHRoaXMuY2xpZW50SWQ7CgogICAgLy9yZXN0b3JlIGEgc3RvcmVkIHNlc3Npb24gaWYgd2UgaGF2ZSBvbmUKICAgIGlmKHRoaXMucGVyc2lzdFNlc3Npb24pIHsKICAgICAgaWYodGhpcy5wcmVmZXJMb2NhbFN0b3JhZ2UgJiYgaGFzTG9jYWxTdG9yYWdlKXsKICAgICAgICB1dGlsLm1lcmdlKHRoaXMsIGxvY2FsU3RvcmFnZS5nZXQodGhpcy5rZXkpKTsKICAgICAgfSBlbHNlIGlmIChoYXNDb29raWVzKSB7CiAgICAgICAgdXRpbC5tZXJnZSh0aGlzLCBjb29raWUuZ2V0KHRoaXMua2V5KSk7CiAgICAgIH0KICAgIH0KCiAgICAvLyBpZiB0aGVyZSBpcyBhbiBhY2Nlc3MgdG9rZW4gYW5kIGl0IGlzIGFmdGVyIHdoZW4gdGhlIHRva2VuIGV4cGlyZXMgb3IgdGhlcmUgaXMgbm8gYWNjZXNzIHRva2VuCiAgICBpZigodGhpcy50b2tlbiAmJiAoRGF0ZS5ub3coKSA+IG5ldyBEYXRlKHRoaXMuZXhwaXJlc09uKS5nZXRUaW1lKCkpKSB8fCAhdGhpcy50b2tlbil7CiAgICAgIC8vIHJlbW92ZSB0b2tlbiB0byBwcmV2ZW50IHF1ZXVlZCBmdW5jdGlvbnMgZnJvbSBmaXJpbmcKICAgICAgZGVsZXRlIHRoaXMudG9rZW47CiAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgfQoKICAgIC8vIGlmIHRva2VuIGV4aXN0cywgaXMgbm90IGV4cGlyZWQsIGFuZCBzZXNzaW9uIGhhcyBiZWVuIHJlc3RvcmVkCiAgICBlbHNlIGlmICh0aGlzLnBlcnNpc3RTZXNzaW9uKSB7CiAgICAgIHRoaXMuZW1pdCgiYXV0aGVudGljYXRpb246cmVzdG9yZWQiKTsKICAgIH0KICB9CgogIFNlc3Npb24ucHJvdG90eXBlLmF1dGhlbnRpY2F0ZWQgPSBmdW5jdGlvbigpewogICAgcmV0dXJuICEhdGhpcy50b2tlbjsKICB9OwoKICBTZXNzaW9uLnByb3RvdHlwZS5yZWZyZXNoID0gZnVuY3Rpb24oKXsKICAgIGlmKHRoaXMucmVmcmVzaGluZyl7CiAgICAgIHJldHVybjsKICAgIH0KICAgIHRoaXMucmVmcmVzaGluZyA9IHRydWU7CiAgICB2YXIgdXJsID0gdGhpcy50b2tlblVybDsKICAgIHZhciBwYXJhbXMgPSB7CiAgICAgIGNsaWVudF9pZDogdGhpcy5jbGllbnRJZCwKICAgICAgZjogImpzb24iCiAgICB9OwoKICAgIGlmKHRoaXMuY2xpZW50U2VjcmV0KXsKICAgICAgcGFyYW1zLmNsaWVudF9zZWNyZXQgPSB0aGlzLmNsaWVudFNlY3JldDsKICAgICAgcGFyYW1zLmdyYW50X3R5cGUgPSAgImNsaWVudF9jcmVkZW50aWFscyI7CiAgICB9IGVsc2UgaWYgKHRoaXMucmVmcmVzaFRva2VuKXsKICAgICAgcGFyYW1zLnJlZnJlc2hfdG9rZW4gPSB0aGlzLnJlZnJlc2hUb2tlbjsKICAgICAgcGFyYW1zLmdyYW50X3R5cGUgPSAicmVmcmVzaF90b2tlbiI7CiAgICB9IGVsc2UgaWYgKHRoaXMuYXV0b21hdGljUmVnaXN0YXRpb24pIHsKICAgICAgdXJsID0gdGhpcy5yZWdpc3RlckRldmljZVVybDsKICAgIH0KCiAgICB0aGlzLnJlcXVlc3QodXJsLCBwYXJhbXMsIGZ1bmN0aW9uKGVycm9yLCByZXNwb25zZSwgeGhyKXsKICAgICAgdGhpcy5yZWZyZXNoaW5nID0gZmFsc2U7CgogICAgICBpZiAoZXJyb3IpIHsKICAgICAgICB0aGlzLmVtaXQoImF1dGhlbnRpY2F0aW9uOmVycm9yIiwgZXJyb3IsIHJlc3BvbnNlLCB4aHIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdGhpcy5leHBpcmVzT24gPSBuZXcgRGF0ZShuZXcgRGF0ZSgpLmdldFRpbWUoKSArICgocmVzcG9uc2UuZXhwaXJlc19pbi0oNjAqNSkpICoxMDAwKSk7CgogICAgICBpZihyZXNwb25zZS5kZXZpY2VUb2tlbil7CiAgICAgICAgdGhpcy5yZWZyZXNoVG9rZW4gPSByZXNwb25zZS5kZXZpY2VUb2tlbi5yZWZyZXNoX3Rva2VuOwogICAgICAgIHRoaXMudG9rZW4gPSByZXNwb25zZS5kZXZpY2VUb2tlbi5hY2Nlc3NfdG9rZW47CiAgICAgICAgdGhpcy5kZXZpY2VJZCA9IHJlc3BvbnNlLmRldmljZS5kZXZpY2VJZDsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLnRva2VuID0gcmVzcG9uc2UuYWNjZXNzX3Rva2VuOwogICAgICB9CgogICAgICBpZih0aGlzLnBlcnNpc3RTZXNzaW9uKXsKICAgICAgICB0aGlzLnBlcnNpc3QoKTsKICAgICAgfQoKICAgICAgd2hpbGUgKHRoaXMuX3F1ZXVlLmxlbmd0aCkgewogICAgICAgIHRoaXMuX3F1ZXVlLnNoaWZ0KCkuYXBwbHkodGhpcyk7CiAgICAgIH0KCiAgICAgIHRoaXMuZW1pdCgiYXV0aGVudGljYXRpb246c3VjY2VzcyIpOwoKICAgICAgd2hpbGUgKHRoaXMuX3JlcXVlc3RRdWV1ZS5sZW5ndGgpIHsKICAgICAgICB0aGlzLnJlcXVlc3QuYXBwbHkodGhpcywgdGhpcy5fcmVxdWVzdFF1ZXVlLnNoaWZ0KCkpOwogICAgICB9CiAgICB9LmJpbmQodGhpcykpOwogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLnRvSlNPTiA9IGZ1bmN0aW9uKCl7CiAgICB2YXIgb2JqID0ge307CiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcykgewogICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpICYmIHRoaXNba2V5XSAmJiAha2V5Lm1hdGNoKC9eXy4rLykpIHsKICAgICAgICBvYmpba2V5XSA9IHRoaXNba2V5XTsKICAgICAgfQogICAgfQogICAgcmV0dXJuIG9iajsKICB9OwoKICBTZXNzaW9uLnByb3RvdHlwZS5vbiA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKXsKICAgIHZhciB0eXBlcyA9IHR5cGUuc3BsaXQoJyAnKTsKCiAgICBmb3IgKHZhciBpPTA7IGkgPCB0eXBlcy5sZW5ndGg7IGkrKykgewogICAgICBpZiAodHlwZW9mIHRoaXMuX2V2ZW50c1t0eXBlc1tpXV0gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVzW2ldXSA9IFtdOwogICAgICB9CiAgICAgIHRoaXMuX2V2ZW50c1t0eXBlc1tpXV0ucHVzaChsaXN0ZW5lcik7CiAgICB9CiAgfTsKCiAgU2Vzc2lvbi5wcm90b3R5cGUuZW1pdCA9IGZ1bmN0aW9uKHR5cGUpewogICAgdmFyIGFyZ3MgPSBbXS5zcGxpY2UuY2FsbChhcmd1bWVudHMsMSk7CiAgICBpZiAodGhpcy5fZXZlbnRzW3R5cGVdIGluc3RhbmNlb2YgQXJyYXkpewogICAgICB2YXIgbGlzdGVuZXJzID0gdGhpcy5fZXZlbnRzW3R5cGVdOwogICAgICBmb3IgKHZhciBpPTAsIGxlbj1saXN0ZW5lcnMubGVuZ3RoOyBpIDwgbGVuOyBpKyspewogICAgICAgIGxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKICAgICAgfQogICAgfQogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLm9mZiA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKXsKICAgIGlmICh0aGlzLl9ldmVudHNbdHlwZV0gaW5zdGFuY2VvZiBBcnJheSl7CiAgICAgIHZhciBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CiAgICAgIGZvciAodmFyIGk9MCwgbGVuPWxpc3RlbmVycy5sZW5ndGg7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgaWYgKGxpc3RlbmVyc1tpXSA9PT0gbGlzdGVuZXIpewogICAgICAgICAgbGlzdGVuZXJzLnNwbGljZShpLCAxKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQogICAgfQogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLnF1ZXVlID0gZnVuY3Rpb24oZm4pIHsKICAgIGlmICghdGhpcy50b2tlbikgewogICAgICB0aGlzLl9xdWV1ZS5wdXNoKGZuKTsKICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICBmbi5hcHBseSh0aGlzKTsKICB9OwoKICBTZXNzaW9uLnByb3RvdHlwZS5yZXF1ZXN0ID0gZnVuY3Rpb24obWV0aG9kLCBwYXJhbXMsIGNhbGxiYWNrKXsKICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICB2YXIganNvbjsKICAgIHZhciBlcnJvcjsKICAgIHZhciByZXNwb25zZTsKICAgIHZhciBodHRwUmVxdWVzdDsKCiAgICAvLyBhc3N1bWUgdGhpcyBpcyBhIHJlcXVlc3QgdG8gZ2V0cmlnZ2VycyBpcyBpdCBkb2Vzbid0IHN0YXJ0IHdpdGggKGh0dHB8aHR0cHMpOi8vCiAgICB2YXIgZ2VvdHJpZ2dlcnNSZXF1ZXN0ID0gIW1ldGhvZC5tYXRjaCgvXmh0dHBzPzpcL1wvLyk7CgogICAgLy8gY3JlYXRlIHRoZSB1cmwgZm9yIHRoZSByZXF1ZXN0CiAgICB2YXIgdXJsID0gKGdlb3RyaWdnZXJzUmVxdWVzdCkgPyB0aGlzLmdlb3RyaWdnZXJzVXJsICsgbWV0aG9kIDogbWV0aG9kOwoKICAgIGlmICh0aGlzLnByb3h5KSB7CiAgICAgIHVybCA9IHRoaXMucHJveHkgKyB1cmw7CiAgICB9CgogICAgaWYodHlwZW9mIHBhcmFtcyA9PT0gImZ1bmN0aW9uIil7CiAgICAgIGNhbGxiYWNrID0gcGFyYW1zOwogICAgICBwYXJhbXMgPSB7fTsKICAgIH0KCiAgICBpZihnZW90cmlnZ2Vyc1JlcXVlc3QgJiYgIXRoaXMudG9rZW4pewogICAgICB0aGlzLl9yZXF1ZXN0UXVldWUucHVzaChhcmdzKTsKICAgICAgdGhpcy5yZWZyZXNoKCk7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICAvLyBjYWxsYmFjayBmb3IgaGFuZGxpbmcgYSBzdWNjZXNzZnVsIHJlcXVlc3QKICAgIHZhciBoYW5kbGVTdWNjZXNzZnVsUmVzcG9uc2UgPSBmdW5jdGlvbigpewoKICAgICAgdHJ5IHsKICAgICAgICBqc29uID0gSlNPTi5wYXJzZShodHRwUmVxdWVzdC5yZXNwb25zZVRleHQpOwogICAgICAgIHJlc3BvbnNlID0gKGpzb24uZXJyb3IpID8gbnVsbCA6IGpzb247CiAgICAgICAgZXJyb3IgPSAoanNvbi5lcnJvcikgPyBqc29uLmVycm9yIDogbnVsbDsKICAgICAgfSBjYXRjaCAoZSl7CiAgICAgICAgcmVzcG9uc2UgPSBudWxsOwogICAgICAgIGVycm9yID0gewogICAgICAgICAgdHlwZTogInBhcnNlX2Vycm9yIiwKICAgICAgICAgIG1lc3NhZ2U6ICJjb3VuZCBub3QgcGFyc2UgcmVzcG9uc2UgYXMgSlNPTiIKICAgICAgICB9OwogICAgICB9CgogICAgICAvLyBkaWQgb3VyIHRva2VuIGV4cGlyZT8KICAgICAgLy8gaWYgaXQgZGlkbid0IHJlc29sdmUgb3IgcmVqZWN0IHRoZSBjYWxsYmFjawogICAgICAvLyBpZiBpdCBkaWQgcmVmcmVzaCB0aGUgYXV0aCBhbmQgcnVuIHRoZSByZXF1ZXN0IGFnYWluCiAgICAgIGlmKGVycm9yICYmIGVycm9yLnR5cGUgPT09ICJpbnZhbGlkSGVhZGVyIiAmJiBlcnJvci5oZWFkZXJzLkF1dGhvcml6YXRpb24pewogICAgICAgIHRoaXMuX3JlcXVlc3RRdWV1ZS5wdXNoKGFyZ3MpOwogICAgICAgIHRoaXMucmVmcmVzaCgpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmICghZXJyb3IpewogICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzcG9uc2UsIGh0dHBSZXF1ZXN0KTsKICAgICAgICB9IGVsc2UgaWYgKGVycm9yKXsKICAgICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsLCBodHRwUmVxdWVzdCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBlcnJvck1lc3NhZ2UgPSB7CiAgICAgICAgICAgIHR5cGU6ICJ1bmV4cGVjdGVkX3Jlc3BvbnNlIiwKICAgICAgICAgICAgbWVzc2FnZTogInRoZSBhcGkgcmV0dXJuZWQgYSBub24gSlNPTiBvciB1bmV4cGVjdGVkIGRhdGEiCiAgICAgICAgICB9OwogICAgICAgICAgY2FsbGJhY2soZXJyb3JNZXNzYWdlLCBudWxsLCBodHRwUmVxdWVzdCk7CiAgICAgICAgfQogICAgICB9CiAgICB9LmJpbmQodGhpcyk7CgogICAgLy8gY2FsbGJhY2sgZm9yIGhhbmRsaW5nIGFuIGh0dHAgZXJyb3IKICAgIHZhciBoYW5kbGVFcnJvclJlc3BvbnNlID0gZnVuY3Rpb24oKXsKICAgICAgdmFyIGVycm9yID0gewogICAgICAgIHR5cGU6ICJodHRwX2Vycm9yIgogICAgICB9OwoKICAgICAgdHJ5IHsKICAgICAgICBlcnJvci5tZXNzYWdlID0gSlNPTi5wYXJzZShodHRwUmVxdWVzdC5yZXNwb25zZVRleHQpOwogICAgICB9IGNhdGNoIChlKXsKICAgICAgICBlcnJvci5tZXNzYWdlID0gImh0dHAgZXJyb3IgYW5kIGNvdW5kIG5vdCBwYXJzZSByZXNwb25zZSBhcyBKU09OIjsKICAgICAgfQoKICAgICAgY2FsbGJhY2soZXJyb3IsIG51bGwsIGh0dHBSZXF1ZXN0KTsKICAgIH0uYmluZCh0aGlzKTsKCiAgICAvLyBjYWxsYmFjayBmb3IgaGFuZGxpbmcgc3RhdGUgY2hhbmdlCiAgICB2YXIgaGFuZGxlU3RhdGVDaGFuZ2UgPSBmdW5jdGlvbigpewogICAgICBpZihodHRwUmVxdWVzdC5yZWFkeVN0YXRlID09PSA0ICYmIGh0dHBSZXF1ZXN0LnN0YXR1cyA8IDQwMCl7CiAgICAgICAgaGFuZGxlU3VjY2Vzc2Z1bFJlc3BvbnNlKCk7CiAgICAgIH0gZWxzZSBpZihodHRwUmVxdWVzdC5yZWFkeVN0YXRlID09PSA0ICYmIGh0dHBSZXF1ZXN0LnN0YXR1cyA+PSA0MDApIHsKICAgICAgICBoYW5kbGVFcnJvclJlc3BvbnNlKCk7CiAgICAgIH0KICAgIH0uYmluZCh0aGlzKTsKCiAgICBodHRwUmVxdWVzdCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpOwogICAgaHR0cFJlcXVlc3Qub25yZWFkeXN0YXRlY2hhbmdlID0gaGFuZGxlU3RhdGVDaGFuZ2U7CgogICAgdmFyIGJvZHk7CgogICAgLy8gc2V0IHRoZSBhY2Nlc3MgdG9rZW4gaW4gdGhlIGJvZHkKICAgIGlmKGdlb3RyaWdnZXJzUmVxdWVzdCl7CiAgICAgIHBhcmFtcy50b2tlbiA9IHRoaXMudG9rZW47CiAgICAgIGJvZHkgPSBKU09OLnN0cmluZ2lmeShwYXJhbXMpOwogICAgfSBlbHNlIHsKICAgICAgYm9keSA9IHV0aWwuc2VyaWFsaXplKHBhcmFtcyk7CiAgICB9CgogICAgaHR0cFJlcXVlc3Qub3BlbigiUE9TVCIsIHVybCk7CiAgICBodHRwUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdDb250ZW50LVR5cGUnLCAoZ2VvdHJpZ2dlcnNSZXF1ZXN0KSA/ICdhcHBsaWNhdGlvbi9qc29uJyA6ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnKTsKCiAgICBpZihnZW90cmlnZ2Vyc1JlcXVlc3QpewogICAgICBodHRwUmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKCdYLUdULUNsaWVudC1OYW1lJywgJ2dlb3RyaWdnZXItanMnKTsKICAgICAgaHR0cFJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcignWC1HVC1DbGllbnQtVmVyc2lvbicsICcxLjAuMCcpOwogICAgfQoKICAgIGh0dHBSZXF1ZXN0LnNlbmQoYm9keSk7CgogIH07CgogIFNlc3Npb24ucHJvdG90eXBlLnBlcnNpc3QgPSBmdW5jdGlvbigpIHsKICAgIHZhciB2YWx1ZSA9IHt9OwogICAgaWYodGhpcy5jbGllbnRJZCl7IHZhbHVlLmNsaWVudElkID0gdGhpcy5jbGllbnRJZDsgfQogICAgaWYodGhpcy5jbGllbnRTZWNyZXQpeyB2YWx1ZS5jbGllbnRTZWNyZXQgPSB0aGlzLmNsaWVudFNlY3JldDsgfQogICAgaWYodGhpcy50b2tlbil7IHZhbHVlLnRva2VuID0gdGhpcy50b2tlbjsgfQogICAgaWYodGhpcy5yZWZyZXNoVG9rZW4peyB2YWx1ZS5yZWZyZXNoVG9rZW4gPSB0aGlzLnJlZnJlc2hUb2tlbjsgfQogICAgaWYodGhpcy5kZXZpY2VJZCl7IHZhbHVlLmRldmljZUlkID0gdGhpcy5kZXZpY2VJZDsgfQogICAgaWYodGhpcy5wcmVmZXJMb2NhbFN0b3JhZ2UgJiYgaGFzTG9jYWxTdG9yYWdlKXsKICAgICAgbG9jYWxTdG9yYWdlLnNldCh0aGlzLmtleSwgdmFsdWUpOwogICAgfSBlbHNlIGlmIChoYXNDb29raWVzKSB7CiAgICAgIGNvb2tpZS5zZXQodGhpcy5rZXksIHZhbHVlKTsKICAgIH0KICB9OwoKICBTZXNzaW9uLnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24oKSB7CiAgICBpZih0aGlzLnByZWZlckxvY2FsU3RvcmFnZSAmJiBoYXNMb2NhbFN0b3JhZ2UpIHsKICAgICAgbG9jYWxTdG9yYWdlLmVyYXNlKHRoaXMua2V5KTsKICAgIH0gZWxzZSBpZiAoaGFzQ29va2llcykgewogICAgICBjb29raWUuZXJhc2UodGhpcy5rZXkpOwogICAgfQogIH07CgogIGV4cG9ydHMuU2Vzc2lvbiA9IFNlc3Npb247CgogIC8qCiAgR2VuZXJhbCBQdXJwb3NlIFV0aWxpdGllcwogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgdmFyIHV0aWwgPSB7CiAgICAvLyBNZXJnZSBPYmplY3QgMSBhbmQgT2JqZWN0IDIuCiAgICAvLyBQcm9wZXJ0aWVzIGZyb20gT2JqZWN0IDIgd2lsbCBvdmVycmlkZSBwcm9wZXJ0aWVzIGluIE9iamVjdCAxLgogICAgLy8gUmV0dXJucyBPYmplY3QgMQogICAgbWVyZ2U6IGZ1bmN0aW9uKHRhcmdldCwgb2JqKXsKICAgICAgZm9yICh2YXIgYXR0ciBpbiBvYmopIHsKICAgICAgICBpZihvYmouaGFzT3duUHJvcGVydHkoYXR0cikpewogICAgICAgICAgdGFyZ2V0W2F0dHJdID0gb2JqW2F0dHJdOwogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gdGFyZ2V0OwogICAgfSwKCiAgICBpc09iamVjdDogZnVuY3Rpb24odGhpbmcpewogICAgICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHRoaW5nKSA9PT0gJ1tvYmplY3QgT2JqZWN0XSc7CiAgICB9LAoKICAgIHNlcmlhbGl6ZTogZnVuY3Rpb24ob2JqLCBwcmVmaXgpIHsKCiAgICAgIHZhciBlbmMgPSBlbmNvZGVVUklDb21wb25lbnQ7CgogICAgICAvLyBtYWtlIGFuIGFycmF5IHRvIGhvbGQgZWFjaCBwZWljZQogICAgICB2YXIgc3RyID0gW107CgogICAgICAvLyBmb3IgZXZlcnkga2V5IGluIG91ciBvYmplY3QKICAgICAgZm9yKHZhciBwIGluIG9iaikgewogICAgICAgIGlmKG9iai5oYXNPd25Qcm9wZXJ0eShwKSl7CiAgICAgICAgICB2YXIgZTsKICAgICAgICAgIHZhciBrID0gKHByZWZpeCkgPyBwcmVmaXggKyAiWyIgKyBwICsgIl0iIDogcCwgdiA9IG9ialtwXTsKICAgICAgICAgIGUgPSAodXRpbC5pc09iamVjdCh2KSkgPyB1dGlsLnNlcmlhbGl6ZSh2LCBrKSA6IGVuYyhrKSArICI9IiArIGVuYyh2KTsKICAgICAgICAgIHN0ci5wdXNoKGUpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgLy8gam9pbiB3aXRoIGFtcGVyc2FuZHMKICAgICAgcmV0dXJuIHN0ci5qb2luKCImIik7CiAgICB9CiAgfTsKCiAgLyoKICBVdGlsaXRpZXMgZm9yIG1hbmlwdWxhdGluZyBzZXNzaW9ucwogIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgKi8KCiAgdmFyIGhhc0xvY2FsU3RvcmFnZSA9ICh0eXBlb2Ygd2luZG93ID09PSAib2JqZWN0IiAmJiB0eXBlb2Ygd2luZG93LmxvY2FsU3RvcmFnZSA9PT0gIm9iamVjdCIpID8gdHJ1ZSA6IGZhbHNlOwogIHZhciBoYXNDb29raWVzID0gKHR5cGVvZiBkb2N1bWVudCA9PT0gIm9iamVjdCIgJiYgdHlwZW9mIGRvY3VtZW50LmNvb2tpZSA9PT0gInN0cmluZyIpID8gdHJ1ZSA6IGZhbHNlOwoKICB2YXIgbG9jYWxTdG9yYWdlID0gewogICAgc2V0OmZ1bmN0aW9uKGtleSwgdmFsdWUpewogICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oa2V5LCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOwogICAgfSwKICAgIGdldDogZnVuY3Rpb24oa2V5KXsKICAgICAgcmV0dXJuIEpTT04ucGFyc2Uod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKGtleSkpOwogICAgfSwKICAgIGVyYXNlOiBmdW5jdGlvbihrZXkpewogICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oa2V5KTsKICAgIH0KICB9OwoKICB2YXIgY29va2llID0gewogICAgZ2V0OiBmdW5jdGlvbihrZXkpIHsKICAgICAgLy8gU3RpbGwgbm90IHN1cmUgdGhhdCAiW2EtekEtWjAtOS4oKT18JS9fXSsoJHw7KSIgbWF0Y2ggKmFsbCogYWxsb3dlZCBjaGFyYWN0ZXJzIGluIGNvb2tpZXMKICAgICAgdmFyIHRtcCA9ICBkb2N1bWVudC5jb29raWUubWF0Y2goKG5ldyBSZWdFeHAoa2V5ICsnPVthLXpBLVowLTkuKCk9fCUvX10rKCR8OyknLCdnJykpKTsKICAgICAgaWYoIXRtcCB8fCAhdG1wWzBdKXsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh0bXBbMF0uc3Vic3RyaW5nKGtleS5sZW5ndGgrMSx0bXBbMF0ubGVuZ3RoKS5yZXBsYWNlKCc7JywnJykpIHx8IG51bGw7CiAgICAgIH0KICAgIH0sCgogICAgc2V0OiBmdW5jdGlvbihrZXksIHZhbHVlLCBzZWN1cmUpIHsKICAgICAgdmFyIGNvb2tpZSA9IFsKICAgICAgICBrZXkrJz0nK0pTT04uc3RyaW5naWZ5KHZhbHVlKSwKICAgICAgICAncGF0aD0vJywKICAgICAgICAnZG9tYWluPScrd2luZG93LmxvY2F0aW9uLmhvc3QKICAgICAgXTsKCiAgICAgIHZhciBleHBpcmF0aW9uX2RhdGUgPSBuZXcgRGF0ZSgpOwogICAgICBleHBpcmF0aW9uX2RhdGUuc2V0RnVsbFllYXIoZXhwaXJhdGlvbl9kYXRlLmdldEZ1bGxZZWFyKCkgKyAxKTsKICAgICAgY29va2llLnB1c2goZXhwaXJhdGlvbl9kYXRlLnRvR01UU3RyaW5nKCkpOwoKICAgICAgaWYgKHNlY3VyZSl7CiAgICAgICAgY29va2llLnB1c2goJ3NlY3VyZScpOwogICAgICB9CiAgICAgIHJldHVybiBkb2N1bWVudC5jb29raWUgPSBjb29raWUuam9pbignOyAnKTsKICAgIH0sCgogICAgZXJhc2U6IGZ1bmN0aW9uKGtleSkgewogICAgICBkb2N1bWVudC5jb29raWUgPSBrZXkgKyAiOyAiICsgbmV3IERhdGUoMCkudG9VVENTdHJpbmcoKTsKICAgIH0KICB9OwoKICByZXR1cm4gZXhwb3J0czsKfSkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 02:16:39 GMT",
                    "Content-Length": "12644",
                    "Date": "Fri, 07 Nov 2014 02:16:39 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}