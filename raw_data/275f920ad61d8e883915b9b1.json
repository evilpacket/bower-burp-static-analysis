{
    "url": "http://localhost:9999/CloudKidStudio/CloudKidFramework/dist/core.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var nameEQ = name + \"=\",     ca = document.cookie.split(';'),     i = 0, c;</li><li>c = ca[i];</li><li>c = c.substring(1,c.length);</li><li>return JSON.parse(unescape(c.substring(nameEQ.length,c.length)));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/CloudKidStudio/CloudKidFramework/dist/core.js",
                "path": "/CloudKidStudio/CloudKidFramework/dist/core.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9DbG91ZEtpZFN0dWRpby9DbG91ZEtpZEZyYW1ld29yay9kaXN0L2NvcmUuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogODQ2NjMNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFRodSwgMDYgTm92IDIwMTQgMTU6Mzk6MjAgR01UDQpMYXN0LU1vZGlmaWVkOiBUaHUsIDA2IE5vdiAyMDE0IDE1OjM5OjE2IEdNVA0KDQovKiEgU3ByaW5nUm9sbCAwLjAuNiAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7LyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiovCi8qKgoqICBTdGF0aWMgY2xhc3MgZm9yIG5hbWVzcGFjaW5nIG9iamVjdHMgYW5kIGFkZGluZwoqICBjbGFzc2VzIHRvIGl0LgoqICBAY2xhc3MgbmFtZXNwYWNlCiogIEBzdGF0aWMKKi8KKGZ1bmN0aW9uKHdpbmRvdyl7CgkKCS8vIFRoZSBuYW1lc3BhY2UgZnVuY3Rpb24gYWxyZWFkeSBleGlzdHMKCWlmICgibmFtZXNwYWNlIiBpbiB3aW5kb3cpIHJldHVybjsKCQoJLyoqCgkqICBDcmVhdGUgdGhlIG5hbWVzcGFjZSBhbmQgYXNzaW5nIHRvIHRoZSB3aW5kb3cKCSoKCSogIEBleGFtcGxlCgkJdmFyIFNwcml0ZVV0aWxzID0gZnVuY3Rpb24oKXt9OwoJCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLlNwcml0ZVV0aWxzID0gU3ByaXRlVXRpbHM7CgkqCgkqICBAY29uc3RydWN0b3IKCSogIEBtZXRob2QgbmFtZXNwYWNlCgkqICBAcGFyYW0ge3N0cmluZ30gbmFtZXNwYWNlU3RyaW5nIE5hbWUgc3BhY2UsIGZvciBpbnN0YW5jZSAnc3ByaW5ncm9sbC51dGlscycKCSogIEByZXR1cm4ge29iamVjdH0gVGhlIG5hbWVzcGFjZSBvYmplY3QgYXR0YWNoZWQgdG8gdGhlIGN1cnJlbnQgd2luZG93CgkqLwoJdmFyIG5hbWVzcGFjZSA9IGZ1bmN0aW9uKG5hbWVzcGFjZVN0cmluZykgewoJCXZhciBwYXJ0cyA9IG5hbWVzcGFjZVN0cmluZy5zcGxpdCgnLicpLAoJCQlwYXJlbnQgPSB3aW5kb3csCgkJCWN1cnJlbnRQYXJ0ID0gJyc7CgoJCWZvcih2YXIgaSA9IDAsIGxlbmd0aCA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKQoJCXsKCQkJY3VycmVudFBhcnQgPSBwYXJ0c1tpXTsKCQkJcGFyZW50W2N1cnJlbnRQYXJ0XSA9IHBhcmVudFtjdXJyZW50UGFydF0gfHwge307CgkJCXBhcmVudCA9IHBhcmVudFtjdXJyZW50UGFydF07CgkJfQoJCXJldHVybiBwYXJlbnQ7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIHdpbmRvdyBuYW1lc3BhY2UKCXdpbmRvdy5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7CgkKfSh3aW5kb3cpKTsKCgovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKi8KLyoqCiogIFVzZWQgdG8gaW5jbHVkZSByZXF1aXJlZCBjbGFzc2VzIGJ5IG5hbWUKKiAgQGNsYXNzIGluY2x1ZGUKKiAgQHN0YXRpYwoqLwooZnVuY3Rpb24od2luZG93LCB1bmRlZmluZWQpewoJCgkvLyBUaGUgaW5jbHVkZSBmdW5jdGlvbiBhbHJlYWR5IGV4aXN0cwoJaWYgKCJpbmNsdWRlIiBpbiB3aW5kb3cpIHJldHVybjsKCQoJLyoqCgkqICBJbXBvcnQgYSBjbGFzcwoJKgoJKiAgQGV4YW1wbGUKCQl2YXIgQXBwbGljYXRpb24gPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkFwcGxpY2F0aW9uJyk7CgkqCgkqICBAY29uc3RydWN0b3IKCSogIEBtZXRob2QgaW5jbHVkZQoJKiAgQHBhcmFtIHtzdHJpbmd9IG5hbWVzcGFjZVN0cmluZyBOYW1lIHNwYWNlLCBmb3IgaW5zdGFuY2UgJ3NwcmluZ3JvbGwuQXBwbGljYXRpb24nCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtyZXF1aXJlZD10cnVlXSBJZiB0aGUgY2xhc3Mgd2UncmUgdHJ5aW5nIHRvIGluY2x1ZGUgaXMgcmVxdWlyZWQuCgkqIAkJRm9yIGNsYXNzZXMgdGhhdCBhcmVuJ3QgZm91bmQgYW5kIGFyZSByZXF1aXJlZCwgYW4gZXJyb3IgaXMgdGhyb3duLgoJKiAgQHJldHVybiB7b2JqZWN0fGZ1bmN0aW9ufSBUaGUgb2JqZWN0IGF0dGFjaGVkIGF0IHRoZSBnaXZlbiBuYW1lc3BhY2UKCSovCgl2YXIgaW5jbHVkZSA9IGZ1bmN0aW9uKG5hbWVzcGFjZVN0cmluZywgcmVxdWlyZWQpCgl7CgkJdmFyIHBhcnRzID0gbmFtZXNwYWNlU3RyaW5nLnNwbGl0KCcuJyksCgkJCXBhcmVudCA9IHdpbmRvdywKCQkJY3VycmVudFBhcnQgPSAnJzsKCQkKCQlyZXF1aXJlZCA9IHJlcXVpcmVkICE9PSB1bmRlZmluZWQgPyAhIXJlcXVpcmVkIDogdHJ1ZTsKCgkJZm9yKHZhciBpID0gMCwgbGVuZ3RoID0gcGFydHMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspCgkJewoJCQljdXJyZW50UGFydCA9IHBhcnRzW2ldOwoJCQlpZiAoIXBhcmVudFtjdXJyZW50UGFydF0pCgkJCXsKCQkJCWlmICghcmVxdWlyZWQpCgkJCQl7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgkJCQlpZiAodHJ1ZSkKCQkJCXsKCQkJCQl0aHJvdyAiVW5hYmxlIHRvIGluY2x1ZGUgJyIgKyBuYW1lc3BhY2VTdHJpbmcgKyAiJyBiZWNhdXNlIHRoZSBjb2RlIGlzIG5vdCBpbmNsdWRlZCBvciB0aGUgY2xhc3MgbmVlZHMgdG8gbG9hZGVkIHNvb25lci4iOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRocm93ICJVbmFibGUgdG8gaW5jbHVkZSAnIiArIG5hbWVzcGFjZVN0cmluZyArICInIjsKCQkJCX0KCQkJfQoJCQlwYXJlbnQgPSBwYXJlbnRbY3VycmVudFBhcnRdOwoJCX0KCQlyZXR1cm4gcGFyZW50OwoJfTsKCQoJLy8gQXNzaWduIHRvIHRoZSB3aW5kb3cgbmFtZXNwYWNlCgl3aW5kb3cuaW5jbHVkZSA9IGluY2x1ZGU7CgkKfSh3aW5kb3cpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiovCihmdW5jdGlvbihPYmplY3QsIHVuZGVmaW5lZCl7CgoJLyoqCgkqICBBZGQgbWV0aG9kcyB0byBPYmplY3QKCSogIEBjbGFzcyBPYmplY3QKCSovCgoJLyoqCgkqICBNZXJnZXMgdHdvIChvciBtb3JlKSBvYmplY3RzLCBnaXZpbmcgdGhlIGxhc3Qgb25lIHByZWNlZGVuY2UKCSogIEBtZXRob2QgbWVyZ2UKCSogIEBleGFtcGxlCgkJdmFyIG9iajEgPSB7IGlkIDogJ2ZvbycsIG5hbWUgOiAnSGVsbG8hJywgdmFsdWUgOiAxMDAgfTsKCQl2YXIgb2JqMiA9IHsgaWQgOiAnYmFyJywgdmFsdWUgOiAyMDAgfTsKCQlPYmplY3QubWVyZ2Uoe30sIG9iajEsIG9iajIpOyAvLyBSZXR1cm5zOiB7IGlkIDogJ2JhcicsIG5hbWUgOiAnSGVsbG8hJywgdmFsdWUgOiAyMDAgfQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtvYmplY3R9IHRhcmdldCBUaGUgdGFyZ2V0IG9iamVjdAoJKiAgQHBhcmFtIHtvYmplY3R9IHNvdXJjZSogQWRkaXRpb25hbCBvYmplY3RzIHRvIGFkZAoJKi8KCU9iamVjdC5tZXJnZSA9IGZ1bmN0aW9uKHRhcmdldCwgc291cmNlKQoJewkJCgkJaWYgKHR5cGVvZiB0YXJnZXQgIT09ICdvYmplY3QnKSAKCQl7CgkJCXRhcmdldCA9IHt9OwoJCX0KCQkKCQlmb3IgKHZhciBwcm9wZXJ0eSBpbiBzb3VyY2UpCgkJewoJCQlpZiAoc291cmNlLmhhc093blByb3BlcnR5KHByb3BlcnR5KSkKCQkJewoJCQkJdmFyIHNvdXJjZVByb3BlcnR5ID0gc291cmNlW3Byb3BlcnR5XTsKCQkJCQoJCQkJaWYgKHR5cGVvZiBzb3VyY2VQcm9wZXJ0eSA9PT0gJ29iamVjdCcgJiYgT2JqZWN0LmlzUGxhaW4oc291cmNlUHJvcGVydHkpKQoJCQkJewoJCQkJCXRhcmdldFtwcm9wZXJ0eV0gPSBPYmplY3QubWVyZ2UodGFyZ2V0W3Byb3BlcnR5XSwgc291cmNlUHJvcGVydHkpOwoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJdGFyZ2V0W3Byb3BlcnR5XSA9IHNvdXJjZVByb3BlcnR5OwoJCQl9CgkJfQoJCQoJCWZvciAodmFyIGkgPSAyLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKykKCQl7CgkJCU9iamVjdC5tZXJnZSh0YXJnZXQsIGFyZ3VtZW50c1tpXSk7CgkJfQoJCXJldHVybiB0YXJnZXQ7Cgl9OwoKCS8qKgoJKiAgQ2hlY2sgdG8gc2VlIGlmIGFuIG9iamVjdCBpcyBhIHBsYWluIG9iamVjdCBkZWZpbml0aW9uCgkqICBAbWV0aG9kIGlzUGxhaW4KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7b2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvYmplY3QKCSogIEByZXR1cm4ge2Jvb2xlYW59IElmIHRoZSBvYmplY3QgaXMgcGxhaW4KCSovCglPYmplY3QuaXNQbGFpbiA9IGZ1bmN0aW9uKG9iaikKCXsKCQl2YXIga2V5OwoKCQkvLyBNdXN0IGJlIGFuIE9iamVjdC4KCQkvLyBCZWNhdXNlIG9mIElFLCB3ZSBhbHNvIGhhdmUgdG8gY2hlY2sgdGhlIHByZXNlbmNlIG9mIHRoZSBjb25zdHJ1Y3RvciBwcm9wZXJ0eS4KCQkvLyBNYWtlIHN1cmUgdGhhdCBET00gbm9kZXMgYW5kIHdpbmRvdyBvYmplY3RzIGRvbid0IHBhc3MgdGhyb3VnaCwgYXMgd2VsbAoJCWlmICghb2JqIHx8IHR5cGVvZiBvYmogIT09ICJvYmplY3QiIHx8IG9iai5ub2RlVHlwZSB8fCBvYmogPT09IHdpbmRvdykKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCXRyeSB7CgkJCS8vIE5vdCBvd24gY29uc3RydWN0b3IgcHJvcGVydHkgbXVzdCBiZSBPYmplY3QKCQkJaWYgKCBvYmouY29uc3RydWN0b3IgJiYKCQkJCSFoYXNPd24uY2FsbChvYmosICJjb25zdHJ1Y3RvciIpICYmCgkJCQkhaGFzT3duLmNhbGwob2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZSwgImlzUHJvdG90eXBlT2YiKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0gCgkJY2F0Y2ggKGUpIAoJCXsKCQkJLy8gSUU4LDkgV2lsbCB0aHJvdyBleGNlcHRpb25zIG9uIGNlcnRhaW4gaG9zdCBvYmplY3RzICM5ODk3CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCS8vIFN1cHBvcnQ6IElFPDkKCQkvLyBIYW5kbGUgaXRlcmF0aW9uIG92ZXIgaW5oZXJpdGVkIHByb3BlcnRpZXMgYmVmb3JlIG93biBwcm9wZXJ0aWVzLgoJCWlmIChzdXBwb3J0Lm93bkxhc3QpCgkJewoJCQlmb3IgKGtleSBpbiBvYmopCgkJCXsKCQkJCXJldHVybiBoYXNPd24uY2FsbChvYmosIGtleSk7CgkJCX0KCQl9CgoJCS8vIE93biBwcm9wZXJ0aWVzIGFyZSBlbnVtZXJhdGVkIGZpcnN0bHksIHNvIHRvIHNwZWVkIHVwLAoJCS8vIGlmIGxhc3Qgb25lIGlzIG93biwgdGhlbiBhbGwgcHJvcGVydGllcyBhcmUgb3duLgoJCWZvciAoa2V5IGluIG9iaikge30KCgkJcmV0dXJuIGtleSA9PT0gdW5kZWZpbmVkIHx8IGhhc093bi5jYWxsKG9iaiwga2V5KTsKCX07Cgp9KE9iamVjdCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKi8KKGZ1bmN0aW9uKHdpbmRvdywgdW5kZWZpbmVkKXsKCQoJLyoqCgkqICBBIHN0YXRpYyBjbG9zdXJlIHRvIHByb3ZpZGUgZWFzeSBhY2Nlc3MgdG8gdGhlIGNvbnNvbGUKCSogIHdpdGhvdXQgaGF2aW5nIGVycm9ycyBpZiB0aGUgY29uc29sZSBkb2Vzbid0IGV4aXN0CgkqICB0byB1c2UgY2FsbDogRGVidWcubG9nKCdZb3VyIGxvZyBoZXJlJykKCSoKCSogIEBjbGFzcyBEZWJ1ZwoJKiAgQHN0YXRpYwoJKi8KCXZhciBEZWJ1ZyA9IGZ1bmN0aW9uKCl7fTsKCQoJLyoqCgkqICBJZiB3ZSBoYXZlIGEgY29uc29sZQoJKgoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Ym9vbH0gaGFzQ29uc29sZQoJKi8KCXZhciBoYXNDb25zb2xlID0gKHdpbmRvdy5jb25zb2xlICE9PSB1bmRlZmluZWQpOwoJCgkvKioKCSogVGhlIG1vc3QgZ2VuZXJhbCBkZWZhdWx0IGRlYnVnIGxldmVsCgkqIEBzdGF0aWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBHRU5FUkFMCgkqLwoJRGVidWcuR0VORVJBTCA9IDA7CgkKCS8qKgoJKiBMb2cgbGV2ZWwgZm9yIGRlYnVnIG1lc3NhZ2VzCgkqIEBzdGF0aWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSB0cnVlCgkqLwoJRGVidWdbJ0RFJysnQlVHJ10gPSAxOyAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCQoJLyoqCgkqIExvZyBsZXZlbCBmb3IgZGVidWcgbWVzc2FnZXMKCSogQHN0YXRpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IElORk8KCSovCglEZWJ1Zy5JTkZPID0gMjsKCQoJLyoqCgkqIExvZyBsZXZlbCBmb3Igd2FybmluZyBtZXNzYWdlcwoJKiBAc3RhdGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gV0FSTgoJKi8KCURlYnVnLldBUk4gPSAzOwoJCgkvKioKCSogTG9nIGxldmVsIGZvciBlcnJvciBtZXNzYWdlcwoJKiBAc3RhdGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gRVJST1IKCSovCglEZWJ1Zy5FUlJPUiA9IDQ7CgkKCS8qKgoJKiBUaGUgbWluaW11bSBsb2cgbGV2ZWwgdG8gc2hvdywgYnkgZGVmYXVsdCBpdCdzIHNldCB0bwoJKiBzaG93IGFsbCBsZXZlbHMgb2YgbG9nZ2luZy4KCSogQHB1YmxpYwoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7aW50fSBtaW5Mb2dMZXZlbAoJKi8KCURlYnVnLm1pbkxvZ0xldmVsID0gRGVidWcuR0VORVJBTDsKCQoJLyoqCgkqIEJvb2xlYW4gdG8gdHVybiBvbiBvciBvZmYgdGhlIGRlYnVnZ2luZwoJKiBAcHVibGljCgkqIEBzdGF0aWMKCSogQHByb3BlcnR5IHtib29sfSBlbmFibGVkCgkqLwoJRGVidWcuZW5hYmxlZCA9IHRydWU7CgkKCS8qKgoJKiAgVGhlIGpRdWVyeSBlbGVtZW50IHRvIG91dHB1dCBkZWJ1ZyBtZXNzYWdlcyB0bwoJKgoJKiAgQHB1YmxpYwoJKiAgQHN0YXRpYwoJKiAgQHByb3BlcnR5IHtqUXVlcnl9IG91dHB1dAoJKi8KCURlYnVnLm91dHB1dCA9IG51bGw7CgoJLyoqCgkqCUlmIHRoZSBjb25zb2xlIGlzIGN1cnJlbnRseSBjb25uZWN0ZWQgd2l0aCBKU0NvbnNvbGUgKGpzY29uc29sZS5jb20pLgoJKglAcHJpdmF0ZQoJKglAc3RhdGljCgkqCUBwcm9wZXJ0eSB7Ym9vbH0gX2lzSlNDb25zb2xlCgkqLwoJRGVidWcuX2lzSlNDb25zb2xlID0gd2luZG93LnJlbW90ZSA9PT0gd2luZG93LmNvbnNvbGU7Ly9UaGUgSlNDb25zb2xlIHNjcmlwdCBzZXRzIG9uZSBvYmplY3QgYXMgJ3JlbW90ZScgYW5kIHRyeXMgdG8gb3ZlcndyaXRlICdjb25zb2xlJwoJCgkvKioKCSogQnJvd3NlciBwb3J0IGZvciB0aGUgd2Vic29ja2V0IGJyb3dzZXJzIHRlbmQgdG8gYmxvY2sgcG9ydHMKCSogIEBzdGF0aWMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gX05FVF9QT1JUCgkqICBAZGVmYXVsdCAxMDI1CgkqLwoJRGVidWcuX05FVF9QT1JUID0gMTAyNTsKCQoJLyoqCgkqIElmIHRoZSB3ZWIgc29ja2V0IGlzIGNvbm5lY3RlZAoJKiBAc3RhdGljCgkqIEBwcml2YXRlCgkqIEBkZWZhdWx0IGZhbHNlCgkqIEBwcm9wZXJ0eSB7Ym9vbH0gX2lzQ29ubmVjdGVkCgkqLwoJRGVidWcuX2lzQ29ubmVjdGVkID0gZmFsc2U7CgkKCS8qKgoJKiBUaGUgc29ja2V0IGNvbm5lY3Rpb24KCSogQHN0YXRpYwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge1dlYlNvY2tldH0gX3NvY2tldAoJKi8KCURlYnVnLl9zb2NrZXQgPSBudWxsOwoJCgkvKioKCSogVGhlIGN1cnJlbnQgbWVzc2FnZSBvYmplY3QgYmVpbmcgc2VudCB0byB0aGUgYFdlYlNvY2tldGAKCSogQHN0YXRpYwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge29iamVjdH0gX21lc3NhZ2VPYmoKCSovCglEZWJ1Zy5fbWVzc2FnZU9iaiA9IG51bGw7CgkKCS8qKgoJKiBUaGUgYFdlYlNvY2tldGAgbWVzc2FnZSBxdWV1ZQoJKiBAc3RhdGljCgkqIEBwcml2YXRlCgkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9tZXNzYWdlUXVldWUKCSovCglEZWJ1Zy5fbWVzc2FnZVF1ZXVlID0gbnVsbDsKCQoJLyoqCgkqICBDb25uZWN0IHRvIHRoZSBgV2ViU29ja2V0YAoJKiAgQHB1YmxpYwoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBjb25uZWN0CgkqICBAcGFyYW0ge3N0cmluZ30gaG9zdCBUaGUgcmVtb3RlIGFkZHJlc3MgdG8gY29ubmVjdCB0bywgSVAgYWRkcmVzcyBvciBob3N0IG5hbWUKCSovCglEZWJ1Zy5jb25uZWN0ID0gZnVuY3Rpb24oaG9zdCkKCXsKCQkvLyBNYWtlIHN1cmUgV2ViU29ja2V0IGV4aXN0cyB3aXRob3V0IHByZWZpeGVzIGZvciB1cwoJCWlmKCEoIldlYlNvY2tldCIgaW4gd2luZG93KSAmJiAhKCJNb3pXZWJTb2NrZXQiIGluIHdpbmRvdykpIHJldHVybiBmYWxzZTsKCQkKCQl3aW5kb3cuV2ViU29ja2V0ID0gV2ViU29ja2V0IHx8IE1veldlYlNvY2tldDsKCQkKCQl0cnkKCQl7CgkJCXZhciBzID0gRGVidWcuX3NvY2tldCA9IG5ldyBXZWJTb2NrZXQoIndzOi8vIiArIGhvc3QgKyAiOiIgKyBEZWJ1Zy5fTkVUX1BPUlQpOwoJCQlzLm9ub3BlbiA9IG9uQ29ubmVjdDsKCQkJcy5vbm1lc3NhZ2UgPSBmdW5jdGlvbigpe307CgkJCXMub25jbG9zZSA9IG9uQ2xvc2U7CgkJCXMub25lcnJvciA9IG9uQ2xvc2U7CgkJCURlYnVnLl9tZXNzYWdlUXVldWUgPSBbXTsKCQkJRGVidWcuX2lzQ29ubmVjdGVkID0gdHJ1ZTsKCQl9CgkJY2F0Y2goZXJyb3IpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfTsKCQoJLyoqCgkqICBEaXNjb25uZWN0IGZyb20gdGhlIGBXZWJTb2NrZXRgCgkqICBAcHVibGljCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGRpc2Nvbm5lY3QKCSovCglEZWJ1Zy5kaXNjb25uZWN0ID0gZnVuY3Rpb24oKQoJewoJCWlmKERlYnVnLl9pc0Nvbm5lY3RlZCkKCQl7CgkJCURlYnVnLl9zb2NrZXQuY2xvc2UoKTsKCQkJb25DbG9zZSgpOwoJCX0KCX07CgkKCS8qKgoJKiAgQ2FsbGJhY2sgd2hlbiB0aGUgYFdlYlNvY2tldGAgaXMgY29ubmVjdGVkCgkqICBAcHJpdmF0ZQoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBvbkNvbm5lY3QKCSovCgl2YXIgb25Db25uZWN0ID0gZnVuY3Rpb24oKQoJewoJCS8vIHNldCB1cCBhIGZ1bmN0aW9uIHRvIGhhbmRsZSBhbGwgbWVzc2FnZXMKCQl3aW5kb3cub25lcnJvciA9IGdsb2JhbEVycm9ySGFuZGxlcjsKCQkKCQkvLyBjcmVhdGUgYW5kIHNlbmQgYSBuZXcgc2Vzc2lvbiBtZXNzYWdlCgkJRGVidWcuX21lc3NhZ2VPYmogPSB7bGV2ZWw6InNlc3Npb24iLCBtZXNzYWdlOiIifTsKCQlEZWJ1Zy5fc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoRGVidWcuX21lc3NhZ2VPYmopKTsKCQkKCQkvLyBzZW5kIGFueSBxdWV1ZWQgbG9ncwoJCWZvcih2YXIgaSA9IDA7IGkgPCBEZWJ1Zy5fbWVzc2FnZVF1ZXVlLmxlbmd0aDsgKytpKQoJCXsKCQkJRGVidWcuX3NvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KERlYnVnLl9tZXNzYWdlUXVldWVbaV0pKTsKCQl9CgkJLy8gZ2V0IHJpZCBvZiB0aGlzLCBzaW5jZSB3ZSBhcmUgY29ubmVjdGVkCgkJRGVidWcuX21lc3NhZ2VRdWV1ZSA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEdsb2JhbCB3aW5kb3cgZXJyb3IgaGFuZGxlciwgdXNlZCBmb3IgcmVtb3RlIGNvbm5lY3Rpb25zLgoJKiAgQHN0YXRpYwoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgZ2xvYmFsRXJyb3JIYW5kbGVyCgkqICBAcGFyYW0ge1N0cmluZ30gbWVzc2FnZSBUaGUgZXJyb3IgbWVzc2FnZQoJKiAgQHBhcmFtIHtTdHJpbmd9IGZpbGUgVGhlIHVybCBvZiB0aGUgZmlsZQoJKiAgQHBhcmFtIHtpbnR9IGxpbmUgVGhlIGxpbmUgd2l0aGluIHRoZSBmaWxlCgkqICBAcGFyYW0ge2ludH0gY29sdW1uIFRoZSBjb2x1bW4gd2l0aGluIHRoZSBsaW5lCgkqICBAcGFyYW0ge0Vycm9yfSBlcnJvciBUaGUgZXJyb3IgaXRzZWxmCgkqLwoJdmFyIGdsb2JhbEVycm9ySGFuZGxlciA9IGZ1bmN0aW9uKG1lc3NhZ2UsIGZpbGUsIGxpbmUsIGNvbHVtbiwgZXJyb3IpCgl7CgkJdmFyIGxvZ01lc3NhZ2UgPSAiRXJyb3I6ICIgKyBtZXNzYWdlICsgIiBpbiAiICsgZmlsZSArICIgYXQgbGluZSAiICsgbGluZTsKCQlpZihjb2x1bW4gIT09IHVuZGVmaW5lZCkKCQkJbG9nTWVzc2FnZSArPSAiOiIgKyBjb2x1bW47CgkJaWYoZXJyb3IpCgkJCWxvZ01lc3NhZ2UgKz0gIlxuIiArIGVycm9yLnN0YWNrOwoJCURlYnVnLnJlbW90ZUxvZyhsb2dNZXNzYWdlLCAiRVJST1IiKTsKCQlyZXR1cm4gZmFsc2U7Cgl9OwoJCgkvKioKCSogIENhbGxiYWNrIGZvciB3aGVuIHRoZSB3ZWJzb2NrZXQgaXMgY2xvc2VkCgkqICBAcHJpdmF0ZQoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBvbkNsb3NlCgkqLwoJdmFyIG9uQ2xvc2UgPSBmdW5jdGlvbigpCgl7CgkJd2luZG93Lm9uZXJyb3IgPSBudWxsOwoJCURlYnVnLl9pc0Nvbm5lY3RlZCA9IGZhbHNlOwoJCXZhciBzID0gRGVidWcuX3NvY2tldDsKCQlzLm9ub3BlbiA9IG51bGw7CgkJcy5vbm1lc3NhZ2UgPSBudWxsOwoJCXMub25jbG9zZSA9IG51bGw7CgkJcy5vbmVycm9yID0gbnVsbDsKCQlEZWJ1Zy5fc29ja2V0ID0gbnVsbDsKCQlEZWJ1Zy5fbWVzc2FnZU9iaiA9IG51bGw7CgkJRGVidWcuX21lc3NhZ2VRdWV1ZSA9IG51bGw7Cgl9OwoJCgkvKioKCSogIFNlbnQgdG8gdGhlIG91dHB1dAoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSogIEBtZXRob2Qgb3V0cHV0CgkqICBAcGFyYW0ge3N0cmluZ30gbGV2ZWwgVGhlIGxvZyBsZXZlbAoJKiAgQHBhcmFtIHtzdHJpbmd9IGFyZ3MgQWRkaXRpb25hbCBhcmd1bWVudHMKCSovCglmdW5jdGlvbiBvdXRwdXQobGV2ZWwsIGFyZ3MpCgl7CgkJaWYgKERlYnVnLm91dHB1dCkKCQl7CgkJCURlYnVnLm91dHB1dC5hcHBlbmQoIjxkaXYgY2xhc3M9XCIiK2xldmVsKyJcIj4iICsgYXJncyArICI8L2Rpdj4iKTsKCQl9Cgl9CgkKCS8qKgoJKiAgU2VuZCBhIHJlbW90ZSBsb2cgbWVzc2FnZSB1c2luZyB0aGUgc29ja2V0IGNvbm5lY3Rpb24KCSogIEBwdWJsaWMKCSogIEBzdGF0aWMKCSogIEBtZXRob2QgcmVtb3RlTG9nCgkqICBAcGFyYW0ge3N0cmluZ30gbWVzc2FnZSBUaGUgbWVzc2FnZSB0byBzZW5kCgkqICBAcGFyYW0ge2xldmVsfSBsZXZlbCBUaGUgbG9nIGxldmVsIHRvIHNlbmQKCSovCglEZWJ1Zy5yZW1vdGVMb2cgPSBmdW5jdGlvbihtZXNzYWdlLCBsZXZlbCkKCXsKCQlpZighbGV2ZWwpCgkJCWxldmVsID0gIkdFTkVSQUwiOwoJCWlmKERlYnVnLl9tZXNzYWdlUXVldWUpLy9JZiB3ZSBhcmUgc3RpbGwgaW4gdGhlIHByb2Nlc3Mgb2YgY29ubmVjdGluZywgcXVldWUgdXAgdGhlIGxvZwoJCXsKCQkJRGVidWcuX21lc3NhZ2VRdWV1ZS5wdXNoKHttZXNzYWdlOm1lc3NhZ2UsIGxldmVsOmxldmVsfSk7CgkJfQoJCWVsc2UvL3NlbmQgdGhlIGxvZyBpbW1lZGlhdGVseQoJCXsKCQkJRGVidWcuX21lc3NhZ2VPYmoubGV2ZWwgPSBsZXZlbDsKCQkJRGVidWcuX21lc3NhZ2VPYmoubWVzc2FnZSA9IG1lc3NhZ2U7CgkJCURlYnVnLl9zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShEZWJ1Zy5fbWVzc2FnZU9iaikpOwoJCX0KCX07CgoJZnVuY3Rpb24gSlNDX3N0cmluZ2lmeShvYmosIGRlcHRoKQoJewoJCWlmKCFkZXB0aCkKCQkJZGVwdGggPSAxOwoJCXZhciBzcGFjaW5nID0gIiI7CgkJdmFyIGVuZFNwYWNpbmcgPSAiIjsKCQlmb3IodmFyIGkgPSAwOyBpIDwgZGVwdGggKiA0OyArK2kpCgkJewoJCQlzcGFjaW5nICs9ICImbmJzcDsiOwoJCQlpZihpIDwgKGRlcHRoIC0gMSkgKiA0KQoJCQkJZW5kU3BhY2luZyArPSAiJm5ic3A7IjsKCQl9CgkJdmFyIHJ0biA9ICJ7PGJyIC8+IjsKCQlmb3IodmFyIGtleSBpbiBvYmopCgkJewoJCQkvL2F2b2lkIGRvaW5nIHByb3BlcnRpZXMgdGhhdCBhcmUga25vd24gdG8gYmUgRE9NIG9iamVjdHMsIGJlY2F1c2UgdGhvc2UgaGF2ZSBjaXJjdWxhciByZWZlcmVuY2VzCgkJCWlmKGtleSA9PSAiZG9jdW1lbnQiIHx8IGtleSA9PSAid2luZG93IiB8fCBrZXkgPT0gIm93bmVyRG9jdW1lbnQiIHx8IGtleSA9PSAidmlldyIpCgkJCQljb250aW51ZTsKCQkJaWYoa2V5ID09ICJ0YXJnZXQiIHx8IGtleSA9PSAiY3VycmVudFRhcmdldCIgfHwga2V5ID09ICJvcmlnaW5hbFRhcmdldCIgfHwga2V5ID09ICJleHBsaWNpdE9yaWdpbmFsVGFyZ2V0IiB8fCBrZXkgPT0gInJhbmdlUGFyZW50IikKCQkJCWNvbnRpbnVlOwoJCQlpZihrZXkgPT0gInNyY0VsZW1lbnQiIHx8IGtleSA9PSAicmVsYXRlZFRhcmdldCIgfHwga2V5ID09ICJmcm9tRWxlbWVudCIgfHwga2V5ID09ICJ0b0VsZW1lbnQiKQoJCQkJY29udGludWU7CgkJCXN3aXRjaCh0eXBlb2Ygb2JqW2tleV0pCgkJCXsKCQkJCWNhc2UgInN0cmluZyI6CgkJCQljYXNlICJudW1iZXIiOgoJCQkJY2FzZSAiYm9vbGVhbiI6CgkJCQljYXNlICJib29sIjoKCQkJCQlydG4gKz0gc3BhY2luZyArIGtleSArICI6ICIgKyBvYmpba2V5XSArICI8YnIgLz4iOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAib2JqZWN0IjoKCQkJCQlydG4gKz0gc3BhY2luZyArIGtleSArICI6ICIgKyBKU0Nfc3RyaW5naWZ5KG9ialtrZXldLCBkZXB0aCArIDEpICsgIjxiciAvPiI7CgkJCQkJYnJlYWs7CgkJCQljYXNlICJmdW5jdGlvbiI6CgkJCQkJcnRuICs9IHNwYWNpbmcgKyBrZXkgKyAiOiAoZnVuY3Rpb24pPGJyIC8+IjsKCQkJCQlicmVhazsKCQkJCWRlZmF1bHQ6CgkJCQkJcnRuICs9IHNwYWNpbmcgKyBrZXkgKyAiOiAiICsgb2JqW2tleV0gKyAiPGJyIC8+IjsKCQkJCQlicmVhazsKCQkJfQoJCX0KCQlydG4gKz0gZW5kU3BhY2luZyArICJ9IjsKCQlyZXR1cm4gcnRuOwoJfQoKCWZ1bmN0aW9uIEpTQ19mb3JtYXQoaW5wdXQpCgl7CgkJaWYodHlwZW9mIGlucHV0ID09ICJzdHJpbmciKQoJCXsKCQkJcmV0dXJuIGlucHV0LnJlcGxhY2UoL1x0L2csICImbmJzcDsmbmJzcDsmbmJzcDsmbmJzcDsiKS5yZXBsYWNlKC9cbi9nLCAiPGJyIC8+Iik7CgkJfQoJCWVsc2UgaWYodHlwZW9mIGlucHV0ID09ICJvYmplY3QiKQoJCXsKCQkJcmV0dXJuIEpTQ19zdHJpbmdpZnkoaW5wdXQpOwoJCX0KCQlyZXR1cm4gaW5wdXQ7Cgl9CgkKCS8qKgoJKiAgTG9nIHNvbWV0aGluZyBpbiB0aGUgY29uc29sZSBvciByZW1vdGUKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgbG9nCgkqICBAcGFyYW0geyp9IHBhcmFtcyBUaGUgc3RhdGVtZW50IG9yIG9iamVjdCB0byBsb2cKCSovCglEZWJ1Zy5sb2cgPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYoIURlYnVnLmVuYWJsZWQpIHJldHVybjsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5yZW1vdGVMb2cocGFyYW1zLCAiR0VORVJBTCIpOwoJCX0KCQllbHNlIGlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA9PSBEZWJ1Zy5HRU5FUkFMICYmIGhhc0NvbnNvbGUpCgkJewoJCQljb25zb2xlLmxvZyhEZWJ1Zy5faXNKU0NvbnNvbGUgPyBKU0NfZm9ybWF0KHBhcmFtcykgOiBwYXJhbXMpOwoJCQlvdXRwdXQoImdlbmVyYWwiLCBwYXJhbXMpOwoJCX0KCX07CgkKCS8qKgoJKiAgRGVidWcgc29tZXRoaW5nIGluIHRoZSBjb25zb2xlIG9yIHJlbW90ZQoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZWJ1ZwoJKiAgQHBhcmFtIHsqfSBwYXJhbXMgVGhlIHN0YXRlbWVudCBvciBvYmplY3QgdG8gZGVidWcKCSovCglEZWJ1Zy5kZWJ1ZyA9IGZ1bmN0aW9uKHBhcmFtcykKCXsKCQlpZighRGVidWcuZW5hYmxlZCkgcmV0dXJuOwoJCWlmKERlYnVnLl9pc0Nvbm5lY3RlZCkKCQl7CgkJCURlYnVnLnJlbW90ZUxvZyhwYXJhbXMsICdERScrJ0JVRycpOwoJCX0KCQllbHNlIGlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA8PSBEZWJ1Z1snREUnKydCVUcnXSAmJiBoYXNDb25zb2xlKSAvLyBqc2hpbnQgaWdub3JlOmxpbmUKCQl7CgkJCWNvbnNvbGUuZGVidWcoRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJb3V0cHV0KCJkZWJ1ZyIsIHBhcmFtcyk7CgkJfQoJfTsKCQoJLyoqCgkqICBJbmZvIHNvbWV0aGluZyBpbiB0aGUgY29uc29sZSBvciByZW1vdGUKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgaW5mbwoJKiAgQHBhcmFtIHsqfSBwYXJhbXMgVGhlIHN0YXRlbWVudCBvciBvYmplY3QgdG8gaW5mbwoJKi8KCURlYnVnLmluZm8gPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYoIURlYnVnLmVuYWJsZWQpIHJldHVybjsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5yZW1vdGVMb2cocGFyYW1zLCAiSU5GTyIpOwoJCX0KCQllbHNlIGlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA8PSBEZWJ1Zy5JTkZPICYmIGhhc0NvbnNvbGUpCgkJewoJCQljb25zb2xlLmluZm8oRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJb3V0cHV0KCJpbmZvIiwgcGFyYW1zKTsKCQl9Cgl9OwoJCgkvKioKCSogIFdhcm4gc29tZXRoaW5nIGluIHRoZSBjb25zb2xlIG9yIHJlbW90ZQoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCB3YXJuCgkqICBAcGFyYW0geyp9IHBhcmFtcyBUaGUgc3RhdGVtZW50IG9yIG9iamVjdCB0byB3YXJuCgkqLwoJRGVidWcud2FybiA9IGZ1bmN0aW9uKHBhcmFtcykKCXsKCQlpZighRGVidWcuZW5hYmxlZCkgcmV0dXJuOwoJCWlmKERlYnVnLl9pc0Nvbm5lY3RlZCkKCQl7CgkJCURlYnVnLnJlbW90ZUxvZyhwYXJhbXMsICJXQVJOSU5HIik7CgkJfQoJCWVsc2UgaWYgKERlYnVnLm1pbkxvZ0xldmVsIDw9IERlYnVnLldBUk4gJiYgaGFzQ29uc29sZSkKCQl7CgkJCWNvbnNvbGUud2FybihEZWJ1Zy5faXNKU0NvbnNvbGUgPyBKU0NfZm9ybWF0KHBhcmFtcykgOiBwYXJhbXMpOwoJCQlvdXRwdXQoIndhcm4iLCBwYXJhbXMpOwoJCX0KCX07CgkKCS8qKgoJKiAgRXJyb3Igc29tZXRoaW5nIGluIHRoZSBjb25zb2xlIG9yIHJlbW90ZQoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBlcnJvcgoJKiAgQHBhcmFtIHsqfSBwYXJhbXMgVGhlIHN0YXRlbWVudCBvciBvYmplY3QgdG8gZXJyb3IKCSovCglEZWJ1Zy5lcnJvciA9IGZ1bmN0aW9uKHBhcmFtcykKCXsKCQlpZighRGVidWcuZW5hYmxlZCkgcmV0dXJuOwoJCWlmKERlYnVnLl9pc0Nvbm5lY3RlZCkKCQl7CgkJCURlYnVnLnJlbW90ZUxvZyhwYXJhbXMsICJFUlJPUiIpOwoJCX0KCQllbHNlIGlmIChoYXNDb25zb2xlKQoJCXsKCQkJY29uc29sZS5lcnJvcihEZWJ1Zy5faXNKU0NvbnNvbGUgPyBKU0NfZm9ybWF0KHBhcmFtcykgOiBwYXJhbXMpOwoJCQlvdXRwdXQoImVycm9yIiwgcGFyYW1zKTsKCQl9Cgl9OwoJCgkvKioKCSogIEFzc2VydCB0aGF0IHNvbWV0aGluZyBpcyB0cnVlCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGFzc2VydAoJKiAgQHBhcmFtIHtib29sfSB0cnV0aCBBcyBzdGF0ZW1lbnQgdGhhdCBpcyBhc3N1bWVkIHRydWUKCSogIEBwYXJhbSB7Kn0gcGFyYW1zIFRoZSBtZXNzYWdlIHRvIGVycm9yIGlmIHRoZSBhc3NlcnQgaXMgZmFsc2UKCSovCglEZWJ1Zy5hc3NlcnQgPSBmdW5jdGlvbih0cnV0aCwgcGFyYW1zKQoJewoJCWlmIChoYXNDb25zb2xlICYmIERlYnVnLmVuYWJsZWQgJiYgY29uc29sZS5hc3NlcnQpCgkJewoJCQljb25zb2xlLmFzc2VydCh0cnV0aCwgRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJaWYgKCF0cnV0aCkgb3V0cHV0KCJlcnJvciIsIHBhcmFtcyk7CgkJfQoJfTsKCQoJLyoqCgkqICBNZXRob2QgdG8gZGVzY3JpYmUgYW4gb2JqZWN0IGluIHRoZSBjb25zb2xlCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIGRpcgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtvYmplY3R9IHBhcmFtcyBUaGUgb2JqZWN0IHRvIGRlc2NyaWJlIGluIHRoZSBjb25zb2xlCgkqLwoJRGVidWcuZGlyID0gZnVuY3Rpb24ocGFyYW1zKQoJewoJCWlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA9PSBEZWJ1Zy5HRU5FUkFMICYmIGhhc0NvbnNvbGUgJiYgRGVidWcuZW5hYmxlZCkKCQl7CgkJCWNvbnNvbGUuZGlyKERlYnVnLl9pc0pTQ29uc29sZSA/IEpTQ19mb3JtYXQocGFyYW1zKSA6IHBhcmFtcyk7CgkJfQoJfTsKCQoJLyoqCgkqICBNZXRob2QgdG8gY2xlYXIgdGhlIGNvbnNvbGUKCSoKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgY2xlYXIKCSovCglEZWJ1Zy5jbGVhciA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoaGFzQ29uc29sZSAmJiBEZWJ1Zy5lbmFibGVkKQoJCXsKCQkJY29uc29sZS5jbGVhcigpOwoJCQlpZiAoRGVidWcub3V0cHV0KSBEZWJ1Zy5vdXRwdXQuaHRtbCgiIik7CgkJfQoJfTsKCQoJLyoqCgkqICBHZW5lcmF0ZSBhIHN0YWNrIHRyYWNrIGluIHRoZSBvdXRwdXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgdHJhY2UKCSogIEBwYXJhbSB7Kn0gcGFyYW1zIE9wdGlvbmFsIHBhcmFtZXRlcnMgdG8gbG9nCgkqLwoJRGVidWcudHJhY2UgPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYgKERlYnVnLm1pbkxvZ0xldmVsID09IERlYnVnLkdFTkVSQUwgJiYgaGFzQ29uc29sZSAmJiBEZWJ1Zy5lbmFibGVkKQoJCXsKCQkJY29uc29sZS50cmFjZShEZWJ1Zy5faXNKU0NvbnNvbGUgPyBKU0NfZm9ybWF0KHBhcmFtcykgOiBwYXJhbXMpOwoJCX0KCX07CgkKCS8vIE1ha2UgdGhlIGRlYnVnIGNsYXNzIGdsb2JhbGx5IGFjY2Vzc2libGUKCS8vIElmIHRoZSBjb25zb2xlIGRvZXNuJ3QgZXhpc3QsIHVzZSB0aGUgZHVtbXkgdG8gcHJldmVudCBlcnJvcnMKCXdpbmRvdy5EZWJ1ZyA9IERlYnVnOwoJCn0od2luZG93KSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKHdpbmRvdyl7CgkJCgkvLyBJbmNsdWRlIHRoZSB3aW5kb3cucGVyZm9ybWFuY2Ugb2JqZWN0Cgl2YXIgcGVyZm9ybWFuY2UgPSBpbmNsdWRlKCdwZXJmb3JtYW5jZScsIGZhbHNlKTsKCgkvLyBTZWUgaWYgd2UgaGF2ZSBwZXJmb3JtYW5jZS5ub3cgb3IgYW55IG9mCgkvLyB0aGUgYnJvd2VyLXNwZWNpZmljIHZlcnNpb25zCgl2YXIgbm93ID0gcGVyZm9ybWFuY2UgJiYgKAoJCXBlcmZvcm1hbmNlLm5vdyB8fCAKCQlwZXJmb3JtYW5jZS5tb3pOb3cgfHwgCgkJcGVyZm9ybWFuY2UubXNOb3cgfHwgCgkJcGVyZm9ybWFuY2Uub05vdyB8fCAKCQlwZXJmb3JtYW5jZS53ZWJraXROb3cKCSk7CgoJLy8gQnJvd3NlciBwcmVmaXggcG9seWZpbGwKCWlmIChub3cpIHBlcmZvcm1hbmNlLm5vdyA9IG5vdzsKCgkvKioKCSogIEEgY29sbGVjdGlvbiBvZiBUaW1lIHJlbGF0ZWQgdXRpbGl0eSBmdW5jdGlvbnMKCSogIEBjbGFzcyBUaW1lVXRpbHMKCSovCgl2YXIgVGltZVV0aWxzID0ge307CgkKCS8qKgoJKiAgVGhpcyBtZXRob2QgZ2V0cyB0aW1lc3RhbXAgaW4gbWljcm9taWxsaXNlY29uZHMgZm9yIGRvaW5nIHBlcmZvcm1hbmNlCgkqICBpbnRlbnNlIG9wZXJhdGlvbnMuIEZhbGxiYWNrIHN1cHBvcnQgaXMgdG8gYERhdGUubm93KClgLiBXZSBhcmVuJ3Qgb3ZlcnJpZGRpbmcKCSogIGBwZXJmb3JtYW5jZS5ub3coKWAgaW5jYXNlIGRlcGVuZGVuY2llcyBvbiB0aGlzIGFjdHVhbGx5IGRlbWFuZCAKCSogIHRoZSBvcHRpbWl6YXRpb24gYW5kIGFjY3VyYWN5IHRoYXQgcGVyZm9ybWFuY2UgYWN0dWFsbHkgcHJvdmlkZXMuCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIG5vdwoJKiAgQHJldHVybiB7aW50fSBUaGUgbnVtYmVyIG9mIG1pY3JvbWlsbGlzZWNvbmRzIG9mIHRoZSBjdXJyZW50IHRpbWVzdGFtcAoJKi8KCVRpbWVVdGlscy5ub3cgPSAhbm93ID8gRGF0ZS5ub3cgOiBmdW5jdGlvbigpCgl7IAoJCXJldHVybiBwZXJmb3JtYW5jZS5ub3coKTsgCgl9OwoKCS8vIEFzc2lnbiB0byBuYW1lc3BhY2UKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLlRpbWVVdGlscyA9IFRpbWVVdGlsczsKCQp9KHdpbmRvdykpOwooZnVuY3Rpb24oKXsKCgkvLyBodHRwOi8vcGF1bGlyaXNoLmNvbS8yMDExL3JlcXVlc3RhbmltYXRpb25mcmFtZS1mb3Itc21hcnQtYW5pbWF0aW5nLwoJLy8gaHR0cDovL215Lm9wZXJhLmNvbS9lbW9sbGVyL2Jsb2cvMjAxMS8xMi8yMC9yZXF1ZXN0YW5pbWF0aW9uZnJhbWUtZm9yLXNtYXJ0LWVyLWFuaW1hdGluZwoJLy8gcmVxdWVzdEFuaW1hdGlvbkZyYW1lIHBvbHlmaWxsIGJ5IEVyaWsgTcO2bGxlci4gZml4ZXMgZnJvbSBQYXVsIElyaXNoIGFuZCBUaW5vIFppamRlbAoJLy8gTUlUIGxpY2Vuc2UKCXZhciB2ZW5kb3JzID0gWydtcycsICdtb3onLCAnd2Via2l0JywgJ28nXTsKCWZvcih2YXIgeCA9IDA7IHggPCB2ZW5kb3JzLmxlbmd0aCAmJiAhd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsgKyt4KQoJewoJCXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSB3aW5kb3dbdmVuZG9yc1t4XSsnUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ107CgkJd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0rJ0NhbmNlbEFuaW1hdGlvbkZyYW1lJ10gfHwgd2luZG93W3ZlbmRvcnNbeF0rJ0NhbmNlbFJlcXVlc3RBbmltYXRpb25GcmFtZSddOwoJfQoKCS8vIGNyZWF0ZSBhIHNldFRpbWVvdXQgYmFzZWQgZmFsbGJhY2sgaWYgdGhlcmUgd2Fzbid0IGFuIG9mZmljaWFsIG9yIHByZWZpeGVkIHZlcnNpb24KCWlmICghd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSkKCXsKCQl2YXIgVGltZVV0aWxzID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5UaW1lVXRpbHMnKTsKCQl2YXIgbGFzdFRpbWUgPSAwOwoJCS8vIENyZWF0ZSB0aGUgcG9seWZpbGwKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oY2FsbGJhY2spCgkJewoJCQl2YXIgY3VyclRpbWUgPSBUaW1lVXRpbHMubm93KCk7Ly91c2UgdGhlIG5vdyBmdW5jdGlvbiBmcm9tIGRvd24gYmVsb3cKCQkJdmFyIHRpbWVUb0NhbGwgPSBNYXRoLm1heCgwLCAxNiAtIChjdXJyVGltZSAtIGxhc3RUaW1lKSk7CgkJCXZhciBpZCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyBjYWxsYmFjayhjdXJyVGltZSArIHRpbWVUb0NhbGwpOyB9LCB0aW1lVG9DYWxsKTsKCQkJbGFzdFRpbWUgPSBjdXJyVGltZSArIHRpbWVUb0NhbGw7CgkJCXJldHVybiBpZDsKCQl9OwoKCQkvLyBPbmx5IHNldCB0aGlzIHVwIGlmIHRoZSBjb3JyZXNwb25kaW5nIHJlcXVlc3RBbmltYXRpb25GcmFtZSB3YXMgc2V0IHVwCgkJd2luZG93LmNhbmNlbEFuaW1hdGlvbkZyYW1lID0gZnVuY3Rpb24oaWQpIHsKCQkJY2xlYXJUaW1lb3V0KGlkKTsKCQl9OwoJfQoKCS8vIFNob3J0IGFsaWFzCgl3aW5kb3cucmVxdWVzdEFuaW1GcmFtZSA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7Cgp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbih1bmRlZmluZWQpewoJCQoJLyoqCgkqICBUaGUgRXZlbnREaXNwYXRjaGVyIG1pcnJvcnMgdGhlIGZ1bmN0aW9uYWxpdHkgb2YgQVMzIGFuZCBDcmVhdGVKUydzIEV2ZW50RGlzcGF0Y2hlciwgCgkqICBidXQgaXMgbW9yZSByb2J1c3QgaW4gdGVybXMgb2YgaW5wdXRzIGZvciB0aGUgYG9uKClgIGFuZCBgb2ZmKClgIG1ldGhvZHMuCgkqICAKCSogIEBjbGFzcyBFdmVudERpc3BhdGNoZXIKCSogIEBjb25zdHJ1Y3RvcgoJKi8KCXZhciBFdmVudERpc3BhdGNoZXIgPSBmdW5jdGlvbigpCgl7CgkJLyoqCgkJKiBUaGUgY29sbGVjdGlvbiBvZiBsaXN0ZW5lcnMKCQkqIEBwcm9wZXJ0eSB7QXJyYXl9IF9saXN0ZW5lcnMKCQkqIEBwcml2YXRlCgkJKi8KCQl0aGlzLl9saXN0ZW5lcnMgPSBbXTsKCgkJLyoqCgkJICogSWYgdGhlIGRpc3BhdGNoZXIgaXMgZGVzdHJveWVkCgkJICogQHByb3BlcnR5IHtCb29sZWFufSBfZGVzdHJveWVkCgkJICogQHByb3RlY3RlZAoJCSAqLwoJCXRoaXMuX2Rlc3Ryb3llZCA9IGZhbHNlOwoJfSwKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgCglwID0gRXZlbnREaXNwYXRjaGVyLnByb3RvdHlwZTsKCQoJLyoqCgkqICBEaXNwYXRjaCBhbiBldmVudAoJKiAgQG1ldGhvZCB0cmlnZ2VyCgkqICBAcGFyYW0ge1N0cmluZ30gdHlwZSBUaGUgdHlwZSBvZiBldmVudCB0byB0cmlnZ2VyCgkqICBAcGFyYW0geyp9IGFyZ3VtZW50cyBBZGRpdGlvbmFsIHBhcmFtZXRlcnMgZm9yIHRoZSBsaXN0ZW5lciBmdW5jdGlvbnMuCgkqLwoJcC50cmlnZ2VyID0gZnVuY3Rpb24odHlwZSkKCXsKCQlpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm47CgkJCgkJaWYgKHRoaXMuX2xpc3RlbmVyc1t0eXBlXSAhPT0gdW5kZWZpbmVkKSAKCQl7CQoJCQkvLyBjb3B5IHRoZSBsaXN0ZW5lcnMgYXJyYXkKCQkJdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyc1t0eXBlXS5zbGljZSgpOwoKCQkJdmFyIGFyZ3M7CgoJCQlpZihhcmd1bWVudHMubGVuZ3RoID4gMSkKCQkJewoJCQkJYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMSk7CgkJCX0KCQkJCgkJCWZvcih2YXIgaSA9IGxpc3RlbmVycy5sZW5ndGggLSAxOyBpID49IDA7IC0taSkgCgkJCXsKCQkJCWxpc3RlbmVyc1tpXS5hcHBseSh0aGlzLCBhcmdzKTsKCgkJCQlpZiAobGlzdGVuZXJzW2ldLl9ldmVudERpc3BhdGNoZXJPbmNlKQoJCQkJewoJCQkJCWRlbGV0ZSBsaXN0ZW5lcnNbaV0uX2V2ZW50RGlzcGF0Y2hlck9uY2U7CgkJCQkJdGhpcy5vZmYodHlwZSwgbGlzdGVuZXJzW2ldKTsKCQkJCX0KCQkJfQoJCX0KCX07CgoJLyoqCgkqICBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgYnV0IG9ubHkgaGFuZGxlIGl0IG9uZSB0aW1lLgoJKiAgCgkqICBAbWV0aG9kIG9uY2UKCSogIEBwYXJhbSB7U3RyaW5nfG9iamVjdH0gbmFtZSBUaGUgdHlwZSBvZiBldmVudCAoY2FuIGJlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgc3BhY2VzKSwgCgkqICAgICAgICAgIG9yIGEgbWFwIG9mIGV2ZW50cyB0byBoYW5kbGVycwoJKiAgQHBhcmFtIHtGdW5jdGlvbnxBcnJheSp9IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGV2ZW50IGlzIGZpcmVkIG9yIGFuIGFycmF5IG9mIGNhbGxiYWNrcy4KCSogIEBwYXJhbSB7aW50fSBbcHJpb3JpdHk9MF0gVGhlIHByaW9yaXR5IG9mIHRoZSBldmVudCBsaXN0ZW5lci4gSGlnaGVyIG51bWJlcnMgYXJlIGhhbmRsZWQgZmlyc3QuCgkqICBAcmV0dXJuIHtFdmVudERpc3BhdGNoZXJ9IFJldHVybiB0aGlzIEV2ZW50RGlzcGF0Y2hlciBmb3IgY2hhaW5pbmcgY2FsbHMuCgkqLwoJcC5vbmNlID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIHByaW9yaXR5KQoJewoJCXJldHVybiB0aGlzLm9uKG5hbWUsIGNhbGxiYWNrLCBwcmlvcml0eSwgdHJ1ZSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhbiBldmVudCBsaXN0ZW5lci4gVGhlIHBhcmFtZXRlcnMgZm9yIHRoZSBsaXN0ZW5lciBmdW5jdGlvbnMgZGVwZW5kIG9uIHRoZSBldmVudC4KCSogIAoJKiAgQG1ldGhvZCBvbgoJKiAgQHBhcmFtIHtTdHJpbmd8b2JqZWN0fSBuYW1lIFRoZSB0eXBlIG9mIGV2ZW50IChjYW4gYmUgbXVsdGlwbGUgZXZlbnRzIHNlcGFyYXRlZCBieSBzcGFjZXMpLCAKCSogICAgICAgICAgb3IgYSBtYXAgb2YgZXZlbnRzIHRvIGhhbmRsZXJzCgkqICBAcGFyYW0ge0Z1bmN0aW9ufEFycmF5Kn0gY2FsbGJhY2sgVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoZW4gZXZlbnQgaXMgZmlyZWQgb3IgYW4gYXJyYXkgb2YgY2FsbGJhY2tzLgoJKiAgQHBhcmFtIHtpbnR9IFtwcmlvcml0eT0wXSBUaGUgcHJpb3JpdHkgb2YgdGhlIGV2ZW50IGxpc3RlbmVyLiBIaWdoZXIgbnVtYmVycyBhcmUgaGFuZGxlZCBmaXJzdC4KCSogIEByZXR1cm4ge0V2ZW50RGlzcGF0Y2hlcn0gUmV0dXJuIHRoaXMgRXZlbnREaXNwYXRjaGVyIGZvciBjaGFpbmluZyBjYWxscy4KCSovCglwLm9uID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2ssIHByaW9yaXR5LCBvbmNlKQoJewoJCWlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybjsKCgkJLy8gQ2FsbGJhY2tzIG1hcAoJCWlmICh0eXBlKG5hbWUpID09PSAnb2JqZWN0JykKCQl7CgkJCWZvciAodmFyIGtleSBpbiBuYW1lKQoJCQl7CgkJCQlpZiAobmFtZS5oYXNPd25Qcm9wZXJ0eShrZXkpKQoJCQkJewoJCQkJCXRoaXMub24oa2V5LCBuYW1lW2tleV0sIHByaW9yaXR5LCBvbmNlKTsKCQkJCX0KCQkJfQoJCX0KCQkvLyBDYWxsYmFjawoJCWVsc2UgaWYgKHR5cGUoY2FsbGJhY2spID09PSAnZnVuY3Rpb24nKQoJCXsKCQkJdmFyIG5hbWVzID0gbmFtZS5zcGxpdCgnICcpLCBuID0gbnVsbDsKCQkJZm9yICh2YXIgaSA9IDAsIG5sID0gbmFtZXMubGVuZ3RoOyBpIDwgbmw7IGkrKykKCQkJewoJCQkJbiA9IG5hbWVzW2ldOwoJCQkJdmFyIGxpc3RlbmVyID0gdGhpcy5fbGlzdGVuZXJzW25dOwoJCQkJaWYoIWxpc3RlbmVyKQoJCQkJCWxpc3RlbmVyID0gdGhpcy5fbGlzdGVuZXJzW25dID0gW107CgkJCQkKCQkJCWlmIChvbmNlKQoJCQkJewoJCQkJCWNhbGxiYWNrLl9ldmVudERpc3BhdGNoZXJPbmNlID0gdHJ1ZTsKCQkJCX0KCQkJCWNhbGxiYWNrLl9wcmlvcml0eSA9IHBhcnNlSW50KHByaW9yaXR5KSB8fCAwOwoKCQkJCWlmIChsaXN0ZW5lci5pbmRleE9mKGNhbGxiYWNrKSA9PT0gLTEpCgkJCQl7CgkJCQkJbGlzdGVuZXIucHVzaChjYWxsYmFjayk7CgkJCQkJaWYobGlzdGVuZXIubGVuZ3RoID4gMSkKCQkJCQkJbGlzdGVuZXIuc29ydChsaXN0ZW5lclNvcnRlcik7CgkJCQl9CgkJCX0KCQl9CgkJLy8gQ2FsbGJhY2tzIGFycmF5CgkJZWxzZSBpZiAoQXJyYXkuaXNBcnJheShjYWxsYmFjaykpCgkJewoJCQlmb3IgKHZhciBmID0gMCwgZmwgPSBjYWxsYmFjay5sZW5ndGg7IGYgPCBmbDsgZisrKQoJCQl7CgkJCQl0aGlzLm9uKG5hbWUsIGNhbGxiYWNrW2ZdLCBwcmlvcml0eSwgb25jZSk7CgkJCX0KCQl9CgkJcmV0dXJuIHRoaXM7Cgl9OwoKCWZ1bmN0aW9uIGxpc3RlbmVyU29ydGVyKGEsIGIpCgl7CgkJcmV0dXJuIGEuX3ByaW9yaXR5IC0gYi5fcHJpb3JpdHk7Cgl9CgkKCS8qKgoJKiAgUmVtb3ZlIHRoZSBldmVudCBsaXN0ZW5lcgoJKiAgCgkqICBAbWV0aG9kIG9mZgoJKiAgQHBhcmFtIHtTdHJpbmcqfSBuYW1lIFRoZSB0eXBlIG9mIGV2ZW50IHN0cmluZyBzZXBhcmF0ZWQgYnkgc3BhY2VzLCBpZiBubyBuYW1lIGlzIHNwZWNpZmVkIHJlbW92ZSBhbGwgbGlzdGVuZXJzLgoJKiAgQHBhcmFtIHtGdW5jdGlvbnxBcnJheSp9IGNhbGxiYWNrIFRoZSBsaXN0ZW5lciBmdW5jdGlvbiBvciBjb2xsZWN0aW9uIG9mIGNhbGxiYWNrIGZ1bmN0aW9ucwoJKiAgQHJldHVybiB7RXZlbnREaXNwYXRjaGVyfSBSZXR1cm4gdGhpcyBFdmVudERpc3BhdGNoZXIgZm9yIGNoYWluaW5nIGNhbGxzLgoJKi8KCXAub2ZmID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2spCgl7CgkJaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuOwoKCQkvLyByZW1vdmUgYWxsIAoJCWlmIChuYW1lID09PSB1bmRlZmluZWQpCgkJewoJCQl0aGlzLl9saXN0ZW5lcnMgPSBbXTsKCQl9CgkJLy8gcmVtb3ZlIG11bHRpcGxlIGNhbGxiYWNrcwoJCWVsc2UgaWYgKEFycmF5LmlzQXJyYXkoY2FsbGJhY2spKQoJCXsKCQkJZm9yICh2YXIgZiA9IDAsIGZsID0gY2FsbGJhY2subGVuZ3RoOyBmIDwgZmw7IGYrKykgCgkJCXsKCQkJCXRoaXMub2ZmKG5hbWUsIGNhbGxiYWNrW2ZdKTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQl2YXIgbmFtZXMgPSBuYW1lLnNwbGl0KCcgJyksIG4gPSBudWxsOwoJCQlmb3IgKHZhciBpID0gMCwgbmwgPSBuYW1lcy5sZW5ndGg7IGkgPCBubDsgaSsrKQoJCQl7CgkJCQluID0gbmFtZXNbaV07CgkJCQl2YXIgbGlzdGVuZXIgPSB0aGlzLl9saXN0ZW5lcnNbbl07CgkJCQlpZihsaXN0ZW5lcikKCQkJCXsKCQkJCQkvLyByZW1vdmUgYWxsIGxpc3RlbmVycyBmb3IgdGhhdCBldmVudAoJCQkJCWlmIChjYWxsYmFjayA9PT0gdW5kZWZpbmVkKQoJCQkJCXsKCQkJCQkJbGlzdGVuZXIubGVuZ3RoID0gMDsKCQkJCQl9CgkJCQkJZWxzZQoJCQkJCXsKCQkJCQkJLy9yZW1vdmUgc2luZ2xlIGxpc3RlbmVyCgkJCQkJCXZhciBpbmRleCA9IGxpc3RlbmVyLmluZGV4T2YoY2FsbGJhY2spOwoJCQkJCQlpZiAoaW5kZXggIT09IC0xKQoJCQkJCQl7CgkJCQkJCQlsaXN0ZW5lci5zcGxpY2UoaW5kZXgsIDEpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKCgkvKioKCSogIENoZWNrcyBpZiB0aGUgRXZlbnREaXNwYXRjaGVyIGhhcyBhIHNwZWNpZmljIGxpc3RlbmVyIG9yIGFueSBsaXN0ZW5lciBmb3IgYSBnaXZlbiBldmVudC4KCSogIAoJKiAgQG1ldGhvZCBoYXMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSBzaW5nbGUgZXZlbnQgdHlwZSB0byBjaGVjayBmb3IKCSogIEBwYXJhbSB7RnVuY3Rpb259IFtjYWxsYmFja10gVGhlIGxpc3RlbmVyIGZ1bmN0aW9uIHRvIGNoZWNrIGZvci4gSWYgb21pdHRlZCwgY2hlY2tzIGZvciBhbnkgbGlzdGVuZXIuCgkqICBAcmV0dXJuIHtCb29sZWFufSBJZiB0aGUgRXZlbnREaXNwYXRjaGVyIGhhcyB0aGUgc3BlY2lmaWVkIGxpc3RlbmVyLgoJKi8KCXAuaGFzID0gZnVuY3Rpb24obmFtZSwgY2FsbGJhY2spCgl7CgkJaWYoIW5hbWUpIHJldHVybiBmYWxzZTsKCgkJdmFyIGxpc3RlbmVycyA9IHRoaXMuX2xpc3RlbmVyc1tuYW1lXTsKCQlpZighbGlzdGVuZXJzKSByZXR1cm4gZmFsc2U7CgkJaWYoIWNhbGxiYWNrKQoJCQlyZXR1cm4gbGlzdGVuZXJzLmxlbmd0aCA+IDA7CgkJcmV0dXJuIGxpc3RlbmVycy5pbmRleE9mKGNhbGxiYWNrKSA+PSAwOwoJfTsKCQoJLyoqCgkqICBEZXN0cm95IGFuZCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX2Rlc3Ryb3llZCA9IHRydWU7CgkJdGhpcy5fbGlzdGVuZXJzID0gbnVsbDsKCX07CgoJLyoqCgkqICBSZXR1cm4gdHlwZSBvZiB0aGUgdmFsdWUuCgkqICAKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIHR5cGUKCSogIEBwYXJhbSAgeyp9IHZhbHVlCgkqICBAcmV0dXJuIHtTdHJpbmd9IFRoZSB0eXBlCgkqLwoJZnVuY3Rpb24gdHlwZSh2YWx1ZSkKCXsKCQlpZiAodmFsdWUgPT09IG51bGwpCgkJewoJCQlyZXR1cm4gJ251bGwnOwoJCX0KCQl2YXIgdHlwZU9mVmFsdWUgPSB0eXBlb2YgdmFsdWU7CgkJaWYgKHR5cGVPZlZhbHVlID09PSAnb2JqZWN0JyB8fCB0eXBlT2ZWYWx1ZSA9PT0gJ2Z1bmN0aW9uJykKCQl7CgkJCXJldHVybiBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsdWUpLm1hdGNoKC9ccyhbYS16XSspL2kpWzFdLnRvTG93ZXJDYXNlKCkgfHwgJ29iamVjdCc7CgkJfQoJCXJldHVybiB0eXBlT2ZWYWx1ZTsKCX0KCgkvKioKCSogIEFkZHMgRXZlbnREaXNwYXRjaGVyIG1ldGhvZHMgYW5kIHByb3BlcnRpZXMgdG8gYW4gb2JqZWN0IG9yIG9iamVjdCBwcm90b3R5cGUuCgkqICBAbWV0aG9kIG1peEluCgkqICBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBvYmplY3Qgb3IgcHJvdG90eXBlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtjYWxsQ29uc3RydWN0b3I9ZmFsc2VdIElmIHRoZSBFdmVudERpc3BhdGNoZXIgY29uc3RydWN0b3Igc2hvdWxkIGJlIGNhbGxlZCBhcyB3ZWxsLgoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKi8KCUV2ZW50RGlzcGF0Y2hlci5taXhJbiA9IGZ1bmN0aW9uKG9iamVjdCwgY2FsbENvbnN0cnVjdG9yKQoJewoJCW9iamVjdC50cmlnZ2VyID0gcC50cmlnZ2VyOwoJCW9iamVjdC5vbiA9IHAub247CgkJb2JqZWN0Lm9mZiA9IHAub2ZmOwoJCW9iamVjdC5oYXMgPSBwLmhhczsKCQlpZihjYWxsQ29uc3RydWN0b3IpCgkJCUV2ZW50RGlzcGF0Y2hlci5jYWxsKG9iamVjdCk7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gbmFtZSBzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuRXZlbnREaXNwYXRjaGVyID0gRXZlbnREaXNwYXRjaGVyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKGdsb2JhbCwgZG9jLCB1bmRlZmluZWQpewoJCQoJLyoqCgkqICBIYW5kbGUgdGhlIHBhZ2UgdmlzaWJsaXR5IGNoYW5nZSwgaWYgc3VwcG9ydGVkLiBBcHBsaWNhdGlvbiB1c2VzIG9uZSBvZiB0aGVzZSB0bwoJKiAgbW9uaXRvciBwYWdlIHZpc2liaWxpdHkuIEl0IGlzIHN1Z2dlc3RlZCB0aGF0IHlvdSBsaXN0ZW4gdG8gInBhdXNlIiwgInBhdXNlZCIsIAoJKiAgb3IgInVucGF1c2VkIiBldmVudHMgb24gdGhlIGFwcGxpY2F0aW9uIGluc3RlYWQgb2YgdXNpbmcgb25lIG9mIHRoZXNlIHlvdXJzZWxmLgoJKiAgCgkqICBAY2xhc3MgUGFnZVZpc2liaWxpdHkKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gb25Gb2N1cyBDYWxsYmFjayB3aGVuIHRoZSBwYWdlIGJlY29tZXMgdmlzaWJsZQoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gb25CbHVyIENhbGxiYWNrIHdoZW4gdGhlIHBhZ2UgbG9zZXMgdmlzaWJpbGl0eQoJKi8KCXZhciBQYWdlVmlzaWJpbGl0eSA9IGZ1bmN0aW9uKG9uRm9jdXMsIG9uQmx1cikKCXsKCQkvKioKCQkqIENhbGxiYWNrIHdoZW4gdGhlIHBhZ2UgYmVjb21lcyB2aXNpYmxlCgkJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Gb2N1cwoJCSogQHByaXZhdGUKCQkqLwoJCXRoaXMuX29uRm9jdXMgPSBvbkZvY3VzOwoJCQoJCS8qKgoJCSogQ2FsbGJhY2sgd2hlbiB0aGUgcGFnZSBsb3NlcyB2aXNpYmlsaXR5CgkJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25CbHVyCgkJKiBAcHJpdmF0ZQoJCSovCgkJdGhpcy5fb25CbHVyID0gb25CbHVyOwoJCQoJCS8qKgoJCSogVGhlIHZpc2liaWxpdHkgdG9nZ2xlIGZ1bmN0aW9uCgkJKiBAcHJvcGVydHkge2Z1bmN0aW9ufSBfb25Ub2dnbGUKCQkqIEBwcml2YXRlCgkJKi8KCQl0aGlzLl9vblRvZ2dsZSA9IG51bGw7CgoJCXRoaXMuaW5pdGlhbGl6ZSgpOwoJfSwKCQoJLy8gUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgCglwID0gUGFnZVZpc2liaWxpdHkucHJvdG90eXBlLAoJCgkvKiogCgkqIFRoZSBuYW1lIG9mIHRoZSB2aXNpYmlsaXR5IGNoYW5nZSBldmVudCBmb3IgdGhlIGJyb3dzZXIKCSogCgkqIEBwcm9wZXJ0eSB7U3RyaW5nfSBfdmlzaWJpbGl0eUNoYW5nZQoJKiBAcHJpdmF0ZQoJKi8KCV92aXNpYmlsaXR5Q2hhbmdlID0gbnVsbDsKCQoJLy8gU2VsZWN0IHRoZSB2aXNpYmxpdHkgY2hhbmdlIGV2ZW50IG5hbWUKCWlmIChkb2MuaGlkZGVuICE9PSB1bmRlZmluZWQpCgl7CgkJX3Zpc2liaWxpdHlDaGFuZ2UgPSAidmlzaWJpbGl0eWNoYW5nZSI7Cgl9IAoJZWxzZSBpZiAoZG9jLm1vekhpZGRlbiAhPT0gdW5kZWZpbmVkKQoJewoJCV92aXNpYmlsaXR5Q2hhbmdlID0gIm1venZpc2liaWxpdHljaGFuZ2UiOwoJfSAKCWVsc2UgaWYgKGRvYy5tc0hpZGRlbiAhPT0gdW5kZWZpbmVkKQoJewoJCV92aXNpYmlsaXR5Q2hhbmdlID0gIm1zdmlzaWJpbGl0eWNoYW5nZSI7Cgl9IAoJZWxzZSBpZiAoZG9jLndlYmtpdEhpZGRlbiAhPT0gdW5kZWZpbmVkKQoJewoJCV92aXNpYmlsaXR5Q2hhbmdlID0gIndlYmtpdHZpc2liaWxpdHljaGFuZ2UiOwoJfQoJCgkvKioKCSogIENyZWF0ZSBuZXcgUGFnZSB2aXNpYmlsaXR5CgkqICAKCSogIEBtZXRob2QgaW5pdGlhbGl6ZQoJKi8KCXAuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uKCkKCXsKCQkvLyBJZiB0aGlzIGJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IHZpc2liaWxpdHkKCQlpZiAoIV92aXNpYmlsaXR5Q2hhbmdlKSByZXR1cm47CgkJCgkJLy8gVGhlIHZpc2liaWxpdHkgdG9nZ2xlIGZ1bmN0aW9uCgkJdmFyIG9uVmlzaWJpbGl0eUNoYW5nZSA9IGZ1bmN0aW9uKCkgCgkJewoJCQlpZiAoZG9jLmhpZGRlbiB8fCBkb2Mud2Via2l0SGlkZGVuIHx8IGRvYy5tc0hpZGRlbiB8fCBkb2MubW96SGlkZGVuKQoJCQkJdGhpcy5fb25CbHVyKCk7CgkJCWVsc2UgCgkJCQl0aGlzLl9vbkZvY3VzKCk7CgkJfS5iaW5kKHRoaXMpOwoJCQoJCS8vIExpc3RlbiB0byB2aXNpYmlsaXR5IGNoYW5nZQoJCS8vIHNlZSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi9BUEkvUGFnZVZpc2liaWxpdHkvUGFnZV9WaXNpYmlsaXR5X0FQSQoJCWRvYy5hZGRFdmVudExpc3RlbmVyKF92aXNpYmlsaXR5Q2hhbmdlLCBvblZpc2liaWxpdHlDaGFuZ2UsIGZhbHNlKTsKCQkKCQkvLyBMaXN0ZW4gZm9yIHBhZ2UgZXZlbnRzICh3aGVuIGNsaWNraW5nIHRoZSBob21lIGJ1dHRvbiBvbiBpT1MpCgkJZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoInBhZ2VoaWRlIiwgdGhpcy5fb25CbHVyKTsKCQlnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigicGFnZXNob3ciLCB0aGlzLl9vbkZvY3VzKTsKCQlnbG9iYWwuYWRkRXZlbnRMaXN0ZW5lcigiYmx1ciIsIHRoaXMuX29uQmx1cik7CgkJZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImZvY3VzIiwgdGhpcy5fb25Gb2N1cyk7CgkJZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoInZpc2liaWxpdHljaGFuZ2UiLCBvblZpc2liaWxpdHlDaGFuZ2UsIGZhbHNlKTsKCQkKCQl0aGlzLl9vblRvZ2dsZSA9IG9uVmlzaWJpbGl0eUNoYW5nZTsKCX07CgkKCS8qKgoJKiAgRGlzYWJsZSB0aGUgZGV0ZWN0aW9uCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJLy8gSWYgdGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB2aXNpYmlsaXR5CgkJaWYgKCFfdmlzaWJpbGl0eUNoYW5nZSkgcmV0dXJuOwoJCQoJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJwYWdlaGlkZSIsIHRoaXMuX29uQmx1cik7CgkJZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoInBhZ2VzaG93IiwgdGhpcy5fb25Gb2N1cyk7CgkJZ2xvYmFsLnJlbW92ZUV2ZW50TGlzdGVuZXIoImJsdXIiLCB0aGlzLl9vbkJsdXIpOwoJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJmb2N1cyIsIHRoaXMuX29uRm9jdXMpOwoJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgdGhpcy5fb25Ub2dnbGUpOwoJCQoJCWRvYy5yZW1vdmVFdmVudExpc3RlbmVyKF92aXNpYmlsaXR5Q2hhbmdlLCB0aGlzLl9vblRvZ2dsZSwgZmFsc2UpOwoJCQoJCXRoaXMuX29uRm9jdXMgPSBudWxsOwoJCXRoaXMuX29uQmx1ciA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuUGFnZVZpc2liaWxpdHkgPSBQYWdlVmlzaWJpbGl0eTsKCQp9KHdpbmRvdywgZG9jdW1lbnQpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCgkvLyBjbGFzc2VzIHRvIGltcG9ydAoJdmFyIERlYnVnLAoJCUxvYWRlciwKCQlUaW1lVXRpbHMsCgkJUGFnZVZpc2liaWxpdHksCgkJRXZlbnREaXNwYXRjaGVyID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5FdmVudERpc3BhdGNoZXInKTsKCgkvKioKCSogIENyZWF0ZXMgYSBuZXcgYXBwbGljYXRpb24sIGZvciBleGFtcGxlIChIYXBweUNhbWVsIGV4dGVuZHMgQXBwbGljYXRpb24pCgkqICBtYW5hZ2VzIGRpc3BsYXlzLCB1cGRhdGUgbG9vcCBjb250cm9sbGluZywgaGFuZGxlcyByZXNpemluZwoJKgoJKgl2YXIgYXBwID0gbmV3IEFwcGxpY2F0aW9uKHtmcHM6NjAsIHJlc2l6ZUVsZW1lbnQ6d2luZG93fSk7CgkqCgkqICBAY2xhc3MgQXBwbGljYXRpb24KCSogIEBleHRlbmQgRXZlbnREaXNwYXRjaGVyCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7T2JqZWN0fSBbb3B0aW9uc10gVGhlIG9wdGlvbnMgZm9yIGNyZWF0aW5nIHRoZSBhcHBsaWNhdGlvbgoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLmZwcz02MF0gVGhlIGZyYW1lcmF0ZSB0byB1c2UgZm9yIHJlbmRlcmluZyB0aGUgc3RhZ2UKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucmFmPXRydWVdIFVzZSByZXF1ZXN0IGFuaW1hdGlvbiBmcmFtZQoJKiAgQHBhcmFtIHtTdHJpbmd8aW50fSBbb3B0aW9ucy52ZXJzaW9uXSBUaGUgY3VycmVudCB2ZXJzaW9uIG51bWJlciBmb3IgeW91ciBhcHBsaWNhdGlvbi4gVGhpcyAKCSogICAgICAgbnVtYmVyIHdpbGwgYXV0b21hdGljYWxseSBiZSBhcHBlbmRlZCB0byBhbGwgZmlsZSByZXF1ZXN0cy4gRm9yIGluc3RhbmNlLCBpZiB0aGUgdmVyc2lvbgoJKiAgICAgICBpcyAiMC4wLjEiIGFsbCBmaWxlIHJlcXVlc3RzIHdpbGwgYmUgYXBwZW5kZWQgd2l0aCAiP3Y9MC4wLjEiCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMudmVyc2lvbnNGaWxlXSBQYXRoIHRvIGEgdGV4dCBmaWxlIHdoaWNoIGNvbnRhaW5zIGV4cGxpY2l0IHZlcnNpb24KCSoJCW51bWJlcnMgZm9yIGVhY2ggYXNzZXQuIFRoaXMgaXMgdXNlZnVsIGZvciBjb250cm9sbGluZyB0aGUgbGl2ZSBicm93c2VyIGNhY2hlLgoJKgkJRm9yIGluc3RhbmNlLCB0aGlzIHRleHQgZmlsZSB3b3VsZCBoYXZlIGFuIGFzc2V0IG9uIGVhY2ggbGluZSBmb2xsb3dlZCBieSBhIG51bWJlcjoKCSoJCWBhc3NldHMvY29uZmlnL2NvbmZpZy5qc29uIDJgIHRoaXMgd291bGQgbG9hZCBgYXNzZXRzL2NvbmZpZy9jb25maWcuanNvbj92PTJgCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLmNhY2hlQnVzdD1mYWxzZV0gT3ZlcnJpZGUgdGhlIGVuZC11c2VyIGJyb3dzZXIgY2FjaGUgYnkgYWRkaW5nICI/dj0iCgkqCQl0byB0aGUgZW5kIG9mIGVhY2ggZmlsZSBwYXRoIHJlcXVlc3RlZC4gVXNlIGZvciBkZXZlbG9wbWVudGx5LCBkZWJ1Z2dpbmcgb25seSEKCSogIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5iYXNlUGF0aF0gVGhlIG9wdGlvbmFsIGZpbGUgcGF0aCB0byBwcmVmaXggdG8gYW55IHJlbGF0aXZlIGZpbGUgcmVxdWVzdHMKCSoJCXRoaXMgaXMgYSBncmVhdCB3YXkgdG8gbG9hZCBhbGwgbG9hZCByZXF1ZXN0cyB3aXRoIGEgQ0ROIHBhdGguCgkqICBAcGFyYW0ge1N0cmluZ3xET01FbGVtZW50fFdpbmRvd30gW29wdGlvbnMucmVzaXplRWxlbWVudF0gVGhlIGVsZW1lbnQgdG8gcmVzaXplIHRoZSBjYW52YXMgdG8KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMudW5pZm9ybVJlc2l6ZT10cnVlXSBXaGV0aGVyIHRvIHJlc2l6ZSB0aGUgZGlzcGxheXMgdG8gdGhlIG9yaWdpbmFsIGFzcGVjdCByYXRpbwoJKiAgQHBhcmFtIHtOdW1iZXJ9IFtvcHRpb25zLm1heEFzcGVjdFJhdGlvXSBJZiBkb2luZyB1bmlmb3JtIHJlc2l6aW5nLCBvcHRpb25hbCBwYXJhbWV0ZXIgdG8gYWRkIGEgbWF4aW11bSBhc3BlY3QgcmF0aW8uCgkqICAgICAgICAgVGhpcyBhbGxvd3MgZm9yICJ0aXRsZS1zYWZlIiByZXNwb25zaXZlbmVzcy4gTXVzdCBiZSBncmVhdGVyIHRoYW4gdGhlIG9yaWdpbmFsIGFzcGVjdCByYXRpbyBvZiB0aGUgY2FudmFzLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5xdWVyeVN0cmluZ1BhcmFtZXRlcnM9ZmFsc2VdIFBhcnNlIHRoZSBxdWVyeSBzdHJpbmcgcGFyYW1lbnRlcnMgYXMgb3B0aW9ucwoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5kZWJ1Zz1mYWxzZV0gRW5hYmxlIHRoZSBEZWJ1ZyBjbGFzcwoJKiAgQHBhcmFtIHtpbnR9IFtvcHRpb25zLm1pbkxvZ0xldmVsPTBdIFRoZSBtaW5pbXVtIGxvZyBsZXZlbCB0byBzaG93IGRlYnVnIG1lc3NhZ2VzIGZvciBmcm9tIDAgKGdlbmVyYWwpIHRvIDQgKGVycm9yKSwKCSoJCXRoZSBgRGVidWdgIGNsYXNzIG11c3QgYmUgdXNlZCBmb3IgdGhpcyBmZWF0dXJlLgoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmRlYnVnUmVtb3RlXSBUaGUgaG9zdCBjb21wdXRlciBmb3IgcmVtb3RlIGRlYnVnZ2luZywKCSoJCXRoZSBkZWJ1ZyBtb2R1bGUgbXVzdCBiZSBpbmNsdWRlZCB0byB1c2UgdGhpcyBmZWF0dXJlLiBDYW4gYmUgYW4gSVAgYWRkcmVzcyBvciBob3N0IG5hbWUuCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnVwZGF0ZVR3ZWVuPWZhbHNlXSBJZiB1c2luZyBUd2VlbkpTLCB0aGUgQXBwbGljYXRpb24gd2lsbCB1cGRhdGUgdGhlIFR3ZWVuIGl0c2VsZgoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmNhbnZhc0lkXSBUaGUgZGVmYXVsdCBkaXNwbGF5IERPTSBJRCBuYW1lCgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBbb3B0aW9ucy5kaXNwbGF5XSBUaGUgbmFtZSBvZiB0aGUgY2xhc3MgdG8gaW5zdGFuaWF0ZSBhcyB0aGUgZGlzcGxheSAoZS5nLiBgc3ByaW5ncm9sbC5QaXhpRGlzcGxheWApCgkqICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnMuZGlzcGxheU9wdGlvbnNdIERpc3BsYXktc3BlY2lmaWMgb3B0aW9ucwoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jcm9zc09yaWdpbj1mYWxzZV0gVXNlZCBieSBgc3ByaW5ncm9sbC5QaXhpVGFza2AsIGRlZmF1bHQgYmVoYXZpb3IgaXMgdG8gbG9hZCBhc3NldHMgZnJvbSB0aGUgc2FtZSBkb21haW4uCgkqLwoJdmFyIEFwcGxpY2F0aW9uID0gZnVuY3Rpb24ob3B0aW9ucykKCXsKCQlpZiAoX2luc3RhbmNlKQoJCXsKCQkJdGhyb3cgIk9ubHkgb25lIEFwcGxpY2F0aW9uIGNhbiBiZSBvcGVuZWQgYXQgYSB0aW1lIjsKCQl9CgkJX2luc3RhbmNlID0gdGhpczsKCgkJRXZlbnREaXNwYXRjaGVyLmNhbGwodGhpcyk7CgoJCWlmKCFEZWJ1ZykKCQl7CgkJCURlYnVnID0gaW5jbHVkZSgnRGVidWcnKTsKCQkJTG9hZGVyID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5Mb2FkZXInKTsKCQkJVGltZVV0aWxzID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5UaW1lVXRpbHMnKTsKCQkJUGFnZVZpc2liaWxpdHkgPSBpbmNsdWRlKCdzcHJpbmdyb2xsLlBhZ2VWaXNpYmlsaXR5Jyk7CgkJfQoKCQkvKioKCQkqICBJbml0aWFsaXphdGlvbiBvcHRpb25zL3F1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzLCB0aGVzZSBwcm9wZXJ0aWVzIGFyZSByZWFkLW9ubHkKCQkqICBBcHBsaWNhdGlvbiBwcm9wZXJ0aWVzIGxpa2UgcmFmLCBmcHMsIGRvbid0IGhhdmUgYW55IGFmZmVjdCBvbiB0aGUgb3B0aW9ucyBvYmplY3QuCgkJKiAgQHByb3BlcnR5IHtPYmplY3R9IG9wdGlvbnMKCQkqICBAcmVhZE9ubHkKCQkqLwoJCXRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCS8qKgoJCSogIFByaW1hcnkgcmVuZGVyZXIgZm9yIHRoZSBhcHBsaWNhdGlvbiwgZm9yIHNpbXBseSBhY2Nlc3NpbmcgQXBwbGljYXRpb24uaW5zdGFuY2UuZGlzcGxheS5zdGFnZTsKCQkqICBUaGUgZmlyc3QgZGlzcGxheSBhZGRlZCBiZWNvbWVzIHRoZSBwcmltYXJ5IGRpc3BsYXkgYXV0b21hdGljYWxseS4KCQkqICBAcHJvcGVydHkge0Rpc3BsYXl9IGRpc3BsYXkKCQkqICBAcHVibGljCgkJKi8KCQl0aGlzLmRpc3BsYXkgPSBudWxsOwoKCQkvKioKCQkqICBJZiB3ZSBzaG91bGQgd2FpdCB0byBpbml0IHRoZSBBcHBsaWNhdGlvbiwgdGhpcyBpcyB1c2VmdWwgaXMgc29tZXRoaW5nIGlzIGluaGVyaXRpbmcKCQkqICBBcHBsaWNhdGlvbiBidXQgd2FudCB0byBkbyBzb21lIGV4dHJhIHN0dWZmIGJlZm9yZSBpbml0IGlzIGFjdHVhbGx5IGNhbGxlZC4KCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZWFkeVRvSW5pdAoJCSogIEBwcm90ZWN0ZWQKCQkqLwoJCXRoaXMuX3JlYWR5VG9Jbml0ID0gdHJ1ZTsKCgkJX2Rpc3BsYXlzID0ge307CgkJX3RpY2tDYWxsYmFjayA9IHRoaXMuX3RpY2suYmluZCh0aGlzKTsKCgkJLy9vdGhlciBpbml0aWFsaXphdGlvbiBzdHVmZiB0b28KCQkvL2lmIHRoZXJlIGFyZSBzb21lIHNwZWNpZmljIHByb3BlcnRpZXMgb24gdGhlIG9wdGlvbnMsIHVzZSB0aGVtIHRvIG1ha2UgYSBkaXNwbGF5CgkJLy9jYWxsIGluaXQgYWZ0ZXIgaGFuZGxpbmcgbG9hZGluZyB1cCBhIHZlcnNpb25zIGZpbGUgb3IgYW55IG90aGVyIG5lZWRlZCBhc3luY2hyb25vdXMgc3R1ZmY/CgkJdGhpcy5faW50ZXJuYWxJbml0KCk7Cgl9OwoKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlCgl2YXIgcyA9IEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGU7Cgl2YXIgcCA9IEFwcGxpY2F0aW9uLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUocyk7CgoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBmdW5jdGlvbiByZWZlcmVuY2VzIHRvIGNhbGwgd2hlbiBpbml0aWFsaXppbmcgdGhlIGFwcGxpY2F0aW9uCgkqICB0aGVzZSBhcmUgcmVnaXN0ZXJlZCBieSBleHRlcm5hbCBsaWJyYXJpZXMgdGhhdCBuZWVkIHRvIHNldHVwLCBkZXN0cm95ZWQKCSogIGZvciBpbnN0YW5jZSBMb2FkZXIKCSogIEBwcm9wZXJ0eSB7QXJyYXl9IF9nbG9iYWxJbml0CgkqICBAcHJpdmF0ZQoJKiAgQHN0YXRpYwoJKi8KCUFwcGxpY2F0aW9uLl9nbG9iYWxJbml0ID0gW107CgoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBmdW5jdGlvbiByZWZlcmVuY2VzIHRvIGNhbGwgd2hlbiBkZXN0cm95aW5nIHRoZSBhcHBsaWNhdGlvbgoJKiAgdGhlc2UgYXJlIHJlZ2lzdGVyZWQgYnkgZXh0ZXJuYWwgbGlicmFyaWVzIHRoYXQgbmVlZCB0byBzZXR1cCwgZGVzdHJveWVkCgkqICBmb3IgaW5zdGFuY2UgTG9hZGVyCgkqICBAcHJvcGVydHkge0FycmF5fSBfZ2xvYmFsRGVzdHJveQoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSovCglBcHBsaWNhdGlvbi5fZ2xvYmFsRGVzdHJveSA9IFtdOwoKCS8qKgoJKiAgVGhlIGZyYW1lIHJhdGUgb2JqZWN0CgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtET01PYmplY3R9IF9mcmFtZXJhdGUKCSovCgl2YXIgX2ZyYW1lcmF0ZSA9IG51bGwsCgkKCS8qKgoJKiAgVGhlIG51bWJlciBvZiBtcyBzaW5jZSB0aGUgbGFzdCBmcmFtZSB1cGRhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gX2xhc3RGcmFtZVRpbWUKCSovCglfbGFzdEZyYW1lVGltZSA9IDAsCgkKCS8qKgoJKiAgVGhlIGxhc3QgdGltZSBzaW5jZSB0aGUgbGFzdCBmcHMgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9sYXN0RlBTVXBkYXRlVGltZQoJKi8KCV9sYXN0RlBTVXBkYXRlVGltZSA9IDAsCgkKCS8qKgoJKiAgVGhlIG51bWJlciBvZiBmcmFtZXMgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfZnJhbWVDb3VudAoJKi8KCV9mcmFtZUNvdW50ID0gMCwKCgkvKioKCSoJVGhlIGJvdW5kIGNhbGxiYWNrIGZvciBsaXN0ZW5pbmcgdG8gdGljayBldmVudHMKCSoJQHByaXZhdGUKCSogICBAcHJvcGVydHkge0Z1bmN0aW9ufSBfdGlja0NhbGxiYWNrCgkqLwoJX3RpY2tDYWxsYmFjayA9IG51bGwsCgoJLyoqCgkqICBJZiB0aGUgY3VycmVudCBhcHBsaWNhdGlvbiBpcyBwYXVzaGVkCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfcGF1c2VkCgkqLwoJX3BhdXNlZCA9IGZhbHNlLAoKCS8qKgoJKiAgVGhlIGlkIG9mIHRoZSBhY3RpdmUgcmVxdWVzdEFuaW1hdGlvbkZyYW1lIG9yIHNldFRpbWVvdXQgY2FsbC4KCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBfdGlja0lkCgkqICBAcHJpdmF0ZQoJKi8KCV90aWNrSWQgPSAtMSwKCgkvKioKCSogIElmIHJlcXVlc3Rpb25BbmltYXRpb25GcmFtZSBzaG91bGQgYmUgdXNlZAoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Qm9vbH0gX3VzZVJBRgoJKiAgQGRlZmF1bHQgZmFsc2UKCSovCglfdXNlUkFGID0gZmFsc2UsCgoJLyoqCgkqICBUaGUgY3VycmVudCBpbnRlcm5hbCBmcmFtZXMgcGVyIHNlY29uZAoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IF9mcHMKCSogIEBwcml2YXRlCgkqICBAZGVmYXVsdCAwCgkqLwoJX2ZwcyA9IDAsCgoJLyoqCgkqIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHBlciBmcmFtZQoJKiBAcHJvcGVydHkge2ludH0gX21zUGVyRnJhbWUKCSogQHByaXZhdGUKCSovCglfbXNQZXJGcmFtZSA9IDAsCgoJLyoqCgkqICBEb20gZWxlbWVudCAob3IgdGhlIHdpbmRvdykgdG8gYXR0YWNoIHJlc2l6ZSBsaXN0ZW5lcnMgYW5kIHJlYWQgdGhlIHNpemUgZnJvbQoJKiAgQHByb3BlcnR5IHtET01FbGVtZW50fFdpbmRvd3xudWxsfSBfcmVzaXplRWxlbWVudAoJKiAgQHByaXZhdGUKCSogIEBkZWZhdWx0IG51bGwKCSovCglfcmVzaXplRWxlbWVudCA9IG51bGwsCgoJLyoqCgkqICBUaGUgYXNwZWN0IHJhdGlvIG9mIHRoZSBwcmltYXJ5IGRpc3BsYXksIGFzIHdpZHRoIC8gaGVpZ2h0LgoJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IF9hc3BlY3RSYXRpbwoJKiAgQHByaXZhdGUKCSovCglfYXNwZWN0UmF0aW8gPSAwLAoKCS8qKgoJKiAgQSBQYWdlVmlzaWJpbGl0eSBvYmplY3QgdG8gYXV0b21hdGljYWxseSBwYXVzZSBBcHBsaWNhdGlvbiB3aGVuIHRoZSBwYWdlIGlzIGhpZGRlbi4KCSogIEBwcm9wZXJ0eSB7UGFnZVZpc2liaWxpdHl9IF9wYWdlVmlzaWJpbGl0eQoJKiAgQHByaXZhdGUKCSovCglfcGFnZVZpc2liaWxpdHkgPSBudWxsLAoKCgkvKioKCSogIFJlbmRlcmluZyBwbHVnaW5zLCBpbiBhIGRpY3Rpb25hcnkgYnkgY2FudmFzIGlkCgkqICBAcHJvcGVydHkge2RpY3Rpb25hcnl9IF9kaXNwbGF5cwoJKiAgQHByaXZhdGUKCSovCglfZGlzcGxheXMgPSBudWxsLAoKCS8qKgoJKiAgRGVmYXVsdCBpbml0aWFsaXphdGlvbiBvcHRpb25zLgoJKiAgQHByb3BlcnR5IHtkaWN0aW9uYXJ5fSBfZGVmYXVsdE9wdGlvbnMKCSogIEBwcml2YXRlCgkqLwoJX2RlZmF1bHRPcHRpb25zID0KCXsKCQkvL2FwcGxpY2F0aW9uIHByb3BlcnRpZXMKCQlyYWY6IHRydWUsCgkJZnBzOiA2MCwKCQlyZXNpemVFbGVtZW50OiBudWxsLAoJCXVuaWZvcm1SZXNpemU6IHRydWUsCgkJcXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBmYWxzZSwKCQlkZWJ1ZzogZmFsc2UsCgkJbWluTG9nTGV2ZWw6IDAsCgkJaXA6IG51bGwsCgkJLy9kZWZhdWx0IGRpc3BsYXkgcHJvcGVydGllcwoJCWNhbnZhc0lkOiBudWxsLAoJCWRpc3BsYXk6IG51bGwsCgkJZGlzcGxheU9wdGlvbnM6IG51bGwsCgkJdXBkYXRlVHdlZW46IGZhbHNlCgl9LAoKCS8qKgoJKiAgQSBoZWxwZXIgb2JqZWN0IHRvIGF2b2lkIG9iamVjdCBjcmVhdGlvbiBlYWNoIHJlc2l6ZSBldmVudC4KCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBfcmVzaXplSGVscGVyCgkqICBAcHJpdmF0ZQoJKi8KCV9yZXNpemVIZWxwZXIgPSB7IHdpZHRoOiAwLCBoZWlnaHQ6IDB9LAoKCS8qKgoJKiAgRmlyZWQgd2hlbiBpbml0aWFsaXphdGlvbiBvZiB0aGUgYXBwbGljYXRpb24gaXMgZG9uZQoJKiAgQGV2ZW50IGluaXQKCSovCglJTklUID0gJ2luaXQnLAoKCS8qKgoJKiAgRXZlbnQgd2hlbiBldmVyeXRoaW5nJ3MgZG9uZSBidXQgd2UgaGF2ZW4ndCBhY3R1YWxseSBpbml0ZWQKCSogIEBldmVudCBwcmVJbml0CgkqICBAcHJvdGVjdGVkCgkqLwoJQkVGT1JFX0lOSVQgPSAnYmVmb3JlSW5pdCcsCgoJLyoqCgkqICBGaXJlZCB3aGVuIGFuIHVwZGF0ZSBpcyBjYWxsZWQsIGV2ZXJ5IGZyYW1lIHVwZGF0ZQoJKiAgQGV2ZW50IHVwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXNwZWQgVGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgc2luY2UgdGhlIGxhc3QgZnJhbWUgdXBkYXRlCgkqLwoJVVBEQVRFID0gJ3VwZGF0ZScsCgoJLyoqCgkqICBGaXJlZCB3aGVuIGEgcmVzaXplIGlzIGNhbGxlZAoJKiAgQGV2ZW50IHJlc2l6ZQoJKiAgQHBhcmFtIHtpbnR9IHdpZHRoIFRoZSB3aWR0aCBvZiB0aGUgcmVzaXplIGVsZW1lbnQKCSogIEBwYXJhbSB7aW50fSBoZWlnaHQgVGhlIGhlaWdodCBvZiB0aGUgcmVzaXplIGVsZW1lbnQKCSovCglSRVNJWkUgPSAncmVzaXplJywKCgkvKioKCSogIEZpcmVkIHdoZW4gdGhlIHBhdXNlIHN0YXRlIGlzIHRvZ2dsZWQKCSogIEBldmVudCBwYXVzZQoJKiAgQHBhcmFtIHtib29sZWFufSBwYXVzZWQgSWYgdGhlIGFwcGxpY2F0aW9uIGlzIG5vdyBwYXVzZWQKCSovCglQQVVTRSA9ICdwYXVzZScsCgoJLyoqCgkqICBGaXJlZCB3aGVuIHRoZSBhcHBsaWNhdGlvbiBiZWNvbWVzIHBhdXNlZAoJKiAgQGV2ZW50IHBhdXNlZAoJKi8KCVBBVVNFRCA9ICdwYXVzZWQnLAoKCS8qKgoJKiAgRmlyZWQgd2hlbiB0aGUgYXBwbGljYXRpb24gcmVzdW1lcyBmcm9tIGEgcGF1c2VkIHN0YXRlCgkqICBAZXZlbnQgcmVzdW1lZAoJKi8KCVJFU1VNRUQgPSAncmVzdW1lZCcsCgoJLyoqCgkqICBGaXJlZCB3aGVuIHRoZSBhcHBsaWNhdGlvbiBpcyBkZXN0cm95ZWQKCSogIEBldmVudCBkZXN0cm95CgkqLwoJREVTVFJPWSA9ICdkZXN0cm95JzsKCgkvKioKCSogIExpYnJhcmllcyB3b3VsZCByZWdpc3RlciBnbG9iYWwgaW5pdGlhbGl6YXRpb24gZnVuY3Rpb25zIHdoZW4gdGhleSBhcmUgY3JlYXRlZCwgZS5nLgoJKiAgQXBwbGljYXRpb24ucmVnaXN0ZXJJbml0KExvYWRlci5pbml0KTsKCSogIEBtZXRob2QgcmVnaXN0ZXJJbml0CgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqLwoJQXBwbGljYXRpb24ucmVnaXN0ZXJJbml0ID0gZnVuY3Rpb24oZnVuYykKCXsKCQlBcHBsaWNhdGlvbi5fZ2xvYmFsSW5pdC5wdXNoKGZ1bmMpOwoJfTsKCS8qKgoJKiAgTGlicmFyaWVzIHdvdWxkIHJlZ2lzdGVyIGdsb2JhbCBkZXN0cm95IGZ1bmN0aW9ucyB3aGVuIHRoZXkgYXJlIGNyZWF0ZWQgb3IgaW5pdGlhbGl6ZWQsIGUuZy4KCSogIEFwcGxpY2F0aW9uLnJlZ2lzdGVySW5pdChMb2FkZXIuaW5zdGFuY2UuZGVzdHJveS5iaW5kKExvYWRlci5pbnN0YW5jZSkpOwoJKiAgQG1ldGhvZCByZWdpc3RlckRlc3Ryb3kKCSogIEBwYXJhbSB7RnVuY3Rpb259IGZ1bmMKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglBcHBsaWNhdGlvbi5yZWdpc3RlckRlc3Ryb3kgPSBmdW5jdGlvbihmdW5jKQoJewoJCUFwcGxpY2F0aW9uLl9nbG9iYWxEZXN0cm95LnB1c2goZnVuYyk7Cgl9OwoKCS8qKgoJKiAgR2V0IHRoZSBzaW5nbGV0b24gaW5zdGFuY2Ugb2YgdGhlIGFwcGxpY2F0aW9uCgkqICBAcHJvcGVydHkge0FwcGxpY2F0aW9ufSBpbnN0YW5jZQoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKi8KCXZhciBfaW5zdGFuY2UgPSBudWxsOwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KEFwcGxpY2F0aW9uLCAiaW5zdGFuY2UiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIF9pbnN0YW5jZTsKCQl9Cgl9KTsKCgkvKioKCSogIFRoZSBpbnRlcm5hbCBpbml0aWFsaXphdGlvbgoJKiAgQG1ldGhvZCBfaW50ZXJuYWxJbml0CgkqICBAcHJpdmF0ZQoJKi8KCXAuX2ludGVybmFsSW5pdCA9IGZ1bmN0aW9uKCkKCXsKCQkvL2dyYWIgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzIGlmIHdlIHNob3VsZCBiZSBkb2luZyBzbwoJCXZhciBxdWVyeSA9ICEhdGhpcy5vcHRpb25zLnBhcnNlUXVlcnlTdHJpbmcgPyBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zKCkgOiB7fTsKCQkKCQkvLyBBc3NlbWJsZSBhbGwgb2YgdGhlIG9wdGlvbnMsIHRoZSBsYXN0IHRha2VzIHByZWNlZGVuY2UKCQl0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2Uoe30sIF9kZWZhdWx0T3B0aW9ucywgdGhpcy5vcHRpb25zLCBxdWVyeSk7CgoJCS8vIENhbGwgYW55IGdsb2JhbCBsaWJyYXJpZXMgdG8gaW5pdGlhbGl6ZQoJCWZvcih2YXIgaSA9IDA7IGkgPCBBcHBsaWNhdGlvbi5fZ2xvYmFsSW5pdC5sZW5ndGg7ICsraSkKCQl7CgkJCUFwcGxpY2F0aW9uLl9nbG9iYWxJbml0W2ldKCk7CgkJfQoKCQlfdXNlUkFGID0gdGhpcy5vcHRpb25zLnJhZjsKCQl0aGlzLmZwcyA9IHRoaXMub3B0aW9ucy5mcHM7CgkJdmFyIGZyYW1lcmF0ZSA9IHRoaXMub3B0aW9ucy5mcmFtZXJhdGU7CgkJaWYoZnJhbWVyYXRlKQoJCXsKCQkJaWYodHlwZW9mIGZyYW1lcmF0ZSA9PSAic3RyaW5nIikKCQkJCV9mcmFtZXJhdGUgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmcmFtZXJhdGUpOwoJCQllbHNlCgkJCQlfZnJhbWVyYXRlID0gZnJhbWVyYXRlOwoJCX0KCQl2YXIgcmVzaXplRWxlbWVudCA9IHRoaXMub3B0aW9ucy5yZXNpemVFbGVtZW50OwoJCWlmKHJlc2l6ZUVsZW1lbnQpCgkJewoJCQlpZih0eXBlb2YgcmVzaXplRWxlbWVudCA9PSAic3RyaW5nIikKCQkJCV9yZXNpemVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQocmVzaXplRWxlbWVudCk7CgkJCWVsc2UKCQkJCV9yZXNpemVFbGVtZW50ID0gcmVzaXplRWxlbWVudDsKCQkJdGhpcy50cmlnZ2VyUmVzaXplID0gdGhpcy50cmlnZ2VyUmVzaXplLmJpbmQodGhpcyk7CgkJCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJyZXNpemUiLCB0aGlzLnRyaWdnZXJSZXNpemUpOwoJCX0KCgkJLy8gVHVybiBvbiBkZWJ1Z2dpbmcKCQlpZiAodGhpcy5vcHRpb25zLmRlYnVnICE9PSB1bmRlZmluZWQpCgkJCURlYnVnLmVuYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGVidWcgPT09IHRydWUgfHwgdGhpcy5vcHRpb25zLmRlYnVnID09PSAidHJ1ZSI7CgkJCgkJaWYgKHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5taW5Mb2dMZXZlbCA9IHBhcnNlSW50KHRoaXMub3B0aW9ucy5taW5Mb2dMZXZlbCwgMTApOwoKCQkvL2lmIHdlIHdlcmUgc3VwcGxpZWQgd2l0aCBhbiBJUCBhZGRyZXNzLCBjb25uZWN0IHRvIGl0IHdpdGggdGhlIERlYnVnIGNsYXNzIGZvciBsb2dnaW5nCgkJaWYodHlwZW9mIHRoaXMub3B0aW9ucy5kZWJ1Z1JlbW90ZSA9PSAic3RyaW5nIikKCQkJRGVidWcuY29ubmVjdCh0aGlzLm9wdGlvbnMuZGVidWdSZW1vdGUpOwoKCQkvLyBJZiB0d2VlbiBhbmQvb3IgdGlja2VyIGFyZSBpbmNsdWRlZAoJCXZhciBUd2VlbiA9IGluY2x1ZGUoJ2NyZWF0ZWpzLlR3ZWVuJywgZmFsc2UpLAoJCQlUaWNrZXIgPSBpbmNsdWRlKCdjcmVhdGVqcy5UaWNrZXInLCBmYWxzZSk7CgoJCS8vIEFkZCBhbiBvcHRpb24gdG8gaGF2ZSB0aGUgYXBwbGljYXRpb24gY29udHJvbCB0aGUgVHdlZW4gdGljawoJCWlmIChUd2VlbiAmJiB0aGlzLm9wdGlvbnMudXBkYXRlVHdlZW4pCgkJewoJCQlpZiAoVGlja2VyKQoJCQl7CgkJCQlUaWNrZXIuc2V0UGF1c2VkKHRydWUpOwoJCQl9CgkJCXRoaXMub24oJ3VwZGF0ZScsIFR3ZWVuLnRpY2spOwoJCX0KCQkKCQkvL3NldCB1cCB0aGUgcGFnZSB2aXNpYmlsaXR5IGxpc3RlbmVyCgkJX3BhZ2VWaXNpYmlsaXR5ID0gbmV3IFBhZ2VWaXNpYmlsaXR5KHRoaXMuX29uVmlzaWJsZS5iaW5kKHRoaXMpLCB0aGlzLl9vbkhpZGRlbi5iaW5kKHRoaXMpKTsKCgkJaWYodGhpcy5vcHRpb25zLmNhbnZhc0lkICYmIHRoaXMub3B0aW9ucy5kaXNwbGF5KQoJCQl0aGlzLmFkZERpc3BsYXkodGhpcy5vcHRpb25zLmNhbnZhc0lkLCB0aGlzLm9wdGlvbnMuZGlzcGxheSwgdGhpcy5vcHRpb25zLmRpc3BsYXlPcHRpb25zKTsKCgoJCS8vIEJpbmQgdGhlIGRvIGluaXQKCQl0aGlzLl9kb0luaXQgPSB0aGlzLl9kb0luaXQuYmluZCh0aGlzKTsKCgkJLy8gQ2hlY2sgdG8gc2VlIGlmIHdlIHNob3VsZCBsb2FkIGEgdmVyc2lvbnMgZmlsZQoJCS8vIFRoZSB2ZXJzaW9ucyBmaWxlIGtlZXBzIHRyYWNrIG9mIGZpbGUgdmVyc2lvbnMgdG8gYXZvaWQgY2FjaGUgaXNzdWVzCgkJaWYgKHRoaXMub3B0aW9ucy52ZXJzaW9uc0ZpbGUgIT09IHVuZGVmaW5lZCkKCQl7CgkJCS8vIFRyeSB0byBsb2FkIHRoZSBkZWZhdWx0IHZlcnNpb25zIGZpbGUKCQkJLy8gY2FsbGJhY2sgc2hvdWxkIGJlIG1hZGUgd2l0aCBhIHNjb3BlIGluIG1pbmQKCQkJTG9hZGVyLmluc3RhbmNlLmNhY2hlTWFuYWdlci5hZGRWZXJzaW9uc0ZpbGUoCgkJCQl0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlLAoJCQkJdGhpcy5fZG9Jbml0CgkJCSk7CgkJfQoJCWVsc2UKCQl7CgkJCS8vIFdhaXQgdW50aWwgdGhlIG5leHQgZXhlY3V0aW9uIHNlcXVlbmNlCgkJCS8vIHNvIHRoYXQgaW5pdCBjYW4gYmUgYWRkZWQgYWZ0ZXIgY29uc3RydWN0aW9uCgkJCXNldFRpbWVvdXQodGhpcy5fZG9Jbml0LCAwKTsKCQl9Cgl9OwoKCS8qKgoJKiAgSW5pdGlhbGl6ZSB0aGUgYXBwbGljYXRpb24KCSogIEBtZXRob2QgX2RvSW5pdAoJKiAgQHByb3RlY3RlZAoJKi8KCXAuX2RvSW5pdCA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLnRyaWdnZXIoQkVGT1JFX0lOSVQpOwoKCQkvLyBJZiBhIHN1Yi1jbGFzcyB3aWxsIG1hbnVhbGx5IHRyeSB0byBpbml0IGxhdGVyIG9uCgkJaWYgKCF0aGlzLl9yZWFkeVRvSW5pdCkgcmV0dXJuOwoKCQkvLyBDYWxsIHRoZSBpbml0IGZ1bmN0aW9uCgkJaWYgKHRoaXMuaW5pdCkgdGhpcy5pbml0KCk7CgoJCS8vZG8gYW4gaW5pdGlhbCByZXNpemUgdG8gbWFrZSBzdXJlIGV2ZXJ5dGhpbmcgaXMgc2l6ZWQgcHJvcGVybHkKCQl0aGlzLnRyaWdnZXJSZXNpemUoKTsKCgkJLy9zdGFydCB1cGRhdGUgbG9vcAoJCXRoaXMucGF1c2VkID0gZmFsc2U7CgoJCS8vIERpc3BhdGNoIHRoZSBpbml0IGV2ZW50CgkJdGhpcy50cmlnZ2VyKElOSVQpOwoJfTsKCgkvKioKCSogIERlZmluZSBhbGwgb2YgdGhlIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zCgkqICBAcmV0dXJuIHtvYmplY3R9IFRoZSBvYmplY3QgcmVmZXJlbmNlIHRvIHVwZGF0ZQoJKi8KCXZhciBwYXJzZVF1ZXJ5U3RyaW5nUGFyYW1zID0gZnVuY3Rpb24oKQoJewoJCXZhciBvdXRwdXQgPSB7fTsKCQl2YXIgaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5zZWFyY2g7CgkJaWYoIWhyZWYpLy9lbXB0eSBzdHJpbmcgaXMgZmFsc2UKCQkJcmV0dXJuIG91dHB1dDsKCQl2YXIgdmFycyA9IGhyZWYuc3Vic3RyKGhyZWYuaW5kZXhPZigiPyIpKzEpOwoJCXZhciBwb3VuZCA9IHZhcnMuaW5kZXhPZignIycpOwoJCXZhcnMgPSBwb3VuZCA8IDAgPyB2YXJzIDogdmFycy5zdWJzdHJpbmcoMCwgcG91bmQpOwoJCXZhciBzcGxpdEZsYXNoVmFycyA9IHZhcnMuc3BsaXQoIiYiKTsKCQl2YXIgbXlWYXI7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCBzcGxpdEZsYXNoVmFycy5sZW5ndGg7IGkrKykKCQl7CgkJCW15VmFyID0gc3BsaXRGbGFzaFZhcnNbaV0uc3BsaXQoIj0iKTsKCQkJaWYgKHRydWUpCgkJCXsKCQkJCURlYnVnLmxvZyhteVZhclswXSArICIgLT4gIiArIG15VmFyWzFdKTsKCQkJfQoJCQlvdXRwdXRbbXlWYXJbMF1dID0gbXlWYXJbMV07CgkJfQoJCXJldHVybiBvdXRwdXQ7Cgl9OwoKCS8qKgoJKiAgT3ZlcnJpZGUgdGhpcyB0byBkbyBwb3N0IGNvbnN0cnVjdG9yIGluaXRpYWxpemF0aW9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBwcm90ZWN0ZWQKCSovCglwLmluaXQgPSBudWxsOwoKCS8qKgoJKiAgUHJpdmF0ZSBsaXN0ZW5lciBmb3Igd2hlbiB0aGUgcGFnZSBpcyBoaWRkZW4uCgkqICBAbWV0aG9kIF9vbkhpZGRlbgoJKiAgQHByaXZhdGUKCSovCglwLl9vbkhpZGRlbiA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLnBhdXNlZCA9IHRydWU7Cgl9OwoKCS8qKgoJKiAgUHJpdmF0ZSBsaXN0ZW5lciBmb3Igd2hlbiB0aGUgcGFnZSBpcyBzaG93bi4KCSogIEBtZXRob2QgX29uVmlzaWJsZQoJKiAgQHByaXZhdGUKCSovCglwLl9vblZpc2libGUgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5wYXVzZWQgPSBmYWxzZTsKCX07CgoJLyoqCgkqICBQYXVzZSB1cGRhdGVzIGF0IHRoZSBhcHBsaWNhdGlvbiBsZXZlbAoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBwYXVzZWQKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInBhdXNlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkKCQl7CgkJCXJldHVybiBfcGF1c2VkOwoJCX0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCV9wYXVzZWQgPSAhIXZhbHVlOwoJCQl0aGlzLnRyaWdnZXIoUEFVU0UsIF9wYXVzZWQpOwoJCQl0aGlzLnRyaWdnZXIoX3BhdXNlZCA/IFBBVVNFRCA6IFJFU1VNRUQsIF9wYXVzZWQpOwoKCQkJaWYoX3BhdXNlZCkKCQkJewoJCQkJaWYoX3RpY2tJZCAhPSAtMSkKCQkJCXsKCQkJCQlpZihfdXNlUkFGKQoJCQkJCXsKCQkJCQkJY2FuY2VsQW5pbWF0aW9uRnJhbWUoX3RpY2tJZCk7CgkJCQkJfQoJCQkJCWVsc2UKCQkJCQkJY2xlYXJUaW1lb3V0KF90aWNrSWQpOwoJCQkJCV90aWNrSWQgPSAtMTsKCQkJCX0KCQkJfQoJCQllbHNlCgkJCXsKCQkJCWlmKF90aWNrSWQgPT0gLTEpCgkJCQl7CgkJCQkJX3RpY2tJZCA9IF91c2VSQUYgPwoJCQkJCQlyZXF1ZXN0QW5pbUZyYW1lKF90aWNrQ2FsbGJhY2spOgoJCQkJCQlzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjayk7CgkJCQl9CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBfbGFzdEZyYW1lVGltZSA9IFRpbWVVdGlscy5ub3coKTsKCQkJfQoJCX0KCX0pOwoKCS8qKgoJKiAgTWFrZXMgYSBzZXRUaW1lb3V0IHdpdGggYSB0aW1lIGJhc2VkIG9uIF9tc1BlckZyYW1lIGFuZCB0aGUgYW1vdW50IG9mIHRpbWUgc3BlbnQgaW4gdGhlCgkqICBjdXJyZW50IHRpY2suCgkqICBAbWV0aG9kIHNldFRhcmdldGVkVGltZW91dAoJKiAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgVGhlIHRpY2sgZnVuY3Rpb24gdG8gY2FsbC4KCSogIEBwYXJhbSB7aW50fSB0aW1lSW5GcmFtZT0wIFRoZSBhbW91bnQgb2YgdGltZSBzcGVudCBpbiB0aGUgY3VycmVudCB0aWNrIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwcml2YXRlCgkqLwoJdmFyIHNldFRhcmdldGVkVGltZW91dCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB0aW1lSW5GcmFtZSkKCXsKCQl2YXIgdGltZVRvQ2FsbCA9IF9tc1BlckZyYW1lOwoJCS8vc3VidHJhY3QgdGhlIHRpbWUgc3BlbnQgaW4gdGhlIGZyYW1lIHRvIGFjdHVhbGx5IGhpdCB0aGUgdGFyZ2V0IGZwcwoJCWlmKHRpbWVJbkZyYW1lKQoJCQl0aW1lVG9DYWxsID0gTWF0aC5tYXgoMCwgX21zUGVyRnJhbWUgLSB0aW1lSW5GcmFtZSk7CgkJcmV0dXJuIHNldFRpbWVvdXQoY2FsbGJhY2ssIHRpbWVUb0NhbGwpOwoJfTsKCgkvKioKCSogIEZpcmUgYSByZXNpemUgZXZlbnQgd2l0aCB0aGUgY3VycmVudCB3aWR0aCBhbmQgaGVpZ2h0IG9mIHRoZSBkaXNwbGF5CgkqICBAbWV0aG9kIHRyaWdnZXJSZXNpemUKCSovCglwLnRyaWdnZXJSZXNpemUgPSBmdW5jdGlvbigpCgl7CgkJaWYoIV9yZXNpemVFbGVtZW50KSByZXR1cm47CgoJCS8vIHdpbmRvdyB1c2VzIGlubmVyV2lkdGgsIERPTSBlbGVtZW50cyBjbGllbnRXaWR0aAoJCV9yZXNpemVIZWxwZXIud2lkdGggPSAoX3Jlc2l6ZUVsZW1lbnQuaW5uZXJXaWR0aCB8fCBfcmVzaXplRWxlbWVudC5jbGllbnRXaWR0aCkgfCAwOwoJCV9yZXNpemVIZWxwZXIuaGVpZ2h0ID0gKF9yZXNpemVFbGVtZW50LmlubmVySGVpZ2h0IHx8IF9yZXNpemVFbGVtZW50LmNsaWVudEhlaWdodCkgfCAwOwoKCQl0aGlzLmNhbGN1bGF0ZURpc3BsYXlTaXplKF9yZXNpemVIZWxwZXIpOwoJCQoJCS8vcm91bmQgZG93biwgYXMgY2FudmFzZXMgcmVxdWlyZSBpbnRlZ2VyIHNpemVzCgkJX3Jlc2l6ZUhlbHBlci53aWR0aCB8PSAwOwoJCV9yZXNpemVIZWxwZXIuaGVpZ2h0IHw9IDA7CgoJCS8vcmVzaXplIHRoZSBkaXNwbGF5cwoJCWZvcih2YXIga2V5IGluIF9kaXNwbGF5cykKCQl7CgkJCV9kaXNwbGF5c1trZXldLnJlc2l6ZShfcmVzaXplSGVscGVyLndpZHRoLCBfcmVzaXplSGVscGVyLmhlaWdodCk7CgkJfQoJCS8vc2VuZCBvdXQgdGhlIHJlc2l6ZSBldmVudAoJCXRoaXMudHJpZ2dlcihSRVNJWkUsIF9yZXNpemVIZWxwZXIud2lkdGgsIF9yZXNpemVIZWxwZXIuaGVpZ2h0KTsKCX07CgoJLyoqCgkqICBDYWxjdWxhdGVzIHRoZSByZXNpemluZyBvZiBkaXNwbGF5cy4gQnkgZGVmYXVsdCwgdGhpcyBsaW1pdHMgdGhlIG5ldyBzaXplCgkqICB0byB0aGUgaW5pdGlhbCBhc3BlY3QgcmF0aW8gb2YgdGhlIHByaW1hcnkgZGlzcGxheS4gT3ZlcnJpZGUgdGhpcyBmdW5jdGlvbgoJKiAgaWYgeW91IG5lZWQgdmFyaWFibGUgYXNwZWN0IHJhdGlvcy4KCSogIEBtZXRob2QgY2FsY3VsYXRlRGlzcGxheVNpemUKCSogIEBwcm90ZWN0ZWQKCSogIEBwYXJhbSB7T2JqZWN0fSBzaXplIEEgc2l6ZSBvYmplY3QgY29udGFpbmluZyB0aGUgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgcmVzaXplZCBjb250YWluZXIuCgkqIAkJCQlUaGUgc2l6ZSBwYXJhbWV0ZXIgaXMgYWxzbyB0aGUgb3V0cHV0IG9mIHRoZSBmdW5jdGlvbiwgc28gdGhlIHNpemUgcHJvcGVydGllcyBhcmUgZWRpdGVkIGluIHBsYWNlLgoJKiAgQHBhcmFtIHtpbnR9IHNpemUud2lkdGggVGhlIHdpZHRoIG9mIHRoZSByZXNpemVkIGNvbnRhaW5lci4KCSogIEBwYXJhbSB7aW50fSBzaXplLmhlaWdodCBUaGUgaGVpZ2h0IG9mIHRoZSByZXNpemVkIGNvbnRhaW5lci4KCSovCglwLmNhbGN1bGF0ZURpc3BsYXlTaXplID0gZnVuY3Rpb24oc2l6ZSkKCXsKCQlpZiAoIV9hc3BlY3RSYXRpbyB8fCAhdGhpcy5vcHRpb25zLnVuaWZvcm1SZXNpemUpIHJldHVybjsKCgkJdmFyIG1heEFzcGVjdFJhdGlvID0gdGhpcy5vcHRpb25zLm1heEFzcGVjdFJhdGlvIHx8IF9hc3BlY3RSYXRpbywKCQkJY3VycmVudEFzcGVjdCA9IHNpemUud2lkdGggLyBzaXplLmhlaWdodDsKCgkJaWYgKGN1cnJlbnRBc3BlY3QgPCBfYXNwZWN0UmF0aW8pCgkJewoJCQkvL2xpbWl0IHRvIHRoZSBuYXJyb3dlciB3aWR0aAoJCQlzaXplLmhlaWdodCA9IHNpemUud2lkdGggLyBfYXNwZWN0UmF0aW87CgkJfQoJCWVsc2UgaWYgKGN1cnJlbnRBc3BlY3QgPiBtYXhBc3BlY3RSYXRpbykKCQl7CgkJCS8vbGltaXQgdG8gdGhlIHNob3J0ZXIgaGVpZ2h0CgkJCXNpemUud2lkdGggPSBzaXplLmhlaWdodCAqIG1heEFzcGVjdFJhdGlvOwoJCX0KCX07CgoJLyoqCgkqICBBZGQgYSBkaXNwbGF5LiBJZiB0aGlzIGlzIHRoZSBmaXJzdCBkaXNwbGF5IGFkZGVkLCB0aGVuIGl0IHdpbGwgYmUgc3RvcmVkIGFzIHRoaXMuZGlzcGxheS4KCSogIEBtZXRob2QgYWRkRGlzcGxheQoJKiAgQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgY2FudmFzIGVsZW1lbnQsIHRoaXMgd2lsbCBiZSB1c2VkIHRvIGdyYWIgdGhlIERpc3BsYXkgbGF0ZXIKCSogICAgICAgICAgICAgICAgYWxzbyB0aGUgRGlzcGxheSBzaG91bGQgYmUgdGhlIG9uZSB0byBjYWxsZWQgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpCgkqICAgICAgICAgICAgICAgIGFuZCBub3QgdGhlIGFwcGxpY2F0aW9uIHNpbmMgd2UgZG9uJ3QgY2FyZSBhYm91dCB0aGUgRE9NRWxlbWVudCBhcyB0aGlzIHBvaW50CgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBkaXNwbGF5Q29uc3RydWN0b3IgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgdG8gY3JlYXRlIHRoZSBkaXNwbGF5IGluc3RhbmNlCgkqICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIE9wdGlvbmFsIERpc3BsYXkgc3BlY2lmaWMgb3B0aW9ucwoJKiAgQHJldHVybiB7RGlzcGxheX0gVGhlIGNyZWF0ZWQgZGlzcGxheS4KCSovCglwLmFkZERpc3BsYXkgPSBmdW5jdGlvbihpZCwgZGlzcGxheUNvbnN0cnVjdG9yLCBvcHRpb25zKQoJewoJCWlmKF9kaXNwbGF5c1tpZF0pCgkJewoJCQlpZiAodHJ1ZSkKCQkJewoJCQkJRGVidWcuZXJyb3IoIkEgZGlzcGxheSBhbHJlYWR5IGV4aXN0cyB3aXRoIHRoZSBpZCBvZiAiICsgaWQpOwoJCQl9CgkJCXJldHVybjsKCQl9CgkJdmFyIGRpc3BsYXkgPSBfZGlzcGxheXNbaWRdID0gbmV3IGRpc3BsYXlDb25zdHJ1Y3RvcihpZCwgb3B0aW9ucyk7CgkJaWYgKCF0aGlzLmRpc3BsYXkpCgkJewoJCQl0aGlzLmRpc3BsYXkgPSBkaXNwbGF5OwoJCQlfYXNwZWN0UmF0aW8gPSBkaXNwbGF5LndpZHRoIC8gZGlzcGxheS5oZWlnaHQ7CgkJCXZhciBtYXhBc3BlY3RSYXRpbyA9IHRoaXMub3B0aW9ucy5tYXhBc3BlY3RSYXRpbyB8fCBfYXNwZWN0UmF0aW87CgoJCQlpZiAobWF4QXNwZWN0UmF0aW8gPCBfYXNwZWN0UmF0aW8pCgkJCXsKCQkJCWlmICh0cnVlKQoJCQkJewoJCQkJCXRocm93ICJJbnZhbGlkICdtYXhBc3BlY3RSYXRpbyc6IE11c3QgYmUgZ3JlYXRlciB0aGFuIHRoZSBvcmlnaW5hbCBhc3BlY3QgcmF0aW8gb2YgdGhlIGRpc3BsYXkiOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRocm93ICJJbnZhbGlkICdtYXhBc3BlY3RSYXRpbyciOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiBkaXNwbGF5OwoJfTsKCgkvKioKCSogIEdldHMgYSBzcGVjaWZpYyByZW5kZXJlciBieSB0aGUgY2FudmFzIGlkLgoJKiAgQG1ldGhvZCBnZXREaXNwbGF5CgkqICBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSBjYW52YXMKCSogIEByZXR1cm4ge0Rpc3BsYXl9IFRoZSByZXF1ZXN0ZWQgZGlzcGxheS4KCSovCglwLmdldERpc3BsYXkgPSBmdW5jdGlvbihpZCkKCXsKCQlyZXR1cm4gX2Rpc3BsYXlzW2lkXTsKCX07CgoJLyoqCgkqICBHZXRzIGEgc3BlY2lmaWMgcmVuZGVyZXIgYnkgdGhlIGNhbnZhcyBpZC4KCSogIEBtZXRob2QgZ2V0RGlzcGxheXMKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7ZnVuY3Rpb259IFtlYWNoXSBPcHRpb25hbCBsb29waW5nIG1ldGhvZCwgY2FsbGJhY2sgdGFrZXMgYSBzaW5nbGUgcGFyYW1ldGVyIG9mIHRoZSBkaXNwbGF5CgkqICBAcmV0dXJuIHtBcnJheX0gVGhlIGNvbGxlY3Rpb24gb2YgRGlzcGxheSBvYmplY3RzCgkqLwoJcC5nZXREaXNwbGF5cyA9IGZ1bmN0aW9uKGVhY2gpCgl7CgkJdmFyIG91dHB1dCA9IFtdOwoJCWZvcih2YXIga2V5IGluIF9kaXNwbGF5cykKCQl7CgkJCW91dHB1dC5wdXNoKF9kaXNwbGF5c1trZXldKTsKCQkJaWYgKHR5cGVvZiBlYWNoID09PSAiZnVuY3Rpb24iKQoJCQl7CgkJCQllYWNoLmNhbGwodGhpcywgX2Rpc3BsYXlzW2tleV0pOwoJCQl9CgkJfQoJCXJldHVybiBvdXRwdXQ7Cgl9OwoKCS8qKgoJKiBSZW1vdmVzIGFuZCBkZXN0cm95cyBhIGRpc3BsYXkKCSogQG1ldGhvZCByZW1vdmVEaXNwbGF5CgkqIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgRGlzcGxheSdzIGlkIChhbHNvIHRoZSBjYW52YXMgSUQpCgkqLwoJcC5yZW1vdmVEaXNwbGF5ID0gZnVuY3Rpb24oaWQpCgl7CgkJdmFyIGRpc3BsYXkgPSBfZGlzcGxheXNbaWRdOwoJCWlmKGRpc3BsYXkpCgkJewoJCQlkaXNwbGF5LmRlc3Ryb3koKTsKCQkJZGVsZXRlIF9kaXNwbGF5c1tpZF07CgkJfQoJfTsKCgkvKioKCSogIFByb3BlcnR5IGZvciBnZXR0aW5nL3NldHRpbmcgdGhlIHRhcmdldCBmcHMgKHdoZW4gbm90IHVzaW5nIFJBRikKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBmcHMKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgImZwcyIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkKCQl7CgkJCXJldHVybiBfZnBzOwoJCX0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCWlmKHR5cGVvZiB2YWx1ZSAhPSAibnVtYmVyIikgcmV0dXJuOwoJCQlfZnBzID0gdmFsdWU7CgkJCV9tc1BlckZyYW1lID0gKDEwMDAgLyBfZnBzKSB8IDA7CgkJfQoJfSk7CgoJLyoqCgkqICBHZXR0ZXIgYW5kIHNldHRpbmcgZm9yIHVzaW5nIFJlcXVlc3QgQW5pbWF0aW9uIEZyYW1lCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IHJhZgoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAicmFmIiwgewoJCWdldDogZnVuY3Rpb24oKQoJCXsKCQkJcmV0dXJuIF91c2VSQUY7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCXsKCQkJX3VzZVJBRiA9ICEhdmFsdWU7CgkJfQoJfSk7CgoJLyoqCgkqICBfdGljayB3b3VsZCBiZSBib3VuZCBpbiBfdGlja0NhbGxiYWNrCgkqICBAbWV0aG9kIF90aWNrCgkqICBAcHJpdmF0ZQoJKi8KCXAuX3RpY2sgPSBmdW5jdGlvbigpCgl7CgkJaWYgKF9wYXVzZWQpCgkJewoJCQlfdGlja0lkID0gLTE7CgkJCXJldHVybjsKCQl9CgoJCXZhciBub3cgPSBUaW1lVXRpbHMubm93KCk7CgkJdmFyIGRUaW1lID0gbm93IC0gX2xhc3RGcmFtZVRpbWU7CgkJCgkJLy8gT25seSB1cGRhdGUgdGhlIGZyYW1lcmF0ZSBldmVyeSBzZWNvbmQKCQlpZihfZnJhbWVyYXRlKQoJCXsKCQkJX2ZyYW1lQ291bnQrKzsKCQkJdmFyIGVsYXBzZWQgPSBub3cgLSBfbGFzdEZQU1VwZGF0ZVRpbWU7CgkJCWlmIChlbGFwc2VkID4gMTAwMCkKCQkJewoJCQkJdmFyIGZyYW1lcmF0ZVZhbHVlID0gMTAwMCAvIGVsYXBzZWQgKiBfZnJhbWVDb3VudDsKCQkJCV9mcmFtZXJhdGUuaW5uZXJIVE1MID0gIkZQUzogIiArIChNYXRoLnJvdW5kKGZyYW1lcmF0ZVZhbHVlICogMTAwMCkgLyAxMDAwKTsKCQkJCV9sYXN0RlBTVXBkYXRlVGltZSA9IG5vdzsKCQkJCV9mcmFtZUNvdW50ID0gMDsKCQkJfQoJCX0KCQlfbGFzdEZyYW1lVGltZSA9IG5vdzsKCgkJLy90cmlnZ2VyIHRoZSB1cGRhdGUgZXZlbnQKCQl0aGlzLnRyaWdnZXIoVVBEQVRFLCBkVGltZSk7CgoJCS8vdGhlbiB1cGRhdGUgYWxsIGRpc3BsYXlzCgkJZm9yKHZhciBrZXkgaW4gX2Rpc3BsYXlzKQoJCXsKCQkJX2Rpc3BsYXlzW2tleV0ucmVuZGVyKGRUaW1lKTsKCQl9CgoJCS8vcmVxdWVzdCB0aGUgbmV4dCB0aWNrCgkJLy9yZXF1ZXN0IHRoZSBuZXh0IGFuaW1hdGlvbiBmcmFtZQoJCV90aWNrSWQgPSBfdXNlUkFGID8KCQkJcmVxdWVzdEFuaW1GcmFtZShfdGlja0NhbGxiYWNrKSA6CgkJCXNldFRhcmdldGVkVGltZW91dChfdGlja0NhbGxiYWNrLCBUaW1lVXRpbHMubm93KCkgLSBfbGFzdEZyYW1lVGltZSk7Cgl9OwoKCS8qKgoJKiBEZXN0cm95cyB0aGUgYXBwbGljYXRpb24sIGdsb2JhbCBsaWJyYXJpZXMgcmVnaXN0ZXJlZCB2aWEgQXBwbGljYXRpb24ucmVnaXN0ZXJEZXN0cm95KCkgYW5kIGFsbCBhY3RpdmUgZGlzcGxheXMKCSogQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuX3JlYWR5VG9Jbml0ID0gZmFsc2U7CgkJdGhpcy5wYXVzZWQgPSB0cnVlOwoJCXRoaXMudHJpZ2dlcihERVNUUk9ZKTsKCQkKCQlmb3IodmFyIGtleSBpbiBfZGlzcGxheXMpCgkJewoJCQlfZGlzcGxheXNba2V5XS5kZXN0cm95KCk7CgkJfQoJCV9kaXNwbGF5cyA9IG51bGw7CgoJCWZvcih2YXIgaSA9IDA7IGkgPCBBcHBsaWNhdGlvbi5fZ2xvYmFsRGVzdHJveS5sZW5ndGg7ICsraSkKCQl7CgkJCUFwcGxpY2F0aW9uLl9nbG9iYWxEZXN0cm95W2ldKCk7CgkJfQoKCQlpZihfcmVzaXplRWxlbWVudCkKCQl7CgkJCXdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJyZXNpemUiLCB0aGlzLnRyaWdnZXJSZXNpemUpOwoJCX0KCgkJX3BhZ2VWaXNpYmlsaXR5LmRlc3Ryb3koKTsKCQlfcGFnZVZpc2liaWxpdHkgPSBudWxsOwoKCQlfaW5zdGFuY2UgPQoJCV90aWNrQ2FsbGJhY2sgPQoJCV9mcmFtZXJhdGUgPQoJCV9yZXNpemVFbGVtZW50ID0gbnVsbDsKCgkJRGVidWcuZGlzY29ubmVjdCgpOwoKCQlzLmRlc3Ryb3kuY2FsbCh0aGlzKTsKCX07CgoJLy8gQWRkIHRvIHRoZSBuYW1lIHNwYWNlCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5BcHBsaWNhdGlvbiA9IEFwcGxpY2F0aW9uOwoKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCgkvKioKCSogICBUaGUgZGlzcGxheSBwcm92aWRlcyB0aGUgYmFzZSBwcm9wZXJ0aWVzIGZvciBhbGwgY3VzdG9tIGRpc3BsYXkuIEEgZGlzcGxheQoJKiAgIGlzIGEgc3BlY2lhbGl6ZWQgdmlldyBmb3IgdGhlIGFwcGxpY2F0aW9uLiBBcyB0aGUgbmFtZSBzdWdnZXN0cywgdGhpcyBjbGFzcwoJKiAgIHNob3VsZCBub3QgYmUgaW5zdGFuY2lhdGVkIGRpcmVjdGx5LgoJKgoJKiAgIEBjbGFzcyBBYnN0cmFjdERpc3BsYXkKCSoJQGNvbnN0cnVjdG9yCgkqCUBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIGNhbnZhcyBlbGVtZW50IG9uIHRoZSBwYWdlIHRvIGRyYXcgdG8uCgkqCUBwYXJhbSB7T2JqZWN0fSBvcHRpb25zIFRoZSBzZXR1cCBkYXRhIGZvciB0aGUgZGlzcGxheS4KCSogICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuY29udGV4dElkPSIyZCJdIFZhbGlkIG9wdGlvbnMgYXJlICIyZCIgYW5kICJ3ZWJnbCIKCSovCgl2YXIgQWJzdHJhY3REaXNwbGF5ID0gZnVuY3Rpb24oaWQsIG9wdGlvbnMpCgl7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgoJCS8qKgoJCSogIHRoZSBjYW52YXMgbWFuYWdlZCBieSB0aGlzIGRpc3BsYXkKCQkqICBAcHJvcGVydHkge0RPTUVsZW1lbnR9IGNhbnZhcwoJCSogIEByZWFkT25seQoJCSogIEBwdWJsaWMKCQkqLwoJCXRoaXMuY2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwoKCQkvKioKCQkqICBUaGUgRE9NIGlkIGZvciB0aGUgY2FudmFzCgkJKiAgQHByb3BlcnR5IHtTdHJpbmd9IGlkCgkJKiAgQHJlYWRPbmx5CgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5pZCA9IGlkOwoKCQkvKioKCQkqICBDb252ZW5pZW5jZSBtZXRob2QgZm9yIGdldHRpbmcgdGhlIHdpZHRoIG9mIHRoZSBjYW52YXMgZWxlbWVudAoJCSogIHdvdWxkIGJlIHRoZSBzYW1lIHRoaW5nIGFzIGNhbnZhcy53aWR0aAoJCSogIEBwcm9wZXJ0eSB7aW50fSB3aWR0aAoJCSogIEByZWFkT25seQoJCSogIEBwdWJsaWMKCQkqLwoJCXRoaXMud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aDsKCgkJLyoqCgkJKiAgQ29udmVuaWVuY2UgbWV0aG9kIGZvciBnZXR0aW5nIHRoZSBoZWlnaHQgb2YgdGhlIGNhbnZhcyBlbGVtZW50CgkJKiAgd291bGQgYmUgdGhlIHNhbWUgdGhpbmcgYXMgY2FudmFzLmhlaWdodAoJCSogIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKi8KCQl0aGlzLmhlaWdodCA9IHRoaXMuY2FudmFzLmhlaWdodDsKCgkJLyoqCgkJKiAgVGhlIG1haW4gcmVuZGVyaW5nIGNvbnRleHQgb3IgdGhlIHJvb3QgZGlzcGxheSBvYmplY3Qgb3Igc3RhZ2UuCgkJKiAgQHByb3BlcnR5IHttaXhlZH0gc3RhZ2UKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKi8KCQl0aGlzLnN0YWdlID0gbnVsbDsKCgkJLyoqCgkJKiAgSWYgcmVuZGVyaW5nIGlzIHBhdXNlZCBvbiB0aGlzIGRpc3BsYXkgb25seS4gUGF1c2luZyBhbGwgZGlzcGxheXMgY2FuIGJlIGRvbmUKCQkqICB1c2luZyBBcHBsaWNhdGlvbi5wYXVzZWQgc2V0dGVyLgoJCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gcGF1c2VkCgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5wYXVzZWQgPSBmYWxzZTsKCgkJLyoqCgkJKiAgSWYgaW5wdXQgaXMgZW5hYmxlZCBvbiB0aGUgc3RhZ2UuCgkJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfZW5hYmxlZAoJCSogIEBwcml2YXRlCgkJKi8KCQl0aGlzLl9lbmFibGVkID0gZmFsc2U7CgoJCS8qKgoJCSogIElmIHRoZSBkaXNwbGF5IGlzIHZpc2libGUuCgkJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfdmlzaWJsZQoJCSogIEBwcml2YXRlCgkJKi8KCQl0aGlzLl92aXNpYmxlID0gdGhpcy5jYW52YXMuc3R5bGUuZGlzcGxheSAhPSAibm9uZSI7CgoJCS8vIHByZXZlbnQgbW91c2UgZG93biB0dXJuaW5nIGludG8gdGV4dCBjdXJzb3IKCQl0aGlzLmNhbnZhcy5vbm1vdXNlZG93biA9IGZ1bmN0aW9uKGUpCgkJewoJCQllLnByZXZlbnREZWZhdWx0KCk7CgkJfTsKCgkJLyoqCgkJKiAgVGhlIEFuaW1hdG9yIGNsYXNzIHRvIHVzZSB3aGVuIHVzaW5nIHRoaXMgZGlzcGxheS4gT3RoZXIgbW9kdWxlcwoJCSogIHVzZXMgdGhpcyB0byBkZXRlcm1pbmUgd2hhdCBBbmltYXRvciB0byB1c2UsIGZvciBpbnN0YW5jZSBzdGF0ZXMKCQkqICB1c2VzIEFuaW1hdG9yIHdoZW4gcGxheWluZyB0cmFuc2l0aW9uIGFuaW1hdGlvbnMuCgkJKiAgQHByb3BlcnR5IHtBbmltYXRvcn0gYW5pbWF0b3IKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKiAgQGRlZmF1bHQgbnVsbAoJCSovCgkJdGhpcy5hbmltYXRvciA9IG51bGw7CgoJCS8qKgoJCSogIFNvbWUgb2YgdGhlIG1vZHVsZXMgcmVxdWlyZSBhIHNwZWNpYWwgZGlzcGxheSBhZGFwdGVyIHRvIHByb3ZpZGUKCQkqICBjb21tb24gbWV0aG9kcyBmb3IgbWFuYWdpbmcgZGlzcGxheSBvYmplY3RzLgoJCSogIEBwcm9wZXJ0eSB7RGlzcGxheUFkYXB0ZXJ9IGFkYXB0ZXIKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKiAgQGRlZmF1bHQgbnVsbAoJCSovCgkJdGhpcy5hZGFwdGVyID0gbnVsbDsKCX07CgoJdmFyIHAgPSBBYnN0cmFjdERpc3BsYXkucHJvdG90eXBlOwoKCS8qKgoJKiAgSWYgaW5wdXQgaXMgZW5hYmxlZCBvbiB0aGUgc3RhZ2UgZm9yIHRoaXMgZGlzcGxheS4gVGhlIGRlZmF1bHQgaXMgdHJ1ZS4KCSogIFdpdGhvdXQgYSByZW5kZXJpbmcgbGlicmFyeSwgdGhpcyBkb2VzIG5vdCBhY3R1YWxseSBoYXZlIGFuIGVmZmVjdC4KCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gZW5hYmxlZAoJKiAgQHB1YmxpYwoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiZW5hYmxlZCIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCl7IHJldHVybiB0aGlzLl9lbmFibGVkOyB9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQl0aGlzLl9lbmFibGVkID0gdmFsdWU7CgkJfQoJfSk7CgoJLyoqCgkqICBJZiB0aGUgZGlzcGxheSBpcyB2aXNpYmxlLCB1c2luZyAiZGlzcGxheTogbm9uZSIgY3NzIG9uIHRoZSBjYW52YXMuIEludmlzaWJsZSBkaXNwbGF5cyB3b24ndCByZW5kZXIuCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IHZpc2libGUKCSogIEBwdWJsaWMKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInZpc2libGUiLCB7CgkJZ2V0OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5fdmlzaWJsZTsgfSwKCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCXsKCQkJdGhpcy5fdmlzaWJsZSA9IHZhbHVlOwoJCQl0aGlzLmNhbnZhcy5zdHlsZS5kaXNwbGF5ID0gdmFsdWUgPyAiYmxvY2siIDogIm5vbmUiOwoJCX0KCX0pOwoKCS8qKgoJKiBSZXNpemVzIHRoZSBjYW52YXMuIFRoaXMgaXMgb25seSBjYWxsZWQgYnkgdGhlIEFwcGxpY2F0aW9uLgoJKiBAbWV0aG9kIHJlc2l6ZQoJKiBAaW50ZXJuYWwKCSogQHBhcmFtIHtpbnR9IHdpZHRoIFRoZSB3aWR0aCB0aGF0IHRoZSBkaXNwbGF5IHNob3VsZCBiZQoJKiBAcGFyYW0ge2ludH0gaGVpZ2h0IFRoZSBoZWlnaHQgdGhhdCB0aGUgZGlzcGxheSBzaG91bGQgYmUKCSovCglwLnJlc2l6ZSA9IGZ1bmN0aW9uKHdpZHRoLCBoZWlnaHQpCgl7CgkJdGhpcy53aWR0aCA9IHRoaXMuY2FudmFzLndpZHRoID0gd2lkdGg7CgkJdGhpcy5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQgPSBoZWlnaHQ7Cgl9OwoKCS8qKiAKCSogVXBkYXRlcyB0aGUgc3RhZ2UgYW5kIGRyYXdzIGl0LiBUaGlzIGlzIG9ubHkgY2FsbGVkIGJ5IHRoZSBBcHBsaWNhdGlvbi4gCgkqIFRoaXMgbWV0aG9kIGRvZXMgbm90aGluZyBpZiBwYXVzZWQgaXMgdHJ1ZSBvciB2aXNpYmxlIGlzIGZhbHNlLgoJKiBAbWV0aG9kIHJlbmRlcgoJKiBAaW50ZXJuYWwKCSogQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5yZW5kZXIgPSBmdW5jdGlvbihlbGFwc2VkKQoJewoJCWlmKHRoaXMucGF1c2VkIHx8ICF0aGlzLl92aXNpYmxlKSByZXR1cm47Cgl9OwoKCS8qKgoJKiAgRGVzdHJveXMgdGhlIGRpc3BsYXkuIFRoaXMgbWV0aG9kIGlzIGNhbGxlZCBieSB0aGUgQXBwbGljYXRpb24gYW5kIHNob3VsZCAKCSogIG5vdCBiZSBjYWxsZWQgZGlyZWN0bHksIHVzZSBBcHBsaWNhdGlvbi5yZW1vdmVEaXNwbGF5KGlkKS4gCgkqICBUaGUgc3RhZ2UgcmVjdXJzaXZlbHkgcmVtb3ZlcyBhbGwgZGlzcGxheSBvYmplY3RzIGhlcmUuCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSogIEBpbnRlcm5hbAoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmVuYWJsZWQgPSBmYWxzZTsKCQl0aGlzLmFuaW1hdG9yID0gbnVsbDsKCQl0aGlzLmFkYXB0ZXIgPSBudWxsOwoJCXRoaXMuY2FudmFzLm9ubW91c2Vkb3duID0gbnVsbDsKCQl0aGlzLmNhbnZhcyA9IG51bGw7Cgl9OwoKCS8vIEFzc2lnbiB0byB0aGUgZ2xvYmFsIG5hbWVzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuQWJzdHJhY3REaXNwbGF5ID0gQWJzdHJhY3REaXNwbGF5OwoKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCgkvLyBDbGFzc2VzIHRvIGltcG9ydAoJdmFyIEFwcGxpY2F0aW9uLAoJCUxvYWRlcjsKCgkvKioKCSogIFVzZWQgZm9yIG1hbmFnaW5nIHRoZSBicm93c2VyIGNhY2hlIG9mIGxvYWRpbmcgZXh0ZXJuYWwgZWxlbWVudHMKCSogIGNhbiBlYXNpbHkgbG9hZCB2ZXJzaW9uIG1hbmlmZXN0IGFuZCBhcHBseSBpdCB0byB0aGUgbWVkaWEgbG9hZGVyCgkqICBzdXBwb3J0cyBjYWNoZSBidXN0aW5nIGFsbCBtZWRpYSBsb2FkIHJlcXVlc3RzCgkqICB1c2VzIHRoZSBxdWVyeSBzdHJpbmcgdG8gYnVzdCBicm93c2VyIHZlcnNpb25zLgoJKgoJKiAgQGNsYXNzIENhY2hlTWFuYWdlcgoJKi8KCXZhciBDYWNoZU1hbmFnZXIgPSBmdW5jdGlvbigpCgl7CgkJaWYoIUFwcGxpY2F0aW9uKQoJCXsKCQkJQXBwbGljYXRpb24gPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkFwcGxpY2F0aW9uJyk7CgkJCUxvYWRlciA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuTG9hZGVyJyk7CgkJfQoJCQoJCXRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uID0gdGhpcy5fYXBwbHlTcGVjaWZpY1ZlcnNpb24uYmluZCh0aGlzKTsKCQl0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24gPSB0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24uYmluZCh0aGlzKTsKCgkJLyoqCgkJKiAgVGhlIGNvbGxlY3Rpb24gb2YgdmVyc2lvbiBudW1iZXJzCgkJKiAgQHByb3RlY3RlZAoJCSogIEBwcm9wZXJ0eSB7RGljdGlvbmFyeX0gX3ZlcnNpb25zCgkJKi8KCQl0aGlzLl92ZXJzaW9ucyA9IHt9OwoJCQoJCS8qKgoJCSogIFRoZSBsaXN0IG9mIFVSTCBmaWx0ZXJpbmcgZnVuY3Rpb25zLgoJCSogIEBwcm90ZWN0ZWQKCQkqICBAcHJvcGVydHkge0FycmF5fSBfZmlsdGVycwoJCSovCgkJdGhpcy5fZmlsdGVycyA9IFtdOwoJCQoJCS8qKgoJCSogIEEgZ2xvYmFsIHZlcnNpb24gb3IgY2FjaGUgYnVzdGluZyBzdHJpbmcgdG8gYXBwbHkgdG8gZXZlcnkgdXJsLgoJCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBfZ2xvYmFsVmVyc2lvbgoJCSovCgkJdGhpcy5fZ2xvYmFsVmVyc2lvbiA9IG51bGw7CgkJCgkJdmFyIGNiID0gQXBwbGljYXRpb24uaW5zdGFuY2Uub3B0aW9ucy5jYWNoZUJ1c3Q7CgkJdGhpcy5jYWNoZUJ1c3QgPSAoY2IgPT09ICJ0cnVlIiB8fCBjYiA9PT0gdHJ1ZSk7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCWlmICh0aGlzLmNhY2hlQnVzdCkgRGVidWcubG9nKCJDYWNoZUJ1c3QgYWxsIGZpbGVzIGlzIG9uLiIpOwoJCX0KCX07CgkKCS8qIEVhc3kgYWNjZXNzIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gQ2FjaGVNYW5hZ2VyLnByb3RvdHlwZSA9IHt9OwoJCgkvKioKCSogIElmIHdlIGFyZSBzdXBwb3NlIHRvIGNhY2hlIGJ1c3QgZXZlcnkgZmlsZQoJKiAgQHByb3BlcnR5IHtCb29sZWFufSBjYWNoZUJ1c3QKCSogIEBwdWJsaWMKCSogIEBkZWZhdWx0IGZhbHNlCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJjYWNoZUJ1c3QiLAoJewoJCWdldDogZnVuY3Rpb24oKQoJCXsKCQkJcmV0dXJuICEhKHRoaXMuX2dsb2JhbFZlcnNpb24gJiYgdGhpcy5fZ2xvYmFsVmVyc2lvbi5pbmRleE9mKCJjYj0iKSA9PT0gMCk7CgkJfSwKCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCXsKCQkJaWYodmFsdWUpCgkJCXsKCQkJCXRoaXMuX2dsb2JhbFZlcnNpb24gPSAiY2I9IiArIERhdGUubm93KCk7CgkJCQl0aGlzLnVucmVnaXN0ZXJVUkxGaWx0ZXIodGhpcy5fYXBwbHlTcGVjaWZpY1ZlcnNpb24pOwoJCQkJdGhpcy5yZWdpc3RlclVSTEZpbHRlcih0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24pOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJdmFyIHZlcnNpb24gPSBBcHBsaWNhdGlvbi5pbnN0YW5jZS5vcHRpb25zLnZlcnNpb247CgkJCQl0aGlzLl9nbG9iYWxWZXJzaW9uID0gdmVyc2lvbiA/ICJ2PSIgKyB2ZXJzaW9uIDogbnVsbDsKCQkJCWlmKHRoaXMuX2dsb2JhbFZlcnNpb24pCgkJCQl7CgkJCQkJdGhpcy51bnJlZ2lzdGVyVVJMRmlsdGVyKHRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uKTsKCQkJCQl0aGlzLnJlZ2lzdGVyVVJMRmlsdGVyKHRoaXMuX2FwcGx5R2xvYmFsVmVyc2lvbik7CgkJCQl9CgkJCQllbHNlCgkJCQl7CgkJCQkJdGhpcy51bnJlZ2lzdGVyVVJMRmlsdGVyKHRoaXMuX2FwcGx5R2xvYmFsVmVyc2lvbik7CgkJCQkJdGhpcy5yZWdpc3RlclVSTEZpbHRlcih0aGlzLl9hcHBseVNwZWNpZmljVmVyc2lvbik7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBjYWNoZSBtYW5hZ2VyLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcy4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLl92ZXJzaW9ucyA9IG51bGw7CgkJdGhpcy5fZmlsdGVycyA9IG51bGw7CgkJdGhpcy5fYXBwbHlTcGVjaWZpY1ZlcnNpb24gPSBudWxsOwoJCXRoaXMuX2FwcGx5R2xvYmFsVmVyc2lvbiA9IG51bGw7Cgl9OwoJCgkvKioKCSogIEFkZHMgYSB2ZXJzaW9ucyB0ZXh0IGZpbGUgY29udGFpbmluZyB2ZXJzaW9ucyBmb3IgZGlmZmVyZW50IGFzc2V0cy4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgYWRkVmVyc2lvbnNGaWxlCgkqICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgb2YgdGhlIHZlcnNpb25zIGZpbGUuCgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBjYWxsYmFjayBDYWxsYmFjayB3aGVuIHRoZSB2ZXJzaW9ucyBmaWxlIGhhcyBiZWVuIGxvYWRlZC4KCSogIEBwYXJhbSB7U3RyaW5nfSBiYXNlVXJsIEEgYmFzZSB1cmwgdG8gcHJlcGVuZCBhbGwgbGluZXMgb2YgdGhlIGZpbGUuCgkqLwoJcC5hZGRWZXJzaW9uc0ZpbGUgPSBmdW5jdGlvbih1cmwsIGNhbGxiYWNrLCBiYXNlVXJsKQoJewoJCURlYnVnLmFzc2VydCgvXi4qXC50eHQkLy50ZXN0KHVybCksICJUaGUgdmVyc2lvbnMgZmlsZSBtdXN0IGJlIGEgKi50eHQgZmlsZSIpOwoJCQkJCgkJdmFyIGxvYWRlciA9IExvYWRlci5pbnN0YW5jZTsKCQkKCQkvLyBJZiB3ZSBhbHJlYWR5IGNhY2hlIGJ1c3RpbmcsIHdlIGNhbiBpZ25vcmUgdGhpcwoJCWlmICh0aGlzLmNhY2hlQnVzdCkKCQl7CgkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJcmV0dXJuOwoJCX0KCQkKCQkvLyBBZGQgYSByYW5kb20gdmVyc2lvbiBudW1iZXIgdG8gbmV2ZXIgY2FjaGUgdGhlIHRleHQgZmlsZQoJCXRoaXMuYWRkVmVyc2lvbih1cmwsIERhdGUubm93KCkudG9TdHJpbmcoKSk7CgkJCgkJLy9lbnN1cmUgdGhhdCB0aGF0IGNhY2hlIGJ1c3RpbmcgdmVyc2lvbiBpcyBhcHBsaWVkCgkJdXJsID0gdGhpcy5fYXBwbHlTcGVjaWZpY1ZlcnNpb24odXJsKTsKCQkKCQl2YXIgY20gPSB0aGlzOwoJCQoJCS8vIExvYWQgdGhlIHZlcnNpb24KCQlsb2FkZXIubG9hZCh1cmwsCgkJCWZ1bmN0aW9uKHJlc3VsdCkKCQkJewoJCQkJLy8gY2hlY2sgZm9yIGEgdmFsaWQgcmVzdWx0IGNvbnRlbnQKCQkJCWlmIChyZXN1bHQgJiYgcmVzdWx0LmNvbnRlbnQpCgkJCQl7CgkJCQkJLy8gUmVtb3ZlIGNhcnJhZ2UgcmV0dXJucyBhbmQgc3BsaXQgb24gbmV3bGluZXMKCQkJCQl2YXIgbGluZXMgPSByZXN1bHQuY29udGVudC5yZXBsYWNlKC9cci9nLCAnJykuc3BsaXQoIlxuIik7CgkJCQkJdmFyIGksIHBhcnRzOwoKCQkJCQkvLyBHbyBsaW5lIGJ5IGxpbmUKCQkJCQlmb3IoaSA9IDA7IGkgPCBsaW5lcy5sZW5ndGg7IGkrKykKCQkJCQl7CgkJCQkJCS8vIENoZWNrIGZvciBhIHZhbGlkIGxpbmUKCQkJCQkJaWYgKCFsaW5lc1tpXSkgY29udGludWU7CgoJCQkJCQkvLyBTcGxpdCBsaW5lcwoJCQkJCQlwYXJ0cyA9IGxpbmVzW2ldLnNwbGl0KCcgJyk7CgoJCQkJCQkvLyBBZGQgdGhlIHBhcnRzCgkJCQkJCWlmIChwYXJ0cy5sZW5ndGggIT0gMikgY29udGludWU7CgoJCQkJCQkvLyBBZGQgdGhlIHZlcnNpb25pbmcKCQkJCQkJY20uYWRkVmVyc2lvbigoYmFzZVVybCB8fCAiIikgKyBwYXJ0c1swXSwgcGFydHNbMV0pOwoJCQkJCX0KCQkJCX0KCQkJCWlmIChjYWxsYmFjaykgY2FsbGJhY2soKTsKCQkJfQoJCSk7Cgl9OwoJCgkvKioKCSogIEFkZCBhIHZlcnNpb24gbnVtYmVyIGZvciBhIGZpbGUKCSogIEBtZXRob2QgYWRkVmVyc2lvbgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSBvYmplY3QKCSogIEBwYXJhbSB7U3RyaW5nfSB2ZXJzaW9uIFZlcnNpb24gbnVtYmVyIG9yIGhhcyBvZiBmaWxlCgkqLwoJcC5hZGRWZXJzaW9uID0gZnVuY3Rpb24odXJsLCB2ZXJzaW9uKQoJewoJCWlmICghdGhpcy5fdmVyc2lvbnNbdXJsXSkKCQkJdGhpcy5fdmVyc2lvbnNbdXJsXSA9IHZlcnNpb247Cgl9OwoJCgkvKioKCSogIEFkZHMgYSBmdW5jdGlvbiBmb3IgcnVubmluZyBhbGwgdXJscyB0aHJvdWdoLCB0byBtb2RpZnkgdGhlbSBpZiBuZWVkZWQuCgkqICBGdW5jdGlvbnMgdXNlZCBzaG91bGQgYWNjZXB0IG9uZSBzdHJpbmcgcGFyYW1ldGVyICh0aGUgdXJsKSwgYW5kIHJldHVybiB0aGUKCSogIG1vZGlmaWVkIHVybC4KCSogIEBtZXRob2QgcmVnaXN0ZXJVUkxGaWx0ZXIKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7RnVuY3Rpb259IGZpbHRlciBUaGUgZnVuY3Rpb24gdGhhdCB3aWxsIGhhbmRsZSB1cmxzLgoJKi8KCXAucmVnaXN0ZXJVUkxGaWx0ZXIgPSBmdW5jdGlvbihmaWx0ZXIpCgl7CgkJaWYodGhpcy5fZmlsdGVycy5pbmRleE9mKGZpbHRlcikgPT0gLTEpCgkJCXRoaXMuX2ZpbHRlcnMucHVzaChmaWx0ZXIpOwoJfTsKCQoJLyoqCgkqICBSZW1vdmVzIGEgZnVuY3Rpb24gZnJvbSB0aGUgbGlzdCBvZiBmaWx0ZXJpbmcgZnVuY3Rpb25zLgoJKiAgQG1ldGhvZCB1bnJlZ2lzdGVyVVJMRmlsdGVyCgkqICBAcHVibGljCgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXIgVGhlIGZ1bmN0aW9uIHRvIHJlbW92ZS4KCSovCglwLnVucmVnaXN0ZXJVUkxGaWx0ZXIgPSBmdW5jdGlvbihmaWx0ZXIpCgl7CgkJdmFyIGluZGV4ID0gdGhpcy5fZmlsdGVycy5pbmRleE9mKGZpbHRlcik7CgkJaWYoaW5kZXggPiAtMSkKCQkJdGhpcy5fZmlsdGVycy5zcGxpY2UoaW5kZXgsIDEpOwoJfTsKCQoJLyoqCgkqICBBcHBsaWVzIGEgdXJsIHNwZWNpZmljIHZlcnNpb24gdG8gYSB1cmwgZnJvbSB0aGUgdmVyc2lvbnMgZmlsZS4KCSogIEBtZXRob2QgX2FwcGx5U3BlY2lmaWNWZXJzaW9uCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGFwcGx5IHZlcnNpb25pbmcgdG8uCgkqICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBtb2RpZmllZCB1cmwuCgkqLwoJcC5fYXBwbHlTcGVjaWZpY1ZlcnNpb24gPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIHZlciA9IHRoaXMuX3ZlcnNpb25zW3VybF07CgkJLy9pZiBhIHZlcnNpb24gZXhpc3RzIGZvciB0aGlzIHVybCwgYW5kIHRoZSB1cmwgZG9lc24ndCBhbHJlYWR5IGhhdmUgJ3Y9JyBpbiBpdAoJCS8vdGhlbiBhcHBseSB0aGUgdXJsIHNwZWNpZmljIHZlcnNpb24uCgkJaWYodmVyICYmIC8oXD98XCYpdlw9WzAtOV0qLy50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCI/IikgPCAwID8gIj8iIDogIiYiKSArICJ2PSIgKyB2ZXIudmVyc2lvbjsKCQl9CgkJcmV0dXJuIHVybDsKCX07CgkKCS8qKgoJKiAgQXBwbGllcyBjYWNoZSBidXN0aW5nIG9yIGEgZ2xvYmFsIHZlcnNpb24gdG8gYSB1cmwuCgkqICBAbWV0aG9kIF9hcHBseUdsb2JhbFZlcnNpb24KCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gYXBwbHkgdmVyc2lvbmluZyB0by4KCSogIEByZXR1cm4ge1N0cmluZ30gVGhlIG1vZGlmaWVkIHVybC4KCSovCglwLl9hcHBseUdsb2JhbFZlcnNpb24gPSBmdW5jdGlvbih1cmwpCgl7CgkJaWYoIXRoaXMuX2dsb2JhbFZlcnNpb24pIHJldHVybiB1cmw7CgkJdmFyIHRlc3QgPSB0aGlzLl9nbG9iYWxWZXJzaW9uLmluZGV4T2YoImNiPSIpID09PSAwID8KCQkJKC8oXD98XCYpY2JcPVswLTldKi8pIDogKC8oXD98XCYpdlw9Lyk7CgkJaWYodGVzdC50ZXN0KHVybCkgPT09IGZhbHNlKQoJCXsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCI/IikgPCAwID8gIj8iIDogIiYiKSArIHRoaXMuX2dsb2JhbFZlcnNpb247CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgkvKioKCSogIEFwcGxpZXMgYSBiYXNlIHBhdGggdG8gYSByZWxhdGl2ZSB1cmwuIFRoaXMgaXMgbm90IHVzZWQgaW4gdGhlIGZpbHRlcmluZwoJKiAgc3lzdGVtIGJlY2F1c2UgUHJlbG9hZEpTIGhhcyBpdHMgb3duIG1ldGhvZCBvZiBwcmVwZW5kaW5nIHRoZSBiYXNlIHBhdGgKCSogIHRoYXQgd2UgdXNlLiBJbnN0ZWFkLCBpdCBpcyB1c2VkIHdpdGggYW4gZXh0cmEgcGFyYW1ldGVyIHRvIHByZXBhcmUoKS4KCSogIEBtZXRob2QgX2FwcGx5QmFzZVBhdGgKCSogIEBwcml2YXRlCgkqICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGVuZCB0aGUgYmFzZSBwYXRoIHRvLgoJKiAgQHJldHVybiB7U3RyaW5nfSBUaGUgbW9kaWZpZWQgdXJsLgoJKi8KCXAuX2FwcGx5QmFzZVBhdGggPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIGJhc2VQYXRoID0gQXBwbGljYXRpb24uaW5zdGFuY2Uub3B0aW9ucy5iYXNlUGF0aDsKCQlpZiAoL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIGJhc2VQYXRoICYmIHVybC5zZWFyY2goYmFzZVBhdGgpID09IC0xKQoJCXsKCQkJdXJsID0gYmFzZVBhdGggKyB1cmw7CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgkvKioKCSogIFByZXBhcmUgYSBVUkwgd2l0aCB0aGUgbmVjZXNzYXJ5IGNhY2hlIGJ1c3RpbmcgYW5kL29yIHZlcnNpb25pbmcKCSogIGFzIHdlbGwgYXMgdGhlIGJhc2UgZGlyZWN0b3J5LgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBwcmVwYXJlCgkqICBAcGFyYW0ge1N0cmluZ30gdXJsIFRoZSB1cmwgdG8gcHJlcGFyZQoJKiAgQHBhcmFtIHtCb29sZWFufSBbYXBwbHlCYXNlUGF0aD1mYWxzZV0gSWYgdGhlIGdsb2JhbCBiYXNlIHBhdGggc2hvdWxkIGJlIGFwcGxpZWQgdG8gdGhlIHVybC4KCSoJCVRoaXMgZGVmYXVsdHMgdG8gZmFsc2UgYmVjYXVzZSBpdCBjYW4gcG90ZW50aWFsbHkgaW50ZXJmZXJlIHdpdGggbGF0ZXIgcmVndWxhcgoJKgkJZXhwcmVzc2lvbiBjaGVja3MsIHBhcnRpY3VsYXJseSB3aXRoIFByZWxvYWRKUwoJKiAgQHJldHVybiB7U3RyaW5nfSBUaGUgZmluYWwgdXJsIHdpdGggdmVyc2lvbi9jYWNoZSBhbmQgYmFzZVBhdGggYWRkZWQKCSovCglwLnByZXBhcmUgPSBmdW5jdGlvbih1cmwsIGFwcGx5QmFzZVBhdGgpCgl7CgkJZm9yKHZhciBpID0gMDsgaSA8IHRoaXMuX2ZpbHRlcnMubGVuZ3RoOyArK2kpCgkJewoJCQl1cmwgPSB0aGlzLl9maWx0ZXJzW2ldKHVybCk7CgkJfQoJCQoJCWlmKGFwcGx5QmFzZVBhdGgpCgkJewoJCQl1cmwgPSB0aGlzLl9hcHBseUJhc2VQYXRoKHVybCk7CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5DYWNoZU1hbmFnZXIgPSBDYWNoZU1hbmFnZXI7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24oKXsKCQoJLyoqCgkqICBSZXByZXNlbnRzIGEgc2luZ2xlIGl0ZW0gaW4gdGhlIGxvYWRlciBxdWV1ZSAKCSoKCSogIEBjbGFzcyBMb2FkZXJRdWV1ZUl0ZW0KCSovCgl2YXIgTG9hZGVyUXVldWVJdGVtID0gZnVuY3Rpb24oKQoJewoJCS8qKgoJCSogIFRoZSB1cmwgb2YgdGhlIGxvYWQKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHtzdHJpbmd9IHVybAoJCSovCgkJdGhpcy51cmwgPSBudWxsOwoJCQoJCS8qKgoJCSogIERhdGEgYXNzb2NpYXRlIHdpdGggdGhlIGxvYWQKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHsqfSBkYXRhCgkJKi8KCQl0aGlzLmRhdGEgPSBudWxsOwoJCQoJCS8qKgoJCSogIFRoZSBjYWxsYmFjayBmdW5jdGlvbiBvZiB0aGUgbG9hZCwgdG8gY2FsbCB3aGVuIAoJCSogIHRoZSBsb2FkIGFzIGZpbmlzaGVkLCB0YWtlcyBvbmUgYXJndW1lbnQgYXMgcmVzdWx0CgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IGNhbGxiYWNrCgkJKi8KCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQkKCQkvKioKCQkqICBUaGUgcHJpb3JpdHkgb2YgdGhpcyBpdGVtCgkJKiAgQHByb3BlcnR5IHtpbnR9IHByaW9yaXR5CgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5wcmlvcml0eSA9IDA7CgkJCgkJLyoqCgkJKiAgVGhlIGFtb3VudCB3ZSd2ZSBsb2FkZWQgc28gZmFyLCBmcm9tIDAgdG8gMQoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkge051bWJlcn0gcHJvZ3Jlc3MKCQkqLwoJCXRoaXMucHJvZ3Jlc3MgPSAwOwoJCQoJCS8qKgoJCSogIFRoZSBwcm9ncmVzcyBjYWxsYmFjawoJCSogIEBwdWJsaWMKCQkqICBAcHJvcHJ0eSB7ZnVuY3Rpb259IHVwZGF0ZUNhbGxiYWNrCgkJKi8KCQl0aGlzLnVwZGF0ZUNhbGxiYWNrID0gbnVsbDsKCQkKCQkvKioKCQkqICBUaGUgY2FsbGJhY2sgd2hlbiBhIGxvYWQgcXVldWUgaXRlbSBmYWlscwoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BydHkge2Z1bmN0aW9ufSBfYm91bmRGYWlsCgkJKi8KCQl0aGlzLl9ib3VuZEZhaWwgPSBudWxsOwoKCQkvKioKCQkqICBUaGUgY2FsbGJhY2sgd2hlbiBhIGxvYWQgcXVldWUgaXRlbSBwcm9ncmVzc2VzCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcHJ0eSB7ZnVuY3Rpb259IF9ib3VuZFByb2dyZXNzCgkJKi8KCQl0aGlzLl9ib3VuZFByb2dyZXNzID0gbnVsbDsKCgkJLyoqCgkJKiAgVGhlIGNhbGxiYWNrIHdoZW4gYSBsb2FkIHF1ZXVlIGl0ZW0gY29tcGxldGVzCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcHJ0eSB7ZnVuY3Rpb259IF9ib3VuZENvbXBsZXRlCgkJKi8KCQl0aGlzLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCX07CgkKCS8qKiBSZWZlcmVuY2UgdG8gdGhlIHByb3RvdHlwZSAqLwoJdmFyIHAgPSBMb2FkZXJRdWV1ZUl0ZW0ucHJvdG90eXBlOwoJCgkvKiogCgkqIEhpZ2hlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfSElHSAoJKi8KCUxvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9ISUdIID0gMTsKCQoJLyoqIAoJKiBOb3JtYWwgcHJpb3JpdHksIHRoZSBkZWZhdWx0CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX05PUk1BTAoJKi8KCUxvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9OT1JNQUwgPSAwOwoJCgkvKiogCgkqIExvd2VzdCBwcmlvcml0eQoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9MT1cKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTE9XID0gLTE7CgkKCS8qKgoJKiAgUmVwcmVzZW50IHRoaXMgb2JqZWN0IGFzIGEgc3RyaW5nCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHRvU3RyaW5nCgkqICBAcmV0dXJuIHtzdHJpbmd9IFRoZSBzdHJpbmcgcmVwcmVzZW50YXRpb24gb2YgdGhpcyBvYmplY3QKCSovCglwLnRvU3RyaW5nID0gZnVuY3Rpb24oKQoJewoJCXJldHVybiAiW0xvYWRlclF1ZXVlSXRlbSh1cmw6JyIrdGhpcy51cmwrIicsIHByaW9yaXR5OiIrdGhpcy5wcmlvcml0eSsiKV0iOwoJfTsKCQoJLyoqCgkqICBEZXN0cm95IHRoaXMgcmVzdWx0CgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cGRhdGVDYWxsYmFjayA9IG51bGw7CgkJdGhpcy5kYXRhID0gbnVsbDsKCQl0aGlzLl9ib3VuZEZhaWwgPSBudWxsOwoJCXRoaXMuX2JvdW5kUHJvZ3Jlc3MgPSBudWxsOwoJCXRoaXMuX2JvdW5kQ29tcGxldGUgPSBudWxsOwoJfTsKCQoJLy8gQXNzaWduIHRvIHRoZSBuYW1lIHNwYWNlCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5Mb2FkZXJRdWV1ZUl0ZW0gPSBMb2FkZXJRdWV1ZUl0ZW07CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24oKXsKCQoJLy8gQ2xhc3NlcyB0byBpbXBvcnQKCXZhciBMb2FkZXJRdWV1ZUl0ZW0sCgkJQ2FjaGVNYW5hZ2VyLAoJCUFwcGxpY2F0aW9uLAoJCVNvdW5kLAoJCUxvYWRRdWV1ZSwKCQlMb2FkZXJSZXN1bHQ7CgoJLyoqCgkqICBUaGUgTG9hZGVyIGlzIHRoZSBzaW5nbGV0b24gbG9hZGVyIGZvciBsb2FkaW5nIGFsbCBhc3NldHMKCSogIGluY2x1ZGluZyBpbWFnZXMsIGRhdGEsIGNvZGUgYW5kIHNvdW5kcy4gTG9hZGVyIHN1cHBvcnRzIGNhY2hlLWJ1c3RpbmcKCSogIGluIHRoZSBicm93c2VyIHVzaW5nIGR5bmFtaWMgcXVlcnkgc3RyaW5nIHBhcmFtZXRlcnMuCgkqIAoJKiAgQGNsYXNzIExvYWRlcgoJKi8KCXZhciBMb2FkZXIgPSBmdW5jdGlvbigpCgl7CgkJaWYgKCFBcHBsaWNhdGlvbikKCQl7CgkJCUxvYWRlclF1ZXVlSXRlbSA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuTG9hZGVyUXVldWVJdGVtJyk7CgkJCUNhY2hlTWFuYWdlciA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuQ2FjaGVNYW5hZ2VyJyk7CgkJCUFwcGxpY2F0aW9uID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5BcHBsaWNhdGlvbicpOwoJCQlMb2FkZXJSZXN1bHQgPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkxvYWRlclJlc3VsdCcpOwoJCQlMb2FkUXVldWUgPSBpbmNsdWRlKCdjcmVhdGVqcy5Mb2FkUXVldWUnKTsKCQkJU291bmQgPSBpbmNsdWRlKCdjcmVhdGVqcy5Tb3VuZCcsIGZhbHNlKTsKCQl9CgoJCS8qKgoJCSogIElmIHdlIGNhbiBsb2FkCgkJKiAgQHByaXZhdGUKCQkqLwoJCXRoaXMuX2NhbkxvYWQgPSB0cnVlOwoJCQoJCS8qKgoJCSogIFRoZSBtYXhpbXVtIG51bWJlciBvZiBzaW11bGFuZW91cyBsb2FkcwoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkge2ludH0gbWF4U2ltdWx0YW5lb3VzTG9hZHMKCQkqICBAZGVmYXVsdCAyCgkJKi8KCQl0aGlzLm1heFNpbXVsdGFuZW91c0xvYWRzID0gMjsKCQkKCQkvKioKCQkqICBUaGUgcmVmZXJlbmNlIHRvIHRoZSBjYWNoZSBtYW5hZ2VyCgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7Q2FjaGVNYW5hZ2VyfSBjYWNoZU1hbmFnZXIKCQkqLwoJCXRoaXMuY2FjaGVNYW5hZ2VyID0gbnVsbDsKCX07CgkKCS8qKiBUaGUgcHJvdG90eXBlICovCgl2YXIgcCA9IExvYWRlci5wcm90b3R5cGU7CgkKCS8qKgoJKiBSZWZlcmVuY2UgdG8gdGhlIHByaXZhdGUgaW5zdGFuY2Ugb2JqZWN0CgkqIEBzdGF0aWMKCSogQHByb3RlY3RlZAoJKi8KCXZhciBfaW5zdGFuY2UgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIExvYWRlclF1ZXVlSXRlbXMKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zIGJ5IHVybAoJKiAgQHByaXZhdGUKCSovCgl2YXIgcXVldWVJdGVtcyA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgbG9hZGVycwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7b2JqZWN0fSBsb2FkZXJzCgkqLwoJdmFyIGxvYWRlcnMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBwb29sIG9mIHF1ZXVlIGl0ZW1zCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHthcnJheX0gbG9hZGVycwoJKi8KCXZhciBxaVBvb2wgPSBudWxsOwoKCS8qKgoJKiAgVGhlIHBvb2wgb2YgbG9hZGVyIGl0ZW1zCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHthcnJheX0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJQb29sID0gbnVsbDsKCgkvKioKCSogIFRoZSBwb29sIG9mIHJlc3VsdCBpdGVtcwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7YXJyYXl9IGxvYWRlcnMKCSovCgl2YXIgcmVzdWx0UG9vbCA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGN1cnJlbnQgbnVtYmVyIG9mIGl0ZW1zIGxvYWRpbmcKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gbnVtTG9hZHMKCSogIEBkZWZhdWx0IDAKCSovCgl2YXIgbnVtTG9hZHMgPSAwOwoJCgkvKioKCSogIFRoZSByZXRyeSBhdHRlbXB0cwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSByZXRyaWVzCgkqLwoJdmFyIHJldHJpZXMgPSBudWxsOwoJCgkvKioKCSogIFN0YXRpYyBjb25zdHJ1Y3RvciBjcmVhdGluZyB0aGUgc2luZ2xldG9uCgkqICBAbWV0aG9kIGluaXQKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglMb2FkZXIuaW5pdCA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAoIV9pbnN0YW5jZSkKCQl7CgkJCV9pbnN0YW5jZSA9IG5ldyBMb2FkZXIoKTsKCQkJX2luc3RhbmNlLl9pbml0aWFsaXplKCk7CgkJCS8vcmVnaXN0ZXIgdGhlIGRlc3Ryb3kgZnVuY3Rpb24KCQkJQXBwbGljYXRpb24ucmVnaXN0ZXJEZXN0cm95KAoJCQkJX2luc3RhbmNlLmRlc3Ryb3kuYmluZChfaW5zdGFuY2UpCgkJCSk7CgkJfQoJCXJldHVybiBfaW5zdGFuY2U7Cgl9OwoKCS8vcmVnaXN0ZXIgdGhlIGdsb2JhbCBpbml0IGZ1bmN0aW9uCglzcHJpbmdyb2xsLkFwcGxpY2F0aW9uLnJlZ2lzdGVySW5pdChMb2FkZXIuaW5pdCk7CgkJCgkvKioKCSogIFN0YXRpYyBmdW5jdGlvbiBmb3IgZ2V0dGluZyB0aGUgc2luZ2xldG9uIGluc3RhbmNlCgkqICBAc3RhdGljCgkqICBAcmVhZE9ubHkKCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7TG9hZGVyfSBpbnN0YW5jZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShMb2FkZXIsICJpbnN0YW5jZSIsIHsKCQlnZXQ6ZnVuY3Rpb24oKQoJCXsKCQkJcmV0dXJuIF9pbnN0YW5jZTsKCQl9Cgl9KTsKCQoJLyoqCgkqICBEZXN0cm95IHRoZSBMb2FkZXIgc2luZ2xldG9uLCBkb24ndCB1c2UgYWZ0ZXIgdGhpcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXZhciBpLCBsZW4sIGtleSwgYXJyID0gdGhpcy5xdWV1ZTsKCQlpZihhcnIpCgkJewoJCQlmb3IoaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBpOyArK2kpCgkJCQlhcnJbaV0uZGVzdHJveSgpOwoJCQlhcnIgPSBxaVBvb2w7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWFyciA9IHJlc3VsdFBvb2w7CgkJCWZvcihpID0gMCwgbGVuID0gYXJyLmxlbmd0aDsgaSA8IGk7ICsraSkKCQkJCWFycltpXS5kZXN0cm95KCk7CgkJCWZvcihrZXkgaW4gbG9hZGVycykKCQkJewoJCQkJcXVldWVJdGVtc1trZXldLmRlc3Ryb3koKTsKCQkJCWxvYWRlcnNba2V5XS5jbG9zZSgpOwoJCQl9CgkJfQoJCV9pbnN0YW5jZSA9IG51bGw7CgkJaWYgKHRoaXMuY2FjaGVNYW5hZ2VyKQoJCQl0aGlzLmNhY2hlTWFuYWdlci5kZXN0cm95KCk7CgkJdGhpcy5jYWNoZU1hbmFnZXIgPSBudWxsOwoJCXF1ZXVlID0gbnVsbDsKCQlyZXN1bHRQb29sID0gbnVsbDsKCQlsb2FkZXJQb29sID0gbnVsbDsKCQlxaVBvb2wgPSBudWxsOwoJCXF1ZXVlSXRlbXMgPSBudWxsOwoJCXJldHJpZXMgPSBudWxsOwoJCWxvYWRlcnMgPSBudWxsOwoJfTsKCQoJLyoqCgkqICBJbml0aWxpemUgdGhlIG9iamVjdAoJKiAgQHByb3RlY3RlZAoJKiAgQG1ldGhvZCBfaW5pdGlhbGl6ZQoJKi8KCXAuX2luaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJcWlQb29sID0gW107CgkJbG9hZGVyUG9vbCA9IFtdOwoJCXJlc3VsdFBvb2wgPSBbXTsKCQlxdWV1ZSA9IFtdOwoJCXF1ZXVlSXRlbXMgPSB7fTsKCQlsb2FkZXJzID0ge307CgkJcmV0cmllcyA9IHt9OwoJCXRoaXMuY2FjaGVNYW5hZ2VyID0gbmV3IENhY2hlTWFuYWdlcigpOwoJfTsKCQoJLyoqCgkqICBMb2FkIGEgZmlsZSAKCSogIEBtZXRob2QgbG9hZAoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgZmlsZSBwYXRoIHRvIGxvYWQKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGNvbXBsZXRlZAoJKiAgQHBhcmFtIHtmdW5jdGlvbip9IHVwZGF0ZUNhbGxiYWNrIFRoZSBjYWxsYmFjayBmb3IgbG9hZCBwcm9ncmVzcyB1cGRhdGUsIHBhc3NlcyAwLTEgYXMgcGFyYW0KCSogIEBwYXJhbSB7aW50Kn0gcHJpb3JpdHkgVGhlIHByaW9yaXR5IG9mIHRoZSBsb2FkCgkqICBAcGFyYW0geyp9IGRhdGEgb3B0aW9uYWwgZGF0YQoJKi8KCXAubG9hZCA9IGZ1bmN0aW9uKHVybCwgY2FsbGJhY2ssIHVwZGF0ZUNhbGxiYWNrLCBwcmlvcml0eSwgZGF0YSkKCXsKCQl2YXIgcWkgPSB0aGlzLl9nZXRRSSgpOwoJCQoJCXZhciBiYXNlUGF0aCA9IEFwcGxpY2F0aW9uLmluc3RhbmNlLm9wdGlvbnMuYmFzZVBhdGg7CgkJaWYgKGJhc2VQYXRoICE9PSB1bmRlZmluZWQgJiYgL15odHRwKHMpP1w6Ly50ZXN0KHVybCkgPT09IGZhbHNlICYmIHVybC5zZWFyY2goYmFzZVBhdGgpID09IC0xKQoJCXsKCQkJcWkuYmFzZVBhdGggPSBiYXNlUGF0aDsKCQl9CgkJCgkJcWkudXJsID0gdXJsOwoJCXFpLmNhbGxiYWNrID0gY2FsbGJhY2s7CgkJcWkudXBkYXRlQ2FsbGJhY2sgPSB1cGRhdGVDYWxsYmFjayB8fCBudWxsOwoJCXFpLnByaW9yaXR5ID0gcHJpb3JpdHkgfHwgTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX05PUk1BTDsKCQlxaS5kYXRhID0gZGF0YSB8fCBudWxsOwoJCQoJCXF1ZXVlLnB1c2gocWkpOwoJCQoJCS8vIFNvcnkgYnkgcHJpb3JpdHkKCQlxdWV1ZS5zb3J0KGZ1bmN0aW9uKGEsIGIpewoJCQlyZXR1cm4gYS5wcmlvcml0eSAtIGIucHJpb3JpdHk7CgkJfSk7CgkJCgkJLy8gVHJ5IHRvIGxvYWQgdGhlIG5leHQgcXVldWUgaXRlbQoJCXRoaXMuX3RyeU5leHRMb2FkKCk7Cgl9OwoJCgkvKioKCSogIFRoZXJlIHdhcyBhbiBlcnJvciBsb2FkaW5nIHRoZSBmaWxlCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Mb2FkRmFpbGVkCgkqICBAcGFyYW0ge0xvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqLwoJcC5fb25Mb2FkRmFpbGVkID0gZnVuY3Rpb24ocWksIGV2ZW50KQoJewoJCURlYnVnLmVycm9yKCJVbmFibGUgdG8gbG9hZCBmaWxlOiAiICsgcWkudXJsICArICIgLSByZWFzb246ICIgKyBldmVudC5lcnJvcik7CgkJCgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbcWkudXJsXTsKCQlsb2FkZXIucmVtb3ZlQWxsRXZlbnRMaXN0ZW5lcnMoKTsKCQlsb2FkZXIuY2xvc2UoKTsKCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCgkJZGVsZXRlIHF1ZXVlSXRlbXNbcWkudXJsXTsKCQlkZWxldGUgbG9hZGVyc1txaS51cmxdOwoJCQoJCWlmKHJldHJpZXNbcWkudXJsXSkKCQkJcmV0cmllc1txaS51cmxdKys7CgkJZWxzZQoJCQlyZXRyaWVzW3FpLnVybF0gPSAxOwoJCWlmKHJldHJpZXNbcWkudXJsXSA+IDMpCgkJCXRoaXMuX2xvYWREb25lKHFpLCBudWxsKTsKCQllbHNlCgkJewoJCQludW1Mb2Fkcy0tOwoJCQlxdWV1ZS5wdXNoKHFpKTsKCQkJdGhpcy5fdHJ5TmV4dExvYWQoKTsKCQl9Cgl9OwoJCgkvKioKCSogIFRoZSBmaWxlIGxvYWQgcHJvZ3Jlc3MgZXZlbnQKCSogIEBtZXRob2QgX29uTG9hZFByb2dyZXNzCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtMb2FkZXJRdWV1ZUl0ZW19IHFpIFRoZSBsb2FkZXIgcXVldWUgaXRlbQoJKiAgQHBhcmFtIHtvYmplY3R9IGV2ZW50IFRoZSBwcm9ncmVzcyBldmVudAoJKi8KCXAuX29uTG9hZFByb2dyZXNzID0gZnVuY3Rpb24ocWksIGV2ZW50KQoJewoJCXFpLnByb2dyZXNzID0gZXZlbnQucHJvZ3Jlc3M7CgkJaWYgKHFpLnVwZGF0ZUNhbGxiYWNrKXsKCQkJcWkudXBkYXRlQ2FsbGJhY2socWkucHJvZ3Jlc3MpOwoJCX0JCgl9OwoJCgkvKioKCSogIFRoZSBmaWxlIHdhcyBsb2FkZWQgc3VjY2Vzc2Z1bGx5CgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfb25Mb2FkQ29tcGxldGVkCgkqICBAcGFyYW0ge0xvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gZXYgVGhlIGxvYWQgZXZlbnQKCSovCglwLl9vbkxvYWRDb21wbGV0ZWQgPSBmdW5jdGlvbihxaSwgZXYpCgl7CgkJaWYodHJ1ZSkKCQl7CgkJCURlYnVnLmxvZygiRmlsZSBsb2FkZWQgc3VjY2Vzc2Z1bGx5IGZyb20gIiArIHFpLnVybCk7CgkJfQoJCXZhciBsb2FkZXIgPSBsb2FkZXJzW3FpLnVybF07CgkJbG9hZGVyLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCk7CgkJbG9hZGVyLmNsb3NlKCk7CgkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQoJCWRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF07CgkJZGVsZXRlIGxvYWRlcnNbcWkudXJsXTsKCQl0aGlzLl9sb2FkRG9uZShxaSwgdGhpcy5fZ2V0UmVzdWx0KGV2LnJlc3VsdCwgcWkudXJsLCBsb2FkZXIpKTsKCX07CgkKCS8qKgoJKiAgQXR0ZW1wdCB0byBkbyB0aGUgbmV4dCBsb2FkCgkqICBAbWV0aG9kIF90cnlOZXh0TG9hZAoJKiAgQHByaXZhdGUKCSovCglwLl90cnlOZXh0TG9hZCA9IGZ1bmN0aW9uKCkKCXsKCQlpZiAobnVtTG9hZHMgPiB0aGlzLm1heFNpbXVsdGFuZW91c0xvYWRzIC0gMSB8fCBxdWV1ZS5sZW5ndGggPT09IDApIHJldHVybjsKCQkKCQludW1Mb2FkcysrOwoJCQoJCXZhciBxaSA9IHF1ZXVlLnNoaWZ0KCk7CgkJCgkJaWYodHJ1ZSkKCQl7CgkJCURlYnVnLmxvZygiQXR0ZW1wdGluZyB0byBsb2FkIGZpbGUgJyIgKyBxaS51cmwgKyAiJyIpOwoJCX0KCQkKCQlxdWV1ZUl0ZW1zW3FpLnVybF0gPSBxaTsKCQkKCQl2YXIgbG9hZGVyID0gdGhpcy5fZ2V0TG9hZGVyKHFpLmJhc2VQYXRoKTsKCQkKCQkvLyBBZGQgdG8gdGhlIGxpc3Qgb2YgbG9hZGVycwoJCWxvYWRlcnNbcWkudXJsXSA9IGxvYWRlcjsKCQkKCQlsb2FkZXIuYWRkRXZlbnRMaXN0ZW5lcigiZmlsZWxvYWQiLCBxaS5fYm91bmRDb21wbGV0ZSk7CgkJbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImVycm9yIiwgcWkuX2JvdW5kRmFpbCk7CgkJbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImZpbGVwcm9ncmVzcyIsIHFpLl9ib3VuZFByb2dyZXNzKTsKCQl2YXIgdXJsID0gdGhpcy5jYWNoZU1hbmFnZXIucHJlcGFyZShxaS51cmwpOwoJCWxvYWRlci5sb2FkRmlsZShxaS5kYXRhID8ge2lkOnFpLmRhdGEuaWQsIHNyYzp1cmwsIGRhdGE6cWkuZGF0YX0gOiB1cmwpOwoJfTsKCQoJLyoqCgkqICBBbGVydCB0aGF0IHRoZSBsb2FkaW5nIGlzIGZpbmlzaGVkCgkqICBAcHJpdmF0ZSAKCSogIEBtZXRob2QgX2xvYWREb25lCgkqICBAcGFyYW0ge0xvYWRlclF1ZXVlSXRlbX0gcWkgVGhlIGxvYWRlciBxdWV1ZSBpdGVtCgkqICBAcGFyYW0ge29iamVjdH0gcmVzdWx0IFRoZSBldmVudCBmcm9tIHByZWxvYWRqcyBvciBudWxsCgkqLwoJcC5fbG9hZERvbmUgPSBmdW5jdGlvbihxaSwgcmVzdWx0KQoJewoJCW51bUxvYWRzLS07CgkJaWYocWkuZGF0YSAmJiByZXN1bHQpLy9hIHdheSB0byBrZWVwIHRyYWNrIG9mIGxvYWQgcmVzdWx0cyB3aXRob3V0IGV4Y2Vzc2l2ZSBmdW5jdGlvbiBiaW5kaW5nCgkJCXJlc3VsdC5pZCA9IHFpLmRhdGEuaWQ7CgkJcWkuY2FsbGJhY2socmVzdWx0KTsKCQkvL3FpLmRlc3Ryb3koKTsKCQl0aGlzLl9wb29sUUkocWkpOwoJCXRoaXMuX3RyeU5leHRMb2FkKCk7Cgl9OwoJCgkvKioKCSogIENhbmNlbCBhIGxvYWQgdGhhdCdzIGN1cnJlbnRseSBpbiBwcm9ncmVzcwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBjYW5jZWwKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybAoJKiAgQHJldHVybiB7Ym9vbH0gSWYgY2FuY2VsZWQgcmV0dXJucyB0cnVlLCBmYWxzZSBpZiBub3QgY2FuY2VsZWQKCSovCglwLmNhbmNlbCA9IGZ1bmN0aW9uKHVybCkKCXsKCQl2YXIgcWkgPSBxdWV1ZUl0ZW1zW3VybF07CgkJdmFyIGxvYWRlciA9IGxvYWRlcnNbdXJsXTsKCQkKCQlpZiAocWkgJiYgbG9hZGVyKQoJCXsKCQkJbG9hZGVyLmNsb3NlKCk7CgkJCWRlbGV0ZSBsb2FkZXJzW3VybF07CgkJCWRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF07CgkJCW51bUxvYWRzLS07CgkJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkJdGhpcy5fcG9vbFFJKHFpKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCQoJCWZvcih2YXIgaSA9IDAsIGxlbiA9IHF1ZXVlLmxlbmd0aDsgaSA8IGxlbjsgaSsrKQoJCXsKCQkJcWkgPSBxdWV1ZVtpXTsKCQkJaWYgKHFpLnVybCA9PSB1cmwpewoJCQkJcXVldWUuc3BsaWNlKGksIDEpOwoJCQkJdGhpcy5fcG9vbFFJKHFpKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJCXJldHVybiBmYWxzZTsJCQoJfTsKCQoJcC5fZ2V0UUkgPSBmdW5jdGlvbigpCgl7CgkJdmFyIHJ0bjsKCQlpZihxaVBvb2wubGVuZ3RoKQoJCQlydG4gPSBxaVBvb2wucG9wKCk7CgkJZWxzZQoJCXsKCQkJcnRuID0gbmV3IExvYWRlclF1ZXVlSXRlbSgpOwoJCQlydG4uX2JvdW5kRmFpbCA9IHRoaXMuX29uTG9hZEZhaWxlZC5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRQcm9ncmVzcyA9IHRoaXMuX29uTG9hZFByb2dyZXNzLmJpbmQodGhpcywgcnRuKTsKCQkJcnRuLl9ib3VuZENvbXBsZXRlID0gdGhpcy5fb25Mb2FkQ29tcGxldGVkLmJpbmQodGhpcywgcnRuKTsKCQl9CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xRSSA9IGZ1bmN0aW9uKHFpKQoJewoJCXFpUG9vbC5wdXNoKHFpKTsKCQlxaS5jYWxsYmFjayA9IHFpLnVwZGF0ZUNhbGxiYWNrID0gcWkuZGF0YSA9IHFpLnVybCA9IG51bGw7CgkJcWkucHJvZ3Jlc3MgPSAwOwoJfTsKCQoJcC5fZ2V0TG9hZGVyID0gZnVuY3Rpb24oYmFzZVBhdGgpCgl7CgkJdmFyIHJ0bjsKCQlpZihsb2FkZXJQb29sLmxlbmd0aCkKCQl7CgkJCXJ0biA9IGxvYWRlclBvb2wucG9wKCk7CgkJCXJ0bi5fYmFzZVBhdGggPSBiYXNlUGF0aDsvL2FwcGFyZW50bHkgdGhleSBuZWdsZWN0ZWQgdG8gbWFrZSB0aGlzIHB1YmxpYwoJCX0KCQllbHNlCgkJCXJ0biA9IG5ldyBMb2FkUXVldWUodHJ1ZSwgYmFzZVBhdGgpOwoJCS8vYWxsb3cgdGhlIGxvYWRlciB0byBoYW5kbGUgc291bmQgYXMgd2VsbAoJCWlmKFNvdW5kKQoJCXsKCQkJcnRuLmluc3RhbGxQbHVnaW4oU291bmQpOwoJCX0KCQlyZXR1cm4gcnRuOwoJfTsKCQoJcC5fcG9vbExvYWRlciA9IGZ1bmN0aW9uKGxvYWRlcikKCXsKCQlsb2FkZXIucmVtb3ZlQWxsKCk7Ly9jbGVhciB0aGUgbG9hZGVyIGZvciByZXVzZQoJCWxvYWRlclBvb2wucHVzaChsb2FkZXIpOwoJfTsKCQoJcC5fZ2V0UmVzdWx0ID0gZnVuY3Rpb24ocmVzdWx0LCB1cmwsIGxvYWRlcikKCXsKCQl2YXIgcnRuOwoJCWlmKHJlc3VsdFBvb2wubGVuZ3RoKQoJCXsKCQkJcnRuID0gcmVzdWx0UG9vbC5wb3AoKTsKCQkJcnRuLmNvbnRlbnQgPSByZXN1bHQ7CgkJCXJ0bi51cmwgPSB1cmw7CgkJCXJ0bi5sb2FkZXIgPSBsb2FkZXI7CgkJfQoJCWVsc2UKCQkJcnRuID0gbmV3IExvYWRlclJlc3VsdChyZXN1bHQsIHVybCwgbG9hZGVyKTsKCQlyZXR1cm4gcnRuOwoJfTsKCQoJcC5fcG9vbFJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdCkKCXsKCQlyZXN1bHQuY29udGVudCA9IHJlc3VsdC51cmwgPSByZXN1bHQubG9hZGVyID0gcmVzdWx0LmlkID0gbnVsbDsKCQlyZXN1bHRQb29sLnB1c2gocmVzdWx0KTsKCX07CgkKCS8vIE1lZGlhTG9hZGVyIG5hbWUgaXMgZGVwcmVjYXRlZAoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuTWVkaWFMb2FkZXIgPSBMb2FkZXI7CgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5Mb2FkZXIgPSBMb2FkZXI7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKCl7CgkKCS8qKgoJKiAgVGhlIHJldHVybiByZXN1bHQgb2YgdGhlIExvYWRlciBsb2FkCgkqICBAY2xhc3MgTG9hZGVyUmVzdWx0CgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7Kn0gY29udGVudCBUaGUgZHluYW1pYyBjb250ZW50IGxvYWRlZAoJKiAgQHBhcmFtIHtzdHJpbmd9IHVybCBUaGUgdXJsIHRoYXQgd2FzIGxvYWRlZAoJKiAgQHBhcmFtIHtjcmVhdGVqcy5Mb2FkUXVldWV9IGxvYWRlciBUaGUgTG9hZFF1ZXVlIHRoYXQgcGVyZm9ybWVkIHRoZSBsb2FkCgkqLwoJdmFyIExvYWRlclJlc3VsdCA9IGZ1bmN0aW9uKGNvbnRlbnQsIHVybCwgbG9hZGVyKQoJewoJCS8qKgoJCSogIFRoZSBjb250ZW50cyBvZiB0aGUgbG9hZAoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkgeyp9IGNvbnRlbnQgCgkJKi8KCQl0aGlzLmNvbnRlbnQgPSBjb250ZW50OwoKCQkvKioKCQkqICBUaGUgdXJsIG9mIHRoZSBsb2FkCgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCQkqLwoJCXRoaXMudXJsID0gdXJsOwoKCQkvKioKCQkqICBSZWZlcmVuY2UgdG8gdGhlIHByZWxvYWRlciBvYmplY3QKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHtjcmVhdGVqcy5Mb2FkZXJRdWV1ZX0gbG9hZGVyCgkJKi8KCQl0aGlzLmxvYWRlciA9IGxvYWRlcjsKCX07CgkKCS8qKiBSZWZlcmVuY2UgdG8gdGhlIHByb3RvdHlwZSAqLwoJdmFyIHAgPSBMb2FkZXJSZXN1bHQucHJvdG90eXBlOwoJCgkvKioKCSogQSB0byBzdHJpbmcgbWV0aG9kCgkqIEBwdWJsaWMKCSogQG1ldGhvZCB0b1N0cmluZwoJKiBAcmV0dXJuIHtzdHJpbmd9IEEgc3RyaW5nIHJlcCBvZiB0aGUgb2JqZWN0CgkqLwoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkKCXsKCQlyZXR1cm4gIltMb2FkZXJSZXN1bHQoJyIrdGhpcy51cmwrIicpXSI7Cgl9OwoJCgkvKioKCSogRGVzdHJveSB0aGlzIHJlc3VsdAoJKiBAcHVibGljCgkqIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLmNhbGxiYWNrID0gbnVsbDsKCQl0aGlzLnVybCA9IG51bGw7CgkJdGhpcy5jb250ZW50ID0gbnVsbDsKCX07CgkKCS8vIEFzc2lnbiB0byB0aGUgbmFtZSBzcGFjZQoJLy8gTWVkaWFMb2FkZVJlc3VsdCBpcyBkZXByZWNhdGVkCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5NZWRpYUxvYWRlclJlc3VsdCA9IExvYWRlclJlc3VsdDsKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLkxvYWRlclJlc3VsdCA9IExvYWRlclJlc3VsdDsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbigpIHsKCQoJLyoqCgkqICBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCBhcyBhIG5vcm1hbCBjYWxsYmFjaywgYnV0IGNoZWNrcyBhbiBvYmplY3QgZm9yIGEgcHJvcGVydHkgaW4gb3JkZXIgdG8gY29tYmluZSB0d28KCSogIGNhbGxiYWNrcyBpbnRvIG9uZS4gRm9yIGV4YW1wbGUgdXNhZ2U6CgkqCgkqICB2YXIgdm9QbGF5ZXIgPSBuZXcgc3ByaW5ncm9sbC5WT1BsYXllcigpOwoJKiAgdmFyIGNhbGxiYWNrID0gc3ByaW5ncm9sbC5Db21iaW5lZENhbGxiYWNrLmNyZWF0ZShteUZ1bmMuYmluZCh0aGlzKSwgdm9QbGF5ZXIsICJwbGF5aW5nIiwgIl9jYWxsYmFjayIpOwoJKiAgQW5pbWF0b3IucGxheShteUNsaXAsICJteUFuaW0iLCBjYWxsYmFjayk7CgkqICAKCSogIEluIHRoaXMgZXhhbXBsZSwgd2hlbiBBbmltYXRvciBjYWxscyAnY2FsbGJhY2snLCBpZiB2b1BsYXllclsicGxheWluZyJdIGlzIGZhbHNlLCAnbXlGdW5jJyBpcyBjYWxsZWQgaW1tZWRpYXRlbHkuCgkqICBJZiB2b1BsYXllclsicGxheWluZyJdIGlzIHRydWUsIHRoZW4gdm9QbGF5ZXJbIl9jYWxsYmFjayJdIGlzIHNldCB0byAnbXlGdW5jJyBzbyB0aGF0IGl0IHdpbGwgYmUgY2FsbGVkIHdoZW4gdm9QbGF5ZXIgY29tcGxldGVzLgoJKiAgCgkqICBAY2xhc3MgQ29tYmluZWRDYWxsYmFjawoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsIFRoZSBjYWxsYmFjayB0byBjYWxsIHdoZW4gZXZlcnl0aGluZyBpcyBjb21wbGV0ZS4KCSogIEBwYXJhbSB7Kn0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgYXMgYW4gYWRkaXRpb25hbCBjb21wbGV0aW9uIGRlcGVuZGVuY3kuCgkqICBAcGFyYW0ge1N0cmluZ30gcHJvcCBUaGUgcHJvcGVydHkgdG8gY2hlY2sgb24gb2JqLiBJZiBvYmpbcHJvcF0gaXMgZmFsc2UsIHRoZW4gaXQgaXMgY29uc2lkZXJlZCBjb21wbGV0ZS4KCSogIEBwYXJhbSB7U3RyaW5nfSBjYWxsUHJvcCBUaGUgcHJvcGVydHkgdG8gc2V0IG9uIG9iaiBpZiBvYmpbcHJvcF0gaXMgdHJ1ZSB3aGVuIHRoZSBDb21iaW5lZENhbGxiYWNrIGlzIGNhbGxlZC4KCSovCgl2YXIgQ29tYmluZWRDYWxsYmFjayA9IGZ1bmN0aW9uKGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApCgl7CgkJaWYoIW9ialtwcm9wXSkvL2FjY2VwdCBhbnl0aGluZyB0aGF0IHJlc29sdmVzIHRvIGZhbHNlOiBlZyB2b1BsYXllci5wbGF5aW5nID09IGZhbHNlCgkJCWNhbGwoKTsKCQllbHNlCgkJCW9ialtjYWxsUHJvcF0gPSBjYWxsOwoJfTsKCgkvKioKCSogIENyZWF0ZXMgYSBDb21iaW5lZENhbGxiYWNrIGZvciB1c2UuCgkqICAKCSogIEBtZXRob2QgY3JlYXRlCgkqICBAc3RhdGljCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsIFRoZSBjYWxsYmFjayB0byBjYWxsIHdoZW4gZXZlcnl0aGluZyBpcyBjb21wbGV0ZS4KCSogIEBwYXJhbSB7Kn0gb2JqIFRoZSBvYmplY3QgdG8gY2hlY2sgYXMgYW4gYWRkaXRpb25hbCBjb21wbGV0aW9uIGRlcGVuZGVuY3kuCgkqICBAcGFyYW0ge1N0cmluZ30gcHJvcCBUaGUgcHJvcGVydHkgdG8gY2hlY2sgb24gb2JqLiBJZiBvYmpbcHJvcF0gaXMgZmFsc2UsIHRoZW4gaXQgaXMgY29uc2lkZXJlZCBjb21wbGV0ZS4KCSogIEBwYXJhbSB7U3RyaW5nfSBjYWxsUHJvcCBUaGUgcHJvcGVydHkgdG8gc2V0IG9uIG9iaiBpZiBvYmpbcHJvcF0gaXMgdHJ1ZSB3aGVuIHRoZSBDb21iaW5lZENhbGxiYWNrIGlzIGNhbGxlZC4KCSovCglDb21iaW5lZENhbGxiYWNrLmNyZWF0ZSA9IGZ1bmN0aW9uKGNhbGwsIG9iaiwgcHJvcCwgY2FsbFByb3ApCgl7CgkJcmV0dXJuIENvbWJpbmVkQ2FsbGJhY2suYmluZCh0aGlzLCBjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKTsKCX07CgoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuQ29tYmluZWRDYWxsYmFjayA9IENvbWJpbmVkQ2FsbGJhY2s7Cn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgkJCgkvKiogCgkqICBUaGUgU2F2ZWREYXRhIGZ1bmN0aW9ucyB1c2UgbG9jYWxTdG9yYWdlIGFuZCBzZXNzaW9uU3RvcmFnZSwgd2l0aCBhIGNvb2tpZSBmYWxsYmFjay4gCgkqCgkqICBAY2xhc3MgU2F2ZWREYXRhCgkqLwoJdmFyIFNhdmVkRGF0YSA9IHt9LAoJCgkvKiogQSBjb25zdGFudCB0byBkZXRlcm1pbmUgaWYgd2UgY2FuIHVzZSBsb2NhbFN0b3JhZ2UgYW5kIHNlc3Npb25TdG9yYWdlICovCglXRUJfU1RPUkFHRV9TVVBQT1JUID0gd2luZG93LlN0b3JhZ2UgIT09IHVuZGVmaW5lZCwKCQoJLyoqIEEgY29uc3RhbnQgZm9yIGNvb2tpZSBmYWxsYmFjayBmb3IgU2F2ZWREYXRhLmNsZWFyKCkgKi8KCUVSQVNFX0NPT0tJRSA9IC0xOwoKCS8vaW4gaU9TLCBpZiB0aGUgdXNlciBpcyBpbiBQcml2YXRlIEJyb3dzaW5nLCB3cml0aW5nIHRvIGxvY2FsU3RvcmFnZSB0aHJvd3MgYW4gZXJyb3IuCglpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJewoJCXRyeQoJCXsKCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oIkxTX1RFU1QiLCAidGVzdCIpOwoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbSgiTFNfVEVTVCIpOwoJCX0KCQljYXRjaChlKQoJCXsKCQkJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IGZhbHNlOwoJCX0KCX0KCQoJLyoqIAoJKiAgUmVtb3ZlIGEgc2F2ZWQgdmFyaWFibGUgYnkgbmFtZS4KCSogIEBtZXRob2QgcmVtb3ZlCgkqICBAc3RhdGljCgkqICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdmFsdWUgdG8gcmVtb3ZlCgkqLwoJU2F2ZWREYXRhLnJlbW92ZSA9IGZ1bmN0aW9uKG5hbWUpCgl7CgkJaWYoV0VCX1NUT1JBR0VfU1VQUE9SVCkKCQl7CgkJCWxvY2FsU3RvcmFnZS5yZW1vdmVJdGVtKG5hbWUpOwoJCQlzZXNzaW9uU3RvcmFnZS5yZW1vdmVJdGVtKG5hbWUpOwoJCX0KCQllbHNlCgkJCVNhdmVkRGF0YS53cml0ZShuYW1lLCIiLEVSQVNFX0NPT0tJRSk7Cgl9OwoJCgkvKioKCSogIFNhdmUgYSB2YXJpYWJsZS4KCSogIEBtZXRob2Qgd3JpdGUKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YWx1ZSB0byBzYXZlCgkqICBAcGFyYW0ge21peGVkfSB2YWx1ZSBUaGUgdmFsdWUgdG8gc2F2ZS4gVGhpcyB3aWxsIGJlIHJ1biB0aHJvdWdoIEpTT04uc3RyaW5naWZ5KCkuCgkqICBAcGFyYW0ge0Jvb2xlYW59IFt0ZW1wT25seT1mYWxzZV0gSWYgdGhlIHZhbHVlIHNob3VsZCBiZSBzYXZlZCBvbmx5IGluIHRoZSBjdXJyZW50IGJyb3dzZXIgc2Vzc2lvbi4KCSovCglTYXZlZERhdGEud3JpdGUgPSBmdW5jdGlvbihuYW1lLCB2YWx1ZSwgdGVtcE9ubHkpCgl7CgkJaWYoV0VCX1NUT1JBR0VfU1VQUE9SVCkKCQl7CgkJCWlmKHRlbXBPbmx5KQoJCQkJc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbShuYW1lLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOwoJCQllbHNlCgkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbShuYW1lLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpOwoJCX0KCQllbHNlCgkJewoJCQl2YXIgZXhwaXJlczsKCQkJaWYgKHRlbXBPbmx5KQoJCQl7CgkJCQlpZih0ZW1wT25seSAhPT0gRVJBU0VfQ09PS0lFKQoJCQkJCWV4cGlyZXMgPSAiIjsvL3JlbW92ZSB3aGVuIGJyb3dzZXIgaXMgY2xvc2VkCgkJCQllbHNlCgkJCQkJZXhwaXJlcyA9ICI7IGV4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVQiOy8vc2F2ZSBjb29raWUgaW4gdGhlIHBhc3QgZm9yIGltbWVkaWF0ZSByZW1vdmFsCgkJCX0KCQkJZWxzZQoJCQkJZXhwaXJlcyA9ICI7IGV4cGlyZXM9IituZXcgRGF0ZSgyMTQ3NDgzNjQ2MDAwKS50b0dNVFN0cmluZygpOy8vVEhFIEVORCBPRiAoMzJiaXQgVU5JWCkgVElNRSEKCQkJCQoJCQlkb2N1bWVudC5jb29raWUgPSBuYW1lKyI9Iitlc2NhcGUoSlNPTi5zdHJpbmdpZnkodmFsdWUpKStleHBpcmVzKyI7IHBhdGg9LyI7CgkJfQoJfTsKCQoJLyoqCgkqICBSZWFkIHRoZSB2YWx1ZSBvZiBhIHNhdmVkIHZhcmlhYmxlCgkqICBAbWV0aG9kIHJlYWQKCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7U3RyaW5nfSBuYW1lIFRoZSBuYW1lIG9mIHRoZSB2YXJpYWJsZQoJKiAgQHJldHVybiB7bWl4ZWR9IFRoZSB2YWx1ZSAocnVuIHRocm91Z2ggYEpTT04ucGFyc2UoKWApIG9yIG51bGwgaWYgaXQgZG9lc24ndCBleGlzdAoJKi8KCVNhdmVkRGF0YS5yZWFkID0gZnVuY3Rpb24obmFtZSkKCXsKCQlpZihXRUJfU1RPUkFHRV9TVVBQT1JUKQoJCXsKCQkJdmFyIHZhbHVlID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0obmFtZSkgfHwgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbShuYW1lKTsKCQkJaWYodmFsdWUpCgkJCQlyZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CgkJCWVsc2UKCQkJCXJldHVybiBudWxsOwoJCX0KCQllbHNlCgkJewoJCQl2YXIgbmFtZUVRID0gbmFtZSArICI9IiwKCQkJCWNhID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7JyksCgkJCQlpID0gMCwgYzsKCQkJCQoJCQlmb3IoaT0wO2kgPCBjYS5sZW5ndGg7aSsrKQoJCQl7CgkJCQljID0gY2FbaV07CgkJCQl3aGlsZSAoYy5jaGFyQXQoMCkgPT0gJyAnKSBjID0gYy5zdWJzdHJpbmcoMSxjLmxlbmd0aCk7CgkJCQlpZiAoYy5pbmRleE9mKG5hbWVFUSkgPT09IDApIHJldHVybiBKU09OLnBhcnNlKHVuZXNjYXBlKGMuc3Vic3RyaW5nKG5hbWVFUS5sZW5ndGgsYy5sZW5ndGgpKSk7CgkJCX0KCQkJcmV0dXJuIG51bGw7CgkJfQoJfTsKCQoJLy8gQXNzaWduIHRvIHRoZSBnbG9iYWwgc3BhY2UKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLlNhdmVkRGF0YSA9IFNhdmVkRGF0YTsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbih1bmRlZmluZWQpIHsKCgl2YXIgQXBwbGljYXRpb24gPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkFwcGxpY2F0aW9uJyk7CgoJLyoqCgkqICBBIGNsYXNzIGZvciBkZWxheWluZyBhIGNhbGwgdGhyb3VnaCB0aGUgQXBwbGljYXRpb24sIGluc3RlYWQgb2YgcmVseWluZyBvbiBzZXRJbnRlcnZhbCgpIG9yIHNldFRpbWVvdXQoKS4KCSogCgkqICBAY2xhc3MgRGVsYXllZENhbGwKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIGNhbGwgd2hlbiB0aGUgZGVsYXkgaGFzIGNvbXBsZXRlZC4KCSogIEBwYXJhbSB7aW50fSBkZWxheSBUaGUgdGltZSB0byBkZWxheSB0aGUgY2FsbCwgaW4gbWlsbGlzZWNvbmRzLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbcmVwZWF0PWZhbHNlXSBJZiB0aGUgRGVsYXllZENhbGwgc2hvdWxkIGF1dG9tYXRpY2FsbHkgcmVwZWF0IGl0c2VsZiB3aGVuIGNvbXBsZXRlZC4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2F1dG9EZXN0cm95PXRydWVdIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgY2xlYW4gaXRzZWxmIHVwIHdoZW4gY29tcGxldGVkLgoJKi8KCXZhciBEZWxheWVkQ2FsbCA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBkZWxheSwgcmVwZWF0LCBhdXRvRGVzdHJveSkKCXsJCQoJCS8qKgoJCSogIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGlzIGNvbXBsZXRlZC4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7ZnVuY3Rpb259IF9jYWxsYmFjawoJCSovCgkJdGhpcy5fY2FsbGJhY2sgPSBjYWxsYmFjazsKCgkJLyoqCgkJKiAgVGhlIGRlbGF5IHRpbWUsIGluIG1pbGxpc2Vjb25kcy4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7aW50fSBfZGVsYXkKCQkqLwoJCXRoaXMuX2RlbGF5ID0gZGVsYXk7CgoJCS8qKgoJCSogIFRoZSB0aW1lciBjb3VudGluZyBkb3duIGZyb20gX2RlbGF5LCBpbiBtaWxsaXNlY29uZHMuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2ludH0gX3RpbWVyCgkJKi8KCQl0aGlzLl90aW1lciA9IGRlbGF5OwoKCQkvKioKCQkqICBJZiB0aGUgRGVsYXllZENhbGwgc2hvdWxkIHJlcGVhdCBpdHNlbGYgYXV0b21hdGljYWxseS4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX3JlcGVhdAoJCSogIEBkZWZhdWx0IGZhbHNlCgkJKi8KCQl0aGlzLl9yZXBlYXQgPSAhIXJlcGVhdDsKCgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBkZXN0cm95IGl0c2VsZiBhZnRlciBjb21wbGV0aW5nCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9hdXRvRGVzdHJveQoJCSogIEBkZWZhdWx0IHRydWUKCQkqLwoJCXRoaXMuX2F1dG9EZXN0cm95ID0gYXV0b0Rlc3Ryb3kgPT09IHVuZGVmaW5lZCA/IHRydWUgOiAhIWF1dG9EZXN0cm95OwoKCQkvKioKCQkqICBJZiB0aGUgRGVsYXllZENhbGwgaXMgY3VycmVudGx5IHBhdXNlZCAobm90IHN0b3BwZWQpLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfcGF1c2VkCgkJKi8KCQl0aGlzLl9wYXVzZWQgPSBmYWxzZTsKCgkJLy9zYXZlIGEgYm91bmQgdmVyc2lvbiBvZiB0aGUgdXBkYXRlIGZ1bmN0aW9uCgkJdGhpcy5fdXBkYXRlID0gdGhpcy5fdXBkYXRlLmJpbmQodGhpcyk7CgoJCS8vc3RhcnQgdGhlIGRlbGF5CgkJQXBwbGljYXRpb24uaW5zdGFuY2Uub24oInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7Cgl9OwoKCXZhciBwID0gRGVsYXllZENhbGwucHJvdG90eXBlOwoKCS8qKgoJKiAgVGhlIGNhbGxiYWNrIHN1cHBsaWVkIHRvIHRoZSBBcHBsaWNhdGlvbiBmb3IgYW4gdXBkYXRlIGVhY2ggZnJhbWUuCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCBfdXBkYXRlCgkqICBAcGFyYW0ge2ludH0gZWxhcHNlZCBUaGUgdGltZSBlbGFwc2VkIHNpbmNlIHRoZSBwcmV2aW91cyBmcmFtZS4KCSovCglwLl91cGRhdGUgPSBmdW5jdGlvbihlbGFwc2VkKQoJewoJCWlmKCF0aGlzLl9jYWxsYmFjaykKCQl7CgkJCXRoaXMuZGVzdHJveSgpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl90aW1lciAtPSBlbGFwc2VkOwoJCWlmKHRoaXMuX3RpbWVyIDw9IDApCgkJewoJCQl0aGlzLl9jYWxsYmFjaygpOwoJCQlpZih0aGlzLl9yZXBlYXQpCgkJCQl0aGlzLl90aW1lciArPSB0aGlzLl9kZWxheTsKCQkJZWxzZSBpZih0aGlzLl9hdXRvRGVzdHJveSkKCQkJCXRoaXMuZGVzdHJveSgpOwoJCQllbHNlCgkJCQlBcHBsaWNhdGlvbi5pbnN0YW5jZS5vZmYoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJfQoJfTsKCgkvKioKCSogIFJlc3RhcnRzIHRoZSBEZWxheWVkQ2FsbCwgd2hldGhlciBpdCBpcyBydW5uaW5nIG9yIG5vdC4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcmVzdGFydAoJKi8KCXAucmVzdGFydCA9IGZ1bmN0aW9uKCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spIHJldHVybjsKCQl2YXIgYXBwID0gQXBwbGljYXRpb24uaW5zdGFuY2U7CgkJaWYoIWFwcC5oYXMoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSkpCgkJCWFwcC5vbigidXBkYXRlIiwgdGhpcy5fdXBkYXRlKTsKCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5OwoJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJfTsKCgkvKioKCSogIFN0b3BzIHRoZSBEZWxheWVkQ2FsbCwgd2l0aG91dCBkZXN0cm95aW5nIGl0LgoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBzdG9wCgkqLwoJcC5zdG9wID0gZnVuY3Rpb24oKQoJewoJCUFwcGxpY2F0aW9uLmluc3RhbmNlLm9mZigidXBkYXRlIiwgdGhpcy5fdXBkYXRlKTsKCQl0aGlzLl9wYXVzZWQgPSBmYWxzZTsKCX07CgoJLyoqCgkqICBJZiB0aGUgRGVsYXllZENhbGwgaXMgcGF1c2VkIG9yIG5vdC4KCSogIEBwdWJsaWMKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gcGF1c2VkCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJwYXVzZWQiLCB7CgkJZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIHRoaXMuX3BhdXNlZDsgfSwKCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCXsKCQkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJCXZhciBhcHAgPSBBcHBsaWNhdGlvbi5pbnN0YW5jZTsKCQkJaWYodGhpcy5fcGF1c2VkICYmICF2YWx1ZSkKCQkJewoJCQkJdGhpcy5fcGF1c2VkID0gZmFsc2U7CgkJCQlpZighYXBwLmhhcygidXBkYXRlIiwgdGhpcy5fdXBkYXRlKSkKCQkJCQlhcHAub24oInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJCX0KCQkJZWxzZSBpZih2YWx1ZSkKCQkJewoJCQkJaWYoYXBwLmhhcygidXBkYXRlIiwgdGhpcy5fdXBkYXRlKSkKCQkJCXsKCQkJCQl0aGlzLl9wYXVzZWQgPSB0cnVlOwoJCQkJCWFwcC5vZmYoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJCQl9CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIFN0b3BzIGFuZCBjbGVhbnMgdXAgdGhlIERlbGF5ZWRDYWxsLiBEbyBub3QgdXNlIGl0IGFmdGVyIGNhbGxpbmcKCSogIGRlc3Ryb3koKS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQlBcHBsaWNhdGlvbi5pbnN0YW5jZS5vZmYoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJdGhpcy5fY2FsbGJhY2sgPSBudWxsOwoJfTsKCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5EZWxheWVkQ2FsbCA9IERlbGF5ZWRDYWxsOwp9KCkpO30oKTs=",
                "body": "LyohIFNwcmluZ1JvbGwgMC4wLjYgKi8KIWZ1bmN0aW9uKCl7InVzZSBzdHJpY3QiOy8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqLwovKioKKiAgU3RhdGljIGNsYXNzIGZvciBuYW1lc3BhY2luZyBvYmplY3RzIGFuZCBhZGRpbmcKKiAgY2xhc3NlcyB0byBpdC4KKiAgQGNsYXNzIG5hbWVzcGFjZQoqICBAc3RhdGljCiovCihmdW5jdGlvbih3aW5kb3cpewoJCgkvLyBUaGUgbmFtZXNwYWNlIGZ1bmN0aW9uIGFscmVhZHkgZXhpc3RzCglpZiAoIm5hbWVzcGFjZSIgaW4gd2luZG93KSByZXR1cm47CgkKCS8qKgoJKiAgQ3JlYXRlIHRoZSBuYW1lc3BhY2UgYW5kIGFzc2luZyB0byB0aGUgd2luZG93CgkqCgkqICBAZXhhbXBsZQoJCXZhciBTcHJpdGVVdGlscyA9IGZ1bmN0aW9uKCl7fTsKCQluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5TcHJpdGVVdGlscyA9IFNwcml0ZVV0aWxzOwoJKgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAbWV0aG9kIG5hbWVzcGFjZQoJKiAgQHBhcmFtIHtzdHJpbmd9IG5hbWVzcGFjZVN0cmluZyBOYW1lIHNwYWNlLCBmb3IgaW5zdGFuY2UgJ3NwcmluZ3JvbGwudXRpbHMnCgkqICBAcmV0dXJuIHtvYmplY3R9IFRoZSBuYW1lc3BhY2Ugb2JqZWN0IGF0dGFjaGVkIHRvIHRoZSBjdXJyZW50IHdpbmRvdwoJKi8KCXZhciBuYW1lc3BhY2UgPSBmdW5jdGlvbihuYW1lc3BhY2VTdHJpbmcpIHsKCQl2YXIgcGFydHMgPSBuYW1lc3BhY2VTdHJpbmcuc3BsaXQoJy4nKSwKCQkJcGFyZW50ID0gd2luZG93LAoJCQljdXJyZW50UGFydCA9ICcnOwoKCQlmb3IodmFyIGkgPSAwLCBsZW5ndGggPSBwYXJ0cy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykKCQl7CgkJCWN1cnJlbnRQYXJ0ID0gcGFydHNbaV07CgkJCXBhcmVudFtjdXJyZW50UGFydF0gPSBwYXJlbnRbY3VycmVudFBhcnRdIHx8IHt9OwoJCQlwYXJlbnQgPSBwYXJlbnRbY3VycmVudFBhcnRdOwoJCX0KCQlyZXR1cm4gcGFyZW50OwoJfTsKCQoJLy8gQXNzaWduIHRvIHRoZSB3aW5kb3cgbmFtZXNwYWNlCgl3aW5kb3cubmFtZXNwYWNlID0gbmFtZXNwYWNlOwoJCn0od2luZG93KSk7CgoKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiovCi8qKgoqICBVc2VkIHRvIGluY2x1ZGUgcmVxdWlyZWQgY2xhc3NlcyBieSBuYW1lCiogIEBjbGFzcyBpbmNsdWRlCiogIEBzdGF0aWMKKi8KKGZ1bmN0aW9uKHdpbmRvdywgdW5kZWZpbmVkKXsKCQoJLy8gVGhlIGluY2x1ZGUgZnVuY3Rpb24gYWxyZWFkeSBleGlzdHMKCWlmICgiaW5jbHVkZSIgaW4gd2luZG93KSByZXR1cm47CgkKCS8qKgoJKiAgSW1wb3J0IGEgY2xhc3MKCSoKCSogIEBleGFtcGxlCgkJdmFyIEFwcGxpY2F0aW9uID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5BcHBsaWNhdGlvbicpOwoJKgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAbWV0aG9kIGluY2x1ZGUKCSogIEBwYXJhbSB7c3RyaW5nfSBuYW1lc3BhY2VTdHJpbmcgTmFtZSBzcGFjZSwgZm9yIGluc3RhbmNlICdzcHJpbmdyb2xsLkFwcGxpY2F0aW9uJwoJKiAgQHBhcmFtIHtCb29sZWFufSBbcmVxdWlyZWQ9dHJ1ZV0gSWYgdGhlIGNsYXNzIHdlJ3JlIHRyeWluZyB0byBpbmNsdWRlIGlzIHJlcXVpcmVkLgoJKiAJCUZvciBjbGFzc2VzIHRoYXQgYXJlbid0IGZvdW5kIGFuZCBhcmUgcmVxdWlyZWQsIGFuIGVycm9yIGlzIHRocm93bi4KCSogIEByZXR1cm4ge29iamVjdHxmdW5jdGlvbn0gVGhlIG9iamVjdCBhdHRhY2hlZCBhdCB0aGUgZ2l2ZW4gbmFtZXNwYWNlCgkqLwoJdmFyIGluY2x1ZGUgPSBmdW5jdGlvbihuYW1lc3BhY2VTdHJpbmcsIHJlcXVpcmVkKQoJewoJCXZhciBwYXJ0cyA9IG5hbWVzcGFjZVN0cmluZy5zcGxpdCgnLicpLAoJCQlwYXJlbnQgPSB3aW5kb3csCgkJCWN1cnJlbnRQYXJ0ID0gJyc7CgkJCgkJcmVxdWlyZWQgPSByZXF1aXJlZCAhPT0gdW5kZWZpbmVkID8gISFyZXF1aXJlZCA6IHRydWU7CgoJCWZvcih2YXIgaSA9IDAsIGxlbmd0aCA9IHBhcnRzLmxlbmd0aDsgaSA8IGxlbmd0aDsgaSsrKQoJCXsKCQkJY3VycmVudFBhcnQgPSBwYXJ0c1tpXTsKCQkJaWYgKCFwYXJlbnRbY3VycmVudFBhcnRdKQoJCQl7CgkJCQlpZiAoIXJlcXVpcmVkKQoJCQkJewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQkJaWYgKHRydWUpCgkJCQl7CgkJCQkJdGhyb3cgIlVuYWJsZSB0byBpbmNsdWRlICciICsgbmFtZXNwYWNlU3RyaW5nICsgIicgYmVjYXVzZSB0aGUgY29kZSBpcyBub3QgaW5jbHVkZWQgb3IgdGhlIGNsYXNzIG5lZWRzIHRvIGxvYWRlZCBzb29uZXIuIjsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQl0aHJvdyAiVW5hYmxlIHRvIGluY2x1ZGUgJyIgKyBuYW1lc3BhY2VTdHJpbmcgKyAiJyI7CgkJCQl9CgkJCX0KCQkJcGFyZW50ID0gcGFyZW50W2N1cnJlbnRQYXJ0XTsKCQl9CgkJcmV0dXJuIHBhcmVudDsKCX07CgkKCS8vIEFzc2lnbiB0byB0aGUgd2luZG93IG5hbWVzcGFjZQoJd2luZG93LmluY2x1ZGUgPSBpbmNsdWRlOwoJCn0od2luZG93KSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqLwooZnVuY3Rpb24oT2JqZWN0LCB1bmRlZmluZWQpewoKCS8qKgoJKiAgQWRkIG1ldGhvZHMgdG8gT2JqZWN0CgkqICBAY2xhc3MgT2JqZWN0CgkqLwoKCS8qKgoJKiAgTWVyZ2VzIHR3byAob3IgbW9yZSkgb2JqZWN0cywgZ2l2aW5nIHRoZSBsYXN0IG9uZSBwcmVjZWRlbmNlCgkqICBAbWV0aG9kIG1lcmdlCgkqICBAZXhhbXBsZQoJCXZhciBvYmoxID0geyBpZCA6ICdmb28nLCBuYW1lIDogJ0hlbGxvIScsIHZhbHVlIDogMTAwIH07CgkJdmFyIG9iajIgPSB7IGlkIDogJ2JhcicsIHZhbHVlIDogMjAwIH07CgkJT2JqZWN0Lm1lcmdlKHt9LCBvYmoxLCBvYmoyKTsgLy8gUmV0dXJuczogeyBpZCA6ICdiYXInLCBuYW1lIDogJ0hlbGxvIScsIHZhbHVlIDogMjAwIH0KCSogIEBzdGF0aWMKCSogIEBwYXJhbSB7b2JqZWN0fSB0YXJnZXQgVGhlIHRhcmdldCBvYmplY3QKCSogIEBwYXJhbSB7b2JqZWN0fSBzb3VyY2UqIEFkZGl0aW9uYWwgb2JqZWN0cyB0byBhZGQKCSovCglPYmplY3QubWVyZ2UgPSBmdW5jdGlvbih0YXJnZXQsIHNvdXJjZSkKCXsJCQoJCWlmICh0eXBlb2YgdGFyZ2V0ICE9PSAnb2JqZWN0JykgCgkJewoJCQl0YXJnZXQgPSB7fTsKCQl9CgkJCgkJZm9yICh2YXIgcHJvcGVydHkgaW4gc291cmNlKQoJCXsKCQkJaWYgKHNvdXJjZS5oYXNPd25Qcm9wZXJ0eShwcm9wZXJ0eSkpCgkJCXsKCQkJCXZhciBzb3VyY2VQcm9wZXJ0eSA9IHNvdXJjZVtwcm9wZXJ0eV07CgkJCQkKCQkJCWlmICh0eXBlb2Ygc291cmNlUHJvcGVydHkgPT09ICdvYmplY3QnICYmIE9iamVjdC5pc1BsYWluKHNvdXJjZVByb3BlcnR5KSkKCQkJCXsKCQkJCQl0YXJnZXRbcHJvcGVydHldID0gT2JqZWN0Lm1lcmdlKHRhcmdldFtwcm9wZXJ0eV0sIHNvdXJjZVByb3BlcnR5KTsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCXRhcmdldFtwcm9wZXJ0eV0gPSBzb3VyY2VQcm9wZXJ0eTsKCQkJfQoJCX0KCQkKCQlmb3IgKHZhciBpID0gMiwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspCgkJewoJCQlPYmplY3QubWVyZ2UodGFyZ2V0LCBhcmd1bWVudHNbaV0pOwoJCX0KCQlyZXR1cm4gdGFyZ2V0OwoJfTsKCgkvKioKCSogIENoZWNrIHRvIHNlZSBpZiBhbiBvYmplY3QgaXMgYSBwbGFpbiBvYmplY3QgZGVmaW5pdGlvbgoJKiAgQG1ldGhvZCBpc1BsYWluCgkqICBAc3RhdGljCgkqICBAcGFyYW0ge29iamVjdH0gdGFyZ2V0IFRoZSB0YXJnZXQgb2JqZWN0CgkqICBAcmV0dXJuIHtib29sZWFufSBJZiB0aGUgb2JqZWN0IGlzIHBsYWluCgkqLwoJT2JqZWN0LmlzUGxhaW4gPSBmdW5jdGlvbihvYmopCgl7CgkJdmFyIGtleTsKCgkJLy8gTXVzdCBiZSBhbiBPYmplY3QuCgkJLy8gQmVjYXVzZSBvZiBJRSwgd2UgYWxzbyBoYXZlIHRvIGNoZWNrIHRoZSBwcmVzZW5jZSBvZiB0aGUgY29uc3RydWN0b3IgcHJvcGVydHkuCgkJLy8gTWFrZSBzdXJlIHRoYXQgRE9NIG5vZGVzIGFuZCB3aW5kb3cgb2JqZWN0cyBkb24ndCBwYXNzIHRocm91Z2gsIGFzIHdlbGwKCQlpZiAoIW9iaiB8fCB0eXBlb2Ygb2JqICE9PSAib2JqZWN0IiB8fCBvYmoubm9kZVR5cGUgfHwgb2JqID09PSB3aW5kb3cpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQl0cnkgewoJCQkvLyBOb3Qgb3duIGNvbnN0cnVjdG9yIHByb3BlcnR5IG11c3QgYmUgT2JqZWN0CgkJCWlmICggb2JqLmNvbnN0cnVjdG9yICYmCgkJCQkhaGFzT3duLmNhbGwob2JqLCAiY29uc3RydWN0b3IiKSAmJgoJCQkJIWhhc093bi5jYWxsKG9iai5jb25zdHJ1Y3Rvci5wcm90b3R5cGUsICJpc1Byb3RvdHlwZU9mIikgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9IAoJCWNhdGNoIChlKSAKCQl7CgkJCS8vIElFOCw5IFdpbGwgdGhyb3cgZXhjZXB0aW9ucyBvbiBjZXJ0YWluIGhvc3Qgb2JqZWN0cyAjOTg5NwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQkvLyBTdXBwb3J0OiBJRTw5CgkJLy8gSGFuZGxlIGl0ZXJhdGlvbiBvdmVyIGluaGVyaXRlZCBwcm9wZXJ0aWVzIGJlZm9yZSBvd24gcHJvcGVydGllcy4KCQlpZiAoc3VwcG9ydC5vd25MYXN0KQoJCXsKCQkJZm9yIChrZXkgaW4gb2JqKQoJCQl7CgkJCQlyZXR1cm4gaGFzT3duLmNhbGwob2JqLCBrZXkpOwoJCQl9CgkJfQoKCQkvLyBPd24gcHJvcGVydGllcyBhcmUgZW51bWVyYXRlZCBmaXJzdGx5LCBzbyB0byBzcGVlZCB1cCwKCQkvLyBpZiBsYXN0IG9uZSBpcyBvd24sIHRoZW4gYWxsIHByb3BlcnRpZXMgYXJlIG93bi4KCQlmb3IgKGtleSBpbiBvYmopIHt9CgoJCXJldHVybiBrZXkgPT09IHVuZGVmaW5lZCB8fCBoYXNPd24uY2FsbChvYmosIGtleSk7Cgl9OwoKfShPYmplY3QpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiovCihmdW5jdGlvbih3aW5kb3csIHVuZGVmaW5lZCl7CgkKCS8qKgoJKiAgQSBzdGF0aWMgY2xvc3VyZSB0byBwcm92aWRlIGVhc3kgYWNjZXNzIHRvIHRoZSBjb25zb2xlCgkqICB3aXRob3V0IGhhdmluZyBlcnJvcnMgaWYgdGhlIGNvbnNvbGUgZG9lc24ndCBleGlzdAoJKiAgdG8gdXNlIGNhbGw6IERlYnVnLmxvZygnWW91ciBsb2cgaGVyZScpCgkqCgkqICBAY2xhc3MgRGVidWcKCSogIEBzdGF0aWMKCSovCgl2YXIgRGVidWcgPSBmdW5jdGlvbigpe307CgkKCS8qKgoJKiAgSWYgd2UgaGF2ZSBhIGNvbnNvbGUKCSoKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2Jvb2x9IGhhc0NvbnNvbGUKCSovCgl2YXIgaGFzQ29uc29sZSA9ICh3aW5kb3cuY29uc29sZSAhPT0gdW5kZWZpbmVkKTsKCQoJLyoqCgkqIFRoZSBtb3N0IGdlbmVyYWwgZGVmYXVsdCBkZWJ1ZyBsZXZlbAoJKiBAc3RhdGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gR0VORVJBTAoJKi8KCURlYnVnLkdFTkVSQUwgPSAwOwoJCgkvKioKCSogTG9nIGxldmVsIGZvciBkZWJ1ZyBtZXNzYWdlcwoJKiBAc3RhdGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gdHJ1ZQoJKi8KCURlYnVnWydERScrJ0JVRyddID0gMTsgLy8ganNoaW50IGlnbm9yZTpsaW5lCgkKCS8qKgoJKiBMb2cgbGV2ZWwgZm9yIGRlYnVnIG1lc3NhZ2VzCgkqIEBzdGF0aWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBJTkZPCgkqLwoJRGVidWcuSU5GTyA9IDI7CgkKCS8qKgoJKiBMb2cgbGV2ZWwgZm9yIHdhcm5pbmcgbWVzc2FnZXMKCSogQHN0YXRpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFdBUk4KCSovCglEZWJ1Zy5XQVJOID0gMzsKCQoJLyoqCgkqIExvZyBsZXZlbCBmb3IgZXJyb3IgbWVzc2FnZXMKCSogQHN0YXRpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IEVSUk9SCgkqLwoJRGVidWcuRVJST1IgPSA0OwoJCgkvKioKCSogVGhlIG1pbmltdW0gbG9nIGxldmVsIHRvIHNob3csIGJ5IGRlZmF1bHQgaXQncyBzZXQgdG8KCSogc2hvdyBhbGwgbGV2ZWxzIG9mIGxvZ2dpbmcuCgkqIEBwdWJsaWMKCSogQHN0YXRpYwoJKiBAcHJvcGVydHkge2ludH0gbWluTG9nTGV2ZWwKCSovCglEZWJ1Zy5taW5Mb2dMZXZlbCA9IERlYnVnLkdFTkVSQUw7CgkKCS8qKgoJKiBCb29sZWFuIHRvIHR1cm4gb24gb3Igb2ZmIHRoZSBkZWJ1Z2dpbmcKCSogQHB1YmxpYwoJKiBAc3RhdGljCgkqIEBwcm9wZXJ0eSB7Ym9vbH0gZW5hYmxlZAoJKi8KCURlYnVnLmVuYWJsZWQgPSB0cnVlOwoJCgkvKioKCSogIFRoZSBqUXVlcnkgZWxlbWVudCB0byBvdXRwdXQgZGVidWcgbWVzc2FnZXMgdG8KCSoKCSogIEBwdWJsaWMKCSogIEBzdGF0aWMKCSogIEBwcm9wZXJ0eSB7alF1ZXJ5fSBvdXRwdXQKCSovCglEZWJ1Zy5vdXRwdXQgPSBudWxsOwoKCS8qKgoJKglJZiB0aGUgY29uc29sZSBpcyBjdXJyZW50bHkgY29ubmVjdGVkIHdpdGggSlNDb25zb2xlIChqc2NvbnNvbGUuY29tKS4KCSoJQHByaXZhdGUKCSoJQHN0YXRpYwoJKglAcHJvcGVydHkge2Jvb2x9IF9pc0pTQ29uc29sZQoJKi8KCURlYnVnLl9pc0pTQ29uc29sZSA9IHdpbmRvdy5yZW1vdGUgPT09IHdpbmRvdy5jb25zb2xlOy8vVGhlIEpTQ29uc29sZSBzY3JpcHQgc2V0cyBvbmUgb2JqZWN0IGFzICdyZW1vdGUnIGFuZCB0cnlzIHRvIG92ZXJ3cml0ZSAnY29uc29sZScKCQoJLyoqCgkqIEJyb3dzZXIgcG9ydCBmb3IgdGhlIHdlYnNvY2tldCBicm93c2VycyB0ZW5kIHRvIGJsb2NrIHBvcnRzCgkqICBAc3RhdGljCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9ORVRfUE9SVAoJKiAgQGRlZmF1bHQgMTAyNQoJKi8KCURlYnVnLl9ORVRfUE9SVCA9IDEwMjU7CgkKCS8qKgoJKiBJZiB0aGUgd2ViIHNvY2tldCBpcyBjb25uZWN0ZWQKCSogQHN0YXRpYwoJKiBAcHJpdmF0ZQoJKiBAZGVmYXVsdCBmYWxzZQoJKiBAcHJvcGVydHkge2Jvb2x9IF9pc0Nvbm5lY3RlZAoJKi8KCURlYnVnLl9pc0Nvbm5lY3RlZCA9IGZhbHNlOwoJCgkvKioKCSogVGhlIHNvY2tldCBjb25uZWN0aW9uCgkqIEBzdGF0aWMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtXZWJTb2NrZXR9IF9zb2NrZXQKCSovCglEZWJ1Zy5fc29ja2V0ID0gbnVsbDsKCQoJLyoqCgkqIFRoZSBjdXJyZW50IG1lc3NhZ2Ugb2JqZWN0IGJlaW5nIHNlbnQgdG8gdGhlIGBXZWJTb2NrZXRgCgkqIEBzdGF0aWMKCSogQHByaXZhdGUKCSogQHByb3BlcnR5IHtvYmplY3R9IF9tZXNzYWdlT2JqCgkqLwoJRGVidWcuX21lc3NhZ2VPYmogPSBudWxsOwoJCgkvKioKCSogVGhlIGBXZWJTb2NrZXRgIG1lc3NhZ2UgcXVldWUKCSogQHN0YXRpYwoJKiBAcHJpdmF0ZQoJKiBAcHJvcGVydHkge0FycmF5fSBfbWVzc2FnZVF1ZXVlCgkqLwoJRGVidWcuX21lc3NhZ2VRdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgQ29ubmVjdCB0byB0aGUgYFdlYlNvY2tldGAKCSogIEBwdWJsaWMKCSogIEBzdGF0aWMKCSogIEBtZXRob2QgY29ubmVjdAoJKiAgQHBhcmFtIHtzdHJpbmd9IGhvc3QgVGhlIHJlbW90ZSBhZGRyZXNzIHRvIGNvbm5lY3QgdG8sIElQIGFkZHJlc3Mgb3IgaG9zdCBuYW1lCgkqLwoJRGVidWcuY29ubmVjdCA9IGZ1bmN0aW9uKGhvc3QpCgl7CgkJLy8gTWFrZSBzdXJlIFdlYlNvY2tldCBleGlzdHMgd2l0aG91dCBwcmVmaXhlcyBmb3IgdXMKCQlpZighKCJXZWJTb2NrZXQiIGluIHdpbmRvdykgJiYgISgiTW96V2ViU29ja2V0IiBpbiB3aW5kb3cpKSByZXR1cm4gZmFsc2U7CgkJCgkJd2luZG93LldlYlNvY2tldCA9IFdlYlNvY2tldCB8fCBNb3pXZWJTb2NrZXQ7CgkJCgkJdHJ5CgkJewoJCQl2YXIgcyA9IERlYnVnLl9zb2NrZXQgPSBuZXcgV2ViU29ja2V0KCJ3czovLyIgKyBob3N0ICsgIjoiICsgRGVidWcuX05FVF9QT1JUKTsKCQkJcy5vbm9wZW4gPSBvbkNvbm5lY3Q7CgkJCXMub25tZXNzYWdlID0gZnVuY3Rpb24oKXt9OwoJCQlzLm9uY2xvc2UgPSBvbkNsb3NlOwoJCQlzLm9uZXJyb3IgPSBvbkNsb3NlOwoJCQlEZWJ1Zy5fbWVzc2FnZVF1ZXVlID0gW107CgkJCURlYnVnLl9pc0Nvbm5lY3RlZCA9IHRydWU7CgkJfQoJCWNhdGNoKGVycm9yKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX07CgkKCS8qKgoJKiAgRGlzY29ubmVjdCBmcm9tIHRoZSBgV2ViU29ja2V0YAoJKiAgQHB1YmxpYwoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBkaXNjb25uZWN0CgkqLwoJRGVidWcuZGlzY29ubmVjdCA9IGZ1bmN0aW9uKCkKCXsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5fc29ja2V0LmNsb3NlKCk7CgkJCW9uQ2xvc2UoKTsKCQl9Cgl9OwoJCgkvKioKCSogIENhbGxiYWNrIHdoZW4gdGhlIGBXZWJTb2NrZXRgIGlzIGNvbm5lY3RlZAoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSogIEBtZXRob2Qgb25Db25uZWN0CgkqLwoJdmFyIG9uQ29ubmVjdCA9IGZ1bmN0aW9uKCkKCXsKCQkvLyBzZXQgdXAgYSBmdW5jdGlvbiB0byBoYW5kbGUgYWxsIG1lc3NhZ2VzCgkJd2luZG93Lm9uZXJyb3IgPSBnbG9iYWxFcnJvckhhbmRsZXI7CgkJCgkJLy8gY3JlYXRlIGFuZCBzZW5kIGEgbmV3IHNlc3Npb24gbWVzc2FnZQoJCURlYnVnLl9tZXNzYWdlT2JqID0ge2xldmVsOiJzZXNzaW9uIiwgbWVzc2FnZToiIn07CgkJRGVidWcuX3NvY2tldC5zZW5kKEpTT04uc3RyaW5naWZ5KERlYnVnLl9tZXNzYWdlT2JqKSk7CgkJCgkJLy8gc2VuZCBhbnkgcXVldWVkIGxvZ3MKCQlmb3IodmFyIGkgPSAwOyBpIDwgRGVidWcuX21lc3NhZ2VRdWV1ZS5sZW5ndGg7ICsraSkKCQl7CgkJCURlYnVnLl9zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShEZWJ1Zy5fbWVzc2FnZVF1ZXVlW2ldKSk7CgkJfQoJCS8vIGdldCByaWQgb2YgdGhpcywgc2luY2Ugd2UgYXJlIGNvbm5lY3RlZAoJCURlYnVnLl9tZXNzYWdlUXVldWUgPSBudWxsOwoJfTsKCQoJLyoqCgkqICBHbG9iYWwgd2luZG93IGVycm9yIGhhbmRsZXIsIHVzZWQgZm9yIHJlbW90ZSBjb25uZWN0aW9ucy4KCSogIEBzdGF0aWMKCSogIEBwcml2YXRlCgkqICBAbWV0aG9kIGdsb2JhbEVycm9ySGFuZGxlcgoJKiAgQHBhcmFtIHtTdHJpbmd9IG1lc3NhZ2UgVGhlIGVycm9yIG1lc3NhZ2UKCSogIEBwYXJhbSB7U3RyaW5nfSBmaWxlIFRoZSB1cmwgb2YgdGhlIGZpbGUKCSogIEBwYXJhbSB7aW50fSBsaW5lIFRoZSBsaW5lIHdpdGhpbiB0aGUgZmlsZQoJKiAgQHBhcmFtIHtpbnR9IGNvbHVtbiBUaGUgY29sdW1uIHdpdGhpbiB0aGUgbGluZQoJKiAgQHBhcmFtIHtFcnJvcn0gZXJyb3IgVGhlIGVycm9yIGl0c2VsZgoJKi8KCXZhciBnbG9iYWxFcnJvckhhbmRsZXIgPSBmdW5jdGlvbihtZXNzYWdlLCBmaWxlLCBsaW5lLCBjb2x1bW4sIGVycm9yKQoJewoJCXZhciBsb2dNZXNzYWdlID0gIkVycm9yOiAiICsgbWVzc2FnZSArICIgaW4gIiArIGZpbGUgKyAiIGF0IGxpbmUgIiArIGxpbmU7CgkJaWYoY29sdW1uICE9PSB1bmRlZmluZWQpCgkJCWxvZ01lc3NhZ2UgKz0gIjoiICsgY29sdW1uOwoJCWlmKGVycm9yKQoJCQlsb2dNZXNzYWdlICs9ICJcbiIgKyBlcnJvci5zdGFjazsKCQlEZWJ1Zy5yZW1vdGVMb2cobG9nTWVzc2FnZSwgIkVSUk9SIik7CgkJcmV0dXJuIGZhbHNlOwoJfTsKCQoJLyoqCgkqICBDYWxsYmFjayBmb3Igd2hlbiB0aGUgd2Vic29ja2V0IGlzIGNsb3NlZAoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSogIEBtZXRob2Qgb25DbG9zZQoJKi8KCXZhciBvbkNsb3NlID0gZnVuY3Rpb24oKQoJewoJCXdpbmRvdy5vbmVycm9yID0gbnVsbDsKCQlEZWJ1Zy5faXNDb25uZWN0ZWQgPSBmYWxzZTsKCQl2YXIgcyA9IERlYnVnLl9zb2NrZXQ7CgkJcy5vbm9wZW4gPSBudWxsOwoJCXMub25tZXNzYWdlID0gbnVsbDsKCQlzLm9uY2xvc2UgPSBudWxsOwoJCXMub25lcnJvciA9IG51bGw7CgkJRGVidWcuX3NvY2tldCA9IG51bGw7CgkJRGVidWcuX21lc3NhZ2VPYmogPSBudWxsOwoJCURlYnVnLl9tZXNzYWdlUXVldWUgPSBudWxsOwoJfTsKCQoJLyoqCgkqICBTZW50IHRvIHRoZSBvdXRwdXQKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIG91dHB1dAoJKiAgQHBhcmFtIHtzdHJpbmd9IGxldmVsIFRoZSBsb2cgbGV2ZWwKCSogIEBwYXJhbSB7c3RyaW5nfSBhcmdzIEFkZGl0aW9uYWwgYXJndW1lbnRzCgkqLwoJZnVuY3Rpb24gb3V0cHV0KGxldmVsLCBhcmdzKQoJewoJCWlmIChEZWJ1Zy5vdXRwdXQpCgkJewoJCQlEZWJ1Zy5vdXRwdXQuYXBwZW5kKCI8ZGl2IGNsYXNzPVwiIitsZXZlbCsiXCI+IiArIGFyZ3MgKyAiPC9kaXY+Iik7CgkJfQoJfQoJCgkvKioKCSogIFNlbmQgYSByZW1vdGUgbG9nIG1lc3NhZ2UgdXNpbmcgdGhlIHNvY2tldCBjb25uZWN0aW9uCgkqICBAcHVibGljCgkqICBAc3RhdGljCgkqICBAbWV0aG9kIHJlbW90ZUxvZwoJKiAgQHBhcmFtIHtzdHJpbmd9IG1lc3NhZ2UgVGhlIG1lc3NhZ2UgdG8gc2VuZAoJKiAgQHBhcmFtIHtsZXZlbH0gbGV2ZWwgVGhlIGxvZyBsZXZlbCB0byBzZW5kCgkqLwoJRGVidWcucmVtb3RlTG9nID0gZnVuY3Rpb24obWVzc2FnZSwgbGV2ZWwpCgl7CgkJaWYoIWxldmVsKQoJCQlsZXZlbCA9ICJHRU5FUkFMIjsKCQlpZihEZWJ1Zy5fbWVzc2FnZVF1ZXVlKS8vSWYgd2UgYXJlIHN0aWxsIGluIHRoZSBwcm9jZXNzIG9mIGNvbm5lY3RpbmcsIHF1ZXVlIHVwIHRoZSBsb2cKCQl7CgkJCURlYnVnLl9tZXNzYWdlUXVldWUucHVzaCh7bWVzc2FnZTptZXNzYWdlLCBsZXZlbDpsZXZlbH0pOwoJCX0KCQllbHNlLy9zZW5kIHRoZSBsb2cgaW1tZWRpYXRlbHkKCQl7CgkJCURlYnVnLl9tZXNzYWdlT2JqLmxldmVsID0gbGV2ZWw7CgkJCURlYnVnLl9tZXNzYWdlT2JqLm1lc3NhZ2UgPSBtZXNzYWdlOwoJCQlEZWJ1Zy5fc29ja2V0LnNlbmQoSlNPTi5zdHJpbmdpZnkoRGVidWcuX21lc3NhZ2VPYmopKTsKCQl9Cgl9OwoKCWZ1bmN0aW9uIEpTQ19zdHJpbmdpZnkob2JqLCBkZXB0aCkKCXsKCQlpZighZGVwdGgpCgkJCWRlcHRoID0gMTsKCQl2YXIgc3BhY2luZyA9ICIiOwoJCXZhciBlbmRTcGFjaW5nID0gIiI7CgkJZm9yKHZhciBpID0gMDsgaSA8IGRlcHRoICogNDsgKytpKQoJCXsKCQkJc3BhY2luZyArPSAiJm5ic3A7IjsKCQkJaWYoaSA8IChkZXB0aCAtIDEpICogNCkKCQkJCWVuZFNwYWNpbmcgKz0gIiZuYnNwOyI7CgkJfQoJCXZhciBydG4gPSAiezxiciAvPiI7CgkJZm9yKHZhciBrZXkgaW4gb2JqKQoJCXsKCQkJLy9hdm9pZCBkb2luZyBwcm9wZXJ0aWVzIHRoYXQgYXJlIGtub3duIHRvIGJlIERPTSBvYmplY3RzLCBiZWNhdXNlIHRob3NlIGhhdmUgY2lyY3VsYXIgcmVmZXJlbmNlcwoJCQlpZihrZXkgPT0gImRvY3VtZW50IiB8fCBrZXkgPT0gIndpbmRvdyIgfHwga2V5ID09ICJvd25lckRvY3VtZW50IiB8fCBrZXkgPT0gInZpZXciKQoJCQkJY29udGludWU7CgkJCWlmKGtleSA9PSAidGFyZ2V0IiB8fCBrZXkgPT0gImN1cnJlbnRUYXJnZXQiIHx8IGtleSA9PSAib3JpZ2luYWxUYXJnZXQiIHx8IGtleSA9PSAiZXhwbGljaXRPcmlnaW5hbFRhcmdldCIgfHwga2V5ID09ICJyYW5nZVBhcmVudCIpCgkJCQljb250aW51ZTsKCQkJaWYoa2V5ID09ICJzcmNFbGVtZW50IiB8fCBrZXkgPT0gInJlbGF0ZWRUYXJnZXQiIHx8IGtleSA9PSAiZnJvbUVsZW1lbnQiIHx8IGtleSA9PSAidG9FbGVtZW50IikKCQkJCWNvbnRpbnVlOwoJCQlzd2l0Y2godHlwZW9mIG9ialtrZXldKQoJCQl7CgkJCQljYXNlICJzdHJpbmciOgoJCQkJY2FzZSAibnVtYmVyIjoKCQkJCWNhc2UgImJvb2xlYW4iOgoJCQkJY2FzZSAiYm9vbCI6CgkJCQkJcnRuICs9IHNwYWNpbmcgKyBrZXkgKyAiOiAiICsgb2JqW2tleV0gKyAiPGJyIC8+IjsKCQkJCQlicmVhazsKCQkJCWNhc2UgIm9iamVjdCI6CgkJCQkJcnRuICs9IHNwYWNpbmcgKyBrZXkgKyAiOiAiICsgSlNDX3N0cmluZ2lmeShvYmpba2V5XSwgZGVwdGggKyAxKSArICI8YnIgLz4iOwoJCQkJCWJyZWFrOwoJCQkJY2FzZSAiZnVuY3Rpb24iOgoJCQkJCXJ0biArPSBzcGFjaW5nICsga2V5ICsgIjogKGZ1bmN0aW9uKTxiciAvPiI7CgkJCQkJYnJlYWs7CgkJCQlkZWZhdWx0OgoJCQkJCXJ0biArPSBzcGFjaW5nICsga2V5ICsgIjogIiArIG9ialtrZXldICsgIjxiciAvPiI7CgkJCQkJYnJlYWs7CgkJCX0KCQl9CgkJcnRuICs9IGVuZFNwYWNpbmcgKyAifSI7CgkJcmV0dXJuIHJ0bjsKCX0KCglmdW5jdGlvbiBKU0NfZm9ybWF0KGlucHV0KQoJewoJCWlmKHR5cGVvZiBpbnB1dCA9PSAic3RyaW5nIikKCQl7CgkJCXJldHVybiBpbnB1dC5yZXBsYWNlKC9cdC9nLCAiJm5ic3A7Jm5ic3A7Jm5ic3A7Jm5ic3A7IikucmVwbGFjZSgvXG4vZywgIjxiciAvPiIpOwoJCX0KCQllbHNlIGlmKHR5cGVvZiBpbnB1dCA9PSAib2JqZWN0IikKCQl7CgkJCXJldHVybiBKU0Nfc3RyaW5naWZ5KGlucHV0KTsKCQl9CgkJcmV0dXJuIGlucHV0OwoJfQoJCgkvKioKCSogIExvZyBzb21ldGhpbmcgaW4gdGhlIGNvbnNvbGUgb3IgcmVtb3RlCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGxvZwoJKiAgQHBhcmFtIHsqfSBwYXJhbXMgVGhlIHN0YXRlbWVudCBvciBvYmplY3QgdG8gbG9nCgkqLwoJRGVidWcubG9nID0gZnVuY3Rpb24ocGFyYW1zKQoJewoJCWlmKCFEZWJ1Zy5lbmFibGVkKSByZXR1cm47CgkJaWYoRGVidWcuX2lzQ29ubmVjdGVkKQoJCXsKCQkJRGVidWcucmVtb3RlTG9nKHBhcmFtcywgIkdFTkVSQUwiKTsKCQl9CgkJZWxzZSBpZiAoRGVidWcubWluTG9nTGV2ZWwgPT0gRGVidWcuR0VORVJBTCAmJiBoYXNDb25zb2xlKQoJCXsKCQkJY29uc29sZS5sb2coRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJb3V0cHV0KCJnZW5lcmFsIiwgcGFyYW1zKTsKCQl9Cgl9OwoJCgkvKioKCSogIERlYnVnIHNvbWV0aGluZyBpbiB0aGUgY29uc29sZSBvciByZW1vdGUKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVidWcKCSogIEBwYXJhbSB7Kn0gcGFyYW1zIFRoZSBzdGF0ZW1lbnQgb3Igb2JqZWN0IHRvIGRlYnVnCgkqLwoJRGVidWcuZGVidWcgPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYoIURlYnVnLmVuYWJsZWQpIHJldHVybjsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5yZW1vdGVMb2cocGFyYW1zLCAnREUnKydCVUcnKTsKCQl9CgkJZWxzZSBpZiAoRGVidWcubWluTG9nTGV2ZWwgPD0gRGVidWdbJ0RFJysnQlVHJ10gJiYgaGFzQ29uc29sZSkgLy8ganNoaW50IGlnbm9yZTpsaW5lCgkJewoJCQljb25zb2xlLmRlYnVnKERlYnVnLl9pc0pTQ29uc29sZSA/IEpTQ19mb3JtYXQocGFyYW1zKSA6IHBhcmFtcyk7CgkJCW91dHB1dCgiZGVidWciLCBwYXJhbXMpOwoJCX0KCX07CgkKCS8qKgoJKiAgSW5mbyBzb21ldGhpbmcgaW4gdGhlIGNvbnNvbGUgb3IgcmVtb3RlCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGluZm8KCSogIEBwYXJhbSB7Kn0gcGFyYW1zIFRoZSBzdGF0ZW1lbnQgb3Igb2JqZWN0IHRvIGluZm8KCSovCglEZWJ1Zy5pbmZvID0gZnVuY3Rpb24ocGFyYW1zKQoJewoJCWlmKCFEZWJ1Zy5lbmFibGVkKSByZXR1cm47CgkJaWYoRGVidWcuX2lzQ29ubmVjdGVkKQoJCXsKCQkJRGVidWcucmVtb3RlTG9nKHBhcmFtcywgIklORk8iKTsKCQl9CgkJZWxzZSBpZiAoRGVidWcubWluTG9nTGV2ZWwgPD0gRGVidWcuSU5GTyAmJiBoYXNDb25zb2xlKQoJCXsKCQkJY29uc29sZS5pbmZvKERlYnVnLl9pc0pTQ29uc29sZSA/IEpTQ19mb3JtYXQocGFyYW1zKSA6IHBhcmFtcyk7CgkJCW91dHB1dCgiaW5mbyIsIHBhcmFtcyk7CgkJfQoJfTsKCQoJLyoqCgkqICBXYXJuIHNvbWV0aGluZyBpbiB0aGUgY29uc29sZSBvciByZW1vdGUKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2Qgd2FybgoJKiAgQHBhcmFtIHsqfSBwYXJhbXMgVGhlIHN0YXRlbWVudCBvciBvYmplY3QgdG8gd2FybgoJKi8KCURlYnVnLndhcm4gPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYoIURlYnVnLmVuYWJsZWQpIHJldHVybjsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5yZW1vdGVMb2cocGFyYW1zLCAiV0FSTklORyIpOwoJCX0KCQllbHNlIGlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA8PSBEZWJ1Zy5XQVJOICYmIGhhc0NvbnNvbGUpCgkJewoJCQljb25zb2xlLndhcm4oRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJb3V0cHV0KCJ3YXJuIiwgcGFyYW1zKTsKCQl9Cgl9OwoJCgkvKioKCSogIEVycm9yIHNvbWV0aGluZyBpbiB0aGUgY29uc29sZSBvciByZW1vdGUKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZXJyb3IKCSogIEBwYXJhbSB7Kn0gcGFyYW1zIFRoZSBzdGF0ZW1lbnQgb3Igb2JqZWN0IHRvIGVycm9yCgkqLwoJRGVidWcuZXJyb3IgPSBmdW5jdGlvbihwYXJhbXMpCgl7CgkJaWYoIURlYnVnLmVuYWJsZWQpIHJldHVybjsKCQlpZihEZWJ1Zy5faXNDb25uZWN0ZWQpCgkJewoJCQlEZWJ1Zy5yZW1vdGVMb2cocGFyYW1zLCAiRVJST1IiKTsKCQl9CgkJZWxzZSBpZiAoaGFzQ29uc29sZSkKCQl7CgkJCWNvbnNvbGUuZXJyb3IoRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQkJb3V0cHV0KCJlcnJvciIsIHBhcmFtcyk7CgkJfQoJfTsKCQoJLyoqCgkqICBBc3NlcnQgdGhhdCBzb21ldGhpbmcgaXMgdHJ1ZQoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBhc3NlcnQKCSogIEBwYXJhbSB7Ym9vbH0gdHJ1dGggQXMgc3RhdGVtZW50IHRoYXQgaXMgYXNzdW1lZCB0cnVlCgkqICBAcGFyYW0geyp9IHBhcmFtcyBUaGUgbWVzc2FnZSB0byBlcnJvciBpZiB0aGUgYXNzZXJ0IGlzIGZhbHNlCgkqLwoJRGVidWcuYXNzZXJ0ID0gZnVuY3Rpb24odHJ1dGgsIHBhcmFtcykKCXsKCQlpZiAoaGFzQ29uc29sZSAmJiBEZWJ1Zy5lbmFibGVkICYmIGNvbnNvbGUuYXNzZXJ0KQoJCXsKCQkJY29uc29sZS5hc3NlcnQodHJ1dGgsIERlYnVnLl9pc0pTQ29uc29sZSA/IEpTQ19mb3JtYXQocGFyYW1zKSA6IHBhcmFtcyk7CgkJCWlmICghdHJ1dGgpIG91dHB1dCgiZXJyb3IiLCBwYXJhbXMpOwoJCX0KCX07CgkKCS8qKgoJKiAgTWV0aG9kIHRvIGRlc2NyaWJlIGFuIG9iamVjdCBpbiB0aGUgY29uc29sZQoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBkaXIKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7b2JqZWN0fSBwYXJhbXMgVGhlIG9iamVjdCB0byBkZXNjcmliZSBpbiB0aGUgY29uc29sZQoJKi8KCURlYnVnLmRpciA9IGZ1bmN0aW9uKHBhcmFtcykKCXsKCQlpZiAoRGVidWcubWluTG9nTGV2ZWwgPT0gRGVidWcuR0VORVJBTCAmJiBoYXNDb25zb2xlICYmIERlYnVnLmVuYWJsZWQpCgkJewoJCQljb25zb2xlLmRpcihEZWJ1Zy5faXNKU0NvbnNvbGUgPyBKU0NfZm9ybWF0KHBhcmFtcykgOiBwYXJhbXMpOwoJCX0KCX07CgkKCS8qKgoJKiAgTWV0aG9kIHRvIGNsZWFyIHRoZSBjb25zb2xlCgkqCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGNsZWFyCgkqLwoJRGVidWcuY2xlYXIgPSBmdW5jdGlvbigpCgl7CgkJaWYgKGhhc0NvbnNvbGUgJiYgRGVidWcuZW5hYmxlZCkKCQl7CgkJCWNvbnNvbGUuY2xlYXIoKTsKCQkJaWYgKERlYnVnLm91dHB1dCkgRGVidWcub3V0cHV0Lmh0bWwoIiIpOwoJCX0KCX07CgkKCS8qKgoJKiAgR2VuZXJhdGUgYSBzdGFjayB0cmFjayBpbiB0aGUgb3V0cHV0CgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHRyYWNlCgkqICBAcGFyYW0geyp9IHBhcmFtcyBPcHRpb25hbCBwYXJhbWV0ZXJzIHRvIGxvZwoJKi8KCURlYnVnLnRyYWNlID0gZnVuY3Rpb24ocGFyYW1zKQoJewoJCWlmIChEZWJ1Zy5taW5Mb2dMZXZlbCA9PSBEZWJ1Zy5HRU5FUkFMICYmIGhhc0NvbnNvbGUgJiYgRGVidWcuZW5hYmxlZCkKCQl7CgkJCWNvbnNvbGUudHJhY2UoRGVidWcuX2lzSlNDb25zb2xlID8gSlNDX2Zvcm1hdChwYXJhbXMpIDogcGFyYW1zKTsKCQl9Cgl9OwoJCgkvLyBNYWtlIHRoZSBkZWJ1ZyBjbGFzcyBnbG9iYWxseSBhY2Nlc3NpYmxlCgkvLyBJZiB0aGUgY29uc29sZSBkb2Vzbid0IGV4aXN0LCB1c2UgdGhlIGR1bW15IHRvIHByZXZlbnQgZXJyb3JzCgl3aW5kb3cuRGVidWcgPSBEZWJ1ZzsKCQp9KHdpbmRvdykpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbih3aW5kb3cpewoJCQoJLy8gSW5jbHVkZSB0aGUgd2luZG93LnBlcmZvcm1hbmNlIG9iamVjdAoJdmFyIHBlcmZvcm1hbmNlID0gaW5jbHVkZSgncGVyZm9ybWFuY2UnLCBmYWxzZSk7CgoJLy8gU2VlIGlmIHdlIGhhdmUgcGVyZm9ybWFuY2Uubm93IG9yIGFueSBvZgoJLy8gdGhlIGJyb3dlci1zcGVjaWZpYyB2ZXJzaW9ucwoJdmFyIG5vdyA9IHBlcmZvcm1hbmNlICYmICgKCQlwZXJmb3JtYW5jZS5ub3cgfHwgCgkJcGVyZm9ybWFuY2UubW96Tm93IHx8IAoJCXBlcmZvcm1hbmNlLm1zTm93IHx8IAoJCXBlcmZvcm1hbmNlLm9Ob3cgfHwgCgkJcGVyZm9ybWFuY2Uud2Via2l0Tm93CgkpOwoKCS8vIEJyb3dzZXIgcHJlZml4IHBvbHlmaWxsCglpZiAobm93KSBwZXJmb3JtYW5jZS5ub3cgPSBub3c7CgoJLyoqCgkqICBBIGNvbGxlY3Rpb24gb2YgVGltZSByZWxhdGVkIHV0aWxpdHkgZnVuY3Rpb25zCgkqICBAY2xhc3MgVGltZVV0aWxzCgkqLwoJdmFyIFRpbWVVdGlscyA9IHt9OwoJCgkvKioKCSogIFRoaXMgbWV0aG9kIGdldHMgdGltZXN0YW1wIGluIG1pY3JvbWlsbGlzZWNvbmRzIGZvciBkb2luZyBwZXJmb3JtYW5jZQoJKiAgaW50ZW5zZSBvcGVyYXRpb25zLiBGYWxsYmFjayBzdXBwb3J0IGlzIHRvIGBEYXRlLm5vdygpYC4gV2UgYXJlbid0IG92ZXJyaWRkaW5nCgkqICBgcGVyZm9ybWFuY2Uubm93KClgIGluY2FzZSBkZXBlbmRlbmNpZXMgb24gdGhpcyBhY3R1YWxseSBkZW1hbmQgCgkqICB0aGUgb3B0aW1pemF0aW9uIGFuZCBhY2N1cmFjeSB0aGF0IHBlcmZvcm1hbmNlIGFjdHVhbGx5IHByb3ZpZGVzLgoJKiAgQHN0YXRpYwoJKiAgQG1ldGhvZCBub3cKCSogIEByZXR1cm4ge2ludH0gVGhlIG51bWJlciBvZiBtaWNyb21pbGxpc2Vjb25kcyBvZiB0aGUgY3VycmVudCB0aW1lc3RhbXAKCSovCglUaW1lVXRpbHMubm93ID0gIW5vdyA/IERhdGUubm93IDogZnVuY3Rpb24oKQoJeyAKCQlyZXR1cm4gcGVyZm9ybWFuY2Uubm93KCk7IAoJfTsKCgkvLyBBc3NpZ24gdG8gbmFtZXNwYWNlCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5UaW1lVXRpbHMgPSBUaW1lVXRpbHM7CgkKfSh3aW5kb3cpKTsKKGZ1bmN0aW9uKCl7CgoJLy8gaHR0cDovL3BhdWxpcmlzaC5jb20vMjAxMS9yZXF1ZXN0YW5pbWF0aW9uZnJhbWUtZm9yLXNtYXJ0LWFuaW1hdGluZy8KCS8vIGh0dHA6Ly9teS5vcGVyYS5jb20vZW1vbGxlci9ibG9nLzIwMTEvMTIvMjAvcmVxdWVzdGFuaW1hdGlvbmZyYW1lLWZvci1zbWFydC1lci1hbmltYXRpbmcKCS8vIHJlcXVlc3RBbmltYXRpb25GcmFtZSBwb2x5ZmlsbCBieSBFcmlrIE3DtmxsZXIuIGZpeGVzIGZyb20gUGF1bCBJcmlzaCBhbmQgVGlubyBaaWpkZWwKCS8vIE1JVCBsaWNlbnNlCgl2YXIgdmVuZG9ycyA9IFsnbXMnLCAnbW96JywgJ3dlYmtpdCcsICdvJ107Cglmb3IodmFyIHggPSAwOyB4IDwgdmVuZG9ycy5sZW5ndGggJiYgIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7ICsreCkKCXsKCQl3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gd2luZG93W3ZlbmRvcnNbeF0rJ1JlcXVlc3RBbmltYXRpb25GcmFtZSddOwoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxBbmltYXRpb25GcmFtZSddIHx8IHdpbmRvd1t2ZW5kb3JzW3hdKydDYW5jZWxSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTsKCX0KCgkvLyBjcmVhdGUgYSBzZXRUaW1lb3V0IGJhc2VkIGZhbGxiYWNrIGlmIHRoZXJlIHdhc24ndCBhbiBvZmZpY2lhbCBvciBwcmVmaXhlZCB2ZXJzaW9uCglpZiAoIXdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUpCgl7CgkJdmFyIFRpbWVVdGlscyA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuVGltZVV0aWxzJyk7CgkJdmFyIGxhc3RUaW1lID0gMDsKCQkvLyBDcmVhdGUgdGhlIHBvbHlmaWxsCgkJd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKQoJCXsKCQkJdmFyIGN1cnJUaW1lID0gVGltZVV0aWxzLm5vdygpOy8vdXNlIHRoZSBub3cgZnVuY3Rpb24gZnJvbSBkb3duIGJlbG93CgkJCXZhciB0aW1lVG9DYWxsID0gTWF0aC5tYXgoMCwgMTYgLSAoY3VyclRpbWUgLSBsYXN0VGltZSkpOwoJCQl2YXIgaWQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsgY2FsbGJhY2soY3VyclRpbWUgKyB0aW1lVG9DYWxsKTsgfSwgdGltZVRvQ2FsbCk7CgkJCWxhc3RUaW1lID0gY3VyclRpbWUgKyB0aW1lVG9DYWxsOwoJCQlyZXR1cm4gaWQ7CgkJfTsKCgkJLy8gT25seSBzZXQgdGhpcyB1cCBpZiB0aGUgY29ycmVzcG9uZGluZyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgd2FzIHNldCB1cAoJCXdpbmRvdy5jYW5jZWxBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGlkKSB7CgkJCWNsZWFyVGltZW91dChpZCk7CgkJfTsKCX0KCgkvLyBTaG9ydCBhbGlhcwoJd2luZG93LnJlcXVlc3RBbmltRnJhbWUgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lOwoKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKXsKCQkKCS8qKgoJKiAgVGhlIEV2ZW50RGlzcGF0Y2hlciBtaXJyb3JzIHRoZSBmdW5jdGlvbmFsaXR5IG9mIEFTMyBhbmQgQ3JlYXRlSlMncyBFdmVudERpc3BhdGNoZXIsIAoJKiAgYnV0IGlzIG1vcmUgcm9idXN0IGluIHRlcm1zIG9mIGlucHV0cyBmb3IgdGhlIGBvbigpYCBhbmQgYG9mZigpYCBtZXRob2RzLgoJKiAgCgkqICBAY2xhc3MgRXZlbnREaXNwYXRjaGVyCgkqICBAY29uc3RydWN0b3IKCSovCgl2YXIgRXZlbnREaXNwYXRjaGVyID0gZnVuY3Rpb24oKQoJewoJCS8qKgoJCSogVGhlIGNvbGxlY3Rpb24gb2YgbGlzdGVuZXJzCgkJKiBAcHJvcGVydHkge0FycmF5fSBfbGlzdGVuZXJzCgkJKiBAcHJpdmF0ZQoJCSovCgkJdGhpcy5fbGlzdGVuZXJzID0gW107CgoJCS8qKgoJCSAqIElmIHRoZSBkaXNwYXRjaGVyIGlzIGRlc3Ryb3llZAoJCSAqIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX2Rlc3Ryb3llZAoJCSAqIEBwcm90ZWN0ZWQKCQkgKi8KCQl0aGlzLl9kZXN0cm95ZWQgPSBmYWxzZTsKCX0sCgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlIAoJcCA9IEV2ZW50RGlzcGF0Y2hlci5wcm90b3R5cGU7CgkKCS8qKgoJKiAgRGlzcGF0Y2ggYW4gZXZlbnQKCSogIEBtZXRob2QgdHJpZ2dlcgoJKiAgQHBhcmFtIHtTdHJpbmd9IHR5cGUgVGhlIHR5cGUgb2YgZXZlbnQgdG8gdHJpZ2dlcgoJKiAgQHBhcmFtIHsqfSBhcmd1bWVudHMgQWRkaXRpb25hbCBwYXJhbWV0ZXJzIGZvciB0aGUgbGlzdGVuZXIgZnVuY3Rpb25zLgoJKi8KCXAudHJpZ2dlciA9IGZ1bmN0aW9uKHR5cGUpCgl7CgkJaWYgKHRoaXMuX2Rlc3Ryb3llZCkgcmV0dXJuOwoJCQoJCWlmICh0aGlzLl9saXN0ZW5lcnNbdHlwZV0gIT09IHVuZGVmaW5lZCkgCgkJewkKCQkJLy8gY29weSB0aGUgbGlzdGVuZXJzIGFycmF5CgkJCXZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnNbdHlwZV0uc2xpY2UoKTsKCgkJCXZhciBhcmdzOwoKCQkJaWYoYXJndW1lbnRzLmxlbmd0aCA+IDEpCgkJCXsKCQkJCWFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOwoJCQl9CgkJCQoJCQlmb3IodmFyIGkgPSBsaXN0ZW5lcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyAtLWkpIAoJCQl7CgkJCQlsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CgoJCQkJaWYgKGxpc3RlbmVyc1tpXS5fZXZlbnREaXNwYXRjaGVyT25jZSkKCQkJCXsKCQkJCQlkZWxldGUgbGlzdGVuZXJzW2ldLl9ldmVudERpc3BhdGNoZXJPbmNlOwoJCQkJCXRoaXMub2ZmKHR5cGUsIGxpc3RlbmVyc1tpXSk7CgkJCQl9CgkJCX0KCQl9Cgl9OwoKCS8qKgoJKiAgQWRkIGFuIGV2ZW50IGxpc3RlbmVyIGJ1dCBvbmx5IGhhbmRsZSBpdCBvbmUgdGltZS4KCSogIAoJKiAgQG1ldGhvZCBvbmNlCgkqICBAcGFyYW0ge1N0cmluZ3xvYmplY3R9IG5hbWUgVGhlIHR5cGUgb2YgZXZlbnQgKGNhbiBiZSBtdWx0aXBsZSBldmVudHMgc2VwYXJhdGVkIGJ5IHNwYWNlcyksIAoJKiAgICAgICAgICBvciBhIG1hcCBvZiBldmVudHMgdG8gaGFuZGxlcnMKCSogIEBwYXJhbSB7RnVuY3Rpb258QXJyYXkqfSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBldmVudCBpcyBmaXJlZCBvciBhbiBhcnJheSBvZiBjYWxsYmFja3MuCgkqICBAcGFyYW0ge2ludH0gW3ByaW9yaXR5PTBdIFRoZSBwcmlvcml0eSBvZiB0aGUgZXZlbnQgbGlzdGVuZXIuIEhpZ2hlciBudW1iZXJzIGFyZSBoYW5kbGVkIGZpcnN0LgoJKiAgQHJldHVybiB7RXZlbnREaXNwYXRjaGVyfSBSZXR1cm4gdGhpcyBFdmVudERpc3BhdGNoZXIgZm9yIGNoYWluaW5nIGNhbGxzLgoJKi8KCXAub25jZSA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBwcmlvcml0eSkKCXsKCQlyZXR1cm4gdGhpcy5vbihuYW1lLCBjYWxsYmFjaywgcHJpb3JpdHksIHRydWUpOwoJfTsKCQoJLyoqCgkqICBBZGQgYW4gZXZlbnQgbGlzdGVuZXIuIFRoZSBwYXJhbWV0ZXJzIGZvciB0aGUgbGlzdGVuZXIgZnVuY3Rpb25zIGRlcGVuZCBvbiB0aGUgZXZlbnQuCgkqICAKCSogIEBtZXRob2Qgb24KCSogIEBwYXJhbSB7U3RyaW5nfG9iamVjdH0gbmFtZSBUaGUgdHlwZSBvZiBldmVudCAoY2FuIGJlIG11bHRpcGxlIGV2ZW50cyBzZXBhcmF0ZWQgYnkgc3BhY2VzKSwgCgkqICAgICAgICAgIG9yIGEgbWFwIG9mIGV2ZW50cyB0byBoYW5kbGVycwoJKiAgQHBhcmFtIHtGdW5jdGlvbnxBcnJheSp9IGNhbGxiYWNrIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGVuIGV2ZW50IGlzIGZpcmVkIG9yIGFuIGFycmF5IG9mIGNhbGxiYWNrcy4KCSogIEBwYXJhbSB7aW50fSBbcHJpb3JpdHk9MF0gVGhlIHByaW9yaXR5IG9mIHRoZSBldmVudCBsaXN0ZW5lci4gSGlnaGVyIG51bWJlcnMgYXJlIGhhbmRsZWQgZmlyc3QuCgkqICBAcmV0dXJuIHtFdmVudERpc3BhdGNoZXJ9IFJldHVybiB0aGlzIEV2ZW50RGlzcGF0Y2hlciBmb3IgY2hhaW5pbmcgY2FsbHMuCgkqLwoJcC5vbiA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrLCBwcmlvcml0eSwgb25jZSkKCXsKCQlpZiAodGhpcy5fZGVzdHJveWVkKSByZXR1cm47CgoJCS8vIENhbGxiYWNrcyBtYXAKCQlpZiAodHlwZShuYW1lKSA9PT0gJ29iamVjdCcpCgkJewoJCQlmb3IgKHZhciBrZXkgaW4gbmFtZSkKCQkJewoJCQkJaWYgKG5hbWUuaGFzT3duUHJvcGVydHkoa2V5KSkKCQkJCXsKCQkJCQl0aGlzLm9uKGtleSwgbmFtZVtrZXldLCBwcmlvcml0eSwgb25jZSk7CgkJCQl9CgkJCX0KCQl9CgkJLy8gQ2FsbGJhY2sKCQllbHNlIGlmICh0eXBlKGNhbGxiYWNrKSA9PT0gJ2Z1bmN0aW9uJykKCQl7CgkJCXZhciBuYW1lcyA9IG5hbWUuc3BsaXQoJyAnKSwgbiA9IG51bGw7CgkJCWZvciAodmFyIGkgPSAwLCBubCA9IG5hbWVzLmxlbmd0aDsgaSA8IG5sOyBpKyspCgkJCXsKCQkJCW4gPSBuYW1lc1tpXTsKCQkJCXZhciBsaXN0ZW5lciA9IHRoaXMuX2xpc3RlbmVyc1tuXTsKCQkJCWlmKCFsaXN0ZW5lcikKCQkJCQlsaXN0ZW5lciA9IHRoaXMuX2xpc3RlbmVyc1tuXSA9IFtdOwoJCQkJCgkJCQlpZiAob25jZSkKCQkJCXsKCQkJCQljYWxsYmFjay5fZXZlbnREaXNwYXRjaGVyT25jZSA9IHRydWU7CgkJCQl9CgkJCQljYWxsYmFjay5fcHJpb3JpdHkgPSBwYXJzZUludChwcmlvcml0eSkgfHwgMDsKCgkJCQlpZiAobGlzdGVuZXIuaW5kZXhPZihjYWxsYmFjaykgPT09IC0xKQoJCQkJewoJCQkJCWxpc3RlbmVyLnB1c2goY2FsbGJhY2spOwoJCQkJCWlmKGxpc3RlbmVyLmxlbmd0aCA+IDEpCgkJCQkJCWxpc3RlbmVyLnNvcnQobGlzdGVuZXJTb3J0ZXIpOwoJCQkJfQoJCQl9CgkJfQoJCS8vIENhbGxiYWNrcyBhcnJheQoJCWVsc2UgaWYgKEFycmF5LmlzQXJyYXkoY2FsbGJhY2spKQoJCXsKCQkJZm9yICh2YXIgZiA9IDAsIGZsID0gY2FsbGJhY2subGVuZ3RoOyBmIDwgZmw7IGYrKykKCQkJewoJCQkJdGhpcy5vbihuYW1lLCBjYWxsYmFja1tmXSwgcHJpb3JpdHksIG9uY2UpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKCglmdW5jdGlvbiBsaXN0ZW5lclNvcnRlcihhLCBiKQoJewoJCXJldHVybiBhLl9wcmlvcml0eSAtIGIuX3ByaW9yaXR5OwoJfQoJCgkvKioKCSogIFJlbW92ZSB0aGUgZXZlbnQgbGlzdGVuZXIKCSogIAoJKiAgQG1ldGhvZCBvZmYKCSogIEBwYXJhbSB7U3RyaW5nKn0gbmFtZSBUaGUgdHlwZSBvZiBldmVudCBzdHJpbmcgc2VwYXJhdGVkIGJ5IHNwYWNlcywgaWYgbm8gbmFtZSBpcyBzcGVjaWZlZCByZW1vdmUgYWxsIGxpc3RlbmVycy4KCSogIEBwYXJhbSB7RnVuY3Rpb258QXJyYXkqfSBjYWxsYmFjayBUaGUgbGlzdGVuZXIgZnVuY3Rpb24gb3IgY29sbGVjdGlvbiBvZiBjYWxsYmFjayBmdW5jdGlvbnMKCSogIEByZXR1cm4ge0V2ZW50RGlzcGF0Y2hlcn0gUmV0dXJuIHRoaXMgRXZlbnREaXNwYXRjaGVyIGZvciBjaGFpbmluZyBjYWxscy4KCSovCglwLm9mZiA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrKQoJewoJCWlmICh0aGlzLl9kZXN0cm95ZWQpIHJldHVybjsKCgkJLy8gcmVtb3ZlIGFsbCAKCQlpZiAobmFtZSA9PT0gdW5kZWZpbmVkKQoJCXsKCQkJdGhpcy5fbGlzdGVuZXJzID0gW107CgkJfQoJCS8vIHJlbW92ZSBtdWx0aXBsZSBjYWxsYmFja3MKCQllbHNlIGlmIChBcnJheS5pc0FycmF5KGNhbGxiYWNrKSkKCQl7CgkJCWZvciAodmFyIGYgPSAwLCBmbCA9IGNhbGxiYWNrLmxlbmd0aDsgZiA8IGZsOyBmKyspIAoJCQl7CgkJCQl0aGlzLm9mZihuYW1lLCBjYWxsYmFja1tmXSk7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJdmFyIG5hbWVzID0gbmFtZS5zcGxpdCgnICcpLCBuID0gbnVsbDsKCQkJZm9yICh2YXIgaSA9IDAsIG5sID0gbmFtZXMubGVuZ3RoOyBpIDwgbmw7IGkrKykKCQkJewoJCQkJbiA9IG5hbWVzW2ldOwoJCQkJdmFyIGxpc3RlbmVyID0gdGhpcy5fbGlzdGVuZXJzW25dOwoJCQkJaWYobGlzdGVuZXIpCgkJCQl7CgkJCQkJLy8gcmVtb3ZlIGFsbCBsaXN0ZW5lcnMgZm9yIHRoYXQgZXZlbnQKCQkJCQlpZiAoY2FsbGJhY2sgPT09IHVuZGVmaW5lZCkKCQkJCQl7CgkJCQkJCWxpc3RlbmVyLmxlbmd0aCA9IDA7CgkJCQkJfQoJCQkJCWVsc2UKCQkJCQl7CgkJCQkJCS8vcmVtb3ZlIHNpbmdsZSBsaXN0ZW5lcgoJCQkJCQl2YXIgaW5kZXggPSBsaXN0ZW5lci5pbmRleE9mKGNhbGxiYWNrKTsKCQkJCQkJaWYgKGluZGV4ICE9PSAtMSkKCQkJCQkJewoJCQkJCQkJbGlzdGVuZXIuc3BsaWNlKGluZGV4LCAxKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gdGhpczsKCX07CgoJLyoqCgkqICBDaGVja3MgaWYgdGhlIEV2ZW50RGlzcGF0Y2hlciBoYXMgYSBzcGVjaWZpYyBsaXN0ZW5lciBvciBhbnkgbGlzdGVuZXIgZm9yIGEgZ2l2ZW4gZXZlbnQuCgkqICAKCSogIEBtZXRob2QgaGFzCgkqICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgc2luZ2xlIGV2ZW50IHR5cGUgdG8gY2hlY2sgZm9yCgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBbY2FsbGJhY2tdIFRoZSBsaXN0ZW5lciBmdW5jdGlvbiB0byBjaGVjayBmb3IuIElmIG9taXR0ZWQsIGNoZWNrcyBmb3IgYW55IGxpc3RlbmVyLgoJKiAgQHJldHVybiB7Qm9vbGVhbn0gSWYgdGhlIEV2ZW50RGlzcGF0Y2hlciBoYXMgdGhlIHNwZWNpZmllZCBsaXN0ZW5lci4KCSovCglwLmhhcyA9IGZ1bmN0aW9uKG5hbWUsIGNhbGxiYWNrKQoJewoJCWlmKCFuYW1lKSByZXR1cm4gZmFsc2U7CgoJCXZhciBsaXN0ZW5lcnMgPSB0aGlzLl9saXN0ZW5lcnNbbmFtZV07CgkJaWYoIWxpc3RlbmVycykgcmV0dXJuIGZhbHNlOwoJCWlmKCFjYWxsYmFjaykKCQkJcmV0dXJuIGxpc3RlbmVycy5sZW5ndGggPiAwOwoJCXJldHVybiBsaXN0ZW5lcnMuaW5kZXhPZihjYWxsYmFjaykgPj0gMDsKCX07CgkKCS8qKgoJKiAgRGVzdHJveSBhbmQgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLl9kZXN0cm95ZWQgPSB0cnVlOwoJCXRoaXMuX2xpc3RlbmVycyA9IG51bGw7Cgl9OwoKCS8qKgoJKiAgUmV0dXJuIHR5cGUgb2YgdGhlIHZhbHVlLgoJKiAgCgkqICBAcHJpdmF0ZQoJKiAgQG1ldGhvZCB0eXBlCgkqICBAcGFyYW0gIHsqfSB2YWx1ZQoJKiAgQHJldHVybiB7U3RyaW5nfSBUaGUgdHlwZQoJKi8KCWZ1bmN0aW9uIHR5cGUodmFsdWUpCgl7CgkJaWYgKHZhbHVlID09PSBudWxsKQoJCXsKCQkJcmV0dXJuICdudWxsJzsKCQl9CgkJdmFyIHR5cGVPZlZhbHVlID0gdHlwZW9mIHZhbHVlOwoJCWlmICh0eXBlT2ZWYWx1ZSA9PT0gJ29iamVjdCcgfHwgdHlwZU9mVmFsdWUgPT09ICdmdW5jdGlvbicpCgkJewoJCQlyZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKS5tYXRjaCgvXHMoW2Etel0rKS9pKVsxXS50b0xvd2VyQ2FzZSgpIHx8ICdvYmplY3QnOwoJCX0KCQlyZXR1cm4gdHlwZU9mVmFsdWU7Cgl9CgoJLyoqCgkqICBBZGRzIEV2ZW50RGlzcGF0Y2hlciBtZXRob2RzIGFuZCBwcm9wZXJ0aWVzIHRvIGFuIG9iamVjdCBvciBvYmplY3QgcHJvdG90eXBlLgoJKiAgQG1ldGhvZCBtaXhJbgoJKiAgQHBhcmFtIHtPYmplY3R9IG9iamVjdCBUaGUgb2JqZWN0IG9yIHByb3RvdHlwZQoJKiAgQHBhcmFtIHtCb29sZWFufSBbY2FsbENvbnN0cnVjdG9yPWZhbHNlXSBJZiB0aGUgRXZlbnREaXNwYXRjaGVyIGNvbnN0cnVjdG9yIHNob3VsZCBiZSBjYWxsZWQgYXMgd2VsbC4KCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCglFdmVudERpc3BhdGNoZXIubWl4SW4gPSBmdW5jdGlvbihvYmplY3QsIGNhbGxDb25zdHJ1Y3RvcikKCXsKCQlvYmplY3QudHJpZ2dlciA9IHAudHJpZ2dlcjsKCQlvYmplY3Qub24gPSBwLm9uOwoJCW9iamVjdC5vZmYgPSBwLm9mZjsKCQlvYmplY3QuaGFzID0gcC5oYXM7CgkJaWYoY2FsbENvbnN0cnVjdG9yKQoJCQlFdmVudERpc3BhdGNoZXIuY2FsbChvYmplY3QpOwoJfTsKCQoJLy8gQXNzaWduIHRvIG5hbWUgc3BhY2UKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLkV2ZW50RGlzcGF0Y2hlciA9IEV2ZW50RGlzcGF0Y2hlcjsKCQp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbihnbG9iYWwsIGRvYywgdW5kZWZpbmVkKXsKCQkKCS8qKgoJKiAgSGFuZGxlIHRoZSBwYWdlIHZpc2libGl0eSBjaGFuZ2UsIGlmIHN1cHBvcnRlZC4gQXBwbGljYXRpb24gdXNlcyBvbmUgb2YgdGhlc2UgdG8KCSogIG1vbml0b3IgcGFnZSB2aXNpYmlsaXR5LiBJdCBpcyBzdWdnZXN0ZWQgdGhhdCB5b3UgbGlzdGVuIHRvICJwYXVzZSIsICJwYXVzZWQiLCAKCSogIG9yICJ1bnBhdXNlZCIgZXZlbnRzIG9uIHRoZSBhcHBsaWNhdGlvbiBpbnN0ZWFkIG9mIHVzaW5nIG9uZSBvZiB0aGVzZSB5b3Vyc2VsZi4KCSogIAoJKiAgQGNsYXNzIFBhZ2VWaXNpYmlsaXR5CgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IG9uRm9jdXMgQ2FsbGJhY2sgd2hlbiB0aGUgcGFnZSBiZWNvbWVzIHZpc2libGUKCSogIEBwYXJhbSB7ZnVuY3Rpb259IG9uQmx1ciBDYWxsYmFjayB3aGVuIHRoZSBwYWdlIGxvc2VzIHZpc2liaWxpdHkKCSovCgl2YXIgUGFnZVZpc2liaWxpdHkgPSBmdW5jdGlvbihvbkZvY3VzLCBvbkJsdXIpCgl7CgkJLyoqCgkJKiBDYWxsYmFjayB3aGVuIHRoZSBwYWdlIGJlY29tZXMgdmlzaWJsZQoJCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uRm9jdXMKCQkqIEBwcml2YXRlCgkJKi8KCQl0aGlzLl9vbkZvY3VzID0gb25Gb2N1czsKCQkKCQkvKioKCQkqIENhbGxiYWNrIHdoZW4gdGhlIHBhZ2UgbG9zZXMgdmlzaWJpbGl0eQoJCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uQmx1cgoJCSogQHByaXZhdGUKCQkqLwoJCXRoaXMuX29uQmx1ciA9IG9uQmx1cjsKCQkKCQkvKioKCQkqIFRoZSB2aXNpYmlsaXR5IHRvZ2dsZSBmdW5jdGlvbgoJCSogQHByb3BlcnR5IHtmdW5jdGlvbn0gX29uVG9nZ2xlCgkJKiBAcHJpdmF0ZQoJCSovCgkJdGhpcy5fb25Ub2dnbGUgPSBudWxsOwoKCQl0aGlzLmluaXRpYWxpemUoKTsKCX0sCgkKCS8vIFJlZmVyZW5jZSB0byB0aGUgcHJvdG90eXBlIAoJcCA9IFBhZ2VWaXNpYmlsaXR5LnByb3RvdHlwZSwKCQoJLyoqIAoJKiBUaGUgbmFtZSBvZiB0aGUgdmlzaWJpbGl0eSBjaGFuZ2UgZXZlbnQgZm9yIHRoZSBicm93c2VyCgkqIAoJKiBAcHJvcGVydHkge1N0cmluZ30gX3Zpc2liaWxpdHlDaGFuZ2UKCSogQHByaXZhdGUKCSovCglfdmlzaWJpbGl0eUNoYW5nZSA9IG51bGw7CgkKCS8vIFNlbGVjdCB0aGUgdmlzaWJsaXR5IGNoYW5nZSBldmVudCBuYW1lCglpZiAoZG9jLmhpZGRlbiAhPT0gdW5kZWZpbmVkKQoJewoJCV92aXNpYmlsaXR5Q2hhbmdlID0gInZpc2liaWxpdHljaGFuZ2UiOwoJfSAKCWVsc2UgaWYgKGRvYy5tb3pIaWRkZW4gIT09IHVuZGVmaW5lZCkKCXsKCQlfdmlzaWJpbGl0eUNoYW5nZSA9ICJtb3p2aXNpYmlsaXR5Y2hhbmdlIjsKCX0gCgllbHNlIGlmIChkb2MubXNIaWRkZW4gIT09IHVuZGVmaW5lZCkKCXsKCQlfdmlzaWJpbGl0eUNoYW5nZSA9ICJtc3Zpc2liaWxpdHljaGFuZ2UiOwoJfSAKCWVsc2UgaWYgKGRvYy53ZWJraXRIaWRkZW4gIT09IHVuZGVmaW5lZCkKCXsKCQlfdmlzaWJpbGl0eUNoYW5nZSA9ICJ3ZWJraXR2aXNpYmlsaXR5Y2hhbmdlIjsKCX0KCQoJLyoqCgkqICBDcmVhdGUgbmV3IFBhZ2UgdmlzaWJpbGl0eQoJKiAgCgkqICBAbWV0aG9kIGluaXRpYWxpemUKCSovCglwLmluaXRpYWxpemUgPSBmdW5jdGlvbigpCgl7CgkJLy8gSWYgdGhpcyBicm93c2VyIGRvZXNuJ3Qgc3VwcG9ydCB2aXNpYmlsaXR5CgkJaWYgKCFfdmlzaWJpbGl0eUNoYW5nZSkgcmV0dXJuOwoJCQoJCS8vIFRoZSB2aXNpYmlsaXR5IHRvZ2dsZSBmdW5jdGlvbgoJCXZhciBvblZpc2liaWxpdHlDaGFuZ2UgPSBmdW5jdGlvbigpIAoJCXsKCQkJaWYgKGRvYy5oaWRkZW4gfHwgZG9jLndlYmtpdEhpZGRlbiB8fCBkb2MubXNIaWRkZW4gfHwgZG9jLm1vekhpZGRlbikKCQkJCXRoaXMuX29uQmx1cigpOwoJCQllbHNlIAoJCQkJdGhpcy5fb25Gb2N1cygpOwoJCX0uYmluZCh0aGlzKTsKCQkKCQkvLyBMaXN0ZW4gdG8gdmlzaWJpbGl0eSBjaGFuZ2UKCQkvLyBzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4vQVBJL1BhZ2VWaXNpYmlsaXR5L1BhZ2VfVmlzaWJpbGl0eV9BUEkKCQlkb2MuYWRkRXZlbnRMaXN0ZW5lcihfdmlzaWJpbGl0eUNoYW5nZSwgb25WaXNpYmlsaXR5Q2hhbmdlLCBmYWxzZSk7CgkJCgkJLy8gTGlzdGVuIGZvciBwYWdlIGV2ZW50cyAod2hlbiBjbGlja2luZyB0aGUgaG9tZSBidXR0b24gb24gaU9TKQoJCWdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJwYWdlaGlkZSIsIHRoaXMuX29uQmx1cik7CgkJZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoInBhZ2VzaG93IiwgdGhpcy5fb25Gb2N1cyk7CgkJZ2xvYmFsLmFkZEV2ZW50TGlzdGVuZXIoImJsdXIiLCB0aGlzLl9vbkJsdXIpOwoJCWdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJmb2N1cyIsIHRoaXMuX29uRm9jdXMpOwoJCWdsb2JhbC5hZGRFdmVudExpc3RlbmVyKCJ2aXNpYmlsaXR5Y2hhbmdlIiwgb25WaXNpYmlsaXR5Q2hhbmdlLCBmYWxzZSk7CgkJCgkJdGhpcy5fb25Ub2dnbGUgPSBvblZpc2liaWxpdHlDaGFuZ2U7Cgl9OwoJCgkvKioKCSogIERpc2FibGUgdGhlIGRldGVjdGlvbgoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCS8vIElmIHRoaXMgYnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgdmlzaWJpbGl0eQoJCWlmICghX3Zpc2liaWxpdHlDaGFuZ2UpIHJldHVybjsKCQkKCQlnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigicGFnZWhpZGUiLCB0aGlzLl9vbkJsdXIpOwoJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJwYWdlc2hvdyIsIHRoaXMuX29uRm9jdXMpOwoJCWdsb2JhbC5yZW1vdmVFdmVudExpc3RlbmVyKCJibHVyIiwgdGhpcy5fb25CbHVyKTsKCQlnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigiZm9jdXMiLCB0aGlzLl9vbkZvY3VzKTsKCQlnbG9iYWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigidmlzaWJpbGl0eWNoYW5nZSIsIHRoaXMuX29uVG9nZ2xlKTsKCQkKCQlkb2MucmVtb3ZlRXZlbnRMaXN0ZW5lcihfdmlzaWJpbGl0eUNoYW5nZSwgdGhpcy5fb25Ub2dnbGUsIGZhbHNlKTsKCQkKCQl0aGlzLl9vbkZvY3VzID0gbnVsbDsKCQl0aGlzLl9vbkJsdXIgPSBudWxsOwoJfTsKCQoJLy8gQXNzaWduIHRvIHRoZSBnbG9iYWwgc3BhY2UKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLlBhZ2VWaXNpYmlsaXR5ID0gUGFnZVZpc2liaWxpdHk7CgkKfSh3aW5kb3csIGRvY3VtZW50KSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgoJLy8gY2xhc3NlcyB0byBpbXBvcnQKCXZhciBEZWJ1ZywKCQlMb2FkZXIsCgkJVGltZVV0aWxzLAoJCVBhZ2VWaXNpYmlsaXR5LAoJCUV2ZW50RGlzcGF0Y2hlciA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuRXZlbnREaXNwYXRjaGVyJyk7CgoJLyoqCgkqICBDcmVhdGVzIGEgbmV3IGFwcGxpY2F0aW9uLCBmb3IgZXhhbXBsZSAoSGFwcHlDYW1lbCBleHRlbmRzIEFwcGxpY2F0aW9uKQoJKiAgbWFuYWdlcyBkaXNwbGF5cywgdXBkYXRlIGxvb3AgY29udHJvbGxpbmcsIGhhbmRsZXMgcmVzaXppbmcKCSoKCSoJdmFyIGFwcCA9IG5ldyBBcHBsaWNhdGlvbih7ZnBzOjYwLCByZXNpemVFbGVtZW50OndpbmRvd30pOwoJKgoJKiAgQGNsYXNzIEFwcGxpY2F0aW9uCgkqICBAZXh0ZW5kIEV2ZW50RGlzcGF0Y2hlcgoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcGFyYW0ge09iamVjdH0gW29wdGlvbnNdIFRoZSBvcHRpb25zIGZvciBjcmVhdGluZyB0aGUgYXBwbGljYXRpb24KCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5mcHM9NjBdIFRoZSBmcmFtZXJhdGUgdG8gdXNlIGZvciByZW5kZXJpbmcgdGhlIHN0YWdlCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnJhZj10cnVlXSBVc2UgcmVxdWVzdCBhbmltYXRpb24gZnJhbWUKCSogIEBwYXJhbSB7U3RyaW5nfGludH0gW29wdGlvbnMudmVyc2lvbl0gVGhlIGN1cnJlbnQgdmVyc2lvbiBudW1iZXIgZm9yIHlvdXIgYXBwbGljYXRpb24uIFRoaXMgCgkqICAgICAgIG51bWJlciB3aWxsIGF1dG9tYXRpY2FsbHkgYmUgYXBwZW5kZWQgdG8gYWxsIGZpbGUgcmVxdWVzdHMuIEZvciBpbnN0YW5jZSwgaWYgdGhlIHZlcnNpb24KCSogICAgICAgaXMgIjAuMC4xIiBhbGwgZmlsZSByZXF1ZXN0cyB3aWxsIGJlIGFwcGVuZGVkIHdpdGggIj92PTAuMC4xIgoJKiAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLnZlcnNpb25zRmlsZV0gUGF0aCB0byBhIHRleHQgZmlsZSB3aGljaCBjb250YWlucyBleHBsaWNpdCB2ZXJzaW9uCgkqCQludW1iZXJzIGZvciBlYWNoIGFzc2V0LiBUaGlzIGlzIHVzZWZ1bCBmb3IgY29udHJvbGxpbmcgdGhlIGxpdmUgYnJvd3NlciBjYWNoZS4KCSoJCUZvciBpbnN0YW5jZSwgdGhpcyB0ZXh0IGZpbGUgd291bGQgaGF2ZSBhbiBhc3NldCBvbiBlYWNoIGxpbmUgZm9sbG93ZWQgYnkgYSBudW1iZXI6CgkqCQlgYXNzZXRzL2NvbmZpZy9jb25maWcuanNvbiAyYCB0aGlzIHdvdWxkIGxvYWQgYGFzc2V0cy9jb25maWcvY29uZmlnLmpzb24/dj0yYAoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy5jYWNoZUJ1c3Q9ZmFsc2VdIE92ZXJyaWRlIHRoZSBlbmQtdXNlciBicm93c2VyIGNhY2hlIGJ5IGFkZGluZyAiP3Y9IgoJKgkJdG8gdGhlIGVuZCBvZiBlYWNoIGZpbGUgcGF0aCByZXF1ZXN0ZWQuIFVzZSBmb3IgZGV2ZWxvcG1lbnRseSwgZGVidWdnaW5nIG9ubHkhCgkqICBAcGFyYW0ge1N0cmluZ30gW29wdGlvbnMuYmFzZVBhdGhdIFRoZSBvcHRpb25hbCBmaWxlIHBhdGggdG8gcHJlZml4IHRvIGFueSByZWxhdGl2ZSBmaWxlIHJlcXVlc3RzCgkqCQl0aGlzIGlzIGEgZ3JlYXQgd2F5IHRvIGxvYWQgYWxsIGxvYWQgcmVxdWVzdHMgd2l0aCBhIENETiBwYXRoLgoJKiAgQHBhcmFtIHtTdHJpbmd8RE9NRWxlbWVudHxXaW5kb3d9IFtvcHRpb25zLnJlc2l6ZUVsZW1lbnRdIFRoZSBlbGVtZW50IHRvIHJlc2l6ZSB0aGUgY2FudmFzIHRvCgkqICBAcGFyYW0ge0Jvb2xlYW59IFtvcHRpb25zLnVuaWZvcm1SZXNpemU9dHJ1ZV0gV2hldGhlciB0byByZXNpemUgdGhlIGRpc3BsYXlzIHRvIHRoZSBvcmlnaW5hbCBhc3BlY3QgcmF0aW8KCSogIEBwYXJhbSB7TnVtYmVyfSBbb3B0aW9ucy5tYXhBc3BlY3RSYXRpb10gSWYgZG9pbmcgdW5pZm9ybSByZXNpemluZywgb3B0aW9uYWwgcGFyYW1ldGVyIHRvIGFkZCBhIG1heGltdW0gYXNwZWN0IHJhdGlvLgoJKiAgICAgICAgIFRoaXMgYWxsb3dzIGZvciAidGl0bGUtc2FmZSIgcmVzcG9uc2l2ZW5lc3MuIE11c3QgYmUgZ3JlYXRlciB0aGFuIHRoZSBvcmlnaW5hbCBhc3BlY3QgcmF0aW8gb2YgdGhlIGNhbnZhcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMucXVlcnlTdHJpbmdQYXJhbWV0ZXJzPWZhbHNlXSBQYXJzZSB0aGUgcXVlcnkgc3RyaW5nIHBhcmFtZW50ZXJzIGFzIG9wdGlvbnMKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuZGVidWc9ZmFsc2VdIEVuYWJsZSB0aGUgRGVidWcgY2xhc3MKCSogIEBwYXJhbSB7aW50fSBbb3B0aW9ucy5taW5Mb2dMZXZlbD0wXSBUaGUgbWluaW11bSBsb2cgbGV2ZWwgdG8gc2hvdyBkZWJ1ZyBtZXNzYWdlcyBmb3IgZnJvbSAwIChnZW5lcmFsKSB0byA0IChlcnJvciksCgkqCQl0aGUgYERlYnVnYCBjbGFzcyBtdXN0IGJlIHVzZWQgZm9yIHRoaXMgZmVhdHVyZS4KCSogIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5kZWJ1Z1JlbW90ZV0gVGhlIGhvc3QgY29tcHV0ZXIgZm9yIHJlbW90ZSBkZWJ1Z2dpbmcsCgkqCQl0aGUgZGVidWcgbW9kdWxlIG11c3QgYmUgaW5jbHVkZWQgdG8gdXNlIHRoaXMgZmVhdHVyZS4gQ2FuIGJlIGFuIElQIGFkZHJlc3Mgb3IgaG9zdCBuYW1lLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbb3B0aW9ucy51cGRhdGVUd2Vlbj1mYWxzZV0gSWYgdXNpbmcgVHdlZW5KUywgdGhlIEFwcGxpY2F0aW9uIHdpbGwgdXBkYXRlIHRoZSBUd2VlbiBpdHNlbGYKCSogIEBwYXJhbSB7U3RyaW5nfSBbb3B0aW9ucy5jYW52YXNJZF0gVGhlIGRlZmF1bHQgZGlzcGxheSBET00gSUQgbmFtZQoJKiAgQHBhcmFtIHtGdW5jdGlvbn0gW29wdGlvbnMuZGlzcGxheV0gVGhlIG5hbWUgb2YgdGhlIGNsYXNzIHRvIGluc3RhbmlhdGUgYXMgdGhlIGRpc3BsYXkgKGUuZy4gYHNwcmluZ3JvbGwuUGl4aURpc3BsYXlgKQoJKiAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zLmRpc3BsYXlPcHRpb25zXSBEaXNwbGF5LXNwZWNpZmljIG9wdGlvbnMKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW29wdGlvbnMuY3Jvc3NPcmlnaW49ZmFsc2VdIFVzZWQgYnkgYHNwcmluZ3JvbGwuUGl4aVRhc2tgLCBkZWZhdWx0IGJlaGF2aW9yIGlzIHRvIGxvYWQgYXNzZXRzIGZyb20gdGhlIHNhbWUgZG9tYWluLgoJKi8KCXZhciBBcHBsaWNhdGlvbiA9IGZ1bmN0aW9uKG9wdGlvbnMpCgl7CgkJaWYgKF9pbnN0YW5jZSkKCQl7CgkJCXRocm93ICJPbmx5IG9uZSBBcHBsaWNhdGlvbiBjYW4gYmUgb3BlbmVkIGF0IGEgdGltZSI7CgkJfQoJCV9pbnN0YW5jZSA9IHRoaXM7CgoJCUV2ZW50RGlzcGF0Y2hlci5jYWxsKHRoaXMpOwoKCQlpZighRGVidWcpCgkJewoJCQlEZWJ1ZyA9IGluY2x1ZGUoJ0RlYnVnJyk7CgkJCUxvYWRlciA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuTG9hZGVyJyk7CgkJCVRpbWVVdGlscyA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuVGltZVV0aWxzJyk7CgkJCVBhZ2VWaXNpYmlsaXR5ID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5QYWdlVmlzaWJpbGl0eScpOwoJCX0KCgkJLyoqCgkJKiAgSW5pdGlhbGl6YXRpb24gb3B0aW9ucy9xdWVyeSBzdHJpbmcgcGFyYW1ldGVycywgdGhlc2UgcHJvcGVydGllcyBhcmUgcmVhZC1vbmx5CgkJKiAgQXBwbGljYXRpb24gcHJvcGVydGllcyBsaWtlIHJhZiwgZnBzLCBkb24ndCBoYXZlIGFueSBhZmZlY3Qgb24gdGhlIG9wdGlvbnMgb2JqZWN0LgoJCSogIEBwcm9wZXJ0eSB7T2JqZWN0fSBvcHRpb25zCgkJKiAgQHJlYWRPbmx5CgkJKi8KCQl0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQkvKioKCQkqICBQcmltYXJ5IHJlbmRlcmVyIGZvciB0aGUgYXBwbGljYXRpb24sIGZvciBzaW1wbHkgYWNjZXNzaW5nIEFwcGxpY2F0aW9uLmluc3RhbmNlLmRpc3BsYXkuc3RhZ2U7CgkJKiAgVGhlIGZpcnN0IGRpc3BsYXkgYWRkZWQgYmVjb21lcyB0aGUgcHJpbWFyeSBkaXNwbGF5IGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByb3BlcnR5IHtEaXNwbGF5fSBkaXNwbGF5CgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5kaXNwbGF5ID0gbnVsbDsKCgkJLyoqCgkJKiAgSWYgd2Ugc2hvdWxkIHdhaXQgdG8gaW5pdCB0aGUgQXBwbGljYXRpb24sIHRoaXMgaXMgdXNlZnVsIGlzIHNvbWV0aGluZyBpcyBpbmhlcml0aW5nCgkJKiAgQXBwbGljYXRpb24gYnV0IHdhbnQgdG8gZG8gc29tZSBleHRyYSBzdHVmZiBiZWZvcmUgaW5pdCBpcyBhY3R1YWxseSBjYWxsZWQuCgkJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfcmVhZHlUb0luaXQKCQkqICBAcHJvdGVjdGVkCgkJKi8KCQl0aGlzLl9yZWFkeVRvSW5pdCA9IHRydWU7CgoJCV9kaXNwbGF5cyA9IHt9OwoJCV90aWNrQ2FsbGJhY2sgPSB0aGlzLl90aWNrLmJpbmQodGhpcyk7CgoJCS8vb3RoZXIgaW5pdGlhbGl6YXRpb24gc3R1ZmYgdG9vCgkJLy9pZiB0aGVyZSBhcmUgc29tZSBzcGVjaWZpYyBwcm9wZXJ0aWVzIG9uIHRoZSBvcHRpb25zLCB1c2UgdGhlbSB0byBtYWtlIGEgZGlzcGxheQoJCS8vY2FsbCBpbml0IGFmdGVyIGhhbmRsaW5nIGxvYWRpbmcgdXAgYSB2ZXJzaW9ucyBmaWxlIG9yIGFueSBvdGhlciBuZWVkZWQgYXN5bmNocm9ub3VzIHN0dWZmPwoJCXRoaXMuX2ludGVybmFsSW5pdCgpOwoJfTsKCgkvLyBSZWZlcmVuY2UgdG8gdGhlIHByb3RvdHlwZQoJdmFyIHMgPSBFdmVudERpc3BhdGNoZXIucHJvdG90eXBlOwoJdmFyIHAgPSBBcHBsaWNhdGlvbi5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHMpOwoKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgZnVuY3Rpb24gcmVmZXJlbmNlcyB0byBjYWxsIHdoZW4gaW5pdGlhbGl6aW5nIHRoZSBhcHBsaWNhdGlvbgoJKiAgdGhlc2UgYXJlIHJlZ2lzdGVyZWQgYnkgZXh0ZXJuYWwgbGlicmFyaWVzIHRoYXQgbmVlZCB0byBzZXR1cCwgZGVzdHJveWVkCgkqICBmb3IgaW5zdGFuY2UgTG9hZGVyCgkqICBAcHJvcGVydHkge0FycmF5fSBfZ2xvYmFsSW5pdAoJKiAgQHByaXZhdGUKCSogIEBzdGF0aWMKCSovCglBcHBsaWNhdGlvbi5fZ2xvYmFsSW5pdCA9IFtdOwoKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgZnVuY3Rpb24gcmVmZXJlbmNlcyB0byBjYWxsIHdoZW4gZGVzdHJveWluZyB0aGUgYXBwbGljYXRpb24KCSogIHRoZXNlIGFyZSByZWdpc3RlcmVkIGJ5IGV4dGVybmFsIGxpYnJhcmllcyB0aGF0IG5lZWQgdG8gc2V0dXAsIGRlc3Ryb3llZAoJKiAgZm9yIGluc3RhbmNlIExvYWRlcgoJKiAgQHByb3BlcnR5IHtBcnJheX0gX2dsb2JhbERlc3Ryb3kKCSogIEBwcml2YXRlCgkqICBAc3RhdGljCgkqLwoJQXBwbGljYXRpb24uX2dsb2JhbERlc3Ryb3kgPSBbXTsKCgkvKioKCSogIFRoZSBmcmFtZSByYXRlIG9iamVjdAoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7RE9NT2JqZWN0fSBfZnJhbWVyYXRlCgkqLwoJdmFyIF9mcmFtZXJhdGUgPSBudWxsLAoJCgkvKioKCSogIFRoZSBudW1iZXIgb2YgbXMgc2luY2UgdGhlIGxhc3QgZnJhbWUgdXBkYXRlCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IF9sYXN0RnJhbWVUaW1lCgkqLwoJX2xhc3RGcmFtZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBsYXN0IHRpbWUgc2luY2UgdGhlIGxhc3QgZnBzIHVwZGF0ZQoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7aW50fSBfbGFzdEZQU1VwZGF0ZVRpbWUKCSovCglfbGFzdEZQU1VwZGF0ZVRpbWUgPSAwLAoJCgkvKioKCSogIFRoZSBudW1iZXIgb2YgZnJhbWVzIHNpbmNlIHRoZSBsYXN0IGZwcyB1cGRhdGUKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2ludH0gX2ZyYW1lQ291bnQKCSovCglfZnJhbWVDb3VudCA9IDAsCgoJLyoqCgkqCVRoZSBib3VuZCBjYWxsYmFjayBmb3IgbGlzdGVuaW5nIHRvIHRpY2sgZXZlbnRzCgkqCUBwcml2YXRlCgkqICAgQHByb3BlcnR5IHtGdW5jdGlvbn0gX3RpY2tDYWxsYmFjawoJKi8KCV90aWNrQ2FsbGJhY2sgPSBudWxsLAoKCS8qKgoJKiAgSWYgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24gaXMgcGF1c2hlZAoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX3BhdXNlZAoJKi8KCV9wYXVzZWQgPSBmYWxzZSwKCgkvKioKCSogIFRoZSBpZCBvZiB0aGUgYWN0aXZlIHJlcXVlc3RBbmltYXRpb25GcmFtZSBvciBzZXRUaW1lb3V0IGNhbGwuCgkqICBAcHJvcGVydHkge051bWJlcn0gX3RpY2tJZAoJKiAgQHByaXZhdGUKCSovCglfdGlja0lkID0gLTEsCgoJLyoqCgkqICBJZiByZXF1ZXN0aW9uQW5pbWF0aW9uRnJhbWUgc2hvdWxkIGJlIHVzZWQKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge0Jvb2x9IF91c2VSQUYKCSogIEBkZWZhdWx0IGZhbHNlCgkqLwoJX3VzZVJBRiA9IGZhbHNlLAoKCS8qKgoJKiAgVGhlIGN1cnJlbnQgaW50ZXJuYWwgZnJhbWVzIHBlciBzZWNvbmQKCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBfZnBzCgkqICBAcHJpdmF0ZQoJKiAgQGRlZmF1bHQgMAoJKi8KCV9mcHMgPSAwLAoKCS8qKgoJKiBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyBwZXIgZnJhbWUKCSogQHByb3BlcnR5IHtpbnR9IF9tc1BlckZyYW1lCgkqIEBwcml2YXRlCgkqLwoJX21zUGVyRnJhbWUgPSAwLAoKCS8qKgoJKiAgRG9tIGVsZW1lbnQgKG9yIHRoZSB3aW5kb3cpIHRvIGF0dGFjaCByZXNpemUgbGlzdGVuZXJzIGFuZCByZWFkIHRoZSBzaXplIGZyb20KCSogIEBwcm9wZXJ0eSB7RE9NRWxlbWVudHxXaW5kb3d8bnVsbH0gX3Jlc2l6ZUVsZW1lbnQKCSogIEBwcml2YXRlCgkqICBAZGVmYXVsdCBudWxsCgkqLwoJX3Jlc2l6ZUVsZW1lbnQgPSBudWxsLAoKCS8qKgoJKiAgVGhlIGFzcGVjdCByYXRpbyBvZiB0aGUgcHJpbWFyeSBkaXNwbGF5LCBhcyB3aWR0aCAvIGhlaWdodC4KCSogIEBwcm9wZXJ0eSB7TnVtYmVyfSBfYXNwZWN0UmF0aW8KCSogIEBwcml2YXRlCgkqLwoJX2FzcGVjdFJhdGlvID0gMCwKCgkvKioKCSogIEEgUGFnZVZpc2liaWxpdHkgb2JqZWN0IHRvIGF1dG9tYXRpY2FsbHkgcGF1c2UgQXBwbGljYXRpb24gd2hlbiB0aGUgcGFnZSBpcyBoaWRkZW4uCgkqICBAcHJvcGVydHkge1BhZ2VWaXNpYmlsaXR5fSBfcGFnZVZpc2liaWxpdHkKCSogIEBwcml2YXRlCgkqLwoJX3BhZ2VWaXNpYmlsaXR5ID0gbnVsbCwKCgoJLyoqCgkqICBSZW5kZXJpbmcgcGx1Z2lucywgaW4gYSBkaWN0aW9uYXJ5IGJ5IGNhbnZhcyBpZAoJKiAgQHByb3BlcnR5IHtkaWN0aW9uYXJ5fSBfZGlzcGxheXMKCSogIEBwcml2YXRlCgkqLwoJX2Rpc3BsYXlzID0gbnVsbCwKCgkvKioKCSogIERlZmF1bHQgaW5pdGlhbGl6YXRpb24gb3B0aW9ucy4KCSogIEBwcm9wZXJ0eSB7ZGljdGlvbmFyeX0gX2RlZmF1bHRPcHRpb25zCgkqICBAcHJpdmF0ZQoJKi8KCV9kZWZhdWx0T3B0aW9ucyA9Cgl7CgkJLy9hcHBsaWNhdGlvbiBwcm9wZXJ0aWVzCgkJcmFmOiB0cnVlLAoJCWZwczogNjAsCgkJcmVzaXplRWxlbWVudDogbnVsbCwKCQl1bmlmb3JtUmVzaXplOiB0cnVlLAoJCXF1ZXJ5U3RyaW5nUGFyYW1ldGVyczogZmFsc2UsCgkJZGVidWc6IGZhbHNlLAoJCW1pbkxvZ0xldmVsOiAwLAoJCWlwOiBudWxsLAoJCS8vZGVmYXVsdCBkaXNwbGF5IHByb3BlcnRpZXMKCQljYW52YXNJZDogbnVsbCwKCQlkaXNwbGF5OiBudWxsLAoJCWRpc3BsYXlPcHRpb25zOiBudWxsLAoJCXVwZGF0ZVR3ZWVuOiBmYWxzZQoJfSwKCgkvKioKCSogIEEgaGVscGVyIG9iamVjdCB0byBhdm9pZCBvYmplY3QgY3JlYXRpb24gZWFjaCByZXNpemUgZXZlbnQuCgkqICBAcHJvcGVydHkge09iamVjdH0gX3Jlc2l6ZUhlbHBlcgoJKiAgQHByaXZhdGUKCSovCglfcmVzaXplSGVscGVyID0geyB3aWR0aDogMCwgaGVpZ2h0OiAwfSwKCgkvKioKCSogIEZpcmVkIHdoZW4gaW5pdGlhbGl6YXRpb24gb2YgdGhlIGFwcGxpY2F0aW9uIGlzIGRvbmUKCSogIEBldmVudCBpbml0CgkqLwoJSU5JVCA9ICdpbml0JywKCgkvKioKCSogIEV2ZW50IHdoZW4gZXZlcnl0aGluZydzIGRvbmUgYnV0IHdlIGhhdmVuJ3QgYWN0dWFsbHkgaW5pdGVkCgkqICBAZXZlbnQgcHJlSW5pdAoJKiAgQHByb3RlY3RlZAoJKi8KCUJFRk9SRV9JTklUID0gJ2JlZm9yZUluaXQnLAoKCS8qKgoJKiAgRmlyZWQgd2hlbiBhbiB1cGRhdGUgaXMgY2FsbGVkLCBldmVyeSBmcmFtZSB1cGRhdGUKCSogIEBldmVudCB1cGRhdGUKCSogIEBwYXJhbSB7aW50fSBlbGFzcGVkIFRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIHNpbmNlIHRoZSBsYXN0IGZyYW1lIHVwZGF0ZQoJKi8KCVVQREFURSA9ICd1cGRhdGUnLAoKCS8qKgoJKiAgRmlyZWQgd2hlbiBhIHJlc2l6ZSBpcyBjYWxsZWQKCSogIEBldmVudCByZXNpemUKCSogIEBwYXJhbSB7aW50fSB3aWR0aCBUaGUgd2lkdGggb2YgdGhlIHJlc2l6ZSBlbGVtZW50CgkqICBAcGFyYW0ge2ludH0gaGVpZ2h0IFRoZSBoZWlnaHQgb2YgdGhlIHJlc2l6ZSBlbGVtZW50CgkqLwoJUkVTSVpFID0gJ3Jlc2l6ZScsCgoJLyoqCgkqICBGaXJlZCB3aGVuIHRoZSBwYXVzZSBzdGF0ZSBpcyB0b2dnbGVkCgkqICBAZXZlbnQgcGF1c2UKCSogIEBwYXJhbSB7Ym9vbGVhbn0gcGF1c2VkIElmIHRoZSBhcHBsaWNhdGlvbiBpcyBub3cgcGF1c2VkCgkqLwoJUEFVU0UgPSAncGF1c2UnLAoKCS8qKgoJKiAgRmlyZWQgd2hlbiB0aGUgYXBwbGljYXRpb24gYmVjb21lcyBwYXVzZWQKCSogIEBldmVudCBwYXVzZWQKCSovCglQQVVTRUQgPSAncGF1c2VkJywKCgkvKioKCSogIEZpcmVkIHdoZW4gdGhlIGFwcGxpY2F0aW9uIHJlc3VtZXMgZnJvbSBhIHBhdXNlZCBzdGF0ZQoJKiAgQGV2ZW50IHJlc3VtZWQKCSovCglSRVNVTUVEID0gJ3Jlc3VtZWQnLAoKCS8qKgoJKiAgRmlyZWQgd2hlbiB0aGUgYXBwbGljYXRpb24gaXMgZGVzdHJveWVkCgkqICBAZXZlbnQgZGVzdHJveQoJKi8KCURFU1RST1kgPSAnZGVzdHJveSc7CgoJLyoqCgkqICBMaWJyYXJpZXMgd291bGQgcmVnaXN0ZXIgZ2xvYmFsIGluaXRpYWxpemF0aW9uIGZ1bmN0aW9ucyB3aGVuIHRoZXkgYXJlIGNyZWF0ZWQsIGUuZy4KCSogIEFwcGxpY2F0aW9uLnJlZ2lzdGVySW5pdChMb2FkZXIuaW5pdCk7CgkqICBAbWV0aG9kIHJlZ2lzdGVySW5pdAoJKiAgQHBhcmFtIHtGdW5jdGlvbn0gZnVuYwoJKiAgQHN0YXRpYwoJKiAgQHB1YmxpYwoJKi8KCUFwcGxpY2F0aW9uLnJlZ2lzdGVySW5pdCA9IGZ1bmN0aW9uKGZ1bmMpCgl7CgkJQXBwbGljYXRpb24uX2dsb2JhbEluaXQucHVzaChmdW5jKTsKCX07CgkvKioKCSogIExpYnJhcmllcyB3b3VsZCByZWdpc3RlciBnbG9iYWwgZGVzdHJveSBmdW5jdGlvbnMgd2hlbiB0aGV5IGFyZSBjcmVhdGVkIG9yIGluaXRpYWxpemVkLCBlLmcuCgkqICBBcHBsaWNhdGlvbi5yZWdpc3RlckluaXQoTG9hZGVyLmluc3RhbmNlLmRlc3Ryb3kuYmluZChMb2FkZXIuaW5zdGFuY2UpKTsKCSogIEBtZXRob2QgcmVnaXN0ZXJEZXN0cm95CgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBmdW5jCgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqLwoJQXBwbGljYXRpb24ucmVnaXN0ZXJEZXN0cm95ID0gZnVuY3Rpb24oZnVuYykKCXsKCQlBcHBsaWNhdGlvbi5fZ2xvYmFsRGVzdHJveS5wdXNoKGZ1bmMpOwoJfTsKCgkvKioKCSogIEdldCB0aGUgc2luZ2xldG9uIGluc3RhbmNlIG9mIHRoZSBhcHBsaWNhdGlvbgoJKiAgQHByb3BlcnR5IHtBcHBsaWNhdGlvbn0gaW5zdGFuY2UKCSogIEBzdGF0aWMKCSogIEBwdWJsaWMKCSovCgl2YXIgX2luc3RhbmNlID0gbnVsbDsKCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShBcHBsaWNhdGlvbiwgImluc3RhbmNlIiwgewoJCWdldDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiBfaW5zdGFuY2U7CgkJfQoJfSk7CgoJLyoqCgkqICBUaGUgaW50ZXJuYWwgaW5pdGlhbGl6YXRpb24KCSogIEBtZXRob2QgX2ludGVybmFsSW5pdAoJKiAgQHByaXZhdGUKCSovCglwLl9pbnRlcm5hbEluaXQgPSBmdW5jdGlvbigpCgl7CgkJLy9ncmFiIHRoZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycyBpZiB3ZSBzaG91bGQgYmUgZG9pbmcgc28KCQl2YXIgcXVlcnkgPSAhIXRoaXMub3B0aW9ucy5wYXJzZVF1ZXJ5U3RyaW5nID8gcGFyc2VRdWVyeVN0cmluZ1BhcmFtcygpIDoge307CgkJCgkJLy8gQXNzZW1ibGUgYWxsIG9mIHRoZSBvcHRpb25zLCB0aGUgbGFzdCB0YWtlcyBwcmVjZWRlbmNlCgkJdGhpcy5vcHRpb25zID0gT2JqZWN0Lm1lcmdlKHt9LCBfZGVmYXVsdE9wdGlvbnMsIHRoaXMub3B0aW9ucywgcXVlcnkpOwoKCQkvLyBDYWxsIGFueSBnbG9iYWwgbGlicmFyaWVzIHRvIGluaXRpYWxpemUKCQlmb3IodmFyIGkgPSAwOyBpIDwgQXBwbGljYXRpb24uX2dsb2JhbEluaXQubGVuZ3RoOyArK2kpCgkJewoJCQlBcHBsaWNhdGlvbi5fZ2xvYmFsSW5pdFtpXSgpOwoJCX0KCgkJX3VzZVJBRiA9IHRoaXMub3B0aW9ucy5yYWY7CgkJdGhpcy5mcHMgPSB0aGlzLm9wdGlvbnMuZnBzOwoJCXZhciBmcmFtZXJhdGUgPSB0aGlzLm9wdGlvbnMuZnJhbWVyYXRlOwoJCWlmKGZyYW1lcmF0ZSkKCQl7CgkJCWlmKHR5cGVvZiBmcmFtZXJhdGUgPT0gInN0cmluZyIpCgkJCQlfZnJhbWVyYXRlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoZnJhbWVyYXRlKTsKCQkJZWxzZQoJCQkJX2ZyYW1lcmF0ZSA9IGZyYW1lcmF0ZTsKCQl9CgkJdmFyIHJlc2l6ZUVsZW1lbnQgPSB0aGlzLm9wdGlvbnMucmVzaXplRWxlbWVudDsKCQlpZihyZXNpemVFbGVtZW50KQoJCXsKCQkJaWYodHlwZW9mIHJlc2l6ZUVsZW1lbnQgPT0gInN0cmluZyIpCgkJCQlfcmVzaXplRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHJlc2l6ZUVsZW1lbnQpOwoJCQllbHNlCgkJCQlfcmVzaXplRWxlbWVudCA9IHJlc2l6ZUVsZW1lbnQ7CgkJCXRoaXMudHJpZ2dlclJlc2l6ZSA9IHRoaXMudHJpZ2dlclJlc2l6ZS5iaW5kKHRoaXMpOwoJCQl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdGhpcy50cmlnZ2VyUmVzaXplKTsKCQl9CgoJCS8vIFR1cm4gb24gZGVidWdnaW5nCgkJaWYgKHRoaXMub3B0aW9ucy5kZWJ1ZyAhPT0gdW5kZWZpbmVkKQoJCQlEZWJ1Zy5lbmFibGVkID0gdGhpcy5vcHRpb25zLmRlYnVnID09PSB0cnVlIHx8IHRoaXMub3B0aW9ucy5kZWJ1ZyA9PT0gInRydWUiOwoJCQoJCWlmICh0aGlzLm9wdGlvbnMubWluTG9nTGV2ZWwgIT09IHVuZGVmaW5lZCkKCQkJRGVidWcubWluTG9nTGV2ZWwgPSBwYXJzZUludCh0aGlzLm9wdGlvbnMubWluTG9nTGV2ZWwsIDEwKTsKCgkJLy9pZiB3ZSB3ZXJlIHN1cHBsaWVkIHdpdGggYW4gSVAgYWRkcmVzcywgY29ubmVjdCB0byBpdCB3aXRoIHRoZSBEZWJ1ZyBjbGFzcyBmb3IgbG9nZ2luZwoJCWlmKHR5cGVvZiB0aGlzLm9wdGlvbnMuZGVidWdSZW1vdGUgPT0gInN0cmluZyIpCgkJCURlYnVnLmNvbm5lY3QodGhpcy5vcHRpb25zLmRlYnVnUmVtb3RlKTsKCgkJLy8gSWYgdHdlZW4gYW5kL29yIHRpY2tlciBhcmUgaW5jbHVkZWQKCQl2YXIgVHdlZW4gPSBpbmNsdWRlKCdjcmVhdGVqcy5Ud2VlbicsIGZhbHNlKSwKCQkJVGlja2VyID0gaW5jbHVkZSgnY3JlYXRlanMuVGlja2VyJywgZmFsc2UpOwoKCQkvLyBBZGQgYW4gb3B0aW9uIHRvIGhhdmUgdGhlIGFwcGxpY2F0aW9uIGNvbnRyb2wgdGhlIFR3ZWVuIHRpY2sKCQlpZiAoVHdlZW4gJiYgdGhpcy5vcHRpb25zLnVwZGF0ZVR3ZWVuKQoJCXsKCQkJaWYgKFRpY2tlcikKCQkJewoJCQkJVGlja2VyLnNldFBhdXNlZCh0cnVlKTsKCQkJfQoJCQl0aGlzLm9uKCd1cGRhdGUnLCBUd2Vlbi50aWNrKTsKCQl9CgkJCgkJLy9zZXQgdXAgdGhlIHBhZ2UgdmlzaWJpbGl0eSBsaXN0ZW5lcgoJCV9wYWdlVmlzaWJpbGl0eSA9IG5ldyBQYWdlVmlzaWJpbGl0eSh0aGlzLl9vblZpc2libGUuYmluZCh0aGlzKSwgdGhpcy5fb25IaWRkZW4uYmluZCh0aGlzKSk7CgoJCWlmKHRoaXMub3B0aW9ucy5jYW52YXNJZCAmJiB0aGlzLm9wdGlvbnMuZGlzcGxheSkKCQkJdGhpcy5hZGREaXNwbGF5KHRoaXMub3B0aW9ucy5jYW52YXNJZCwgdGhpcy5vcHRpb25zLmRpc3BsYXksIHRoaXMub3B0aW9ucy5kaXNwbGF5T3B0aW9ucyk7CgoKCQkvLyBCaW5kIHRoZSBkbyBpbml0CgkJdGhpcy5fZG9Jbml0ID0gdGhpcy5fZG9Jbml0LmJpbmQodGhpcyk7CgoJCS8vIENoZWNrIHRvIHNlZSBpZiB3ZSBzaG91bGQgbG9hZCBhIHZlcnNpb25zIGZpbGUKCQkvLyBUaGUgdmVyc2lvbnMgZmlsZSBrZWVwcyB0cmFjayBvZiBmaWxlIHZlcnNpb25zIHRvIGF2b2lkIGNhY2hlIGlzc3VlcwoJCWlmICh0aGlzLm9wdGlvbnMudmVyc2lvbnNGaWxlICE9PSB1bmRlZmluZWQpCgkJewoJCQkvLyBUcnkgdG8gbG9hZCB0aGUgZGVmYXVsdCB2ZXJzaW9ucyBmaWxlCgkJCS8vIGNhbGxiYWNrIHNob3VsZCBiZSBtYWRlIHdpdGggYSBzY29wZSBpbiBtaW5kCgkJCUxvYWRlci5pbnN0YW5jZS5jYWNoZU1hbmFnZXIuYWRkVmVyc2lvbnNGaWxlKAoJCQkJdGhpcy5vcHRpb25zLnZlcnNpb25zRmlsZSwKCQkJCXRoaXMuX2RvSW5pdAoJCQkpOwoJCX0KCQllbHNlCgkJewoJCQkvLyBXYWl0IHVudGlsIHRoZSBuZXh0IGV4ZWN1dGlvbiBzZXF1ZW5jZQoJCQkvLyBzbyB0aGF0IGluaXQgY2FuIGJlIGFkZGVkIGFmdGVyIGNvbnN0cnVjdGlvbgoJCQlzZXRUaW1lb3V0KHRoaXMuX2RvSW5pdCwgMCk7CgkJfQoJfTsKCgkvKioKCSogIEluaXRpYWxpemUgdGhlIGFwcGxpY2F0aW9uCgkqICBAbWV0aG9kIF9kb0luaXQKCSogIEBwcm90ZWN0ZWQKCSovCglwLl9kb0luaXQgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy50cmlnZ2VyKEJFRk9SRV9JTklUKTsKCgkJLy8gSWYgYSBzdWItY2xhc3Mgd2lsbCBtYW51YWxseSB0cnkgdG8gaW5pdCBsYXRlciBvbgoJCWlmICghdGhpcy5fcmVhZHlUb0luaXQpIHJldHVybjsKCgkJLy8gQ2FsbCB0aGUgaW5pdCBmdW5jdGlvbgoJCWlmICh0aGlzLmluaXQpIHRoaXMuaW5pdCgpOwoKCQkvL2RvIGFuIGluaXRpYWwgcmVzaXplIHRvIG1ha2Ugc3VyZSBldmVyeXRoaW5nIGlzIHNpemVkIHByb3Blcmx5CgkJdGhpcy50cmlnZ2VyUmVzaXplKCk7CgoJCS8vc3RhcnQgdXBkYXRlIGxvb3AKCQl0aGlzLnBhdXNlZCA9IGZhbHNlOwoKCQkvLyBEaXNwYXRjaCB0aGUgaW5pdCBldmVudAoJCXRoaXMudHJpZ2dlcihJTklUKTsKCX07CgoJLyoqCgkqICBEZWZpbmUgYWxsIG9mIHRoZSBxdWVyeSBzdHJpbmcgcGFyYW1ldGVycwoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgcGFyc2VRdWVyeVN0cmluZ1BhcmFtcwoJKiAgQHJldHVybiB7b2JqZWN0fSBUaGUgb2JqZWN0IHJlZmVyZW5jZSB0byB1cGRhdGUKCSovCgl2YXIgcGFyc2VRdWVyeVN0cmluZ1BhcmFtcyA9IGZ1bmN0aW9uKCkKCXsKCQl2YXIgb3V0cHV0ID0ge307CgkJdmFyIGhyZWYgPSB3aW5kb3cubG9jYXRpb24uc2VhcmNoOwoJCWlmKCFocmVmKS8vZW1wdHkgc3RyaW5nIGlzIGZhbHNlCgkJCXJldHVybiBvdXRwdXQ7CgkJdmFyIHZhcnMgPSBocmVmLnN1YnN0cihocmVmLmluZGV4T2YoIj8iKSsxKTsKCQl2YXIgcG91bmQgPSB2YXJzLmluZGV4T2YoJyMnKTsKCQl2YXJzID0gcG91bmQgPCAwID8gdmFycyA6IHZhcnMuc3Vic3RyaW5nKDAsIHBvdW5kKTsKCQl2YXIgc3BsaXRGbGFzaFZhcnMgPSB2YXJzLnNwbGl0KCImIik7CgkJdmFyIG15VmFyOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgc3BsaXRGbGFzaFZhcnMubGVuZ3RoOyBpKyspCgkJewoJCQlteVZhciA9IHNwbGl0Rmxhc2hWYXJzW2ldLnNwbGl0KCI9Iik7CgkJCWlmICh0cnVlKQoJCQl7CgkJCQlEZWJ1Zy5sb2cobXlWYXJbMF0gKyAiIC0+ICIgKyBteVZhclsxXSk7CgkJCX0KCQkJb3V0cHV0W215VmFyWzBdXSA9IG15VmFyWzFdOwoJCX0KCQlyZXR1cm4gb3V0cHV0OwoJfTsKCgkvKioKCSogIE92ZXJyaWRlIHRoaXMgdG8gZG8gcG9zdCBjb25zdHJ1Y3RvciBpbml0aWFsaXphdGlvbgoJKiAgQG1ldGhvZCBpbml0CgkqICBAcHJvdGVjdGVkCgkqLwoJcC5pbml0ID0gbnVsbDsKCgkvKioKCSogIFByaXZhdGUgbGlzdGVuZXIgZm9yIHdoZW4gdGhlIHBhZ2UgaXMgaGlkZGVuLgoJKiAgQG1ldGhvZCBfb25IaWRkZW4KCSogIEBwcml2YXRlCgkqLwoJcC5fb25IaWRkZW4gPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5wYXVzZWQgPSB0cnVlOwoJfTsKCgkvKioKCSogIFByaXZhdGUgbGlzdGVuZXIgZm9yIHdoZW4gdGhlIHBhZ2UgaXMgc2hvd24uCgkqICBAbWV0aG9kIF9vblZpc2libGUKCSogIEBwcml2YXRlCgkqLwoJcC5fb25WaXNpYmxlID0gZnVuY3Rpb24oKQoJewoJCXRoaXMucGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgUGF1c2UgdXBkYXRlcyBhdCB0aGUgYXBwbGljYXRpb24gbGV2ZWwKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gcGF1c2VkCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJwYXVzZWQiLCB7CgkJZ2V0OiBmdW5jdGlvbigpCgkJewoJCQlyZXR1cm4gX3BhdXNlZDsKCQl9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlfcGF1c2VkID0gISF2YWx1ZTsKCQkJdGhpcy50cmlnZ2VyKFBBVVNFLCBfcGF1c2VkKTsKCQkJdGhpcy50cmlnZ2VyKF9wYXVzZWQgPyBQQVVTRUQgOiBSRVNVTUVELCBfcGF1c2VkKTsKCgkJCWlmKF9wYXVzZWQpCgkJCXsKCQkJCWlmKF90aWNrSWQgIT0gLTEpCgkJCQl7CgkJCQkJaWYoX3VzZVJBRikKCQkJCQl7CgkJCQkJCWNhbmNlbEFuaW1hdGlvbkZyYW1lKF90aWNrSWQpOwoJCQkJCX0KCQkJCQllbHNlCgkJCQkJCWNsZWFyVGltZW91dChfdGlja0lkKTsKCQkJCQlfdGlja0lkID0gLTE7CgkJCQl9CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlpZihfdGlja0lkID09IC0xKQoJCQkJewoJCQkJCV90aWNrSWQgPSBfdXNlUkFGID8KCQkJCQkJcmVxdWVzdEFuaW1GcmFtZShfdGlja0NhbGxiYWNrKToKCQkJCQkJc2V0VGFyZ2V0ZWRUaW1lb3V0KF90aWNrQ2FsbGJhY2spOwoJCQkJfQoJCQkJX2xhc3RGUFNVcGRhdGVUaW1lID0gX2xhc3RGcmFtZVRpbWUgPSBUaW1lVXRpbHMubm93KCk7CgkJCX0KCQl9Cgl9KTsKCgkvKioKCSogIE1ha2VzIGEgc2V0VGltZW91dCB3aXRoIGEgdGltZSBiYXNlZCBvbiBfbXNQZXJGcmFtZSBhbmQgdGhlIGFtb3VudCBvZiB0aW1lIHNwZW50IGluIHRoZQoJKiAgY3VycmVudCB0aWNrLgoJKiAgQG1ldGhvZCBzZXRUYXJnZXRlZFRpbWVvdXQKCSogIEBwYXJhbSB7RnVuY3Rpb259IGNhbGxiYWNrIFRoZSB0aWNrIGZ1bmN0aW9uIHRvIGNhbGwuCgkqICBAcGFyYW0ge2ludH0gdGltZUluRnJhbWU9MCBUaGUgYW1vdW50IG9mIHRpbWUgc3BlbnQgaW4gdGhlIGN1cnJlbnQgdGljayBpbiBtaWxsaXNlY29uZHMuCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBzZXRUYXJnZXRlZFRpbWVvdXQgPSBmdW5jdGlvbihjYWxsYmFjaywgdGltZUluRnJhbWUpCgl7CgkJdmFyIHRpbWVUb0NhbGwgPSBfbXNQZXJGcmFtZTsKCQkvL3N1YnRyYWN0IHRoZSB0aW1lIHNwZW50IGluIHRoZSBmcmFtZSB0byBhY3R1YWxseSBoaXQgdGhlIHRhcmdldCBmcHMKCQlpZih0aW1lSW5GcmFtZSkKCQkJdGltZVRvQ2FsbCA9IE1hdGgubWF4KDAsIF9tc1BlckZyYW1lIC0gdGltZUluRnJhbWUpOwoJCXJldHVybiBzZXRUaW1lb3V0KGNhbGxiYWNrLCB0aW1lVG9DYWxsKTsKCX07CgoJLyoqCgkqICBGaXJlIGEgcmVzaXplIGV2ZW50IHdpdGggdGhlIGN1cnJlbnQgd2lkdGggYW5kIGhlaWdodCBvZiB0aGUgZGlzcGxheQoJKiAgQG1ldGhvZCB0cmlnZ2VyUmVzaXplCgkqLwoJcC50cmlnZ2VyUmVzaXplID0gZnVuY3Rpb24oKQoJewoJCWlmKCFfcmVzaXplRWxlbWVudCkgcmV0dXJuOwoKCQkvLyB3aW5kb3cgdXNlcyBpbm5lcldpZHRoLCBET00gZWxlbWVudHMgY2xpZW50V2lkdGgKCQlfcmVzaXplSGVscGVyLndpZHRoID0gKF9yZXNpemVFbGVtZW50LmlubmVyV2lkdGggfHwgX3Jlc2l6ZUVsZW1lbnQuY2xpZW50V2lkdGgpIHwgMDsKCQlfcmVzaXplSGVscGVyLmhlaWdodCA9IChfcmVzaXplRWxlbWVudC5pbm5lckhlaWdodCB8fCBfcmVzaXplRWxlbWVudC5jbGllbnRIZWlnaHQpIHwgMDsKCgkJdGhpcy5jYWxjdWxhdGVEaXNwbGF5U2l6ZShfcmVzaXplSGVscGVyKTsKCQkKCQkvL3JvdW5kIGRvd24sIGFzIGNhbnZhc2VzIHJlcXVpcmUgaW50ZWdlciBzaXplcwoJCV9yZXNpemVIZWxwZXIud2lkdGggfD0gMDsKCQlfcmVzaXplSGVscGVyLmhlaWdodCB8PSAwOwoKCQkvL3Jlc2l6ZSB0aGUgZGlzcGxheXMKCQlmb3IodmFyIGtleSBpbiBfZGlzcGxheXMpCgkJewoJCQlfZGlzcGxheXNba2V5XS5yZXNpemUoX3Jlc2l6ZUhlbHBlci53aWR0aCwgX3Jlc2l6ZUhlbHBlci5oZWlnaHQpOwoJCX0KCQkvL3NlbmQgb3V0IHRoZSByZXNpemUgZXZlbnQKCQl0aGlzLnRyaWdnZXIoUkVTSVpFLCBfcmVzaXplSGVscGVyLndpZHRoLCBfcmVzaXplSGVscGVyLmhlaWdodCk7Cgl9OwoKCS8qKgoJKiAgQ2FsY3VsYXRlcyB0aGUgcmVzaXppbmcgb2YgZGlzcGxheXMuIEJ5IGRlZmF1bHQsIHRoaXMgbGltaXRzIHRoZSBuZXcgc2l6ZQoJKiAgdG8gdGhlIGluaXRpYWwgYXNwZWN0IHJhdGlvIG9mIHRoZSBwcmltYXJ5IGRpc3BsYXkuIE92ZXJyaWRlIHRoaXMgZnVuY3Rpb24KCSogIGlmIHlvdSBuZWVkIHZhcmlhYmxlIGFzcGVjdCByYXRpb3MuCgkqICBAbWV0aG9kIGNhbGN1bGF0ZURpc3BsYXlTaXplCgkqICBAcHJvdGVjdGVkCgkqICBAcGFyYW0ge09iamVjdH0gc2l6ZSBBIHNpemUgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHdpZHRoIGFuZCBoZWlnaHQgb2YgdGhlIHJlc2l6ZWQgY29udGFpbmVyLgoJKiAJCQkJVGhlIHNpemUgcGFyYW1ldGVyIGlzIGFsc28gdGhlIG91dHB1dCBvZiB0aGUgZnVuY3Rpb24sIHNvIHRoZSBzaXplIHByb3BlcnRpZXMgYXJlIGVkaXRlZCBpbiBwbGFjZS4KCSogIEBwYXJhbSB7aW50fSBzaXplLndpZHRoIFRoZSB3aWR0aCBvZiB0aGUgcmVzaXplZCBjb250YWluZXIuCgkqICBAcGFyYW0ge2ludH0gc2l6ZS5oZWlnaHQgVGhlIGhlaWdodCBvZiB0aGUgcmVzaXplZCBjb250YWluZXIuCgkqLwoJcC5jYWxjdWxhdGVEaXNwbGF5U2l6ZSA9IGZ1bmN0aW9uKHNpemUpCgl7CgkJaWYgKCFfYXNwZWN0UmF0aW8gfHwgIXRoaXMub3B0aW9ucy51bmlmb3JtUmVzaXplKSByZXR1cm47CgoJCXZhciBtYXhBc3BlY3RSYXRpbyA9IHRoaXMub3B0aW9ucy5tYXhBc3BlY3RSYXRpbyB8fCBfYXNwZWN0UmF0aW8sCgkJCWN1cnJlbnRBc3BlY3QgPSBzaXplLndpZHRoIC8gc2l6ZS5oZWlnaHQ7CgoJCWlmIChjdXJyZW50QXNwZWN0IDwgX2FzcGVjdFJhdGlvKQoJCXsKCQkJLy9saW1pdCB0byB0aGUgbmFycm93ZXIgd2lkdGgKCQkJc2l6ZS5oZWlnaHQgPSBzaXplLndpZHRoIC8gX2FzcGVjdFJhdGlvOwoJCX0KCQllbHNlIGlmIChjdXJyZW50QXNwZWN0ID4gbWF4QXNwZWN0UmF0aW8pCgkJewoJCQkvL2xpbWl0IHRvIHRoZSBzaG9ydGVyIGhlaWdodAoJCQlzaXplLndpZHRoID0gc2l6ZS5oZWlnaHQgKiBtYXhBc3BlY3RSYXRpbzsKCQl9Cgl9OwoKCS8qKgoJKiAgQWRkIGEgZGlzcGxheS4gSWYgdGhpcyBpcyB0aGUgZmlyc3QgZGlzcGxheSBhZGRlZCwgdGhlbiBpdCB3aWxsIGJlIHN0b3JlZCBhcyB0aGlzLmRpc3BsYXkuCgkqICBAbWV0aG9kIGFkZERpc3BsYXkKCSogIEBwYXJhbSB7U3RyaW5nfSBpZCBUaGUgaWQgb2YgdGhlIGNhbnZhcyBlbGVtZW50LCB0aGlzIHdpbGwgYmUgdXNlZCB0byBncmFiIHRoZSBEaXNwbGF5IGxhdGVyCgkqICAgICAgICAgICAgICAgIGFsc28gdGhlIERpc3BsYXkgc2hvdWxkIGJlIHRoZSBvbmUgdG8gY2FsbGVkIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKQoJKiAgICAgICAgICAgICAgICBhbmQgbm90IHRoZSBhcHBsaWNhdGlvbiBzaW5jIHdlIGRvbid0IGNhcmUgYWJvdXQgdGhlIERPTUVsZW1lbnQgYXMgdGhpcyBwb2ludAoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gZGlzcGxheUNvbnN0cnVjdG9yIFRoZSBmdW5jdGlvbiB0byBjYWxsIHRvIGNyZWF0ZSB0aGUgZGlzcGxheSBpbnN0YW5jZQoJKiAgQHBhcmFtIHtPYmplY3R9IFtvcHRpb25zXSBPcHRpb25hbCBEaXNwbGF5IHNwZWNpZmljIG9wdGlvbnMKCSogIEByZXR1cm4ge0Rpc3BsYXl9IFRoZSBjcmVhdGVkIGRpc3BsYXkuCgkqLwoJcC5hZGREaXNwbGF5ID0gZnVuY3Rpb24oaWQsIGRpc3BsYXlDb25zdHJ1Y3Rvciwgb3B0aW9ucykKCXsKCQlpZihfZGlzcGxheXNbaWRdKQoJCXsKCQkJaWYgKHRydWUpCgkJCXsKCQkJCURlYnVnLmVycm9yKCJBIGRpc3BsYXkgYWxyZWFkeSBleGlzdHMgd2l0aCB0aGUgaWQgb2YgIiArIGlkKTsKCQkJfQoJCQlyZXR1cm47CgkJfQoJCXZhciBkaXNwbGF5ID0gX2Rpc3BsYXlzW2lkXSA9IG5ldyBkaXNwbGF5Q29uc3RydWN0b3IoaWQsIG9wdGlvbnMpOwoJCWlmICghdGhpcy5kaXNwbGF5KQoJCXsKCQkJdGhpcy5kaXNwbGF5ID0gZGlzcGxheTsKCQkJX2FzcGVjdFJhdGlvID0gZGlzcGxheS53aWR0aCAvIGRpc3BsYXkuaGVpZ2h0OwoJCQl2YXIgbWF4QXNwZWN0UmF0aW8gPSB0aGlzLm9wdGlvbnMubWF4QXNwZWN0UmF0aW8gfHwgX2FzcGVjdFJhdGlvOwoKCQkJaWYgKG1heEFzcGVjdFJhdGlvIDwgX2FzcGVjdFJhdGlvKQoJCQl7CgkJCQlpZiAodHJ1ZSkKCQkJCXsKCQkJCQl0aHJvdyAiSW52YWxpZCAnbWF4QXNwZWN0UmF0aW8nOiBNdXN0IGJlIGdyZWF0ZXIgdGhhbiB0aGUgb3JpZ2luYWwgYXNwZWN0IHJhdGlvIG9mIHRoZSBkaXNwbGF5IjsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQl0aHJvdyAiSW52YWxpZCAnbWF4QXNwZWN0UmF0aW8nIjsKCQkJCX0KCQkJfQoJCX0KCQlyZXR1cm4gZGlzcGxheTsKCX07CgoJLyoqCgkqICBHZXRzIGEgc3BlY2lmaWMgcmVuZGVyZXIgYnkgdGhlIGNhbnZhcyBpZC4KCSogIEBtZXRob2QgZ2V0RGlzcGxheQoJKiAgQHBhcmFtIHtTdHJpbmd9IGlkIFRoZSBpZCBvZiB0aGUgY2FudmFzCgkqICBAcmV0dXJuIHtEaXNwbGF5fSBUaGUgcmVxdWVzdGVkIGRpc3BsYXkuCgkqLwoJcC5nZXREaXNwbGF5ID0gZnVuY3Rpb24oaWQpCgl7CgkJcmV0dXJuIF9kaXNwbGF5c1tpZF07Cgl9OwoKCS8qKgoJKiAgR2V0cyBhIHNwZWNpZmljIHJlbmRlcmVyIGJ5IHRoZSBjYW52YXMgaWQuCgkqICBAbWV0aG9kIGdldERpc3BsYXlzCgkqICBAcHVibGljCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBbZWFjaF0gT3B0aW9uYWwgbG9vcGluZyBtZXRob2QsIGNhbGxiYWNrIHRha2VzIGEgc2luZ2xlIHBhcmFtZXRlciBvZiB0aGUgZGlzcGxheQoJKiAgQHJldHVybiB7QXJyYXl9IFRoZSBjb2xsZWN0aW9uIG9mIERpc3BsYXkgb2JqZWN0cwoJKi8KCXAuZ2V0RGlzcGxheXMgPSBmdW5jdGlvbihlYWNoKQoJewoJCXZhciBvdXRwdXQgPSBbXTsKCQlmb3IodmFyIGtleSBpbiBfZGlzcGxheXMpCgkJewoJCQlvdXRwdXQucHVzaChfZGlzcGxheXNba2V5XSk7CgkJCWlmICh0eXBlb2YgZWFjaCA9PT0gImZ1bmN0aW9uIikKCQkJewoJCQkJZWFjaC5jYWxsKHRoaXMsIF9kaXNwbGF5c1trZXldKTsKCQkJfQoJCX0KCQlyZXR1cm4gb3V0cHV0OwoJfTsKCgkvKioKCSogUmVtb3ZlcyBhbmQgZGVzdHJveXMgYSBkaXNwbGF5CgkqIEBtZXRob2QgcmVtb3ZlRGlzcGxheQoJKiBAcGFyYW0ge1N0cmluZ30gaWQgVGhlIERpc3BsYXkncyBpZCAoYWxzbyB0aGUgY2FudmFzIElEKQoJKi8KCXAucmVtb3ZlRGlzcGxheSA9IGZ1bmN0aW9uKGlkKQoJewoJCXZhciBkaXNwbGF5ID0gX2Rpc3BsYXlzW2lkXTsKCQlpZihkaXNwbGF5KQoJCXsKCQkJZGlzcGxheS5kZXN0cm95KCk7CgkJCWRlbGV0ZSBfZGlzcGxheXNbaWRdOwoJCX0KCX07CgoJLyoqCgkqICBQcm9wZXJ0eSBmb3IgZ2V0dGluZy9zZXR0aW5nIHRoZSB0YXJnZXQgZnBzICh3aGVuIG5vdCB1c2luZyBSQUYpCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge051bWJlcn0gZnBzCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJmcHMiLCB7CgkJZ2V0OiBmdW5jdGlvbigpCgkJewoJCQlyZXR1cm4gX2ZwczsKCQl9LAoJCXNldDogZnVuY3Rpb24odmFsdWUpCgkJewoJCQlpZih0eXBlb2YgdmFsdWUgIT0gIm51bWJlciIpIHJldHVybjsKCQkJX2ZwcyA9IHZhbHVlOwoJCQlfbXNQZXJGcmFtZSA9ICgxMDAwIC8gX2ZwcykgfCAwOwoJCX0KCX0pOwoKCS8qKgoJKiAgR2V0dGVyIGFuZCBzZXR0aW5nIGZvciB1c2luZyBSZXF1ZXN0IEFuaW1hdGlvbiBGcmFtZQoJKiAgQHB1YmxpYwoJKiAgQHByb3BlcnR5IHtCb29sZWFufSByYWYKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgInJhZiIsIHsKCQlnZXQ6IGZ1bmN0aW9uKCkKCQl7CgkJCXJldHVybiBfdXNlUkFGOwoJCX0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCV91c2VSQUYgPSAhIXZhbHVlOwoJCX0KCX0pOwoKCS8qKgoJKiAgX3RpY2sgd291bGQgYmUgYm91bmQgaW4gX3RpY2tDYWxsYmFjawoJKiAgQG1ldGhvZCBfdGljawoJKiAgQHByaXZhdGUKCSovCglwLl90aWNrID0gZnVuY3Rpb24oKQoJewoJCWlmIChfcGF1c2VkKQoJCXsKCQkJX3RpY2tJZCA9IC0xOwoJCQlyZXR1cm47CgkJfQoKCQl2YXIgbm93ID0gVGltZVV0aWxzLm5vdygpOwoJCXZhciBkVGltZSA9IG5vdyAtIF9sYXN0RnJhbWVUaW1lOwoJCQoJCS8vIE9ubHkgdXBkYXRlIHRoZSBmcmFtZXJhdGUgZXZlcnkgc2Vjb25kCgkJaWYoX2ZyYW1lcmF0ZSkKCQl7CgkJCV9mcmFtZUNvdW50Kys7CgkJCXZhciBlbGFwc2VkID0gbm93IC0gX2xhc3RGUFNVcGRhdGVUaW1lOwoJCQlpZiAoZWxhcHNlZCA+IDEwMDApCgkJCXsKCQkJCXZhciBmcmFtZXJhdGVWYWx1ZSA9IDEwMDAgLyBlbGFwc2VkICogX2ZyYW1lQ291bnQ7CgkJCQlfZnJhbWVyYXRlLmlubmVySFRNTCA9ICJGUFM6ICIgKyAoTWF0aC5yb3VuZChmcmFtZXJhdGVWYWx1ZSAqIDEwMDApIC8gMTAwMCk7CgkJCQlfbGFzdEZQU1VwZGF0ZVRpbWUgPSBub3c7CgkJCQlfZnJhbWVDb3VudCA9IDA7CgkJCX0KCQl9CgkJX2xhc3RGcmFtZVRpbWUgPSBub3c7CgoJCS8vdHJpZ2dlciB0aGUgdXBkYXRlIGV2ZW50CgkJdGhpcy50cmlnZ2VyKFVQREFURSwgZFRpbWUpOwoKCQkvL3RoZW4gdXBkYXRlIGFsbCBkaXNwbGF5cwoJCWZvcih2YXIga2V5IGluIF9kaXNwbGF5cykKCQl7CgkJCV9kaXNwbGF5c1trZXldLnJlbmRlcihkVGltZSk7CgkJfQoKCQkvL3JlcXVlc3QgdGhlIG5leHQgdGljawoJCS8vcmVxdWVzdCB0aGUgbmV4dCBhbmltYXRpb24gZnJhbWUKCQlfdGlja0lkID0gX3VzZVJBRiA/CgkJCXJlcXVlc3RBbmltRnJhbWUoX3RpY2tDYWxsYmFjaykgOgoJCQlzZXRUYXJnZXRlZFRpbWVvdXQoX3RpY2tDYWxsYmFjaywgVGltZVV0aWxzLm5vdygpIC0gX2xhc3RGcmFtZVRpbWUpOwoJfTsKCgkvKioKCSogRGVzdHJveXMgdGhlIGFwcGxpY2F0aW9uLCBnbG9iYWwgbGlicmFyaWVzIHJlZ2lzdGVyZWQgdmlhIEFwcGxpY2F0aW9uLnJlZ2lzdGVyRGVzdHJveSgpIGFuZCBhbGwgYWN0aXZlIGRpc3BsYXlzCgkqIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl0aGlzLl9yZWFkeVRvSW5pdCA9IGZhbHNlOwoJCXRoaXMucGF1c2VkID0gdHJ1ZTsKCQl0aGlzLnRyaWdnZXIoREVTVFJPWSk7CgkJCgkJZm9yKHZhciBrZXkgaW4gX2Rpc3BsYXlzKQoJCXsKCQkJX2Rpc3BsYXlzW2tleV0uZGVzdHJveSgpOwoJCX0KCQlfZGlzcGxheXMgPSBudWxsOwoKCQlmb3IodmFyIGkgPSAwOyBpIDwgQXBwbGljYXRpb24uX2dsb2JhbERlc3Ryb3kubGVuZ3RoOyArK2kpCgkJewoJCQlBcHBsaWNhdGlvbi5fZ2xvYmFsRGVzdHJveVtpXSgpOwoJCX0KCgkJaWYoX3Jlc2l6ZUVsZW1lbnQpCgkJewoJCQl3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigicmVzaXplIiwgdGhpcy50cmlnZ2VyUmVzaXplKTsKCQl9CgoJCV9wYWdlVmlzaWJpbGl0eS5kZXN0cm95KCk7CgkJX3BhZ2VWaXNpYmlsaXR5ID0gbnVsbDsKCgkJX2luc3RhbmNlID0KCQlfdGlja0NhbGxiYWNrID0KCQlfZnJhbWVyYXRlID0KCQlfcmVzaXplRWxlbWVudCA9IG51bGw7CgoJCURlYnVnLmRpc2Nvbm5lY3QoKTsKCgkJcy5kZXN0cm95LmNhbGwodGhpcyk7Cgl9OwoKCS8vIEFkZCB0byB0aGUgbmFtZSBzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuQXBwbGljYXRpb24gPSBBcHBsaWNhdGlvbjsKCn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgoJLyoqCgkqICAgVGhlIGRpc3BsYXkgcHJvdmlkZXMgdGhlIGJhc2UgcHJvcGVydGllcyBmb3IgYWxsIGN1c3RvbSBkaXNwbGF5LiBBIGRpc3BsYXkKCSogICBpcyBhIHNwZWNpYWxpemVkIHZpZXcgZm9yIHRoZSBhcHBsaWNhdGlvbi4gQXMgdGhlIG5hbWUgc3VnZ2VzdHMsIHRoaXMgY2xhc3MKCSogICBzaG91bGQgbm90IGJlIGluc3RhbmNpYXRlZCBkaXJlY3RseS4KCSoKCSogICBAY2xhc3MgQWJzdHJhY3REaXNwbGF5CgkqCUBjb25zdHJ1Y3RvcgoJKglAcGFyYW0ge1N0cmluZ30gaWQgVGhlIGlkIG9mIHRoZSBjYW52YXMgZWxlbWVudCBvbiB0aGUgcGFnZSB0byBkcmF3IHRvLgoJKglAcGFyYW0ge09iamVjdH0gb3B0aW9ucyBUaGUgc2V0dXAgZGF0YSBmb3IgdGhlIGRpc3BsYXkuCgkqICAgQHBhcmFtIHtTdHJpbmd9IFtvcHRpb25zLmNvbnRleHRJZD0iMmQiXSBWYWxpZCBvcHRpb25zIGFyZSAiMmQiIGFuZCAid2ViZ2wiCgkqLwoJdmFyIEFic3RyYWN0RGlzcGxheSA9IGZ1bmN0aW9uKGlkLCBvcHRpb25zKQoJewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoKCQkvKioKCQkqICB0aGUgY2FudmFzIG1hbmFnZWQgYnkgdGhpcyBkaXNwbGF5CgkJKiAgQHByb3BlcnR5IHtET01FbGVtZW50fSBjYW52YXMKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKi8KCQl0aGlzLmNhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCgkJLyoqCgkJKiAgVGhlIERPTSBpZCBmb3IgdGhlIGNhbnZhcwoJCSogIEBwcm9wZXJ0eSB7U3RyaW5nfSBpZAoJCSogIEByZWFkT25seQoJCSogIEBwdWJsaWMKCQkqLwoJCXRoaXMuaWQgPSBpZDsKCgkJLyoqCgkJKiAgQ29udmVuaWVuY2UgbWV0aG9kIGZvciBnZXR0aW5nIHRoZSB3aWR0aCBvZiB0aGUgY2FudmFzIGVsZW1lbnQKCQkqICB3b3VsZCBiZSB0aGUgc2FtZSB0aGluZyBhcyBjYW52YXMud2lkdGgKCQkqICBAcHJvcGVydHkge2ludH0gd2lkdGgKCQkqICBAcmVhZE9ubHkKCQkqICBAcHVibGljCgkJKi8KCQl0aGlzLndpZHRoID0gdGhpcy5jYW52YXMud2lkdGg7CgoJCS8qKgoJCSogIENvbnZlbmllbmNlIG1ldGhvZCBmb3IgZ2V0dGluZyB0aGUgaGVpZ2h0IG9mIHRoZSBjYW52YXMgZWxlbWVudAoJCSogIHdvdWxkIGJlIHRoZSBzYW1lIHRoaW5nIGFzIGNhbnZhcy5oZWlnaHQKCQkqICBAcHJvcGVydHkge2ludH0gaGVpZ2h0CgkJKiAgQHJlYWRPbmx5CgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5oZWlnaHQgPSB0aGlzLmNhbnZhcy5oZWlnaHQ7CgoJCS8qKgoJCSogIFRoZSBtYWluIHJlbmRlcmluZyBjb250ZXh0IG9yIHRoZSByb290IGRpc3BsYXkgb2JqZWN0IG9yIHN0YWdlLgoJCSogIEBwcm9wZXJ0eSB7bWl4ZWR9IHN0YWdlCgkJKiAgQHJlYWRPbmx5CgkJKiAgQHB1YmxpYwoJCSovCgkJdGhpcy5zdGFnZSA9IG51bGw7CgoJCS8qKgoJCSogIElmIHJlbmRlcmluZyBpcyBwYXVzZWQgb24gdGhpcyBkaXNwbGF5IG9ubHkuIFBhdXNpbmcgYWxsIGRpc3BsYXlzIGNhbiBiZSBkb25lCgkJKiAgdXNpbmcgQXBwbGljYXRpb24ucGF1c2VkIHNldHRlci4KCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IHBhdXNlZAoJCSogIEBwdWJsaWMKCQkqLwoJCXRoaXMucGF1c2VkID0gZmFsc2U7CgoJCS8qKgoJCSogIElmIGlucHV0IGlzIGVuYWJsZWQgb24gdGhlIHN0YWdlLgoJCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX2VuYWJsZWQKCQkqICBAcHJpdmF0ZQoJCSovCgkJdGhpcy5fZW5hYmxlZCA9IGZhbHNlOwoKCQkvKioKCQkqICBJZiB0aGUgZGlzcGxheSBpcyB2aXNpYmxlLgoJCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX3Zpc2libGUKCQkqICBAcHJpdmF0ZQoJCSovCgkJdGhpcy5fdmlzaWJsZSA9IHRoaXMuY2FudmFzLnN0eWxlLmRpc3BsYXkgIT0gIm5vbmUiOwoKCQkvLyBwcmV2ZW50IG1vdXNlIGRvd24gdHVybmluZyBpbnRvIHRleHQgY3Vyc29yCgkJdGhpcy5jYW52YXMub25tb3VzZWRvd24gPSBmdW5jdGlvbihlKQoJCXsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCX07CgoJCS8qKgoJCSogIFRoZSBBbmltYXRvciBjbGFzcyB0byB1c2Ugd2hlbiB1c2luZyB0aGlzIGRpc3BsYXkuIE90aGVyIG1vZHVsZXMKCQkqICB1c2VzIHRoaXMgdG8gZGV0ZXJtaW5lIHdoYXQgQW5pbWF0b3IgdG8gdXNlLCBmb3IgaW5zdGFuY2Ugc3RhdGVzCgkJKiAgdXNlcyBBbmltYXRvciB3aGVuIHBsYXlpbmcgdHJhbnNpdGlvbiBhbmltYXRpb25zLgoJCSogIEBwcm9wZXJ0eSB7QW5pbWF0b3J9IGFuaW1hdG9yCgkJKiAgQHJlYWRPbmx5CgkJKiAgQHB1YmxpYwoJCSogIEBkZWZhdWx0IG51bGwKCQkqLwoJCXRoaXMuYW5pbWF0b3IgPSBudWxsOwoKCQkvKioKCQkqICBTb21lIG9mIHRoZSBtb2R1bGVzIHJlcXVpcmUgYSBzcGVjaWFsIGRpc3BsYXkgYWRhcHRlciB0byBwcm92aWRlCgkJKiAgY29tbW9uIG1ldGhvZHMgZm9yIG1hbmFnaW5nIGRpc3BsYXkgb2JqZWN0cy4KCQkqICBAcHJvcGVydHkge0Rpc3BsYXlBZGFwdGVyfSBhZGFwdGVyCgkJKiAgQHJlYWRPbmx5CgkJKiAgQHB1YmxpYwoJCSogIEBkZWZhdWx0IG51bGwKCQkqLwoJCXRoaXMuYWRhcHRlciA9IG51bGw7Cgl9OwoKCXZhciBwID0gQWJzdHJhY3REaXNwbGF5LnByb3RvdHlwZTsKCgkvKioKCSogIElmIGlucHV0IGlzIGVuYWJsZWQgb24gdGhlIHN0YWdlIGZvciB0aGlzIGRpc3BsYXkuIFRoZSBkZWZhdWx0IGlzIHRydWUuCgkqICBXaXRob3V0IGEgcmVuZGVyaW5nIGxpYnJhcnksIHRoaXMgZG9lcyBub3QgYWN0dWFsbHkgaGF2ZSBhbiBlZmZlY3QuCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IGVuYWJsZWQKCSogIEBwdWJsaWMKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkocCwgImVuYWJsZWQiLCB7CgkJZ2V0OiBmdW5jdGlvbigpeyByZXR1cm4gdGhpcy5fZW5hYmxlZDsgfSwKCQlzZXQ6IGZ1bmN0aW9uKHZhbHVlKQoJCXsKCQkJdGhpcy5fZW5hYmxlZCA9IHZhbHVlOwoJCX0KCX0pOwoKCS8qKgoJKiAgSWYgdGhlIGRpc3BsYXkgaXMgdmlzaWJsZSwgdXNpbmcgImRpc3BsYXk6IG5vbmUiIGNzcyBvbiB0aGUgY2FudmFzLiBJbnZpc2libGUgZGlzcGxheXMgd29uJ3QgcmVuZGVyLgoJKiAgQHByb3BlcnR5IHtCb29sZWFufSB2aXNpYmxlCgkqICBAcHVibGljCgkqLwoJT2JqZWN0LmRlZmluZVByb3BlcnR5KHAsICJ2aXNpYmxlIiwgewoJCWdldDogZnVuY3Rpb24oKXsgcmV0dXJuIHRoaXMuX3Zpc2libGU7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCXRoaXMuX3Zpc2libGUgPSB2YWx1ZTsKCQkJdGhpcy5jYW52YXMuc3R5bGUuZGlzcGxheSA9IHZhbHVlID8gImJsb2NrIiA6ICJub25lIjsKCQl9Cgl9KTsKCgkvKioKCSogUmVzaXplcyB0aGUgY2FudmFzLiBUaGlzIGlzIG9ubHkgY2FsbGVkIGJ5IHRoZSBBcHBsaWNhdGlvbi4KCSogQG1ldGhvZCByZXNpemUKCSogQGludGVybmFsCgkqIEBwYXJhbSB7aW50fSB3aWR0aCBUaGUgd2lkdGggdGhhdCB0aGUgZGlzcGxheSBzaG91bGQgYmUKCSogQHBhcmFtIHtpbnR9IGhlaWdodCBUaGUgaGVpZ2h0IHRoYXQgdGhlIGRpc3BsYXkgc2hvdWxkIGJlCgkqLwoJcC5yZXNpemUgPSBmdW5jdGlvbih3aWR0aCwgaGVpZ2h0KQoJewoJCXRoaXMud2lkdGggPSB0aGlzLmNhbnZhcy53aWR0aCA9IHdpZHRoOwoJCXRoaXMuaGVpZ2h0ID0gdGhpcy5jYW52YXMuaGVpZ2h0ID0gaGVpZ2h0OwoJfTsKCgkvKiogCgkqIFVwZGF0ZXMgdGhlIHN0YWdlIGFuZCBkcmF3cyBpdC4gVGhpcyBpcyBvbmx5IGNhbGxlZCBieSB0aGUgQXBwbGljYXRpb24uIAoJKiBUaGlzIG1ldGhvZCBkb2VzIG5vdGhpbmcgaWYgcGF1c2VkIGlzIHRydWUgb3IgdmlzaWJsZSBpcyBmYWxzZS4KCSogQG1ldGhvZCByZW5kZXIKCSogQGludGVybmFsCgkqIEBwYXJhbSB7aW50fSBlbGFwc2VkIFRoZSB0aW1lIGVsYXBzZWQgc2luY2UgdGhlIHByZXZpb3VzIGZyYW1lLgoJKi8KCXAucmVuZGVyID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZih0aGlzLnBhdXNlZCB8fCAhdGhpcy5fdmlzaWJsZSkgcmV0dXJuOwoJfTsKCgkvKioKCSogIERlc3Ryb3lzIHRoZSBkaXNwbGF5LiBUaGlzIG1ldGhvZCBpcyBjYWxsZWQgYnkgdGhlIEFwcGxpY2F0aW9uIGFuZCBzaG91bGQgCgkqICBub3QgYmUgY2FsbGVkIGRpcmVjdGx5LCB1c2UgQXBwbGljYXRpb24ucmVtb3ZlRGlzcGxheShpZCkuIAoJKiAgVGhlIHN0YWdlIHJlY3Vyc2l2ZWx5IHJlbW92ZXMgYWxsIGRpc3BsYXkgb2JqZWN0cyBoZXJlLgoJKiAgQG1ldGhvZCBkZXN0cm95CgkqICBAaW50ZXJuYWwKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5lbmFibGVkID0gZmFsc2U7CgkJdGhpcy5hbmltYXRvciA9IG51bGw7CgkJdGhpcy5hZGFwdGVyID0gbnVsbDsKCQl0aGlzLmNhbnZhcy5vbm1vdXNlZG93biA9IG51bGw7CgkJdGhpcy5jYW52YXMgPSBudWxsOwoJfTsKCgkvLyBBc3NpZ24gdG8gdGhlIGdsb2JhbCBuYW1lc3BhY2UKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLkFic3RyYWN0RGlzcGxheSA9IEFic3RyYWN0RGlzcGxheTsKCn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKHVuZGVmaW5lZCl7CgoJLy8gQ2xhc3NlcyB0byBpbXBvcnQKCXZhciBBcHBsaWNhdGlvbiwKCQlMb2FkZXI7CgoJLyoqCgkqICBVc2VkIGZvciBtYW5hZ2luZyB0aGUgYnJvd3NlciBjYWNoZSBvZiBsb2FkaW5nIGV4dGVybmFsIGVsZW1lbnRzCgkqICBjYW4gZWFzaWx5IGxvYWQgdmVyc2lvbiBtYW5pZmVzdCBhbmQgYXBwbHkgaXQgdG8gdGhlIG1lZGlhIGxvYWRlcgoJKiAgc3VwcG9ydHMgY2FjaGUgYnVzdGluZyBhbGwgbWVkaWEgbG9hZCByZXF1ZXN0cwoJKiAgdXNlcyB0aGUgcXVlcnkgc3RyaW5nIHRvIGJ1c3QgYnJvd3NlciB2ZXJzaW9ucy4KCSoKCSogIEBjbGFzcyBDYWNoZU1hbmFnZXIKCSovCgl2YXIgQ2FjaGVNYW5hZ2VyID0gZnVuY3Rpb24oKQoJewoJCWlmKCFBcHBsaWNhdGlvbikKCQl7CgkJCUFwcGxpY2F0aW9uID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5BcHBsaWNhdGlvbicpOwoJCQlMb2FkZXIgPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkxvYWRlcicpOwoJCX0KCQkKCQl0aGlzLl9hcHBseVNwZWNpZmljVmVyc2lvbiA9IHRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uLmJpbmQodGhpcyk7CgkJdGhpcy5fYXBwbHlHbG9iYWxWZXJzaW9uID0gdGhpcy5fYXBwbHlHbG9iYWxWZXJzaW9uLmJpbmQodGhpcyk7CgoJCS8qKgoJCSogIFRoZSBjb2xsZWN0aW9uIG9mIHZlcnNpb24gbnVtYmVycwoJCSogIEBwcm90ZWN0ZWQKCQkqICBAcHJvcGVydHkge0RpY3Rpb25hcnl9IF92ZXJzaW9ucwoJCSovCgkJdGhpcy5fdmVyc2lvbnMgPSB7fTsKCQkKCQkvKioKCQkqICBUaGUgbGlzdCBvZiBVUkwgZmlsdGVyaW5nIGZ1bmN0aW9ucy4KCQkqICBAcHJvdGVjdGVkCgkJKiAgQHByb3BlcnR5IHtBcnJheX0gX2ZpbHRlcnMKCQkqLwoJCXRoaXMuX2ZpbHRlcnMgPSBbXTsKCQkKCQkvKioKCQkqICBBIGdsb2JhbCB2ZXJzaW9uIG9yIGNhY2hlIGJ1c3Rpbmcgc3RyaW5nIHRvIGFwcGx5IHRvIGV2ZXJ5IHVybC4KCQkqICBAcHJvcGVydHkge1N0cmluZ30gX2dsb2JhbFZlcnNpb24KCQkqLwoJCXRoaXMuX2dsb2JhbFZlcnNpb24gPSBudWxsOwoJCQoJCXZhciBjYiA9IEFwcGxpY2F0aW9uLmluc3RhbmNlLm9wdGlvbnMuY2FjaGVCdXN0OwoJCXRoaXMuY2FjaGVCdXN0ID0gKGNiID09PSAidHJ1ZSIgfHwgY2IgPT09IHRydWUpOwoJCQoJCWlmKHRydWUpCgkJewoJCQlpZiAodGhpcy5jYWNoZUJ1c3QpIERlYnVnLmxvZygiQ2FjaGVCdXN0IGFsbCBmaWxlcyBpcyBvbi4iKTsKCQl9Cgl9OwoJCgkvKiBFYXN5IGFjY2VzcyB0byB0aGUgcHJvdG90eXBlICovCgl2YXIgcCA9IENhY2hlTWFuYWdlci5wcm90b3R5cGUgPSB7fTsKCQoJLyoqCgkqICBJZiB3ZSBhcmUgc3VwcG9zZSB0byBjYWNoZSBidXN0IGV2ZXJ5IGZpbGUKCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gY2FjaGVCdXN0CgkqICBAcHVibGljCgkqICBAZGVmYXVsdCBmYWxzZQoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAiY2FjaGVCdXN0IiwKCXsKCQlnZXQ6IGZ1bmN0aW9uKCkKCQl7CgkJCXJldHVybiAhISh0aGlzLl9nbG9iYWxWZXJzaW9uICYmIHRoaXMuX2dsb2JhbFZlcnNpb24uaW5kZXhPZigiY2I9IikgPT09IDApOwoJCX0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCWlmKHZhbHVlKQoJCQl7CgkJCQl0aGlzLl9nbG9iYWxWZXJzaW9uID0gImNiPSIgKyBEYXRlLm5vdygpOwoJCQkJdGhpcy51bnJlZ2lzdGVyVVJMRmlsdGVyKHRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uKTsKCQkJCXRoaXMucmVnaXN0ZXJVUkxGaWx0ZXIodGhpcy5fYXBwbHlHbG9iYWxWZXJzaW9uKTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXZhciB2ZXJzaW9uID0gQXBwbGljYXRpb24uaW5zdGFuY2Uub3B0aW9ucy52ZXJzaW9uOwoJCQkJdGhpcy5fZ2xvYmFsVmVyc2lvbiA9IHZlcnNpb24gPyAidj0iICsgdmVyc2lvbiA6IG51bGw7CgkJCQlpZih0aGlzLl9nbG9iYWxWZXJzaW9uKQoJCQkJewoJCQkJCXRoaXMudW5yZWdpc3RlclVSTEZpbHRlcih0aGlzLl9hcHBseVNwZWNpZmljVmVyc2lvbik7CgkJCQkJdGhpcy5yZWdpc3RlclVSTEZpbHRlcih0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24pOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCXRoaXMudW5yZWdpc3RlclVSTEZpbHRlcih0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24pOwoJCQkJCXRoaXMucmVnaXN0ZXJVUkxGaWx0ZXIodGhpcy5fYXBwbHlTcGVjaWZpY1ZlcnNpb24pOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgkKCS8qKgoJKiAgRGVzdHJveSB0aGUgY2FjaGUgbWFuYWdlciwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5fdmVyc2lvbnMgPSBudWxsOwoJCXRoaXMuX2ZpbHRlcnMgPSBudWxsOwoJCXRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uID0gbnVsbDsKCQl0aGlzLl9hcHBseUdsb2JhbFZlcnNpb24gPSBudWxsOwoJfTsKCQoJLyoqCgkqICBBZGRzIGEgdmVyc2lvbnMgdGV4dCBmaWxlIGNvbnRhaW5pbmcgdmVyc2lvbnMgZm9yIGRpZmZlcmVudCBhc3NldHMuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGFkZFZlcnNpb25zRmlsZQoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIG9mIHRoZSB2ZXJzaW9ucyBmaWxlLgoJKiAgQHBhcmFtIHtGdW5jdGlvbn0gY2FsbGJhY2sgQ2FsbGJhY2sgd2hlbiB0aGUgdmVyc2lvbnMgZmlsZSBoYXMgYmVlbiBsb2FkZWQuCgkqICBAcGFyYW0ge1N0cmluZ30gYmFzZVVybCBBIGJhc2UgdXJsIHRvIHByZXBlbmQgYWxsIGxpbmVzIG9mIHRoZSBmaWxlLgoJKi8KCXAuYWRkVmVyc2lvbnNGaWxlID0gZnVuY3Rpb24odXJsLCBjYWxsYmFjaywgYmFzZVVybCkKCXsKCQlEZWJ1Zy5hc3NlcnQoL14uKlwudHh0JC8udGVzdCh1cmwpLCAiVGhlIHZlcnNpb25zIGZpbGUgbXVzdCBiZSBhICoudHh0IGZpbGUiKTsKCQkJCQoJCXZhciBsb2FkZXIgPSBMb2FkZXIuaW5zdGFuY2U7CgkJCgkJLy8gSWYgd2UgYWxyZWFkeSBjYWNoZSBidXN0aW5nLCB3ZSBjYW4gaWdub3JlIHRoaXMKCQlpZiAodGhpcy5jYWNoZUJ1c3QpCgkJewoJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCXJldHVybjsKCQl9CgkJCgkJLy8gQWRkIGEgcmFuZG9tIHZlcnNpb24gbnVtYmVyIHRvIG5ldmVyIGNhY2hlIHRoZSB0ZXh0IGZpbGUKCQl0aGlzLmFkZFZlcnNpb24odXJsLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpOwoJCQoJCS8vZW5zdXJlIHRoYXQgdGhhdCBjYWNoZSBidXN0aW5nIHZlcnNpb24gaXMgYXBwbGllZAoJCXVybCA9IHRoaXMuX2FwcGx5U3BlY2lmaWNWZXJzaW9uKHVybCk7CgkJCgkJdmFyIGNtID0gdGhpczsKCQkKCQkvLyBMb2FkIHRoZSB2ZXJzaW9uCgkJbG9hZGVyLmxvYWQodXJsLAoJCQlmdW5jdGlvbihyZXN1bHQpCgkJCXsKCQkJCS8vIGNoZWNrIGZvciBhIHZhbGlkIHJlc3VsdCBjb250ZW50CgkJCQlpZiAocmVzdWx0ICYmIHJlc3VsdC5jb250ZW50KQoJCQkJewoJCQkJCS8vIFJlbW92ZSBjYXJyYWdlIHJldHVybnMgYW5kIHNwbGl0IG9uIG5ld2xpbmVzCgkJCQkJdmFyIGxpbmVzID0gcmVzdWx0LmNvbnRlbnQucmVwbGFjZSgvXHIvZywgJycpLnNwbGl0KCJcbiIpOwoJCQkJCXZhciBpLCBwYXJ0czsKCgkJCQkJLy8gR28gbGluZSBieSBsaW5lCgkJCQkJZm9yKGkgPSAwOyBpIDwgbGluZXMubGVuZ3RoOyBpKyspCgkJCQkJewoJCQkJCQkvLyBDaGVjayBmb3IgYSB2YWxpZCBsaW5lCgkJCQkJCWlmICghbGluZXNbaV0pIGNvbnRpbnVlOwoKCQkJCQkJLy8gU3BsaXQgbGluZXMKCQkJCQkJcGFydHMgPSBsaW5lc1tpXS5zcGxpdCgnICcpOwoKCQkJCQkJLy8gQWRkIHRoZSBwYXJ0cwoJCQkJCQlpZiAocGFydHMubGVuZ3RoICE9IDIpIGNvbnRpbnVlOwoKCQkJCQkJLy8gQWRkIHRoZSB2ZXJzaW9uaW5nCgkJCQkJCWNtLmFkZFZlcnNpb24oKGJhc2VVcmwgfHwgIiIpICsgcGFydHNbMF0sIHBhcnRzWzFdKTsKCQkJCQl9CgkJCQl9CgkJCQlpZiAoY2FsbGJhY2spIGNhbGxiYWNrKCk7CgkJCX0KCQkpOwoJfTsKCQoJLyoqCgkqICBBZGQgYSB2ZXJzaW9uIG51bWJlciBmb3IgYSBmaWxlCgkqICBAbWV0aG9kIGFkZFZlcnNpb24KCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCBvZiB0aGUgb2JqZWN0CgkqICBAcGFyYW0ge1N0cmluZ30gdmVyc2lvbiBWZXJzaW9uIG51bWJlciBvciBoYXMgb2YgZmlsZQoJKi8KCXAuYWRkVmVyc2lvbiA9IGZ1bmN0aW9uKHVybCwgdmVyc2lvbikKCXsKCQlpZiAoIXRoaXMuX3ZlcnNpb25zW3VybF0pCgkJCXRoaXMuX3ZlcnNpb25zW3VybF0gPSB2ZXJzaW9uOwoJfTsKCQoJLyoqCgkqICBBZGRzIGEgZnVuY3Rpb24gZm9yIHJ1bm5pbmcgYWxsIHVybHMgdGhyb3VnaCwgdG8gbW9kaWZ5IHRoZW0gaWYgbmVlZGVkLgoJKiAgRnVuY3Rpb25zIHVzZWQgc2hvdWxkIGFjY2VwdCBvbmUgc3RyaW5nIHBhcmFtZXRlciAodGhlIHVybCksIGFuZCByZXR1cm4gdGhlCgkqICBtb2RpZmllZCB1cmwuCgkqICBAbWV0aG9kIHJlZ2lzdGVyVVJMRmlsdGVyCgkqICBAcHVibGljCgkqICBAcGFyYW0ge0Z1bmN0aW9ufSBmaWx0ZXIgVGhlIGZ1bmN0aW9uIHRoYXQgd2lsbCBoYW5kbGUgdXJscy4KCSovCglwLnJlZ2lzdGVyVVJMRmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyKQoJewoJCWlmKHRoaXMuX2ZpbHRlcnMuaW5kZXhPZihmaWx0ZXIpID09IC0xKQoJCQl0aGlzLl9maWx0ZXJzLnB1c2goZmlsdGVyKTsKCX07CgkKCS8qKgoJKiAgUmVtb3ZlcyBhIGZ1bmN0aW9uIGZyb20gdGhlIGxpc3Qgb2YgZmlsdGVyaW5nIGZ1bmN0aW9ucy4KCSogIEBtZXRob2QgdW5yZWdpc3RlclVSTEZpbHRlcgoJKiAgQHB1YmxpYwoJKiAgQHBhcmFtIHtGdW5jdGlvbn0gZmlsdGVyIFRoZSBmdW5jdGlvbiB0byByZW1vdmUuCgkqLwoJcC51bnJlZ2lzdGVyVVJMRmlsdGVyID0gZnVuY3Rpb24oZmlsdGVyKQoJewoJCXZhciBpbmRleCA9IHRoaXMuX2ZpbHRlcnMuaW5kZXhPZihmaWx0ZXIpOwoJCWlmKGluZGV4ID4gLTEpCgkJCXRoaXMuX2ZpbHRlcnMuc3BsaWNlKGluZGV4LCAxKTsKCX07CgkKCS8qKgoJKiAgQXBwbGllcyBhIHVybCBzcGVjaWZpYyB2ZXJzaW9uIHRvIGEgdXJsIGZyb20gdGhlIHZlcnNpb25zIGZpbGUuCgkqICBAbWV0aG9kIF9hcHBseVNwZWNpZmljVmVyc2lvbgoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7U3RyaW5nfSB1cmwgVGhlIHVybCB0byBhcHBseSB2ZXJzaW9uaW5nIHRvLgoJKiAgQHJldHVybiB7U3RyaW5nfSBUaGUgbW9kaWZpZWQgdXJsLgoJKi8KCXAuX2FwcGx5U3BlY2lmaWNWZXJzaW9uID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciB2ZXIgPSB0aGlzLl92ZXJzaW9uc1t1cmxdOwoJCS8vaWYgYSB2ZXJzaW9uIGV4aXN0cyBmb3IgdGhpcyB1cmwsIGFuZCB0aGUgdXJsIGRvZXNuJ3QgYWxyZWFkeSBoYXZlICd2PScgaW4gaXQKCQkvL3RoZW4gYXBwbHkgdGhlIHVybCBzcGVjaWZpYyB2ZXJzaW9uLgoJCWlmKHZlciAmJiAvKFw/fFwmKXZcPVswLTldKi8udGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyAidj0iICsgdmVyLnZlcnNpb247CgkJfQoJCXJldHVybiB1cmw7Cgl9OwoJCgkvKioKCSogIEFwcGxpZXMgY2FjaGUgYnVzdGluZyBvciBhIGdsb2JhbCB2ZXJzaW9uIHRvIGEgdXJsLgoJKiAgQG1ldGhvZCBfYXBwbHlHbG9iYWxWZXJzaW9uCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIGFwcGx5IHZlcnNpb25pbmcgdG8uCgkqICBAcmV0dXJuIHtTdHJpbmd9IFRoZSBtb2RpZmllZCB1cmwuCgkqLwoJcC5fYXBwbHlHbG9iYWxWZXJzaW9uID0gZnVuY3Rpb24odXJsKQoJewoJCWlmKCF0aGlzLl9nbG9iYWxWZXJzaW9uKSByZXR1cm4gdXJsOwoJCXZhciB0ZXN0ID0gdGhpcy5fZ2xvYmFsVmVyc2lvbi5pbmRleE9mKCJjYj0iKSA9PT0gMCA/CgkJCSgvKFw/fFwmKWNiXD1bMC05XSovKSA6ICgvKFw/fFwmKXZcPS8pOwoJCWlmKHRlc3QudGVzdCh1cmwpID09PSBmYWxzZSkKCQl7CgkJCXVybCA9IHVybCArICh1cmwuaW5kZXhPZigiPyIpIDwgMCA/ICI/IiA6ICImIikgKyB0aGlzLl9nbG9iYWxWZXJzaW9uOwoJCX0KCQlyZXR1cm4gdXJsOwoJfTsKCQoJLyoqCgkqICBBcHBsaWVzIGEgYmFzZSBwYXRoIHRvIGEgcmVsYXRpdmUgdXJsLiBUaGlzIGlzIG5vdCB1c2VkIGluIHRoZSBmaWx0ZXJpbmcKCSogIHN5c3RlbSBiZWNhdXNlIFByZWxvYWRKUyBoYXMgaXRzIG93biBtZXRob2Qgb2YgcHJlcGVuZGluZyB0aGUgYmFzZSBwYXRoCgkqICB0aGF0IHdlIHVzZS4gSW5zdGVhZCwgaXQgaXMgdXNlZCB3aXRoIGFuIGV4dHJhIHBhcmFtZXRlciB0byBwcmVwYXJlKCkuCgkqICBAbWV0aG9kIF9hcHBseUJhc2VQYXRoCgkqICBAcHJpdmF0ZQoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIHByZXBlbmQgdGhlIGJhc2UgcGF0aCB0by4KCSogIEByZXR1cm4ge1N0cmluZ30gVGhlIG1vZGlmaWVkIHVybC4KCSovCglwLl9hcHBseUJhc2VQYXRoID0gZnVuY3Rpb24odXJsKQoJewoJCXZhciBiYXNlUGF0aCA9IEFwcGxpY2F0aW9uLmluc3RhbmNlLm9wdGlvbnMuYmFzZVBhdGg7CgkJaWYgKC9eaHR0cChzKT9cOi8udGVzdCh1cmwpID09PSBmYWxzZSAmJiBiYXNlUGF0aCAmJiB1cmwuc2VhcmNoKGJhc2VQYXRoKSA9PSAtMSkKCQl7CgkJCXVybCA9IGJhc2VQYXRoICsgdXJsOwoJCX0KCQlyZXR1cm4gdXJsOwoJfTsKCQoJLyoqCgkqICBQcmVwYXJlIGEgVVJMIHdpdGggdGhlIG5lY2Vzc2FyeSBjYWNoZSBidXN0aW5nIGFuZC9vciB2ZXJzaW9uaW5nCgkqICBhcyB3ZWxsIGFzIHRoZSBiYXNlIGRpcmVjdG9yeS4KCSogIEBwdWJsaWMKCSogIEBtZXRob2QgcHJlcGFyZQoJKiAgQHBhcmFtIHtTdHJpbmd9IHVybCBUaGUgdXJsIHRvIHByZXBhcmUKCSogIEBwYXJhbSB7Qm9vbGVhbn0gW2FwcGx5QmFzZVBhdGg9ZmFsc2VdIElmIHRoZSBnbG9iYWwgYmFzZSBwYXRoIHNob3VsZCBiZSBhcHBsaWVkIHRvIHRoZSB1cmwuCgkqCQlUaGlzIGRlZmF1bHRzIHRvIGZhbHNlIGJlY2F1c2UgaXQgY2FuIHBvdGVudGlhbGx5IGludGVyZmVyZSB3aXRoIGxhdGVyIHJlZ3VsYXIKCSoJCWV4cHJlc3Npb24gY2hlY2tzLCBwYXJ0aWN1bGFybHkgd2l0aCBQcmVsb2FkSlMKCSogIEByZXR1cm4ge1N0cmluZ30gVGhlIGZpbmFsIHVybCB3aXRoIHZlcnNpb24vY2FjaGUgYW5kIGJhc2VQYXRoIGFkZGVkCgkqLwoJcC5wcmVwYXJlID0gZnVuY3Rpb24odXJsLCBhcHBseUJhc2VQYXRoKQoJewoJCWZvcih2YXIgaSA9IDA7IGkgPCB0aGlzLl9maWx0ZXJzLmxlbmd0aDsgKytpKQoJCXsKCQkJdXJsID0gdGhpcy5fZmlsdGVyc1tpXSh1cmwpOwoJCX0KCQkKCQlpZihhcHBseUJhc2VQYXRoKQoJCXsKCQkJdXJsID0gdGhpcy5fYXBwbHlCYXNlUGF0aCh1cmwpOwoJCX0KCQlyZXR1cm4gdXJsOwoJfTsKCQoJLy8gQXNzaWduIHRvIG5hbWVzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuQ2FjaGVNYW5hZ2VyID0gQ2FjaGVNYW5hZ2VyOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKCl7CgkKCS8qKgoJKiAgUmVwcmVzZW50cyBhIHNpbmdsZSBpdGVtIGluIHRoZSBsb2FkZXIgcXVldWUgCgkqCgkqICBAY2xhc3MgTG9hZGVyUXVldWVJdGVtCgkqLwoJdmFyIExvYWRlclF1ZXVlSXRlbSA9IGZ1bmN0aW9uKCkKCXsKCQkvKioKCQkqICBUaGUgdXJsIG9mIHRoZSBsb2FkCgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwKCQkqLwoJCXRoaXMudXJsID0gbnVsbDsKCQkKCQkvKioKCQkqICBEYXRhIGFzc29jaWF0ZSB3aXRoIHRoZSBsb2FkCgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7Kn0gZGF0YQoJCSovCgkJdGhpcy5kYXRhID0gbnVsbDsKCQkKCQkvKioKCQkqICBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gb2YgdGhlIGxvYWQsIHRvIGNhbGwgd2hlbiAKCQkqICB0aGUgbG9hZCBhcyBmaW5pc2hlZCwgdGFrZXMgb25lIGFyZ3VtZW50IGFzIHJlc3VsdAoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBjYWxsYmFjawoJCSovCgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJCgkJLyoqCgkJKiAgVGhlIHByaW9yaXR5IG9mIHRoaXMgaXRlbQoJCSogIEBwcm9wZXJ0eSB7aW50fSBwcmlvcml0eQoJCSogIEBwdWJsaWMKCQkqLwoJCXRoaXMucHJpb3JpdHkgPSAwOwoJCQoJCS8qKgoJCSogIFRoZSBhbW91bnQgd2UndmUgbG9hZGVkIHNvIGZhciwgZnJvbSAwIHRvIDEKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHtOdW1iZXJ9IHByb2dyZXNzCgkJKi8KCQl0aGlzLnByb2dyZXNzID0gMDsKCQkKCQkvKioKCQkqICBUaGUgcHJvZ3Jlc3MgY2FsbGJhY2sKCQkqICBAcHVibGljCgkJKiAgQHByb3BydHkge2Z1bmN0aW9ufSB1cGRhdGVDYWxsYmFjawoJCSovCgkJdGhpcy51cGRhdGVDYWxsYmFjayA9IG51bGw7CgkJCgkJLyoqCgkJKiAgVGhlIGNhbGxiYWNrIHdoZW4gYSBsb2FkIHF1ZXVlIGl0ZW0gZmFpbHMKCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wcnR5IHtmdW5jdGlvbn0gX2JvdW5kRmFpbAoJCSovCgkJdGhpcy5fYm91bmRGYWlsID0gbnVsbDsKCgkJLyoqCgkJKiAgVGhlIGNhbGxiYWNrIHdoZW4gYSBsb2FkIHF1ZXVlIGl0ZW0gcHJvZ3Jlc3NlcwoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BydHkge2Z1bmN0aW9ufSBfYm91bmRQcm9ncmVzcwoJCSovCgkJdGhpcy5fYm91bmRQcm9ncmVzcyA9IG51bGw7CgoJCS8qKgoJCSogIFRoZSBjYWxsYmFjayB3aGVuIGEgbG9hZCBxdWV1ZSBpdGVtIGNvbXBsZXRlcwoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BydHkge2Z1bmN0aW9ufSBfYm91bmRDb21wbGV0ZQoJCSovCgkJdGhpcy5fYm91bmRDb21wbGV0ZSA9IG51bGw7Cgl9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUXVldWVJdGVtLnByb3RvdHlwZTsKCQoJLyoqIAoJKiBIaWdoZXN0IHByaW9yaXR5CgkqIEBzdGF0aWMKCSogQHB1YmxpYwoJKiBAZmluYWwKCSogQHByb3BlcnR5IHtpbnR9IFBSSU9SSVRZX0hJR0gKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfSElHSCA9IDE7CgkKCS8qKiAKCSogTm9ybWFsIHByaW9yaXR5LCB0aGUgZGVmYXVsdAoJKiBAc3RhdGljCgkqIEBwdWJsaWMKCSogQGZpbmFsCgkqIEBwcm9wZXJ0eSB7aW50fSBQUklPUklUWV9OT1JNQUwKCSovCglMb2FkZXJRdWV1ZUl0ZW0uUFJJT1JJVFlfTk9STUFMID0gMDsKCQoJLyoqIAoJKiBMb3dlc3QgcHJpb3JpdHkKCSogQHN0YXRpYwoJKiBAcHVibGljCgkqIEBmaW5hbAoJKiBAcHJvcGVydHkge2ludH0gUFJJT1JJVFlfTE9XCgkqLwoJTG9hZGVyUXVldWVJdGVtLlBSSU9SSVRZX0xPVyA9IC0xOwoJCgkvKioKCSogIFJlcHJlc2VudCB0aGlzIG9iamVjdCBhcyBhIHN0cmluZwoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCB0b1N0cmluZwoJKiAgQHJldHVybiB7c3RyaW5nfSBUaGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgb2JqZWN0CgkqLwoJcC50b1N0cmluZyA9IGZ1bmN0aW9uKCkKCXsKCQlyZXR1cm4gIltMb2FkZXJRdWV1ZUl0ZW0odXJsOiciK3RoaXMudXJsKyInLCBwcmlvcml0eToiK3RoaXMucHJpb3JpdHkrIildIjsKCX07CgkKCS8qKgoJKiAgRGVzdHJveSB0aGlzIHJlc3VsdAoJKiAgQHB1YmxpYwoJKiAgQG1ldGhvZCBkZXN0cm95CgkqLwoJcC5kZXN0cm95ID0gZnVuY3Rpb24oKQoJewoJCXRoaXMuY2FsbGJhY2sgPSBudWxsOwoJCXRoaXMudXBkYXRlQ2FsbGJhY2sgPSBudWxsOwoJCXRoaXMuZGF0YSA9IG51bGw7CgkJdGhpcy5fYm91bmRGYWlsID0gbnVsbDsKCQl0aGlzLl9ib3VuZFByb2dyZXNzID0gbnVsbDsKCQl0aGlzLl9ib3VuZENvbXBsZXRlID0gbnVsbDsKCX07CgkKCS8vIEFzc2lnbiB0byB0aGUgbmFtZSBzcGFjZQoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuTG9hZGVyUXVldWVJdGVtID0gTG9hZGVyUXVldWVJdGVtOwoJCn0oKSk7Ci8qKgoqICBAbW9kdWxlIEZyYW1ld29yawoqICBAbmFtZXNwYWNlIHNwcmluZ3JvbGwKKi8KKGZ1bmN0aW9uKCl7CgkKCS8vIENsYXNzZXMgdG8gaW1wb3J0Cgl2YXIgTG9hZGVyUXVldWVJdGVtLAoJCUNhY2hlTWFuYWdlciwKCQlBcHBsaWNhdGlvbiwKCQlTb3VuZCwKCQlMb2FkUXVldWUsCgkJTG9hZGVyUmVzdWx0OwoKCS8qKgoJKiAgVGhlIExvYWRlciBpcyB0aGUgc2luZ2xldG9uIGxvYWRlciBmb3IgbG9hZGluZyBhbGwgYXNzZXRzCgkqICBpbmNsdWRpbmcgaW1hZ2VzLCBkYXRhLCBjb2RlIGFuZCBzb3VuZHMuIExvYWRlciBzdXBwb3J0cyBjYWNoZS1idXN0aW5nCgkqICBpbiB0aGUgYnJvd3NlciB1c2luZyBkeW5hbWljIHF1ZXJ5IHN0cmluZyBwYXJhbWV0ZXJzLgoJKiAKCSogIEBjbGFzcyBMb2FkZXIKCSovCgl2YXIgTG9hZGVyID0gZnVuY3Rpb24oKQoJewoJCWlmICghQXBwbGljYXRpb24pCgkJewoJCQlMb2FkZXJRdWV1ZUl0ZW0gPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkxvYWRlclF1ZXVlSXRlbScpOwoJCQlDYWNoZU1hbmFnZXIgPSBpbmNsdWRlKCdzcHJpbmdyb2xsLkNhY2hlTWFuYWdlcicpOwoJCQlBcHBsaWNhdGlvbiA9IGluY2x1ZGUoJ3NwcmluZ3JvbGwuQXBwbGljYXRpb24nKTsKCQkJTG9hZGVyUmVzdWx0ID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5Mb2FkZXJSZXN1bHQnKTsKCQkJTG9hZFF1ZXVlID0gaW5jbHVkZSgnY3JlYXRlanMuTG9hZFF1ZXVlJyk7CgkJCVNvdW5kID0gaW5jbHVkZSgnY3JlYXRlanMuU291bmQnLCBmYWxzZSk7CgkJfQoKCQkvKioKCQkqICBJZiB3ZSBjYW4gbG9hZAoJCSogIEBwcml2YXRlCgkJKi8KCQl0aGlzLl9jYW5Mb2FkID0gdHJ1ZTsKCQkKCQkvKioKCQkqICBUaGUgbWF4aW11bSBudW1iZXIgb2Ygc2ltdWxhbmVvdXMgbG9hZHMKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHtpbnR9IG1heFNpbXVsdGFuZW91c0xvYWRzCgkJKiAgQGRlZmF1bHQgMgoJCSovCgkJdGhpcy5tYXhTaW11bHRhbmVvdXNMb2FkcyA9IDI7CgkJCgkJLyoqCgkJKiAgVGhlIHJlZmVyZW5jZSB0byB0aGUgY2FjaGUgbWFuYWdlcgoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkge0NhY2hlTWFuYWdlcn0gY2FjaGVNYW5hZ2VyCgkJKi8KCQl0aGlzLmNhY2hlTWFuYWdlciA9IG51bGw7Cgl9OwoJCgkvKiogVGhlIHByb3RvdHlwZSAqLwoJdmFyIHAgPSBMb2FkZXIucHJvdG90eXBlOwoJCgkvKioKCSogUmVmZXJlbmNlIHRvIHRoZSBwcml2YXRlIGluc3RhbmNlIG9iamVjdAoJKiBAc3RhdGljCgkqIEBwcm90ZWN0ZWQKCSovCgl2YXIgX2luc3RhbmNlID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgY29sbGVjdGlvbiBvZiBMb2FkZXJRdWV1ZUl0ZW1zCgkqICBAcHJpdmF0ZQoJKi8KCXZhciBxdWV1ZSA9IG51bGw7CgkKCS8qKgoJKiAgVGhlIGNvbGxlY3Rpb24gb2YgTG9hZGVyUXVldWVJdGVtcyBieSB1cmwKCSogIEBwcml2YXRlCgkqLwoJdmFyIHF1ZXVlSXRlbXMgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjb2xsZWN0aW9uIG9mIGxvYWRlcnMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge29iamVjdH0gbG9hZGVycwoJKi8KCXZhciBsb2FkZXJzID0gbnVsbDsKCQoJLyoqCgkqICBUaGUgcG9vbCBvZiBxdWV1ZSBpdGVtcwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7YXJyYXl9IGxvYWRlcnMKCSovCgl2YXIgcWlQb29sID0gbnVsbDsKCgkvKioKCSogIFRoZSBwb29sIG9mIGxvYWRlciBpdGVtcwoJKiAgQHByaXZhdGUKCSogIEBwcm9wZXJ0eSB7YXJyYXl9IGxvYWRlcnMKCSovCgl2YXIgbG9hZGVyUG9vbCA9IG51bGw7CgoJLyoqCgkqICBUaGUgcG9vbCBvZiByZXN1bHQgaXRlbXMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge2FycmF5fSBsb2FkZXJzCgkqLwoJdmFyIHJlc3VsdFBvb2wgPSBudWxsOwoJCgkvKioKCSogIFRoZSBjdXJyZW50IG51bWJlciBvZiBpdGVtcyBsb2FkaW5nCgkqICBAcHJpdmF0ZQoJKiAgQHByb3BlcnR5IHtpbnR9IG51bUxvYWRzCgkqICBAZGVmYXVsdCAwCgkqLwoJdmFyIG51bUxvYWRzID0gMDsKCQoJLyoqCgkqICBUaGUgcmV0cnkgYXR0ZW1wdHMKCSogIEBwcml2YXRlCgkqICBAcHJvcGVydHkge09iamVjdH0gcmV0cmllcwoJKi8KCXZhciByZXRyaWVzID0gbnVsbDsKCQoJLyoqCgkqICBTdGF0aWMgY29uc3RydWN0b3IgY3JlYXRpbmcgdGhlIHNpbmdsZXRvbgoJKiAgQG1ldGhvZCBpbml0CgkqICBAc3RhdGljCgkqICBAcHVibGljCgkqLwoJTG9hZGVyLmluaXQgPSBmdW5jdGlvbigpCgl7CgkJaWYgKCFfaW5zdGFuY2UpCgkJewoJCQlfaW5zdGFuY2UgPSBuZXcgTG9hZGVyKCk7CgkJCV9pbnN0YW5jZS5faW5pdGlhbGl6ZSgpOwoJCQkvL3JlZ2lzdGVyIHRoZSBkZXN0cm95IGZ1bmN0aW9uCgkJCUFwcGxpY2F0aW9uLnJlZ2lzdGVyRGVzdHJveSgKCQkJCV9pbnN0YW5jZS5kZXN0cm95LmJpbmQoX2luc3RhbmNlKQoJCQkpOwoJCX0KCQlyZXR1cm4gX2luc3RhbmNlOwoJfTsKCgkvL3JlZ2lzdGVyIHRoZSBnbG9iYWwgaW5pdCBmdW5jdGlvbgoJc3ByaW5ncm9sbC5BcHBsaWNhdGlvbi5yZWdpc3RlckluaXQoTG9hZGVyLmluaXQpOwoJCQoJLyoqCgkqICBTdGF0aWMgZnVuY3Rpb24gZm9yIGdldHRpbmcgdGhlIHNpbmdsZXRvbiBpbnN0YW5jZQoJKiAgQHN0YXRpYwoJKiAgQHJlYWRPbmx5CgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge0xvYWRlcn0gaW5zdGFuY2UKCSovCglPYmplY3QuZGVmaW5lUHJvcGVydHkoTG9hZGVyLCAiaW5zdGFuY2UiLCB7CgkJZ2V0OmZ1bmN0aW9uKCkKCQl7CgkJCXJldHVybiBfaW5zdGFuY2U7CgkJfQoJfSk7CgkKCS8qKgoJKiAgRGVzdHJveSB0aGUgTG9hZGVyIHNpbmdsZXRvbiwgZG9uJ3QgdXNlIGFmdGVyIHRoaXMKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgZGVzdHJveQoJKi8KCXAuZGVzdHJveSA9IGZ1bmN0aW9uKCkKCXsKCQl2YXIgaSwgbGVuLCBrZXksIGFyciA9IHRoaXMucXVldWU7CgkJaWYoYXJyKQoJCXsKCQkJZm9yKGkgPSAwLCBsZW4gPSBhcnIubGVuZ3RoOyBpIDwgaTsgKytpKQoJCQkJYXJyW2ldLmRlc3Ryb3koKTsKCQkJYXJyID0gcWlQb29sOwoJCQlmb3IoaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBpOyArK2kpCgkJCQlhcnJbaV0uZGVzdHJveSgpOwoJCQlhcnIgPSByZXN1bHRQb29sOwoJCQlmb3IoaSA9IDAsIGxlbiA9IGFyci5sZW5ndGg7IGkgPCBpOyArK2kpCgkJCQlhcnJbaV0uZGVzdHJveSgpOwoJCQlmb3Ioa2V5IGluIGxvYWRlcnMpCgkJCXsKCQkJCXF1ZXVlSXRlbXNba2V5XS5kZXN0cm95KCk7CgkJCQlsb2FkZXJzW2tleV0uY2xvc2UoKTsKCQkJfQoJCX0KCQlfaW5zdGFuY2UgPSBudWxsOwoJCWlmICh0aGlzLmNhY2hlTWFuYWdlcikKCQkJdGhpcy5jYWNoZU1hbmFnZXIuZGVzdHJveSgpOwoJCXRoaXMuY2FjaGVNYW5hZ2VyID0gbnVsbDsKCQlxdWV1ZSA9IG51bGw7CgkJcmVzdWx0UG9vbCA9IG51bGw7CgkJbG9hZGVyUG9vbCA9IG51bGw7CgkJcWlQb29sID0gbnVsbDsKCQlxdWV1ZUl0ZW1zID0gbnVsbDsKCQlyZXRyaWVzID0gbnVsbDsKCQlsb2FkZXJzID0gbnVsbDsKCX07CgkKCS8qKgoJKiAgSW5pdGlsaXplIHRoZSBvYmplY3QKCSogIEBwcm90ZWN0ZWQKCSogIEBtZXRob2QgX2luaXRpYWxpemUKCSovCglwLl9pbml0aWFsaXplID0gZnVuY3Rpb24oKQoJewoJCXFpUG9vbCA9IFtdOwoJCWxvYWRlclBvb2wgPSBbXTsKCQlyZXN1bHRQb29sID0gW107CgkJcXVldWUgPSBbXTsKCQlxdWV1ZUl0ZW1zID0ge307CgkJbG9hZGVycyA9IHt9OwoJCXJldHJpZXMgPSB7fTsKCQl0aGlzLmNhY2hlTWFuYWdlciA9IG5ldyBDYWNoZU1hbmFnZXIoKTsKCX07CgkKCS8qKgoJKiAgTG9hZCBhIGZpbGUgCgkqICBAbWV0aG9kIGxvYWQKCSogIEBwdWJsaWMKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIGZpbGUgcGF0aCB0byBsb2FkCgkqICBAcGFyYW0ge2Z1bmN0aW9ufSBjYWxsYmFjayBUaGUgY2FsbGJhY2sgZnVuY3Rpb24gd2hlbiBjb21wbGV0ZWQKCSogIEBwYXJhbSB7ZnVuY3Rpb24qfSB1cGRhdGVDYWxsYmFjayBUaGUgY2FsbGJhY2sgZm9yIGxvYWQgcHJvZ3Jlc3MgdXBkYXRlLCBwYXNzZXMgMC0xIGFzIHBhcmFtCgkqICBAcGFyYW0ge2ludCp9IHByaW9yaXR5IFRoZSBwcmlvcml0eSBvZiB0aGUgbG9hZAoJKiAgQHBhcmFtIHsqfSBkYXRhIG9wdGlvbmFsIGRhdGEKCSovCglwLmxvYWQgPSBmdW5jdGlvbih1cmwsIGNhbGxiYWNrLCB1cGRhdGVDYWxsYmFjaywgcHJpb3JpdHksIGRhdGEpCgl7CgkJdmFyIHFpID0gdGhpcy5fZ2V0UUkoKTsKCQkKCQl2YXIgYmFzZVBhdGggPSBBcHBsaWNhdGlvbi5pbnN0YW5jZS5vcHRpb25zLmJhc2VQYXRoOwoJCWlmIChiYXNlUGF0aCAhPT0gdW5kZWZpbmVkICYmIC9eaHR0cChzKT9cOi8udGVzdCh1cmwpID09PSBmYWxzZSAmJiB1cmwuc2VhcmNoKGJhc2VQYXRoKSA9PSAtMSkKCQl7CgkJCXFpLmJhc2VQYXRoID0gYmFzZVBhdGg7CgkJfQoJCQoJCXFpLnVybCA9IHVybDsKCQlxaS5jYWxsYmFjayA9IGNhbGxiYWNrOwoJCXFpLnVwZGF0ZUNhbGxiYWNrID0gdXBkYXRlQ2FsbGJhY2sgfHwgbnVsbDsKCQlxaS5wcmlvcml0eSA9IHByaW9yaXR5IHx8IExvYWRlclF1ZXVlSXRlbS5QUklPUklUWV9OT1JNQUw7CgkJcWkuZGF0YSA9IGRhdGEgfHwgbnVsbDsKCQkKCQlxdWV1ZS5wdXNoKHFpKTsKCQkKCQkvLyBTb3J5IGJ5IHByaW9yaXR5CgkJcXVldWUuc29ydChmdW5jdGlvbihhLCBiKXsKCQkJcmV0dXJuIGEucHJpb3JpdHkgLSBiLnByaW9yaXR5OwoJCX0pOwoJCQoJCS8vIFRyeSB0byBsb2FkIHRoZSBuZXh0IHF1ZXVlIGl0ZW0KCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJfTsKCQoJLyoqCgkqICBUaGVyZSB3YXMgYW4gZXJyb3IgbG9hZGluZyB0aGUgZmlsZQoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTG9hZEZhaWxlZAoJKiAgQHBhcmFtIHtMb2FkZXJRdWV1ZUl0ZW19IHFpIFRoZSBsb2FkZXIgcXVldWUgaXRlbQoJKi8KCXAuX29uTG9hZEZhaWxlZCA9IGZ1bmN0aW9uKHFpLCBldmVudCkKCXsKCQlEZWJ1Zy5lcnJvcigiVW5hYmxlIHRvIGxvYWQgZmlsZTogIiArIHFpLnVybCAgKyAiIC0gcmVhc29uOiAiICsgZXZlbnQuZXJyb3IpOwoJCQoJCXZhciBsb2FkZXIgPSBsb2FkZXJzW3FpLnVybF07CgkJbG9hZGVyLnJlbW92ZUFsbEV2ZW50TGlzdGVuZXJzKCk7CgkJbG9hZGVyLmNsb3NlKCk7CgkJdGhpcy5fcG9vbExvYWRlcihsb2FkZXIpOwoJCQoJCWRlbGV0ZSBxdWV1ZUl0ZW1zW3FpLnVybF07CgkJZGVsZXRlIGxvYWRlcnNbcWkudXJsXTsKCQkKCQlpZihyZXRyaWVzW3FpLnVybF0pCgkJCXJldHJpZXNbcWkudXJsXSsrOwoJCWVsc2UKCQkJcmV0cmllc1txaS51cmxdID0gMTsKCQlpZihyZXRyaWVzW3FpLnVybF0gPiAzKQoJCQl0aGlzLl9sb2FkRG9uZShxaSwgbnVsbCk7CgkJZWxzZQoJCXsKCQkJbnVtTG9hZHMtLTsKCQkJcXVldWUucHVzaChxaSk7CgkJCXRoaXMuX3RyeU5leHRMb2FkKCk7CgkJfQoJfTsKCQoJLyoqCgkqICBUaGUgZmlsZSBsb2FkIHByb2dyZXNzIGV2ZW50CgkqICBAbWV0aG9kIF9vbkxvYWRQcm9ncmVzcwoJKiAgQHByaXZhdGUKCSogIEBwYXJhbSB7TG9hZGVyUXVldWVJdGVtfSBxaSBUaGUgbG9hZGVyIHF1ZXVlIGl0ZW0KCSogIEBwYXJhbSB7b2JqZWN0fSBldmVudCBUaGUgcHJvZ3Jlc3MgZXZlbnQKCSovCglwLl9vbkxvYWRQcm9ncmVzcyA9IGZ1bmN0aW9uKHFpLCBldmVudCkKCXsKCQlxaS5wcm9ncmVzcyA9IGV2ZW50LnByb2dyZXNzOwoJCWlmIChxaS51cGRhdGVDYWxsYmFjayl7CgkJCXFpLnVwZGF0ZUNhbGxiYWNrKHFpLnByb2dyZXNzKTsKCQl9CQoJfTsKCQoJLyoqCgkqICBUaGUgZmlsZSB3YXMgbG9hZGVkIHN1Y2Nlc3NmdWxseQoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX29uTG9hZENvbXBsZXRlZAoJKiAgQHBhcmFtIHtMb2FkZXJRdWV1ZUl0ZW19IHFpIFRoZSBsb2FkZXIgcXVldWUgaXRlbQoJKiAgQHBhcmFtIHtvYmplY3R9IGV2IFRoZSBsb2FkIGV2ZW50CgkqLwoJcC5fb25Mb2FkQ29tcGxldGVkID0gZnVuY3Rpb24ocWksIGV2KQoJewoJCWlmKHRydWUpCgkJewoJCQlEZWJ1Zy5sb2coIkZpbGUgbG9hZGVkIHN1Y2Nlc3NmdWxseSBmcm9tICIgKyBxaS51cmwpOwoJCX0KCQl2YXIgbG9hZGVyID0gbG9hZGVyc1txaS51cmxdOwoJCWxvYWRlci5yZW1vdmVBbGxFdmVudExpc3RlbmVycygpOwoJCWxvYWRlci5jbG9zZSgpOwoJCXRoaXMuX3Bvb2xMb2FkZXIobG9hZGVyKTsKCQkKCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCWRlbGV0ZSBsb2FkZXJzW3FpLnVybF07CgkJdGhpcy5fbG9hZERvbmUocWksIHRoaXMuX2dldFJlc3VsdChldi5yZXN1bHQsIHFpLnVybCwgbG9hZGVyKSk7Cgl9OwoJCgkvKioKCSogIEF0dGVtcHQgdG8gZG8gdGhlIG5leHQgbG9hZAoJKiAgQG1ldGhvZCBfdHJ5TmV4dExvYWQKCSogIEBwcml2YXRlCgkqLwoJcC5fdHJ5TmV4dExvYWQgPSBmdW5jdGlvbigpCgl7CgkJaWYgKG51bUxvYWRzID4gdGhpcy5tYXhTaW11bHRhbmVvdXNMb2FkcyAtIDEgfHwgcXVldWUubGVuZ3RoID09PSAwKSByZXR1cm47CgkJCgkJbnVtTG9hZHMrKzsKCQkKCQl2YXIgcWkgPSBxdWV1ZS5zaGlmdCgpOwoJCQoJCWlmKHRydWUpCgkJewoJCQlEZWJ1Zy5sb2coIkF0dGVtcHRpbmcgdG8gbG9hZCBmaWxlICciICsgcWkudXJsICsgIiciKTsKCQl9CgkJCgkJcXVldWVJdGVtc1txaS51cmxdID0gcWk7CgkJCgkJdmFyIGxvYWRlciA9IHRoaXMuX2dldExvYWRlcihxaS5iYXNlUGF0aCk7CgkJCgkJLy8gQWRkIHRvIHRoZSBsaXN0IG9mIGxvYWRlcnMKCQlsb2FkZXJzW3FpLnVybF0gPSBsb2FkZXI7CgkJCgkJbG9hZGVyLmFkZEV2ZW50TGlzdGVuZXIoImZpbGVsb2FkIiwgcWkuX2JvdW5kQ29tcGxldGUpOwoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJlcnJvciIsIHFpLl9ib3VuZEZhaWwpOwoJCWxvYWRlci5hZGRFdmVudExpc3RlbmVyKCJmaWxlcHJvZ3Jlc3MiLCBxaS5fYm91bmRQcm9ncmVzcyk7CgkJdmFyIHVybCA9IHRoaXMuY2FjaGVNYW5hZ2VyLnByZXBhcmUocWkudXJsKTsKCQlsb2FkZXIubG9hZEZpbGUocWkuZGF0YSA/IHtpZDpxaS5kYXRhLmlkLCBzcmM6dXJsLCBkYXRhOnFpLmRhdGF9IDogdXJsKTsKCX07CgkKCS8qKgoJKiAgQWxlcnQgdGhhdCB0aGUgbG9hZGluZyBpcyBmaW5pc2hlZAoJKiAgQHByaXZhdGUgCgkqICBAbWV0aG9kIF9sb2FkRG9uZQoJKiAgQHBhcmFtIHtMb2FkZXJRdWV1ZUl0ZW19IHFpIFRoZSBsb2FkZXIgcXVldWUgaXRlbQoJKiAgQHBhcmFtIHtvYmplY3R9IHJlc3VsdCBUaGUgZXZlbnQgZnJvbSBwcmVsb2FkanMgb3IgbnVsbAoJKi8KCXAuX2xvYWREb25lID0gZnVuY3Rpb24ocWksIHJlc3VsdCkKCXsKCQludW1Mb2Fkcy0tOwoJCWlmKHFpLmRhdGEgJiYgcmVzdWx0KS8vYSB3YXkgdG8ga2VlcCB0cmFjayBvZiBsb2FkIHJlc3VsdHMgd2l0aG91dCBleGNlc3NpdmUgZnVuY3Rpb24gYmluZGluZwoJCQlyZXN1bHQuaWQgPSBxaS5kYXRhLmlkOwoJCXFpLmNhbGxiYWNrKHJlc3VsdCk7CgkJLy9xaS5kZXN0cm95KCk7CgkJdGhpcy5fcG9vbFFJKHFpKTsKCQl0aGlzLl90cnlOZXh0TG9hZCgpOwoJfTsKCQoJLyoqCgkqICBDYW5jZWwgYSBsb2FkIHRoYXQncyBjdXJyZW50bHkgaW4gcHJvZ3Jlc3MKCSogIEBwdWJsaWMKCSogIEBtZXRob2QgY2FuY2VsCgkqICBAcGFyYW0ge3N0cmluZ30gdXJsIFRoZSB1cmwKCSogIEByZXR1cm4ge2Jvb2x9IElmIGNhbmNlbGVkIHJldHVybnMgdHJ1ZSwgZmFsc2UgaWYgbm90IGNhbmNlbGVkCgkqLwoJcC5jYW5jZWwgPSBmdW5jdGlvbih1cmwpCgl7CgkJdmFyIHFpID0gcXVldWVJdGVtc1t1cmxdOwoJCXZhciBsb2FkZXIgPSBsb2FkZXJzW3VybF07CgkJCgkJaWYgKHFpICYmIGxvYWRlcikKCQl7CgkJCWxvYWRlci5jbG9zZSgpOwoJCQlkZWxldGUgbG9hZGVyc1t1cmxdOwoJCQlkZWxldGUgcXVldWVJdGVtc1txaS51cmxdOwoJCQludW1Mb2Fkcy0tOwoJCQl0aGlzLl9wb29sTG9hZGVyKGxvYWRlcik7CgkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCXJldHVybiB0cnVlOwoJCX0KCQkKCQlmb3IodmFyIGkgPSAwLCBsZW4gPSBxdWV1ZS5sZW5ndGg7IGkgPCBsZW47IGkrKykKCQl7CgkJCXFpID0gcXVldWVbaV07CgkJCWlmIChxaS51cmwgPT0gdXJsKXsKCQkJCXF1ZXVlLnNwbGljZShpLCAxKTsKCQkJCXRoaXMuX3Bvb2xRSShxaSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCX0KCQlyZXR1cm4gZmFsc2U7CQkKCX07CgkKCXAuX2dldFFJID0gZnVuY3Rpb24oKQoJewoJCXZhciBydG47CgkJaWYocWlQb29sLmxlbmd0aCkKCQkJcnRuID0gcWlQb29sLnBvcCgpOwoJCWVsc2UKCQl7CgkJCXJ0biA9IG5ldyBMb2FkZXJRdWV1ZUl0ZW0oKTsKCQkJcnRuLl9ib3VuZEZhaWwgPSB0aGlzLl9vbkxvYWRGYWlsZWQuYmluZCh0aGlzLCBydG4pOwoJCQlydG4uX2JvdW5kUHJvZ3Jlc3MgPSB0aGlzLl9vbkxvYWRQcm9ncmVzcy5iaW5kKHRoaXMsIHJ0bik7CgkJCXJ0bi5fYm91bmRDb21wbGV0ZSA9IHRoaXMuX29uTG9hZENvbXBsZXRlZC5iaW5kKHRoaXMsIHJ0bik7CgkJfQoJCXJldHVybiBydG47Cgl9OwoJCglwLl9wb29sUUkgPSBmdW5jdGlvbihxaSkKCXsKCQlxaVBvb2wucHVzaChxaSk7CgkJcWkuY2FsbGJhY2sgPSBxaS51cGRhdGVDYWxsYmFjayA9IHFpLmRhdGEgPSBxaS51cmwgPSBudWxsOwoJCXFpLnByb2dyZXNzID0gMDsKCX07CgkKCXAuX2dldExvYWRlciA9IGZ1bmN0aW9uKGJhc2VQYXRoKQoJewoJCXZhciBydG47CgkJaWYobG9hZGVyUG9vbC5sZW5ndGgpCgkJewoJCQlydG4gPSBsb2FkZXJQb29sLnBvcCgpOwoJCQlydG4uX2Jhc2VQYXRoID0gYmFzZVBhdGg7Ly9hcHBhcmVudGx5IHRoZXkgbmVnbGVjdGVkIHRvIG1ha2UgdGhpcyBwdWJsaWMKCQl9CgkJZWxzZQoJCQlydG4gPSBuZXcgTG9hZFF1ZXVlKHRydWUsIGJhc2VQYXRoKTsKCQkvL2FsbG93IHRoZSBsb2FkZXIgdG8gaGFuZGxlIHNvdW5kIGFzIHdlbGwKCQlpZihTb3VuZCkKCQl7CgkJCXJ0bi5pbnN0YWxsUGx1Z2luKFNvdW5kKTsKCQl9CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xMb2FkZXIgPSBmdW5jdGlvbihsb2FkZXIpCgl7CgkJbG9hZGVyLnJlbW92ZUFsbCgpOy8vY2xlYXIgdGhlIGxvYWRlciBmb3IgcmV1c2UKCQlsb2FkZXJQb29sLnB1c2gobG9hZGVyKTsKCX07CgkKCXAuX2dldFJlc3VsdCA9IGZ1bmN0aW9uKHJlc3VsdCwgdXJsLCBsb2FkZXIpCgl7CgkJdmFyIHJ0bjsKCQlpZihyZXN1bHRQb29sLmxlbmd0aCkKCQl7CgkJCXJ0biA9IHJlc3VsdFBvb2wucG9wKCk7CgkJCXJ0bi5jb250ZW50ID0gcmVzdWx0OwoJCQlydG4udXJsID0gdXJsOwoJCQlydG4ubG9hZGVyID0gbG9hZGVyOwoJCX0KCQllbHNlCgkJCXJ0biA9IG5ldyBMb2FkZXJSZXN1bHQocmVzdWx0LCB1cmwsIGxvYWRlcik7CgkJcmV0dXJuIHJ0bjsKCX07CgkKCXAuX3Bvb2xSZXN1bHQgPSBmdW5jdGlvbihyZXN1bHQpCgl7CgkJcmVzdWx0LmNvbnRlbnQgPSByZXN1bHQudXJsID0gcmVzdWx0LmxvYWRlciA9IHJlc3VsdC5pZCA9IG51bGw7CgkJcmVzdWx0UG9vbC5wdXNoKHJlc3VsdCk7Cgl9OwoJCgkvLyBNZWRpYUxvYWRlciBuYW1lIGlzIGRlcHJlY2F0ZWQKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLk1lZGlhTG9hZGVyID0gTG9hZGVyOwoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuTG9hZGVyID0gTG9hZGVyOwp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbigpewoJCgkvKioKCSogIFRoZSByZXR1cm4gcmVzdWx0IG9mIHRoZSBMb2FkZXIgbG9hZAoJKiAgQGNsYXNzIExvYWRlclJlc3VsdAoJKiAgQGNvbnN0cnVjdG9yCgkqICBAcGFyYW0geyp9IGNvbnRlbnQgVGhlIGR5bmFtaWMgY29udGVudCBsb2FkZWQKCSogIEBwYXJhbSB7c3RyaW5nfSB1cmwgVGhlIHVybCB0aGF0IHdhcyBsb2FkZWQKCSogIEBwYXJhbSB7Y3JlYXRlanMuTG9hZFF1ZXVlfSBsb2FkZXIgVGhlIExvYWRRdWV1ZSB0aGF0IHBlcmZvcm1lZCB0aGUgbG9hZAoJKi8KCXZhciBMb2FkZXJSZXN1bHQgPSBmdW5jdGlvbihjb250ZW50LCB1cmwsIGxvYWRlcikKCXsKCQkvKioKCQkqICBUaGUgY29udGVudHMgb2YgdGhlIGxvYWQKCQkqICBAcHVibGljCgkJKiAgQHByb3BlcnR5IHsqfSBjb250ZW50IAoJCSovCgkJdGhpcy5jb250ZW50ID0gY29udGVudDsKCgkJLyoqCgkJKiAgVGhlIHVybCBvZiB0aGUgbG9hZAoJCSogIEBwdWJsaWMKCQkqICBAcHJvcGVydHkge3N0cmluZ30gdXJsCgkJKi8KCQl0aGlzLnVybCA9IHVybDsKCgkJLyoqCgkJKiAgUmVmZXJlbmNlIHRvIHRoZSBwcmVsb2FkZXIgb2JqZWN0CgkJKiAgQHB1YmxpYwoJCSogIEBwcm9wZXJ0eSB7Y3JlYXRlanMuTG9hZGVyUXVldWV9IGxvYWRlcgoJCSovCgkJdGhpcy5sb2FkZXIgPSBsb2FkZXI7Cgl9OwoJCgkvKiogUmVmZXJlbmNlIHRvIHRoZSBwcm90b3R5cGUgKi8KCXZhciBwID0gTG9hZGVyUmVzdWx0LnByb3RvdHlwZTsKCQoJLyoqCgkqIEEgdG8gc3RyaW5nIG1ldGhvZAoJKiBAcHVibGljCgkqIEBtZXRob2QgdG9TdHJpbmcKCSogQHJldHVybiB7c3RyaW5nfSBBIHN0cmluZyByZXAgb2YgdGhlIG9iamVjdAoJKi8KCXAudG9TdHJpbmcgPSBmdW5jdGlvbigpCgl7CgkJcmV0dXJuICJbTG9hZGVyUmVzdWx0KCciK3RoaXMudXJsKyInKV0iOwoJfTsKCQoJLyoqCgkqIERlc3Ryb3kgdGhpcyByZXN1bHQKCSogQHB1YmxpYwoJKiBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJdGhpcy5jYWxsYmFjayA9IG51bGw7CgkJdGhpcy51cmwgPSBudWxsOwoJCXRoaXMuY29udGVudCA9IG51bGw7Cgl9OwoJCgkvLyBBc3NpZ24gdG8gdGhlIG5hbWUgc3BhY2UKCS8vIE1lZGlhTG9hZGVSZXN1bHQgaXMgZGVwcmVjYXRlZAoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuTWVkaWFMb2FkZXJSZXN1bHQgPSBMb2FkZXJSZXN1bHQ7CgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5Mb2FkZXJSZXN1bHQgPSBMb2FkZXJSZXN1bHQ7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24oKSB7CgkKCS8qKgoJKiAgQSBmdW5jdGlvbiB0aGF0IGlzIHVzZWQgYXMgYSBub3JtYWwgY2FsbGJhY2ssIGJ1dCBjaGVja3MgYW4gb2JqZWN0IGZvciBhIHByb3BlcnR5IGluIG9yZGVyIHRvIGNvbWJpbmUgdHdvCgkqICBjYWxsYmFja3MgaW50byBvbmUuIEZvciBleGFtcGxlIHVzYWdlOgoJKgoJKiAgdmFyIHZvUGxheWVyID0gbmV3IHNwcmluZ3JvbGwuVk9QbGF5ZXIoKTsKCSogIHZhciBjYWxsYmFjayA9IHNwcmluZ3JvbGwuQ29tYmluZWRDYWxsYmFjay5jcmVhdGUobXlGdW5jLmJpbmQodGhpcyksIHZvUGxheWVyLCAicGxheWluZyIsICJfY2FsbGJhY2siKTsKCSogIEFuaW1hdG9yLnBsYXkobXlDbGlwLCAibXlBbmltIiwgY2FsbGJhY2spOwoJKiAgCgkqICBJbiB0aGlzIGV4YW1wbGUsIHdoZW4gQW5pbWF0b3IgY2FsbHMgJ2NhbGxiYWNrJywgaWYgdm9QbGF5ZXJbInBsYXlpbmciXSBpcyBmYWxzZSwgJ215RnVuYycgaXMgY2FsbGVkIGltbWVkaWF0ZWx5LgoJKiAgSWYgdm9QbGF5ZXJbInBsYXlpbmciXSBpcyB0cnVlLCB0aGVuIHZvUGxheWVyWyJfY2FsbGJhY2siXSBpcyBzZXQgdG8gJ215RnVuYycgc28gdGhhdCBpdCB3aWxsIGJlIGNhbGxlZCB3aGVuIHZvUGxheWVyIGNvbXBsZXRlcy4KCSogIAoJKiAgQGNsYXNzIENvbWJpbmVkQ2FsbGJhY2sKCSogIEBjb25zdHJ1Y3RvcgoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbCBUaGUgY2FsbGJhY2sgdG8gY2FsbCB3aGVuIGV2ZXJ5dGhpbmcgaXMgY29tcGxldGUuCgkqICBAcGFyYW0geyp9IG9iaiBUaGUgb2JqZWN0IHRvIGNoZWNrIGFzIGFuIGFkZGl0aW9uYWwgY29tcGxldGlvbiBkZXBlbmRlbmN5LgoJKiAgQHBhcmFtIHtTdHJpbmd9IHByb3AgVGhlIHByb3BlcnR5IHRvIGNoZWNrIG9uIG9iai4gSWYgb2JqW3Byb3BdIGlzIGZhbHNlLCB0aGVuIGl0IGlzIGNvbnNpZGVyZWQgY29tcGxldGUuCgkqICBAcGFyYW0ge1N0cmluZ30gY2FsbFByb3AgVGhlIHByb3BlcnR5IHRvIHNldCBvbiBvYmogaWYgb2JqW3Byb3BdIGlzIHRydWUgd2hlbiB0aGUgQ29tYmluZWRDYWxsYmFjayBpcyBjYWxsZWQuCgkqLwoJdmFyIENvbWJpbmVkQ2FsbGJhY2sgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKQoJewoJCWlmKCFvYmpbcHJvcF0pLy9hY2NlcHQgYW55dGhpbmcgdGhhdCByZXNvbHZlcyB0byBmYWxzZTogZWcgdm9QbGF5ZXIucGxheWluZyA9PSBmYWxzZQoJCQljYWxsKCk7CgkJZWxzZQoJCQlvYmpbY2FsbFByb3BdID0gY2FsbDsKCX07CgoJLyoqCgkqICBDcmVhdGVzIGEgQ29tYmluZWRDYWxsYmFjayBmb3IgdXNlLgoJKiAgCgkqICBAbWV0aG9kIGNyZWF0ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtmdW5jdGlvbn0gY2FsbCBUaGUgY2FsbGJhY2sgdG8gY2FsbCB3aGVuIGV2ZXJ5dGhpbmcgaXMgY29tcGxldGUuCgkqICBAcGFyYW0geyp9IG9iaiBUaGUgb2JqZWN0IHRvIGNoZWNrIGFzIGFuIGFkZGl0aW9uYWwgY29tcGxldGlvbiBkZXBlbmRlbmN5LgoJKiAgQHBhcmFtIHtTdHJpbmd9IHByb3AgVGhlIHByb3BlcnR5IHRvIGNoZWNrIG9uIG9iai4gSWYgb2JqW3Byb3BdIGlzIGZhbHNlLCB0aGVuIGl0IGlzIGNvbnNpZGVyZWQgY29tcGxldGUuCgkqICBAcGFyYW0ge1N0cmluZ30gY2FsbFByb3AgVGhlIHByb3BlcnR5IHRvIHNldCBvbiBvYmogaWYgb2JqW3Byb3BdIGlzIHRydWUgd2hlbiB0aGUgQ29tYmluZWRDYWxsYmFjayBpcyBjYWxsZWQuCgkqLwoJQ29tYmluZWRDYWxsYmFjay5jcmVhdGUgPSBmdW5jdGlvbihjYWxsLCBvYmosIHByb3AsIGNhbGxQcm9wKQoJewoJCXJldHVybiBDb21iaW5lZENhbGxiYWNrLmJpbmQodGhpcywgY2FsbCwgb2JqLCBwcm9wLCBjYWxsUHJvcCk7Cgl9OwoKCW5hbWVzcGFjZSgnc3ByaW5ncm9sbCcpLkNvbWJpbmVkQ2FsbGJhY2sgPSBDb21iaW5lZENhbGxiYWNrOwp9KCkpOwovKioKKiAgQG1vZHVsZSBGcmFtZXdvcmsKKiAgQG5hbWVzcGFjZSBzcHJpbmdyb2xsCiovCihmdW5jdGlvbih1bmRlZmluZWQpewoJCQoJLyoqIAoJKiAgVGhlIFNhdmVkRGF0YSBmdW5jdGlvbnMgdXNlIGxvY2FsU3RvcmFnZSBhbmQgc2Vzc2lvblN0b3JhZ2UsIHdpdGggYSBjb29raWUgZmFsbGJhY2suIAoJKgoJKiAgQGNsYXNzIFNhdmVkRGF0YQoJKi8KCXZhciBTYXZlZERhdGEgPSB7fSwKCQoJLyoqIEEgY29uc3RhbnQgdG8gZGV0ZXJtaW5lIGlmIHdlIGNhbiB1c2UgbG9jYWxTdG9yYWdlIGFuZCBzZXNzaW9uU3RvcmFnZSAqLwoJV0VCX1NUT1JBR0VfU1VQUE9SVCA9IHdpbmRvdy5TdG9yYWdlICE9PSB1bmRlZmluZWQsCgkKCS8qKiBBIGNvbnN0YW50IGZvciBjb29raWUgZmFsbGJhY2sgZm9yIFNhdmVkRGF0YS5jbGVhcigpICovCglFUkFTRV9DT09LSUUgPSAtMTsKCgkvL2luIGlPUywgaWYgdGhlIHVzZXIgaXMgaW4gUHJpdmF0ZSBCcm93c2luZywgd3JpdGluZyB0byBsb2NhbFN0b3JhZ2UgdGhyb3dzIGFuIGVycm9yLgoJaWYoV0VCX1NUT1JBR0VfU1VQUE9SVCkKCXsKCQl0cnkKCQl7CgkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCJMU19URVNUIiwgInRlc3QiKTsKCQkJbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oIkxTX1RFU1QiKTsKCQl9CgkJY2F0Y2goZSkKCQl7CgkJCVdFQl9TVE9SQUdFX1NVUFBPUlQgPSBmYWxzZTsKCQl9Cgl9CgkKCS8qKiAKCSogIFJlbW92ZSBhIHNhdmVkIHZhcmlhYmxlIGJ5IG5hbWUuCgkqICBAbWV0aG9kIHJlbW92ZQoJKiAgQHN0YXRpYwoJKiAgQHBhcmFtIHtTdHJpbmd9IG5hbWUgVGhlIG5hbWUgb2YgdGhlIHZhbHVlIHRvIHJlbW92ZQoJKi8KCVNhdmVkRGF0YS5yZW1vdmUgPSBmdW5jdGlvbihuYW1lKQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQlsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKTsKCQkJc2Vzc2lvblN0b3JhZ2UucmVtb3ZlSXRlbShuYW1lKTsKCQl9CgkJZWxzZQoJCQlTYXZlZERhdGEud3JpdGUobmFtZSwiIixFUkFTRV9DT09LSUUpOwoJfTsKCQoJLyoqCgkqICBTYXZlIGEgdmFyaWFibGUuCgkqICBAbWV0aG9kIHdyaXRlCgkqICBAc3RhdGljCgkqICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdmFsdWUgdG8gc2F2ZQoJKiAgQHBhcmFtIHttaXhlZH0gdmFsdWUgVGhlIHZhbHVlIHRvIHNhdmUuIFRoaXMgd2lsbCBiZSBydW4gdGhyb3VnaCBKU09OLnN0cmluZ2lmeSgpLgoJKiAgQHBhcmFtIHtCb29sZWFufSBbdGVtcE9ubHk9ZmFsc2VdIElmIHRoZSB2YWx1ZSBzaG91bGQgYmUgc2F2ZWQgb25seSBpbiB0aGUgY3VycmVudCBicm93c2VyIHNlc3Npb24uCgkqLwoJU2F2ZWREYXRhLndyaXRlID0gZnVuY3Rpb24obmFtZSwgdmFsdWUsIHRlbXBPbmx5KQoJewoJCWlmKFdFQl9TVE9SQUdFX1NVUFBPUlQpCgkJewoJCQlpZih0ZW1wT25seSkKCQkJCXNlc3Npb25TdG9yYWdlLnNldEl0ZW0obmFtZSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKCQkJZWxzZQoJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0obmFtZSwgSlNPTi5zdHJpbmdpZnkodmFsdWUpKTsKCQl9CgkJZWxzZQoJCXsKCQkJdmFyIGV4cGlyZXM7CgkJCWlmICh0ZW1wT25seSkKCQkJewoJCQkJaWYodGVtcE9ubHkgIT09IEVSQVNFX0NPT0tJRSkKCQkJCQlleHBpcmVzID0gIiI7Ly9yZW1vdmUgd2hlbiBicm93c2VyIGlzIGNsb3NlZAoJCQkJZWxzZQoJCQkJCWV4cGlyZXMgPSAiOyBleHBpcmVzPVRodSwgMDEgSmFuIDE5NzAgMDA6MDA6MDAgR01UIjsvL3NhdmUgY29va2llIGluIHRoZSBwYXN0IGZvciBpbW1lZGlhdGUgcmVtb3ZhbAoJCQl9CgkJCWVsc2UKCQkJCWV4cGlyZXMgPSAiOyBleHBpcmVzPSIrbmV3IERhdGUoMjE0NzQ4MzY0NjAwMCkudG9HTVRTdHJpbmcoKTsvL1RIRSBFTkQgT0YgKDMyYml0IFVOSVgpIFRJTUUhCgkJCQkKCQkJZG9jdW1lbnQuY29va2llID0gbmFtZSsiPSIrZXNjYXBlKEpTT04uc3RyaW5naWZ5KHZhbHVlKSkrZXhwaXJlcysiOyBwYXRoPS8iOwoJCX0KCX07CgkKCS8qKgoJKiAgUmVhZCB0aGUgdmFsdWUgb2YgYSBzYXZlZCB2YXJpYWJsZQoJKiAgQG1ldGhvZCByZWFkCgkqICBAc3RhdGljCgkqICBAcGFyYW0ge1N0cmluZ30gbmFtZSBUaGUgbmFtZSBvZiB0aGUgdmFyaWFibGUKCSogIEByZXR1cm4ge21peGVkfSBUaGUgdmFsdWUgKHJ1biB0aHJvdWdoIGBKU09OLnBhcnNlKClgKSBvciBudWxsIGlmIGl0IGRvZXNuJ3QgZXhpc3QKCSovCglTYXZlZERhdGEucmVhZCA9IGZ1bmN0aW9uKG5hbWUpCgl7CgkJaWYoV0VCX1NUT1JBR0VfU1VQUE9SVCkKCQl7CgkJCXZhciB2YWx1ZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKG5hbWUpIHx8IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0obmFtZSk7CgkJCWlmKHZhbHVlKQoJCQkJcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwoJCQllbHNlCgkJCQlyZXR1cm4gbnVsbDsKCQl9CgkJZWxzZQoJCXsKCQkJdmFyIG5hbWVFUSA9IG5hbWUgKyAiPSIsCgkJCQljYSA9IGRvY3VtZW50LmNvb2tpZS5zcGxpdCgnOycpLAoJCQkJaSA9IDAsIGM7CgkJCQkKCQkJZm9yKGk9MDtpIDwgY2EubGVuZ3RoO2krKykKCQkJewoJCQkJYyA9IGNhW2ldOwoJCQkJd2hpbGUgKGMuY2hhckF0KDApID09ICcgJykgYyA9IGMuc3Vic3RyaW5nKDEsYy5sZW5ndGgpOwoJCQkJaWYgKGMuaW5kZXhPZihuYW1lRVEpID09PSAwKSByZXR1cm4gSlNPTi5wYXJzZSh1bmVzY2FwZShjLnN1YnN0cmluZyhuYW1lRVEubGVuZ3RoLGMubGVuZ3RoKSkpOwoJCQl9CgkJCXJldHVybiBudWxsOwoJCX0KCX07CgkKCS8vIEFzc2lnbiB0byB0aGUgZ2xvYmFsIHNwYWNlCgluYW1lc3BhY2UoJ3NwcmluZ3JvbGwnKS5TYXZlZERhdGEgPSBTYXZlZERhdGE7CgkKfSgpKTsKLyoqCiogIEBtb2R1bGUgRnJhbWV3b3JrCiogIEBuYW1lc3BhY2Ugc3ByaW5ncm9sbAoqLwooZnVuY3Rpb24odW5kZWZpbmVkKSB7CgoJdmFyIEFwcGxpY2F0aW9uID0gaW5jbHVkZSgnc3ByaW5ncm9sbC5BcHBsaWNhdGlvbicpOwoKCS8qKgoJKiAgQSBjbGFzcyBmb3IgZGVsYXlpbmcgYSBjYWxsIHRocm91Z2ggdGhlIEFwcGxpY2F0aW9uLCBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gc2V0SW50ZXJ2YWwoKSBvciBzZXRUaW1lb3V0KCkuCgkqIAoJKiAgQGNsYXNzIERlbGF5ZWRDYWxsCgkqICBAY29uc3RydWN0b3IKCSogIEBwYXJhbSB7ZnVuY3Rpb259IGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBjYWxsIHdoZW4gdGhlIGRlbGF5IGhhcyBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge2ludH0gZGVsYXkgVGhlIHRpbWUgdG8gZGVsYXkgdGhlIGNhbGwsIGluIG1pbGxpc2Vjb25kcy4KCSogIEBwYXJhbSB7Qm9vbGVhbn0gW3JlcGVhdD1mYWxzZV0gSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCBhdXRvbWF0aWNhbGx5IHJlcGVhdCBpdHNlbGYgd2hlbiBjb21wbGV0ZWQuCgkqICBAcGFyYW0ge0Jvb2xlYW59IFthdXRvRGVzdHJveT10cnVlXSBJZiB0aGUgRGVsYXllZENhbGwgc2hvdWxkIGNsZWFuIGl0c2VsZiB1cCB3aGVuIGNvbXBsZXRlZC4KCSovCgl2YXIgRGVsYXllZENhbGwgPSBmdW5jdGlvbihjYWxsYmFjaywgZGVsYXksIHJlcGVhdCwgYXV0b0Rlc3Ryb3kpCgl7CQkKCQkvKioKCQkqICBUaGUgZnVuY3Rpb24gdG8gY2FsbCB3aGVuIHRoZSBkZWxheSBpcyBjb21wbGV0ZWQuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2Z1bmN0aW9ufSBfY2FsbGJhY2sKCQkqLwoJCXRoaXMuX2NhbGxiYWNrID0gY2FsbGJhY2s7CgoJCS8qKgoJCSogIFRoZSBkZWxheSB0aW1lLCBpbiBtaWxsaXNlY29uZHMuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge2ludH0gX2RlbGF5CgkJKi8KCQl0aGlzLl9kZWxheSA9IGRlbGF5OwoKCQkvKioKCQkqICBUaGUgdGltZXIgY291bnRpbmcgZG93biBmcm9tIF9kZWxheSwgaW4gbWlsbGlzZWNvbmRzLgoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtpbnR9IF90aW1lcgoJCSovCgkJdGhpcy5fdGltZXIgPSBkZWxheTsKCgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIHNob3VsZCByZXBlYXQgaXRzZWxmIGF1dG9tYXRpY2FsbHkuCgkJKiAgQHByaXZhdGUKCQkqICBAcHJvcGVydHkge0Jvb2xlYW59IF9yZXBlYXQKCQkqICBAZGVmYXVsdCBmYWxzZQoJCSovCgkJdGhpcy5fcmVwZWF0ID0gISFyZXBlYXQ7CgoJCS8qKgoJCSogIElmIHRoZSBEZWxheWVkQ2FsbCBzaG91bGQgZGVzdHJveSBpdHNlbGYgYWZ0ZXIgY29tcGxldGluZwoJCSogIEBwcml2YXRlCgkJKiAgQHByb3BlcnR5IHtCb29sZWFufSBfYXV0b0Rlc3Ryb3kKCQkqICBAZGVmYXVsdCB0cnVlCgkJKi8KCQl0aGlzLl9hdXRvRGVzdHJveSA9IGF1dG9EZXN0cm95ID09PSB1bmRlZmluZWQgPyB0cnVlIDogISFhdXRvRGVzdHJveTsKCgkJLyoqCgkJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIGlzIGN1cnJlbnRseSBwYXVzZWQgKG5vdCBzdG9wcGVkKS4KCQkqICBAcHJpdmF0ZQoJCSogIEBwcm9wZXJ0eSB7Qm9vbGVhbn0gX3BhdXNlZAoJCSovCgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7CgoJCS8vc2F2ZSBhIGJvdW5kIHZlcnNpb24gb2YgdGhlIHVwZGF0ZSBmdW5jdGlvbgoJCXRoaXMuX3VwZGF0ZSA9IHRoaXMuX3VwZGF0ZS5iaW5kKHRoaXMpOwoKCQkvL3N0YXJ0IHRoZSBkZWxheQoJCUFwcGxpY2F0aW9uLmluc3RhbmNlLm9uKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpOwoJfTsKCgl2YXIgcCA9IERlbGF5ZWRDYWxsLnByb3RvdHlwZTsKCgkvKioKCSogIFRoZSBjYWxsYmFjayBzdXBwbGllZCB0byB0aGUgQXBwbGljYXRpb24gZm9yIGFuIHVwZGF0ZSBlYWNoIGZyYW1lLgoJKiAgQHByaXZhdGUKCSogIEBtZXRob2QgX3VwZGF0ZQoJKiAgQHBhcmFtIHtpbnR9IGVsYXBzZWQgVGhlIHRpbWUgZWxhcHNlZCBzaW5jZSB0aGUgcHJldmlvdXMgZnJhbWUuCgkqLwoJcC5fdXBkYXRlID0gZnVuY3Rpb24oZWxhcHNlZCkKCXsKCQlpZighdGhpcy5fY2FsbGJhY2spCgkJewoJCQl0aGlzLmRlc3Ryb3koKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fdGltZXIgLT0gZWxhcHNlZDsKCQlpZih0aGlzLl90aW1lciA8PSAwKQoJCXsKCQkJdGhpcy5fY2FsbGJhY2soKTsKCQkJaWYodGhpcy5fcmVwZWF0KQoJCQkJdGhpcy5fdGltZXIgKz0gdGhpcy5fZGVsYXk7CgkJCWVsc2UgaWYodGhpcy5fYXV0b0Rlc3Ryb3kpCgkJCQl0aGlzLmRlc3Ryb3koKTsKCQkJZWxzZQoJCQkJQXBwbGljYXRpb24uaW5zdGFuY2Uub2ZmKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpOwoJCX0KCX07CgoJLyoqCgkqICBSZXN0YXJ0cyB0aGUgRGVsYXllZENhbGwsIHdoZXRoZXIgaXQgaXMgcnVubmluZyBvciBub3QuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIHJlc3RhcnQKCSovCglwLnJlc3RhcnQgPSBmdW5jdGlvbigpCgl7CgkJaWYoIXRoaXMuX2NhbGxiYWNrKSByZXR1cm47CgkJdmFyIGFwcCA9IEFwcGxpY2F0aW9uLmluc3RhbmNlOwoJCWlmKCFhcHAuaGFzKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpKQoJCQlhcHAub24oInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJdGhpcy5fdGltZXIgPSB0aGlzLl9kZWxheTsKCQl0aGlzLl9wYXVzZWQgPSBmYWxzZTsKCX07CgoJLyoqCgkqICBTdG9wcyB0aGUgRGVsYXllZENhbGwsIHdpdGhvdXQgZGVzdHJveWluZyBpdC4KCSogIEBwdWJsaWMKCSogIEBtZXRob2Qgc3RvcAoJKi8KCXAuc3RvcCA9IGZ1bmN0aW9uKCkKCXsKCQlBcHBsaWNhdGlvbi5pbnN0YW5jZS5vZmYoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSk7CgkJdGhpcy5fcGF1c2VkID0gZmFsc2U7Cgl9OwoKCS8qKgoJKiAgSWYgdGhlIERlbGF5ZWRDYWxsIGlzIHBhdXNlZCBvciBub3QuCgkqICBAcHVibGljCgkqICBAcHJvcGVydHkge0Jvb2xlYW59IHBhdXNlZAoJKi8KCU9iamVjdC5kZWZpbmVQcm9wZXJ0eShwLCAicGF1c2VkIiwgewoJCWdldDogZnVuY3Rpb24oKSB7IHJldHVybiB0aGlzLl9wYXVzZWQ7IH0sCgkJc2V0OiBmdW5jdGlvbih2YWx1ZSkKCQl7CgkJCWlmKCF0aGlzLl9jYWxsYmFjaykgcmV0dXJuOwoJCQl2YXIgYXBwID0gQXBwbGljYXRpb24uaW5zdGFuY2U7CgkJCWlmKHRoaXMuX3BhdXNlZCAmJiAhdmFsdWUpCgkJCXsKCQkJCXRoaXMuX3BhdXNlZCA9IGZhbHNlOwoJCQkJaWYoIWFwcC5oYXMoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSkpCgkJCQkJYXBwLm9uKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpOwoJCQl9CgkJCWVsc2UgaWYodmFsdWUpCgkJCXsKCQkJCWlmKGFwcC5oYXMoInVwZGF0ZSIsIHRoaXMuX3VwZGF0ZSkpCgkJCQl7CgkJCQkJdGhpcy5fcGF1c2VkID0gdHJ1ZTsKCQkJCQlhcHAub2ZmKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJLyoqCgkqICBTdG9wcyBhbmQgY2xlYW5zIHVwIHRoZSBEZWxheWVkQ2FsbC4gRG8gbm90IHVzZSBpdCBhZnRlciBjYWxsaW5nCgkqICBkZXN0cm95KCkuCgkqICBAcHVibGljCgkqICBAbWV0aG9kIGRlc3Ryb3kKCSovCglwLmRlc3Ryb3kgPSBmdW5jdGlvbigpCgl7CgkJQXBwbGljYXRpb24uaW5zdGFuY2Uub2ZmKCJ1cGRhdGUiLCB0aGlzLl91cGRhdGUpOwoJCXRoaXMuX2NhbGxiYWNrID0gbnVsbDsKCX07CgoJbmFtZXNwYWNlKCdzcHJpbmdyb2xsJykuRGVsYXllZENhbGwgPSBEZWxheWVkQ2FsbDsKfSgpKTt9KCk7",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 15:39:16 GMT",
                    "Content-Length": "84663",
                    "Date": "Thu, 06 Nov 2014 15:39:20 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}