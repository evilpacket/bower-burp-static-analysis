{
    "url": "http://localhost:9999/kogmbh/WebODF/programs/viewer/viewer.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "DOM data manipulation (DOM-based)",
    "issueType": 5247488,
    "severity": "Information",
    "confidence": "Firm",
    "issueBackground": "DOM-based DOM data manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a data field within the DOM that is used within the visible UI or client-side application logic. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the appearance or behavior of the client-side UI. An attacker may be able to leverage this to perform virtual defacement of the application, or possibly to induce the user to perform unintended actions.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based DOM data manipulation vulnerabilities is not to dynamically write to DOM data fields any data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from being stored. In general, this is best achieved by using a whitelist of permitted values.",
    "issueDetail": "The application may be vulnerable to DOM-based DOM data manipulation. Data is read from <b>location</b> and written to <b>document.title</b> via the following statements:<ul><li>url = location;</li><li>filename = url.replace(/^.*[\\\\\\/]/, '');</li><li>document.title = filename;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/kogmbh/WebODF/programs/viewer/viewer.js",
                "path": "/kogmbh/WebODF/programs/viewer/viewer.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9rb2dtYmgvV2ViT0RGL3Byb2dyYW1zL3ZpZXdlci92aWV3ZXIuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMjM2NDkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IFN1biwgMDkgTm92IDIwMTQgMDI6Mzk6NTYgR01UDQpMYXN0LU1vZGlmaWVkOiBTdW4sIDA5IE5vdiAyMDE0IDAyOjM5OjU1IEdNVA0KDQovKioKICogQ29weXJpZ2h0IChDKSAyMDEyLTIwMTQgS08gR21iSCA8Y29weXJpZ2h0QGtvZ21iaC5jb20+CiAqCiAqIEBsaWNzdGFydAogKiBUaGlzIGZpbGUgaXMgcGFydCBvZiBXZWJPREYuCiAqCiAqIFdlYk9ERiBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5IGl0CiAqIHVuZGVyIHRoZSB0ZXJtcyBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlIChHTlUgQUdQTCkKICogYXMgcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YKICogdGhlIExpY2Vuc2UsIG9yIChhdCB5b3VyIG9wdGlvbikgYW55IGxhdGVyIHZlcnNpb24uCiAqCiAqIFdlYk9ERiBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLCBidXQKICogV0lUSE9VVCBBTlkgV0FSUkFOVFk7IHdpdGhvdXQgZXZlbiB0aGUgaW1wbGllZCB3YXJyYW50eSBvZgogKiBNRVJDSEFOVEFCSUxJVFkgb3IgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UuICBTZWUgdGhlCiAqIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLgogKgogKiBZb3Ugc2hvdWxkIGhhdmUgcmVjZWl2ZWQgYSBjb3B5IG9mIHRoZSBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UKICogYWxvbmcgd2l0aCBXZWJPREYuICBJZiBub3QsIHNlZSA8aHR0cDovL3d3dy5nbnUub3JnL2xpY2Vuc2VzLz4uCiAqIEBsaWNlbmQKICoKICogQHNvdXJjZTogaHR0cDovL3d3dy53ZWJvZGYub3JnLwogKiBAc291cmNlOiBodHRwczovL2dpdGh1Yi5jb20va29nbWJoL1dlYk9ERi8KICovCgovKgogKiBUaGlzIGZpbGUgaXMgYSBkZXJpdmF0aXZlIGZyb20gYSBwYXJ0IG9mIE1vemlsbGEncyBQREYuanMgcHJvamVjdC4gVGhlCiAqIG9yaWdpbmFsIGxpY2Vuc2UgaGVhZGVyIGZvbGxvd3MuCiAqLwoKLyogQ29weXJpZ2h0IDIwMTIgTW96aWxsYSBGb3VuZGF0aW9uCiAqCiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSAiTGljZW5zZSIpOwogKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdAogKgogKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjAKICoKICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZQogKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAiQVMgSVMiIEJBU0lTLAogKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC4KICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZAogKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS4KICovCgovKmdsb2JhbCBkb2N1bWVudCwgd2luZG93Ki8KCmZ1bmN0aW9uIFZpZXdlcih2aWV3ZXJQbHVnaW4pIHsKICAgICJ1c2Ugc3RyaWN0IjsKCiAgICB2YXIgc2VsZiA9IHRoaXMsCiAgICAgICAga1Njcm9sbGJhclBhZGRpbmcgPSA0MCwKICAgICAgICBrTWluU2NhbGUgPSAwLjI1LAogICAgICAgIGtNYXhTY2FsZSA9IDQuMCwKICAgICAgICBrRGVmYXVsdFNjYWxlRGVsdGEgPSAxLjEsCiAgICAgICAga0RlZmF1bHRTY2FsZSA9ICdhdXRvJywKICAgICAgICBwcmVzZW50YXRpb25Nb2RlID0gZmFsc2UsCiAgICAgICAgaXNGdWxsU2NyZWVuID0gZmFsc2UsCiAgICAgICAgaW5pdGlhbGl6ZWQgPSBmYWxzZSwKICAgICAgICBpc1NsaWRlc2hvdyA9IGZhbHNlLAogICAgICAgIHVybCwKICAgICAgICB2aWV3ZXJFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZpZXdlcicpLAogICAgICAgIGNhbnZhc0NvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYW52YXNDb250YWluZXInKSwKICAgICAgICBvdmVybGF5TmF2aWdhdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ292ZXJsYXlOYXZpZ2F0b3InKSwKICAgICAgICB0aXRsZWJhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0aXRsZWJhcicpLAogICAgICAgIHRvb2xiYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9vbGJhckNvbnRhaW5lcicpLAogICAgICAgIHBhZ2VTd2l0Y2hlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b29sYmFyTGVmdCcpLAogICAgICAgIHpvb21XaWRnZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9vbGJhck1pZGRsZUNvbnRhaW5lcicpLAogICAgICAgIHNjYWxlU2VsZWN0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NhbGVTZWxlY3QnKSwKICAgICAgICBkaWFsb2dPdmVybGF5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpYWxvZ092ZXJsYXknKSwKICAgICAgICB0b29sYmFyUmlnaHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9vbGJhclJpZ2h0JyksCiAgICAgICAgYWJvdXREaWFsb2csCiAgICAgICAgZmlsZW5hbWUsCiAgICAgICAgcGFnZXMgPSBbXSwKICAgICAgICBjdXJyZW50UGFnZSwKICAgICAgICBzY2FsZUNoYW5nZVRpbWVyLAogICAgICAgIHRvdWNoVGltZXIsCiAgICAgICAgdG9vbGJhclRvdWNoVGltZXIsCiAgICAgICAgLyoqQGNvbnN0Ki8KICAgICAgICBVSV9GQURFX0RVUkFUSU9OID0gNTAwMDsKCiAgICBmdW5jdGlvbiBpc0JsYW5rZWRPdXQoKSB7CiAgICAgICAgcmV0dXJuIChibGFua2VkLnN0eWxlLmRpc3BsYXkgPT09ICdibG9jaycpOwogICAgfQoKICAgIGZ1bmN0aW9uIGluaXRpYWxpemVBYm91dEluZm9ybWF0aW9uKCkgewogICAgICAgIHZhciBhYm91dERpYWxvZ0NlbnRlcmVyVGFibGUsIGFib3V0RGlhbG9nQ2VudGVyZXJDZWxsLCBhYm91dEJ1dHRvbiwgcGx1Z2luTmFtZSwgcGx1Z2luVmVyc2lvbiwgcGx1Z2luVVJMOwoKICAgICAgICBpZiAodmlld2VyUGx1Z2luKSB7CiAgICAgICAgICAgIHBsdWdpbk5hbWUgPSB2aWV3ZXJQbHVnaW4uZ2V0UGx1Z2luTmFtZSgpOwogICAgICAgICAgICBwbHVnaW5WZXJzaW9uID0gdmlld2VyUGx1Z2luLmdldFBsdWdpblZlcnNpb24oKTsKICAgICAgICAgICAgcGx1Z2luVVJMID0gdmlld2VyUGx1Z2luLmdldFBsdWdpblVSTCgpOwogICAgICAgIH0KCiAgICAgICAgLy8gQ3JlYXRlIGRpYWxvZwogICAgICAgIGFib3V0RGlhbG9nQ2VudGVyZXJUYWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGFib3V0RGlhbG9nQ2VudGVyZXJUYWJsZS5pZCA9ICJhYm91dERpYWxvZ0NlbnRlcmVyVGFibGUiOwogICAgICAgIGFib3V0RGlhbG9nQ2VudGVyZXJDZWxsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgYWJvdXREaWFsb2dDZW50ZXJlckNlbGwuaWQgPSAiYWJvdXREaWFsb2dDZW50ZXJlckNlbGwiOwogICAgICAgIGFib3V0RGlhbG9nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgYWJvdXREaWFsb2cuaWQgPSAiYWJvdXREaWFsb2ciOwogICAgICAgIGFib3V0RGlhbG9nLmlubmVySFRNTCA9CiAgICAgICAgICAgICI8aDE+Vmlld2VySlM8L2gxPiIgKwogICAgICAgICAgICAiPHA+T3BlbiBTb3VyY2UgZG9jdW1lbnQgdmlld2VyIGZvciB3ZWJwYWdlcywgYnVpbHQgd2l0aCBIVE1MIGFuZCBKYXZhU2NyaXB0LjwvcD4iICsKICAgICAgICAgICAgIjxwPkxlYXJuIG1vcmUgYW5kIGdldCB5b3VyIG93biBjb3B5IG9uIHRoZSA8YSBocmVmPVwiaHR0cDovL3ZpZXdlcmpzLm9yZy9cIiB0YXJnZXQ9XCJfYmxhbmtcIj5WaWV3ZXJKUyB3ZWJzaXRlPC9hPi48L3A+IiArCiAgICAgICAgICAgICh2aWV3ZXJQbHVnaW4gPyAoIjxwPlVzaW5nIHRoZSA8YSBocmVmID0gXCIiKyBwbHVnaW5VUkwgKyAiXCIgdGFyZ2V0PVwiX2JsYW5rXCI+IiArIHBsdWdpbk5hbWUgKyAiPC9hPiAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICIoPHNwYW4gaWQgPSBcInBsdWdpblZlcnNpb25cIj4iICsgcGx1Z2luVmVyc2lvbiArICI8L3NwYW4+KSAiICsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJwbHVnaW4gdG8gc2hvdyB5b3UgdGhpcyBkb2N1bWVudC48L3A+IikKICAgICAgICAgICAgICAgICAgICAgICAgIDogIiIpICsKICAgICAgICAgICAgIjxwPlN1cHBvcnRlZCBieSA8YSBocmVmPVwiaHR0cDovL25sbmV0Lm5sXCIgdGFyZ2V0PVwiX2JsYW5rXCI+PGJyPjxpbWcgc3JjPVwiaW1hZ2VzXC9ubG5ldC5wbmdcIiB3aWR0aD1cIjE2MFwiIGhlaWdodD1cIjYwXCIgYWx0PVwiTkxuZXQgRm91bmRhdGlvblwiPjwvYT48L3A+IiArCiAgICAgICAgICAgICI8cD5NYWRlIGJ5IDxhIGhyZWY9XCJodHRwOi8va29nbWJoLmNvbVwiIHRhcmdldD1cIl9ibGFua1wiPjxicj48aW1nIHNyYz1cImltYWdlc1wva29nbWJoLnBuZ1wiIHdpZHRoPVwiMTcyXCIgaGVpZ2h0PVwiNDBcIiBhbHQ9XCJLTyBHbWJIXCI+PC9hPjwvcD4iICsKICAgICAgICAgICAgIjxidXR0b24gaWQgPSBcImFib3V0RGlhbG9nQ2xvc2VCdXR0b25cIiBjbGFzcyA9IFwidG9vbGJhckJ1dHRvbiB0ZXh0QnV0dG9uXCI+Q2xvc2U8L2J1dHRvbj4iOwogICAgICAgIGRpYWxvZ092ZXJsYXkuYXBwZW5kQ2hpbGQoYWJvdXREaWFsb2dDZW50ZXJlclRhYmxlKTsKICAgICAgICBhYm91dERpYWxvZ0NlbnRlcmVyVGFibGUuYXBwZW5kQ2hpbGQoYWJvdXREaWFsb2dDZW50ZXJlckNlbGwpOwogICAgICAgIGFib3V0RGlhbG9nQ2VudGVyZXJDZWxsLmFwcGVuZENoaWxkKGFib3V0RGlhbG9nKTsKCiAgICAgICAgLy8gQ3JlYXRlIGJ1dHRvbiB0byBvcGVuIGRpYWxvZyB0aGF0IHNheXMgIlZpZXdlckpTIgogICAgICAgIGFib3V0QnV0dG9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYnV0dG9uJyk7CiAgICAgICAgYWJvdXRCdXR0b24uaWQgPSAiYWJvdXQiOwogICAgICAgIGFib3V0QnV0dG9uLmNsYXNzTmFtZSA9ICJ0b29sYmFyQnV0dG9uIHRleHRCdXR0b24gYWJvdXQiOwogICAgICAgIGFib3V0QnV0dG9uLnRpdGxlID0gIkFib3V0IjsKICAgICAgICBhYm91dEJ1dHRvbi5pbm5lckhUTUwgPSAiVmlld2VySlMiCiAgICAgICAgdG9vbGJhclJpZ2h0LmFwcGVuZENoaWxkKGFib3V0QnV0dG9uKTsKCiAgICAgICAgLy8gQXR0YWNoIGV2ZW50cyB0byB0aGUgYWJvdmUKICAgICAgICBhYm91dEJ1dHRvbi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNob3dBYm91dERpYWxvZygpOwogICAgICAgIH0pOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhYm91dERpYWxvZ0Nsb3NlQnV0dG9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBoaWRlQWJvdXREaWFsb2coKTsKICAgICAgICB9KTsKCiAgICB9CgogICAgZnVuY3Rpb24gc2hvd0Fib3V0RGlhbG9nKCkgewogICAgICAgIGRpYWxvZ092ZXJsYXkuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICB9CgogICAgZnVuY3Rpb24gaGlkZUFib3V0RGlhbG9nKCkgewogICAgICAgIGRpYWxvZ092ZXJsYXkuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKICAgIH0KCiAgICBmdW5jdGlvbiBzZWxlY3RTY2FsZU9wdGlvbih2YWx1ZSkgewogICAgICAgIC8vIFJldHJpZXZlIHRoZSBvcHRpb25zIGZyb20gdGhlIHpvb20gbGV2ZWwgPHNlbGVjdD4gZWxlbWVudAogICAgICAgIHZhciBvcHRpb25zID0gc2NhbGVTZWxlY3Rvci5vcHRpb25zLAogICAgICAgICAgICBvcHRpb24sCiAgICAgICAgICAgIHByZWRlZmluZWRWYWx1ZUZvdW5kID0gZmFsc2UsCiAgICAgICAgICAgIGk7CgogICAgICAgIGZvciAoaSA9IDA7IGkgPCBvcHRpb25zLmxlbmd0aDsgaSArPSAxKSB7CiAgICAgICAgICAgIG9wdGlvbiA9IG9wdGlvbnNbaV07CiAgICAgICAgICAgIGlmIChvcHRpb24udmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgIHByZWRlZmluZWRWYWx1ZUZvdW5kID0gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHByZWRlZmluZWRWYWx1ZUZvdW5kOwogICAgfQoKICAgIGZ1bmN0aW9uIGdldFBhZ2VzKCkgewogICAgICAgIHJldHVybiB2aWV3ZXJQbHVnaW4uZ2V0UGFnZXMoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRTY2FsZSh2YWwsIHJlc2V0QXV0b1NldHRpbmdzLCBub1Njcm9sbCkgewogICAgICAgIGlmICh2YWwgPT09IHNlbGYuZ2V0Wm9vbUxldmVsKCkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgc2VsZi5zZXRab29tTGV2ZWwodmFsKTsKCiAgICAgICAgdmFyIGV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoJ1VJRXZlbnRzJyk7CiAgICAgICAgZXZlbnQuaW5pdFVJRXZlbnQoJ3NjYWxlY2hhbmdlJywgZmFsc2UsIGZhbHNlLCB3aW5kb3csIDApOwogICAgICAgIGV2ZW50LnNjYWxlID0gdmFsOwogICAgICAgIGV2ZW50LnJlc2V0QXV0b1NldHRpbmdzID0gcmVzZXRBdXRvU2V0dGluZ3M7CiAgICAgICAgd2luZG93LmRpc3BhdGNoRXZlbnQoZXZlbnQpOwogICAgfQoKICAgIGZ1bmN0aW9uIG9uU2Nyb2xsKCkgewogICAgICAgIHZhciBwYWdlTnVtYmVyOwoKICAgICAgICBpZiAodmlld2VyUGx1Z2luLm9uU2Nyb2xsKSB7CiAgICAgICAgICAgIHZpZXdlclBsdWdpbi5vblNjcm9sbCgpOwogICAgICAgIH0KICAgICAgICBpZiAodmlld2VyUGx1Z2luLmdldFBhZ2VJblZpZXcpIHsKICAgICAgICAgICAgcGFnZU51bWJlciA9IHZpZXdlclBsdWdpbi5nZXRQYWdlSW5WaWV3KCk7CiAgICAgICAgICAgIGlmIChwYWdlTnVtYmVyKSB7CiAgICAgICAgICAgICAgICBjdXJyZW50UGFnZSA9IHBhZ2VOdW1iZXI7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFnZU51bWJlcicpLnZhbHVlID0gcGFnZU51bWJlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBkZWxheWVkUmVmcmVzaChtaWxsaXNlY29uZHMpIHsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHNjYWxlQ2hhbmdlVGltZXIpOwogICAgICAgIHNjYWxlQ2hhbmdlVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIG9uU2Nyb2xsKCk7CiAgICAgICAgfSwgbWlsbGlzZWNvbmRzKTsKICAgIH0KCiAgICBmdW5jdGlvbiBwYXJzZVNjYWxlKHZhbHVlLCByZXNldEF1dG9TZXR0aW5ncywgbm9TY3JvbGwpIHsKICAgICAgICB2YXIgc2NhbGUsCiAgICAgICAgICAgIG1heFdpZHRoLAogICAgICAgICAgICBtYXhIZWlnaHQ7CgogICAgICAgIGlmICh2YWx1ZSA9PT0gJ2N1c3RvbScpIHsKICAgICAgICAgICAgc2NhbGUgPSBwYXJzZUZsb2F0KGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXN0b21TY2FsZU9wdGlvbicpLnRleHRDb250ZW50KSAvIDEwMDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzY2FsZSA9IHBhcnNlRmxvYXQodmFsdWUpOwogICAgICAgIH0KCiAgICAgICAgaWYgKHNjYWxlKSB7CiAgICAgICAgICAgIHNldFNjYWxlKHNjYWxlLCB0cnVlLCBub1Njcm9sbCk7CiAgICAgICAgICAgIGRlbGF5ZWRSZWZyZXNoKDMwMCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIG1heFdpZHRoID0gY2FudmFzQ29udGFpbmVyLmNsaWVudFdpZHRoIC0ga1Njcm9sbGJhclBhZGRpbmc7CiAgICAgICAgbWF4SGVpZ2h0ID0gY2FudmFzQ29udGFpbmVyLmNsaWVudEhlaWdodCAtIGtTY3JvbGxiYXJQYWRkaW5nOwoKICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7CiAgICAgICAgY2FzZSAncGFnZS1hY3R1YWwnOgogICAgICAgICAgICBzZXRTY2FsZSgxLCByZXNldEF1dG9TZXR0aW5ncywgbm9TY3JvbGwpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwYWdlLXdpZHRoJzoKICAgICAgICAgICAgdmlld2VyUGx1Z2luLmZpdFRvV2lkdGgobWF4V2lkdGgpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwYWdlLWhlaWdodCc6CiAgICAgICAgICAgIHZpZXdlclBsdWdpbi5maXRUb0hlaWdodChtYXhIZWlnaHQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdwYWdlLWZpdCc6CiAgICAgICAgICAgIHZpZXdlclBsdWdpbi5maXRUb1BhZ2UobWF4V2lkdGgsIG1heEhlaWdodCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgJ2F1dG8nOgogICAgICAgICAgICBpZiAodmlld2VyUGx1Z2luLmlzU2xpZGVzaG93KCkpIHsKICAgICAgICAgICAgICAgIHZpZXdlclBsdWdpbi5maXRUb1BhZ2UobWF4V2lkdGggKyBrU2Nyb2xsYmFyUGFkZGluZywgbWF4SGVpZ2h0ICsga1Njcm9sbGJhclBhZGRpbmcpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmlld2VyUGx1Z2luLmZpdFNtYXJ0KG1heFdpZHRoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICB9CgogICAgICAgIHNlbGVjdFNjYWxlT3B0aW9uKHZhbHVlKTsKICAgICAgICBkZWxheWVkUmVmcmVzaCgzMDApOwogICAgfQoKICAgIAogICAgdGhpcy5pbml0aWFsaXplID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBsb2NhdGlvbiA9IFN0cmluZyhkb2N1bWVudC5sb2NhdGlvbiksCiAgICAgICAgICAgIHBvcyA9IGxvY2F0aW9uLmluZGV4T2YoJyMnKSwKICAgICAgICAgICAgZWxlbWVudDsKCiAgICAgICAgbG9jYXRpb24gPSBsb2NhdGlvbi5zdWJzdHIocG9zICsgMSk7CiAgICAgICAgaWYgKHBvcyA9PT0gLTEgfHwgbG9jYXRpb24ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDb3VsZCBub3QgcGFyc2UgZmlsZSBwYXRoIGFyZ3VtZW50LicpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICB1cmwgPSBsb2NhdGlvbjsKICAgICAgICBmaWxlbmFtZSA9IHVybC5yZXBsYWNlKC9eLipbXFxcL10vLCAnJyk7CiAgICAgICAgZG9jdW1lbnQudGl0bGUgPSBmaWxlbmFtZTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jdW1lbnROYW1lJykuaW5uZXJIVE1MID0gZG9jdW1lbnQudGl0bGU7CgogICAgICAgIHZpZXdlclBsdWdpbi5vbkxvYWQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwbHVnaW5WZXJzaW9uJykuaW5uZXJIVE1MID0gdmlld2VyUGx1Z2luLmdldFBsdWdpblZlcnNpb24oKTsKCiAgICAgICAgICAgIGlzU2xpZGVzaG93ID0gdmlld2VyUGx1Z2luLmlzU2xpZGVzaG93KCk7CiAgICAgICAgICAgIGlmIChpc1NsaWRlc2hvdykgewogICAgICAgICAgICAgICAgLy8gU2xpZGVzaG93IHBhZ2VzIHNob3VsZCBiZSBjZW50ZXJlZAogICAgICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoInNsaWRlc2hvdyIpOwogICAgICAgICAgICAgICAgLy8gU2hvdyBwYWdlIG5hdiBjb250cm9scyBvbmx5IGZvciBwcmVzZW50YXRpb25zCiAgICAgICAgICAgICAgICBwYWdlU3dpdGNoZXIuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIEZvciB0ZXh0IGRvY3VtZW50cywgc2hvdyB0aGUgem9vbSB3aWRnZXQuCiAgICAgICAgICAgICAgICB6b29tV2lkZ2V0LnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgICAgICAvLyBPbmx5IHNob3cgdGhlIHBhZ2Ugc3dpdGNoZXIgd2lkZ2V0IGlmIHRoZSBwbHVnaW4gc3VwcG9ydHMgcGFnZSBudW1iZXJzCiAgICAgICAgICAgICAgICBpZiAodmlld2VyUGx1Z2luLmdldFBhZ2VJblZpZXcpIHsKICAgICAgICAgICAgICAgICAgICBwYWdlU3dpdGNoZXIuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgaW5pdGlhbGl6ZWQgPSB0cnVlOwogICAgICAgICAgICBwYWdlcyA9IGdldFBhZ2VzKCk7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdudW1QYWdlcycpLmlubmVySFRNTCA9ICdvZiAnICsgcGFnZXMubGVuZ3RoOwoKICAgICAgICAgICAgc2VsZi5zaG93UGFnZSgxKTsKCiAgICAgICAgICAgIC8vIFNldCBkZWZhdWx0IHNjYWxlCiAgICAgICAgICAgIHBhcnNlU2NhbGUoa0RlZmF1bHRTY2FsZSk7CgogICAgICAgICAgICBjYW52YXNDb250YWluZXIub25zY3JvbGwgPSBvblNjcm9sbDsKICAgICAgICAgICAgZGVsYXllZFJlZnJlc2goKTsKICAgICAgICB9OwoKICAgICAgICB2aWV3ZXJQbHVnaW4uaW5pdGlhbGl6ZShjYW52YXNDb250YWluZXIsIGxvY2F0aW9uKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTaG93cyB0aGUgJ24ndGggcGFnZS4gSWYgbiBpcyBsYXJnZXIgdGhhbiB0aGUgcGFnZSBjb3VudCwKICAgICAqIHNob3dzIHRoZSBsYXN0IHBhZ2UuIElmIG4gaXMgbGVzcyB0aGFuIDEsIHNob3dzIHRoZSBmaXJzdCBwYWdlLgogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnNob3dQYWdlID0gZnVuY3Rpb24gKG4pIHsKICAgICAgICBpZiAobiA8PSAwKSB7CiAgICAgICAgICAgIG4gPSAxOwogICAgICAgIH0gZWxzZSBpZiAobiA+IHBhZ2VzLmxlbmd0aCkgewogICAgICAgICAgICBuID0gcGFnZXMubGVuZ3RoOwogICAgICAgIH0KCiAgICAgICAgdmlld2VyUGx1Z2luLnNob3dQYWdlKG4pOwoKICAgICAgICBjdXJyZW50UGFnZSA9IG47CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhZ2VOdW1iZXInKS52YWx1ZSA9IGN1cnJlbnRQYWdlOwogICAgfTsKCiAgICAvKioKICAgICAqIFNob3dzIHRoZSBuZXh0IHBhZ2UuIElmIHRoZXJlIGlzIG5vIHN1YnNlcXVlbnQgcGFnZSwgZG9lcyBub3RoaW5nLgogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnNob3dOZXh0UGFnZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLnNob3dQYWdlKGN1cnJlbnRQYWdlICsgMSk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2hvd3MgdGhlIHByZXZpb3VzIHBhZ2UuIElmIHRoZXJlIGlzIG5vIHByZXZpb3VzIHBhZ2UsIGRvZXMgbm90aGluZy4KICAgICAqIEByZXR1cm4ge3VuZGVmaW5lZH0KICAgICAqLwogICAgdGhpcy5zaG93UHJldmlvdXNQYWdlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHNlbGYuc2hvd1BhZ2UoY3VycmVudFBhZ2UgLSAxKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBBdHRlbXB0cyB0byAnZG93bmxvYWQnIHRoZSBmaWxlLgogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLmRvd25sb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgIHZhciBkb2N1bWVudFVybCA9IHVybC5zcGxpdCgnIycpWzBdOwogICAgICAgIGRvY3VtZW50VXJsICs9ICcjdmlld2VyLmFjdGlvbj1kb3dubG9hZCc7CiAgICAgICAgd2luZG93Lm9wZW4oZG9jdW1lbnRVcmwsICdfcGFyZW50Jyk7CiAgICB9OwoKICAgIC8qKgogICAgICogVG9nZ2xlcyB0aGUgZnVsbHNjcmVlbiBzdGF0ZSBvZiB0aGUgdmlld2VyCiAgICAgKiBAcmV0dXJuIHt1bmRlZmluZWR9CiAgICAgKi8KICAgIHRoaXMudG9nZ2xlRnVsbFNjcmVlbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZWxlbSA9IHZpZXdlckVsZW1lbnQ7CiAgICAgICAgaWYgKCFpc0Z1bGxTY3JlZW4pIHsKICAgICAgICAgICAgaWYgKGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgICAgIGVsZW0ucmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLm1velJlcXVlc3RGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBlbGVtLm1velJlcXVlc3RGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgZWxlbS53ZWJraXRSZXF1ZXN0RnVsbHNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxTY3JlZW4oRWxlbWVudC5BTExPV19LRVlCT0FSRF9JTlBVVCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgICBlbGVtLm1zUmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChkb2N1bWVudC5leGl0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5jYW5jZWxGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5jYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LndlYmtpdEV4aXRGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC5tc0V4aXRGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5tc0V4aXRGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogCiAgICAvKioKICAgICAqIFRvZ2dsZXMgdGhlIHByZXNlbnRhdGlvbiBtb2RlIG9mIHRoZSB2aWV3ZXIuCiAgICAgKiBQcmVzZW50YXRpb24gbW9kZSBpbnZvbHZlcyBmdWxsc2NyZWVuICsgaGlkZGVuIFVJIGNvbnRyb2xzCiAgICAgKi8KICAgIHRoaXMudG9nZ2xlUHJlc2VudGF0aW9uTW9kZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgb3ZlcmxheUNsb3NlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ292ZXJsYXlDbG9zZUJ1dHRvbicpOwoKICAgICAgICBpZiAoIXByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICAgICAgdGl0bGViYXIuc3R5bGUuZGlzcGxheSA9IHRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgICAgICAgICAgb3ZlcmxheUNsb3NlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgICAgICBjYW52YXNDb250YWluZXIuY2xhc3NMaXN0LmFkZCgncHJlc2VudGF0aW9uTW9kZScpOwogICAgICAgICAgICBpc1NsaWRlc2hvdyA9IHRydWU7CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbm1vdXNlZG93biA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLm9uY29udGV4dG1lbnUgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbm1vdXNldXAgPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT09IDEpIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dOZXh0UGFnZSgpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dQcmV2aW91c1BhZ2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcGFyc2VTY2FsZSgncGFnZS1maXQnKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoaXNCbGFua2VkT3V0KCkpIHsKICAgICAgICAgICAgICAgIGxlYXZlQmxhbmtPdXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aXRsZWJhci5zdHlsZS5kaXNwbGF5ID0gdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgb3ZlcmxheUNsb3NlQnV0dG9uLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5jbGFzc0xpc3QucmVtb3ZlKCdwcmVzZW50YXRpb25Nb2RlJyk7CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbm1vdXNldXAgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLm9uY29udGV4dG1lbnUgPSBmdW5jdGlvbiAoKSB7fTsKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLm9ubW91c2Vkb3duID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIHBhcnNlU2NhbGUoJ2F1dG8nKTsKICAgICAgICAgICAgaXNTbGlkZXNob3cgPSB2aWV3ZXJQbHVnaW4uaXNTbGlkZXNob3coKTsKICAgICAgICB9CgogICAgICAgIHByZXNlbnRhdGlvbk1vZGUgPSAhcHJlc2VudGF0aW9uTW9kZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBHZXRzIHRoZSB6b29tIGxldmVsIG9mIHRoZSBkb2N1bWVudAogICAgICogQHJldHVybiB7IW51bWJlcn0KICAgICAqLwogICAgdGhpcy5nZXRab29tTGV2ZWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgcmV0dXJuIHZpZXdlclBsdWdpbi5nZXRab29tTGV2ZWwoKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTZXQgdGhlIHpvb20gbGV2ZWwgb2YgdGhlIGRvY3VtZW50CiAgICAgKiBAcGFyYW0geyFudW1iZXJ9IHZhbHVlCiAgICAgKiBAcmV0dXJuIHt1bmRlZmluZWR9CiAgICAgKi8KICAgIHRoaXMuc2V0Wm9vbUxldmVsID0gZnVuY3Rpb24gKHZhbHVlKSB7CiAgICAgICAgdmlld2VyUGx1Z2luLnNldFpvb21MZXZlbCh2YWx1ZSk7CiAgICB9OwoKICAgIC8qKgogICAgICogWm9vbSBvdXQgYnkgMTAgJQogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnpvb21PdXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gMTAgJSBkZWNyZW1lbnQKICAgICAgICB2YXIgbmV3U2NhbGUgPSAoc2VsZi5nZXRab29tTGV2ZWwoKSAvIGtEZWZhdWx0U2NhbGVEZWx0YSkudG9GaXhlZCgyKTsKICAgICAgICBuZXdTY2FsZSA9IE1hdGgubWF4KGtNaW5TY2FsZSwgbmV3U2NhbGUpOwogICAgICAgIHBhcnNlU2NhbGUobmV3U2NhbGUsIHRydWUpOwogICAgfTsKCiAgICAvKioKICAgICAqIFpvb20gaW4gYnkgMTAlCiAgICAgKiBAcmV0dXJuIHt1bmRlZmluZWR9CiAgICAgKi8KICAgIHRoaXMuem9vbUluID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIDEwICUgaW5jcmVtZW50CiAgICAgICAgdmFyIG5ld1NjYWxlID0gKHNlbGYuZ2V0Wm9vbUxldmVsKCkgKiBrRGVmYXVsdFNjYWxlRGVsdGEpLnRvRml4ZWQoMik7CiAgICAgICAgbmV3U2NhbGUgPSBNYXRoLm1pbihrTWF4U2NhbGUsIG5ld1NjYWxlKTsKICAgICAgICBwYXJzZVNjYWxlKG5ld1NjYWxlLCB0cnVlKTsKICAgIH07CgogICAgZnVuY3Rpb24gY2FuY2VsUHJlc2VudGF0aW9uTW9kZSgpIHsKICAgICAgICBpZiAocHJlc2VudGF0aW9uTW9kZSAmJiAhaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgIHNlbGYudG9nZ2xlUHJlc2VudGF0aW9uTW9kZSgpOwogICAgICAgIH0KICAgIH0KCiAgICBmdW5jdGlvbiBoYW5kbGVGdWxsU2NyZWVuQ2hhbmdlKCkgewogICAgICAgIGlzRnVsbFNjcmVlbiA9ICFpc0Z1bGxTY3JlZW47CiAgICAgICAgY2FuY2VsUHJlc2VudGF0aW9uTW9kZSgpOwogICAgfQoKICAgIGZ1bmN0aW9uIHNob3dPdmVybGF5TmF2aWdhdG9yKCkgewogICAgICAgIGlmIChpc1NsaWRlc2hvdykgewogICAgICAgICAgICBvdmVybGF5TmF2aWdhdG9yLmNsYXNzTmFtZSA9ICd2aWV3ZXItdG91Y2hlZCc7CiAgICAgICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodG91Y2hUaW1lcik7CiAgICAgICAgICAgIHRvdWNoVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBvdmVybGF5TmF2aWdhdG9yLmNsYXNzTmFtZSA9ICcnOwogICAgICAgICAgICB9LCBVSV9GQURFX0RVUkFUSU9OKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0geyFib29sZWFufSB0aW1lZCBGYWRlIGFmdGVyIGEgd2hpbGUKICAgICAqLwogICAgZnVuY3Rpb24gc2hvd1Rvb2xiYXJzKCkgewogICAgICAgIHRpdGxlYmFyLmNsYXNzTGlzdC5hZGQoJ3ZpZXdlci10b3VjaGVkJyk7CiAgICAgICAgdG9vbGJhci5jbGFzc0xpc3QuYWRkKCd2aWV3ZXItdG91Y2hlZCcpOwogICAgICAgIHdpbmRvdy5jbGVhclRpbWVvdXQodG9vbGJhclRvdWNoVGltZXIpOwogICAgICAgIHRvb2xiYXJUb3VjaFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBoaWRlVG9vbGJhcnMoKTsKICAgICAgICB9LCBVSV9GQURFX0RVUkFUSU9OKTsKICAgIH0KCiAgICBmdW5jdGlvbiBoaWRlVG9vbGJhcnMoKSB7CiAgICAgICAgdGl0bGViYXIuY2xhc3NMaXN0LnJlbW92ZSgndmlld2VyLXRvdWNoZWQnKTsKICAgICAgICB0b29sYmFyLmNsYXNzTGlzdC5yZW1vdmUoJ3ZpZXdlci10b3VjaGVkJyk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9nZ2xlVG9vbGJhcnMoKSB7CiAgICAgICAgaWYgKHRpdGxlYmFyLmNsYXNzTGlzdC5jb250YWlucygndmlld2VyLXRvdWNoZWQnKSkgewogICAgICAgICAgICBoaWRlVG9vbGJhcnMoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBzaG93VG9vbGJhcnMoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gYmxhbmtPdXQodmFsdWUpIHsKICAgICAgICBibGFua2VkLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snOwogICAgICAgIGJsYW5rZWQuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gdmFsdWU7CiAgICAgICAgaGlkZVRvb2xiYXJzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gbGVhdmVCbGFua091dCgpIHsKICAgICAgICBibGFua2VkLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgdG9nZ2xlVG9vbGJhcnMoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbml0KCkgewoKICAgICAgICBpbml0aWFsaXplQWJvdXRJbmZvcm1hdGlvbigpOwoKICAgICAgICBpZiAodmlld2VyUGx1Z2luKSB7CiAgICAgICAgICAgIHNlbGYuaW5pdGlhbGl6ZSgpOwoKICAgICAgICAgICAgaWYgKCEoZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4gfHwgZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbiB8fCBkb2N1bWVudC5tb3pDYW5jZWxGdWxsU2NyZWVuIHx8IGRvY3VtZW50LndlYmtpdEV4aXRGdWxsc2NyZWVuIHx8IGRvY3VtZW50LndlYmtpdENhbmNlbEZ1bGxTY3JlZW4gfHwgZG9jdW1lbnQubXNFeGl0RnVsbHNjcmVlbikpIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmdWxsc2NyZWVuJykuc3R5bGUudmlzaWJpbGl0eSA9ICdoaWRkZW4nOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByZXNlbnRhdGlvbicpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ292ZXJsYXlDbG9zZUJ1dHRvbicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2VsZi50b2dnbGVGdWxsU2NyZWVuKTsKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Z1bGxzY3JlZW4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNlbGYudG9nZ2xlRnVsbFNjcmVlbik7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmVzZW50YXRpb24nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIGlmICghaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi50b2dnbGVGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLnRvZ2dsZVByZXNlbnRhdGlvbk1vZGUoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdmdWxsc2NyZWVuY2hhbmdlJywgaGFuZGxlRnVsbFNjcmVlbkNoYW5nZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3dlYmtpdGZ1bGxzY3JlZW5jaGFuZ2UnLCBoYW5kbGVGdWxsU2NyZWVuQ2hhbmdlKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignbW96ZnVsbHNjcmVlbmNoYW5nZScsIGhhbmRsZUZ1bGxTY3JlZW5DaGFuZ2UpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdNU0Z1bGxzY3JlZW5DaGFuZ2UnLCBoYW5kbGVGdWxsU2NyZWVuQ2hhbmdlKTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb3dubG9hZCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5kb3dubG9hZCgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd6b29tT3V0JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzZWxmLnpvb21PdXQoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnem9vbUluJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzZWxmLnpvb21JbigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmV2aW91cycpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5zaG93UHJldmlvdXNQYWdlKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25leHQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuc2hvd05leHRQYWdlKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ByZXZpb3VzUGFnZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5zaG93UHJldmlvdXNQYWdlKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25leHRQYWdlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzZWxmLnNob3dOZXh0UGFnZSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWdlTnVtYmVyJykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5zaG93UGFnZSh0aGlzLnZhbHVlKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NhbGVTZWxlY3QnKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBwYXJzZVNjYWxlKHRoaXMudmFsdWUpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNob3dPdmVybGF5TmF2aWdhdG9yKTsKICAgICAgICAgICAgb3ZlcmxheU5hdmlnYXRvci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNob3dPdmVybGF5TmF2aWdhdG9yKTsKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdG9nZ2xlVG9vbGJhcnMpOwogICAgICAgICAgICB0aXRsZWJhci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNob3dUb29sYmFycyk7CiAgICAgICAgICAgIHRvb2xiYXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzaG93VG9vbGJhcnMpOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3NjYWxlY2hhbmdlJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICAgICAgdmFyIGN1c3RvbVNjYWxlT3B0aW9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2N1c3RvbVNjYWxlT3B0aW9uJyksCiAgICAgICAgICAgICAgICAgICAgcHJlZGVmaW5lZFZhbHVlRm91bmQgPSBzZWxlY3RTY2FsZU9wdGlvbihTdHJpbmcoZXZ0LnNjYWxlKSk7CgogICAgICAgICAgICAgICAgY3VzdG9tU2NhbGVPcHRpb24uc2VsZWN0ZWQgPSBmYWxzZTsKCiAgICAgICAgICAgICAgICBpZiAoIXByZWRlZmluZWRWYWx1ZUZvdW5kKSB7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tU2NhbGVPcHRpb24udGV4dENvbnRlbnQgPSBNYXRoLnJvdW5kKGV2dC5zY2FsZSAqIDEwMDAwKSAvIDEwMCArICclJzsKICAgICAgICAgICAgICAgICAgICBjdXN0b21TY2FsZU9wdGlvbi5zZWxlY3RlZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sIHRydWUpOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgICAgIGlmIChpbml0aWFsaXplZCAmJgogICAgICAgICAgICAgICAgICAgICAgICAgIChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFnZVdpZHRoT3B0aW9uJykuc2VsZWN0ZWQgfHwKICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFnZUF1dG9PcHRpb24nKS5zZWxlY3RlZCkpIHsKICAgICAgICAgICAgICAgICAgICBwYXJzZVNjYWxlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzY2FsZVNlbGVjdCcpLnZhbHVlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNob3dPdmVybGF5TmF2aWdhdG9yKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICAgICAgICB2YXIga2V5ID0gZXZ0LmtleUNvZGUsCiAgICAgICAgICAgICAgICAgICAgc2hpZnRLZXkgPSBldnQuc2hpZnRLZXk7CgogICAgICAgICAgICAgICAgLy8gYmxhbmtlZC1vdXQgbW9kZT8KICAgICAgICAgICAgICAgIGlmIChpc0JsYW5rZWRPdXQoKSkgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxNjogLy8gU2hpZnQKICAgICAgICAgICAgICAgICAgICBjYXNlIDE3OiAvLyBDdHJsCiAgICAgICAgICAgICAgICAgICAgY2FzZSAxODogLy8gQWx0CiAgICAgICAgICAgICAgICAgICAgY2FzZSA5MTogLy8gTGVmdE1ldGEKICAgICAgICAgICAgICAgICAgICBjYXNlIDkzOiAvLyBSaWdodE1ldGEKICAgICAgICAgICAgICAgICAgICBjYXNlIDIyNDogLy8gTWV0YUluTW96aWxsYQogICAgICAgICAgICAgICAgICAgIGNhc2UgMjI1OiAvLyBBbHRHcgogICAgICAgICAgICAgICAgICAgICAgICAvLyBpZ25vcmUgbW9kaWZpZXIga2V5cyBhbG9uZQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBsZWF2ZUJsYW5rT3V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoIChrZXkpIHsKICAgICAgICAgICAgICAgICAgICBjYXNlIDg6IC8vIGJhY2tzcGFjZQogICAgICAgICAgICAgICAgICAgIGNhc2UgMzM6IC8vIHBhZ2VVcAogICAgICAgICAgICAgICAgICAgIGNhc2UgMzc6IC8vIGxlZnQgYXJyb3cKICAgICAgICAgICAgICAgICAgICBjYXNlIDM4OiAvLyB1cCBhcnJvdwogICAgICAgICAgICAgICAgICAgIGNhc2UgODA6IC8vIGtleSAncCcKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zaG93UHJldmlvdXNQYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMTM6IC8vIGVudGVyCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzNDogLy8gcGFnZURvd24KICAgICAgICAgICAgICAgICAgICBjYXNlIDM5OiAvLyByaWdodCBhcnJvdwogICAgICAgICAgICAgICAgICAgIGNhc2UgNDA6IC8vIGRvd24gYXJyb3cKICAgICAgICAgICAgICAgICAgICBjYXNlIDc4OiAvLyBrZXkgJ24nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd05leHRQYWdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMzI6IC8vIHNwYWNlCiAgICAgICAgICAgICAgICAgICAgICAgIHNoaWZ0S2V5ID8gc2VsZi5zaG93UHJldmlvdXNQYWdlKCkgOiBzZWxmLnNob3dOZXh0UGFnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDY2OiAgLy8ga2V5ICdiJyBibGFua3Mgc2NyZWVuICh0byBibGFjaykgb3IgcmV0dXJucyB0byB0aGUgZG9jdW1lbnQKICAgICAgICAgICAgICAgICAgICBjYXNlIDE5MDogLy8gYW5kIHNvIGRvZXMgdGhlIGtleSAnLicgKGRvdCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHByZXNlbnRhdGlvbk1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJsYW5rT3V0KCcjMDAwJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA4NzogIC8vIGtleSAndycgYmxhbmtzIHBhZ2UgKHRvIHdoaXRlKSBvciByZXR1cm5zIHRvIHRoZSBkb2N1bWVudAogICAgICAgICAgICAgICAgICAgIGNhc2UgMTg4OiAvLyBhbmQgc28gZG9lcyB0aGUga2V5ICcsJyAoY29tbWEpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmVzZW50YXRpb25Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibGFua091dCgnI0ZGRicpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMzY6IC8vIGtleSAnSG9tZScgZ29lcyB0byBmaXJzdCBwYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd1BhZ2UoMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgMzU6IC8vIGtleSAnRW5kJyBnb2VzIHRvIGxhc3QgcGFnZQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dQYWdlKHBhZ2VzLmxlbmd0aCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQoKICAgIGluaXQoKTsKfQo=",
                "body": "LyoqCiAqIENvcHlyaWdodCAoQykgMjAxMi0yMDE0IEtPIEdtYkggPGNvcHlyaWdodEBrb2dtYmguY29tPgogKgogKiBAbGljc3RhcnQKICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgV2ViT0RGLgogKgogKiBXZWJPREYgaXMgZnJlZSBzb2Z0d2FyZTogeW91IGNhbiByZWRpc3RyaWJ1dGUgaXQgYW5kL29yIG1vZGlmeSBpdAogKiB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSAoR05VIEFHUEwpCiAqIGFzIHB1Ymxpc2hlZCBieSB0aGUgRnJlZSBTb2Z0d2FyZSBGb3VuZGF0aW9uLCBlaXRoZXIgdmVyc2lvbiAzIG9mCiAqIHRoZSBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLgogKgogKiBXZWJPREYgaXMgZGlzdHJpYnV0ZWQgaW4gdGhlIGhvcGUgdGhhdCBpdCB3aWxsIGJlIHVzZWZ1bCwgYnV0CiAqIFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2YKICogTUVSQ0hBTlRBQklMSVRZIG9yIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFLiAgU2VlIHRoZQogKiBHTlUgQWZmZXJvIEdlbmVyYWwgUHVibGljIExpY2Vuc2UgZm9yIG1vcmUgZGV0YWlscy4KICoKICogWW91IHNob3VsZCBoYXZlIHJlY2VpdmVkIGEgY29weSBvZiB0aGUgR05VIEFmZmVybyBHZW5lcmFsIFB1YmxpYyBMaWNlbnNlCiAqIGFsb25nIHdpdGggV2ViT0RGLiAgSWYgbm90LCBzZWUgPGh0dHA6Ly93d3cuZ251Lm9yZy9saWNlbnNlcy8+LgogKiBAbGljZW5kCiAqCiAqIEBzb3VyY2U6IGh0dHA6Ly93d3cud2Vib2RmLm9yZy8KICogQHNvdXJjZTogaHR0cHM6Ly9naXRodWIuY29tL2tvZ21iaC9XZWJPREYvCiAqLwoKLyoKICogVGhpcyBmaWxlIGlzIGEgZGVyaXZhdGl2ZSBmcm9tIGEgcGFydCBvZiBNb3ppbGxhJ3MgUERGLmpzIHByb2plY3QuIFRoZQogKiBvcmlnaW5hbCBsaWNlbnNlIGhlYWRlciBmb2xsb3dzLgogKi8KCi8qIENvcHlyaWdodCAyMDEyIE1vemlsbGEgRm91bmRhdGlvbgogKgogKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgIkxpY2Vuc2UiKTsKICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLgogKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXQKICoKICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wCiAqCiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmUKICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gIkFTIElTIiBCQVNJUywKICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuCiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmQKICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuCiAqLwoKLypnbG9iYWwgZG9jdW1lbnQsIHdpbmRvdyovCgpmdW5jdGlvbiBWaWV3ZXIodmlld2VyUGx1Z2luKSB7CiAgICAidXNlIHN0cmljdCI7CgogICAgdmFyIHNlbGYgPSB0aGlzLAogICAgICAgIGtTY3JvbGxiYXJQYWRkaW5nID0gNDAsCiAgICAgICAga01pblNjYWxlID0gMC4yNSwKICAgICAgICBrTWF4U2NhbGUgPSA0LjAsCiAgICAgICAga0RlZmF1bHRTY2FsZURlbHRhID0gMS4xLAogICAgICAgIGtEZWZhdWx0U2NhbGUgPSAnYXV0bycsCiAgICAgICAgcHJlc2VudGF0aW9uTW9kZSA9IGZhbHNlLAogICAgICAgIGlzRnVsbFNjcmVlbiA9IGZhbHNlLAogICAgICAgIGluaXRpYWxpemVkID0gZmFsc2UsCiAgICAgICAgaXNTbGlkZXNob3cgPSBmYWxzZSwKICAgICAgICB1cmwsCiAgICAgICAgdmlld2VyRWxlbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWV3ZXInKSwKICAgICAgICBjYW52YXNDb250YWluZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2FudmFzQ29udGFpbmVyJyksCiAgICAgICAgb3ZlcmxheU5hdmlnYXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvdmVybGF5TmF2aWdhdG9yJyksCiAgICAgICAgdGl0bGViYXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGl0bGViYXInKSwKICAgICAgICB0b29sYmFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Rvb2xiYXJDb250YWluZXInKSwKICAgICAgICBwYWdlU3dpdGNoZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9vbGJhckxlZnQnKSwKICAgICAgICB6b29tV2lkZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Rvb2xiYXJNaWRkbGVDb250YWluZXInKSwKICAgICAgICBzY2FsZVNlbGVjdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjYWxlU2VsZWN0JyksCiAgICAgICAgZGlhbG9nT3ZlcmxheSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaWFsb2dPdmVybGF5JyksCiAgICAgICAgdG9vbGJhclJpZ2h0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Rvb2xiYXJSaWdodCcpLAogICAgICAgIGFib3V0RGlhbG9nLAogICAgICAgIGZpbGVuYW1lLAogICAgICAgIHBhZ2VzID0gW10sCiAgICAgICAgY3VycmVudFBhZ2UsCiAgICAgICAgc2NhbGVDaGFuZ2VUaW1lciwKICAgICAgICB0b3VjaFRpbWVyLAogICAgICAgIHRvb2xiYXJUb3VjaFRpbWVyLAogICAgICAgIC8qKkBjb25zdCovCiAgICAgICAgVUlfRkFERV9EVVJBVElPTiA9IDUwMDA7CgogICAgZnVuY3Rpb24gaXNCbGFua2VkT3V0KCkgewogICAgICAgIHJldHVybiAoYmxhbmtlZC5zdHlsZS5kaXNwbGF5ID09PSAnYmxvY2snKTsKICAgIH0KCiAgICBmdW5jdGlvbiBpbml0aWFsaXplQWJvdXRJbmZvcm1hdGlvbigpIHsKICAgICAgICB2YXIgYWJvdXREaWFsb2dDZW50ZXJlclRhYmxlLCBhYm91dERpYWxvZ0NlbnRlcmVyQ2VsbCwgYWJvdXRCdXR0b24sIHBsdWdpbk5hbWUsIHBsdWdpblZlcnNpb24sIHBsdWdpblVSTDsKCiAgICAgICAgaWYgKHZpZXdlclBsdWdpbikgewogICAgICAgICAgICBwbHVnaW5OYW1lID0gdmlld2VyUGx1Z2luLmdldFBsdWdpbk5hbWUoKTsKICAgICAgICAgICAgcGx1Z2luVmVyc2lvbiA9IHZpZXdlclBsdWdpbi5nZXRQbHVnaW5WZXJzaW9uKCk7CiAgICAgICAgICAgIHBsdWdpblVSTCA9IHZpZXdlclBsdWdpbi5nZXRQbHVnaW5VUkwoKTsKICAgICAgICB9CgogICAgICAgIC8vIENyZWF0ZSBkaWFsb2cKICAgICAgICBhYm91dERpYWxvZ0NlbnRlcmVyVGFibGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBhYm91dERpYWxvZ0NlbnRlcmVyVGFibGUuaWQgPSAiYWJvdXREaWFsb2dDZW50ZXJlclRhYmxlIjsKICAgICAgICBhYm91dERpYWxvZ0NlbnRlcmVyQ2VsbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGFib3V0RGlhbG9nQ2VudGVyZXJDZWxsLmlkID0gImFib3V0RGlhbG9nQ2VudGVyZXJDZWxsIjsKICAgICAgICBhYm91dERpYWxvZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGFib3V0RGlhbG9nLmlkID0gImFib3V0RGlhbG9nIjsKICAgICAgICBhYm91dERpYWxvZy5pbm5lckhUTUwgPQogICAgICAgICAgICAiPGgxPlZpZXdlckpTPC9oMT4iICsKICAgICAgICAgICAgIjxwPk9wZW4gU291cmNlIGRvY3VtZW50IHZpZXdlciBmb3Igd2VicGFnZXMsIGJ1aWx0IHdpdGggSFRNTCBhbmQgSmF2YVNjcmlwdC48L3A+IiArCiAgICAgICAgICAgICI8cD5MZWFybiBtb3JlIGFuZCBnZXQgeW91ciBvd24gY29weSBvbiB0aGUgPGEgaHJlZj1cImh0dHA6Ly92aWV3ZXJqcy5vcmcvXCIgdGFyZ2V0PVwiX2JsYW5rXCI+Vmlld2VySlMgd2Vic2l0ZTwvYT4uPC9wPiIgKwogICAgICAgICAgICAodmlld2VyUGx1Z2luID8gKCI8cD5Vc2luZyB0aGUgPGEgaHJlZiA9IFwiIisgcGx1Z2luVVJMICsgIlwiIHRhcmdldD1cIl9ibGFua1wiPiIgKyBwbHVnaW5OYW1lICsgIjwvYT4gIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiKDxzcGFuIGlkID0gXCJwbHVnaW5WZXJzaW9uXCI+IiArIHBsdWdpblZlcnNpb24gKyAiPC9zcGFuPikgIiArCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAicGx1Z2luIHRvIHNob3cgeW91IHRoaXMgZG9jdW1lbnQuPC9wPiIpCiAgICAgICAgICAgICAgICAgICAgICAgICA6ICIiKSArCiAgICAgICAgICAgICI8cD5TdXBwb3J0ZWQgYnkgPGEgaHJlZj1cImh0dHA6Ly9ubG5ldC5ubFwiIHRhcmdldD1cIl9ibGFua1wiPjxicj48aW1nIHNyYz1cImltYWdlc1wvbmxuZXQucG5nXCIgd2lkdGg9XCIxNjBcIiBoZWlnaHQ9XCI2MFwiIGFsdD1cIk5MbmV0IEZvdW5kYXRpb25cIj48L2E+PC9wPiIgKwogICAgICAgICAgICAiPHA+TWFkZSBieSA8YSBocmVmPVwiaHR0cDovL2tvZ21iaC5jb21cIiB0YXJnZXQ9XCJfYmxhbmtcIj48YnI+PGltZyBzcmM9XCJpbWFnZXNcL2tvZ21iaC5wbmdcIiB3aWR0aD1cIjE3MlwiIGhlaWdodD1cIjQwXCIgYWx0PVwiS08gR21iSFwiPjwvYT48L3A+IiArCiAgICAgICAgICAgICI8YnV0dG9uIGlkID0gXCJhYm91dERpYWxvZ0Nsb3NlQnV0dG9uXCIgY2xhc3MgPSBcInRvb2xiYXJCdXR0b24gdGV4dEJ1dHRvblwiPkNsb3NlPC9idXR0b24+IjsKICAgICAgICBkaWFsb2dPdmVybGF5LmFwcGVuZENoaWxkKGFib3V0RGlhbG9nQ2VudGVyZXJUYWJsZSk7CiAgICAgICAgYWJvdXREaWFsb2dDZW50ZXJlclRhYmxlLmFwcGVuZENoaWxkKGFib3V0RGlhbG9nQ2VudGVyZXJDZWxsKTsKICAgICAgICBhYm91dERpYWxvZ0NlbnRlcmVyQ2VsbC5hcHBlbmRDaGlsZChhYm91dERpYWxvZyk7CgogICAgICAgIC8vIENyZWF0ZSBidXR0b24gdG8gb3BlbiBkaWFsb2cgdGhhdCBzYXlzICJWaWV3ZXJKUyIKICAgICAgICBhYm91dEJ1dHRvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2J1dHRvbicpOwogICAgICAgIGFib3V0QnV0dG9uLmlkID0gImFib3V0IjsKICAgICAgICBhYm91dEJ1dHRvbi5jbGFzc05hbWUgPSAidG9vbGJhckJ1dHRvbiB0ZXh0QnV0dG9uIGFib3V0IjsKICAgICAgICBhYm91dEJ1dHRvbi50aXRsZSA9ICJBYm91dCI7CiAgICAgICAgYWJvdXRCdXR0b24uaW5uZXJIVE1MID0gIlZpZXdlckpTIgogICAgICAgIHRvb2xiYXJSaWdodC5hcHBlbmRDaGlsZChhYm91dEJ1dHRvbik7CgogICAgICAgIC8vIEF0dGFjaCBldmVudHMgdG8gdGhlIGFib3ZlCiAgICAgICAgYWJvdXRCdXR0b24uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzaG93QWJvdXREaWFsb2coKTsKICAgICAgICB9KTsKICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWJvdXREaWFsb2dDbG9zZUJ1dHRvbicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaGlkZUFib3V0RGlhbG9nKCk7CiAgICAgICAgfSk7CgogICAgfQoKICAgIGZ1bmN0aW9uIHNob3dBYm91dERpYWxvZygpIHsKICAgICAgICBkaWFsb2dPdmVybGF5LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgfQoKICAgIGZ1bmN0aW9uIGhpZGVBYm91dERpYWxvZygpIHsKICAgICAgICBkaWFsb2dPdmVybGF5LnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICB9CgogICAgZnVuY3Rpb24gc2VsZWN0U2NhbGVPcHRpb24odmFsdWUpIHsKICAgICAgICAvLyBSZXRyaWV2ZSB0aGUgb3B0aW9ucyBmcm9tIHRoZSB6b29tIGxldmVsIDxzZWxlY3Q+IGVsZW1lbnQKICAgICAgICB2YXIgb3B0aW9ucyA9IHNjYWxlU2VsZWN0b3Iub3B0aW9ucywKICAgICAgICAgICAgb3B0aW9uLAogICAgICAgICAgICBwcmVkZWZpbmVkVmFsdWVGb3VuZCA9IGZhbHNlLAogICAgICAgICAgICBpOwoKICAgICAgICBmb3IgKGkgPSAwOyBpIDwgb3B0aW9ucy5sZW5ndGg7IGkgKz0gMSkgewogICAgICAgICAgICBvcHRpb24gPSBvcHRpb25zW2ldOwogICAgICAgICAgICBpZiAob3B0aW9uLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICAgICAgb3B0aW9uLnNlbGVjdGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBvcHRpb24uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICBwcmVkZWZpbmVkVmFsdWVGb3VuZCA9IHRydWU7CiAgICAgICAgfQogICAgICAgIHJldHVybiBwcmVkZWZpbmVkVmFsdWVGb3VuZDsKICAgIH0KCiAgICBmdW5jdGlvbiBnZXRQYWdlcygpIHsKICAgICAgICByZXR1cm4gdmlld2VyUGx1Z2luLmdldFBhZ2VzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gc2V0U2NhbGUodmFsLCByZXNldEF1dG9TZXR0aW5ncywgbm9TY3JvbGwpIHsKICAgICAgICBpZiAodmFsID09PSBzZWxmLmdldFpvb21MZXZlbCgpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CgogICAgICAgIHNlbGYuc2V0Wm9vbUxldmVsKHZhbCk7CgogICAgICAgIHZhciBldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCdVSUV2ZW50cycpOwogICAgICAgIGV2ZW50LmluaXRVSUV2ZW50KCdzY2FsZWNoYW5nZScsIGZhbHNlLCBmYWxzZSwgd2luZG93LCAwKTsKICAgICAgICBldmVudC5zY2FsZSA9IHZhbDsKICAgICAgICBldmVudC5yZXNldEF1dG9TZXR0aW5ncyA9IHJlc2V0QXV0b1NldHRpbmdzOwogICAgICAgIHdpbmRvdy5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0KCiAgICBmdW5jdGlvbiBvblNjcm9sbCgpIHsKICAgICAgICB2YXIgcGFnZU51bWJlcjsKCiAgICAgICAgaWYgKHZpZXdlclBsdWdpbi5vblNjcm9sbCkgewogICAgICAgICAgICB2aWV3ZXJQbHVnaW4ub25TY3JvbGwoKTsKICAgICAgICB9CiAgICAgICAgaWYgKHZpZXdlclBsdWdpbi5nZXRQYWdlSW5WaWV3KSB7CiAgICAgICAgICAgIHBhZ2VOdW1iZXIgPSB2aWV3ZXJQbHVnaW4uZ2V0UGFnZUluVmlldygpOwogICAgICAgICAgICBpZiAocGFnZU51bWJlcikgewogICAgICAgICAgICAgICAgY3VycmVudFBhZ2UgPSBwYWdlTnVtYmVyOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhZ2VOdW1iZXInKS52YWx1ZSA9IHBhZ2VOdW1iZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gZGVsYXllZFJlZnJlc2gobWlsbGlzZWNvbmRzKSB7CiAgICAgICAgd2luZG93LmNsZWFyVGltZW91dChzY2FsZUNoYW5nZVRpbWVyKTsKICAgICAgICBzY2FsZUNoYW5nZVRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICBvblNjcm9sbCgpOwogICAgICAgIH0sIG1pbGxpc2Vjb25kcyk7CiAgICB9CgogICAgZnVuY3Rpb24gcGFyc2VTY2FsZSh2YWx1ZSwgcmVzZXRBdXRvU2V0dGluZ3MsIG5vU2Nyb2xsKSB7CiAgICAgICAgdmFyIHNjYWxlLAogICAgICAgICAgICBtYXhXaWR0aCwKICAgICAgICAgICAgbWF4SGVpZ2h0OwoKICAgICAgICBpZiAodmFsdWUgPT09ICdjdXN0b20nKSB7CiAgICAgICAgICAgIHNjYWxlID0gcGFyc2VGbG9hdChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY3VzdG9tU2NhbGVPcHRpb24nKS50ZXh0Q29udGVudCkgLyAxMDA7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2NhbGUgPSBwYXJzZUZsb2F0KHZhbHVlKTsKICAgICAgICB9CgogICAgICAgIGlmIChzY2FsZSkgewogICAgICAgICAgICBzZXRTY2FsZShzY2FsZSwgdHJ1ZSwgbm9TY3JvbGwpOwogICAgICAgICAgICBkZWxheWVkUmVmcmVzaCgzMDApOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoKICAgICAgICBtYXhXaWR0aCA9IGNhbnZhc0NvbnRhaW5lci5jbGllbnRXaWR0aCAtIGtTY3JvbGxiYXJQYWRkaW5nOwogICAgICAgIG1heEhlaWdodCA9IGNhbnZhc0NvbnRhaW5lci5jbGllbnRIZWlnaHQgLSBrU2Nyb2xsYmFyUGFkZGluZzsKCiAgICAgICAgc3dpdGNoICh2YWx1ZSkgewogICAgICAgIGNhc2UgJ3BhZ2UtYWN0dWFsJzoKICAgICAgICAgICAgc2V0U2NhbGUoMSwgcmVzZXRBdXRvU2V0dGluZ3MsIG5vU2Nyb2xsKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncGFnZS13aWR0aCc6CiAgICAgICAgICAgIHZpZXdlclBsdWdpbi5maXRUb1dpZHRoKG1heFdpZHRoKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncGFnZS1oZWlnaHQnOgogICAgICAgICAgICB2aWV3ZXJQbHVnaW4uZml0VG9IZWlnaHQobWF4SGVpZ2h0KTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAncGFnZS1maXQnOgogICAgICAgICAgICB2aWV3ZXJQbHVnaW4uZml0VG9QYWdlKG1heFdpZHRoLCBtYXhIZWlnaHQpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICdhdXRvJzoKICAgICAgICAgICAgaWYgKHZpZXdlclBsdWdpbi5pc1NsaWRlc2hvdygpKSB7CiAgICAgICAgICAgICAgICB2aWV3ZXJQbHVnaW4uZml0VG9QYWdlKG1heFdpZHRoICsga1Njcm9sbGJhclBhZGRpbmcsIG1heEhlaWdodCArIGtTY3JvbGxiYXJQYWRkaW5nKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZpZXdlclBsdWdpbi5maXRTbWFydChtYXhXaWR0aCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBzZWxlY3RTY2FsZU9wdGlvbih2YWx1ZSk7CiAgICAgICAgZGVsYXllZFJlZnJlc2goMzAwKTsKICAgIH0KCiAgICAKICAgIHRoaXMuaW5pdGlhbGl6ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgbG9jYXRpb24gPSBTdHJpbmcoZG9jdW1lbnQubG9jYXRpb24pLAogICAgICAgICAgICBwb3MgPSBsb2NhdGlvbi5pbmRleE9mKCcjJyksCiAgICAgICAgICAgIGVsZW1lbnQ7CgogICAgICAgIGxvY2F0aW9uID0gbG9jYXRpb24uc3Vic3RyKHBvcyArIDEpOwogICAgICAgIGlmIChwb3MgPT09IC0xIHx8IGxvY2F0aW9uLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnQ291bGQgbm90IHBhcnNlIGZpbGUgcGF0aCBhcmd1bWVudC4nKTsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KCiAgICAgICAgdXJsID0gbG9jYXRpb247CiAgICAgICAgZmlsZW5hbWUgPSB1cmwucmVwbGFjZSgvXi4qW1xcXC9dLywgJycpOwogICAgICAgIGRvY3VtZW50LnRpdGxlID0gZmlsZW5hbWU7CiAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RvY3VtZW50TmFtZScpLmlubmVySFRNTCA9IGRvY3VtZW50LnRpdGxlOwoKICAgICAgICB2aWV3ZXJQbHVnaW4ub25Mb2FkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGx1Z2luVmVyc2lvbicpLmlubmVySFRNTCA9IHZpZXdlclBsdWdpbi5nZXRQbHVnaW5WZXJzaW9uKCk7CgogICAgICAgICAgICBpc1NsaWRlc2hvdyA9IHZpZXdlclBsdWdpbi5pc1NsaWRlc2hvdygpOwogICAgICAgICAgICBpZiAoaXNTbGlkZXNob3cpIHsKICAgICAgICAgICAgICAgIC8vIFNsaWRlc2hvdyBwYWdlcyBzaG91bGQgYmUgY2VudGVyZWQKICAgICAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5jbGFzc0xpc3QuYWRkKCJzbGlkZXNob3ciKTsKICAgICAgICAgICAgICAgIC8vIFNob3cgcGFnZSBuYXYgY29udHJvbHMgb25seSBmb3IgcHJlc2VudGF0aW9ucwogICAgICAgICAgICAgICAgcGFnZVN3aXRjaGVyLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyBGb3IgdGV4dCBkb2N1bWVudHMsIHNob3cgdGhlIHpvb20gd2lkZ2V0LgogICAgICAgICAgICAgICAgem9vbVdpZGdldC5zdHlsZS52aXNpYmlsaXR5ID0gJ3Zpc2libGUnOwogICAgICAgICAgICAgICAgLy8gT25seSBzaG93IHRoZSBwYWdlIHN3aXRjaGVyIHdpZGdldCBpZiB0aGUgcGx1Z2luIHN1cHBvcnRzIHBhZ2UgbnVtYmVycwogICAgICAgICAgICAgICAgaWYgKHZpZXdlclBsdWdpbi5nZXRQYWdlSW5WaWV3KSB7CiAgICAgICAgICAgICAgICAgICAgcGFnZVN3aXRjaGVyLnN0eWxlLnZpc2liaWxpdHkgPSAndmlzaWJsZSc7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGluaXRpYWxpemVkID0gdHJ1ZTsKICAgICAgICAgICAgcGFnZXMgPSBnZXRQYWdlcygpOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbnVtUGFnZXMnKS5pbm5lckhUTUwgPSAnb2YgJyArIHBhZ2VzLmxlbmd0aDsKCiAgICAgICAgICAgIHNlbGYuc2hvd1BhZ2UoMSk7CgogICAgICAgICAgICAvLyBTZXQgZGVmYXVsdCBzY2FsZQogICAgICAgICAgICBwYXJzZVNjYWxlKGtEZWZhdWx0U2NhbGUpOwoKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLm9uc2Nyb2xsID0gb25TY3JvbGw7CiAgICAgICAgICAgIGRlbGF5ZWRSZWZyZXNoKCk7CiAgICAgICAgfTsKCiAgICAgICAgdmlld2VyUGx1Z2luLmluaXRpYWxpemUoY2FudmFzQ29udGFpbmVyLCBsb2NhdGlvbik7CiAgICB9OwoKICAgIC8qKgogICAgICogU2hvd3MgdGhlICduJ3RoIHBhZ2UuIElmIG4gaXMgbGFyZ2VyIHRoYW4gdGhlIHBhZ2UgY291bnQsCiAgICAgKiBzaG93cyB0aGUgbGFzdCBwYWdlLiBJZiBuIGlzIGxlc3MgdGhhbiAxLCBzaG93cyB0aGUgZmlyc3QgcGFnZS4KICAgICAqIEByZXR1cm4ge3VuZGVmaW5lZH0KICAgICAqLwogICAgdGhpcy5zaG93UGFnZSA9IGZ1bmN0aW9uIChuKSB7CiAgICAgICAgaWYgKG4gPD0gMCkgewogICAgICAgICAgICBuID0gMTsKICAgICAgICB9IGVsc2UgaWYgKG4gPiBwYWdlcy5sZW5ndGgpIHsKICAgICAgICAgICAgbiA9IHBhZ2VzLmxlbmd0aDsKICAgICAgICB9CgogICAgICAgIHZpZXdlclBsdWdpbi5zaG93UGFnZShuKTsKCiAgICAgICAgY3VycmVudFBhZ2UgPSBuOwogICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwYWdlTnVtYmVyJykudmFsdWUgPSBjdXJyZW50UGFnZTsKICAgIH07CgogICAgLyoqCiAgICAgKiBTaG93cyB0aGUgbmV4dCBwYWdlLiBJZiB0aGVyZSBpcyBubyBzdWJzZXF1ZW50IHBhZ2UsIGRvZXMgbm90aGluZy4KICAgICAqIEByZXR1cm4ge3VuZGVmaW5lZH0KICAgICAqLwogICAgdGhpcy5zaG93TmV4dFBhZ2UgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2VsZi5zaG93UGFnZShjdXJyZW50UGFnZSArIDEpOwogICAgfTsKCiAgICAvKioKICAgICAqIFNob3dzIHRoZSBwcmV2aW91cyBwYWdlLiBJZiB0aGVyZSBpcyBubyBwcmV2aW91cyBwYWdlLCBkb2VzIG5vdGhpbmcuCiAgICAgKiBAcmV0dXJuIHt1bmRlZmluZWR9CiAgICAgKi8KICAgIHRoaXMuc2hvd1ByZXZpb3VzUGFnZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICBzZWxmLnNob3dQYWdlKGN1cnJlbnRQYWdlIC0gMSk7CiAgICB9OwoKICAgIC8qKgogICAgICogQXR0ZW1wdHMgdG8gJ2Rvd25sb2FkJyB0aGUgZmlsZS4KICAgICAqIEByZXR1cm4ge3VuZGVmaW5lZH0KICAgICAqLwogICAgdGhpcy5kb3dubG9hZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgZG9jdW1lbnRVcmwgPSB1cmwuc3BsaXQoJyMnKVswXTsKICAgICAgICBkb2N1bWVudFVybCArPSAnI3ZpZXdlci5hY3Rpb249ZG93bmxvYWQnOwogICAgICAgIHdpbmRvdy5vcGVuKGRvY3VtZW50VXJsLCAnX3BhcmVudCcpOwogICAgfTsKCiAgICAvKioKICAgICAqIFRvZ2dsZXMgdGhlIGZ1bGxzY3JlZW4gc3RhdGUgb2YgdGhlIHZpZXdlcgogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnRvZ2dsZUZ1bGxTY3JlZW4gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIGVsZW0gPSB2aWV3ZXJFbGVtZW50OwogICAgICAgIGlmICghaXNGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgIGlmIChlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKSB7CiAgICAgICAgICAgICAgICBlbGVtLnJlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZWxlbS5tb3pSZXF1ZXN0RnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgZWxlbS5tb3pSZXF1ZXN0RnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgICAgIGVsZW0ud2Via2l0UmVxdWVzdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChlbGVtLndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBlbGVtLndlYmtpdFJlcXVlc3RGdWxsU2NyZWVuKEVsZW1lbnQuQUxMT1dfS0VZQk9BUkRfSU5QVVQpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGVsZW0ubXNSZXF1ZXN0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgZWxlbS5tc1JlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoZG9jdW1lbnQuZXhpdEZ1bGxzY3JlZW4pIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmV4aXRGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQuY2FuY2VsRnVsbFNjcmVlbigpOwogICAgICAgICAgICB9IGVsc2UgaWYgKGRvY3VtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4pIHsKICAgICAgICAgICAgICAgIGRvY3VtZW50Lm1vekNhbmNlbEZ1bGxTY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQud2Via2l0RXhpdEZ1bGxzY3JlZW4oKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChkb2N1bWVudC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuKCk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoZG9jdW1lbnQubXNFeGl0RnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgZG9jdW1lbnQubXNFeGl0RnVsbHNjcmVlbigpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKIAogICAgLyoqCiAgICAgKiBUb2dnbGVzIHRoZSBwcmVzZW50YXRpb24gbW9kZSBvZiB0aGUgdmlld2VyLgogICAgICogUHJlc2VudGF0aW9uIG1vZGUgaW52b2x2ZXMgZnVsbHNjcmVlbiArIGhpZGRlbiBVSSBjb250cm9scwogICAgICovCiAgICB0aGlzLnRvZ2dsZVByZXNlbnRhdGlvbk1vZGUgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdmFyIG92ZXJsYXlDbG9zZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvdmVybGF5Q2xvc2VCdXR0b24nKTsKCiAgICAgICAgaWYgKCFwcmVzZW50YXRpb25Nb2RlKSB7CiAgICAgICAgICAgIHRpdGxlYmFyLnN0eWxlLmRpc3BsYXkgPSB0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgICAgICAgIG92ZXJsYXlDbG9zZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICAgICAgY2FudmFzQ29udGFpbmVyLmNsYXNzTGlzdC5hZGQoJ3ByZXNlbnRhdGlvbk1vZGUnKTsKICAgICAgICAgICAgaXNTbGlkZXNob3cgPSB0cnVlOwogICAgICAgICAgICBjYW52YXNDb250YWluZXIub25tb3VzZWRvd24gPSBmdW5jdGlvbiAoZXZlbnQpIHsKICAgICAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbmNvbnRleHRtZW51ID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB9OwogICAgICAgICAgICBjYW52YXNDb250YWluZXIub25tb3VzZXVwID0gZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICAgICAgaWYgKGV2ZW50LndoaWNoID09PSAxKSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zaG93TmV4dFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zaG93UHJldmlvdXNQYWdlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHBhcnNlU2NhbGUoJ3BhZ2UtZml0Jyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGlzQmxhbmtlZE91dCgpKSB7CiAgICAgICAgICAgICAgICBsZWF2ZUJsYW5rT3V0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGl0bGViYXIuc3R5bGUuZGlzcGxheSA9IHRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICAgICAgICAgIG92ZXJsYXlDbG9zZUJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgICAgICBjYW52YXNDb250YWluZXIuY2xhc3NMaXN0LnJlbW92ZSgncHJlc2VudGF0aW9uTW9kZScpOwogICAgICAgICAgICBjYW52YXNDb250YWluZXIub25tb3VzZXVwID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbmNvbnRleHRtZW51ID0gZnVuY3Rpb24gKCkge307CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5vbm1vdXNlZG93biA9IGZ1bmN0aW9uICgpIHt9OwogICAgICAgICAgICBwYXJzZVNjYWxlKCdhdXRvJyk7CiAgICAgICAgICAgIGlzU2xpZGVzaG93ID0gdmlld2VyUGx1Z2luLmlzU2xpZGVzaG93KCk7CiAgICAgICAgfQoKICAgICAgICBwcmVzZW50YXRpb25Nb2RlID0gIXByZXNlbnRhdGlvbk1vZGU7CiAgICB9OwoKICAgIC8qKgogICAgICogR2V0cyB0aGUgem9vbSBsZXZlbCBvZiB0aGUgZG9jdW1lbnQKICAgICAqIEByZXR1cm4geyFudW1iZXJ9CiAgICAgKi8KICAgIHRoaXMuZ2V0Wm9vbUxldmVsID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB2aWV3ZXJQbHVnaW4uZ2V0Wm9vbUxldmVsKCk7CiAgICB9OwoKICAgIC8qKgogICAgICogU2V0IHRoZSB6b29tIGxldmVsIG9mIHRoZSBkb2N1bWVudAogICAgICogQHBhcmFtIHshbnVtYmVyfSB2YWx1ZQogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnNldFpvb21MZXZlbCA9IGZ1bmN0aW9uICh2YWx1ZSkgewogICAgICAgIHZpZXdlclBsdWdpbi5zZXRab29tTGV2ZWwodmFsdWUpOwogICAgfTsKCiAgICAvKioKICAgICAqIFpvb20gb3V0IGJ5IDEwICUKICAgICAqIEByZXR1cm4ge3VuZGVmaW5lZH0KICAgICAqLwogICAgdGhpcy56b29tT3V0ID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIDEwICUgZGVjcmVtZW50CiAgICAgICAgdmFyIG5ld1NjYWxlID0gKHNlbGYuZ2V0Wm9vbUxldmVsKCkgLyBrRGVmYXVsdFNjYWxlRGVsdGEpLnRvRml4ZWQoMik7CiAgICAgICAgbmV3U2NhbGUgPSBNYXRoLm1heChrTWluU2NhbGUsIG5ld1NjYWxlKTsKICAgICAgICBwYXJzZVNjYWxlKG5ld1NjYWxlLCB0cnVlKTsKICAgIH07CgogICAgLyoqCiAgICAgKiBab29tIGluIGJ5IDEwJQogICAgICogQHJldHVybiB7dW5kZWZpbmVkfQogICAgICovCiAgICB0aGlzLnpvb21JbiA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAvLyAxMCAlIGluY3JlbWVudAogICAgICAgIHZhciBuZXdTY2FsZSA9IChzZWxmLmdldFpvb21MZXZlbCgpICoga0RlZmF1bHRTY2FsZURlbHRhKS50b0ZpeGVkKDIpOwogICAgICAgIG5ld1NjYWxlID0gTWF0aC5taW4oa01heFNjYWxlLCBuZXdTY2FsZSk7CiAgICAgICAgcGFyc2VTY2FsZShuZXdTY2FsZSwgdHJ1ZSk7CiAgICB9OwoKICAgIGZ1bmN0aW9uIGNhbmNlbFByZXNlbnRhdGlvbk1vZGUoKSB7CiAgICAgICAgaWYgKHByZXNlbnRhdGlvbk1vZGUgJiYgIWlzRnVsbFNjcmVlbikgewogICAgICAgICAgICBzZWxmLnRvZ2dsZVByZXNlbnRhdGlvbk1vZGUoKTsKICAgICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gaGFuZGxlRnVsbFNjcmVlbkNoYW5nZSgpIHsKICAgICAgICBpc0Z1bGxTY3JlZW4gPSAhaXNGdWxsU2NyZWVuOwogICAgICAgIGNhbmNlbFByZXNlbnRhdGlvbk1vZGUoKTsKICAgIH0KCiAgICBmdW5jdGlvbiBzaG93T3ZlcmxheU5hdmlnYXRvcigpIHsKICAgICAgICBpZiAoaXNTbGlkZXNob3cpIHsKICAgICAgICAgICAgb3ZlcmxheU5hdmlnYXRvci5jbGFzc05hbWUgPSAndmlld2VyLXRvdWNoZWQnOwogICAgICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRvdWNoVGltZXIpOwogICAgICAgICAgICB0b3VjaFRpbWVyID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgb3ZlcmxheU5hdmlnYXRvci5jbGFzc05hbWUgPSAnJzsKICAgICAgICAgICAgfSwgVUlfRkFERV9EVVJBVElPTik7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogQHBhcmFtIHshYm9vbGVhbn0gdGltZWQgRmFkZSBhZnRlciBhIHdoaWxlCiAgICAgKi8KICAgIGZ1bmN0aW9uIHNob3dUb29sYmFycygpIHsKICAgICAgICB0aXRsZWJhci5jbGFzc0xpc3QuYWRkKCd2aWV3ZXItdG91Y2hlZCcpOwogICAgICAgIHRvb2xiYXIuY2xhc3NMaXN0LmFkZCgndmlld2VyLXRvdWNoZWQnKTsKICAgICAgICB3aW5kb3cuY2xlYXJUaW1lb3V0KHRvb2xiYXJUb3VjaFRpbWVyKTsKICAgICAgICB0b29sYmFyVG91Y2hUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaGlkZVRvb2xiYXJzKCk7CiAgICAgICAgfSwgVUlfRkFERV9EVVJBVElPTik7CiAgICB9CgogICAgZnVuY3Rpb24gaGlkZVRvb2xiYXJzKCkgewogICAgICAgIHRpdGxlYmFyLmNsYXNzTGlzdC5yZW1vdmUoJ3ZpZXdlci10b3VjaGVkJyk7CiAgICAgICAgdG9vbGJhci5jbGFzc0xpc3QucmVtb3ZlKCd2aWV3ZXItdG91Y2hlZCcpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvZ2dsZVRvb2xiYXJzKCkgewogICAgICAgIGlmICh0aXRsZWJhci5jbGFzc0xpc3QuY29udGFpbnMoJ3ZpZXdlci10b3VjaGVkJykpIHsKICAgICAgICAgICAgaGlkZVRvb2xiYXJzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc2hvd1Rvb2xiYXJzKCk7CiAgICAgICAgfQogICAgfQoKICAgIGZ1bmN0aW9uIGJsYW5rT3V0KHZhbHVlKSB7CiAgICAgICAgYmxhbmtlZC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJzsKICAgICAgICBibGFua2VkLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IHZhbHVlOwogICAgICAgIGhpZGVUb29sYmFycygpOwogICAgfQoKICAgIGZ1bmN0aW9uIGxlYXZlQmxhbmtPdXQoKSB7CiAgICAgICAgYmxhbmtlZC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgICAgIHRvZ2dsZVRvb2xiYXJzKCk7CiAgICB9CgogICAgZnVuY3Rpb24gaW5pdCgpIHsKCiAgICAgICAgaW5pdGlhbGl6ZUFib3V0SW5mb3JtYXRpb24oKTsKCiAgICAgICAgaWYgKHZpZXdlclBsdWdpbikgewogICAgICAgICAgICBzZWxmLmluaXRpYWxpemUoKTsKCiAgICAgICAgICAgIGlmICghKGRvY3VtZW50LmV4aXRGdWxsc2NyZWVuIHx8IGRvY3VtZW50LmNhbmNlbEZ1bGxTY3JlZW4gfHwgZG9jdW1lbnQubW96Q2FuY2VsRnVsbFNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRFeGl0RnVsbHNjcmVlbiB8fCBkb2N1bWVudC53ZWJraXRDYW5jZWxGdWxsU2NyZWVuIHx8IGRvY3VtZW50Lm1zRXhpdEZ1bGxzY3JlZW4pKSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZnVsbHNjcmVlbicpLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmVzZW50YXRpb24nKS5zdHlsZS52aXNpYmlsaXR5ID0gJ2hpZGRlbic7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdvdmVybGF5Q2xvc2VCdXR0b24nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHNlbGYudG9nZ2xlRnVsbFNjcmVlbik7CiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmdWxsc2NyZWVuJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzZWxmLnRvZ2dsZUZ1bGxTY3JlZW4pOwogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJlc2VudGF0aW9uJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBpZiAoIWlzRnVsbFNjcmVlbikgewogICAgICAgICAgICAgICAgICAgIHNlbGYudG9nZ2xlRnVsbFNjcmVlbigpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi50b2dnbGVQcmVzZW50YXRpb25Nb2RlKCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignZnVsbHNjcmVlbmNoYW5nZScsIGhhbmRsZUZ1bGxTY3JlZW5DaGFuZ2UpOwogICAgICAgICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd3ZWJraXRmdWxsc2NyZWVuY2hhbmdlJywgaGFuZGxlRnVsbFNjcmVlbkNoYW5nZSk7CiAgICAgICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ21vemZ1bGxzY3JlZW5jaGFuZ2UnLCBoYW5kbGVGdWxsU2NyZWVuQ2hhbmdlKTsKICAgICAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignTVNGdWxsc2NyZWVuQ2hhbmdlJywgaGFuZGxlRnVsbFNjcmVlbkNoYW5nZSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG93bmxvYWQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuZG93bmxvYWQoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnem9vbU91dCcpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi56b29tT3V0KCk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3pvb21JbicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi56b29tSW4oKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncHJldmlvdXMnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuc2hvd1ByZXZpb3VzUGFnZSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICBzZWxmLnNob3dOZXh0UGFnZSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmV2aW91c1BhZ2UnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuc2hvd1ByZXZpb3VzUGFnZSgpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0UGFnZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgc2VsZi5zaG93TmV4dFBhZ2UoKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncGFnZU51bWJlcicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgIHNlbGYuc2hvd1BhZ2UodGhpcy52YWx1ZSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NjYWxlU2VsZWN0JykuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlJywgZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgcGFyc2VTY2FsZSh0aGlzLnZhbHVlKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBjYW52YXNDb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzaG93T3ZlcmxheU5hdmlnYXRvcik7CiAgICAgICAgICAgIG92ZXJsYXlOYXZpZ2F0b3IuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzaG93T3ZlcmxheU5hdmlnYXRvcik7CiAgICAgICAgICAgIGNhbnZhc0NvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRvZ2dsZVRvb2xiYXJzKTsKICAgICAgICAgICAgdGl0bGViYXIuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBzaG93VG9vbGJhcnMpOwogICAgICAgICAgICB0b29sYmFyLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgc2hvd1Rvb2xiYXJzKTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY2FsZWNoYW5nZScsIGZ1bmN0aW9uIChldnQpIHsKICAgICAgICAgICAgICAgIHZhciBjdXN0b21TY2FsZU9wdGlvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjdXN0b21TY2FsZU9wdGlvbicpLAogICAgICAgICAgICAgICAgICAgIHByZWRlZmluZWRWYWx1ZUZvdW5kID0gc2VsZWN0U2NhbGVPcHRpb24oU3RyaW5nKGV2dC5zY2FsZSkpOwoKICAgICAgICAgICAgICAgIGN1c3RvbVNjYWxlT3B0aW9uLnNlbGVjdGVkID0gZmFsc2U7CgogICAgICAgICAgICAgICAgaWYgKCFwcmVkZWZpbmVkVmFsdWVGb3VuZCkgewogICAgICAgICAgICAgICAgICAgIGN1c3RvbVNjYWxlT3B0aW9uLnRleHRDb250ZW50ID0gTWF0aC5yb3VuZChldnQuc2NhbGUgKiAxMDAwMCkgLyAxMDAgKyAnJSc7CiAgICAgICAgICAgICAgICAgICAgY3VzdG9tU2NhbGVPcHRpb24uc2VsZWN0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LCB0cnVlKTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbGl6ZWQgJiYKICAgICAgICAgICAgICAgICAgICAgICAgICAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhZ2VXaWR0aE9wdGlvbicpLnNlbGVjdGVkIHx8CiAgICAgICAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BhZ2VBdXRvT3B0aW9uJykuc2VsZWN0ZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgcGFyc2VTY2FsZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2NhbGVTZWxlY3QnKS52YWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzaG93T3ZlcmxheU5hdmlnYXRvcigpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24gKGV2dCkgewogICAgICAgICAgICAgICAgdmFyIGtleSA9IGV2dC5rZXlDb2RlLAogICAgICAgICAgICAgICAgICAgIHNoaWZ0S2V5ID0gZXZ0LnNoaWZ0S2V5OwoKICAgICAgICAgICAgICAgIC8vIGJsYW5rZWQtb3V0IG1vZGU/CiAgICAgICAgICAgICAgICBpZiAoaXNCbGFua2VkT3V0KCkpIHsKICAgICAgICAgICAgICAgICAgICBzd2l0Y2ggKGtleSkgewogICAgICAgICAgICAgICAgICAgIGNhc2UgMTY6IC8vIFNoaWZ0CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxNzogLy8gQ3RybAogICAgICAgICAgICAgICAgICAgIGNhc2UgMTg6IC8vIEFsdAogICAgICAgICAgICAgICAgICAgIGNhc2UgOTE6IC8vIExlZnRNZXRhCiAgICAgICAgICAgICAgICAgICAgY2FzZSA5MzogLy8gUmlnaHRNZXRhCiAgICAgICAgICAgICAgICAgICAgY2FzZSAyMjQ6IC8vIE1ldGFJbk1vemlsbGEKICAgICAgICAgICAgICAgICAgICBjYXNlIDIyNTogLy8gQWx0R3IKICAgICAgICAgICAgICAgICAgICAgICAgLy8gaWdub3JlIG1vZGlmaWVyIGtleXMgYWxvbmUKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgICAgICAgICAgICAgbGVhdmVCbGFua091dCgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA4OiAvLyBiYWNrc3BhY2UKICAgICAgICAgICAgICAgICAgICBjYXNlIDMzOiAvLyBwYWdlVXAKICAgICAgICAgICAgICAgICAgICBjYXNlIDM3OiAvLyBsZWZ0IGFycm93CiAgICAgICAgICAgICAgICAgICAgY2FzZSAzODogLy8gdXAgYXJyb3cKICAgICAgICAgICAgICAgICAgICBjYXNlIDgwOiAvLyBrZXkgJ3AnCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2hvd1ByZXZpb3VzUGFnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDEzOiAvLyBlbnRlcgogICAgICAgICAgICAgICAgICAgIGNhc2UgMzQ6IC8vIHBhZ2VEb3duCiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOTogLy8gcmlnaHQgYXJyb3cKICAgICAgICAgICAgICAgICAgICBjYXNlIDQwOiAvLyBkb3duIGFycm93CiAgICAgICAgICAgICAgICAgICAgY2FzZSA3ODogLy8ga2V5ICduJwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dOZXh0UGFnZSgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDMyOiAvLyBzcGFjZQogICAgICAgICAgICAgICAgICAgICAgICBzaGlmdEtleSA/IHNlbGYuc2hvd1ByZXZpb3VzUGFnZSgpIDogc2VsZi5zaG93TmV4dFBhZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgY2FzZSA2NjogIC8vIGtleSAnYicgYmxhbmtzIHNjcmVlbiAodG8gYmxhY2spIG9yIHJldHVybnMgdG8gdGhlIGRvY3VtZW50CiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOTA6IC8vIGFuZCBzbyBkb2VzIHRoZSBrZXkgJy4nIChkb3QpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwcmVzZW50YXRpb25Nb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBibGFua091dCgnIzAwMCcpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIGNhc2UgODc6ICAvLyBrZXkgJ3cnIGJsYW5rcyBwYWdlICh0byB3aGl0ZSkgb3IgcmV0dXJucyB0byB0aGUgZG9jdW1lbnQKICAgICAgICAgICAgICAgICAgICBjYXNlIDE4ODogLy8gYW5kIHNvIGRvZXMgdGhlIGtleSAnLCcgKGNvbW1hKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJlc2VudGF0aW9uTW9kZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYmxhbmtPdXQoJyNGRkYnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM2OiAvLyBrZXkgJ0hvbWUnIGdvZXMgdG8gZmlyc3QgcGFnZQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNob3dQYWdlKDApOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICBjYXNlIDM1OiAvLyBrZXkgJ0VuZCcgZ29lcyB0byBsYXN0IHBhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zaG93UGFnZShwYWdlcy5sZW5ndGgpOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KCiAgICBpbml0KCk7Cn0K",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Sun, 09 Nov 2014 02:39:55 GMT",
                    "Content-Length": "23649",
                    "Date": "Sun, 09 Nov 2014 02:39:56 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}