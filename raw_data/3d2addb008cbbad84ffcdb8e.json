{
    "url": "http://localhost:9999/miguelmota/inview/node_modules/grunt/node_modules/underscore.string/test/test_underscore/vendor/qunit.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Cross-site scripting (DOM-based)",
    "issueType": 2097936,
    "severity": "High",
    "confidence": "Firm",
    "issueBackground": "DOM-based cross-site scripting vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the HTML document in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause JavaScript code supplied by the attacker to execute within the user's browser in the context of that user's session with the application.<br><br>The attacker-supplied code can perform a wide variety of actions, such as stealing the victim's session token or login credentials, performing arbitrary actions on the victim's behalf, and logging their keystrokes.<br><br>Users can be induced to visit the attacker's crafted URL in various ways, similar to the usual attack delivery vectors for reflected cross-site scripting vulnerabilities. ",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based cross-site scripting vulnerabilities is not to dynamically write data into the HTML document that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing script code into the document. In many cases, the relevant data can be validated on a whitelist basis, to allow only content that is known to be safe. In other cases, it will be necessary to sanitize or encode the data. This can be a complex task, and depending on the context that the data is to be inserted may need to involve a combination of JavaScript escaping, HTML encoding, and URL encoding, in the appropriate sequence.",
    "issueDetail": "The application may be vulnerable to DOM-based cross-site scripting. Data is read from <b>location.href</b> and written to <b>the 'innerHTML' property of a DOM element</b> via the following statements:<ul><li>var mainPageLocation = location.href.slice(0, paramsIndex);</li><li>banner.innerHTML = '&lt;a href=\"' + mainPageLocation + '\"&gt;' + banner.innerHTML + '&lt;/a&gt; &amp;#8250; &lt;a href=\"\"&gt;' + testName + '&lt;/a&gt;';</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/miguelmota/inview/node_modules/grunt/node_modules/underscore.string/test/test_underscore/vendor/qunit.js",
                "path": "/miguelmota/inview/node_modules/grunt/node_modules/underscore.string/test/test_underscore/vendor/qunit.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9taWd1ZWxtb3RhL2ludmlldy9ub2RlX21vZHVsZXMvZ3J1bnQvbm9kZV9tb2R1bGVzL3VuZGVyc2NvcmUuc3RyaW5nL3Rlc3QvdGVzdF91bmRlcnNjb3JlL3ZlbmRvci9xdW5pdC5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjI4MDkNCkFjY2VwdC1SYW5nZXM6IGJ5dGVzDQpDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2phdmFzY3JpcHQNCkRhdGU6IEZyaSwgMDcgTm92IDIwMTQgMDU6MDM6MzUgR01UDQpMYXN0LU1vZGlmaWVkOiBGcmksIDA3IE5vdiAyMDE0IDA1OjAzOjIyIEdNVA0KDQovKgogKiBRVW5pdCAtIEEgSmF2YVNjcmlwdCBVbml0IFRlc3RpbmcgRnJhbWV3b3JrCiAqCiAqIGh0dHA6Ly9kb2NzLmpxdWVyeS5jb20vUVVuaXQKICoKICogQ29weXJpZ2h0IChjKSAyMDA5IEpvaG4gUmVzaWcsIErDtnJuIFphZWZmZXJlcgogKiBEdWFsIGxpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgKE1JVC1MSUNFTlNFLnR4dCkKICogYW5kIEdQTCAoR1BMLUxJQ0VOU0UudHh0KSBsaWNlbnNlcy4KICovCgooZnVuY3Rpb24od2luZG93KSB7Cgp2YXIgUVVuaXQgPSB7CgoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlndXJhdGlvbiBvcHRpb25zCglpbml0OiBmdW5jdGlvbiBpbml0KCkgewoJCWNvbmZpZyA9IHsKCQkJc3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJbW9kdWxlU3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJc3RhcnRlZDogK25ldyBEYXRlLAoJCQlibG9ja2luZzogZmFsc2UsCgkJCWF1dG9ydW46IGZhbHNlLAoJCQlhc3NlcnRpb25zOiBbXSwKCQkJZmlsdGVyczogW10sCgkJCXF1ZXVlOiBbXQoJCX07CgoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAoJCQliYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCgkJCXJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgoJCWlmICggdGVzdHMgKSB7CgkJCXRlc3RzLmlubmVySFRNTCA9ICIiOwoJCX0KCgkJaWYgKCBiYW5uZXIgKSB7CgkJCWJhbm5lci5jbGFzc05hbWUgPSAiIjsKCQl9CgoJCWlmICggcmVzdWx0ICkgewoJCQlyZXN1bHQucGFyZW50Tm9kZS5yZW1vdmVDaGlsZCggcmVzdWx0ICk7CgkJfQoJfSwKCgkvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKCW1vZHVsZTogZnVuY3Rpb24gbW9kdWxlKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgewoKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQkJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7CgkJCX0KCgkJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCQkJY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCA9IHRlc3RFbnZpcm9ubWVudDsKCQkJY29uZmlnLm1vZHVsZVN0YXRzID0geyBhbGw6IDAsIGJhZDogMCB9OwoKCQkJUVVuaXQubW9kdWxlU3RhcnQoIG5hbWUsIHRlc3RFbnZpcm9ubWVudCApOwoJCX0pOwoJfSwKCglhc3luY1Rlc3Q6IGZ1bmN0aW9uIGFzeW5jVGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrKSB7CgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IDA7CgkJfQoKCQlRVW5pdC50ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIHRydWUpOwoJfSwKCgl0ZXN0OiBmdW5jdGlvbiB0ZXN0KHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIGFzeW5jKSB7CgkJdmFyIG5hbWUgPSB0ZXN0TmFtZSwgdGVzdEVudmlyb25tZW50ID0ge307CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSBudWxsOwoJCX0KCgkJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQkJbmFtZSA9IGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIiBtb2R1bGU6ICIgKyBuYW1lOwoJCX0KCgkJaWYgKCAhdmFsaWRUZXN0KG5hbWUpICkgewoJCQlyZXR1cm47CgkJfQoKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJUVVuaXQudGVzdFN0YXJ0KCB0ZXN0TmFtZSApOwoKCQkJdGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsKCQkJCXNldHVwOiBmdW5jdGlvbigpIHt9LAoJCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkge30KCQkJfSwgY29uZmlnLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7CgoJCQljb25maWcuYXNzZXJ0aW9ucyA9IFtdOwoJCQljb25maWcuZXhwZWN0ZWQgPSBudWxsOwoKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID49IDMgKSB7CgkJCQljb25maWcuZXhwZWN0ZWQgPSBjYWxsYmFjazsKCQkJCWNhbGxiYWNrID0gYXJndW1lbnRzWzJdOwoJCQl9CgoJCQl0cnkgewoJCQkJaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKCQkJCQlzYXZlR2xvYmFsKCk7CgkJCQl9CgoJCQkJdGVzdEVudmlyb25tZW50LnNldHVwLmNhbGwodGVzdEVudmlyb25tZW50KTsKCQkJfSBjYXRjaChlKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJTZXR1cCBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJCX0KCgkJCWlmICggYXN5bmMgKSB7CgkJCQlRVW5pdC5zdG9wKCk7CgkJCX0KCgkJCXRyeSB7CgkJCQljYWxsYmFjay5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJZmFpbCgiVGVzdCAiICsgbmFtZSArICIgZGllZCwgZXhjZXB0aW9uIGFuZCB0ZXN0IGZvbGxvd3MiLCBlLCBjYWxsYmFjayk7CgkJCQlRVW5pdC5vayggZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAoY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJCQkvLyBlbHNlIG5leHQgdGVzdCB3aWxsIGNhcnJ5IHRoZSByZXNwb25zaWJpbGl0eQoJCQkJc2F2ZUdsb2JhbCgpOwoKCQkJCS8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcKCQkJCWlmICggY29uZmlnLmJsb2NraW5nICkgewoJCQkJCXN0YXJ0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCXRyeSB7CgkJCQljaGVja1BvbGx1dGlvbigpOwoJCQkJdGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGVzdEVudmlyb25tZW50KTsKCQkJfSBjYXRjaChlKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJUZWFyZG93biBmYWlsZWQgb24gIiArIG5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJCX0KCgkJCXRyeSB7CgkJCQlRVW5pdC5yZXNldCgpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCWZhaWwoInJlc2V0KCkgZmFpbGVkLCBmb2xsb3dpbmcgVGVzdCAiICsgbmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIHJlc2V0KTsKCQkJfQoKCQkJaWYgKCBjb25maWcuZXhwZWN0ZWQgJiYgY29uZmlnLmV4cGVjdGVkICE9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIkV4cGVjdGVkICIgKyBjb25maWcuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKCQkJfQoKCQkJdmFyIGdvb2QgPSAwLCBiYWQgPSAwLAoJCQkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsKCgkJCWNvbmZpZy5zdGF0cy5hbGwgKz0gY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOwoJCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKCgkJCWlmICggdGVzdHMgKSB7CgkJCQl2YXIgb2wgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgib2wiKTsKCQkJCW9sLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CgkJCQkJdmFyIGFzc2VydGlvbiA9IGNvbmZpZy5hc3NlcnRpb25zW2ldOwoKCQkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJCWxpLmNsYXNzTmFtZSA9IGFzc2VydGlvbi5yZXN1bHQgPyAicGFzcyIgOiAiZmFpbCI7CgkJCQkJbGkuaW5uZXJIVE1MID0gYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgIihubyBtZXNzYWdlKSI7CgkJCQkJb2wuYXBwZW5kQ2hpbGQoIGxpICk7CgoJCQkJCWlmICggYXNzZXJ0aW9uLnJlc3VsdCApIHsKCQkJCQkJZ29vZCsrOwoJCQkJCX0gZWxzZSB7CgkJCQkJCWJhZCsrOwoJCQkJCQljb25maWcuc3RhdHMuYmFkKys7CgkJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCQl9CgkJCQl9CgoJCQkJdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKCQkJCWIuaW5uZXJIVE1MID0gbmFtZSArICIgPGIgc3R5bGU9J2NvbG9yOmJsYWNrOyc+KDxiIGNsYXNzPSdmYWlsJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzJz4iICsgZ29vZCArICI8L2I+LCAiICsgY29uZmlnLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsKCgkJCQlhZGRFdmVudChiLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJCQl2YXIgbmV4dCA9IGIubmV4dFNpYmxpbmcsIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7CgkJCQkJbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKCQkJCX0pOwoKCQkJCWFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKGUpIHsKCQkJCQl2YXIgdGFyZ2V0ID0gKGUgfHwgd2luZG93LmV2ZW50KS50YXJnZXQ7CgkJCQkJaWYgKCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN0cm9uZyIgKSB7CgkJCQkJCXZhciB0ZXh0ID0gIiIsIG5vZGUgPSB0YXJnZXQuZmlyc3RDaGlsZDsKCgkJCQkJCXdoaWxlICggbm9kZS5ub2RlVHlwZSA9PT0gMyApIHsKCQkJCQkJCXRleHQgKz0gbm9kZS5ub2RlVmFsdWU7CgkJCQkJCQlub2RlID0gbm9kZS5uZXh0U2libGluZzsKCQkJCQkJfQoKCQkJCQkJdGV4dCA9IHRleHQucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpOwoKCQkJCQkJaWYgKCB3aW5kb3cubG9jYXRpb24gKSB7CgkJCQkJCQl3aW5kb3cubG9jYXRpb24uaHJlZiA9IHdpbmRvdy5sb2NhdGlvbi5ocmVmLm1hdGNoKC9eKC4rPykoXD8uKik/JC8pWzFdICsgIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KHRleHQpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgoJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQkJCWxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKCQkJCWxpLmFwcGVuZENoaWxkKCBiICk7CgkJCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsKCQkJCXRlc3RzLmFwcGVuZENoaWxkKCBsaSApOwoKCQkJCWlmICggYmFkICkgewoJCQkJCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJCQkJCWlmICggdG9vbGJhciApIHsKCQkJCQkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQkJaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOwoJCQkJCQlpZCgicXVuaXQtZmlsdGVyLW1pc3NpbmciKS5kaXNhYmxlZCA9IG51bGw7CgkJCQkJfQoJCQkJfQoKCQkJfSBlbHNlIHsKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJCWlmICggIWNvbmZpZy5hc3NlcnRpb25zW2ldLnJlc3VsdCApIHsKCQkJCQkJYmFkKys7CgkJCQkJCWNvbmZpZy5zdGF0cy5iYWQrKzsKCQkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJUVVuaXQudGVzdERvbmUoIHRlc3ROYW1lLCBiYWQsIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCApOwoKCQkJaWYgKCAhd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CgkJCQlkb25lKCk7CgkJCX0KCQl9KTsKCgkJaWYgKCB3aW5kb3cuc2V0VGltZW91dCAmJiAhY29uZmlnLmRvbmVUaW1lciApIHsKCQkJY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCQlpZiAoICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJCWRvbmUoKTsKCQkJCX0gZWxzZSB7CgkJCQkJc3luY2hyb25pemUoIGRvbmUgKTsKCQkJCX0KCQkJfSwgMTMpOwoJCX0KCX0sCgoJLyoqCgkgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCgkgKi8KCWV4cGVjdDogZnVuY3Rpb24gZXhwZWN0KGFzc2VydHMpIHsKCQljb25maWcuZXhwZWN0ZWQgPSBhc3NlcnRzOwoJfSwKCgkvKioKCSAqIEFzc2VydHMgdHJ1ZS4KCSAqIEBleGFtcGxlIG9rKCAiYXNkZmFzZGYiLmxlbmd0aCA+IDUsICJUaGVyZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnMiICk7CgkgKi8KCW9rOiBmdW5jdGlvbiBvayhhLCBtc2cpIHsKCQlRVW5pdC5sb2coYSwgbXNnKTsKCgkJY29uZmlnLmFzc2VydGlvbnMucHVzaCh7CgkJCXJlc3VsdDogISFhLAoJCQltZXNzYWdlOiBtc2cKCQl9KTsKCX0sCgoJLyoqCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KCSAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KCSAqCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKCSAqCgkgKiBAZXhhbXBsZSBlcXVhbHMoIGZvcm1hdCgiUmVjZWl2ZWQgezB9IGJ5dGVzLiIsIDIpLCAiUmVjZWl2ZWQgMiBieXRlcy4iICk7CgkgKgoJICogQHBhcmFtIE9iamVjdCBhY3R1YWwKCSAqIEBwYXJhbSBPYmplY3QgZXhwZWN0ZWQKCSAqIEBwYXJhbSBTdHJpbmcgbWVzc2FnZSAob3B0aW9uYWwpCgkgKi8KCWVxdWFsczogZnVuY3Rpb24gZXF1YWxzKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlwdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCXNhbWU6IGZ1bmN0aW9uKGEsIGIsIG1lc3NhZ2UpIHsKCQlwdXNoKFFVbml0LmVxdWl2KGEsIGIpLCBhLCBiLCBtZXNzYWdlKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uIHN0YXJ0KCkgewoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKCQlpZiAoIHdpbmRvdy5zZXRUaW1lb3V0ICkgewoJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWlmICggY29uZmlnLnRpbWVvdXQgKSB7CgkJCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKCQkJCX0KCgkJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJCXByb2Nlc3MoKTsKCQkJfSwgMTMpOwoJCX0gZWxzZSB7CgkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCQlwcm9jZXNzKCk7CgkJfQoJfSwKCglzdG9wOiBmdW5jdGlvbiBzdG9wKHRpbWVvdXQpIHsKCQljb25maWcuYmxvY2tpbmcgPSB0cnVlOwoKCQlpZiAoIHRpbWVvdXQgJiYgd2luZG93LnNldFRpbWVvdXQgKSB7CgkJCWNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJUZXN0IHRpbWVkIG91dCIgKTsKCQkJCVFVbml0LnN0YXJ0KCk7CgkJCX0sIHRpbWVvdXQpOwoJCX0KCX0sCgoJLyoqCgkgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KCSAqLwoJcmVzZXQ6IGZ1bmN0aW9uIHJlc2V0KCkgewoJCWlmICggd2luZG93LmpRdWVyeSApIHsKCQkJalF1ZXJ5KCIjbWFpbiIpLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7CgkJCWpRdWVyeS5ldmVudC5nbG9iYWwgPSB7fTsKCQkJalF1ZXJ5LmFqYXhTZXR0aW5ncyA9IGV4dGVuZCh7fSwgY29uZmlnLmFqYXhTZXR0aW5ncyk7CgkJfQoJfSwKCgkvKioKCSAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KCSAqCgkgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKCSAqCgkgKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtCgkgKiBAcGFyYW0gU3RyaW5nIHR5cGUKCSAqLwoJdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiB0cmlnZ2VyRXZlbnQoIGVsZW0sIHR5cGUsIGV2ZW50ICkgewoJCWlmICggZG9jdW1lbnQuY3JlYXRlRXZlbnQgKSB7CgkJCWV2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQoIk1vdXNlRXZlbnRzIik7CgkJCWV2ZW50LmluaXRNb3VzZUV2ZW50KHR5cGUsIHRydWUsIHRydWUsIGVsZW0ub3duZXJEb2N1bWVudC5kZWZhdWx0VmlldywKCQkJCTAsIDAsIDAsIDAsIDAsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCAwLCBudWxsKTsKCQkJZWxlbS5kaXNwYXRjaEV2ZW50KCBldmVudCApOwoKCQl9IGVsc2UgaWYgKCBlbGVtLmZpcmVFdmVudCApIHsKCQkJZWxlbS5maXJlRXZlbnQoIm9uIit0eXBlKTsKCQl9Cgl9LAoKCS8vIExvZ2dpbmcgY2FsbGJhY2tzCglkb25lOiBmdW5jdGlvbiBkb25lKGZhaWx1cmVzLCB0b3RhbCkge30sCglsb2c6IGZ1bmN0aW9uIGxvZyhyZXN1bHQsIG1lc3NhZ2UpIHt9LAoJdGVzdFN0YXJ0OiBmdW5jdGlvbiB0ZXN0U3RhcnQobmFtZSkge30sCgl0ZXN0RG9uZTogZnVuY3Rpb24gdGVzdERvbmUobmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fSwKCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbiBtb2R1bGVTdGFydChuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LAoJbW9kdWxlRG9uZTogZnVuY3Rpb24gbW9kdWxlRG9uZShuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9Cn07CgovLyBNYWludGFpbiBpbnRlcm5hbCBzdGF0ZQp2YXIgY29uZmlnID0gewoJLy8gVGhlIHF1ZXVlIG9mIHRlc3RzIHRvIHJ1bgoJcXVldWU6IFtdLAoKCS8vIGJsb2NrIHVudGlsIGRvY3VtZW50IHJlYWR5CglibG9ja2luZzogdHJ1ZQp9OwoKLy8gTG9hZCBwYXJhbWF0ZXJzCihmdW5jdGlvbigpIHsKCXZhciBsb2NhdGlvbiA9IHdpbmRvdy5sb2NhdGlvbiB8fCB7IHNlYXJjaDogIiIsIHByb3RvY29sOiAiZmlsZToiIH0sCgkJR0VUUGFyYW1zID0gbG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpLnNwbGl0KCcmJyk7CgoJZm9yICggdmFyIGkgPSAwOyBpIDwgR0VUUGFyYW1zLmxlbmd0aDsgaSsrICkgewoJCUdFVFBhcmFtc1tpXSA9IGRlY29kZVVSSUNvbXBvbmVudCggR0VUUGFyYW1zW2ldICk7CgkJaWYgKCBHRVRQYXJhbXNbaV0gPT09ICJub2dsb2JhbHMiICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQkJY29uZmlnLm5vZ2xvYmFscyA9IHRydWU7CgkJfQoJfQoKCS8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOwoKCS8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgcnVubmluZyB0aGUgdGVzdHMgZnJvbSBhIHNlcnZlciBvciBub3QKCVFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7Cn0pKCk7CgovLyBFeHBvc2UgdGhlIEFQSSBhcyBnbG9iYWwgdmFyaWFibGVzLCB1bmxlc3MgYW4gJ2V4cG9ydHMnCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMKaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHJlcXVpcmUgPT09ICJ1bmRlZmluZWQiICkgewoJZXh0ZW5kKHdpbmRvdywgUVVuaXQpOwoJd2luZG93LlFVbml0ID0gUVVuaXQ7Cn0gZWxzZSB7CglleHRlbmQoZXhwb3J0cywgUVVuaXQpOwoJZXhwb3J0cy5RVW5pdCA9IFFVbml0Owp9CgppZiAoIHR5cGVvZiBkb2N1bWVudCA9PT0gInVuZGVmaW5lZCIgfHwgZG9jdW1lbnQucmVhZHlTdGF0ZSA9PT0gImNvbXBsZXRlIiApIHsKCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKfQoKYWRkRXZlbnQod2luZG93LCAibG9hZCIsIGZ1bmN0aW9uKCkgewoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQoJdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKCVFVbml0LmluaXQoKTsKCWV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7CgoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgoJdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKCWlmICggdXNlckFnZW50ICkgewoJCXVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJfQoKCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJaWYgKCB0b29sYmFyICkgewoJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCgkJdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkJZmlsdGVyLnR5cGUgPSAiY2hlY2tib3giOwoJCWZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7CgkJZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsKCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigicGFzcyIpID4gLTEgKSB7CgkJCQkJbGlbaV0uc3R5bGUuZGlzcGxheSA9IGZpbHRlci5jaGVja2VkID8gIm5vbmUiIDogImJsb2NrIjsKCQkJCX0KCQkJfQoJCX0pOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOwoKCQl2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgImZpbHRlci1wYXNzIik7CgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgcGFzc2VkIHRlc3RzIjsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoKCQl2YXIgbWlzc2luZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkJbWlzc2luZy50eXBlID0gImNoZWNrYm94IjsKCQltaXNzaW5nLmlkID0gInF1bml0LWZpbHRlci1taXNzaW5nIjsKCQltaXNzaW5nLmRpc2FibGVkID0gdHJ1ZTsKCQlhZGRFdmVudCggbWlzc2luZywgImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOwoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoImZhaWwiKSA+IC0xICYmIGxpW2ldLmlubmVySFRNTC5pbmRleE9mKCdtaXNzaW5nIHRlc3QgLSB1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlJykgPiAtIDEgKSB7CgkJCQkJbGlbaV0ucGFyZW50Tm9kZS5wYXJlbnROb2RlLnN0eWxlLmRpc3BsYXkgPSBtaXNzaW5nLmNoZWNrZWQgPyAibm9uZSIgOiAiYmxvY2siOwoJCQkJfQoJCQl9CgkJfSk7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbWlzc2luZyApOwoKCQlsYWJlbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxhYmVsIik7CgkJbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCAiZmlsdGVyLW1pc3NpbmciKTsKCQlsYWJlbC5pbm5lckhUTUwgPSAiSGlkZSBtaXNzaW5nIHRlc3RzICh1bnRlc3RlZCBjb2RlIGlzIGJyb2tlbiBjb2RlKSI7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsKCX0KCgl2YXIgbWFpbiA9IGlkKCdtYWluJyk7CglpZiAoIG1haW4gKSB7CgkJY29uZmlnLmZpeHR1cmUgPSBtYWluLmlubmVySFRNTDsKCX0KCglpZiAoIHdpbmRvdy5qUXVlcnkgKSB7CgkJY29uZmlnLmFqYXhTZXR0aW5ncyA9IHdpbmRvdy5qUXVlcnkuYWpheFNldHRpbmdzOwoJfQoKCVFVbml0LnN0YXJ0KCk7Cn0pOwoKZnVuY3Rpb24gZG9uZSgpIHsKCWlmICggY29uZmlnLmRvbmVUaW1lciAmJiB3aW5kb3cuY2xlYXJUaW1lb3V0ICkgewoJCXdpbmRvdy5jbGVhclRpbWVvdXQoIGNvbmZpZy5kb25lVGltZXIgKTsKCQljb25maWcuZG9uZVRpbWVyID0gbnVsbDsKCX0KCglpZiAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CgkJY29uZmlnLmRvbmVUaW1lciA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCl7CgkJCWlmICggIWNvbmZpZy5xdWV1ZS5sZW5ndGggKSB7CgkJCQlkb25lKCk7CgkJCX0gZWxzZSB7CgkJCQlzeW5jaHJvbml6ZSggZG9uZSApOwoJCQl9CgkJfSwgMTMpOwoKCQlyZXR1cm47Cgl9CgoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOwoKCS8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cwoJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQlRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOwoJfQoKCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCgkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKCQlodG1sID0gWydUZXN0cyBjb21wbGV0ZWQgaW4gJywKCQkrbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAoJCSc8c3BhbiBjbGFzcz0iYmFkIj4nLCBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9ImFsbCI+JywgY29uZmlnLnN0YXRzLmFsbCwgJzwvc3Bhbj4gcGFzc2VkLCAnLCBjb25maWcuc3RhdHMuYmFkLCcgZmFpbGVkLiddLmpvaW4oJycpOwoKCWlmICggYmFubmVyICkgewoJCWJhbm5lci5jbGFzc05hbWUgKz0gIiAiICsgKGNvbmZpZy5zdGF0cy5iYWQgPyAiZmFpbCIgOiAicGFzcyIpOwoJfQoKCWlmICggdGVzdHMgKSB7CgkJdmFyIHJlc3VsdCA9IGlkKCJxdW5pdC10ZXN0cmVzdWx0Iik7CgoJCWlmICggIXJlc3VsdCApIHsKCQkJcmVzdWx0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgicCIpOwoJCQlyZXN1bHQuaWQgPSAicXVuaXQtdGVzdHJlc3VsdCI7CgkJCXJlc3VsdC5jbGFzc05hbWUgPSAicmVzdWx0IjsKCQkJdGVzdHMucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIHJlc3VsdCwgdGVzdHMubmV4dFNpYmxpbmcgKTsKCQl9CgoJCXJlc3VsdC5pbm5lckhUTUwgPSBodG1sOwoJfQoKCVFVbml0LmRvbmUoIGNvbmZpZy5zdGF0cy5iYWQsIGNvbmZpZy5zdGF0cy5hbGwgKTsKfQoKZnVuY3Rpb24gdmFsaWRUZXN0KCBuYW1lICkgewoJdmFyIGkgPSBjb25maWcuZmlsdGVycy5sZW5ndGgsCgkJcnVuID0gZmFsc2U7CgoJaWYgKCAhaSApIHsKCQlyZXR1cm4gdHJ1ZTsKCX0KCgl3aGlsZSAoIGktLSApIHsKCQl2YXIgZmlsdGVyID0gY29uZmlnLmZpbHRlcnNbaV0sCgkJCW5vdCA9IGZpbHRlci5jaGFyQXQoMCkgPT0gJyEnOwoKCQlpZiAoIG5vdCApIHsKCQkJZmlsdGVyID0gZmlsdGVyLnNsaWNlKDEpOwoJCX0KCgkJaWYgKCBuYW1lLmluZGV4T2YoZmlsdGVyKSAhPT0gLTEgKSB7CgkJCXJldHVybiAhbm90OwoJCX0KCgkJaWYgKCBub3QgKSB7CgkJCXJ1biA9IHRydWU7CgkJfQoJfQoKCXJldHVybiBydW47Cn0KCmZ1bmN0aW9uIHB1c2gocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgltZXNzYWdlID0gbWVzc2FnZSB8fCAocmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJUVVuaXQub2soIHJlc3VsdCwgcmVzdWx0ID8gbWVzc2FnZSArICI6ICIgKyBleHBlY3RlZCA6IG1lc3NhZ2UgKyAiLCBleHBlY3RlZDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShleHBlY3RlZCkgKyAiIHJlc3VsdDogIiArIFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpICk7Cn0KCmZ1bmN0aW9uIHN5bmNocm9uaXplKCBjYWxsYmFjayApIHsKCWNvbmZpZy5xdWV1ZS5wdXNoKCBjYWxsYmFjayApOwoKCWlmICggY29uZmlnLmF1dG9ydW4gJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQlwcm9jZXNzKCk7Cgl9Cn0KCmZ1bmN0aW9uIHByb2Nlc3MoKSB7Cgl3aGlsZSAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQljb25maWcucXVldWUuc2hpZnQoKSgpOwoJfQp9CgpmdW5jdGlvbiBzYXZlR2xvYmFsKCkgewoJY29uZmlnLnBvbGx1dGlvbiA9IFtdOwoKCWlmICggY29uZmlnLm5vZ2xvYmFscyApIHsKCQlmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsKCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICkgewoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247CglzYXZlR2xvYmFsKCk7CgoJdmFyIG5ld0dsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsKCWlmICggbmV3R2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7CgkJY29uZmlnLmV4cGVjdGVkKys7Cgl9CgoJdmFyIGRlbGV0ZWRHbG9iYWxzID0gZGlmZiggY29uZmlnLnBvbGx1dGlvbiwgb2xkICk7CglpZiAoIGRlbGV0ZWRHbG9iYWxzLmxlbmd0aCA+IDAgKSB7CgkJb2soIGZhbHNlLCAiRGVsZXRlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBkZWxldGVkR2xvYmFscy5qb2luKCIsICIpICk7CgkJY29uZmlnLmV4cGVjdGVkKys7Cgl9Cn0KCi8vIHJldHVybnMgYSBuZXcgQXJyYXkgd2l0aCB0aGUgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBidXQgbm90IGluIGIKZnVuY3Rpb24gZGlmZiggYSwgYiApIHsKCXZhciByZXN1bHQgPSBhLnNsaWNlKCk7Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKysgKSB7CgkJZm9yICggdmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKyApIHsKCQkJaWYgKCByZXN1bHRbaV0gPT09IGJbal0gKSB7CgkJCQlyZXN1bHQuc3BsaWNlKGksIDEpOwoJCQkJaS0tOwoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9CglyZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBmYWlsKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2spIHsKCWlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCWNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CgkJY29uc29sZS5lcnJvcihleGNlcHRpb24pOwoJCWNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsKCgl9IGVsc2UgaWYgKCB3aW5kb3cub3BlcmEgJiYgb3BlcmEucG9zdEVycm9yICkgewoJCW9wZXJhLnBvc3RFcnJvcihtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrLnRvU3RyaW5nKTsKCX0KfQoKZnVuY3Rpb24gZXh0ZW5kKGEsIGIpIHsKCWZvciAoIHZhciBwcm9wIGluIGIgKSB7CgkJYVtwcm9wXSA9IGJbcHJvcF07Cgl9CgoJcmV0dXJuIGE7Cn0KCmZ1bmN0aW9uIGFkZEV2ZW50KGVsZW0sIHR5cGUsIGZuKSB7CglpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwoJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsKCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZm4gKTsKCX0gZWxzZSB7CgkJZm4oKTsKCX0KfQoKZnVuY3Rpb24gaWQobmFtZSkgewoJcmV0dXJuICEhKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpICYmCgkJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG5hbWUgKTsKfQoKLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMOpIDxwcmF0aGVAZ21haWwuY29tPgpRVW5pdC5lcXVpdiA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24KICAgIHZhciBjYWxsZXJzID0gW107IC8vIHN0YWNrIHRvIGRlY2lkZSBiZXR3ZWVuIHNraXAvYWJvcnQgZnVuY3Rpb25zCgoKICAgIC8vIERldGVybWluZSB3aGF0IGlzIG8uCiAgICBmdW5jdGlvbiBob296aXQobykgewogICAgICAgIGlmIChvLmNvbnN0cnVjdG9yID09PSBTdHJpbmcpIHsKICAgICAgICAgICAgcmV0dXJuICJzdHJpbmciOwoKICAgICAgICB9IGVsc2UgaWYgKG8uY29uc3RydWN0b3IgPT09IEJvb2xlYW4pIHsKICAgICAgICAgICAgcmV0dXJuICJib29sZWFuIjsKCiAgICAgICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBOdW1iZXIpIHsKCiAgICAgICAgICAgIGlmIChpc05hTihvKSkgewogICAgICAgICAgICAgICAgcmV0dXJuICJuYW4iOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuICJudW1iZXIiOwogICAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJ1bmRlZmluZWQiKSB7CiAgICAgICAgICAgIHJldHVybiAidW5kZWZpbmVkIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QKICAgICAgICB9IGVsc2UgaWYgKG8gPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuICJudWxsIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IHR5cGVvZiBbXSA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgcmV0dXJuICJhcnJheSI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbmV3IERhdGUoKSA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICByZXR1cm4gImRhdGUiOwoKICAgICAgICAvLyBjb25zaWRlcjogLy4vIGluc3RhbmNlb2YgT2JqZWN0OwogICAgICAgIC8vICAgICAgICAgICAvLi8gaW5zdGFuY2VvZiBSZWdFeHA7CiAgICAgICAgLy8gICAgICAgICAgdHlwZW9mIC8uLyA9PT0gImZ1bmN0aW9uIjsgLy8gPT4gZmFsc2UgaW4gSUUgYW5kIE9wZXJhLAogICAgICAgIC8vICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ1ZSBpbiBGRiBhbmQgU2FmYXJpCiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiAicmVnZXhwIjsKCiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgbyA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgcmV0dXJuICJvYmplY3QiOwoKICAgICAgICB9IGVsc2UgaWYgKG8gaW5zdGFuY2VvZiBGdW5jdGlvbikgewogICAgICAgICAgICByZXR1cm4gImZ1bmN0aW9uIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0KICAgIH0KCiAgICAvLyBDYWxsIHRoZSBvIHJlbGF0ZWQgY2FsbGJhY2sgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzLgogICAgZnVuY3Rpb24gaGFuZGxlRXZlbnRzKG8sIGNhbGxiYWNrcywgYXJncykgewogICAgICAgIHZhciBwcm9wID0gaG9veml0KG8pOwogICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgIGlmIChob296aXQoY2FsbGJhY2tzW3Byb3BdKSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXS5hcHBseShjYWxsYmFja3MsIGFyZ3MpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxiYWNrc1twcm9wXTsgLy8gb3IgdW5kZWZpbmVkCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgdmFyIGNhbGxiYWNrcyA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgLy8gZm9yIHN0cmluZywgYm9vbGVhbiwgbnVtYmVyIGFuZCBudWxsCiAgICAgICAgZnVuY3Rpb24gdXNlU3RyaWN0RXF1YWxpdHkoYiwgYSkgewogICAgICAgICAgICBpZiAoYiBpbnN0YW5jZW9mIGEuY29uc3RydWN0b3IgfHwgYSBpbnN0YW5jZW9mIGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgIC8vIHRvIGNhdGNoIHNob3J0IGFubm90YWlvbiBWUyAnbmV3JyBhbm5vdGF0aW9uIG9mIGEgZGVjbGFyYXRpb24KICAgICAgICAgICAgICAgIC8vIGUuZy4gdmFyIGkgPSAxOwogICAgICAgICAgICAgICAgLy8gICAgICB2YXIgaiA9IG5ldyBOdW1iZXIoMSk7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PSBiOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT09IGI7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJzdHJpbmciOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgImJvb2xlYW4iOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bWJlciI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVsbCI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAidW5kZWZpbmVkIjogdXNlU3RyaWN0RXF1YWxpdHksCgogICAgICAgICAgICAibmFuIjogZnVuY3Rpb24gKGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBpc05hTihiKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJkYXRlIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAicmVnZXhwIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBob296aXQoYikgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwKICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgIGlmICggISAoaG9veml0KGIpID09PSAiYXJyYXkiKSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBsZW4gPSBhLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmIChsZW4gIT09IGIubGVuZ3RoKSB7IC8vIHNhZmUgYW5kIGZhc3RlcgogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGlmICggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJvYmplY3QiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgdmFyIGk7CiAgICAgICAgICAgICAgICB2YXIgZXEgPSB0cnVlOyAvLyB1bmxlc3Mgd2UgY2FuIHByb292ZSBpdAogICAgICAgICAgICAgICAgdmFyIGFQcm9wZXJ0aWVzID0gW10sIGJQcm9wZXJ0aWVzID0gW107IC8vIGNvbGxlY3Rpb24gb2Ygc3RyaW5ncwoKICAgICAgICAgICAgICAgIC8vIGNvbXBhcmluZyBjb25zdHJ1Y3RvcnMgaXMgbW9yZSBzdHJpY3QgdGhhbiB1c2luZyBpbnN0YW5jZW9mCiAgICAgICAgICAgICAgICBpZiAoIGEuY29uc3RydWN0b3IgIT09IGIuY29uc3RydWN0b3IpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gc3RhY2sgY29uc3RydWN0b3IgYmVmb3JlIHRyYXZlcnNpbmcgcHJvcGVydGllcwogICAgICAgICAgICAgICAgY2FsbGVycy5wdXNoKGEuY29uc3RydWN0b3IpOwoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBhKSB7IC8vIGJlIHN0cmljdDogZG9uJ3QgZW5zdXJlcyBoYXNPd25Qcm9wZXJ0eSBhbmQgZ28gZGVlcAoKICAgICAgICAgICAgICAgICAgICBhUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGEncyBwcm9wZXJ0aWVzCgogICAgICAgICAgICAgICAgICAgIGlmICggISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGNhbGxlcnMucG9wKCk7IC8vIHVuc3RhY2ssIHdlIGFyZSBkb25lCgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgaG9veml0KGEpICE9PSBob296aXQoYikpIHsKICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsgLy8gZG9uJ3QgbG9zZSB0aW1lIHdpdGggZXJyb3IgcHJvbmUgY2FzZXMKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBoYW5kbGVFdmVudHMoYSwgY2FsbGJhY2tzLCBbYiwgYV0pOwogICAgICAgICAgICB9CgogICAgICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gd2l0aCAoMS4ubikgYXJndW1lbnRzCiAgICAgICAgfSkoYXJnc1swXSwgYXJnc1sxXSkgJiYgYXJndW1lbnRzLmNhbGxlZS5hcHBseSh0aGlzLCBhcmdzLnNwbGljZSgxLCBhcmdzLmxlbmd0aCAtMSkpOwogICAgfTsKCiAgICByZXR1cm4gaW5uZXJFcXVpdjsKCn0oKTsKCi8qKgogKiBqc0R1bXAKICogQ29weXJpZ2h0IChjKSAyMDA4IEFyaWVsIEZsZXNsZXIgLSBhZmxlc2xlcihhdClnbWFpbChkb3QpY29tIHwgaHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tCiAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApCiAqIERhdGU6IDUvMTUvMjAwOAogKiBAcHJvamVjdERlc2NyaXB0aW9uIEFkdmFuY2VkIGFuZCBleHRlbnNpYmxlIGRhdGEgZHVtcGluZyBmb3IgSmF2YXNjcmlwdC4KICogQHZlcnNpb24gMS4wLjAKICogQGF1dGhvciBBcmllbCBGbGVzbGVyCiAqIEBsaW5rIHtodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20vMjAwOC8wNS9qc2R1bXAtcHJldHR5LWR1bXAtb2YtYW55LWphdmFzY3JpcHQuaHRtbH0KICovClFVbml0LmpzRHVtcCA9IChmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIHF1b3RlKCBzdHIgKSB7CgkJcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOwoJfTsKCWZ1bmN0aW9uIGxpdGVyYWwoIG8gKSB7CgkJcmV0dXJuIG8gKyAnJzsKCX07CglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsKCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwKCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwoJCWlmICggYXJyLmpvaW4gKQoJCQlhcnIgPSBhcnIuam9pbiggJywnICsgcyArIGlubmVyICk7CgkJaWYgKCAhYXJyICkKCQkJcmV0dXJuIHByZSArIHBvc3Q7CgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwoJfTsKCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7CgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsKCQl0aGlzLnVwKCk7CgkJd2hpbGUgKCBpLS0gKQoJCQlyZXRbaV0gPSB0aGlzLnBhcnNlKCBhcnJbaV0gKTsKCQl0aGlzLmRvd24oKTsKCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOwoJfTsKCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgoJdmFyIGpzRHVtcCA9IHsKCQlwYXJzZTpmdW5jdGlvbiggb2JqLCB0eXBlICkgeyAvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQoJCQl2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKCQkJdHlwZSA9IHR5cGVvZiBwYXJzZXI7CgoJCQlyZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwoIHRoaXMsIG9iaiApIDoKCQkJCSAgIHR5cGUgPT0gJ3N0cmluZycgPyBwYXJzZXIgOgoJCQkJICAgdGhpcy5wYXJzZXJzLmVycm9yOwoJCX0sCgkJdHlwZU9mOmZ1bmN0aW9uKCBvYmogKSB7CgkJCXZhciB0eXBlID0gdHlwZW9mIG9iaiwKCQkJCWYgPSAnZnVuY3Rpb24nOy8vd2UnbGwgdXNlIGl0IDMgdGltZXMsIHNhdmUgaXQKCQkJcmV0dXJuIHR5cGUgIT0gJ29iamVjdCcgJiYgdHlwZSAhPSBmID8gdHlwZSA6CgkJCQkhb2JqID8gJ251bGwnIDoKCQkJCW9iai5leGVjID8gJ3JlZ2V4cCcgOi8vIHNvbWUgYnJvd3NlcnMgKEZGKSBjb25zaWRlciByZWdleHBzIGZ1bmN0aW9ucwoJCQkJb2JqLmdldEhvdXJzID8gJ2RhdGUnIDoKCQkJCW9iai5zY3JvbGxCeSA/ICAnd2luZG93JyA6CgkJCQlvYmoubm9kZU5hbWUgPT0gJyNkb2N1bWVudCcgPyAnZG9jdW1lbnQnIDoKCQkJCW9iai5ub2RlTmFtZSA/ICdub2RlJyA6CgkJCQlvYmouaXRlbSA/ICdub2RlbGlzdCcgOiAvLyBTYWZhcmkgcmVwb3J0cyBub2RlbGlzdHMgYXMgZnVuY3Rpb25zCgkJCQlvYmouY2FsbGVlID8gJ2FyZ3VtZW50cycgOgoJCQkJb2JqLmNhbGwgfHwgb2JqLmNvbnN0cnVjdG9yICE9IEFycmF5ICYmIC8vYW4gYXJyYXkgd291bGQgYWxzbyBmYWxsIG9uIHRoaXMgaGFjawoJCQkJCShvYmorJycpLmluZGV4T2YoZikgIT0gLTEgPyBmIDogLy9JRSByZXBvcnRzIGZ1bmN0aW9ucyBsaWtlIGFsZXJ0LCBhcyBvYmplY3RzCgkJCQknbGVuZ3RoJyBpbiBvYmogPyAnYXJyYXknIDoKCQkJCXR5cGU7CgkJfSwKCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwoJCX0sCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwoJCQlpZiAoICF0aGlzLm11bHRpbGluZSApCgkJCQlyZXR1cm4gJyc7CgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CgkJCWlmICggdGhpcy5IVE1MICkKCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOwoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CgkJfSwKCQl1cDpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKCQl9LAoJCWRvd246ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CgkJfSwKCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsKCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwoJCX0sCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtCgkJcXVvdGU6cXVvdGUsCgkJbGl0ZXJhbDpsaXRlcmFsLAoJCWpvaW46am9pbiwKCQkvLwoJCV9kZXB0aF86IDEsCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXIKCQlwYXJzZXJzOnsKCQkJd2luZG93OiAnW1dpbmRvd10nLAoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLAoJCQllcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KCQkJdW5rbm93bjogJ1tVbmtub3duXScsCgkJCSdudWxsJzonbnVsbCcsCgkJCXVuZGVmaW5lZDondW5kZWZpbmVkJywKCQkJJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7CgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCQkJCWlmICggbmFtZSApCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7CgkJCQlyZXQgKz0gJygnOwoKCQkJCXJldCA9IFsgcmV0LCB0aGlzLnBhcnNlKCBmbiwgJ2Z1bmN0aW9uQXJncycgKSwgJyl7J10uam9pbignJyk7CgkJCQlyZXR1cm4gam9pbiggcmV0LCB0aGlzLnBhcnNlKGZuLCdmdW5jdGlvbkNvZGUnKSwgJ30nICk7CgkJCX0sCgkJCWFycmF5OiBhcnJheSwKCQkJbm9kZWxpc3Q6IGFycmF5LAoJCQlhcmd1bWVudHM6IGFycmF5LAoJCQlvYmplY3Q6ZnVuY3Rpb24oIG1hcCApIHsKCQkJCXZhciByZXQgPSBbIF07CgkJCQl0aGlzLnVwKCk7CgkJCQlmb3IgKCB2YXIga2V5IGluIG1hcCApCgkJCQkJcmV0LnB1c2goIHRoaXMucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyB0aGlzLnBhcnNlKG1hcFtrZXldKSApOwoJCQkJdGhpcy5kb3duKCk7CgkJCQlyZXR1cm4gam9pbiggJ3snLCByZXQsICd9JyApOwoJCQl9LAoJCQlub2RlOmZ1bmN0aW9uKCBub2RlICkgewoJCQkJdmFyIG9wZW4gPSB0aGlzLkhUTUwgPyAnJmx0OycgOiAnPCcsCgkJCQkJY2xvc2UgPSB0aGlzLkhUTUwgPyAnJmd0OycgOiAnPic7CgoJCQkJdmFyIHRhZyA9IG5vZGUubm9kZU5hbWUudG9Mb3dlckNhc2UoKSwKCQkJCQlyZXQgPSBvcGVuICsgdGFnOwoKCQkJCWZvciAoIHZhciBhIGluIHRoaXMuRE9NQXR0cnMgKSB7CgkJCQkJdmFyIHZhbCA9IG5vZGVbdGhpcy5ET01BdHRyc1thXV07CgkJCQkJaWYgKCB2YWwgKQoJCQkJCQlyZXQgKz0gJyAnICsgYSArICc9JyArIHRoaXMucGFyc2UoIHZhbCwgJ2F0dHJpYnV0ZScgKTsKCQkJCX0KCQkJCXJldHVybiByZXQgKyBjbG9zZSArIG9wZW4gKyAnLycgKyB0YWcgKyBjbG9zZTsKCQkJfSwKCQkJZnVuY3Rpb25BcmdzOmZ1bmN0aW9uKCBmbiApIHsvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGFyZ3VtZW50cyBwYXJ0IG9mIHRoZSBmdW5jdGlvbgoJCQkJdmFyIGwgPSBmbi5sZW5ndGg7CgkJCQlpZiAoICFsICkgcmV0dXJuICcnOwoKCQkJCXZhciBhcmdzID0gQXJyYXkobCk7CgkJCQl3aGlsZSAoIGwtLSApCgkJCQkJYXJnc1tsXSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoOTcrbCk7Ly85NyBpcyAnYScKCQkJCXJldHVybiAnICcgKyBhcmdzLmpvaW4oJywgJykgKyAnICc7CgkJCX0sCgkJCWtleTpxdW90ZSwgLy9vYmplY3QgY2FsbHMgaXQgaW50ZXJuYWxseSwgdGhlIGtleSBwYXJ0IG9mIGFuIGl0ZW0gaW4gYSBtYXAKCQkJZnVuY3Rpb25Db2RlOidbY29kZV0nLCAvL2Z1bmN0aW9uIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgdGhlIGNvbnRlbnQgb2YgdGhlIGZ1bmN0aW9uCgkJCWF0dHJpYnV0ZTpxdW90ZSwgLy9ub2RlIGNhbGxzIGl0IGludGVybmFsbHksIGl0J3MgYW4gaHRtbCBhdHRyaWJ1dGUgdmFsdWUKCQkJc3RyaW5nOnF1b3RlLAoJCQlkYXRlOnF1b3RlLAoJCQlyZWdleHA6bGl0ZXJhbCwgLy9yZWdleAoJCQludW1iZXI6bGl0ZXJhbCwKCQkJJ2Jvb2xlYW4nOmxpdGVyYWwKCQl9LAoJCURPTUF0dHJzOnsvL2F0dHJpYnV0ZXMgdG8gZHVtcCBmcm9tIG5vZGVzLCBuYW1lPT5yZWFsTmFtZQoJCQlpZDonaWQnLAoJCQluYW1lOiduYW1lJywKCQkJJ2NsYXNzJzonY2xhc3NOYW1lJwoJCX0sCgkJSFRNTDp0cnVlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkKCQlpbmRlbnRDaGFyOicgICAnLC8vaW5kZW50YXRpb24gdW5pdAoJCW11bHRpbGluZTp0cnVlIC8vaWYgdHJ1ZSwgaXRlbXMgaW4gYSBjb2xsZWN0aW9uLCBhcmUgc2VwYXJhdGVkIGJ5IGEgXG4sIGVsc2UganVzdCBhIHNwYWNlLgoJfTsKCglyZXR1cm4ganNEdW1wOwp9KSgpOwoKfSkodGhpcyk7LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIGRlZmluZWQgPSB7CglzZXRUaW1lb3V0OiB0eXBlb2Ygd2luZG93LnNldFRpbWVvdXQgIT09ICJ1bmRlZmluZWQiLAoJc2Vzc2lvblN0b3JhZ2U6IChmdW5jdGlvbigpIHsKCQl0cnkgewoJCQlyZXR1cm4gISFzZXNzaW9uU3RvcmFnZS5nZXRJdGVtOwoJCX0gY2F0Y2goZSl7CgkJCXJldHVybiBmYWxzZTsKCQl9CiAgfSkoKQp9Cgp2YXIgdGVzdElkID0gMDsKCnZhciBUZXN0ID0gZnVuY3Rpb24obmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjaykgewoJdGhpcy5uYW1lID0gbmFtZTsKCXRoaXMudGVzdE5hbWUgPSB0ZXN0TmFtZTsKCXRoaXMuZXhwZWN0ZWQgPSBleHBlY3RlZDsKCXRoaXMudGVzdEVudmlyb25tZW50QXJnID0gdGVzdEVudmlyb25tZW50QXJnOwoJdGhpcy5hc3luYyA9IGFzeW5jOwoJdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrOwoJdGhpcy5hc3NlcnRpb25zID0gW107Cn07ClRlc3QucHJvdG90eXBlID0gewoJaW5pdDogZnVuY3Rpb24oKSB7CgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CgkJaWYgKHRlc3RzKSB7CgkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJCQliLmlubmVySFRNTCA9ICJSdW5uaW5nICIgKyB0aGlzLm5hbWU7CgkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCQkJbGkuaWQgPSB0aGlzLmlkID0gInRlc3Qtb3V0cHV0IiArIHRlc3RJZCsrOwoJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsKCQl9Cgl9LAoJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCWlmICh0aGlzLm1vZHVsZSAhPSBjb25maWcucHJldmlvdXNNb2R1bGUpIHsKCQkJaWYgKCB0aGlzLnByZXZpb3VzTW9kdWxlICkgewoJCQkJUVVuaXQubW9kdWxlRG9uZSggdGhpcy5tb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsKCQkJfQoJCQljb25maWcucHJldmlvdXNNb2R1bGUgPSB0aGlzLm1vZHVsZTsKCQkJY29uZmlnLm1vZHVsZVN0YXRzID0geyBhbGw6IDAsIGJhZDogMCB9OwoJCQlRVW5pdC5tb2R1bGVTdGFydCggdGhpcy5tb2R1bGUsIHRoaXMubW9kdWxlVGVzdEVudmlyb25tZW50ICk7CgkJfQoKCQljb25maWcuY3VycmVudCA9IHRoaXM7CgkJdGhpcy50ZXN0RW52aXJvbm1lbnQgPSBleHRlbmQoewoJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkge30KCQl9LCB0aGlzLm1vZHVsZVRlc3RFbnZpcm9ubWVudCk7CgkJaWYgKHRoaXMudGVzdEVudmlyb25tZW50QXJnKSB7CgkJCWV4dGVuZCh0aGlzLnRlc3RFbnZpcm9ubWVudCwgdGhpcy50ZXN0RW52aXJvbm1lbnRBcmcpOwoJCX0KCgkJUVVuaXQudGVzdFN0YXJ0KCB0aGlzLnRlc3ROYW1lLCB0aGlzLnRlc3RFbnZpcm9ubWVudCApOwoKCQkvLyBhbGxvdyB1dGlsaXR5IGZ1bmN0aW9ucyB0byBhY2Nlc3MgdGhlIGN1cnJlbnQgdGVzdCBlbnZpcm9ubWVudAoJCS8vIFRPRE8gd2h5Pz8KCQlRVW5pdC5jdXJyZW50X3Rlc3RFbnZpcm9ubWVudCA9IHRoaXMudGVzdEVudmlyb25tZW50OwoKCQl0cnkgewoJCQlpZiAoICFjb25maWcucG9sbHV0aW9uICkgewoJCQkJc2F2ZUdsb2JhbCgpOwoJCQl9CgoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJLy8gVE9ETyB1c2UgdGVzdE5hbWUgaW5zdGVhZCBvZiBuYW1lIGZvciBuby1tYXJrdXAgbWVzc2FnZT8KCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyB0aGlzLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJfQoJfSwKCXJ1bjogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmFzeW5jICkgewoJCQlRVW5pdC5zdG9wKCk7CgkJfQoKCQl0cnkgewoJCQl0aGlzLmNhbGxiYWNrLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOwoJCX0gY2F0Y2goZSkgewoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPwoJCQlmYWlsKCJUZXN0ICIgKyB0aGlzLm5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIiwgZSwgdGhpcy5jYWxsYmFjayk7CgkJCVFVbml0Lm9rKCBmYWxzZSwgIkRpZWQgb24gdGVzdCAjIiArICh0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgMSkgKyAiOiAiICsgZS5tZXNzYWdlICsgIiAtICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZSkgKTsKCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKCQkJc2F2ZUdsb2JhbCgpOwoKCQkJLy8gUmVzdGFydCB0aGUgdGVzdHMgaWYgdGhleSdyZSBibG9ja2luZwoJCQlpZiAoIGNvbmZpZy5ibG9ja2luZyApIHsKCQkJCXN0YXJ0KCk7CgkJCX0KCQl9Cgl9LAoJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCXRyeSB7CgkJCWNoZWNrUG9sbHV0aW9uKCk7CgkJCXRoaXMudGVzdEVudmlyb25tZW50LnRlYXJkb3duLmNhbGwodGhpcy50ZXN0RW52aXJvbm1lbnQpOwoJCX0gY2F0Y2goZSkgewoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPwoJCQlRVW5pdC5vayggZmFsc2UsICJUZWFyZG93biBmYWlsZWQgb24gIiArIHRoaXMubmFtZSArICI6ICIgKyBlLm1lc3NhZ2UgKTsKCQl9Cgl9LAoJZmluaXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuZXhwZWN0ZWQgJiYgdGhpcy5leHBlY3RlZCAhPSB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICkgewoJCQlRVW5pdC5vayggZmFsc2UsICJFeHBlY3RlZCAiICsgdGhpcy5leHBlY3RlZCArICIgYXNzZXJ0aW9ucywgYnV0ICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIiB3ZXJlIHJ1biIgKTsKCQl9CgoJCXZhciBnb29kID0gMCwgYmFkID0gMCwKCQkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKTsKCgkJY29uZmlnLnN0YXRzLmFsbCArPSB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOwoJCWNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKz0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsKCgkJaWYgKCB0ZXN0cyApIHsKCQkJdmFyIG9sICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7CgoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoOyBpKysgKSB7CgkJCQl2YXIgYXNzZXJ0aW9uID0gdGhpcy5hc3NlcnRpb25zW2ldOwoKCQkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQlsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOwoJCQkJbGkuaW5uZXJIVE1MID0gYXNzZXJ0aW9uLm1lc3NhZ2UgfHwgKGFzc2VydGlvbi5yZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CgkJCQlvbC5hcHBlbmRDaGlsZCggbGkgKTsKCgkJCQlpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7CgkJCQkJZ29vZCsrOwoJCQkJfSBlbHNlIHsKCQkJCQliYWQrKzsKCQkJCQljb25maWcuc3RhdHMuYmFkKys7CgkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwoJCQkJfQoJCQl9CgoJCQkvLyBzdG9yZSByZXN1bHQgd2hlbiBwb3NzaWJsZQoJCQlkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oInF1bml0LSIgKyB0aGlzLnRlc3ROYW1lLCBiYWQpOwoKCQkJaWYgKGJhZCA9PSAwKSB7CgkJCQlvbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoJCQl9CgoJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwoJCQliLmlubmVySFRNTCA9IHRoaXMubmFtZSArICIgPGIgY2xhc3M9J2NvdW50cyc+KDxiIGNsYXNzPSdmYWlsZWQnPiIgKyBiYWQgKyAiPC9iPiwgPGIgY2xhc3M9J3Bhc3NlZCc+IiArIGdvb2QgKyAiPC9iPiwgIiArIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKyAiKTwvYj4iOwoKCQkJYWRkRXZlbnQoYiwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQl2YXIgbmV4dCA9IGIubmV4dFNpYmxpbmcsIGRpc3BsYXkgPSBuZXh0LnN0eWxlLmRpc3BsYXk7CgkJCQluZXh0LnN0eWxlLmRpc3BsYXkgPSBkaXNwbGF5ID09PSAibm9uZSIgPyAiYmxvY2siIDogIm5vbmUiOwoJCQl9KTsKCgkJCWFkZEV2ZW50KGIsICJkYmxjbGljayIsIGZ1bmN0aW9uKGUpIHsKCQkJCXZhciB0YXJnZXQgPSBlICYmIGUudGFyZ2V0ID8gZS50YXJnZXQgOiB3aW5kb3cuZXZlbnQuc3JjRWxlbWVudDsKCQkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT0gInNwYW4iIHx8IHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJiIiApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJCWlmICggd2luZG93LmxvY2F0aW9uICYmIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09PSAic3Ryb25nIiApIHsKCQkJCQl3aW5kb3cubG9jYXRpb24uc2VhcmNoID0gIj8iICsgZW5jb2RlVVJJQ29tcG9uZW50KGdldFRleHQoW3RhcmdldF0pLnJlcGxhY2UoL1woLitcKSQvLCAiIikucmVwbGFjZSgvKF5ccyp8XHMqJCkvZywgIiIpKTsKCQkJCX0KCQkJfSk7CgoJCQl2YXIgbGkgPSBpZCh0aGlzLmlkKTsKCQkJbGkuY2xhc3NOYW1lID0gYmFkID8gImZhaWwiIDogInBhc3MiOwoJCQlsaS5zdHlsZS5kaXNwbGF5ID0gcmVzdWx0RGlzcGxheVN0eWxlKCFiYWQpOwoJCQlsaS5yZW1vdmVDaGlsZCggbGkuZmlyc3RDaGlsZCApOwoJCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCQlsaS5hcHBlbmRDaGlsZCggb2wgKTsKCgkJCWlmICggYmFkICkgewoJCQkJdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7CgkJCQlpZiAoIHRvb2xiYXIgKSB7CgkJCQkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCQkJCQlpZCgicXVuaXQtZmlsdGVyLXBhc3MiKS5kaXNhYmxlZCA9IG51bGw7CgkJCQl9CgkJCX0KCgkJfSBlbHNlIHsKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCAhdGhpcy5hc3NlcnRpb25zW2ldLnJlc3VsdCApIHsKCQkJCQliYWQrKzsKCQkJCQljb25maWcuc3RhdHMuYmFkKys7CgkJCQkJY29uZmlnLm1vZHVsZVN0YXRzLmJhZCsrOwoJCQkJfQoJCQl9CgkJfQoKCQl0cnkgewoJCQlRVW5pdC5yZXNldCgpOwoJCX0gY2F0Y2goZSkgewoJCQkvLyBUT0RPIHVzZSB0ZXN0TmFtZSBpbnN0ZWFkIG9mIG5hbWUgZm9yIG5vLW1hcmt1cCBtZXNzYWdlPwoJCQlmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIHRoaXMubmFtZSArICIsIGV4Y2VwdGlvbiBhbmQgcmVzZXQgZm4gZm9sbG93cyIsIGUsIFFVbml0LnJlc2V0KTsKCQl9CgoJCVFVbml0LnRlc3REb25lKCB0aGlzLnRlc3ROYW1lLCBiYWQsIHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGggKTsKCX0sCgoJcXVldWU6IGZ1bmN0aW9uKCkgewoJCXZhciB0ZXN0ID0gdGhpczsKCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJdGVzdC5pbml0KCk7CgkJfSk7CgkJZnVuY3Rpb24gcnVuKCkgewoJCQkvLyBlYWNoIG9mIHRoZXNlIGNhbiBieSBhc3luYwoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJCXRlc3Quc2V0dXAoKTsKCQkJfSk7CgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC5ydW4oKTsKCQkJfSk7CgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC50ZWFyZG93bigpOwoJCQl9KTsKCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCQl0ZXN0LmZpbmlzaCgpOwoJCQl9KTsKCQl9CgkJLy8gZGVmZXIgd2hlbiBwcmV2aW91cyB0ZXN0IHJ1biBwYXNzZWQsIGlmIHN0b3JhZ2UgaXMgYXZhaWxhYmxlCgkJdmFyIGJhZCA9IGRlZmluZWQuc2Vzc2lvblN0b3JhZ2UgJiYgK3Nlc3Npb25TdG9yYWdlLmdldEl0ZW0oInF1bml0LSIgKyB0aGlzLnRlc3ROYW1lKTsKCQlpZiAoYmFkKSB7CgkJCXJ1bigpOwoJCX0gZWxzZSB7CgkJCXN5bmNocm9uaXplKHJ1bik7CgkJfTsKCX0KCn0KCnZhciBRVW5pdCA9IHsKCgkvLyBjYWxsIG9uIHN0YXJ0IG9mIG1vZHVsZSB0ZXN0IHRvIHByZXBlbmQgbmFtZSB0byBhbGwgdGVzdHMKCW1vZHVsZTogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7CgkJY29uZmlnLnByZXZpb3VzTW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7CgkJY29uZmlnLmN1cnJlbnRNb2R1bGUgPSBuYW1lOwoJCWNvbmZpZy5jdXJyZW50TW9kdWxlVGVzdEVudmlyb21lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7Cgl9LAoKCWFzeW5jVGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaykgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSAwOwoJCX0KCgkJUVVuaXQudGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCB0cnVlKTsKCX0sCgoJdGVzdDogZnVuY3Rpb24odGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgYXN5bmMpIHsKCQl2YXIgbmFtZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1uYW1lIj4nICsgdGVzdE5hbWUgKyAnPC9zcGFuPicsIHRlc3RFbnZpcm9ubWVudEFyZzsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAyICkgewoJCQljYWxsYmFjayA9IGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoJCS8vIGlzIDJuZCBhcmd1bWVudCBhIHRlc3RFbnZpcm9ubWVudD8KCQlpZiAoIGV4cGVjdGVkICYmIHR5cGVvZiBleHBlY3RlZCA9PT0gJ29iamVjdCcpIHsKCQkJdGVzdEVudmlyb25tZW50QXJnID0gIGV4cGVjdGVkOwoJCQlleHBlY3RlZCA9IG51bGw7CgkJfQoKCQlpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCQluYW1lID0gJzxzcGFuIGNsYXNzPSJtb2R1bGUtbmFtZSI+JyArIGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjwvc3Bhbj46ICIgKyBuYW1lOwoJCX0KCgkJaWYgKCAhdmFsaWRUZXN0KGNvbmZpZy5jdXJyZW50TW9kdWxlICsgIjogIiArIHRlc3ROYW1lKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdmFyIHRlc3QgPSBuZXcgVGVzdChuYW1lLCB0ZXN0TmFtZSwgZXhwZWN0ZWQsIHRlc3RFbnZpcm9ubWVudEFyZywgYXN5bmMsIGNhbGxiYWNrKTsKCQl0ZXN0LnByZXZpb3VzTW9kdWxlID0gY29uZmlnLnByZXZpb3VzTW9kdWxlOwoJCXRlc3QubW9kdWxlID0gY29uZmlnLmN1cnJlbnRNb2R1bGU7CgkJdGVzdC5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSBjb25maWcuY3VycmVudE1vZHVsZVRlc3RFbnZpcm9tZW50OwoJCXRlc3QucXVldWUoKTsKCX0sCgoJLyoqCgkgKiBTcGVjaWZ5IHRoZSBudW1iZXIgb2YgZXhwZWN0ZWQgYXNzZXJ0aW9ucyB0byBndXJhbnRlZSB0aGF0IGZhaWxlZCB0ZXN0IChubyBhc3NlcnRpb25zIGFyZSBydW4gYXQgYWxsKSBkb24ndCBzbGlwIHRocm91Z2guCgkgKi8KCWV4cGVjdDogZnVuY3Rpb24oYXNzZXJ0cykgewoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkID0gYXNzZXJ0czsKCX0sCgoJLyoqCgkgKiBBc3NlcnRzIHRydWUuCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwoJICovCglvazogZnVuY3Rpb24oYSwgbXNnKSB7CgkJYSA9ICEhYTsKCQl2YXIgZGV0YWlscyA9IHsKCQkJcmVzdWx0OiBhLAoJCQltZXNzYWdlOiBtc2cKCQl9OwoJCW1zZyA9IGVzY2FwZUh0bWwobXNnKTsKCQlRVW5pdC5sb2coYSwgbXNnLCBkZXRhaWxzKTsKCQljb25maWcuY3VycmVudC5hc3NlcnRpb25zLnB1c2goewoJCQlyZXN1bHQ6IGEsCgkJCW1lc3NhZ2U6IG1zZwoJCX0pOwoJfSwKCgkvKioKCSAqIENoZWNrcyB0aGF0IHRoZSBmaXJzdCB0d28gYXJndW1lbnRzIGFyZSBlcXVhbCwgd2l0aCBhbiBvcHRpb25hbCBtZXNzYWdlLgoJICogUHJpbnRzIG91dCBib3RoIGFjdHVhbCBhbmQgZXhwZWN0ZWQgdmFsdWVzLgoJICoKCSAqIFByZWZlcmVkIHRvIG9rKCBhY3R1YWwgPT0gZXhwZWN0ZWQsIG1lc3NhZ2UgKQoJICoKCSAqIEBleGFtcGxlIGVxdWFsKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOwoJICoKCSAqIEBwYXJhbSBPYmplY3QgYWN0dWFsCgkgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkCgkgKiBAcGFyYW0gU3RyaW5nIG1lc3NhZ2UgKG9wdGlvbmFsKQoJICovCgllcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goZXhwZWN0ZWQgPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJbm90RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkICE9IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCWRlZXBFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglub3REZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKCFRVW5pdC5lcXVpdihhY3R1YWwsIGV4cGVjdGVkKSwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCXN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCA9PT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJbm90U3RyaWN0RXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkICE9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglyYWlzZXM6IGZ1bmN0aW9uKGJsb2NrLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCXZhciBhY3R1YWwsIG9rID0gZmFsc2U7CgoJCWlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdzdHJpbmcnKSB7CgkJCW1lc3NhZ2UgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSBudWxsOwoJCX0KCgkJdHJ5IHsKCQkJYmxvY2soKTsKCQl9IGNhdGNoIChlKSB7CgkJCWFjdHVhbCA9IGU7CgkJfQoKCQlpZiAoYWN0dWFsKSB7CgkJCS8vIHdlIGRvbid0IHdhbnQgdG8gdmFsaWRhdGUgdGhyb3duIGVycm9yCgkJCWlmICghZXhwZWN0ZWQpIHsKCQkJCW9rID0gdHJ1ZTsKCQkJLy8gZXhwZWN0ZWQgaXMgYSByZWdleHAKCQkJfSBlbHNlIGlmIChRVW5pdC5vYmplY3RUeXBlKGV4cGVjdGVkKSA9PT0gInJlZ2V4cCIpIHsKCQkJCW9rID0gZXhwZWN0ZWQudGVzdChhY3R1YWwpOwoJCQkvLyBleHBlY3RlZCBpcyBhIGNvbnN0cnVjdG9yCgkJCX0gZWxzZSBpZiAoYWN0dWFsIGluc3RhbmNlb2YgZXhwZWN0ZWQpIHsKCQkJCW9rID0gdHJ1ZTsKCQkJLy8gZXhwZWN0ZWQgaXMgYSB2YWxpZGF0aW9uIGZ1bmN0aW9uIHdoaWNoIHJldHVybnMgdHJ1ZSBpcyB2YWxpZGF0aW9uIHBhc3NlZAoJCQl9IGVsc2UgaWYgKGV4cGVjdGVkLmNhbGwoe30sIGFjdHVhbCkgPT09IHRydWUpIHsKCQkJCW9rID0gdHJ1ZTsKCQkJfQoJCX0KCgkJUVVuaXQub2sob2ssIG1lc3NhZ2UpOwoJfSwKCglzdGFydDogZnVuY3Rpb24oKSB7CgkJLy8gQSBzbGlnaHQgZGVsYXksIHRvIGF2b2lkIGFueSBjdXJyZW50IGNhbGxiYWNrcwoJCWlmICggZGVmaW5lZC5zZXRUaW1lb3V0ICkgewoJCQl3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCWlmICggY29uZmlnLnRpbWVvdXQgKSB7CgkJCQkJY2xlYXJUaW1lb3V0KGNvbmZpZy50aW1lb3V0KTsKCQkJCX0KCgkJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJCXByb2Nlc3MoKTsKCQkJfSwgMTMpOwoJCX0gZWxzZSB7CgkJCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoJCQlwcm9jZXNzKCk7CgkJfQoJfSwKCglzdG9wOiBmdW5jdGlvbih0aW1lb3V0KSB7CgkJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCgkJaWYgKCB0aW1lb3V0ICYmIGRlZmluZWQuc2V0VGltZW91dCApIHsKCQkJY29uZmlnLnRpbWVvdXQgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCVFVbml0Lm9rKCBmYWxzZSwgIlRlc3QgdGltZWQgb3V0IiApOwoJCQkJUVVuaXQuc3RhcnQoKTsKCQkJfSwgdGltZW91dCk7CgkJfQoJfQoKfTsKCi8vIEJhY2t3YXJkcyBjb21wYXRpYmlsaXR5LCBkZXByZWNhdGVkClFVbml0LmVxdWFscyA9IFFVbml0LmVxdWFsOwpRVW5pdC5zYW1lID0gUVVuaXQuZGVlcEVxdWFsOwoKLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUKdmFyIGNvbmZpZyA9IHsKCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KCXF1ZXVlOiBbXSwKCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQoJYmxvY2tpbmc6IHRydWUKfTsKCi8vIExvYWQgcGFyYW1hdGVycwooZnVuY3Rpb24oKSB7Cgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoKCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsKCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOwoJCWlmICggR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIiApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJCWNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwoJCX0gZWxzZSBpZiAoIEdFVFBhcmFtc1tpXS5zZWFyY2goJz0nKSA+IC0xICkgewoJCQlHRVRQYXJhbXMuc3BsaWNlKCBpLCAxICk7CgkJCWktLTsKCQl9Cgl9CgoJLy8gcmVzdHJpY3QgbW9kdWxlcy90ZXN0cyBieSBnZXQgcGFyYW1ldGVycwoJY29uZmlnLmZpbHRlcnMgPSBHRVRQYXJhbXM7CgoJLy8gRmlndXJlIG91dCBpZiB3ZSdyZSBydW5uaW5nIHRoZSB0ZXN0cyBmcm9tIGEgc2VydmVyIG9yIG5vdAoJUVVuaXQuaXNMb2NhbCA9ICEhKGxvY2F0aW9uLnByb3RvY29sID09PSAnZmlsZTonKTsKfSkoKTsKCi8vIEV4cG9zZSB0aGUgQVBJIGFzIGdsb2JhbCB2YXJpYWJsZXMsIHVubGVzcyBhbiAnZXhwb3J0cycKLy8gb2JqZWN0IGV4aXN0cywgaW4gdGhhdCBjYXNlIHdlIGFzc3VtZSB3ZSdyZSBpbiBDb21tb25KUwppZiAoIHR5cGVvZiBleHBvcnRzID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgcmVxdWlyZSA9PT0gInVuZGVmaW5lZCIgKSB7CglleHRlbmQod2luZG93LCBRVW5pdCk7Cgl3aW5kb3cuUVVuaXQgPSBRVW5pdDsKfSBlbHNlIHsKCWV4dGVuZChleHBvcnRzLCBRVW5pdCk7CglleHBvcnRzLlFVbml0ID0gUVVuaXQ7Cn0KCi8vIGRlZmluZSB0aGVzZSBhZnRlciBleHBvc2luZyBnbG9iYWxzIHRvIGtlZXAgdGhlbSBpbiB0aGVzZSBRVW5pdCBuYW1lc3BhY2Ugb25seQpleHRlbmQoUVVuaXQsIHsKCWNvbmZpZzogY29uZmlnLAoKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwoJaW5pdDogZnVuY3Rpb24oKSB7CgkJZXh0ZW5kKGNvbmZpZywgewoJCQlzdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQltb2R1bGVTdGF0czogeyBhbGw6IDAsIGJhZDogMCB9LAoJCQlzdGFydGVkOiArbmV3IERhdGUsCgkJCXVwZGF0ZVJhdGU6IDEwMDAsCgkJCWJsb2NraW5nOiBmYWxzZSwKCQkJYXV0b3N0YXJ0OiB0cnVlLAoJCQlhdXRvcnVuOiBmYWxzZSwKCQkJZmlsdGVyczogW10sCgkJCXF1ZXVlOiBbXQoJCX0pOwoKCQl2YXIgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKCQkJYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAoJCQlyZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKCQlpZiAoIHRlc3RzICkgewoJCQl0ZXN0cy5pbm5lckhUTUwgPSAiIjsKCQl9CgoJCWlmICggYmFubmVyICkgewoJCQliYW5uZXIuY2xhc3NOYW1lID0gIiI7CgkJfQoKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHJlc3VsdCApOwoJCX0KCX0sCgoJLyoqCgkgKiBSZXNldHMgdGhlIHRlc3Qgc2V0dXAuIFVzZWZ1bCBmb3IgdGVzdHMgdGhhdCBtb2RpZnkgdGhlIERPTS4KCSAqCgkgKiBJZiBqUXVlcnkgaXMgYXZhaWxhYmxlLCB1c2VzIGpRdWVyeSdzIGh0bWwoKSwgb3RoZXJ3aXNlIGp1c3QgaW5uZXJIVE1MLgoJICovCglyZXNldDogZnVuY3Rpb24oKSB7CgkJaWYgKCB3aW5kb3cualF1ZXJ5ICkgewoJCQlqUXVlcnkoICIjbWFpbiwgI3F1bml0LWZpeHR1cmUiICkuaHRtbCggY29uZmlnLmZpeHR1cmUgKTsKCQl9IGVsc2UgewoJCQl2YXIgbWFpbiA9IGlkKCAnbWFpbicgKSB8fCBpZCggJ3F1bml0LWZpeHR1cmUnICk7CgkJCWlmICggbWFpbiApIHsKCQkJCW1haW4uaW5uZXJIVE1MID0gY29uZmlnLmZpeHR1cmU7CgkJCX0KCQl9Cgl9LAoKCS8qKgoJICogVHJpZ2dlciBhbiBldmVudCBvbiBhbiBlbGVtZW50LgoJICoKCSAqIEBleGFtcGxlIHRyaWdnZXJFdmVudCggZG9jdW1lbnQuYm9keSwgImNsaWNrIiApOwoJICoKCSAqIEBwYXJhbSBET01FbGVtZW50IGVsZW0KCSAqIEBwYXJhbSBTdHJpbmcgdHlwZQoJICovCgl0cmlnZ2VyRXZlbnQ6IGZ1bmN0aW9uKCBlbGVtLCB0eXBlLCBldmVudCApIHsKCQlpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewoJCQlldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOwoJCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCgkJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CgkJCWVsZW0uZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsKCgkJfSBlbHNlIGlmICggZWxlbS5maXJlRXZlbnQgKSB7CgkJCWVsZW0uZmlyZUV2ZW50KCJvbiIrdHlwZSk7CgkJfQoJfSwKCgkvLyBTYWZlIG9iamVjdCB0eXBlIGNoZWNraW5nCglpczogZnVuY3Rpb24oIHR5cGUsIG9iaiApIHsKCQlyZXR1cm4gUVVuaXQub2JqZWN0VHlwZSggb2JqICkgPT0gdHlwZTsKCX0sCgoJb2JqZWN0VHlwZTogZnVuY3Rpb24oIG9iaiApIHsKCQlpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXJldHVybiAidW5kZWZpbmVkIjsKCgkJLy8gY29uc2lkZXI6IHR5cGVvZiBudWxsID09PSBvYmplY3QKCQl9CgkJaWYgKG9iaiA9PT0gbnVsbCkgewoJCQkJcmV0dXJuICJudWxsIjsKCQl9CgoJCXZhciB0eXBlID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKCBvYmogKQoJCQkubWF0Y2goL15cW29iamVjdFxzKC4qKVxdJC8pWzFdIHx8ICcnOwoKCQlzd2l0Y2ggKHR5cGUpIHsKCQkJCWNhc2UgJ051bWJlcic6CgkJCQkJCWlmIChpc05hTihvYmopKSB7CgkJCQkJCQkJcmV0dXJuICJuYW4iOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJldHVybiAibnVtYmVyIjsKCQkJCQkJfQoJCQkJY2FzZSAnU3RyaW5nJzoKCQkJCWNhc2UgJ0Jvb2xlYW4nOgoJCQkJY2FzZSAnQXJyYXknOgoJCQkJY2FzZSAnRGF0ZSc6CgkJCQljYXNlICdSZWdFeHAnOgoJCQkJY2FzZSAnRnVuY3Rpb24nOgoJCQkJCQlyZXR1cm4gdHlwZS50b0xvd2VyQ2FzZSgpOwoJCX0KCQlpZiAodHlwZW9mIG9iaiA9PT0gIm9iamVjdCIpIHsKCQkJCXJldHVybiAib2JqZWN0IjsKCQl9CgkJcmV0dXJuIHVuZGVmaW5lZDsKCX0sCgoJcHVzaDogZnVuY3Rpb24ocmVzdWx0LCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJdmFyIGRldGFpbHMgPSB7CgkJCXJlc3VsdDogcmVzdWx0LAoJCQltZXNzYWdlOiBtZXNzYWdlLAoJCQlhY3R1YWw6IGFjdHVhbCwKCQkJZXhwZWN0ZWQ6IGV4cGVjdGVkCgkJfTsKCgkJbWVzc2FnZSA9IGVzY2FwZUh0bWwobWVzc2FnZSkgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKCQltZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJ0ZXN0LW1lc3NhZ2UiPicgKyBtZXNzYWdlICsgIjwvc3Bhbj4iOwoJCWV4cGVjdGVkID0gZXNjYXBlSHRtbChRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpKTsKCQlhY3R1YWwgPSBlc2NhcGVIdG1sKFFVbml0LmpzRHVtcC5wYXJzZShhY3R1YWwpKTsKCQl2YXIgb3V0cHV0ID0gbWVzc2FnZSArICc8dGFibGU+PHRyIGNsYXNzPSJ0ZXN0LWV4cGVjdGVkIj48dGg+RXhwZWN0ZWQ6IDwvdGg+PHRkPjxwcmU+JyArIGV4cGVjdGVkICsgJzwvcHJlPjwvdGQ+PC90cj4nOwoJCWlmIChhY3R1YWwgIT0gZXhwZWN0ZWQpIHsKCQkJb3V0cHV0ICs9ICc8dHIgY2xhc3M9InRlc3QtYWN0dWFsIj48dGg+UmVzdWx0OiA8L3RoPjx0ZD48cHJlPicgKyBhY3R1YWwgKyAnPC9wcmU+PC90ZD48L3RyPic7CgkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LWRpZmYiPjx0aD5EaWZmOiA8L3RoPjx0ZD48cHJlPicgKyBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpICsnPC9wcmU+PC90ZD48L3RyPic7CgkJfQoJCWlmICghcmVzdWx0KSB7CgkJCXZhciBzb3VyY2UgPSBzb3VyY2VGcm9tU3RhY2t0cmFjZSgpOwoJCQlpZiAoc291cmNlKSB7CgkJCQlkZXRhaWxzLnNvdXJjZSA9IHNvdXJjZTsKCQkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LXNvdXJjZSI+PHRoPlNvdXJjZTogPC90aD48dGQ+PHByZT4nICsgc291cmNlICsnPC9wcmU+PC90ZD48L3RyPic7CgkJCX0KCQl9CgkJb3V0cHV0ICs9ICI8L3RhYmxlPiI7CgoJCVFVbml0LmxvZyhyZXN1bHQsIG1lc3NhZ2UsIGRldGFpbHMpOwoKCQljb25maWcuY3VycmVudC5hc3NlcnRpb25zLnB1c2goewoJCQlyZXN1bHQ6ICEhcmVzdWx0LAoJCQltZXNzYWdlOiBvdXRwdXQKCQl9KTsKCX0sCgoJLy8gTG9nZ2luZyBjYWxsYmFja3MKCWJlZ2luOiBmdW5jdGlvbigpIHt9LAoJZG9uZTogZnVuY3Rpb24oZmFpbHVyZXMsIHRvdGFsKSB7fSwKCWxvZzogZnVuY3Rpb24ocmVzdWx0LCBtZXNzYWdlKSB7fSwKCXRlc3RTdGFydDogZnVuY3Rpb24obmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwKCXRlc3REb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9LAoJbW9kdWxlU3RhcnQ6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkge30sCgltb2R1bGVEb25lOiBmdW5jdGlvbihuYW1lLCBmYWlsdXJlcywgdG90YWwpIHt9Cn0pOwoKaWYgKCB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7Cn0KCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsKCVFVbml0LmJlZ2luKCk7CgoJLy8gSW5pdGlhbGl6ZSB0aGUgY29uZmlnLCBzYXZpbmcgdGhlIGV4ZWN1dGlvbiBxdWV1ZQoJdmFyIG9sZGNvbmZpZyA9IGV4dGVuZCh7fSwgY29uZmlnKTsKCVFVbml0LmluaXQoKTsKCWV4dGVuZChjb25maWcsIG9sZGNvbmZpZyk7CgoJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgoJdmFyIHVzZXJBZ2VudCA9IGlkKCJxdW5pdC11c2VyQWdlbnQiKTsKCWlmICggdXNlckFnZW50ICkgewoJCXVzZXJBZ2VudC5pbm5lckhUTUwgPSBuYXZpZ2F0b3IudXNlckFnZW50OwoJfQoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1oZWFkZXIiKTsKCWlmICggYmFubmVyICkgewoJCXZhciBwYXJhbXNJbmRleCA9IGxvY2F0aW9uLmhyZWYubGFzdEluZGV4T2YobG9jYXRpb24uc2VhcmNoKTsKCQlpZiAoIHBhcmFtc0luZGV4ID4gLTEgKSB7CgkJCXZhciBtYWluUGFnZUxvY2F0aW9uID0gbG9jYXRpb24uaHJlZi5zbGljZSgwLCBwYXJhbXNJbmRleCk7CgkJCWlmICggbWFpblBhZ2VMb2NhdGlvbiA9PSBsb2NhdGlvbi5ocmVmICkgewoJCQkJYmFubmVyLmlubmVySFRNTCA9ICc8YSBocmVmPSIiPiAnICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICc7CgkJCX0gZWxzZSB7CgkJCQl2YXIgdGVzdE5hbWUgPSBkZWNvZGVVUklDb21wb25lbnQobG9jYXRpb24uc2VhcmNoLnNsaWNlKDEpKTsKCQkJCWJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iJyArIG1haW5QYWdlTG9jYXRpb24gKyAnIj4nICsgYmFubmVyLmlubmVySFRNTCArICc8L2E+ICYjODI1MDsgPGEgaHJlZj0iIj4nICsgdGVzdE5hbWUgKyAnPC9hPic7CgkJCX0KCQl9Cgl9CgoJdmFyIHRvb2xiYXIgPSBpZCgicXVuaXQtdGVzdHJ1bm5lci10b29sYmFyIik7CglpZiAoIHRvb2xiYXIgKSB7CgkJdG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKCQl2YXIgZmlsdGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiaW5wdXQiKTsKCQlmaWx0ZXIudHlwZSA9ICJjaGVja2JveCI7CgkJZmlsdGVyLmlkID0gInF1bml0LWZpbHRlci1wYXNzIjsKCQlmaWx0ZXIuZGlzYWJsZWQgPSB0cnVlOwoJCWFkZEV2ZW50KCBmaWx0ZXIsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJwYXNzIikgPiAtMSApIHsKCQkJCQlsaVtpXS5zdHlsZS5kaXNwbGF5ID0gZmlsdGVyLmNoZWNrZWQgPyAibm9uZSIgOiAiIjsKCQkJCX0KCQkJfQoJCX0pOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGZpbHRlciApOwoKCQl2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgInF1bml0LWZpbHRlci1wYXNzIik7CgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgcGFzc2VkIHRlc3RzIjsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBsYWJlbCApOwoJfQoKCXZhciBtYWluID0gaWQoJ21haW4nKSB8fCBpZCgncXVuaXQtZml4dHVyZScpOwoJaWYgKCBtYWluICkgewoJCWNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7Cgl9CgoJaWYgKGNvbmZpZy5hdXRvc3RhcnQpIHsKCQlRVW5pdC5zdGFydCgpOwoJfQp9KTsKCmZ1bmN0aW9uIGRvbmUoKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7CgoJLy8gTG9nIHRoZSBsYXN0IG1vZHVsZSByZXN1bHRzCglpZiAoIGNvbmZpZy5jdXJyZW50TW9kdWxlICkgewoJCVFVbml0Lm1vZHVsZURvbmUoIGNvbmZpZy5jdXJyZW50TW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7Cgl9CgoJdmFyIGJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKCQl0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpLAoJCWh0bWwgPSBbJ1Rlc3RzIGNvbXBsZXRlZCBpbiAnLAoJCStuZXcgRGF0ZSAtIGNvbmZpZy5zdGFydGVkLCAnIG1pbGxpc2Vjb25kcy48YnIvPicsCgkJJzxzcGFuIGNsYXNzPSJwYXNzZWQiPicsIGNvbmZpZy5zdGF0cy5hbGwgLSBjb25maWcuc3RhdHMuYmFkLCAnPC9zcGFuPiB0ZXN0cyBvZiA8c3BhbiBjbGFzcz0idG90YWwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgPHNwYW4gY2xhc3M9ImZhaWxlZCI+JywgY29uZmlnLnN0YXRzLmJhZCwnPC9zcGFuPiBmYWlsZWQuJ10uam9pbignJyk7CgoJaWYgKCBiYW5uZXIgKSB7CgkJYmFubmVyLmNsYXNzTmFtZSA9IChjb25maWcuc3RhdHMuYmFkID8gInF1bml0LWZhaWwiIDogInF1bml0LXBhc3MiKTsKCX0KCglpZiAoIHRlc3RzICkgewoJCXZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKCQlpZiAoICFyZXN1bHQgKSB7CgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKCQkJcmVzdWx0LmlkID0gInF1bml0LXRlc3RyZXN1bHQiOwoJCQlyZXN1bHQuY2xhc3NOYW1lID0gInJlc3VsdCI7CgkJCXRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7CgkJfQoKCQlyZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsKCX0KCglRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoKCWlmICggIWkgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJd2hpbGUgKCBpLS0gKSB7CgkJdmFyIGZpbHRlciA9IGNvbmZpZy5maWx0ZXJzW2ldLAoJCQlub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCgkJaWYgKCBub3QgKSB7CgkJCWZpbHRlciA9IGZpbHRlci5zbGljZSgxKTsKCQl9CgoJCWlmICggbmFtZS5pbmRleE9mKGZpbHRlcikgIT09IC0xICkgewoJCQlyZXR1cm4gIW5vdDsKCQl9CgoJCWlmICggbm90ICkgewoJCQlydW4gPSB0cnVlOwoJCX0KCX0KCglyZXR1cm4gcnVuOwp9CgovLyBzbyBmYXIgc3VwcG9ydHMgb25seSBGaXJlZm94LCBDaHJvbWUgYW5kIE9wZXJhIChidWdneSkKLy8gY291bGQgYmUgZXh0ZW5kZWQgaW4gdGhlIGZ1dHVyZSB0byB1c2Ugc29tZXRoaW5nIGxpa2UgaHR0cHM6Ly9naXRodWIuY29tL2Nzbm92ZXIvVHJhY2VLaXQKZnVuY3Rpb24gc291cmNlRnJvbVN0YWNrdHJhY2UoKSB7Cgl0cnkgewoJCXRocm93IG5ldyBFcnJvcigpOwoJfSBjYXRjaCAoIGUgKSB7CgkJaWYgKGUuc3RhY2t0cmFjZSkgewoJCQkvLyBPcGVyYQoJCQlyZXR1cm4gZS5zdGFja3RyYWNlLnNwbGl0KCJcbiIpWzZdOwoJCX0gZWxzZSBpZiAoZS5zdGFjaykgewoJCQkvLyBGaXJlZm94LCBDaHJvbWUKCQkJcmV0dXJuIGUuc3RhY2suc3BsaXQoIlxuIilbNF07CgkJfQoJfQp9CgpmdW5jdGlvbiByZXN1bHREaXNwbGF5U3R5bGUocGFzc2VkKSB7CglyZXR1cm4gcGFzc2VkICYmIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpICYmIGlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmNoZWNrZWQgPyAnbm9uZScgOiAnJzsKfQoKZnVuY3Rpb24gZXNjYXBlSHRtbChzKSB7CglpZiAoIXMpIHsKCQlyZXR1cm4gIiI7Cgl9CglzID0gcyArICIiOwoJcmV0dXJuIHMucmVwbGFjZSgvW1wmIjw+XFxdL2csIGZ1bmN0aW9uKHMpIHsKCQlzd2l0Y2gocykgewoJCQljYXNlICImIjogcmV0dXJuICImYW1wOyI7CgkJCWNhc2UgIlxcIjogcmV0dXJuICJcXFxcIjsKCQkJY2FzZSAnIic6IHJldHVybiAnXCInOwoJCQljYXNlICI8IjogcmV0dXJuICImbHQ7IjsKCQkJY2FzZSAiPiI6IHJldHVybiAiJmd0OyI7CgkJCWRlZmF1bHQ6IHJldHVybiBzOwoJCX0KCX0pOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7Cgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJcHJvY2VzcygpOwoJfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCkgewoJdmFyIHN0YXJ0ID0gKG5ldyBEYXRlKCkpLmdldFRpbWUoKTsKCgl3aGlsZSAoIGNvbmZpZy5xdWV1ZS5sZW5ndGggJiYgIWNvbmZpZy5ibG9ja2luZyApIHsKCQlpZiAoIGNvbmZpZy51cGRhdGVSYXRlIDw9IDAgfHwgKCgobmV3IERhdGUoKSkuZ2V0VGltZSgpIC0gc3RhcnQpIDwgY29uZmlnLnVwZGF0ZVJhdGUpICkgewoJCQljb25maWcucXVldWUuc2hpZnQoKSgpOwoJCX0gZWxzZSB7CgkJCXdpbmRvdy5zZXRUaW1lb3V0KCBwcm9jZXNzLCAxMyApOwoJCQlicmVhazsKCQl9Cgl9CiAgaWYgKCFjb25maWcuYmxvY2tpbmcgJiYgIWNvbmZpZy5xdWV1ZS5sZW5ndGgpIHsKICAgIGRvbmUoKTsKICB9Cn0KCmZ1bmN0aW9uIHNhdmVHbG9iYWwoKSB7Cgljb25maWcucG9sbHV0aW9uID0gW107CgoJaWYgKCBjb25maWcubm9nbG9iYWxzICkgewoJCWZvciAoIHZhciBrZXkgaW4gd2luZG93ICkgewoJCQljb25maWcucG9sbHV0aW9uLnB1c2goIGtleSApOwoJCX0KCX0KfQoKZnVuY3Rpb24gY2hlY2tQb2xsdXRpb24oIG5hbWUgKSB7Cgl2YXIgb2xkID0gY29uZmlnLnBvbGx1dGlvbjsKCXNhdmVHbG9iYWwoKTsKCgl2YXIgbmV3R2xvYmFscyA9IGRpZmYoIG9sZCwgY29uZmlnLnBvbGx1dGlvbiApOwoJaWYgKCBuZXdHbG9iYWxzLmxlbmd0aCA+IDAgKSB7CgkJb2soIGZhbHNlLCAiSW50cm9kdWNlZCBnbG9iYWwgdmFyaWFibGUocyk6ICIgKyBuZXdHbG9iYWxzLmpvaW4oIiwgIikgKTsKCQljb25maWcuY3VycmVudC5leHBlY3RlZCsrOwoJfQoKCXZhciBkZWxldGVkR2xvYmFscyA9IGRpZmYoIGNvbmZpZy5wb2xsdXRpb24sIG9sZCApOwoJaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkRlbGV0ZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGVsZXRlZEdsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5jdXJyZW50LmV4cGVjdGVkKys7Cgl9Cn0KCi8vIHJldHVybnMgYSBuZXcgQXJyYXkgd2l0aCB0aGUgZWxlbWVudHMgdGhhdCBhcmUgaW4gYSBidXQgbm90IGluIGIKZnVuY3Rpb24gZGlmZiggYSwgYiApIHsKCXZhciByZXN1bHQgPSBhLnNsaWNlKCk7Cglmb3IgKCB2YXIgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKysgKSB7CgkJZm9yICggdmFyIGogPSAwOyBqIDwgYi5sZW5ndGg7IGorKyApIHsKCQkJaWYgKCByZXN1bHRbaV0gPT09IGJbal0gKSB7CgkJCQlyZXN1bHQuc3BsaWNlKGksIDEpOwoJCQkJaS0tOwoJCQkJYnJlYWs7CgkJCX0KCQl9Cgl9CglyZXR1cm4gcmVzdWx0Owp9CgpmdW5jdGlvbiBmYWlsKG1lc3NhZ2UsIGV4Y2VwdGlvbiwgY2FsbGJhY2spIHsKCWlmICggdHlwZW9mIGNvbnNvbGUgIT09ICJ1bmRlZmluZWQiICYmIGNvbnNvbGUuZXJyb3IgJiYgY29uc29sZS53YXJuICkgewoJCWNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CgkJY29uc29sZS5lcnJvcihleGNlcHRpb24pOwoJCWNvbnNvbGUud2FybihjYWxsYmFjay50b1N0cmluZygpKTsKCgl9IGVsc2UgaWYgKCB3aW5kb3cub3BlcmEgJiYgb3BlcmEucG9zdEVycm9yICkgewoJCW9wZXJhLnBvc3RFcnJvcihtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrLnRvU3RyaW5nKTsKCX0KfQoKZnVuY3Rpb24gZXh0ZW5kKGEsIGIpIHsKCWZvciAoIHZhciBwcm9wIGluIGIgKSB7CgkJYVtwcm9wXSA9IGJbcHJvcF07Cgl9CgoJcmV0dXJuIGE7Cn0KCmZ1bmN0aW9uIGFkZEV2ZW50KGVsZW0sIHR5cGUsIGZuKSB7CglpZiAoIGVsZW0uYWRkRXZlbnRMaXN0ZW5lciApIHsKCQllbGVtLmFkZEV2ZW50TGlzdGVuZXIoIHR5cGUsIGZuLCBmYWxzZSApOwoJfSBlbHNlIGlmICggZWxlbS5hdHRhY2hFdmVudCApIHsKCQllbGVtLmF0dGFjaEV2ZW50KCAib24iICsgdHlwZSwgZm4gKTsKCX0gZWxzZSB7CgkJZm4oKTsKCX0KfQoKZnVuY3Rpb24gaWQobmFtZSkgewoJcmV0dXJuICEhKHR5cGVvZiBkb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgZG9jdW1lbnQgJiYgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQpICYmCgkJZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIG5hbWUgKTsKfQoKLy8gVGVzdCBmb3IgZXF1YWxpdHkgYW55IEphdmFTY3JpcHQgdHlwZS4KLy8gRGlzY3Vzc2lvbnMgYW5kIHJlZmVyZW5jZTogaHR0cDovL3BoaWxyYXRoZS5jb20vYXJ0aWNsZXMvZXF1aXYKLy8gVGVzdCBzdWl0ZXM6IGh0dHA6Ly9waGlscmF0aGUuY29tL3Rlc3RzL2VxdWl2Ci8vIEF1dGhvcjogUGhpbGlwcGUgUmF0aMOpIDxwcmF0aGVAZ21haWwuY29tPgpRVW5pdC5lcXVpdiA9IGZ1bmN0aW9uICgpIHsKCiAgICB2YXIgaW5uZXJFcXVpdjsgLy8gdGhlIHJlYWwgZXF1aXYgZnVuY3Rpb24KICAgIHZhciBjYWxsZXJzID0gW107IC8vIHN0YWNrIHRvIGRlY2lkZSBiZXR3ZWVuIHNraXAvYWJvcnQgZnVuY3Rpb25zCiAgICB2YXIgcGFyZW50cyA9IFtdOyAvLyBzdGFjayB0byBhdm9pZGluZyBsb29wcyBmcm9tIGNpcmN1bGFyIHJlZmVyZW5jaW5nCgogICAgLy8gQ2FsbCB0aGUgbyByZWxhdGVkIGNhbGxiYWNrIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgIGZ1bmN0aW9uIGJpbmRDYWxsYmFja3MobywgY2FsbGJhY2tzLCBhcmdzKSB7CiAgICAgICAgdmFyIHByb3AgPSBRVW5pdC5vYmplY3RUeXBlKG8pOwogICAgICAgIGlmIChwcm9wKSB7CiAgICAgICAgICAgIGlmIChRVW5pdC5vYmplY3RUeXBlKGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImRhdGUiICYmIGEudmFsdWVPZigpID09PSBiLnZhbHVlT2YoKTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJyZWdleHAiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJyZWdleHAiICYmCiAgICAgICAgICAgICAgICAgICAgYS5zb3VyY2UgPT09IGIuc291cmNlICYmIC8vIHRoZSByZWdleCBpdHNlbGYKICAgICAgICAgICAgICAgICAgICBhLmdsb2JhbCA9PT0gYi5nbG9iYWwgJiYgLy8gYW5kIGl0cyBtb2RpZmVycyAoZ21pKSAuLi4KICAgICAgICAgICAgICAgICAgICBhLmlnbm9yZUNhc2UgPT09IGIuaWdub3JlQ2FzZSAmJgogICAgICAgICAgICAgICAgICAgIGEubXVsdGlsaW5lID09PSBiLm11bHRpbGluZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIC8vIC0gc2tpcCB3aGVuIHRoZSBwcm9wZXJ0eSBpcyBhIG1ldGhvZCBvZiBhbiBpbnN0YW5jZSAoT09QKQogICAgICAgICAgICAvLyAtIGFib3J0IG90aGVyd2lzZSwKICAgICAgICAgICAgLy8gICBpbml0aWFsID09PSB3b3VsZCBoYXZlIGNhdGNoIGlkZW50aWNhbCByZWZlcmVuY2VzIGFueXdheQogICAgICAgICAgICAiZnVuY3Rpb24iOiBmdW5jdGlvbiAoKSB7CiAgICAgICAgICAgICAgICB2YXIgY2FsbGVyID0gY2FsbGVyc1tjYWxsZXJzLmxlbmd0aCAtIDFdOwogICAgICAgICAgICAgICAgcmV0dXJuIGNhbGxlciAhPT0gT2JqZWN0ICYmCiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVvZiBjYWxsZXIgIT09ICJ1bmRlZmluZWQiOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImFycmF5IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgdmFyIGxlbjsKCiAgICAgICAgICAgICAgICAvLyBiIGNvdWxkIGJlIGFuIG9iamVjdCBsaXRlcmFsIGhlcmUKICAgICAgICAgICAgICAgIGlmICggISAoUVVuaXQub2JqZWN0VHlwZShiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy90cmFjayByZWZlcmVuY2UgdG8gYXZvaWQgY2lyY3VsYXIgcmVmZXJlbmNlcwogICAgICAgICAgICAgICAgcGFyZW50cy5wdXNoKGEpOwogICAgICAgICAgICAgICAgZm9yIChpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvb3AgPSB0cnVlOy8vZG9udCByZXdhbGsgYXJyYXkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpLCBqLCBsb29wOwogICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQKICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgaWYgKCBhLmNvbnN0cnVjdG9yICE9PSBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKICAgICAgICAgICAgICAgICAgICBsb29wID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgZm9yKGo9MDtqPHBhcmVudHMubGVuZ3RoO2orKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKHBhcmVudHNbal0gPT09IGFbaV0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsgLy9kb24ndCBnbyBkb3duIHRoZSBzYW1lIHBhdGggdHdpY2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcwoKICAgICAgICAgICAgICAgICAgICBpZiAoIWxvb3AgJiYgISBpbm5lckVxdWl2KGFbaV0sIGJbaV0pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGVxID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYikgewogICAgICAgICAgICAgICAgICAgIGJQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYidzIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBFbnN1cmVzIGlkZW50aWNhbCBwcm9wZXJ0aWVzIG5hbWUKICAgICAgICAgICAgICAgIHJldHVybiBlcSAmJiBpbm5lckVxdWl2KGFQcm9wZXJ0aWVzLnNvcnQoKSwgYlByb3BlcnRpZXMuc29ydCgpKTsKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICB9KCk7CgogICAgaW5uZXJFcXVpdiA9IGZ1bmN0aW9uICgpIHsgLy8gY2FuIHRha2UgbXVsdGlwbGUgYXJndW1lbnRzCiAgICAgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuYXBwbHkoYXJndW1lbnRzKTsKICAgICAgICBpZiAoYXJncy5sZW5ndGggPCAyKSB7CiAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBlbmQgdHJhbnNpdGlvbgogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICBpZiAoYSA9PT0gYikgewogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGNhdGNoIHRoZSBtb3N0IHlvdSBjYW4KICAgICAgICAgICAgfSBlbHNlIGlmIChhID09PSBudWxsIHx8IGIgPT09IG51bGwgfHwgdHlwZW9mIGEgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiBiID09PSAidW5kZWZpbmVkIiB8fCBRVW5pdC5vYmplY3RUeXBlKGEpICE9PSBRVW5pdC5vYmplY3RUeXBlKGIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYmluZENhbGxiYWNrcyhhLCBjYWxsYmFja3MsIFtiLCBhXSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgLy8gYXBwbHkgdHJhbnNpdGlvbiB3aXRoICgxLi5uKSBhcmd1bWVudHMKICAgICAgICB9KShhcmdzWzBdLCBhcmdzWzFdKSAmJiBhcmd1bWVudHMuY2FsbGVlLmFwcGx5KHRoaXMsIGFyZ3Muc3BsaWNlKDEsIGFyZ3MubGVuZ3RoIC0xKSk7CiAgICB9OwoKICAgIHJldHVybiBpbm5lckVxdWl2OwoKfSgpOwoKLyoqCiAqIGpzRHVtcAogKiBDb3B5cmlnaHQgKGMpIDIwMDggQXJpZWwgRmxlc2xlciAtIGFmbGVzbGVyKGF0KWdtYWlsKGRvdCljb20gfCBodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20KICogTGljZW5zZWQgdW5kZXIgQlNEIChodHRwOi8vd3d3Lm9wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2JzZC1saWNlbnNlLnBocCkKICogRGF0ZTogNS8xNS8yMDA4CiAqIEBwcm9qZWN0RGVzY3JpcHRpb24gQWR2YW5jZWQgYW5kIGV4dGVuc2libGUgZGF0YSBkdW1waW5nIGZvciBKYXZhc2NyaXB0LgogKiBAdmVyc2lvbiAxLjAuMAogKiBAYXV0aG9yIEFyaWVsIEZsZXNsZXIKICogQGxpbmsge2h0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbS8yMDA4LzA1L2pzZHVtcC1wcmV0dHktZHVtcC1vZi1hbnktamF2YXNjcmlwdC5odG1sfQogKi8KUVVuaXQuanNEdW1wID0gKGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24gcXVvdGUoIHN0ciApIHsKCQlyZXR1cm4gJyInICsgc3RyLnRvU3RyaW5nKCkucmVwbGFjZSgvIi9nLCAnXFwiJykgKyAnIic7Cgl9OwoJZnVuY3Rpb24gbGl0ZXJhbCggbyApIHsKCQlyZXR1cm4gbyArICcnOwoJfTsKCWZ1bmN0aW9uIGpvaW4oIHByZSwgYXJyLCBwb3N0ICkgewoJCXZhciBzID0ganNEdW1wLnNlcGFyYXRvcigpLAoJCQliYXNlID0ganNEdW1wLmluZGVudCgpLAoJCQlpbm5lciA9IGpzRHVtcC5pbmRlbnQoMSk7CgkJaWYgKCBhcnIuam9pbiApCgkJCWFyciA9IGFyci5qb2luKCAnLCcgKyBzICsgaW5uZXIgKTsKCQlpZiAoICFhcnIgKQoJCQlyZXR1cm4gcHJlICsgcG9zdDsKCQlyZXR1cm4gWyBwcmUsIGlubmVyICsgYXJyLCBiYXNlICsgcG9zdCBdLmpvaW4ocyk7Cgl9OwoJZnVuY3Rpb24gYXJyYXkoIGFyciApIHsKCQl2YXIgaSA9IGFyci5sZW5ndGgsCXJldCA9IEFycmF5KGkpOwoJCXRoaXMudXAoKTsKCQl3aGlsZSAoIGktLSApCgkJCXJldFtpXSA9IHRoaXMucGFyc2UoIGFycltpXSApOwoJCXRoaXMuZG93bigpOwoJCXJldHVybiBqb2luKCAnWycsIHJldCwgJ10nICk7Cgl9OwoKCXZhciByZU5hbWUgPSAvXmZ1bmN0aW9uIChcdyspLzsKCgl2YXIganNEdW1wID0gewoJCXBhcnNlOmZ1bmN0aW9uKCBvYmosIHR5cGUgKSB7IC8vdHlwZSBpcyB1c2VkIG1vc3RseSBpbnRlcm5hbGx5LCB5b3UgY2FuIGZpeCBhIChjdXN0b20pdHlwZSBpbiBhZHZhbmNlCgkJCXZhcglwYXJzZXIgPSB0aGlzLnBhcnNlcnNbIHR5cGUgfHwgdGhpcy50eXBlT2Yob2JqKSBdOwoJCQl0eXBlID0gdHlwZW9mIHBhcnNlcjsKCgkJCXJldHVybiB0eXBlID09ICdmdW5jdGlvbicgPyBwYXJzZXIuY2FsbCggdGhpcywgb2JqICkgOgoJCQkJICAgdHlwZSA9PSAnc3RyaW5nJyA/IHBhcnNlciA6CgkJCQkgICB0aGlzLnBhcnNlcnMuZXJyb3I7CgkJfSwKCQl0eXBlT2Y6ZnVuY3Rpb24oIG9iaiApIHsKCQkJdmFyIHR5cGU7CgkJCWlmICggb2JqID09PSBudWxsICkgewoJCQkJdHlwZSA9ICJudWxsIjsKCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAidW5kZWZpbmVkIikgewoJCQkJdHlwZSA9ICJ1bmRlZmluZWQiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJSZWdFeHAiLCBvYmopKSB7CgkJCQl0eXBlID0gInJlZ2V4cCI7CgkJCX0gZWxzZSBpZiAoUVVuaXQuaXMoIkRhdGUiLCBvYmopKSB7CgkJCQl0eXBlID0gImRhdGUiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJGdW5jdGlvbiIsIG9iaikpIHsKCQkJCXR5cGUgPSAiZnVuY3Rpb24iOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmouc2V0SW50ZXJ2YWwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2Ygb2JqLmRvY3VtZW50ICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Ygb2JqLm5vZGVUeXBlID09PSAidW5kZWZpbmVkIikgewoJCQkJdHlwZSA9ICJ3aW5kb3ciOwoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSA9PT0gOSkgewoJCQkJdHlwZSA9ICJkb2N1bWVudCI7CgkJCX0gZWxzZSBpZiAob2JqLm5vZGVUeXBlKSB7CgkJCQl0eXBlID0gIm5vZGUiOwoJCQl9IGVsc2UgaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiICYmIHR5cGVvZiBvYmoubGVuZ3RoID09PSAibnVtYmVyIiAmJiBvYmoubGVuZ3RoID49IDApIHsKCQkJCXR5cGUgPSAiYXJyYXkiOwoJCQl9IGVsc2UgewoJCQkJdHlwZSA9IHR5cGVvZiBvYmo7CgkJCX0KCQkJcmV0dXJuIHR5cGU7CgkJfSwKCQlzZXBhcmF0b3I6ZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLm11bHRpbGluZSA/CXRoaXMuSFRNTCA/ICc8YnIgLz4nIDogJ1xuJyA6IHRoaXMuSFRNTCA/ICcmbmJzcDsnIDogJyAnOwoJCX0sCgkJaW5kZW50OmZ1bmN0aW9uKCBleHRyYSApIHsvLyBleHRyYSBjYW4gYmUgYSBudW1iZXIsIHNob3J0Y3V0IGZvciBpbmNyZWFzaW5nLWNhbGxpbmctZGVjcmVhc2luZwoJCQlpZiAoICF0aGlzLm11bHRpbGluZSApCgkJCQlyZXR1cm4gJyc7CgkJCXZhciBjaHIgPSB0aGlzLmluZGVudENoYXI7CgkJCWlmICggdGhpcy5IVE1MICkKCQkJCWNociA9IGNoci5yZXBsYWNlKC9cdC9nLCcgICAnKS5yZXBsYWNlKC8gL2csJyZuYnNwOycpOwoJCQlyZXR1cm4gQXJyYXkoIHRoaXMuX2RlcHRoXyArIChleHRyYXx8MCkgKS5qb2luKGNocik7CgkJfSwKCQl1cDpmdW5jdGlvbiggYSApIHsKCQkJdGhpcy5fZGVwdGhfICs9IGEgfHwgMTsKCQl9LAoJCWRvd246ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyAtPSBhIHx8IDE7CgkJfSwKCQlzZXRQYXJzZXI6ZnVuY3Rpb24oIG5hbWUsIHBhcnNlciApIHsKCQkJdGhpcy5wYXJzZXJzW25hbWVdID0gcGFyc2VyOwoJCX0sCgkJLy8gVGhlIG5leHQgMyBhcmUgZXhwb3NlZCBzbyB5b3UgY2FuIHVzZSB0aGVtCgkJcXVvdGU6cXVvdGUsCgkJbGl0ZXJhbDpsaXRlcmFsLAoJCWpvaW46am9pbiwKCQkvLwoJCV9kZXB0aF86IDEsCgkJLy8gVGhpcyBpcyB0aGUgbGlzdCBvZiBwYXJzZXJzLCB0byBtb2RpZnkgdGhlbSwgdXNlIGpzRHVtcC5zZXRQYXJzZXIKCQlwYXJzZXJzOnsKCQkJd2luZG93OiAnW1dpbmRvd10nLAoJCQlkb2N1bWVudDogJ1tEb2N1bWVudF0nLAoJCQllcnJvcjonW0VSUk9SXScsIC8vd2hlbiBubyBwYXJzZXIgaXMgZm91bmQsIHNob3VsZG4ndCBoYXBwZW4KCQkJdW5rbm93bjogJ1tVbmtub3duXScsCgkJCSdudWxsJzonbnVsbCcsCgkJCXVuZGVmaW5lZDondW5kZWZpbmVkJywKCQkJJ2Z1bmN0aW9uJzpmdW5jdGlvbiggZm4gKSB7CgkJCQl2YXIgcmV0ID0gJ2Z1bmN0aW9uJywKCQkJCQluYW1lID0gJ25hbWUnIGluIGZuID8gZm4ubmFtZSA6IChyZU5hbWUuZXhlYyhmbil8fFtdKVsxXTsvL2Z1bmN0aW9ucyBuZXZlciBoYXZlIG5hbWUgaW4gSUUKCQkJCWlmICggbmFtZSApCgkJCQkJcmV0ICs9ICcgJyArIG5hbWU7CgkJCQlyZXQgKz0gJygnOwoKCQkJCXJldCA9IFsgcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoIGZuLCAnZnVuY3Rpb25BcmdzJyApLCAnKXsnXS5qb2luKCcnKTsKCQkJCXJldHVybiBqb2luKCByZXQsIFFVbml0LmpzRHVtcC5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOwoJCQl9LAoJCQlhcnJheTogYXJyYXksCgkJCW5vZGVsaXN0OiBhcnJheSwKCQkJYXJndW1lbnRzOiBhcnJheSwKCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7CgkJCQl2YXIgcmV0ID0gWyBdOwoJCQkJUVVuaXQuanNEdW1wLnVwKCk7CgkJCQlmb3IgKCB2YXIga2V5IGluIG1hcCApCgkJCQkJcmV0LnB1c2goIFFVbml0LmpzRHVtcC5wYXJzZShrZXksJ2tleScpICsgJzogJyArIFFVbml0LmpzRHVtcC5wYXJzZShtYXBba2V5XSkgKTsKCQkJCVFVbml0LmpzRHVtcC5kb3duKCk7CgkJCQlyZXR1cm4gam9pbiggJ3snLCByZXQsICd9JyApOwoJCQl9LAoJCQlub2RlOmZ1bmN0aW9uKCBub2RlICkgewoJCQkJdmFyIG9wZW4gPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmbHQ7JyA6ICc8JywKCQkJCQljbG9zZSA9IFFVbml0LmpzRHVtcC5IVE1MID8gJyZndDsnIDogJz4nOwoKCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsKCgkJCQlmb3IgKCB2YXIgYSBpbiBRVW5pdC5qc0R1bXAuRE9NQXR0cnMgKSB7CgkJCQkJdmFyIHZhbCA9IG5vZGVbUVVuaXQuanNEdW1wLkRPTUF0dHJzW2FdXTsKCQkJCQlpZiAoIHZhbCApCgkJCQkJCXJldCArPSAnICcgKyBhICsgJz0nICsgUVVuaXQuanNEdW1wLnBhcnNlKCB2YWwsICdhdHRyaWJ1dGUnICk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7CgkJCX0sCgkJCWZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24KCQkJCXZhciBsID0gZm4ubGVuZ3RoOwoJCQkJaWYgKCAhbCApIHJldHVybiAnJzsKCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOwoJCQkJd2hpbGUgKCBsLS0gKQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwoJCQl9LAoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCgkJCXN0cmluZzpxdW90ZSwKCQkJZGF0ZTpxdW90ZSwKCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKCQkJbnVtYmVyOmxpdGVyYWwsCgkJCSdib29sZWFuJzpsaXRlcmFsCgkJfSwKCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKCQkJaWQ6J2lkJywKCQkJbmFtZTonbmFtZScsCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScKCQl9LAoJCUhUTUw6ZmFsc2UsLy9pZiB0cnVlLCBlbnRpdGllcyBhcmUgZXNjYXBlZCAoIDwsID4sIFx0LCBzcGFjZSBhbmQgXG4gKQoJCWluZGVudENoYXI6JyAgJywvL2luZGVudGF0aW9uIHVuaXQKCQltdWx0aWxpbmU6dHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KCX07CgoJcmV0dXJuIGpzRHVtcDsKfSkoKTsKCi8vIGZyb20gU2l6emxlLmpzCmZ1bmN0aW9uIGdldFRleHQoIGVsZW1zICkgewoJdmFyIHJldCA9ICIiLCBlbGVtOwoKCWZvciAoIHZhciBpID0gMDsgZWxlbXNbaV07IGkrKyApIHsKCQllbGVtID0gZWxlbXNbaV07CgoJCS8vIEdldCB0aGUgdGV4dCBmcm9tIHRleHQgbm9kZXMgYW5kIENEQVRBIG5vZGVzCgkJaWYgKCBlbGVtLm5vZGVUeXBlID09PSAzIHx8IGVsZW0ubm9kZVR5cGUgPT09IDQgKSB7CgkJCXJldCArPSBlbGVtLm5vZGVWYWx1ZTsKCgkJLy8gVHJhdmVyc2UgZXZlcnl0aGluZyBlbHNlLCBleGNlcHQgY29tbWVudCBub2RlcwoJCX0gZWxzZSBpZiAoIGVsZW0ubm9kZVR5cGUgIT09IDggKSB7CgkJCXJldCArPSBnZXRUZXh0KCBlbGVtLmNoaWxkTm9kZXMgKTsKCQl9Cgl9CgoJcmV0dXJuIHJldDsKfTsKCi8qCiAqIEphdmFzY3JpcHQgRGlmZiBBbGdvcml0aG0KICogIEJ5IEpvaG4gUmVzaWcgKGh0dHA6Ly9lam9obi5vcmcvKQogKiAgTW9kaWZpZWQgYnkgQ2h1IEFsYW4gInNwcml0ZSIKICoKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKgogKiBNb3JlIEluZm86CiAqICBodHRwOi8vZWpvaG4ub3JnL3Byb2plY3RzL2phdmFzY3JpcHQtZGlmZi1hbGdvcml0aG0vCiAqCiAqIFVzYWdlOiBRVW5pdC5kaWZmKGV4cGVjdGVkLCBhY3R1YWwpCiAqCiAqIFFVbml0LmRpZmYoInRoZSBxdWljayBicm93biBmb3gganVtcGVkIG92ZXIiLCAidGhlIHF1aWNrIGZveCBqdW1wcyBvdmVyIikgPT0gInRoZSAgcXVpY2sgPGRlbD5icm93biA8L2RlbD4gZm94IDxkZWw+anVtcGVkIDwvZGVsPjxpbnM+anVtcHMgPC9pbnM+IG92ZXIiCiAqLwpRVW5pdC5kaWZmID0gKGZ1bmN0aW9uKCkgewoJZnVuY3Rpb24gZGlmZihvLCBuKXsKCQl2YXIgbnMgPSBuZXcgT2JqZWN0KCk7CgkJdmFyIG9zID0gbmV3IE9iamVjdCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoOyBpKyspIHsKCQkJaWYgKG5zW25baV1dID09IG51bGwpCgkJCQluc1tuW2ldXSA9IHsKCQkJCQlyb3dzOiBuZXcgQXJyYXkoKSwKCQkJCQlvOiBudWxsCgkJCQl9OwoJCQluc1tuW2ldXS5yb3dzLnB1c2goaSk7CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IG8ubGVuZ3RoOyBpKyspIHsKCQkJaWYgKG9zW29baV1dID09IG51bGwpCgkJCQlvc1tvW2ldXSA9IHsKCQkJCQlyb3dzOiBuZXcgQXJyYXkoKSwKCQkJCQluOiBudWxsCgkJCQl9OwoJCQlvc1tvW2ldXS5yb3dzLnB1c2goaSk7CgkJfQoKCQlmb3IgKHZhciBpIGluIG5zKSB7CgkJCWlmIChuc1tpXS5yb3dzLmxlbmd0aCA9PSAxICYmIHR5cGVvZihvc1tpXSkgIT0gInVuZGVmaW5lZCIgJiYgb3NbaV0ucm93cy5sZW5ndGggPT0gMSkgewoJCQkJbltuc1tpXS5yb3dzWzBdXSA9IHsKCQkJCQl0ZXh0OiBuW25zW2ldLnJvd3NbMF1dLAoJCQkJCXJvdzogb3NbaV0ucm93c1swXQoJCQkJfTsKCQkJCW9bb3NbaV0ucm93c1swXV0gPSB7CgkJCQkJdGV4dDogb1tvc1tpXS5yb3dzWzBdXSwKCQkJCQlyb3c6IG5zW2ldLnJvd3NbMF0KCQkJCX07CgkJCX0KCQl9CgoJCWZvciAodmFyIGkgPSAwOyBpIDwgbi5sZW5ndGggLSAxOyBpKyspIHsKCQkJaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSArIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyArIDEgPCBvLmxlbmd0aCAmJiBvW25baV0ucm93ICsgMV0udGV4dCA9PSBudWxsICYmCgkJCW5baSArIDFdID09IG9bbltpXS5yb3cgKyAxXSkgewoJCQkJbltpICsgMV0gPSB7CgkJCQkJdGV4dDogbltpICsgMV0sCgkJCQkJcm93OiBuW2ldLnJvdyArIDEKCQkJCX07CgkJCQlvW25baV0ucm93ICsgMV0gPSB7CgkJCQkJdGV4dDogb1tuW2ldLnJvdyArIDFdLAoJCQkJCXJvdzogaSArIDEKCQkJCX07CgkJCX0KCQl9CgoJCWZvciAodmFyIGkgPSBuLmxlbmd0aCAtIDE7IGkgPiAwOyBpLS0pIHsKCQkJaWYgKG5baV0udGV4dCAhPSBudWxsICYmIG5baSAtIDFdLnRleHQgPT0gbnVsbCAmJiBuW2ldLnJvdyA+IDAgJiYgb1tuW2ldLnJvdyAtIDFdLnRleHQgPT0gbnVsbCAmJgoJCQluW2kgLSAxXSA9PSBvW25baV0ucm93IC0gMV0pIHsKCQkJCW5baSAtIDFdID0gewoJCQkJCXRleHQ6IG5baSAtIDFdLAoJCQkJCXJvdzogbltpXS5yb3cgLSAxCgkJCQl9OwoJCQkJb1tuW2ldLnJvdyAtIDFdID0gewoJCQkJCXRleHQ6IG9bbltpXS5yb3cgLSAxXSwKCQkJCQlyb3c6IGkgLSAxCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gewoJCQlvOiBvLAoJCQluOiBuCgkJfTsKCX0KCglyZXR1cm4gZnVuY3Rpb24obywgbil7CgkJbyA9IG8ucmVwbGFjZSgvXHMrJC8sICcnKTsKCQluID0gbi5yZXBsYWNlKC9ccyskLywgJycpOwoJCXZhciBvdXQgPSBkaWZmKG8gPT0gIiIgPyBbXSA6IG8uc3BsaXQoL1xzKy8pLCBuID09ICIiID8gW10gOiBuLnNwbGl0KC9ccysvKSk7CgoJCXZhciBzdHIgPSAiIjsKCgkJdmFyIG9TcGFjZSA9IG8ubWF0Y2goL1xzKy9nKTsKCQlpZiAob1NwYWNlID09IG51bGwpIHsKCQkJb1NwYWNlID0gWyIgIl07CgkJfQoJCWVsc2UgewoJCQlvU3BhY2UucHVzaCgiICIpOwoJCX0KCQl2YXIgblNwYWNlID0gbi5tYXRjaCgvXHMrL2cpOwoJCWlmIChuU3BhY2UgPT0gbnVsbCkgewoJCQluU3BhY2UgPSBbIiAiXTsKCQl9CgkJZWxzZSB7CgkJCW5TcGFjZS5wdXNoKCIgIik7CgkJfQoKCQlpZiAob3V0Lm4ubGVuZ3RoID09IDApIHsKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQuby5sZW5ndGg7IGkrKykgewoJCQkJc3RyICs9ICc8ZGVsPicgKyBvdXQub1tpXSArIG9TcGFjZVtpXSArICI8L2RlbD4iOwoJCQl9CgkJfQoJCWVsc2UgewoJCQlpZiAob3V0Lm5bMF0udGV4dCA9PSBudWxsKSB7CgkJCQlmb3IgKG4gPSAwOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7CgkJCQkJc3RyICs9ICc8ZGVsPicgKyBvdXQub1tuXSArIG9TcGFjZVtuXSArICI8L2RlbD4iOwoJCQkJfQoJCQl9CgoJCQlmb3IgKHZhciBpID0gMDsgaSA8IG91dC5uLmxlbmd0aDsgaSsrKSB7CgkJCQlpZiAob3V0Lm5baV0udGV4dCA9PSBudWxsKSB7CgkJCQkJc3RyICs9ICc8aW5zPicgKyBvdXQubltpXSArIG5TcGFjZVtpXSArICI8L2lucz4iOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJdmFyIHByZSA9ICIiOwoKCQkJCQlmb3IgKG4gPSBvdXQubltpXS5yb3cgKyAxOyBuIDwgb3V0Lm8ubGVuZ3RoICYmIG91dC5vW25dLnRleHQgPT0gbnVsbDsgbisrKSB7CgkJCQkJCXByZSArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsKCQkJCQl9CgkJCQkJc3RyICs9ICIgIiArIG91dC5uW2ldLnRleHQgKyBuU3BhY2VbaV0gKyBwcmU7CgkJCQl9CgkJCX0KCQl9CgoJCXJldHVybiBzdHI7Cgl9Owp9KSgpOwoKfSkodGhpcyk7",
                "body": "LyoKICogUVVuaXQgLSBBIEphdmFTY3JpcHQgVW5pdCBUZXN0aW5nIEZyYW1ld29yawogKgogKiBodHRwOi8vZG9jcy5qcXVlcnkuY29tL1FVbml0CiAqCiAqIENvcHlyaWdodCAoYykgMjAwOSBKb2huIFJlc2lnLCBKw7ZybiBaYWVmZmVyZXIKICogRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIChNSVQtTElDRU5TRS50eHQpCiAqIGFuZCBHUEwgKEdQTC1MSUNFTlNFLnR4dCkgbGljZW5zZXMuCiAqLwoKKGZ1bmN0aW9uKHdpbmRvdykgewoKdmFyIFFVbml0ID0gewoKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gb3B0aW9ucwoJaW5pdDogZnVuY3Rpb24gaW5pdCgpIHsKCQljb25maWcgPSB7CgkJCXN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCgkJCW1vZHVsZVN0YXRzOiB7IGFsbDogMCwgYmFkOiAwIH0sCgkJCXN0YXJ0ZWQ6ICtuZXcgRGF0ZSwKCQkJYmxvY2tpbmc6IGZhbHNlLAoJCQlhdXRvcnVuOiBmYWxzZSwKCQkJYXNzZXJ0aW9uczogW10sCgkJCWZpbHRlcnM6IFtdLAoJCQlxdWV1ZTogW10KCQl9OwoKCQl2YXIgdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKCQkJYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAoJCQlyZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKCQlpZiAoIHRlc3RzICkgewoJCQl0ZXN0cy5pbm5lckhUTUwgPSAiIjsKCQl9CgoJCWlmICggYmFubmVyICkgewoJCQliYW5uZXIuY2xhc3NOYW1lID0gIiI7CgkJfQoKCQlpZiAoIHJlc3VsdCApIHsKCQkJcmVzdWx0LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoIHJlc3VsdCApOwoJCX0KCX0sCgoJLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCgltb2R1bGU6IGZ1bmN0aW9uIG1vZHVsZShuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHsKCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJCQlRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOwoJCQl9CgoJCQljb25maWcuY3VycmVudE1vZHVsZSA9IG5hbWU7CgkJCWNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQgPSB0ZXN0RW52aXJvbm1lbnQ7CgkJCWNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsKCgkJCVFVbml0Lm1vZHVsZVN0YXJ0KCBuYW1lLCB0ZXN0RW52aXJvbm1lbnQgKTsKCQl9KTsKCX0sCgoJYXN5bmNUZXN0OiBmdW5jdGlvbiBhc3luY1Rlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaykgewoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSAwOwoJCX0KCgkJUVVuaXQudGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCB0cnVlKTsKCX0sCgoJdGVzdDogZnVuY3Rpb24gdGVzdCh0ZXN0TmFtZSwgZXhwZWN0ZWQsIGNhbGxiYWNrLCBhc3luYykgewoJCXZhciBuYW1lID0gdGVzdE5hbWUsIHRlc3RFbnZpcm9ubWVudCA9IHt9OwoKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgoJCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJCW5hbWUgPSBjb25maWcuY3VycmVudE1vZHVsZSArICIgbW9kdWxlOiAiICsgbmFtZTsKCQl9CgoJCWlmICggIXZhbGlkVGVzdChuYW1lKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCVFVbml0LnRlc3RTdGFydCggdGVzdE5hbWUgKTsKCgkJCXRlc3RFbnZpcm9ubWVudCA9IGV4dGVuZCh7CgkJCQlzZXR1cDogZnVuY3Rpb24oKSB7fSwKCQkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9CgkJCX0sIGNvbmZpZy5tb2R1bGVUZXN0RW52aXJvbm1lbnQpOwoKCQkJY29uZmlnLmFzc2VydGlvbnMgPSBbXTsKCQkJY29uZmlnLmV4cGVjdGVkID0gbnVsbDsKCgkJCWlmICggYXJndW1lbnRzLmxlbmd0aCA+PSAzICkgewoJCQkJY29uZmlnLmV4cGVjdGVkID0gY2FsbGJhY2s7CgkJCQljYWxsYmFjayA9IGFyZ3VtZW50c1syXTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmICggIWNvbmZpZy5wb2xsdXRpb24gKSB7CgkJCQkJc2F2ZUdsb2JhbCgpOwoJCQkJfQoKCQkJCXRlc3RFbnZpcm9ubWVudC5zZXR1cC5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiU2V0dXAgZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCQl9CgoJCQlpZiAoIGFzeW5jICkgewoJCQkJUVVuaXQuc3RvcCgpOwoJCQl9CgoJCQl0cnkgewoJCQkJY2FsbGJhY2suY2FsbCh0ZXN0RW52aXJvbm1lbnQpOwoJCQl9IGNhdGNoKGUpIHsKCQkJCWZhaWwoIlRlc3QgIiArIG5hbWUgKyAiIGRpZWQsIGV4Y2VwdGlvbiBhbmQgdGVzdCBmb2xsb3dzIiwgZSwgY2FsbGJhY2spOwoJCQkJUVVuaXQub2soIGZhbHNlLCAiRGllZCBvbiB0ZXN0ICMiICsgKGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSApOwoJCQkJLy8gZWxzZSBuZXh0IHRlc3Qgd2lsbCBjYXJyeSB0aGUgcmVzcG9uc2liaWxpdHkKCQkJCXNhdmVHbG9iYWwoKTsKCgkJCQkvLyBSZXN0YXJ0IHRoZSB0ZXN0cyBpZiB0aGV5J3JlIGJsb2NraW5nCgkJCQlpZiAoIGNvbmZpZy5ibG9ja2luZyApIHsKCQkJCQlzdGFydCgpOwoJCQkJfQoJCQl9CgkJfSk7CgoJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQl0cnkgewoJCQkJY2hlY2tQb2xsdXRpb24oKTsKCQkJCXRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRlc3RFbnZpcm9ubWVudCk7CgkJCX0gY2F0Y2goZSkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyBuYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCQl9CgoJCQl0cnkgewoJCQkJUVVuaXQucmVzZXQoKTsKCQkJfSBjYXRjaChlKSB7CgkJCQlmYWlsKCJyZXNldCgpIGZhaWxlZCwgZm9sbG93aW5nIFRlc3QgIiArIG5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCByZXNldCk7CgkJCX0KCgkJCWlmICggY29uZmlnLmV4cGVjdGVkICYmIGNvbmZpZy5leHBlY3RlZCAhPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJFeHBlY3RlZCAiICsgY29uZmlnLmV4cGVjdGVkICsgIiBhc3NlcnRpb25zLCBidXQgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIgd2VyZSBydW4iICk7CgkJCX0KCgkJCXZhciBnb29kID0gMCwgYmFkID0gMCwKCQkJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CgoJCQljb25maWcuc3RhdHMuYWxsICs9IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsKCQkJY29uZmlnLm1vZHVsZVN0YXRzLmFsbCArPSBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7CgoJCQlpZiAoIHRlc3RzICkgewoJCQkJdmFyIG9sICA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoIm9sIik7CgkJCQlvbC5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKCQkJCWZvciAoIHZhciBpID0gMDsgaSA8IGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJCXZhciBhc3NlcnRpb24gPSBjb25maWcuYXNzZXJ0aW9uc1tpXTsKCgkJCQkJdmFyIGxpID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGkiKTsKCQkJCQlsaS5jbGFzc05hbWUgPSBhc3NlcnRpb24ucmVzdWx0ID8gInBhc3MiIDogImZhaWwiOwoJCQkJCWxpLmlubmVySFRNTCA9IGFzc2VydGlvbi5tZXNzYWdlIHx8ICIobm8gbWVzc2FnZSkiOwoJCQkJCW9sLmFwcGVuZENoaWxkKCBsaSApOwoKCQkJCQlpZiAoIGFzc2VydGlvbi5yZXN1bHQgKSB7CgkJCQkJCWdvb2QrKzsKCQkJCQl9IGVsc2UgewoJCQkJCQliYWQrKzsKCQkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCQljb25maWcubW9kdWxlU3RhdHMuYmFkKys7CgkJCQkJfQoJCQkJfQoKCQkJCXZhciBiID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3Ryb25nIik7CgkJCQliLmlubmVySFRNTCA9IG5hbWUgKyAiIDxiIHN0eWxlPSdjb2xvcjpibGFjazsnPig8YiBjbGFzcz0nZmFpbCc+IiArIGJhZCArICI8L2I+LCA8YiBjbGFzcz0ncGFzcyc+IiArIGdvb2QgKyAiPC9iPiwgIiArIGNvbmZpZy5hc3NlcnRpb25zLmxlbmd0aCArICIpPC9iPiI7CgoJCQkJYWRkRXZlbnQoYiwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCQkJdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5OwoJCQkJCW5leHQuc3R5bGUuZGlzcGxheSA9IGRpc3BsYXkgPT09ICJub25lIiA/ICJibG9jayIgOiAibm9uZSI7CgkJCQl9KTsKCgkJCQlhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7CgkJCQkJdmFyIHRhcmdldCA9IChlIHx8IHdpbmRvdy5ldmVudCkudGFyZ2V0OwoJCQkJCWlmICggdGFyZ2V0Lm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJzdHJvbmciICkgewoJCQkJCQl2YXIgdGV4dCA9ICIiLCBub2RlID0gdGFyZ2V0LmZpcnN0Q2hpbGQ7CgoJCQkJCQl3aGlsZSAoIG5vZGUubm9kZVR5cGUgPT09IDMgKSB7CgkJCQkJCQl0ZXh0ICs9IG5vZGUubm9kZVZhbHVlOwoJCQkJCQkJbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CgkJCQkJCX0KCgkJCQkJCXRleHQgPSB0ZXh0LnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKTsKCgkJCQkJCWlmICggd2luZG93LmxvY2F0aW9uICkgewoJCQkJCQkJd2luZG93LmxvY2F0aW9uLmhyZWYgPSB3aW5kb3cubG9jYXRpb24uaHJlZi5tYXRjaCgvXiguKz8pKFw/LiopPyQvKVsxXSArICI/IiArIGVuY29kZVVSSUNvbXBvbmVudCh0ZXh0KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0pOwoKCQkJCXZhciBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImxpIik7CgkJCQlsaS5jbGFzc05hbWUgPSBiYWQgPyAiZmFpbCIgOiAicGFzcyI7CgkJCQlsaS5hcHBlbmRDaGlsZCggYiApOwoJCQkJbGkuYXBwZW5kQ2hpbGQoIG9sICk7CgkJCQl0ZXN0cy5hcHBlbmRDaGlsZCggbGkgKTsKCgkJCQlpZiAoIGJhZCApIHsKCQkJCQl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKCQkJCQlpZiAoIHRvb2xiYXIgKSB7CgkJCQkJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQkJCWlkKCJxdW5pdC1maWx0ZXItcGFzcyIpLmRpc2FibGVkID0gbnVsbDsKCQkJCQkJaWQoInF1bml0LWZpbHRlci1taXNzaW5nIikuZGlzYWJsZWQgPSBudWxsOwoJCQkJCX0KCQkJCX0KCgkJCX0gZWxzZSB7CgkJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCQlpZiAoICFjb25maWcuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7CgkJCQkJCWJhZCsrOwoJCQkJCQljb25maWcuc3RhdHMuYmFkKys7CgkJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCVFVbml0LnRlc3REb25lKCB0ZXN0TmFtZSwgYmFkLCBjb25maWcuYXNzZXJ0aW9ucy5sZW5ndGggKTsKCgkJCWlmICggIXdpbmRvdy5zZXRUaW1lb3V0ICYmICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJZG9uZSgpOwoJCQl9CgkJfSk7CgoJCWlmICggd2luZG93LnNldFRpbWVvdXQgJiYgIWNvbmZpZy5kb25lVGltZXIgKSB7CgkJCWNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewoJCQkJaWYgKCAhY29uZmlnLnF1ZXVlLmxlbmd0aCApIHsKCQkJCQlkb25lKCk7CgkJCQl9IGVsc2UgewoJCQkJCXN5bmNocm9uaXplKCBkb25lICk7CgkJCQl9CgkJCX0sIDEzKTsKCQl9Cgl9LAoKCS8qKgoJICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgoJICovCglleHBlY3Q6IGZ1bmN0aW9uIGV4cGVjdChhc3NlcnRzKSB7CgkJY29uZmlnLmV4cGVjdGVkID0gYXNzZXJ0czsKCX0sCgoJLyoqCgkgKiBBc3NlcnRzIHRydWUuCgkgKiBAZXhhbXBsZSBvayggImFzZGZhc2RmIi5sZW5ndGggPiA1LCAiVGhlcmUgbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzIiApOwoJICovCglvazogZnVuY3Rpb24gb2soYSwgbXNnKSB7CgkJUVVuaXQubG9nKGEsIG1zZyk7CgoJCWNvbmZpZy5hc3NlcnRpb25zLnB1c2goewoJCQlyZXN1bHQ6ICEhYSwKCQkJbWVzc2FnZTogbXNnCgkJfSk7Cgl9LAoKCS8qKgoJICogQ2hlY2tzIHRoYXQgdGhlIGZpcnN0IHR3byBhcmd1bWVudHMgYXJlIGVxdWFsLCB3aXRoIGFuIG9wdGlvbmFsIG1lc3NhZ2UuCgkgKiBQcmludHMgb3V0IGJvdGggYWN0dWFsIGFuZCBleHBlY3RlZCB2YWx1ZXMuCgkgKgoJICogUHJlZmVyZWQgdG8gb2soIGFjdHVhbCA9PSBleHBlY3RlZCwgbWVzc2FnZSApCgkgKgoJICogQGV4YW1wbGUgZXF1YWxzKCBmb3JtYXQoIlJlY2VpdmVkIHswfSBieXRlcy4iLCAyKSwgIlJlY2VpdmVkIDIgYnl0ZXMuIiApOwoJICoKCSAqIEBwYXJhbSBPYmplY3QgYWN0dWFsCgkgKiBAcGFyYW0gT2JqZWN0IGV4cGVjdGVkCgkgKiBAcGFyYW0gU3RyaW5nIG1lc3NhZ2UgKG9wdGlvbmFsKQoJICovCgllcXVhbHM6IGZ1bmN0aW9uIGVxdWFscyhhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJcHVzaChleHBlY3RlZCA9PSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglzYW1lOiBmdW5jdGlvbihhLCBiLCBtZXNzYWdlKSB7CgkJcHVzaChRVW5pdC5lcXVpdihhLCBiKSwgYSwgYiwgbWVzc2FnZSk7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbiBzdGFydCgpIHsKCQkvLyBBIHNsaWdodCBkZWxheSwgdG8gYXZvaWQgYW55IGN1cnJlbnQgY2FsbGJhY2tzCgkJaWYgKCB3aW5kb3cuc2V0VGltZW91dCApIHsKCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNvbmZpZy50aW1lb3V0ICkgewoJCQkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CgkJCQl9CgoJCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgkJCQlwcm9jZXNzKCk7CgkJCX0sIDEzKTsKCQl9IGVsc2UgewoJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJcHJvY2VzcygpOwoJCX0KCX0sCgoJc3RvcDogZnVuY3Rpb24gc3RvcCh0aW1lb3V0KSB7CgkJY29uZmlnLmJsb2NraW5nID0gdHJ1ZTsKCgkJaWYgKCB0aW1lb3V0ICYmIHdpbmRvdy5zZXRUaW1lb3V0ICkgewoJCQljb25maWcudGltZW91dCA9IHdpbmRvdy5zZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJUVVuaXQub2soIGZhbHNlLCAiVGVzdCB0aW1lZCBvdXQiICk7CgkJCQlRVW5pdC5zdGFydCgpOwoJCQl9LCB0aW1lb3V0KTsKCQl9Cgl9LAoKCS8qKgoJICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCgkgKi8KCXJlc2V0OiBmdW5jdGlvbiByZXNldCgpIHsKCQlpZiAoIHdpbmRvdy5qUXVlcnkgKSB7CgkJCWpRdWVyeSgiI21haW4iKS5odG1sKCBjb25maWcuZml4dHVyZSApOwoJCQlqUXVlcnkuZXZlbnQuZ2xvYmFsID0ge307CgkJCWpRdWVyeS5hamF4U2V0dGluZ3MgPSBleHRlbmQoe30sIGNvbmZpZy5hamF4U2V0dGluZ3MpOwoJCX0KCX0sCgoJLyoqCgkgKiBUcmlnZ2VyIGFuIGV2ZW50IG9uIGFuIGVsZW1lbnQuCgkgKgoJICogQGV4YW1wbGUgdHJpZ2dlckV2ZW50KCBkb2N1bWVudC5ib2R5LCAiY2xpY2siICk7CgkgKgoJICogQHBhcmFtIERPTUVsZW1lbnQgZWxlbQoJICogQHBhcmFtIFN0cmluZyB0eXBlCgkgKi8KCXRyaWdnZXJFdmVudDogZnVuY3Rpb24gdHJpZ2dlckV2ZW50KCBlbGVtLCB0eXBlLCBldmVudCApIHsKCQlpZiAoIGRvY3VtZW50LmNyZWF0ZUV2ZW50ICkgewoJCQlldmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50KCJNb3VzZUV2ZW50cyIpOwoJCQlldmVudC5pbml0TW91c2VFdmVudCh0eXBlLCB0cnVlLCB0cnVlLCBlbGVtLm93bmVyRG9jdW1lbnQuZGVmYXVsdFZpZXcsCgkJCQkwLCAwLCAwLCAwLCAwLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgMCwgbnVsbCk7CgkJCWVsZW0uZGlzcGF0Y2hFdmVudCggZXZlbnQgKTsKCgkJfSBlbHNlIGlmICggZWxlbS5maXJlRXZlbnQgKSB7CgkJCWVsZW0uZmlyZUV2ZW50KCJvbiIrdHlwZSk7CgkJfQoJfSwKCgkvLyBMb2dnaW5nIGNhbGxiYWNrcwoJZG9uZTogZnVuY3Rpb24gZG9uZShmYWlsdXJlcywgdG90YWwpIHt9LAoJbG9nOiBmdW5jdGlvbiBsb2cocmVzdWx0LCBtZXNzYWdlKSB7fSwKCXRlc3RTdGFydDogZnVuY3Rpb24gdGVzdFN0YXJ0KG5hbWUpIHt9LAoJdGVzdERvbmU6IGZ1bmN0aW9uIHRlc3REb25lKG5hbWUsIGZhaWx1cmVzLCB0b3RhbCkge30sCgltb2R1bGVTdGFydDogZnVuY3Rpb24gbW9kdWxlU3RhcnQobmFtZSwgdGVzdEVudmlyb25tZW50KSB7fSwKCW1vZHVsZURvbmU6IGZ1bmN0aW9uIG1vZHVsZURvbmUobmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fQp9OwoKLy8gTWFpbnRhaW4gaW50ZXJuYWwgc3RhdGUKdmFyIGNvbmZpZyA9IHsKCS8vIFRoZSBxdWV1ZSBvZiB0ZXN0cyB0byBydW4KCXF1ZXVlOiBbXSwKCgkvLyBibG9jayB1bnRpbCBkb2N1bWVudCByZWFkeQoJYmxvY2tpbmc6IHRydWUKfTsKCi8vIExvYWQgcGFyYW1hdGVycwooZnVuY3Rpb24oKSB7Cgl2YXIgbG9jYXRpb24gPSB3aW5kb3cubG9jYXRpb24gfHwgeyBzZWFyY2g6ICIiLCBwcm90b2NvbDogImZpbGU6IiB9LAoJCUdFVFBhcmFtcyA9IGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKS5zcGxpdCgnJicpOwoKCWZvciAoIHZhciBpID0gMDsgaSA8IEdFVFBhcmFtcy5sZW5ndGg7IGkrKyApIHsKCQlHRVRQYXJhbXNbaV0gPSBkZWNvZGVVUklDb21wb25lbnQoIEdFVFBhcmFtc1tpXSApOwoJCWlmICggR0VUUGFyYW1zW2ldID09PSAibm9nbG9iYWxzIiApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJCWNvbmZpZy5ub2dsb2JhbHMgPSB0cnVlOwoJCX0KCX0KCgkvLyByZXN0cmljdCBtb2R1bGVzL3Rlc3RzIGJ5IGdldCBwYXJhbWV0ZXJzCgljb25maWcuZmlsdGVycyA9IEdFVFBhcmFtczsKCgkvLyBGaWd1cmUgb3V0IGlmIHdlJ3JlIHJ1bm5pbmcgdGhlIHRlc3RzIGZyb20gYSBzZXJ2ZXIgb3Igbm90CglRVW5pdC5pc0xvY2FsID0gISEobG9jYXRpb24ucHJvdG9jb2wgPT09ICdmaWxlOicpOwp9KSgpOwoKLy8gRXhwb3NlIHRoZSBBUEkgYXMgZ2xvYmFsIHZhcmlhYmxlcywgdW5sZXNzIGFuICdleHBvcnRzJwovLyBvYmplY3QgZXhpc3RzLCBpbiB0aGF0IGNhc2Ugd2UgYXNzdW1lIHdlJ3JlIGluIENvbW1vbkpTCmlmICggdHlwZW9mIGV4cG9ydHMgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZiByZXF1aXJlID09PSAidW5kZWZpbmVkIiApIHsKCWV4dGVuZCh3aW5kb3csIFFVbml0KTsKCXdpbmRvdy5RVW5pdCA9IFFVbml0Owp9IGVsc2UgewoJZXh0ZW5kKGV4cG9ydHMsIFFVbml0KTsKCWV4cG9ydHMuUVVuaXQgPSBRVW5pdDsKfQoKaWYgKCB0eXBlb2YgZG9jdW1lbnQgPT09ICJ1bmRlZmluZWQiIHx8IGRvY3VtZW50LnJlYWR5U3RhdGUgPT09ICJjb21wbGV0ZSIgKSB7Cgljb25maWcuYXV0b3J1biA9IHRydWU7Cn0KCmFkZEV2ZW50KHdpbmRvdywgImxvYWQiLCBmdW5jdGlvbigpIHsKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKCXZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7CglRVW5pdC5pbml0KCk7CglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoKCXZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7CglpZiAoIHVzZXJBZ2VudCApIHsKCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCX0KCgl2YXIgdG9vbGJhciA9IGlkKCJxdW5pdC10ZXN0cnVubmVyLXRvb2xiYXIiKTsKCWlmICggdG9vbGJhciApIHsKCQl0b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CgoJCXZhciBmaWx0ZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCWZpbHRlci50eXBlID0gImNoZWNrYm94IjsKCQlmaWx0ZXIuaWQgPSAicXVuaXQtZmlsdGVyLXBhc3MiOwoJCWZpbHRlci5kaXNhYmxlZCA9IHRydWU7CgkJYWRkRXZlbnQoIGZpbHRlciwgImNsaWNrIiwgZnVuY3Rpb24oKSB7CgkJCXZhciBsaSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJsaSIpOwoJCQlmb3IgKCB2YXIgaSA9IDA7IGkgPCBsaS5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggbGlbaV0uY2xhc3NOYW1lLmluZGV4T2YoInBhc3MiKSA+IC0xICkgewoJCQkJCWxpW2ldLnN0eWxlLmRpc3BsYXkgPSBmaWx0ZXIuY2hlY2tlZCA/ICJub25lIiA6ICJibG9jayI7CgkJCQl9CgkJCX0KCQl9KTsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsKCgkJdmFyIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJmaWx0ZXItcGFzcyIpOwoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsKCgkJdmFyIG1pc3NpbmcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwoJCW1pc3NpbmcudHlwZSA9ICJjaGVja2JveCI7CgkJbWlzc2luZy5pZCA9ICJxdW5pdC1maWx0ZXItbWlzc2luZyI7CgkJbWlzc2luZy5kaXNhYmxlZCA9IHRydWU7CgkJYWRkRXZlbnQoIG1pc3NpbmcsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQl2YXIgbGkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgbGkubGVuZ3RoOyBpKysgKSB7CgkJCQlpZiAoIGxpW2ldLmNsYXNzTmFtZS5pbmRleE9mKCJmYWlsIikgPiAtMSAmJiBsaVtpXS5pbm5lckhUTUwuaW5kZXhPZignbWlzc2luZyB0ZXN0IC0gdW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZScpID4gLSAxICkgewoJCQkJCWxpW2ldLnBhcmVudE5vZGUucGFyZW50Tm9kZS5zdHlsZS5kaXNwbGF5ID0gbWlzc2luZy5jaGVja2VkID8gIm5vbmUiIDogImJsb2NrIjsKCQkJCX0KCQkJfQoJCX0pOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIG1pc3NpbmcgKTsKCgkJbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwoJCWxhYmVsLnNldEF0dHJpYnV0ZSgiZm9yIiwgImZpbHRlci1taXNzaW5nIik7CgkJbGFiZWwuaW5uZXJIVE1MID0gIkhpZGUgbWlzc2luZyB0ZXN0cyAodW50ZXN0ZWQgY29kZSBpcyBicm9rZW4gY29kZSkiOwoJCXRvb2xiYXIuYXBwZW5kQ2hpbGQoIGxhYmVsICk7Cgl9CgoJdmFyIG1haW4gPSBpZCgnbWFpbicpOwoJaWYgKCBtYWluICkgewoJCWNvbmZpZy5maXh0dXJlID0gbWFpbi5pbm5lckhUTUw7Cgl9CgoJaWYgKCB3aW5kb3cualF1ZXJ5ICkgewoJCWNvbmZpZy5hamF4U2V0dGluZ3MgPSB3aW5kb3cualF1ZXJ5LmFqYXhTZXR0aW5nczsKCX0KCglRVW5pdC5zdGFydCgpOwp9KTsKCmZ1bmN0aW9uIGRvbmUoKSB7CglpZiAoIGNvbmZpZy5kb25lVGltZXIgJiYgd2luZG93LmNsZWFyVGltZW91dCApIHsKCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCBjb25maWcuZG9uZVRpbWVyICk7CgkJY29uZmlnLmRvbmVUaW1lciA9IG51bGw7Cgl9CgoJaWYgKCBjb25maWcucXVldWUubGVuZ3RoICkgewoJCWNvbmZpZy5kb25lVGltZXIgPSB3aW5kb3cuc2V0VGltZW91dChmdW5jdGlvbigpewoJCQlpZiAoICFjb25maWcucXVldWUubGVuZ3RoICkgewoJCQkJZG9uZSgpOwoJCQl9IGVsc2UgewoJCQkJc3luY2hyb25pemUoIGRvbmUgKTsKCQkJfQoJCX0sIDEzKTsKCgkJcmV0dXJuOwoJfQoKCWNvbmZpZy5hdXRvcnVuID0gdHJ1ZTsKCgkvLyBMb2cgdGhlIGxhc3QgbW9kdWxlIHJlc3VsdHMKCWlmICggY29uZmlnLmN1cnJlbnRNb2R1bGUgKSB7CgkJUVVuaXQubW9kdWxlRG9uZSggY29uZmlnLmN1cnJlbnRNb2R1bGUsIGNvbmZpZy5tb2R1bGVTdGF0cy5iYWQsIGNvbmZpZy5tb2R1bGVTdGF0cy5hbGwgKTsKCX0KCgl2YXIgYmFubmVyID0gaWQoInF1bml0LWJhbm5lciIpLAoJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCgkJaHRtbCA9IFsnVGVzdHMgY29tcGxldGVkIGluICcsCgkJK25ldyBEYXRlIC0gY29uZmlnLnN0YXJ0ZWQsICcgbWlsbGlzZWNvbmRzLjxici8+JywKCQknPHNwYW4gY2xhc3M9ImJhZCI+JywgY29uZmlnLnN0YXRzLmFsbCAtIGNvbmZpZy5zdGF0cy5iYWQsICc8L3NwYW4+IHRlc3RzIG9mIDxzcGFuIGNsYXNzPSJhbGwiPicsIGNvbmZpZy5zdGF0cy5hbGwsICc8L3NwYW4+IHBhc3NlZCwgJywgY29uZmlnLnN0YXRzLmJhZCwnIGZhaWxlZC4nXS5qb2luKCcnKTsKCglpZiAoIGJhbm5lciApIHsKCQliYW5uZXIuY2xhc3NOYW1lICs9ICIgIiArIChjb25maWcuc3RhdHMuYmFkID8gImZhaWwiIDogInBhc3MiKTsKCX0KCglpZiAoIHRlc3RzICkgewoJCXZhciByZXN1bHQgPSBpZCgicXVuaXQtdGVzdHJlc3VsdCIpOwoKCQlpZiAoICFyZXN1bHQgKSB7CgkJCXJlc3VsdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInAiKTsKCQkJcmVzdWx0LmlkID0gInF1bml0LXRlc3RyZXN1bHQiOwoJCQlyZXN1bHQuY2xhc3NOYW1lID0gInJlc3VsdCI7CgkJCXRlc3RzLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKCByZXN1bHQsIHRlc3RzLm5leHRTaWJsaW5nICk7CgkJfQoKCQlyZXN1bHQuaW5uZXJIVE1MID0gaHRtbDsKCX0KCglRVW5pdC5kb25lKCBjb25maWcuc3RhdHMuYmFkLCBjb25maWcuc3RhdHMuYWxsICk7Cn0KCmZ1bmN0aW9uIHZhbGlkVGVzdCggbmFtZSApIHsKCXZhciBpID0gY29uZmlnLmZpbHRlcnMubGVuZ3RoLAoJCXJ1biA9IGZhbHNlOwoKCWlmICggIWkgKSB7CgkJcmV0dXJuIHRydWU7Cgl9CgoJd2hpbGUgKCBpLS0gKSB7CgkJdmFyIGZpbHRlciA9IGNvbmZpZy5maWx0ZXJzW2ldLAoJCQlub3QgPSBmaWx0ZXIuY2hhckF0KDApID09ICchJzsKCgkJaWYgKCBub3QgKSB7CgkJCWZpbHRlciA9IGZpbHRlci5zbGljZSgxKTsKCQl9CgoJCWlmICggbmFtZS5pbmRleE9mKGZpbHRlcikgIT09IC0xICkgewoJCQlyZXR1cm4gIW5vdDsKCQl9CgoJCWlmICggbm90ICkgewoJCQlydW4gPSB0cnVlOwoJCX0KCX0KCglyZXR1cm4gcnVuOwp9CgpmdW5jdGlvbiBwdXNoKHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJbWVzc2FnZSA9IG1lc3NhZ2UgfHwgKHJlc3VsdCA/ICJva2F5IiA6ICJmYWlsZWQiKTsKCVFVbml0Lm9rKCByZXN1bHQsIHJlc3VsdCA/IG1lc3NhZ2UgKyAiOiAiICsgZXhwZWN0ZWQgOiBtZXNzYWdlICsgIiwgZXhwZWN0ZWQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoZXhwZWN0ZWQpICsgIiByZXN1bHQ6ICIgKyBRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSApOwp9CgpmdW5jdGlvbiBzeW5jaHJvbml6ZSggY2FsbGJhY2sgKSB7Cgljb25maWcucXVldWUucHVzaCggY2FsbGJhY2sgKTsKCglpZiAoIGNvbmZpZy5hdXRvcnVuICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJcHJvY2VzcygpOwoJfQp9CgpmdW5jdGlvbiBwcm9jZXNzKCkgewoJd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsKCX0KfQoKZnVuY3Rpb24gc2F2ZUdsb2JhbCgpIHsKCWNvbmZpZy5wb2xsdXRpb24gPSBbXTsKCglpZiAoIGNvbmZpZy5ub2dsb2JhbHMgKSB7CgkJZm9yICggdmFyIGtleSBpbiB3aW5kb3cgKSB7CgkJCWNvbmZpZy5wb2xsdXRpb24ucHVzaCgga2V5ICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBjaGVja1BvbGx1dGlvbiggbmFtZSApIHsKCXZhciBvbGQgPSBjb25maWcucG9sbHV0aW9uOwoJc2F2ZUdsb2JhbCgpOwoKCXZhciBuZXdHbG9iYWxzID0gZGlmZiggb2xkLCBjb25maWcucG9sbHV0aW9uICk7CglpZiAoIG5ld0dsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJJbnRyb2R1Y2VkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIG5ld0dsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5leHBlY3RlZCsrOwoJfQoKCXZhciBkZWxldGVkR2xvYmFscyA9IGRpZmYoIGNvbmZpZy5wb2xsdXRpb24sIG9sZCApOwoJaWYgKCBkZWxldGVkR2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkRlbGV0ZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgZGVsZXRlZEdsb2JhbHMuam9pbigiLCAiKSApOwoJCWNvbmZpZy5leHBlY3RlZCsrOwoJfQp9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7Cgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrICkgewoJCWZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7CgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgewoJCQkJcmVzdWx0LnNwbGljZShpLCAxKTsKCQkJCWktLTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CglpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOwoJCWNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsKCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgoJfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsKCQlvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7Cgl9Cn0KCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7Cglmb3IgKCB2YXIgcHJvcCBpbiBiICkgewoJCWFbcHJvcF0gPSBiW3Byb3BdOwoJfQoKCXJldHVybiBhOwp9CgpmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7Cgl9IGVsc2UgewoJCWZuKCk7Cgl9Cn0KCmZ1bmN0aW9uIGlkKG5hbWUpIHsKCXJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJgoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7Cn0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwoKCiAgICAvLyBEZXRlcm1pbmUgd2hhdCBpcyBvLgogICAgZnVuY3Rpb24gaG9veml0KG8pIHsKICAgICAgICBpZiAoby5jb25zdHJ1Y3RvciA9PT0gU3RyaW5nKSB7CiAgICAgICAgICAgIHJldHVybiAic3RyaW5nIjsKCiAgICAgICAgfSBlbHNlIGlmIChvLmNvbnN0cnVjdG9yID09PSBCb29sZWFuKSB7CiAgICAgICAgICAgIHJldHVybiAiYm9vbGVhbiI7CgogICAgICAgIH0gZWxzZSBpZiAoby5jb25zdHJ1Y3RvciA9PT0gTnVtYmVyKSB7CgogICAgICAgICAgICBpZiAoaXNOYU4obykpIHsKICAgICAgICAgICAgICAgIHJldHVybiAibmFuIjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiAibnVtYmVyIjsKICAgICAgICAgICAgfQoKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICByZXR1cm4gInVuZGVmaW5lZCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CiAgICAgICAgfSBlbHNlIGlmIChvID09PSBudWxsKSB7CiAgICAgICAgICAgIHJldHVybiAibnVsbCI7CgogICAgICAgIC8vIGNvbnNpZGVyOiB0eXBlb2YgW10gPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIEFycmF5KSB7CiAgICAgICAgICAgIHJldHVybiAiYXJyYXkiOwoKICAgICAgICAvLyBjb25zaWRlcjogdHlwZW9mIG5ldyBEYXRlKCkgPT09IG9iamVjdAogICAgICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgICAgcmV0dXJuICJkYXRlIjsKCiAgICAgICAgLy8gY29uc2lkZXI6IC8uLyBpbnN0YW5jZW9mIE9iamVjdDsKICAgICAgICAvLyAgICAgICAgICAgLy4vIGluc3RhbmNlb2YgUmVnRXhwOwogICAgICAgIC8vICAgICAgICAgIHR5cGVvZiAvLi8gPT09ICJmdW5jdGlvbiI7IC8vID0+IGZhbHNlIGluIElFIGFuZCBPcGVyYSwKICAgICAgICAvLyAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRydWUgaW4gRkYgYW5kIFNhZmFyaQogICAgICAgIH0gZWxzZSBpZiAobyBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gInJlZ2V4cCI7CgogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIG8gPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIHJldHVybiAib2JqZWN0IjsKCiAgICAgICAgfSBlbHNlIGlmIChvIGluc3RhbmNlb2YgRnVuY3Rpb24pIHsKICAgICAgICAgICAgcmV0dXJuICJmdW5jdGlvbiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICB9CiAgICB9CgogICAgLy8gQ2FsbCB0aGUgbyByZWxhdGVkIGNhbGxiYWNrIHdpdGggdGhlIGdpdmVuIGFyZ3VtZW50cy4KICAgIGZ1bmN0aW9uIGhhbmRsZUV2ZW50cyhvLCBjYWxsYmFja3MsIGFyZ3MpIHsKICAgICAgICB2YXIgcHJvcCA9IGhvb3ppdChvKTsKICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBpZiAoaG9veml0KGNhbGxiYWNrc1twcm9wXSkgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF0uYXBwbHkoY2FsbGJhY2tzLCBhcmdzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsYmFja3NbcHJvcF07IC8vIG9yIHVuZGVmaW5lZAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIHZhciBjYWxsYmFja3MgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgIC8vIGZvciBzdHJpbmcsIGJvb2xlYW4sIG51bWJlciBhbmQgbnVsbAogICAgICAgIGZ1bmN0aW9uIHVzZVN0cmljdEVxdWFsaXR5KGIsIGEpIHsKICAgICAgICAgICAgaWYgKGIgaW5zdGFuY2VvZiBhLmNvbnN0cnVjdG9yIHx8IGEgaW5zdGFuY2VvZiBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAvLyB0byBjYXRjaCBzaG9ydCBhbm5vdGFpb24gVlMgJ25ldycgYW5ub3RhdGlvbiBvZiBhIGRlY2xhcmF0aW9uCiAgICAgICAgICAgICAgICAvLyBlLmcuIHZhciBpID0gMTsKICAgICAgICAgICAgICAgIC8vICAgICAgdmFyIGogPSBuZXcgTnVtYmVyKDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIGEgPT0gYjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHJldHVybiBhID09PSBiOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RyaW5nIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJib29sZWFuIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudW1iZXIiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgIm51bGwiOiB1c2VTdHJpY3RFcXVhbGl0eSwKICAgICAgICAgICAgInVuZGVmaW5lZCI6IHVzZVN0cmljdEVxdWFsaXR5LAoKICAgICAgICAgICAgIm5hbiI6IGZ1bmN0aW9uIChiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNOYU4oYik7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAiZGF0ZSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAiZGF0ZSIgJiYgYS52YWx1ZU9mKCkgPT09IGIudmFsdWVPZigpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgInJlZ2V4cCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaG9veml0KGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY2FsbGVyICE9PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaTsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICBpZiAoICEgKGhvb3ppdChiKSA9PT0gImFycmF5IikpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGVuID0gYS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAobGVuICE9PSBiLmxlbmd0aCkgeyAvLyBzYWZlIGFuZCBmYXN0ZXIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICBpZiAoICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAib2JqZWN0IjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHZhciBpOwogICAgICAgICAgICAgICAgdmFyIGVxID0gdHJ1ZTsgLy8gdW5sZXNzIHdlIGNhbiBwcm9vdmUgaXQKICAgICAgICAgICAgICAgIHZhciBhUHJvcGVydGllcyA9IFtdLCBiUHJvcGVydGllcyA9IFtdOyAvLyBjb2xsZWN0aW9uIG9mIHN0cmluZ3MKCiAgICAgICAgICAgICAgICAvLyBjb21wYXJpbmcgY29uc3RydWN0b3JzIGlzIG1vcmUgc3RyaWN0IHRoYW4gdXNpbmcgaW5zdGFuY2VvZgogICAgICAgICAgICAgICAgaWYgKCBhLmNvbnN0cnVjdG9yICE9PSBiLmNvbnN0cnVjdG9yKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIHN0YWNrIGNvbnN0cnVjdG9yIGJlZm9yZSB0cmF2ZXJzaW5nIHByb3BlcnRpZXMKICAgICAgICAgICAgICAgIGNhbGxlcnMucHVzaChhLmNvbnN0cnVjdG9yKTsKCiAgICAgICAgICAgICAgICBmb3IgKGkgaW4gYSkgeyAvLyBiZSBzdHJpY3Q6IGRvbid0IGVuc3VyZXMgaGFzT3duUHJvcGVydHkgYW5kIGdvIGRlZXAKCiAgICAgICAgICAgICAgICAgICAgYVByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBhJ3MgcHJvcGVydGllcwoKICAgICAgICAgICAgICAgICAgICBpZiAoICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICBjYWxsZXJzLnBvcCgpOyAvLyB1bnN0YWNrLCB3ZSBhcmUgZG9uZQoKICAgICAgICAgICAgICAgIGZvciAoaSBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgYlByb3BlcnRpZXMucHVzaChpKTsgLy8gY29sbGVjdCBiJ3MgcHJvcGVydGllcwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIEVuc3VyZXMgaWRlbnRpY2FsIHByb3BlcnRpZXMgbmFtZQogICAgICAgICAgICAgICAgcmV0dXJuIGVxICYmIGlubmVyRXF1aXYoYVByb3BlcnRpZXMuc29ydCgpLCBiUHJvcGVydGllcy5zb3J0KCkpOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgIH0oKTsKCiAgICBpbm5lckVxdWl2ID0gZnVuY3Rpb24gKCkgeyAvLyBjYW4gdGFrZSBtdWx0aXBsZSBhcmd1bWVudHMKICAgICAgICB2YXIgYXJncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5hcHBseShhcmd1bWVudHMpOwogICAgICAgIGlmIChhcmdzLmxlbmd0aCA8IDIpIHsKICAgICAgICAgICAgcmV0dXJuIHRydWU7IC8vIGVuZCB0cmFuc2l0aW9uCiAgICAgICAgfQoKICAgICAgICByZXR1cm4gKGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgICAgIGlmIChhID09PSBiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gY2F0Y2ggdGhlIG1vc3QgeW91IGNhbgogICAgICAgICAgICB9IGVsc2UgaWYgKGEgPT09IG51bGwgfHwgYiA9PT0gbnVsbCB8fCB0eXBlb2YgYSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIGIgPT09ICJ1bmRlZmluZWQiIHx8IGhvb3ppdChhKSAhPT0gaG9veml0KGIpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7IC8vIGRvbid0IGxvc2UgdGltZSB3aXRoIGVycm9yIHByb25lIGNhc2VzCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gaGFuZGxlRXZlbnRzKGEsIGNhbGxiYWNrcywgW2IsIGFdKTsKICAgICAgICAgICAgfQoKICAgICAgICAvLyBhcHBseSB0cmFuc2l0aW9uIHdpdGggKDEuLm4pIGFyZ3VtZW50cwogICAgICAgIH0pKGFyZ3NbMF0sIGFyZ3NbMV0pICYmIGFyZ3VtZW50cy5jYWxsZWUuYXBwbHkodGhpcywgYXJncy5zcGxpY2UoMSwgYXJncy5sZW5ndGggLTEpKTsKICAgIH07CgogICAgcmV0dXJuIGlubmVyRXF1aXY7Cgp9KCk7CgovKioKICoganNEdW1wCiAqIENvcHlyaWdodCAoYykgMjAwOCBBcmllbCBGbGVzbGVyIC0gYWZsZXNsZXIoYXQpZ21haWwoZG90KWNvbSB8IGh0dHA6Ly9mbGVzbGVyLmJsb2dzcG90LmNvbQogKiBMaWNlbnNlZCB1bmRlciBCU0QgKGh0dHA6Ly93d3cub3BlbnNvdXJjZS5vcmcvbGljZW5zZXMvYnNkLWxpY2Vuc2UucGhwKQogKiBEYXRlOiA1LzE1LzIwMDgKICogQHByb2plY3REZXNjcmlwdGlvbiBBZHZhbmNlZCBhbmQgZXh0ZW5zaWJsZSBkYXRhIGR1bXBpbmcgZm9yIEphdmFzY3JpcHQuCiAqIEB2ZXJzaW9uIDEuMC4wCiAqIEBhdXRob3IgQXJpZWwgRmxlc2xlcgogKiBAbGluayB7aHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tLzIwMDgvMDUvanNkdW1wLXByZXR0eS1kdW1wLW9mLWFueS1qYXZhc2NyaXB0Lmh0bWx9CiAqLwpRVW5pdC5qc0R1bXAgPSAoZnVuY3Rpb24oKSB7CglmdW5jdGlvbiBxdW90ZSggc3RyICkgewoJCXJldHVybiAnIicgKyBzdHIudG9TdHJpbmcoKS5yZXBsYWNlKC8iL2csICdcXCInKSArICciJzsKCX07CglmdW5jdGlvbiBsaXRlcmFsKCBvICkgewoJCXJldHVybiBvICsgJyc7Cgl9OwoJZnVuY3Rpb24gam9pbiggcHJlLCBhcnIsIHBvc3QgKSB7CgkJdmFyIHMgPSBqc0R1bXAuc2VwYXJhdG9yKCksCgkJCWJhc2UgPSBqc0R1bXAuaW5kZW50KCksCgkJCWlubmVyID0ganNEdW1wLmluZGVudCgxKTsKCQlpZiAoIGFyci5qb2luICkKCQkJYXJyID0gYXJyLmpvaW4oICcsJyArIHMgKyBpbm5lciApOwoJCWlmICggIWFyciApCgkJCXJldHVybiBwcmUgKyBwb3N0OwoJCXJldHVybiBbIHByZSwgaW5uZXIgKyBhcnIsIGJhc2UgKyBwb3N0IF0uam9pbihzKTsKCX07CglmdW5jdGlvbiBhcnJheSggYXJyICkgewoJCXZhciBpID0gYXJyLmxlbmd0aCwJcmV0ID0gQXJyYXkoaSk7CgkJdGhpcy51cCgpOwoJCXdoaWxlICggaS0tICkKCQkJcmV0W2ldID0gdGhpcy5wYXJzZSggYXJyW2ldICk7CgkJdGhpcy5kb3duKCk7CgkJcmV0dXJuIGpvaW4oICdbJywgcmV0LCAnXScgKTsKCX07CgoJdmFyIHJlTmFtZSA9IC9eZnVuY3Rpb24gKFx3KykvOwoKCXZhciBqc0R1bXAgPSB7CgkJcGFyc2U6ZnVuY3Rpb24oIG9iaiwgdHlwZSApIHsgLy90eXBlIGlzIHVzZWQgbW9zdGx5IGludGVybmFsbHksIHlvdSBjYW4gZml4IGEgKGN1c3RvbSl0eXBlIGluIGFkdmFuY2UKCQkJdmFyCXBhcnNlciA9IHRoaXMucGFyc2Vyc1sgdHlwZSB8fCB0aGlzLnR5cGVPZihvYmopIF07CgkJCXR5cGUgPSB0eXBlb2YgcGFyc2VyOwoKCQkJcmV0dXJuIHR5cGUgPT0gJ2Z1bmN0aW9uJyA/IHBhcnNlci5jYWxsKCB0aGlzLCBvYmogKSA6CgkJCQkgICB0eXBlID09ICdzdHJpbmcnID8gcGFyc2VyIDoKCQkJCSAgIHRoaXMucGFyc2Vycy5lcnJvcjsKCQl9LAoJCXR5cGVPZjpmdW5jdGlvbiggb2JqICkgewoJCQl2YXIgdHlwZSA9IHR5cGVvZiBvYmosCgkJCQlmID0gJ2Z1bmN0aW9uJzsvL3dlJ2xsIHVzZSBpdCAzIHRpbWVzLCBzYXZlIGl0CgkJCXJldHVybiB0eXBlICE9ICdvYmplY3QnICYmIHR5cGUgIT0gZiA/IHR5cGUgOgoJCQkJIW9iaiA/ICdudWxsJyA6CgkJCQlvYmouZXhlYyA/ICdyZWdleHAnIDovLyBzb21lIGJyb3dzZXJzIChGRikgY29uc2lkZXIgcmVnZXhwcyBmdW5jdGlvbnMKCQkJCW9iai5nZXRIb3VycyA/ICdkYXRlJyA6CgkJCQlvYmouc2Nyb2xsQnkgPyAgJ3dpbmRvdycgOgoJCQkJb2JqLm5vZGVOYW1lID09ICcjZG9jdW1lbnQnID8gJ2RvY3VtZW50JyA6CgkJCQlvYmoubm9kZU5hbWUgPyAnbm9kZScgOgoJCQkJb2JqLml0ZW0gPyAnbm9kZWxpc3QnIDogLy8gU2FmYXJpIHJlcG9ydHMgbm9kZWxpc3RzIGFzIGZ1bmN0aW9ucwoJCQkJb2JqLmNhbGxlZSA/ICdhcmd1bWVudHMnIDoKCQkJCW9iai5jYWxsIHx8IG9iai5jb25zdHJ1Y3RvciAhPSBBcnJheSAmJiAvL2FuIGFycmF5IHdvdWxkIGFsc28gZmFsbCBvbiB0aGlzIGhhY2sKCQkJCQkob2JqKycnKS5pbmRleE9mKGYpICE9IC0xID8gZiA6IC8vSUUgcmVwb3J0cyBmdW5jdGlvbnMgbGlrZSBhbGVydCwgYXMgb2JqZWN0cwoJCQkJJ2xlbmd0aCcgaW4gb2JqID8gJ2FycmF5JyA6CgkJCQl0eXBlOwoJCX0sCgkJc2VwYXJhdG9yOmZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsKCQl9LAoJCWluZGVudDpmdW5jdGlvbiggZXh0cmEgKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcKCQkJaWYgKCAhdGhpcy5tdWx0aWxpbmUgKQoJCQkJcmV0dXJuICcnOwoJCQl2YXIgY2hyID0gdGhpcy5pbmRlbnRDaGFyOwoJCQlpZiAoIHRoaXMuSFRNTCApCgkJCQljaHIgPSBjaHIucmVwbGFjZSgvXHQvZywnICAgJykucmVwbGFjZSgvIC9nLCcmbmJzcDsnKTsKCQkJcmV0dXJuIEFycmF5KCB0aGlzLl9kZXB0aF8gKyAoZXh0cmF8fDApICkuam9pbihjaHIpOwoJCX0sCgkJdXA6ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyArPSBhIHx8IDE7CgkJfSwKCQlkb3duOmZ1bmN0aW9uKCBhICkgewoJCQl0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOwoJCX0sCgkJc2V0UGFyc2VyOmZ1bmN0aW9uKCBuYW1lLCBwYXJzZXIgKSB7CgkJCXRoaXMucGFyc2Vyc1tuYW1lXSA9IHBhcnNlcjsKCQl9LAoJCS8vIFRoZSBuZXh0IDMgYXJlIGV4cG9zZWQgc28geW91IGNhbiB1c2UgdGhlbQoJCXF1b3RlOnF1b3RlLAoJCWxpdGVyYWw6bGl0ZXJhbCwKCQlqb2luOmpvaW4sCgkJLy8KCQlfZGVwdGhfOiAxLAoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCgkJcGFyc2Vyczp7CgkJCXdpbmRvdzogJ1tXaW5kb3ddJywKCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuCgkJCXVua25vd246ICdbVW5rbm93bl0nLAoJCQknbnVsbCc6J251bGwnLAoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsCgkJCSdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICkgewoJCQkJdmFyIHJldCA9ICdmdW5jdGlvbicsCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFCgkJCQlpZiAoIG5hbWUgKQoJCQkJCXJldCArPSAnICcgKyBuYW1lOwoJCQkJcmV0ICs9ICcoJzsKCgkJCQlyZXQgPSBbIHJldCwgdGhpcy5wYXJzZSggZm4sICdmdW5jdGlvbkFyZ3MnICksICcpeyddLmpvaW4oJycpOwoJCQkJcmV0dXJuIGpvaW4oIHJldCwgdGhpcy5wYXJzZShmbiwnZnVuY3Rpb25Db2RlJyksICd9JyApOwoJCQl9LAoJCQlhcnJheTogYXJyYXksCgkJCW5vZGVsaXN0OiBhcnJheSwKCQkJYXJndW1lbnRzOiBhcnJheSwKCQkJb2JqZWN0OmZ1bmN0aW9uKCBtYXAgKSB7CgkJCQl2YXIgcmV0ID0gWyBdOwoJCQkJdGhpcy51cCgpOwoJCQkJZm9yICggdmFyIGtleSBpbiBtYXAgKQoJCQkJCXJldC5wdXNoKCB0aGlzLnBhcnNlKGtleSwna2V5JykgKyAnOiAnICsgdGhpcy5wYXJzZShtYXBba2V5XSkgKTsKCQkJCXRoaXMuZG93bigpOwoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKCQkJfSwKCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsKCQkJCXZhciBvcGVuID0gdGhpcy5IVE1MID8gJyZsdDsnIDogJzwnLAoJCQkJCWNsb3NlID0gdGhpcy5IVE1MID8gJyZndDsnIDogJz4nOwoKCQkJCXZhciB0YWcgPSBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCQkJcmV0ID0gb3BlbiArIHRhZzsKCgkJCQlmb3IgKCB2YXIgYSBpbiB0aGlzLkRPTUF0dHJzICkgewoJCQkJCXZhciB2YWwgPSBub2RlW3RoaXMuRE9NQXR0cnNbYV1dOwoJCQkJCWlmICggdmFsICkKCQkJCQkJcmV0ICs9ICcgJyArIGEgKyAnPScgKyB0aGlzLnBhcnNlKCB2YWwsICdhdHRyaWJ1dGUnICk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0ICsgY2xvc2UgKyBvcGVuICsgJy8nICsgdGFnICsgY2xvc2U7CgkJCX0sCgkJCWZ1bmN0aW9uQXJnczpmdW5jdGlvbiggZm4gKSB7Ly9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBhcmd1bWVudHMgcGFydCBvZiB0aGUgZnVuY3Rpb24KCQkJCXZhciBsID0gZm4ubGVuZ3RoOwoJCQkJaWYgKCAhbCApIHJldHVybiAnJzsKCgkJCQl2YXIgYXJncyA9IEFycmF5KGwpOwoJCQkJd2hpbGUgKCBsLS0gKQoJCQkJCWFyZ3NbbF0gPSBTdHJpbmcuZnJvbUNoYXJDb2RlKDk3K2wpOy8vOTcgaXMgJ2EnCgkJCQlyZXR1cm4gJyAnICsgYXJncy5qb2luKCcsICcpICsgJyAnOwoJCQl9LAoJCQlrZXk6cXVvdGUsIC8vb2JqZWN0IGNhbGxzIGl0IGludGVybmFsbHksIHRoZSBrZXkgcGFydCBvZiBhbiBpdGVtIGluIGEgbWFwCgkJCWZ1bmN0aW9uQ29kZTonW2NvZGVdJywgLy9mdW5jdGlvbiBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIHRoZSBjb250ZW50IG9mIHRoZSBmdW5jdGlvbgoJCQlhdHRyaWJ1dGU6cXVvdGUsIC8vbm9kZSBjYWxscyBpdCBpbnRlcm5hbGx5LCBpdCdzIGFuIGh0bWwgYXR0cmlidXRlIHZhbHVlCgkJCXN0cmluZzpxdW90ZSwKCQkJZGF0ZTpxdW90ZSwKCQkJcmVnZXhwOmxpdGVyYWwsIC8vcmVnZXgKCQkJbnVtYmVyOmxpdGVyYWwsCgkJCSdib29sZWFuJzpsaXRlcmFsCgkJfSwKCQlET01BdHRyczp7Ly9hdHRyaWJ1dGVzIHRvIGR1bXAgZnJvbSBub2RlcywgbmFtZT0+cmVhbE5hbWUKCQkJaWQ6J2lkJywKCQkJbmFtZTonbmFtZScsCgkJCSdjbGFzcyc6J2NsYXNzTmFtZScKCQl9LAoJCUhUTUw6dHJ1ZSwvL2lmIHRydWUsIGVudGl0aWVzIGFyZSBlc2NhcGVkICggPCwgPiwgXHQsIHNwYWNlIGFuZCBcbiApCgkJaW5kZW50Q2hhcjonICAgJywvL2luZGVudGF0aW9uIHVuaXQKCQltdWx0aWxpbmU6dHJ1ZSAvL2lmIHRydWUsIGl0ZW1zIGluIGEgY29sbGVjdGlvbiwgYXJlIHNlcGFyYXRlZCBieSBhIFxuLCBlbHNlIGp1c3QgYSBzcGFjZS4KCX07CgoJcmV0dXJuIGpzRHVtcDsKfSkoKTsKCn0pKHRoaXMpOy8qCiAqIFFVbml0IC0gQSBKYXZhU2NyaXB0IFVuaXQgVGVzdGluZyBGcmFtZXdvcmsKICoKICogaHR0cDovL2RvY3MuanF1ZXJ5LmNvbS9RVW5pdAogKgogKiBDb3B5cmlnaHQgKGMpIDIwMDkgSm9obiBSZXNpZywgSsO2cm4gWmFlZmZlcmVyCiAqIER1YWwgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCAoTUlULUxJQ0VOU0UudHh0KQogKiBhbmQgR1BMIChHUEwtTElDRU5TRS50eHQpIGxpY2Vuc2VzLgogKi8KCihmdW5jdGlvbih3aW5kb3cpIHsKCnZhciBkZWZpbmVkID0gewoJc2V0VGltZW91dDogdHlwZW9mIHdpbmRvdy5zZXRUaW1lb3V0ICE9PSAidW5kZWZpbmVkIiwKCXNlc3Npb25TdG9yYWdlOiAoZnVuY3Rpb24oKSB7CgkJdHJ5IHsKCQkJcmV0dXJuICEhc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbTsKCQl9IGNhdGNoKGUpewoJCQlyZXR1cm4gZmFsc2U7CgkJfQogIH0pKCkKfQoKdmFyIHRlc3RJZCA9IDA7Cgp2YXIgVGVzdCA9IGZ1bmN0aW9uKG5hbWUsIHRlc3ROYW1lLCBleHBlY3RlZCwgdGVzdEVudmlyb25tZW50QXJnLCBhc3luYywgY2FsbGJhY2spIHsKCXRoaXMubmFtZSA9IG5hbWU7Cgl0aGlzLnRlc3ROYW1lID0gdGVzdE5hbWU7Cgl0aGlzLmV4cGVjdGVkID0gZXhwZWN0ZWQ7Cgl0aGlzLnRlc3RFbnZpcm9ubWVudEFyZyA9IHRlc3RFbnZpcm9ubWVudEFyZzsKCXRoaXMuYXN5bmMgPSBhc3luYzsKCXRoaXMuY2FsbGJhY2sgPSBjYWxsYmFjazsKCXRoaXMuYXNzZXJ0aW9ucyA9IFtdOwp9OwpUZXN0LnByb3RvdHlwZSA9IHsKCWluaXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB0ZXN0cyA9IGlkKCJxdW5pdC10ZXN0cyIpOwoJCWlmICh0ZXN0cykgewoJCQl2YXIgYiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0cm9uZyIpOwoJCQkJYi5pbm5lckhUTUwgPSAiUnVubmluZyAiICsgdGhpcy5uYW1lOwoJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsKCQkJCWxpLmlkID0gdGhpcy5pZCA9ICJ0ZXN0LW91dHB1dCIgKyB0ZXN0SWQrKzsKCQkJdGVzdHMuYXBwZW5kQ2hpbGQoIGxpICk7CgkJfQoJfSwKCXNldHVwOiBmdW5jdGlvbigpIHsKCQlpZiAodGhpcy5tb2R1bGUgIT0gY29uZmlnLnByZXZpb3VzTW9kdWxlKSB7CgkJCWlmICggdGhpcy5wcmV2aW91c01vZHVsZSApIHsKCQkJCVFVbml0Lm1vZHVsZURvbmUoIHRoaXMubW9kdWxlLCBjb25maWcubW9kdWxlU3RhdHMuYmFkLCBjb25maWcubW9kdWxlU3RhdHMuYWxsICk7CgkJCX0KCQkJY29uZmlnLnByZXZpb3VzTW9kdWxlID0gdGhpcy5tb2R1bGU7CgkJCWNvbmZpZy5tb2R1bGVTdGF0cyA9IHsgYWxsOiAwLCBiYWQ6IDAgfTsKCQkJUVVuaXQubW9kdWxlU3RhcnQoIHRoaXMubW9kdWxlLCB0aGlzLm1vZHVsZVRlc3RFbnZpcm9ubWVudCApOwoJCX0KCgkJY29uZmlnLmN1cnJlbnQgPSB0aGlzOwoJCXRoaXMudGVzdEVudmlyb25tZW50ID0gZXh0ZW5kKHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkge30sCgkJCXRlYXJkb3duOiBmdW5jdGlvbigpIHt9CgkJfSwgdGhpcy5tb2R1bGVUZXN0RW52aXJvbm1lbnQpOwoJCWlmICh0aGlzLnRlc3RFbnZpcm9ubWVudEFyZykgewoJCQlleHRlbmQodGhpcy50ZXN0RW52aXJvbm1lbnQsIHRoaXMudGVzdEVudmlyb25tZW50QXJnKTsKCQl9CgoJCVFVbml0LnRlc3RTdGFydCggdGhpcy50ZXN0TmFtZSwgdGhpcy50ZXN0RW52aXJvbm1lbnQgKTsKCgkJLy8gYWxsb3cgdXRpbGl0eSBmdW5jdGlvbnMgdG8gYWNjZXNzIHRoZSBjdXJyZW50IHRlc3QgZW52aXJvbm1lbnQKCQkvLyBUT0RPIHdoeT8/CgkJUVVuaXQuY3VycmVudF90ZXN0RW52aXJvbm1lbnQgPSB0aGlzLnRlc3RFbnZpcm9ubWVudDsKCgkJdHJ5IHsKCQkJaWYgKCAhY29uZmlnLnBvbGx1dGlvbiApIHsKCQkJCXNhdmVHbG9iYWwoKTsKCQkJfQoKCQkJdGhpcy50ZXN0RW52aXJvbm1lbnQuc2V0dXAuY2FsbCh0aGlzLnRlc3RFbnZpcm9ubWVudCk7CgkJfSBjYXRjaChlKSB7CgkJCS8vIFRPRE8gdXNlIHRlc3ROYW1lIGluc3RlYWQgb2YgbmFtZSBmb3Igbm8tbWFya3VwIG1lc3NhZ2U/CgkJCVFVbml0Lm9rKCBmYWxzZSwgIlNldHVwIGZhaWxlZCBvbiAiICsgdGhpcy5uYW1lICsgIjogIiArIGUubWVzc2FnZSApOwoJCX0KCX0sCglydW46IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5hc3luYyApIHsKCQkJUVVuaXQuc3RvcCgpOwoJCX0KCgkJdHJ5IHsKCQkJdGhpcy5jYWxsYmFjay5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJLy8gVE9ETyB1c2UgdGVzdE5hbWUgaW5zdGVhZCBvZiBuYW1lIGZvciBuby1tYXJrdXAgbWVzc2FnZT8KCQkJZmFpbCgiVGVzdCAiICsgdGhpcy5uYW1lICsgIiBkaWVkLCBleGNlcHRpb24gYW5kIHRlc3QgZm9sbG93cyIsIGUsIHRoaXMuY2FsbGJhY2spOwoJCQlRVW5pdC5vayggZmFsc2UsICJEaWVkIG9uIHRlc3QgIyIgKyAodGhpcy5hc3NlcnRpb25zLmxlbmd0aCArIDEpICsgIjogIiArIGUubWVzc2FnZSArICIgLSAiICsgUVVuaXQuanNEdW1wLnBhcnNlKGUpICk7CgkJCS8vIGVsc2UgbmV4dCB0ZXN0IHdpbGwgY2FycnkgdGhlIHJlc3BvbnNpYmlsaXR5CgkJCXNhdmVHbG9iYWwoKTsKCgkJCS8vIFJlc3RhcnQgdGhlIHRlc3RzIGlmIHRoZXkncmUgYmxvY2tpbmcKCQkJaWYgKCBjb25maWcuYmxvY2tpbmcgKSB7CgkJCQlzdGFydCgpOwoJCQl9CgkJfQoJfSwKCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQl0cnkgewoJCQljaGVja1BvbGx1dGlvbigpOwoJCQl0aGlzLnRlc3RFbnZpcm9ubWVudC50ZWFyZG93bi5jYWxsKHRoaXMudGVzdEVudmlyb25tZW50KTsKCQl9IGNhdGNoKGUpIHsKCQkJLy8gVE9ETyB1c2UgdGVzdE5hbWUgaW5zdGVhZCBvZiBuYW1lIGZvciBuby1tYXJrdXAgbWVzc2FnZT8KCQkJUVVuaXQub2soIGZhbHNlLCAiVGVhcmRvd24gZmFpbGVkIG9uICIgKyB0aGlzLm5hbWUgKyAiOiAiICsgZS5tZXNzYWdlICk7CgkJfQoJfSwKCWZpbmlzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLmV4cGVjdGVkICYmIHRoaXMuZXhwZWN0ZWQgIT0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aCApIHsKCQkJUVVuaXQub2soIGZhbHNlLCAiRXhwZWN0ZWQgIiArIHRoaXMuZXhwZWN0ZWQgKyAiIGFzc2VydGlvbnMsIGJ1dCAiICsgdGhpcy5hc3NlcnRpb25zLmxlbmd0aCArICIgd2VyZSBydW4iICk7CgkJfQoKCQl2YXIgZ29vZCA9IDAsIGJhZCA9IDAsCgkJCXRlc3RzID0gaWQoInF1bml0LXRlc3RzIik7CgoJCWNvbmZpZy5zdGF0cy5hbGwgKz0gdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsKCQljb25maWcubW9kdWxlU3RhdHMuYWxsICs9IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7CgoJCWlmICggdGVzdHMgKSB7CgkJCXZhciBvbCAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJvbCIpOwoKCQkJZm9yICggdmFyIGkgPSAwOyBpIDwgdGhpcy5hc3NlcnRpb25zLmxlbmd0aDsgaSsrICkgewoJCQkJdmFyIGFzc2VydGlvbiA9IHRoaXMuYXNzZXJ0aW9uc1tpXTsKCgkJCQl2YXIgbGkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsaSIpOwoJCQkJbGkuY2xhc3NOYW1lID0gYXNzZXJ0aW9uLnJlc3VsdCA/ICJwYXNzIiA6ICJmYWlsIjsKCQkJCWxpLmlubmVySFRNTCA9IGFzc2VydGlvbi5tZXNzYWdlIHx8IChhc3NlcnRpb24ucmVzdWx0ID8gIm9rYXkiIDogImZhaWxlZCIpOwoJCQkJb2wuYXBwZW5kQ2hpbGQoIGxpICk7CgoJCQkJaWYgKCBhc3NlcnRpb24ucmVzdWx0ICkgewoJCQkJCWdvb2QrKzsKCQkJCX0gZWxzZSB7CgkJCQkJYmFkKys7CgkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCX0KCQkJfQoKCQkJLy8gc3RvcmUgcmVzdWx0IHdoZW4gcG9zc2libGUKCQkJZGVmaW5lZC5zZXNzaW9uU3RvcmFnZSAmJiBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCJxdW5pdC0iICsgdGhpcy50ZXN0TmFtZSwgYmFkKTsKCgkJCWlmIChiYWQgPT0gMCkgewoJCQkJb2wuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCQkJfQoKCQkJdmFyIGIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHJvbmciKTsKCQkJYi5pbm5lckhUTUwgPSB0aGlzLm5hbWUgKyAiIDxiIGNsYXNzPSdjb3VudHMnPig8YiBjbGFzcz0nZmFpbGVkJz4iICsgYmFkICsgIjwvYj4sIDxiIGNsYXNzPSdwYXNzZWQnPiIgKyBnb29kICsgIjwvYj4sICIgKyB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICsgIik8L2I+IjsKCgkJCWFkZEV2ZW50KGIsICJjbGljayIsIGZ1bmN0aW9uKCkgewoJCQkJdmFyIG5leHQgPSBiLm5leHRTaWJsaW5nLCBkaXNwbGF5ID0gbmV4dC5zdHlsZS5kaXNwbGF5OwoJCQkJbmV4dC5zdHlsZS5kaXNwbGF5ID0gZGlzcGxheSA9PT0gIm5vbmUiID8gImJsb2NrIiA6ICJub25lIjsKCQkJfSk7CgoJCQlhZGRFdmVudChiLCAiZGJsY2xpY2siLCBmdW5jdGlvbihlKSB7CgkJCQl2YXIgdGFyZ2V0ID0gZSAmJiBlLnRhcmdldCA/IGUudGFyZ2V0IDogd2luZG93LmV2ZW50LnNyY0VsZW1lbnQ7CgkJCQlpZiAoIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJzcGFuIiB8fCB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PSAiYiIgKSB7CgkJCQkJdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgkJCQl9CgkJCQlpZiAoIHdpbmRvdy5sb2NhdGlvbiAmJiB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gInN0cm9uZyIgKSB7CgkJCQkJd2luZG93LmxvY2F0aW9uLnNlYXJjaCA9ICI/IiArIGVuY29kZVVSSUNvbXBvbmVudChnZXRUZXh0KFt0YXJnZXRdKS5yZXBsYWNlKC9cKC4rXCkkLywgIiIpLnJlcGxhY2UoLyheXHMqfFxzKiQpL2csICIiKSk7CgkJCQl9CgkJCX0pOwoKCQkJdmFyIGxpID0gaWQodGhpcy5pZCk7CgkJCWxpLmNsYXNzTmFtZSA9IGJhZCA/ICJmYWlsIiA6ICJwYXNzIjsKCQkJbGkuc3R5bGUuZGlzcGxheSA9IHJlc3VsdERpc3BsYXlTdHlsZSghYmFkKTsKCQkJbGkucmVtb3ZlQ2hpbGQoIGxpLmZpcnN0Q2hpbGQgKTsKCQkJbGkuYXBwZW5kQ2hpbGQoIGIgKTsKCQkJbGkuYXBwZW5kQ2hpbGQoIG9sICk7CgoJCQlpZiAoIGJhZCApIHsKCQkJCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJCQkJaWYgKCB0b29sYmFyICkgewoJCQkJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CgkJCQkJaWQoInF1bml0LWZpbHRlci1wYXNzIikuZGlzYWJsZWQgPSBudWxsOwoJCQkJfQoJCQl9CgoJCX0gZWxzZSB7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IHRoaXMuYXNzZXJ0aW9ucy5sZW5ndGg7IGkrKyApIHsKCQkJCWlmICggIXRoaXMuYXNzZXJ0aW9uc1tpXS5yZXN1bHQgKSB7CgkJCQkJYmFkKys7CgkJCQkJY29uZmlnLnN0YXRzLmJhZCsrOwoJCQkJCWNvbmZpZy5tb2R1bGVTdGF0cy5iYWQrKzsKCQkJCX0KCQkJfQoJCX0KCgkJdHJ5IHsKCQkJUVVuaXQucmVzZXQoKTsKCQl9IGNhdGNoKGUpIHsKCQkJLy8gVE9ETyB1c2UgdGVzdE5hbWUgaW5zdGVhZCBvZiBuYW1lIGZvciBuby1tYXJrdXAgbWVzc2FnZT8KCQkJZmFpbCgicmVzZXQoKSBmYWlsZWQsIGZvbGxvd2luZyBUZXN0ICIgKyB0aGlzLm5hbWUgKyAiLCBleGNlcHRpb24gYW5kIHJlc2V0IGZuIGZvbGxvd3MiLCBlLCBRVW5pdC5yZXNldCk7CgkJfQoKCQlRVW5pdC50ZXN0RG9uZSggdGhpcy50ZXN0TmFtZSwgYmFkLCB0aGlzLmFzc2VydGlvbnMubGVuZ3RoICk7Cgl9LAoKCXF1ZXVlOiBmdW5jdGlvbigpIHsKCQl2YXIgdGVzdCA9IHRoaXM7CgkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCXRlc3QuaW5pdCgpOwoJCX0pOwoJCWZ1bmN0aW9uIHJ1bigpIHsKCQkJLy8gZWFjaCBvZiB0aGVzZSBjYW4gYnkgYXN5bmMKCQkJc3luY2hyb25pemUoZnVuY3Rpb24oKSB7CgkJCQl0ZXN0LnNldHVwKCk7CgkJCX0pOwoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJCXRlc3QucnVuKCk7CgkJCX0pOwoJCQlzeW5jaHJvbml6ZShmdW5jdGlvbigpIHsKCQkJCXRlc3QudGVhcmRvd24oKTsKCQkJfSk7CgkJCXN5bmNocm9uaXplKGZ1bmN0aW9uKCkgewoJCQkJdGVzdC5maW5pc2goKTsKCQkJfSk7CgkJfQoJCS8vIGRlZmVyIHdoZW4gcHJldmlvdXMgdGVzdCBydW4gcGFzc2VkLCBpZiBzdG9yYWdlIGlzIGF2YWlsYWJsZQoJCXZhciBiYWQgPSBkZWZpbmVkLnNlc3Npb25TdG9yYWdlICYmICtzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJxdW5pdC0iICsgdGhpcy50ZXN0TmFtZSk7CgkJaWYgKGJhZCkgewoJCQlydW4oKTsKCQl9IGVsc2UgewoJCQlzeW5jaHJvbml6ZShydW4pOwoJCX07Cgl9Cgp9Cgp2YXIgUVVuaXQgPSB7CgoJLy8gY2FsbCBvbiBzdGFydCBvZiBtb2R1bGUgdGVzdCB0byBwcmVwZW5kIG5hbWUgdG8gYWxsIHRlc3RzCgltb2R1bGU6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkgewoJCWNvbmZpZy5wcmV2aW91c01vZHVsZSA9IGNvbmZpZy5jdXJyZW50TW9kdWxlOwoJCWNvbmZpZy5jdXJyZW50TW9kdWxlID0gbmFtZTsKCQljb25maWcuY3VycmVudE1vZHVsZVRlc3RFbnZpcm9tZW50ID0gdGVzdEVudmlyb25tZW50OwoJfSwKCglhc3luY1Rlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2spIHsKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggPT09IDIgKSB7CgkJCWNhbGxiYWNrID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gMDsKCQl9CgoJCVFVbml0LnRlc3QodGVzdE5hbWUsIGV4cGVjdGVkLCBjYWxsYmFjaywgdHJ1ZSk7Cgl9LAoKCXRlc3Q6IGZ1bmN0aW9uKHRlc3ROYW1lLCBleHBlY3RlZCwgY2FsbGJhY2ssIGFzeW5jKSB7CgkJdmFyIG5hbWUgPSAnPHNwYW4gY2xhc3M9InRlc3QtbmFtZSI+JyArIHRlc3ROYW1lICsgJzwvc3Bhbj4nLCB0ZXN0RW52aXJvbm1lbnRBcmc7CgoJCWlmICggYXJndW1lbnRzLmxlbmd0aCA9PT0gMiApIHsKCQkJY2FsbGJhY2sgPSBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSBudWxsOwoJCX0KCQkvLyBpcyAybmQgYXJndW1lbnQgYSB0ZXN0RW52aXJvbm1lbnQ/CgkJaWYgKCBleHBlY3RlZCAmJiB0eXBlb2YgZXhwZWN0ZWQgPT09ICdvYmplY3QnKSB7CgkJCXRlc3RFbnZpcm9ubWVudEFyZyA9ICBleHBlY3RlZDsKCQkJZXhwZWN0ZWQgPSBudWxsOwoJCX0KCgkJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQkJbmFtZSA9ICc8c3BhbiBjbGFzcz0ibW9kdWxlLW5hbWUiPicgKyBjb25maWcuY3VycmVudE1vZHVsZSArICI8L3NwYW4+OiAiICsgbmFtZTsKCQl9CgoJCWlmICggIXZhbGlkVGVzdChjb25maWcuY3VycmVudE1vZHVsZSArICI6ICIgKyB0ZXN0TmFtZSkgKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciB0ZXN0ID0gbmV3IFRlc3QobmFtZSwgdGVzdE5hbWUsIGV4cGVjdGVkLCB0ZXN0RW52aXJvbm1lbnRBcmcsIGFzeW5jLCBjYWxsYmFjayk7CgkJdGVzdC5wcmV2aW91c01vZHVsZSA9IGNvbmZpZy5wcmV2aW91c01vZHVsZTsKCQl0ZXN0Lm1vZHVsZSA9IGNvbmZpZy5jdXJyZW50TW9kdWxlOwoJCXRlc3QubW9kdWxlVGVzdEVudmlyb25tZW50ID0gY29uZmlnLmN1cnJlbnRNb2R1bGVUZXN0RW52aXJvbWVudDsKCQl0ZXN0LnF1ZXVlKCk7Cgl9LAoKCS8qKgoJICogU3BlY2lmeSB0aGUgbnVtYmVyIG9mIGV4cGVjdGVkIGFzc2VydGlvbnMgdG8gZ3VyYW50ZWUgdGhhdCBmYWlsZWQgdGVzdCAobm8gYXNzZXJ0aW9ucyBhcmUgcnVuIGF0IGFsbCkgZG9uJ3Qgc2xpcCB0aHJvdWdoLgoJICovCglleHBlY3Q6IGZ1bmN0aW9uKGFzc2VydHMpIHsKCQljb25maWcuY3VycmVudC5leHBlY3RlZCA9IGFzc2VydHM7Cgl9LAoKCS8qKgoJICogQXNzZXJ0cyB0cnVlLgoJICogQGV4YW1wbGUgb2soICJhc2RmYXNkZiIubGVuZ3RoID4gNSwgIlRoZXJlIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFycyIgKTsKCSAqLwoJb2s6IGZ1bmN0aW9uKGEsIG1zZykgewoJCWEgPSAhIWE7CgkJdmFyIGRldGFpbHMgPSB7CgkJCXJlc3VsdDogYSwKCQkJbWVzc2FnZTogbXNnCgkJfTsKCQltc2cgPSBlc2NhcGVIdG1sKG1zZyk7CgkJUVVuaXQubG9nKGEsIG1zZywgZGV0YWlscyk7CgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKCQkJcmVzdWx0OiBhLAoJCQltZXNzYWdlOiBtc2cKCQl9KTsKCX0sCgoJLyoqCgkgKiBDaGVja3MgdGhhdCB0aGUgZmlyc3QgdHdvIGFyZ3VtZW50cyBhcmUgZXF1YWwsIHdpdGggYW4gb3B0aW9uYWwgbWVzc2FnZS4KCSAqIFByaW50cyBvdXQgYm90aCBhY3R1YWwgYW5kIGV4cGVjdGVkIHZhbHVlcy4KCSAqCgkgKiBQcmVmZXJlZCB0byBvayggYWN0dWFsID09IGV4cGVjdGVkLCBtZXNzYWdlICkKCSAqCgkgKiBAZXhhbXBsZSBlcXVhbCggZm9ybWF0KCJSZWNlaXZlZCB7MH0gYnl0ZXMuIiwgMiksICJSZWNlaXZlZCAyIGJ5dGVzLiIgKTsKCSAqCgkgKiBAcGFyYW0gT2JqZWN0IGFjdHVhbAoJICogQHBhcmFtIE9iamVjdCBleHBlY3RlZAoJICogQHBhcmFtIFN0cmluZyBtZXNzYWdlIChvcHRpb25hbCkKCSAqLwoJZXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKGV4cGVjdGVkID09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCW5vdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCAhPSBhY3R1YWwsIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglkZWVwRXF1YWw6IGZ1bmN0aW9uKGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQlRVW5pdC5wdXNoKFFVbml0LmVxdWl2KGFjdHVhbCwgZXhwZWN0ZWQpLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJbm90RGVlcEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaCghUVVuaXQuZXF1aXYoYWN0dWFsLCBleHBlY3RlZCksIGFjdHVhbCwgZXhwZWN0ZWQsIG1lc3NhZ2UpOwoJfSwKCglzdHJpY3RFcXVhbDogZnVuY3Rpb24oYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCVFVbml0LnB1c2goZXhwZWN0ZWQgPT09IGFjdHVhbCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSk7Cgl9LAoKCW5vdFN0cmljdEVxdWFsOiBmdW5jdGlvbihhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKSB7CgkJUVVuaXQucHVzaChleHBlY3RlZCAhPT0gYWN0dWFsLCBhY3R1YWwsIGV4cGVjdGVkLCBtZXNzYWdlKTsKCX0sCgoJcmFpc2VzOiBmdW5jdGlvbihibG9jaywgZXhwZWN0ZWQsIG1lc3NhZ2UpIHsKCQl2YXIgYWN0dWFsLCBvayA9IGZhbHNlOwoKCQlpZiAodHlwZW9mIGV4cGVjdGVkID09PSAnc3RyaW5nJykgewoJCQltZXNzYWdlID0gZXhwZWN0ZWQ7CgkJCWV4cGVjdGVkID0gbnVsbDsKCQl9CgoJCXRyeSB7CgkJCWJsb2NrKCk7CgkJfSBjYXRjaCAoZSkgewoJCQlhY3R1YWwgPSBlOwoJCX0KCgkJaWYgKGFjdHVhbCkgewoJCQkvLyB3ZSBkb24ndCB3YW50IHRvIHZhbGlkYXRlIHRocm93biBlcnJvcgoJCQlpZiAoIWV4cGVjdGVkKSB7CgkJCQlvayA9IHRydWU7CgkJCS8vIGV4cGVjdGVkIGlzIGEgcmVnZXhwCgkJCX0gZWxzZSBpZiAoUVVuaXQub2JqZWN0VHlwZShleHBlY3RlZCkgPT09ICJyZWdleHAiKSB7CgkJCQlvayA9IGV4cGVjdGVkLnRlc3QoYWN0dWFsKTsKCQkJLy8gZXhwZWN0ZWQgaXMgYSBjb25zdHJ1Y3RvcgoJCQl9IGVsc2UgaWYgKGFjdHVhbCBpbnN0YW5jZW9mIGV4cGVjdGVkKSB7CgkJCQlvayA9IHRydWU7CgkJCS8vIGV4cGVjdGVkIGlzIGEgdmFsaWRhdGlvbiBmdW5jdGlvbiB3aGljaCByZXR1cm5zIHRydWUgaXMgdmFsaWRhdGlvbiBwYXNzZWQKCQkJfSBlbHNlIGlmIChleHBlY3RlZC5jYWxsKHt9LCBhY3R1YWwpID09PSB0cnVlKSB7CgkJCQlvayA9IHRydWU7CgkJCX0KCQl9CgoJCVFVbml0Lm9rKG9rLCBtZXNzYWdlKTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKCkgewoJCS8vIEEgc2xpZ2h0IGRlbGF5LCB0byBhdm9pZCBhbnkgY3VycmVudCBjYWxsYmFja3MKCQlpZiAoIGRlZmluZWQuc2V0VGltZW91dCApIHsKCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlpZiAoIGNvbmZpZy50aW1lb3V0ICkgewoJCQkJCWNsZWFyVGltZW91dChjb25maWcudGltZW91dCk7CgkJCQl9CgoJCQkJY29uZmlnLmJsb2NraW5nID0gZmFsc2U7CgkJCQlwcm9jZXNzKCk7CgkJCX0sIDEzKTsKCQl9IGVsc2UgewoJCQljb25maWcuYmxvY2tpbmcgPSBmYWxzZTsKCQkJcHJvY2VzcygpOwoJCX0KCX0sCgoJc3RvcDogZnVuY3Rpb24odGltZW91dCkgewoJCWNvbmZpZy5ibG9ja2luZyA9IHRydWU7CgoJCWlmICggdGltZW91dCAmJiBkZWZpbmVkLnNldFRpbWVvdXQgKSB7CgkJCWNvbmZpZy50aW1lb3V0ID0gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQlRVW5pdC5vayggZmFsc2UsICJUZXN0IHRpbWVkIG91dCIgKTsKCQkJCVFVbml0LnN0YXJ0KCk7CgkJCX0sIHRpbWVvdXQpOwoJCX0KCX0KCn07CgovLyBCYWNrd2FyZHMgY29tcGF0aWJpbGl0eSwgZGVwcmVjYXRlZApRVW5pdC5lcXVhbHMgPSBRVW5pdC5lcXVhbDsKUVVuaXQuc2FtZSA9IFFVbml0LmRlZXBFcXVhbDsKCi8vIE1haW50YWluIGludGVybmFsIHN0YXRlCnZhciBjb25maWcgPSB7CgkvLyBUaGUgcXVldWUgb2YgdGVzdHMgdG8gcnVuCglxdWV1ZTogW10sCgoJLy8gYmxvY2sgdW50aWwgZG9jdW1lbnQgcmVhZHkKCWJsb2NraW5nOiB0cnVlCn07CgovLyBMb2FkIHBhcmFtYXRlcnMKKGZ1bmN0aW9uKCkgewoJdmFyIGxvY2F0aW9uID0gd2luZG93LmxvY2F0aW9uIHx8IHsgc2VhcmNoOiAiIiwgcHJvdG9jb2w6ICJmaWxlOiIgfSwKCQlHRVRQYXJhbXMgPSBsb2NhdGlvbi5zZWFyY2guc2xpY2UoMSkuc3BsaXQoJyYnKTsKCglmb3IgKCB2YXIgaSA9IDA7IGkgPCBHRVRQYXJhbXMubGVuZ3RoOyBpKysgKSB7CgkJR0VUUGFyYW1zW2ldID0gZGVjb2RlVVJJQ29tcG9uZW50KCBHRVRQYXJhbXNbaV0gKTsKCQlpZiAoIEdFVFBhcmFtc1tpXSA9PT0gIm5vZ2xvYmFscyIgKSB7CgkJCUdFVFBhcmFtcy5zcGxpY2UoIGksIDEgKTsKCQkJaS0tOwoJCQljb25maWcubm9nbG9iYWxzID0gdHJ1ZTsKCQl9IGVsc2UgaWYgKCBHRVRQYXJhbXNbaV0uc2VhcmNoKCc9JykgPiAtMSApIHsKCQkJR0VUUGFyYW1zLnNwbGljZSggaSwgMSApOwoJCQlpLS07CgkJfQoJfQoKCS8vIHJlc3RyaWN0IG1vZHVsZXMvdGVzdHMgYnkgZ2V0IHBhcmFtZXRlcnMKCWNvbmZpZy5maWx0ZXJzID0gR0VUUGFyYW1zOwoKCS8vIEZpZ3VyZSBvdXQgaWYgd2UncmUgcnVubmluZyB0aGUgdGVzdHMgZnJvbSBhIHNlcnZlciBvciBub3QKCVFVbml0LmlzTG9jYWwgPSAhIShsb2NhdGlvbi5wcm90b2NvbCA9PT0gJ2ZpbGU6Jyk7Cn0pKCk7CgovLyBFeHBvc2UgdGhlIEFQSSBhcyBnbG9iYWwgdmFyaWFibGVzLCB1bmxlc3MgYW4gJ2V4cG9ydHMnCi8vIG9iamVjdCBleGlzdHMsIGluIHRoYXQgY2FzZSB3ZSBhc3N1bWUgd2UncmUgaW4gQ29tbW9uSlMKaWYgKCB0eXBlb2YgZXhwb3J0cyA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mIHJlcXVpcmUgPT09ICJ1bmRlZmluZWQiICkgewoJZXh0ZW5kKHdpbmRvdywgUVVuaXQpOwoJd2luZG93LlFVbml0ID0gUVVuaXQ7Cn0gZWxzZSB7CglleHRlbmQoZXhwb3J0cywgUVVuaXQpOwoJZXhwb3J0cy5RVW5pdCA9IFFVbml0Owp9CgovLyBkZWZpbmUgdGhlc2UgYWZ0ZXIgZXhwb3NpbmcgZ2xvYmFscyB0byBrZWVwIHRoZW0gaW4gdGhlc2UgUVVuaXQgbmFtZXNwYWNlIG9ubHkKZXh0ZW5kKFFVbml0LCB7Cgljb25maWc6IGNvbmZpZywKCgkvLyBJbml0aWFsaXplIHRoZSBjb25maWd1cmF0aW9uIG9wdGlvbnMKCWluaXQ6IGZ1bmN0aW9uKCkgewoJCWV4dGVuZChjb25maWcsIHsKCQkJc3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJbW9kdWxlU3RhdHM6IHsgYWxsOiAwLCBiYWQ6IDAgfSwKCQkJc3RhcnRlZDogK25ldyBEYXRlLAoJCQl1cGRhdGVSYXRlOiAxMDAwLAoJCQlibG9ja2luZzogZmFsc2UsCgkJCWF1dG9zdGFydDogdHJ1ZSwKCQkJYXV0b3J1bjogZmFsc2UsCgkJCWZpbHRlcnM6IFtdLAoJCQlxdWV1ZTogW10KCQl9KTsKCgkJdmFyIHRlc3RzID0gaWQoInF1bml0LXRlc3RzIiksCgkJCWJhbm5lciA9IGlkKCJxdW5pdC1iYW5uZXIiKSwKCQkJcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCgkJaWYgKCB0ZXN0cyApIHsKCQkJdGVzdHMuaW5uZXJIVE1MID0gIiI7CgkJfQoKCQlpZiAoIGJhbm5lciApIHsKCQkJYmFubmVyLmNsYXNzTmFtZSA9ICIiOwoJCX0KCgkJaWYgKCByZXN1bHQgKSB7CgkJCXJlc3VsdC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKCByZXN1bHQgKTsKCQl9Cgl9LAoKCS8qKgoJICogUmVzZXRzIHRoZSB0ZXN0IHNldHVwLiBVc2VmdWwgZm9yIHRlc3RzIHRoYXQgbW9kaWZ5IHRoZSBET00uCgkgKgoJICogSWYgalF1ZXJ5IGlzIGF2YWlsYWJsZSwgdXNlcyBqUXVlcnkncyBodG1sKCksIG90aGVyd2lzZSBqdXN0IGlubmVySFRNTC4KCSAqLwoJcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggd2luZG93LmpRdWVyeSApIHsKCQkJalF1ZXJ5KCAiI21haW4sICNxdW5pdC1maXh0dXJlIiApLmh0bWwoIGNvbmZpZy5maXh0dXJlICk7CgkJfSBlbHNlIHsKCQkJdmFyIG1haW4gPSBpZCggJ21haW4nICkgfHwgaWQoICdxdW5pdC1maXh0dXJlJyApOwoJCQlpZiAoIG1haW4gKSB7CgkJCQltYWluLmlubmVySFRNTCA9IGNvbmZpZy5maXh0dXJlOwoJCQl9CgkJfQoJfSwKCgkvKioKCSAqIFRyaWdnZXIgYW4gZXZlbnQgb24gYW4gZWxlbWVudC4KCSAqCgkgKiBAZXhhbXBsZSB0cmlnZ2VyRXZlbnQoIGRvY3VtZW50LmJvZHksICJjbGljayIgKTsKCSAqCgkgKiBAcGFyYW0gRE9NRWxlbWVudCBlbGVtCgkgKiBAcGFyYW0gU3RyaW5nIHR5cGUKCSAqLwoJdHJpZ2dlckV2ZW50OiBmdW5jdGlvbiggZWxlbSwgdHlwZSwgZXZlbnQgKSB7CgkJaWYgKCBkb2N1bWVudC5jcmVhdGVFdmVudCApIHsKCQkJZXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCgiTW91c2VFdmVudHMiKTsKCQkJZXZlbnQuaW5pdE1vdXNlRXZlbnQodHlwZSwgdHJ1ZSwgdHJ1ZSwgZWxlbS5vd25lckRvY3VtZW50LmRlZmF1bHRWaWV3LAoJCQkJMCwgMCwgMCwgMCwgMCwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsIDAsIG51bGwpOwoJCQllbGVtLmRpc3BhdGNoRXZlbnQoIGV2ZW50ICk7CgoJCX0gZWxzZSBpZiAoIGVsZW0uZmlyZUV2ZW50ICkgewoJCQllbGVtLmZpcmVFdmVudCgib24iK3R5cGUpOwoJCX0KCX0sCgoJLy8gU2FmZSBvYmplY3QgdHlwZSBjaGVja2luZwoJaXM6IGZ1bmN0aW9uKCB0eXBlLCBvYmogKSB7CgkJcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoIG9iaiApID09IHR5cGU7Cgl9LAoKCW9iamVjdFR5cGU6IGZ1bmN0aW9uKCBvYmogKSB7CgkJaWYgKHR5cGVvZiBvYmogPT09ICJ1bmRlZmluZWQiKSB7CgkJCQlyZXR1cm4gInVuZGVmaW5lZCI7CgoJCS8vIGNvbnNpZGVyOiB0eXBlb2YgbnVsbCA9PT0gb2JqZWN0CgkJfQoJCWlmIChvYmogPT09IG51bGwpIHsKCQkJCXJldHVybiAibnVsbCI7CgkJfQoKCQl2YXIgdHlwZSA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbCggb2JqICkKCQkJLm1hdGNoKC9eXFtvYmplY3RccyguKilcXSQvKVsxXSB8fCAnJzsKCgkJc3dpdGNoICh0eXBlKSB7CgkJCQljYXNlICdOdW1iZXInOgoJCQkJCQlpZiAoaXNOYU4ob2JqKSkgewoJCQkJCQkJCXJldHVybiAibmFuIjsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlyZXR1cm4gIm51bWJlciI7CgkJCQkJCX0KCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQljYXNlICdCb29sZWFuJzoKCQkJCWNhc2UgJ0FycmF5JzoKCQkJCWNhc2UgJ0RhdGUnOgoJCQkJY2FzZSAnUmVnRXhwJzoKCQkJCWNhc2UgJ0Z1bmN0aW9uJzoKCQkJCQkJcmV0dXJuIHR5cGUudG9Mb3dlckNhc2UoKTsKCQl9CgkJaWYgKHR5cGVvZiBvYmogPT09ICJvYmplY3QiKSB7CgkJCQlyZXR1cm4gIm9iamVjdCI7CgkJfQoJCXJldHVybiB1bmRlZmluZWQ7Cgl9LAoKCXB1c2g6IGZ1bmN0aW9uKHJlc3VsdCwgYWN0dWFsLCBleHBlY3RlZCwgbWVzc2FnZSkgewoJCXZhciBkZXRhaWxzID0gewoJCQlyZXN1bHQ6IHJlc3VsdCwKCQkJbWVzc2FnZTogbWVzc2FnZSwKCQkJYWN0dWFsOiBhY3R1YWwsCgkJCWV4cGVjdGVkOiBleHBlY3RlZAoJCX07CgoJCW1lc3NhZ2UgPSBlc2NhcGVIdG1sKG1lc3NhZ2UpIHx8IChyZXN1bHQgPyAib2theSIgOiAiZmFpbGVkIik7CgkJbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0idGVzdC1tZXNzYWdlIj4nICsgbWVzc2FnZSArICI8L3NwYW4+IjsKCQlleHBlY3RlZCA9IGVzY2FwZUh0bWwoUVVuaXQuanNEdW1wLnBhcnNlKGV4cGVjdGVkKSk7CgkJYWN0dWFsID0gZXNjYXBlSHRtbChRVW5pdC5qc0R1bXAucGFyc2UoYWN0dWFsKSk7CgkJdmFyIG91dHB1dCA9IG1lc3NhZ2UgKyAnPHRhYmxlPjx0ciBjbGFzcz0idGVzdC1leHBlY3RlZCI+PHRoPkV4cGVjdGVkOiA8L3RoPjx0ZD48cHJlPicgKyBleHBlY3RlZCArICc8L3ByZT48L3RkPjwvdHI+JzsKCQlpZiAoYWN0dWFsICE9IGV4cGVjdGVkKSB7CgkJCW91dHB1dCArPSAnPHRyIGNsYXNzPSJ0ZXN0LWFjdHVhbCI+PHRoPlJlc3VsdDogPC90aD48dGQ+PHByZT4nICsgYWN0dWFsICsgJzwvcHJlPjwvdGQ+PC90cj4nOwoJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1kaWZmIj48dGg+RGlmZjogPC90aD48dGQ+PHByZT4nICsgUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKSArJzwvcHJlPjwvdGQ+PC90cj4nOwoJCX0KCQlpZiAoIXJlc3VsdCkgewoJCQl2YXIgc291cmNlID0gc291cmNlRnJvbVN0YWNrdHJhY2UoKTsKCQkJaWYgKHNvdXJjZSkgewoJCQkJZGV0YWlscy5zb3VyY2UgPSBzb3VyY2U7CgkJCQlvdXRwdXQgKz0gJzx0ciBjbGFzcz0idGVzdC1zb3VyY2UiPjx0aD5Tb3VyY2U6IDwvdGg+PHRkPjxwcmU+JyArIHNvdXJjZSArJzwvcHJlPjwvdGQ+PC90cj4nOwoJCQl9CgkJfQoJCW91dHB1dCArPSAiPC90YWJsZT4iOwoKCQlRVW5pdC5sb2cocmVzdWx0LCBtZXNzYWdlLCBkZXRhaWxzKTsKCgkJY29uZmlnLmN1cnJlbnQuYXNzZXJ0aW9ucy5wdXNoKHsKCQkJcmVzdWx0OiAhIXJlc3VsdCwKCQkJbWVzc2FnZTogb3V0cHV0CgkJfSk7Cgl9LAoKCS8vIExvZ2dpbmcgY2FsbGJhY2tzCgliZWdpbjogZnVuY3Rpb24oKSB7fSwKCWRvbmU6IGZ1bmN0aW9uKGZhaWx1cmVzLCB0b3RhbCkge30sCglsb2c6IGZ1bmN0aW9uKHJlc3VsdCwgbWVzc2FnZSkge30sCgl0ZXN0U3RhcnQ6IGZ1bmN0aW9uKG5hbWUsIHRlc3RFbnZpcm9ubWVudCkge30sCgl0ZXN0RG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fSwKCW1vZHVsZVN0YXJ0OiBmdW5jdGlvbihuYW1lLCB0ZXN0RW52aXJvbm1lbnQpIHt9LAoJbW9kdWxlRG9uZTogZnVuY3Rpb24obmFtZSwgZmFpbHVyZXMsIHRvdGFsKSB7fQp9KTsKCmlmICggdHlwZW9mIGRvY3VtZW50ID09PSAidW5kZWZpbmVkIiB8fCBkb2N1bWVudC5yZWFkeVN0YXRlID09PSAiY29tcGxldGUiICkgewoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOwp9CgphZGRFdmVudCh3aW5kb3csICJsb2FkIiwgZnVuY3Rpb24oKSB7CglRVW5pdC5iZWdpbigpOwoKCS8vIEluaXRpYWxpemUgdGhlIGNvbmZpZywgc2F2aW5nIHRoZSBleGVjdXRpb24gcXVldWUKCXZhciBvbGRjb25maWcgPSBleHRlbmQoe30sIGNvbmZpZyk7CglRVW5pdC5pbml0KCk7CglleHRlbmQoY29uZmlnLCBvbGRjb25maWcpOwoKCWNvbmZpZy5ibG9ja2luZyA9IGZhbHNlOwoKCXZhciB1c2VyQWdlbnQgPSBpZCgicXVuaXQtdXNlckFnZW50Iik7CglpZiAoIHVzZXJBZ2VudCApIHsKCQl1c2VyQWdlbnQuaW5uZXJIVE1MID0gbmF2aWdhdG9yLnVzZXJBZ2VudDsKCX0KCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtaGVhZGVyIik7CglpZiAoIGJhbm5lciApIHsKCQl2YXIgcGFyYW1zSW5kZXggPSBsb2NhdGlvbi5ocmVmLmxhc3RJbmRleE9mKGxvY2F0aW9uLnNlYXJjaCk7CgkJaWYgKCBwYXJhbXNJbmRleCA+IC0xICkgewoJCQl2YXIgbWFpblBhZ2VMb2NhdGlvbiA9IGxvY2F0aW9uLmhyZWYuc2xpY2UoMCwgcGFyYW1zSW5kZXgpOwoJCQlpZiAoIG1haW5QYWdlTG9jYXRpb24gPT0gbG9jYXRpb24uaHJlZiApIHsKCQkJCWJhbm5lci5pbm5lckhUTUwgPSAnPGEgaHJlZj0iIj4gJyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAnOwoJCQl9IGVsc2UgewoJCQkJdmFyIHRlc3ROYW1lID0gZGVjb2RlVVJJQ29tcG9uZW50KGxvY2F0aW9uLnNlYXJjaC5zbGljZSgxKSk7CgkJCQliYW5uZXIuaW5uZXJIVE1MID0gJzxhIGhyZWY9IicgKyBtYWluUGFnZUxvY2F0aW9uICsgJyI+JyArIGJhbm5lci5pbm5lckhUTUwgKyAnPC9hPiAmIzgyNTA7IDxhIGhyZWY9IiI+JyArIHRlc3ROYW1lICsgJzwvYT4nOwoJCQl9CgkJfQoJfQoKCXZhciB0b29sYmFyID0gaWQoInF1bml0LXRlc3RydW5uZXItdG9vbGJhciIpOwoJaWYgKCB0b29sYmFyICkgewoJCXRvb2xiYXIuc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCgkJdmFyIGZpbHRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImlucHV0Iik7CgkJZmlsdGVyLnR5cGUgPSAiY2hlY2tib3giOwoJCWZpbHRlci5pZCA9ICJxdW5pdC1maWx0ZXItcGFzcyI7CgkJZmlsdGVyLmRpc2FibGVkID0gdHJ1ZTsKCQlhZGRFdmVudCggZmlsdGVyLCAiY2xpY2siLCBmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImxpIik7CgkJCWZvciAoIHZhciBpID0gMDsgaSA8IGxpLmxlbmd0aDsgaSsrICkgewoJCQkJaWYgKCBsaVtpXS5jbGFzc05hbWUuaW5kZXhPZigicGFzcyIpID4gLTEgKSB7CgkJCQkJbGlbaV0uc3R5bGUuZGlzcGxheSA9IGZpbHRlci5jaGVja2VkID8gIm5vbmUiIDogIiI7CgkJCQl9CgkJCX0KCQl9KTsKCQl0b29sYmFyLmFwcGVuZENoaWxkKCBmaWx0ZXIgKTsKCgkJdmFyIGxhYmVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgibGFiZWwiKTsKCQlsYWJlbC5zZXRBdHRyaWJ1dGUoImZvciIsICJxdW5pdC1maWx0ZXItcGFzcyIpOwoJCWxhYmVsLmlubmVySFRNTCA9ICJIaWRlIHBhc3NlZCB0ZXN0cyI7CgkJdG9vbGJhci5hcHBlbmRDaGlsZCggbGFiZWwgKTsKCX0KCgl2YXIgbWFpbiA9IGlkKCdtYWluJykgfHwgaWQoJ3F1bml0LWZpeHR1cmUnKTsKCWlmICggbWFpbiApIHsKCQljb25maWcuZml4dHVyZSA9IG1haW4uaW5uZXJIVE1MOwoJfQoKCWlmIChjb25maWcuYXV0b3N0YXJ0KSB7CgkJUVVuaXQuc3RhcnQoKTsKCX0KfSk7CgpmdW5jdGlvbiBkb25lKCkgewoJY29uZmlnLmF1dG9ydW4gPSB0cnVlOwoKCS8vIExvZyB0aGUgbGFzdCBtb2R1bGUgcmVzdWx0cwoJaWYgKCBjb25maWcuY3VycmVudE1vZHVsZSApIHsKCQlRVW5pdC5tb2R1bGVEb25lKCBjb25maWcuY3VycmVudE1vZHVsZSwgY29uZmlnLm1vZHVsZVN0YXRzLmJhZCwgY29uZmlnLm1vZHVsZVN0YXRzLmFsbCApOwoJfQoKCXZhciBiYW5uZXIgPSBpZCgicXVuaXQtYmFubmVyIiksCgkJdGVzdHMgPSBpZCgicXVuaXQtdGVzdHMiKSwKCQlodG1sID0gWydUZXN0cyBjb21wbGV0ZWQgaW4gJywKCQkrbmV3IERhdGUgLSBjb25maWcuc3RhcnRlZCwgJyBtaWxsaXNlY29uZHMuPGJyLz4nLAoJCSc8c3BhbiBjbGFzcz0icGFzc2VkIj4nLCBjb25maWcuc3RhdHMuYWxsIC0gY29uZmlnLnN0YXRzLmJhZCwgJzwvc3Bhbj4gdGVzdHMgb2YgPHNwYW4gY2xhc3M9InRvdGFsIj4nLCBjb25maWcuc3RhdHMuYWxsLCAnPC9zcGFuPiBwYXNzZWQsIDxzcGFuIGNsYXNzPSJmYWlsZWQiPicsIGNvbmZpZy5zdGF0cy5iYWQsJzwvc3Bhbj4gZmFpbGVkLiddLmpvaW4oJycpOwoKCWlmICggYmFubmVyICkgewoJCWJhbm5lci5jbGFzc05hbWUgPSAoY29uZmlnLnN0YXRzLmJhZCA/ICJxdW5pdC1mYWlsIiA6ICJxdW5pdC1wYXNzIik7Cgl9CgoJaWYgKCB0ZXN0cyApIHsKCQl2YXIgcmVzdWx0ID0gaWQoInF1bml0LXRlc3RyZXN1bHQiKTsKCgkJaWYgKCAhcmVzdWx0ICkgewoJCQlyZXN1bHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJwIik7CgkJCXJlc3VsdC5pZCA9ICJxdW5pdC10ZXN0cmVzdWx0IjsKCQkJcmVzdWx0LmNsYXNzTmFtZSA9ICJyZXN1bHQiOwoJCQl0ZXN0cy5wYXJlbnROb2RlLmluc2VydEJlZm9yZSggcmVzdWx0LCB0ZXN0cy5uZXh0U2libGluZyApOwoJCX0KCgkJcmVzdWx0LmlubmVySFRNTCA9IGh0bWw7Cgl9CgoJUVVuaXQuZG9uZSggY29uZmlnLnN0YXRzLmJhZCwgY29uZmlnLnN0YXRzLmFsbCApOwp9CgpmdW5jdGlvbiB2YWxpZFRlc3QoIG5hbWUgKSB7Cgl2YXIgaSA9IGNvbmZpZy5maWx0ZXJzLmxlbmd0aCwKCQlydW4gPSBmYWxzZTsKCglpZiAoICFpICkgewoJCXJldHVybiB0cnVlOwoJfQoKCXdoaWxlICggaS0tICkgewoJCXZhciBmaWx0ZXIgPSBjb25maWcuZmlsdGVyc1tpXSwKCQkJbm90ID0gZmlsdGVyLmNoYXJBdCgwKSA9PSAnISc7CgoJCWlmICggbm90ICkgewoJCQlmaWx0ZXIgPSBmaWx0ZXIuc2xpY2UoMSk7CgkJfQoKCQlpZiAoIG5hbWUuaW5kZXhPZihmaWx0ZXIpICE9PSAtMSApIHsKCQkJcmV0dXJuICFub3Q7CgkJfQoKCQlpZiAoIG5vdCApIHsKCQkJcnVuID0gdHJ1ZTsKCQl9Cgl9CgoJcmV0dXJuIHJ1bjsKfQoKLy8gc28gZmFyIHN1cHBvcnRzIG9ubHkgRmlyZWZveCwgQ2hyb21lIGFuZCBPcGVyYSAoYnVnZ3kpCi8vIGNvdWxkIGJlIGV4dGVuZGVkIGluIHRoZSBmdXR1cmUgdG8gdXNlIHNvbWV0aGluZyBsaWtlIGh0dHBzOi8vZ2l0aHViLmNvbS9jc25vdmVyL1RyYWNlS2l0CmZ1bmN0aW9uIHNvdXJjZUZyb21TdGFja3RyYWNlKCkgewoJdHJ5IHsKCQl0aHJvdyBuZXcgRXJyb3IoKTsKCX0gY2F0Y2ggKCBlICkgewoJCWlmIChlLnN0YWNrdHJhY2UpIHsKCQkJLy8gT3BlcmEKCQkJcmV0dXJuIGUuc3RhY2t0cmFjZS5zcGxpdCgiXG4iKVs2XTsKCQl9IGVsc2UgaWYgKGUuc3RhY2spIHsKCQkJLy8gRmlyZWZveCwgQ2hyb21lCgkJCXJldHVybiBlLnN0YWNrLnNwbGl0KCJcbiIpWzRdOwoJCX0KCX0KfQoKZnVuY3Rpb24gcmVzdWx0RGlzcGxheVN0eWxlKHBhc3NlZCkgewoJcmV0dXJuIHBhc3NlZCAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKSAmJiBpZCgicXVuaXQtZmlsdGVyLXBhc3MiKS5jaGVja2VkID8gJ25vbmUnIDogJyc7Cn0KCmZ1bmN0aW9uIGVzY2FwZUh0bWwocykgewoJaWYgKCFzKSB7CgkJcmV0dXJuICIiOwoJfQoJcyA9IHMgKyAiIjsKCXJldHVybiBzLnJlcGxhY2UoL1tcJiI8PlxcXS9nLCBmdW5jdGlvbihzKSB7CgkJc3dpdGNoKHMpIHsKCQkJY2FzZSAiJiI6IHJldHVybiAiJmFtcDsiOwoJCQljYXNlICJcXCI6IHJldHVybiAiXFxcXCI7CgkJCWNhc2UgJyInOiByZXR1cm4gJ1wiJzsKCQkJY2FzZSAiPCI6IHJldHVybiAiJmx0OyI7CgkJCWNhc2UgIj4iOiByZXR1cm4gIiZndDsiOwoJCQlkZWZhdWx0OiByZXR1cm4gczsKCQl9Cgl9KTsKfQoKZnVuY3Rpb24gc3luY2hyb25pemUoIGNhbGxiYWNrICkgewoJY29uZmlnLnF1ZXVlLnB1c2goIGNhbGxiYWNrICk7CgoJaWYgKCBjb25maWcuYXV0b3J1biAmJiAhY29uZmlnLmJsb2NraW5nICkgewoJCXByb2Nlc3MoKTsKCX0KfQoKZnVuY3Rpb24gcHJvY2VzcygpIHsKCXZhciBzdGFydCA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7CgoJd2hpbGUgKCBjb25maWcucXVldWUubGVuZ3RoICYmICFjb25maWcuYmxvY2tpbmcgKSB7CgkJaWYgKCBjb25maWcudXBkYXRlUmF0ZSA8PSAwIHx8ICgoKG5ldyBEYXRlKCkpLmdldFRpbWUoKSAtIHN0YXJ0KSA8IGNvbmZpZy51cGRhdGVSYXRlKSApIHsKCQkJY29uZmlnLnF1ZXVlLnNoaWZ0KCkoKTsKCQl9IGVsc2UgewoJCQl3aW5kb3cuc2V0VGltZW91dCggcHJvY2VzcywgMTMgKTsKCQkJYnJlYWs7CgkJfQoJfQogIGlmICghY29uZmlnLmJsb2NraW5nICYmICFjb25maWcucXVldWUubGVuZ3RoKSB7CiAgICBkb25lKCk7CiAgfQp9CgpmdW5jdGlvbiBzYXZlR2xvYmFsKCkgewoJY29uZmlnLnBvbGx1dGlvbiA9IFtdOwoKCWlmICggY29uZmlnLm5vZ2xvYmFscyApIHsKCQlmb3IgKCB2YXIga2V5IGluIHdpbmRvdyApIHsKCQkJY29uZmlnLnBvbGx1dGlvbi5wdXNoKCBrZXkgKTsKCQl9Cgl9Cn0KCmZ1bmN0aW9uIGNoZWNrUG9sbHV0aW9uKCBuYW1lICkgewoJdmFyIG9sZCA9IGNvbmZpZy5wb2xsdXRpb247CglzYXZlR2xvYmFsKCk7CgoJdmFyIG5ld0dsb2JhbHMgPSBkaWZmKCBvbGQsIGNvbmZpZy5wb2xsdXRpb24gKTsKCWlmICggbmV3R2xvYmFscy5sZW5ndGggPiAwICkgewoJCW9rKCBmYWxzZSwgIkludHJvZHVjZWQgZ2xvYmFsIHZhcmlhYmxlKHMpOiAiICsgbmV3R2xvYmFscy5qb2luKCIsICIpICk7CgkJY29uZmlnLmN1cnJlbnQuZXhwZWN0ZWQrKzsKCX0KCgl2YXIgZGVsZXRlZEdsb2JhbHMgPSBkaWZmKCBjb25maWcucG9sbHV0aW9uLCBvbGQgKTsKCWlmICggZGVsZXRlZEdsb2JhbHMubGVuZ3RoID4gMCApIHsKCQlvayggZmFsc2UsICJEZWxldGVkIGdsb2JhbCB2YXJpYWJsZShzKTogIiArIGRlbGV0ZWRHbG9iYWxzLmpvaW4oIiwgIikgKTsKCQljb25maWcuY3VycmVudC5leHBlY3RlZCsrOwoJfQp9CgovLyByZXR1cm5zIGEgbmV3IEFycmF5IHdpdGggdGhlIGVsZW1lbnRzIHRoYXQgYXJlIGluIGEgYnV0IG5vdCBpbiBiCmZ1bmN0aW9uIGRpZmYoIGEsIGIgKSB7Cgl2YXIgcmVzdWx0ID0gYS5zbGljZSgpOwoJZm9yICggdmFyIGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrICkgewoJCWZvciAoIHZhciBqID0gMDsgaiA8IGIubGVuZ3RoOyBqKysgKSB7CgkJCWlmICggcmVzdWx0W2ldID09PSBiW2pdICkgewoJCQkJcmVzdWx0LnNwbGljZShpLCAxKTsKCQkJCWktLTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKZnVuY3Rpb24gZmFpbChtZXNzYWdlLCBleGNlcHRpb24sIGNhbGxiYWNrKSB7CglpZiAoIHR5cGVvZiBjb25zb2xlICE9PSAidW5kZWZpbmVkIiAmJiBjb25zb2xlLmVycm9yICYmIGNvbnNvbGUud2FybiApIHsKCQljb25zb2xlLmVycm9yKG1lc3NhZ2UpOwoJCWNvbnNvbGUuZXJyb3IoZXhjZXB0aW9uKTsKCQljb25zb2xlLndhcm4oY2FsbGJhY2sudG9TdHJpbmcoKSk7CgoJfSBlbHNlIGlmICggd2luZG93Lm9wZXJhICYmIG9wZXJhLnBvc3RFcnJvciApIHsKCQlvcGVyYS5wb3N0RXJyb3IobWVzc2FnZSwgZXhjZXB0aW9uLCBjYWxsYmFjay50b1N0cmluZyk7Cgl9Cn0KCmZ1bmN0aW9uIGV4dGVuZChhLCBiKSB7Cglmb3IgKCB2YXIgcHJvcCBpbiBiICkgewoJCWFbcHJvcF0gPSBiW3Byb3BdOwoJfQoKCXJldHVybiBhOwp9CgpmdW5jdGlvbiBhZGRFdmVudChlbGVtLCB0eXBlLCBmbikgewoJaWYgKCBlbGVtLmFkZEV2ZW50TGlzdGVuZXIgKSB7CgkJZWxlbS5hZGRFdmVudExpc3RlbmVyKCB0eXBlLCBmbiwgZmFsc2UgKTsKCX0gZWxzZSBpZiAoIGVsZW0uYXR0YWNoRXZlbnQgKSB7CgkJZWxlbS5hdHRhY2hFdmVudCggIm9uIiArIHR5cGUsIGZuICk7Cgl9IGVsc2UgewoJCWZuKCk7Cgl9Cn0KCmZ1bmN0aW9uIGlkKG5hbWUpIHsKCXJldHVybiAhISh0eXBlb2YgZG9jdW1lbnQgIT09ICJ1bmRlZmluZWQiICYmIGRvY3VtZW50ICYmIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKSAmJgoJCWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBuYW1lICk7Cn0KCi8vIFRlc3QgZm9yIGVxdWFsaXR5IGFueSBKYXZhU2NyaXB0IHR5cGUuCi8vIERpc2N1c3Npb25zIGFuZCByZWZlcmVuY2U6IGh0dHA6Ly9waGlscmF0aGUuY29tL2FydGljbGVzL2VxdWl2Ci8vIFRlc3Qgc3VpdGVzOiBodHRwOi8vcGhpbHJhdGhlLmNvbS90ZXN0cy9lcXVpdgovLyBBdXRob3I6IFBoaWxpcHBlIFJhdGjDqSA8cHJhdGhlQGdtYWlsLmNvbT4KUVVuaXQuZXF1aXYgPSBmdW5jdGlvbiAoKSB7CgogICAgdmFyIGlubmVyRXF1aXY7IC8vIHRoZSByZWFsIGVxdWl2IGZ1bmN0aW9uCiAgICB2YXIgY2FsbGVycyA9IFtdOyAvLyBzdGFjayB0byBkZWNpZGUgYmV0d2VlbiBza2lwL2Fib3J0IGZ1bmN0aW9ucwogICAgdmFyIHBhcmVudHMgPSBbXTsgLy8gc3RhY2sgdG8gYXZvaWRpbmcgbG9vcHMgZnJvbSBjaXJjdWxhciByZWZlcmVuY2luZwoKICAgIC8vIENhbGwgdGhlIG8gcmVsYXRlZCBjYWxsYmFjayB3aXRoIHRoZSBnaXZlbiBhcmd1bWVudHMuCiAgICBmdW5jdGlvbiBiaW5kQ2FsbGJhY2tzKG8sIGNhbGxiYWNrcywgYXJncykgewogICAgICAgIHZhciBwcm9wID0gUVVuaXQub2JqZWN0VHlwZShvKTsKICAgICAgICBpZiAocHJvcCkgewogICAgICAgICAgICBpZiAoUVVuaXQub2JqZWN0VHlwZShjYWxsYmFja3NbcHJvcF0pID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdLmFwcGx5KGNhbGxiYWNrcywgYXJncyk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gY2FsbGJhY2tzW3Byb3BdOyAvLyBvciB1bmRlZmluZWQKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICB2YXIgY2FsbGJhY2tzID0gZnVuY3Rpb24gKCkgewoKICAgICAgICAvLyBmb3Igc3RyaW5nLCBib29sZWFuLCBudW1iZXIgYW5kIG51bGwKICAgICAgICBmdW5jdGlvbiB1c2VTdHJpY3RFcXVhbGl0eShiLCBhKSB7CiAgICAgICAgICAgIGlmIChiIGluc3RhbmNlb2YgYS5jb25zdHJ1Y3RvciB8fCBhIGluc3RhbmNlb2YgYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgLy8gdG8gY2F0Y2ggc2hvcnQgYW5ub3RhaW9uIFZTICduZXcnIGFubm90YXRpb24gb2YgYSBkZWNsYXJhdGlvbgogICAgICAgICAgICAgICAgLy8gZS5nLiB2YXIgaSA9IDE7CiAgICAgICAgICAgICAgICAvLyAgICAgIHZhciBqID0gbmV3IE51bWJlcigxKTsKICAgICAgICAgICAgICAgIHJldHVybiBhID09IGI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICByZXR1cm4gYSA9PT0gYjsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgInN0cmluZyI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAiYm9vbGVhbiI6IHVzZVN0cmljdEVxdWFsaXR5LAogICAgICAgICAgICAibnVtYmVyIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJudWxsIjogdXNlU3RyaWN0RXF1YWxpdHksCiAgICAgICAgICAgICJ1bmRlZmluZWQiOiB1c2VTdHJpY3RFcXVhbGl0eSwKCiAgICAgICAgICAgICJuYW4iOiBmdW5jdGlvbiAoYikgewogICAgICAgICAgICAgICAgcmV0dXJuIGlzTmFOKGIpOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgImRhdGUiOiBmdW5jdGlvbiAoYiwgYSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJkYXRlIiAmJiBhLnZhbHVlT2YoKSA9PT0gYi52YWx1ZU9mKCk7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAicmVnZXhwIjogZnVuY3Rpb24gKGIsIGEpIHsKICAgICAgICAgICAgICAgIHJldHVybiBRVW5pdC5vYmplY3RUeXBlKGIpID09PSAicmVnZXhwIiAmJgogICAgICAgICAgICAgICAgICAgIGEuc291cmNlID09PSBiLnNvdXJjZSAmJiAvLyB0aGUgcmVnZXggaXRzZWxmCiAgICAgICAgICAgICAgICAgICAgYS5nbG9iYWwgPT09IGIuZ2xvYmFsICYmIC8vIGFuZCBpdHMgbW9kaWZlcnMgKGdtaSkgLi4uCiAgICAgICAgICAgICAgICAgICAgYS5pZ25vcmVDYXNlID09PSBiLmlnbm9yZUNhc2UgJiYKICAgICAgICAgICAgICAgICAgICBhLm11bHRpbGluZSA9PT0gYi5tdWx0aWxpbmU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICAvLyAtIHNraXAgd2hlbiB0aGUgcHJvcGVydHkgaXMgYSBtZXRob2Qgb2YgYW4gaW5zdGFuY2UgKE9PUCkKICAgICAgICAgICAgLy8gLSBhYm9ydCBvdGhlcndpc2UsCiAgICAgICAgICAgIC8vICAgaW5pdGlhbCA9PT0gd291bGQgaGF2ZSBjYXRjaCBpZGVudGljYWwgcmVmZXJlbmNlcyBhbnl3YXkKICAgICAgICAgICAgImZ1bmN0aW9uIjogZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgdmFyIGNhbGxlciA9IGNhbGxlcnNbY2FsbGVycy5sZW5ndGggLSAxXTsKICAgICAgICAgICAgICAgIHJldHVybiBjYWxsZXIgIT09IE9iamVjdCAmJgogICAgICAgICAgICAgICAgICAgICAgICB0eXBlb2YgY2FsbGVyICE9PSAidW5kZWZpbmVkIjsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgICJhcnJheSI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsKICAgICAgICAgICAgICAgIHZhciBsZW47CgogICAgICAgICAgICAgICAgLy8gYiBjb3VsZCBiZSBhbiBvYmplY3QgbGl0ZXJhbCBoZXJlCiAgICAgICAgICAgICAgICBpZiAoICEgKFFVbml0Lm9iamVjdFR5cGUoYikgPT09ICJhcnJheSIpKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGxlbiA9IGEubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKGxlbiAhPT0gYi5sZW5ndGgpIHsgLy8gc2FmZSBhbmQgZmFzdGVyCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vdHJhY2sgcmVmZXJlbmNlIHRvIGF2b2lkIGNpcmN1bGFyIHJlZmVyZW5jZXMKICAgICAgICAgICAgICAgIHBhcmVudHMucHVzaChhKTsKICAgICAgICAgICAgICAgIGZvciAoaSA9IDA7IGkgPCBsZW47IGkrKykgewogICAgICAgICAgICAgICAgICAgIGxvb3AgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBmb3Ioaj0wO2o8cGFyZW50cy5sZW5ndGg7aisrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocGFyZW50c1tqXSA9PT0gYVtpXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb29wID0gdHJ1ZTsvL2RvbnQgcmV3YWxrIGFycmF5CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGFyZW50cy5wb3AoKTsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICB9LAoKICAgICAgICAgICAgIm9iamVjdCI6IGZ1bmN0aW9uIChiLCBhKSB7CiAgICAgICAgICAgICAgICB2YXIgaSwgaiwgbG9vcDsKICAgICAgICAgICAgICAgIHZhciBlcSA9IHRydWU7IC8vIHVubGVzcyB3ZSBjYW4gcHJvb3ZlIGl0CiAgICAgICAgICAgICAgICB2YXIgYVByb3BlcnRpZXMgPSBbXSwgYlByb3BlcnRpZXMgPSBbXTsgLy8gY29sbGVjdGlvbiBvZiBzdHJpbmdzCgogICAgICAgICAgICAgICAgLy8gY29tcGFyaW5nIGNvbnN0cnVjdG9ycyBpcyBtb3JlIHN0cmljdCB0aGFuIHVzaW5nIGluc3RhbmNlb2YKICAgICAgICAgICAgICAgIGlmICggYS5jb25zdHJ1Y3RvciAhPT0gYi5jb25zdHJ1Y3RvcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBzdGFjayBjb25zdHJ1Y3RvciBiZWZvcmUgdHJhdmVyc2luZyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICBjYWxsZXJzLnB1c2goYS5jb25zdHJ1Y3Rvcik7CiAgICAgICAgICAgICAgICAvL3RyYWNrIHJlZmVyZW5jZSB0byBhdm9pZCBjaXJjdWxhciByZWZlcmVuY2VzCiAgICAgICAgICAgICAgICBwYXJlbnRzLnB1c2goYSk7CgogICAgICAgICAgICAgICAgZm9yIChpIGluIGEpIHsgLy8gYmUgc3RyaWN0OiBkb24ndCBlbnN1cmVzIGhhc093blByb3BlcnR5IGFuZCBnbyBkZWVwCiAgICAgICAgICAgICAgICAgICAgbG9vcCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGZvcihqPTA7ajxwYXJlbnRzLmxlbmd0aDtqKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZihwYXJlbnRzW2pdID09PSBhW2ldKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9vcCA9IHRydWU7IC8vZG9uJ3QgZ28gZG93biB0aGUgc2FtZSBwYXRoIHR3aWNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGFQcm9wZXJ0aWVzLnB1c2goaSk7IC8vIGNvbGxlY3QgYSdzIHByb3BlcnRpZXMKCiAgICAgICAgICAgICAgICAgICAgaWYgKCFsb29wICYmICEgaW5uZXJFcXVpdihhW2ldLCBiW2ldKSkgewogICAgICAgICAgICAgICAgICAgICAgICBlcSA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgY2FsbGVycy5wb3AoKTsgLy8gdW5zdGFjaywgd2UgYXJlIGRvbmUKICAgICAgICAgICAgICAgIHBhcmVudHMucG9wKCk7CgogICAgICAgICAgICAgICAgZm9yIChpIGluIGIpIHsKICAgICAgICAgICAgICAgICAgICBiUHJvcGVydGllcy5wdXNoKGkpOyAvLyBjb2xsZWN0IGIncyBwcm9wZXJ0aWVzCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gRW5zdXJlcyBpZGVudGljYWwgcHJvcGVydGllcyBuYW1lCiAgICAgICAgICAgICAgICByZXR1cm4gZXEgJiYgaW5uZXJFcXVpdihhUHJvcGVydGllcy5zb3J0KCksIGJQcm9wZXJ0aWVzLnNvcnQoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgfSgpOwoKICAgIGlubmVyRXF1aXYgPSBmdW5jdGlvbiAoKSB7IC8vIGNhbiB0YWtlIG11bHRpcGxlIGFyZ3VtZW50cwogICAgICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmFwcGx5KGFyZ3VtZW50cyk7CiAgICAgICAgaWYgKGFyZ3MubGVuZ3RoIDwgMikgewogICAgICAgICAgICByZXR1cm4gdHJ1ZTsgLy8gZW5kIHRyYW5zaXRpb24KICAgICAgICB9CgogICAgICAgIHJldHVybiAoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgaWYgKGEgPT09IGIpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOyAvLyBjYXRjaCB0aGUgbW9zdCB5b3UgY2FuCiAgICAgICAgICAgIH0gZWxzZSBpZiAoYSA9PT0gbnVsbCB8fCBiID09PSBudWxsIHx8IHR5cGVvZiBhID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YgYiA9PT0gInVuZGVmaW5lZCIgfHwgUVVuaXQub2JqZWN0VHlwZShhKSAhPT0gUVVuaXQub2JqZWN0VHlwZShiKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBkb24ndCBsb3NlIHRpbWUgd2l0aCBlcnJvciBwcm9uZSBjYXNlcwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgcmV0dXJuIGJpbmRDYWxsYmFja3MoYSwgY2FsbGJhY2tzLCBbYiwgYV0pOwogICAgICAgICAgICB9CgogICAgICAgIC8vIGFwcGx5IHRyYW5zaXRpb24gd2l0aCAoMS4ubikgYXJndW1lbnRzCiAgICAgICAgfSkoYXJnc1swXSwgYXJnc1sxXSkgJiYgYXJndW1lbnRzLmNhbGxlZS5hcHBseSh0aGlzLCBhcmdzLnNwbGljZSgxLCBhcmdzLmxlbmd0aCAtMSkpOwogICAgfTsKCiAgICByZXR1cm4gaW5uZXJFcXVpdjsKCn0oKTsKCi8qKgogKiBqc0R1bXAKICogQ29weXJpZ2h0IChjKSAyMDA4IEFyaWVsIEZsZXNsZXIgLSBhZmxlc2xlcihhdClnbWFpbChkb3QpY29tIHwgaHR0cDovL2ZsZXNsZXIuYmxvZ3Nwb3QuY29tCiAqIExpY2Vuc2VkIHVuZGVyIEJTRCAoaHR0cDovL3d3dy5vcGVuc291cmNlLm9yZy9saWNlbnNlcy9ic2QtbGljZW5zZS5waHApCiAqIERhdGU6IDUvMTUvMjAwOAogKiBAcHJvamVjdERlc2NyaXB0aW9uIEFkdmFuY2VkIGFuZCBleHRlbnNpYmxlIGRhdGEgZHVtcGluZyBmb3IgSmF2YXNjcmlwdC4KICogQHZlcnNpb24gMS4wLjAKICogQGF1dGhvciBBcmllbCBGbGVzbGVyCiAqIEBsaW5rIHtodHRwOi8vZmxlc2xlci5ibG9nc3BvdC5jb20vMjAwOC8wNS9qc2R1bXAtcHJldHR5LWR1bXAtb2YtYW55LWphdmFzY3JpcHQuaHRtbH0KICovClFVbml0LmpzRHVtcCA9IChmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIHF1b3RlKCBzdHIgKSB7CgkJcmV0dXJuICciJyArIHN0ci50b1N0cmluZygpLnJlcGxhY2UoLyIvZywgJ1xcIicpICsgJyInOwoJfTsKCWZ1bmN0aW9uIGxpdGVyYWwoIG8gKSB7CgkJcmV0dXJuIG8gKyAnJzsKCX07CglmdW5jdGlvbiBqb2luKCBwcmUsIGFyciwgcG9zdCApIHsKCQl2YXIgcyA9IGpzRHVtcC5zZXBhcmF0b3IoKSwKCQkJYmFzZSA9IGpzRHVtcC5pbmRlbnQoKSwKCQkJaW5uZXIgPSBqc0R1bXAuaW5kZW50KDEpOwoJCWlmICggYXJyLmpvaW4gKQoJCQlhcnIgPSBhcnIuam9pbiggJywnICsgcyArIGlubmVyICk7CgkJaWYgKCAhYXJyICkKCQkJcmV0dXJuIHByZSArIHBvc3Q7CgkJcmV0dXJuIFsgcHJlLCBpbm5lciArIGFyciwgYmFzZSArIHBvc3QgXS5qb2luKHMpOwoJfTsKCWZ1bmN0aW9uIGFycmF5KCBhcnIgKSB7CgkJdmFyIGkgPSBhcnIubGVuZ3RoLAlyZXQgPSBBcnJheShpKTsKCQl0aGlzLnVwKCk7CgkJd2hpbGUgKCBpLS0gKQoJCQlyZXRbaV0gPSB0aGlzLnBhcnNlKCBhcnJbaV0gKTsKCQl0aGlzLmRvd24oKTsKCQlyZXR1cm4gam9pbiggJ1snLCByZXQsICddJyApOwoJfTsKCgl2YXIgcmVOYW1lID0gL15mdW5jdGlvbiAoXHcrKS87CgoJdmFyIGpzRHVtcCA9IHsKCQlwYXJzZTpmdW5jdGlvbiggb2JqLCB0eXBlICkgeyAvL3R5cGUgaXMgdXNlZCBtb3N0bHkgaW50ZXJuYWxseSwgeW91IGNhbiBmaXggYSAoY3VzdG9tKXR5cGUgaW4gYWR2YW5jZQoJCQl2YXIJcGFyc2VyID0gdGhpcy5wYXJzZXJzWyB0eXBlIHx8IHRoaXMudHlwZU9mKG9iaikgXTsKCQkJdHlwZSA9IHR5cGVvZiBwYXJzZXI7CgoJCQlyZXR1cm4gdHlwZSA9PSAnZnVuY3Rpb24nID8gcGFyc2VyLmNhbGwoIHRoaXMsIG9iaiApIDoKCQkJCSAgIHR5cGUgPT0gJ3N0cmluZycgPyBwYXJzZXIgOgoJCQkJICAgdGhpcy5wYXJzZXJzLmVycm9yOwoJCX0sCgkJdHlwZU9mOmZ1bmN0aW9uKCBvYmogKSB7CgkJCXZhciB0eXBlOwoJCQlpZiAoIG9iaiA9PT0gbnVsbCApIHsKCQkJCXR5cGUgPSAibnVsbCI7CgkJCX0gZWxzZSBpZiAodHlwZW9mIG9iaiA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXR5cGUgPSAidW5kZWZpbmVkIjsKCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiUmVnRXhwIiwgb2JqKSkgewoJCQkJdHlwZSA9ICJyZWdleHAiOwoJCQl9IGVsc2UgaWYgKFFVbml0LmlzKCJEYXRlIiwgb2JqKSkgewoJCQkJdHlwZSA9ICJkYXRlIjsKCQkJfSBlbHNlIGlmIChRVW5pdC5pcygiRnVuY3Rpb24iLCBvYmopKSB7CgkJCQl0eXBlID0gImZ1bmN0aW9uIjsKCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqLnNldEludGVydmFsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG9iai5kb2N1bWVudCAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mIG9iai5ub2RlVHlwZSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCXR5cGUgPSAid2luZG93IjsKCQkJfSBlbHNlIGlmIChvYmoubm9kZVR5cGUgPT09IDkpIHsKCQkJCXR5cGUgPSAiZG9jdW1lbnQiOwoJCQl9IGVsc2UgaWYgKG9iai5ub2RlVHlwZSkgewoJCQkJdHlwZSA9ICJub2RlIjsKCQkJfSBlbHNlIGlmICh0eXBlb2Ygb2JqID09PSAib2JqZWN0IiAmJiB0eXBlb2Ygb2JqLmxlbmd0aCA9PT0gIm51bWJlciIgJiYgb2JqLmxlbmd0aCA+PSAwKSB7CgkJCQl0eXBlID0gImFycmF5IjsKCQkJfSBlbHNlIHsKCQkJCXR5cGUgPSB0eXBlb2Ygb2JqOwoJCQl9CgkJCXJldHVybiB0eXBlOwoJCX0sCgkJc2VwYXJhdG9yOmZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5tdWx0aWxpbmUgPwl0aGlzLkhUTUwgPyAnPGJyIC8+JyA6ICdcbicgOiB0aGlzLkhUTUwgPyAnJm5ic3A7JyA6ICcgJzsKCQl9LAoJCWluZGVudDpmdW5jdGlvbiggZXh0cmEgKSB7Ly8gZXh0cmEgY2FuIGJlIGEgbnVtYmVyLCBzaG9ydGN1dCBmb3IgaW5jcmVhc2luZy1jYWxsaW5nLWRlY3JlYXNpbmcKCQkJaWYgKCAhdGhpcy5tdWx0aWxpbmUgKQoJCQkJcmV0dXJuICcnOwoJCQl2YXIgY2hyID0gdGhpcy5pbmRlbnRDaGFyOwoJCQlpZiAoIHRoaXMuSFRNTCApCgkJCQljaHIgPSBjaHIucmVwbGFjZSgvXHQvZywnICAgJykucmVwbGFjZSgvIC9nLCcmbmJzcDsnKTsKCQkJcmV0dXJuIEFycmF5KCB0aGlzLl9kZXB0aF8gKyAoZXh0cmF8fDApICkuam9pbihjaHIpOwoJCX0sCgkJdXA6ZnVuY3Rpb24oIGEgKSB7CgkJCXRoaXMuX2RlcHRoXyArPSBhIHx8IDE7CgkJfSwKCQlkb3duOmZ1bmN0aW9uKCBhICkgewoJCQl0aGlzLl9kZXB0aF8gLT0gYSB8fCAxOwoJCX0sCgkJc2V0UGFyc2VyOmZ1bmN0aW9uKCBuYW1lLCBwYXJzZXIgKSB7CgkJCXRoaXMucGFyc2Vyc1tuYW1lXSA9IHBhcnNlcjsKCQl9LAoJCS8vIFRoZSBuZXh0IDMgYXJlIGV4cG9zZWQgc28geW91IGNhbiB1c2UgdGhlbQoJCXF1b3RlOnF1b3RlLAoJCWxpdGVyYWw6bGl0ZXJhbCwKCQlqb2luOmpvaW4sCgkJLy8KCQlfZGVwdGhfOiAxLAoJCS8vIFRoaXMgaXMgdGhlIGxpc3Qgb2YgcGFyc2VycywgdG8gbW9kaWZ5IHRoZW0sIHVzZSBqc0R1bXAuc2V0UGFyc2VyCgkJcGFyc2Vyczp7CgkJCXdpbmRvdzogJ1tXaW5kb3ddJywKCQkJZG9jdW1lbnQ6ICdbRG9jdW1lbnRdJywKCQkJZXJyb3I6J1tFUlJPUl0nLCAvL3doZW4gbm8gcGFyc2VyIGlzIGZvdW5kLCBzaG91bGRuJ3QgaGFwcGVuCgkJCXVua25vd246ICdbVW5rbm93bl0nLAoJCQknbnVsbCc6J251bGwnLAoJCQl1bmRlZmluZWQ6J3VuZGVmaW5lZCcsCgkJCSdmdW5jdGlvbic6ZnVuY3Rpb24oIGZuICkgewoJCQkJdmFyIHJldCA9ICdmdW5jdGlvbicsCgkJCQkJbmFtZSA9ICduYW1lJyBpbiBmbiA/IGZuLm5hbWUgOiAocmVOYW1lLmV4ZWMoZm4pfHxbXSlbMV07Ly9mdW5jdGlvbnMgbmV2ZXIgaGF2ZSBuYW1lIGluIElFCgkJCQlpZiAoIG5hbWUgKQoJCQkJCXJldCArPSAnICcgKyBuYW1lOwoJCQkJcmV0ICs9ICcoJzsKCgkJCQlyZXQgPSBbIHJldCwgUVVuaXQuanNEdW1wLnBhcnNlKCBmbiwgJ2Z1bmN0aW9uQXJncycgKSwgJyl7J10uam9pbignJyk7CgkJCQlyZXR1cm4gam9pbiggcmV0LCBRVW5pdC5qc0R1bXAucGFyc2UoZm4sJ2Z1bmN0aW9uQ29kZScpLCAnfScgKTsKCQkJfSwKCQkJYXJyYXk6IGFycmF5LAoJCQlub2RlbGlzdDogYXJyYXksCgkJCWFyZ3VtZW50czogYXJyYXksCgkJCW9iamVjdDpmdW5jdGlvbiggbWFwICkgewoJCQkJdmFyIHJldCA9IFsgXTsKCQkJCVFVbml0LmpzRHVtcC51cCgpOwoJCQkJZm9yICggdmFyIGtleSBpbiBtYXAgKQoJCQkJCXJldC5wdXNoKCBRVW5pdC5qc0R1bXAucGFyc2Uoa2V5LCdrZXknKSArICc6ICcgKyBRVW5pdC5qc0R1bXAucGFyc2UobWFwW2tleV0pICk7CgkJCQlRVW5pdC5qc0R1bXAuZG93bigpOwoJCQkJcmV0dXJuIGpvaW4oICd7JywgcmV0LCAnfScgKTsKCQkJfSwKCQkJbm9kZTpmdW5jdGlvbiggbm9kZSApIHsKCQkJCXZhciBvcGVuID0gUVVuaXQuanNEdW1wLkhUTUwgPyAnJmx0OycgOiAnPCcsCgkJCQkJY2xvc2UgPSBRVW5pdC5qc0R1bXAuSFRNTCA/ICcmZ3Q7JyA6ICc+JzsKCgkJCQl2YXIgdGFnID0gbm9kZS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpLAoJCQkJCXJldCA9IG9wZW4gKyB0YWc7CgoJCQkJZm9yICggdmFyIGEgaW4gUVVuaXQuanNEdW1wLkRPTUF0dHJzICkgewoJCQkJCXZhciB2YWwgPSBub2RlW1FVbml0LmpzRHVtcC5ET01BdHRyc1thXV07CgkJCQkJaWYgKCB2YWwgKQoJCQkJCQlyZXQgKz0gJyAnICsgYSArICc9JyArIFFVbml0LmpzRHVtcC5wYXJzZSggdmFsLCAnYXR0cmlidXRlJyApOwoJCQkJfQoJCQkJcmV0dXJuIHJldCArIGNsb3NlICsgb3BlbiArICcvJyArIHRhZyArIGNsb3NlOwoJCQl9LAoJCQlmdW5jdGlvbkFyZ3M6ZnVuY3Rpb24oIGZuICkgey8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgYXJndW1lbnRzIHBhcnQgb2YgdGhlIGZ1bmN0aW9uCgkJCQl2YXIgbCA9IGZuLmxlbmd0aDsKCQkJCWlmICggIWwgKSByZXR1cm4gJyc7CgoJCQkJdmFyIGFyZ3MgPSBBcnJheShsKTsKCQkJCXdoaWxlICggbC0tICkKCQkJCQlhcmdzW2xdID0gU3RyaW5nLmZyb21DaGFyQ29kZSg5NytsKTsvLzk3IGlzICdhJwoJCQkJcmV0dXJuICcgJyArIGFyZ3Muam9pbignLCAnKSArICcgJzsKCQkJfSwKCQkJa2V5OnF1b3RlLCAvL29iamVjdCBjYWxscyBpdCBpbnRlcm5hbGx5LCB0aGUga2V5IHBhcnQgb2YgYW4gaXRlbSBpbiBhIG1hcAoJCQlmdW5jdGlvbkNvZGU6J1tjb2RlXScsIC8vZnVuY3Rpb24gY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyB0aGUgY29udGVudCBvZiB0aGUgZnVuY3Rpb24KCQkJYXR0cmlidXRlOnF1b3RlLCAvL25vZGUgY2FsbHMgaXQgaW50ZXJuYWxseSwgaXQncyBhbiBodG1sIGF0dHJpYnV0ZSB2YWx1ZQoJCQlzdHJpbmc6cXVvdGUsCgkJCWRhdGU6cXVvdGUsCgkJCXJlZ2V4cDpsaXRlcmFsLCAvL3JlZ2V4CgkJCW51bWJlcjpsaXRlcmFsLAoJCQknYm9vbGVhbic6bGl0ZXJhbAoJCX0sCgkJRE9NQXR0cnM6ey8vYXR0cmlidXRlcyB0byBkdW1wIGZyb20gbm9kZXMsIG5hbWU9PnJlYWxOYW1lCgkJCWlkOidpZCcsCgkJCW5hbWU6J25hbWUnLAoJCQknY2xhc3MnOidjbGFzc05hbWUnCgkJfSwKCQlIVE1MOmZhbHNlLC8vaWYgdHJ1ZSwgZW50aXRpZXMgYXJlIGVzY2FwZWQgKCA8LCA+LCBcdCwgc3BhY2UgYW5kIFxuICkKCQlpbmRlbnRDaGFyOicgICcsLy9pbmRlbnRhdGlvbiB1bml0CgkJbXVsdGlsaW5lOnRydWUgLy9pZiB0cnVlLCBpdGVtcyBpbiBhIGNvbGxlY3Rpb24sIGFyZSBzZXBhcmF0ZWQgYnkgYSBcbiwgZWxzZSBqdXN0IGEgc3BhY2UuCgl9OwoKCXJldHVybiBqc0R1bXA7Cn0pKCk7CgovLyBmcm9tIFNpenpsZS5qcwpmdW5jdGlvbiBnZXRUZXh0KCBlbGVtcyApIHsKCXZhciByZXQgPSAiIiwgZWxlbTsKCglmb3IgKCB2YXIgaSA9IDA7IGVsZW1zW2ldOyBpKysgKSB7CgkJZWxlbSA9IGVsZW1zW2ldOwoKCQkvLyBHZXQgdGhlIHRleHQgZnJvbSB0ZXh0IG5vZGVzIGFuZCBDREFUQSBub2RlcwoJCWlmICggZWxlbS5ub2RlVHlwZSA9PT0gMyB8fCBlbGVtLm5vZGVUeXBlID09PSA0ICkgewoJCQlyZXQgKz0gZWxlbS5ub2RlVmFsdWU7CgoJCS8vIFRyYXZlcnNlIGV2ZXJ5dGhpbmcgZWxzZSwgZXhjZXB0IGNvbW1lbnQgbm9kZXMKCQl9IGVsc2UgaWYgKCBlbGVtLm5vZGVUeXBlICE9PSA4ICkgewoJCQlyZXQgKz0gZ2V0VGV4dCggZWxlbS5jaGlsZE5vZGVzICk7CgkJfQoJfQoKCXJldHVybiByZXQ7Cn07CgovKgogKiBKYXZhc2NyaXB0IERpZmYgQWxnb3JpdGhtCiAqICBCeSBKb2huIFJlc2lnIChodHRwOi8vZWpvaG4ub3JnLykKICogIE1vZGlmaWVkIGJ5IENodSBBbGFuICJzcHJpdGUiCiAqCiAqIFJlbGVhc2VkIHVuZGVyIHRoZSBNSVQgbGljZW5zZS4KICoKICogTW9yZSBJbmZvOgogKiAgaHR0cDovL2Vqb2huLm9yZy9wcm9qZWN0cy9qYXZhc2NyaXB0LWRpZmYtYWxnb3JpdGhtLwogKgogKiBVc2FnZTogUVVuaXQuZGlmZihleHBlY3RlZCwgYWN0dWFsKQogKgogKiBRVW5pdC5kaWZmKCJ0aGUgcXVpY2sgYnJvd24gZm94IGp1bXBlZCBvdmVyIiwgInRoZSBxdWljayBmb3gganVtcHMgb3ZlciIpID09ICJ0aGUgIHF1aWNrIDxkZWw+YnJvd24gPC9kZWw+IGZveCA8ZGVsPmp1bXBlZCA8L2RlbD48aW5zPmp1bXBzIDwvaW5zPiBvdmVyIgogKi8KUVVuaXQuZGlmZiA9IChmdW5jdGlvbigpIHsKCWZ1bmN0aW9uIGRpZmYobywgbil7CgkJdmFyIG5zID0gbmV3IE9iamVjdCgpOwoJCXZhciBvcyA9IG5ldyBPYmplY3QoKTsKCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBuLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChuc1tuW2ldXSA9PSBudWxsKQoJCQkJbnNbbltpXV0gPSB7CgkJCQkJcm93czogbmV3IEFycmF5KCksCgkJCQkJbzogbnVsbAoJCQkJfTsKCQkJbnNbbltpXV0ucm93cy5wdXNoKGkpOwoJCX0KCgkJZm9yICh2YXIgaSA9IDA7IGkgPCBvLmxlbmd0aDsgaSsrKSB7CgkJCWlmIChvc1tvW2ldXSA9PSBudWxsKQoJCQkJb3Nbb1tpXV0gPSB7CgkJCQkJcm93czogbmV3IEFycmF5KCksCgkJCQkJbjogbnVsbAoJCQkJfTsKCQkJb3Nbb1tpXV0ucm93cy5wdXNoKGkpOwoJCX0KCgkJZm9yICh2YXIgaSBpbiBucykgewoJCQlpZiAobnNbaV0ucm93cy5sZW5ndGggPT0gMSAmJiB0eXBlb2Yob3NbaV0pICE9ICJ1bmRlZmluZWQiICYmIG9zW2ldLnJvd3MubGVuZ3RoID09IDEpIHsKCQkJCW5bbnNbaV0ucm93c1swXV0gPSB7CgkJCQkJdGV4dDogbltuc1tpXS5yb3dzWzBdXSwKCQkJCQlyb3c6IG9zW2ldLnJvd3NbMF0KCQkJCX07CgkJCQlvW29zW2ldLnJvd3NbMF1dID0gewoJCQkJCXRleHQ6IG9bb3NbaV0ucm93c1swXV0sCgkJCQkJcm93OiBuc1tpXS5yb3dzWzBdCgkJCQl9OwoJCQl9CgkJfQoKCQlmb3IgKHZhciBpID0gMDsgaSA8IG4ubGVuZ3RoIC0gMTsgaSsrKSB7CgkJCWlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgKyAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgKyAxIDwgby5sZW5ndGggJiYgb1tuW2ldLnJvdyArIDFdLnRleHQgPT0gbnVsbCAmJgoJCQluW2kgKyAxXSA9PSBvW25baV0ucm93ICsgMV0pIHsKCQkJCW5baSArIDFdID0gewoJCQkJCXRleHQ6IG5baSArIDFdLAoJCQkJCXJvdzogbltpXS5yb3cgKyAxCgkJCQl9OwoJCQkJb1tuW2ldLnJvdyArIDFdID0gewoJCQkJCXRleHQ6IG9bbltpXS5yb3cgKyAxXSwKCQkJCQlyb3c6IGkgKyAxCgkJCQl9OwoJCQl9CgkJfQoKCQlmb3IgKHZhciBpID0gbi5sZW5ndGggLSAxOyBpID4gMDsgaS0tKSB7CgkJCWlmIChuW2ldLnRleHQgIT0gbnVsbCAmJiBuW2kgLSAxXS50ZXh0ID09IG51bGwgJiYgbltpXS5yb3cgPiAwICYmIG9bbltpXS5yb3cgLSAxXS50ZXh0ID09IG51bGwgJiYKCQkJbltpIC0gMV0gPT0gb1tuW2ldLnJvdyAtIDFdKSB7CgkJCQluW2kgLSAxXSA9IHsKCQkJCQl0ZXh0OiBuW2kgLSAxXSwKCQkJCQlyb3c6IG5baV0ucm93IC0gMQoJCQkJfTsKCQkJCW9bbltpXS5yb3cgLSAxXSA9IHsKCQkJCQl0ZXh0OiBvW25baV0ucm93IC0gMV0sCgkJCQkJcm93OiBpIC0gMQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHsKCQkJbzogbywKCQkJbjogbgoJCX07Cgl9CgoJcmV0dXJuIGZ1bmN0aW9uKG8sIG4pewoJCW8gPSBvLnJlcGxhY2UoL1xzKyQvLCAnJyk7CgkJbiA9IG4ucmVwbGFjZSgvXHMrJC8sICcnKTsKCQl2YXIgb3V0ID0gZGlmZihvID09ICIiID8gW10gOiBvLnNwbGl0KC9ccysvKSwgbiA9PSAiIiA/IFtdIDogbi5zcGxpdCgvXHMrLykpOwoKCQl2YXIgc3RyID0gIiI7CgoJCXZhciBvU3BhY2UgPSBvLm1hdGNoKC9ccysvZyk7CgkJaWYgKG9TcGFjZSA9PSBudWxsKSB7CgkJCW9TcGFjZSA9IFsiICJdOwoJCX0KCQllbHNlIHsKCQkJb1NwYWNlLnB1c2goIiAiKTsKCQl9CgkJdmFyIG5TcGFjZSA9IG4ubWF0Y2goL1xzKy9nKTsKCQlpZiAoblNwYWNlID09IG51bGwpIHsKCQkJblNwYWNlID0gWyIgIl07CgkJfQoJCWVsc2UgewoJCQluU3BhY2UucHVzaCgiICIpOwoJCX0KCgkJaWYgKG91dC5uLmxlbmd0aCA9PSAwKSB7CgkJCWZvciAodmFyIGkgPSAwOyBpIDwgb3V0Lm8ubGVuZ3RoOyBpKyspIHsKCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9baV0gKyBvU3BhY2VbaV0gKyAiPC9kZWw+IjsKCQkJfQoJCX0KCQllbHNlIHsKCQkJaWYgKG91dC5uWzBdLnRleHQgPT0gbnVsbCkgewoJCQkJZm9yIChuID0gMDsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKykgewoJCQkJCXN0ciArPSAnPGRlbD4nICsgb3V0Lm9bbl0gKyBvU3BhY2Vbbl0gKyAiPC9kZWw+IjsKCQkJCX0KCQkJfQoKCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBvdXQubi5sZW5ndGg7IGkrKykgewoJCQkJaWYgKG91dC5uW2ldLnRleHQgPT0gbnVsbCkgewoJCQkJCXN0ciArPSAnPGlucz4nICsgb3V0Lm5baV0gKyBuU3BhY2VbaV0gKyAiPC9pbnM+IjsKCQkJCX0KCQkJCWVsc2UgewoJCQkJCXZhciBwcmUgPSAiIjsKCgkJCQkJZm9yIChuID0gb3V0Lm5baV0ucm93ICsgMTsgbiA8IG91dC5vLmxlbmd0aCAmJiBvdXQub1tuXS50ZXh0ID09IG51bGw7IG4rKykgewoJCQkJCQlwcmUgKz0gJzxkZWw+JyArIG91dC5vW25dICsgb1NwYWNlW25dICsgIjwvZGVsPiI7CgkJCQkJfQoJCQkJCXN0ciArPSAiICIgKyBvdXQubltpXS50ZXh0ICsgblNwYWNlW2ldICsgcHJlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gc3RyOwoJfTsKfSkoKTsKCn0pKHRoaXMpOw==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 05:03:22 GMT",
                    "Content-Length": "62809",
                    "Date": "Fri, 07 Nov 2014 05:03:35 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}