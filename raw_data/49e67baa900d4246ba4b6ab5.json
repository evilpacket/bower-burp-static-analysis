{
    "url": "http://localhost:9999/jumpbytehq/backbone-jqmobile/examples/lib/jquery.mobile-1.4.0/jquery.mobile-1.4.0.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Link manipulation (DOM-based)",
    "issueType": 5246976,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based link manipulation vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this to a navigation target within the current page, such as a clickable link or the submission URL of a form. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will modify the target of links within the response. An attacker may be able to leverage this to perform various attacks, including:<ul><li>Causing the user to redirect to an arbitrary external URL, to facilitate a phishing attack.</li><li>Causing the user to submit sensitive form data to a server controlled by the attacker.</li><li>Causing the user to perform an unintended action within the application, by changing the file or query string associated with a link.</li><li>Bypassing browser anti-XSS defenses by injecting on-site links containing XSS exploits, since browser anti-XSS defenses typically do not operate on on-site links.</li></ul>",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based link manipulation vulnerabilities is not to dynamically set the target URLs of links or forms using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a link target. In general, this is best achieved by using a whitelist of URLs that are permitted link targets, and strictly validating the target against this list before setting the link target.",
    "issueDetail": "The application may be vulnerable to DOM-based link manipulation. Data is read from <b>location.pathname</b> and written to <b>the 'href' property of a DOM element</b> via the following statement:<ul><li>base[ 0 ].href = href || location.pathname;</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/jumpbytehq/backbone-jqmobile/examples/lib/jquery.mobile-1.4.0/jquery.mobile-1.4.0.js",
                "path": "/jumpbytehq/backbone-jqmobile/examples/lib/jquery.mobile-1.4.0/jquery.mobile-1.4.0.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9qdW1wYnl0ZWhxL2JhY2tib25lLWpxbW9iaWxlL2V4YW1wbGVzL2xpYi9qcXVlcnkubW9iaWxlLTEuNC4wL2pxdWVyeS5tb2JpbGUtMS40LjAuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNDQzMjk2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBUaHUsIDA2IE5vdiAyMDE0IDExOjI3OjI2IEdNVA0KTGFzdC1Nb2RpZmllZDogVGh1LCAwNiBOb3YgMjAxNCAxMToyNzoyMiBHTVQNCg0KLyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMAoqIEdpdCBIRUFEIGhhc2g6IGYwOWFhZTBlMDM1ZDY4MDVlNDYxYTdiZTI0NmQwNGEwZGJjOThmNjkgPD4gRGF0ZTogVGh1IERlYyAxOSAyMDEzIDE3OjM0OjIyIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4wIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCXdpZGdldEVsZW1lbnRzID0ge30sCgkJCQlrZWVwTmF0aXZlID0gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCksCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQl0aGlzLmZpbmQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLm5vdCgga2VlcE5hdGl2ZSApCgkJCQkuanFtRW5oYW5jZWFibGUoKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJdmFyIGVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCgkJCQkJCS8vICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvciBpcyBkZXByZWNhdGVkIHRoaXMgaXMganVzdCBmb3IgYmFja2NvbXBhdAoJCQkJCQkvLyBTd2l0Y2ggdG8gJC5tb2JpbGUua2VlcE5hdGl2ZSBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCWVsZW1lbnRzID0gZWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJCQkJfQoKCQkJCQkvLyBFbmhhbmNlIHdoYXRldmVyIGlzIGxlZnQKCQkJCQlpZiAoIGVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdID0gZWxlbWVudHM7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCWZvciAoIGluZGV4IGluIHdpZGdldEVsZW1lbnRzICkgewoJCQkJd2lkZ2V0RWxlbWVudHNbIGluZGV4IF1bIGluZGV4IF0oKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiAoICEkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGVsZW0sICJkZWZhdWx0cyIgKSApIHsKCQkJZm9yICggb3B0aW9uIGluIHRoaXMub3B0aW9ucyApIHsKCQkJCXZhbHVlID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCBvcHRpb24ucmVwbGFjZSggcmNhcGl0YWxzLCByZXBsYWNlRnVuY3Rpb24gKSApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCm5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggKCAkLnN1cHBvcnQubWVkaWFxdWVyeSAmJiAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCApIHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA4ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLAoJCWR1bW15Rm5Ub0luaXROYXZpZ2F0ZSA9IGZ1bmN0aW9uKCkgewoJCX07CgoJJC5ldmVudC5zcGVjaWFsLmJlZm9yZW5hdmlnYXRlID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vbiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9mZiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfQoJfTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKSB7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggLyogZGF0YSwgbmFtZXNwYWNlcyAqLyApIHsKCQkJaWYgKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmICggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICkgewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYgKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmICggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmICggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYgKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiAoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmICggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiYmFjayIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiZm9yd2FyZCIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKSB7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGFzaCwgc3RhdGU7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApIHsKCQkJCQkJZW1pdHRlZCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKTsKCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgkJCQl9KTsKCQkJfSk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQgKS51bmJpbmQoIHRvdWNoTW92ZUV2ZW50ICkudW5iaW5kKCB0b3VjaFN0b3BFdmVudCApOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggc291cmNlRXZlbnQgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9LAoJCXd3LCB3aCwgbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKTsKCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCk7CgkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJLy8gVE9ETyB1c2UgX2dldEhpc3RvcnkKCQlfZ2V0QWN0aXZlSGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoIGhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9ICkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gVE9ETyBtb3ZlIHRvIF9oYW5kbGVEZXN0aW5hdGlvbiA/CgkJCS8vIElmIHRoaXMgaXNuJ3QgdGhlIGZpcnN0IHBhZ2UsIGlmIHRoZSBjdXJyZW50IHVybCBpcyBhIGRpYWxvZyBoYXNoCgkJCS8vIGtleSwgYW5kIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uIGlzbid0IGVxdWFsIHRvIHRoZSBjdXJyZW50IHRhcmdldAoJCQkvLyBwYWdlLCB1c2UgdGhlIHNwZWNpYWwgZGlhbG9nIGhhbmRsaW5nCgkJCWlmICggaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYKCQkJCXRvLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQloaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCXRvID0gdGhpcy5faGFuZGxlRGlhbG9nKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSApOwoKCQkJCWlmICggdG8gPT09IGZhbHNlICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fY2hhbmdlQ29udGVudCggdGhpcy5faGFuZGxlRGVzdGluYXRpb24oIHRvICksIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJfSwKCgkJX2NoYW5nZUNvbnRlbnQ6IGZ1bmN0aW9uKCB0bywgb3B0cyApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIG9wdHMgKTsKCQl9LAoKCQlfZ2V0QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5iYXNlOwoJCX0sCgoJCV9nZXROczogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uczsKCQl9LAoKCQlfZW5oYW5jZTogZnVuY3Rpb24oIGNvbnRlbnQsIHJvbGUgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjaywgYW5kIHBhc3NpbmcgaW4KCQkJLy8gdGhlIHNldHRpbmdzIHdoaWNoIGluY2x1ZGVzIHRoZSByb2xlCgkJCXJldHVybiBjb250ZW50LnBhZ2UoeyByb2xlOiByb2xlIH0pOwoJCX0sCgoJCV9pbmNsdWRlOiBmdW5jdGlvbiggcGFnZSwgc2V0dGluZ3MgKSB7CgkJCS8vIGFwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCXBhZ2UuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gdXNlIHRoZSBwYWdlIHdpZGdldCB0byBlbmhhbmNlCgkJCXRoaXMuX2VuaGFuY2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCS8vIHJlbW92ZSBwYWdlIG9uIGhpZGUKCQkJcGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCQl9LAoKCQlfZmluZDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrCgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICksCgkJCQlwYWdlLCBpbml0aWFsQ29udGVudCA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgoJCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzZXVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEKCQkJLy8gZGF0YS11cmwgYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgISQubW9iaWxlLnBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCIjIiArIGRhdGFVcmwpICkKCQkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgZGF0YVVybCApCgkJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJCX0KCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIGNoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMuCgkJCS8vIFdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgJiYKCQkJCWluaXRpYWxDb250ZW50ICYmCgkJCQlpbml0aWFsQ29udGVudC5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggaW5pdGlhbENvbnRlbnQgKTsKCQkJfQoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX2dldExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5sb2FkaW5nKCk7CgkJfSwKCgkJX3Nob3dMb2FkaW5nOiBmdW5jdGlvbiggZGVsYXksIHRoZW1lLCBtc2csIHRleHRvbmx5ICkgewoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZgoJCQkvLyBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJaWYgKCB0aGlzLl9sb2FkTXNnICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCQl0aGlzLl9sb2FkTXNnID0gMDsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgkJCXRoaXMuX2xvYWRNc2cgPSAwOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoIGZpbGVVcmwgKTsKCQkJCX0KCgkJCQljb250ZW50ID0gdGhpcy5fcGFyc2UoIGh0bWwsIGZpbGVVcmwgKTsKCgkJCQl0aGlzLl9zZXRMb2FkZWRUaXRsZSggY29udGVudCwgaHRtbCApOwoKCQkJCS8vIEFkZCB0aGUgY29udGVudCByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCgkJCQkvLyBERVBSRUNBVEVECgkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gY29udGVudDsKCgkJCQl0cmlnZ2VyRGF0YS5jb250ZW50ID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoICF0aGlzLl90cmlnZ2VyKCAibG9hZCIsIHVuZGVmaW5lZCwgdHJpZ2dlckRhdGEgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQkVHSU4gREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlbG9hZCIgKTsKCQkJCS8vIEVORCBERVBSRUNBVEVEIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8CgkJCQkkLm1vYmlsZS5wYXRoLmlzU2FtZURvbWFpbigkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIExvYWQgdGhlIG5ldyBjb250ZW50LgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogdGhpcy5fbG9hZFN1Y2Nlc3MoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApLAoJCQkJZXJyb3I6IHRoaXMuX2xvYWRFcnJvciggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkKCQkJfSk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7IG5leHRQYWdlOiB0bywgc2FtZVBhZ2U6IHNhbWVQYWdlIH0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsgcHJldlBhZ2U6IGZyb20gfHwgJCggIiIgKSB9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9ICggbmV3IFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0bywgZnJvbSApICkudHJhbnNpdGlvbigpOwoKCQkJLy8gVE9ETyB0ZW1wb3JhcnkgYWNjb21vZGF0aW9uIG9mIGFyZ3VtZW50IGRlZmVycmVkCgkJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUuYXBwbHkoIGRlZmVycmVkLCBhcmd1bWVudHMgKTsKCQkJfSk7CgoJCQlwcm9taXNlLmRvbmUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3JlbGVhc2VUcmFuc2l0aW9uTG9jazogZnVuY3Rpb24oKSB7CgkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJCX0KCQl9LAoKCQlfcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2UgKTsKCQl9LAoKCQlfbG9hZFVybDogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcwoJCQkvLyBmcm9tIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkKCQkJLy8gcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZQoJCQkvLyBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0bzsKCQkJc2V0dGluZ3MuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLmxvYWQoIHRvLCBzZXR0aW5ncyApOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIGNvbnRlbnQgKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCW9wdGlvbnMuYWJzVXJsID0gdHJpZ2dlckRhdGEuYWJzVXJsOwoKCQkJCXRoaXMudHJhbnNpdGlvbiggY29udGVudCwgdHJpZ2dlckRhdGEsIG9wdGlvbnMgKTsKCQkJfSwgdGhpcykpOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZmFpbCgkLnByb3h5KGZ1bmN0aW9uKC8qIHVybCwgb3B0aW9ucyAqLykgewoJCQkJdGhpcy5fcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2U6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICk7CgoJCQkkLmV4dGVuZCh0cmlnZ2VyRGF0YSwgeyB0b1BhZ2U6IHRvLCBvcHRpb25zOiBzZXR0aW5ncyB9KTsKCgkJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tCgkJCS8vIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUKCQkJLy8gYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlCgkJCS8vIFNlZSBpc3N1ZSAjNTA4NQoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHNldHRpbmdzLmFic1VybDsKCQkJfQoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgoJCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJCWlmICggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCQkJfQoKCQkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QKCQkJLy8gdXNlIHBhZ2VUaXRsZQoJCQluZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKSA/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwKCQkJCXRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vbmV3IHdheSB0byBoYW5kbGUgYWN0aXZlUGFnZQoJCQl0aGlzLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQlfZmluZEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXZhciBjbG9zZXN0QmFzZSA9ICggdGhpcy5hY3RpdmVQYWdlICYmCgkJCSQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCB0aGlzLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCX0KCX0pOwoKCS8vIFRoZSBmb2xsb3dpbmcgaGFuZGxlcnMgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvLyB0aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJLy90aGVzZSB2YXJpYWJsZXMgbWFrZSBhbGwgcGFnZSBjb250YWluZXJzIHVzZSB0aGUgc2FtZSBxdWV1ZSBhbmQgb25seSBuYXZpZ2F0ZSBvbmUgYXQgYSB0aW1lCgkvLyBxdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgl2YXIgcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvLyBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCXZhciBkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgoJCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJCX0sCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIGEgYnV0dG9uIHdhcyBjbGlja2VkLCBjbGVhbiB1cCB0aGUgYWN0aXZlIGNsYXNzIGFkZGVkIGJ5IHZjbGljayBhYm92ZQoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGlua1sgMCBdID09PSBldmVudC50YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQliYXNlVXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICk7CgoJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgISQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gVE9ETyByZW1vdmUgZGlyZWN0IHJlZmVyZW5jZXMgdG8gJC5tb2JpbGUgYW5kIHByb3BlcnRpZXMsIHdlIHNob3VsZAoJLy8gICAgICBmYXZvciBpbmplY3Rpb24gd2l0aCBwYXJhbXMgdG8gdGhlIGNvbnN0cnVjdG9yCgkkLm1vYmlsZS5UcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQl0b1ByZUNsYXNzOiAiIHVpLXBhZ2UtcHJlLWluIiwKCgkJaW5pdDogZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgkJCSQuZXh0ZW5kKHRoaXMsIHsKCQkJCW5hbWU6IG5hbWUsCgkJCQlyZXZlcnNlOiByZXZlcnNlLAoJCQkJJHRvOiAkdG8sCgkJCQkkZnJvbTogJGZyb20sCgkJCQlkZWZlcnJlZDogbmV3ICQuRGVmZXJyZWQoKQoJCQl9KTsKCQl9LAoKCQljbGVhbkZyb206IGZ1bmN0aW9uKCkgewoJCQl0aGlzLiRmcm9tCgkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApCgkJCQkuaGVpZ2h0KCAiIiApOwoJCX0sCgoJCS8vIE5PVEUgb3ZlcnJpZGRlbiBieSBjaGlsZCBvYmplY3QgcHJvdG90eXBlcywgbm9vcCdkIGhlcmUgYXMgZGVmYXVsdHMKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oKSB7fSwKCgkJZG9uZUluOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iZWZvcmVEb25lSW4oKTsKCgkJCXRoaXMuJHRvLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApLmhlaWdodCggIiIgKTsKCgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdGhpcy50b1Njcm9sbCApIHsKCQkJCXRoaXMuc2Nyb2xsUGFnZSgpOwoJCQl9CgkJCWlmICggIXRoaXMuc2VxdWVudGlhbCApIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLmRlZmVycmVkLnJlc29sdmUoIHRoaXMubmFtZSwgdGhpcy5yZXZlcnNlLCB0aGlzLiR0bywgdGhpcy4kZnJvbSwgdHJ1ZSApOwoJCX0sCgoJCWRvbmVPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmJlZm9yZURvbmVPdXQoKTsKCQkJdGhpcy5zdGFydEluKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICk7CgkJfSwKCgkJaGlkZUluOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJY2FsbGJhY2suY2FsbCggdGhpcyApOwoJCQl0aGlzLiR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQl9LAoKCQlzY3JvbGxQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoJCQkvL2lmIHdlIGFyZSBoaWRpbmcgdGhlIHVybCBiYXIgb3IgdGhlIHBhZ2Ugd2FzIHByZXZpb3VzbHkgc2Nyb2xsZWQgc2Nyb2xsIHRvIGhpZGUgb3IgcmV0dXJuIHRvIHBvc2l0aW9uCgkJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciB8fCB0aGlzLnRvU2Nyb2xsICE9PSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy50b1Njcm9sbCApOwoJCQl9CgoJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCXN0YXJ0SW46IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmhpZGVJbihmdW5jdGlvbigpIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0aGlzLnRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQlpZiAoICFwcmV2ZW50Rm9jdXMgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgcmV2ZXJzZUNsYXNzID0gdGhpcy5yZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgISQuc3VwcG9ydC5jc3NBbmltYXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwovLyBCYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gJC5tb2JpbGUuZGVncmFkZUlucHV0czsKCi8vIEF1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJdGFyZ2V0ID0gJCggdGFyZ2V0ICk7CgoJLy8gRGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5Cgl0YXJnZXQuZmluZCggImlucHV0IiApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IiwKCQkJaHRtbCwgaGFzVHlwZSwgZmluZHN0ciwgcmVwc3RyOwoKCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCBlbGVtZW50LmNsb25lKCkgKS5odG1sKCk7CgkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTE7CgkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi87CgkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJZWxlbWVudC5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUucGFnZSwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlkaWFsb2c6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmICggdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgkJCXRoaXMucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9zdXBlcigpOwoJCX0KCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiwgImJhY2siICkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCX0sCgoJLy8gY2xpY2sgYW5kIHN1Ym1pdCBldmVudHM6CgkvLyAtIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nCgkvLyAgIG9wZW5lZCB3aXRoIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJLy8gLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIgoJLy8gICBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CglfaGFuZGxlVkNsaWNrU3VibWl0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGF0dHJzLAoJCQkkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKTsKCgkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCQkJYXR0cnMgPSB7fTsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiBdID0KCQkJCSggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fSApWyAidHJhbnNpdGlvbiIgXSB8fAoJCQkJJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb247CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiBdID0gInJldmVyc2UiOwoJCQkkdGFyZ2V0LmF0dHIoIGF0dHJzICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcgYW5kIHdyYXAgaW50ZXJpb3IKCQllbGVtLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJLy8gQVJJQSByb2xlCgkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkoICEhb3B0cy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJfSkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfaXNDbG9zZWFibGU6IGZhbHNlLAoJCQlfaW5uZXI6IGVsZW0uY2hpbGRyZW4oKSwKCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJfSk7CgoJCXRoaXMuX29uKCBlbGVtLCB7CgkJCXZjbGljazogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlzdWJtaXQ6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQlwYWdlYmVmb3JlaGlkZTogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIG9wdHMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQkJdGhpcy5fb24oIGJ0biwgeyBjbGljazogImNsb3NlIiB9ICk7CgkJfQoKCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgl0aGVtZTogImluaGVyaXQiLAoJbWluaTogZmFsc2UKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXZpc2libGVzID0gJGVscy5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJaWYgKCB2aXNpYmxlcy5sZW5ndGggPT09IDAgKSB7CgkJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCX0KCQl9CgoJCXJldHVybiB2aXNpYmxlczsKCX0sCgoJX2FkZEZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzLCAkdmlzaWJsZXMsIGNyZWF0ZSApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCQkkdmlzaWJsZXMuZXEoIDAgKS5hZGRDbGFzcyggInVpLWZpcnN0LWNoaWxkIiApLmVuZCgpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxhc3QtY2hpbGQiICk7CgkJaWYgKCAhY3JlYXRlICkgewoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQl9Cgl9LAoKCV9yZW1vdmVGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscyApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgPSAiOm1vYmlsZS1jb2xsYXBzaWJsZSwgIiArICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvcjsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5leHRlbmQoIHsKCgkvLyBUaGUgaW5pdFNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgYXMgb2YgMS40LjAuIEluIDEuNS4wIHdlIHdpbGwgdXNlCgkvLyA6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIHdoaWNoIHdpbGwgYWxsb3cgdXMgdG8gZ2V0IHJpZCBvZiB0aGUgbGluZQoJLy8gYmVsb3cgYWx0b2dldGhlciwgYmVjYXVzZSB0aGUgYXV0b2luaXQgd2lsbCBnZW5lcmF0ZSBzdWNoIGFuIGluaXRTZWxlY3RvcgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSIsCgoJb3B0aW9uczogJC5leHRlbmQoIHsKCQllbmhhbmNlZDogZmFsc2UKCX0sICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICksCgoJX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgoJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOm1vYmlsZS1jb2xsYXBzaWJsZXNldCwgOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlOm5vdCgudWktY29sbGFwc2libGUtY29sbGFwc2VkKSIgKQoJCQkJLmNvbGxhcHNpYmxlKCAiY29sbGFwc2UiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NsYXNzZXM6ICIiCgkJfSk7CgoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdHMudGhlbWUgKSArICIgIiArCgkJCQkoIG9wdHMuY29ybmVycyAmJiBvcHRzLmluc2V0ID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLmNvbGxhcHNpYmxlKCk7CgkJfQoKCQl0aGlzLl9vbiggZWxlbSwgeyBjb2xsYXBzaWJsZWV4cGFuZDogIl9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZCIgfSApOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCXRoaXMuZWxlbWVudAoJCQkuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKQoJCQkuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApCgkJCS5jb2xsYXBzaWJsZSggImV4cGFuZCIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQsIGhhc0Nvcm5lcnMsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdGlvbnMudGhlbWUgKTsKCgkJaWYgKCB0aGVtZUNsYXNzICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGVtZUNsYXNzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmluc2V0ICYmICggb3B0aW9ucy5jb3JuZXJzIHx8IHRoaXMub3B0aW9ucy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5jb3JuZXJzICYmICggb3B0aW9ucy5pbnNldCB8fCB0aGlzLm9wdGlvbnMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCAicmVmcmVzaCIgKTsKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBlbC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApICk7CgkJZWwKCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtc2V0IHVpLWNvcm5lci1hbGwgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJLmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKQoJCQkuY29sbGFwc2libGUoICJkZXN0cm95IiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKTsKCgkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSgpOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gRGVwcmVjYXRlZCBpbiAxLjQKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbigvKiBvcHRpb25zICovKSB7CglyZXR1cm4gdGhpcy5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4iICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yLAoJCQlsZXR0ZXI7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJaWYgKCAhKCBhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoKCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSB8fAoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApICkgKSB7CgoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQlhY3RpdmVCdG4uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBnZXRBdHRyID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiBudWxsLCAvKiBEZXByZWNhdGVkIGluIDEuNCAqLwoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtciIsCgkJc3BsaXRJY29uOiAiY2FyYXQtciIsCgkJc3BsaXRUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzICk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5oYXNDbGFzcyggInVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgYnV0dG9uQ2xhc3MsIHBvcywgbnVtbGksIGl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLCBpdGVtSWNvbiwgaWNvbiwgYSwKCQkJaXNEaXZpZGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCB2YWx1ZSwgbGFzdCwgc3BsaXR0aGVtZSwgc3BsaXRUaGVtZUNsYXNzLCBzcGxpdGljb24sCgkJCWFsdEJ1dHRvbkNsYXNzLCBkaXZpZGVyVGhlbWUsIGxpLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJdGhpcy5fYmVmb3JlTGlzdHZpZXdSZWZyZXNoKCk7CgoJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKTsKCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoJCQkJCX0gZWxzZSBpZiAoIGljb24gKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tcmlnaHQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FmdGVyTGlzdHZpZXdSZWZyZXNoKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IoIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfQoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWF1dG9kaXZpZGVyczogZmFsc2UsCgkJYXV0b2RpdmlkZXJzU2VsZWN0b3I6IGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvcgoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJCXRoaXMuX3JlcGxhY2VEaXZpZGVycygpOwoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQl9Cgl9LAoKCV9yZXBsYWNlRGl2aWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpLCBsaXMsIGxpLCBkaXZpZGVyVGV4dCwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwKCQkJbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJZGl2aWRlcjsKCgkJbGlzdC5jaGlsZHJlbiggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCWxpcyA9IGxpc3QuY2hpbGRyZW4oICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZURpdmlkZXJzOiBmYWxzZQoJfSwKCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlRGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGlucHV0WzBdLmlkICkgKyAiJ10iICkKCQkJCQkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIGlucHV0dHlwZSArICItb2ZmIjsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuZWxlbWVudFswXS5kaXNhYmxlZCApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCW8uaWNvbnBvcyA9IGluaGVyaXRBdHRyKCBpbnB1dCwgImljb25wb3MiICkgfHwgbGFiZWwuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiICkgfHwgby5pY29ucG9zLAoKCQkvLyBFc3RhYmxpc2ggb3B0aW9ucwoJCW8ubWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICkgfHwgby5taW5pOwoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlpbnB1dDogaW5wdXQsCgkJCWxhYmVsOiBsYWJlbCwKCQkJcGFyZW50TGFiZWw6IHBhcmVudExhYmVsLAoJCQlpbnB1dHR5cGU6IGlucHV0dHlwZSwKCQkJY2hlY2tlZENsYXNzOiBjaGVja2VkQ2xhc3MsCgkJCXVuY2hlY2tlZENsYXNzOiB1bmNoZWNrZWRDbGFzcwoJCX0pOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCBsYWJlbCwgewoJCQl2bW91c2VvdmVyOiAiX2hhbmRsZUxhYmVsVk1vdXNlT3ZlciIsCgkJCXZjbGljazogIl9oYW5kbGVMYWJlbFZDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oIGlucHV0LCB7CgkJCXZtb3VzZWRvd246ICJfY2FjaGVWYWxzIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUlucHV0VkNsaWNrIiwKCQkJZm9jdXM6ICJfaGFuZGxlSW5wdXRGb2N1cyIsCgkJCWJsdXI6ICJfaGFuZGxlSW5wdXRCbHVyIgoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiAoIHRoaXMucGFyZW50TGFiZWwubGVuZ3RoID4gMCApIHsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkidGhlbWUiOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCSJpY29ucG9zIjogdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCSJtaW5pIjogdGhpcy5vcHRpb25zLm1pbmkKCQl9KTsKCgl9LAoKCV93cmFwcGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgICsKCQkJKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKwoJCQkiIHVpLSIgKyB0aGlzLmlucHV0dHlwZSArCgkJCSggdGhpcy5vcHRpb25zLmRpc2FibGVkID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCIgOiAiIiApICsgIicgPiIgKTsKCX0sCgoJX2hhbmRsZUlucHV0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0Qmx1cjogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfaGFuZGxlSW5wdXRWQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9IHRoaXMuZWxlbWVudDsKCgkJLy8gQWRkcyBjaGVja2VkIGF0dHJpYnV0ZSB0byBjaGVja2VkIGlucHV0IHdoZW4ga2V5Ym9hcmQgaXMgdXNlZAoJCWlmICggJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApIHsKCgkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgdHJ1ZSk7CgkJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCAkdGhpcyApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9IGVsc2UgewoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCX0sCgoJX2hhbmRsZUxhYmVsVk1vdXNlT3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5sYWJlbC5wYXJlbnQoKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQl9Cgl9LAoKCV9oYW5kbGVMYWJlbFZDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fY2FjaGVWYWxzKCk7CgoJCWlucHV0LnByb3AoICJjaGVja2VkIiwgdGhpcy5pbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkvLyBob3cgbGFiZWwgY2xpY2tzIGJlaGF2ZSBub3JtYWxseSBpbiB0aGUgYnJvd3NlcnMKCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCS8vICAgICAgIHdyYXBwZXIgZWxlbWVudCBsZXZlbAoJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAiY2xpY2siICk7CgoJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkvLyBidXR0b25zLCBidXQgd2lsbCBub3QgZm9yIGNoZWNrYm94ZXMuIGNsZWFyaW5nIHRoZSBjaGVja2VkIHN0YXR1cwoJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmF0dHIoImRhdGEtIiArICQubW9iaWxlLm5zICsgImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFsgMCBdLm5hbWUgKyAiJ11bdHlwZT0nIiArIHRoaXMuaW5wdXR0eXBlICsgIiddIiApOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgkvLyBJcyB0aGUgd2lkZ2V0IHN1cHBvc2VkIHRvIGRpc3BsYXkgYW4gaWNvbj8KCV9oYXNJY29uOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udHJvbGdyb3VwLCBjb250cm9sZ3JvdXBXaWRnZXQsCgkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yID0gJC5tb2JpbGUuY29udHJvbGdyb3VwOwoKCQkvLyBJZiB0aGUgY29udHJvbGdyb3VwIHdpZGdldCBpcyBkZWZpbmVkIC4uLgoJCWlmICggY29udHJvbGdyb3VwQ29uc3RydWN0b3IgKSB7CgkJCWNvbnRyb2xncm91cCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KAoJCQkJIjptb2JpbGUtY29udHJvbGdyb3VwLCIgKwoJCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciApOwoKCQkJLy8gLi4uIGFuZCB0aGUgY2hlY2tib3ggaXMgaW4gYSBjb250cm9sZ3JvdXAgLi4uCgkJCWlmICggY29udHJvbGdyb3VwLmxlbmd0aCA+IDAgKSB7CgoJCQkJLy8gLi4uIGxvb2sgZm9yIGEgY29udHJvbGdyb3VwIHdpZGdldCBpbnN0YW5jZSwgYW5kIC4uLgoJCQkJY29udHJvbGdyb3VwV2lkZ2V0ID0gJC5kYXRhKCBjb250cm9sZ3JvdXBbIDAgXSwgIm1vYmlsZS1jb250cm9sZ3JvdXAiICk7CgoJCQkJLy8gLi4uIGlmIGZvdW5kLCBkZWNpZGUgYmFzZWQgb24gdGhlIG9wdGlvbiB2YWx1ZSwgLi4uCgkJCQlyZXR1cm4gKCAoIGNvbnRyb2xncm91cFdpZGdldCA/IGNvbnRyb2xncm91cFdpZGdldC5vcHRpb25zLnR5cGUgOgoKCQkJCQkvLyAuLi4gb3RoZXJ3aXNlIGRlY2lkZSBiYXNlZCBvbiB0aGUgInR5cGUiIGRhdGEgYXR0cmlidXRlLgoJCQkJCWNvbnRyb2xncm91cC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIgKSApICE9PSAiaG9yaXpvbnRhbCIgKTsKCQkJfQoJCX0KCgkJLy8gTm9ybWFsbHksIHRoZSB3aWRnZXQgZGlzcGxheXMgYW4gaWNvbi4KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCksCgkJCWlzQ2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsCgkJCWFjdGl2ZSA9ICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQlpY29ucG9zQ2xhc3MgPSAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQlhZGRDbGFzc2VzID0gW10sCgkJCXJlbW92ZUNsYXNzZXMgPSBbXTsKCgkJaWYgKCBoYXNJY29uICkgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGFjdGl2ZSApOwoJCQlhZGRDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCX0gZWxzZSB7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggaWNvbnBvc0NsYXNzICk7CgkJCSggaXNDaGVja2VkID8gYWRkQ2xhc3NlcyA6IHJlbW92ZUNsYXNzZXMgKS5wdXNoKCBhY3RpdmUgKTsKCQl9CgoJCWlmICggaXNDaGVja2VkICkgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCX0gZWxzZSB7CgkJCWFkZENsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJfQoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgJiYgaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoICFoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpY29uQ2xhc3NlcyA9IHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKTsKCgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/ICIgIiArIG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggb3B0aW9ucy5pbmxpbmUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiIgKSArCgkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoIGljb25DbGFzc2VzID8gKCAiICIgKyBpY29uQ2xhc3NlcyApIDogIiIgKSArCgkJCSInID4iICsgdGhpcy5lbGVtZW50LnZhbCgpICsgIjwvZGl2PiIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfZ2V0SWNvbkNsYXNzZXM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXJldHVybiAoIG9wdGlvbnMuaWNvbiA/ICggInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArCgkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICsgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCSIgdWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApIDogIiIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkIHx8CgkJCQlvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCB8fCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJCW9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcyggdGhpcy5vcHRpb25zICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcygKCQkJCQkkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApICkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiAmJiB0aGlzLm9wdGlvbnMuaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXZhciBvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwiICsKCQkiaW5wdXRbdHlwZT0nc2VhcmNoJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCIgKwoJCSJpbnB1dFt0eXBlPSdudW1iZXInXSwiICsKCQkiOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIiArCgkJImlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIiArCgkJImlucHV0W3R5cGU9J2VtYWlsJ10sIiArCgkJImlucHV0W3R5cGU9J3VybCddLCIgKwoJCSJpbnB1dFt0eXBlPSd0ZWwnXSwiICsKCQkidGV4dGFyZWEsIiArCgkJImlucHV0W3R5cGU9J3RpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdtb250aCddLCIgKwoJCSJpbnB1dFt0eXBlPSd3ZWVrJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIiArCgkJImlucHV0W3R5cGU9J2NvbG9yJ10sIiArCgkJImlucHV0Om5vdChbdHlwZV0pLCIgKwoJCSJpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoKCQlpZiAoIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJY2xhc3NlczogdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCksCgkJCWlzU2VhcmNoOiBpc1NlYXJjaCwKCQkJaXNUZXh0YXJlYTogaXNUZXh0YXJlYSwKCQkJaXNSYW5nZTogaXNSYW5nZSwKCQkJaW5wdXROZWVkc1dyYXA6IGlucHV0TmVlZHNXcmFwCgkJfSk7CgoJCXRoaXMuX2F1dG9Db3JyZWN0KCk7CgoJCWlmICggIW9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB7CgkJCSJmb2N1cyI6ICJfaGFuZGxlRm9jdXMiLAoJCQkiYmx1ciI6ICJfaGFuZGxlQmx1ciIKCQl9KTsKCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0T3B0aW9ucyh7CgkJCSJkaXNhYmxlZCIgOiB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkKCQl9KTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50Q2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLWlucHV0LXRleHQiICk7CgkJfQoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSB8fCB0aGlzLmlzUmFuZ2UgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXAoKSApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnRDbGFzc2VzID0gZWxlbWVudENsYXNzZXMuY29uY2F0KCB0aGlzLmNsYXNzZXMgKTsKCQl9CgoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggZWxlbWVudENsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgPyB0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCV9jbGFzc2VzRnJvbU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQljbGFzc2VzID0gW107CgoJCWNsYXNzZXMucHVzaCggInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICkgKTsKCQlpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKSB7CgkJCWNsYXNzZXMucHVzaCggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCXJldHVybiBjbGFzc2VzOwoJfSwKCglfd3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICsKCQkJKCB0aGlzLmlzU2VhcmNoID8gInVpLWlucHV0LXNlYXJjaCAiIDogInVpLWlucHV0LXRleHQgIiApICsKCQkJdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICsgIiAiICsKCQkJInVpLXNoYWRvdy1pbnNldCc+PC9kaXY+IiApOwoJfSwKCglfYXV0b0NvcnJlY3Q6IGZ1bmN0aW9uKCkgewoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LgoJCS8vICAgICAgLSBqYmxhcwoJCWlmICggdHlwZW9mIHRoaXMuZWxlbWVudFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYKCQkJISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCX0KCX0sCgoJX2hhbmRsZUZvY3VzOiBmdW5jdGlvbigpIHsKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMKCQkvLyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoICEoIG9wdGlvbnMuZGlzYWJsZWQgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLm1pbmkgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLmNvcm5lcnMgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLnRoZW1lID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy53cmFwcGVyQ2xhc3MgPT09IHVuZGVmaW5lZCApICkgewoKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCQl0aGlzLmNsYXNzZXMgPSB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKTsKCQkJb3V0ZXIuYWRkQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFsgMCBdLCAidGhlbWUiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0aGVtZUNsYXNzID0gIHRoZW1lID8gIiB1aS1idG4tIiArIHRoZW1lIDogIiIsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sLAoJCQlweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wsIGlzSW5wdXQsIG9wdGlvbkVsZW1lbnRzLCBtaW4sIG1heCwgc3RlcCwKCQkJbmV3dmFsLCB2YWxNb2RTdGVwLCBhbGlnblZhbHVlLCBwZXJjZW50UGVyU3RlcCwKCQkJaGFuZGxlUGVyY2VudCwgYVBlcmNlbnQsIGJQZXJjZW50LAoJCQl2YWx1ZUNoYW5nZWQ7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiwgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLWJ0biIgKyB0aGVtZUNsYXNzICsgIiB1aS1zaGFkb3ciICk7CgoJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQ7CgkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoOwoJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwOwoJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDE7CgkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQluZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQl9CgkJfQoJfSwKCgkvLyBzaG93IHZhbHVlIG9uIHRoZSBoYW5kbGUgYW5kIGluIHBvcHVwCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsIG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICkgewoJCQkvLyByZW1vdmUgdGhlIHRpdGxlIGF0dHJpYnV0ZSBmcm9tIHRoZSBoYW5kbGUgKHdoaWNoIGlzCgkJCS8vIHJlc3BvbnNpYmxlIGZvciB0aGUgYW5ub3lpbmcgdG9vbHRpcCk7IE5CIHdlIGhhdmUKCQkJLy8gdG8gZG8gaXQgaGVyZSBhcyB0aGUganFtIHNsaWRlciBzZXRzIGl0IGV2ZXJ5IHRpbWUKCQkJLy8gdGhlIHNsaWRlcidzIHZhbHVlIGNoYW5nZXMgOigKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCX0KCgkJbmV3VmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggbmV3VmFsdWUgPT09IHRoaXMuX2N1cnJlbnRWYWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9jdXJyZW50VmFsdWUgPSBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cCApIHsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cC5odG1sKCBuZXdWYWx1ZSApOwoJCX0gZWxzZSBpZiAoIG8uc2hvd1ZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggbmV3VmFsdWUgKTsKCQl9Cgl9LAoKCV9zaG93UG9wdXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCAmJiAhdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCAiIiApOwoJCQl0aGlzLl9wb3B1cC5zaG93KCk7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gdHJ1ZTsKCQl9Cgl9LAoKCV9oaWRlUG9wdXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJaWYgKCBvLnNob3dWYWx1ZSAmJiAhby5taW5pICkgewoJCQkJdGhpcy5oYW5kbGUuaHRtbCggdGhpcy5fdmFsdWUoKSApOwoJCQl9CgkJCXRoaXMuX3BvcHVwLmhpZGUoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gZmFsc2U7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZmxpcHN3aXRjaCIsICQuZXh0ZW5kKHsKCglvcHRpb25zOiB7CgkJb25UZXh0OiAiT24iLAoJCW9mZlRleHQ6ICJPZmYiLAoJCXRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkJCSJkaXNhYmxlZCI6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9vbiggdGhpcy5mbGlwc3dpdGNoLCB7CgkJCQkiY2xpY2siOiAiX3RvZ2dsZSIsCgkJCQkic3dpcGVsZWZ0IjogIl9sZWZ0IiwKCQkJCSJzd2lwZXJpZ2h0IjogIl9yaWdodCIKCQkJfSk7CgoJCQl0aGlzLl9vbiggdGhpcy5vbiwgewoJCQkJImtleWRvd24iOiAiX2tleWRvd24iCgkJCX0pOwoKCQkJdGhpcy5fb24oIHsKCQkJCSJjaGFuZ2UiOiAicmVmcmVzaCIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX2xlZnQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAwOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfcmlnaHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAxOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZmxpcHN3aXRjaCA9ICQoICI8ZGl2PiIgKSwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJb24gPSAkKCAiPHNwYW4+PC9zcGFuPiIsIHsgdGFiaW5kZXg6IDEgfSApLAoJCQlvZmYgPSAkKCAiPHNwYW4+PC9zcGFuPiIgKSwKCQkJdHlwZSA9IGVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZSwKCQkJb25UZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPwoJCQkJb3B0aW9ucy5vblRleHQgOiBlbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDEgKS50ZXh0KCksCgkJCW9mZlRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9mZlRleHQgOiBlbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDAgKS50ZXh0KCk7CgoJCQlvbgoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vbiB1aS1idG4gdWktc2hhZG93IHVpLWJ0bi1pbmhlcml0IiApCgkJCQkudGV4dCggb25UZXh0ICk7CgkJCW9mZgoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vZmYiICkKCQkJCS50ZXh0KCBvZmZUZXh0ICk7CgoJCQlmbGlwc3dpdGNoCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoIHVpLXNoYWRvdy1pbnNldCAiICsKCQkJCQkidWktYmFyLSIgKyB0aGVtZSArICIgIiArCgkJCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/IG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArICIgIiArCgkJCQkJKCAoIGVsZW1lbnQuaXMoICI6Y2hlY2tlZCIgKSB8fAoJCQkJCQllbGVtZW50CgkJCQkJCQkuZmluZCggIm9wdGlvbiIgKQoJCQkJCQkJLmVxKCAxICkKCQkJCQkJCS5pcyggIjpzZWxlY3RlZCIgKSApID8gInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiA6ICIiICkgKwoJCQkJCSggZWxlbWVudC5pcygiOmRpc2FibGVkIikgPyAiIHVpLXN0YXRlLWRpc2FibGVkIjogIiIpICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCI6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIjogIiIgKSApCgkJCQkuYXBwZW5kKCBvbiwgb2ZmICk7CgoJCQllbGVtZW50CgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApCgkJCQkuYWZ0ZXIoIGZsaXBzd2l0Y2ggKQoJCQkJLmFwcGVuZFRvKCBmbGlwc3dpdGNoICk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWZsaXBzd2l0Y2g6IGZsaXBzd2l0Y2gsCgkJCW9uOiBvbiwKCQkJb2ZmOiBvZmYsCgkJCXR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiwKCQkJZXhpc3RpbmdEaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfcmlnaHQiIDogIl9sZWZ0IjsKCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfSBlbHNlIHsKCQkJZGlyZWN0aW9uID0gdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoKCQlpZiAoIGRpcmVjdGlvbiAhPT0gZXhpc3RpbmdEaXJlY3Rpb24gKSB7CgkJCXRoaXNbIGRpcmVjdGlvbiBdKCk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX2xlZnQiIDogIl9yaWdodCI7CgoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuTEVGVCApIHsKCQkJdGhpcy5fbGVmdCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuUklHSFQgKSB7CgkJCXRoaXMuX3JpZ2h0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApIHsKCQkJdGhpcy5fdG9nZ2xlKCk7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGN1cnJlbnRUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQkJbmV3VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IjsKCgkJCXRoaXMud2lkZ2V0KCkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWJhci0iICsgY3VycmVudFRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgbmV3VGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9uVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9uLnRleHQoIG9wdGlvbnMub25UZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5vZmZUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub2ZmLnRleHQoIG9wdGlvbnMub2ZmVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMub24ucmVtb3ZlKCk7CgkJdGhpcy5vZmYucmVtb3ZlKCk7CgkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmUoKTsKCQl0aGlzLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQuZXh0ZW5kKCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWNvcm5lcnM6IHRydWUsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJX2xhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyV2lkZ2V0Rmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRGaXJzdC5zbGlkZXIoKS5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICksCgkJCV9zbGlkZXJXaWRnZXRMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkgfHwKCQkJCSQuZGF0YSggX2lucHV0TGFzdC5zbGlkZXIoKS5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICksCgkJCV9zbGlkZXJGaXJzdCA9IF9zbGlkZXJXaWRnZXRGaXJzdC5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gX3NsaWRlcldpZGdldExhc3Quc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9IF9zbGlkZXJXaWRnZXRGaXJzdC5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9J3VpLXJhbmdlc2xpZGVyLXNsaWRlcnMnIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9sYWJlbC5pbnNlcnRCZWZvcmUoICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX2xhYmVsOiBfbGFiZWwsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250CgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCQl9CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggdGhpcy5faW5wdXRGaXJzdC5pcyggIjpkaXNhYmxlZCIgKSB8fCB0aGlzLl9pbnB1dExhc3QuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgoJCQkkZWwuZmluZCggImlucHV0IiApLnNsaWRlcih7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCXRyYWNrVGhlbWU6IG8udHJhY2tUaGVtZSwKCQkJCWRpc2FibGVkOiBvLmRpc2FibGVkLAoJCQkJY29ybmVyczogby5jb3JuZXJzLAoJCQkJbWluaTogby5taW5pLAoJCQkJaGlnaGxpZ2h0OiBvLmhpZ2hsaWdodAoJCQl9KS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQl9LAoKCQlfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggZXZlbnQudHlwZSA9PT0gImtleXVwIiApIHsKCQkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQltaW4gPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpLCAxMCApLAoJCQkJbWF4ID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRMYXN0LnZhbCgpLCAxMCApLAoJCQkJZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApLAoJCQkJdGhpc1NsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRGaXJzdCA6IHRoaXMuX2lucHV0TGFzdCwKCQkJCW90aGVyU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApIHsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYgKCBldmVudC50eXBlID09PSAibW91c2Vkb3duIiApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIG1pbiA+IG1heCAmJiAhdGhpcy5fc2xpZGVyVGFyZ2V0ICkgewoJCQkJLy90aGlzIHByZXZlbnRzIG1pbiBmcm9tIGJlaW5nIGdyZWF0ZXIgdGhlbiBtYXgKCQkJCXRoaXNTbGlkZXIudmFsKCBmaXJzdCA/IG1heDogbWluICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCXRoaXMuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCX0gZWxzZSBpZiAoIG1pbiA+IG1heCApIHsKCQkJCS8vdGhpcyBtYWtlcyBpdCBzbyBjbGlja3Mgb24gdGhlIHRhcmdldCBvbiBlaXRoZXIgZXh0cmVtZSBnbyB0byB0aGUgY2xvc2VzdCBoYW5kbGUKCQkJCXRoaXNTbGlkZXIudmFsKCB0aGlzLl90YXJnZXRWYWwgKS5zbGlkZXIoICJyZWZyZXNoIiApOwoKCQkJCS8vWW91IG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBzbyBmaXJzdCBzbGlkZXIgaXMgdXBkYXRlZCBiZWZvcmUgdXBkYXRpbmcgc2Vjb25kCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlvdGhlclNsaWRlci52YWwoIGZpcnN0ID8gbWluOiBtYXggKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMSApOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMCApOwoJCQl9IGVsc2UgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJfQoKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgoJCQlpZiAoIG1pbiA+PSBtYXggKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfdXBkYXRlSGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1pbiA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0cmFja1RoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0cmFja1RoZW1lIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJtaW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJtaW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsICEhdmFsdWUgKTsKCQl9LAoKCQlfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2xhYmVsLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICk7CgkJCXRoaXMuX2lucHV0Rmlyc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckZpcnN0ICk7CgkJCXRoaXMuX2lucHV0TGFzdC5hZnRlciggdGhpcy5fc2xpZGVyTGFzdCApOwoJCQl0aGlzLl9zbGlkZXJzLnJlbW92ZSgpOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QgdWktcmFuZ2VzbGlkZXItbGFzdCIgKS5zbGlkZXIoICJkZXN0cm95IiApOwoJCX0KCgl9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJY2xlYXJCdG46IGZhbHNlLAoJCQljbGVhckJ0blRleHQ6ICJDbGVhciB0ZXh0IgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCAhIXRoaXMub3B0aW9ucy5jbGVhckJ0biB8fCB0aGlzLmlzU2VhcmNoICkgewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJidG4gIT09IHVuZGVmaW5lZCAmJiAhdGhpcy5lbGVtZW50LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICkgKSB7CgkJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG4gKSB7CgkJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0blRleHQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9jbGVhckJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fY2xlYXJCdG4udGV4dCggb3B0aW9ucy5jbGVhckJ0blRleHQgKTsKCQkJfQoJCX0sCgoJCV90b2dnbGVDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2RlbGF5KCAiX3RvZ2dsZUNsZWFyQ2xhc3MiLCAwICk7CgkJfSwKCgkJX3RvZ2dsZUNsZWFyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9jbGVhckJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICF0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9LAoKCQlfZGVzdHJveUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl0aGlzLl91bmJpbmRDbGVhcigpLl9jbGVhckJ0bi5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCX0KCgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJYXV0b2dyb3c6dHJ1ZSwKCQkJa2V5dXBUaW1lb3V0QnVmZmVyOiAxMDAKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCX0KCQl9LAoKCQlfYXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RpbWVvdXQiLAoJCQkJImNoYW5nZSI6ICJfdGltZW91dCIsCgkJCQkiaW5wdXQiOiAiX3RpbWVvdXQiLAoJCQkJInBhc3RlIjogIl90aW1lb3V0IiwKCQkJfSk7CgoJCQkvLyBBdHRhY2ggdG8gdGhlIHZhcmlvdXMgeW91LWhhdmUtYmVjb21lLXZpc2libGUgbm90aWZpY2F0aW9ucyB0aGF0IHRoZQoJCQkvLyB2YXJpb3VzIGZyYW1ld29yayBlbGVtZW50cyBlbWl0LgoJCQkvLyBUT0RPOiBSZW1vdmUgYWxsIGJ1dCB0aGUgdXBkYXRlbGF5b3V0IGhhbmRsZXIgb25jZSAjNjQyNiBpcyBmaXhlZC4KCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZG9jdW1lbnQsIHsKCgkJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vbi1kZXByZWNhdGVkIGV2ZW50CgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVNob3ciLAoJCQkJInBvcHVwYmVmb3JlcG9zaXRpb24iOiAiX2hhbmRsZVNob3ciLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicGFuZWxvcGVuIjogIl9oYW5kbGVTaG93IgoJCQl9KTsKCQl9LAoKCQkvLyBTeW5jaHJvbm91c2x5IGZpeCB0aGUgd2lkZ2V0IGhlaWdodCBpZiB0aGlzIHdpZGdldCdzIHBhcmVudHMgYXJlIHN1Y2gKCQkvLyB0aGF0IHRoZXkgc2hvdy9oaWRlIGNvbnRlbnQgYXQgcnVudGltZS4gV2Ugc3RpbGwgbmVlZCB0byBjaGVjayB3aGV0aGVyCgkJLy8gdGhlIHdpZGdldCBpcyBhY3R1YWxseSB2aXNpYmxlIGluIGNhc2UgaXQgaXMgY29udGFpbmVkIGluc2lkZSBtdWx0aXBsZQoJCS8vIHN1Y2ggY29udGFpbmVycy4gRm9yIGV4YW1wbGU6IHBhbmVsIGNvbnRhaW5zIGNvbGxhcHNpYmxlIGNvbnRhaW5zCgkJLy8gYXV0b2dyb3cgdGV4dGlucHV0LiBUaGUgcGFuZWwgbWF5IGVtaXQgInBhbmVsb3BlbiIgaW5kaWNhdGluZyB0aGF0IGl0cwoJCS8vIGNvbnRlbnQgaGFzIGJlY29tZSB2aXNpYmxlLCBidXQgdGhlIGNvbGxhcHNpYmxlIGlzIHN0aWxsIGNvbGxhcHNlZCwgc28KCQkvLyB0aGUgYXV0b2dyb3cgdGV4dGFyZWEgaXMgc3RpbGwgbm90IHZpc2libGUuCgkJX2hhbmRsZVNob3c6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAkLmNvbnRhaW5zKCBldmVudC50YXJnZXQsIHRoaXMuZWxlbWVudFsgMCBdICkgJiYKCQkJCXRoaXMuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoKCQkJCWlmICggZXZlbnQudHlwZSAhPT0gInBvcHVwYmVmb3JlcG9zaXRpb24iICkgewoJCQkJCXRoaXMuZWxlbWVudAoJCQkJCQkuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApCgkJCQkJCS5vbmUoICJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQiLAoJCQkJCQkJJC5wcm94eSggZnVuY3Rpb24oKSB7CgkJCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93LXJlc2l6ZSIgKTsKCQkJCQkJCX0sIHRoaXMgKSApOwoJCQkJfQoJCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSgpOwoJCQl9CgkJfSwKCgkJX3VuYmluZEF1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLmVsZW1lbnQsICJrZXl1cCBjaGFuZ2UgaW5wdXQgcGFzdGUiICk7CgkJCXRoaXMuX29mZiggdGhpcy5kb2N1bWVudCwKCQkJCSJwYWdlc2hvdyBwb3B1cGJlZm9yZXBvc2l0aW9uIHVwZGF0ZWxheW91dCBwYW5lbG9wZW4iICk7CgkJfSwKCgkJa2V5dXBUaW1lb3V0OiBudWxsLAoKCQlfcHJlcGFyZUhlaWdodFVwZGF0ZTogZnVuY3Rpb24oIGRlbGF5ICkgewoJCQlpZiAoIHRoaXMua2V5dXBUaW1lb3V0ICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmtleXVwVGltZW91dCApOwoJCQl9CgkJCWlmICggZGVsYXkgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5rZXl1cFRpbWVvdXQgPSB0aGlzLl9kZWxheSggIl91cGRhdGVIZWlnaHQiLCBkZWxheSApOwoJCQl9CgkJfSwKCgkJX3RpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCB0aGlzLm9wdGlvbnMua2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJfSwKCgkJX3VwZGF0ZUhlaWdodDogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmtleXVwVGltZW91dCA9IDA7CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiAwLAoJCQkJIm1pbi1oZWlnaHQiOiAwLAoJCQkJIm1heC1oZWlnaHQiOiAwCgkJCX0pOwoKCQkJdmFyIHBhZGRpbmdUb3AsIHBhZGRpbmdCb3R0b20sIHBhZGRpbmdIZWlnaHQsCgkJCQlzY3JvbGxIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQljbGllbnRIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jbGllbnRIZWlnaHQsCgkJCQlib3JkZXJUb3AgPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQkJYm9yZGVyQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKSwKCQkJCWJvcmRlckhlaWdodCA9IGJvcmRlclRvcCArIGJvcmRlckJvdHRvbSwKCQkJCWhlaWdodCA9IHNjcm9sbEhlaWdodCArIGJvcmRlckhlaWdodCArIDE1OwoKCQkJLy8gSXNzdWUgNjE3OTogUGFkZGluZyBpcyBub3QgaW5jbHVkZWQgaW4gc2Nyb2xsSGVpZ2h0IGFuZAoJCQkvLyBjbGllbnRIZWlnaHQgYnkgRmlyZWZveCBpZiBubyBzY3JvbGxiYXIgaXMgdmlzaWJsZS4gQmVjYXVzZQoJCQkvLyB0ZXh0YXJlYXMgdXNlIHRoZSBib3JkZXItYm94IGJveC1zaXppbmcgbW9kZWwsIHBhZGRpbmcgc2hvdWxkIGJlCgkJCS8vIGluY2x1ZGVkIGluIHRoZSBuZXcgKGFzc2lnbmVkKSBoZWlnaHQuIEJlY2F1c2UgdGhlIGhlaWdodCBpcyBzZXQKCQkJLy8gdG8gMCwgY2xpZW50SGVpZ2h0ID09IDAgaW4gRmlyZWZveC4gVGhlcmVmb3JlLCB3ZSBjYW4gdXNlIHRoaXMgdG8KCQkJLy8gY2hlY2sgaWYgcGFkZGluZyBtdXN0IGJlIGFkZGVkLgoJCQlpZiAoIGNsaWVudEhlaWdodCA9PT0gMCApIHsKCQkJCXBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAicGFkZGluZy10b3AiICkgKTsKCQkJCXBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJCXBhZGRpbmdIZWlnaHQgPSBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbTsKCgkJCQloZWlnaHQgKz0gcGFkZGluZ0hlaWdodDsKCQkJfQoKCQkJdGhpcy5lbGVtZW50LmNzcyh7CgkJCQkiaGVpZ2h0IjogaGVpZ2h0LAoJCQkJIm1pbi1oZWlnaHQiOiAiIiwKCQkJCSJtYXgtaGVpZ2h0IjogIiIKCQkJfSk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyApIHsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoJCQkJc3Bhbi5odG1sKCAiJm5ic3A7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlbGVtZW50ID0gdGhpcywKCQkJCWlkcmVmID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoICJocmVmIiApLnN1YnN0cmluZyggMSApOwoKCQkJaWYgKCBpZHJlZiApIHsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCX0KCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgLSBDU1MgaXMgc29tZXRpbWVzIG5vdAoJLy8gZW5vdWdoIHRvIGFjY29tcGxpc2ggdGhpcy4KCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW4sCgkJCXBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICksCgkJCXNjcmVlbkhlaWdodCA9IHNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICkuaGVpZ2h0KCksCgoJCQkvLyBTdWJ0cmFjdGluZyAxIGhlcmUgaXMgbmVjZXNzYXJ5IGZvciBhbiBvYnNjdXJlIEFuZHJkb2lkIDQuMCBidWcgd2hlcmUKCQkJLy8gdGhlIGJyb3dzZXIgaGFuZ3MgaWYgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCA6LwoJCQlkb2N1bWVudEhlaWdodCA9IHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgLSAxOwoKCQlpZiAoIHNjcmVlbkhlaWdodCA8IGRvY3VtZW50SGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBkb2N1bWVudEhlaWdodCApOwoJCX0gZWxzZSBpZiAoIHBvcHVwSGVpZ2h0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKTsKCgkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQlpZiAoIHdpbmRvd0Nvb3JkaW5hdGVzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy55ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3kgKSB7CgkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQl9CgkJfQoKCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQl0aW1lb3V0SWQ6IHRoaXMuX2RlbGF5KCAiX3Jlc2l6ZVRpbWVvdXQiLCAyMDAgKSwKCQkJd2luZG93Q29vcmRpbmF0ZXM6IHdpbmRvd0Nvb3JkaW5hdGVzCgkJfTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICk7CgkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCX0KCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJfQoJfSwKCglfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IDA7Cgl9LAoKCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQl9CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSB0aGlzLl9kZWxheSggIl9zdG9wSWdub3JpbmdSZXNpemVFdmVudHMiLCAxMDAwICk7Cgl9LAoKCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCX0KCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXZhciB0YXJnZXQsCgkJCXRhcmdldEVsZW1lbnQgPSB0aGVFdmVudC50YXJnZXQsCgkJCXVpID0gdGhpcy5fdWk7CgoJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0YXJnZXRFbGVtZW50ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJdGFyZ2V0ID0gJCggdGFyZ2V0RWxlbWVudCApOwoJCQlpZiAoIDAgPT09IHRhcmdldC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuZG9jdW1lbnRbIDAgXS5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCQkJCXRhcmdldC5ibHVyKCk7CgkJCQl9KTsKCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQl1aS5mb2N1c0VsZW1lbnQgPSB0YXJnZXQ7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiAoIHByZWZpeCArIHZhbHVlICkgKSA6ICggcHJlZml4ICsgImluaGVyaXQiICkgKTsKCX0sCgoJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG5ld09wdGlvbnMgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW47CgoJCWlmICggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBuZXdPcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSApICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG5ld09wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG5ld09wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG5ld09wdGlvbnMudHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudG9sZXJhbmNlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRvbGVyYW5jZSggbmV3T3B0aW9ucy50b2xlcmFuY2UgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlciggbmV3T3B0aW9ucyApOwoJfSwKCglfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfSwKCQkJYXI7CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQljYXNlIDE6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJY2FzZSAyOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQljYXNlIDQ6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbGFtcFBvcHVwV2lkdGg6IGZ1bmN0aW9uKCBpbmZvT25seSApIHsKCQl2YXIgbWVudVNpemUsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXJlY3RhbmdsZSA9IHsKCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJeTogd2luZG93Q29vcmRpbmF0ZXMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJY3g6IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5kb3dDb29yZGluYXRlcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJfTsKCgkJaWYgKCAhaW5mb09ubHkgKSB7CgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJlY3RhbmdsZS5jeCApOwoJCX0KCgkJbWVudVNpemUgPSB7CgkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQl9OwoKCQlyZXR1cm4geyByYzogcmVjdGFuZ2xlLCBtZW51U2l6ZTogbWVudVNpemUgfTsKCX0sCgoJX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb246IGZ1bmN0aW9uKCBkZXNpcmVkLCBjbGFtcEluZm8gKSB7CgkJdmFyIHJldHVyblZhbHVlLAoJCQlyZWN0YW5nbGUgPSBjbGFtcEluZm8ucmMsCgkJCW1lbnVTaXplID0gY2xhbXBJbmZvLm1lbnVTaXplOwoKCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcwoJCS8vIHRvbyBsYXJnZS4KCQlyZXR1cm5WYWx1ZSA9IHsKCQkJbGVmdDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeCwgbWVudVNpemUuY3gsIHJlY3RhbmdsZS54LCBkZXNpcmVkLnggKSwKCQkJdG9wOiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN5LCBtZW51U2l6ZS5jeSwgcmVjdGFuZ2xlLnksIGRlc2lyZWQueSApCgkJfTsKCgkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCXJldHVyblZhbHVlLnRvcCA9IE1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKTsKCgkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJcmV0dXJuVmFsdWUudG9wIC09IE1hdGgubWluKCByZXR1cm5WYWx1ZS50b3AsCgkJCU1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKyBtZW51U2l6ZS5jeSAtIHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCXggPSBvcGVuT3B0aW9ucy54LAoJCQl5ID0gb3Blbk9wdGlvbnMueSwKCQkJcFRvID0gb3Blbk9wdGlvbnMucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQkJfSBlbHNlIHsKCQkJCXRyeSB7CgkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQl9IGNhdGNoKCBlcnIgKSB7CgkJCQkJZHN0ID0gbnVsbDsKCQkJCX0KCQkJCWlmICggZHN0ICkgewoJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQlpZiAoIGRzdCApIHsKCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQl9CgkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCW9wZW5PcHRpb25zID0gewoJCQl4OiBvcGVuT3B0aW9ucy54LAoJCQl5OiBvcGVuT3B0aW9ucy55LAoJCQlwb3NpdGlvblRvOiBvcGVuT3B0aW9ucy5wb3NpdGlvblRvCgkJfTsKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCB1bmRlZmluZWQsIG9wZW5PcHRpb25zICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcGVuT3B0aW9ucyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoJCX0KCX0sCgoJX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG9wZW5PcHRpb25zID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCWlmICggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG9wZW5PcHRpb25zLnRyYW5zaXRpb247CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvcGVuT3B0aW9ucy50cmFuc2l0aW9uICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtdHJ1bmNhdGUiICk7CgoJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCS8qIFRPRE86IFRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkIGFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluIHR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOiBodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogb3Blbk9wdGlvbnMudHJhbnNpdGlvbiwKCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyCgkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciA9IHRoaXMuX3VpLmNvbnRhaW5lciwKCQkJaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQl9CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQl0aGlzLl9zZXRPcHRpb25zKCB7IHRoZW1lOiAkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUub3B0aW9ucy50aGVtZSB9ICk7CgkJdGhpcy5lbGVtZW50CgkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkuZGV0YWNoKCkKCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS1pbmhlcml0IiApOwoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCXRoaXMuY2xvc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJCXZhciBwYXJzZWREc3QsIHRvVXJsLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaW1tZWRpYXRlID0gZmFsc2U7CgoJCWlmICggKCB0aGVFdmVudCAmJiB0aGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHx8ICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQlpZiAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfQoKCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJdGhpcy53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2luZG93CgkJCS5vbiggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY29udGFpbmVyOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeSwKCQkJc2VsZiA9IHRoaXMsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgfHwgY3VycmVudE9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiAoICEoIGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgKSApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQljdXJyZW50SXNEaWFsb2cgPSAoIGFjdGl2ZVBhZ2UgPyBhY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApIDogZmFsc2UgKTsKCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQlpZiAoIGhhc0hhc2ggKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApIHsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCX0gZWxzZSB7CgkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCX0KCgkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQl1cmwgKz0gaGFzaGtleTsKCQl9CgoJCS8vIHN3YWxsb3cgdGhlIHRoZSBpbml0aWFsIG5hdmlnYXRpb24gZXZlbnQsIGFuZCBiaW5kIGZvciB0aGUgbmV4dAoJCXRoaXMud2luZG93Lm9uZSggImJlZm9yZW5hdmlnYXRlIiwgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCX0pOwoKCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHsgcm9sZTogImRpYWxvZyIgfSApOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCi8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCXZhciBvZmZzZXQsCgkJcGF0aCA9ICQubW9iaWxlLnBhdGgsCgoJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoIGZyb20gdGhlIGhyZWYgYmVjYXVzZSBpZTcgKHdwNykKCQkvLyAgICAgIHJldHVybnMgdGhlIGFic29sdXRlIGhyZWYgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJcG9wdXAgPSAkKCBwYXRoLmhhc2hUb1NlbGVjdG9yKCBwYXRoLnBhcnNlVXJsKCAkbGluay5hdHRyKCAiaHJlZiIgKSApLmhhc2ggKSApLmZpcnN0KCk7CgoJaWYgKCBwb3B1cC5sZW5ndGggPiAwICYmIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCX0pOwoJfQoKCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCX0sIDMwMCApOwp9OwoKLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCiQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yID0gIi51aS1kaXNhYmxlZCwudWktc3RhdGUtZGlzYWJsZWQsLnVpLWxpLWRpdmlkZXIsLnVpLXNjcmVlbi1oaWRkZW4sOmpxbURhdGEocm9sZT0ncGxhY2Vob2xkZXInKSIsCglnb1RvQWRqYWNlbnRJdGVtID0gZnVuY3Rpb24oIGl0ZW0sIHRhcmdldCwgZGlyZWN0aW9uICkgewoJCXZhciBhZGphY2VudCA9IGl0ZW1bIGRpcmVjdGlvbiArICJBbGwiIF0oKQoJCQkubm90KCB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciApCgkJCS5maXJzdCgpOwoKCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCWlmICggYWRqYWNlbnQubGVuZ3RoICkgewoJCQl0YXJnZXQKCQkJCS5ibHVyKCkKCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQlhZGphY2VudC5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJfQoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS5zZWxlY3RtZW51LCB7CglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ3VzdG9tIHNlbGVjdHMgY2Fubm90IGV4aXN0IGluc2lkZSBwb3B1cHMsIHNvIHJldmVydCB0aGUgIm5hdGl2ZU1lbnUiCgkJLy8gb3B0aW9uIHRvIHRydWUgaWYgYSBwYXJlbnQgaXMgYSBwb3B1cAoJCW8ubmF0aXZlTWVudSA9IG8ubmF0aXZlTWVudSB8fCAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSw6bW9iaWxlLXBvcHVwIiApLmxlbmd0aCA+IDAgKTsKCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9oYW5kbGVTZWxlY3RGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmJsdXIoKTsKCQl0aGlzLmJ1dHRvbi5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX3N1cGVyKCBldmVudCApOwoJCXRoaXMuX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24oIGV2ZW50ICk7Cgl9LAoKCV9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJdGhpcy5fZGVjaWRlRm9ybWF0KCk7CgkJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLnBvcHVwSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5kaWFsb2dJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJfQoJCQl0aGlzLmlzT3BlbiA9IHRydWU7CgkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQl9Cgl9LAoKCV9oYW5kbGVMaXN0Rm9jdXM6IGZ1bmN0aW9uKCBlICkgewoJCXZhciBwYXJhbXMgPSAoIGUudHlwZSA9PT0gImZvY3VzaW4iICkgPwoJCQl7IHRhYmluZGV4OiAiMCIsIGV2ZW50OiAidm1vdXNlb3ZlciIgfToKCQkJeyB0YWJpbmRleDogIi0xIiwgZXZlbnQ6ICJ2bW91c2VvdXQiIH07CgoJCSQoIGUudGFyZ2V0ICkKCQkJLmF0dHIoICJ0YWJpbmRleCIsIHBhcmFtcy50YWJpbmRleCApCgkJCS50cmlnZ2VyKCBwYXJhbXMuZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUxpc3RLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICk7CgoJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQljYXNlIDM4OgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAicHJldiIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQljYXNlIDQwOgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAibmV4dCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJY2FzZSAxMzoKCQljYXNlIDMyOgoJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlTWVudVBhZ2VIaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCS8vCgkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJLy8KCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkvLwoJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCXRoaXMudGhpc1BhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7Cgl9LAoKCV9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsIHRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lQXR0ciwKCQkJZGl2aWRlclRoZW1lQXR0ciwgbWVudVBhZ2UsIGxpc3Rib3gsIGxpc3QsIGhlYWRlciwgaGVhZGVyVGl0bGUsIG1lbnVQYWdlQ29udGVudCwgbWVudVBhZ2VDbG9zZSwgaGVhZGVyQ2xvc2UsIHNlbGYsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCXNlbGVjdElkID0gdGhpcy5zZWxlY3RJZDsKCQlwb3B1cElkID0gc2VsZWN0SWQgKyAiLWxpc3Rib3giOwoJCWRpYWxvZ0lkID0gc2VsZWN0SWQgKyAiLWRpYWxvZyI7CgkJbGFiZWwgPSB0aGlzLmxhYmVsOwoJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQlpc011bHRpcGxlID0gdGhpcy5lbGVtZW50WyAwIF0ubXVsdGlwbGU7CgkJbWVudUlkID0gc2VsZWN0SWQgKyAiLW1lbnUiOwoJCXRoZW1lQXR0ciA9IG8udGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLnRoZW1lICsgIiciICkgOiAiIjsKCQlvdmVybGF5VGhlbWVBdHRyID0gby5vdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLm92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+IiApLmFwcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWhlYWRlciB1aS1iYXItIiArICggby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCIgKSArICInPiIgKS5wcmVwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXJUaXRsZSA9ICQoICI8aDEgY2xhc3M9J3VpLXRpdGxlJz4iICkuYXBwZW5kVG8oIGhlYWRlciApOwoKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCSJ0ZXh0Ijogby5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1idG4tbGVmdCB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi1kZWxldGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNlbGVjdElkOiBzZWxlY3RJZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSWQ6IHBvcHVwSWQsCgkJCWRpYWxvZ0lkOiBkaWFsb2dJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIgoJCX0pOwoKCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJdGhpcy5yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2UgdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCS8vIG5vbmUgcHJlc2VudC4KCQkJdGhpcy5fb3JpZ1RhYkluZGV4ID0gKCB0aGlzLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCXRoaXMuX29uKCB0aGlzLnNlbGVjdCwgeyBmb2N1cyA6ICJfaGFuZGxlU2VsZWN0Rm9jdXMiIH0gKTsKCgkJLy8gQnV0dG9uIGV2ZW50cwoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biIKCQl9KTsKCgkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJdGhpcy5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICk7CgkJdGhpcy5fb24oIHRoaXMubGlzdCwgewoJCQlmb2N1c2luIDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlmb2N1c291dCA6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJa2V5ZG93bjogIl9oYW5kbGVMaXN0S2V5ZG93biIKCQl9KTsKCQl0aGlzLmxpc3QKCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwudWktc3RhdGUtZGlzYWJsZWQsLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQluZXdJbmRleCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgIm9wdGlvbi1pbmRleCIgKSwKCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJJCggdGhpcyApLmZpbmQoICJhIiApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktY2hlY2tib3gtb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKCBpdGVtLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCQkJCWl0ZW0ubmV4dCgpLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJfQoKCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCX0sCgoJb3BlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5idXR0b24uY2xpY2soKTsKCX0sCgoJX2ZvY3VzTWVudUl0ZW06IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAiYS4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImxpOm5vdCgiICsgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKyAiKSBhLnVpLWJ0biIgKTsKCQl9CgkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpOwoJfSwKCglfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSR3aW5kb3cgPSB0aGlzLndpbmRvdywKCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCk7CgoJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQl9KTsKCQkJfQoKCQkJc2VsZi5tZW51UGFnZS5vbmUoIHsKCQkJCXBhZ2VzaG93OiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICksCgkJCQlwYWdlaGlkZTogJC5wcm94eSggdGhpcywgImNsb3NlIiApCgkJCX0pOwoKCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJc2VsZi5tZW51UGFnZS5maW5kKCAiZGl2IC51aS10aXRsZSIgKS50ZXh0KCBzZWxmLmxhYmVsLnRleHQoKSApOwoJCX0gZWxzZSB7CgkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQlzZWxmLmxpc3Rib3gub25lKCB7IHBvcHVwYWZ0ZXJvcGVuOiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICkgfSApOwoJCX0KCX0sCgoJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCWRhdGFJY29uID0gImZhbHNlIiwKCQkJJG9wdGlvbnMsIG51bU9wdGlvbnMsIHNlbGVjdCwKCQkJZGF0YVByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAib3B0aW9uLWluZGV4IiwKCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICJpY29uIiwKCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICJyb2xlIiwKCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAicGxhY2Vob2xkZXIiLAoJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJb3B0R3JvdXAsCgkJCWksCgkJCW9wdGlvbiwgJG9wdGlvbiwgcGFyZW50LCB0ZXh0LCBhbmNob3IsIGNsYXNzZXMsCgkJCW9wdExhYmVsLCBkaXZpZGVyLCBpdGVtOwoKCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoJCSRvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGg7CgkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXTsKCgkJZm9yICggaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQlvcHRpb24gPSAkb3B0aW9uc1tpXTsKCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApOwoKCQkJLy8gRG8gbm90IGNyZWF0ZSBvcHRpb25zIGJhc2VkIG9uIHVpLXNjcmVlbi1oaWRkZW4gc2VsZWN0IG9wdGlvbnMKCQkJaWYgKCAkb3B0aW9uLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZTsKCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpOwoJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCWNsYXNzZXMgPSBbXTsKCgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCW9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggImxhYmVsIiApOwoJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQl9CgkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCWNsYXNzZXMucHVzaCggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQl9CgkJCX0KCgkJCWl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsIGkgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQkJJCggYW5jaG9yICkuYWRkQ2xhc3MoICJ1aS1idG4gdWktY2hlY2tib3gtb2ZmIHVpLWJ0bi1pY29uLXJpZ2h0IiApOwoJCQl9CgoJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQl9CgoJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlci5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJfQoKCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ID8KCQkJdGhpcy5fc3VwZXIoKSA6CgkJCSQoICI8YT4iLCB7CgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCgkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJLy8gUmVtb3ZlIHRoZSBkaWFsb2cKCQkJdGhpcy5tZW51UGFnZS5yZW1vdmUoKTsKCQl9CgoJCS8vIENoYWluIHVwCgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKLy8gYnV0dG9uTWFya3VwIGlzIGRlcHJlY2F0ZWQgYXMgb2YgMS40LjAgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiAxLjUuMC4KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuLAoJCQkJYmFja0J0bjogbnVsbAoJCQl9KTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKS5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9zZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCQl9LAoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLmFkZEJhY2tCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmFkZEJhY2tCdG4gJiYKCQkJCQl0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCQl0aGlzLnBhZ2VbIDAgXS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCQkhdGhpcy5sZWZ0YnRuICkgewoJCQkJCQl0aGlzLl9hZGRCYWNrQnV0dG9uKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4iICkucmVtb3ZlKCk7CgkJCQl9CgkJCX0KCQkJaWYgKCBvLmJhY2tCdG5UaGVtZSAhPSBudWxsICkgewoJCQkJdGhpcy5lbGVtZW50CgkJCQkJLmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWJ0biB1aS1idG4tIiArIG8uYmFja0J0blRoZW1lICk7CgkJCX0KCQkJaWYgKCBvLmJhY2tCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIC51aS1idG4tdGV4dCIgKS50ZXh0KCBvLmJhY2tCdG5UZXh0ICk7CgkJCX0KCQkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQkJCW5ld1RoZW1lID0gby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCI7CgoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKS5hZGRDbGFzcyggInVpLWJhci0iICsgbmV3VGhlbWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG8gKTsKCQl9LAoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgKSB7CgkJCQl0aGlzLl9hZGRIZWFkZXJCdXR0b25DbGFzc2VzKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5wYWdlICkgewoJCQkJdGhpcy5fc2V0UmVsYXRpdmUoKTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgoJCS8vd2Ugb25seSB3YW50IHRoaXMgdG8gcnVuIG9uIG5vbiBmaXhlZCB0b29sYmFycyBzbyBtYWtlIGl0IGVhc3kgdG8gb3ZlcnJpZGUKCQlfc2V0UmVsYXRpdmU6IGZ1bmN0aW9uKCkgewoJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSddIiApLmNzcyh7ICJwb3NpdGlvbiI6ICJyZWxhdGl2ZSIgfSk7CgkJfSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGJ1dHRvbiBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgdWktYnRuLWxlZnQvcmlnaHQgY2xhc3NlcyBoYXZlIHRvIGJlIHByZXNlbnQgaW4gdGhlIG1hcmt1cC4KCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoZW1lLAoJCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggIXRoaXMuYmFja0J0biApIHsKCQkJCXRoZW1lID0gb3B0aW9ucy5iYWNrQnRuVGhlbWUgfHwgb3B0aW9ucy50aGVtZTsKCQkJCXRoaXMuYmFja0J0biA9ICQoICI8YSByb2xlPSdidXR0b24nIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnICIgKwoJCQkJCSJjbGFzcz0ndWktYnRuIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLWJ0bi1sZWZ0ICIgKwoJCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkJInVpLXRvb2xiYXItYmFjay1idG4gdWktaWNvbi1jYXJhdC1sIHVpLWJ0bi1pY29uLWxlZnQnICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWw9J2JhY2snPiIgKyBvcHRpb25zLmJhY2tCdG5UZXh0ICsgIjwvYT4iICkKCQkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9LAoJCV9hZGRIZWFkaW5nQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgkJb3B0aW9uczogewoJCQlwb3NpdGlvbjpudWxsLAoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLWZsaXBzd2l0Y2gsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1maXhlZCIgKTsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQl0aGlzLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWJhY2tncm91bmQnPjwvZGl2PiIgKwoJCQkiPC9kaXY+IiArCgkJIjwvZGl2PiIKCSksCgkvLyBOZWVkZWQgZm9yIHRyYW5zZm9ybWluZyBjb29yZGluYXRlcyBmcm9tIHNjcmVlbiB0byBhcnJvdyBiYWNrZ3JvdW5kCgl0eEZhY3RvciA9IE1hdGguc3FydCggMiApIC8gMjsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpLAoJCWJnID0gYXIuY2hpbGRyZW4oKTsKCglyZXR1cm4geyBhckVsczogY3QuYWRkKCBnZCApLCBnZDogZ2QsIGN0OiBjdCwgYXI6IGFyLCBiZzogYmcgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmJnLmFkZENsYXNzKCB0aGVtZSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgYmdPZmZzZXQsIGVsT2Zmc2V0LCBkaWZmLCBiZ1JlZiwKCQkJb3B0aW9uVmFsdWUgPSB0aGlzLm9wdGlvbnMuYXJyb3csCgkJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggIWFyICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCWFyLmFyRWxzLnNob3coKTsKCgkJYmdSZWYgPSB7fTsKCQlzdGF0ZSA9IHRoaXMuX2dldFBsYWNlbWVudFN0YXRlKCB0cnVlICk7CgkJcGFyYW1zID0gewoJCQkibCI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogIC1zdGF0ZS5hckhhbGYuY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0sCgkJCSJyIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN4ICsgc3RhdGUuY29udGVudEJveC5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJImIiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN5ICsgc3RhdGUuY29udGVudEJveC5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJInQiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAtc3RhdGUuYXJIYWxmLmN5LCBhcnJvd09mZnNldEZhY3RvcjogMCB9CgkJfTsKCgkJLy8gVHJ5IGVhY2ggc2lkZSBzcGVjaWZpZWQgaW4gdGhlIG9wdGlvbnMgdG8gc2VlIG9uIHdoaWNoIG9uZSB0aGUgYXJyb3cKCQkvLyBzaG91bGQgYmUgcGxhY2VkIHN1Y2ggdGhhdCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdGlwIG9mIHRoZSBhcnJvdyBhbmQKCQkvLyB0aGUgZGVzaXJlZCBjb29yZGluYXRlcyBpcyB0aGUgc2hvcnRlc3QuCgkJJC5lYWNoKCAoIG9wdGlvblZhbHVlID09PSB0cnVlID8gImwsdCxyLGIiIDogb3B0aW9uVmFsdWUgKS5zcGxpdCggIiwiICksCgkJCSQucHJveHkoIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJYmVzdCA9IHRoaXMuX3RyeUFuQXJyb3coIHBhcmFtc1sgdmFsdWUgXSwgdmFsdWUsIGRlc2lyZWQsIHN0YXRlLCBiZXN0ICk7CgkJCX0sIHRoaXMgKSApOwoKCQkvLyBDb3VsZCBub3QgcGxhY2UgdGhlIGFycm93IGFsb25nIGFueSBvZiB0aGUgZWRnZXMgLSBiZWhhdmUgYXMgaWYgc2hvd2luZwoJCS8vIHRoZSBhcnJvdyB3YXMgdHVybmVkIG9mZi4KCQlpZiAoICFiZXN0ICkgewoJCQlhci5hckVscy5oaWRlKCk7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJLy8gTW92ZSB0aGUgYXJyb3cgaW50byBwbGFjZQoJCWFyLmN0CgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFycm93LWwgdWktcG9wdXAtYXJyb3ctdCB1aS1wb3B1cC1hcnJvdy1yIHVpLXBvcHVwLWFycm93LWIiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtYXJyb3ctIiArIGJlc3QuZGlyICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5jc3MoIGJlc3QucG9zUHJvcCwgYmVzdC5wb3NWYWwgKQoJCQkuc2hvdygpOwoKCQkvLyBEbyBub3QgbW92ZS9zaXplIHRoZSBiYWNrZ3JvdW5kIGRpdiBvbiBJRSwgYmVjYXVzZSB3ZSB1c2UgdGhlIGFycm93IGRpdiBmb3IgYmFja2dyb3VuZCBhcyB3ZWxsLgoJCWlmICggIWllSGFjayApIHsKCQkJZWxPZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uZnN0IF0gPSBhci5jdC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5zbmQgXSA9IHsKCQkJCWxlZnQ6IGVsT2Zmc2V0LmxlZnQgKyBzdGF0ZS5jb250ZW50Qm94LngsCgkJCQl0b3A6IGVsT2Zmc2V0LnRvcCArIHN0YXRlLmNvbnRlbnRCb3gueQoJCQl9OwoJCQliZ09mZnNldCA9IGFyLmJnCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApCgkJCQkuY3NzKCAoICJjeCIgPT09IHBhcmFtc1sgYmVzdC5kaXIgXS5kaW1LZXkgPyAid2lkdGgiIDogImhlaWdodCIgKSwgc3RhdGUuY29udGVudEJveFsgcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSBdICkKCQkJCS5vZmZzZXQoKTsKCQkJZGlmZiA9IHsgZHg6IGJnUmVmLngubGVmdCAtIGJnT2Zmc2V0LmxlZnQsIGR5OiBiZ1JlZi55LnRvcCAtIGJnT2Zmc2V0LnRvcCB9OwoJCQlhci5iZy5jc3MoIHsgbGVmdDogdHhGYWN0b3IgKiBkaWZmLmR5ICsgdHhGYWN0b3IgKiBkaWZmLmR4LCB0b3A6IHR4RmFjdG9yICogZGlmZi5keSAtIHR4RmFjdG9yICogZGlmZi5keCB9ICk7CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQkJYXIuYmcucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFyZW50UGFnZTogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXJzOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiBlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IHRoaXMuX2dldFdyYXBwZXIsCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2dldFBhbmVsSW5uZXI6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fcGFyZW50UGFnZSA/IHRoaXMuX3BhcmVudFBhZ2UgOiAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoLnVpLWhlYWRlci1maXhlZCksIC51aS1jb250ZW50Om5vdCgudWktcG9wdXApLCAudWktZm9vdGVyOm5vdCgudWktZm9vdGVyLWZpeGVkKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyAiJz48L2Rpdj4iICkKCQkJCS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiB3cmFwcGVyOwoJfSwKCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWludEZpeGVkVG9vbGJhcnMgPSB0aGlzLl9wYWdlKCkuZmluZCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWZpeGVkVG9vbGJhcnMgPSBleHRGaXhlZFRvb2xiYXJzLmFkZCggaW50Rml4ZWRUb29sYmFycyApLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlRml4ZWRUb29sYmFyICk7CgoJCXJldHVybiBmaXhlZFRvb2xiYXJzOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQgKwoJCQkiICIgKyAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIgKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5kb2N1bWVudC5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5kb2N1bWVudC5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvdGhlclBhbmVscywKCQlvID0gdGhpcy5vcHRpb25zLAoJCW11bHRpcGxlUGFuZWxzID0gKCAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkubGVuZ3RoICsgJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKSA+IDE7CgoJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgoJCQkvLyAgcmVtb3ZlIHRoZSB3cmFwcGVyIGlmIG5vdCBpbiB1c2UgYnkgYW5vdGhlciBwYW5lbAoJCQlvdGhlclBhbmVscyA9ICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5hZGQoICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkgKTsKCQkJaWYgKCBvdGhlclBhbmVscy5ub3QoICIudWktcGFuZWwtZGlzcGxheS1vdmVybGF5IiApLm5vdCggdGhpcy5lbGVtZW50ICkubGVuZ3RoID09PSAwICkgewoJCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQl9CgoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUKCQkJCS8vIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiLCB0YWJsZS5maW5kKCAidHIiICkubm90KCB0cnMuZXEoIDAgKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWxlY3RvciApICk7CgoJCQkJY29sdW1uQ291bnQrKzsKCQkJfSk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJjb2x1bW50b2dnbGUiLAoJCWNvbHVtbkJ0blRoZW1lOiBudWxsLAoJCWNvbHVtblBvcHVwVGhlbWU6IG51bGwsCgkJY29sdW1uQnRuVGV4dDogIkNvbHVtbnMuLi4iLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKSApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQkJdGhpcy5fYWRkVG9nZ2xlcyggdGhpcy5fbWVudSwgdHJ1ZSApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggdGhpcy5fbWVudSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLl9lbmhhbmNlQ29sVG9nZ2xlKCk7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQl9CgoJCXRoaXMuX3NldHVwRXZlbnRzKCk7CgoJCXRoaXMuX3NldFRvZ2dsZVN0YXRlKCk7Cgl9LAoKCV9pZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSB8fCAoIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZCApICk7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJLy9OT1RFOiBpbnB1dHMgYXJlIGJvdW5kIGluIGJpbmRUb2dnbGVzLAoJCS8vIHNvIGl0IGNhbiBiZSBjYWxsZWQgb24gcmVmcmVzaCwgdG9vCgoJCS8vIHVwZGF0ZSBjb2x1bW4gdG9nZ2xlcyBvbiByZXNpemUKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICksCgkJCQljZWxscyA9IGhlYWRlci5hZGQoIGhlYWRlci5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJCWlmICggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkoIGtlZXAgPyBpbnB1dHMuZXEoIGNoZWNrYm94SW5kZXgrKyApIDoKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggY29udGFpbmVyICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSkgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJbWVudS5jb250cm9sZ3JvdXAoICJyZWZyZXNoIiApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlkID0gdGhpcy5faWQoKSArICItcG9wdXAiOwoJCW1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gIiArCgkJCSJ1aS1idG4tIiArICggb3B0cy5jb2x1bW5CdG5UaGVtZSB8fCAiYSIgKSArCgkJCSIgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgdWktbWluaScgIiArCgkJCSJkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQ+PC9maWVsZHNldD4iICkuY29udHJvbGdyb3VwKCk7CgoJCS8vIHNldCBleHRlbnNpb24gaGVyZSwgc2VuZCAiZmFsc2UiIHRvIHRyaWdnZXIgYnVpbGQvcmVidWlsZAoJCXRoaXMuX2FkZFRvZ2dsZXMoIG1lbnUsIGZhbHNlICk7CgoJCW1lbnUuYXBwZW5kVG8oIHBvcHVwICk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBwb3B1cFsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIG1lbnVCdXR0b25bIDAgXSApOwoJCXRhYmxlLmJlZm9yZSggZnJhZ21lbnQgKTsKCgkJcG9wdXAucG9wdXAoKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gInJlZmxvdyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCk7CgkJfQoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMuX3N1cGVyKCBjcmVhdGUgKTsKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl91cGRhdGVSZWZsb3coICk7CgkJfQoJfSwKCglfdXBkYXRlUmVmbG93OiBmdW5jdGlvbigpIHsKCQl2YXIgdGFibGUgPSB0aGlzLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCQkkKCB0YWJsZS5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQkJY29sc3RhcnQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJjb2xzdGFydCIgKSwKCQkJCWhpZXJhcmNoeUNsYXNzID0gY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQkJdGV4dCA9ICQoIHRoaXMgKS50ZXh0KCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIHRleHQgIT09ICIiICApIHsKCgkJCQkJaWYgKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApIHsKCQkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQkJfQoKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKSwgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgdGV4dCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscywgdGV4dCApOwoJCQkJCX0KCgkJCQl9CgkJfSk7Cgl9LAoKCV9hZGRMYWJlbHM6IGZ1bmN0aW9uKCBjZWxscywgbGFiZWwsIHRleHQgKSB7CgkJLy8gLm5vdCBmaXhlcyAjNjAwNgoJCWNlbGxzLm5vdCggIjpoYXMoYi4iICsgbGFiZWwgKyAiKSIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBsYWJlbCArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoJfSwKCgkvLyBUaGUgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBfcmVmcmVzaENoaWxkV2lkZ2V0IGF0dGVtcHRzIHRvIGNhbGwKCS8vIHJlZnJlc2ggb24gY29sbGFwc2libGVzZXQsIGNvbnRyb2xncm91cCwgc2VsZWN0bWVudSwgb3IgbGlzdHZpZXcKCV9yZWZyZXNoQ2hpbGRXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aWRnZXQsIGlkeCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldCA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0IF0gKSB7CgkJCQl3aWRnZXQgPSB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0ICk7CgkJCQlpZiAoIHdpZGdldCAmJiAkLmlzRnVuY3Rpb24oIHdpZGdldC5yZWZyZXNoICkgKSB7CgkJCQkJd2lkZ2V0LnJlZnJlc2goKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gVE9ETzogV2hlbiB0aGUgaW5wdXQgaXMgbm90IGludGVybmFsLCBkbyBub3QgZXZlbiBzdG9yZSBpdCBpbiB0aGlzLl9zZWFyY2gKCV9zZXRJbnB1dDogZnVuY3Rpb24gKCBzZWxlY3RvciApIHsKCQl2YXIgc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQkvLyBTdG9wIGEgcGVuZGluZyBmaWx0ZXIgb3BlcmF0aW9uCgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXRoaXMuX29mZiggc2VhcmNoLCAia2V5dXAgY2hhbmdlIGlucHV0IiApOwoJCQlzZWFyY2ggPSBudWxsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciApIHsKCQkJc2VhcmNoID0gc2VsZWN0b3IuanF1ZXJ5ID8gc2VsZWN0b3I6CgkJCQlzZWxlY3Rvci5ub2RlTmFtZSA/ICQoIHNlbGVjdG9yICk6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIHNlbGVjdG9yICk7CgoJCQl0aGlzLl9vbiggc2VhcmNoLCB7CgkJCQlrZXl1cDogIl9vbktleVVwIiwKCQkJCWNoYW5nZTogIl9vbktleVVwIiwKCQkJCWlucHV0OiAiX29uS2V5VXAiCgkJCX0pOwoJCX0KCgkJdGhpcy5fc2VhcmNoID0gc2VhcmNoOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJlZmlsdGVyID0gISggKCBvcHRpb25zLmZpbHRlclJldmVhbCA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5jaGlsZHJlbiA9PT0gdW5kZWZpbmVkICkgKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBvcHRpb25zLmlucHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldElucHV0KCBvcHRpb25zLmlucHV0ICk7CgkJCXJlZmlsdGVyID0gdHJ1ZTsKCQl9CgoJCWlmICggcmVmaWx0ZXIgKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlpdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCWl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIG9wdHMuZmlsdGVyUmV2ZWFsICk7CgkJfSBlbHNlIHsKCQkJaXRlbXMucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIENyZWF0ZSBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXBsYWNlIHRoZSBfc2V0T3B0aW9ucyBmdW5jdGlvbiBvZiBhIHdpZGdldCwKLy8gYW5kIHdpbGwgcGFzcyB0aGUgb3B0aW9ucyBvbiB0byB0aGUgaW5wdXQgb2YgdGhlIGZpbHRlcmFibGUuCnZhciByZXBsYWNlU2V0T3B0aW9ucyA9IGZ1bmN0aW9uKCBzZWxmLCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJb3JpZy5jYWxsKCB0aGlzLCBvcHRpb25zICk7CgkJCXNlbGYuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCBvcHRpb25zICk7CgkJfTsKCX0sCglyRGl2aWRlckxpc3RJdGVtID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoXHN8JCkvLAoJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjayA9ICQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2s7CgovLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBmaWx0ZXIgY2FsbGJhY2sgd2l0aCBvbmUgdGhhdCBkb2VzIG5vdCBoaWRlIGxpc3QgZGl2aWRlcnMKJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gIXRoaXMuY2xhc3NOYW1lLm1hdGNoKCByRGl2aWRlckxpc3RJdGVtICkgJiYKCQlvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrLmNhbGwoIHRoaXMsIGluZGV4LCBzZWFyY2hWYWx1ZSApOwp9OwoKJC53aWRnZXQoICJtb2JpbGUuZmlsdGVyYWJsZSIsICQubW9iaWxlLmZpbHRlcmFibGUsIHsKCW9wdGlvbnM6IHsKCQlmaWx0ZXJQbGFjZWhvbGRlcjogIkZpbHRlciBpdGVtcy4uLiIsCgkJZmlsdGVyVGhlbWU6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJCWlmICggdGhpcy5fd2lkZ2V0LndpZGdldE5hbWUgPT09ICJsaXN0dmlldyIgKSB7CgkJCQl0aGlzLl93aWRnZXQub3B0aW9ucy5oaWRlZGl2aWRlcnMgPSB0cnVlOwoJCQkJdGhpcy5fd2lkZ2V0LmVsZW1lbnQubGlzdHZpZXcoICJyZWZyZXNoIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgZmFkZjJiMzEyYTA1MDQwNDM2NDUxYzY0YmJmYWY0ODE0YmM2MmM1NgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmCgkJZGVjb2RlVVJJQ29tcG9uZW50KCBhbmNob3IuaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApID09PQoJCQlkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKTsKfQoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogImZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYiLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gdHJ1ZTsKCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCWlmICggISggL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIC9PUyBbMS01XV9bMC05X10qIGxpa2UgTWFjIE9TIFgvaS50ZXN0KCB1YSApICYmIHVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKSB7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXpvb20gPSAkLm1vYmlsZS56b29tOwoKCWZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKCQlpZiAoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKSB7CgkJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCQl6b29tLmRpc2FibGUoKTsKCQkJCX0KCQl9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQkJem9vbS5lbmFibGUoKTsKCQl9Cgl9CgoJJC5tb2JpbGUuZG9jdW1lbnQub24oICJtb2JpbGVpbml0IiwgZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgKSB7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoKCQkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCQkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZCBpZiBoaWRlVXJsQmFyIGlzIHRydWUgdGhpcyBpcyB0byB0cnkgYW5kIGRvIGl0IGFzIHNvb24gYXMgcG9zc2libGUKCQlpZiAoICQubW9iaWxlLmhpZGVVcmxCYXIgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoJCX0KCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgYXMgZmFsbCBiYWNrIGluY2FzZSB3ZSB3ZXJlIHRvbyBlYXJseSBiZWZvcmUKCQlpZiAoICQubW9iaWxlLmhpZGVVcmxCYXIgKSB7CgkJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7CgkJfQoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIHVpLWRpc2FibGVkIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXN0YXRlLWRpc2FibGVkLC51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCgp9KSk7Cg==",
                "body": "LyohCiogalF1ZXJ5IE1vYmlsZSAxLjQuMAoqIEdpdCBIRUFEIGhhc2g6IGYwOWFhZTBlMDM1ZDY4MDVlNDYxYTdiZTI0NmQwNGEwZGJjOThmNjkgPD4gRGF0ZTogVGh1IERlYyAxOSAyMDEzIDE3OjM0OjIyIFVUQwoqIGh0dHA6Ly9qcXVlcnltb2JpbGUuY29tCioKKiBDb3B5cmlnaHQgMjAxMCwgMjAxMyBqUXVlcnkgRm91bmRhdGlvbiwgSW5jLiBhbmQgb3RoZXIgY29udHJpYnV0b3JzCiogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgoqIGh0dHA6Ly9qcXVlcnkub3JnL2xpY2Vuc2UKKgoqLwoKCihmdW5jdGlvbiAoIHJvb3QsIGRvYywgZmFjdG9yeSApIHsKCWlmICggdHlwZW9mIGRlZmluZSA9PT0gImZ1bmN0aW9uIiAmJiBkZWZpbmUuYW1kICkgewoJCS8vIEFNRC4gUmVnaXN0ZXIgYXMgYW4gYW5vbnltb3VzIG1vZHVsZS4KCQlkZWZpbmUoIFsgImpxdWVyeSIgXSwgZnVuY3Rpb24gKCAkICkgewoJCQlmYWN0b3J5KCAkLCByb290LCBkb2MgKTsKCQkJcmV0dXJuICQubW9iaWxlOwoJCX0pOwoJfSBlbHNlIHsKCQkvLyBCcm93c2VyIGdsb2JhbHMKCQlmYWN0b3J5KCByb290LmpRdWVyeSwgcm9vdCwgZG9jICk7Cgl9Cn0oIHRoaXMsIGRvY3VtZW50LCBmdW5jdGlvbiAoIGpRdWVyeSwgd2luZG93LCBkb2N1bWVudCwgdW5kZWZpbmVkICkgewooZnVuY3Rpb24oICQgKSB7CgkkLm1vYmlsZSA9IHt9Owp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIFZlcnNpb24gb2YgdGhlIGpRdWVyeSBNb2JpbGUgRnJhbWV3b3JrCgkJdmVyc2lvbjogIjEuNC4wIiwKCgkJLy8gRGVwcmVjYXRlZCBhbmQgbm8gbG9uZ2VyIHVzZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkvLyBEZWZpbmUgdGhlIHVybCBwYXJhbWV0ZXIgdXNlZCBmb3IgcmVmZXJlbmNpbmcgd2lkZ2V0LWdlbmVyYXRlZCBzdWItcGFnZXMuCgkJLy8gVHJhbnNsYXRlcyB0byBleGFtcGxlLmh0bWwmdWktcGFnZT1zdWJwYWdlSWRlbnRpZmllcgoJCS8vIGhhc2ggc2VnbWVudCBiZWZvcmUgJnVpLXBhZ2U9IGlzIHVzZWQgdG8gbWFrZSBBamF4IHJlcXVlc3QKCQlzdWJQYWdlVXJsS2V5OiAidWktcGFnZSIsCgoJCWhpZGVVcmxCYXI6IHRydWUsCgoJCS8vIEtlZXBuYXRpdmUgU2VsZWN0b3IKCQlrZWVwTmF0aXZlOiAiOmpxbURhdGEocm9sZT0nbm9uZScpLCA6anFtRGF0YShyb2xlPSdub2pzJykiLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJLy8gQ2xhc3MgYXNzaWduZWQgdG8gcGFnZSBjdXJyZW50bHkgaW4gdmlldywgYW5kIGR1cmluZyB0cmFuc2l0aW9ucwoJCWFjdGl2ZVBhZ2VDbGFzczogInVpLXBhZ2UtYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJhY3RpdmUiIGJ1dHRvbiBzdGF0ZSwgZnJvbSBDU1MgZnJhbWV3b3JrCgkJYWN0aXZlQnRuQ2xhc3M6ICJ1aS1idG4tYWN0aXZlIiwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJCS8vIENsYXNzIHVzZWQgZm9yICJmb2N1cyIgZm9ybSBlbGVtZW50IHN0YXRlLCBmcm9tIENTUyBmcmFtZXdvcmsKCQlmb2N1c0NsYXNzOiAidWktZm9jdXMiLAoKCQkvLyBBdXRvbWF0aWNhbGx5IGhhbmRsZSBjbGlja3MgYW5kIGZvcm0gc3VibWlzc2lvbnMgdGhyb3VnaCBBamF4LCB3aGVuIHNhbWUtZG9tYWluCgkJYWpheEVuYWJsZWQ6IHRydWUsCgoJCS8vIEF1dG9tYXRpY2FsbHkgbG9hZCBhbmQgc2hvdyBwYWdlcyBiYXNlZCBvbiBsb2NhdGlvbi5oYXNoCgkJaGFzaExpc3RlbmluZ0VuYWJsZWQ6IHRydWUsCgoJCS8vIGRpc2FibGUgdG8gcHJldmVudCBqcXVlcnkgZnJvbSBib3RoZXJpbmcgd2l0aCBsaW5rcwoJCWxpbmtCaW5kaW5nRW5hYmxlZDogdHJ1ZSwKCgkJLy8gU2V0IGRlZmF1bHQgcGFnZSB0cmFuc2l0aW9uIC0gJ25vbmUnIGZvciBubyB0cmFuc2l0aW9ucwoJCWRlZmF1bHRQYWdlVHJhbnNpdGlvbjogImZhZGUiLAoKCQkvLyBTZXQgbWF4aW11bSB3aW5kb3cgd2lkdGggZm9yIHRyYW5zaXRpb25zIHRvIGFwcGx5IC0gJ2ZhbHNlJyBmb3Igbm8gbGltaXQKCQltYXhUcmFuc2l0aW9uV2lkdGg6IGZhbHNlLAoKCQkvLyBNaW5pbXVtIHNjcm9sbCBkaXN0YW5jZSB0aGF0IHdpbGwgYmUgcmVtZW1iZXJlZCB3aGVuIHJldHVybmluZyB0byBhIHBhZ2UKCQkvLyBEZXByZWNhdGVkIHJlbW92ZSBpbiAxLjUKCQltaW5TY3JvbGxCYWNrOiAwLAoKCQkvLyBTZXQgZGVmYXVsdCBkaWFsb2cgdHJhbnNpdGlvbiAtICdub25lJyBmb3Igbm8gdHJhbnNpdGlvbnMKCQlkZWZhdWx0RGlhbG9nVHJhbnNpdGlvbjogInBvcCIsCgoJCS8vIEVycm9yIHJlc3BvbnNlIG1lc3NhZ2UgLSBhcHBlYXJzIHdoZW4gYW4gQWpheCBwYWdlIHJlcXVlc3QgZmFpbHMKCQlwYWdlTG9hZEVycm9yTWVzc2FnZTogIkVycm9yIExvYWRpbmcgUGFnZSIsCgoJCS8vIEZvciBlcnJvciBtZXNzYWdlcywgd2hpY2ggdGhlbWUgZG9lcyB0aGUgYm94IHVzZXM/CgkJcGFnZUxvYWRFcnJvck1lc3NhZ2VUaGVtZTogImEiLAoKCQkvLyByZXBsYWNlIGNhbGxzIHRvIHdpbmRvdy5oaXN0b3J5LmJhY2sgd2l0aCBwaG9uZWdhcHMgbmF2aWdhdGlvbiBoZWxwZXIKCQkvLyB3aGVyZSBpdCBpcyBwcm92aWRlZCBvbiB0aGUgd2luZG93IG9iamVjdAoJCXBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQ6IGZhbHNlLAoKCQkvL2F1dG9tYXRpY2FsbHkgaW5pdGlhbGl6ZSB0aGUgRE9NIHdoZW4gaXQncyByZWFkeQoJCWF1dG9Jbml0aWFsaXplUGFnZTogdHJ1ZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJLy8gYWxsb3dzIHVzZXJzIHRvIG9wdCBpbiB0byBpZ25vcmluZyBjb250ZW50IGJ5IG1hcmtpbmcgYSBwYXJlbnQgZWxlbWVudCBhcwoJCS8vIGRhdGEtaWdub3JlZAoJCWlnbm9yZUNvbnRlbnRFbmFibGVkOiBmYWxzZSwKCgkJYnV0dG9uTWFya3VwOiB7CgkJCWhvdmVyRGVsYXk6IDIwMAoJCX0sCgoJCS8vIGRpc2FibGUgdGhlIGFsdGVyYXRpb24gb2YgdGhlIGR5bmFtaWMgYmFzZSB0YWcgb3IgbGlua3MgaW4gdGhlIGNhc2UKCQkvLyB0aGF0IGEgZHluYW1pYyBiYXNlIHRhZyBpc24ndCBzdXBwb3J0ZWQKCQlkeW5hbWljQmFzZUVuYWJsZWQ6IHRydWUsCgoJCS8vIGRlZmF1bHQgdGhlIHByb3BlcnR5IHRvIHJlbW92ZSBkZXBlbmRlbmN5IG9uIGFzc2lnbm1lbnQgaW4gaW5pdCBtb2R1bGUKCQlwYWdlQ29udGFpbmVyOiAkKCksCgoJCS8vZW5hYmxlIGNyb3NzLWRvbWFpbiBwYWdlIHN1cHBvcnQKCQlhbGxvd0Nyb3NzRG9tYWluUGFnZXM6IGZhbHNlLAoKCQlkaWFsb2dIYXNoS2V5OiAiJnVpLXN0YXRlPWRpYWxvZyIKCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyIG5zTm9ybWFsaXplRGljdCA9IHt9LAoJCW9sZEZpbmQgPSAkLmZpbmQsCgkJcmJyYWNlID0gLyg/Olx7W1xzXFNdKlx9fFxbW1xzXFNdKlxdKSQvLAoJCWpxbURhdGFSRSA9IC86anFtRGF0YVwoKFteKV0qKVwpL2c7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgoJCS8vIE5hbWVzcGFjZSB1c2VkIGZyYW1ld29yay13aWRlIGZvciBkYXRhLWF0dHJzLiBEZWZhdWx0IGlzIG5vIG5hbWVzcGFjZQoKCQluczogIiIsCgoJCS8vIFJldHJpZXZlIGFuIGF0dHJpYnV0ZSBmcm9tIGFuIGVsZW1lbnQgYW5kIHBlcmZvcm0gc29tZSBtYXNzYWdpbmcgb2YgdGhlIHZhbHVlCgoJCWdldEF0dHJpYnV0ZTogZnVuY3Rpb24oIGVsZW1lbnQsIGtleSApIHsKCQkJdmFyIGRhdGE7CgoJCQllbGVtZW50ID0gZWxlbWVudC5qcXVlcnkgPyBlbGVtZW50WzBdIDogZWxlbWVudDsKCgkJCWlmICggZWxlbWVudCAmJiBlbGVtZW50LmdldEF0dHJpYnV0ZSApIHsKCQkJCWRhdGEgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsga2V5ICk7CgkJCX0KCgkJCS8vIENvcGllZCBmcm9tIGNvcmUncyBzcmMvZGF0YS5qczpkYXRhQXR0cigpCgkJCS8vIENvbnZlcnQgZnJvbSBhIHN0cmluZyB0byBhIHByb3BlciBkYXRhIHR5cGUKCQkJdHJ5IHsKCQkJCWRhdGEgPSBkYXRhID09PSAidHJ1ZSIgPyB0cnVlIDoKCQkJCQlkYXRhID09PSAiZmFsc2UiID8gZmFsc2UgOgoJCQkJCWRhdGEgPT09ICJudWxsIiA/IG51bGwgOgoJCQkJCS8vIE9ubHkgY29udmVydCB0byBhIG51bWJlciBpZiBpdCBkb2Vzbid0IGNoYW5nZSB0aGUgc3RyaW5nCgkJCQkJK2RhdGEgKyAiIiA9PT0gZGF0YSA/ICtkYXRhIDoKCQkJCQlyYnJhY2UudGVzdCggZGF0YSApID8gSlNPTi5wYXJzZSggZGF0YSApIDoKCQkJCQlkYXRhOwoJCQl9IGNhdGNoKCBlcnIgKSB7fQoKCQkJcmV0dXJuIGRhdGE7CgkJfSwKCgkJLy8gRXhwb3NlIG91ciBjYWNoZSBmb3IgdGVzdGluZyBwdXJwb3Nlcy4KCQluc05vcm1hbGl6ZURpY3Q6IG5zTm9ybWFsaXplRGljdCwKCgkJLy8gVGFrZSBhIGRhdGEgYXR0cmlidXRlIHByb3BlcnR5LCBwcmVwZW5kIHRoZSBuYW1lc3BhY2UKCQkvLyBhbmQgdGhlbiBjYW1lbCBjYXNlIHRoZSBhdHRyaWJ1dGUgc3RyaW5nLiBBZGQgdGhlIHJlc3VsdAoJCS8vIHRvIG91ciBuc05vcm1hbGl6ZURpY3Qgc28gd2UgZG9uJ3QgaGF2ZSB0byBkbyB0aGlzIGFnYWluLgoJCW5zTm9ybWFsaXplOiBmdW5jdGlvbiggcHJvcCApIHsKCQkJcmV0dXJuIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdIHx8CgkJCQkoIG5zTm9ybWFsaXplRGljdFsgcHJvcCBdID0gJC5jYW1lbENhc2UoICQubW9iaWxlLm5zICsgcHJvcCApICk7CgkJfSwKCgkJLy8gRmluZCB0aGUgY2xvc2VzdCBqYXZhc2NyaXB0IHBhZ2UgZWxlbWVudCB0byBnYXRoZXIgc2V0dGluZ3MgZGF0YSBqc3BlcmYgdGVzdAoJCS8vIGh0dHA6Ly9qc3BlcmYuY29tL3NpbmdsZS1jb21wbGV4LXNlbGVjdG9yLXZzLW1hbnktY29tcGxleC1zZWxlY3RvcnMvZWRpdAoJCS8vIHBvc3NpYmx5IG5haXZlLCBidXQgaXQgc2hvd3MgdGhhdCB0aGUgcGFyc2luZyBvdmVyaGVhZCBmb3IgKmp1c3QqIHRoZSBwYWdlIHNlbGVjdG9yIHZzCgkJLy8gdGhlIHBhZ2UgYW5kIGRpYWxvZyBzZWxlY3RvciBpcyBuZWdsaWdhYmxlLiBUaGlzIGNvdWxkIHByb2JhYmx5IGJlIHNwZWVkIHVwIGJ5CgkJLy8gZG9pbmcgYSBzaW1pbGFyIHBhcmVudCBub2RlIHRyYXZlcnNhbCB0byB0aGUgb25lIGZvdW5kIGluIHRoZSBpbmhlcml0ZWQgdGhlbWUgY29kZSBhYm92ZQoJCWNsb3Nlc3RQYWdlRGF0YTogZnVuY3Rpb24oICR0YXJnZXQgKSB7CgkJCXJldHVybiAkdGFyZ2V0CgkJCQkuY2xvc2VzdCggIjpqcW1EYXRhKHJvbGU9J3BhZ2UnKSwgOmpxbURhdGEocm9sZT0nZGlhbG9nJykiICkKCQkJCS5kYXRhKCAibW9iaWxlLXBhZ2UiICk7CgkJfQoKCX0pOwoKCS8vIE1vYmlsZSB2ZXJzaW9uIG9mIGRhdGEgYW5kIHJlbW92ZURhdGEgYW5kIGhhc0RhdGEgbWV0aG9kcwoJLy8gZW5zdXJlcyBhbGwgZGF0YSBpcyBzZXQgYW5kIHJldHJpZXZlZCB1c2luZyBqUXVlcnkgTW9iaWxlJ3MgZGF0YSBuYW1lc3BhY2UKCSQuZm4uanFtRGF0YSA9IGZ1bmN0aW9uKCBwcm9wLCB2YWx1ZSApIHsKCQl2YXIgcmVzdWx0OwoJCWlmICggdHlwZW9mIHByb3AgIT09ICJ1bmRlZmluZWQiICkgewoJCQlpZiAoIHByb3AgKSB7CgkJCQlwcm9wID0gJC5tb2JpbGUubnNOb3JtYWxpemUoIHByb3AgKTsKCQkJfQoKCQkJLy8gdW5kZWZpbmVkIGlzIHBlcm1pdHRlZCBhcyBhbiBleHBsaWNpdCBpbnB1dCBmb3IgdGhlIHNlY29uZCBwYXJhbQoJCQkvLyBpbiB0aGlzIGNhc2UgaXQgcmV0dXJucyB0aGUgdmFsdWUgYW5kIGRvZXMgbm90IHNldCBpdCB0byB1bmRlZmluZWQKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoIDwgMiB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJcmVzdWx0ID0gdGhpcy5kYXRhKCBwcm9wICk7CgkJCX0gZWxzZSB7CgkJCQlyZXN1bHQgPSB0aGlzLmRhdGEoIHByb3AsIHZhbHVlICk7CgkJCX0KCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX07CgoJJC5qcW1EYXRhID0gZnVuY3Rpb24oIGVsZW0sIHByb3AsIHZhbHVlICkgewoJCXZhciByZXN1bHQ7CgkJaWYgKCB0eXBlb2YgcHJvcCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJCXJlc3VsdCA9ICQuZGF0YSggZWxlbSwgcHJvcCA/ICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgOiBwcm9wLCB2YWx1ZSApOwoJCX0KCQlyZXR1cm4gcmVzdWx0OwoJfTsKCgkkLmZuLmpxbVJlbW92ZURhdGEgPSBmdW5jdGlvbiggcHJvcCApIHsKCQlyZXR1cm4gdGhpcy5yZW1vdmVEYXRhKCAkLm1vYmlsZS5uc05vcm1hbGl6ZSggcHJvcCApICk7Cgl9OwoKCSQuanFtUmVtb3ZlRGF0YSA9IGZ1bmN0aW9uKCBlbGVtLCBwcm9wICkgewoJCXJldHVybiAkLnJlbW92ZURhdGEoIGVsZW0sICQubW9iaWxlLm5zTm9ybWFsaXplKCBwcm9wICkgKTsKCX07CgoJJC5maW5kID0gZnVuY3Rpb24oIHNlbGVjdG9yLCBjb250ZXh0LCByZXQsIGV4dHJhICkgewoJCWlmICggc2VsZWN0b3IuaW5kZXhPZiggIjpqcW1EYXRhIiApID4gLTEgKSB7CgkJCXNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgganFtRGF0YVJFLCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICIkMV0iICk7CgkJfQoKCQlyZXR1cm4gb2xkRmluZC5jYWxsKCB0aGlzLCBzZWxlY3RvciwgY29udGV4dCwgcmV0LCBleHRyYSApOwoJfTsKCgkkLmV4dGVuZCggJC5maW5kLCBvbGRGaW5kICk7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKiEKICogalF1ZXJ5IFVJIENvcmUgYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MAogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2NhdGVnb3J5L3VpLWNvcmUvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXJ1bmlxdWVJZCA9IC9edWktaWQtXGQrJC87CgovLyAkLnVpIG1pZ2h0IGV4aXN0IGZyb20gY29tcG9uZW50cyB3aXRoIG5vIGRlcGVuZGVuY2llcywgZS5nLiwgJC51aS5wb3NpdGlvbgokLnVpID0gJC51aSB8fCB7fTsKCiQuZXh0ZW5kKCAkLnVpLCB7Cgl2ZXJzaW9uOiAiYzBhYjcxMDU2YjkzNjYyN2U4YTc4MjFmMDNjMDQ0YWVjNjI4MGE0MCIsCgoJa2V5Q29kZTogewoJCUJBQ0tTUEFDRTogOCwKCQlDT01NQTogMTg4LAoJCURFTEVURTogNDYsCgkJRE9XTjogNDAsCgkJRU5EOiAzNSwKCQlFTlRFUjogMTMsCgkJRVNDQVBFOiAyNywKCQlIT01FOiAzNiwKCQlMRUZUOiAzNywKCQlQQUdFX0RPV046IDM0LAoJCVBBR0VfVVA6IDMzLAoJCVBFUklPRDogMTkwLAoJCVJJR0hUOiAzOSwKCQlTUEFDRTogMzIsCgkJVEFCOiA5LAoJCVVQOiAzOAoJfQp9KTsKCi8vIHBsdWdpbnMKJC5mbi5leHRlbmQoewoJZm9jdXM6IChmdW5jdGlvbiggb3JpZyApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGRlbGF5LCBmbiApIHsKCQkJcmV0dXJuIHR5cGVvZiBkZWxheSA9PT0gIm51bWJlciIgPwoJCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJCXZhciBlbGVtID0gdGhpczsKCQkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCQkkKCBlbGVtICkuZm9jdXMoKTsKCQkJCQkJaWYgKCBmbiApIHsKCQkJCQkJCWZuLmNhbGwoIGVsZW0gKTsKCQkJCQkJfQoJCQkJCX0sIGRlbGF5ICk7CgkJCQl9KSA6CgkJCQlvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl9OwoJfSkoICQuZm4uZm9jdXMgKSwKCglzY3JvbGxQYXJlbnQ6IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JvbGxQYXJlbnQ7CgkJaWYgKCgkLnVpLmllICYmICgvKHN0YXRpY3xyZWxhdGl2ZSkvKS50ZXN0KHRoaXMuY3NzKCJwb3NpdGlvbiIpKSkgfHwgKC9hYnNvbHV0ZS8pLnRlc3QodGhpcy5jc3MoInBvc2l0aW9uIikpKSB7CgkJCXNjcm9sbFBhcmVudCA9IHRoaXMucGFyZW50cygpLmZpbHRlcihmdW5jdGlvbigpIHsKCQkJCXJldHVybiAoLyhyZWxhdGl2ZXxhYnNvbHV0ZXxmaXhlZCkvKS50ZXN0KCQuY3NzKHRoaXMsInBvc2l0aW9uIikpICYmICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfSBlbHNlIHsKCQkJc2Nyb2xsUGFyZW50ID0gdGhpcy5wYXJlbnRzKCkuZmlsdGVyKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICgvKGF1dG98c2Nyb2xsKS8pLnRlc3QoJC5jc3ModGhpcywib3ZlcmZsb3ciKSskLmNzcyh0aGlzLCJvdmVyZmxvdy15IikrJC5jc3ModGhpcywib3ZlcmZsb3cteCIpKTsKCQkJfSkuZXEoMCk7CgkJfQoKCQlyZXR1cm4gKCAvZml4ZWQvICkudGVzdCggdGhpcy5jc3MoICJwb3NpdGlvbiIpICkgfHwgIXNjcm9sbFBhcmVudC5sZW5ndGggPyAkKCB0aGlzWyAwIF0ub3duZXJEb2N1bWVudCB8fCBkb2N1bWVudCApIDogc2Nyb2xsUGFyZW50OwoJfSwKCgl1bmlxdWVJZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5pZCApIHsKCQkJCXRoaXMuaWQgPSAidWktaWQtIiArICgrK3V1aWQpOwoJCQl9CgkJfSk7Cgl9LAoKCXJlbW92ZVVuaXF1ZUlkOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoIHJ1bmlxdWVJZC50ZXN0KCB0aGlzLmlkICkgKSB7CgkJCQkkKCB0aGlzICkucmVtb3ZlQXR0ciggImlkIiApOwoJCQl9CgkJfSk7Cgl9Cn0pOwoKLy8gc2VsZWN0b3JzCmZ1bmN0aW9uIGZvY3VzYWJsZSggZWxlbWVudCwgaXNUYWJJbmRleE5vdE5hTiApIHsKCXZhciBtYXAsIG1hcE5hbWUsIGltZywKCQlub2RlTmFtZSA9IGVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCWlmICggImFyZWEiID09PSBub2RlTmFtZSApIHsKCQltYXAgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJbWFwTmFtZSA9IG1hcC5uYW1lOwoJCWlmICggIWVsZW1lbnQuaHJlZiB8fCAhbWFwTmFtZSB8fCBtYXAubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gIm1hcCIgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaW1nID0gJCggImltZ1t1c2VtYXA9IyIgKyBtYXBOYW1lICsgIl0iIClbMF07CgkJcmV0dXJuICEhaW1nICYmIHZpc2libGUoIGltZyApOwoJfQoJcmV0dXJuICggL2lucHV0fHNlbGVjdHx0ZXh0YXJlYXxidXR0b258b2JqZWN0Ly50ZXN0KCBub2RlTmFtZSApID8KCQkhZWxlbWVudC5kaXNhYmxlZCA6CgkJImEiID09PSBub2RlTmFtZSA/CgkJCWVsZW1lbnQuaHJlZiB8fCBpc1RhYkluZGV4Tm90TmFOIDoKCQkJaXNUYWJJbmRleE5vdE5hTikgJiYKCQkvLyB0aGUgZWxlbWVudCBhbmQgYWxsIG9mIGl0cyBhbmNlc3RvcnMgbXVzdCBiZSB2aXNpYmxlCgkJdmlzaWJsZSggZWxlbWVudCApOwp9CgpmdW5jdGlvbiB2aXNpYmxlKCBlbGVtZW50ICkgewoJcmV0dXJuICQuZXhwci5maWx0ZXJzLnZpc2libGUoIGVsZW1lbnQgKSAmJgoJCSEkKCBlbGVtZW50ICkucGFyZW50cygpLmFkZEJhY2soKS5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLmNzcyggdGhpcywgInZpc2liaWxpdHkiICkgPT09ICJoaWRkZW4iOwoJCX0pLmxlbmd0aDsKfQoKJC5leHRlbmQoICQuZXhwclsgIjoiIF0sIHsKCWRhdGE6ICQuZXhwci5jcmVhdGVQc2V1ZG8gPwoJCSQuZXhwci5jcmVhdGVQc2V1ZG8oZnVuY3Rpb24oIGRhdGFOYW1lICkgewoJCQlyZXR1cm4gZnVuY3Rpb24oIGVsZW0gKSB7CgkJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIGRhdGFOYW1lICk7CgkJCX07CgkJfSkgOgoJCS8vIHN1cHBvcnQ6IGpRdWVyeSA8MS44CgkJZnVuY3Rpb24oIGVsZW0sIGksIG1hdGNoICkgewoJCQlyZXR1cm4gISEkLmRhdGEoIGVsZW0sIG1hdGNoWyAzIF0gKTsKCQl9LAoKCWZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJcmV0dXJuIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzTmFOKCAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSApICk7Cgl9LAoKCXRhYmJhYmxlOiBmdW5jdGlvbiggZWxlbWVudCApIHsKCQl2YXIgdGFiSW5kZXggPSAkLmF0dHIoIGVsZW1lbnQsICJ0YWJpbmRleCIgKSwKCQkJaXNUYWJJbmRleE5hTiA9IGlzTmFOKCB0YWJJbmRleCApOwoJCXJldHVybiAoIGlzVGFiSW5kZXhOYU4gfHwgdGFiSW5kZXggPj0gMCApICYmIGZvY3VzYWJsZSggZWxlbWVudCwgIWlzVGFiSW5kZXhOYU4gKTsKCX0KfSk7CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkKCAiPGE+IiApLm91dGVyV2lkdGgoIDEgKS5qcXVlcnkgKSB7CgkkLmVhY2goIFsgIldpZHRoIiwgIkhlaWdodCIgXSwgZnVuY3Rpb24oIGksIG5hbWUgKSB7CgkJdmFyIHNpZGUgPSBuYW1lID09PSAiV2lkdGgiID8gWyAiTGVmdCIsICJSaWdodCIgXSA6IFsgIlRvcCIsICJCb3R0b20iIF0sCgkJCXR5cGUgPSBuYW1lLnRvTG93ZXJDYXNlKCksCgkJCW9yaWcgPSB7CgkJCQlpbm5lcldpZHRoOiAkLmZuLmlubmVyV2lkdGgsCgkJCQlpbm5lckhlaWdodDogJC5mbi5pbm5lckhlaWdodCwKCQkJCW91dGVyV2lkdGg6ICQuZm4ub3V0ZXJXaWR0aCwKCQkJCW91dGVySGVpZ2h0OiAkLmZuLm91dGVySGVpZ2h0CgkJCX07CgoJCWZ1bmN0aW9uIHJlZHVjZSggZWxlbSwgc2l6ZSwgYm9yZGVyLCBtYXJnaW4gKSB7CgkJCSQuZWFjaCggc2lkZSwgZnVuY3Rpb24oKSB7CgkJCQlzaXplIC09IHBhcnNlRmxvYXQoICQuY3NzKCBlbGVtLCAicGFkZGluZyIgKyB0aGlzICkgKSB8fCAwOwoJCQkJaWYgKCBib3JkZXIgKSB7CgkJCQkJc2l6ZSAtPSBwYXJzZUZsb2F0KCAkLmNzcyggZWxlbSwgImJvcmRlciIgKyB0aGlzICsgIldpZHRoIiApICkgfHwgMDsKCQkJCX0KCQkJCWlmICggbWFyZ2luICkgewoJCQkJCXNpemUgLT0gcGFyc2VGbG9hdCggJC5jc3MoIGVsZW0sICJtYXJnaW4iICsgdGhpcyApICkgfHwgMDsKCQkJCX0KCQkJfSk7CgkJCXJldHVybiBzaXplOwoJCX0KCgkJJC5mblsgImlubmVyIiArIG5hbWUgXSA9IGZ1bmN0aW9uKCBzaXplICkgewoJCQlpZiAoIHNpemUgPT09IHVuZGVmaW5lZCApIHsKCQkJCXJldHVybiBvcmlnWyAiaW5uZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5jc3MoIHR5cGUsIHJlZHVjZSggdGhpcywgc2l6ZSApICsgInB4IiApOwoJCQl9KTsKCQl9OwoKCQkkLmZuWyAib3V0ZXIiICsgbmFtZV0gPSBmdW5jdGlvbiggc2l6ZSwgbWFyZ2luICkgewoJCQlpZiAoIHR5cGVvZiBzaXplICE9PSAibnVtYmVyIiApIHsKCQkJCXJldHVybiBvcmlnWyAib3V0ZXIiICsgbmFtZSBdLmNhbGwoIHRoaXMsIHNpemUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMpLmNzcyggdHlwZSwgcmVkdWNlKCB0aGlzLCBzaXplLCB0cnVlLCBtYXJnaW4gKSArICJweCIgKTsKCQkJfSk7CgkJfTsKCX0pOwp9CgovLyBzdXBwb3J0OiBqUXVlcnkgPDEuOAppZiAoICEkLmZuLmFkZEJhY2sgKSB7CgkkLmZuLmFkZEJhY2sgPSBmdW5jdGlvbiggc2VsZWN0b3IgKSB7CgkJcmV0dXJuIHRoaXMuYWRkKCBzZWxlY3RvciA9PSBudWxsID8KCQkJdGhpcy5wcmV2T2JqZWN0IDogdGhpcy5wcmV2T2JqZWN0LmZpbHRlciggc2VsZWN0b3IgKQoJCSk7Cgl9Owp9CgovLyBzdXBwb3J0OiBqUXVlcnkgMS42LjEsIDEuNi4yIChodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC85NDEzKQppZiAoICQoICI8YT4iICkuZGF0YSggImEtYiIsICJhIiApLnJlbW92ZURhdGEoICJhLWIiICkuZGF0YSggImEtYiIgKSApIHsKCSQuZm4ucmVtb3ZlRGF0YSA9IChmdW5jdGlvbiggcmVtb3ZlRGF0YSApIHsKCQlyZXR1cm4gZnVuY3Rpb24oIGtleSApIHsKCQkJaWYgKCBhcmd1bWVudHMubGVuZ3RoICkgewoJCQkJcmV0dXJuIHJlbW92ZURhdGEuY2FsbCggdGhpcywgJC5jYW1lbENhc2UoIGtleSApICk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gcmVtb3ZlRGF0YS5jYWxsKCB0aGlzICk7CgkJCX0KCQl9OwoJfSkoICQuZm4ucmVtb3ZlRGF0YSApOwp9CgoKCgoKLy8gZGVwcmVjYXRlZAokLnVpLmllID0gISEvbXNpZSBbXHcuXSsvLmV4ZWMoIG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSApOwoKJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID0gIm9uc2VsZWN0c3RhcnQiIGluIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICk7CiQuZm4uZXh0ZW5kKHsKCWRpc2FibGVTZWxlY3Rpb246IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmJpbmQoICggJC5zdXBwb3J0LnNlbGVjdHN0YXJ0ID8gInNlbGVjdHN0YXJ0IiA6ICJtb3VzZWRvd24iICkgKwoJCQkiLnVpLWRpc2FibGVTZWxlY3Rpb24iLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9KTsKCX0sCgoJZW5hYmxlU2VsZWN0aW9uOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy51bmJpbmQoICIudWktZGlzYWJsZVNlbGVjdGlvbiIgKTsKCX0sCgoJekluZGV4OiBmdW5jdGlvbiggekluZGV4ICkgewoJCWlmICggekluZGV4ICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0aGlzLmNzcyggInpJbmRleCIsIHpJbmRleCApOwoJCX0KCgkJaWYgKCB0aGlzLmxlbmd0aCApIHsKCQkJdmFyIGVsZW0gPSAkKCB0aGlzWyAwIF0gKSwgcG9zaXRpb24sIHZhbHVlOwoJCQl3aGlsZSAoIGVsZW0ubGVuZ3RoICYmIGVsZW1bIDAgXSAhPT0gZG9jdW1lbnQgKSB7CgkJCQkvLyBJZ25vcmUgei1pbmRleCBpZiBwb3NpdGlvbiBpcyBzZXQgdG8gYSB2YWx1ZSB3aGVyZSB6LWluZGV4IGlzIGlnbm9yZWQgYnkgdGhlIGJyb3dzZXIKCQkJCS8vIFRoaXMgbWFrZXMgYmVoYXZpb3Igb2YgdGhpcyBmdW5jdGlvbiBjb25zaXN0ZW50IGFjcm9zcyBicm93c2VycwoJCQkJLy8gV2ViS2l0IGFsd2F5cyByZXR1cm5zIGF1dG8gaWYgdGhlIGVsZW1lbnQgaXMgcG9zaXRpb25lZAoJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoJCQkJaWYgKCBwb3NpdGlvbiA9PT0gImFic29sdXRlIiB8fCBwb3NpdGlvbiA9PT0gInJlbGF0aXZlIiB8fCBwb3NpdGlvbiA9PT0gImZpeGVkIiApIHsKCQkJCQkvLyBJRSByZXR1cm5zIDAgd2hlbiB6SW5kZXggaXMgbm90IHNwZWNpZmllZAoJCQkJCS8vIG90aGVyIGJyb3dzZXJzIHJldHVybiBhIHN0cmluZwoJCQkJCS8vIHdlIGlnbm9yZSB0aGUgY2FzZSBvZiBuZXN0ZWQgZWxlbWVudHMgd2l0aCBhbiBleHBsaWNpdCB2YWx1ZSBvZiAwCgkJCQkJLy8gPGRpdiBzdHlsZT0iei1pbmRleDogLTEwOyI+PGRpdiBzdHlsZT0iei1pbmRleDogMDsiPjwvZGl2PjwvZGl2PgoJCQkJCXZhbHVlID0gcGFyc2VJbnQoIGVsZW0uY3NzKCAiekluZGV4IiApLCAxMCApOwoJCQkJCWlmICggIWlzTmFOKCB2YWx1ZSApICYmIHZhbHVlICE9PSAwICkgewoJCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQkJfQoJCQkJfQoJCQkJZWxlbSA9IGVsZW0ucGFyZW50KCk7CgkJCX0KCQl9CgoJCXJldHVybiAwOwoJfQp9KTsKCi8vICQudWkucGx1Z2luIGlzIGRlcHJlY2F0ZWQuIFVzZSAkLndpZGdldCgpIGV4dGVuc2lvbnMgaW5zdGVhZC4KJC51aS5wbHVnaW4gPSB7CglhZGQ6IGZ1bmN0aW9uKCBtb2R1bGUsIG9wdGlvbiwgc2V0ICkgewoJCXZhciBpLAoJCQlwcm90byA9ICQudWlbIG1vZHVsZSBdLnByb3RvdHlwZTsKCQlmb3IgKCBpIGluIHNldCApIHsKCQkJcHJvdG8ucGx1Z2luc1sgaSBdID0gcHJvdG8ucGx1Z2luc1sgaSBdIHx8IFtdOwoJCQlwcm90by5wbHVnaW5zWyBpIF0ucHVzaCggWyBvcHRpb24sIHNldFsgaSBdIF0gKTsKCQl9Cgl9LAoJY2FsbDogZnVuY3Rpb24oIGluc3RhbmNlLCBuYW1lLCBhcmdzLCBhbGxvd0Rpc2Nvbm5lY3RlZCApIHsKCQl2YXIgaSwKCQkJc2V0ID0gaW5zdGFuY2UucGx1Z2luc1sgbmFtZSBdOwoKCQlpZiAoICFzZXQgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIWFsbG93RGlzY29ubmVjdGVkICYmICggIWluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlIHx8IGluc3RhbmNlLmVsZW1lbnRbIDAgXS5wYXJlbnROb2RlLm5vZGVUeXBlID09PSAxMSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlmb3IgKCBpID0gMDsgaSA8IHNldC5sZW5ndGg7IGkrKyApIHsKCQkJaWYgKCBpbnN0YW5jZS5vcHRpb25zWyBzZXRbIGkgXVsgMCBdIF0gKSB7CgkJCQlzZXRbIGkgXVsgMSBdLmFwcGx5KCBpbnN0YW5jZS5lbGVtZW50LCBhcmdzICk7CgkJCX0KCQl9Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZGVmaW5lIHRoZSB3aW5kb3cgYW5kIHRoZSBkb2N1bWVudCBvYmplY3RzCgkJd2luZG93OiAkKCB3aW5kb3cgKSwKCQlkb2N1bWVudDogJCggZG9jdW1lbnQgKSwKCgkJLy8gVE9ETzogUmVtb3ZlIGFuZCB1c2UgJC51aS5rZXlDb2RlIGRpcmVjdGx5CgkJa2V5Q29kZTogJC51aS5rZXlDb2RlLAoKCQkvLyBQbGFjZSB0byBzdG9yZSB2YXJpb3VzIHdpZGdldCBleHRlbnNpb25zCgkJYmVoYXZpb3JzOiB7fSwKCgkJLy8gU2Nyb2xsIHBhZ2UgdmVydGljYWxseTogc2Nyb2xsIHRvIDAgdG8gaGlkZSBpT1MgYWRkcmVzcyBiYXIsIG9yIHBhc3MgYSBZIHZhbHVlCgkJc2lsZW50U2Nyb2xsOiBmdW5jdGlvbiggeXBvcyApIHsKCQkJaWYgKCAkLnR5cGUoIHlwb3MgKSAhPT0gIm51bWJlciIgKSB7CgkJCQl5cG9zID0gJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCX0KCgkJCS8vIHByZXZlbnQgc2Nyb2xsc3RhcnQgYW5kIHNjcm9sbHN0b3AgZXZlbnRzCgkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gZmFsc2U7CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJd2luZG93LnNjcm9sbFRvKCAwLCB5cG9zICk7CgkJCQkkLm1vYmlsZS5kb2N1bWVudC50cmlnZ2VyKCAic2lsZW50c2Nyb2xsIiwgeyB4OiAwLCB5OiB5cG9zIH0pOwoJCQl9LCAyMCApOwoKCQkJc2V0VGltZW91dChmdW5jdGlvbigpIHsKCQkJCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydC5lbmFibGVkID0gdHJ1ZTsKCQkJfSwgMTUwICk7CgkJfSwKCgkJZ2V0Q2xvc2VzdEJhc2VVcmw6IGZ1bmN0aW9uKCBlbGUgKQl7CgkJCS8vIEZpbmQgdGhlIGNsb3Nlc3QgcGFnZSBhbmQgZXh0cmFjdCBvdXQgaXRzIHVybC4KCQkJdmFyIHVybCA9ICQoIGVsZSApLmNsb3Nlc3QoICIudWktcGFnZSIgKS5qcW1EYXRhKCAidXJsIiApLAoJCQkJYmFzZSA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2g7CgoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgfHwgIXVybCB8fCAhJC5tb2JpbGUucGF0aC5pc1BhdGgoIHVybCApICkgewoJCQkJdXJsID0gYmFzZTsKCQkJfQoKCQkJcmV0dXJuICQubW9iaWxlLnBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIGJhc2UgKTsKCQl9LAoJCXJlbW92ZUFjdGl2ZUxpbmtDbGFzczogZnVuY3Rpb24oIGZvcmNlUmVtb3ZhbCApIHsKCQkJaWYgKCAhISQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkoICEkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5jbG9zZXN0KCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKS5sZW5ndGggfHwKCQkJCQlmb3JjZVJlbW92YWwgKSApIHsKCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9IG51bGw7CgkJfSwKCgkJLy8gREVQUkVDQVRFRCBpbiAxLjQKCQkvLyBGaW5kIHRoZSBjbG9zZXN0IHBhcmVudCB3aXRoIGEgdGhlbWUgY2xhc3Mgb24gaXQuIE5vdGUgdGhhdAoJCS8vIHdlIGFyZSBub3QgdXNpbmcgJC5mbi5jbG9zZXN0KCkgb24gcHVycG9zZSBoZXJlIGJlY2F1c2UgdGhpcwoJCS8vIG1ldGhvZCBnZXRzIGNhbGxlZCBxdWl0ZSBhIGJpdCBhbmQgd2UgbmVlZCBpdCB0byBiZSBhcyBmYXN0CgkJLy8gYXMgcG9zc2libGUuCgkJZ2V0SW5oZXJpdGVkVGhlbWU6IGZ1bmN0aW9uKCBlbCwgZGVmYXVsdFRoZW1lICkgewoJCQl2YXIgZSA9IGVsWyAwIF0sCgkJCQlsdHIgPSAiIiwKCQkJCXJlID0gL3VpLShiYXJ8Ym9keXxvdmVybGF5KS0oW2Etel0pXGIvLAoJCQkJYywgbTsKCQkJd2hpbGUgKCBlICkgewoJCQkJYyA9IGUuY2xhc3NOYW1lIHx8ICIiOwoJCQkJaWYgKCBjICYmICggbSA9IHJlLmV4ZWMoIGMgKSApICYmICggbHRyID0gbVsgMiBdICkgKSB7CgkJCQkJLy8gV2UgZm91bmQgYSBwYXJlbnQgd2l0aCBhIHRoZW1lIGNsYXNzCgkJCQkJLy8gb24gaXQgc28gYmFpbCBmcm9tIHRoaXMgbG9vcC4KCQkJCQlicmVhazsKCQkJCX0KCgkJCQllID0gZS5wYXJlbnROb2RlOwoJCQl9CgkJCS8vIFJldHVybiB0aGUgdGhlbWUgbGV0dGVyIHdlIGZvdW5kLCBpZiBub25lLCByZXR1cm4gdGhlCgkJCS8vIHNwZWNpZmllZCBkZWZhdWx0LgoJCQlyZXR1cm4gbHRyIHx8IGRlZmF1bHRUaGVtZSB8fCAiYSI7CgkJfSwKCgkJZW5oYW5jZWFibGU6IGZ1bmN0aW9uKCBlbGVtZW50cyApIHsKCQkJcmV0dXJuIHRoaXMuaGF2ZVBhcmVudHMoIGVsZW1lbnRzLCAiZW5oYW5jZSIgKTsKCQl9LAoKCQloaWphY2thYmxlOiBmdW5jdGlvbiggZWxlbWVudHMgKSB7CgkJCXJldHVybiB0aGlzLmhhdmVQYXJlbnRzKCBlbGVtZW50cywgImFqYXgiICk7CgkJfSwKCgkJaGF2ZVBhcmVudHM6IGZ1bmN0aW9uKCBlbGVtZW50cywgYXR0ciApIHsKCQkJaWYgKCAhJC5tb2JpbGUuaWdub3JlQ29udGVudEVuYWJsZWQgKSB7CgkJCQlyZXR1cm4gZWxlbWVudHM7CgkJCX0KCgkJCXZhciBjb3VudCA9IGVsZW1lbnRzLmxlbmd0aCwKCQkJCSRuZXdTZXQgPSAkKCksCgkJCQllLCAkZWxlbWVudCwgZXhjbHVkZWQsCgkJCQlpLCBjOwoKCQkJZm9yICggaSA9IDA7IGkgPCBjb3VudDsgaSsrICkgewoJCQkJJGVsZW1lbnQgPSBlbGVtZW50cy5lcSggaSApOwoJCQkJZXhjbHVkZWQgPSBmYWxzZTsKCQkJCWUgPSBlbGVtZW50c1sgaSBdOwoKCQkJCXdoaWxlICggZSApIHsKCQkJCQljID0gZS5nZXRBdHRyaWJ1dGUgPyBlLmdldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgYXR0ciApIDogIiI7CgoJCQkJCWlmICggYyA9PT0gImZhbHNlIiApIHsKCQkJCQkJZXhjbHVkZWQgPSB0cnVlOwoJCQkJCQlicmVhazsKCQkJCQl9CgoJCQkJCWUgPSBlLnBhcmVudE5vZGU7CgkJCQl9CgoJCQkJaWYgKCAhZXhjbHVkZWQgKSB7CgkJCQkJJG5ld1NldCA9ICRuZXdTZXQuYWRkKCAkZWxlbWVudCApOwoJCQkJfQoJCQl9CgoJCQlyZXR1cm4gJG5ld1NldDsKCQl9LAoKCQlnZXRTY3JlZW5IZWlnaHQ6IGZ1bmN0aW9uKCkgewoJCQkvLyBOYXRpdmUgaW5uZXJIZWlnaHQgcmV0dXJucyBtb3JlIGFjY3VyYXRlIHZhbHVlIGZvciB0aGlzIGFjcm9zcyBwbGF0Zm9ybXMsCgkJCS8vIGpRdWVyeSB2ZXJzaW9uIGlzIGhlcmUgYXMgYSBub3JtYWxpemVkIGZhbGxiYWNrIGZvciBwbGF0Zm9ybXMgbGlrZSBTeW1iaWFuCgkJCXJldHVybiB3aW5kb3cuaW5uZXJIZWlnaHQgfHwgJC5tb2JpbGUud2luZG93LmhlaWdodCgpOwoJCX0sCgoJCS8vc2ltcGx5IHNldCB0aGUgYWN0aXZlIHBhZ2UncyBtaW5pbXVtIGhlaWdodCB0byBzY3JlZW4gaGVpZ2h0LCBkZXBlbmRpbmcgb24gb3JpZW50YXRpb24KCQlyZXNldEFjdGl2ZVBhZ2VIZWlnaHQ6IGZ1bmN0aW9uKCBoZWlnaHQgKSB7CgkJCXZhciBwYWdlID0gJCggIi4iICsgJC5tb2JpbGUuYWN0aXZlUGFnZUNsYXNzICksCgkJCQlwYWdlSGVpZ2h0ID0gcGFnZS5oZWlnaHQoKSwKCQkJCXBhZ2VPdXRlckhlaWdodCA9IHBhZ2Uub3V0ZXJIZWlnaHQoIHRydWUgKTsKCgkJCWhlaWdodCA9ICggdHlwZW9mIGhlaWdodCA9PT0gIm51bWJlciIgKSA/IGhlaWdodCA6ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQkJcGFnZS5jc3MoICJtaW4taGVpZ2h0IiwgaGVpZ2h0IC0gKCBwYWdlT3V0ZXJIZWlnaHQgLSBwYWdlSGVpZ2h0ICkgKTsKCQl9LAoKCQlsb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgY2FsbCB0byB0aGlzIGZ1bmN0aW9uLCBpbnN0YW50aWF0ZSBhIGxvYWRlciB3aWRnZXQKCQkJdmFyIGxvYWRlciA9IHRoaXMubG9hZGluZy5fd2lkZ2V0IHx8ICQoICQubW9iaWxlLmxvYWRlci5wcm90b3R5cGUuZGVmYXVsdEh0bWwgKS5sb2FkZXIoKSwKCgkJCQkvLyBDYWxsIHRoZSBhcHByb3ByaWF0ZSBtZXRob2Qgb24gdGhlIGxvYWRlcgoJCQkJcmV0dXJuVmFsdWUgPSBsb2FkZXIubG9hZGVyLmFwcGx5KCBsb2FkZXIsIGFyZ3VtZW50cyApOwoKCQkJLy8gTWFrZSBzdXJlIHRoZSBsb2FkZXIgaXMgcmV0YWluZWQgZm9yIGZ1dHVyZSBjYWxscyB0byB0aGlzIGZ1bmN0aW9uLgoJCQl0aGlzLmxvYWRpbmcuX3dpZGdldCA9IGxvYWRlcjsKCgkJCXJldHVybiByZXR1cm5WYWx1ZTsKCQl9Cgl9KTsKCgkkLmFkZERlcGVuZGVudHMgPSBmdW5jdGlvbiggZWxlbSwgbmV3RGVwZW5kZW50cyApIHsKCQl2YXIgJGVsZW0gPSAkKCBlbGVtICksCgkJCWRlcGVuZGVudHMgPSAkZWxlbS5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCSRlbGVtLmpxbURhdGEoICJkZXBlbmRlbnRzIiwgJCggZGVwZW5kZW50cyApLmFkZCggbmV3RGVwZW5kZW50cyApICk7Cgl9OwoKCS8vIHBsdWdpbnMKCSQuZm4uZXh0ZW5kKHsKCQlyZW1vdmVXaXRoRGVwZW5kZW50czogZnVuY3Rpb24oKSB7CgkJCSQucmVtb3ZlV2l0aERlcGVuZGVudHMoIHRoaXMgKTsKCQl9LAoKCQkvLyBFbmhhbmNlIGNoaWxkIGVsZW1lbnRzCgkJZW5oYW5jZVdpdGhpbjogZnVuY3Rpb24oKSB7CgkJCXZhciBpbmRleCwKCQkJCXdpZGdldEVsZW1lbnRzID0ge30sCgkJCQlrZWVwTmF0aXZlID0gJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCksCgkJCQl0aGF0ID0gdGhpczsKCgkJCS8vIEFkZCBubyBqcyBjbGFzcyB0byBlbGVtZW50cwoJCQlpZiAoICQubW9iaWxlLm5vanMgKSB7CgkJCQkkLm1vYmlsZS5ub2pzKCB0aGlzICk7CgkJCX0KCgkJCS8vIEJpbmQgbGlua3MgZm9yIGFqYXggbmF2CgkJCWlmICggJC5tb2JpbGUubGlua3MgKSB7CgkJCQkkLm1vYmlsZS5saW5rcyggdGhpcyApOwoJCQl9CgoJCQkvLyBEZWdyYWRlIGlucHV0cyBmb3Igc3R5bGVpbmcKCQkJaWYgKCAkLm1vYmlsZS5kZWdyYWRlSW5wdXRzV2l0aGluICkgewoJCQkJJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiggdGhpcyApOwoJCQl9CgoJCQkvLyBSdW4gYnV0dG9ubWFya3VwCgkJCWlmICggJC5mbi5idXR0b25NYXJrdXAgKSB7CgkJCQl0aGlzLmZpbmQoICQuZm4uYnV0dG9uTWFya3VwLmluaXRTZWxlY3RvciApLm5vdCgga2VlcE5hdGl2ZSApCgkJCQkuanFtRW5oYW5jZWFibGUoKS5idXR0b25NYXJrdXAoKTsKCQkJfQoKCQkJLy8gQWRkIGNsYXNzZXMgZm9yIGZpZWxkQ29udGFpbgoJCQlpZiAoICQuZm4uZmllbGRjb250YWluICkgewoJCQkJdGhpcy5maW5kKCAiOmpxbURhdGEocm9sZT0nZmllbGRjb250YWluJykiICkubm90KCBrZWVwTmF0aXZlICkKCQkJCS5qcW1FbmhhbmNlYWJsZSgpLmZpZWxkY29udGFpbigpOwoJCQl9CgoJCQkvLyBFbmhhbmNlIHdpZGdldHMKCQkJJC5lYWNoKCAkLm1vYmlsZS53aWRnZXRzLCBmdW5jdGlvbiggbmFtZSwgY29uc3RydWN0b3IgKSB7CgoJCQkJLy8gSWYgaW5pdFNlbGVjdG9yIG5vdCBmYWxzZSBmaW5kIGVsZW1lbnRzCgkJCQlpZiAoIGNvbnN0cnVjdG9yLmluaXRTZWxlY3RvciApIHsKCgkJCQkJLy8gRmlsdGVyIGVsZW1lbnRzIHRoYXQgc2hvdWxkIG5vdCBiZSBlbmhhbmNlZCBiYXNlZCBvbiBwYXJlbnRzCgkJCQkJdmFyIGVsZW1lbnRzID0gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoYXQuZmluZCggY29uc3RydWN0b3IuaW5pdFNlbGVjdG9yICkgKTsKCgkJCQkJLy8gSWYgYW55IG1hdGNoaW5nIGVsZW1lbnRzIHJlbWFpbiBmaWx0ZXIgb25lcyB3aXRoIGtlZXBOYXRpdmVTZWxlY3RvcgoJCQkJCWlmICggZWxlbWVudHMubGVuZ3RoID4gMCApIHsKCgkJCQkJCS8vICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvciBpcyBkZXByZWNhdGVkIHRoaXMgaXMganVzdCBmb3IgYmFja2NvbXBhdAoJCQkJCQkvLyBTd2l0Y2ggdG8gJC5tb2JpbGUua2VlcE5hdGl2ZSBpbiAxLjUgd2hpY2ggaXMganVzdCBhIHZhbHVlIG5vdCBhIGZ1bmN0aW9uCgkJCQkJCWVsZW1lbnRzID0gZWxlbWVudHMubm90KCBrZWVwTmF0aXZlICk7CgkJCQkJfQoKCQkJCQkvLyBFbmhhbmNlIHdoYXRldmVyIGlzIGxlZnQKCQkJCQlpZiAoIGVsZW1lbnRzLmxlbmd0aCA+IDAgKSB7CgkJCQkJCXdpZGdldEVsZW1lbnRzWyBjb25zdHJ1Y3Rvci5wcm90b3R5cGUud2lkZ2V0TmFtZSBdID0gZWxlbWVudHM7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCWZvciAoIGluZGV4IGluIHdpZGdldEVsZW1lbnRzICkgewoJCQkJd2lkZ2V0RWxlbWVudHNbIGluZGV4IF1bIGluZGV4IF0oKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXM7CgkJfSwKCgkJYWRkRGVwZW5kZW50czogZnVuY3Rpb24oIG5ld0RlcGVuZGVudHMgKSB7CgkJCSQuYWRkRGVwZW5kZW50cyggdGhpcywgbmV3RGVwZW5kZW50cyApOwoJCX0sCgoJCS8vIG5vdGUgdGhhdCB0aGlzIGhlbHBlciBkb2Vzbid0IGF0dGVtcHQgdG8gaGFuZGxlIHRoZSBjYWxsYmFjawoJCS8vIG9yIHNldHRpbmcgb2YgYW4gaHRtbCBlbGVtZW50J3MgdGV4dCwgaXRzIG9ubHkgcHVycG9zZSBpcwoJCS8vIHRvIHJldHVybiB0aGUgaHRtbCBlbmNvZGVkIHZlcnNpb24gb2YgdGhlIHRleHQgaW4gYWxsIGNhc2VzLiAodGh1cyB0aGUgbmFtZSkKCQlnZXRFbmNvZGVkVGV4dDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkKCAiPGE+IiApLnRleHQoIHRoaXMudGV4dCgpICkuaHRtbCgpOwoJCX0sCgoJCS8vIGZsdWVudCBoZWxwZXIgZnVuY3Rpb24gZm9yIHRoZSBtb2JpbGUgbmFtZXNwYWNlZCBlcXVpdmFsZW50CgkJanFtRW5oYW5jZWFibGU6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZW5oYW5jZWFibGUoIHRoaXMgKTsKCQl9LAoKCQlqcW1IaWphY2thYmxlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmhpamFja2FibGUoIHRoaXMgKTsKCQl9Cgl9KTsKCgkkLnJlbW92ZVdpdGhEZXBlbmRlbnRzID0gZnVuY3Rpb24oIG5hdGl2ZUVsZW1lbnQgKSB7CgkJdmFyIGVsZW1lbnQgPSAkKCBuYXRpdmVFbGVtZW50ICk7CgoJCSggZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCkgKS5yZW1vdmUoKTsKCQllbGVtZW50LnJlbW92ZSgpOwoJfTsKCSQuYWRkRGVwZW5kZW50cyA9IGZ1bmN0aW9uKCBuYXRpdmVFbGVtZW50LCBuZXdEZXBlbmRlbnRzICkgewoJCXZhciBlbGVtZW50ID0gJCggbmF0aXZlRWxlbWVudCApLAoJCQlkZXBlbmRlbnRzID0gZWxlbWVudC5qcW1EYXRhKCAiZGVwZW5kZW50cyIgKSB8fCAkKCk7CgoJCWVsZW1lbnQuanFtRGF0YSggImRlcGVuZGVudHMiLCAkKCBkZXBlbmRlbnRzICkuYWRkKCBuZXdEZXBlbmRlbnRzICkgKTsKCX07CgoJJC5maW5kLm1hdGNoZXMgPSBmdW5jdGlvbiggZXhwciwgc2V0ICkgewoJCXJldHVybiAkLmZpbmQoIGV4cHIsIG51bGwsIG51bGwsIHNldCApOwoJfTsKCgkkLmZpbmQubWF0Y2hlc1NlbGVjdG9yID0gZnVuY3Rpb24oIG5vZGUsIGV4cHIgKSB7CgkJcmV0dXJuICQuZmluZCggZXhwciwgbnVsbCwgbnVsbCwgWyBub2RlIF0gKS5sZW5ndGggPiAwOwoJfTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgovKiEKICogalF1ZXJ5IFVJIFdpZGdldCBjMGFiNzEwNTZiOTM2NjI3ZThhNzgyMWYwM2MwNDRhZWM2MjgwYTQwTgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL2pRdWVyeS53aWRnZXQvCiAqLwooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciB1dWlkID0gMCwKCXNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLAoJX2NsZWFuRGF0YSA9ICQuY2xlYW5EYXRhOwokLmNsZWFuRGF0YSA9IGZ1bmN0aW9uKCBlbGVtcyApIHsKCWZvciAoIHZhciBpID0gMCwgZWxlbTsgKGVsZW0gPSBlbGVtc1tpXSkgIT0gbnVsbDsgaSsrICkgewoJCXRyeSB7CgkJCSQoIGVsZW0gKS50cmlnZ2VySGFuZGxlciggInJlbW92ZSIgKTsKCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC84MjM1CgkJfSBjYXRjaCggZSApIHt9Cgl9CglfY2xlYW5EYXRhKCBlbGVtcyApOwp9OwoKJC53aWRnZXQgPSBmdW5jdGlvbiggbmFtZSwgYmFzZSwgcHJvdG90eXBlICkgewoJdmFyIGZ1bGxOYW1lLCBleGlzdGluZ0NvbnN0cnVjdG9yLCBjb25zdHJ1Y3RvciwgYmFzZVByb3RvdHlwZSwKCQkvLyBwcm94aWVkUHJvdG90eXBlIGFsbG93cyB0aGUgcHJvdmlkZWQgcHJvdG90eXBlIHRvIHJlbWFpbiB1bm1vZGlmaWVkCgkJLy8gc28gdGhhdCBpdCBjYW4gYmUgdXNlZCBhcyBhIG1peGluIGZvciBtdWx0aXBsZSB3aWRnZXRzICgjODg3NikKCQlwcm94aWVkUHJvdG90eXBlID0ge30sCgkJbmFtZXNwYWNlID0gbmFtZS5zcGxpdCggIi4iIClbIDAgXTsKCgluYW1lID0gbmFtZS5zcGxpdCggIi4iIClbIDEgXTsKCWZ1bGxOYW1lID0gbmFtZXNwYWNlICsgIi0iICsgbmFtZTsKCglpZiAoICFwcm90b3R5cGUgKSB7CgkJcHJvdG90eXBlID0gYmFzZTsKCQliYXNlID0gJC5XaWRnZXQ7Cgl9CgoJLy8gY3JlYXRlIHNlbGVjdG9yIGZvciBwbHVnaW4KCSQuZXhwclsgIjoiIF1bIGZ1bGxOYW1lLnRvTG93ZXJDYXNlKCkgXSA9IGZ1bmN0aW9uKCBlbGVtICkgewoJCXJldHVybiAhISQuZGF0YSggZWxlbSwgZnVsbE5hbWUgKTsKCX07CgoJJFsgbmFtZXNwYWNlIF0gPSAkWyBuYW1lc3BhY2UgXSB8fCB7fTsKCWV4aXN0aW5nQ29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdOwoJY29uc3RydWN0b3IgPSAkWyBuYW1lc3BhY2UgXVsgbmFtZSBdID0gZnVuY3Rpb24oIG9wdGlvbnMsIGVsZW1lbnQgKSB7CgkJLy8gYWxsb3cgaW5zdGFudGlhdGlvbiB3aXRob3V0ICJuZXciIGtleXdvcmQKCQlpZiAoICF0aGlzLl9jcmVhdGVXaWRnZXQgKSB7CgkJCXJldHVybiBuZXcgY29uc3RydWN0b3IoIG9wdGlvbnMsIGVsZW1lbnQgKTsKCQl9CgoJCS8vIGFsbG93IGluc3RhbnRpYXRpb24gd2l0aG91dCBpbml0aWFsaXppbmcgZm9yIHNpbXBsZSBpbmhlcml0YW5jZQoJCS8vIG11c3QgdXNlICJuZXciIGtleXdvcmQgKHRoZSBjb2RlIGFib3ZlIGFsd2F5cyBwYXNzZXMgYXJncykKCQlpZiAoIGFyZ3VtZW50cy5sZW5ndGggKSB7CgkJCXRoaXMuX2NyZWF0ZVdpZGdldCggb3B0aW9ucywgZWxlbWVudCApOwoJCX0KCX07CgkvLyBleHRlbmQgd2l0aCB0aGUgZXhpc3RpbmcgY29uc3RydWN0b3IgdG8gY2Fycnkgb3ZlciBhbnkgc3RhdGljIHByb3BlcnRpZXMKCSQuZXh0ZW5kKCBjb25zdHJ1Y3RvciwgZXhpc3RpbmdDb25zdHJ1Y3RvciwgewoJCXZlcnNpb246IHByb3RvdHlwZS52ZXJzaW9uLAoJCS8vIGNvcHkgdGhlIG9iamVjdCB1c2VkIHRvIGNyZWF0ZSB0aGUgcHJvdG90eXBlIGluIGNhc2Ugd2UgbmVlZCB0bwoJCS8vIHJlZGVmaW5lIHRoZSB3aWRnZXQgbGF0ZXIKCQlfcHJvdG86ICQuZXh0ZW5kKCB7fSwgcHJvdG90eXBlICksCgkJLy8gdHJhY2sgd2lkZ2V0cyB0aGF0IGluaGVyaXQgZnJvbSB0aGlzIHdpZGdldCBpbiBjYXNlIHRoaXMgd2lkZ2V0IGlzCgkJLy8gcmVkZWZpbmVkIGFmdGVyIGEgd2lkZ2V0IGluaGVyaXRzIGZyb20gaXQKCQlfY2hpbGRDb25zdHJ1Y3RvcnM6IFtdCgl9KTsKCgliYXNlUHJvdG90eXBlID0gbmV3IGJhc2UoKTsKCS8vIHdlIG5lZWQgdG8gbWFrZSB0aGUgb3B0aW9ucyBoYXNoIGEgcHJvcGVydHkgZGlyZWN0bHkgb24gdGhlIG5ldyBpbnN0YW5jZQoJLy8gb3RoZXJ3aXNlIHdlJ2xsIG1vZGlmeSB0aGUgb3B0aW9ucyBoYXNoIG9uIHRoZSBwcm90b3R5cGUgdGhhdCB3ZSdyZQoJLy8gaW5oZXJpdGluZyBmcm9tCgliYXNlUHJvdG90eXBlLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LCBiYXNlUHJvdG90eXBlLm9wdGlvbnMgKTsKCSQuZWFjaCggcHJvdG90eXBlLCBmdW5jdGlvbiggcHJvcCwgdmFsdWUgKSB7CgkJaWYgKCAhJC5pc0Z1bmN0aW9uKCB2YWx1ZSApICkgewoJCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSB2YWx1ZTsKCQkJcmV0dXJuOwoJCX0KCQlwcm94aWVkUHJvdG90eXBlWyBwcm9wIF0gPSAoZnVuY3Rpb24oKSB7CgkJCXZhciBfc3VwZXIgPSBmdW5jdGlvbigpIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCQl9LAoJCQkJX3N1cGVyQXBwbHkgPSBmdW5jdGlvbiggYXJncyApIHsKCQkJCQlyZXR1cm4gYmFzZS5wcm90b3R5cGVbIHByb3AgXS5hcHBseSggdGhpcywgYXJncyApOwoJCQkJfTsKCQkJcmV0dXJuIGZ1bmN0aW9uKCkgewoJCQkJdmFyIF9fc3VwZXIgPSB0aGlzLl9zdXBlciwKCQkJCQlfX3N1cGVyQXBwbHkgPSB0aGlzLl9zdXBlckFwcGx5LAoJCQkJCXJldHVyblZhbHVlOwoKCQkJCXRoaXMuX3N1cGVyID0gX3N1cGVyOwoJCQkJdGhpcy5fc3VwZXJBcHBseSA9IF9zdXBlckFwcGx5OwoKCQkJCXJldHVyblZhbHVlID0gdmFsdWUuYXBwbHkoIHRoaXMsIGFyZ3VtZW50cyApOwoKCQkJCXRoaXMuX3N1cGVyID0gX19zdXBlcjsKCQkJCXRoaXMuX3N1cGVyQXBwbHkgPSBfX3N1cGVyQXBwbHk7CgoJCQkJcmV0dXJuIHJldHVyblZhbHVlOwoJCQl9OwoJCX0pKCk7Cgl9KTsKCWNvbnN0cnVjdG9yLnByb3RvdHlwZSA9ICQud2lkZ2V0LmV4dGVuZCggYmFzZVByb3RvdHlwZSwgewoJCS8vIFRPRE86IHJlbW92ZSBzdXBwb3J0IGZvciB3aWRnZXRFdmVudFByZWZpeAoJCS8vIGFsd2F5cyB1c2UgdGhlIG5hbWUgKyBhIGNvbG9uIGFzIHRoZSBwcmVmaXgsIGUuZy4sIGRyYWdnYWJsZTpzdGFydAoJCS8vIGRvbid0IHByZWZpeCBmb3Igd2lkZ2V0cyB0aGF0IGFyZW4ndCBET00tYmFzZWQKCQl3aWRnZXRFdmVudFByZWZpeDogZXhpc3RpbmdDb25zdHJ1Y3RvciA/IChiYXNlUHJvdG90eXBlLndpZGdldEV2ZW50UHJlZml4IHx8IG5hbWUpIDogbmFtZQoJfSwgcHJveGllZFByb3RvdHlwZSwgewoJCWNvbnN0cnVjdG9yOiBjb25zdHJ1Y3RvciwKCQluYW1lc3BhY2U6IG5hbWVzcGFjZSwKCQl3aWRnZXROYW1lOiBuYW1lLAoJCXdpZGdldEZ1bGxOYW1lOiBmdWxsTmFtZQoJfSk7CgoJLy8gSWYgdGhpcyB3aWRnZXQgaXMgYmVpbmcgcmVkZWZpbmVkIHRoZW4gd2UgbmVlZCB0byBmaW5kIGFsbCB3aWRnZXRzIHRoYXQKCS8vIGFyZSBpbmhlcml0aW5nIGZyb20gaXQgYW5kIHJlZGVmaW5lIGFsbCBvZiB0aGVtIHNvIHRoYXQgdGhleSBpbmhlcml0IGZyb20KCS8vIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGlzIHdpZGdldC4gV2UncmUgZXNzZW50aWFsbHkgdHJ5aW5nIHRvIHJlcGxhY2Ugb25lCgkvLyBsZXZlbCBpbiB0aGUgcHJvdG90eXBlIGNoYWluLgoJaWYgKCBleGlzdGluZ0NvbnN0cnVjdG9yICkgewoJCSQuZWFjaCggZXhpc3RpbmdDb25zdHJ1Y3Rvci5fY2hpbGRDb25zdHJ1Y3RvcnMsIGZ1bmN0aW9uKCBpLCBjaGlsZCApIHsKCQkJdmFyIGNoaWxkUHJvdG90eXBlID0gY2hpbGQucHJvdG90eXBlOwoKCQkJLy8gcmVkZWZpbmUgdGhlIGNoaWxkIHdpZGdldCB1c2luZyB0aGUgc2FtZSBwcm90b3R5cGUgdGhhdCB3YXMKCQkJLy8gb3JpZ2luYWxseSB1c2VkLCBidXQgaW5oZXJpdCBmcm9tIHRoZSBuZXcgdmVyc2lvbiBvZiB0aGUgYmFzZQoJCQkkLndpZGdldCggY2hpbGRQcm90b3R5cGUubmFtZXNwYWNlICsgIi4iICsgY2hpbGRQcm90b3R5cGUud2lkZ2V0TmFtZSwgY29uc3RydWN0b3IsIGNoaWxkLl9wcm90byApOwoJCX0pOwoJCS8vIHJlbW92ZSB0aGUgbGlzdCBvZiBleGlzdGluZyBjaGlsZCBjb25zdHJ1Y3RvcnMgZnJvbSB0aGUgb2xkIGNvbnN0cnVjdG9yCgkJLy8gc28gdGhlIG9sZCBjaGlsZCBjb25zdHJ1Y3RvcnMgY2FuIGJlIGdhcmJhZ2UgY29sbGVjdGVkCgkJZGVsZXRlIGV4aXN0aW5nQ29uc3RydWN0b3IuX2NoaWxkQ29uc3RydWN0b3JzOwoJfSBlbHNlIHsKCQliYXNlLl9jaGlsZENvbnN0cnVjdG9ycy5wdXNoKCBjb25zdHJ1Y3RvciApOwoJfQoKCSQud2lkZ2V0LmJyaWRnZSggbmFtZSwgY29uc3RydWN0b3IgKTsKCglyZXR1cm4gY29uc3RydWN0b3I7Cn07CgokLndpZGdldC5leHRlbmQgPSBmdW5jdGlvbiggdGFyZ2V0ICkgewoJdmFyIGlucHV0ID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJaW5wdXRJbmRleCA9IDAsCgkJaW5wdXRMZW5ndGggPSBpbnB1dC5sZW5ndGgsCgkJa2V5LAoJCXZhbHVlOwoJZm9yICggOyBpbnB1dEluZGV4IDwgaW5wdXRMZW5ndGg7IGlucHV0SW5kZXgrKyApIHsKCQlmb3IgKCBrZXkgaW4gaW5wdXRbIGlucHV0SW5kZXggXSApIHsKCQkJdmFsdWUgPSBpbnB1dFsgaW5wdXRJbmRleCBdWyBrZXkgXTsKCQkJaWYgKCBpbnB1dFsgaW5wdXRJbmRleCBdLmhhc093blByb3BlcnR5KCBrZXkgKSAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJLy8gQ2xvbmUgb2JqZWN0cwoJCQkJaWYgKCAkLmlzUGxhaW5PYmplY3QoIHZhbHVlICkgKSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9ICQuaXNQbGFpbk9iamVjdCggdGFyZ2V0WyBrZXkgXSApID8KCQkJCQkJJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGFyZ2V0WyBrZXkgXSwgdmFsdWUgKSA6CgkJCQkJCS8vIERvbid0IGV4dGVuZCBzdHJpbmdzLCBhcnJheXMsIGV0Yy4gd2l0aCBvYmplY3RzCgkJCQkJCSQud2lkZ2V0LmV4dGVuZCgge30sIHZhbHVlICk7CgkJCQkvLyBDb3B5IGV2ZXJ5dGhpbmcgZWxzZSBieSByZWZlcmVuY2UKCQkJCX0gZWxzZSB7CgkJCQkJdGFyZ2V0WyBrZXkgXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoJfQoJcmV0dXJuIHRhcmdldDsKfTsKCiQud2lkZ2V0LmJyaWRnZSA9IGZ1bmN0aW9uKCBuYW1lLCBvYmplY3QgKSB7Cgl2YXIgZnVsbE5hbWUgPSBvYmplY3QucHJvdG90eXBlLndpZGdldEZ1bGxOYW1lIHx8IG5hbWU7CgkkLmZuWyBuYW1lIF0gPSBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNNZXRob2RDYWxsID0gdHlwZW9mIG9wdGlvbnMgPT09ICJzdHJpbmciLAoJCQlhcmdzID0gc2xpY2UuY2FsbCggYXJndW1lbnRzLCAxICksCgkJCXJldHVyblZhbHVlID0gdGhpczsKCgkJLy8gYWxsb3cgbXVsdGlwbGUgaGFzaGVzIHRvIGJlIHBhc3NlZCBvbiBpbml0CgkJb3B0aW9ucyA9ICFpc01ldGhvZENhbGwgJiYgYXJncy5sZW5ndGggPwoJCQkkLndpZGdldC5leHRlbmQuYXBwbHkoIG51bGwsIFsgb3B0aW9ucyBdLmNvbmNhdChhcmdzKSApIDoKCQkJb3B0aW9uczsKCgkJaWYgKCBpc01ldGhvZENhbGwgKSB7CgkJCXRoaXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBtZXRob2RWYWx1ZSwKCQkJCQlpbnN0YW5jZSA9ICQuZGF0YSggdGhpcywgZnVsbE5hbWUgKTsKCQkJCWlmICggb3B0aW9ucyA9PT0gImluc3RhbmNlIiApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IGluc3RhbmNlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJCWlmICggIWluc3RhbmNlICkgewoJCQkJCXJldHVybiAkLmVycm9yKCAiY2Fubm90IGNhbGwgbWV0aG9kcyBvbiAiICsgbmFtZSArICIgcHJpb3IgdG8gaW5pdGlhbGl6YXRpb247ICIgKwoJCQkJCQkiYXR0ZW1wdGVkIHRvIGNhbGwgbWV0aG9kICciICsgb3B0aW9ucyArICInIiApOwoJCQkJfQoJCQkJaWYgKCAhJC5pc0Z1bmN0aW9uKCBpbnN0YW5jZVtvcHRpb25zXSApIHx8IG9wdGlvbnMuY2hhckF0KCAwICkgPT09ICJfIiApIHsKCQkJCQlyZXR1cm4gJC5lcnJvciggIm5vIHN1Y2ggbWV0aG9kICciICsgb3B0aW9ucyArICInIGZvciAiICsgbmFtZSArICIgd2lkZ2V0IGluc3RhbmNlIiApOwoJCQkJfQoJCQkJbWV0aG9kVmFsdWUgPSBpbnN0YW5jZVsgb3B0aW9ucyBdLmFwcGx5KCBpbnN0YW5jZSwgYXJncyApOwoJCQkJaWYgKCBtZXRob2RWYWx1ZSAhPT0gaW5zdGFuY2UgJiYgbWV0aG9kVmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm5WYWx1ZSA9IG1ldGhvZFZhbHVlICYmIG1ldGhvZFZhbHVlLmpxdWVyeSA/CgkJCQkJCXJldHVyblZhbHVlLnB1c2hTdGFjayggbWV0aG9kVmFsdWUuZ2V0KCkgKSA6CgkJCQkJCW1ldGhvZFZhbHVlOwoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCQkJfSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGluc3RhbmNlID0gJC5kYXRhKCB0aGlzLCBmdWxsTmFtZSApOwoJCQkJaWYgKCBpbnN0YW5jZSApIHsKCQkJCQlpbnN0YW5jZS5vcHRpb24oIG9wdGlvbnMgfHwge30gKS5faW5pdCgpOwoJCQkJfSBlbHNlIHsKCQkJCQkkLmRhdGEoIHRoaXMsIGZ1bGxOYW1lLCBuZXcgb2JqZWN0KCBvcHRpb25zLCB0aGlzICkgKTsKCQkJCX0KCQkJfSk7CgkJfQoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9Owp9OwoKJC5XaWRnZXQgPSBmdW5jdGlvbiggLyogb3B0aW9ucywgZWxlbWVudCAqLyApIHt9OwokLldpZGdldC5fY2hpbGRDb25zdHJ1Y3RvcnMgPSBbXTsKCiQuV2lkZ2V0LnByb3RvdHlwZSA9IHsKCXdpZGdldE5hbWU6ICJ3aWRnZXQiLAoJd2lkZ2V0RXZlbnRQcmVmaXg6ICIiLAoJZGVmYXVsdEVsZW1lbnQ6ICI8ZGl2PiIsCglvcHRpb25zOiB7CgkJZGlzYWJsZWQ6IGZhbHNlLAoKCQkvLyBjYWxsYmFja3MKCQljcmVhdGU6IG51bGwKCX0sCglfY3JlYXRlV2lkZ2V0OiBmdW5jdGlvbiggb3B0aW9ucywgZWxlbWVudCApIHsKCQllbGVtZW50ID0gJCggZWxlbWVudCB8fCB0aGlzLmRlZmF1bHRFbGVtZW50IHx8IHRoaXMgKVsgMCBdOwoJCXRoaXMuZWxlbWVudCA9ICQoIGVsZW1lbnQgKTsKCQl0aGlzLnV1aWQgPSB1dWlkKys7CgkJdGhpcy5ldmVudE5hbWVzcGFjZSA9ICIuIiArIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZDsKCQl0aGlzLm9wdGlvbnMgPSAkLndpZGdldC5leHRlbmQoIHt9LAoJCQl0aGlzLm9wdGlvbnMsCgkJCXRoaXMuX2dldENyZWF0ZU9wdGlvbnMoKSwKCQkJb3B0aW9ucyApOwoKCQl0aGlzLmJpbmRpbmdzID0gJCgpOwoJCXRoaXMuaG92ZXJhYmxlID0gJCgpOwoJCXRoaXMuZm9jdXNhYmxlID0gJCgpOwoKCQlpZiAoIGVsZW1lbnQgIT09IHRoaXMgKSB7CgkJCSQuZGF0YSggZWxlbWVudCwgdGhpcy53aWRnZXRGdWxsTmFtZSwgdGhpcyApOwoJCQl0aGlzLl9vbiggdHJ1ZSwgdGhpcy5lbGVtZW50LCB7CgkJCQlyZW1vdmU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCQlpZiAoIGV2ZW50LnRhcmdldCA9PT0gZWxlbWVudCApIHsKCQkJCQkJdGhpcy5kZXN0cm95KCk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCQkJdGhpcy5kb2N1bWVudCA9ICQoIGVsZW1lbnQuc3R5bGUgPwoJCQkJLy8gZWxlbWVudCB3aXRoaW4gdGhlIGRvY3VtZW50CgkJCQllbGVtZW50Lm93bmVyRG9jdW1lbnQgOgoJCQkJLy8gZWxlbWVudCBpcyB3aW5kb3cgb3IgZG9jdW1lbnQKCQkJCWVsZW1lbnQuZG9jdW1lbnQgfHwgZWxlbWVudCApOwoJCQl0aGlzLndpbmRvdyA9ICQoIHRoaXMuZG9jdW1lbnRbMF0uZGVmYXVsdFZpZXcgfHwgdGhpcy5kb2N1bWVudFswXS5wYXJlbnRXaW5kb3cgKTsKCQl9CgoJCXRoaXMuX2NyZWF0ZSgpOwoJCXRoaXMuX3RyaWdnZXIoICJjcmVhdGUiLCBudWxsLCB0aGlzLl9nZXRDcmVhdGVFdmVudERhdGEoKSApOwoJCXRoaXMuX2luaXQoKTsKCX0sCglfZ2V0Q3JlYXRlT3B0aW9uczogJC5ub29wLAoJX2dldENyZWF0ZUV2ZW50RGF0YTogJC5ub29wLAoJX2NyZWF0ZTogJC5ub29wLAoJX2luaXQ6ICQubm9vcCwKCglkZXN0cm95OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9kZXN0cm95KCk7CgkJLy8gd2UgY2FuIHByb2JhYmx5IHJlbW92ZSB0aGUgdW5iaW5kIGNhbGxzIGluIDIuMAoJCS8vIGFsbCBldmVudCBiaW5kaW5ncyBzaG91bGQgZ28gdGhyb3VnaCB0aGlzLl9vbigpCgkJdGhpcy5lbGVtZW50CgkJCS51bmJpbmQoIHRoaXMuZXZlbnROYW1lc3BhY2UgKQoJCQkucmVtb3ZlRGF0YSggdGhpcy53aWRnZXRGdWxsTmFtZSApCgkJCS8vIHN1cHBvcnQ6IGpxdWVyeSA8MS42LjMKCQkJLy8gaHR0cDovL2J1Z3MuanF1ZXJ5LmNvbS90aWNrZXQvOTQxMwoJCQkucmVtb3ZlRGF0YSggJC5jYW1lbENhc2UoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKSApOwoJCXRoaXMud2lkZ2V0KCkKCQkJLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApCgkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKQoJCQkucmVtb3ZlQ2xhc3MoCgkJCQl0aGlzLndpZGdldEZ1bGxOYW1lICsgIi1kaXNhYmxlZCAiICsKCQkJCSJ1aS1zdGF0ZS1kaXNhYmxlZCIgKTsKCgkJLy8gY2xlYW4gdXAgZXZlbnRzIGFuZCBzdGF0ZXMKCQl0aGlzLmJpbmRpbmdzLnVuYmluZCggdGhpcy5ldmVudE5hbWVzcGFjZSApOwoJCXRoaXMuaG92ZXJhYmxlLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJdGhpcy5mb2N1c2FibGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCX0sCglfZGVzdHJveTogJC5ub29wLAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZWxlbWVudDsKCX0sCgoJb3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl2YXIgb3B0aW9ucyA9IGtleSwKCQkJcGFydHMsCgkJCWN1ck9wdGlvbiwKCQkJaTsKCgkJaWYgKCBhcmd1bWVudHMubGVuZ3RoID09PSAwICkgewoJCQkvLyBkb24ndCByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIGludGVybmFsIGhhc2gKCQkJcmV0dXJuICQud2lkZ2V0LmV4dGVuZCgge30sIHRoaXMub3B0aW9ucyApOwoJCX0KCgkJaWYgKCB0eXBlb2Yga2V5ID09PSAic3RyaW5nIiApIHsKCQkJLy8gaGFuZGxlIG5lc3RlZCBrZXlzLCBlLmcuLCAiZm9vLmJhciIgPT4geyBmb286IHsgYmFyOiBfX18gfSB9CgkJCW9wdGlvbnMgPSB7fTsKCQkJcGFydHMgPSBrZXkuc3BsaXQoICIuIiApOwoJCQlrZXkgPSBwYXJ0cy5zaGlmdCgpOwoJCQlpZiAoIHBhcnRzLmxlbmd0aCApIHsKCQkJCWN1ck9wdGlvbiA9IG9wdGlvbnNbIGtleSBdID0gJC53aWRnZXQuZXh0ZW5kKCB7fSwgdGhpcy5vcHRpb25zWyBrZXkgXSApOwoJCQkJZm9yICggaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGggLSAxOyBpKysgKSB7CgkJCQkJY3VyT3B0aW9uWyBwYXJ0c1sgaSBdIF0gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXSB8fCB7fTsKCQkJCQljdXJPcHRpb24gPSBjdXJPcHRpb25bIHBhcnRzWyBpIF0gXTsKCQkJCX0KCQkJCWtleSA9IHBhcnRzLnBvcCgpOwoJCQkJaWYgKCB2YWx1ZSA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXJldHVybiBjdXJPcHRpb25bIGtleSBdID09PSB1bmRlZmluZWQgPyBudWxsIDogY3VyT3B0aW9uWyBrZXkgXTsKCQkJCX0KCQkJCWN1ck9wdGlvblsga2V5IF0gPSB2YWx1ZTsKCQkJfSBlbHNlIHsKCQkJCWlmICggdmFsdWUgPT09IHVuZGVmaW5lZCApIHsKCQkJCQlyZXR1cm4gdGhpcy5vcHRpb25zWyBrZXkgXSA9PT0gdW5kZWZpbmVkID8gbnVsbCA6IHRoaXMub3B0aW9uc1sga2V5IF07CgkJCQl9CgkJCQlvcHRpb25zWyBrZXkgXSA9IHZhbHVlOwoJCQl9CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCXJldHVybiB0aGlzOwoJfSwKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIga2V5OwoKCQlmb3IgKCBrZXkgaW4gb3B0aW9ucyApIHsKCQkJdGhpcy5fc2V0T3B0aW9uKCBrZXksIG9wdGlvbnNbIGtleSBdICk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0sCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLm9wdGlvbnNbIGtleSBdID0gdmFsdWU7CgoJCWlmICgga2V5ID09PSAiZGlzYWJsZWQiICkgewoJCQl0aGlzLndpZGdldCgpCgkJCQkudG9nZ2xlQ2xhc3MoIHRoaXMud2lkZ2V0RnVsbE5hbWUgKyAiLWRpc2FibGVkIiwgISF2YWx1ZSApOwoJCQl0aGlzLmhvdmVyYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWhvdmVyIiApOwoJCQl0aGlzLmZvY3VzYWJsZS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVuYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogZmFsc2UgfSk7Cgl9LAoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbnMoeyBkaXNhYmxlZDogdHJ1ZSB9KTsKCX0sCgoJX29uOiBmdW5jdGlvbiggc3VwcHJlc3NEaXNhYmxlZENoZWNrLCBlbGVtZW50LCBoYW5kbGVycyApIHsKCQl2YXIgZGVsZWdhdGVFbGVtZW50LAoJCQlpbnN0YW5jZSA9IHRoaXM7CgoJCS8vIG5vIHN1cHByZXNzRGlzYWJsZWRDaGVjayBmbGFnLCBzaHVmZmxlIGFyZ3VtZW50cwoJCWlmICggdHlwZW9mIHN1cHByZXNzRGlzYWJsZWRDaGVjayAhPT0gImJvb2xlYW4iICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSBzdXBwcmVzc0Rpc2FibGVkQ2hlY2s7CgkJCXN1cHByZXNzRGlzYWJsZWRDaGVjayA9IGZhbHNlOwoJCX0KCgkJLy8gbm8gZWxlbWVudCBhcmd1bWVudCwgc2h1ZmZsZSBhbmQgdXNlIHRoaXMuZWxlbWVudAoJCWlmICggIWhhbmRsZXJzICkgewoJCQloYW5kbGVycyA9IGVsZW1lbnQ7CgkJCWVsZW1lbnQgPSB0aGlzLmVsZW1lbnQ7CgkJCWRlbGVnYXRlRWxlbWVudCA9IHRoaXMud2lkZ2V0KCk7CgkJfSBlbHNlIHsKCQkJLy8gYWNjZXB0IHNlbGVjdG9ycywgRE9NIGVsZW1lbnRzCgkJCWVsZW1lbnQgPSBkZWxlZ2F0ZUVsZW1lbnQgPSAkKCBlbGVtZW50ICk7CgkJCXRoaXMuYmluZGluZ3MgPSB0aGlzLmJpbmRpbmdzLmFkZCggZWxlbWVudCApOwoJCX0KCgkJJC5lYWNoKCBoYW5kbGVycywgZnVuY3Rpb24oIGV2ZW50LCBoYW5kbGVyICkgewoJCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCQkvLyBhbGxvdyB3aWRnZXRzIHRvIGN1c3RvbWl6ZSB0aGUgZGlzYWJsZWQgaGFuZGxpbmcKCQkJCS8vIC0gZGlzYWJsZWQgYXMgYW4gYXJyYXkgaW5zdGVhZCBvZiBib29sZWFuCgkJCQkvLyAtIGRpc2FibGVkIGNsYXNzIGFzIG1ldGhvZCBmb3IgZGlzYWJsaW5nIGluZGl2aWR1YWwgcGFydHMKCQkJCWlmICggIXN1cHByZXNzRGlzYWJsZWRDaGVjayAmJgoJCQkJCQkoIGluc3RhbmNlLm9wdGlvbnMuZGlzYWJsZWQgPT09IHRydWUgfHwKCQkJCQkJCSQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJcmV0dXJuICggdHlwZW9mIGhhbmRsZXIgPT09ICJzdHJpbmciID8gaW5zdGFuY2VbIGhhbmRsZXIgXSA6IGhhbmRsZXIgKQoJCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCQl9CgoJCQkvLyBjb3B5IHRoZSBndWlkIHNvIGRpcmVjdCB1bmJpbmRpbmcgd29ya3MKCQkJaWYgKCB0eXBlb2YgaGFuZGxlciAhPT0gInN0cmluZyIgKSB7CgkJCQloYW5kbGVyUHJveHkuZ3VpZCA9IGhhbmRsZXIuZ3VpZCA9CgkJCQkJaGFuZGxlci5ndWlkIHx8IGhhbmRsZXJQcm94eS5ndWlkIHx8ICQuZ3VpZCsrOwoJCQl9CgoJCQl2YXIgbWF0Y2ggPSBldmVudC5tYXRjaCggL14oXHcrKVxzKiguKikkLyApLAoJCQkJZXZlbnROYW1lID0gbWF0Y2hbMV0gKyBpbnN0YW5jZS5ldmVudE5hbWVzcGFjZSwKCQkJCXNlbGVjdG9yID0gbWF0Y2hbMl07CgkJCWlmICggc2VsZWN0b3IgKSB7CgkJCQlkZWxlZ2F0ZUVsZW1lbnQuZGVsZWdhdGUoIHNlbGVjdG9yLCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9IGVsc2UgewoJCQkJZWxlbWVudC5iaW5kKCBldmVudE5hbWUsIGhhbmRsZXJQcm94eSApOwoJCQl9CgkJfSk7Cgl9LAoKCV9vZmY6IGZ1bmN0aW9uKCBlbGVtZW50LCBldmVudE5hbWUgKSB7CgkJZXZlbnROYW1lID0gKGV2ZW50TmFtZSB8fCAiIikuc3BsaXQoICIgIiApLmpvaW4oIHRoaXMuZXZlbnROYW1lc3BhY2UgKyAiICIgKSArIHRoaXMuZXZlbnROYW1lc3BhY2U7CgkJZWxlbWVudC51bmJpbmQoIGV2ZW50TmFtZSApLnVuZGVsZWdhdGUoIGV2ZW50TmFtZSApOwoJfSwKCglfZGVsYXk6IGZ1bmN0aW9uKCBoYW5kbGVyLCBkZWxheSApIHsKCQlmdW5jdGlvbiBoYW5kbGVyUHJveHkoKSB7CgkJCXJldHVybiAoIHR5cGVvZiBoYW5kbGVyID09PSAic3RyaW5nIiA/IGluc3RhbmNlWyBoYW5kbGVyIF0gOiBoYW5kbGVyICkKCQkJCS5hcHBseSggaW5zdGFuY2UsIGFyZ3VtZW50cyApOwoJCX0KCQl2YXIgaW5zdGFuY2UgPSB0aGlzOwoJCXJldHVybiBzZXRUaW1lb3V0KCBoYW5kbGVyUHJveHksIGRlbGF5IHx8IDAgKTsKCX0sCgoJX2hvdmVyYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5ob3ZlcmFibGUgPSB0aGlzLmhvdmVyYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQltb3VzZWVudGVyOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1ob3ZlciIgKTsKCQkJfSwKCQkJbW91c2VsZWF2ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJJCggZXZlbnQuY3VycmVudFRhcmdldCApLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtaG92ZXIiICk7CgkJCX0KCQl9KTsKCX0sCgoJX2ZvY3VzYWJsZTogZnVuY3Rpb24oIGVsZW1lbnQgKSB7CgkJdGhpcy5mb2N1c2FibGUgPSB0aGlzLmZvY3VzYWJsZS5hZGQoIGVsZW1lbnQgKTsKCQl0aGlzLl9vbiggZWxlbWVudCwgewoJCQlmb2N1c2luOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkkKCBldmVudC5jdXJyZW50VGFyZ2V0ICkuYWRkQ2xhc3MoICJ1aS1zdGF0ZS1mb2N1cyIgKTsKCQkJfSwKCQkJZm9jdXNvdXQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCSQoIGV2ZW50LmN1cnJlbnRUYXJnZXQgKS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWZvY3VzIiApOwoJCQl9CgkJfSk7Cgl9LAoKCV90cmlnZ2VyOiBmdW5jdGlvbiggdHlwZSwgZXZlbnQsIGRhdGEgKSB7CgkJdmFyIHByb3AsIG9yaWcsCgkJCWNhbGxiYWNrID0gdGhpcy5vcHRpb25zWyB0eXBlIF07CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoJCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCQlldmVudC50eXBlID0gKCB0eXBlID09PSB0aGlzLndpZGdldEV2ZW50UHJlZml4ID8KCQkJdHlwZSA6CgkJCXRoaXMud2lkZ2V0RXZlbnRQcmVmaXggKyB0eXBlICkudG9Mb3dlckNhc2UoKTsKCQkvLyB0aGUgb3JpZ2luYWwgZXZlbnQgbWF5IGNvbWUgZnJvbSBhbnkgZWxlbWVudAoJCS8vIHNvIHdlIG5lZWQgdG8gcmVzZXQgdGhlIHRhcmdldCBvbiB0aGUgbmV3IGV2ZW50CgkJZXZlbnQudGFyZ2V0ID0gdGhpcy5lbGVtZW50WyAwIF07CgoJCS8vIGNvcHkgb3JpZ2luYWwgZXZlbnQgcHJvcGVydGllcyBvdmVyIHRvIHRoZSBuZXcgZXZlbnQKCQlvcmlnID0gZXZlbnQub3JpZ2luYWxFdmVudDsKCQlpZiAoIG9yaWcgKSB7CgkJCWZvciAoIHByb3AgaW4gb3JpZyApIHsKCQkJCWlmICggISggcHJvcCBpbiBldmVudCApICkgewoJCQkJCWV2ZW50WyBwcm9wIF0gPSBvcmlnWyBwcm9wIF07CgkJCQl9CgkJCX0KCQl9CgoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBldmVudCwgZGF0YSApOwoJCXJldHVybiAhKCAkLmlzRnVuY3Rpb24oIGNhbGxiYWNrICkgJiYKCQkJY2FsbGJhY2suYXBwbHkoIHRoaXMuZWxlbWVudFswXSwgWyBldmVudCBdLmNvbmNhdCggZGF0YSApICkgPT09IGZhbHNlIHx8CgkJCWV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICk7Cgl9Cn07CgokLmVhY2goIHsgc2hvdzogImZhZGVJbiIsIGhpZGU6ICJmYWRlT3V0IiB9LCBmdW5jdGlvbiggbWV0aG9kLCBkZWZhdWx0RWZmZWN0ICkgewoJJC5XaWRnZXQucHJvdG90eXBlWyAiXyIgKyBtZXRob2QgXSA9IGZ1bmN0aW9uKCBlbGVtZW50LCBvcHRpb25zLCBjYWxsYmFjayApIHsKCQlpZiAoIHR5cGVvZiBvcHRpb25zID09PSAic3RyaW5nIiApIHsKCQkJb3B0aW9ucyA9IHsgZWZmZWN0OiBvcHRpb25zIH07CgkJfQoJCXZhciBoYXNPcHRpb25zLAoJCQllZmZlY3ROYW1lID0gIW9wdGlvbnMgPwoJCQkJbWV0aG9kIDoKCQkJCW9wdGlvbnMgPT09IHRydWUgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiID8KCQkJCQlkZWZhdWx0RWZmZWN0IDoKCQkJCQlvcHRpb25zLmVmZmVjdCB8fCBkZWZhdWx0RWZmZWN0OwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCWlmICggdHlwZW9mIG9wdGlvbnMgPT09ICJudW1iZXIiICkgewoJCQlvcHRpb25zID0geyBkdXJhdGlvbjogb3B0aW9ucyB9OwoJCX0KCQloYXNPcHRpb25zID0gISQuaXNFbXB0eU9iamVjdCggb3B0aW9ucyApOwoJCW9wdGlvbnMuY29tcGxldGUgPSBjYWxsYmFjazsKCQlpZiAoIG9wdGlvbnMuZGVsYXkgKSB7CgkJCWVsZW1lbnQuZGVsYXkoIG9wdGlvbnMuZGVsYXkgKTsKCQl9CgkJaWYgKCBoYXNPcHRpb25zICYmICQuZWZmZWN0cyAmJiAkLmVmZmVjdHMuZWZmZWN0WyBlZmZlY3ROYW1lIF0gKSB7CgkJCWVsZW1lbnRbIG1ldGhvZCBdKCBvcHRpb25zICk7CgkJfSBlbHNlIGlmICggZWZmZWN0TmFtZSAhPT0gbWV0aG9kICYmIGVsZW1lbnRbIGVmZmVjdE5hbWUgXSApIHsKCQkJZWxlbWVudFsgZWZmZWN0TmFtZSBdKCBvcHRpb25zLmR1cmF0aW9uLCBvcHRpb25zLmVhc2luZywgY2FsbGJhY2sgKTsKCQl9IGVsc2UgewoJCQllbGVtZW50LnF1ZXVlKGZ1bmN0aW9uKCBuZXh0ICkgewoJCQkJJCggdGhpcyApWyBtZXRob2QgXSgpOwoJCQkJaWYgKCBjYWxsYmFjayApIHsKCQkJCQljYWxsYmFjay5jYWxsKCBlbGVtZW50WyAwIF0gKTsKCQkJCX0KCQkJCW5leHQoKTsKCQkJfSk7CgkJfQoJfTsKfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByY2FwaXRhbHMgPSAvW0EtWl0vZywKCXJlcGxhY2VGdW5jdGlvbiA9IGZ1bmN0aW9uKCBjICkgewoJCXJldHVybiAiLSIgKyBjLnRvTG93ZXJDYXNlKCk7Cgl9OwoKJC5leHRlbmQoICQuV2lkZ2V0LnByb3RvdHlwZSwgewoJX2dldENyZWF0ZU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb24sIHZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50WyAwIF0sCgkJCW9wdGlvbnMgPSB7fTsKCgkJLy8KCQlpZiAoICEkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGVsZW0sICJkZWZhdWx0cyIgKSApIHsKCQkJZm9yICggb3B0aW9uIGluIHRoaXMub3B0aW9ucyApIHsKCQkJCXZhbHVlID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBlbGVtLCBvcHRpb24ucmVwbGFjZSggcmNhcGl0YWxzLCByZXBsYWNlRnVuY3Rpb24gKSApOwoKCQkJCWlmICggdmFsdWUgIT0gbnVsbCApIHsKCQkJCQlvcHRpb25zWyBvcHRpb24gXSA9IHZhbHVlOwoJCQkJfQoJCQl9CgkJfQoKCQlyZXR1cm4gb3B0aW9uczsKCX0KfSk7CgovL1RPRE86IFJlbW92ZSBpbiAxLjUgZm9yIGJhY2tjb21wYXQgb25seQokLm1vYmlsZS53aWRnZXQgPSAkLldpZGdldDsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgkvLyBUT0RPIG1vdmUgbG9hZGVyIGNsYXNzIGRvd24gaW50byB0aGUgd2lkZ2V0IHNldHRpbmdzCgl2YXIgbG9hZGVyQ2xhc3MgPSAidWktbG9hZGVyIiwgJGh0bWwgPSAkKCAiaHRtbCIgKTsKCgkkLndpZGdldCggIm1vYmlsZS5sb2FkZXIiLCB7CgkJLy8gTk9URSBpZiB0aGUgZ2xvYmFsIGNvbmZpZyBzZXR0aW5ncyBhcmUgZGVmaW5lZCB0aGV5IHdpbGwgb3ZlcnJpZGUgdGhlc2UKCQkvLyAgICAgIG9wdGlvbnMKCQlvcHRpb25zOiB7CgkJCS8vIHRoZSB0aGVtZSBmb3IgdGhlIGxvYWRpbmcgbWVzc2FnZQoJCQl0aGVtZTogImEiLAoKCQkJLy8gd2hldGhlciB0aGUgdGV4dCBpbiB0aGUgbG9hZGluZyBtZXNzYWdlIGlzIHNob3duCgkJCXRleHRWaXNpYmxlOiBmYWxzZSwKCgkJCS8vIGN1c3RvbSBodG1sIGZvciB0aGUgaW5uZXIgY29udGVudCBvZiB0aGUgbG9hZGluZyBtZXNzYWdlCgkJCWh0bWw6ICIiLAoKCQkJLy8gdGhlIHRleHQgdG8gYmUgZGlzcGxheWVkIHdoZW4gdGhlIHBvcHVwIGlzIHNob3duCgkJCXRleHQ6ICJsb2FkaW5nIgoJCX0sCgoJCWRlZmF1bHRIdG1sOiAiPGRpdiBjbGFzcz0nIiArIGxvYWRlckNsYXNzICsgIic+IiArCgkJCSI8c3BhbiBjbGFzcz0ndWktaWNvbi1sb2FkaW5nJz48L3NwYW4+IiArCgkJCSI8aDE+PC9oMT4iICsKCQkJIjwvZGl2PiIsCgoJCS8vIEZvciBub24tZml4ZWQgc3VwcG9ydGluIGJyb3dzZXJzLiBQb3NpdGlvbiBhdCB5IGNlbnRlciAoaWYgc2Nyb2xsVG9wIHN1cHBvcnRlZCksIGFib3ZlIHRoZSBhY3RpdmVCdG4gKGlmIGRlZmluZWQpLCBvciBqdXN0IDEwMHB4IGZyb20gdG9wCgkJZmFrZUZpeExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXZhciBhY3RpdmVCdG4gPSAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApLmZpcnN0KCk7CgoJCQl0aGlzLmVsZW1lbnQKCQkJCS5jc3MoewoJCQkJCXRvcDogJC5zdXBwb3J0LnNjcm9sbFRvcCAmJiB0aGlzLndpbmRvdy5zY3JvbGxUb3AoKSArIHRoaXMud2luZG93LmhlaWdodCgpIC8gMiB8fAoJCQkJCQlhY3RpdmVCdG4ubGVuZ3RoICYmIGFjdGl2ZUJ0bi5vZmZzZXQoKS50b3AgfHwgMTAwCgkJCQl9KTsKCQl9LAoKCQkvLyBjaGVjayBwb3NpdGlvbiBvZiBsb2FkZXIgdG8gc2VlIGlmIGl0IGFwcGVhcnMgdG8gYmUgImZpeGVkIiB0byBjZW50ZXIKCQkvLyBpZiBub3QsIHVzZSBhYnMgcG9zaXRpb25pbmcKCQljaGVja0xvYWRlclBvc2l0aW9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIG9mZnNldCA9IHRoaXMuZWxlbWVudC5vZmZzZXQoKSwKCQkJCXNjcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlpZiAoIG9mZnNldC50b3AgPCBzY3JvbGxUb3AgfHwgKCBvZmZzZXQudG9wIC0gc2Nyb2xsVG9wICkgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoICJ1aS1sb2FkZXItZmFrZWZpeCIgKTsKCQkJCXRoaXMuZmFrZUZpeExvYWRlcigpOwoJCQkJdGhpcy53aW5kb3cKCQkJCQkudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uICkKCQkJCQkuYmluZCggInNjcm9sbCIsICQucHJveHkoIHRoaXMuZmFrZUZpeExvYWRlciwgdGhpcyApICk7CgkJCX0KCQl9LAoKCQlyZXNldEh0bWw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuaHRtbCggJCggdGhpcy5kZWZhdWx0SHRtbCApLmh0bWwoKSApOwoJCX0sCgoJCS8vIFR1cm4gb24vb2ZmIHBhZ2UgbG9hZGluZyBtZXNzYWdlLiBUaGVtZSBkb3VibGVzIGFzIGFuIG9iamVjdCBhcmd1bWVudAoJCS8vIHdpdGggdGhlIGZvbGxvd2luZyBzaGFwZTogeyB0aGVtZTogJycsIHRleHQ6ICcnLCBodG1sOiAnJywgdGV4dFZpc2libGU6ICcnIH0KCQkvLyBOT1RFIHRoYXQgdGhlICQubW9iaWxlLmxvYWRpbmcqIHNldHRpbmdzIGFuZCBwYXJhbXMgcGFzdCB0aGUgZmlyc3QgYXJlIGRlcHJlY2F0ZWQKCQkvLyBUT0RPIHN3ZWV0IGplc3VzIHdlIG5lZWQgdG8gYnJlYWsgc29tZSBvZiB0aGlzIG91dAoJCXNob3c6IGZ1bmN0aW9uKCB0aGVtZSwgbXNnVGV4dCwgdGV4dG9ubHkgKSB7CgkJCXZhciB0ZXh0VmlzaWJsZSwgbWVzc2FnZSwgbG9hZFNldHRpbmdzOwoKCQkJdGhpcy5yZXNldEh0bWwoKTsKCgkJCS8vIHVzZSB0aGUgcHJvdG90eXBlIG9wdGlvbnMgc28gdGhhdCBwZW9wbGUgY2FuIHNldCB0aGVtIGdsb2JhbGx5IGF0CgkJCS8vIG1vYmlsZSBpbml0LiBDb25zaXN0ZW5jeSwgaXQncyB3aGF0J3MgZm9yIGRpbm5lcgoJCQlpZiAoICQudHlwZSggdGhlbWUgKSA9PT0gIm9iamVjdCIgKSB7CgkJCQlsb2FkU2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgdGhlbWUgKTsKCgkJCQl0aGVtZSA9IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfSBlbHNlIHsKCQkJCWxvYWRTZXR0aW5ncyA9IHRoaXMub3B0aW9uczsKCgkJCQkvLyBoZXJlIHdlIHByZWZlciB0aGUgdGhlbWUgdmFsdWUgcGFzc2VkIGFzIGEgc3RyaW5nIGFyZ3VtZW50LCB0aGVuCgkJCQkvLyB3ZSBwcmVmZXIgdGhlIGdsb2JhbCBvcHRpb24gYmVjYXVzZSB3ZSBjYW4ndCB1c2UgdW5kZWZpbmVkIGRlZmF1bHQKCQkJCS8vIHByb3RvdHlwZSBvcHRpb25zLCB0aGVuIHRoZSBwcm90b3R5cGUgb3B0aW9uCgkJCQl0aGVtZSA9IHRoZW1lIHx8IGxvYWRTZXR0aW5ncy50aGVtZTsKCQkJfQoKCQkJLy8gc2V0IHRoZSBtZXNzYWdlIHRleHQsIHByZWZlciB0aGUgcGFyYW0sIHRoZW4gdGhlIHNldHRpbmdzIG9iamVjdAoJCQkvLyB0aGVuIGxvYWRpbmcgbWVzc2FnZQoJCQltZXNzYWdlID0gbXNnVGV4dCB8fCAoIGxvYWRTZXR0aW5ncy50ZXh0ID09PSBmYWxzZSA/ICIiIDogbG9hZFNldHRpbmdzLnRleHQgKTsKCgkJCS8vIHByZXBhcmUgdGhlIGRvbQoJCQkkaHRtbC5hZGRDbGFzcyggInVpLWxvYWRpbmciICk7CgoJCQl0ZXh0VmlzaWJsZSA9IGxvYWRTZXR0aW5ncy50ZXh0VmlzaWJsZTsKCgkJCS8vIGFkZCB0aGUgcHJvcGVyIGNzcyBnaXZlbiB0aGUgb3B0aW9ucyAodGhlbWUsIHRleHQsIGV0YykKCQkJLy8gRm9yY2UgdGV4dCB2aXNpYmlsaXR5IGlmIHRoZSBzZWNvbmQgYXJndW1lbnQgd2FzIHN1cHBsaWVkLCBvcgoJCQkvLyBpZiB0aGUgdGV4dCB3YXMgZXhwbGljaXRseSBzZXQgaW4gdGhlIG9iamVjdCBhcmdzCgkJCXRoaXMuZWxlbWVudC5hdHRyKCJjbGFzcyIsIGxvYWRlckNsYXNzICsKCQkJCSIgdWktY29ybmVyLWFsbCB1aS1ib2R5LSIgKyB0aGVtZSArCgkJCQkiIHVpLWxvYWRlci0iICsgKCB0ZXh0VmlzaWJsZSB8fCBtc2dUZXh0IHx8IHRoZW1lLnRleHQgPyAidmVyYm9zZSIgOiAiZGVmYXVsdCIgKSArCgkJCQkoIGxvYWRTZXR0aW5ncy50ZXh0b25seSB8fCB0ZXh0b25seSA/ICIgdWktbG9hZGVyLXRleHRvbmx5IiA6ICIiICkgKTsKCgkJCS8vIFRPRE8gdmVyaWZ5IHRoYXQganF1ZXJ5LmZuLmh0bWwgaXMgb2sgdG8gdXNlIGluIGJvdGggY2FzZXMgaGVyZQoJCQkvLyAgICAgIHRoaXMgbWlnaHQgYmUgb3Zlcmx5IGRlZmVuc2l2ZSBpbiBwcmV2ZW50aW5nIHVua25vd2luZyB4c3MKCQkJLy8gaWYgdGhlIGh0bWwgYXR0cmlidXRlIGlzIGRlZmluZWQgb24gdGhlIGxvYWRpbmcgc2V0dGluZ3MsIHVzZSB0aGF0CgkJCS8vIG90aGVyd2lzZSB1c2UgdGhlIGZhbGxiYWNrcyBmcm9tIGFib3ZlCgkJCWlmICggbG9hZFNldHRpbmdzLmh0bWwgKSB7CgkJCQl0aGlzLmVsZW1lbnQuaHRtbCggbG9hZFNldHRpbmdzLmh0bWwgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiaDEiICkudGV4dCggbWVzc2FnZSApOwoJCQl9CgoJCQkvLyBhdHRhY2ggdGhlIGxvYWRlciB0byB0aGUgRE9NCgkJCXRoaXMuZWxlbWVudC5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApOwoKCQkJLy8gY2hlY2sgdGhhdCB0aGUgbG9hZGVyIGlzIHZpc2libGUKCQkJdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uKCk7CgoJCQkvLyBvbiBzY3JvbGwgY2hlY2sgdGhlIGxvYWRlciBwb3NpdGlvbgoJCQl0aGlzLndpbmRvdy5iaW5kKCAic2Nyb2xsIiwgJC5wcm94eSggdGhpcy5jaGVja0xvYWRlclBvc2l0aW9uLCB0aGlzICkgKTsKCQl9LAoKCQloaWRlOiBmdW5jdGlvbigpIHsKCQkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1sb2FkaW5nIiApOwoKCQkJaWYgKCB0aGlzLm9wdGlvbnMudGV4dCApIHsKCQkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWxvYWRlci1mYWtlZml4IiApOwoJCQl9CgoJCQkkLm1vYmlsZS53aW5kb3cudW5iaW5kKCAic2Nyb2xsIiwgdGhpcy5mYWtlRml4TG9hZGVyICk7CgkJCSQubW9iaWxlLndpbmRvdy51bmJpbmQoICJzY3JvbGwiLCB0aGlzLmNoZWNrTG9hZGVyUG9zaXRpb24gKTsKCQl9Cgl9KTsKCn0pKGpRdWVyeSwgdGhpcyk7CgoKLy8gU2NyaXB0OiBqUXVlcnkgaGFzaGNoYW5nZSBldmVudAovLyAKLy8gKlZlcnNpb246IDEuMywgTGFzdCB1cGRhdGVkOiA3LzIxLzIwMTAqCi8vIAovLyBQcm9qZWN0IEhvbWUgLSBodHRwOi8vYmVuYWxtYW4uY29tL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlLXBsdWdpbi8KLy8gR2l0SHViICAgICAgIC0gaHR0cDovL2dpdGh1Yi5jb20vY293Ym95L2pxdWVyeS1oYXNoY2hhbmdlLwovLyBTb3VyY2UgICAgICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5qcwovLyAoTWluaWZpZWQpICAgLSBodHRwOi8vZ2l0aHViLmNvbS9jb3dib3kvanF1ZXJ5LWhhc2hjaGFuZ2UvcmF3L21hc3Rlci9qcXVlcnkuYmEtaGFzaGNoYW5nZS5taW4uanMgKDAuOGtiIGd6aXBwZWQpCi8vIAovLyBBYm91dDogTGljZW5zZQovLyAKLy8gQ29weXJpZ2h0IChjKSAyMDEwICJDb3dib3kiIEJlbiBBbG1hbiwKLy8gRHVhbCBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGFuZCBHUEwgbGljZW5zZXMuCi8vIGh0dHA6Ly9iZW5hbG1hbi5jb20vYWJvdXQvbGljZW5zZS8KLy8gCi8vIEFib3V0OiBFeGFtcGxlcwovLyAKLy8gVGhlc2Ugd29ya2luZyBleGFtcGxlcywgY29tcGxldGUgd2l0aCBmdWxseSBjb21tZW50ZWQgY29kZSwgaWxsdXN0cmF0ZSBhIGZldwovLyB3YXlzIGluIHdoaWNoIHRoaXMgcGx1Z2luIGNhbiBiZSB1c2VkLgovLyAKLy8gaGFzaGNoYW5nZSBldmVudCAtIGh0dHA6Ly9iZW5hbG1hbi5jb20vY29kZS9wcm9qZWN0cy9qcXVlcnktaGFzaGNoYW5nZS9leGFtcGxlcy9oYXNoY2hhbmdlLwovLyBkb2N1bWVudC5kb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvZG9jdW1lbnRfZG9tYWluLwovLyAKLy8gQWJvdXQ6IFN1cHBvcnQgYW5kIFRlc3RpbmcKLy8gCi8vIEluZm9ybWF0aW9uIGFib3V0IHdoYXQgdmVyc2lvbiBvciB2ZXJzaW9ucyBvZiBqUXVlcnkgdGhpcyBwbHVnaW4gaGFzIGJlZW4KLy8gdGVzdGVkIHdpdGgsIHdoYXQgYnJvd3NlcnMgaXQgaGFzIGJlZW4gdGVzdGVkIGluLCBhbmQgd2hlcmUgdGhlIHVuaXQgdGVzdHMKLy8gcmVzaWRlIChzbyB5b3UgY2FuIHRlc3QgaXQgeW91cnNlbGYpLgovLyAKLy8galF1ZXJ5IFZlcnNpb25zIC0gMS4yLjYsIDEuMy4yLCAxLjQuMSwgMS40LjIKLy8gQnJvd3NlcnMgVGVzdGVkIC0gSW50ZXJuZXQgRXhwbG9yZXIgNi04LCBGaXJlZm94IDItNCwgQ2hyb21lIDUtNiwgU2FmYXJpIDMuMi01LAovLyAgICAgICAgICAgICAgICAgICBPcGVyYSA5LjYtMTAuNjAsIGlQaG9uZSAzLjEsIEFuZHJvaWQgMS42LTIuMiwgQmxhY2tCZXJyeSA0LjYtNS4KLy8gVW5pdCBUZXN0cyAgICAgIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL3VuaXQvCi8vIAovLyBBYm91dDogS25vd24gaXNzdWVzCi8vIAovLyBXaGlsZSB0aGlzIGpRdWVyeSBoYXNoY2hhbmdlIGV2ZW50IGltcGxlbWVudGF0aW9uIGlzIHF1aXRlIHN0YWJsZSBhbmQKLy8gcm9idXN0LCB0aGVyZSBhcmUgYSBmZXcgdW5mb3J0dW5hdGUgYnJvd3NlciBidWdzIHN1cnJvdW5kaW5nIGV4cGVjdGVkCi8vIGhhc2hjaGFuZ2UgZXZlbnQtYmFzZWQgYmVoYXZpb3JzLCBpbmRlcGVuZGVudCBvZiBhbnkgSmF2YVNjcmlwdAovLyB3aW5kb3cub25oYXNoY2hhbmdlIGFic3RyYWN0aW9uLiBTZWUgdGhlIGZvbGxvd2luZyBleGFtcGxlcyBmb3IgbW9yZQovLyBpbmZvcm1hdGlvbjoKLy8gCi8vIENocm9tZTogQmFjayBCdXR0b24gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLWNocm9tZS1iYWNrLWJ1dHRvbi8KLy8gRmlyZWZveDogUmVtb3RlIFhNTEh0dHBSZXF1ZXN0IC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy1maXJlZm94LXJlbW90ZS14aHIvCi8vIFdlYktpdDogQmFjayBCdXR0b24gaW4gYW4gSWZyYW1lIC0gaHR0cDovL2JlbmFsbWFuLmNvbS9jb2RlL3Byb2plY3RzL2pxdWVyeS1oYXNoY2hhbmdlL2V4YW1wbGVzL2J1Zy13ZWJraXQtaGFzaC1pZnJhbWUvCi8vIFNhZmFyaTogQmFjayBCdXR0b24gZnJvbSBhIGRpZmZlcmVudCBkb21haW4gLSBodHRwOi8vYmVuYWxtYW4uY29tL2NvZGUvcHJvamVjdHMvanF1ZXJ5LWhhc2hjaGFuZ2UvZXhhbXBsZXMvYnVnLXNhZmFyaS1iYWNrLWZyb20tZGlmZi1kb21haW4vCi8vIAovLyBBbHNvIG5vdGUgdGhhdCBzaG91bGQgYSBicm93c2VyIG5hdGl2ZWx5IHN1cHBvcnQgdGhlIHdpbmRvdy5vbmhhc2hjaGFuZ2UgCi8vIGV2ZW50LCBidXQgbm90IHJlcG9ydCB0aGF0IGl0IGRvZXMsIHRoZSBmYWxsYmFjayBwb2xsaW5nIGxvb3Agd2lsbCBiZSB1c2VkLgovLyAKLy8gQWJvdXQ6IFJlbGVhc2UgSGlzdG9yeQovLyAKLy8gMS4zICAgLSAoNy8yMS8yMDEwKSBSZW9yZ2FuaXplZCBJRTYvNyBJZnJhbWUgY29kZSB0byBtYWtlIGl0IG1vcmUKLy8gICAgICAgICAicmVtb3ZhYmxlIiBmb3IgbW9iaWxlLW9ubHkgZGV2ZWxvcG1lbnQuIEFkZGVkIElFNi83IGRvY3VtZW50LnRpdGxlCi8vICAgICAgICAgc3VwcG9ydC4gQXR0ZW1wdGVkIHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZSBieSB1c2luZwovLyAgICAgICAgIHRlY2huaXF1ZXMgZnJvbSBodHRwOi8vd3d3LnBhY2llbGxvZ3JvdXAuY29tL2Jsb2cvP3A9NjA0LiBBZGRlZCAKLy8gICAgICAgICBzdXBwb3J0IGZvciB0aGUgInNob3J0Y3V0IiBmb3JtYXQgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoIGZuICkgYW5kCi8vICAgICAgICAgJCh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBsaWtlIGpRdWVyeSBwcm92aWRlcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgovLyAgICAgICAgIFJlbmFtZWQgalF1ZXJ5Lmhhc2hjaGFuZ2VEZWxheSB0byA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IGFuZAovLyAgICAgICAgIGxvd2VyZWQgaXRzIGRlZmF1bHQgdmFsdWUgdG8gNTAuIEFkZGVkIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+Ci8vICAgICAgICAgYW5kIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5zcmM+IHByb3BlcnRpZXMgcGx1cyBkb2N1bWVudC1kb21haW4uaHRtbAovLyAgICAgICAgIGZpbGUgdG8gYWRkcmVzcyBhY2Nlc3MgZGVuaWVkIGlzc3VlcyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGluCi8vICAgICAgICAgSUU2LzcuCi8vIDEuMiAgIC0gKDIvMTEvMjAxMCkgRml4ZWQgYSBidWcgd2hlcmUgY29taW5nIGJhY2sgdG8gYSBwYWdlIHVzaW5nIHRoaXMgcGx1Z2luCi8vICAgICAgICAgZnJvbSBhIHBhZ2Ugb24gYW5vdGhlciBkb21haW4gd291bGQgY2F1c2UgYW4gZXJyb3IgaW4gU2FmYXJpIDQuIEFsc28sCi8vICAgICAgICAgSUU2LzcgSWZyYW1lIGlzIG5vdyBpbnNlcnRlZCBhZnRlciB0aGUgYm9keSAodGhpcyBhY3R1YWxseSB3b3JrcyksCi8vICAgICAgICAgd2hpY2ggcHJldmVudHMgdGhlIHBhZ2UgZnJvbSBzY3JvbGxpbmcgd2hlbiB0aGUgZXZlbnQgaXMgZmlyc3QgYm91bmQuCi8vICAgICAgICAgRXZlbnQgY2FuIGFsc28gbm93IGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBpdCB3b24ndCBiZSB1c2FibGUKLy8gICAgICAgICBiZWZvcmUgdGhlbiBpbiBJRTYvNy4KLy8gMS4xICAgLSAoMS8yMS8yMDEwKSBJbmNvcnBvcmF0ZWQgZG9jdW1lbnQuZG9jdW1lbnRNb2RlIHRlc3QgdG8gZml4IElFOCBidWcKLy8gICAgICAgICB3aGVyZSBicm93c2VyIHZlcnNpb24gaXMgaW5jb3JyZWN0bHkgcmVwb3J0ZWQgYXMgOC4wLCBkZXNwaXRlCi8vICAgICAgICAgaW5jbHVzaW9uIG9mIHRoZSBYLVVBLUNvbXBhdGlibGUgSUU9RW11bGF0ZUlFNyBtZXRhIHRhZy4KLy8gMS4wICAgLSAoMS85LzIwMTApIEluaXRpYWwgUmVsZWFzZS4gQnJva2Ugb3V0IHRoZSBqUXVlcnkgQkJRIGV2ZW50LnNwZWNpYWwKLy8gICAgICAgICB3aW5kb3cub25oYXNoY2hhbmdlIGZ1bmN0aW9uYWxpdHkgaW50byBhIHNlcGFyYXRlIHBsdWdpbiBmb3IgdXNlcnMKLy8gICAgICAgICB3aG8gd2FudCBqdXN0IHRoZSBiYXNpYyBldmVudCAmIGJhY2sgYnV0dG9uIHN1cHBvcnQsIHdpdGhvdXQgYWxsIHRoZQovLyAgICAgICAgIGV4dHJhIGF3ZXNvbWVuZXNzIHRoYXQgQkJRIHByb3ZpZGVzLiBUaGlzIHBsdWdpbiB3aWxsIGJlIGluY2x1ZGVkIGFzCi8vICAgICAgICAgcGFydCBvZiBqUXVlcnkgQkJRLCBidXQgYWxzbyBiZSBhdmFpbGFibGUgc2VwYXJhdGVseS4KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CiAgLy8gUmV1c2VkIHN0cmluZy4KICB2YXIgc3RyX2hhc2hjaGFuZ2UgPSAnaGFzaGNoYW5nZScsCiAgICAKICAgIC8vIE1ldGhvZCAvIG9iamVjdCByZWZlcmVuY2VzLgogICAgZG9jID0gZG9jdW1lbnQsCiAgICBmYWtlX29uaGFzaGNoYW5nZSwKICAgIHNwZWNpYWwgPSAkLmV2ZW50LnNwZWNpYWwsCiAgICAKICAgIC8vIERvZXMgdGhlIGJyb3dzZXIgc3VwcG9ydCB3aW5kb3cub25oYXNoY2hhbmdlPyBOb3RlIHRoYXQgSUU4IHJ1bm5pbmcgaW4KICAgIC8vIElFNyBjb21wYXRpYmlsaXR5IG1vZGUgcmVwb3J0cyB0cnVlIGZvciAnb25oYXNoY2hhbmdlJyBpbiB3aW5kb3csIGV2ZW4KICAgIC8vIHRob3VnaCB0aGUgZXZlbnQgaXNuJ3Qgc3VwcG9ydGVkLCBzbyBhbHNvIHRlc3QgZG9jdW1lbnQuZG9jdW1lbnRNb2RlLgogICAgZG9jX21vZGUgPSBkb2MuZG9jdW1lbnRNb2RlLAogICAgc3VwcG9ydHNfb25oYXNoY2hhbmdlID0gJ29uJyArIHN0cl9oYXNoY2hhbmdlIGluIHdpbmRvdyAmJiAoIGRvY19tb2RlID09PSB1bmRlZmluZWQgfHwgZG9jX21vZGUgPiA3ICk7CiAgCiAgLy8gR2V0IGxvY2F0aW9uLmhhc2ggKG9yIHdoYXQgeW91J2QgZXhwZWN0IGxvY2F0aW9uLmhhc2ggdG8gYmUpIHNhbnMgYW55CiAgLy8gbGVhZGluZyAjLiBUaGFua3MgZm9yIG1ha2luZyB0aGlzIG5lY2Vzc2FyeSwgRmlyZWZveCEKICBmdW5jdGlvbiBnZXRfZnJhZ21lbnQoIHVybCApIHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbi5ocmVmOwogICAgcmV0dXJuICcjJyArIHVybC5yZXBsYWNlKCAvXlteI10qIz8oLiopJC8sICckMScgKTsKICB9OwogIAogIC8vIE1ldGhvZDogalF1ZXJ5LmZuLmhhc2hjaGFuZ2UKICAvLyAKICAvLyBCaW5kIGEgaGFuZGxlciB0byB0aGUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBvciB0cmlnZ2VyIGFsbCBib3VuZAogIC8vIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMuIFRoaXMgYmVoYXZpb3IgaXMgY29uc2lzdGVudCB3aXRoCiAgLy8galF1ZXJ5J3MgYnVpbHQtaW4gZXZlbnQgaGFuZGxlcnMuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCBbIGhhbmRsZXIgXSApOwogIC8vIAogIC8vIEFyZ3VtZW50czoKICAvLyAKICAvLyAgaGFuZGxlciAtIChGdW5jdGlvbikgT3B0aW9uYWwgaGFuZGxlciB0byBiZSBib3VuZCB0byB0aGUgaGFzaGNoYW5nZQogIC8vICAgIGV2ZW50LiBUaGlzIGlzIGEgInNob3J0Y3V0IiBmb3IgdGhlIG1vcmUgdmVyYm9zZSBmb3JtOgogIC8vICAgIGpRdWVyeSh3aW5kb3cpLmJpbmQoICdoYXNoY2hhbmdlJywgaGFuZGxlciApLiBJZiBoYW5kbGVyIGlzIG9taXR0ZWQsCiAgLy8gICAgYWxsIGJvdW5kIHdpbmRvdy5vbmhhc2hjaGFuZ2UgZXZlbnQgaGFuZGxlcnMgd2lsbCBiZSB0cmlnZ2VyZWQuIFRoaXMKICAvLyAgICBpcyBhIHNob3J0Y3V0IGZvciB0aGUgbW9yZSB2ZXJib3NlCiAgLy8gICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuIFRoZXNlIGZvcm1zIGFyZSBkZXNjcmliZWQgaW4KICAvLyAgICB0aGUgPGhhc2hjaGFuZ2UgZXZlbnQ+IHNlY3Rpb24uCiAgLy8gCiAgLy8gUmV0dXJuczoKICAvLyAKICAvLyAgKGpRdWVyeSkgVGhlIGluaXRpYWwgalF1ZXJ5IGNvbGxlY3Rpb24gb2YgZWxlbWVudHMuCiAgCiAgLy8gQWxsb3cgdGhlICJzaG9ydGN1dCIgZm9ybWF0ICQoZWxlbSkuaGFzaGNoYW5nZSggZm4gKSBmb3IgYmluZGluZyBhbmQKICAvLyAkKGVsZW0pLmhhc2hjaGFuZ2UoKSBmb3IgdHJpZ2dlcmluZywgbGlrZSBqUXVlcnkgZG9lcyBmb3IgYnVpbHQtaW4gZXZlbnRzLgogICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0gPSBmdW5jdGlvbiggZm4gKSB7CiAgICByZXR1cm4gZm4gPyB0aGlzLmJpbmQoIHN0cl9oYXNoY2hhbmdlLCBmbiApIDogdGhpcy50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogIH07CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRlbGF5CiAgLy8gCiAgLy8gVGhlIG51bWVyaWMgaW50ZXJ2YWwgKGluIG1pbGxpc2Vjb25kcykgYXQgd2hpY2ggdGhlIDxoYXNoY2hhbmdlIGV2ZW50PgogIC8vIHBvbGxpbmcgbG9vcCBleGVjdXRlcy4gRGVmYXVsdHMgdG8gNTAuCiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLmRvbWFpbgogIC8vIAogIC8vIElmIHlvdSdyZSBzZXR0aW5nIGRvY3VtZW50LmRvbWFpbiBpbiB5b3VyIEphdmFTY3JpcHQsIGFuZCB5b3Ugd2FudCBoYXNoCiAgLy8gaGlzdG9yeSB0byB3b3JrIGluIElFNi83LCBub3Qgb25seSBtdXN0IHRoaXMgcHJvcGVydHkgYmUgc2V0LCBidXQgeW91IG11c3QKICAvLyBhbHNvIHNldCBkb2N1bWVudC5kb21haW4gQkVGT1JFIGpRdWVyeSBpcyBsb2FkZWQgaW50byB0aGUgcGFnZS4gVGhpcwogIC8vIHByb3BlcnR5IGlzIG9ubHkgYXBwbGljYWJsZSBpZiB5b3UgYXJlIHN1cHBvcnRpbmcgSUU2LzcgKG9yIElFOCBvcGVyYXRpbmcKICAvLyBpbiAiSUU3IGNvbXBhdGliaWxpdHkiIG1vZGUpLgogIC8vIAogIC8vIEluIGFkZGl0aW9uLCB0aGUgPGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYz4gcHJvcGVydHkgbXVzdCBiZSBzZXQgdG8gdGhlCiAgLy8gcGF0aCBvZiB0aGUgaW5jbHVkZWQgImRvY3VtZW50LWRvbWFpbi5odG1sIiBmaWxlLCB3aGljaCBjYW4gYmUgcmVuYW1lZCBvcgogIC8vIG1vZGlmaWVkIGlmIG5lY2Vzc2FyeSAobm90ZSB0aGF0IHRoZSBkb2N1bWVudC5kb21haW4gc3BlY2lmaWVkIG11c3QgYmUgdGhlCiAgLy8gc2FtZSBpbiBib3RoIHlvdXIgbWFpbiBKYXZhU2NyaXB0IGFzIHdlbGwgYXMgaW4gdGhpcyBmaWxlKS4KICAvLyAKICAvLyBVc2FnZToKICAvLyAKICAvLyBqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4gPSBkb2N1bWVudC5kb21haW47CiAgCiAgLy8gUHJvcGVydHk6IGpRdWVyeS5mbi5oYXNoY2hhbmdlLnNyYwogIC8vIAogIC8vIElmLCBmb3Igc29tZSByZWFzb24sIHlvdSBuZWVkIHRvIHNwZWNpZnkgYW4gSWZyYW1lIHNyYyBmaWxlIChmb3IgZXhhbXBsZSwKICAvLyB3aGVuIHNldHRpbmcgZG9jdW1lbnQuZG9tYWluIGFzIGluIDxqUXVlcnkuZm4uaGFzaGNoYW5nZS5kb21haW4+KSwgeW91IGNhbgogIC8vIGRvIHNvIHVzaW5nIHRoaXMgcHJvcGVydHkuIE5vdGUgdGhhdCB3aGVuIHVzaW5nIHRoaXMgcHJvcGVydHksIGhpc3RvcnkKICAvLyB3b24ndCBiZSByZWNvcmRlZCBpbiBJRTYvNyB1bnRpbCB0aGUgSWZyYW1lIHNyYyBmaWxlIGxvYWRzLiBUaGlzIHByb3BlcnR5CiAgLy8gaXMgb25seSBhcHBsaWNhYmxlIGlmIHlvdSBhcmUgc3VwcG9ydGluZyBJRTYvNyAob3IgSUU4IG9wZXJhdGluZyBpbiAiSUU3CiAgLy8gY29tcGF0aWJpbGl0eSIgbW9kZSkuCiAgLy8gCiAgLy8gVXNhZ2U6CiAgLy8gCiAgLy8galF1ZXJ5LmZuLmhhc2hjaGFuZ2Uuc3JjID0gJ3BhdGgvdG8vZmlsZS5odG1sJzsKICAKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRlbGF5ID0gNTA7CiAgLyoKICAkLmZuWyBzdHJfaGFzaGNoYW5nZSBdLmRvbWFpbiA9IG51bGw7CiAgJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmMgPSBudWxsOwogICovCiAgCiAgLy8gRXZlbnQ6IGhhc2hjaGFuZ2UgZXZlbnQKICAvLyAKICAvLyBGaXJlZCB3aGVuIGxvY2F0aW9uLmhhc2ggY2hhbmdlcy4gSW4gYnJvd3NlcnMgdGhhdCBzdXBwb3J0IGl0LCB0aGUgbmF0aXZlCiAgLy8gSFRNTDUgd2luZG93Lm9uaGFzaGNoYW5nZSBldmVudCBpcyB1c2VkLCBvdGhlcndpc2UgYSBwb2xsaW5nIGxvb3AgaXMKICAvLyBpbml0aWFsaXplZCwgcnVubmluZyBldmVyeSA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2UuZGVsYXk+IG1pbGxpc2Vjb25kcyB0bwogIC8vIHNlZSBpZiB0aGUgaGFzaCBoYXMgY2hhbmdlZC4gSW4gSUU2LzcgKGFuZCBJRTggb3BlcmF0aW5nIGluICJJRTcKICAvLyBjb21wYXRpYmlsaXR5IiBtb2RlKSwgYSBoaWRkZW4gSWZyYW1lIGlzIGNyZWF0ZWQgdG8gYWxsb3cgdGhlIGJhY2sgYnV0dG9uCiAgLy8gYW5kIGhhc2gtYmFzZWQgaGlzdG9yeSB0byB3b3JrLgogIC8vIAogIC8vIFVzYWdlIGFzIGRlc2NyaWJlZCBpbiA8alF1ZXJ5LmZuLmhhc2hjaGFuZ2U+OgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuaGFzaGNoYW5nZSggZnVuY3Rpb24oZSkgewogIC8vID4gICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CiAgLy8gPiAgIC4uLgogIC8vID4gfSk7CiAgLy8gPiAKICAvLyA+IC8vIE1hbnVhbGx5IHRyaWdnZXIgdGhlIGV2ZW50IGhhbmRsZXIuCiAgLy8gPiBqUXVlcnkod2luZG93KS5oYXNoY2hhbmdlKCk7CiAgLy8gCiAgLy8gQSBtb3JlIHZlcmJvc2UgdXNhZ2UgdGhhdCBhbGxvd3MgZm9yIGV2ZW50IG5hbWVzcGFjaW5nOgogIC8vIAogIC8vID4gLy8gQmluZCBhbiBldmVudCBoYW5kbGVyLgogIC8vID4galF1ZXJ5KHdpbmRvdykuYmluZCggJ2hhc2hjaGFuZ2UnLCBmdW5jdGlvbihlKSB7CiAgLy8gPiAgIHZhciBoYXNoID0gbG9jYXRpb24uaGFzaDsKICAvLyA+ICAgLi4uCiAgLy8gPiB9KTsKICAvLyA+IAogIC8vID4gLy8gTWFudWFsbHkgdHJpZ2dlciB0aGUgZXZlbnQgaGFuZGxlci4KICAvLyA+IGpRdWVyeSh3aW5kb3cpLnRyaWdnZXIoICdoYXNoY2hhbmdlJyApOwogIC8vIAogIC8vIEFkZGl0aW9uYWwgTm90ZXM6CiAgLy8gCiAgLy8gKiBUaGUgcG9sbGluZyBsb29wIGFuZCBJZnJhbWUgYXJlIG5vdCBjcmVhdGVkIHVudGlsIGF0IGxlYXN0IG9uZSBoYW5kbGVyCiAgLy8gICBpcyBhY3R1YWxseSBib3VuZCB0byB0aGUgJ2hhc2hjaGFuZ2UnIGV2ZW50LgogIC8vICogSWYgeW91IG5lZWQgdGhlIGJvdW5kIGhhbmRsZXIocykgdG8gZXhlY3V0ZSBpbW1lZGlhdGVseSwgaW4gY2FzZXMgd2hlcmUKICAvLyAgIGEgbG9jYXRpb24uaGFzaCBleGlzdHMgb24gcGFnZSBsb2FkLCB2aWEgYm9va21hcmsgb3IgcGFnZSByZWZyZXNoIGZvcgogIC8vICAgZXhhbXBsZSwgdXNlIGpRdWVyeSh3aW5kb3cpLmhhc2hjaGFuZ2UoKSBvciB0aGUgbW9yZSB2ZXJib3NlIAogIC8vICAgalF1ZXJ5KHdpbmRvdykudHJpZ2dlciggJ2hhc2hjaGFuZ2UnICkuCiAgLy8gKiBUaGUgZXZlbnQgY2FuIGJlIGJvdW5kIGJlZm9yZSBET00gcmVhZHksIGJ1dCBzaW5jZSBpdCB3b24ndCBiZSB1c2FibGUKICAvLyAgIGJlZm9yZSB0aGVuIGluIElFNi83IChkdWUgdG8gdGhlIG5lY2Vzc2FyeSBJZnJhbWUpLCByZWNvbW1lbmRlZCB1c2FnZSBpcwogIC8vICAgdG8gYmluZCBpdCBpbnNpZGUgYSBET00gcmVhZHkgaGFuZGxlci4KICAKICAvLyBPdmVycmlkZSBleGlzdGluZyAkLmV2ZW50LnNwZWNpYWwuaGFzaGNoYW5nZSBtZXRob2RzIChhbGxvd2luZyB0aGlzIHBsdWdpbgogIC8vIHRvIGJlIGRlZmluZWQgYWZ0ZXIgalF1ZXJ5IEJCUSBpbiBCQlEncyBzb3VyY2UgY29kZSkuCiAgc3BlY2lhbFsgc3RyX2hhc2hjaGFuZ2UgXSA9ICQuZXh0ZW5kKCBzcGVjaWFsWyBzdHJfaGFzaGNoYW5nZSBdLCB7CiAgICAKICAgIC8vIENhbGxlZCBvbmx5IHdoZW4gdGhlIGZpcnN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyBib3VuZCB0byB3aW5kb3cuCiAgICBzZXR1cDogZnVuY3Rpb24oKSB7CiAgICAgIC8vIElmIHdpbmRvdy5vbmhhc2hjaGFuZ2UgaXMgc3VwcG9ydGVkIG5hdGl2ZWx5LCB0aGVyZSdzIG5vdGhpbmcgdG8gZG8uLgogICAgICBpZiAoIHN1cHBvcnRzX29uaGFzaGNoYW5nZSApIHsgcmV0dXJuIGZhbHNlOyB9CiAgICAgIAogICAgICAvLyBPdGhlcndpc2UsIHdlIG5lZWQgdG8gY3JlYXRlIG91ciBvd24uIEFuZCB3ZSBkb24ndCB3YW50IHRvIGNhbGwgdGhpcwogICAgICAvLyB1bnRpbCB0aGUgdXNlciBiaW5kcyB0byB0aGUgZXZlbnQsIGp1c3QgaW4gY2FzZSB0aGV5IG5ldmVyIGRvLCBzaW5jZSBpdAogICAgICAvLyB3aWxsIGNyZWF0ZSBhIHBvbGxpbmcgbG9vcCBhbmQgcG9zc2libHkgZXZlbiBhIGhpZGRlbiBJZnJhbWUuCiAgICAgICQoIGZha2Vfb25oYXNoY2hhbmdlLnN0YXJ0ICk7CiAgICB9LAogICAgCiAgICAvLyBDYWxsZWQgb25seSB3aGVuIHRoZSBsYXN0ICdoYXNoY2hhbmdlJyBldmVudCBpcyB1bmJvdW5kIGZyb20gd2luZG93LgogICAgdGVhcmRvd246IGZ1bmN0aW9uKCkgewogICAgICAvLyBJZiB3aW5kb3cub25oYXNoY2hhbmdlIGlzIHN1cHBvcnRlZCBuYXRpdmVseSwgdGhlcmUncyBub3RoaW5nIHRvIGRvLi4KICAgICAgaWYgKCBzdXBwb3J0c19vbmhhc2hjaGFuZ2UgKSB7IHJldHVybiBmYWxzZTsgfQogICAgICAKICAgICAgLy8gT3RoZXJ3aXNlLCB3ZSBuZWVkIHRvIHN0b3Agb3VycyAoaWYgcG9zc2libGUpLgogICAgICAkKCBmYWtlX29uaGFzaGNoYW5nZS5zdG9wICk7CiAgICB9CiAgICAKICB9KTsKICAKICAvLyBmYWtlX29uaGFzaGNoYW5nZSBkb2VzIGFsbCB0aGUgd29yayBvZiB0cmlnZ2VyaW5nIHRoZSB3aW5kb3cub25oYXNoY2hhbmdlCiAgLy8gZXZlbnQgZm9yIGJyb3dzZXJzIHRoYXQgZG9uJ3QgbmF0aXZlbHkgc3VwcG9ydCBpdCwgaW5jbHVkaW5nIGNyZWF0aW5nIGEKICAvLyBwb2xsaW5nIGxvb3AgdG8gd2F0Y2ggZm9yIGhhc2ggY2hhbmdlcyBhbmQgaW4gSUUgNi83IGNyZWF0aW5nIGEgaGlkZGVuCiAgLy8gSWZyYW1lIHRvIGVuYWJsZSBiYWNrIGFuZCBmb3J3YXJkLgogIGZha2Vfb25oYXNoY2hhbmdlID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHNlbGYgPSB7fSwKICAgICAgdGltZW91dF9pZCwKICAgICAgCiAgICAgIC8vIFJlbWVtYmVyIHRoZSBpbml0aWFsIGhhc2ggc28gaXQgZG9lc24ndCBnZXQgdHJpZ2dlcmVkIGltbWVkaWF0ZWx5LgogICAgICBsYXN0X2hhc2ggPSBnZXRfZnJhZ21lbnQoKSwKICAgICAgCiAgICAgIGZuX3JldHZhbCA9IGZ1bmN0aW9uKCB2YWwgKSB7IHJldHVybiB2YWw7IH0sCiAgICAgIGhpc3Rvcnlfc2V0ID0gZm5fcmV0dmFsLAogICAgICBoaXN0b3J5X2dldCA9IGZuX3JldHZhbDsKICAgIAogICAgLy8gU3RhcnQgdGhlIHBvbGxpbmcgbG9vcC4KICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCB8fCBwb2xsKCk7CiAgICB9OwogICAgCiAgICAvLyBTdG9wIHRoZSBwb2xsaW5nIGxvb3AuCiAgICBzZWxmLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgdGltZW91dF9pZCAmJiBjbGVhclRpbWVvdXQoIHRpbWVvdXRfaWQgKTsKICAgICAgdGltZW91dF9pZCA9IHVuZGVmaW5lZDsKICAgIH07CiAgICAKICAgIC8vIFRoaXMgcG9sbGluZyBsb29wIGNoZWNrcyBldmVyeSAkLmZuLmhhc2hjaGFuZ2UuZGVsYXkgbWlsbGlzZWNvbmRzIHRvIHNlZQogICAgLy8gaWYgbG9jYXRpb24uaGFzaCBoYXMgY2hhbmdlZCwgYW5kIHRyaWdnZXJzIHRoZSAnaGFzaGNoYW5nZScgZXZlbnQgb24KICAgIC8vIHdpbmRvdyB3aGVuIG5lY2Vzc2FyeS4KICAgIGZ1bmN0aW9uIHBvbGwoKSB7CiAgICAgIHZhciBoYXNoID0gZ2V0X2ZyYWdtZW50KCksCiAgICAgICAgaGlzdG9yeV9oYXNoID0gaGlzdG9yeV9nZXQoIGxhc3RfaGFzaCApOwogICAgICAKICAgICAgaWYgKCBoYXNoICE9PSBsYXN0X2hhc2ggKSB7CiAgICAgICAgaGlzdG9yeV9zZXQoIGxhc3RfaGFzaCA9IGhhc2gsIGhpc3RvcnlfaGFzaCApOwogICAgICAgIAogICAgICAgICQod2luZG93KS50cmlnZ2VyKCBzdHJfaGFzaGNoYW5nZSApOwogICAgICAgIAogICAgICB9IGVsc2UgaWYgKCBoaXN0b3J5X2hhc2ggIT09IGxhc3RfaGFzaCApIHsKICAgICAgICBsb2NhdGlvbi5ocmVmID0gbG9jYXRpb24uaHJlZi5yZXBsYWNlKCAvIy4qLywgJycgKSArIGhpc3RvcnlfaGFzaDsKICAgICAgfQogICAgICAKICAgICAgdGltZW91dF9pZCA9IHNldFRpbWVvdXQoIHBvbGwsICQuZm5bIHN0cl9oYXNoY2hhbmdlIF0uZGVsYXkgKTsKICAgIH07CiAgICAKICAgIC8vIHZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dgogICAgLy8gdnZ2dnZ2dnZ2dnZ2dnZ2dnZ2diBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2CiAgICAvLyB2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnZ2dnYKICAgIHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIgJiYgIXN1cHBvcnRzX29uaGFzaGNoYW5nZSAmJiAoZnVuY3Rpb24oKSB7CiAgICAgIC8vIE5vdCBvbmx5IGRvIElFNi83IG5lZWQgdGhlICJtYWdpY2FsIiBJZnJhbWUgdHJlYXRtZW50LCBidXQgc28gZG9lcyBJRTgKICAgICAgLy8gd2hlbiBydW5uaW5nIGluICJJRTcgY29tcGF0aWJpbGl0eSIgbW9kZS4KICAgICAgCiAgICAgIHZhciBpZnJhbWUsCiAgICAgICAgaWZyYW1lX3NyYzsKICAgICAgCiAgICAgIC8vIFdoZW4gdGhlIGV2ZW50IGlzIGJvdW5kIGFuZCBwb2xsaW5nIHN0YXJ0cyBpbiBJRSA2LzcsIGNyZWF0ZSBhIGhpZGRlbgogICAgICAvLyBJZnJhbWUgZm9yIGhpc3RvcnkgaGFuZGxpbmcuCiAgICAgIHNlbGYuc3RhcnQgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoICFpZnJhbWUgKSB7CiAgICAgICAgICBpZnJhbWVfc3JjID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5zcmM7CiAgICAgICAgICBpZnJhbWVfc3JjID0gaWZyYW1lX3NyYyAmJiBpZnJhbWVfc3JjICsgZ2V0X2ZyYWdtZW50KCk7CiAgICAgICAgICAKICAgICAgICAgIC8vIENyZWF0ZSBoaWRkZW4gSWZyYW1lLiBBdHRlbXB0IHRvIG1ha2UgSWZyYW1lIGFzIGhpZGRlbiBhcyBwb3NzaWJsZQogICAgICAgICAgLy8gYnkgdXNpbmcgdGVjaG5pcXVlcyBmcm9tIGh0dHA6Ly93d3cucGFjaWVsbG9ncm91cC5jb20vYmxvZy8/cD02MDQuCiAgICAgICAgICBpZnJhbWUgPSAkKCc8aWZyYW1lIHRhYmluZGV4PSItMSIgdGl0bGU9ImVtcHR5Ii8+JykuaGlkZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBXaGVuIElmcmFtZSBoYXMgY29tcGxldGVseSBsb2FkZWQsIGluaXRpYWxpemUgdGhlIGhpc3RvcnkgYW5kCiAgICAgICAgICAgIC8vIHN0YXJ0IHBvbGxpbmcuCiAgICAgICAgICAgIC5vbmUoICdsb2FkJywgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgaWZyYW1lX3NyYyB8fCBoaXN0b3J5X3NldCggZ2V0X2ZyYWdtZW50KCkgKTsKICAgICAgICAgICAgICBwb2xsKCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAvLyBMb2FkIElmcmFtZSBzcmMgaWYgc3BlY2lmaWVkLCBvdGhlcndpc2Ugbm90aGluZy4KICAgICAgICAgICAgLmF0dHIoICdzcmMnLCBpZnJhbWVfc3JjIHx8ICdqYXZhc2NyaXB0OjAnICkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vIEFwcGVuZCBJZnJhbWUgYWZ0ZXIgdGhlIGVuZCBvZiB0aGUgYm9keSB0byBwcmV2ZW50IHVubmVjZXNzYXJ5CiAgICAgICAgICAgIC8vIGluaXRpYWwgcGFnZSBzY3JvbGxpbmcgKHllcywgdGhpcyB3b3JrcykuCiAgICAgICAgICAgIC5pbnNlcnRBZnRlciggJ2JvZHknIClbMF0uY29udGVudFdpbmRvdzsKICAgICAgICAgIAogICAgICAgICAgLy8gV2hlbmV2ZXIgYGRvY3VtZW50LnRpdGxlYCBjaGFuZ2VzLCB1cGRhdGUgdGhlIElmcmFtZSdzIHRpdGxlIHRvCiAgICAgICAgICAvLyBwcmV0dGlmeSB0aGUgYmFjay9uZXh0IGhpc3RvcnkgbWVudSBlbnRyaWVzLiBTaW5jZSBJRSBzb21ldGltZXMKICAgICAgICAgIC8vIGVycm9ycyB3aXRoICJVbnNwZWNpZmllZCBlcnJvciIgdGhlIHZlcnkgZmlyc3QgdGltZSB0aGlzIGlzIHNldAogICAgICAgICAgLy8gKHllcywgdmVyeSB1c2VmdWwpIHdyYXAgdGhpcyB3aXRoIGEgdHJ5L2NhdGNoIGJsb2NrLgogICAgICAgICAgZG9jLm9ucHJvcGVydHljaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBpZiAoIGV2ZW50LnByb3BlcnR5TmFtZSA9PT0gJ3RpdGxlJyApIHsKICAgICAgICAgICAgICAgIGlmcmFtZS5kb2N1bWVudC50aXRsZSA9IGRvYy50aXRsZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2goZSkge30KICAgICAgICAgIH07CiAgICAgICAgICAKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgICAvLyBPdmVycmlkZSB0aGUgInN0b3AiIG1ldGhvZCBzaW5jZSBhbiBJRTYvNyBJZnJhbWUgd2FzIGNyZWF0ZWQuIEV2ZW4KICAgICAgLy8gaWYgdGhlcmUgYXJlIG5vIGxvbmdlciBhbnkgYm91bmQgZXZlbnQgaGFuZGxlcnMsIHRoZSBwb2xsaW5nIGxvb3AKICAgICAgLy8gaXMgc3RpbGwgbmVjZXNzYXJ5IGZvciBiYWNrL25leHQgdG8gd29yayBhdCBhbGwhCiAgICAgIHNlbGYuc3RvcCA9IGZuX3JldHZhbDsKICAgICAgCiAgICAgIC8vIEdldCBoaXN0b3J5IGJ5IGxvb2tpbmcgYXQgdGhlIGhpZGRlbiBJZnJhbWUncyBsb2NhdGlvbi5oYXNoLgogICAgICBoaXN0b3J5X2dldCA9IGZ1bmN0aW9uKCkgewogICAgICAgIHJldHVybiBnZXRfZnJhZ21lbnQoIGlmcmFtZS5sb2NhdGlvbi5ocmVmICk7CiAgICAgIH07CiAgICAgIAogICAgICAvLyBTZXQgYSBuZXcgaGlzdG9yeSBpdGVtIGJ5IG9wZW5pbmcgYW5kIHRoZW4gY2xvc2luZyB0aGUgSWZyYW1lCiAgICAgIC8vIGRvY3VtZW50LCAqdGhlbiogc2V0dGluZyBpdHMgbG9jYXRpb24uaGFzaC4gSWYgZG9jdW1lbnQuZG9tYWluIGhhcwogICAgICAvLyBiZWVuIHNldCwgdXBkYXRlIHRoYXQgYXMgd2VsbC4KICAgICAgaGlzdG9yeV9zZXQgPSBmdW5jdGlvbiggaGFzaCwgaGlzdG9yeV9oYXNoICkgewogICAgICAgIHZhciBpZnJhbWVfZG9jID0gaWZyYW1lLmRvY3VtZW50LAogICAgICAgICAgZG9tYWluID0gJC5mblsgc3RyX2hhc2hjaGFuZ2UgXS5kb21haW47CiAgICAgICAgCiAgICAgICAgaWYgKCBoYXNoICE9PSBoaXN0b3J5X2hhc2ggKSB7CiAgICAgICAgICAvLyBVcGRhdGUgSWZyYW1lIHdpdGggYW55IGluaXRpYWwgYGRvY3VtZW50LnRpdGxlYCB0aGF0IG1pZ2h0IGJlIHNldC4KICAgICAgICAgIGlmcmFtZV9kb2MudGl0bGUgPSBkb2MudGl0bGU7CiAgICAgICAgICAKICAgICAgICAgIC8vIE9wZW5pbmcgdGhlIElmcmFtZSdzIGRvY3VtZW50IGFmdGVyIGl0IGhhcyBiZWVuIGNsb3NlZCBpcyB3aGF0CiAgICAgICAgICAvLyBhY3R1YWxseSBhZGRzIGEgaGlzdG9yeSBlbnRyeS4KICAgICAgICAgIGlmcmFtZV9kb2Mub3BlbigpOwogICAgICAgICAgCiAgICAgICAgICAvLyBTZXQgZG9jdW1lbnQuZG9tYWluIGZvciB0aGUgSWZyYW1lIGRvY3VtZW50IGFzIHdlbGwsIGlmIG5lY2Vzc2FyeS4KICAgICAgICAgIGRvbWFpbiAmJiBpZnJhbWVfZG9jLndyaXRlKCAnPHNjcmlwdD5kb2N1bWVudC5kb21haW49IicgKyBkb21haW4gKyAnIjxcL3NjcmlwdD4nICk7CiAgICAgICAgICAKICAgICAgICAgIGlmcmFtZV9kb2MuY2xvc2UoKTsKICAgICAgICAgIAogICAgICAgICAgLy8gVXBkYXRlIHRoZSBJZnJhbWUncyBoYXNoLCBmb3IgZ3JlYXQganVzdGljZS4KICAgICAgICAgIGlmcmFtZS5sb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgICAgICB9CiAgICAgIH07CiAgICAgIAogICAgfSkoKTsKICAgIC8vIF5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXgogICAgLy8gXl5eXl5eXl5eXl5eXl5eXl5eXiBSRU1PVkUgSUYgTk9UIFNVUFBPUlRJTkcgSUU2LzcvOCBeXl5eXl5eXl5eXl5eXl5eXl5eCiAgICAvLyBeXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl5eXl4KICAgIAogICAgcmV0dXJuIHNlbGY7CiAgfSkoKTsKICAKfSkoalF1ZXJ5LHRoaXMpOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgoJLyohIG1hdGNoTWVkaWEoKSBwb2x5ZmlsbCAtIFRlc3QgYSBDU1MgbWVkaWEgdHlwZS9xdWVyeSBpbiBKUy4gQXV0aG9ycyAmIGNvcHlyaWdodCAoYykgMjAxMjogU2NvdHQgSmVobCwgUGF1bCBJcmlzaCwgTmljaG9sYXMgWmFrYXMuIER1YWwgTUlUL0JTRCBsaWNlbnNlICovCgl3aW5kb3cubWF0Y2hNZWRpYSA9IHdpbmRvdy5tYXRjaE1lZGlhIHx8IChmdW5jdGlvbiggZG9jLCB1bmRlZmluZWQgKSB7CgoJCQoKCQl2YXIgYm9vbCwKCQkJZG9jRWxlbSA9IGRvYy5kb2N1bWVudEVsZW1lbnQsCgkJCXJlZk5vZGUgPSBkb2NFbGVtLmZpcnN0RWxlbWVudENoaWxkIHx8IGRvY0VsZW0uZmlyc3RDaGlsZCwKCQkJLy8gZmFrZUJvZHkgcmVxdWlyZWQgZm9yIDxGRjQgd2hlbiBleGVjdXRlZCBpbiA8aGVhZD4KCQkJZmFrZUJvZHkgPSBkb2MuY3JlYXRlRWxlbWVudCggImJvZHkiICksCgkJCWRpdiA9IGRvYy5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoKCQlkaXYuaWQgPSAibXEtdGVzdC0xIjsKCQlkaXYuc3R5bGUuY3NzVGV4dCA9ICJwb3NpdGlvbjphYnNvbHV0ZTt0b3A6LTEwMGVtIjsKCQlmYWtlQm9keS5zdHlsZS5iYWNrZ3JvdW5kID0gIm5vbmUiOwoJCWZha2VCb2R5LmFwcGVuZENoaWxkKGRpdik7CgoJCXJldHVybiBmdW5jdGlvbihxKXsKCgkJCWRpdi5pbm5lckhUTUwgPSAiJnNoeTs8c3R5bGUgbWVkaWE9XCIiICsgcSArICJcIj4gI21xLXRlc3QtMSB7IHdpZHRoOiA0MnB4OyB9PC9zdHlsZT4iOwoKCQkJZG9jRWxlbS5pbnNlcnRCZWZvcmUoIGZha2VCb2R5LCByZWZOb2RlICk7CgkJCWJvb2wgPSBkaXYub2Zmc2V0V2lkdGggPT09IDQyOwoJCQlkb2NFbGVtLnJlbW92ZUNoaWxkKCBmYWtlQm9keSApOwoKCQkJcmV0dXJuIHsKCQkJCW1hdGNoZXM6IGJvb2wsCgkJCQltZWRpYTogcQoJCQl9OwoKCQl9OwoKCX0oIGRvY3VtZW50ICkpOwoKCS8vICQubW9iaWxlLm1lZGlhIHVzZXMgbWF0Y2hNZWRpYSB0byByZXR1cm4gYSBib29sZWFuLgoJJC5tb2JpbGUubWVkaWEgPSBmdW5jdGlvbiggcSApIHsKCQlyZXR1cm4gd2luZG93Lm1hdGNoTWVkaWEoIHEgKS5tYXRjaGVzOwoJfTsKCn0pKGpRdWVyeSk7CgoJKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHN1cHBvcnQgPSB7CgkJCXRvdWNoOiAib250b3VjaGVuZCIgaW4gZG9jdW1lbnQKCQl9OwoKCQkkLm1vYmlsZS5zdXBwb3J0ID0gJC5tb2JpbGUuc3VwcG9ydCB8fCB7fTsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCBzdXBwb3J0ICk7CgkJJC5leHRlbmQoICQubW9iaWxlLnN1cHBvcnQsIHN1cHBvcnQgKTsKCX0oIGpRdWVyeSApKTsKCgkoZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCQkkLmV4dGVuZCggJC5zdXBwb3J0LCB7CgkJCW9yaWVudGF0aW9uOiAib3JpZW50YXRpb24iIGluIHdpbmRvdyAmJiAib25vcmllbnRhdGlvbmNoYW5nZSIgaW4gd2luZG93CgkJfSk7Cgl9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIHRoeCBNb2Rlcm5penIKZnVuY3Rpb24gcHJvcEV4aXN0cyggcHJvcCApIHsKCXZhciB1Y19wcm9wID0gcHJvcC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgcHJvcC5zdWJzdHIoIDEgKSwKCQlwcm9wcyA9ICggcHJvcCArICIgIiArIHZlbmRvcnMuam9pbiggdWNfcHJvcCArICIgIiApICsgdWNfcHJvcCApLnNwbGl0KCAiICIgKSwKCQl2OwoKCWZvciAoIHYgaW4gcHJvcHMgKSB7CgkJaWYgKCBmYkNTU1sgcHJvcHNbIHYgXSBdICE9PSB1bmRlZmluZWQgKSB7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KfQoKdmFyIGZha2VCb2R5ID0gJCggIjxib2R5PiIgKS5wcmVwZW5kVG8oICJodG1sIiApLAoJZmJDU1MgPSBmYWtlQm9keVsgMCBdLnN0eWxlLAoJdmVuZG9ycyA9IFsgIldlYmtpdCIsICJNb3oiLCAiTyIgXSwKCXdlYm9zID0gInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93LCAvL29ubHkgdXNlZCB0byBydWxlIG91dCBzY3JvbGxUb3AKCW9wZXJhID0gd2luZG93Lm9wZXJhLAoJb3BlcmFtaW5pID0gd2luZG93Lm9wZXJhbWluaSAmJiAoe30pLnRvU3RyaW5nLmNhbGwoIHdpbmRvdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIsCgliYiA9IHdpbmRvdy5ibGFja2JlcnJ5ICYmICFwcm9wRXhpc3RzKCAiLXdlYmtpdC10cmFuc2Zvcm0iICksIC8vb25seSB1c2VkIHRvIHJ1bGUgb3V0IGJveCBzaGFkb3csIGFzIGl0J3MgZmlsbGVkIG9wYXF1ZSBvbiBCQiA1IGFuZCBsb3dlcgoJbm9raWFMVEU3XzM7CgpmdW5jdGlvbiB2YWxpZFN0eWxlKCBwcm9wLCB2YWx1ZSwgY2hlY2tfdmVuZCApIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCXVjID0gZnVuY3Rpb24oIHR4dCApIHsKCQkJcmV0dXJuIHR4dC5jaGFyQXQoIDAgKS50b1VwcGVyQ2FzZSgpICsgdHh0LnN1YnN0ciggMSApOwoJCX0sCgkJdmVuZF9wcmVmID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCWlmICggdmVuZCA9PT0gIiIgKSB7CgkJCQlyZXR1cm4gIiI7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm4gICItIiArIHZlbmQuY2hhckF0KCAwICkudG9Mb3dlckNhc2UoKSArIHZlbmQuc3Vic3RyKCAxICkgKyAiLSI7CgkJCX0KCQl9LAoJCWNoZWNrX3N0eWxlID0gZnVuY3Rpb24oIHZlbmQgKSB7CgkJCXZhciB2ZW5kX3Byb3AgPSB2ZW5kX3ByZWYoIHZlbmQgKSArIHByb3AgKyAiOiAiICsgdmFsdWUgKyAiOyIsCgkJCQl1Y192ZW5kID0gdWMoIHZlbmQgKSwKCQkJCXByb3BTdHlsZSA9IHVjX3ZlbmQgKyAoIHVjX3ZlbmQgPT09ICIiID8gcHJvcCA6IHVjKCBwcm9wICkgKTsKCgkJCWRpdi5zZXRBdHRyaWJ1dGUoICJzdHlsZSIsIHZlbmRfcHJvcCApOwoKCQkJaWYgKCAhIWRpdi5zdHlsZVsgcHJvcFN0eWxlIF0gKSB7CgkJCQlyZXQgPSB0cnVlOwoJCQl9CgkJfSwKCQljaGVja192ZW5kcyA9IGNoZWNrX3ZlbmQgPyBjaGVja192ZW5kIDogdmVuZG9ycywKCQlpLCByZXQ7CgoJZm9yKCBpID0gMDsgaSA8IGNoZWNrX3ZlbmRzLmxlbmd0aDsgaSsrICkgewoJCWNoZWNrX3N0eWxlKCBjaGVja192ZW5kc1tpXSApOwoJfQoJcmV0dXJuICEhcmV0Owp9CgovLyBpbmxpbmUgU1ZHIHN1cHBvcnQgdGVzdApmdW5jdGlvbiBpbmxpbmVTVkcoKSB7CgkvLyBUaGFua3MgTW9kZXJuaXpyICYgRXJpayBEYWhsc3Ryb20KCXZhciB3ID0gd2luZG93LAoJCXN2ZyA9ICEhdy5kb2N1bWVudC5jcmVhdGVFbGVtZW50TlMgJiYgISF3LmRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyggImh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiwgInN2ZyIgKS5jcmVhdGVTVkdSZWN0ICYmICEoIHcub3BlcmEgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCAiQ2hyb21lIiApID09PSAtMSApLAoJCXN1cHBvcnQgPSBmdW5jdGlvbiggZGF0YSApIHsKCQkJaWYgKCAhKCBkYXRhICYmIHN2ZyApICkgewoJCQkJJCggImh0bWwiICkuYWRkQ2xhc3MoICJ1aS1ub3N2ZyIgKTsKCQkJfQoJCX0sCgkJaW1nID0gbmV3IHcuSW1hZ2UoKTsKCglpbWcub25lcnJvciA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGZhbHNlICk7Cgl9OwoJaW1nLm9ubG9hZCA9IGZ1bmN0aW9uKCkgewoJCXN1cHBvcnQoIGltZy53aWR0aCA9PT0gMSAmJiBpbWcuaGVpZ2h0ID09PSAxICk7Cgl9OwoJaW1nLnNyYyA9ICJkYXRhOmltYWdlL2dpZjtiYXNlNjQsUjBsR09EbGhBUUFCQUlBQUFBQUFBUC8vL3l3QUFBQUFBUUFCQUFBQ0FVd0FPdz09IjsKfQoKZnVuY3Rpb24gdHJhbnNmb3JtM2RUZXN0KCkgewoJdmFyIG1xUHJvcCA9ICJ0cmFuc2Zvcm0tM2QiLAoJCS8vIEJlY2F1c2UgdGhlIGB0cmFuc2xhdGUzZGAgdGVzdCBiZWxvdyB0aHJvd3MgZmFsc2UgcG9zaXRpdmVzIGluIEFuZHJvaWQ6CgkJcmV0ID0gJC5tb2JpbGUubWVkaWEoICIoLSIgKyB2ZW5kb3JzLmpvaW4oICItIiArIG1xUHJvcCArICIpLCgtIiApICsgIi0iICsgbXFQcm9wICsgIiksKCIgKyBtcVByb3AgKyAiKSIgKSwKCQllbCwgdHJhbnNmb3JtcywgdDsKCglpZiAoIHJldCApIHsKCQlyZXR1cm4gISFyZXQ7Cgl9CgoJZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJdHJhbnNmb3JtcyA9IHsKCQkvLyBXZeKAmXJlIG9taXR0aW5nIE9wZXJhIGZvciB0aGUgdGltZSBiZWluZzsgTVMgdXNlcyB1bnByZWZpeGVkLgoJCSJNb3pUcmFuc2Zvcm0iOiAiLW1vei10cmFuc2Zvcm0iLAoJCSJ0cmFuc2Zvcm0iOiAidHJhbnNmb3JtIgoJfTsKCglmYWtlQm9keS5hcHBlbmQoIGVsICk7CgoJZm9yICggdCBpbiB0cmFuc2Zvcm1zICkgewoJCWlmICggZWwuc3R5bGVbIHQgXSAhPT0gdW5kZWZpbmVkICkgewoJCQllbC5zdHlsZVsgdCBdID0gInRyYW5zbGF0ZTNkKCAxMDBweCwgMXB4LCAxcHggKSI7CgkJCXJldCA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKCBlbCApLmdldFByb3BlcnR5VmFsdWUoIHRyYW5zZm9ybXNbIHQgXSApOwoJCX0KCX0KCXJldHVybiAoICEhcmV0ICYmIHJldCAhPT0gIm5vbmUiICk7Cn0KCi8vIFRlc3QgZm9yIGR5bmFtaWMtdXBkYXRpbmcgYmFzZSB0YWcgc3VwcG9ydCAoIGFsbG93cyB1cyB0byBhdm9pZCBocmVmLHNyYyBhdHRyIHJld3JpdGluZyApCmZ1bmN0aW9uIGJhc2VUYWdUZXN0KCkgewoJdmFyIGZhdXhCYXNlID0gbG9jYXRpb24ucHJvdG9jb2wgKyAiLy8iICsgbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lICsgInVpLWRpci8iLAoJCWJhc2UgPSAkKCAiaGVhZCBiYXNlIiApLAoJCWZhdXhFbGUgPSBudWxsLAoJCWhyZWYgPSAiIiwKCQlsaW5rLCByZWJhc2U7CgoJaWYgKCAhYmFzZS5sZW5ndGggKSB7CgkJYmFzZSA9IGZhdXhFbGUgPSAkKCAiPGJhc2U+IiwgeyAiaHJlZiI6IGZhdXhCYXNlIH0pLmFwcGVuZFRvKCAiaGVhZCIgKTsKCX0gZWxzZSB7CgkJaHJlZiA9IGJhc2UuYXR0ciggImhyZWYiICk7Cgl9CgoJbGluayA9ICQoICI8YSBocmVmPSd0ZXN0dXJsJyAvPiIgKS5wcmVwZW5kVG8oIGZha2VCb2R5ICk7CglyZWJhc2UgPSBsaW5rWyAwIF0uaHJlZjsKCWJhc2VbIDAgXS5ocmVmID0gaHJlZiB8fCBsb2NhdGlvbi5wYXRobmFtZTsKCglpZiAoIGZhdXhFbGUgKSB7CgkJZmF1eEVsZS5yZW1vdmUoKTsKCX0KCXJldHVybiByZWJhc2UuaW5kZXhPZiggZmF1eEJhc2UgKSA9PT0gMDsKfQoKLy8gVGhhbmtzIE1vZGVybml6cgpmdW5jdGlvbiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpIHsKCXZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggIngiICksCgkJZG9jdW1lbnRFbGVtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LAoJCWdldENvbXB1dGVkU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSwKCQlzdXBwb3J0czsKCglpZiAoICEoICJwb2ludGVyRXZlbnRzIiBpbiBlbGVtZW50LnN0eWxlICkgKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJhdXRvIjsKCWVsZW1lbnQuc3R5bGUucG9pbnRlckV2ZW50cyA9ICJ4IjsKCWRvY3VtZW50RWxlbWVudC5hcHBlbmRDaGlsZCggZWxlbWVudCApOwoJc3VwcG9ydHMgPSBnZXRDb21wdXRlZFN0eWxlICYmCglnZXRDb21wdXRlZFN0eWxlKCBlbGVtZW50LCAiIiApLnBvaW50ZXJFdmVudHMgPT09ICJhdXRvIjsKCWRvY3VtZW50RWxlbWVudC5yZW1vdmVDaGlsZCggZWxlbWVudCApOwoJcmV0dXJuICEhc3VwcG9ydHM7Cn0KCmZ1bmN0aW9uIGJvdW5kaW5nUmVjdCgpIHsKCXZhciBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApOwoJcmV0dXJuIHR5cGVvZiBkaXYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICE9PSAidW5kZWZpbmVkIjsKfQoKLy8gbm9uLVVBLWJhc2VkIElFIHZlcnNpb24gY2hlY2sgYnkgSmFtZXMgUGFkb2xzZXksIG1vZGlmaWVkIGJ5IGpkYWx0b24gLSBmcm9tIGh0dHA6Ly9naXN0LmdpdGh1Yi5jb20vNTI3NjgzCi8vIGFsbG93cyBmb3IgaW5jbHVzaW9uIG9mIElFIDYrLCBpbmNsdWRpbmcgV2luZG93cyBNb2JpbGUgNwokLmV4dGVuZCggJC5tb2JpbGUsIHsgYnJvd3Nlcjoge30gfSApOwokLm1vYmlsZS5icm93c2VyLm9sZElFID0gKGZ1bmN0aW9uKCkgewoJdmFyIHYgPSAzLAoJCWRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJkaXYiICksCgkJYSA9IGRpdi5hbGwgfHwgW107CgoJZG8gewoJCWRpdi5pbm5lckhUTUwgPSAiPCEtLVtpZiBndCBJRSAiICsgKCArK3YgKSArICJdPjxicj48IVtlbmRpZl0tLT4iOwoJfSB3aGlsZSggYVswXSApOwoKCXJldHVybiB2ID4gNCA/IHYgOiAhdjsKfSkoKTsKCmZ1bmN0aW9uIGZpeGVkUG9zaXRpb24oKSB7Cgl2YXIgdyA9IHdpbmRvdywKCQl1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJcGxhdGZvcm0gPSBuYXZpZ2F0b3IucGxhdGZvcm0sCgkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTldKykvICksCgkJd2t2ZXJzaW9uID0gISF3a21hdGNoICYmIHdrbWF0Y2hbIDEgXSwKCQlmZm1hdGNoID0gdWEubWF0Y2goIC9GZW5uZWNcLyhbMC05XSspLyApLAoJCWZmdmVyc2lvbiA9ICEhZmZtYXRjaCAmJiBmZm1hdGNoWyAxIF0sCgkJb3BlcmFtbW9iaWxlbWF0Y2ggPSB1YS5tYXRjaCggL09wZXJhIE1vYmlcLyhbMC05XSspLyApLAoJCW9tdmVyc2lvbiA9ICEhb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb3BlcmFtbW9iaWxlbWF0Y2hbIDEgXTsKCglpZiAoCgkJLy8gaU9TIDQuMyBhbmQgb2xkZXIgOiBQbGF0Zm9ybSBpcyBpUGhvbmUvUGFkL1RvdWNoIGFuZCBXZWJraXQgdmVyc2lvbiBpcyBsZXNzIHRoYW4gNTM0IChpb3M1KQoJCSggKCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBob25lIiApID4gLTEgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQYWQiICkgPiAtMSAgfHwgcGxhdGZvcm0uaW5kZXhPZiggImlQb2QiICkgPiAtMSApICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB8fAoJCS8vIE9wZXJhIE1pbmkKCQkoIHcub3BlcmFtaW5pICYmICh7fSkudG9TdHJpbmcuY2FsbCggdy5vcGVyYW1pbmkgKSA9PT0gIltvYmplY3QgT3BlcmFNaW5pXSIgKSB8fAoJCSggb3BlcmFtbW9iaWxlbWF0Y2ggJiYgb212ZXJzaW9uIDwgNzQ1OCApCXx8CgkJLy9BbmRyb2lkIGx0ZSAyLjE6IFBsYXRmb3JtIGlzIEFuZHJvaWQgYW5kIFdlYmtpdCB2ZXJzaW9uIGlzIGxlc3MgdGhhbiA1MzMgKEFuZHJvaWQgMi4yKQoJCSggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSAmJiB3a3ZlcnNpb24gJiYgd2t2ZXJzaW9uIDwgNTMzICkgfHwKCQkvLyBGaXJlZm94IE1vYmlsZSBiZWZvcmUgNi4wIC0KCQkoIGZmdmVyc2lvbiAmJiBmZnZlcnNpb24gPCA2ICkgfHwKCQkvLyBXZWJPUyBsZXNzIHRoYW4gMwoJCSggInBhbG1HZXRSZXNvdXJjZSIgaW4gd2luZG93ICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKQl8fAoJCS8vIE1lZUdvCgkJKCB1YS5pbmRleE9mKCAiTWVlR28iICkgPiAtMSAmJiB1YS5pbmRleE9mKCAiTm9raWFCcm93c2VyLzguNS4wIiApID4gLTEgKSApIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CgoJcmV0dXJuIHRydWU7Cn0KCiQuZXh0ZW5kKCAkLnN1cHBvcnQsIHsKCWNzc1RyYW5zaXRpb25zOiAiV2ViS2l0VHJhbnNpdGlvbkV2ZW50IiBpbiB3aW5kb3cgfHwKCQl2YWxpZFN0eWxlKCAidHJhbnNpdGlvbiIsICJoZWlnaHQgMTAwbXMgbGluZWFyIiwgWyAiV2Via2l0IiwgIk1veiIsICIiIF0gKSAmJgoJCSEkLm1vYmlsZS5icm93c2VyLm9sZElFICYmICFvcGVyYSwKCgkvLyBOb3RlLCBDaHJvbWUgZm9yIGlPUyBoYXMgYW4gZXh0cmVtZWx5IHF1aXJreSBpbXBsZW1lbnRhdGlvbiBvZiBwb3BzdGF0ZS4KCS8vIFdlJ3ZlIGNob3NlbiB0byB0YWtlIHRoZSBzaG9ydGVzdCBwYXRoIHRvIGEgYnVnIGZpeCBoZXJlIGZvciBpc3N1ZSAjNTQyNgoJLy8gU2VlIHRoZSBmb2xsb3dpbmcgbGluayBmb3IgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHJlZ2V4IGNob3NlbgoJLy8gaHR0cHM6Ly9kZXZlbG9wZXJzLmdvb2dsZS5jb20vY2hyb21lL21vYmlsZS9kb2NzL3VzZXItYWdlbnQjY2hyb21lX2Zvcl9pb3NfdXNlci1hZ2VudAoJcHVzaFN0YXRlOiAicHVzaFN0YXRlIiBpbiBoaXN0b3J5ICYmCgkJInJlcGxhY2VTdGF0ZSIgaW4gaGlzdG9yeSAmJgoJCS8vIFdoZW4gcnVubmluZyBpbnNpZGUgYSBGRiBpZnJhbWUsIGNhbGxpbmcgcmVwbGFjZVN0YXRlIGNhdXNlcyBhbiBlcnJvcgoJCSEoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJGaXJlZm94IiApID49IDAgJiYgd2luZG93LnRvcCAhPT0gd2luZG93ICkgJiYKCQkoIHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50LnNlYXJjaCgvQ3JpT1MvKSA9PT0gLTEgKSwKCgltZWRpYXF1ZXJ5OiAkLm1vYmlsZS5tZWRpYSggIm9ubHkgYWxsIiApLAoJY3NzUHNldWRvRWxlbWVudDogISFwcm9wRXhpc3RzKCAiY29udGVudCIgKSwKCXRvdWNoT3ZlcmZsb3c6ICEhcHJvcEV4aXN0cyggIm92ZXJmbG93U2Nyb2xsaW5nIiApLAoJY3NzVHJhbnNmb3JtM2Q6IHRyYW5zZm9ybTNkVGVzdCgpLAoJY3NzQW5pbWF0aW9uczogISFwcm9wRXhpc3RzKCAiYW5pbWF0aW9uTmFtZSIgKSwKCWJveFNoYWRvdzogISFwcm9wRXhpc3RzKCAiYm94U2hhZG93IiApICYmICFiYiwKCWZpeGVkUG9zaXRpb246IGZpeGVkUG9zaXRpb24oKSwKCXNjcm9sbFRvcDogKCJwYWdlWE9mZnNldCIgaW4gd2luZG93IHx8CgkJInNjcm9sbFRvcCIgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50IHx8CgkJInNjcm9sbFRvcCIgaW4gZmFrZUJvZHlbIDAgXSkgJiYgIXdlYm9zICYmICFvcGVyYW1pbmksCgoJZHluYW1pY0Jhc2VUYWc6IGJhc2VUYWdUZXN0KCksCgljc3NQb2ludGVyRXZlbnRzOiBjc3NQb2ludGVyRXZlbnRzVGVzdCgpLAoJYm91bmRpbmdSZWN0OiBib3VuZGluZ1JlY3QoKSwKCWlubGluZVNWRzogaW5saW5lU1ZHCn0pOwoKZmFrZUJvZHkucmVtb3ZlKCk7CgovLyAkLm1vYmlsZS5hamF4QmxhY2tsaXN0IGlzIHVzZWQgdG8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcyAoQkI1LCBTeW1iaWFuKQovLyBvciB0aGF0IGdlbmVyYWxseSB3b3JrIGJldHRlciBicm93c2luZyBpbiByZWd1bGFyIGh0dHAgZm9yIGZ1bGwgcGFnZSByZWZyZXNoZXMgKE9wZXJhIE1pbmkpCi8vIE5vdGU6IFRoaXMgZGV0ZWN0aW9uIGJlbG93IGlzIHVzZWQgYXMgYSBsYXN0IHJlc29ydC4KLy8gV2UgcmVjb21tZW5kIG9ubHkgdXNpbmcgdGhlc2UgZGV0ZWN0aW9uIG1ldGhvZHMgd2hlbiBhbGwgb3RoZXIgbW9yZSByZWxpYWJsZS9mb3J3YXJkLWxvb2tpbmcgYXBwcm9hY2hlcyBhcmUgbm90IHBvc3NpYmxlCm5va2lhTFRFN18zID0gKGZ1bmN0aW9uKCkgewoKCXZhciB1YSA9IHdpbmRvdy5uYXZpZ2F0b3IudXNlckFnZW50OwoKCS8vVGhlIGZvbGxvd2luZyBpcyBhbiBhdHRlbXB0IHRvIG1hdGNoIE5va2lhIGJyb3dzZXJzIHRoYXQgYXJlIHJ1bm5pbmcgU3ltYmlhbi9zNjAsIHdpdGggd2Via2l0LCB2ZXJzaW9uIDcuMyBvciBvbGRlcgoJcmV0dXJuIHVhLmluZGV4T2YoICJOb2tpYSIgKSA+IC0xICYmCgkJCSggdWEuaW5kZXhPZiggIlN5bWJpYW4vMyIgKSA+IC0xIHx8IHVhLmluZGV4T2YoICJTZXJpZXM2MC81IiApID4gLTEgKSAmJgoJCQl1YS5pbmRleE9mKCAiQXBwbGVXZWJLaXQiICkgPiAtMSAmJgoJCQl1YS5tYXRjaCggLyhCcm93c2VyTkd8Tm9raWFCcm93c2VyKVwvN1wuWzAtM10vICk7Cn0pKCk7CgovLyBTdXBwb3J0IGNvbmRpdGlvbnMgdGhhdCBtdXN0IGJlIG1ldCBpbiBvcmRlciB0byBwcm9jZWVkCi8vIGRlZmF1bHQgZW5oYW5jZWQgcXVhbGlmaWNhdGlvbnMgYXJlIG1lZGlhIHF1ZXJ5IHN1cHBvcnQgT1IgSUUgNysKCiQubW9iaWxlLmdyYWRlQSA9IGZ1bmN0aW9uKCkgewoJcmV0dXJuICggKCAkLnN1cHBvcnQubWVkaWFxdWVyeSAmJiAkLnN1cHBvcnQuY3NzUHNldWRvRWxlbWVudCApIHx8ICQubW9iaWxlLmJyb3dzZXIub2xkSUUgJiYgJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSA+PSA4ICkgJiYgKCAkLnN1cHBvcnQuYm91bmRpbmdSZWN0IHx8ICQuZm4uanF1ZXJ5Lm1hdGNoKC8xXC5bMC03K11cLlswLTkrXT8vKSAhPT0gbnVsbCApOwp9OwoKJC5tb2JpbGUuYWpheEJsYWNrbGlzdCA9CgkJCS8vIEJsYWNrQmVycnkgYnJvd3NlcnMsIHByZS13ZWJraXQKCQkJd2luZG93LmJsYWNrYmVycnkgJiYgIXdpbmRvdy5XZWJLaXRQb2ludCB8fAoJCQkvLyBPcGVyYSBNaW5pCgkJCW9wZXJhbWluaSB8fAoJCQkvLyBTeW1iaWFuIHdlYmtpdHMgcHJlIDcuMwoJCQlub2tpYUxURTdfMzsKCi8vIExhc3RseSwgdGhpcyB3b3JrYXJvdW5kIGlzIHRoZSBvbmx5IHdheSB3ZSd2ZSBmb3VuZCBzbyBmYXIgdG8gZ2V0IHByZSA3LjMgU3ltYmlhbiB3ZWJraXQgZGV2aWNlcwovLyB0byByZW5kZXIgdGhlIHN0eWxlc2hlZXRzIHdoZW4gdGhleSdyZSByZWZlcmVuY2VkIGJlZm9yZSB0aGlzIHNjcmlwdCwgYXMgd2UnZCByZWNvbW1lbmQgZG9pbmcuCi8vIFRoaXMgc2ltcGx5IHJlYXBwZW5kcyB0aGUgQ1NTIGluIHBsYWNlLCB3aGljaCBmb3Igc29tZSByZWFzb24gbWFrZXMgaXQgYXBwbHkKaWYgKCBub2tpYUxURTdfMyApIHsKCSQoZnVuY3Rpb24oKSB7CgkJJCggImhlYWQgbGlua1tyZWw9J3N0eWxlc2hlZXQnXSIgKS5hdHRyKCAicmVsIiwgImFsdGVybmF0ZSBzdHlsZXNoZWV0IiApLmF0dHIoICJyZWwiLCAic3R5bGVzaGVldCIgKTsKCX0pOwp9CgovLyBGb3IgcnVsaW5nIG91dCBzaGFkb3dzIHZpYSBjc3MKaWYgKCAhJC5zdXBwb3J0LmJveFNoYWRvdyApIHsKCSQoICJodG1sIiApLmFkZENsYXNzKCAidWktbm9ib3hzaGFkb3ciICk7Cn0KCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCXZhciAkd2luID0gJC5tb2JpbGUud2luZG93LCBzZWxmLAoJCWR1bW15Rm5Ub0luaXROYXZpZ2F0ZSA9IGZ1bmN0aW9uKCkgewoJCX07CgoJJC5ldmVudC5zcGVjaWFsLmJlZm9yZW5hdmlnYXRlID0gewoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJJHdpbi5vbiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkd2luLm9mZiggIm5hdmlnYXRlIiwgZHVtbXlGblRvSW5pdE5hdmlnYXRlICk7CgkJfQoJfTsKCgkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUgPSBzZWxmID0gewoJCWJvdW5kOiBmYWxzZSwKCgkJcHVzaFN0YXRlRW5hYmxlZDogdHJ1ZSwKCgkJb3JpZ2luYWxFdmVudE5hbWU6IHVuZGVmaW5lZCwKCgkJLy8gSWYgcHVzaHN0YXRlIHN1cHBvcnQgaXMgcHJlc2VudCBhbmQgcHVzaCBzdGF0ZSBzdXBwb3J0IGlzIGRlZmluZWQgdG8KCQkvLyBiZSB0cnVlIG9uIHRoZSBtb2JpbGUgbmFtZXNwYWNlLgoJCWlzUHVzaFN0YXRlRW5hYmxlZDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLnN1cHBvcnQucHVzaFN0YXRlICYmCgkJCQkkLm1vYmlsZS5wdXNoU3RhdGVFbmFibGVkID09PSB0cnVlICYmCgkJCQl0aGlzLmlzSGFzaENoYW5nZUVuYWJsZWQoKTsKCQl9LAoKCQkvLyAhISBhc3N1bWVzIG1vYmlsZSBuYW1lc3BhY2UgaXMgcHJlc2VudAoJCWlzSGFzaENoYW5nZUVuYWJsZWQ6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgPT09IHRydWU7CgkJfSwKCgkJLy8gVE9ETyBhIGxvdCBvZiBkdXBsaWNhdGlvbiBiZXR3ZWVuIHBvcHN0YXRlIGFuZCBoYXNoY2hhbmdlCgkJcG9wc3RhdGU6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIG5ld0V2ZW50ID0gbmV3ICQuRXZlbnQoICJuYXZpZ2F0ZSIgKSwKCQkJCWJlZm9yZU5hdmlnYXRlID0gbmV3ICQuRXZlbnQoICJiZWZvcmVuYXZpZ2F0ZSIgKSwKCQkJCXN0YXRlID0gZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSB8fCB7fTsKCgkJCWJlZm9yZU5hdmlnYXRlLm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCQkJJHdpbi50cmlnZ2VyKCBiZWZvcmVOYXZpZ2F0ZSApOwoKCQkJaWYgKCBiZWZvcmVOYXZpZ2F0ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBldmVudC5oaXN0b3J5U3RhdGUgKSB7CgkJCQkkLmV4dGVuZChzdGF0ZSwgZXZlbnQuaGlzdG9yeVN0YXRlKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHRoZSBvcmlnaW5hbCBldmVudCBpcyB0cmFja2VkIGZvciB0aGUgZW5kCgkJCS8vIHVzZXIgdG8gaW5zcGVjdCBpbmNhc2UgdGhleSB3YW50IHRvIGRvIHNvbWV0aGluZyBzcGVjaWFsCgkJCW5ld0V2ZW50Lm9yaWdpbmFsRXZlbnQgPSBldmVudDsKCgkJCS8vIE5PVEUgd2UgbGV0IHRoZSBjdXJyZW50IHN0YWNrIHVud2luZCBiZWNhdXNlIGFueSBhc3NpZ25tZW50IHRvCgkJCS8vICAgICAgbG9jYXRpb24uaGFzaCB3aWxsIHN0b3AgdGhlIHdvcmxkIGFuZCBydW4gdGhpcyBldmVudCBoYW5kbGVyLiBCeQoJCQkvLyAgICAgIGRvaW5nIHRoaXMgd2UgY3JlYXRlIGEgc2ltaWxhciBiZWhhdmlvciB0byBoYXNoY2hhbmdlIG9uIGhhc2gKCQkJLy8gICAgICBhc3NpZ25tZW50CgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkJc3RhdGU6IHN0YXRlCgkJCQl9KTsKCQkJfSwgMCk7CgkJfSwKCgkJaGFzaGNoYW5nZTogZnVuY3Rpb24oIGV2ZW50IC8qLCBkYXRhICovICkgewoJCQl2YXIgbmV3RXZlbnQgPSBuZXcgJC5FdmVudCggIm5hdmlnYXRlIiApLAoJCQkJYmVmb3JlTmF2aWdhdGUgPSBuZXcgJC5FdmVudCggImJlZm9yZW5hdmlnYXRlIiApOwoKCQkJYmVmb3JlTmF2aWdhdGUub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoJCQkkd2luLnRyaWdnZXIoIGJlZm9yZU5hdmlnYXRlICk7CgoJCQlpZiAoIGJlZm9yZU5hdmlnYXRlLmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBNYWtlIHN1cmUgdGhlIG9yaWdpbmFsIGV2ZW50IGlzIHRyYWNrZWQgZm9yIHRoZSBlbmQKCQkJLy8gdXNlciB0byBpbnNwZWN0IGluY2FzZSB0aGV5IHdhbnQgdG8gZG8gc29tZXRoaW5nIHNwZWNpYWwKCQkJbmV3RXZlbnQub3JpZ2luYWxFdmVudCA9IGV2ZW50OwoKCQkJLy8gVHJpZ2dlciB0aGUgaGFzaGNoYW5nZSB3aXRoIHN0YXRlIHByb3ZpZGVkIGJ5IHRoZSB1c2VyCgkJCS8vIHRoYXQgYWx0ZXJlZCB0aGUgaGFzaAoJCQkkd2luLnRyaWdnZXIoIG5ld0V2ZW50LCB7CgkJCQkvLyBVc2VycyB0aGF0IHdhbnQgdG8gZnVsbHkgbm9ybWFsaXplIHRoZSB0d28gZXZlbnRzCgkJCQkvLyB3aWxsIG5lZWQgdG8gZG8gaGlzdG9yeSBtYW5hZ2VtZW50IGRvd24gdGhlIHN0YWNrIGFuZAoJCQkJLy8gYWRkIHRoZSBzdGF0ZSB0byB0aGUgZXZlbnQgYmVmb3JlIHRoaXMgYmluZGluZyBpcyBmaXJlZAoJCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBmb3IgdGhlIGV4cGxpY2l0IGFkZGl0aW9uIG9mIGNhbGxiYWNrcwoJCQkJLy8gICAgICB0byBiZSBmaXJlZCBiZWZvcmUgdGhpcyB2YWx1ZSBpcyBzZXQgdG8gYXZvaWQgZXZlbnQgdGltaW5nIGlzc3VlcwoJCQkJc3RhdGU6IGV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSB8fCB7fQoJCQl9KTsKCQl9LAoKCQkvLyBUT0RPIFdlIHJlYWxseSBvbmx5IHdhbnQgdG8gc2V0IHRoaXMgdXAgb25jZQoJCS8vICAgICAgYnV0IEknbSBub3QgY2xlYXIgaWYgdGhlcmUncyBhIGJldGVyIHdheSB0byBhY2hpZXZlCgkJLy8gICAgICB0aGlzIHdpdGggdGhlIGpRdWVyeSBzcGVjaWFsIGV2ZW50IHN0cnVjdHVyZQoJCXNldHVwOiBmdW5jdGlvbiggLyogZGF0YSwgbmFtZXNwYWNlcyAqLyApIHsKCQkJaWYgKCBzZWxmLmJvdW5kICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZWxmLmJvdW5kID0gdHJ1ZTsKCgkJCWlmICggc2VsZi5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCXNlbGYub3JpZ2luYWxFdmVudE5hbWUgPSAicG9wc3RhdGUiOwoJCQkJJHdpbi5iaW5kKCAicG9wc3RhdGUubmF2aWdhdGUiLCBzZWxmLnBvcHN0YXRlICk7CgkJCX0gZWxzZSBpZiAoIHNlbGYuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpICkgewoJCQkJc2VsZi5vcmlnaW5hbEV2ZW50TmFtZSA9ICJoYXNoY2hhbmdlIjsKCQkJCSR3aW4uYmluZCggImhhc2hjaGFuZ2UubmF2aWdhdGUiLCBzZWxmLmhhc2hjaGFuZ2UgKTsKCQkJfQoJCX0KCX07Cn0pKCBqUXVlcnkgKTsKCgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkJdmFyIHBhdGgsICRiYXNlLCBkaWFsb2dIYXNoS2V5ID0gIiZ1aS1zdGF0ZT1kaWFsb2ciOwoKCQkkLm1vYmlsZS5wYXRoID0gcGF0aCA9IHsKCQkJdWlTdGF0ZUtleTogIiZ1aS1zdGF0ZSIsCgoJCQkvLyBUaGlzIHNjYXJ5IGxvb2tpbmcgcmVndWxhciBleHByZXNzaW9uIHBhcnNlcyBhbiBhYnNvbHV0ZSBVUkwgb3IgaXRzIHJlbGF0aXZlCgkJCS8vIHZhcmlhbnRzIChwcm90b2NvbCwgc2l0ZSwgZG9jdW1lbnQsIHF1ZXJ5LCBhbmQgaGFzaCksIGludG8gdGhlIHZhcmlvdXMKCQkJLy8gY29tcG9uZW50cyAocHJvdG9jb2wsIGhvc3QsIHBhdGgsIHF1ZXJ5LCBmcmFnbWVudCwgZXRjIHRoYXQgbWFrZSB1cCB0aGUKCQkJLy8gVVJMIGFzIHdlbGwgYXMgc29tZSBvdGhlciBjb21tb25seSB1c2VkIHN1Yi1wYXJ0cy4gV2hlbiB1c2VkIHdpdGggUmVnRXhwLmV4ZWMoKQoJCQkvLyBvciBTdHJpbmcubWF0Y2gsIGl0IHBhcnNlcyB0aGUgVVJMIGludG8gYSByZXN1bHRzIGFycmF5IHRoYXQgbG9va3MgbGlrZSB0aGlzOgoJCQkvLwoJCQkvLyAgICAgWzBdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwL21haWwvaW5ib3g/bXNnPTEyMzQmdHlwZT11bnJlYWQjbXNnLWNvbnRlbnQKCQkJLy8gICAgIFsxXTogaHR0cDovL2pibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MC9tYWlsL2luYm94P21zZz0xMjM0JnR5cGU9dW5yZWFkCgkJCS8vICAgICBbMl06IGh0dHA6Ly9qYmxhczpwYXNzd29yZEBteWNvbXBhbnkuY29tOjgwODAvbWFpbC9pbmJveAoJCQkvLyAgICAgWzNdOiBodHRwOi8vamJsYXM6cGFzc3dvcmRAbXljb21wYW55LmNvbTo4MDgwCgkJCS8vICAgICBbNF06IGh0dHA6CgkJCS8vICAgICBbNV06IC8vCgkJCS8vICAgICBbNl06IGpibGFzOnBhc3N3b3JkQG15Y29tcGFueS5jb206ODA4MAoJCQkvLyAgICAgWzddOiBqYmxhczpwYXNzd29yZAoJCQkvLyAgICAgWzhdOiBqYmxhcwoJCQkvLyAgICAgWzldOiBwYXNzd29yZAoJCQkvLyAgICBbMTBdOiBteWNvbXBhbnkuY29tOjgwODAKCQkJLy8gICAgWzExXTogbXljb21wYW55LmNvbQoJCQkvLyAgICBbMTJdOiA4MDgwCgkJCS8vICAgIFsxM106IC9tYWlsL2luYm94CgkJCS8vICAgIFsxNF06IC9tYWlsLwoJCQkvLyAgICBbMTVdOiBpbmJveAoJCQkvLyAgICBbMTZdOiA/bXNnPTEyMzQmdHlwZT11bnJlYWQKCQkJLy8gICAgWzE3XTogI21zZy1jb250ZW50CgkJCS8vCgkJCXVybFBhcnNlUkU6IC9eXHMqKCgoKFteOlwvI1w/XSs6KT8oPzooXC9cLykoKD86KChbXjpAXC8jXD9dKykoPzpcOihbXjpAXC8jXD9dKykpPylAKT8oKFteOlwvI1w/XF1cW10rfFxbW15cL1xdQCM/XStcXSkoPzpcOihbMC05XSspKT8pKT8pPyk/KChcLz8oPzpbXlwvXD8jXStcLyspKikoW15cPyNdKikpKT8oXD9bXiNdKyk/KSgjLiopPy8sCgoJCQkvLyBBYnN0cmFjdGlvbiB0byBhZGRyZXNzIHhzcyAoSXNzdWUgIzQ3ODcpIGJ5IHJlbW92aW5nIHRoZSBhdXRob3JpdHkgaW4KCQkJLy8gYnJvd3NlcnMgdGhhdCBhdXRvCWRlY29kZSBpdC4gQWxsIHJlZmVyZW5jZXMgdG8gbG9jYXRpb24uaHJlZiBzaG91bGQgYmUKCQkJLy8gcmVwbGFjZWQgd2l0aCBhIGNhbGwgdG8gdGhpcyBtZXRob2Qgc28gdGhhdCBpdCBjYW4gYmUgZGVhbHQgd2l0aCBwcm9wZXJseSBoZXJlCgkJCWdldExvY2F0aW9uOiBmdW5jdGlvbiggdXJsICkgewoJCQkJdmFyIHVyaSA9IHVybCA/IHRoaXMucGFyc2VVcmwoIHVybCApIDogbG9jYXRpb24sCgkJCQkJaGFzaCA9IHRoaXMucGFyc2VVcmwoIHVybCB8fCBsb2NhdGlvbi5ocmVmICkuaGFzaDsKCgkJCQkvLyBtaW1pYyB0aGUgYnJvd3NlciB3aXRoIGFuIGVtcHR5IHN0cmluZyB3aGVuIHRoZSBoYXNoIGlzIGVtcHR5CgkJCQloYXNoID0gaGFzaCA9PT0gIiMiID8gIiIgOiBoYXNoOwoKCQkJCS8vIE1ha2Ugc3VyZSB0byBwYXJzZSB0aGUgdXJsIG9yIHRoZSBsb2NhdGlvbiBvYmplY3QgZm9yIHRoZSBoYXNoIGJlY2F1c2UgdXNpbmcgbG9jYXRpb24uaGFzaAoJCQkJLy8gaXMgYXV0b2RlY29kZWQgaW4gZmlyZWZveCwgdGhlIHJlc3Qgb2YgdGhlIHVybCBzaG91bGQgYmUgZnJvbSB0aGUgb2JqZWN0IChsb2NhdGlvbiB1bmxlc3MKCQkJCS8vIHdlJ3JlIHRlc3RpbmcpIHRvIGF2b2lkIHRoZSBpbmNsdXNpb24gb2YgdGhlIGF1dGhvcml0eQoJCQkJcmV0dXJuIHVyaS5wcm90b2NvbCArICIvLyIgKyB1cmkuaG9zdCArIHVyaS5wYXRobmFtZSArIHVyaS5zZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9yZXR1cm4gdGhlIG9yaWdpbmFsIGRvY3VtZW50IHVybAoJCQlnZXREb2N1bWVudFVybDogZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQkJcmV0dXJuIGFzUGFyc2VkT2JqZWN0ID8gJC5leHRlbmQoIHt9LCBwYXRoLmRvY3VtZW50VXJsICkgOiBwYXRoLmRvY3VtZW50VXJsLmhyZWY7CgkJCX0sCgoJCQlwYXJzZUxvY2F0aW9uOiBmdW5jdGlvbigpIHsKCQkJCXJldHVybiB0aGlzLnBhcnNlVXJsKCB0aGlzLmdldExvY2F0aW9uKCkgKTsKCQkJfSwKCgkJCS8vUGFyc2UgYSBVUkwgaW50byBhIHN0cnVjdHVyZSB0aGF0IGFsbG93cyBlYXN5IGFjY2VzcyB0bwoJCQkvL2FsbCBvZiB0aGUgVVJMIGNvbXBvbmVudHMgYnkgbmFtZS4KCQkJcGFyc2VVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBJZiB3ZSdyZSBwYXNzZWQgYW4gb2JqZWN0LCB3ZSdsbCBhc3N1bWUgdGhhdCBpdCBpcwoJCQkJLy8gYSBwYXJzZWQgdXJsIG9iamVjdCBhbmQganVzdCByZXR1cm4gaXQgYmFjayB0byB0aGUgY2FsbGVyLgoJCQkJaWYgKCAkLnR5cGUoIHVybCApID09PSAib2JqZWN0IiApIHsKCQkJCQlyZXR1cm4gdXJsOwoJCQkJfQoKCQkJCXZhciBtYXRjaGVzID0gcGF0aC51cmxQYXJzZVJFLmV4ZWMoIHVybCB8fCAiIiApIHx8IFtdOwoKCQkJCQkvLyBDcmVhdGUgYW4gb2JqZWN0IHRoYXQgYWxsb3dzIHRoZSBjYWxsZXIgdG8gYWNjZXNzIHRoZSBzdWItbWF0Y2hlcwoJCQkJCS8vIGJ5IG5hbWUuIE5vdGUgdGhhdCBJRSByZXR1cm5zIGFuIGVtcHR5IHN0cmluZyBpbnN0ZWFkIG9mIHVuZGVmaW5lZCwKCQkJCQkvLyBsaWtlIGFsbCBvdGhlciBicm93c2VycyBkbywgc28gd2Ugbm9ybWFsaXplIGV2ZXJ5dGhpbmcgc28gaXRzIGNvbnNpc3RlbnQKCQkJCQkvLyBubyBtYXR0ZXIgd2hhdCBicm93c2VyIHdlJ3JlIHJ1bm5pbmcgb24uCgkJCQkJcmV0dXJuIHsKCQkJCQkJaHJlZjogICAgICAgICBtYXRjaGVzWyAgMCBdIHx8ICIiLAoJCQkJCQlocmVmTm9IYXNoOiAgIG1hdGNoZXNbICAxIF0gfHwgIiIsCgkJCQkJCWhyZWZOb1NlYXJjaDogbWF0Y2hlc1sgIDIgXSB8fCAiIiwKCQkJCQkJZG9tYWluOiAgICAgICBtYXRjaGVzWyAgMyBdIHx8ICIiLAoJCQkJCQlwcm90b2NvbDogICAgIG1hdGNoZXNbICA0IF0gfHwgIiIsCgkJCQkJCWRvdWJsZVNsYXNoOiAgbWF0Y2hlc1sgIDUgXSB8fCAiIiwKCQkJCQkJYXV0aG9yaXR5OiAgICBtYXRjaGVzWyAgNiBdIHx8ICIiLAoJCQkJCQl1c2VybmFtZTogICAgIG1hdGNoZXNbICA4IF0gfHwgIiIsCgkJCQkJCXBhc3N3b3JkOiAgICAgbWF0Y2hlc1sgIDkgXSB8fCAiIiwKCQkJCQkJaG9zdDogICAgICAgICBtYXRjaGVzWyAxMCBdIHx8ICIiLAoJCQkJCQlob3N0bmFtZTogICAgIG1hdGNoZXNbIDExIF0gfHwgIiIsCgkJCQkJCXBvcnQ6ICAgICAgICAgbWF0Y2hlc1sgMTIgXSB8fCAiIiwKCQkJCQkJcGF0aG5hbWU6ICAgICBtYXRjaGVzWyAxMyBdIHx8ICIiLAoJCQkJCQlkaXJlY3Rvcnk6ICAgIG1hdGNoZXNbIDE0IF0gfHwgIiIsCgkJCQkJCWZpbGVuYW1lOiAgICAgbWF0Y2hlc1sgMTUgXSB8fCAiIiwKCQkJCQkJc2VhcmNoOiAgICAgICBtYXRjaGVzWyAxNiBdIHx8ICIiLAoJCQkJCQloYXNoOiAgICAgICAgIG1hdGNoZXNbIDE3IF0gfHwgIiIKCQkJCQl9OwoJCQl9LAoKCQkJLy9UdXJuIHJlbFBhdGggaW50byBhbiBhc2JvbHV0ZSBwYXRoLiBhYnNQYXRoIGlzCgkJCS8vYW4gb3B0aW9uYWwgYWJzb2x1dGUgcGF0aCB3aGljaCBkZXNjcmliZXMgd2hhdAoJCQkvL3JlbFBhdGggaXMgcmVsYXRpdmUgdG8uCgkJCW1ha2VQYXRoQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxQYXRoLCBhYnNQYXRoICkgewoJCQkJdmFyIGFic1N0YWNrLAoJCQkJCXJlbFN0YWNrLAoJCQkJCWksIGQ7CgoJCQkJaWYgKCByZWxQYXRoICYmIHJlbFBhdGguY2hhckF0KCAwICkgPT09ICIvIiApIHsKCQkJCQlyZXR1cm4gcmVsUGF0aDsKCQkJCX0KCgkJCQlyZWxQYXRoID0gcmVsUGF0aCB8fCAiIjsKCQkJCWFic1BhdGggPSBhYnNQYXRoID8gYWJzUGF0aC5yZXBsYWNlKCAvXlwvfChcL1teXC9dKnxbXlwvXSspJC9nLCAiIiApIDogIiI7CgoJCQkJYWJzU3RhY2sgPSBhYnNQYXRoID8gYWJzUGF0aC5zcGxpdCggIi8iICkgOiBbXTsKCQkJCXJlbFN0YWNrID0gcmVsUGF0aC5zcGxpdCggIi8iICk7CgoJCQkJZm9yICggaSA9IDA7IGkgPCByZWxTdGFjay5sZW5ndGg7IGkrKyApIHsKCQkJCQlkID0gcmVsU3RhY2tbIGkgXTsKCQkJCQlzd2l0Y2ggKCBkICkgewoJCQkJCQljYXNlICIuIjoKCQkJCQkJCWJyZWFrOwoJCQkJCQljYXNlICIuLiI6CgkJCQkJCQlpZiAoIGFic1N0YWNrLmxlbmd0aCApIHsKCQkJCQkJCQlhYnNTdGFjay5wb3AoKTsKCQkJCQkJCX0KCQkJCQkJCWJyZWFrOwoJCQkJCQlkZWZhdWx0OgoJCQkJCQkJYWJzU3RhY2sucHVzaCggZCApOwoJCQkJCQkJYnJlYWs7CgkJCQkJfQoJCQkJfQoJCQkJcmV0dXJuICIvIiArIGFic1N0YWNrLmpvaW4oICIvIiApOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgaWYgYm90aCB1cmxzIGhhdmUgdGhlIHNhbWUgZG9tYWluLgoJCQlpc1NhbWVEb21haW46IGZ1bmN0aW9uKCBhYnNVcmwxLCBhYnNVcmwyICkgewoJCQkJcmV0dXJuIHBhdGgucGFyc2VVcmwoIGFic1VybDEgKS5kb21haW4gPT09IHBhdGgucGFyc2VVcmwoIGFic1VybDIgKS5kb21haW47CgkJCX0sCgoJCQkvL1JldHVybnMgdHJ1ZSBmb3IgYW55IHJlbGF0aXZlIHZhcmlhbnQuCgkJCWlzUmVsYXRpdmVVcmw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQkvLyBBbGwgcmVsYXRpdmUgVXJsIHZhcmlhbnRzIGhhdmUgb25lIHRoaW5nIGluIGNvbW1vbiwgbm8gcHJvdG9jb2wuCgkJCQlyZXR1cm4gcGF0aC5wYXJzZVVybCggdXJsICkucHJvdG9jb2wgPT09ICIiOwoJCQl9LAoKCQkJLy9SZXR1cm5zIHRydWUgZm9yIGFuIGFic29sdXRlIHVybC4KCQkJaXNBYnNvbHV0ZVVybDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiBwYXRoLnBhcnNlVXJsKCB1cmwgKS5wcm90b2NvbCAhPT0gIiI7CgkJCX0sCgoJCQkvL1R1cm4gdGhlIHNwZWNpZmllZCByZWFsdGl2ZSBVUkwgaW50byBhbiBhYnNvbHV0ZSBvbmUuIFRoaXMgZnVuY3Rpb24KCQkJLy9jYW4gaGFuZGxlIGFsbCByZWxhdGl2ZSB2YXJpYW50cyAocHJvdG9jb2wsIHNpdGUsIGRvY3VtZW50LCBxdWVyeSwgZnJhZ21lbnQpLgoJCQltYWtlVXJsQWJzb2x1dGU6IGZ1bmN0aW9uKCByZWxVcmwsIGFic1VybCApIHsKCQkJCWlmICggIXBhdGguaXNSZWxhdGl2ZVVybCggcmVsVXJsICkgKSB7CgkJCQkJcmV0dXJuIHJlbFVybDsKCQkJCX0KCgkJCQlpZiAoIGFic1VybCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCWFic1VybCA9IHRoaXMuZG9jdW1lbnRCYXNlOwoJCQkJfQoKCQkJCXZhciByZWxPYmogPSBwYXRoLnBhcnNlVXJsKCByZWxVcmwgKSwKCQkJCQlhYnNPYmogPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKSwKCQkJCQlwcm90b2NvbCA9IHJlbE9iai5wcm90b2NvbCB8fCBhYnNPYmoucHJvdG9jb2wsCgkJCQkJZG91YmxlU2xhc2ggPSByZWxPYmoucHJvdG9jb2wgPyByZWxPYmouZG91YmxlU2xhc2ggOiAoIHJlbE9iai5kb3VibGVTbGFzaCB8fCBhYnNPYmouZG91YmxlU2xhc2ggKSwKCQkJCQlhdXRob3JpdHkgPSByZWxPYmouYXV0aG9yaXR5IHx8IGFic09iai5hdXRob3JpdHksCgkJCQkJaGFzUGF0aCA9IHJlbE9iai5wYXRobmFtZSAhPT0gIiIsCgkJCQkJcGF0aG5hbWUgPSBwYXRoLm1ha2VQYXRoQWJzb2x1dGUoIHJlbE9iai5wYXRobmFtZSB8fCBhYnNPYmouZmlsZW5hbWUsIGFic09iai5wYXRobmFtZSApLAoJCQkJCXNlYXJjaCA9IHJlbE9iai5zZWFyY2ggfHwgKCAhaGFzUGF0aCAmJiBhYnNPYmouc2VhcmNoICkgfHwgIiIsCgkJCQkJaGFzaCA9IHJlbE9iai5oYXNoOwoKCQkJCXJldHVybiBwcm90b2NvbCArIGRvdWJsZVNsYXNoICsgYXV0aG9yaXR5ICsgcGF0aG5hbWUgKyBzZWFyY2ggKyBoYXNoOwoJCQl9LAoKCQkJLy9BZGQgc2VhcmNoIChha2EgcXVlcnkpIHBhcmFtcyB0byB0aGUgc3BlY2lmaWVkIHVybC4KCQkJYWRkU2VhcmNoUGFyYW1zOiBmdW5jdGlvbiggdXJsLCBwYXJhbXMgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApLAoJCQkJCXAgPSAoIHR5cGVvZiBwYXJhbXMgPT09ICJvYmplY3QiICkgPyAkLnBhcmFtKCBwYXJhbXMgKSA6IHBhcmFtcywKCQkJCQlzID0gdS5zZWFyY2ggfHwgIj8iOwoJCQkJcmV0dXJuIHUuaHJlZk5vU2VhcmNoICsgcyArICggcy5jaGFyQXQoIHMubGVuZ3RoIC0gMSApICE9PSAiPyIgPyAiJiIgOiAiIiApICsgcCArICggdS5oYXNoIHx8ICIiICk7CgkJCX0sCgoJCQljb252ZXJ0VXJsVG9EYXRhVXJsOiBmdW5jdGlvbiggYWJzVXJsICkgewoJCQkJdmFyIHUgPSBwYXRoLnBhcnNlVXJsKCBhYnNVcmwgKTsKCQkJCWlmICggcGF0aC5pc0VtYmVkZGVkUGFnZSggdSApICkgewoJCQkJCS8vIEZvciBlbWJlZGRlZCBwYWdlcywgcmVtb3ZlIHRoZSBkaWFsb2cgaGFzaCBrZXkgYXMgaW4gZ2V0RmlsZVBhdGgoKSwKCQkJCQkvLyBhbmQgcmVtb3ZlIG90aGVyd2lzZSB0aGUgRGF0YSBVcmwgd29uJ3QgbWF0Y2ggdGhlIGlkIG9mIHRoZSBlbWJlZGRlZCBQYWdlLgoJCQkJCXJldHVybiB1Lmhhc2gKCQkJCQkJLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF0KCQkJCQkJLnJlcGxhY2UoIC9eIy8sICIiICkKCQkJCQkJLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCQl9IGVsc2UgaWYgKCBwYXRoLmlzU2FtZURvbWFpbiggdSwgdGhpcy5kb2N1bWVudEJhc2UgKSApIHsKCQkJCQlyZXR1cm4gdS5ocmVmTm9IYXNoLnJlcGxhY2UoIHRoaXMuZG9jdW1lbnRCYXNlLmRvbWFpbiwgIiIgKS5zcGxpdCggZGlhbG9nSGFzaEtleSApWzBdOwoJCQkJfQoKCQkJCXJldHVybiB3aW5kb3cuZGVjb2RlVVJJQ29tcG9uZW50KGFic1VybCk7CgkJCX0sCgoJCQkvL2dldCBwYXRoIGZyb20gY3VycmVudCBoYXNoLCBvciBmcm9tIGEgZmlsZSBwYXRoCgkJCWdldDogZnVuY3Rpb24oIG5ld1BhdGggKSB7CgkJCQlpZiAoIG5ld1BhdGggPT09IHVuZGVmaW5lZCApIHsKCQkJCQluZXdQYXRoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJCX0KCQkJCXJldHVybiBwYXRoLnN0cmlwSGFzaCggbmV3UGF0aCApLnJlcGxhY2UoIC9bXlwvXSpcLlteXC8qXSskLywgIiIgKTsKCQkJfSwKCgkJCS8vc2V0IGxvY2F0aW9uIGhhc2ggdG8gcGF0aAoJCQlzZXQ6IGZ1bmN0aW9uKCBwYXRoICkgewoJCQkJbG9jYXRpb24uaGFzaCA9IHBhdGg7CgkJCX0sCgoJCQkvL3Rlc3QgaWYgYSBnaXZlbiB1cmwgKHN0cmluZykgaXMgYSBwYXRoCgkJCS8vTk9URSBtaWdodCBiZSBleGNlcHRpb25hbGx5IG5haXZlCgkJCWlzUGF0aDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiAoIC9cLy8gKS50ZXN0KCB1cmwgKTsKCQkJfSwKCgkJCS8vcmV0dXJuIGEgdXJsIHBhdGggd2l0aCB0aGUgd2luZG93J3MgbG9jYXRpb24gcHJvdG9jb2wvaG9zdG5hbWUvcGF0aG5hbWUgcmVtb3ZlZAoJCQljbGVhbjogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggdGhpcy5kb2N1bWVudEJhc2UuZG9tYWluLCAiIiApOwoJCQl9LAoKCQkJLy9qdXN0IHJldHVybiB0aGUgdXJsIHdpdGhvdXQgYW4gaW5pdGlhbCAjCgkJCXN0cmlwSGFzaDogZnVuY3Rpb24oIHVybCApIHsKCQkJCXJldHVybiB1cmwucmVwbGFjZSggL14jLywgIiIgKTsKCQkJfSwKCgkJCXN0cmlwUXVlcnlQYXJhbXM6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gdXJsLnJlcGxhY2UoIC9cPy4qJC8sICIiICk7CgkJCX0sCgoJCQkvL3JlbW92ZSB0aGUgcHJlY2VkaW5nIGhhc2gsIGFueSBxdWVyeSBwYXJhbXMsIGFuZCBkaWFsb2cgbm90YXRpb25zCgkJCWNsZWFuSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gcGF0aC5zdHJpcEhhc2goIGhhc2gucmVwbGFjZSggL1w/LiokLywgIiIgKS5yZXBsYWNlKCBkaWFsb2dIYXNoS2V5LCAiIiApICk7CgkJCX0sCgoJCQlpc0hhc2hWYWxpZDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gKCAvXiNbXiNdKyQvICkudGVzdCggaGFzaCApOwoJCQl9LAoKCQkJLy9jaGVjayB3aGV0aGVyIGEgdXJsIGlzIHJlZmVyZW5jaW5nIHRoZSBzYW1lIGRvbWFpbiwgb3IgYW4gZXh0ZXJuYWwgZG9tYWluIG9yIGRpZmZlcmVudCBwcm90b2NvbAoJCQkvL2NvdWxkIGJlIG1haWx0bywgZXRjCgkJCWlzRXh0ZXJuYWw6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoJCQkJcmV0dXJuIHUucHJvdG9jb2wgJiYgdS5kb21haW4gIT09IHRoaXMuZG9jdW1lbnRVcmwuZG9tYWluID8gdHJ1ZSA6IGZhbHNlOwoJCQl9LAoKCQkJaGFzUHJvdG9jb2w6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQlyZXR1cm4gKCAvXig6P1x3KzopLyApLnRlc3QoIHVybCApOwoJCQl9LAoKCQkJaXNFbWJlZGRlZFBhZ2U6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHVybCApOwoKCQkJCS8vaWYgdGhlIHBhdGggaXMgYWJzb2x1dGUsIHRoZW4gd2UgbmVlZCB0byBjb21wYXJlIHRoZSB1cmwgYWdhaW5zdAoJCQkJLy9ib3RoIHRoZSB0aGlzLmRvY3VtZW50VXJsIGFuZCB0aGUgZG9jdW1lbnRCYXNlLiBUaGUgbWFpbiByZWFzb24gZm9yIHRoaXMKCQkJCS8vaXMgdGhhdCBsaW5rcyBlbWJlZGRlZCB3aXRoaW4gZXh0ZXJuYWwgZG9jdW1lbnRzIHdpbGwgcmVmZXIgdG8gdGhlCgkJCQkvL2FwcGxpY2F0aW9uIGRvY3VtZW50LCB3aGVyZWFzIGxpbmtzIGVtYmVkZGVkIHdpdGhpbiB0aGUgYXBwbGljYXRpb24KCQkJCS8vZG9jdW1lbnQgd2lsbCBiZSByZXNvbHZlZCBhZ2FpbnN0IHRoZSBkb2N1bWVudCBiYXNlLgoJCQkJaWYgKCB1LnByb3RvY29sICE9PSAiIiApIHsKCQkJCQlyZXR1cm4gKCAhdGhpcy5pc1BhdGgodS5oYXNoKSAmJiB1Lmhhc2ggJiYgKCB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fCAoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJiB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSApICk7CgkJCQl9CgkJCQlyZXR1cm4gKCAvXiMvICkudGVzdCggdS5ocmVmICk7CgkJCX0sCgoJCQlzcXVhc2g6IGZ1bmN0aW9uKCB1cmwsIHJlc29sdXRpb25VcmwgKSB7CgkJCQl2YXIgaHJlZiwgY2xlYW5lZFVybCwgc2VhcmNoLCBzdGF0ZUluZGV4LAoJCQkJCWlzUGF0aCA9IHRoaXMuaXNQYXRoKCB1cmwgKSwKCQkJCQl1cmkgPSB0aGlzLnBhcnNlVXJsKCB1cmwgKSwKCQkJCQlwcmVzZXJ2ZWRIYXNoID0gdXJpLmhhc2gsCgkJCQkJdWlTdGF0ZSA9ICIiOwoKCQkJCS8vIHByb2R1Y2UgYSB1cmwgYWdhaW5zdCB3aGljaCB3ZSBjYW4gcmVzb2xlIHRoZSBwcm92aWRlZCBwYXRoCgkJCQlyZXNvbHV0aW9uVXJsID0gcmVzb2x1dGlvblVybCB8fCAocGF0aC5pc1BhdGgodXJsKSA/IHBhdGguZ2V0TG9jYXRpb24oKSA6IHBhdGguZ2V0RG9jdW1lbnRVcmwoKSk7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhbnl0aGluZyBidXQgYSBzaW1wbGUgc3RyaW5nLCByZW1vdmUgYW55IHByZWNlZGluZyBoYXNoCgkJCQkvLyBlZyAjZm9vL2JhciAtPiBmb28vYmFyCgkJCQkvLyAgICAjZm9vIC0+ICNmb28KCQkJCWNsZWFuZWRVcmwgPSBpc1BhdGggPyBwYXRoLnN0cmlwSGFzaCggdXJsICkgOiB1cmw7CgoJCQkJLy8gSWYgdGhlIHVybCBpcyBhIGZ1bGwgdXJsIHdpdGggYSBoYXNoIGNoZWNrIGlmIHRoZSBwYXJzZWQgaGFzaCBpcyBhIHBhdGgKCQkJCS8vIGlmIGl0IGlzLCBzdHJpcCB0aGUgIywgYW5kIHVzZSBpdCBvdGhlcndpc2UgY29udGludWUgd2l0aG91dCBjaGFuZ2UKCQkJCWNsZWFuZWRVcmwgPSBwYXRoLmlzUGF0aCggdXJpLmhhc2ggKSA/IHBhdGguc3RyaXBIYXNoKCB1cmkuaGFzaCApIDogY2xlYW5lZFVybDsKCgkJCQkvLyBTcGxpdCB0aGUgVUkgU3RhdGUga2V5cyBvZmYgdGhlIGhyZWYKCQkJCXN0YXRlSW5kZXggPSBjbGVhbmVkVXJsLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApOwoKCQkJCS8vIHN0b3JlIHRoZSB1aSBzdGF0ZSBrZXlzIGZvciB1c2UKCQkJCWlmICggc3RhdGVJbmRleCA+IC0xICkgewoJCQkJCXVpU3RhdGUgPSBjbGVhbmVkVXJsLnNsaWNlKCBzdGF0ZUluZGV4ICk7CgkJCQkJY2xlYW5lZFVybCA9IGNsZWFuZWRVcmwuc2xpY2UoIDAsIHN0YXRlSW5kZXggKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHRoZSBjbGVhbmVkVXJsIGFic29sdXRlIHJlbGF0aXZlIHRvIHRoZSByZXNvbHV0aW9uIHVybAoJCQkJaHJlZiA9IHBhdGgubWFrZVVybEFic29sdXRlKCBjbGVhbmVkVXJsLCByZXNvbHV0aW9uVXJsICk7CgoJCQkJLy8gZ3JhYiB0aGUgc2VhcmNoIGZyb20gdGhlIHJlc29sdmVkIHVybCBzaW5jZSBwYXJzaW5nIGZyb20KCQkJCS8vIHRoZSBwYXNzZWQgdXJsIG1heSBub3QgeWllbGQgdGhlIGNvcnJlY3QgcmVzdWx0CgkJCQlzZWFyY2ggPSB0aGlzLnBhcnNlVXJsKCBocmVmICkuc2VhcmNoOwoKCQkJCS8vIFRPRE8gYWxsIHRoaXMgY3JhcCBpcyB0ZXJyaWJsZSwgY2xlYW4gaXQgdXAKCQkJCWlmICggaXNQYXRoICkgewoJCQkJCS8vIHJlamVjdCB0aGUgaGFzaCBpZiBpdCdzIGEgcGF0aCBvciBpdCdzIGp1c3QgYSBkaWFsb2cga2V5CgkJCQkJaWYgKCBwYXRoLmlzUGF0aCggcHJlc2VydmVkSGFzaCApIHx8IHByZXNlcnZlZEhhc2gucmVwbGFjZSgiIyIsICIiKS5pbmRleE9mKCB0aGlzLnVpU3RhdGVLZXkgKSA9PT0gMCkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiI7CgkJCQkJfQoKCQkJCQkvLyBBcHBlbmQgdGhlIFVJIFN0YXRlIGtleXMgd2hlcmUgaXQgZXhpc3RzIGFuZCBpdCdzIGJlZW4gcmVtb3ZlZAoJCQkJCS8vIGZyb20gdGhlIHVybAoJCQkJCWlmICggdWlTdGF0ZSAmJiBwcmVzZXJ2ZWRIYXNoLmluZGV4T2YoIHRoaXMudWlTdGF0ZUtleSApID09PSAtMSkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoICs9IHVpU3RhdGU7CgkJCQkJfQoKCQkJCQkvLyBtYWtlIHN1cmUgdGhhdCBwb3VuZCBpcyBvbiB0aGUgZnJvbnQgb2YgdGhlIGhhc2gKCQkJCQlpZiAoIHByZXNlcnZlZEhhc2guaW5kZXhPZiggIiMiICkgPT09IC0xICYmIHByZXNlcnZlZEhhc2ggIT09ICIiICkgewoJCQkJCQlwcmVzZXJ2ZWRIYXNoID0gIiMiICsgcHJlc2VydmVkSGFzaDsKCQkJCQl9CgoJCQkJCS8vIHJlY29uc3RydWN0IGVhY2ggb2YgdGhlIHBpZWNlcyB3aXRoIHRoZSBuZXcgc2VhcmNoIHN0cmluZyBhbmQgaGFzaAoJCQkJCWhyZWYgPSBwYXRoLnBhcnNlVXJsKCBocmVmICk7CgkJCQkJaHJlZiA9IGhyZWYucHJvdG9jb2wgKyAiLy8iICsgaHJlZi5ob3N0ICsgaHJlZi5wYXRobmFtZSArIHNlYXJjaCArIHByZXNlcnZlZEhhc2g7CgkJCQl9IGVsc2UgewoJCQkJCWhyZWYgKz0gaHJlZi5pbmRleE9mKCAiIyIgKSA+IC0xID8gdWlTdGF0ZSA6ICIjIiArIHVpU3RhdGU7CgkJCQl9CgoJCQkJcmV0dXJuIGhyZWY7CgkJCX0sCgoJCQlpc1ByZXNlcnZhYmxlSGFzaDogZnVuY3Rpb24oIGhhc2ggKSB7CgkJCQlyZXR1cm4gaGFzaC5yZXBsYWNlKCAiIyIsICIiICkuaW5kZXhPZiggdGhpcy51aVN0YXRlS2V5ICkgPT09IDA7CgkJCX0sCgoJCQkvLyBFc2NhcGUgd2VpcmQgY2hhcmFjdGVycyBpbiB0aGUgaGFzaCBpZiBpdCBpcyB0byBiZSB1c2VkIGFzIGEgc2VsZWN0b3IKCQkJaGFzaFRvU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCQkJdmFyIGhhc0hhc2ggPSAoIGhhc2guc3Vic3RyaW5nKCAwLCAxICkgPT09ICIjIiApOwoJCQkJaWYgKCBoYXNIYXNoICkgewoJCQkJCWhhc2ggPSBoYXNoLnN1YnN0cmluZyggMSApOwoJCQkJfQoJCQkJcmV0dXJuICggaGFzSGFzaCA/ICIjIiA6ICIiICkgKyBoYXNoLnJlcGxhY2UoIC8oWyEiIyQlJicoKSorLC4vOjs8PT4/QFtcXV5ge3x9fl0pL2csICJcXCQxIiApOwoJCQl9LAoKCQkJLy8gcmV0dXJuIHRoZSBzdWJzdHJpbmcgb2YgYSBmaWxlcGF0aCBiZWZvcmUgdGhlIHN1Yi1wYWdlIGtleSwgZm9yIG1ha2luZwoJCQkvLyBhIHNlcnZlciByZXF1ZXN0CgkJCWdldEZpbGVQYXRoOiBmdW5jdGlvbiggcGF0aCApIHsKCQkJCXZhciBzcGxpdGtleSA9ICImIiArICQubW9iaWxlLnN1YlBhZ2VVcmxLZXk7CgkJCQlyZXR1cm4gcGF0aCAmJiBwYXRoLnNwbGl0KCBzcGxpdGtleSApWzBdLnNwbGl0KCBkaWFsb2dIYXNoS2V5IClbMF07CgkJCX0sCgoJCQkvLyBjaGVjayBpZiB0aGUgc3BlY2lmaWVkIHVybCByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIG1haW4KCQkJLy8gYXBwbGljYXRpb24gZG9jdW1lbnQuCgkJCWlzRmlyc3RQYWdlVXJsOiBmdW5jdGlvbiggdXJsICkgewoJCQkJLy8gV2Ugb25seSBkZWFsIHdpdGggYWJzb2x1dGUgcGF0aHMuCgkJCQl2YXIgdSA9IHBhdGgucGFyc2VVcmwoIHBhdGgubWFrZVVybEFic29sdXRlKCB1cmwsIHRoaXMuZG9jdW1lbnRCYXNlICkgKSwKCgkJCQkJLy8gRG9lcyB0aGUgdXJsIGhhdmUgdGhlIHNhbWUgcGF0aCBhcyB0aGUgZG9jdW1lbnQ/CgkJCQkJc2FtZVBhdGggPSB1LmhyZWZOb0hhc2ggPT09IHRoaXMuZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCB8fAoJCQkJCQkoIHRoaXMuZG9jdW1lbnRCYXNlRGlmZmVycyAmJgoJCQkJCQkJdS5ocmVmTm9IYXNoID09PSB0aGlzLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoICksCgoJCQkJCS8vIEdldCB0aGUgZmlyc3QgcGFnZSBlbGVtZW50LgoJCQkJCWZwID0gJC5tb2JpbGUuZmlyc3RQYWdlLAoKCQkJCQkvLyBHZXQgdGhlIGlkIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQgaWYgaXQgaGFzIG9uZS4KCQkJCQlmcElkID0gZnAgJiYgZnBbMF0gPyBmcFswXS5pZCA6IHVuZGVmaW5lZDsKCgkJCQkvLyBUaGUgdXJsIHJlZmVycyB0byB0aGUgZmlyc3QgcGFnZSBpZiB0aGUgcGF0aCBtYXRjaGVzIHRoZSBkb2N1bWVudCBhbmQKCQkJCS8vIGl0IGVpdGhlciBoYXMgbm8gaGFzaCB2YWx1ZSwgb3IgdGhlIGhhc2ggaXMgZXhhY3RseSBlcXVhbCB0byB0aGUgaWQKCQkJCS8vIG9mIHRoZSBmaXJzdCBwYWdlIGVsZW1lbnQuCgkJCQlyZXR1cm4gc2FtZVBhdGggJiYKCQkJCQkoICF1Lmhhc2ggfHwKCQkJCQkJdS5oYXNoID09PSAiIyIgfHwKCQkJCQkJKCBmcElkICYmIHUuaGFzaC5yZXBsYWNlKCAvXiMvLCAiIiApID09PSBmcElkICkgKTsKCQkJfSwKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cKCQkJLy8gY3Jvc3MtZG9tYWluIFhIUiByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZAoJCQkvLyB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8KCQkJLy8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMgZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyCgkJCS8vIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZSBhbGxvd0Nyb3NzRG9tYWluUGFnZXMKCQkJLy8gb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMgcmVxdWVzdHMgdG8gZ28KCQkJLy8gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoJCQlpc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdDogZnVuY3Rpb24oIGRvY1VybCwgcmVxVXJsICkgewoJCQkJcmV0dXJuICQubW9iaWxlLmFsbG93Q3Jvc3NEb21haW5QYWdlcyAmJgoJCQkJCShkb2NVcmwucHJvdG9jb2wgPT09ICJmaWxlOiIgfHwgZG9jVXJsLnByb3RvY29sID09PSAiY29udGVudDoiKSAmJgoJCQkJCXJlcVVybC5zZWFyY2goIC9eaHR0cHM/Oi8gKSAhPT0gLTE7CgkJCX0KCQl9OwoKCQlwYXRoLmRvY3VtZW50VXJsID0gcGF0aC5wYXJzZUxvY2F0aW9uKCk7CgoJCSRiYXNlID0gJCggImhlYWQiICkuZmluZCggImJhc2UiICk7CgoJCXBhdGguZG9jdW1lbnRCYXNlID0gJGJhc2UubGVuZ3RoID8KCQkJcGF0aC5wYXJzZVVybCggcGF0aC5tYWtlVXJsQWJzb2x1dGUoICRiYXNlLmF0dHIoICJocmVmIiApLCBwYXRoLmRvY3VtZW50VXJsLmhyZWYgKSApIDoKCQkJcGF0aC5kb2N1bWVudFVybDsKCgkJcGF0aC5kb2N1bWVudEJhc2VEaWZmZXJzID0gKHBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaCAhPT0gcGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCk7CgoJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCBiYXNlIHVybAoJCXBhdGguZ2V0RG9jdW1lbnRCYXNlID0gZnVuY3Rpb24oIGFzUGFyc2VkT2JqZWN0ICkgewoJCQlyZXR1cm4gYXNQYXJzZWRPYmplY3QgPyAkLmV4dGVuZCgge30sIHBhdGguZG9jdW1lbnRCYXNlICkgOiBwYXRoLmRvY3VtZW50QmFzZS5ocmVmOwoJCX07CgoJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgaW4gMS41LjAKCQkkLmV4dGVuZCggJC5tb2JpbGUsIHsKCgkJCS8vcmV0dXJuIHRoZSBvcmlnaW5hbCBkb2N1bWVudCB1cmwKCQkJZ2V0RG9jdW1lbnRVcmw6IHBhdGguZ2V0RG9jdW1lbnRVcmwsCgoJCQkvL3JldHVybiB0aGUgb3JpZ2luYWwgZG9jdW1lbnQgYmFzZSB1cmwKCQkJZ2V0RG9jdW1lbnRCYXNlOiBwYXRoLmdldERvY3VtZW50QmFzZQoJCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJJC5tb2JpbGUuSGlzdG9yeSA9IGZ1bmN0aW9uKCBzdGFjaywgaW5kZXggKSB7CgkJdGhpcy5zdGFjayA9IHN0YWNrIHx8IFtdOwoJCXRoaXMuYWN0aXZlSW5kZXggPSBpbmRleCB8fCAwOwoJfTsKCgkkLmV4dGVuZCgkLm1vYmlsZS5IaXN0b3J5LnByb3RvdHlwZSwgewoJCWdldEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IF07CgkJfSwKCgkJZ2V0TGFzdDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLnByZXZpb3VzSW5kZXggXTsKCQl9LAoKCQlnZXROZXh0OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuIHRoaXMuc3RhY2tbIHRoaXMuYWN0aXZlSW5kZXggKyAxIF07CgkJfSwKCgkJZ2V0UHJldjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiB0aGlzLnN0YWNrWyB0aGlzLmFjdGl2ZUluZGV4IC0gMSBdOwoJCX0sCgoJCS8vIGFkZE5ldyBpcyB1c2VkIHdoZW5ldmVyIGEgbmV3IHBhZ2UgaXMgYWRkZWQKCQlhZGQ6IGZ1bmN0aW9uKCB1cmwsIGRhdGEgKSB7CgkJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQkJLy9pZiB0aGVyZSdzIGZvcndhcmQgaGlzdG9yeSwgd2lwZSBpdAoJCQlpZiAoIHRoaXMuZ2V0TmV4dCgpICkgewoJCQkJdGhpcy5jbGVhckZvcndhcmQoKTsKCQkJfQoKCQkJLy8gaWYgdGhlIGhhc2ggaXMgaW5jbHVkZWQgaW4gdGhlIGRhdGEgbWFrZSBzdXJlIHRoZSBzaGFwZQoJCQkvLyBpcyBjb25zaXN0ZW50IGZvciBjb21wYXJpc29uCgkJCWlmICggZGF0YS5oYXNoICYmIGRhdGEuaGFzaC5pbmRleE9mKCAiIyIgKSA9PT0gLTEpIHsKCQkJCWRhdGEuaGFzaCA9ICIjIiArIGRhdGEuaGFzaDsKCQkJfQoKCQkJZGF0YS51cmwgPSB1cmw7CgkJCXRoaXMuc3RhY2sucHVzaCggZGF0YSApOwoJCQl0aGlzLmFjdGl2ZUluZGV4ID0gdGhpcy5zdGFjay5sZW5ndGggLSAxOwoJCX0sCgoJCS8vd2lwZSB1cmxzIGFoZWFkIG9mIGFjdGl2ZSBpbmRleAoJCWNsZWFyRm9yd2FyZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc3RhY2sgPSB0aGlzLnN0YWNrLnNsaWNlKCAwLCB0aGlzLmFjdGl2ZUluZGV4ICsgMSApOwoJCX0sCgoJCWZpbmQ6IGZ1bmN0aW9uKCB1cmwsIHN0YWNrLCBlYXJseVJldHVybiApIHsKCQkJc3RhY2sgPSBzdGFjayB8fCB0aGlzLnN0YWNrOwoKCQkJdmFyIGVudHJ5LCBpLCBsZW5ndGggPSBzdGFjay5sZW5ndGgsIGluZGV4OwoKCQkJZm9yICggaSA9IDA7IGkgPCBsZW5ndGg7IGkrKyApIHsKCQkJCWVudHJ5ID0gc3RhY2tbaV07CgoJCQkJaWYgKCBkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5LnVybCkgfHwKCQkJCQlkZWNvZGVVUklDb21wb25lbnQodXJsKSA9PT0gZGVjb2RlVVJJQ29tcG9uZW50KGVudHJ5Lmhhc2gpICkgewoJCQkJCWluZGV4ID0gaTsKCgkJCQkJaWYgKCBlYXJseVJldHVybiApIHsKCQkJCQkJcmV0dXJuIGluZGV4OwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJcmV0dXJuIGluZGV4OwoJCX0sCgoJCWNsb3Nlc3Q6IGZ1bmN0aW9uKCB1cmwgKSB7CgkJCXZhciBjbG9zZXN0LCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIEZpcnN0LCB0YWtlIHRoZSBzbGljZSBvZiB0aGUgaGlzdG9yeSBzdGFjayBiZWZvcmUgdGhlIGN1cnJlbnQgaW5kZXggYW5kIHNlYXJjaAoJCQkvLyBmb3IgYSB1cmwgbWF0Y2guIElmIG9uZSBpcyBmb3VuZCwgd2UnbGwgYXZvaWQgYXZvaWQgbG9va2luZyB0aHJvdWdoIGZvcndhcmQgaGlzdG9yeQoJCQkvLyBOT1RFIHRoZSBwcmVmZXJlbmNlIGZvciBiYWNrd2FyZCBoaXN0b3J5IG1vdmVtZW50IGlzIGRyaXZlbiBieSB0aGUgZmFjdCB0aGF0CgkJCS8vICAgICAgbW9zdCBtb2JpbGUgYnJvd3NlcnMgb25seSBoYXZlIGEgZGVkaWNhdGVkIGJhY2sgYnV0dG9uLCBhbmQgdXNlcnMgcmFyZWx5IHVzZQoJCQkvLyAgICAgIHRoZSBmb3J3YXJkIGJ1dHRvbiBpbiBkZXNrdG9wIGJyb3dzZXIgYW55aG93CgkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZSgwLCBhKSApOwoKCQkJLy8gSWYgbm90aGluZyB3YXMgZm91bmQgaW4gYmFja3dhcmQgaGlzdG9yeSBjaGVjayBmb3J3YXJkLiBUaGUgYHRydWVgCgkJCS8vIHZhbHVlIHBhc3NlZCBhcyB0aGUgdGhpcmQgcGFyYW1ldGVyIGNhdXNlcyB0aGUgZmluZCBtZXRob2QgdG8gYnJlYWsKCQkJLy8gb24gdGhlIGZpcnN0IG1hdGNoIGluIHRoZSBmb3J3YXJkIGhpc3Rvcnkgc2xpY2UuIFRoZSBzdGFydGluZyBpbmRleAoJCQkvLyBvZiB0aGUgc2xpY2UgbXVzdCB0aGVuIGJlIGFkZGVkIHRvIHRoZSByZXN1bHQgdG8gZ2V0IHRoZSBlbGVtZW50IGluZGV4CgkJCS8vIGluIHRoZSBvcmlnaW5hbCBoaXN0b3J5IHN0YWNrIDooIDooCgkJCS8vCgkJCS8vIFRPRE8gdGhpcyBpcyBoeXBlciBjb25mdXNpbmcgYW5kIHNob3VsZCBiZSBjbGVhbmVkIHVwICh1Z2ggc28gYmFkKQoJCQlpZiAoIGNsb3Nlc3QgPT09IHVuZGVmaW5lZCApIHsKCQkJCWNsb3Nlc3QgPSB0aGlzLmZpbmQoIHVybCwgdGhpcy5zdGFjay5zbGljZShhKSwgdHJ1ZSApOwoJCQkJY2xvc2VzdCA9IGNsb3Nlc3QgPT09IHVuZGVmaW5lZCA/IGNsb3Nlc3QgOiBjbG9zZXN0ICsgYTsKCQkJfQoKCQkJcmV0dXJuIGNsb3Nlc3Q7CgkJfSwKCgkJZGlyZWN0OiBmdW5jdGlvbiggb3B0cyApIHsKCQkJdmFyIG5ld0FjdGl2ZUluZGV4ID0gdGhpcy5jbG9zZXN0KCBvcHRzLnVybCApLCBhID0gdGhpcy5hY3RpdmVJbmRleDsKCgkJCS8vIHNhdmUgbmV3IHBhZ2UgaW5kZXgsIG51bGwgY2hlY2sgdG8gcHJldmVudCBmYWxzZXkgMCByZXN1bHQKCQkJLy8gcmVjb3JkIHRoZSBwcmV2aW91cyBpbmRleCBmb3IgcmVmZXJlbmNlCgkJCWlmICggbmV3QWN0aXZlSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuYWN0aXZlSW5kZXggPSBuZXdBY3RpdmVJbmRleDsKCQkJCXRoaXMucHJldmlvdXNJbmRleCA9IGE7CgkJCX0KCgkJCS8vIGludm9rZSBjYWxsYmFja3Mgd2hlcmUgYXBwcm9wcmlhdGUKCQkJLy8KCQkJLy8gVE9ETyB0aGlzIGlzIGFsc28gY29udm9sdXRlZCBhbmQgY29uZnVzaW5nCgkJCWlmICggbmV3QWN0aXZlSW5kZXggPCBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5iYWNrIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiYmFjayIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPiBhICkgewoJCQkJKCBvcHRzLnByZXNlbnQgfHwgb3B0cy5mb3J3YXJkIHx8ICQubm9vcCApKCB0aGlzLmdldEFjdGl2ZSgpLCAiZm9yd2FyZCIgKTsKCQkJfSBlbHNlIGlmICggbmV3QWN0aXZlSW5kZXggPT09IHVuZGVmaW5lZCAmJiBvcHRzLm1pc3NpbmcgKSB7CgkJCQlvcHRzLm1pc3NpbmcoIHRoaXMuZ2V0QWN0aXZlKCkgKTsKCQkJfQoJCX0KCX0pOwp9KSggalF1ZXJ5ICk7CgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoJdmFyIHBhdGggPSAkLm1vYmlsZS5wYXRoLAoJCWluaXRpYWxIcmVmID0gbG9jYXRpb24uaHJlZjsKCgkkLm1vYmlsZS5OYXZpZ2F0b3IgPSBmdW5jdGlvbiggaGlzdG9yeSApIHsKCQl0aGlzLmhpc3RvcnkgPSBoaXN0b3J5OwoJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgPSB0cnVlOwoKCQkkLm1vYmlsZS53aW5kb3cuYmluZCh7CgkJCSJwb3BzdGF0ZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5wb3BzdGF0ZSwgdGhpcyApLAoJCQkiaGFzaGNoYW5nZS5oaXN0b3J5IjogJC5wcm94eSggdGhpcy5oYXNoY2hhbmdlLCB0aGlzICkKCQl9KTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuTmF2aWdhdG9yLnByb3RvdHlwZSwgewoJCXNxdWFzaDogZnVuY3Rpb24oIHVybCwgZGF0YSApIHsKCQkJdmFyIHN0YXRlLCBocmVmLCBoYXNoID0gcGF0aC5pc1BhdGgodXJsKSA/IHBhdGguc3RyaXBIYXNoKHVybCkgOiB1cmw7CgoJCQlocmVmID0gcGF0aC5zcXVhc2goIHVybCApOwoKCQkJLy8gbWFrZSBzdXJlIHRvIHByb3ZpZGUgdGhpcyBpbmZvcm1hdGlvbiB3aGVuIGl0IGlzbid0IGV4cGxpY2l0bHkgc2V0IGluIHRoZQoJCQkvLyBkYXRhIG9iamVjdCB0aGF0IHdhcyBwYXNzZWQgdG8gdGhlIHNxdWFzaCBtZXRob2QKCQkJc3RhdGUgPSAkLmV4dGVuZCh7CgkJCQloYXNoOiBoYXNoLAoJCQkJdXJsOiBocmVmCgkJCX0sIGRhdGEpOwoKCQkJLy8gcmVwbGFjZSB0aGUgY3VycmVudCB1cmwgd2l0aCB0aGUgbmV3IGhyZWYgYW5kIHN0b3JlIHRoZSBzdGF0ZQoJCQkvLyBOb3RlIHRoYXQgaW4gc29tZSBjYXNlcyB3ZSBtaWdodCBiZSByZXBsYWNpbmcgYW4gdXJsIHdpdGggdGhlCgkJCS8vIHNhbWUgdXJsLiBXZSBkbyB0aGlzIGFueXdheXMgYmVjYXVzZSB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGF0CgkJCS8vIGFsbCBvZiBvdXIgaGlzdG9yeSBlbnRyaWVzIGhhdmUgYSBzdGF0ZSBvYmplY3QgYXNzb2NpYXRlZCB3aXRoCgkJCS8vIHRoZW0uIFRoaXMgYWxsb3dzIHVzIHRvIHdvcmsgYXJvdW5kIHRoZSBjYXNlIHdoZXJlICQubW9iaWxlLmJhY2soKQoJCQkvLyBpcyBjYWxsZWQgdG8gdHJhbnNpdGlvbiBmcm9tIGFuIGV4dGVybmFsIHBhZ2UgdG8gYW4gZW1iZWRkZWQgcGFnZS4KCQkJLy8gSW4gdGhhdCBwYXJ0aWN1bGFyIGNhc2UsIGEgaGFzaGNoYW5nZSBldmVudCBpcyAqTk9UKiBnZW5lcmF0ZWQgYnkgdGhlIGJyb3dzZXIuCgkJCS8vIEVuc3VyaW5nIGVhY2ggaGlzdG9yeSBlbnRyeSBoYXMgYSBzdGF0ZSBvYmplY3QgbWVhbnMgdGhhdCBvblBvcFN0YXRlKCkKCQkJLy8gd2lsbCBhbHdheXMgdHJpZ2dlciBvdXIgaGFzaGNoYW5nZSBjYWxsYmFjayBldmVuIHdoZW4gYSBoYXNoY2hhbmdlIGV2ZW50CgkJCS8vIGlzIG5vdCBmaXJlZC4KCQkJd2luZG93Lmhpc3RvcnkucmVwbGFjZVN0YXRlKCBzdGF0ZSwgc3RhdGUudGl0bGUgfHwgZG9jdW1lbnQudGl0bGUsIGhyZWYgKTsKCgkJCXJldHVybiBzdGF0ZTsKCQl9LAoKCQloYXNoOiBmdW5jdGlvbiggdXJsLCBocmVmICkgewoJCQl2YXIgcGFyc2VkLCBsb2MsIGhhc2gsIHJlc29sdmVkOwoKCQkJLy8gR3JhYiB0aGUgaGFzaCBmb3IgcmVjb3JkaW5nLiBJZiB0aGUgcGFzc2VkIHVybCBpcyBhIHBhdGgKCQkJLy8gd2UgdXNlZCB0aGUgcGFyc2VkIHZlcnNpb24gb2YgdGhlIHNxdWFzaGVkIHVybCB0byByZWNvbnN0cnVjdCwKCQkJLy8gb3RoZXJ3aXNlIHdlIGFzc3VtZSBpdCdzIGEgaGFzaCBhbmQgc3RvcmUgaXQgZGlyZWN0bHkKCQkJcGFyc2VkID0gcGF0aC5wYXJzZVVybCggdXJsICk7CgkJCWxvYyA9IHBhdGgucGFyc2VMb2NhdGlvbigpOwoKCQkJaWYgKCBsb2MucGF0aG5hbWUgKyBsb2Muc2VhcmNoID09PSBwYXJzZWQucGF0aG5hbWUgKyBwYXJzZWQuc2VhcmNoICkgewoJCQkJLy8gSWYgdGhlIHBhdGhuYW1lIGFuZCBzZWFyY2ggb2YgdGhlIHBhc3NlZCB1cmwgaXMgaWRlbnRpY2FsIHRvIHRoZSBjdXJyZW50IGxvYwoJCQkJLy8gdGhlbiB3ZSBtdXN0IHVzZSB0aGUgaGFzaC4gT3RoZXJ3aXNlIHRoZXJlIHdpbGwgYmUgbm8gZXZlbnQKCQkJCS8vIGVnLCB1cmwgPSAiL2Zvby9iYXI/YmF6I2JhbmciLCBsb2NhdGlvbi5ocmVmID0gImh0dHA6Ly9leGFtcGxlLmNvbS9mb28vYmFyP2JheiIKCQkJCWhhc2ggPSBwYXJzZWQuaGFzaCA/IHBhcnNlZC5oYXNoIDogcGFyc2VkLnBhdGhuYW1lICsgcGFyc2VkLnNlYXJjaDsKCQkJfSBlbHNlIGlmICggcGF0aC5pc1BhdGgodXJsKSApIHsKCQkJCXJlc29sdmVkID0gcGF0aC5wYXJzZVVybCggaHJlZiApOwoJCQkJLy8gSWYgdGhlIHBhc3NlZCB1cmwgaXMgYSBwYXRoLCBtYWtlIGl0IGRvbWFpbiByZWxhdGl2ZSBhbmQgcmVtb3ZlIGFueSB0cmFpbGluZyBoYXNoCgkJCQloYXNoID0gcmVzb2x2ZWQucGF0aG5hbWUgKyByZXNvbHZlZC5zZWFyY2ggKyAocGF0aC5pc1ByZXNlcnZhYmxlSGFzaCggcmVzb2x2ZWQuaGFzaCApPyByZXNvbHZlZC5oYXNoLnJlcGxhY2UoICIjIiwgIiIgKSA6ICIiKTsKCQkJfSBlbHNlIHsKCQkJCWhhc2ggPSB1cmw7CgkJCX0KCgkJCXJldHVybiBoYXNoOwoJCX0sCgoJCS8vIFRPRE8gcmVjb25zaWRlciBuYW1lCgkJZ286IGZ1bmN0aW9uKCB1cmwsIGRhdGEsIG5vRXZlbnRzICkgewoJCQl2YXIgc3RhdGUsIGhyZWYsIGhhc2gsIHBvcHN0YXRlRXZlbnQsCgkJCQlpc1BvcFN0YXRlRXZlbnQgPSAkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCk7CgoJCQkvLyBHZXQgdGhlIHVybCBhcyBpdCB3b3VsZCBsb29rIHNxdWFzaGVkIG9uIHRvIHRoZSBjdXJyZW50IHJlc29sdXRpb24gdXJsCgkJCWhyZWYgPSBwYXRoLnNxdWFzaCggdXJsICk7CgoJCQkvLyBzb3J0IG91dCB3aGF0IHRoZSBoYXNoIHNvdWxkIGJlIGZyb20gdGhlIHVybAoJCQloYXNoID0gdGhpcy5oYXNoKCB1cmwsIGhyZWYgKTsKCgkJCS8vIEhlcmUgd2UgcHJldmVudCB0aGUgbmV4dCBoYXNoIGNoYW5nZSBvciBwb3BzdGF0ZSBldmVudCBmcm9tIGRvaW5nIGFueQoJCQkvLyBoaXN0b3J5IG1hbmFnZW1lbnQuIEluIHRoZSBjYXNlIG9mIGhhc2hjaGFuZ2Ugd2UgZG9uJ3Qgc3dhbGxvdyBpdAoJCQkvLyBpZiB0aGVyZSB3aWxsIGJlIG5vIGhhc2hjaGFuZ2UgZmlyZWQgKHNpbmNlIHRoYXQgd29uJ3QgcmVzZXQgdGhlIHZhbHVlKQoJCQkvLyBhbmQgd2lsbCBzd2FsbG93IHRoZSBmb2xsb3dpbmcgaGFzaGNoYW5nZQoJCQlpZiAoIG5vRXZlbnRzICYmIGhhc2ggIT09IHBhdGguc3RyaXBIYXNoKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICkgewoJCQkJdGhpcy5wcmV2ZW50TmV4dEhhc2hDaGFuZ2UgPSBub0V2ZW50czsKCQkJfQoKCQkJLy8gSU1QT1JUQU5UIGluIHRoZSBjYXNlIHdoZXJlIHBvcHN0YXRlIGlzIHN1cHBvcnRlZCB0aGUgZXZlbnQgd2lsbCBiZSB0cmlnZ2VyZWQKCQkJLy8gICAgICBkaXJlY3RseSwgc3RvcHBpbmcgZnVydGhlciBleGVjdXRpb24gLSBpZSwgaW50ZXJ1cHRpbmcgdGhlIGZsb3cgb2YgdGhpcwoJCQkvLyAgICAgIG1ldGhvZCBjYWxsIHRvIGZpcmUgYmluZGluZ3MgYXQgdGhpcyBleHByZXNzaW9uLiBCZWxvdyB0aGUgbmF2aWdhdGUgbWV0aG9kCgkJCS8vICAgICAgdGhlcmUgaXMgYSBiaW5kaW5nIHRvIGNhdGNoIHRoaXMgZXZlbnQgYW5kIHN0b3AgaXRzIHByb3BhZ2F0aW9uLgoJCQkvLwoJCQkvLyAgICAgIFdlIHRoZW4gdHJpZ2dlciBhIG5ldyBwb3BzdGF0ZSBldmVudCBvbiB0aGUgd2luZG93IHdpdGggYSBudWxsIHN0YXRlCgkJCS8vICAgICAgc28gdGhhdCB0aGUgbmF2aWdhdGUgZXZlbnRzIGNhbiBjb25jbHVkZSB0aGVpciB3b3JrIHByb3Blcmx5CgkJCS8vCgkJCS8vIGlmIHRoZSB1cmwgaXMgYSBwYXRoIHdlIHdhbnQgdG8gcHJlc2VydmUgdGhlIHF1ZXJ5IHBhcmFtcyB0aGF0IGFyZSBhdmFpbGFibGUgb24KCQkJLy8gdGhlIGN1cnJlbnQgdXJsLgoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSB0cnVlOwoJCQl3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgoJCQkvLyBJZiBwb3BzdGF0ZSBpcyBlbmFibGVkIGFuZCB0aGUgYnJvd3NlciB0cmlnZ2VycyBgcG9wc3RhdGVgIGV2ZW50cyB3aGVuIHRoZSBoYXNoCgkJCS8vIGlzIHNldCAodGhpcyBvZnRlbiBoYXBwZW5zIGltbWVkaWF0ZWx5IGluIGJyb3dzZXJzIGxpa2UgQ2hyb21lKSwgdGhlbiB0aGUKCQkJLy8gdGhpcyBmbGFnIHdpbGwgYmUgc2V0IHRvIGZhbHNlIGFscmVhZHkuIElmIGl0J3MgYSBicm93c2VyIHRoYXQgZG9lcyBub3QgdHJpZ2dlcgoJCQkvLyBhIGBwb3BzdGF0ZWAgb24gaGFzaCBhc3NpZ25lbWVudCBvciBgcmVwbGFjZVN0YXRlYCB0aGVuIHdlIG5lZWQgYXZvaWQgdGhlIGJyYW5jaAoJCQkvLyB0aGF0IHN3YWxsb3dzIHRoZSBldmVudCBjcmVhdGVkIGJ5IHRoZSBwb3BzdGF0ZSBnZW5lcmF0ZWQgYnkgdGhlIGhhc2ggYXNzaWdubWVudAoJCQkvLyBBdCB0aGUgdGltZSBvZiB0aGlzIHdyaXRpbmcgdGhpcyBoYXBwZW5zIHdpdGggT3BlcmEgMTIgYW5kIHNvbWUgdmVyc2lvbiBvZiBJRQoJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCgkJCXN0YXRlID0gJC5leHRlbmQoewoJCQkJdXJsOiBocmVmLAoJCQkJaGFzaDogaGFzaCwKCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQl9LCBkYXRhKTsKCgkJCWlmICggaXNQb3BTdGF0ZUV2ZW50ICkgewoJCQkJcG9wc3RhdGVFdmVudCA9IG5ldyAkLkV2ZW50KCAicG9wc3RhdGUiICk7CgkJCQlwb3BzdGF0ZUV2ZW50Lm9yaWdpbmFsRXZlbnQgPSB7CgkJCQkJdHlwZTogInBvcHN0YXRlIiwKCQkJCQlzdGF0ZTogbnVsbAoJCQkJfTsKCgkJCQl0aGlzLnNxdWFzaCggdXJsLCBzdGF0ZSApOwoKCQkJCS8vIFRyaWdnZXIgYSBuZXcgZmF1eCBwb3BzdGF0ZSBldmVudCB0byByZXBsYWNlIHRoZSBvbmUgdGhhdCB3ZQoJCQkJLy8gY2F1Z2h0IHRoYXQgd2FzIHRyaWdnZXJlZCBieSB0aGUgaGFzaCBzZXR0aW5nIGFib3ZlLgoJCQkJaWYgKCAhbm9FdmVudHMgKSB7CgkJCQkJdGhpcy5pZ25vcmVQb3BTdGF0ZSA9IHRydWU7CgkJCQkJJC5tb2JpbGUud2luZG93LnRyaWdnZXIoIHBvcHN0YXRlRXZlbnQgKTsKCQkJCX0KCQkJfQoKCQkJLy8gcmVjb3JkIHRoZSBoaXN0b3J5IGVudHJ5IHNvIHRoYXQgdGhlIGluZm9ybWF0aW9uIGNhbiBiZSBpbmNsdWRlZAoJCQkvLyBpbiBoYXNoY2hhbmdlIGV2ZW50IGRyaXZlbiBuYXZpZ2F0ZSBldmVudHMgaW4gYSBzaW1pbGFyIGZhc2hpb24gdG8KCQkJLy8gdGhlIHN0YXRlIHRoYXQncyBwcm92aWRlZCBieSBwb3BzdGF0ZQoJCQl0aGlzLmhpc3RvcnkuYWRkKCBzdGF0ZS51cmwsIHN0YXRlICk7CgkJfSwKCgkJLy8gVGhpcyBiaW5kaW5nIGlzIGludGVuZGVkIHRvIGNhdGNoIHRoZSBwb3BzdGF0ZSBldmVudHMgdGhhdCBhcmUgZmlyZWQKCQkvLyB3aGVuIGV4ZWN1dGlvbiBvZiB0aGUgYCQubmF2aWdhdGVgIG1ldGhvZCBzdG9wcyBhdCB3aW5kb3cubG9jYXRpb24uaGFzaCA9IHVybDsKCQkvLyBhbmQgY29tcGxldGVseSBwcmV2ZW50IHRoZW0gZnJvbSBwcm9wYWdhdGluZy4gVGhlIHBvcHN0YXRlIGV2ZW50IHdpbGwgdGhlbiBiZQoJCS8vIHJldHJpZ2dlcmVkIGFmdGVyIGV4ZWN1dGlvbiByZXN1bWVzCgkJLy8KCQkvLyBUT0RPIGdyYWIgdGhlIG9yaWdpbmFsIGV2ZW50IGhlcmUgYW5kIHVzZSBpdCBmb3IgdGhlIHN5bnRoZXRpYyBldmVudCBpbiB0aGUKCQkvLyAgICAgIHNlY29uZCBoYWxmIG9mIHRoZSBuYXZpZ2F0ZSBleGVjdXRpb24gdGhhdCB3aWxsIGZvbGxvdyB0aGlzIGJpbmRpbmcKCQlwb3BzdGF0ZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQl2YXIgaGFzaCwgc3RhdGU7CgoJCQkvLyBQYXJ0bHkgdG8gc3VwcG9ydCBvdXIgdGVzdCBzdWl0ZSB3aGljaCBtYW51YWxseSBhbHRlcnMgdGhlIHN1cHBvcnQKCQkJLy8gdmFsdWUgdG8gdGVzdCBoYXNoY2hhbmdlLiBQYXJ0bHkgdG8gcHJldmVudCBhbGwgYXJvdW5kIHdlaXJkbmVzcwoJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIHRoaXMgaXMgdGhlIHBvcHN0YXRlIHRyaWdnZXJlZCBieSB0aGUgYWN0dWFsIGFsdGVyYXRpb24gb2YgdGhlIGhhc2gKCQkJLy8gcHJldmVudCBpdCBjb21wbGV0ZWx5LiBIaXN0b3J5IGlzIHRyYWNrZWQgbWFudWFsbHkKCQkJaWYgKCB0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgKSB7CgkJCQl0aGlzLnByZXZlbnRIYXNoQXNzaWduUG9wU3RhdGUgPSBmYWxzZTsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGlzIGlzIHRoZSBwb3BzdGF0ZSB0cmlnZ2VyZWQgYWZ0ZXIgdGhlIGByZXBsYWNlU3RhdGVgIGNhbGwgaW4gdGhlIGdvCgkJCS8vIG1ldGhvZCwgdGhlbiBzaW1wbHkgaWdub3JlIGl0LiBUaGUgaGlzdG9yeSBlbnRyeSBoYXMgYWxyZWFkeSBiZWVuIGNhcHR1cmVkCgkJCWlmICggdGhpcy5pZ25vcmVQb3BTdGF0ZSApIHsKCQkJCXRoaXMuaWdub3JlUG9wU3RhdGUgPSBmYWxzZTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gSWYgdGhlcmUgaXMgbm8gc3RhdGUsIGFuZCB0aGUgaGlzdG9yeSBzdGFjayBsZW5ndGggaXMgb25lIHdlcmUKCQkJLy8gcHJvYmFibHkgZ2V0dGluZyB0aGUgcGFnZSBsb2FkIHBvcHN0YXRlIGZpcmVkIGJ5IGJyb3dzZXJzIGxpa2UgY2hyb21lCgkJCS8vIGF2b2lkIGl0IGFuZCBzZXQgdGhlIG9uZSB0aW1lIGZsYWcgdG8gZmFsc2UuCgkJCS8vIFRPRE86IERvIHdlIHJlYWxseSBuZWVkIGFsbCB0aGVzZSBjb25kaXRpb25zPyBDb21wYXJpbmcgbG9jYXRpb24gaHJlZnMKCQkJLy8gc2hvdWxkIGJlIHN1ZmZpY2llbnQuCgkJCWlmICggIWV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgJiYKCQkJCXRoaXMuaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDEgJiYKCQkJCXRoaXMuaWdub3JlSW5pdGlhbEhhc2hDaGFuZ2UgKSB7CgkJCQl0aGlzLmlnbm9yZUluaXRpYWxIYXNoQ2hhbmdlID0gZmFsc2U7CgoJCQkJaWYgKCBsb2NhdGlvbi5ocmVmID09PSBpbml0aWFsSHJlZiApIHsKCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJLy8gYWNjb3VudCBmb3IgZGlyZWN0IG1hbmlwdWxhdGlvbiBvZiB0aGUgaGFzaC4gVGhhdCBpcywgd2Ugd2lsbCByZWNlaXZlIGEgcG9wc3RhdGUKCQkJLy8gd2hlbiB0aGUgaGFzaCBpcyBjaGFuZ2VkIGJ5IGFzc2lnbm1lbnQsIGFuZCBpdCB3b24ndCBoYXZlIGEgc3RhdGUgYXNzb2NpYXRlZC4gV2UKCQkJLy8gdGhlbiBuZWVkIHRvIHNxdWFzaCB0aGUgaGFzaC4gU2VlIGJlbG93IGZvciBoYW5kbGluZyBvZiBoYXNoIGFzc2lnbm1lbnQgdGhhdAoJCQkvLyBtYXRjaGVzIGFuIGV4aXN0aW5nIGhpc3RvcnkgZW50cnkKCQkJLy8gVE9ETyBpdCBtaWdodCBiZSBiZXR0ZXIgdG8gb25seSBhZGQgdG8gdGhlIGhpc3Rvcnkgc3RhY2sKCQkJLy8gICAgICB3aGVuIHRoZSBoYXNoIGlzIGFkamFjZW50IHRvIHRoZSBhY3RpdmUgaGlzdG9yeSBlbnRyeQoJCQloYXNoID0gcGF0aC5wYXJzZUxvY2F0aW9uKCkuaGFzaDsKCQkJaWYgKCAhZXZlbnQub3JpZ2luYWxFdmVudC5zdGF0ZSAmJiBoYXNoICkgewoJCQkJLy8gc3F1YXNoIHRoZSBoYXNoIHRoYXQncyBiZWVuIGFzc2lnbmVkIG9uIHRoZSBVUkwgd2l0aCByZXBsYWNlU3RhdGUKCQkJCS8vIGFsc28gZ3JhYiB0aGUgcmVzdWx0aW5nIHN0YXRlIG9iamVjdCBmb3Igc3RvcmFnZQoJCQkJc3RhdGUgPSB0aGlzLnNxdWFzaCggaGFzaCApOwoKCQkJCS8vIHJlY29yZCB0aGUgbmV3IGhhc2ggYXMgYW4gYWRkaXRpb25hbCBoaXN0b3J5IGVudHJ5CgkJCQkvLyB0byBtYXRjaCB0aGUgYnJvd3NlcidzIHRyZWF0bWVudCBvZiBoYXNoIGFzc2lnbm1lbnQKCQkJCXRoaXMuaGlzdG9yeS5hZGQoIHN0YXRlLnVybCwgc3RhdGUgKTsKCgkJCQkvLyBwYXNzIHRoZSBuZXdseSBjcmVhdGVkIHN0YXRlIGluZm9ybWF0aW9uCgkJCQkvLyBhbG9uZyB3aXRoIHRoZSBldmVudAoJCQkJZXZlbnQuaGlzdG9yeVN0YXRlID0gc3RhdGU7CgoJCQkJLy8gZG8gbm90IGFsdGVyIGhpc3RvcnksIHdlJ3ZlIGFkZGVkIGEgbmV3IGhpc3RvcnkgZW50cnkKCQkJCS8vIHNvIHdlIGtub3cgd2hlcmUgd2UgYXJlCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIElmIGFsbCBlbHNlIGZhaWxzIHRoaXMgaXMgYSBwb3BzdGF0ZSB0aGF0IGNvbWVzIGZyb20gdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b25zCgkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHN0YXRlIG9mIG91ciBoaXN0b3J5IHN0YWNrIHByb3Blcmx5LCBhbmQgcmVjb3JkIHRoZSBkaXJlY3Rpb25hbGl0eQoJCQl0aGlzLmhpc3RvcnkuZGlyZWN0KHsKCQkJCXVybDogKGV2ZW50Lm9yaWdpbmFsRXZlbnQuc3RhdGUgfHwge30pLnVybCB8fCBoYXNoLAoKCQkJCS8vIFdoZW4gdGhlIHVybCBpcyBlaXRoZXIgZm9yd2FyZCBvciBiYWNrd2FyZCBpbiBoaXN0b3J5IGluY2x1ZGUgdGhlIGVudHJ5CgkJCQkvLyBhcyBkYXRhIG9uIHRoZSBldmVudCBvYmplY3QgZm9yIG1lcmdpbmcgYXMgZGF0YSBpbiB0aGUgbmF2aWdhdGUgZXZlbnQKCQkJCXByZXNlbnQ6IGZ1bmN0aW9uKCBoaXN0b3J5RW50cnksIGRpcmVjdGlvbiApIHsKCQkJCQkvLyBtYWtlIHN1cmUgdG8gY3JlYXRlIGEgbmV3IG9iamVjdCB0byBwYXNzIGRvd24gYXMgdGhlIG5hdmlnYXRlIGV2ZW50IGRhdGEKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUgPSAkLmV4dGVuZCh7fSwgaGlzdG9yeUVudHJ5KTsKCQkJCQlldmVudC5oaXN0b3J5U3RhdGUuZGlyZWN0aW9uID0gZGlyZWN0aW9uOwoJCQkJfQoJCQl9KTsKCQl9LAoKCQkvLyBOT1RFIG11c3QgYmluZCBiZWZvcmUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50IGhhc2hjaGFuZ2UgYmluZGluZyBvdGhlcndpc2UgdGhlCgkJLy8gICAgICBuYXZpZ2F0aW9uIGRhdGEgd29uJ3QgYmUgYXR0YWNoZWQgdG8gdGhlIGhhc2hjaGFuZ2UgZXZlbnQgaW4gdGltZSBmb3IgdGhvc2UKCQkvLyAgICAgIGJpbmRpbmdzIHRvIGF0dGFjaCBpdCB0byB0aGUgYG5hdmlnYXRlYCBzcGVjaWFsIGV2ZW50CgkJLy8gVE9ETyBhZGQgYSBjaGVjayBoZXJlIHRoYXQgYGhhc2hjaGFuZ2UubmF2aWdhdGVgIGlzIGJvdW5kIGFscmVhZHkgb3RoZXJ3aXNlIGl0J3MKCQkvLyAgICAgIGJyb2tlbiAoZXhjZXB0aW9uPykKCQloYXNoY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBoaXN0b3J5LCBoYXNoOwoKCQkJLy8gSWYgaGFzaGNoYW5nZSBsaXN0ZW5pbmcgaXMgZXhwbGljaXRseSBkaXNhYmxlZCBvciBwdXNoc3RhdGUgaXMgc3VwcG9ydGVkCgkJCS8vIGF2b2lkIG1ha2luZyB1c2Ugb2YgdGhlIGhhc2hjaGFuZ2UgaGFuZGxlci4KCQkJaWYgKCEkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNIYXNoQ2hhbmdlRW5hYmxlZCgpIHx8CgkJCQkkLmV2ZW50LnNwZWNpYWwubmF2aWdhdGUuaXNQdXNoU3RhdGVFbmFibGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIE9uIG9jY2FzaW9uIGV4cGxpY2l0bHkgd2FudCB0byBwcmV2ZW50IHRoZSBuZXh0IGhhc2ggZnJvbSBwcm9wb2dhdGluZyBiZWNhdXNlIHdlIG9ubHkKCQkJLy8gd2l0aCB0byBhbHRlciB0aGUgdXJsIHRvIHJlcHJlc2VudCB0aGUgbmV3IHN0YXRlIGRvIHNvIGhlcmUKCQkJaWYgKCB0aGlzLnByZXZlbnROZXh0SGFzaENoYW5nZSApIHsKCQkJCXRoaXMucHJldmVudE5leHRIYXNoQ2hhbmdlID0gZmFsc2U7CgkJCQlldmVudC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaGlzdG9yeSA9IHRoaXMuaGlzdG9yeTsKCQkJaGFzaCA9IHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2g7CgoJCQkvLyBJZiB0aGlzIGlzIGEgaGFzaGNoYW5nZSBjYXVzZWQgYnkgdGhlIGJhY2sgb3IgZm9yd2FyZCBidXR0b24KCQkJLy8gbWFrZSBzdXJlIHRvIHNldCB0aGUgc3RhdGUgb2Ygb3VyIGhpc3Rvcnkgc3RhY2sgcHJvcGVybHkKCQkJdGhpcy5oaXN0b3J5LmRpcmVjdCh7CgkJCQl1cmw6IGhhc2gsCgoJCQkJLy8gV2hlbiB0aGUgdXJsIGlzIGVpdGhlciBmb3J3YXJkIG9yIGJhY2t3YXJkIGluIGhpc3RvcnkgaW5jbHVkZSB0aGUgZW50cnkKCQkJCS8vIGFzIGRhdGEgb24gdGhlIGV2ZW50IG9iamVjdCBmb3IgbWVyZ2luZyBhcyBkYXRhIGluIHRoZSBuYXZpZ2F0ZSBldmVudAoJCQkJcHJlc2VudDogZnVuY3Rpb24oIGhpc3RvcnlFbnRyeSwgZGlyZWN0aW9uICkgewoJCQkJCS8vIG1ha2Ugc3VyZSB0byBjcmVhdGUgYSBuZXcgb2JqZWN0IHRvIHBhc3MgZG93biBhcyB0aGUgbmF2aWdhdGUgZXZlbnQgZGF0YQoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZSA9ICQuZXh0ZW5kKHt9LCBoaXN0b3J5RW50cnkpOwoJCQkJCWV2ZW50Lmhhc2hjaGFuZ2VTdGF0ZS5kaXJlY3Rpb24gPSBkaXJlY3Rpb247CgkJCQl9LAoKCQkJCS8vIFdoZW4gd2UgZG9uJ3QgZmluZCBhIGhhc2ggaW4gb3VyIGhpc3RvcnkgY2xlYXJseSB3ZSdyZSBhaW1pbmcgdG8gZ28gdGhlcmUKCQkJCS8vIHJlY29yZCB0aGUgZW50cnkgYXMgbmV3IGZvciBmdXR1cmUgdHJhdmVyc2FsCgkJCQkvLwoJCQkJLy8gTk9URSBpdCdzIG5vdCBlbnRpcmVseSBjbGVhciB0aGF0IHRoaXMgaXMgdGhlIHJpZ2h0IHRoaW5nIHRvIGRvIGdpdmVuIHRoYXQgd2UKCQkJCS8vICAgICAgY2FuJ3Qga25vdyB0aGUgdXNlcnMgaW50ZW50aW9uLiBJdCBtaWdodCBiZSBiZXR0ZXIgdG8gZXhwbGljaXRseSBfbm90XwoJCQkJLy8gICAgICBzdXBwb3J0IGxvY2F0aW9uLmhhc2ggYXNzaWdubWVudCBpbiBwcmVmZXJlbmNlIHRvICQubmF2aWdhdGUgY2FsbHMKCQkJCS8vIFRPRE8gZmlyc3QgYXJnIHRvIGFkZCBzaG91bGQgYmUgdGhlIGhyZWYsIGJ1dCBpdCBjYXVzZXMgaXNzdWVzIGluIGlkZW50aWZ5aW5nCgkJCQkvLyAgICAgIGVtYmVkZWQgcGFnZXMKCQkJCW1pc3Npbmc6IGZ1bmN0aW9uKCkgewoJCQkJCWhpc3RvcnkuYWRkKCBoYXNoLCB7CgkJCQkJCWhhc2g6IGhhc2gsCgkJCQkJCXRpdGxlOiBkb2N1bWVudC50aXRsZQoJCQkJCX0pOwoJCQkJfQoJCQl9KTsKCQl9Cgl9KTsKfSkoIGpRdWVyeSApOwoKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCS8vIFRPRE8gY29uc2lkZXIgcXVldWVpbmcgbmF2aWdhdGlvbiBhY3Rpdml0eSB1bnRpbCBwcmV2aW91cyBhY3Rpdml0aWVzIGhhdmUgY29tcGxldGVkCgkvLyAgICAgIHNvIHRoYXQgZW5kIHVzZXJzIGRvbid0IGhhdmUgdG8gdGhpbmsgYWJvdXQgaXQuIFB1bnRpbmcgZm9yIG5vdwoJLy8gVE9ETyAhISBtb3ZlIHRoZSBldmVudCBiaW5kaW5ncyBpbnRvIGNhbGxiYWNrcyBvbiB0aGUgbmF2aWdhdGUgZXZlbnQKCSQubW9iaWxlLm5hdmlnYXRlID0gZnVuY3Rpb24oIHVybCwgZGF0YSwgbm9FdmVudHMgKSB7CgkJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yLmdvKCB1cmwsIGRhdGEsIG5vRXZlbnRzICk7Cgl9OwoKCS8vIGV4cG9zZSB0aGUgaGlzdG9yeSBvbiB0aGUgbmF2aWdhdGUgbWV0aG9kIGluIGFudGljaXBhdGlvbiBvZiBmdWxsIGludGVncmF0aW9uIHdpdGgKCS8vIGV4aXN0aW5nIG5hdmlnYXRpb24gZnVuY3Rpb25hbHR5IHRoYXQgaXMgdGlnaHRseSBjb3VwbGVkIHRvIHRoZSBoaXN0b3J5IGluZm9ybWF0aW9uCgkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5ID0gbmV3ICQubW9iaWxlLkhpc3RvcnkoKTsKCgkvLyBpbnN0YW50aWF0ZSBhbiBpbnN0YW5jZSBvZiB0aGUgbmF2aWdhdG9yIGZvciB1c2Ugd2l0aGluIHRoZSAkLm5hdmlnYXRlIG1ldGhvZAoJJC5tb2JpbGUubmF2aWdhdGUubmF2aWdhdG9yID0gbmV3ICQubW9iaWxlLk5hdmlnYXRvciggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeSApOwoKCXZhciBsb2MgPSAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKTsKCSQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuYWRkKCBsb2MuaHJlZiwge2hhc2g6IGxvYy5oYXNofSApOwp9KSggalF1ZXJ5ICk7CgoKLy8gVGhpcyBwbHVnaW4gaXMgYW4gZXhwZXJpbWVudCBmb3IgYWJzdHJhY3RpbmcgYXdheSB0aGUgdG91Y2ggYW5kIG1vdXNlCi8vIGV2ZW50cyBzbyB0aGF0IGRldmVsb3BlcnMgZG9uJ3QgaGF2ZSB0byB3b3JyeSBhYm91dCB3aGljaCBtZXRob2Qgb2YgaW5wdXQKLy8gdGhlIGRldmljZSB0aGVpciBkb2N1bWVudCBpcyBsb2FkZWQgb24gc3VwcG9ydHMuCi8vCi8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gYWxsb3cgdGhlIGRldmVsb3BlciB0byByZWdpc3RlciBsaXN0ZW5lcnMgZm9yIHRoZQovLyBiYXNpYyBtb3VzZSBldmVudHMsIHN1Y2ggYXMgbW91c2Vkb3duLCBtb3VzZW1vdmUsIG1vdXNldXAsIGFuZCBjbGljaywKLy8gYW5kIHRoZSBwbHVnaW4gd2lsbCB0YWtlIGNhcmUgb2YgcmVnaXN0ZXJpbmcgdGhlIGNvcnJlY3QgbGlzdGVuZXJzCi8vIGJlaGluZCB0aGUgc2NlbmVzIHRvIGludm9rZSB0aGUgbGlzdGVuZXIgYXQgdGhlIGZhc3Rlc3QgcG9zc2libGUgdGltZQovLyBmb3IgdGhhdCBkZXZpY2UsIHdoaWxlIHN0aWxsIHJldGFpbmluZyB0aGUgb3JkZXIgb2YgZXZlbnQgZmlyaW5nIGluCi8vIHRoZSB0cmFkaXRpb25hbCBtb3VzZSBlbnZpcm9ubWVudCwgc2hvdWxkIG11bHRpcGxlIGhhbmRsZXJzIGJlIHJlZ2lzdGVyZWQKLy8gb24gdGhlIHNhbWUgZWxlbWVudCBmb3IgZGlmZmVyZW50IGV2ZW50cy4KLy8KLy8gVGhlIGN1cnJlbnQgdmVyc2lvbiBleHBvc2VzIHRoZSBmb2xsb3dpbmcgdmlydHVhbCBldmVudHMgdG8galF1ZXJ5IGJpbmQgbWV0aG9kczoKLy8gInZtb3VzZW92ZXIgdm1vdXNlZG93biB2bW91c2Vtb3ZlIHZtb3VzZXVwIHZjbGljayB2bW91c2VvdXQgdm1vdXNlY2FuY2VsIgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIGRvY3VtZW50LCB1bmRlZmluZWQgKSB7Cgp2YXIgZGF0YVByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsTW91c2VCaW5kaW5ncyIsCgl0b3VjaFRhcmdldFByb3BlcnR5TmFtZSA9ICJ2aXJ0dWFsVG91Y2hJRCIsCgl2aXJ0dWFsRXZlbnROYW1lcyA9ICJ2bW91c2VvdmVyIHZtb3VzZWRvd24gdm1vdXNlbW92ZSB2bW91c2V1cCB2Y2xpY2sgdm1vdXNlb3V0IHZtb3VzZWNhbmNlbCIuc3BsaXQoICIgIiApLAoJdG91Y2hFdmVudFByb3BzID0gImNsaWVudFggY2xpZW50WSBwYWdlWCBwYWdlWSBzY3JlZW5YIHNjcmVlblkiLnNwbGl0KCAiICIgKSwKCW1vdXNlSG9va1Byb3BzID0gJC5ldmVudC5tb3VzZUhvb2tzID8gJC5ldmVudC5tb3VzZUhvb2tzLnByb3BzIDogW10sCgltb3VzZUV2ZW50UHJvcHMgPSAkLmV2ZW50LnByb3BzLmNvbmNhdCggbW91c2VIb29rUHJvcHMgKSwKCWFjdGl2ZURvY0hhbmRsZXJzID0ge30sCglyZXNldFRpbWVySUQgPSAwLAoJc3RhcnRYID0gMCwKCXN0YXJ0WSA9IDAsCglkaWRTY3JvbGwgPSBmYWxzZSwKCWNsaWNrQmxvY2tMaXN0ID0gW10sCglibG9ja01vdXNlVHJpZ2dlcnMgPSBmYWxzZSwKCWJsb2NrVG91Y2hUcmlnZ2VycyA9IGZhbHNlLAoJZXZlbnRDYXB0dXJlU3VwcG9ydGVkID0gImFkZEV2ZW50TGlzdGVuZXIiIGluIGRvY3VtZW50LAoJJGRvY3VtZW50ID0gJCggZG9jdW1lbnQgKSwKCW5leHRUb3VjaElEID0gMSwKCWxhc3RUb3VjaElEID0gMCwgdGhyZXNob2xkLAoJaTsKCiQudm1vdXNlID0gewoJbW92ZURpc3RhbmNlVGhyZXNob2xkOiAxMCwKCWNsaWNrRGlzdGFuY2VUaHJlc2hvbGQ6IDEwLAoJcmVzZXRUaW1lckR1cmF0aW9uOiAxNTAwCn07CgpmdW5jdGlvbiBnZXROYXRpdmVFdmVudCggZXZlbnQgKSB7CgoJd2hpbGUgKCBldmVudCAmJiB0eXBlb2YgZXZlbnQub3JpZ2luYWxFdmVudCAhPT0gInVuZGVmaW5lZCIgKSB7CgkJZXZlbnQgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJfQoJcmV0dXJuIGV2ZW50Owp9CgpmdW5jdGlvbiBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKSB7CgoJdmFyIHQgPSBldmVudC50eXBlLAoJCW9lLCBwcm9wcywgbmUsIHByb3AsIGN0LCB0b3VjaCwgaSwgaiwgbGVuOwoKCWV2ZW50ID0gJC5FdmVudCggZXZlbnQgKTsKCWV2ZW50LnR5cGUgPSBldmVudFR5cGU7CgoJb2UgPSBldmVudC5vcmlnaW5hbEV2ZW50OwoJcHJvcHMgPSAkLmV2ZW50LnByb3BzOwoKCS8vIGFkZHJlc3NlcyBzZXBhcmF0aW9uIG9mICQuZXZlbnQucHJvcHMgaW4gdG8gJC5ldmVudC5tb3VzZUhvb2sucHJvcHMgYW5kIElzc3VlIDMyODAKCS8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvMzI4MAoJaWYgKCB0LnNlYXJjaCggL14obW91c2V8Y2xpY2spLyApID4gLTEgKSB7CgkJcHJvcHMgPSBtb3VzZUV2ZW50UHJvcHM7Cgl9CgoJLy8gY29weSBvcmlnaW5hbCBldmVudCBwcm9wZXJ0aWVzIG92ZXIgdG8gdGhlIG5ldyBldmVudAoJLy8gdGhpcyB3b3VsZCBoYXBwZW4gaWYgd2UgY291bGQgY2FsbCAkLmV2ZW50LmZpeCBpbnN0ZWFkIG9mICQuRXZlbnQKCS8vIGJ1dCB3ZSBkb24ndCBoYXZlIGEgd2F5IHRvIGZvcmNlIGFuIGV2ZW50IHRvIGJlIGZpeGVkIG11bHRpcGxlIHRpbWVzCglpZiAoIG9lICkgewoJCWZvciAoIGkgPSBwcm9wcy5sZW5ndGgsIHByb3A7IGk7ICkgewoJCQlwcm9wID0gcHJvcHNbIC0taSBdOwoJCQlldmVudFsgcHJvcCBdID0gb2VbIHByb3AgXTsKCQl9Cgl9CgoJLy8gbWFrZSBzdXJlIHRoYXQgaWYgdGhlIG1vdXNlIGFuZCBjbGljayB2aXJ0dWFsIGV2ZW50cyBhcmUgZ2VuZXJhdGVkCgkvLyB3aXRob3V0IGEgLndoaWNoIG9uZSBpcyBkZWZpbmVkCglpZiAoIHQuc2VhcmNoKC9tb3VzZShkb3dufHVwKXxjbGljay8pID4gLTEgJiYgIWV2ZW50LndoaWNoICkgewoJCWV2ZW50LndoaWNoID0gMTsKCX0KCglpZiAoIHQuc2VhcmNoKC9edG91Y2gvKSAhPT0gLTEgKSB7CgkJbmUgPSBnZXROYXRpdmVFdmVudCggb2UgKTsKCQl0ID0gbmUudG91Y2hlczsKCQljdCA9IG5lLmNoYW5nZWRUb3VjaGVzOwoJCXRvdWNoID0gKCB0ICYmIHQubGVuZ3RoICkgPyB0WzBdIDogKCAoIGN0ICYmIGN0Lmxlbmd0aCApID8gY3RbIDAgXSA6IHVuZGVmaW5lZCApOwoKCQlpZiAoIHRvdWNoICkgewoJCQlmb3IgKCBqID0gMCwgbGVuID0gdG91Y2hFdmVudFByb3BzLmxlbmd0aDsgaiA8IGxlbjsgaisrKSB7CgkJCQlwcm9wID0gdG91Y2hFdmVudFByb3BzWyBqIF07CgkJCQlldmVudFsgcHJvcCBdID0gdG91Y2hbIHByb3AgXTsKCQkJfQoJCX0KCX0KCglyZXR1cm4gZXZlbnQ7Cn0KCmZ1bmN0aW9uIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGVsZW1lbnQgKSB7CgoJdmFyIGZsYWdzID0ge30sCgkJYiwgazsKCgl3aGlsZSAoIGVsZW1lbnQgKSB7CgoJCWIgPSAkLmRhdGEoIGVsZW1lbnQsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJZm9yICggIGsgaW4gYiApIHsKCQkJaWYgKCBiWyBrIF0gKSB7CgkJCQlmbGFnc1sgayBdID0gZmxhZ3MuaGFzVmlydHVhbEJpbmRpbmcgPSB0cnVlOwoJCQl9CgkJfQoJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7Cgl9CglyZXR1cm4gZmxhZ3M7Cn0KCmZ1bmN0aW9uIGdldENsb3Nlc3RFbGVtZW50V2l0aFZpcnR1YWxCaW5kaW5nKCBlbGVtZW50LCBldmVudFR5cGUgKSB7Cgl2YXIgYjsKCXdoaWxlICggZWxlbWVudCApIHsKCgkJYiA9ICQuZGF0YSggZWxlbWVudCwgZGF0YVByb3BlcnR5TmFtZSApOwoKCQlpZiAoIGIgJiYgKCAhZXZlbnRUeXBlIHx8IGJbIGV2ZW50VHlwZSBdICkgKSB7CgkJCXJldHVybiBlbGVtZW50OwoJCX0KCQllbGVtZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJfQoJcmV0dXJuIG51bGw7Cn0KCmZ1bmN0aW9uIGVuYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSBmYWxzZTsKfQoKZnVuY3Rpb24gZGlzYWJsZVRvdWNoQmluZGluZ3MoKSB7CglibG9ja1RvdWNoVHJpZ2dlcnMgPSB0cnVlOwp9CgpmdW5jdGlvbiBlbmFibGVNb3VzZUJpbmRpbmdzKCkgewoJbGFzdFRvdWNoSUQgPSAwOwoJY2xpY2tCbG9ja0xpc3QubGVuZ3RoID0gMDsKCWJsb2NrTW91c2VUcmlnZ2VycyA9IGZhbHNlOwoKCS8vIFdoZW4gbW91c2UgYmluZGluZ3MgYXJlIGVuYWJsZWQsIG91cgoJLy8gdG91Y2ggYmluZGluZ3MgYXJlIGRpc2FibGVkLgoJZGlzYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gZGlzYWJsZU1vdXNlQmluZGluZ3MoKSB7CgkvLyBXaGVuIG1vdXNlIGJpbmRpbmdzIGFyZSBkaXNhYmxlZCwgb3VyCgkvLyB0b3VjaCBiaW5kaW5ncyBhcmUgZW5hYmxlZC4KCWVuYWJsZVRvdWNoQmluZGluZ3MoKTsKfQoKZnVuY3Rpb24gc3RhcnRSZXNldFRpbWVyKCkgewoJY2xlYXJSZXNldFRpbWVyKCk7CglyZXNldFRpbWVySUQgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQlyZXNldFRpbWVySUQgPSAwOwoJCWVuYWJsZU1vdXNlQmluZGluZ3MoKTsKCX0sICQudm1vdXNlLnJlc2V0VGltZXJEdXJhdGlvbiApOwp9CgpmdW5jdGlvbiBjbGVhclJlc2V0VGltZXIoKSB7CglpZiAoIHJlc2V0VGltZXJJRCApIHsKCQljbGVhclRpbWVvdXQoIHJlc2V0VGltZXJJRCApOwoJCXJlc2V0VGltZXJJRCA9IDA7Cgl9Cn0KCmZ1bmN0aW9uIHRyaWdnZXJWaXJ0dWFsRXZlbnQoIGV2ZW50VHlwZSwgZXZlbnQsIGZsYWdzICkgewoJdmFyIHZlOwoKCWlmICggKCBmbGFncyAmJiBmbGFnc1sgZXZlbnRUeXBlIF0gKSB8fAoJCQkJKCAhZmxhZ3MgJiYgZ2V0Q2xvc2VzdEVsZW1lbnRXaXRoVmlydHVhbEJpbmRpbmcoIGV2ZW50LnRhcmdldCwgZXZlbnRUeXBlICkgKSApIHsKCgkJdmUgPSBjcmVhdGVWaXJ0dWFsRXZlbnQoIGV2ZW50LCBldmVudFR5cGUgKTsKCgkJJCggZXZlbnQudGFyZ2V0KS50cmlnZ2VyKCB2ZSApOwoJfQoKCXJldHVybiB2ZTsKfQoKZnVuY3Rpb24gbW91c2VFdmVudENhbGxiYWNrKCBldmVudCApIHsKCXZhciB0b3VjaElEID0gJC5kYXRhKCBldmVudC50YXJnZXQsIHRvdWNoVGFyZ2V0UHJvcGVydHlOYW1lICksCgkJdmU7CgoJaWYgKCAhYmxvY2tNb3VzZVRyaWdnZXJzICYmICggIWxhc3RUb3VjaElEIHx8IGxhc3RUb3VjaElEICE9PSB0b3VjaElEICkgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidiIgKyBldmVudC50eXBlLCBldmVudCApOwoJCWlmICggdmUgKSB7CgkJCWlmICggdmUuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJCWlmICggdmUuaXNQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJCWlmICggdmUuaXNJbW1lZGlhdGVQcm9wYWdhdGlvblN0b3BwZWQoKSApIHsKCQkJCWV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQl9CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaFN0YXJ0KCBldmVudCApIHsKCgl2YXIgdG91Y2hlcyA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXMsCgkJdGFyZ2V0LCBmbGFncywgdDsKCglpZiAoIHRvdWNoZXMgJiYgdG91Y2hlcy5sZW5ndGggPT09IDEgKSB7CgoJCXRhcmdldCA9IGV2ZW50LnRhcmdldDsKCQlmbGFncyA9IGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIHRhcmdldCApOwoKCQlpZiAoIGZsYWdzLmhhc1ZpcnR1YWxCaW5kaW5nICkgewoKCQkJbGFzdFRvdWNoSUQgPSBuZXh0VG91Y2hJRCsrOwoJCQkkLmRhdGEoIHRhcmdldCwgdG91Y2hUYXJnZXRQcm9wZXJ0eU5hbWUsIGxhc3RUb3VjaElEICk7CgoJCQljbGVhclJlc2V0VGltZXIoKTsKCgkJCWRpc2FibGVNb3VzZUJpbmRpbmdzKCk7CgkJCWRpZFNjcm9sbCA9IGZhbHNlOwoKCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLnRvdWNoZXNbIDAgXTsKCQkJc3RhcnRYID0gdC5wYWdlWDsKCQkJc3RhcnRZID0gdC5wYWdlWTsKCgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2VvdmVyIiwgZXZlbnQsIGZsYWdzICk7CgkJCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vkb3duIiwgZXZlbnQsIGZsYWdzICk7CgkJfQoJfQp9CgpmdW5jdGlvbiBoYW5kbGVTY3JvbGwoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWlmICggIWRpZFNjcm9sbCApIHsKCQl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlY2FuY2VsIiwgZXZlbnQsIGdldFZpcnR1YWxCaW5kaW5nRmxhZ3MoIGV2ZW50LnRhcmdldCApICk7Cgl9CgoJZGlkU2Nyb2xsID0gdHJ1ZTsKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYW5kbGVUb3VjaE1vdmUoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCXZhciB0ID0gZ2V0TmF0aXZlRXZlbnQoIGV2ZW50ICkudG91Y2hlc1sgMCBdLAoJCWRpZENhbmNlbCA9IGRpZFNjcm9sbCwKCQltb3ZlVGhyZXNob2xkID0gJC52bW91c2UubW92ZURpc3RhbmNlVGhyZXNob2xkLAoJCWZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICk7CgoJCWRpZFNjcm9sbCA9IGRpZFNjcm9sbCB8fAoJCQkoIE1hdGguYWJzKCB0LnBhZ2VYIC0gc3RhcnRYICkgPiBtb3ZlVGhyZXNob2xkIHx8CgkJCQlNYXRoLmFicyggdC5wYWdlWSAtIHN0YXJ0WSApID4gbW92ZVRocmVzaG9sZCApOwoKCWlmICggZGlkU2Nyb2xsICYmICFkaWRDYW5jZWwgKSB7CgkJdHJpZ2dlclZpcnR1YWxFdmVudCggInZtb3VzZWNhbmNlbCIsIGV2ZW50LCBmbGFncyApOwoJfQoKCXRyaWdnZXJWaXJ0dWFsRXZlbnQoICJ2bW91c2Vtb3ZlIiwgZXZlbnQsIGZsYWdzICk7CglzdGFydFJlc2V0VGltZXIoKTsKfQoKZnVuY3Rpb24gaGFuZGxlVG91Y2hFbmQoIGV2ZW50ICkgewoJaWYgKCBibG9ja1RvdWNoVHJpZ2dlcnMgKSB7CgkJcmV0dXJuOwoJfQoKCWRpc2FibGVUb3VjaEJpbmRpbmdzKCk7CgoJdmFyIGZsYWdzID0gZ2V0VmlydHVhbEJpbmRpbmdGbGFncyggZXZlbnQudGFyZ2V0ICksCgkJdmUsIHQ7Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNldXAiLCBldmVudCwgZmxhZ3MgKTsKCglpZiAoICFkaWRTY3JvbGwgKSB7CgkJdmUgPSB0cmlnZ2VyVmlydHVhbEV2ZW50KCAidmNsaWNrIiwgZXZlbnQsIGZsYWdzICk7CgkJaWYgKCB2ZSAmJiB2ZS5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJLy8gVGhlIHRhcmdldCBvZiB0aGUgbW91c2UgZXZlbnRzIHRoYXQgZm9sbG93IHRoZSB0b3VjaGVuZAoJCQkvLyBldmVudCBkb24ndCBuZWNlc3NhcmlseSBtYXRjaCB0aGUgdGFyZ2V0IHVzZWQgZHVyaW5nIHRoZQoJCQkvLyB0b3VjaC4gVGhpcyBtZWFucyB3ZSBuZWVkIHRvIHJlbHkgb24gY29vcmRpbmF0ZXMgZm9yIGJsb2NraW5nCgkJCS8vIGFueSBjbGljayB0aGF0IGlzIGdlbmVyYXRlZC4KCQkJdCA9IGdldE5hdGl2ZUV2ZW50KCBldmVudCApLmNoYW5nZWRUb3VjaGVzWyAwIF07CgkJCWNsaWNrQmxvY2tMaXN0LnB1c2goewoJCQkJdG91Y2hJRDogbGFzdFRvdWNoSUQsCgkJCQl4OiB0LmNsaWVudFgsCgkJCQl5OiB0LmNsaWVudFkKCQkJfSk7CgoJCQkvLyBQcmV2ZW50IGFueSBtb3VzZSBldmVudHMgdGhhdCBmb2xsb3cgZnJvbSB0cmlnZ2VyaW5nCgkJCS8vIHZpcnR1YWwgZXZlbnQgbm90aWZpY2F0aW9ucy4KCQkJYmxvY2tNb3VzZVRyaWdnZXJzID0gdHJ1ZTsKCQl9Cgl9Cgl0cmlnZ2VyVmlydHVhbEV2ZW50KCAidm1vdXNlb3V0IiwgZXZlbnQsIGZsYWdzKTsKCWRpZFNjcm9sbCA9IGZhbHNlOwoKCXN0YXJ0UmVzZXRUaW1lcigpOwp9CgpmdW5jdGlvbiBoYXNWaXJ0dWFsQmluZGluZ3MoIGVsZSApIHsKCXZhciBiaW5kaW5ncyA9ICQuZGF0YSggZWxlLCBkYXRhUHJvcGVydHlOYW1lICksCgkJazsKCglpZiAoIGJpbmRpbmdzICkgewoJCWZvciAoIGsgaW4gYmluZGluZ3MgKSB7CgkJCWlmICggYmluZGluZ3NbIGsgXSApIHsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJfQoJfQoJcmV0dXJuIGZhbHNlOwp9CgpmdW5jdGlvbiBkdW1teU1vdXNlSGFuZGxlcigpIHt9CgpmdW5jdGlvbiBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIGV2ZW50VHlwZSApIHsKCXZhciByZWFsVHlwZSA9IGV2ZW50VHlwZS5zdWJzdHIoIDEgKTsKCglyZXR1cm4gewoJCXNldHVwOiBmdW5jdGlvbigvKiBkYXRhLCBuYW1lc3BhY2UgKi8pIHsKCQkJLy8gSWYgdGhpcyBpcyB0aGUgZmlyc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIGZvciB0aGlzIGVsZW1lbnQsCgkJCS8vIGFkZCBhIGJpbmRpbmdzIG9iamVjdCB0byBpdHMgZGF0YS4KCgkJCWlmICggIWhhc1ZpcnR1YWxCaW5kaW5ncyggdGhpcyApICkgewoJCQkJJC5kYXRhKCB0aGlzLCBkYXRhUHJvcGVydHlOYW1lLCB7fSApOwoJCQl9CgoJCQkvLyBJZiBzZXR1cCBpcyBjYWxsZWQsIHdlIGtub3cgaXQgaXMgdGhlIGZpcnN0IGJpbmRpbmcgZm9yIHRoaXMKCQkJLy8gZXZlbnRUeXBlLCBzbyBpbml0aWFsaXplIHRoZSBjb3VudCBmb3IgdGhlIGV2ZW50VHlwZSB0byB6ZXJvLgoJCQl2YXIgYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCQkJYmluZGluZ3NbIGV2ZW50VHlwZSBdID0gdHJ1ZTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgZXZlbnQgZm9yIHRoaXMgdHlwZSwKCQkJLy8gcmVnaXN0ZXIgYSBnbG9iYWwgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQlhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPSAoIGFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSB8fCAwICkgKyAxOwoKCQkJaWYgKCBhY3RpdmVEb2NIYW5kbGVyc1sgZXZlbnRUeXBlIF0gPT09IDEgKSB7CgkJCQkkZG9jdW1lbnQuYmluZCggcmVhbFR5cGUsIG1vdXNlRXZlbnRDYWxsYmFjayApOwoJCQl9CgoJCQkvLyBTb21lIGJyb3dzZXJzLCBsaWtlIE9wZXJhIE1pbmksIHdvbid0IGRpc3BhdGNoIG1vdXNlL2NsaWNrIGV2ZW50cwoJCQkvLyBmb3IgZWxlbWVudHMgdW5sZXNzIHRoZXkgYWN0dWFsbHkgaGF2ZSBoYW5kbGVycyByZWdpc3RlcmVkIG9uIHRoZW0uCgkJCS8vIFRvIGdldCBhcm91bmQgdGhpcywgd2UgcmVnaXN0ZXIgZHVtbXkgaGFuZGxlcnMgb24gdGhlIGVsZW1lbnRzLgoKCQkJJCggdGhpcyApLmJpbmQoIHJlYWxUeXBlLCBkdW1teU1vdXNlSGFuZGxlciApOwoKCQkJLy8gRm9yIG5vdywgaWYgZXZlbnQgY2FwdHVyZSBpcyBub3Qgc3VwcG9ydGVkLCB3ZSByZWx5IG9uIG1vdXNlIGhhbmRsZXJzLgoJCQlpZiAoIGV2ZW50Q2FwdHVyZVN1cHBvcnRlZCApIHsKCQkJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBmb3IgdGhlIGRvY3VtZW50LAoJCQkJLy8gcmVnaXN0ZXIgb3VyIHRvdWNoc3RhcnQgaGFuZGxlciBvbiB0aGUgZG9jdW1lbnQuCgoJCQkJYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID0gKCBhY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF0gfHwgMCkgKyAxOwoKCQkJCWlmICggYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdID09PSAxICkgewoJCQkJCSRkb2N1bWVudC5iaW5kKCAidG91Y2hzdGFydCIsIGhhbmRsZVRvdWNoU3RhcnQgKQoJCQkJCQkuYmluZCggInRvdWNoZW5kIiwgaGFuZGxlVG91Y2hFbmQgKQoKCQkJCQkJLy8gT24gdG91Y2ggcGxhdGZvcm1zLCB0b3VjaGluZyB0aGUgc2NyZWVuIGFuZCB0aGVuIGRyYWdnaW5nIHlvdXIgZmluZ2VyCgkJCQkJCS8vIGNhdXNlcyB0aGUgd2luZG93IGNvbnRlbnQgdG8gc2Nyb2xsIGFmdGVyIHNvbWUgZGlzdGFuY2UgdGhyZXNob2xkIGlzCgkJCQkJCS8vIGV4Y2VlZGVkLiBPbiB0aGVzZSBwbGF0Zm9ybXMsIGEgc2Nyb2xsIHByZXZlbnRzIGEgY2xpY2sgZXZlbnQgZnJvbSBiZWluZwoJCQkJCQkvLyBkaXNwYXRjaGVkLCBhbmQgb24gc29tZSBwbGF0Zm9ybXMsIGV2ZW4gdGhlIHRvdWNoZW5kIGlzIHN1cHByZXNzZWQuIFRvCgkJCQkJCS8vIG1pbWljIHRoZSBzdXBwcmVzc2lvbiBvZiB0aGUgY2xpY2sgZXZlbnQsIHdlIG5lZWQgdG8gd2F0Y2ggZm9yIGEgc2Nyb2xsCgkJCQkJCS8vIGV2ZW50LiBVbmZvcnR1bmF0ZWx5LCBzb21lIHBsYXRmb3JtcyBsaWtlIGlPUyBkb24ndCBkaXNwYXRjaCBzY3JvbGwKCQkJCQkJLy8gZXZlbnRzIHVudGlsICpBRlRFUiogdGhlIHVzZXIgbGlmdHMgdGhlaXIgZmluZ2VyICh0b3VjaGVuZCkuIFRoaXMgbWVhbnMKCQkJCQkJLy8gd2UgbmVlZCB0byB3YXRjaCBib3RoIHNjcm9sbCBhbmQgdG91Y2htb3ZlIGV2ZW50cyB0byBmaWd1cmUgb3V0IHdoZXRoZXIKCQkJCQkJLy8gb3Igbm90IGEgc2Nyb2xsIGhhcHBlbmVucyBiZWZvcmUgdGhlIHRvdWNoZW5kIGV2ZW50IGlzIGZpcmVkLgoKCQkJCQkJLmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkuYmluZCggInNjcm9sbCIsIGhhbmRsZVNjcm9sbCApOwoJCQkJfQoJCQl9CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKC8qIGRhdGEsIG5hbWVzcGFjZSAqLykgewoJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgYmluZGluZyBmb3IgdGhpcyBldmVudFR5cGUsCgkJCS8vIHJlbW92ZSBpdHMgZ2xvYmFsIGhhbmRsZXIgZnJvbSB0aGUgZG9jdW1lbnQuCgoJCQktLWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXTsKCgkJCWlmICggIWFjdGl2ZURvY0hhbmRsZXJzWyBldmVudFR5cGUgXSApIHsKCQkJCSRkb2N1bWVudC51bmJpbmQoIHJlYWxUeXBlLCBtb3VzZUV2ZW50Q2FsbGJhY2sgKTsKCQkJfQoKCQkJaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7CgkJCQkvLyBJZiB0aGlzIGlzIHRoZSBsYXN0IHZpcnR1YWwgbW91c2UgYmluZGluZyBpbiBleGlzdGVuY2UsCgkJCQkvLyByZW1vdmUgb3VyIGRvY3VtZW50IHRvdWNoc3RhcnQgbGlzdGVuZXIuCgoJCQkJLS1hY3RpdmVEb2NIYW5kbGVyc1sgInRvdWNoc3RhcnQiIF07CgoJCQkJaWYgKCAhYWN0aXZlRG9jSGFuZGxlcnNbICJ0b3VjaHN0YXJ0IiBdICkgewoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ0b3VjaHN0YXJ0IiwgaGFuZGxlVG91Y2hTdGFydCApCgkJCQkJCS51bmJpbmQoICJ0b3VjaG1vdmUiLCBoYW5kbGVUb3VjaE1vdmUgKQoJCQkJCQkudW5iaW5kKCAidG91Y2hlbmQiLCBoYW5kbGVUb3VjaEVuZCApCgkJCQkJCS51bmJpbmQoICJzY3JvbGwiLCBoYW5kbGVTY3JvbGwgKTsKCQkJCX0KCQkJfQoKCQkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQkJYmluZGluZ3MgPSAkLmRhdGEoIHRoaXMsIGRhdGFQcm9wZXJ0eU5hbWUgKTsKCgkJCS8vIHRlYXJkb3duIG1heSBiZSBjYWxsZWQgd2hlbiBhbiBlbGVtZW50IHdhcwoJCQkvLyByZW1vdmVkIGZyb20gdGhlIERPTS4gSWYgdGhpcyBpcyB0aGUgY2FzZSwKCQkJLy8galF1ZXJ5IGNvcmUgbWF5IGhhdmUgYWxyZWFkeSBzdHJpcHBlZCB0aGUgZWxlbWVudAoJCQkvLyBvZiBhbnkgZGF0YSBiaW5kaW5ncyBzbyB3ZSBuZWVkIHRvIGNoZWNrIGl0IGJlZm9yZQoJCQkvLyB1c2luZyBpdC4KCQkJaWYgKCBiaW5kaW5ncyApIHsKCQkJCWJpbmRpbmdzWyBldmVudFR5cGUgXSA9IGZhbHNlOwoJCQl9CgoJCQkvLyBVbnJlZ2lzdGVyIHRoZSBkdW1teSBldmVudCBoYW5kbGVyLgoKCQkJJHRoaXMudW5iaW5kKCByZWFsVHlwZSwgZHVtbXlNb3VzZUhhbmRsZXIgKTsKCgkJCS8vIElmIHRoaXMgaXMgdGhlIGxhc3QgdmlydHVhbCBtb3VzZSBiaW5kaW5nIG9uIHRoZQoJCQkvLyBlbGVtZW50LCByZW1vdmUgdGhlIGJpbmRpbmcgZGF0YSBmcm9tIHRoZSBlbGVtZW50LgoKCQkJaWYgKCAhaGFzVmlydHVhbEJpbmRpbmdzKCB0aGlzICkgKSB7CgkJCQkkdGhpcy5yZW1vdmVEYXRhKCBkYXRhUHJvcGVydHlOYW1lICk7CgkJCX0KCQl9Cgl9Owp9CgovLyBFeHBvc2Ugb3VyIGN1c3RvbSBldmVudHMgdG8gdGhlIGpRdWVyeSBiaW5kL3VuYmluZCBtZWNoYW5pc20uCgpmb3IgKCBpID0gMDsgaSA8IHZpcnR1YWxFdmVudE5hbWVzLmxlbmd0aDsgaSsrICkgewoJJC5ldmVudC5zcGVjaWFsWyB2aXJ0dWFsRXZlbnROYW1lc1sgaSBdIF0gPSBnZXRTcGVjaWFsRXZlbnRPYmplY3QoIHZpcnR1YWxFdmVudE5hbWVzWyBpIF0gKTsKfQoKLy8gQWRkIGEgY2FwdHVyZSBjbGljayBoYW5kbGVyIHRvIGJsb2NrIGNsaWNrcy4KLy8gTm90ZSB0aGF0IHdlIHJlcXVpcmUgZXZlbnQgY2FwdHVyZSBzdXBwb3J0IGZvciB0aGlzIHNvIGlmIHRoZSBkZXZpY2UKLy8gZG9lc24ndCBzdXBwb3J0IGl0LCB3ZSBwdW50IGZvciBub3cgYW5kIHJlbHkgc29sZWx5IG9uIG1vdXNlIGV2ZW50cy4KaWYgKCBldmVudENhcHR1cmVTdXBwb3J0ZWQgKSB7Cglkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCAiY2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQl2YXIgY250ID0gY2xpY2tCbG9ja0xpc3QubGVuZ3RoLAoJCQl0YXJnZXQgPSBlLnRhcmdldCwKCQkJeCwgeSwgZWxlLCBpLCBvLCB0b3VjaElEOwoKCQlpZiAoIGNudCApIHsKCQkJeCA9IGUuY2xpZW50WDsKCQkJeSA9IGUuY2xpZW50WTsKCQkJdGhyZXNob2xkID0gJC52bW91c2UuY2xpY2tEaXN0YW5jZVRocmVzaG9sZDsKCgkJCS8vIFRoZSBpZGVhIGhlcmUgaXMgdG8gcnVuIHRocm91Z2ggdGhlIGNsaWNrQmxvY2tMaXN0IHRvIHNlZSBpZgoJCQkvLyB0aGUgY3VycmVudCBjbGljayBldmVudCBpcyBpbiB0aGUgcHJveGltaXR5IG9mIG9uZSBvZiBvdXIKCQkJLy8gdmNsaWNrIGV2ZW50cyB0aGF0IGhhZCBwcmV2ZW50RGVmYXVsdCgpIGNhbGxlZCBvbiBpdC4gSWYgd2UgZmluZAoJCQkvLyBvbmUsIHRoZW4gd2UgYmxvY2sgdGhlIGNsaWNrLgoJCQkvLwoJCQkvLyBXaHkgZG8gd2UgaGF2ZSB0byByZWx5IG9uIHByb3hpbWl0eT8KCQkJLy8KCQkJLy8gQmVjYXVzZSB0aGUgdGFyZ2V0IG9mIHRoZSB0b3VjaCBldmVudCB0aGF0IHRyaWdnZXJlZCB0aGUgdmNsaWNrCgkJCS8vIGNhbiBiZSBkaWZmZXJlbnQgZnJvbSB0aGUgdGFyZ2V0IG9mIHRoZSBjbGljayBldmVudCBzeW50aGVzaXplZAoJCQkvLyBieSB0aGUgYnJvd3Nlci4gVGhlIHRhcmdldCBvZiBhIG1vdXNlL2NsaWNrIGV2ZW50IHRoYXQgaXMgc3ludGhlc2l6ZWQKCQkJLy8gZnJvbSBhIHRvdWNoIGV2ZW50IHNlZW1zIHRvIGJlIGltcGxlbWVudGF0aW9uIHNwZWNpZmljLiBGb3IgZXhhbXBsZSwKCQkJLy8gc29tZSBicm93c2VycyB3aWxsIGZpcmUgbW91c2UvY2xpY2sgZXZlbnRzIGZvciBhIGxpbmsgdGhhdCBpcyBuZWFyCgkJCS8vIGEgdG91Y2ggZXZlbnQsIGV2ZW4gdGhvdWdoIHRoZSB0YXJnZXQgb2YgdGhlIHRvdWNoc3RhcnQvdG91Y2hlbmQgZXZlbnQKCQkJLy8gc2F5cyB0aGUgdXNlciB0b3VjaGVkIG91dHNpZGUgdGhlIGxpbmsuIEFsc28sIGl0IHNlZW1zIHRoYXQgd2l0aCBtb3N0CgkJCS8vIGJyb3dzZXJzLCB0aGUgdGFyZ2V0IG9mIHRoZSBtb3VzZS9jbGljayBldmVudCBpcyBub3QgY2FsY3VsYXRlZCB1bnRpbCB0aGUKCQkJLy8gdGltZSBpdCBpcyBkaXNwYXRjaGVkLCBzbyBpZiB5b3UgcmVwbGFjZSBhbiBlbGVtZW50IHRoYXQgeW91IHRvdWNoZWQKCQkJLy8gd2l0aCBhbm90aGVyIGVsZW1lbnQsIHRoZSB0YXJnZXQgb2YgdGhlIG1vdXNlL2NsaWNrIHdpbGwgYmUgdGhlIG5ldwoJCQkvLyBlbGVtZW50IHVuZGVybmVhdGggdGhhdCBwb2ludC4KCQkJLy8KCQkJLy8gQXNpZGUgZnJvbSBwcm94aW1pdHksIHdlIGFsc28gY2hlY2sgdG8gc2VlIGlmIHRoZSB0YXJnZXQgYW5kIGFueQoJCQkvLyBvZiBpdHMgYW5jZXN0b3JzIHdlcmUgdGhlIG9uZXMgdGhhdCBibG9ja2VkIGEgY2xpY2suIFRoaXMgaXMgbmVjZXNzYXJ5CgkJCS8vIGJlY2F1c2Ugb2YgdGhlIHN0cmFuZ2UgbW91c2UvY2xpY2sgdGFyZ2V0IGNhbGN1bGF0aW9uIGRvbmUgaW4gdGhlCgkJCS8vIEFuZHJvaWQgMi4xIGJyb3dzZXIsIHdoZXJlIGlmIHlvdSBjbGljayBvbiBhbiBlbGVtZW50LCBhbmQgdGhlcmUgaXMgYQoJCQkvLyBtb3VzZS9jbGljayBoYW5kbGVyIG9uIG9uZSBvZiBpdHMgYW5jZXN0b3JzLCB0aGUgdGFyZ2V0IHdpbGwgYmUgdGhlCgkJCS8vIGlubmVybW9zdCBjaGlsZCBvZiB0aGUgdG91Y2hlZCBlbGVtZW50LCBldmVuIGlmIHRoYXQgY2hpbGQgaXMgbm8gd2hlcmUKCQkJLy8gbmVhciB0aGUgcG9pbnQgb2YgdG91Y2guCgoJCQllbGUgPSB0YXJnZXQ7CgoJCQl3aGlsZSAoIGVsZSApIHsKCQkJCWZvciAoIGkgPSAwOyBpIDwgY250OyBpKysgKSB7CgkJCQkJbyA9IGNsaWNrQmxvY2tMaXN0WyBpIF07CgkJCQkJdG91Y2hJRCA9IDA7CgoJCQkJCWlmICggKCBlbGUgPT09IHRhcmdldCAmJiBNYXRoLmFicyggby54IC0geCApIDwgdGhyZXNob2xkICYmIE1hdGguYWJzKCBvLnkgLSB5ICkgPCB0aHJlc2hvbGQgKSB8fAoJCQkJCQkJCSQuZGF0YSggZWxlLCB0b3VjaFRhcmdldFByb3BlcnR5TmFtZSApID09PSBvLnRvdWNoSUQgKSB7CgkJCQkJCS8vIFhYWDogV2UgbWF5IHdhbnQgdG8gY29uc2lkZXIgcmVtb3ZpbmcgbWF0Y2hlcyBmcm9tIHRoZSBibG9jayBsaXN0CgkJCQkJCS8vICAgICAgaW5zdGVhZCBvZiB3YWl0aW5nIGZvciB0aGUgcmVzZXQgdGltZXIgdG8gZmlyZS4KCQkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQllLnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCQlyZXR1cm47CgkJCQkJfQoJCQkJfQoJCQkJZWxlID0gZWxlLnBhcmVudE5vZGU7CgkJCX0KCQl9Cgl9LCB0cnVlKTsKfQp9KSggalF1ZXJ5LCB3aW5kb3csIGRvY3VtZW50ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCXZhciAkZG9jdW1lbnQgPSAkKCBkb2N1bWVudCApLAoJCXN1cHBvcnRUb3VjaCA9ICQubW9iaWxlLnN1cHBvcnQudG91Y2gsCgkJc2Nyb2xsRXZlbnQgPSAidG91Y2htb3ZlIHNjcm9sbCIsCgkJdG91Y2hTdGFydEV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNoc3RhcnQiIDogIm1vdXNlZG93biIsCgkJdG91Y2hTdG9wRXZlbnQgPSBzdXBwb3J0VG91Y2ggPyAidG91Y2hlbmQiIDogIm1vdXNldXAiLAoJCXRvdWNoTW92ZUV2ZW50ID0gc3VwcG9ydFRvdWNoID8gInRvdWNobW92ZSIgOiAibW91c2Vtb3ZlIjsKCgkvLyBzZXR1cCBuZXcgZXZlbnQgc2hvcnRjdXRzCgkkLmVhY2goICggInRvdWNoc3RhcnQgdG91Y2htb3ZlIHRvdWNoZW5kICIgKwoJCSJ0YXAgdGFwaG9sZCAiICsKCQkic3dpcGUgc3dpcGVsZWZ0IHN3aXBlcmlnaHQgIiArCgkJInNjcm9sbHN0YXJ0IHNjcm9sbHN0b3AiICkuc3BsaXQoICIgIiApLCBmdW5jdGlvbiggaSwgbmFtZSApIHsKCgkJJC5mblsgbmFtZSBdID0gZnVuY3Rpb24oIGZuICkgewoJCQlyZXR1cm4gZm4gPyB0aGlzLmJpbmQoIG5hbWUsIGZuICkgOiB0aGlzLnRyaWdnZXIoIG5hbWUgKTsKCQl9OwoKCQkvLyBqUXVlcnkgPCAxLjgKCQlpZiAoICQuYXR0ckZuICkgewoJCQkkLmF0dHJGblsgbmFtZSBdID0gdHJ1ZTsKCQl9Cgl9KTsKCglmdW5jdGlvbiB0cmlnZ2VyQ3VzdG9tRXZlbnQoIG9iaiwgZXZlbnRUeXBlLCBldmVudCApIHsKCQl2YXIgb3JpZ2luYWxUeXBlID0gZXZlbnQudHlwZTsKCQlldmVudC50eXBlID0gZXZlbnRUeXBlOwoJCSQuZXZlbnQuZGlzcGF0Y2guY2FsbCggb2JqLCBldmVudCApOwoJCWV2ZW50LnR5cGUgPSBvcmlnaW5hbFR5cGU7Cgl9CgoJLy8gYWxzbyBoYW5kbGVzIHNjcm9sbHN0b3AKCSQuZXZlbnQuc3BlY2lhbC5zY3JvbGxzdGFydCA9IHsKCgkJZW5hYmxlZDogdHJ1ZSwKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKSwKCQkJCXNjcm9sbGluZywKCQkJCXRpbWVyOwoKCQkJZnVuY3Rpb24gdHJpZ2dlciggZXZlbnQsIHN0YXRlICkgewoJCQkJc2Nyb2xsaW5nID0gc3RhdGU7CgkJCQl0cmlnZ2VyQ3VzdG9tRXZlbnQoIHRoaXNPYmplY3QsIHNjcm9sbGluZyA/ICJzY3JvbGxzdGFydCIgOiAic2Nyb2xsc3RvcCIsIGV2ZW50ICk7CgkJCX0KCgkJCS8vIGlQaG9uZSB0cmlnZ2VycyBzY3JvbGwgYWZ0ZXIgYSBzbWFsbCBkZWxheTsgdXNlIHRvdWNobW92ZSBpbnN0ZWFkCgkJCSR0aGlzLmJpbmQoIHNjcm9sbEV2ZW50LCBmdW5jdGlvbiggZXZlbnQgKSB7CgoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLnNjcm9sbHN0YXJ0LmVuYWJsZWQgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICggIXNjcm9sbGluZyApIHsKCQkJCQl0cmlnZ2VyKCBldmVudCwgdHJ1ZSApOwoJCQkJfQoKCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCXRpbWVyID0gc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkJdHJpZ2dlciggZXZlbnQsIGZhbHNlICk7CgkJCQl9LCA1MCApOwoJCQl9KTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLnVuYmluZCggc2Nyb2xsRXZlbnQgKTsKCQl9Cgl9OwoKCS8vIGFsc28gaGFuZGxlcyB0YXBob2xkCgkkLmV2ZW50LnNwZWNpYWwudGFwID0gewoJCXRhcGhvbGRUaHJlc2hvbGQ6IDc1MCwKCQllbWl0VGFwT25UYXBob2xkOiB0cnVlLAoJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoaXNPYmplY3QgPSB0aGlzLAoJCQkJJHRoaXMgPSAkKCB0aGlzT2JqZWN0ICksCgkJCQlpc1RhcGhvbGQgPSBmYWxzZTsKCgkJCSR0aGlzLmJpbmQoICJ2bW91c2Vkb3duIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJaXNUYXBob2xkID0gZmFsc2U7CgkJCQlpZiAoIGV2ZW50LndoaWNoICYmIGV2ZW50LndoaWNoICE9PSAxICkgewoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQl2YXIgb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQl0aW1lcjsKCgkJCQlmdW5jdGlvbiBjbGVhclRhcFRpbWVyKCkgewoJCQkJCWNsZWFyVGltZW91dCggdGltZXIgKTsKCQkJCX0KCgkJCQlmdW5jdGlvbiBjbGVhclRhcEhhbmRsZXJzKCkgewoJCQkJCWNsZWFyVGFwVGltZXIoKTsKCgkJCQkJJHRoaXMudW5iaW5kKCAidmNsaWNrIiwgY2xpY2tIYW5kbGVyICkKCQkJCQkJLnVuYmluZCggInZtb3VzZXVwIiwgY2xlYXJUYXBUaW1lciApOwoJCQkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgkJCQl9CgoJCQkJZnVuY3Rpb24gY2xpY2tIYW5kbGVyKCBldmVudCApIHsKCQkJCQljbGVhclRhcEhhbmRsZXJzKCk7CgoJCQkJCS8vIE9OTFkgdHJpZ2dlciBhICd0YXAnIGV2ZW50IGlmIHRoZSBzdGFydCB0YXJnZXQgaXMKCQkJCQkvLyB0aGUgc2FtZSBhcyB0aGUgc3RvcCB0YXJnZXQuCgkJCQkJaWYgKCAhaXNUYXBob2xkICYmIG9yaWdUYXJnZXQgPT09IGV2ZW50LnRhcmdldCApIHsKCQkJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAidGFwIiwgZXZlbnQgKTsKCQkJCQl9IGVsc2UgaWYgKCBpc1RhcGhvbGQgKSB7CgkJCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCAidm1vdXNldXAiLCBjbGVhclRhcFRpbWVyICkKCQkJCQkuYmluZCggInZjbGljayIsIGNsaWNrSGFuZGxlciApOwoJCQkJJGRvY3VtZW50LmJpbmQoICJ2bW91c2VjYW5jZWwiLCBjbGVhclRhcEhhbmRsZXJzICk7CgoJCQkJdGltZXIgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICEkLmV2ZW50LnNwZWNpYWwudGFwLmVtaXRUYXBPblRhcGhvbGQgKSB7CgkJCQkJCWlzVGFwaG9sZCA9IHRydWU7CgkJCQkJfQoJCQkJCXRyaWdnZXJDdXN0b21FdmVudCggdGhpc09iamVjdCwgInRhcGhvbGQiLCAkLkV2ZW50KCAidGFwaG9sZCIsIHsgdGFyZ2V0OiBvcmlnVGFyZ2V0IH0gKSApOwoJCQkJfSwgJC5ldmVudC5zcGVjaWFsLnRhcC50YXBob2xkVGhyZXNob2xkICk7CgkJCX0pOwoJCX0sCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCAidm1vdXNlZG93biIgKS51bmJpbmQoICJ2Y2xpY2siICkudW5iaW5kKCAidm1vdXNldXAiICk7CgkJCSRkb2N1bWVudC51bmJpbmQoICJ2bW91c2VjYW5jZWwiICk7CgkJfQoJfTsKCgkvLyBhbHNvIGhhbmRsZXMgc3dpcGVsZWZ0LCBzd2lwZXJpZ2h0CgkkLmV2ZW50LnNwZWNpYWwuc3dpcGUgPSB7CgkJc2Nyb2xsU3VwcmVzc2lvblRocmVzaG9sZDogMzAsIC8vIE1vcmUgdGhhbiB0aGlzIGhvcml6b250YWwgZGlzcGxhY2VtZW50LCBhbmQgd2Ugd2lsbCBzdXBwcmVzcyBzY3JvbGxpbmcuCgoJCWR1cmF0aW9uVGhyZXNob2xkOiAxMDAwLCAvLyBNb3JlIHRpbWUgdGhhbiB0aGlzLCBhbmQgaXQgaXNuJ3QgYSBzd2lwZS4KCgkJaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkOiAzMCwgIC8vIFN3aXBlIGhvcml6b250YWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbW9yZSB0aGFuIHRoaXMuCgoJCXZlcnRpY2FsRGlzdGFuY2VUaHJlc2hvbGQ6IDc1LCAgLy8gU3dpcGUgdmVydGljYWwgZGlzcGxhY2VtZW50IG11c3QgYmUgbGVzcyB0aGFuIHRoaXMuCgoJCXN0YXJ0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBkYXRhID0gZXZlbnQub3JpZ2luYWxFdmVudC50b3VjaGVzID8KCQkJCQlldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXNbIDAgXSA6IGV2ZW50OwoJCQlyZXR1cm4gewoJCQkJCQl0aW1lOiAoIG5ldyBEYXRlKCkgKS5nZXRUaW1lKCksCgkJCQkJCWNvb3JkczogWyBkYXRhLnBhZ2VYLCBkYXRhLnBhZ2VZIF0sCgkJCQkJCW9yaWdpbjogJCggZXZlbnQudGFyZ2V0ICkKCQkJCQl9OwoJCX0sCgoJCXN0b3A6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGRhdGEgPSBldmVudC5vcmlnaW5hbEV2ZW50LnRvdWNoZXMgPwoJCQkJCWV2ZW50Lm9yaWdpbmFsRXZlbnQudG91Y2hlc1sgMCBdIDogZXZlbnQ7CgkJCXJldHVybiB7CgkJCQkJCXRpbWU6ICggbmV3IERhdGUoKSApLmdldFRpbWUoKSwKCQkJCQkJY29vcmRzOiBbIGRhdGEucGFnZVgsIGRhdGEucGFnZVkgXQoJCQkJCX07CgkJfSwKCgkJaGFuZGxlU3dpcGU6IGZ1bmN0aW9uKCBzdGFydCwgc3RvcCwgdGhpc09iamVjdCwgb3JpZ1RhcmdldCApIHsKCQkJaWYgKCBzdG9wLnRpbWUgLSBzdGFydC50aW1lIDwgJC5ldmVudC5zcGVjaWFsLnN3aXBlLmR1cmF0aW9uVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAwIF0gLSBzdG9wLmNvb3Jkc1sgMCBdICkgPiAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuaG9yaXpvbnRhbERpc3RhbmNlVGhyZXNob2xkICYmCgkJCQlNYXRoLmFicyggc3RhcnQuY29vcmRzWyAxIF0gLSBzdG9wLmNvb3Jkc1sgMSBdICkgPCAkLmV2ZW50LnNwZWNpYWwuc3dpcGUudmVydGljYWxEaXN0YW5jZVRocmVzaG9sZCApIHsKCQkJCXZhciBkaXJlY3Rpb24gPSBzdGFydC5jb29yZHNbMF0gPiBzdG9wLmNvb3Jkc1sgMCBdID8gInN3aXBlbGVmdCIgOiAic3dpcGVyaWdodCI7CgoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCAic3dpcGUiLCAkLkV2ZW50KCAic3dpcGUiLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9KSApOwoJCQkJdHJpZ2dlckN1c3RvbUV2ZW50KCB0aGlzT2JqZWN0LCBkaXJlY3Rpb24sJC5FdmVudCggZGlyZWN0aW9uLCB7IHRhcmdldDogb3JpZ1RhcmdldCwgc3dpcGVzdGFydDogc3RhcnQsIHN3aXBlc3RvcDogc3RvcCB9ICkgKTsKCQkJCXJldHVybiB0cnVlOwoJCQl9CgkJCXJldHVybiBmYWxzZTsKCgkJfSwKCgkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdGhpc09iamVjdCA9IHRoaXMsCgkJCQkkdGhpcyA9ICQoIHRoaXNPYmplY3QgKTsKCgkJCSR0aGlzLmJpbmQoIHRvdWNoU3RhcnRFdmVudCwgZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkJdmFyIHN0b3AsCgkJCQkJc3RhcnQgPSAkLmV2ZW50LnNwZWNpYWwuc3dpcGUuc3RhcnQoIGV2ZW50ICksCgkJCQkJb3JpZ1RhcmdldCA9IGV2ZW50LnRhcmdldCwKCQkJCQllbWl0dGVkID0gZmFsc2U7CgoJCQkJZnVuY3Rpb24gbW92ZUhhbmRsZXIoIGV2ZW50ICkgewoJCQkJCWlmICggIXN0YXJ0ICkgewoJCQkJCQlyZXR1cm47CgkJCQkJfQoKCQkJCQlzdG9wID0gJC5ldmVudC5zcGVjaWFsLnN3aXBlLnN0b3AoIGV2ZW50ICk7CgkJCQkJaWYgKCAhZW1pdHRlZCApIHsKCQkJCQkJZW1pdHRlZCA9ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5oYW5kbGVTd2lwZSggc3RhcnQsIHN0b3AsIHRoaXNPYmplY3QsIG9yaWdUYXJnZXQgKTsKCQkJCQl9CgkJCQkJLy8gcHJldmVudCBzY3JvbGxpbmcKCQkJCQlpZiAoIE1hdGguYWJzKCBzdGFydC5jb29yZHNbIDAgXSAtIHN0b3AuY29vcmRzWyAwIF0gKSA+ICQuZXZlbnQuc3BlY2lhbC5zd2lwZS5zY3JvbGxTdXByZXNzaW9uVGhyZXNob2xkICkgewoJCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCX0KCQkJCX0KCgkJCQkkdGhpcy5iaW5kKCB0b3VjaE1vdmVFdmVudCwgbW92ZUhhbmRsZXIgKQoJCQkJCS5vbmUoIHRvdWNoU3RvcEV2ZW50LCBmdW5jdGlvbigpIHsKCQkJCQkJZW1pdHRlZCA9IHRydWU7CgkJCQkJCSR0aGlzLnVuYmluZCggdG91Y2hNb3ZlRXZlbnQsIG1vdmVIYW5kbGVyICk7CgkJCQl9KTsKCQkJfSk7CgkJfSwKCgkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkudW5iaW5kKCB0b3VjaFN0YXJ0RXZlbnQgKS51bmJpbmQoIHRvdWNoTW92ZUV2ZW50ICkudW5iaW5kKCB0b3VjaFN0b3BFdmVudCApOwoJCX0KCX07CgkkLmVhY2goewoJCXNjcm9sbHN0b3A6ICJzY3JvbGxzdGFydCIsCgkJdGFwaG9sZDogInRhcCIsCgkJc3dpcGVsZWZ0OiAic3dpcGUiLAoJCXN3aXBlcmlnaHQ6ICJzd2lwZSIKCX0sIGZ1bmN0aW9uKCBldmVudCwgc291cmNlRXZlbnQgKSB7CgoJCSQuZXZlbnQuc3BlY2lhbFsgZXZlbnQgXSA9IHsKCQkJc2V0dXA6IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmJpbmQoIHNvdXJjZUV2ZW50LCAkLm5vb3AgKTsKCQkJfSwKCQkJdGVhcmRvd246IGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLnVuYmluZCggc291cmNlRXZlbnQgKTsKCQkJfQoJCX07Cgl9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCgoJLy8gdGhyb3R0bGVkIHJlc2l6ZSBldmVudAoJKGZ1bmN0aW9uKCAkICkgewoJCSQuZXZlbnQuc3BlY2lhbC50aHJvdHRsZWRyZXNpemUgPSB7CgkJCXNldHVwOiBmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9LAoJCQl0ZWFyZG93bjogZnVuY3Rpb24oKSB7CgkJCQkkKCB0aGlzICkudW5iaW5kKCAicmVzaXplIiwgaGFuZGxlciApOwoJCQl9CgkJfTsKCgkJdmFyIHRocm90dGxlID0gMjUwLAoJCQloYW5kbGVyID0gZnVuY3Rpb24oKSB7CgkJCQljdXJyID0gKCBuZXcgRGF0ZSgpICkuZ2V0VGltZSgpOwoJCQkJZGlmZiA9IGN1cnIgLSBsYXN0Q2FsbDsKCgkJCQlpZiAoIGRpZmYgPj0gdGhyb3R0bGUgKSB7CgoJCQkJCWxhc3RDYWxsID0gY3VycjsKCQkJCQkkKCB0aGlzICkudHJpZ2dlciggInRocm90dGxlZHJlc2l6ZSIgKTsKCgkJCQl9IGVsc2UgewoKCQkJCQlpZiAoIGhlbGRDYWxsICkgewoJCQkJCQljbGVhclRpbWVvdXQoIGhlbGRDYWxsICk7CgkJCQkJfQoKCQkJCQkvLyBQcm9taXNlIGEgaGVsZCBjYWxsIHdpbGwgc3RpbGwgZXhlY3V0ZQoJCQkJCWhlbGRDYWxsID0gc2V0VGltZW91dCggaGFuZGxlciwgdGhyb3R0bGUgLSBkaWZmICk7CgkJCQl9CgkJCX0sCgkJCWxhc3RDYWxsID0gMCwKCQkJaGVsZENhbGwsCgkJCWN1cnIsCgkJCWRpZmY7Cgl9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7Cgl2YXIgd2luID0gJCggd2luZG93ICksCgkJZXZlbnRfbmFtZSA9ICJvcmllbnRhdGlvbmNoYW5nZSIsCgkJZ2V0X29yaWVudGF0aW9uLAoJCWxhc3Rfb3JpZW50YXRpb24sCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19sYW5kc2NhcGUsCgkJaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0LAoJCXBvcnRyYWl0X21hcCA9IHsgIjAiOiB0cnVlLCAiMTgwIjogdHJ1ZSB9LAoJCXd3LCB3aCwgbGFuZHNjYXBlX3RocmVzaG9sZDsKCgkvLyBJdCBzZWVtcyB0aGF0IHNvbWUgZGV2aWNlL2Jyb3dzZXIgdmVuZG9ycyB1c2Ugd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlcyAwIGFuZCAxODAgdG8KCS8vIGRlbm90ZSB0aGUgImRlZmF1bHQiIG9yaWVudGF0aW9uLiBGb3IgaU9TIGRldmljZXMsIGFuZCBtb3N0IG90aGVyIHNtYXJ0LXBob25lcyB0ZXN0ZWQsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyBhbHdheXMgInBvcnRyYWl0IiwgYnV0IGluIHNvbWUgQW5kcm9pZCBhbmQgUklNIGJhc2VkIHRhYmxldHMsCgkvLyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBpcyAibGFuZHNjYXBlIi4gVGhlIGZvbGxvd2luZyBjb2RlIGF0dGVtcHRzIHRvIHVzZSB0aGUgd2luZG93CgkvLyBkaW1lbnNpb25zIHRvIGZpZ3VyZSBvdXQgd2hhdCB0aGUgY3VycmVudCBvcmllbnRhdGlvbiBpcywgYW5kIHRoZW4gbWFrZXMgYWRqdXN0bWVudHMKCS8vIHRvIHRoZSB0byB0aGUgcG9ydHJhaXRfbWFwIGlmIG5lY2Vzc2FyeSwgc28gdGhhdCB3ZSBjYW4gcHJvcGVybHkgZGVjb2RlIHRoZQoJLy8gd2luZG93Lm9yaWVudGF0aW9uIHZhbHVlIHdoZW5ldmVyIGdldF9vcmllbnRhdGlvbigpIGlzIGNhbGxlZC4KCS8vCgkvLyBOb3RlIHRoYXQgd2UgdXNlZCB0byB1c2UgYSBtZWRpYSBxdWVyeSB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIG9yaWVudGF0aW9uIHRoZSBicm93c2VyCgkvLyB0aGlua3MgaXQgaXMgaW46CgkvLwoJLy8gICAgIGluaXRpYWxfb3JpZW50YXRpb25faXNfbGFuZHNjYXBlID0gJC5tb2JpbGUubWVkaWEoImFsbCBhbmQgKG9yaWVudGF0aW9uOiBsYW5kc2NhcGUpIik7CgkvLwoJLy8gYnV0IHRoZXJlIHdhcyBhbiBpUGhvbmUvaVBvZCBUb3VjaCBidWcgYmVnaW5uaW5nIHdpdGggaU9TIDQuMiwgdXAgdGhyb3VnaCBpT1MgNS4xLAoJLy8gd2hlcmUgdGhlIGJyb3dzZXIgKkFMV0FZUyogYXBwbGllZCB0aGUgbGFuZHNjYXBlIG1lZGlhIHF1ZXJ5LiBUaGlzIGJ1ZyBkb2VzIG5vdAoJLy8gaGFwcGVuIG9uIGlQYWQuCgoJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgoJCS8vIENoZWNrIHRoZSB3aW5kb3cgd2lkdGggYW5kIGhlaWdodCB0byBmaWd1cmUgb3V0IHdoYXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24KCQkvLyBvZiB0aGUgZGV2aWNlIGlzIGF0IHRoaXMgbW9tZW50LiBOb3RlIHRoYXQgd2UndmUgaW5pdGlhbGl6ZWQgdGhlIHBvcnRyYWl0IG1hcAoJCS8vIHZhbHVlcyB0byAwIGFuZCAxODAsICpBTkQqIHdlIHB1cnBvc2VseSBjaGVjayBmb3IgbGFuZHNjYXBlIHNvIHRoYXQgaWYgd2UgZ3Vlc3MKCQkvLyB3cm9uZywgLCB3ZSBkZWZhdWx0IHRvIHRoZSBhc3N1bXB0aW9uIHRoYXQgcG9ydHJhaXQgaXMgdGhlIGRlZmF1bHQgb3JpZW50YXRpb24uCgkJLy8gV2UgdXNlIGEgdGhyZXNob2xkIGNoZWNrIGJlbG93IGJlY2F1c2Ugb24gc29tZSBwbGF0Zm9ybXMgbGlrZSBpT1MsIHRoZSBpUGhvbmUKCQkvLyBmb3JtLWZhY3RvciBjYW4gcmVwb3J0IGEgbGFyZ2VyIHdpZHRoIHRoYW4gaGVpZ2h0IGlmIHRoZSB1c2VyIHR1cm5zIG9uIHRoZQoJCS8vIGRldmVsb3BlciBjb25zb2xlLiBUaGUgYWN0dWFsIHRocmVzaG9sZCB2YWx1ZSBpcyBzb21ld2hhdCBhcmJpdHJhcnksIHdlIGp1c3QKCQkvLyBuZWVkIHRvIG1ha2Ugc3VyZSBpdCBpcyBsYXJnZSBlbm91Z2ggdG8gZXhjbHVkZSB0aGUgZGV2ZWxvcGVyIGNvbnNvbGUgY2FzZS4KCgkJd3cgPSB3aW5kb3cuaW5uZXJXaWR0aCB8fCB3aW4ud2lkdGgoKTsKCQl3aCA9IHdpbmRvdy5pbm5lckhlaWdodCB8fCB3aW4uaGVpZ2h0KCk7CgkJbGFuZHNjYXBlX3RocmVzaG9sZCA9IDUwOwoKCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSA9IHd3ID4gd2ggJiYgKCB3dyAtIHdoICkgPiBsYW5kc2NhcGVfdGhyZXNob2xkOwoKCQkvLyBOb3cgY2hlY2sgdG8gc2VlIGlmIHRoZSBjdXJyZW50IHdpbmRvdy5vcmllbnRhdGlvbiBpcyAwIG9yIDE4MC4KCQlpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoKCQkvLyBJZiB0aGUgaW5pdGlhbCBvcmllbnRhdGlvbiBpcyBsYW5kc2NhcGUsIGJ1dCB3aW5kb3cub3JpZW50YXRpb24gcmVwb3J0cyAwIG9yIDE4MCwgKk9SKgoJCS8vIGlmIHRoZSBpbml0aWFsIG9yaWVudGF0aW9uIGlzIHBvcnRyYWl0LCBidXQgd2luZG93Lm9yaWVudGF0aW9uIHJlcG9ydHMgOTAgb3IgLTkwLCB3ZQoJCS8vIG5lZWQgdG8gZmxpcCBvdXIgcG9ydHJhaXRfbWFwIHZhbHVlcyBiZWNhdXNlIGxhbmRzY2FwZSBpcyB0aGUgZGVmYXVsdCBvcmllbnRhdGlvbiBmb3IKCQkvLyB0aGlzIGRldmljZS9icm93c2VyLgoJCWlmICggKCBpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiBpbml0aWFsX29yaWVudGF0aW9uX2lzX2RlZmF1bHQgKSB8fCAoICFpbml0aWFsX29yaWVudGF0aW9uX2lzX2xhbmRzY2FwZSAmJiAhaW5pdGlhbF9vcmllbnRhdGlvbl9pc19kZWZhdWx0ICkgKSB7CgkJCXBvcnRyYWl0X21hcCA9IHsgIi05MCI6IHRydWUsICI5MCI6IHRydWUgfTsKCQl9Cgl9CgoJJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlID0gJC5leHRlbmQoIHt9LCAkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UsIHsKCQlzZXR1cDogZnVuY3Rpb24oKSB7CgkJCS8vIElmIHRoZSBldmVudCBpcyBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0IGpRdWVyeQoJCQkvLyB3aWxsIGJpbmQgdG8gdGhlIGV2ZW50IHVzaW5nIERPTSBtZXRob2RzLgoJCQlpZiAoICQuc3VwcG9ydC5vcmllbnRhdGlvbiAmJiAhJC5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLmRpc2FibGVkICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQkvLyBHZXQgdGhlIGN1cnJlbnQgb3JpZW50YXRpb24gdG8gYXZvaWQgaW5pdGlhbCBkb3VibGUtdHJpZ2dlcmluZy4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbigpOwoKCQkJLy8gQmVjYXVzZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQgZG9lc24ndCBleGlzdCwgc2ltdWxhdGUgdGhlCgkJCS8vIGV2ZW50IGJ5IHRlc3Rpbmcgd2luZG93IGRpbWVuc2lvbnMgb24gcmVzaXplLgoJCQl3aW4uYmluZCggInRocm90dGxlZHJlc2l6ZSIsIGhhbmRsZXIgKTsKCQl9LAoJCXRlYXJkb3duOiBmdW5jdGlvbigpIHsKCQkJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHJldHVybiBmYWxzZSBzbyB0aGF0CgkJCS8vIGpRdWVyeSB3aWxsIHVuYmluZCB0aGUgZXZlbnQgdXNpbmcgRE9NIG1ldGhvZHMuCgkJCWlmICggJC5zdXBwb3J0Lm9yaWVudGF0aW9uICYmICEkLmV2ZW50LnNwZWNpYWwub3JpZW50YXRpb25jaGFuZ2UuZGlzYWJsZWQgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCS8vIEJlY2F1c2UgdGhlIG9yaWVudGF0aW9uY2hhbmdlIGV2ZW50IGRvZXNuJ3QgZXhpc3QsIHVuYmluZCB0aGUKCQkJLy8gcmVzaXplIGV2ZW50IGhhbmRsZXIuCgkJCXdpbi51bmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCBoYW5kbGVyICk7CgkJfSwKCQlhZGQ6IGZ1bmN0aW9uKCBoYW5kbGVPYmogKSB7CgkJCS8vIFNhdmUgYSByZWZlcmVuY2UgdG8gdGhlIGJvdW5kIGV2ZW50IGhhbmRsZXIuCgkJCXZhciBvbGRfaGFuZGxlciA9IGhhbmRsZU9iai5oYW5kbGVyOwoKCQkJaGFuZGxlT2JqLmhhbmRsZXIgPSBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQkvLyBNb2RpZnkgZXZlbnQgb2JqZWN0LCBhZGRpbmcgdGhlIC5vcmllbnRhdGlvbiBwcm9wZXJ0eS4KCQkJCWV2ZW50Lm9yaWVudGF0aW9uID0gZ2V0X29yaWVudGF0aW9uKCk7CgoJCQkJLy8gQ2FsbCB0aGUgb3JpZ2luYWxseS1ib3VuZCBldmVudCBoYW5kbGVyIGFuZCByZXR1cm4gaXRzIHJlc3VsdC4KCQkJCXJldHVybiBvbGRfaGFuZGxlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJCX07CgkJfQoJfSk7CgoJLy8gSWYgdGhlIGV2ZW50IGlzIG5vdCBzdXBwb3J0ZWQgbmF0aXZlbHksIHRoaXMgaGFuZGxlciB3aWxsIGJlIGJvdW5kIHRvCgkvLyB0aGUgd2luZG93IHJlc2l6ZSBldmVudCB0byBzaW11bGF0ZSB0aGUgb3JpZW50YXRpb25jaGFuZ2UgZXZlbnQuCglmdW5jdGlvbiBoYW5kbGVyKCkgewoJCS8vIEdldCB0aGUgY3VycmVudCBvcmllbnRhdGlvbi4KCQl2YXIgb3JpZW50YXRpb24gPSBnZXRfb3JpZW50YXRpb24oKTsKCgkJaWYgKCBvcmllbnRhdGlvbiAhPT0gbGFzdF9vcmllbnRhdGlvbiApIHsKCQkJLy8gVGhlIG9yaWVudGF0aW9uIGhhcyBjaGFuZ2VkLCBzbyB0cmlnZ2VyIHRoZSBvcmllbnRhdGlvbmNoYW5nZSBldmVudC4KCQkJbGFzdF9vcmllbnRhdGlvbiA9IG9yaWVudGF0aW9uOwoJCQl3aW4udHJpZ2dlciggZXZlbnRfbmFtZSApOwoJCX0KCX0KCgkvLyBHZXQgdGhlIGN1cnJlbnQgcGFnZSBvcmllbnRhdGlvbi4gVGhpcyBtZXRob2QgaXMgZXhwb3NlZCBwdWJsaWNseSwgc2hvdWxkIGl0CgkvLyBiZSBuZWVkZWQsIGFzIGpRdWVyeS5ldmVudC5zcGVjaWFsLm9yaWVudGF0aW9uY2hhbmdlLm9yaWVudGF0aW9uKCkKCSQuZXZlbnQuc3BlY2lhbC5vcmllbnRhdGlvbmNoYW5nZS5vcmllbnRhdGlvbiA9IGdldF9vcmllbnRhdGlvbiA9IGZ1bmN0aW9uKCkgewoJCXZhciBpc1BvcnRyYWl0ID0gdHJ1ZSwgZWxlbSA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudDsKCgkJLy8gcHJlZmVyIHdpbmRvdyBvcmllbnRhdGlvbiB0byB0aGUgY2FsY3VsYXRpb24gYmFzZWQgb24gc2NyZWVuc2l6ZSBhcwoJCS8vIHRoZSBhY3R1YWwgc2NyZWVuIHJlc2l6ZSB0YWtlcyBwbGFjZSBiZWZvcmUgb3IgYWZ0ZXIgdGhlIG9yaWVudGF0aW9uIGNoYW5nZSBldmVudAoJCS8vIGhhcyBiZWVuIGZpcmVkIGRlcGVuZGluZyBvbiBpbXBsZW1lbnRhdGlvbiAoZWcgYW5kcm9pZCAyLjMgaXMgYmVmb3JlLCBpcGhvbmUgYWZ0ZXIpLgoJCS8vIE1vcmUgdGVzdGluZyBpcyByZXF1aXJlZCB0byBkZXRlcm1pbmUgaWYgYSBtb3JlIHJlbGlhYmxlIG1ldGhvZCBvZiBkZXRlcm1pbmluZyB0aGUgbmV3IHNjcmVlbnNpemUKCQkvLyBpcyBwb3NzaWJsZSB3aGVuIG9yaWVudGF0aW9uY2hhbmdlIGlzIGZpcmVkLiAoZWcsIHVzZSBtZWRpYSBxdWVyaWVzICsgZWxlbWVudCArIG9wYWNpdHkpCgkJaWYgKCAkLnN1cHBvcnQub3JpZW50YXRpb24gKSB7CgkJCS8vIGlmIHRoZSB3aW5kb3cgb3JpZW50YXRpb24gcmVnaXN0ZXJzIGFzIDAgb3IgMTgwIGRlZ3JlZXMgcmVwb3J0CgkJCS8vIHBvcnRyYWl0LCBvdGhlcndpc2UgbGFuZHNjYXBlCgkJCWlzUG9ydHJhaXQgPSBwb3J0cmFpdF9tYXBbIHdpbmRvdy5vcmllbnRhdGlvbiBdOwoJCX0gZWxzZSB7CgkJCWlzUG9ydHJhaXQgPSBlbGVtICYmIGVsZW0uY2xpZW50V2lkdGggLyBlbGVtLmNsaWVudEhlaWdodCA8IDEuMTsKCQl9CgoJCXJldHVybiBpc1BvcnRyYWl0ID8gInBvcnRyYWl0IiA6ICJsYW5kc2NhcGUiOwoJfTsKCgkkLmZuWyBldmVudF9uYW1lIF0gPSBmdW5jdGlvbiggZm4gKSB7CgkJcmV0dXJuIGZuID8gdGhpcy5iaW5kKCBldmVudF9uYW1lLCBmbiApIDogdGhpcy50cmlnZ2VyKCBldmVudF9uYW1lICk7Cgl9OwoKCS8vIGpRdWVyeSA8IDEuOAoJaWYgKCAkLmF0dHJGbiApIHsKCQkkLmF0dHJGblsgZXZlbnRfbmFtZSBdID0gdHJ1ZTsKCX0KCn0oIGpRdWVyeSwgdGhpcyApKTsKCgoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCS8vIGV4aXN0aW5nIGJhc2UgdGFnPwoJdmFyIGJhc2VFbGVtZW50ID0gJCggImhlYWQiICkuY2hpbGRyZW4oICJiYXNlIiApLAoKCS8vIGJhc2UgZWxlbWVudCBtYW5hZ2VtZW50LCBkZWZpbmVkIGRlcGVuZGluZyBvbiBkeW5hbWljIGJhc2UgdGFnIHN1cHBvcnQKCS8vIFRPRE8gbW92ZSB0byBleHRlcm5hbCB3aWRnZXQKCWJhc2UgPSB7CgoJCS8vIGRlZmluZSBiYXNlIGVsZW1lbnQsIGZvciB1c2UgaW4gcm91dGluZyBhc3NldCB1cmxzIHRoYXQgYXJlIHJlZmVyZW5jZWQKCQkvLyBpbiBBamF4LXJlcXVlc3RlZCBtYXJrdXAKCQllbGVtZW50OiAoIGJhc2VFbGVtZW50Lmxlbmd0aCA/IGJhc2VFbGVtZW50IDoKCQkJJCggIjxiYXNlPiIsIHsgaHJlZjogJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UuaHJlZk5vSGFzaCB9ICkucHJlcGVuZFRvKCAkKCAiaGVhZCIgKSApICksCgoJCWxpbmtTZWxlY3RvcjogIltzcmNdLCBsaW5rW2hyZWZdLCBhW3JlbD0nZXh0ZXJuYWwnXSwgOmpxbURhdGEoYWpheD0nZmFsc2UnKSwgYVt0YXJnZXRdIiwKCgkJLy8gc2V0IHRoZSBnZW5lcmF0ZWQgQkFTRSBlbGVtZW50J3MgaHJlZiB0byBhIG5ldyBwYWdlJ3MgYmFzZSBwYXRoCgkJc2V0OiBmdW5jdGlvbiggaHJlZiApIHsKCgkJCS8vIHdlIHNob3VsZCBkbyBub3RoaW5nIGlmIHRoZSB1c2VyIHdhbnRzIHRvIG1hbmFnZSB0aGVpciB1cmwgYmFzZQoJCQkvLyBtYW51YWxseQoJCQlpZiAoICEkLm1vYmlsZS5keW5hbWljQmFzZUVuYWJsZWQgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIHdlIHNob3VsZCB1c2UgdGhlIGJhc2UgdGFnIGlmIHdlIGNhbiBtYW5pcHVsYXRlIGl0IGR5bmFtaWNhbGx5CgkJCWlmICggJC5zdXBwb3J0LmR5bmFtaWNCYXNlVGFnICkgewoJCQkJYmFzZS5lbGVtZW50LmF0dHIoICJocmVmIiwKCQkJCQkkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgJC5tb2JpbGUucGF0aC5kb2N1bWVudEJhc2UgKSApOwoJCQl9CgkJfSwKCgkJcmV3cml0ZTogZnVuY3Rpb24oIGhyZWYsIHBhZ2UgKSB7CgkJCXZhciBuZXdQYXRoID0gJC5tb2JpbGUucGF0aC5nZXQoIGhyZWYgKTsKCgkJCXBhZ2UuZmluZCggYmFzZS5saW5rU2VsZWN0b3IgKS5lYWNoKGZ1bmN0aW9uKCBpLCBsaW5rICkgewoJCQkJdmFyIHRoaXNBdHRyID0gJCggbGluayApLmlzKCAiW2hyZWZdIiApID8gImhyZWYiIDoKCQkJCQkkKCBsaW5rICkuaXMoICJbc3JjXSIgKSA/ICJzcmMiIDogImFjdGlvbiIsCgkJCQl0aGlzVXJsID0gJCggbGluayApLmF0dHIoIHRoaXNBdHRyICk7CgoJCQkJLy8gWFhYX2pibGFzOiBXZSBuZWVkIHRvIGZpeCB0aGlzIHNvIHRoYXQgaXQgcmVtb3ZlcyB0aGUgZG9jdW1lbnQKCQkJCS8vICAgICAgICAgICAgYmFzZSBVUkwsIGFuZCB0aGVuIHByZXBlbmRzIHdpdGggdGhlIG5ldyBwYWdlIFVSTC4KCQkJCS8vIGlmIGZ1bGwgcGF0aCBleGlzdHMgYW5kIGlzIHNhbWUsIGNob3AgaXQgLSBoZWxwcyBJRSBvdXQKCQkJCXRoaXNVcmwgPSB0aGlzVXJsLnJlcGxhY2UoIGxvY2F0aW9uLnByb3RvY29sICsgIi8vIiArCgkJCQkJbG9jYXRpb24uaG9zdCArIGxvY2F0aW9uLnBhdGhuYW1lLCAiIiApOwoKCQkJCWlmICggIS9eKFx3Kzp8I3xcLykvLnRlc3QoIHRoaXNVcmwgKSApIHsKCQkJCQkkKCBsaW5rICkuYXR0ciggdGhpc0F0dHIsIG5ld1BhdGggKyB0aGlzVXJsICk7CgkJCQl9CgkJCX0pOwoJCX0sCgoJCS8vIHNldCB0aGUgZ2VuZXJhdGVkIEJBU0UgZWxlbWVudCdzIGhyZWYgdG8gYSBuZXcgcGFnZSdzIGJhc2UgcGF0aAoJCXJlc2V0OiBmdW5jdGlvbigvKiBocmVmICovKSB7CgkJCWJhc2UuZWxlbWVudC5hdHRyKCAiaHJlZiIsICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb1NlYXJjaCApOwoJCX0KCX07CgoJJC5tb2JpbGUuYmFzZSA9IGJhc2U7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CiQubW9iaWxlLndpZGdldHMgPSB7fTsKCnZhciBvcmlnaW5hbFdpZGdldCA9ICQud2lkZ2V0LAoKCS8vIFJlY29yZCB0aGUgb3JpZ2luYWwsIG5vbi1tb2JpbGVpbml0LW1vZGlmaWVkIHZlcnNpb24gb2YgJC5tb2JpbGUua2VlcE5hdGl2ZQoJLy8gc28gd2UgY2FuIGxhdGVyIGRldGVybWluZSB3aGV0aGVyIHNvbWVvbmUgaGFzIG1vZGlmaWVkICQubW9iaWxlLmtlZXBOYXRpdmUKCWtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9ICQubW9iaWxlLmtlZXBOYXRpdmU7CgokLndpZGdldCA9IChmdW5jdGlvbiggb3JpZyApIHsKCXJldHVybiBmdW5jdGlvbigpIHsKCQl2YXIgY29uc3RydWN0b3IgPSBvcmlnLmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKSwKCQkJbmFtZSA9IGNvbnN0cnVjdG9yLnByb3RvdHlwZS53aWRnZXROYW1lOwoKCQljb25zdHJ1Y3Rvci5pbml0U2VsZWN0b3IgPSAoICggY29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciAhPT0gdW5kZWZpbmVkICkgPwoJCQljb25zdHJ1Y3Rvci5wcm90b3R5cGUuaW5pdFNlbGVjdG9yIDogIjpqcW1EYXRhKHJvbGU9JyIgKyBuYW1lICsgIicpIiApOwoKCQkkLm1vYmlsZS53aWRnZXRzWyBuYW1lIF0gPSBjb25zdHJ1Y3RvcjsKCgkJcmV0dXJuIGNvbnN0cnVjdG9yOwoJfTsKfSkoICQud2lkZ2V0ICk7CgovLyBNYWtlIHN1cmUgJC53aWRnZXQgc3RpbGwgaGFzIGJyaWRnZSBhbmQgZXh0ZW5kIG1ldGhvZHMKJC5leHRlbmQoICQud2lkZ2V0LCBvcmlnaW5hbFdpZGdldCApOwoKLy8gRm9yIGJhY2tjb21wYXQgcmVtb3ZlIGluIDEuNQokLm1vYmlsZS5kb2N1bWVudC5vbiggImNyZWF0ZSIsIGZ1bmN0aW9uKCBldmVudCApIHsKCSQoIGV2ZW50LnRhcmdldCApLmVuaGFuY2VXaXRoaW4oKTsKfSk7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgewoJb3B0aW9uczogewoJCXRoZW1lOiAiYSIsCgkJZG9tQ2FjaGU6IGZhbHNlLAoKCQkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CgkJa2VlcE5hdGl2ZURlZmF1bHQ6ICQubW9iaWxlLmtlZXBOYXRpdmUsCgoJCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQljb250ZW50VGhlbWU6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCS8vIERFUFJFQ0FURUQgZm9yID4gMS40CgkvLyBUT0RPIHJlbW92ZSBhdCAxLjUKCV9jcmVhdGVXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCSQuV2lkZ2V0LnByb3RvdHlwZS5fY3JlYXRlV2lkZ2V0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCQl0aGlzLl90cmlnZ2VyKCAiaW5pdCIgKTsKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJLy8gSWYgZmFsc2UgaXMgcmV0dXJuZWQgYnkgdGhlIGNhbGxiYWNrcyBkbyBub3QgY3JlYXRlIHRoZSBwYWdlCgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3JlY3JlYXRlIiApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9lbmhhbmNlKCk7CgkJfQoKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LCB7CgkJCXBhZ2ViZWZvcmVoaWRlOiAicmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCIsCgkJCXBhZ2ViZWZvcmVzaG93OiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IgoJCX0pOwoKCQl0aGlzLmVsZW1lbnQuZW5oYW5jZVdpdGhpbigpOwoJCS8vIERpYWxvZyB3aWRnZXQgaXMgZGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIHRoaXMgaW4gMS41CgkJaWYgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFswXSwgInJvbGUiICkgPT09ICJkaWFsb2ciICYmICQubW9iaWxlLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmRpYWxvZygpOwoJCX0KCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uICgpIHsKCQl2YXIgYXR0clByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJc2VsZiA9IHRoaXM7CgoJCWlmICggdGhpcy5vcHRpb25zLnJvbGUgKSB7CgkJCXRoaXMuZWxlbWVudC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicm9sZSIsIHRoaXMub3B0aW9ucy5yb2xlICk7CgkJfQoKCQl0aGlzLmVsZW1lbnQKCQkJLmF0dHIoICJ0YWJpbmRleCIsICIwIiApCgkJCS5hZGRDbGFzcyggInVpLXBhZ2UgdWktcGFnZS10aGVtZS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgoJCS8vIE1hbmlwdWxhdGlvbiBvZiBjb250ZW50IG9zIERlcHJlY2F0ZWQgYXMgb2YgMS40IHJlbW92ZSBpbiAxLjUKCQl0aGlzLmVsZW1lbnQuZmluZCggIlsiICsgYXR0clByZWZpeCArICJyb2xlPSdjb250ZW50J10iICkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCXRoZW1lID0gdGhpcy5nZXRBdHRyaWJ1dGUoIGF0dHJQcmVmaXggKyAidGhlbWUiICkgfHwgdW5kZWZpbmVkOwoJCQkJc2VsZi5vcHRpb25zLmNvbnRlbnRUaGVtZSA9IHRoZW1lIHx8IHNlbGYub3B0aW9ucy5jb250ZW50VGhlbWUgfHwgKCBzZWxmLm9wdGlvbnMuZGlhbG9nICYmIHNlbGYub3B0aW9ucy50aGVtZSApIHx8ICggc2VsZi5lbGVtZW50LmpxbURhdGEoInJvbGUiKSA9PT0gImRpYWxvZyIgJiYgIHNlbGYub3B0aW9ucy50aGVtZSApOwoJCQkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCQkJaWYgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgewoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktYm9keS0iICsgKCBzZWxmLm9wdGlvbnMuY29udGVudFRoZW1lICkgKTsKCQkJCX0KCQkJCS8vIEFkZCBBUklBIHJvbGUKCQkJCSR0aGlzLmF0dHIoICJyb2xlIiwgIm1haW4iICkuYWRkQ2xhc3MoICJ1aS1jb250ZW50IiApOwoJCX0pOwoJfSwKCgliaW5kUmVtb3ZlOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJdmFyIHBhZ2UgPSB0aGlzLmVsZW1lbnQ7CgoJCS8vIHdoZW4gZG9tIGNhY2hpbmcgaXMgbm90IGVuYWJsZWQgb3IgdGhlIHBhZ2UgaXMgZW1iZWRkZWQgYmluZCB0byByZW1vdmUgdGhlIHBhZ2Ugb24gaGlkZQoJCWlmICggIXBhZ2UuZGF0YSggIm1vYmlsZS1wYWdlIiApLm9wdGlvbnMuZG9tQ2FjaGUgJiYKCQkJcGFnZS5pcyggIjpqcW1EYXRhKGV4dGVybmFsLXBhZ2U9J3RydWUnKSIgKSApIHsKCgkJCS8vIFRPRE8gdXNlIF9vbiAtIHRoYXQgaXMsIHNvcnQgb3V0IHdoeSBpdCBkb2Vzbid0IHdvcmsgaW4gdGhpcyBjYXNlCgkJCXBhZ2UuYmluZCggInBhZ2VoaWRlLnJlbW92ZSIsIGNhbGxiYWNrIHx8IGZ1bmN0aW9uKCBlLCBkYXRhICkgewoKCQkJCS8vY2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCBpZiBzbyBkb24ndCByZW1vdmUgdGhlIHBhZ2UKCQkJCWlmKCAhZGF0YS5zYW1lUGFnZSApewoJCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKSwKCQkJCQkJcHJFdmVudCA9IG5ldyAkLkV2ZW50KCAicGFnZXJlbW92ZSIgKTsKCgkJCQkJJHRoaXMudHJpZ2dlciggcHJFdmVudCApOwoKCQkJCQlpZiAoICFwckV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJCQkkdGhpcy5yZW1vdmVXaXRoRGVwZW5kZW50cygpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG8gKSB7CgkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy50aGVtZSApLmFkZENsYXNzKCAidWktYm9keS0iICsgby50aGVtZSApOwoJCX0KCgkJaWYgKCBvLmNvbnRlbnRUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggIltkYXRhLSIgKyAkLm1vYmlsZS5ucyArICI9J2NvbnRlbnQnXSIgKS5yZW1vdmVDbGFzcyggInVpLWJvZHktIiArIHRoaXMub3B0aW9ucy5jb250ZW50VGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgby5jb250ZW50VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oLyogZSAqLykgewoJCXRoaXMuc2V0Q29udGFpbmVyQmFja2dyb3VuZCgpOwoJfSwKCS8vIERlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCXJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiOm1vYmlsZS1wYWdlY29udGFpbmVyIiApLnBhZ2Vjb250YWluZXIoeyAidGhlbWUiOiAibm9uZSIgfSk7Cgl9LAoJLy8gRGVwcmVjYXRlZCBpbiAxLjQgcmVtb3ZlIGluIDEuNQoJLy8gc2V0IHRoZSBwYWdlIGNvbnRhaW5lciBiYWNrZ3JvdW5kIHRvIHRoZSBwYWdlIHRoZW1lCglzZXRDb250YWluZXJCYWNrZ3JvdW5kOiBmdW5jdGlvbiggdGhlbWUgKSB7CgkJdGhpcy5lbGVtZW50LnBhcmVudCgpLnBhZ2Vjb250YWluZXIoIHsgInRoZW1lIjogdGhlbWUgfHwgdGhpcy5vcHRpb25zLnRoZW1lIH0gKTsKCX0sCgkvLyBEZXByZWNhdGVkIGluIDEuNCByZW1vdmUgaW4gMS41CglrZWVwTmF0aXZlU2VsZWN0b3I6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlrZWVwTmF0aXZlID0gJC50cmltKCBvcHRpb25zLmtlZXBOYXRpdmUgfHwgIiIgKSwKCQkJZ2xvYmFsVmFsdWUgPSAkLnRyaW0oICQubW9iaWxlLmtlZXBOYXRpdmUgKSwKCQkJb3B0aW9uVmFsdWUgPSAkLnRyaW0oIG9wdGlvbnMua2VlcE5hdGl2ZURlZmF1bHQgKSwKCgkJCS8vIENoZWNrIGlmICQubW9iaWxlLmtlZXBOYXRpdmUgaGFzIGNoYW5nZWQgZnJvbSB0aGUgZmFjdG9yeSBkZWZhdWx0CgkJCW5ld0RlZmF1bHQgPSAoIGtlZXBOYXRpdmVGYWN0b3J5RGVmYXVsdCA9PT0gZ2xvYmFsVmFsdWUgPwoJCQkJIiIgOiBnbG9iYWxWYWx1ZSApLAoKCQkJLy8gSWYgJC5tb2JpbGUua2VlcE5hdGl2ZSBoYXMgbm90IGNoYW5nZWQsIHVzZSBvcHRpb25zLmtlZXBOYXRpdmVEZWZhdWx0CgkJCW9sZERlZmF1bHQgPSAoIG5ld0RlZmF1bHQgPT09ICIiID8gb3B0aW9uVmFsdWUgOiAiIiApOwoKCQkvLyBDb25jYXRlbmF0ZSBrZWVwTmF0aXZlIHNlbGVjdG9ycyBmcm9tIGFsbCBzb3VyY2VzIHdoZXJlIHRoZSB2YWx1ZSBoYXMKCQkvLyBjaGFuZ2VkIG9yLCBpZiBub3RoaW5nIGhhcyBjaGFuZ2VkLCByZXR1cm4gdGhlIGRlZmF1bHQKCQlyZXR1cm4gKCAoIGtlZXBOYXRpdmUgPyBbIGtlZXBOYXRpdmUgXSA6IFtdICkKCQkJLmNvbmNhdCggbmV3RGVmYXVsdCA/IFsgbmV3RGVmYXVsdCBdIDogW10gKQoJCQkuY29uY2F0KCBvbGREZWZhdWx0ID8gWyBvbGREZWZhdWx0IF0gOiBbXSApCgkJCS5qb2luKCAiLCAiICkgKTsKCX0KfSk7Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnBhZ2Vjb250YWluZXIiLCB7CgkJb3B0aW9uczogewoJCQl0aGVtZTogImEiCgkJfSwKCgkJaW5pdFNlbGVjdG9yOiBmYWxzZSwKCgkJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoKCQkJLy8gVE9ETyBjb25zaWRlciBtb3ZpbmcgdGhlIG5hdmlnYXRpb24gaGFuZGxlciBPVVQgb2Ygd2lkZ2V0IGludG8KCQkJLy8gICAgICBzb21lIG90aGVyIG9iamVjdCBhcyBnbHVlIGJldHdlZW4gdGhlIG5hdmlnYXRlIGV2ZW50IGFuZCB0aGUKCQkJLy8gICAgICBjb250ZW50IHdpZGdldCBsb2FkIGFuZCBjaGFuZ2UgbWV0aG9kcwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgbmF2aWdhdGU6ICJfZmlsdGVyTmF2aWdhdGVFdmVudHMiIH0pOwoKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCQkvLyBkaXNhYmxlIGFuIHNjcm9sbCBzZXR0aW5nIHdoZW4gYSBoYXNoY2hhbmdlIGhhcyBiZWVuIGZpcmVkLAoJCQkJLy8gdGhpcyBvbmx5IHdvcmtzIGJlY2F1c2UgdGhlIHJlY29yZGluZyBvZiB0aGUgc2Nyb2xsIHBvc2l0aW9uCgkJCQkvLyBpcyBkZWxheWVkIGZvciAxMDBtcyBhZnRlciB0aGUgYnJvd3NlciBtaWdodCBoYXZlIGNoYW5nZWQgdGhlCgkJCQkvLyBwb3NpdGlvbiBiZWNhdXNlIG9mIHRoZSBoYXNoY2hhbmdlCgkJCQluYXZpZ2F0ZTogIl9kaXNhYmxlUmVjb3JkU2Nyb2xsIiwKCgkJCQkvLyBiaW5kIHRvIHNjcm9sbHN0b3AgZm9yIHRoZSBmaXJzdCBwYWdlLCAicGFnZWNoYW5nZSIgd29uJ3QgYmUKCQkJCS8vIGZpcmVkIGluIHRoYXQgY2FzZQoJCQkJc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIgoJCQl9KTsKCgkJCS8vIFRPRE8gbW92ZSBmcm9tIHBhZ2UqIGV2ZW50cyB0byBjb250ZW50KiBldmVudHMKCQkJdGhpcy5fb24oeyBwYWdlY2hhbmdlOiAiX2FmdGVyQ29udGVudENoYW5nZSIgfSk7CgoJCQkvLyBoYW5kbGUgaW5pdGlhbCBoYXNoY2hhbmdlIGZyb20gY2hyb21lIDooCgkJCXRoaXMud2luZG93Lm9uZSggIm5hdmlnYXRlIiwgJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCAmJiBvcHRpb25zLnRoZW1lICE9PSAibm9uZSIgKSB7CgkJCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS1vdmVybGF5LSIgKyB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJCS5hZGRDbGFzcyggInVpLW92ZXJsYXktIiArIG9wdGlvbnMudGhlbWUgKTsKCQkJfSBlbHNlIGlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktb3ZlcmxheS0iICsgdGhpcy5vcHRpb25zLnRoZW1lICk7CgkJCX0KCgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJfSwKCgkJX2Rpc2FibGVSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gZmFsc2U7CgkJfSwKCgkJX2VuYWJsZVJlY29yZFNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuc2V0TGFzdFNjcm9sbEVuYWJsZWQgPSB0cnVlOwoJCX0sCgoJCS8vIFRPRE8gY29uc2lkZXIgdGhlIG5hbWUgaGVyZSwgc2luY2UgaXQncyBwdXJwb3NlIHNwZWNpZmljCgkJX2FmdGVyQ29udGVudENoYW5nZTogZnVuY3Rpb24oKSB7CgkJCS8vIG9uY2UgdGhlIHBhZ2UgaGFzIGNoYW5nZWQsIHJlLWVuYWJsZSB0aGUgc2Nyb2xsIHJlY29yZGluZwoJCQl0aGlzLnNldExhc3RTY3JvbGxFbmFibGVkID0gdHJ1ZTsKCgkJCS8vIHJlbW92ZSBhbnkgYmluZGluZyB0aGF0IHByZXZpb3VzbHkgZXhpc3RlZCBvbiB0aGUgZ2V0IHNjcm9sbAoJCQkvLyB3aGljaCBtYXkgb3IgbWF5IG5vdCBiZSBkaWZmZXJlbnQgdGhhbiB0aGUgc2Nyb2xsIGVsZW1lbnQKCQkJLy8gZGV0ZXJtaW5lZCBmb3IgdGhpcyBwYWdlIHByZXZpb3VzbHkKCQkJdGhpcy5fb2ZmKCB0aGlzLndpbmRvdywgInNjcm9sbHN0b3AiICk7CgoJCQkvLyBkZXRlcm1pbmUgYW5kIGJpbmQgdG8gdGhlIGN1cnJlbnQgc2NvbGwgZWxlbWVudCB3aGljaCBtYXkgYmUgdGhlCgkJCS8vIHdpbmRvdyBvciBpbiB0aGUgY2FzZSBvZiB0b3VjaCBvdmVyZmxvdyB0aGUgZWxlbWVudCB0b3VjaCBvdmVyZmxvdwoJCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsgc2Nyb2xsc3RvcDogIl9kZWxheWVkUmVjb3JkU2Nyb2xsIiB9KTsKCQl9LAoKCQlfcmVjb3JkU2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJLy8gdGhpcyBiYXJyaWVyIHByZXZlbnRzIHNldHRpbmcgdGhlIHNjcm9sbCB2YWx1ZSBiYXNlZCBvbgoJCQkvLyB0aGUgYnJvd3NlciBzY3JvbGxpbmcgdGhlIHdpbmRvdyBiYXNlZCBvbiBhIGhhc2hjaGFuZ2UKCQkJaWYgKCAhdGhpcy5zZXRMYXN0U2Nyb2xsRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGFjdGl2ZSA9IHRoaXMuX2dldEFjdGl2ZUhpc3RvcnkoKSwKCQkJCWN1cnJlbnRTY3JvbGwsIG1pblNjcm9sbCwgZGVmYXVsdFNjcm9sbDsKCgkJCWlmICggYWN0aXZlICkgewoJCQkJY3VycmVudFNjcm9sbCA9IHRoaXMuX2dldFNjcm9sbCgpOwoJCQkJbWluU2Nyb2xsID0gdGhpcy5fZ2V0TWluU2Nyb2xsKCk7CgkJCQlkZWZhdWx0U2Nyb2xsID0gdGhpcy5fZ2V0RGVmYXVsdFNjcm9sbCgpOwoKCQkJCS8vIFNldCBhY3RpdmUgcGFnZSdzIGxhc3RTY3JvbGwgcHJvcC4gSWYgdGhlIGxvY2F0aW9uIHdlJ3JlCgkJCQkvLyBzY3JvbGxpbmcgdG8gaXMgbGVzcyB0aGFuIG1pblNjcm9sbEJhY2ssIGxldCBpdCBnby4KCQkJCWFjdGl2ZS5sYXN0U2Nyb2xsID0gY3VycmVudFNjcm9sbCA8IG1pblNjcm9sbCA/IGRlZmF1bHRTY3JvbGwgOiBjdXJyZW50U2Nyb2xsOwoJCQl9CgkJfSwKCgkJX2RlbGF5ZWRSZWNvcmRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlzZXRUaW1lb3V0KCAkLnByb3h5KHRoaXMsICJfcmVjb3JkU2Nyb2xsIiksIDEwMCApOwoJCX0sCgoJCV9nZXRTY3JvbGw6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgkJfSwKCgkJX2dldE1pblNjcm9sbDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5taW5TY3JvbGxCYWNrOwoJCX0sCgoJCV9nZXREZWZhdWx0U2Nyb2xsOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmRlZmF1bHRIb21lU2Nyb2xsOwoJCX0sCgoJCV9maWx0ZXJOYXZpZ2F0ZUV2ZW50czogZnVuY3Rpb24oIGUsIGRhdGEgKSB7CgkJCXZhciB1cmw7CgoJCQlpZiAoIGUub3JpZ2luYWxFdmVudCAmJiBlLm9yaWdpbmFsRXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXVybCA9IGUub3JpZ2luYWxFdmVudC50eXBlLmluZGV4T2YoICJoYXNoY2hhbmdlIiApID4gLTEgPyBkYXRhLnN0YXRlLmhhc2ggOiBkYXRhLnN0YXRlLnVybDsKCgkJCWlmICggIXVybCApIHsKCQkJCXVybCA9IHRoaXMuX2dldEhhc2goKTsKCQkJfQoKCQkJaWYgKCAhdXJsIHx8IHVybCA9PT0gIiMiIHx8IHVybC5pbmRleE9mKCAiIyIgKyAkLm1vYmlsZS5wYXRoLnVpU3RhdGVLZXkgKSA9PT0gMCApIHsKCQkJCXVybCA9IGxvY2F0aW9uLmhyZWY7CgkJCX0KCgkJCXRoaXMuX2hhbmRsZU5hdmlnYXRlKCB1cmwsIGRhdGEuc3RhdGUgKTsKCQl9LAoKCQlfZ2V0SGFzaDogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5wYXRoLnBhcnNlTG9jYXRpb24oKS5oYXNoOwoJCX0sCgoJCS8vIFRPRE8gYWN0aXZlIHBhZ2Ugc2hvdWxkIGJlIG1hbmFnZWQgYnkgdGhlIGNvbnRhaW5lciAoaWUsIGl0IHNob3VsZCBiZSBhIHByb3BlcnR5KQoJCWdldEFjdGl2ZVBhZ2U6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gdGhpcy5hY3RpdmVQYWdlOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGZpcnN0IHBhZ2Ugc2hvdWxkIGJlIGEgcHJvcGVydHkgc2V0IGR1cmluZyBfY3JlYXRlIHVzaW5nIHRoZSBsb2dpYwoJCS8vICAgICAgdGhhdCBjdXJyZW50bHkgcmVzaWRlcyBpbiBpbml0CgkJX2dldEluaXRpYWxDb250ZW50OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLmZpcnN0UGFnZTsKCQl9LAoKCQkvLyBUT0RPIGVhY2ggY29udGVudCBjb250YWluZXIgc2hvdWxkIGhhdmUgYSBoaXN0b3J5IG9iamVjdAoJCV9nZXRIaXN0b3J5OiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnk7CgkJfSwKCgkJLy8gVE9ETyB1c2UgX2dldEhpc3RvcnkKCQlfZ2V0QWN0aXZlSGlzdG9yeTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCX0sCgoJCS8vIFRPRE8gdGhlIGRvY3VtZW50IGJhc2Ugc2hvdWxkIGJlIGRldGVybWluZWQgYXQgY3JlYXRpb24KCQlfZ2V0RG9jdW1lbnRCYXNlOiBmdW5jdGlvbigpIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlOwoJCX0sCgoJCWJhY2s6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAtMSApOwoJCX0sCgoJCWZvcndhcmQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmdvKCAxICk7CgkJfSwKCgkJZ286IGZ1bmN0aW9uKCBzdGVwcyApIHsKCgkJCS8vaWYgaGFzaGxpc3RlbmluZyBpcyBlbmFibGVkIHVzZSBuYXRpdmUgaGlzdG9yeSBtZXRob2QKCQkJaWYgKCAkLm1vYmlsZS5oYXNoTGlzdGVuaW5nRW5hYmxlZCApIHsKCQkJCXdpbmRvdy5oaXN0b3J5LmdvKCBzdGVwcyApOwoJCQl9IGVsc2UgewoKCQkJCS8vd2UgYXJlIG5vdCBsaXN0ZW5pbmcgdG8gdGhlIGhhc2ggc28gaGFuZGxlIGhpc3RvcnkgaW50ZXJuYWxseQoJCQkJdmFyIGFjdGl2ZUluZGV4ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCwKCQkJCQlpbmRleCA9IGFjdGl2ZUluZGV4ICsgcGFyc2VJbnQoIHN0ZXBzLCAxMCApLAoJCQkJCXVybCA9ICQubW9iaWxlLm5hdmlnYXRlLmhpc3Rvcnkuc3RhY2tbIGluZGV4IF0udXJsLAoJCQkJCWRpcmVjdGlvbiA9ICggc3RlcHMgPj0gMSApPyAiZm9yd2FyZCIgOiAiYmFjayI7CgoJCQkJLy91cGRhdGUgdGhlIGhpc3Rvcnkgb2JqZWN0CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID0gaW5kZXg7CgkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnByZXZpb3VzSW5kZXggPSBhY3RpdmVJbmRleDsKCgkJCQkvL2NoYW5nZSB0byB0aGUgbmV3IHBhZ2UKCQkJCXRoaXMuY2hhbmdlKCB1cmwsIHsgZGlyZWN0aW9uOiBkaXJlY3Rpb24sIGNoYW5nZUhhc2g6IGZhbHNlLCBmcm9tSGFzaENoYW5nZTogdHJ1ZSB9ICk7CgkJCX0KCQl9LAoKCQkvLyBUT0RPIHJlbmFtZSBfaGFuZGxlRGVzdGluYXRpb24KCQlfaGFuZGxlRGVzdGluYXRpb246IGZ1bmN0aW9uKCB0byApIHsKCQkJdmFyIGhpc3Rvcnk7CgoJCQkvLyBjbGVhbiB0aGUgaGFzaCBmb3IgY29tcGFyaXNvbiBpZiBpdCdzIGEgdXJsCgkJCWlmICggJC50eXBlKHRvKSA9PT0gInN0cmluZyIgKSB7CgkJCQl0byA9ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCB0byApOwoJCQl9CgoJCQlpZiAoIHRvICkgewoJCQkJaGlzdG9yeSA9IHRoaXMuX2dldEhpc3RvcnkoKTsKCgkJCQkvLyBBdCB0aGlzIHBvaW50LCAndG8nIGNhbiBiZSBvbmUgb2YgMyB0aGluZ3MsIGEgY2FjaGVkIHBhZ2UKCQkJCS8vIGVsZW1lbnQgZnJvbSBhIGhpc3Rvcnkgc3RhY2sgZW50cnksIGFuIGlkLCBvciBzaXRlLXJlbGF0aXZlIC8KCQkJCS8vIGFic29sdXRlIFVSTC4gSWYgJ3RvJyBpcyBhbiBpZCwgd2UgbmVlZCB0byByZXNvbHZlIGl0IGFnYWluc3QKCQkJCS8vIHRoZSBkb2N1bWVudEJhc2UsIG5vdCB0aGUgbG9jYXRpb24uaHJlZiwgc2luY2UgdGhlIGhhc2hjaGFuZ2UKCQkJCS8vIGNvdWxkJ3ZlIGJlZW4gdGhlIHJlc3VsdCBvZiBhIGZvcndhcmQvYmFja3dhcmQgbmF2aWdhdGlvbgoJCQkJLy8gdGhhdCBjcm9zc2VzIGZyb20gYW4gZXh0ZXJuYWwgcGFnZS9kaWFsb2cgdG8gYW4gaW50ZXJuYWwKCQkJCS8vIHBhZ2UvZGlhbG9nLgoJCQkJLy8KCQkJCS8vIFRPRE8gbW92ZSBjaGVjayB0byBoaXN0b3J5IG9iamVjdCBvciBwYXRoIG9iamVjdD8KCQkJCXRvID0gISQubW9iaWxlLnBhdGguaXNQYXRoKCB0byApID8gKCAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggIiMiICsgdG8sIHRoaXMuX2dldERvY3VtZW50QmFzZSgpICkgKSA6IHRvOwoKCQkJCS8vIElmIHdlJ3JlIGFib3V0IHRvIGdvIHRvIGFuIGluaXRpYWwgVVJMIHRoYXQgY29udGFpbnMgYQoJCQkJLy8gcmVmZXJlbmNlIHRvIGEgbm9uLWV4aXN0ZW50IGludGVybmFsIHBhZ2UsIGdvIHRvIHRoZSBmaXJzdAoJCQkJLy8gcGFnZSBpbnN0ZWFkLiBXZSBrbm93IHRoYXQgdGhlIGluaXRpYWwgaGFzaCByZWZlcnMgdG8gYQoJCQkJLy8gbm9uLWV4aXN0ZW50IHBhZ2UsIGJlY2F1c2UgdGhlIGluaXRpYWwgaGFzaCBkaWQgbm90IGVuZAoJCQkJLy8gdXAgaW4gdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJLy8gVE9ETyBtb3ZlIGNoZWNrIHRvIGhpc3Rvcnkgb2JqZWN0PwoJCQkJaWYgKCB0byA9PT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhpc3RvcnkuaW5pdGlhbERzdCwgdGhpcy5fZ2V0RG9jdW1lbnRCYXNlKCkgKSAmJgoJCQkJCWhpc3Rvcnkuc3RhY2subGVuZ3RoICYmCgkJCQkJaGlzdG9yeS5zdGFja1swXS51cmwgIT09IGhpc3RvcnkuaW5pdGlhbERzdC5yZXBsYWNlKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5LCAiIiApICkgewoJCQkJCXRvID0gdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gdG8gfHwgdGhpcy5fZ2V0SW5pdGlhbENvbnRlbnQoKTsKCQl9LAoKCQlfaGFuZGxlRGlhbG9nOiBmdW5jdGlvbiggY2hhbmdlUGFnZU9wdGlvbnMsIGRhdGEgKSB7CgkJCXZhciB0bywgYWN0aXZlLCBhY3RpdmVDb250ZW50ID0gdGhpcy5nZXRBY3RpdmVQYWdlKCk7CgoJCQkvLyBJZiBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIG5vdCBhIGRpYWxvZyBza2lwIHRoZSBkaWFsb2cgYW5kIGNvbnRpbnVlCgkJCS8vIGluIHRoZSBzYW1lIGRpcmVjdGlvbgoJCQlpZiAoIGFjdGl2ZUNvbnRlbnQgJiYgIWFjdGl2ZUNvbnRlbnQuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgKSB7CgkJCQkvLyBkZXRlcm1pbmUgaWYgd2UncmUgaGVhZGluZyBmb3J3YXJkIG9yIGJhY2t3YXJkIGFuZCBjb250aW51ZQoJCQkJLy8gYWNjb3JkaW5nbHkgcGFzdCB0aGUgY3VycmVudCBkaWFsb2cKCQkJCWlmICggZGF0YS5kaXJlY3Rpb24gPT09ICJiYWNrIiApIHsKCQkJCQl0aGlzLmJhY2soKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5mb3J3YXJkKCk7CgkJCQl9CgoJCQkJLy8gcHJldmVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSBjdXJyZW50IGFjdGl2ZSBwYWdlIGlzIGEgZGlhbG9nIGFuZCB3ZSdyZSBuYXZpZ2F0aW5nCgkJCQkvLyB0byBhIGRpYWxvZyB1c2UgdGhlIGRpYWxvZyBvYmplY3RlZCBzYXZlZCBpbiB0aGUgc3RhY2sKCQkJCXRvID0gZGF0YS5wYWdlVXJsOwoJCQkJYWN0aXZlID0gdGhpcy5fZ2V0QWN0aXZlSGlzdG9yeSgpOwoKCQkJCS8vIG1ha2Ugc3VyZSB0byBzZXQgdGhlIHJvbGUsIHRyYW5zaXRpb24gYW5kIHJldmVyc2FsCgkJCQkvLyBhcyBtb3N0IG9mIHRoaXMgaXMgbG9zdCBieSB0aGUgZG9tQ2FjaGUgY2xlYW5pbmcKCQkJCSQuZXh0ZW5kKCBjaGFuZ2VQYWdlT3B0aW9ucywgewoJCQkJCXJvbGU6IGFjdGl2ZS5yb2xlLAoJCQkJCXRyYW5zaXRpb246IGFjdGl2ZS50cmFuc2l0aW9uLAoJCQkJCXJldmVyc2U6IGRhdGEuZGlyZWN0aW9uID09PSAiYmFjayIKCQkJCX0pOwoJCQl9CgoJCQlyZXR1cm4gdG87CgkJfSwKCgkJX2hhbmRsZU5hdmlnYXRlOiBmdW5jdGlvbiggdXJsLCBkYXRhICkgewoJCQkvL2ZpbmQgZmlyc3QgcGFnZSB2aWEgaGFzaAoJCQkvLyBUT0RPIHN0cmlwcGluZyB0aGUgaGFzaCB0d2ljZSB3aXRoIGhhbmRsZVVybAoJCQl2YXIgdG8gPSAkLm1vYmlsZS5wYXRoLnN0cmlwSGFzaCggdXJsICksIGhpc3RvcnkgPSB0aGlzLl9nZXRIaXN0b3J5KCksCgoJCQkJLy8gdHJhbnNpdGlvbiBpcyBmYWxzZSBpZiBpdCdzIHRoZSBmaXJzdCBwYWdlLCB1bmRlZmluZWQKCQkJCS8vIG90aGVyd2lzZSAoYW5kIG1heSBiZSBvdmVycmlkZGVuIGJ5IGRlZmF1bHQpCgkJCQl0cmFuc2l0aW9uID0gaGlzdG9yeS5zdGFjay5sZW5ndGggPT09IDAgPyAibm9uZSIgOiB1bmRlZmluZWQsCgoJCQkJLy8gZGVmYXVsdCBvcHRpb25zIGZvciB0aGUgY2hhbmdQYWdlIGNhbGxzIG1hZGUgYWZ0ZXIgZXhhbWluaW5nCgkJCQkvLyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgcGFnZSBhbmQgdGhlIGhhc2gsIE5PVEUgdGhhdCB0aGUKCQkJCS8vIHRyYW5zaXRpb24gaXMgZGVyaXZlZCBmcm9tIHRoZSBwcmV2aW91cyBoaXN0b3J5IGVudHJ5CgkJCQljaGFuZ2VQYWdlT3B0aW9ucyA9IHsKCQkJCQljaGFuZ2VIYXNoOiBmYWxzZSwKCQkJCQlmcm9tSGFzaENoYW5nZTogdHJ1ZSwKCQkJCQlyZXZlcnNlOiBkYXRhLmRpcmVjdGlvbiA9PT0gImJhY2siCgkJCQl9OwoKCQkJJC5leHRlbmQoIGNoYW5nZVBhZ2VPcHRpb25zLCBkYXRhLCB7CgkJCQl0cmFuc2l0aW9uOiAoIGhpc3RvcnkuZ2V0TGFzdCgpIHx8IHt9ICkudHJhbnNpdGlvbiB8fCB0cmFuc2l0aW9uCgkJCX0pOwoKCQkJLy8gVE9ETyBtb3ZlIHRvIF9oYW5kbGVEZXN0aW5hdGlvbiA/CgkJCS8vIElmIHRoaXMgaXNuJ3QgdGhlIGZpcnN0IHBhZ2UsIGlmIHRoZSBjdXJyZW50IHVybCBpcyBhIGRpYWxvZyBoYXNoCgkJCS8vIGtleSwgYW5kIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uIGlzbid0IGVxdWFsIHRvIHRoZSBjdXJyZW50IHRhcmdldAoJCQkvLyBwYWdlLCB1c2UgdGhlIHNwZWNpYWwgZGlhbG9nIGhhbmRsaW5nCgkJCWlmICggaGlzdG9yeS5hY3RpdmVJbmRleCA+IDAgJiYKCQkJCXRvLmluZGV4T2YoICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSA+IC0xICYmCgkJCQloaXN0b3J5LmluaXRpYWxEc3QgIT09IHRvICkgewoKCQkJCXRvID0gdGhpcy5faGFuZGxlRGlhbG9nKCBjaGFuZ2VQYWdlT3B0aW9ucywgZGF0YSApOwoKCQkJCWlmICggdG8gPT09IGZhbHNlICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJfQoKCQkJdGhpcy5fY2hhbmdlQ29udGVudCggdGhpcy5faGFuZGxlRGVzdGluYXRpb24oIHRvICksIGNoYW5nZVBhZ2VPcHRpb25zICk7CgkJfSwKCgkJX2NoYW5nZUNvbnRlbnQ6IGZ1bmN0aW9uKCB0bywgb3B0cyApIHsKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggdG8sIG9wdHMgKTsKCQl9LAoKCQlfZ2V0QmFzZTogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5iYXNlOwoJCX0sCgoJCV9nZXROczogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5uczsKCQl9LAoKCQlfZW5oYW5jZTogZnVuY3Rpb24oIGNvbnRlbnQsIHJvbGUgKSB7CgkJCS8vIFRPRE8gY29uc2lkZXIgc3VwcG9ydGluZyBhIGN1c3RvbSBjYWxsYmFjaywgYW5kIHBhc3NpbmcgaW4KCQkJLy8gdGhlIHNldHRpbmdzIHdoaWNoIGluY2x1ZGVzIHRoZSByb2xlCgkJCXJldHVybiBjb250ZW50LnBhZ2UoeyByb2xlOiByb2xlIH0pOwoJCX0sCgoJCV9pbmNsdWRlOiBmdW5jdGlvbiggcGFnZSwgc2V0dGluZ3MgKSB7CgkJCS8vIGFwcGVuZCB0byBwYWdlIGFuZCBlbmhhbmNlCgkJCXBhZ2UuYXBwZW5kVG8oIHRoaXMuZWxlbWVudCApOwoKCQkJLy8gdXNlIHRoZSBwYWdlIHdpZGdldCB0byBlbmhhbmNlCgkJCXRoaXMuX2VuaGFuY2UoIHBhZ2UsIHNldHRpbmdzLnJvbGUgKTsKCgkJCS8vIHJlbW92ZSBwYWdlIG9uIGhpZGUKCQkJcGFnZS5wYWdlKCAiYmluZFJlbW92ZSIgKTsKCQl9LAoKCQlfZmluZDogZnVuY3Rpb24oIGFic1VybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBzdXBwb3J0aW5nIGEgY3VzdG9tIGNhbGxiYWNrCgkJCXZhciBmaWxlVXJsID0gdGhpcy5fY3JlYXRlRmlsZVVybCggYWJzVXJsICksCgkJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICksCgkJCQlwYWdlLCBpbml0aWFsQ29udGVudCA9IHRoaXMuX2dldEluaXRpYWxDb250ZW50KCk7CgoJCQkvLyBDaGVjayB0byBzZWUgaWYgdGhlIHBhZ2UgYWxyZWFkeSBleGlzdHMgaW4gdGhlIERPTS4KCQkJLy8gTk9URSBkbyBfbm90XyB1c2UgdGhlIDpqcW1EYXRhIHBzZXVkbyBzZWxlY3RvciBiZWNhdXNlIHBhcmVudGhlc2lzCgkJCS8vICAgICAgYXJlIGEgdmFsaWQgdXJsIGNoYXIgYW5kIGl0IGJyZWFrcyBvbiB0aGUgZmlyc3Qgb2NjdXJlbmNlCgkJCXBhZ2UgPSB0aGlzLmVsZW1lbnQKCQkJCS5jaGlsZHJlbiggIltkYXRhLSIgKyB0aGlzLl9nZXROcygpICsidXJsPSciICsgZGF0YVVybCArICInXSIgKTsKCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIHRoZSBwYWdlLCBjaGVjayB0byBzZWUgaWYgdGhlIHVybCBpcyBhCgkJCS8vIHJlZmVyZW5jZSB0byBhbiBlbWJlZGRlZCBwYWdlLiBJZiBzbywgaXQgbWF5IGhhdmUgYmVlbiBkeW5hbWljYWxseQoJCQkvLyBpbmplY3RlZCBieSBhIGRldmVsb3BlciwgaW4gd2hpY2ggY2FzZSBpdCB3b3VsZCBiZSBsYWNraW5nIGEKCQkJLy8gZGF0YS11cmwgYXR0cmlidXRlIGFuZCBpbiBuZWVkIG9mIGVuaGFuY2VtZW50LgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmIGRhdGFVcmwgJiYgISQubW9iaWxlLnBhdGguaXNQYXRoKCBkYXRhVXJsICkgKSB7CgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAkLm1vYmlsZS5wYXRoLmhhc2hUb1NlbGVjdG9yKCIjIiArIGRhdGFVcmwpICkKCQkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAidXJsIiwgZGF0YVVybCApCgkJCQkJLmpxbURhdGEoICJ1cmwiLCBkYXRhVXJsICk7CgkJCX0KCgkJCS8vIElmIHdlIGZhaWxlZCB0byBmaW5kIGEgcGFnZSBpbiB0aGUgRE9NLCBjaGVjayB0aGUgVVJMIHRvIHNlZSBpZiBpdAoJCQkvLyByZWZlcnMgdG8gdGhlIGZpcnN0IHBhZ2UgaW4gdGhlIGFwcGxpY2F0aW9uLiBBbHNvIGNoZWNrIHRvIG1ha2Ugc3VyZQoJCQkvLyBvdXIgY2FjaGVkLWZpcnN0LXBhZ2UgaXMgYWN0dWFsbHkgaW4gdGhlIERPTS4gU29tZSB1c2VyIGRlcGxveWVkCgkJCS8vIGFwcHMgYXJlIHBydW5pbmcgdGhlIGZpcnN0IHBhZ2UgZnJvbSB0aGUgRE9NIGZvciB2YXJpb3VzIHJlYXNvbnMuCgkJCS8vIFdlIGNoZWNrIGZvciB0aGlzIGNhc2UgaGVyZSBiZWNhdXNlIHdlIGRvbid0IHdhbnQgYSBmaXJzdC1wYWdlIHdpdGgKCQkJLy8gYW4gaWQgZmFsbGluZyB0aHJvdWdoIHRvIHRoZSBub24tZXhpc3RlbnQgZW1iZWRkZWQgcGFnZSBlcnJvciBjYXNlLgoJCQlpZiAoIHBhZ2UubGVuZ3RoID09PSAwICYmCgkJCQkkLm1vYmlsZS5wYXRoLmlzRmlyc3RQYWdlVXJsKCBmaWxlVXJsICkgJiYKCQkJCWluaXRpYWxDb250ZW50ICYmCgkJCQlpbml0aWFsQ29udGVudC5wYXJlbnQoKS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggaW5pdGlhbENvbnRlbnQgKTsKCQkJfQoKCQkJcmV0dXJuIHBhZ2U7CgkJfSwKCgkJX2dldExvYWRlcjogZnVuY3Rpb24oKSB7CgkJCXJldHVybiAkLm1vYmlsZS5sb2FkaW5nKCk7CgkJfSwKCgkJX3Nob3dMb2FkaW5nOiBmdW5jdGlvbiggZGVsYXksIHRoZW1lLCBtc2csIHRleHRvbmx5ICkgewoJCQkvLyBUaGlzIGNvbmZpZ3VyYWJsZSB0aW1lb3V0IGFsbG93cyBjYWNoZWQgcGFnZXMgYSBicmllZgoJCQkvLyBkZWxheSB0byBsb2FkIHdpdGhvdXQgc2hvd2luZyBhIG1lc3NhZ2UKCQkJaWYgKCB0aGlzLl9sb2FkTXNnICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQl0aGlzLl9sb2FkTXNnID0gc2V0VGltZW91dCgkLnByb3h5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAic2hvdyIsIHRoZW1lLCBtc2csIHRleHRvbmx5ICk7CgkJCQl0aGlzLl9sb2FkTXNnID0gMDsKCQkJfSwgdGhpcyksIGRlbGF5ICk7CgkJfSwKCgkJX2hpZGVMb2FkaW5nOiBmdW5jdGlvbigpIHsKCQkJLy8gU3RvcCBtZXNzYWdlIHNob3cgdGltZXIKCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9sb2FkTXNnICk7CgkJCXRoaXMuX2xvYWRNc2cgPSAwOwoKCQkJLy8gSGlkZSBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5fZ2V0TG9hZGVyKCkubG9hZGVyKCAiaGlkZSIgKTsKCQl9LAoKCQlfc2hvd0Vycm9yOiBmdW5jdGlvbigpIHsKCQkJLy8gbWFrZSBzdXJlIHRvIHJlbW92ZSB0aGUgY3VycmVudCBsb2FkaW5nIG1lc3NhZ2UKCQkJdGhpcy5faGlkZUxvYWRpbmcoKTsKCgkJCS8vIHNob3cgdGhlIGVycm9yIG1lc3NhZ2UKCQkJdGhpcy5fc2hvd0xvYWRpbmcoIDAsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlVGhlbWUsICQubW9iaWxlLnBhZ2VMb2FkRXJyb3JNZXNzYWdlLCB0cnVlICk7CgoJCQkvLyBoaWRlIHRoZSBlcnJvciBtZXNzYWdlIGFmdGVyIGEgZGVsYXkKCQkJLy8gVE9ETyBjb25maWd1cmF0aW9uCgkJCXNldFRpbWVvdXQoICQucHJveHkodGhpcywgIl9oaWRlTG9hZGluZyIpLCAxNTAwICk7CgkJfSwKCgkJX3BhcnNlOiBmdW5jdGlvbiggaHRtbCwgZmlsZVVybCApIHsKCQkJLy8gVE9ETyBjb25zaWRlciBhbGxvd2luZyBjdXN0b21pemF0aW9uIG9mIHRoaXMgbWV0aG9kLiBJdCdzIHZlcnkgSlFNIHNwZWNpZmljCgkJCXZhciBwYWdlLCBhbGwgPSAkKCAiPGRpdj48L2Rpdj4iICk7CgoJCQkvL3dvcmthcm91bmQgdG8gYWxsb3cgc2NyaXB0cyB0byBleGVjdXRlIHdoZW4gaW5jbHVkZWQgaW4gcGFnZSBkaXZzCgkJCWFsbC5nZXQoIDAgKS5pbm5lckhUTUwgPSBodG1sOwoKCQkJcGFnZSA9IGFsbC5maW5kKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKS5maXJzdCgpOwoKCQkJLy9pZiBwYWdlIGVsZW0gY291bGRuJ3QgYmUgZm91bmQsIGNyZWF0ZSBvbmUgYW5kIGluc2VydCB0aGUgYm9keSBlbGVtZW50J3MgY29udGVudHMKCQkJaWYgKCAhcGFnZS5sZW5ndGggKSB7CgkJCQlwYWdlID0gJCggIjxkaXYgZGF0YS0iICsgdGhpcy5fZ2V0TnMoKSArICJyb2xlPSdwYWdlJz4iICsKCQkJCQkoIGh0bWwuc3BsaXQoIC88XC8/Ym9keVtePl0qPi9nbWkgKVsxXSB8fCAiIiApICsKCQkJCQkiPC9kaXY+IiApOwoJCQl9CgoJCQkvLyBUT0RPIHRhZ2dpbmcgYSBwYWdlIHdpdGggZXh0ZXJuYWwgdG8gbWFrZSBzdXJlIHRoYXQgZW1iZWRkZWQgcGFnZXMgYXJlbid0CgkJCS8vIHJlbW92ZWQgYnkgdGhlIHZhcmlvdXMgcGFnZSBoYW5kbGluZyBjb2RlIGlzIGJhZC4gSGF2aW5nIHBhZ2UgaGFuZGxpbmcgY29kZQoJCQkvLyBpbiBtYW55IHBsYWNlcyBpcyBiYWQuIFNvbHV0aW9ucyBwb3N0IDEuMAoJCQlwYWdlLmF0dHIoICJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybCIsICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybChmaWxlVXJsKSApCgkJCQkuYXR0ciggImRhdGEtIiArIHRoaXMuX2dldE5zKCkgKyAiZXh0ZXJuYWwtcGFnZSIsIHRydWUgKTsKCgkJCXJldHVybiBwYWdlOwoJCX0sCgoJCV9zZXRMb2FkZWRUaXRsZTogZnVuY3Rpb24oIHBhZ2UsIGh0bWwgKSB7CgkJCS8vcGFnZSB0aXRsZSByZWdleHAKCQkJdmFyIG5ld1BhZ2VUaXRsZSA9IGh0bWwubWF0Y2goIC88dGl0bGVbXj5dKj4oW148XSopLyApICYmIFJlZ0V4cC4kMTsKCgkJCWlmICggbmV3UGFnZVRpdGxlICYmICFwYWdlLmpxbURhdGEoInRpdGxlIikgKSB7CgkJCQluZXdQYWdlVGl0bGUgPSAkKCAiPGRpdj4iICsgbmV3UGFnZVRpdGxlICsgIjwvZGl2PiIgKS50ZXh0KCk7CgkJCQlwYWdlLmpxbURhdGEoICJ0aXRsZSIsIG5ld1BhZ2VUaXRsZSApOwoJCQl9CgkJfSwKCgkJX2lzUmV3cml0YWJsZUJhc2VUYWc6IGZ1bmN0aW9uKCkgewoJCQlyZXR1cm4gJC5tb2JpbGUuZHluYW1pY0Jhc2VFbmFibGVkICYmICEkLnN1cHBvcnQuZHluYW1pY0Jhc2VUYWc7CgkJfSwKCgkJX2NyZWF0ZURhdGFVcmw6IGZ1bmN0aW9uKCBhYnNvbHV0ZVVybCApIHsKCQkJcmV0dXJuICQubW9iaWxlLnBhdGguY29udmVydFVybFRvRGF0YVVybCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfY3JlYXRlRmlsZVVybDogZnVuY3Rpb24oIGFic29sdXRlVXJsICkgewoJCQlyZXR1cm4gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggYWJzb2x1dGVVcmwgKTsKCQl9LAoKCQlfdHJpZ2dlcldpdGhEZXByZWNhdGVkOiBmdW5jdGlvbiggbmFtZSwgZGF0YSwgcGFnZSApIHsKCQkJdmFyIGRlcHJlY2F0ZWRFdmVudCA9ICQuRXZlbnQoICJwYWdlIiArIG5hbWUgKSwKCQkJCW5ld0V2ZW50ID0gJC5FdmVudCggdGhpcy53aWRnZXROYW1lICsgbmFtZSApOwoKCQkJLy8gREVQUkVDQVRFRAoJCQkvLyB0cmlnZ2VyIHRoZSBvbGQgZGVwcmVjYXRlZCBldmVudCBvbiB0aGUgcGFnZSBpZiBpdCdzIHByb3ZpZGVkCgkJCSggcGFnZSB8fCB0aGlzLmVsZW1lbnQgKS50cmlnZ2VyKCBkZXByZWNhdGVkRXZlbnQsIGRhdGEgKTsKCgkJCS8vIHVzZSB0aGUgd2lkZ2V0IHRyaWdnZXIgbWV0aG9kIGZvciB0aGUgbmV3IGNvbnRlbnQqIGV2ZW50CgkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCBuZXdFdmVudCwgZGF0YSApOwoKCQkJcmV0dXJuIHsKCQkJCWRlcHJlY2F0ZWRFdmVudDogZGVwcmVjYXRlZEV2ZW50LAoJCQkJZXZlbnQ6IG5ld0V2ZW50CgkJCX07CgkJfSwKCgkJLy8gVE9ETyBpdCB3b3VsZCBiZSBuaWNlIHRvIHNwbGl0IHRoaXMgdXAgbW9yZSBidXQgZXZlcnl0aGluZyBhcHBlYXJzIHRvIGJlICJvbmUgb2ZmIgoJCS8vICAgICAgb3IgcmVxdWlyZSBvcmRlcmluZyBzdWNoIHRoYXQgb3RoZXIgYml0cyBhcmUgc3ByaW5rbGVkIGluIGJldHdlZW4gcGFydHMgdGhhdAoJCS8vICAgICAgY291bGQgYmUgYWJzdHJhY3RlZCBvdXQgYXMgYSBncm91cAoJCV9sb2FkU3VjY2VzczogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJdmFyIGZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKSwKCQkJCWRhdGFVcmwgPSB0aGlzLl9jcmVhdGVEYXRhVXJsKCBhYnNVcmwgKTsKCgkJCXJldHVybiAkLnByb3h5KGZ1bmN0aW9uKCBodG1sLCB0ZXh0U3RhdHVzLCB4aHIgKSB7CgkJCQkvL3ByZS1wYXJzZSBodG1sIHRvIGNoZWNrIGZvciBhIGRhdGEtdXJsLAoJCQkJLy91c2UgaXQgYXMgdGhlIG5ldyBmaWxlVXJsLCBiYXNlIHBhdGgsIGV0YwoJCQkJdmFyIGNvbnRlbnQsCgoJCQkJCS8vIFRPRE8gaGFuZGxlIGRpYWxvZ3MgYWdhaW4KCQkJCQlwYWdlRWxlbVJlZ2V4ID0gbmV3IFJlZ0V4cCggIig8W14+XStcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInJvbGU9W1wiJ10/cGFnZVtcIiddP1tePl0qPikiICksCgoJCQkJCWRhdGFVcmxSZWdleCA9IG5ldyBSZWdFeHAoICJcXGJkYXRhLSIgKyB0aGlzLl9nZXROcygpICsgInVybD1bXCInXT8oW15cIic+XSopW1wiJ10/IiApOwoKCQkJCS8vIGRhdGEtdXJsIG11c3QgYmUgcHJvdmlkZWQgZm9yIHRoZSBiYXNlIHRhZyBzbyByZXNvdXJjZSByZXF1ZXN0cwoJCQkJLy8gY2FuIGJlIGRpcmVjdGVkIHRvIHRoZSBjb3JyZWN0IHVybC4gbG9hZGluZyBpbnRvIGEgdGVtcHJvcmFyeQoJCQkJLy8gZWxlbWVudCBtYWtlcyB0aGVzZSByZXF1ZXN0cyBpbW1lZGlhdGVseQoJCQkJaWYgKCBwYWdlRWxlbVJlZ2V4LnRlc3QoIGh0bWwgKSAmJgoJCQkJCVJlZ0V4cC4kMSAmJgoJCQkJCWRhdGFVcmxSZWdleC50ZXN0KCBSZWdFeHAuJDEgKSAmJgoJCQkJCVJlZ0V4cC4kMSApIHsKCQkJCQlmaWxlVXJsID0gJC5tb2JpbGUucGF0aC5nZXRGaWxlUGF0aCggJCgiPGRpdj4iICsgUmVnRXhwLiQxICsgIjwvZGl2PiIpLnRleHQoKSApOwoJCQkJfQoKCQkJCS8vZG9udCB1cGRhdGUgdGhlIGJhc2UgdGFnIGlmIHdlIGFyZSBwcmVmZXRjaGluZwoJCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJCXRoaXMuX2dldEJhc2UoKS5zZXQoIGZpbGVVcmwgKTsKCQkJCX0KCgkJCQljb250ZW50ID0gdGhpcy5fcGFyc2UoIGh0bWwsIGZpbGVVcmwgKTsKCgkJCQl0aGlzLl9zZXRMb2FkZWRUaXRsZSggY29udGVudCwgaHRtbCApOwoKCQkJCS8vIEFkZCB0aGUgY29udGVudCByZWZlcmVuY2UgYW5kIHhociB0byBvdXIgdHJpZ2dlckRhdGEuCgkJCQl0cmlnZ2VyRGF0YS54aHIgPSB4aHI7CgkJCQl0cmlnZ2VyRGF0YS50ZXh0U3RhdHVzID0gdGV4dFN0YXR1czsKCgkJCQkvLyBERVBSRUNBVEVECgkJCQl0cmlnZ2VyRGF0YS5wYWdlID0gY29udGVudDsKCgkJCQl0cmlnZ2VyRGF0YS5jb250ZW50ID0gY29udGVudDsKCgkJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJCS8vIE5vdGUgdGhhdCBpdCBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIGxpc3RlbmVyL2hhbmRsZXIKCQkJCS8vIHRoYXQgY2FsbGVkIHByZXZlbnREZWZhdWx0KCksIHRvIHJlc29sdmUvcmVqZWN0IHRoZQoJCQkJLy8gZGVmZXJyZWQgb2JqZWN0IHdpdGhpbiB0aGUgdHJpZ2dlckRhdGEuCgkJCQlpZiAoICF0aGlzLl90cmlnZ2VyKCAibG9hZCIsIHVuZGVmaW5lZCwgdHJpZ2dlckRhdGEgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gcmV3cml0ZSBzcmMgYW5kIGhyZWYgYXR0cnMgdG8gdXNlIGEgYmFzZSB1cmwgaWYgdGhlIGJhc2UgdGFnIHdvbid0IHdvcmsKCQkJCWlmICggdGhpcy5faXNSZXdyaXRhYmxlQmFzZVRhZygpICYmIGNvbnRlbnQgKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnJld3JpdGUoIGZpbGVVcmwsIGNvbnRlbnQgKTsKCQkJCX0KCgkJCQl0aGlzLl9pbmNsdWRlKCBjb250ZW50LCBzZXR0aW5ncyApOwoKCQkJCS8vIEVuaGFuY2luZyB0aGUgY29udGVudCBtYXkgcmVzdWx0IGluIG5ldyBkaWFsb2dzL3N1YiBjb250ZW50IGJlaW5nIGluc2VydGVkCgkJCQkvLyBpbnRvIHRoZSBET00uIElmIHRoZSBvcmlnaW5hbCBhYnNVcmwgcmVmZXJzIHRvIGEgc3ViLWNvbnRlbnQsIHRoYXQgaXMgdGhlCgkJCQkvLyByZWFsIGNvbnRlbnQgd2UgYXJlIGludGVyZXN0ZWQgaW4uCgkJCQlpZiAoIGFic1VybC5pbmRleE9mKCAiJiIgKyAkLm1vYmlsZS5zdWJQYWdlVXJsS2V5ICkgPiAtMSApIHsKCQkJCQljb250ZW50ID0gdGhpcy5lbGVtZW50LmNoaWxkcmVuKCAiW2RhdGEtIiArIHRoaXMuX2dldE5zKCkgKyJ1cmw9JyIgKyBkYXRhVXJsICsgIiddIiApOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX2hpZGVMb2FkaW5nKCk7CgkJCQl9CgoJCQkJLy8gQkVHSU4gREVQUkVDQVRFRCAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgY29udGVudCBsb2FkZWQgc3VjY2Vzc2Z1bGx5LgoJCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJwYWdlbG9hZCIgKTsKCQkJCS8vIEVORCBERVBSRUNBVEVEIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCgoJCQkJZGVmZXJyZWQucmVzb2x2ZSggYWJzVXJsLCBzZXR0aW5ncywgY29udGVudCApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfbG9hZERlZmF1bHRzOiB7CgkJCXR5cGU6ICJnZXQiLAoJCQlkYXRhOiB1bmRlZmluZWQsCgoJCQkvLyBERVBSRUNBVEVECgkJCXJlbG9hZFBhZ2U6IGZhbHNlLAoKCQkJcmVsb2FkOiBmYWxzZSwKCgkJCS8vIEJ5IGRlZmF1bHQgd2UgcmVseSBvbiB0aGUgcm9sZSBkZWZpbmVkIGJ5IHRoZSBAZGF0YS1yb2xlIGF0dHJpYnV0ZS4KCQkJcm9sZTogdW5kZWZpbmVkLAoKCQkJc2hvd0xvYWRNc2c6IGZhbHNlLAoKCQkJLy8gVGhpcyBkZWxheSBhbGxvd3MgbG9hZHMgdGhhdCBwdWxsIGZyb20gYnJvd3NlciBjYWNoZSB0bwoJCQkvLyBvY2N1ciB3aXRob3V0IHNob3dpbmcgdGhlIGxvYWRpbmcgbWVzc2FnZS4KCQkJbG9hZE1zZ0RlbGF5OiA1MAoJCX0sCgoJCWxvYWQ6IGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMgKSB7CgkJCS8vIFRoaXMgZnVuY3Rpb24gdXNlcyBkZWZlcnJlZCBub3RpZmljYXRpb25zIHRvIGxldCBjYWxsZXJzCgkJCS8vIGtub3cgd2hlbiB0aGUgY29udGVudCBpcyBkb25lIGxvYWRpbmcsIG9yIGlmIGFuIGVycm9yIGhhcyBvY2N1cnJlZC4KCQkJdmFyIGRlZmVycmVkID0gKCBvcHRpb25zICYmIG9wdGlvbnMuZGVmZXJyZWQgKSB8fCAkLkRlZmVycmVkKCksCgoJCQkJLy8gVGhlIGRlZmF1bHQgbG9hZCBvcHRpb25zIHdpdGggb3ZlcnJpZGVzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyLgoJCQkJc2V0dGluZ3MgPSAkLmV4dGVuZCgge30sIHRoaXMuX2xvYWREZWZhdWx0cywgb3B0aW9ucyApLAoKCQkJCS8vIFRoZSBET00gZWxlbWVudCBmb3IgdGhlIGNvbnRlbnQgYWZ0ZXIgaXQgaGFzIGJlZW4gbG9hZGVkLgoJCQkJY29udGVudCA9IG51bGwsCgoJCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBwYXNzZWQgaW50byB0aGUgZnVuY3Rpb24uIFRoaXMKCQkJCS8vIHZlcnNpb24gb2YgdGhlIFVSTCBtYXkgY29udGFpbiBkaWFsb2cvc3ViY29udGVudCBwYXJhbXMgaW4gaXQuCgkJCQlhYnNVcmwgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggdXJsLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKSwKCQkJCWZpbGVVcmwsIGRhdGFVcmwsIHBibEV2ZW50LCB0cmlnZ2VyRGF0YTsKCgkJCS8vIERFUFJFQ0FURUQgcmVsb2FkUGFnZQoJCQlzZXR0aW5ncy5yZWxvYWQgPSBzZXR0aW5ncy5yZWxvYWRQYWdlOwoKCQkJLy8gSWYgdGhlIGNhbGxlciBwcm92aWRlZCBkYXRhLCBhbmQgd2UncmUgdXNpbmcgImdldCIgcmVxdWVzdCwKCQkJLy8gYXBwZW5kIHRoZSBkYXRhIHRvIHRoZSBVUkwuCgkJCWlmICggc2V0dGluZ3MuZGF0YSAmJiBzZXR0aW5ncy50eXBlID09PSAiZ2V0IiApIHsKCQkJCWFic1VybCA9ICQubW9iaWxlLnBhdGguYWRkU2VhcmNoUGFyYW1zKCBhYnNVcmwsIHNldHRpbmdzLmRhdGEgKTsKCQkJCXNldHRpbmdzLmRhdGEgPSB1bmRlZmluZWQ7CgkJCX0KCgkJCS8vIElmIHRoZSBjYWxsZXIgaXMgdXNpbmcgYSAicG9zdCIgcmVxdWVzdCwgcmVsb2FkIG11c3QgYmUgdHJ1ZQoJCQlpZiAoIHNldHRpbmdzLmRhdGEgJiYgc2V0dGluZ3MudHlwZSA9PT0gInBvc3QiICkgewoJCQkJc2V0dGluZ3MucmVsb2FkID0gdHJ1ZTsKCQkJfQoKCQkJLy8gVGhlIGFic29sdXRlIHZlcnNpb24gb2YgdGhlIFVSTCBtaW51cyBhbnkgZGlhbG9nL3N1YmNvbnRlbnQgcGFyYW1zLgoJCQkvLyBJbiBvdGhlcndvcmRzIHRoZSByZWFsIFVSTCBvZiB0aGUgY29udGVudCB0byBiZSBsb2FkZWQuCgkJCWZpbGVVcmwgPSB0aGlzLl9jcmVhdGVGaWxlVXJsKCBhYnNVcmwgKTsKCgkJCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBVcmwgYWN0dWFsbHkgc3RvcmVkIGluIHRoZSBkYXRhLXVybCBhdHRyaWJ1dGUgb2YKCQkJLy8gdGhlIGNvbnRlbnQuIEZvciBlbWJlZGRlZCBjb250ZW50LCBpdCBpcyBqdXN0IHRoZSBpZCBvZiB0aGUgcGFnZS4gRm9yCgkJCS8vIGNvbnRlbnQgd2l0aGluIHRoZSBzYW1lIGRvbWFpbiBhcyB0aGUgZG9jdW1lbnQgYmFzZSwgaXQgaXMgdGhlIHNpdGUKCQkJLy8gcmVsYXRpdmUgcGF0aC4gRm9yIGNyb3NzLWRvbWFpbiBjb250ZW50IChQaG9uZSBHYXAgb25seSkgdGhlIGVudGlyZQoJCQkvLyBhYnNvbHV0ZSBVcmwgaXMgdXNlZCB0byBsb2FkIHRoZSBjb250ZW50LgoJCQlkYXRhVXJsID0gdGhpcy5fY3JlYXRlRGF0YVVybCggYWJzVXJsICk7CgoJCQljb250ZW50ID0gdGhpcy5fZmluZCggYWJzVXJsICk7CgoJCQkvLyBJZiBpdCBpc24ndCBhIHJlZmVyZW5jZSB0byB0aGUgZmlyc3QgY29udGVudCBhbmQgcmVmZXJzIHRvIG1pc3NpbmcKCQkJLy8gZW1iZWRkZWQgY29udGVudCByZWplY3QgdGhlIGRlZmVycmVkIGFuZCByZXR1cm4KCQkJaWYgKCBjb250ZW50Lmxlbmd0aCA9PT0gMCAmJgoJCQkJJC5tb2JpbGUucGF0aC5pc0VtYmVkZGVkUGFnZShmaWxlVXJsKSAmJgoJCQkJISQubW9iaWxlLnBhdGguaXNGaXJzdFBhZ2VVcmwoZmlsZVVybCkgKSB7CgkJCQlkZWZlcnJlZC5yZWplY3QoIGFic1VybCwgc2V0dGluZ3MgKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlCgkJCS8vIFRPRE8gZmlndXJlIG91dCB3aHkgd2UgZG9lIHRoaXMKCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgoJCQkvLyBJZiB0aGUgY29udGVudCB3ZSBhcmUgaW50ZXJlc3RlZCBpbiBpcyBhbHJlYWR5IGluIHRoZSBET00sCgkJCS8vIGFuZCB0aGUgY2FsbGVyIGRpZCBub3QgaW5kaWNhdGUgdGhhdCB3ZSBzaG91bGQgZm9yY2UgYQoJCQkvLyByZWxvYWQgb2YgdGhlIGZpbGUsIHdlIGFyZSBkb25lLiBSZXNvbHZlIHRoZSBkZWZlcnJyZWQgc28gdGhhdAoJCQkvLyB1c2VycyBjYW4gYmluZCB0byAuZG9uZSBvbiB0aGUgcHJvbWlzZQoJCQlpZiAoIGNvbnRlbnQubGVuZ3RoICYmICFzZXR0aW5ncy5yZWxvYWQgKSB7CgkJCQl0aGlzLl9lbmhhbmNlKCBjb250ZW50LCBzZXR0aW5ncy5yb2xlICk7CgkJCQlkZWZlcnJlZC5yZXNvbHZlKCBhYnNVcmwsIHNldHRpbmdzLCBjb250ZW50ICk7CgoJCQkJLy9pZiB3ZSBhcmUgcmVsb2FkaW5nIHRoZSBjb250ZW50IG1ha2Ugc3VyZSB3ZSB1cGRhdGUKCQkJCS8vIHRoZSBiYXNlIGlmIGl0cyBub3QgYSBwcmVmZXRjaAoJCQkJaWYgKCAhc2V0dGluZ3MucHJlZmV0Y2ggKSB7CgkJCQkJdGhpcy5fZ2V0QmFzZSgpLnNldCh1cmwpOwoJCQkJfQoKCQkJCXJldHVybjsKCQkJfQoKCQkJdHJpZ2dlckRhdGEgPSB7CgkJCQl1cmw6IHVybCwKCQkJCWFic1VybDogYWJzVXJsLAoJCQkJZGF0YVVybDogZGF0YVVybCwKCQkJCWRlZmVycmVkOiBkZWZlcnJlZCwKCQkJCW9wdGlvbnM6IHNldHRpbmdzCgkJCX07CgoJCQkvLyBMZXQgbGlzdGVuZXJzIGtub3cgd2UncmUgYWJvdXQgdG8gbG9hZCBjb250ZW50LgoJCQlwYmxFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImJlZm9yZWxvYWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJLy8gSWYgdGhlIGRlZmF1bHQgYmVoYXZpb3IgaXMgcHJldmVudGVkLCBzdG9wIGhlcmUhCgkJCWlmICggcGJsRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQlwYmxFdmVudC5ldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCBzZXR0aW5ncy5zaG93TG9hZE1zZyApIHsKCQkJCXRoaXMuX3Nob3dMb2FkaW5nKCBzZXR0aW5ncy5sb2FkTXNnRGVsYXkgKTsKCQkJfQoKCQkJLy8gUmVzZXQgYmFzZSB0byB0aGUgZGVmYXVsdCBkb2N1bWVudCBiYXNlLgoJCQkvLyBvbmx5IHJlc2V0IGlmIHdlIGFyZSBub3QgcHJlZmV0Y2hpbmcKCQkJaWYgKCBzZXR0aW5ncy5wcmVmZXRjaCA9PT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fZ2V0QmFzZSgpLnJlc2V0KCk7CgkJCX0KCgkJCWlmICggISggJC5tb2JpbGUuYWxsb3dDcm9zc0RvbWFpblBhZ2VzIHx8CgkJCQkkLm1vYmlsZS5wYXRoLmlzU2FtZURvbWFpbigkLm1vYmlsZS5wYXRoLmRvY3VtZW50VXJsLCBhYnNVcmwgKSApICkgewoJCQkJZGVmZXJyZWQucmVqZWN0KCBhYnNVcmwsIHNldHRpbmdzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIExvYWQgdGhlIG5ldyBjb250ZW50LgoJCQkkLmFqYXgoewoJCQkJdXJsOiBmaWxlVXJsLAoJCQkJdHlwZTogc2V0dGluZ3MudHlwZSwKCQkJCWRhdGE6IHNldHRpbmdzLmRhdGEsCgkJCQljb250ZW50VHlwZTogc2V0dGluZ3MuY29udGVudFR5cGUsCgkJCQlkYXRhVHlwZTogImh0bWwiLAoJCQkJc3VjY2VzczogdGhpcy5fbG9hZFN1Y2Nlc3MoIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApLAoJCQkJZXJyb3I6IHRoaXMuX2xvYWRFcnJvciggYWJzVXJsLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MsIGRlZmVycmVkICkKCQkJfSk7CgkJfSwKCgkJX2xvYWRFcnJvcjogZnVuY3Rpb24oIGFic1VybCwgdHJpZ2dlckRhdGEsIHNldHRpbmdzLCBkZWZlcnJlZCApIHsKCQkJcmV0dXJuICQucHJveHkoZnVuY3Rpb24oIHhociwgdGV4dFN0YXR1cywgZXJyb3JUaHJvd24gKSB7CgkJCQkvL3NldCBiYXNlIGJhY2sgdG8gY3VycmVudCBwYXRoCgkJCQl0aGlzLl9nZXRCYXNlKCkuc2V0KCAkLm1vYmlsZS5wYXRoLmdldCgpICk7CgoJCQkJLy8gQWRkIGVycm9yIGluZm8gdG8gb3VyIHRyaWdnZXJEYXRhLgoJCQkJdHJpZ2dlckRhdGEueGhyID0geGhyOwoJCQkJdHJpZ2dlckRhdGEudGV4dFN0YXR1cyA9IHRleHRTdGF0dXM7CgkJCQl0cmlnZ2VyRGF0YS5lcnJvclRocm93biA9IGVycm9yVGhyb3duOwoKCQkJCS8vIExldCBsaXN0ZW5lcnMga25vdyB0aGUgcGFnZSBsb2FkIGZhaWxlZC4KCQkJCXZhciBwbGZFdmVudCA9IHRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImxvYWRmYWlsZWQiLCB0cmlnZ2VyRGF0YSApOwoKCQkJCS8vIElmIHRoZSBkZWZhdWx0IGJlaGF2aW9yIGlzIHByZXZlbnRlZCwgc3RvcCBoZXJlIQoJCQkJLy8gTm90ZSB0aGF0IGl0IGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgbGlzdGVuZXIvaGFuZGxlcgoJCQkJLy8gdGhhdCBjYWxsZWQgcHJldmVudERlZmF1bHQoKSwgdG8gcmVzb2x2ZS9yZWplY3QgdGhlCgkJCQkvLyBkZWZlcnJlZCBvYmplY3Qgd2l0aGluIHRoZSB0cmlnZ2VyRGF0YS4KCQkJCWlmICggcGxmRXZlbnQuZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQkJcGxmRXZlbnQuZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCS8vIFJlbW92ZSBsb2FkaW5nIG1lc3NhZ2UuCgkJCQlpZiAoIHNldHRpbmdzLnNob3dMb2FkTXNnICkgewoJCQkJCXRoaXMuX3Nob3dFcnJvcigpOwoJCQkJfQoKCQkJCWRlZmVycmVkLnJlamVjdCggYWJzVXJsLCBzZXR0aW5ncyApOwoJCQl9LCB0aGlzKTsKCQl9LAoKCQlfZ2V0VHJhbnNpdGlvbkhhbmRsZXI6IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCQl0cmFuc2l0aW9uID0gJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24oIHRyYW5zaXRpb24gKTsKCgkJCS8vZmluZCB0aGUgdHJhbnNpdGlvbiBoYW5kbGVyIGZvciB0aGUgc3BlY2lmaWVkIHRyYW5zaXRpb24uIElmIHRoZXJlCgkJCS8vaXNuJ3Qgb25lIGluIG91ciB0cmFuc2l0aW9uSGFuZGxlcnMgZGljdGlvbmFyeSwgdXNlIHRoZSBkZWZhdWx0IG9uZS4KCQkJLy9jYWxsIHRoZSBoYW5kbGVyIGltbWVkaWF0ZWx5IHRvIGtpY2stb2ZmIHRoZSB0cmFuc2l0aW9uLgoJCQlyZXR1cm4gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzWyB0cmFuc2l0aW9uIF0gfHwgJC5tb2JpbGUuZGVmYXVsdFRyYW5zaXRpb25IYW5kbGVyOwoJCX0sCgoJCS8vIFRPRE8gbW92ZSBpbnRvIHRyYW5zaXRpb24gaGFuZGxlcnM/CgkJX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzOiBmdW5jdGlvbiggdG8sIGZyb20sIHByZWZpeCApIHsKCQkJdmFyIHNhbWVQYWdlID0gZmFsc2U7CgoJCQlwcmVmaXggPSBwcmVmaXggfHwgIiI7CgoJCQkvLyBUT0RPIGRlY2lkZSBpZiB0aGVzZSBldmVudHMgc2hvdWxkIGluIGZhY3QgYmUgdHJpZ2dlcmVkIG9uIHRoZSBjb250YWluZXIKCQkJaWYgKCBmcm9tICkgewoKCQkJCS8vQ2hlY2sgaWYgdGhpcyBpcyBhIHNhbWUgcGFnZSB0cmFuc2l0aW9uIGFuZCB0ZWxsIHRoZSBoYW5kbGVyIGluIHBhZ2UKCQkJCWlmKCB0b1swXSA9PT0gZnJvbVswXSApewoJCQkJCXNhbWVQYWdlID0gdHJ1ZTsKCQkJCX0KCgkJCQkvL3RyaWdnZXIgYmVmb3JlIHNob3cvaGlkZSBldmVudHMKCQkJCS8vIFRPRE8gZGVwcmVjYXRlIG5leHRQYWdlIGluIGZhdm9yIG9mIG5leHQKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggcHJlZml4ICsgImhpZGUiLCB7IG5leHRQYWdlOiB0bywgc2FtZVBhZ2U6IHNhbWVQYWdlIH0sIGZyb20gKTsKCQkJfQoKCQkJLy8gVE9ETyBkZXByZWNhdGUgcHJldlBhZ2UgaW4gZmF2b3Igb2YgcHJldmlvdXMKCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCBwcmVmaXggKyAic2hvdyIsIHsgcHJldlBhZ2U6IGZyb20gfHwgJCggIiIgKSB9LCB0byApOwoJCX0sCgoJCS8vIFRPRE8gbWFrZSBwcml2YXRlIG9uY2UgY2hhbmdlIGhhcyBiZWVuIGRlZmluZWQgaW4gdGhlIHdpZGdldAoJCV9jc3NUcmFuc2l0aW9uOiBmdW5jdGlvbiggdG8sIGZyb20sIG9wdGlvbnMgKSB7CgkJCXZhciB0cmFuc2l0aW9uID0gb3B0aW9ucy50cmFuc2l0aW9uLAoJCQkJcmV2ZXJzZSA9IG9wdGlvbnMucmV2ZXJzZSwKCQkJCWRlZmVycmVkID0gb3B0aW9ucy5kZWZlcnJlZCwKCQkJCVRyYW5zaXRpb25IYW5kbGVyLAoJCQkJcHJvbWlzZTsKCgkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSwgImJlZm9yZSIgKTsKCgkJCS8vIFRPRE8gcHV0IHRoaXMgaW4gYSBiaW5kaW5nIHRvIGV2ZW50cyAqb3V0c2lkZSogdGhlIHdpZGdldAoJCQl0aGlzLl9oaWRlTG9hZGluZygpOwoKCQkJVHJhbnNpdGlvbkhhbmRsZXIgPSB0aGlzLl9nZXRUcmFuc2l0aW9uSGFuZGxlciggdHJhbnNpdGlvbiApOwoKCQkJcHJvbWlzZSA9ICggbmV3IFRyYW5zaXRpb25IYW5kbGVyKCB0cmFuc2l0aW9uLCByZXZlcnNlLCB0bywgZnJvbSApICkudHJhbnNpdGlvbigpOwoKCQkJLy8gVE9ETyB0ZW1wb3JhcnkgYWNjb21vZGF0aW9uIG9mIGFyZ3VtZW50IGRlZmVycmVkCgkJCXByb21pc2UuZG9uZShmdW5jdGlvbigpIHsKCQkJCWRlZmVycmVkLnJlc29sdmUuYXBwbHkoIGRlZmVycmVkLCBhcmd1bWVudHMgKTsKCQkJfSk7CgoJCQlwcm9taXNlLmRvbmUoJC5wcm94eShmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXJDc3NUcmFuc2l0aW9uRXZlbnRzKCB0bywgZnJvbSApOwoJCQl9LCB0aGlzKSk7CgkJfSwKCgkJX3JlbGVhc2VUcmFuc2l0aW9uTG9jazogZnVuY3Rpb24oKSB7CgkJCS8vcmVsZWFzZSB0cmFuc2l0aW9uIGxvY2sgc28gbmF2aWdhdGlvbiBpcyBmcmVlIGFnYWluCgkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSBmYWxzZTsKCQkJaWYgKCBwYWdlVHJhbnNpdGlvblF1ZXVlLmxlbmd0aCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5jaGFuZ2VQYWdlLmFwcGx5KCBudWxsLCBwYWdlVHJhbnNpdGlvblF1ZXVlLnBvcCgpICk7CgkJCX0KCQl9LAoKCQlfcmVtb3ZlQWN0aXZlTGlua0NsYXNzOiBmdW5jdGlvbiggZm9yY2UgKSB7CgkJCS8vY2xlYXIgb3V0IHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlCgkJCSQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggZm9yY2UgKTsKCQl9LAoKCQlfbG9hZFVybDogZnVuY3Rpb24oIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKSB7CgkJCS8vIHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcwoJCQkvLyBmcm9tIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkKCQkJLy8gcGFyYW1zIGhhdmUgYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZQoJCQkvLyBsaWZlIGN5Y2xlIFNlZSBpc3N1ZSAjNTA4NQoJCQlzZXR0aW5ncy50YXJnZXQgPSB0bzsKCQkJc2V0dGluZ3MuZGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLmxvYWQoIHRvLCBzZXR0aW5ncyApOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZG9uZSgkLnByb3h5KGZ1bmN0aW9uKCB1cmwsIG9wdGlvbnMsIGNvbnRlbnQgKSB7CgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgoJCQkJLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGFic29sdXRlIHVybCBzbyB0aGF0IGl0IGNhbiBiZSBwcm92aWRlZAoJCQkJLy8gdG8gZXZlbnRzIGluIHRoZSB0cmlnZ2VyRGF0YSBvZiB0aGUgc3Vic2VxdWVudCBjaGFuZ2VQYWdlIGNhbGwKCQkJCW9wdGlvbnMuYWJzVXJsID0gdHJpZ2dlckRhdGEuYWJzVXJsOwoKCQkJCXRoaXMudHJhbnNpdGlvbiggY29udGVudCwgdHJpZ2dlckRhdGEsIG9wdGlvbnMgKTsKCQkJfSwgdGhpcykpOwoKCQkJc2V0dGluZ3MuZGVmZXJyZWQuZmFpbCgkLnByb3h5KGZ1bmN0aW9uKC8qIHVybCwgb3B0aW9ucyAqLykgewoJCQkJdGhpcy5fcmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQl0aGlzLl9yZWxlYXNlVHJhbnNpdGlvbkxvY2soKTsKCQkJCXRoaXMuX3RyaWdnZXJXaXRoRGVwcmVjYXRlZCggImNoYW5nZWZhaWxlZCIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQlfdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2U6IGZ1bmN0aW9uKCB0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgcGJjRXZlbnQgPSBuZXcgJC5FdmVudCggInBhZ2ViZWZvcmVjaGFuZ2UiICk7CgoJCQkkLmV4dGVuZCh0cmlnZ2VyRGF0YSwgeyB0b1BhZ2U6IHRvLCBvcHRpb25zOiBzZXR0aW5ncyB9KTsKCgkJCS8vIE5PVEU6IHByZXNlcnZlIHRoZSBvcmlnaW5hbCB0YXJnZXQgYXMgdGhlIGRhdGFVcmwgdmFsdWUgd2lsbCBiZQoJCQkvLyBzaW1wbGlmaWVkIGVnLCByZW1vdmluZyB1aS1zdGF0ZSwgYW5kIHJlbW92aW5nIHF1ZXJ5IHBhcmFtcyBmcm9tCgkJCS8vIHRoZSBoYXNoIHRoaXMgaXMgc28gdGhhdCB1c2VycyB3aG8gd2FudCB0byB1c2UgcXVlcnkgcGFyYW1zIGhhdmUKCQkJLy8gYWNjZXNzIHRvIHRoZW0gaW4gdGhlIGV2ZW50IGJpbmRpbmdzIGZvciB0aGUgcGFnZSBsaWZlIGN5Y2xlCgkJCS8vIFNlZSBpc3N1ZSAjNTA4NQoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gaWYgdGhlIHRvUGFnZSBpcyBhIHN0cmluZyBzaW1wbHkgY29udmVydCBpdAoJCQkJdHJpZ2dlckRhdGEuYWJzVXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvLCB0aGlzLl9maW5kQmFzZVdpdGhEZWZhdWx0KCkgKTsKCQkJfSBlbHNlIHsKCQkJCS8vIGlmIHRoZSB0b1BhZ2UgaXMgYSBqUXVlcnkgb2JqZWN0IGdyYWIgdGhlIGFic29sdXRlIHVybCBzdG9yZWQKCQkJCS8vIGluIHRoZSBsb2FkUGFnZSBjYWxsYmFjayB3aGVyZSBpdCBleGlzdHMKCQkJCXRyaWdnZXJEYXRhLmFic1VybCA9IHNldHRpbmdzLmFic1VybDsKCQkJfQoKCQkJLy8gTGV0IGxpc3RlbmVycyBrbm93IHdlJ3JlIGFib3V0IHRvIGNoYW5nZSB0aGUgY3VycmVudCBwYWdlLgoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggcGJjRXZlbnQsIHRyaWdnZXJEYXRhICk7CgoJCQkvLyBJZiB0aGUgZGVmYXVsdCBiZWhhdmlvciBpcyBwcmV2ZW50ZWQsIHN0b3AgaGVyZSEKCQkJaWYgKCBwYmNFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoKCQkJcmV0dXJuIHRydWU7CgkJfSwKCgkJY2hhbmdlOiBmdW5jdGlvbiggdG8sIG9wdGlvbnMgKSB7CgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggYXJndW1lbnRzICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXZhciBzZXR0aW5ncyA9ICQuZXh0ZW5kKCB7fSwgJC5tb2JpbGUuY2hhbmdlUGFnZS5kZWZhdWx0cywgb3B0aW9ucyApLAoJCQkJdHJpZ2dlckRhdGEgPSB7fTsKCgkJCS8vIE1ha2Ugc3VyZSB3ZSBoYXZlIGEgZnJvbVBhZ2UuCgkJCXNldHRpbmdzLmZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2UgfHwgdGhpcy5hY3RpdmVQYWdlOwoKCQkJLy8gaWYgdGhlIHBhZ2UgYmVmb3JlY2hhbmdlIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQlpZiAoICF0aGlzLl90cmlnZ2VyUGFnZUJlZm9yZUNoYW5nZSh0bywgdHJpZ2dlckRhdGEsIHNldHRpbmdzKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gV2UgYWxsb3cgInBhZ2ViZWZvcmVjaGFuZ2UiIG9ic2VydmVycyB0byBtb2RpZnkgdGhlIHRvIGluCgkJCS8vIHRoZSB0cmlnZ2VyIGRhdGEgdG8gYWxsb3cgZm9yIHJlZGlyZWN0cy4gTWFrZSBzdXJlIG91ciB0byBpcwoJCQkvLyB1cGRhdGVkLiBXZSBhbHNvIG5lZWQgdG8gcmUtZXZhbHVhdGUgd2hldGhlciBpdCBpcyBhIHN0cmluZywKCQkJLy8gYmVjYXVzZSBhbiBvYmplY3QgY2FuIGFsc28gYmUgcmVwbGFjZWQgYnkgYSBzdHJpbmcKCQkJdG8gPSB0cmlnZ2VyRGF0YS50b1BhZ2U7CgoJCQkvLyBJZiB0aGUgY2FsbGVyIHBhc3NlZCB1cyBhIHVybCwgY2FsbCBsb2FkUGFnZSgpCgkJCS8vIHRvIG1ha2Ugc3VyZSBpdCBpcyBsb2FkZWQgaW50byB0aGUgRE9NLiBXZSdsbCBsaXN0ZW4KCQkJLy8gdG8gdGhlIHByb21pc2Ugb2JqZWN0IGl0IHJldHVybnMgc28gd2Uga25vdyB3aGVuCgkJCS8vIGl0IGlzIGRvbmUgbG9hZGluZyBvciBpZiBhbiBlcnJvciBvY3VycmVkLgoJCQlpZiAoICQudHlwZSh0bykgPT09ICJzdHJpbmciICkgewoJCQkJLy8gU2V0IHRoZSBpc1BhZ2VUcmFuc2l0aW9uaW5nIGZsYWcgdG8gcHJldmVudCBhbnkgcmVxdWVzdHMgZnJvbQoJCQkJLy8gZW50ZXJpbmcgdGhpcyBtZXRob2Qgd2hpbGUgd2UgYXJlIGluIHRoZSBtaWRzdCBvZiBsb2FkaW5nIGEgcGFnZQoJCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJCWlzUGFnZVRyYW5zaXRpb25pbmcgPSB0cnVlOwoKCQkJCXRoaXMuX2xvYWRVcmwoIHRvLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMudHJhbnNpdGlvbiggdG8sIHRyaWdnZXJEYXRhLCBzZXR0aW5ncyApOwoJCQl9CgkJfSwKCgkJdHJhbnNpdGlvbjogZnVuY3Rpb24oIHRvUGFnZSwgdHJpZ2dlckRhdGEsIHNldHRpbmdzICkgewoJCQl2YXIgZnJvbVBhZ2UsIHVybCwgcGFnZVVybCwgZmlsZVVybCwKCQkJCWFjdGl2ZSwgYWN0aXZlSXNJbml0aWFsUGFnZSwKCQkJCWhpc3RvcnlEaXIsIHBhZ2VUaXRsZSwgaXNEaWFsb2csCgkJCQlhbHJlYWR5VGhlcmUsIG5ld1BhZ2VUaXRsZSwKCQkJCXBhcmFtcywJY3NzVHJhbnNpdGlvbkRlZmVycmVkLAoJCQkJYmVmb3JlVHJhbnNpdGlvbjsKCgkJCS8vIElmIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgYSB0cmFuc2l0aW9uLCBxdWV1ZSB0aGUgY3VycmVudCByZXF1ZXN0LgoJCQkvLyBXZSdsbCBjYWxsIGNoYW5nZVBhZ2UoKSBvbmNlIHdlJ3JlIGRvbmUgd2l0aCB0aGUgY3VycmVudCB0cmFuc2l0aW9uCgkJCS8vIHRvIHNlcnZpY2UgdGhlIHJlcXVlc3QuCgkJCWlmICggaXNQYWdlVHJhbnNpdGlvbmluZyApIHsKCQkJCS8vIG1ha2Ugc3VyZSB0byBvbmx5IHF1ZXVlIHRoZSB0byBhbmQgc2V0dGluZ3MgdmFsdWVzIHNvIHRoZSBhcmd1bWVudHMKCQkJCS8vIHdvcmsgd2l0aCBhIGNhbGwgdG8gdGhlIGNoYW5nZSBtZXRob2QKCQkJCXBhZ2VUcmFuc2l0aW9uUXVldWUudW5zaGlmdCggW3RvUGFnZSwgc2V0dGluZ3NdICk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIERFUFJFQ0FURUQgLSB0aGlzIGNhbGwgb25seSwgaW4gZmF2b3Igb2YgdGhlIGJlZm9yZSB0cmFuc2l0aW9uCgkJCS8vIGlmIHRoZSBwYWdlIGJlZm9yZWNoYW5nZSBkZWZhdWx0IGlzIHByZXZlbnRlZCByZXR1cm4gZWFybHkKCQkJaWYgKCAhdGhpcy5fdHJpZ2dlclBhZ2VCZWZvcmVDaGFuZ2UodG9QYWdlLCB0cmlnZ2VyRGF0YSwgc2V0dGluZ3MpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBpZiB0aGUgKGNvbnRlbnR8cGFnZSliZWZvcmV0cmFuc2l0aW9uIGRlZmF1bHQgaXMgcHJldmVudGVkIHJldHVybiBlYXJseQoJCQkvLyBOb3RlLCB3ZSBoYXZlIHRvIGNoZWNrIGZvciBib3RoIHRoZSBkZXByZWNhdGVkIGFuZCBuZXcgZXZlbnRzCgkJCWJlZm9yZVRyYW5zaXRpb24gPSB0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJiZWZvcmV0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJaWYgKGJlZm9yZVRyYW5zaXRpb24uZGVwcmVjYXRlZEV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpIHx8CgkJCQliZWZvcmVUcmFuc2l0aW9uLmV2ZW50LmlzRGVmYXVsdFByZXZlbnRlZCgpICkgewoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBTZXQgdGhlIGlzUGFnZVRyYW5zaXRpb25pbmcgZmxhZyB0byBwcmV2ZW50IGFueSByZXF1ZXN0cyBmcm9tCgkJCS8vIGVudGVyaW5nIHRoaXMgbWV0aG9kIHdoaWxlIHdlIGFyZSBpbiB0aGUgbWlkc3Qgb2YgbG9hZGluZyBhIHBhZ2UKCQkJLy8gb3IgdHJhbnNpdGlvbmluZy4KCQkJaXNQYWdlVHJhbnNpdGlvbmluZyA9IHRydWU7CgoJCQkvLyBJZiB3ZSBhcmUgZ29pbmcgdG8gdGhlIGZpcnN0LXBhZ2Ugb2YgdGhlIGFwcGxpY2F0aW9uLCB3ZSBuZWVkIHRvIG1ha2UKCQkJLy8gc3VyZSBzZXR0aW5ncy5kYXRhVXJsIGlzIHNldCB0byB0aGUgYXBwbGljYXRpb24gZG9jdW1lbnQgdXJsLiBUaGlzIGFsbG93cwoJCQkvLyB1cyB0byBhdm9pZCBnZW5lcmF0aW5nIGEgZG9jdW1lbnQgdXJsIHdpdGggYW4gaWQgaGFzaCBpbiB0aGUgY2FzZSB3aGVyZSB0aGUKCQkJLy8gZmlyc3QtcGFnZSBvZiB0aGUgZG9jdW1lbnQgaGFzIGFuIGlkIGF0dHJpYnV0ZSBzcGVjaWZpZWQuCgkJCWlmICggdG9QYWdlWyAwIF0gPT09ICQubW9iaWxlLmZpcnN0UGFnZVsgMCBdICYmICFzZXR0aW5ncy5kYXRhVXJsICkgewoJCQkJc2V0dGluZ3MuZGF0YVVybCA9ICQubW9iaWxlLnBhdGguZG9jdW1lbnRVcmwuaHJlZk5vSGFzaDsKCQkJfQoKCQkJLy8gVGhlIGNhbGxlciBwYXNzZWQgdXMgYSByZWFsIHBhZ2UgRE9NIGVsZW1lbnQuIFVwZGF0ZSBvdXIKCQkJLy8gaW50ZXJuYWwgc3RhdGUgYW5kIHRoZW4gdHJpZ2dlciBhIHRyYW5zaXRpb24gdG8gdGhlIHBhZ2UuCgkJCWZyb21QYWdlID0gc2V0dGluZ3MuZnJvbVBhZ2U7CgkJCXVybCA9ICggc2V0dGluZ3MuZGF0YVVybCAmJiAkLm1vYmlsZS5wYXRoLmNvbnZlcnRVcmxUb0RhdGFVcmwoc2V0dGluZ3MuZGF0YVVybCkgKSB8fAoJCQkJdG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgoJCQkvLyBUaGUgcGFnZVVybCB2YXIgaXMgdXN1YWxseSB0aGUgc2FtZSBhcyB1cmwsIGV4Y2VwdCB3aGVuIHVybCBpcyBvYnNjdXJlZAoJCQkvLyBhcyBhIGRpYWxvZyB1cmwuIHBhZ2VVcmwgYWx3YXlzIGNvbnRhaW5zIHRoZSBmaWxlIHBhdGgKCQkJcGFnZVVybCA9IHVybDsKCQkJZmlsZVVybCA9ICQubW9iaWxlLnBhdGguZ2V0RmlsZVBhdGgoIHVybCApOwoJCQlhY3RpdmUgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpOwoJCQlhY3RpdmVJc0luaXRpYWxQYWdlID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMDsKCQkJaGlzdG9yeURpciA9IDA7CgkJCXBhZ2VUaXRsZSA9IGRvY3VtZW50LnRpdGxlOwoJCQlpc0RpYWxvZyA9ICggc2V0dGluZ3Mucm9sZSA9PT0gImRpYWxvZyIgfHwKCQkJCXRvUGFnZS5qcW1EYXRhKCAicm9sZSIgKSA9PT0gImRpYWxvZyIgKSAmJgoJCQkJdG9QYWdlLmpxbURhdGEoICJkaWFsb2ciICkgIT09IHRydWU7CgoJCQkvLyBCeSBkZWZhdWx0LCB3ZSBwcmV2ZW50IGNoYW5nZVBhZ2UgcmVxdWVzdHMgd2hlbiB0aGUgZnJvbVBhZ2UgYW5kIHRvUGFnZQoJCQkvLyBhcmUgdGhlIHNhbWUgZWxlbWVudCwgYnV0IGZvbGtzIHRoYXQgZ2VuZXJhdGUgY29udGVudAoJCQkvLyBtYW51YWxseS9keW5hbWljYWxseSBhbmQgcmV1c2UgcGFnZXMgd2FudCB0byBiZSBhYmxlIHRvIHRyYW5zaXRpb24gdG8KCQkJLy8gdGhlIHNhbWUgcGFnZS4gVG8gYWxsb3cgdGhpcywgdGhleSB3aWxsIG5lZWQgdG8gY2hhbmdlIHRoZSBkZWZhdWx0CgkJCS8vIHZhbHVlIG9mIGFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uIHRvIHRydWUsICpPUiosIHBhc3MgaXQgaW4gYXMgYW4KCQkJLy8gb3B0aW9uIHdoZW4gdGhleSBtYW51YWxseSBjYWxsIGNoYW5nZVBhZ2UoKS4gSXQgc2hvdWxkIGJlIG5vdGVkIHRoYXQKCQkJLy8gb3VyIGRlZmF1bHQgdHJhbnNpdGlvbiBhbmltYXRpb25zIGFzc3VtZSB0aGF0IHRoZSBmb3JtUGFnZSBhbmQgdG9QYWdlCgkJCS8vIGFyZSBkaWZmZXJlbnQgZWxlbWVudHMsIHNvIHRoZXkgbWF5IGJlaGF2ZSB1bmV4cGVjdGVkbHkuIEl0IGlzIHVwIHRvCgkJCS8vIHRoZSBkZXZlbG9wZXIgdGhhdCB0dXJucyBvbiB0aGUgYWxsb3dTYW1lUGFnZVRyYW5zaXRpb25hIG9wdGlvbiB0bwoJCQkvLyBlaXRoZXIgdHVybiBvZmYgdHJhbnNpdGlvbiBhbmltYXRpb25zLCBvciBtYWtlIHN1cmUgdGhhdCBhbiBhcHByb3ByaWF0ZQoJCQkvLyBhbmltYXRpb24gdHJhbnNpdGlvbiBpcyB1c2VkLgoJCQlpZiAoIGZyb21QYWdlICYmIGZyb21QYWdlWzBdID09PSB0b1BhZ2VbMF0gJiYKCQkJCSFzZXR0aW5ncy5hbGxvd1NhbWVQYWdlVHJhbnNpdGlvbiApIHsKCgkJCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7CgkJCQl0aGlzLl90cmlnZ2VyV2l0aERlcHJlY2F0ZWQoICJ0cmFuc2l0aW9uIiwgdHJpZ2dlckRhdGEgKTsKCQkJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAicGFnZWNoYW5nZSIsIHRyaWdnZXJEYXRhICk7CgoJCQkJLy8gRXZlbiBpZiB0aGVyZSBpcyBubyBwYWdlIGNoYW5nZSB0byBiZSBkb25lLCB3ZSBzaG91bGQga2VlcCB0aGUKCQkJCS8vIHVybEhpc3RvcnkgaW4gc3luYyB3aXRoIHRoZSBoYXNoIGNoYW5nZXMKCQkJCWlmICggc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5kaXJlY3QoeyB1cmw6IHVybCB9KTsKCQkJCX0KCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFdlIG5lZWQgdG8gbWFrZSBzdXJlIHRoZSBwYWdlIHdlIGFyZSBnaXZlbiBoYXMgYWxyZWFkeSBiZWVuIGVuaGFuY2VkLgoJCQl0b1BhZ2UucGFnZSh7IHJvbGU6IHNldHRpbmdzLnJvbGUgfSk7CgoJCQkvLyBJZiB0aGUgY2hhbmdlUGFnZSByZXF1ZXN0IHdhcyBzZW50IGZyb20gYSBoYXNoQ2hhbmdlIGV2ZW50LCBjaGVjayB0bwoJCQkvLyBzZWUgaWYgdGhlIHBhZ2UgaXMgYWxyZWFkeSB3aXRoaW4gdGhlIHVybEhpc3Rvcnkgc3RhY2suIElmIHNvLCB3ZSdsbAoJCQkvLyBhc3N1bWUgdGhlIHVzZXIgaGl0IHRoZSBmb3J3YXJkL2JhY2sgYnV0dG9uIGFuZCB3aWxsIHRyeSB0byBtYXRjaCB0aGUKCQkJLy8gdHJhbnNpdGlvbiBhY2NvcmRpbmdseS4KCQkJaWYgKCBzZXR0aW5ncy5mcm9tSGFzaENoYW5nZSApIHsKCQkJCWhpc3RvcnlEaXIgPSBzZXR0aW5ncy5kaXJlY3Rpb24gPT09ICJiYWNrIiA/IC0xIDogMTsKCQkJfQoKCQkJLy8gS2lsbCB0aGUga2V5Ym9hcmQuCgkJCS8vIFhYWF9qYmxhczogV2UgbmVlZCB0byBzdG9wIGNyYXdsaW5nIHRoZSBlbnRpcmUgZG9jdW1lbnQgdG8ga2lsbCBmb2N1cy4KCQkJLy8gICAgICAgICAgICBJbnN0ZWFkLCB3ZSBzaG91bGQgYmUgdHJhY2tpbmcgZm9jdXMgd2l0aCBhIGRlbGVnYXRlKCkKCQkJLy8gICAgICAgICAgICBoYW5kbGVyIHNvIHdlIGFscmVhZHkgaGF2ZSB0aGUgZWxlbWVudCBpbiBoYW5kIGF0IHRoaXMKCQkJLy8gICAgICAgICAgICBwb2ludC4KCQkJLy8gV3JhcCB0aGlzIGluIGEgdHJ5L2NhdGNoIGJsb2NrIHNpbmNlIElFOSB0aHJvdyAiVW5zcGVjaWZpZWQgZXJyb3IiIGlmCgkJCS8vIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgdW5kZWZpbmVkIHdoZW4gd2UgYXJlIGluIGFuIElGcmFtZS4KCQkJdHJ5IHsKCQkJCWlmICggZG9jdW1lbnQuYWN0aXZlRWxlbWVudCAmJgoJCQkJCWRvY3VtZW50LmFjdGl2ZUVsZW1lbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSAhPT0gImJvZHkiICkgewoKCQkJCQkkKCBkb2N1bWVudC5hY3RpdmVFbGVtZW50ICkuYmx1cigpOwoJCQkJfSBlbHNlIHsKCQkJCQkkKCAiaW5wdXQ6Zm9jdXMsIHRleHRhcmVhOmZvY3VzLCBzZWxlY3Q6Zm9jdXMiICkuYmx1cigpOwoJCQkJfQoJCQl9IGNhdGNoKCBlICkge30KCgkJCS8vIFJlY29yZCB3aGV0aGVyIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3Rvcnkgd2hlcmUgYSBkaWFsb2cgdXNlZCB0byBiZSAtCgkJCS8vIGlmIHNvLCBkbyBub3QgYWRkIGEgbmV3IGhpc3RvcnkgZW50cnkgYW5kIGRvIG5vdCBjaGFuZ2UgdGhlIGhhc2ggZWl0aGVyCgkJCWFscmVhZHlUaGVyZSA9IGZhbHNlOwoKCQkJLy8gSWYgd2UncmUgZGlzcGxheWluZyB0aGUgcGFnZSBhcyBhIGRpYWxvZywgd2UgZG9uJ3Qgd2FudCB0aGUgdXJsCgkJCS8vIGZvciB0aGUgZGlhbG9nIGNvbnRlbnQgdG8gYmUgdXNlZCBpbiB0aGUgaGFzaC4gSW5zdGVhZCwgd2Ugd2FudAoJCQkvLyB0byBhcHBlbmQgdGhlIGRpYWxvZ0hhc2hLZXkgdG8gdGhlIHVybCBvZiB0aGUgY3VycmVudCBwYWdlLgoJCQlpZiAoIGlzRGlhbG9nICYmIGFjdGl2ZSApIHsKCQkJCS8vIG9uIHRoZSBpbml0aWFsIHBhZ2UgbG9hZCBhY3RpdmUudXJsIGlzIHVuZGVmaW5lZCBhbmQgaW4gdGhhdCBjYXNlCgkJCQkvLyBzaG91bGQgYmUgYW4gZW1wdHkgc3RyaW5nLiBNb3ZpbmcgdGhlIHVuZGVmaW5lZCAtPiBlbXB0eSBzdHJpbmcgYmFjawoJCQkJLy8gaW50byB1cmxIaXN0b3J5LmFkZE5ldyBzZWVtZWQgaW1wcnVkZW50IGdpdmVuIHVuZGVmaW5lZCBiZXR0ZXIKCQkJCS8vIHJlcHJlc2VudHMgdGhlIHVybCBzdGF0ZQoKCQkJCS8vIElmIHdlIGFyZSBhdCBhIHBsYWNlIGluIGhpc3RvcnkgdGhhdCBvbmNlIGJlbG9uZ2VkIHRvIGEgZGlhbG9nLCByZXVzZQoJCQkJLy8gdGhpcyBzdGF0ZSB3aXRob3V0IGFkZGluZyB0byB1cmxIaXN0b3J5IGFuZCB3aXRob3V0IG1vZGlmeWluZyB0aGUKCQkJCS8vIGhhc2guIEhvd2V2ZXIsIGlmIGEgZGlhbG9nIGlzIGFscmVhZHkgZGlzcGxheWVkIGF0IHRoaXMgcG9pbnQsIGFuZAoJCQkJLy8gd2UncmUgYWJvdXQgdG8gZGlzcGxheSBhbm90aGVyIGRpYWxvZywgdGhlbiB3ZSBtdXN0IGFkZCBhbm90aGVyIGhhc2gKCQkJCS8vIGFuZCBoaXN0b3J5IGVudHJ5IG9uIHRvcCBzbyB0aGF0IG9uZSBtYXkgbmF2aWdhdGUgYmFjayB0byB0aGUKCQkJCS8vIG9yaWdpbmFsIGRpYWxvZwoJCQkJaWYgKCBhY3RpdmUudXJsICYmCgkJCQkJYWN0aXZlLnVybC5pbmRleE9mKCAkLm1vYmlsZS5kaWFsb2dIYXNoS2V5ICkgPiAtMSAmJgoJCQkJCXRoaXMuYWN0aXZlUGFnZSAmJgoJCQkJCSF0aGlzLmFjdGl2ZVBhZ2UuaGFzQ2xhc3MoICJ1aS1kaWFsb2ciICkgJiYKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApIHsKCgkJCQkJc2V0dGluZ3MuY2hhbmdlSGFzaCA9IGZhbHNlOwoJCQkJCWFscmVhZHlUaGVyZSA9IHRydWU7CgkJCQl9CgoJCQkJLy8gTm9ybWFsbHksIHdlIHRhY2sgb24gYSBkaWFsb2cgaGFzaCBrZXksIGJ1dCBpZiB0aGlzIGlzIHRoZSBsb2NhdGlvbgoJCQkJLy8gb2YgYSBzdGFsZSBkaWFsb2csIHdlIHJldXNlIHRoZSBVUkwgZnJvbSB0aGUgZW50cnkKCQkJCXVybCA9ICggYWN0aXZlLnVybCB8fCAiIiApOwoKCQkJCS8vIGFjY291bnQgZm9yIGFic29sdXRlIHVybHMgaW5zdGVhZCBvZiBqdXN0IHJlbGF0aXZlIHVybHMgdXNlIGFzIGhhc2hlcwoJCQkJaWYgKCAhYWxyZWFkeVRoZXJlICYmIHVybC5pbmRleE9mKCIjIikgPiAtMSApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0gZWxzZSB7CgkJCQkJdXJsICs9ICIjIiArICQubW9iaWxlLmRpYWxvZ0hhc2hLZXk7CgkJCQl9CgoJCQkJLy8gdGFjayBvbiBhbm90aGVyIGRpYWxvZ0hhc2hLZXkgaWYgdGhpcyBpcyB0aGUgc2FtZSBhcyB0aGUgaW5pdGlhbCBoYXNoCgkJCQkvLyB0aGlzIG1ha2VzIHN1cmUgdGhhdCBhIGhpc3RvcnkgZW50cnkgaXMgY3JlYXRlZCBmb3IgdGhpcyBkaWFsb2cKCQkJCWlmICggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hY3RpdmVJbmRleCA9PT0gMCAmJiB1cmwgPT09ICQubW9iaWxlLm5hdmlnYXRlLmhpc3RvcnkuaW5pdGlhbERzdCApIHsKCQkJCQl1cmwgKz0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQkJCX0KCQkJfQoKCQkJLy8gaWYgdGl0bGUgZWxlbWVudCB3YXNuJ3QgZm91bmQsIHRyeSB0aGUgcGFnZSBkaXYgZGF0YSBhdHRyIHRvbwoJCQkvLyBJZiB0aGlzIGlzIGEgZGVlcC1saW5rIG9yIGEgcmVsb2FkICggYWN0aXZlID09PSB1bmRlZmluZWQgKSB0aGVuIGp1c3QKCQkJLy8gdXNlIHBhZ2VUaXRsZQoJCQluZXdQYWdlVGl0bGUgPSAoICFhY3RpdmUgKSA/IHBhZ2VUaXRsZSA6IHRvUGFnZS5qcW1EYXRhKCAidGl0bGUiICkgfHwKCQkJCXRvUGFnZS5jaGlsZHJlbiggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpbmQoICIudWktdGl0bGUiICkudGV4dCgpOwoJCQlpZiAoICEhbmV3UGFnZVRpdGxlICYmIHBhZ2VUaXRsZSA9PT0gZG9jdW1lbnQudGl0bGUgKSB7CgkJCQlwYWdlVGl0bGUgPSBuZXdQYWdlVGl0bGU7CgkJCX0KCQkJaWYgKCAhdG9QYWdlLmpxbURhdGEoICJ0aXRsZSIgKSApIHsKCQkJCXRvUGFnZS5qcW1EYXRhKCAidGl0bGUiLCBwYWdlVGl0bGUgKTsKCQkJfQoKCQkJLy8gTWFrZSBzdXJlIHdlIGhhdmUgYSB0cmFuc2l0aW9uIGRlZmluZWQuCgkJCXNldHRpbmdzLnRyYW5zaXRpb24gPSBzZXR0aW5ncy50cmFuc2l0aW9uIHx8CgkJCQkoICggaGlzdG9yeURpciAmJiAhYWN0aXZlSXNJbml0aWFsUGFnZSApID8gYWN0aXZlLnRyYW5zaXRpb24gOiB1bmRlZmluZWQgKSB8fAoJCQkJKCBpc0RpYWxvZyA/ICQubW9iaWxlLmRlZmF1bHREaWFsb2dUcmFuc2l0aW9uIDogJC5tb2JpbGUuZGVmYXVsdFBhZ2VUcmFuc2l0aW9uICk7CgoJCQkvL2FkZCBwYWdlIHRvIGhpc3Rvcnkgc3RhY2sgaWYgaXQncyBub3QgYmFjayBvciBmb3J3YXJkCgkJCWlmICggIWhpc3RvcnlEaXIgJiYgYWxyZWFkeVRoZXJlICkgewoJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKS5wYWdlVXJsID0gcGFnZVVybDsKCQkJfQoKCQkJLy8gU2V0IHRoZSBsb2NhdGlvbiBoYXNoLgoJCQlpZiAoIHVybCAmJiAhc2V0dGluZ3MuZnJvbUhhc2hDaGFuZ2UgKSB7CgoJCQkJLy8gcmVidWlsZGluZyB0aGUgaGFzaCBoZXJlIHNpbmNlIHdlIGxvb3NlIGl0IGVhcmxpZXIgb24KCQkJCS8vIFRPRE8gcHJlc2VydmUgdGhlIG9yaWdpbmFsbHkgcGFzc2VkIGluIHBhdGgKCQkJCWlmICggISQubW9iaWxlLnBhdGguaXNQYXRoKCB1cmwgKSAmJiB1cmwuaW5kZXhPZiggIiMiICkgPCAwICkgewoJCQkJCXVybCA9ICIjIiArIHVybDsKCQkJCX0KCgkJCQkvLyBUT0RPIHRoZSBwcm9wZXJ0eSBuYW1lcyBoZXJlIGFyZSBqdXN0IHNpbGx5CgkJCQlwYXJhbXMgPSB7CgkJCQkJdHJhbnNpdGlvbjogc2V0dGluZ3MudHJhbnNpdGlvbiwKCQkJCQl0aXRsZTogcGFnZVRpdGxlLAoJCQkJCXBhZ2VVcmw6IHBhZ2VVcmwsCgkJCQkJcm9sZTogc2V0dGluZ3Mucm9sZQoJCQkJfTsKCgkJCQlpZiAoIHNldHRpbmdzLmNoYW5nZUhhc2ggIT09IGZhbHNlICYmICQubW9iaWxlLmhhc2hMaXN0ZW5pbmdFbmFibGVkICkgewoJCQkJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHBhcmFtcywgdHJ1ZSk7CgkJCQl9IGVsc2UgaWYgKCB0b1BhZ2VbIDAgXSAhPT0gJC5tb2JpbGUuZmlyc3RQYWdlWyAwIF0gKSB7CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5hZGQoIHVybCwgcGFyYW1zICk7CgkJCQl9CgkJCX0KCgkJCS8vc2V0IHBhZ2UgdGl0bGUKCQkJZG9jdW1lbnQudGl0bGUgPSBwYWdlVGl0bGU7CgoJCQkvL3NldCAidG9QYWdlIiBhcyBhY3RpdmVQYWdlIGRlcHJlY2F0ZWQgaW4gMS40IHJlbW92ZSBpbiAxLjUKCQkJJC5tb2JpbGUuYWN0aXZlUGFnZSA9IHRvUGFnZTsKCgkJCS8vbmV3IHdheSB0byBoYW5kbGUgYWN0aXZlUGFnZQoJCQl0aGlzLmFjdGl2ZVBhZ2UgPSB0b1BhZ2U7CgoJCQkvLyBJZiB3ZSdyZSBuYXZpZ2F0aW5nIGJhY2sgaW4gdGhlIFVSTCBoaXN0b3J5LCBzZXQgcmV2ZXJzZSBhY2NvcmRpbmdseS4KCQkJc2V0dGluZ3MucmV2ZXJzZSA9IHNldHRpbmdzLnJldmVyc2UgfHwgaGlzdG9yeURpciA8IDA7CgoJCQljc3NUcmFuc2l0aW9uRGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJCQl0aGlzLl9jc3NUcmFuc2l0aW9uKHRvUGFnZSwgZnJvbVBhZ2UsIHsKCQkJCXRyYW5zaXRpb246IHNldHRpbmdzLnRyYW5zaXRpb24sCgkJCQlyZXZlcnNlOiBzZXR0aW5ncy5yZXZlcnNlLAoJCQkJZGVmZXJyZWQ6IGNzc1RyYW5zaXRpb25EZWZlcnJlZAoJCQl9KTsKCgkJCWNzc1RyYW5zaXRpb25EZWZlcnJlZC5kb25lKCQucHJveHkoZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20sIGFscmVhZHlGb2N1c2VkICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCk7CgoJCQkJLy9pZiB0aGVyZSdzIGEgZHVwbGljYXRlQ2FjaGVkUGFnZSwgcmVtb3ZlIGl0IGZyb20gdGhlIERPTSBub3cgdGhhdCBpdCdzIGhpZGRlbgoJCQkJaWYgKCBzZXR0aW5ncy5kdXBsaWNhdGVDYWNoZWRQYWdlICkgewoJCQkJCXNldHRpbmdzLmR1cGxpY2F0ZUNhY2hlZFBhZ2UucmVtb3ZlKCk7CgkJCQl9CgoJCQkJLy8gZGVzcGl0ZSB2aXNpYmlsaXR5OiBoaWRkZW4gYWRkcmVzc2VzIGlzc3VlICMyOTY1CgkJCQkvLyBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzI5NjUKCQkJCWlmICggIWFscmVhZHlGb2N1c2VkICkgewoJCQkJCSQubW9iaWxlLmZvY3VzUGFnZSggdG9QYWdlICk7CgkJCQl9CgoJCQkJdGhpcy5fcmVsZWFzZVRyYW5zaXRpb25Mb2NrKCk7CgkJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInBhZ2VjaGFuZ2UiLCB0cmlnZ2VyRGF0YSApOwoJCQkJdGhpcy5fdHJpZ2dlcldpdGhEZXByZWNhdGVkKCAidHJhbnNpdGlvbiIsIHRyaWdnZXJEYXRhICk7CgkJCX0sIHRoaXMpKTsKCQl9LAoKCQkvLyBkZXRlcm1pbmUgdGhlIGN1cnJlbnQgYmFzZSB1cmwKCQlfZmluZEJhc2VXaXRoRGVmYXVsdDogZnVuY3Rpb24oKSB7CgkJCXZhciBjbG9zZXN0QmFzZSA9ICggdGhpcy5hY3RpdmVQYWdlICYmCgkJCSQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCB0aGlzLmFjdGl2ZVBhZ2UgKSApOwoJCXJldHVybiBjbG9zZXN0QmFzZSB8fCAkLm1vYmlsZS5wYXRoLmRvY3VtZW50QmFzZS5ocmVmTm9IYXNoOwoJCX0KCX0pOwoKCS8vIFRoZSBmb2xsb3dpbmcgaGFuZGxlcnMgc2hvdWxkIGJlIGJvdW5kIGFmdGVyIG1vYmlsZWluaXQgaGFzIGJlZW4gdHJpZ2dlcmVkCgkvLyB0aGUgZm9sbG93aW5nIGRlZmVycmVkIGlzIHJlc29sdmVkIGluIHRoZSBpbml0IGZpbGUKCSQubW9iaWxlLm5hdnJlYWR5RGVmZXJyZWQgPSAkLkRlZmVycmVkKCk7CgoJLy90aGVzZSB2YXJpYWJsZXMgbWFrZSBhbGwgcGFnZSBjb250YWluZXJzIHVzZSB0aGUgc2FtZSBxdWV1ZSBhbmQgb25seSBuYXZpZ2F0ZSBvbmUgYXQgYSB0aW1lCgkvLyBxdWV1ZSB0byBob2xkIHNpbXVsdGFuaW91cyBwYWdlIHRyYW5zaXRpb25zCgl2YXIgcGFnZVRyYW5zaXRpb25RdWV1ZSA9IFtdLAoKCQkvLyBpbmRpY2F0ZXMgd2hldGhlciBvciBub3QgcGFnZSBpcyBpbiBwcm9jZXNzIG9mIHRyYW5zaXRpb25pbmcKCQlpc1BhZ2VUcmFuc2l0aW9uaW5nID0gZmFsc2U7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkJLy8gcmVzb2x2ZWQgb24gZG9tcmVhZHkKCXZhciBkb21yZWFkeURlZmVycmVkID0gJC5EZWZlcnJlZCgpLAoJCWRvY3VtZW50VXJsID0gJC5tb2JpbGUucGF0aC5kb2N1bWVudFVybCwKCgkJLy8gdXNlZCB0byB0cmFjayBsYXN0IHZjbGlja2VkIGVsZW1lbnQgdG8gbWFrZSBzdXJlIGl0cyB2YWx1ZSBpcyBhZGRlZCB0byBmb3JtIGRhdGEKCQkkbGFzdFZDbGlja2VkID0gbnVsbDsKCgkvKiBFdmVudCBCaW5kaW5ncyAtIGhhc2hjaGFuZ2UsIHN1Ym1pdCwgYW5kIGNsaWNrICovCglmdW5jdGlvbiBmaW5kQ2xvc2VzdExpbmsoIGVsZSApCXsKCQl3aGlsZSAoIGVsZSApIHsKCQkJLy8gTG9vayBmb3IgdGhlIGNsb3Nlc3QgZWxlbWVudCB3aXRoIGEgbm9kZU5hbWUgb2YgImEiLgoJCQkvLyBOb3RlIHRoYXQgd2UgYXJlIGNoZWNraW5nIGlmIHdlIGhhdmUgYSB2YWxpZCBub2RlTmFtZQoJCQkvLyBiZWZvcmUgYXR0ZW1wdGluZyB0byBhY2Nlc3MgaXQuIFRoaXMgaXMgYmVjYXVzZSB0aGUKCQkJLy8gbm9kZSB3ZSBnZXQgY2FsbGVkIHdpdGggY291bGQgaGF2ZSBvcmlnaW5hdGVkIGZyb20gd2l0aGluCgkJCS8vIGFuIGVtYmVkZGVkIFNWRyBkb2N1bWVudCB3aGVyZSBzb21lIHN5bWJvbCBpbnN0YW5jZSBlbGVtZW50cwoJCQkvLyBkb24ndCBoYXZlIG5vZGVOYW1lIGRlZmluZWQgb24gdGhlbSwgb3Igc3RyaW5ncyBhcmUgb2YgdHlwZQoJCQkvLyBTVkdBbmltYXRlZFN0cmluZy4KCQkJaWYgKCAoIHR5cGVvZiBlbGUubm9kZU5hbWUgPT09ICJzdHJpbmciICkgJiYgZWxlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09ICJhIiApIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWVsZSA9IGVsZS5wYXJlbnROb2RlOwoJCX0KCQlyZXR1cm4gZWxlOwoJfQoKCSQubW9iaWxlLmxvYWRQYWdlID0gZnVuY3Rpb24oIHVybCwgb3B0cyApIHsKCQl2YXIgY29udGFpbmVyOwoKCQlvcHRzID0gb3B0cyB8fCB7fTsKCQljb250YWluZXIgPSAoIG9wdHMucGFnZUNvbnRhaW5lciB8fCAkLm1vYmlsZS5wYWdlQ29udGFpbmVyICk7CgoJCS8vIGNyZWF0ZSB0aGUgZGVmZXJyZWQgdGhhdCB3aWxsIGJlIHN1cHBsaWVkIHRvIGxvYWRQYWdlIGNhbGxlcnMKCQkvLyBhbmQgcmVzb2x2ZWQgYnkgdGhlIGNvbnRlbnQgd2lkZ2V0J3MgbG9hZCBtZXRob2QKCQlvcHRzLmRlZmVycmVkID0gJC5EZWZlcnJlZCgpOwoKCQkvLyBQcmVmZXJyaW5nIHRvIGFsbG93IGV4Y2VwdGlvbnMgZm9yIHVuaW5pdGlhbGl6ZWQgb3B0cy5wYWdlQ29udGFpbmVyCgkJLy8gd2lkZ2V0cyBzbyB3ZSBrbm93IGlmIHdlIG5lZWQgdG8gZm9yY2UgaW5pdCBoZXJlIGZvciB1c2VycwoJCWNvbnRhaW5lci5wYWdlY29udGFpbmVyKCAibG9hZCIsIHVybCwgb3B0cyApOwoKCQkvLyBwcm92aWRlIHRoZSBkZWZlcnJlZAoJCXJldHVybiBvcHRzLmRlZmVycmVkLnByb21pc2UoKTsKCX07CgoJLy9kZWZpbmUgdmFycyBmb3IgaW50ZXJhbCB1c2UKCgkvKiBpbnRlcm5hbCB1dGlsaXR5IGZ1bmN0aW9ucyAqLwoKCS8vIE5PVEUgSXNzdWUgIzQ5NTAgQW5kcm9pZCBwaG9uZWdhcCBkb2Vzbid0IG5hdmlnYXRlIGJhY2sgcHJvcGVybHkKCS8vICAgICAgd2hlbiBhIGZ1bGwgcGFnZSByZWZyZXNoIGhhcyB0YWtlbiBwbGFjZS4gSXQgYXBwZWFycyB0aGF0IGhhc2hjaGFuZ2UKCS8vICAgICAgYW5kIHJlcGxhY2VzdGF0ZSBoaXN0b3J5IGFsdGVyYXRpb25zIHdvcmsgZmluZSBidXQgd2UgbmVlZCB0byBzdXBwb3J0CgkvLyAgICAgIGJvdGggZm9ybXMgb2YgaGlzdG9yeSB0cmF2ZXJzYWwgaW4gb3VyIGNvZGUgdGhhdCB1c2VzIGJhY2t3YXJkIGhpc3RvcnkKCS8vICAgICAgbW92ZW1lbnQKCSQubW9iaWxlLmJhY2sgPSBmdW5jdGlvbigpIHsKCQl2YXIgbmF2ID0gd2luZG93Lm5hdmlnYXRvcjsKCgkJLy8gaWYgdGhlIHNldHRpbmcgaXMgb24gYW5kIHRoZSBuYXZpZ2F0b3Igb2JqZWN0IGlzCgkJLy8gYXZhaWxhYmxlIHVzZSB0aGUgcGhvbmVnYXAgbmF2aWdhdGlvbiBjYXBhYmlsaXR5CgkJaWYgKCB0aGlzLnBob25lZ2FwTmF2aWdhdGlvbkVuYWJsZWQgJiYKCQkJbmF2ICYmCgkJCW5hdi5hcHAgJiYKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSApIHsKCQkJbmF2LmFwcC5iYWNrSGlzdG9yeSgpOwoJCX0gZWxzZSB7CgkJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImJhY2siICk7CgkJfQoJfTsKCgkvL2RpcmVjdCBmb2N1cyB0byB0aGUgcGFnZSB0aXRsZSwgb3Igb3RoZXJ3aXNlIGZpcnN0IGZvY3VzYWJsZSBlbGVtZW50CgkkLm1vYmlsZS5mb2N1c1BhZ2UgPSBmdW5jdGlvbiAoIHBhZ2UgKSB7CgkJdmFyIGF1dG9mb2N1cyA9IHBhZ2UuZmluZCggIlthdXRvZm9jdXNdIiApLAoJCQlwYWdlVGl0bGUgPSBwYWdlLmZpbmQoICIudWktdGl0bGU6ZXEoMCkiICk7CgoJCWlmICggYXV0b2ZvY3VzLmxlbmd0aCApIHsKCQkJYXV0b2ZvY3VzLmZvY3VzKCk7CgkJCXJldHVybjsKCQl9CgoJCWlmICggcGFnZVRpdGxlLmxlbmd0aCApIHsKCQkJcGFnZVRpdGxlLmZvY3VzKCk7CgkJfSBlbHNlewoJCQlwYWdlLmZvY3VzKCk7CgkJfQoJfTsKCgkvLyBOby1vcCBpbXBsZW1lbnRhdGlvbiBvZiB0cmFuc2l0aW9uIGRlZ3JhZGF0aW9uCgkkLm1vYmlsZS5fbWF5YmVEZWdyYWRlVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uIHx8IGZ1bmN0aW9uKCB0cmFuc2l0aW9uICkgewoJCXJldHVybiB0cmFuc2l0aW9uOwoJfTsKCgkvKiBleHBvc2VkICQubW9iaWxlIG1ldGhvZHMgKi8KCgkvL2FuaW1hdGlvbiBjb21wbGV0ZSBjYWxsYmFjawoJJC5mbi5hbmltYXRpb25Db21wbGV0ZSA9IGZ1bmN0aW9uKCBjYWxsYmFjayApIHsKCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2l0aW9ucyApIHsKCQkJcmV0dXJuICQoIHRoaXMgKS5vbmUoICJ3ZWJraXRBbmltYXRpb25FbmQgYW5pbWF0aW9uZW5kIiwgY2FsbGJhY2sgKTsKCQl9CgkJZWxzZXsKCQkJLy8gZGVmZXIgZXhlY3V0aW9uIGZvciBjb25zaXN0ZW5jeSBiZXR3ZWVuIHdlYmtpdC9ub24gd2Via2l0CgkJCXNldFRpbWVvdXQoIGNhbGxiYWNrLCAwICk7CgkJCXJldHVybiAkKCB0aGlzICk7CgkJfQoJfTsKCgkkLm1vYmlsZS5jaGFuZ2VQYWdlID0gZnVuY3Rpb24oIHRvLCBvcHRpb25zICkgewoJCSQubW9iaWxlLnBhZ2VDb250YWluZXIucGFnZWNvbnRhaW5lciggImNoYW5nZSIsIHRvLCBvcHRpb25zICk7Cgl9OwoKCSQubW9iaWxlLmNoYW5nZVBhZ2UuZGVmYXVsdHMgPSB7CgkJdHJhbnNpdGlvbjogdW5kZWZpbmVkLAoJCXJldmVyc2U6IGZhbHNlLAoJCWNoYW5nZUhhc2g6IHRydWUsCgkJZnJvbUhhc2hDaGFuZ2U6IGZhbHNlLAoJCXJvbGU6IHVuZGVmaW5lZCwgLy8gQnkgZGVmYXVsdCB3ZSByZWx5IG9uIHRoZSByb2xlIGRlZmluZWQgYnkgdGhlIEBkYXRhLXJvbGUgYXR0cmlidXRlLgoJCWR1cGxpY2F0ZUNhY2hlZFBhZ2U6IHVuZGVmaW5lZCwKCQlwYWdlQ29udGFpbmVyOiB1bmRlZmluZWQsCgkJc2hvd0xvYWRNc2c6IHRydWUsIC8vbG9hZGluZyBtZXNzYWdlIHNob3dzIGJ5IGRlZmF1bHQgd2hlbiBwYWdlcyBhcmUgYmVpbmcgZmV0Y2hlZCBkdXJpbmcgY2hhbmdlUGFnZQoJCWRhdGFVcmw6IHVuZGVmaW5lZCwKCQlmcm9tUGFnZTogdW5kZWZpbmVkLAoJCWFsbG93U2FtZVBhZ2VUcmFuc2l0aW9uOiBmYWxzZQoJfTsKCgkkLm1vYmlsZS5fcmVnaXN0ZXJJbnRlcm5hbEV2ZW50cyA9IGZ1bmN0aW9uKCkgewoJCXZhciBnZXRBamF4Rm9ybURhdGEgPSBmdW5jdGlvbiggJGZvcm0sIGNhbGN1bGF0ZU9ubHkgKSB7CgkJCXZhciB1cmwsIHJldCA9IHRydWUsIGZvcm1EYXRhLCB2Y2xpY2tlZE5hbWUsIG1ldGhvZDsKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgfHwKCQkJCQkvLyB0ZXN0IHRoYXQgdGhlIGZvcm0gaXMsIGl0c2VsZiwgYWpheCBmYWxzZQoJCQkJCSRmb3JtLmlzKCAiOmpxbURhdGEoYWpheD0nZmFsc2UnKSIgKSB8fAoJCQkJCS8vIHRlc3QgdGhhdCAkLm1vYmlsZS5pZ25vcmVDb250ZW50RW5hYmxlZCBpcyBzZXQgYW5kCgkJCQkJLy8gdGhlIGZvcm0gb3Igb25lIG9mIGl0J3MgcGFyZW50cyBpcyBhamF4PWZhbHNlCgkJCQkJISRmb3JtLmpxbUhpamFja2FibGUoKS5sZW5ndGggfHwKCQkJCQkkZm9ybS5hdHRyKCAidGFyZ2V0IiApICkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl1cmwgPSAoICRsYXN0VkNsaWNrZWQgJiYgJGxhc3RWQ2xpY2tlZC5hdHRyKCAiZm9ybWFjdGlvbiIgKSApIHx8CgkJCQkkZm9ybS5hdHRyKCAiYWN0aW9uIiApOwoJCQltZXRob2QgPSAoICRmb3JtLmF0dHIoICJtZXRob2QiICkgfHwgImdldCIgKS50b0xvd2VyQ2FzZSgpOwoKCQkJLy8gSWYgbm8gYWN0aW9uIGlzIHNwZWNpZmllZCwgYnJvd3NlcnMgZGVmYXVsdCB0byB1c2luZyB0aGUKCQkJLy8gVVJMIG9mIHRoZSBkb2N1bWVudCBjb250YWluaW5nIHRoZSBmb3JtLiBTaW5jZSB3ZSBkeW5hbWljYWxseQoJCQkvLyBwdWxsIGluIHBhZ2VzIGZyb20gZXh0ZXJuYWwgZG9jdW1lbnRzLCB0aGUgZm9ybSBzaG91bGQgc3VibWl0CgkJCS8vIHRvIHRoZSBVUkwgZm9yIHRoZSBzb3VyY2UgZG9jdW1lbnQgb2YgdGhlIHBhZ2UgY29udGFpbmluZwoJCQkvLyB0aGUgZm9ybS4KCQkJaWYgKCAhdXJsICkgewoJCQkJLy8gR2V0IHRoZSBAZGF0YS11cmwgZm9yIHRoZSBwYWdlIGNvbnRhaW5pbmcgdGhlIGZvcm0uCgkJCQl1cmwgPSAkLm1vYmlsZS5nZXRDbG9zZXN0QmFzZVVybCggJGZvcm0gKTsKCgkJCQkvLyBOT1RFOiBJZiB0aGUgbWV0aG9kIGlzICJnZXQiLCB3ZSBuZWVkIHRvIHN0cmlwIG9mZiB0aGUgcXVlcnkgc3RyaW5nCgkJCQkvLyBiZWNhdXNlIGl0IHdpbGwgZ2V0IHJlcGxhY2VkIHdpdGggdGhlIG5ldyBmb3JtIGRhdGEuIFNlZSBpc3N1ZSAjNTcxMC4KCQkJCWlmICggbWV0aG9kID09PSAiZ2V0IiApIHsKCQkJCQl1cmwgPSAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB1cmwgKS5ocmVmTm9TZWFyY2g7CgkJCQl9CgoJCQkJaWYgKCB1cmwgPT09ICQubW9iaWxlLnBhdGguZG9jdW1lbnRCYXNlLmhyZWZOb0hhc2ggKSB7CgkJCQkJLy8gVGhlIHVybCB3ZSBnb3QgYmFjayBtYXRjaGVzIHRoZSBkb2N1bWVudCBiYXNlLAoJCQkJCS8vIHdoaWNoIG1lYW5zIHRoZSBwYWdlIG11c3QgYmUgYW4gaW50ZXJuYWwvZW1iZWRkZWQgcGFnZSwKCQkJCQkvLyBzbyBkZWZhdWx0IHRvIHVzaW5nIHRoZSBhY3R1YWwgZG9jdW1lbnQgdXJsIGFzIGEgYnJvd3NlcgoJCQkJCS8vIHdvdWxkLgoJCQkJCXVybCA9IGRvY3VtZW50VXJsLmhyZWZOb1NlYXJjaDsKCQkJCX0KCQkJfQoKCQkJdXJsID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICB1cmwsICQubW9iaWxlLmdldENsb3Nlc3RCYXNlVXJsKCAkZm9ybSApICk7CgoJCQlpZiAoICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCB1cmwgKSAmJiAhJC5tb2JpbGUucGF0aC5pc1Blcm1pdHRlZENyb3NzRG9tYWluUmVxdWVzdCggZG9jdW1lbnRVcmwsIHVybCApICkgKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCgkJCWlmICggIWNhbGN1bGF0ZU9ubHkgKSB7CgkJCQlmb3JtRGF0YSA9ICRmb3JtLnNlcmlhbGl6ZUFycmF5KCk7CgoJCQkJaWYgKCAkbGFzdFZDbGlja2VkICYmICRsYXN0VkNsaWNrZWRbIDAgXS5mb3JtID09PSAkZm9ybVsgMCBdICkgewoJCQkJCXZjbGlja2VkTmFtZSA9ICRsYXN0VkNsaWNrZWQuYXR0ciggIm5hbWUiICk7CgkJCQkJaWYgKCB2Y2xpY2tlZE5hbWUgKSB7CgkJCQkJCS8vIE1ha2Ugc3VyZSB0aGUgbGFzdCBjbGlja2VkIGVsZW1lbnQgaXMgaW5jbHVkZWQgaW4gdGhlIGZvcm0KCQkJCQkJJC5lYWNoKCBmb3JtRGF0YSwgZnVuY3Rpb24oIGtleSwgdmFsdWUgKSB7CgkJCQkJCQlpZiAoIHZhbHVlLm5hbWUgPT09IHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCQkvLyBVbnNldCB2Y2xpY2tlZE5hbWUgLSB3ZSd2ZSBmb3VuZCBpdCBpbiB0aGUgc2VyaWFsaXplZCBkYXRhIGFscmVhZHkKCQkJCQkJCQl2Y2xpY2tlZE5hbWUgPSAiIjsKCQkJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJCQl9CgkJCQkJCX0pOwoJCQkJCQlpZiAoIHZjbGlja2VkTmFtZSApIHsKCQkJCQkJCWZvcm1EYXRhLnB1c2goIHsgbmFtZTogdmNsaWNrZWROYW1lLCB2YWx1ZTogJGxhc3RWQ2xpY2tlZC5hdHRyKCAidmFsdWUiICkgfSApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoKCQkJCXJldCA9IHsKCQkJCQl1cmw6IHVybCwKCQkJCQlvcHRpb25zOiB7CgkJCQkJCXR5cGU6CQltZXRob2QsCgkJCQkJCWRhdGE6CQkkLnBhcmFtKCBmb3JtRGF0YSApLAoJCQkJCQl0cmFuc2l0aW9uOgkkZm9ybS5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSwKCQkJCQkJcmV2ZXJzZToJJGZvcm0uanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiLAoJCQkJCQlyZWxvYWRQYWdlOgl0cnVlCgkJCQkJfQoJCQkJfTsKCQkJfQoKCQkJcmV0dXJuIHJldDsKCQl9OwoKCQkvL2JpbmQgdG8gZm9ybSBzdWJtaXQgZXZlbnRzLCBoYW5kbGUgd2l0aCBBamF4CgkJJC5tb2JpbGUuZG9jdW1lbnQuZGVsZWdhdGUoICJmb3JtIiwgInN1Ym1pdCIsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZvcm1EYXRhOwoKCQkJaWYgKCAhZXZlbnQuaXNEZWZhdWx0UHJldmVudGVkKCkgKSB7CgkJCQlmb3JtRGF0YSA9IGdldEFqYXhGb3JtRGF0YSggJCggdGhpcyApICk7CgkJCQlpZiAoIGZvcm1EYXRhICkgewoJCQkJCSQubW9iaWxlLmNoYW5nZVBhZ2UoIGZvcm1EYXRhLnVybCwgZm9ybURhdGEub3B0aW9ucyApOwoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0KCQl9KTsKCgkJLy9hZGQgYWN0aXZlIHN0YXRlIG9uIHZjbGljawoJCSQubW9iaWxlLmRvY3VtZW50LmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciAkYnRuLCBidG5FbHMsIHRhcmdldCA9IGV2ZW50LnRhcmdldCwgbmVlZENsb3Nlc3QgPSBmYWxzZTsKCQkJLy8gaWYgdGhpcyBpc24ndCBhIGxlZnQgY2xpY2sgd2UgZG9uJ3QgY2FyZS4gSXRzIGltcG9ydGFudCB0byBub3RlCgkJCS8vIHRoYXQgd2hlbiB0aGUgdmlydHVhbCBldmVudCBpcyBnZW5lcmF0ZWQgaXQgd2lsbCBjcmVhdGUgdGhlIHdoaWNoIGF0dHIKCQkJaWYgKCBldmVudC53aGljaCA+IDEgfHwgISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gUmVjb3JkIHRoYXQgdGhpcyBlbGVtZW50IHdhcyBjbGlja2VkLCBpbiBjYXNlIHdlIG5lZWQgaXQgZm9yIGNvcnJlY3QKCQkJLy8gZm9ybSBzdWJtaXNzaW9uIGR1cmluZyB0aGUgInN1Ym1pdCIgaGFuZGxlciBhYm92ZQoJCQkkbGFzdFZDbGlja2VkID0gJCggdGFyZ2V0ICk7CgoJCQkvLyBUcnkgdG8gZmluZCBhIHRhcmdldCBlbGVtZW50IHRvIHdoaWNoIHRoZSBhY3RpdmUgY2xhc3Mgd2lsbCBiZSBhcHBsaWVkCgkJCWlmICggJC5kYXRhKCB0YXJnZXQsICJtb2JpbGUtYnV0dG9uIiApICkgewoJCQkJLy8gSWYgdGhlIGZvcm0gd2lsbCBub3QgYmUgc3VibWl0dGVkIHZpYSBBSkFYLCBkbyBub3QgYWRkIGFjdGl2ZSBjbGFzcwoJCQkJaWYgKCAhZ2V0QWpheEZvcm1EYXRhKCAkKCB0YXJnZXQgKS5jbG9zZXN0KCAiZm9ybSIgKSwgdHJ1ZSApICkgewoJCQkJCXJldHVybjsKCQkJCX0KCQkJCS8vIFdlIHdpbGwgYXBwbHkgdGhlIGFjdGl2ZSBzdGF0ZSB0byB0aGlzIGJ1dHRvbiB3aWRnZXQgLSB0aGUgcGFyZW50CgkJCQkvLyBvZiB0aGUgaW5wdXQgdGhhdCB3YXMgY2xpY2tlZCB3aWxsIGhhdmUgdGhlIGFzc29jaWF0ZWQgZGF0YQoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQl0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCXRhcmdldCA9IGZpbmRDbG9zZXN0TGluayggdGFyZ2V0ICk7CgkJCQlpZiAoICEoIHRhcmdldCAmJiAkLm1vYmlsZS5wYXRoLnBhcnNlVXJsKCB0YXJnZXQuZ2V0QXR0cmlidXRlKCAiaHJlZiIgKSB8fCAiIyIgKS5oYXNoICE9PSAiIyIgKSApIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUKCQkJCS8vIGxpbmsgd3JhcHBpbmcgY2FuIGJlIGF2b2lkZWQKCQkJCWlmICggISQoIHRhcmdldCApLmpxbUhpamFja2FibGUoKS5sZW5ndGggKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQl9CgoJCQkvLyBBdm9pZCBjYWxsaW5nIC5jbG9zZXN0IGJ5IHVzaW5nIHRoZSBkYXRhIHNldCBkdXJpbmcgLmJ1dHRvbk1hcmt1cCgpCgkJCS8vIExpc3QgaXRlbXMgaGF2ZSB0aGUgYnV0dG9uIGRhdGEgaW4gdGhlIHBhcmVudCBvZiB0aGUgZWxlbWVudCBjbGlja2VkCgkJCWlmICggISF+dGFyZ2V0LmNsYXNzTmFtZS5pbmRleE9mKCAidWktbGluay1pbmhlcml0IiApICkgewoJCQkJaWYgKCB0YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCQlidG5FbHMgPSAkLmRhdGEoIHRhcmdldC5wYXJlbnROb2RlLCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCQl9CgkJCS8vIE90aGVyd2lzZSwgbG9vayBmb3IgdGhlIGRhdGEgb24gdGhlIHRhcmdldCBpdHNlbGYKCQkJfSBlbHNlIHsKCQkJCWJ0bkVscyA9ICQuZGF0YSggdGFyZ2V0LCAiYnV0dG9uRWxlbWVudHMiICk7CgkJCX0KCQkJLy8gSWYgZm91bmQsIGdyYWIgdGhlIGJ1dHRvbidzIG91dGVyIGVsZW1lbnQKCQkJaWYgKCBidG5FbHMgKSB7CgkJCQl0YXJnZXQgPSBidG5FbHMub3V0ZXI7CgkJCX0gZWxzZSB7CgkJCQluZWVkQ2xvc2VzdCA9IHRydWU7CgkJCX0KCgkJCSRidG4gPSAkKCB0YXJnZXQgKTsKCQkJLy8gSWYgdGhlIG91dGVyIGVsZW1lbnQgd2Fzbid0IGZvdW5kIGJ5IHRoZSBvdXIgaGV1cmlzdGljcywgdXNlIC5jbG9zZXN0KCkKCQkJaWYgKCBuZWVkQ2xvc2VzdCApIHsKCQkJCSRidG4gPSAkYnRuLmNsb3Nlc3QoICIudWktYnRuIiApOwoJCQl9CgoJCQlpZiAoICRidG4ubGVuZ3RoID4gMCAmJgoJCQkJISggJGJ0bi5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiB8fAoKCQkJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJCQkvLyBvbmx5IHVpLXN0YXRlLWRpc2FibGVkIHNob3VsZCBiZSBwcmVzZW50IHRoZXJlYWZ0ZXIKCQkJCQkkYnRuLmhhc0NsYXNzKCAidWktZGlzYWJsZWQiICkgKSApICkgewoJCQkJJC5tb2JpbGUucmVtb3ZlQWN0aXZlTGlua0NsYXNzKCB0cnVlICk7CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluayA9ICRidG47CgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGluay5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfQoJCX0pOwoKCQkvLyBjbGljayByb3V0aW5nIC0gZGlyZWN0IHRvIEhUVFAgb3IgQWpheCwgYWNjb3JkaW5nbHkKCQkkLm1vYmlsZS5kb2N1bWVudC5iaW5kKCAiY2xpY2siLCBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggISQubW9iaWxlLmxpbmtCaW5kaW5nRW5hYmxlZCB8fCBldmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJdmFyIGxpbmsgPSBmaW5kQ2xvc2VzdExpbmsoIGV2ZW50LnRhcmdldCApLAoJCQkJJGxpbmsgPSAkKCBsaW5rICksCgoJCQkJLy9yZW1vdmUgYWN0aXZlIGxpbmsgY2xhc3MgaWYgZXh0ZXJuYWwgKHRoZW4gaXQgd29uJ3QgYmUgdGhlcmUgaWYgeW91IGNvbWUgYmFjaykKCQkJCWh0dHBDbGVhbnVwID0gZnVuY3Rpb24oKSB7CgkJCQkJd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ICQubW9iaWxlLnJlbW92ZUFjdGl2ZUxpbmtDbGFzcyggdHJ1ZSApOyB9LCAyMDAgKTsKCQkJCX0sCgkJCQliYXNlVXJsLCBocmVmLAoJCQkJdXNlRGVmYXVsdFVybEhhbmRsaW5nLCBpc0V4dGVybmFsLAoJCQkJdHJhbnNpdGlvbiwgcmV2ZXJzZSwgcm9sZTsKCgkJCS8vIElmIGEgYnV0dG9uIHdhcyBjbGlja2VkLCBjbGVhbiB1cCB0aGUgYWN0aXZlIGNsYXNzIGFkZGVkIGJ5IHZjbGljayBhYm92ZQoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZUNsaWNrZWRMaW5rICYmCgkJCQkkLm1vYmlsZS5hY3RpdmVDbGlja2VkTGlua1sgMCBdID09PSBldmVudC50YXJnZXQucGFyZW50Tm9kZSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCX0KCgkJCS8vIElmIHRoZXJlIGlzIG5vIGxpbmsgYXNzb2NpYXRlZCB3aXRoIHRoZSBjbGljayBvciBpdHMgbm90IGEgbGVmdAoJCQkvLyBjbGljayB3ZSB3YW50IHRvIGlnbm9yZSB0aGUgY2xpY2sKCQkJLy8gVE9ETyB0ZWFjaCAkLm1vYmlsZS5oaWphY2thYmxlIHRvIG9wZXJhdGUgb24gcmF3IGRvbSBlbGVtZW50cyBzbyB0aGUgbGluayB3cmFwcGluZwoJCQkvLyBjYW4gYmUgYXZvaWRlZAoJCQlpZiAoICFsaW5rIHx8IGV2ZW50LndoaWNoID4gMSB8fCAhJGxpbmsuanFtSGlqYWNrYWJsZSgpLmxlbmd0aCApIHsKCQkJCXJldHVybjsKCQkJfQoKCQkJLy9pZiB0aGVyZSdzIGEgZGF0YS1yZWw9YmFjayBhdHRyLCBnbyBiYWNrIGluIGhpc3RvcnkKCQkJaWYgKCAkbGluay5pcyggIjpqcW1EYXRhKHJlbD0nYmFjaycpIiApICkgewoJCQkJJC5tb2JpbGUuYmFjaygpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQliYXNlVXJsID0gJC5tb2JpbGUuZ2V0Q2xvc2VzdEJhc2VVcmwoICRsaW5rICk7CgoJCQkvL2dldCBocmVmLCBpZiBkZWZpbmVkLCBvdGhlcndpc2UgZGVmYXVsdCB0byBlbXB0eSBoYXNoCgkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggJGxpbmsuYXR0ciggImhyZWYiICkgfHwgIiMiLCBiYXNlVXJsICk7CgoJCQkvL2lmIGFqYXggaXMgZGlzYWJsZWQsIGV4aXQgZWFybHkKCQkJaWYgKCAhJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgISQubW9iaWxlLnBhdGguaXNFbWJlZGRlZFBhZ2UoIGhyZWYgKSApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vIFhYWF9qYmxhczogSWRlYWxseSBsaW5rcyB0byBhcHBsaWNhdGlvbiBwYWdlcyBzaG91bGQgYmUgc3BlY2lmaWVkIGFzCgkJCS8vICAgICAgICAgICAgYW4gdXJsIHRvIHRoZSBhcHBsaWNhdGlvbiBkb2N1bWVudCB3aXRoIGEgaGFzaCB0aGF0IGlzIGVpdGhlcgoJCQkvLyAgICAgICAgICAgIHRoZSBzaXRlIHJlbGF0aXZlIHBhdGggb3IgaWQgdG8gdGhlIHBhZ2UuIEJ1dCBzb21lIG9mIHRoZQoJCQkvLyAgICAgICAgICAgIGludGVybmFsIGNvZGUgdGhhdCBkeW5hbWljYWxseSBnZW5lcmF0ZXMgc3ViLXBhZ2VzIGZvciBuZXN0ZWQKCQkJLy8gICAgICAgICAgICBsaXN0cyBhbmQgc2VsZWN0IGRpYWxvZ3MsIGp1c3Qgd3JpdGUgYSBoYXNoIGluIHRoZSBsaW5rIHRoZXkKCQkJLy8gICAgICAgICAgICBjcmVhdGUuIFRoaXMgbWVhbnMgdGhlIGFjdHVhbCBVUkwgcGF0aCBpcyBiYXNlZCBvbiB3aGF0ZXZlcgoJCQkvLyAgICAgICAgICAgIHRoZSBjdXJyZW50IHZhbHVlIG9mIHRoZSBiYXNlIHRhZyBpcyBhdCB0aGUgdGltZSB0aGlzIGNvZGUKCQkJLy8gICAgICAgICAgICBpcyBjYWxsZWQuIEZvciBub3cgd2UgYXJlIGp1c3QgYXNzdW1pbmcgdGhhdCBhbnkgdXJsIHdpdGggYQoJCQkvLyAgICAgICAgICAgIGhhc2ggaW4gaXQgaXMgYW4gYXBwbGljYXRpb24gcGFnZSByZWZlcmVuY2UuCgkJCWlmICggaHJlZi5zZWFyY2goICIjIiApICE9PSAtMSApIHsKCQkJCWhyZWYgPSBocmVmLnJlcGxhY2UoIC9bXiNdKiMvLCAiIiApOwoJCQkJaWYgKCAhaHJlZiApIHsKCQkJCQkvL2xpbmsgd2FzIGFuIGVtcHR5IGhhc2ggbWVhbnQgcHVyZWx5CgkJCQkJLy9mb3IgaW50ZXJhY3Rpb24sIHNvIHdlIGlnbm9yZSBpdC4KCQkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCXJldHVybjsKCQkJCX0gZWxzZSBpZiAoICQubW9iaWxlLnBhdGguaXNQYXRoKCBocmVmICkgKSB7CgkJCQkJLy93ZSBoYXZlIGFwYXRoIHNvIG1ha2UgaXQgdGhlIGhyZWYgd2Ugd2FudCB0byBsb2FkLgoJCQkJCWhyZWYgPSAkLm1vYmlsZS5wYXRoLm1ha2VVcmxBYnNvbHV0ZSggaHJlZiwgYmFzZVVybCApOwoJCQkJfSBlbHNlIHsKCQkJCQkvL3dlIGhhdmUgYSBzaW1wbGUgaWQgc28gdXNlIHRoZSBkb2N1bWVudFVybCBhcyBpdHMgYmFzZS4KCQkJCQlocmVmID0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoICIjIiArIGhyZWYsIGRvY3VtZW50VXJsLmhyZWZOb0hhc2ggKTsKCQkJCX0KCQkJfQoKCQkJLy8gU2hvdWxkIHdlIGhhbmRsZSB0aGlzIGxpbmssIG9yIGxldCB0aGUgYnJvd3NlciBkZWFsIHdpdGggaXQ/CgkJCXVzZURlZmF1bHRVcmxIYW5kbGluZyA9ICRsaW5rLmlzKCAiW3JlbD0nZXh0ZXJuYWwnXSIgKSB8fCAkbGluay5pcyggIjpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiICkgfHwgJGxpbmsuaXMoICJbdGFyZ2V0XSIgKTsKCgkJCS8vIFNvbWUgZW1iZWRkZWQgYnJvd3NlcnMsIGxpa2UgdGhlIHdlYiB2aWV3IGluIFBob25lIEdhcCwgYWxsb3cgY3Jvc3MtZG9tYWluIFhIUgoJCQkvLyByZXF1ZXN0cyBpZiB0aGUgZG9jdW1lbnQgZG9pbmcgdGhlIHJlcXVlc3Qgd2FzIGxvYWRlZCB2aWEgdGhlIGZpbGU6Ly8gcHJvdG9jb2wuCgkJCS8vIFRoaXMgaXMgdXN1YWxseSB0byBhbGxvdyB0aGUgYXBwbGljYXRpb24gdG8gInBob25lIGhvbWUiIGFuZCBmZXRjaCBhcHAgc3BlY2lmaWMKCQkJLy8gZGF0YS4gV2Ugbm9ybWFsbHkgbGV0IHRoZSBicm93c2VyIGhhbmRsZSBleHRlcm5hbC9jcm9zcy1kb21haW4gdXJscywgYnV0IGlmIHRoZQoJCQkvLyBhbGxvd0Nyb3NzRG9tYWluUGFnZXMgb3B0aW9uIGlzIHRydWUsIHdlIHdpbGwgYWxsb3cgY3Jvc3MtZG9tYWluIGh0dHAvaHR0cHMKCQkJLy8gcmVxdWVzdHMgdG8gZ28gdGhyb3VnaCBvdXIgcGFnZSBsb2FkaW5nIGxvZ2ljLgoKCQkJLy9jaGVjayBmb3IgcHJvdG9jb2wgb3IgcmVsIGFuZCBpdHMgbm90IGFuIGVtYmVkZGVkIHBhZ2UKCQkJLy9UT0RPIG92ZXJsYXAgaW4gbG9naWMgZnJvbSBpc0V4dGVybmFsLCByZWw9ZXh0ZXJuYWwgY2hlY2sgc2hvdWxkIGJlCgkJCS8vICAgICBtb3ZlZCBpbnRvIG1vcmUgY29tcHJlaGVuc2l2ZSBpc0V4dGVybmFsTGluawoJCQlpc0V4dGVybmFsID0gdXNlRGVmYXVsdFVybEhhbmRsaW5nIHx8ICggJC5tb2JpbGUucGF0aC5pc0V4dGVybmFsKCBocmVmICkgJiYgISQubW9iaWxlLnBhdGguaXNQZXJtaXR0ZWRDcm9zc0RvbWFpblJlcXVlc3QoIGRvY3VtZW50VXJsLCBocmVmICkgKTsKCgkJCWlmICggaXNFeHRlcm5hbCApIHsKCQkJCWh0dHBDbGVhbnVwKCk7CgkJCQkvL3VzZSBkZWZhdWx0IGNsaWNrIGhhbmRsaW5nCgkJCQlyZXR1cm47CgkJCX0KCgkJCS8vdXNlIGFqYXgKCQkJdHJhbnNpdGlvbiA9ICRsaW5rLmpxbURhdGEoICJ0cmFuc2l0aW9uIiApOwoJCQlyZXZlcnNlID0gJGxpbmsuanFtRGF0YSggImRpcmVjdGlvbiIgKSA9PT0gInJldmVyc2UiIHx8CgkJCQkJCS8vIGRlcHJlY2F0ZWQgLSByZW1vdmUgYnkgMS4wCgkJCQkJCSRsaW5rLmpxbURhdGEoICJiYWNrIiApOwoKCQkJLy90aGlzIG1heSBuZWVkIHRvIGJlIG1vcmUgc3BlY2lmaWMgYXMgd2UgdXNlIGRhdGEtcmVsIG1vcmUKCQkJcm9sZSA9ICRsaW5rLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWwiICkgfHwgdW5kZWZpbmVkOwoKCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggaHJlZiwgeyB0cmFuc2l0aW9uOiB0cmFuc2l0aW9uLCByZXZlcnNlOiByZXZlcnNlLCByb2xlOiByb2xlLCBsaW5rOiAkbGluayB9ICk7CgkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJfSk7CgoJCS8vcHJlZmV0Y2ggcGFnZXMgd2hlbiBhbmNob3JzIHdpdGggZGF0YS1wcmVmZXRjaCBhcmUgZW5jb3VudGVyZWQKCQkkLm1vYmlsZS5kb2N1bWVudC5kZWxlZ2F0ZSggIi51aS1wYWdlIiwgInBhZ2VzaG93LnByZWZldGNoIiwgZnVuY3Rpb24oKSB7CgkJCXZhciB1cmxzID0gW107CgkJCSQoIHRoaXMgKS5maW5kKCAiYTpqcW1EYXRhKHByZWZldGNoKSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyICRsaW5rID0gJCggdGhpcyApLAoJCQkJCXVybCA9ICRsaW5rLmF0dHIoICJocmVmIiApOwoKCQkJCWlmICggdXJsICYmICQuaW5BcnJheSggdXJsLCB1cmxzICkgPT09IC0xICkgewoJCQkJCXVybHMucHVzaCggdXJsICk7CgoJCQkJCSQubW9iaWxlLmxvYWRQYWdlKCB1cmwsIHsgcm9sZTogJGxpbmsuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJlbCIgKSxwcmVmZXRjaDogdHJ1ZSB9ICk7CgkJCQl9CgkJCX0pOwoJCX0pOwoKCQkvLyBUT0RPIGVuc3VyZSB0aGF0IHRoZSBuYXZpZ2F0ZSBiaW5kaW5nIGluIHRoZSBjb250ZW50IHdpZGdldCBoYXBwZW5zIGF0IHRoZSByaWdodCB0aW1lCgkJJC5tb2JpbGUucGFnZUNvbnRhaW5lci5wYWdlY29udGFpbmVyKCk7CgoJCS8vc2V0IHBhZ2UgbWluLWhlaWdodHMgdG8gYmUgZGV2aWNlIHNwZWNpZmljCgkJJC5tb2JpbGUuZG9jdW1lbnQuYmluZCggInBhZ2VzaG93IiwgJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0ICk7CgkJJC5tb2JpbGUud2luZG93LmJpbmQoICJ0aHJvdHRsZWRyZXNpemUiLCAkLm1vYmlsZS5yZXNldEFjdGl2ZVBhZ2VIZWlnaHQgKTsKCgl9Oy8vbmF2cmVhZHlEZWZlcnJlZCBkb25lIGNhbGxiYWNrCgoJJCggZnVuY3Rpb24oKSB7IGRvbXJlYWR5RGVmZXJyZWQucmVzb2x2ZSgpOyB9ICk7CgoJJC53aGVuKCBkb21yZWFkeURlZmVycmVkLCAkLm1vYmlsZS5uYXZyZWFkeURlZmVycmVkICkuZG9uZSggZnVuY3Rpb24oKSB7ICQubW9iaWxlLl9yZWdpc3RlckludGVybmFsRXZlbnRzKCk7IH0gKTsKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgoJLy8gVE9ETyByZW1vdmUgZGlyZWN0IHJlZmVyZW5jZXMgdG8gJC5tb2JpbGUgYW5kIHByb3BlcnRpZXMsIHdlIHNob3VsZAoJLy8gICAgICBmYXZvciBpbmplY3Rpb24gd2l0aCBwYXJhbXMgdG8gdGhlIGNvbnN0cnVjdG9yCgkkLm1vYmlsZS5UcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KCB0aGlzLCBhcmd1bWVudHMgKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQl0b1ByZUNsYXNzOiAiIHVpLXBhZ2UtcHJlLWluIiwKCgkJaW5pdDogZnVuY3Rpb24oIG5hbWUsIHJldmVyc2UsICR0bywgJGZyb20gKSB7CgkJCSQuZXh0ZW5kKHRoaXMsIHsKCQkJCW5hbWU6IG5hbWUsCgkJCQlyZXZlcnNlOiByZXZlcnNlLAoJCQkJJHRvOiAkdG8sCgkJCQkkZnJvbTogJGZyb20sCgkJCQlkZWZlcnJlZDogbmV3ICQuRGVmZXJyZWQoKQoJCQl9KTsKCQl9LAoKCQljbGVhbkZyb206IGZ1bmN0aW9uKCkgewoJCQl0aGlzLiRmcm9tCgkJCQkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZVBhZ2VDbGFzcyArICIgb3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApCgkJCQkuaGVpZ2h0KCAiIiApOwoJCX0sCgoJCS8vIE5PVEUgb3ZlcnJpZGRlbiBieSBjaGlsZCBvYmplY3QgcHJvdG90eXBlcywgbm9vcCdkIGhlcmUgYXMgZGVmYXVsdHMKCQliZWZvcmVEb25lSW46IGZ1bmN0aW9uKCkge30sCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7fSwKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oKSB7fSwKCgkJZG9uZUluOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5iZWZvcmVEb25lSW4oKTsKCgkJCXRoaXMuJHRvLnJlbW92ZUNsYXNzKCAib3V0IGluIHJldmVyc2UgIiArIHRoaXMubmFtZSApLmhlaWdodCggIiIgKTsKCgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJLy8gSW4gc29tZSBicm93c2VycyAoaU9TNSksIDNEIHRyYW5zaXRpb25zIGJsb2NrIHRoZSBhYmlsaXR5IHRvIHNjcm9sbCB0byB0aGUgZGVzaXJlZCBsb2NhdGlvbiBkdXJpbmcgdHJhbnNpdGlvbgoJCQkvLyBUaGlzIGVuc3VyZXMgd2UganVtcCB0byB0aGF0IHNwb3QgYWZ0ZXIgdGhlIGZhY3QsIGlmIHdlIGFyZW4ndCB0aGVyZSBhbHJlYWR5LgoJCQlpZiAoICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSAhPT0gdGhpcy50b1Njcm9sbCApIHsKCQkJCXRoaXMuc2Nyb2xsUGFnZSgpOwoJCQl9CgkJCWlmICggIXRoaXMuc2VxdWVudGlhbCApIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCQkJfQoJCQl0aGlzLmRlZmVycmVkLnJlc29sdmUoIHRoaXMubmFtZSwgdGhpcy5yZXZlcnNlLCB0aGlzLiR0bywgdGhpcy4kZnJvbSwgdHJ1ZSApOwoJCX0sCgoJCWRvbmVPdXQ6IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmJlZm9yZURvbmVPdXQoKTsKCQkJdGhpcy5zdGFydEluKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICk7CgkJfSwKCgkJaGlkZUluOiBmdW5jdGlvbiggY2FsbGJhY2sgKSB7CgkJCS8vIFByZXZlbnQgZmxpY2tlcmluZyBpbiBwaG9uZWdhcCBjb250YWluZXI6IHNlZSBjb21tZW50cyBhdCAjNDAyNCByZWdhcmRpbmcgaU9TCgkJCXRoaXMuJHRvLmNzcyggInotaW5kZXgiLCAtMTAgKTsKCQkJY2FsbGJhY2suY2FsbCggdGhpcyApOwoJCQl0aGlzLiR0by5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQl9LAoKCQlzY3JvbGxQYWdlOiBmdW5jdGlvbigpIHsKCQkJLy8gQnkgdXNpbmcgc2Nyb2xsVG8gaW5zdGVhZCBvZiBzaWxlbnRTY3JvbGwsIHdlIGNhbiBrZWVwIHRoaW5ncyBiZXR0ZXIgaW4gb3JkZXIKCQkJLy8gSnVzdCB0byBiZSBwcmVjYXV0aW9zLCBkaXNhYmxlIHNjcm9sbHN0YXJ0IGxpc3RlbmluZyBsaWtlIHNpbGVudFNjcm9sbCB3b3VsZAoJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IGZhbHNlOwoJCQkvL2lmIHdlIGFyZSBoaWRpbmcgdGhlIHVybCBiYXIgb3IgdGhlIHBhZ2Ugd2FzIHByZXZpb3VzbHkgc2Nyb2xsZWQgc2Nyb2xsIHRvIGhpZGUgb3IgcmV0dXJuIHRvIHBvc2l0aW9uCgkJCWlmICggJC5tb2JpbGUuaGlkZVVybEJhciB8fCB0aGlzLnRvU2Nyb2xsICE9PSAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApIHsKCQkJCXdpbmRvdy5zY3JvbGxUbyggMCwgdGhpcy50b1Njcm9sbCApOwoJCQl9CgoJCQkvLyByZWVuYWJsZSBzY3JvbGxzdGFydCBsaXN0ZW5pbmcgbGlrZSBzaWxlbnRTY3JvbGwgd291bGQKCQkJc2V0VGltZW91dCggZnVuY3Rpb24oKSB7CgkJCQkkLmV2ZW50LnNwZWNpYWwuc2Nyb2xsc3RhcnQuZW5hYmxlZCA9IHRydWU7CgkJCX0sIDE1MCApOwoJCX0sCgoJCXN0YXJ0SW46IGZ1bmN0aW9uKCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSwgcHJldmVudEZvY3VzICkgewoJCQl0aGlzLmhpZGVJbihmdW5jdGlvbigpIHsKCQkJCXRoaXMuJHRvLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKyB0aGlzLnRvUHJlQ2xhc3MgKTsKCgkJCQkvLyBTZW5kIGZvY3VzIHRvIHBhZ2UgYXMgaXQgaXMgbm93IGRpc3BsYXk6IGJsb2NrCgkJCQlpZiAoICFwcmV2ZW50Rm9jdXMgKSB7CgkJCQkJJC5tb2JpbGUuZm9jdXNQYWdlKCB0aGlzLiR0byApOwoJCQkJfQoKCQkJCS8vIFNldCB0byBwYWdlIGhlaWdodAoJCQkJdGhpcy4kdG8uaGVpZ2h0KCBzY3JlZW5IZWlnaHQgKyB0aGlzLnRvU2Nyb2xsICk7CgogICAgICAgICAgICAgICAgaWYgKCAhbm9uZSApIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFBhZ2UoKTsKICAgICAgICAgICAgICAgIH0KCQkJfSk7CgoJCQlpZiAoICFub25lICkgewoJCQkJdGhpcy4kdG8uYW5pbWF0aW9uQ29tcGxldGUoICQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQkJdGhpcy5kb25lSW4oKTsKCQkJCX0sIHRoaXMgKSk7CgkJCX0KCgkJCXRoaXMuJHRvCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMudG9QcmVDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgaW4gIiArIHJldmVyc2VDbGFzcyApOwoKCQkJaWYgKCBub25lICkgewoJCQkJdGhpcy5kb25lSW4oKTsKCQkJfQoKCQl9LAoKCQlzdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLmJlZm9yZVN0YXJ0T3V0KCBzY3JlZW5IZWlnaHQsIHJldmVyc2VDbGFzcywgbm9uZSApOwoKCQkJLy8gU2V0IHRoZSBmcm9tIHBhZ2UncyBoZWlnaHQgYW5kIHN0YXJ0IGl0IHRyYW5zaXRpb25pbmcgb3V0CgkJCS8vIE5vdGU6IHNldHRpbmcgYW4gZXhwbGljaXQgaGVpZ2h0IGhlbHBzIGVsaW1pbmF0ZSB0aWxpbmcgaW4gdGhlIHRyYW5zaXRpb25zCgkJCXRoaXMuJGZyb20KCQkJCS5oZWlnaHQoIHNjcmVlbkhlaWdodCArICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMubmFtZSArICIgb3V0IiArIHJldmVyc2VDbGFzcyApOwoJCX0sCgoJCXRvZ2dsZVZpZXdwb3J0Q2xhc3M6IGZ1bmN0aW9uKCkgewoJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnRvZ2dsZUNsYXNzKCAidWktbW9iaWxlLXZpZXdwb3J0LXRyYW5zaXRpb25pbmcgdmlld3BvcnQtIiArIHRoaXMubmFtZSApOwoJCX0sCgoJCXRyYW5zaXRpb246IGZ1bmN0aW9uKCkgewoJCQkvLyBOT1RFIG1hbnkgb2YgdGhlc2UgY291bGQgYmUgY2FsY3VsYXRlZC9yZWNvcmRlZCBpbiB0aGUgY29uc3RydWN0b3IsIGl0J3MgbXkKCQkJLy8gICAgICBvcGluaW9uIHRoYXQgYmluZGluZyB0aGVtIGFzIGxhdGUgYXMgcG9zc2libGUgaGFzIHZhbHVlIHdpdGggcmVnYXJkcyB0bwoJCQkvLyAgICAgIGJldHRlciB0cmFuc2l0aW9ucyB3aXRoIGZld2VyIGJ1Z3MuIEllLCBpdCdzIG5vdCBndWFyYW50ZWVkIHRoYXQgdGhlCgkJCS8vICAgICAgb2JqZWN0IHdpbGwgYmUgY3JlYXRlZCBhbmQgdHJhbnNpdGlvbiB3aWxsIGJlIHJ1biBpbW1lZGlhdGVseSBhZnRlciBhcwoJCQkvLyAgICAgIGl0IGlzIHRvZGF5LiBTbyB3ZSB3YWl0IHVudGlsIHRyYW5zaXRpb24gaXMgaW52b2tlZCB0byBnYXRoZXIgdGhlIGZvbGxvd2luZwoJCQl2YXIgcmV2ZXJzZUNsYXNzID0gdGhpcy5yZXZlcnNlID8gIiByZXZlcnNlIiA6ICIiLAoJCQkJc2NyZWVuSGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCksCgkJCQltYXhUcmFuc2l0aW9uT3ZlcnJpZGUgPSAkLm1vYmlsZS5tYXhUcmFuc2l0aW9uV2lkdGggIT09IGZhbHNlICYmICQubW9iaWxlLndpbmRvdy53aWR0aCgpID4gJC5tb2JpbGUubWF4VHJhbnNpdGlvbldpZHRoLAoJCQkJbm9uZSA9ICEkLnN1cHBvcnQuY3NzVHJhbnNpdGlvbnMgfHwgISQuc3VwcG9ydC5jc3NBbmltYXRpb25zIHx8IG1heFRyYW5zaXRpb25PdmVycmlkZSB8fCAhdGhpcy5uYW1lIHx8IHRoaXMubmFtZSA9PT0gIm5vbmUiIHx8IE1hdGgubWF4KCAkLm1vYmlsZS53aW5kb3cuc2Nyb2xsVG9wKCksIHRoaXMudG9TY3JvbGwgKSA+ICQubW9iaWxlLmdldE1heFNjcm9sbEZvclRyYW5zaXRpb24oKTsKCgkJCXRoaXMudG9TY3JvbGwgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmdldEFjdGl2ZSgpLmxhc3RTY3JvbGwgfHwgJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGw7CgkJCXRoaXMudG9nZ2xlVmlld3BvcnRDbGFzcygpOwoKCQkJaWYgKCB0aGlzLiRmcm9tICYmICFub25lICkgewoJCQkJdGhpcy5zdGFydE91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUsIHRydWUgKTsKCQkJfQoKCQkJcmV0dXJuIHRoaXMuZGVmZXJyZWQucHJvbWlzZSgpOwoJCX0KCX0pOwp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQl0aGlzLmluaXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCX07CgoJJC5leHRlbmQoJC5tb2JpbGUuU2VyaWFsVHJhbnNpdGlvbi5wcm90b3R5cGUsICQubW9iaWxlLlRyYW5zaXRpb24ucHJvdG90eXBlLCB7CgkJc2VxdWVudGlhbDogdHJ1ZSwKCgkJYmVmb3JlRG9uZU91dDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy4kZnJvbSApIHsKCQkJCXRoaXMuY2xlYW5Gcm9tKCk7CgkJCX0KCQl9LAoKCQliZWZvcmVTdGFydE91dDogZnVuY3Rpb24oIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICkgewoJCQl0aGlzLiRmcm9tLmFuaW1hdGlvbkNvbXBsZXRlKCQucHJveHkoZnVuY3Rpb24oKSB7CgkJCQl0aGlzLmRvbmVPdXQoIHNjcmVlbkhlaWdodCwgcmV2ZXJzZUNsYXNzLCBub25lICk7CgkJCX0sIHRoaXMgKSk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKGZ1bmN0aW9uKCAkICkgewoKCSQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uID0gZnVuY3Rpb24oKSB7CgkJdGhpcy5pbml0LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cgl9OwoKCSQuZXh0ZW5kKCQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uLnByb3RvdHlwZSwgJC5tb2JpbGUuVHJhbnNpdGlvbi5wcm90b3R5cGUsIHsKCQlzZXF1ZW50aWFsOiBmYWxzZSwKCgkJYmVmb3JlRG9uZUluOiBmdW5jdGlvbigpIHsKCQkJaWYgKCB0aGlzLiRmcm9tICkgewoJCQkJdGhpcy5jbGVhbkZyb20oKTsKCQkJfQoJCX0sCgoJCWJlZm9yZVN0YXJ0T3V0OiBmdW5jdGlvbiggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKSB7CgkJCXRoaXMuZG9uZU91dCggc2NyZWVuSGVpZ2h0LCByZXZlcnNlQ2xhc3MsIG5vbmUgKTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQgKSB7CgoJLy8gZ2VuZXJhdGUgdGhlIGhhbmRsZXJzIGZyb20gdGhlIGFib3ZlCgl2YXIgZGVmYXVsdEdldE1heFNjcm9sbEZvclRyYW5zaXRpb24gPSBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCkgKiAzOwoJfTsKCgkvL3RyYW5zaXRpb24gaGFuZGxlciBkaWN0aW9uYXJ5IGZvciAzcmQgcGFydHkgdHJhbnNpdGlvbnMKCSQubW9iaWxlLnRyYW5zaXRpb25IYW5kbGVycyA9IHsKCQkic2VxdWVudGlhbCI6ICQubW9iaWxlLlNlcmlhbFRyYW5zaXRpb24sCgkJInNpbXVsdGFuZW91cyI6ICQubW9iaWxlLkNvbmN1cnJlbnRUcmFuc2l0aW9uCgl9OwoKCS8vIE1ha2Ugb3VyIHRyYW5zaXRpb24gaGFuZGxlciB0aGUgcHVibGljIGRlZmF1bHQuCgkkLm1vYmlsZS5kZWZhdWx0VHJhbnNpdGlvbkhhbmRsZXIgPSAkLm1vYmlsZS50cmFuc2l0aW9uSGFuZGxlcnMuc2VxdWVudGlhbDsKCgkkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzID0ge307CgoJLy8gSWYgdHJhbnNpdGlvbiBpcyBkZWZpbmVkLCBjaGVjayBpZiBjc3MgM0QgdHJhbnNmb3JtcyBhcmUgc3VwcG9ydGVkLCBhbmQgaWYgbm90LCBpZiBhIGZhbGxiYWNrIGlzIHNwZWNpZmllZAoJJC5tb2JpbGUuX21heWJlRGVncmFkZVRyYW5zaXRpb24gPSBmdW5jdGlvbiggdHJhbnNpdGlvbiApIHsKCQlpZiAoIHRyYW5zaXRpb24gJiYgISQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF0gKSB7CgkJCXRyYW5zaXRpb24gPSAkLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzWyB0cmFuc2l0aW9uIF07CgkJfQoKCQlyZXR1cm4gdHJhbnNpdGlvbjsKCX07CgoJLy8gU2V0IHRoZSBnZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uIHRvIGRlZmF1bHQgaWYgbm8gaW1wbGVtZW50YXRpb24gd2FzIHNldCBieSB1c2VyCgkkLm1vYmlsZS5nZXRNYXhTY3JvbGxGb3JUcmFuc2l0aW9uID0gJC5tb2JpbGUuZ2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbiB8fCBkZWZhdWx0R2V0TWF4U2Nyb2xsRm9yVHJhbnNpdGlvbjsKCn0pKCBqUXVlcnkgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxpcCBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxpcCA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgZmxvdyBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLnRyYW5zaXRpb25GYWxsYmFja3MuZmxvdyA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3IgcG9wIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5wb3AgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKLy8gVXNlIHRoZSBzaW11bHRhbmVvdXMgdHJhbnNpdGlvbnMgaGFuZGxlciBmb3Igc2xpZGUgdHJhbnNpdGlvbnMKJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNsaWRlID0gJC5tb2JpbGUudHJhbnNpdGlvbkhhbmRsZXJzLnNpbXVsdGFuZW91czsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZSA9ICJmYWRlIjsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCi8qCiogZmFsbGJhY2sgdHJhbnNpdGlvbiBmb3Igc2xpZGVkb3duIGluIG5vbi0zRCBzdXBwb3J0aW5nIGJyb3dzZXJzICh3aGljaCB0ZW5kIHRvIGhhbmRsZSBjb21wbGV4IHRyYW5zaXRpb25zIHBvb3JseSBpbiBnZW5lcmFsCiovCgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWRvd24gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRlZmFkZSBpbiBub24tM0Qgc3VwcG9ydGluZyBicm93c2VycyAod2hpY2ggdGVuZCB0byBoYW5kbGUgY29tcGxleCB0cmFuc2l0aW9ucyBwb29ybHkgaW4gZ2VuZXJhbAoqLwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCi8vIFNldCB0aGUgc2xpZGUgdHJhbnNpdGlvbnMncyBmYWxsYmFjayB0byAiZmFkZSIKJC5tb2JpbGUudHJhbnNpdGlvbkZhbGxiYWNrcy5zbGlkZWZhZGUgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHNsaWRldXAgaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnNsaWRldXAgPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgovKgoqIGZhbGxiYWNrIHRyYW5zaXRpb24gZm9yIHR1cm4gaW4gbm9uLTNEIHN1cHBvcnRpbmcgYnJvd3NlcnMgKHdoaWNoIHRlbmQgdG8gaGFuZGxlIGNvbXBsZXggdHJhbnNpdGlvbnMgcG9vcmx5IGluIGdlbmVyYWwKKi8KCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS50cmFuc2l0aW9uRmFsbGJhY2tzLnR1cm4gPSAiZmFkZSI7Cgp9KSggalF1ZXJ5LCB0aGlzICk7CgoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5kZWdyYWRlSW5wdXRzID0gewoJY29sb3I6IGZhbHNlLAoJZGF0ZTogZmFsc2UsCglkYXRldGltZTogZmFsc2UsCgkiZGF0ZXRpbWUtbG9jYWwiOiBmYWxzZSwKCWVtYWlsOiBmYWxzZSwKCW1vbnRoOiBmYWxzZSwKCW51bWJlcjogZmFsc2UsCglyYW5nZTogIm51bWJlciIsCglzZWFyY2g6ICJ0ZXh0IiwKCXRlbDogZmFsc2UsCgl0aW1lOiBmYWxzZSwKCXVybDogZmFsc2UsCgl3ZWVrOiBmYWxzZQp9OwovLyBCYWNrY29tcGF0IHJlbW92ZSBpbiAxLjUKJC5tb2JpbGUucGFnZS5wcm90b3R5cGUub3B0aW9ucy5kZWdyYWRlSW5wdXRzID0gJC5tb2JpbGUuZGVncmFkZUlucHV0czsKCi8vIEF1dG8gc2VsZi1pbml0IHdpZGdldHMKJC5tb2JpbGUuZGVncmFkZUlucHV0c1dpdGhpbiA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJdGFyZ2V0ID0gJCggdGFyZ2V0ICk7CgoJLy8gRGVncmFkZSBpbnB1dHMgdG8gYXZvaWQgcG9vcmx5IGltcGxlbWVudGVkIG5hdGl2ZSBmdW5jdGlvbmFsaXR5Cgl0YXJnZXQuZmluZCggImlucHV0IiApLm5vdCggJC5tb2JpbGUucGFnZS5wcm90b3R5cGUua2VlcE5hdGl2ZVNlbGVjdG9yKCkgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50ID0gJCggdGhpcyApLAoJCQl0eXBlID0gdGhpcy5nZXRBdHRyaWJ1dGUoICJ0eXBlIiApLAoJCQlvcHRUeXBlID0gJC5tb2JpbGUuZGVncmFkZUlucHV0c1sgdHlwZSBdIHx8ICJ0ZXh0IiwKCQkJaHRtbCwgaGFzVHlwZSwgZmluZHN0ciwgcmVwc3RyOwoKCQlpZiAoICQubW9iaWxlLmRlZ3JhZGVJbnB1dHNbIHR5cGUgXSApIHsKCQkJaHRtbCA9ICQoICI8ZGl2PiIgKS5odG1sKCBlbGVtZW50LmNsb25lKCkgKS5odG1sKCk7CgkJCS8vIEluIElFIGJyb3dzZXJzLCB0aGUgdHlwZSBzb21ldGltZXMgZG9lc24ndCBleGlzdCBpbiB0aGUgY2xvbmVkIG1hcmt1cCwgc28gd2UgcmVwbGFjZSB0aGUgY2xvc2luZyB0YWcgaW5zdGVhZAoJCQloYXNUeXBlID0gaHRtbC5pbmRleE9mKCAiIHR5cGU9IiApID4gLTE7CgkJCWZpbmRzdHIgPSBoYXNUeXBlID8gL1xzK3R5cGU9WyInXT9cdytbJyJdPy8gOiAvXC8/Pi87CgkJCXJlcHN0ciA9ICIgdHlwZT1cIiIgKyBvcHRUeXBlICsgIlwiIGRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9XCIiICsgdHlwZSArICJcIiIgKyAoIGhhc1R5cGUgPyAiIiA6ICI+IiApOwoKCQkJZWxlbWVudC5yZXBsYWNlV2l0aCggaHRtbC5yZXBsYWNlKCBmaW5kc3RyLCByZXBzdHIgKSApOwoJCX0KCX0pOwoKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgd2luZG93LCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5wYWdlIiwgJC5tb2JpbGUucGFnZSwgewoJb3B0aW9uczogewoKCQkvLyBBY2NlcHRzIGxlZnQsIHJpZ2h0IGFuZCBub25lCgkJY2xvc2VCdG46ICJsZWZ0IiwKCQljbG9zZUJ0blRleHQ6ICJDbG9zZSIsCgkJb3ZlcmxheVRoZW1lOiAiYSIsCgkJY29ybmVyczogdHJ1ZSwKCQlkaWFsb2c6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlhbG9nICkgewoKCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCV9pbm5lcjogdGhpcy5lbGVtZW50LmNoaWxkcmVuKCksCgkJCQlfaGVhZGVyQ2xvc2VCdXR0b246IG51bGwKCQkJfSk7CgoJCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCQl0aGlzLl9zZXRDbG9zZUJ0biggdGhpcy5vcHRpb25zLmNsb3NlQnRuICk7CgkJCX0KCQl9Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBDbGFzcyB0aGUgbWFya3VwIGZvciBkaWFsb2cgc3R5bGluZyBhbmQgd3JhcCBpbnRlcmlvcgoJCWlmICggdGhpcy5vcHRpb25zLmRpYWxvZyApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCQkud3JhcElubmVyKCAkKCAiPGRpdi8+IiwgewoKCQkJCQkvLyBBUklBIHJvbGUKCQkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCQkiY2xhc3MiIDogInVpLWRpYWxvZy1jb250YWluIHVpLW92ZXJsYXktc2hhZG93IiArCgkJCQkJCSggdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIgKQoJCQkJfSkpOwoJCX0KCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2hhbmRsZVBhZ2VCZWZvcmVTaG93OiBmdW5jdGlvbiAoKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIHRoaXMub3B0aW9ucy5kaWFsb2cgKSB7CgkJCXRoaXMucmVtb3ZlQ29udGFpbmVyQmFja2dyb3VuZCgpOwoJCQl0aGlzLnNldENvbnRhaW5lckJhY2tncm91bmQoIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9IGVsc2UgewoJCQl0aGlzLl9zdXBlcigpOwoJCX0KCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJocmVmIjogIiMiLAoJCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktYnRuLSIgKyBsb2NhdGlvbgoJCQkJfSkKCQkJCS5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicmVsIiwgImJhY2siICkKCQkJCS50ZXh0KCB0ZXh0IHx8IHRoaXMub3B0aW9ucy5jbG9zZUJ0blRleHQgfHwgIiIgKQoJCQkJLnByZXBlbmRUbyggZHN0ICk7CgkJCXRoaXMuX29uKCBidG4sIHsgY2xpY2s6ICJjbG9zZSIgfSApOwoJCX0KCgkJdGhpcy5faGVhZGVyQ2xvc2VCdXR0b24gPSBidG47Cgl9Cn0pOwoKfSkoIGpRdWVyeSwgdGhpcyApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3csIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmRpYWxvZyIsIHsKCW9wdGlvbnM6IHsKCgkJLy8gQWNjZXB0cyBsZWZ0LCByaWdodCBhbmQgbm9uZQoJCWNsb3NlQnRuOiAibGVmdCIsCgkJY2xvc2VCdG5UZXh0OiAiQ2xvc2UiLAoJCW92ZXJsYXlUaGVtZTogImEiLAoJCWNvcm5lcnM6IHRydWUKCX0sCgoJLy8gT3ZlcnJpZGUgdGhlIHRoZW1lIHNldCBieSB0aGUgcGFnZSBwbHVnaW4gb24gcGFnZXNob3cKCV9oYW5kbGVQYWdlQmVmb3JlU2hvdzogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSB0cnVlOwoJCWlmICggdGhpcy5vcHRpb25zLm92ZXJsYXlUaGVtZSApIHsKCQkJdGhpcy5lbGVtZW50CgkJCQkucGFnZSggInJlbW92ZUNvbnRhaW5lckJhY2tncm91bmQiICkKCQkJCS5wYWdlKCAic2V0Q29udGFpbmVyQmFja2dyb3VuZCIsIHRoaXMub3B0aW9ucy5vdmVybGF5VGhlbWUgKTsKCQl9Cgl9LAoKCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5faXNDbG9zZWFibGUgPSBmYWxzZTsKCX0sCgoJLy8gY2xpY2sgYW5kIHN1Ym1pdCBldmVudHM6CgkvLyAtIGNsaWNrcyBhbmQgc3VibWl0cyBzaG91bGQgdXNlIHRoZSBjbG9zaW5nIHRyYW5zaXRpb24gdGhhdCB0aGUgZGlhbG9nCgkvLyAgIG9wZW5lZCB3aXRoIHVubGVzcyBhIGRhdGEtdHJhbnNpdGlvbiBpcyBzcGVjaWZpZWQgb24gdGhlIGxpbmsvZm9ybQoJLy8gLSBpZiB0aGUgY2xpY2sgd2FzIG9uIHRoZSBjbG9zZSBidXR0b24sIG9yIHRoZSBsaW5rIGhhcyBhIGRhdGEtcmVsPSJiYWNrIgoJLy8gICBpdCdsbCBnbyBiYWNrIGluIGhpc3RvcnkgbmF0dXJhbGx5CglfaGFuZGxlVkNsaWNrU3VibWl0OiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGF0dHJzLAoJCQkkdGFyZ2V0ID0gJCggZXZlbnQudGFyZ2V0ICkuY2xvc2VzdCggZXZlbnQudHlwZSA9PT0gInZjbGljayIgPyAiYSIgOiAiZm9ybSIgKTsKCgkJaWYgKCAkdGFyZ2V0Lmxlbmd0aCAmJiAhJHRhcmdldC5qcW1EYXRhKCAidHJhbnNpdGlvbiIgKSApIHsKCQkJYXR0cnMgPSB7fTsKCQkJYXR0cnNbICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ0cmFuc2l0aW9uIiBdID0KCQkJCSggJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeS5nZXRBY3RpdmUoKSB8fCB7fSApWyAidHJhbnNpdGlvbiIgXSB8fAoJCQkJJC5tb2JpbGUuZGVmYXVsdERpYWxvZ1RyYW5zaXRpb247CgkJCWF0dHJzWyAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAiZGlyZWN0aW9uIiBdID0gInJldmVyc2UiOwoJCQkkdGFyZ2V0LmF0dHIoIGF0dHJzICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ2xhc3MgdGhlIG1hcmt1cCBmb3IgZGlhbG9nIHN0eWxpbmcgYW5kIHdyYXAgaW50ZXJpb3IKCQllbGVtLmFkZENsYXNzKCAidWktZGlhbG9nIiApCgkJCS53cmFwSW5uZXIoICQoICI8ZGl2Lz4iLCB7CgoJCQkJLy8gQVJJQSByb2xlCgkJCQkicm9sZSIgOiAiZGlhbG9nIiwKCQkJCSJjbGFzcyIgOiAidWktZGlhbG9nLWNvbnRhaW4gdWktb3ZlcmxheS1zaGFkb3ciICsKCQkJCQkoICEhb3B0cy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkKCQkJfSkpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfaXNDbG9zZWFibGU6IGZhbHNlLAoJCQlfaW5uZXI6IGVsZW0uY2hpbGRyZW4oKSwKCQkJX2hlYWRlckNsb3NlQnV0dG9uOiBudWxsCgkJfSk7CgoJCXRoaXMuX29uKCBlbGVtLCB7CgkJCXZjbGljazogIl9oYW5kbGVWQ2xpY2tTdWJtaXQiLAoJCQlzdWJtaXQ6ICJfaGFuZGxlVkNsaWNrU3VibWl0IiwKCQkJcGFnZWJlZm9yZXNob3c6ICJfaGFuZGxlUGFnZUJlZm9yZVNob3ciLAoJCQlwYWdlYmVmb3JlaGlkZTogIl9oYW5kbGVQYWdlQmVmb3JlSGlkZSIKCQl9KTsKCgkJdGhpcy5fc2V0Q2xvc2VCdG4oIG9wdHMuY2xvc2VCdG4gKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBjbG9zZUJ1dHRvbkxvY2F0aW9uLCBjbG9zZUJ1dHRvblRleHQsCgkJCWN1cnJlbnRPcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9pbm5lci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCAhIW9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm92ZXJsYXlUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoICQubW9iaWxlLmFjdGl2ZVBhZ2VbIDAgXSA9PT0gdGhpcy5lbGVtZW50WyAwIF0gKSB7CgkJCQljdXJyZW50T3B0cy5vdmVybGF5VGhlbWUgPSBvcHRpb25zLm92ZXJsYXlUaGVtZTsKCQkJCXRoaXMuX2hhbmRsZVBhZ2VCZWZvcmVTaG93KCk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0blRleHQgIT09IHVuZGVmaW5lZCApIHsKCQkJY2xvc2VCdXR0b25Mb2NhdGlvbiA9IGN1cnJlbnRPcHRzLmNsb3NlQnRuOwoJCQljbG9zZUJ1dHRvblRleHQgPSBvcHRpb25zLmNsb3NlQnRuVGV4dDsKCQl9CgoJCWlmICggb3B0aW9ucy5jbG9zZUJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQljbG9zZUJ1dHRvbkxvY2F0aW9uID0gb3B0aW9ucy5jbG9zZUJ0bjsKCQl9CgoJCWlmICggY2xvc2VCdXR0b25Mb2NhdGlvbiApIHsKCQkJdGhpcy5fc2V0Q2xvc2VCdG4oIGNsb3NlQnV0dG9uTG9jYXRpb24sIGNsb3NlQnV0dG9uVGV4dCApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX3NldENsb3NlQnRuOiBmdW5jdGlvbiggbG9jYXRpb24sIHRleHQgKSB7CgkJdmFyIGRzdCwKCQkJYnRuID0gdGhpcy5faGVhZGVyQ2xvc2VCdXR0b247CgoJCS8vIFNhbml0aXplIHZhbHVlCgkJbG9jYXRpb24gPSAibGVmdCIgPT09IGxvY2F0aW9uID8gImxlZnQiIDogInJpZ2h0IiA9PT0gbG9jYXRpb24gPyAicmlnaHQiIDogIm5vbmUiOwoKCQlpZiAoICJub25lIiA9PT0gbG9jYXRpb24gKSB7CgkJCWlmICggYnRuICkgewoJCQkJYnRuLnJlbW92ZSgpOwoJCQkJYnRuID0gbnVsbDsKCQkJfQoJCX0gZWxzZSBpZiAoIGJ0biApIHsKCQkJYnRuLnJlbW92ZUNsYXNzKCAidWktYnRuLWxlZnQgdWktYnRuLXJpZ2h0IiApLmFkZENsYXNzKCAidWktYnRuLSIgKyBsb2NhdGlvbiApOwoJCQlpZiAoIHRleHQgKSB7CgkJCQlidG4udGV4dCggdGV4dCApOwoJCQl9CgkJfSBlbHNlIHsKCQkJZHN0ID0gdGhpcy5faW5uZXIuZmluZCggIjpqcW1EYXRhKHJvbGU9J2hlYWRlcicpIiApLmZpcnN0KCk7CgkJCWJ0biA9ICQoICI8YT48L2E+IiwgewoJCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkJImhyZWYiOiAiIyIsCgkJCQkJImNsYXNzIjogInVpLWJ0biB1aS1jb3JuZXItYWxsIHVpLWljb24tZGVsZXRlIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1idG4tIiArIGxvY2F0aW9uCgkJCQl9KQoJCQkJLnRleHQoIHRleHQgfHwgdGhpcy5vcHRpb25zLmNsb3NlQnRuVGV4dCB8fCAiIiApCgkJCQkucHJlcGVuZFRvKCBkc3QgKTsKCQkJdGhpcy5fb24oIGJ0biwgeyBjbGljazogImNsb3NlIiB9ICk7CgkJfQoKCQl0aGlzLl9oZWFkZXJDbG9zZUJ1dHRvbiA9IGJ0bjsKCX0sCgoJLy8gQ2xvc2UgbWV0aG9kIGdvZXMgYmFjayBpbiBoaXN0b3J5CgljbG9zZTogZnVuY3Rpb24oKSB7CgkJdmFyIGhpc3QgPSAkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5OwoKCQlpZiAoIHRoaXMuX2lzQ2xvc2VhYmxlICkgewoJCQl0aGlzLl9pc0Nsb3NlYWJsZSA9IGZhbHNlOwoJCQkvLyBJZiB0aGUgaGFzaCBsaXN0ZW5pbmcgaXMgZW5hYmxlZCBhbmQgdGhlcmUgaXMgYXQgbGVhc3Qgb25lIHByZWNlZGluZyBoaXN0b3J5CgkJCS8vIGVudHJ5IGl0J3Mgb2sgdG8gZ28gYmFjay4gSW5pdGlhbCBwYWdlcyB3aXRoIHRoZSBkaWFsb2cgaGFzaCBzdGF0ZSBhcmUgYW4gZXhhbXBsZQoJCQkvLyB3aGVyZSB0aGUgc3RhY2sgY2hlY2sgaXMgbmVjZXNzYXJ5CgkJCWlmICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYgaGlzdC5hY3RpdmVJbmRleCA+IDAgKSB7CgkJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCX0gZWxzZSB7CgkJCQkkLm1vYmlsZS5wYWdlQ29udGFpbmVyLnBhZ2Vjb250YWluZXIoICJiYWNrIiApOwoJCQl9CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnksIHRoaXMgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHJJbml0aWFsTGV0dGVyID0gLyhbQS1aXSkvZzsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlIiwgewoJb3B0aW9uczogewoJCWVuaGFuY2VkOiBmYWxzZSwKCQlleHBhbmRDdWVUZXh0OiBudWxsLAoJCWNvbGxhcHNlQ3VlVGV4dDogbnVsbCwKCQljb2xsYXBzZWQ6IHRydWUsCgkJaGVhZGluZzogImgxLGgyLGgzLGg0LGg1LGg2LGxlZ2VuZCIsCgkJY29sbGFwc2VkSWNvbjogbnVsbCwKCQlleHBhbmRlZEljb246IG51bGwsCgkJaWNvbnBvczogbnVsbCwKCQl0aGVtZTogbnVsbCwKCQljb250ZW50VGhlbWU6IG51bGwsCgkJaW5zZXQ6IG51bGwsCgkJY29ybmVyczogbnVsbCwKCQltaW5pOiBudWxsCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQl1aSA9IHsKCQkJCWFjY29yZGlvbjogZWxlbQoJCQkJCS5jbG9zZXN0KCAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICsKCQkJCQkJKCAkLm1vYmlsZS5jb2xsYXBzaWJsZXNldCA/ICIsIDptb2JpbGUtY29sbGFwc2libGVzZXQiIDogIiIgKSApCgkJCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtc2V0IiApCgkJCX07CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV91aTogdWkKCQl9KTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmciLCB0aGlzLmVsZW1lbnRbIDAgXSApOwoJCQl1aS5jb250ZW50ID0gdWkuaGVhZGluZy5uZXh0KCk7CgkJCXVpLmFuY2hvciA9ICQoICJhIiwgdWkuaGVhZGluZ1sgMCBdICkuZmlyc3QoKTsKCQkJdWkuc3RhdHVzID0gdWkuYW5jaG9yLmNoaWxkcmVuKCAiLnVpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzIiApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX2VuaGFuY2UoIGVsZW0sIHVpICk7CgkJfQoKCQl0aGlzLl9vbiggdWkuaGVhZGluZywgewoJCQkidGFwIjogZnVuY3Rpb24oKSB7CgkJCQl1aS5oZWFkaW5nLmZpbmQoICJhIiApLmZpcnN0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0sCgoJCQkiY2xpY2siOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggIXVpLmhlYWRpbmcuaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1oZWFkaW5nLWNvbGxhcHNlZCIgKSApOwoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWV2ZW50LnN0b3BQcm9wYWdhdGlvbigpOwoJCQl9CgkJfSk7Cgl9LAoKCS8vIEFkanVzdCB0aGUga2V5cyBpbnNpZGUgb3B0aW9ucyBmb3IgaW5oZXJpdGVkIHZhbHVlcwoJX2dldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBrZXksCgkJCWFjY29yZGlvbiA9IHRoaXMuX3VpLmFjY29yZGlvbiwKCQkJYWNjb3JkaW9uV2lkZ2V0ID0gdGhpcy5fdWkuYWNjb3JkaW9uV2lkZ2V0OwoKCQkvLyBDb3B5IG9wdGlvbnMKCQlvcHRpb25zID0gJC5leHRlbmQoIHt9LCBvcHRpb25zICk7CgoJCWlmICggYWNjb3JkaW9uLmxlbmd0aCAmJiAhYWNjb3JkaW9uV2lkZ2V0ICkgewoJCQl0aGlzLl91aS5hY2NvcmRpb25XaWRnZXQgPQoJCQlhY2NvcmRpb25XaWRnZXQgPSBhY2NvcmRpb24uZGF0YSggIm1vYmlsZS1jb2xsYXBzaWJsZXNldCIgKTsKCQl9CgoJCWZvciAoIGtleSBpbiBvcHRpb25zICkgewoKCQkJLy8gUmV0cmlldmUgdGhlIG9wdGlvbiB2YWx1ZSBmaXJzdCBmcm9tIHRoZSBvcHRpb25zIG9iamVjdCBwYXNzZWQgaW4gYW5kLCBpZgoJCQkvLyBudWxsLCBmcm9tIHRoZSBwYXJlbnQgYWNjb3JkaW9uIG9yLCBpZiB0aGF0J3MgbnVsbCB0b28sIG9yIGlmIHRoZXJlJ3Mgbm8KCQkJLy8gcGFyZW50IGFjY29yZGlvbiwgdGhlbiBmcm9tIHRoZSBkZWZhdWx0cy4KCQkJb3B0aW9uc1sga2V5IF0gPQoJCQkJKCBvcHRpb25zWyBrZXkgXSAhPSBudWxsICkgPyBvcHRpb25zWyBrZXkgXSA6CgkJCQkoIGFjY29yZGlvbldpZGdldCApID8gYWNjb3JkaW9uV2lkZ2V0Lm9wdGlvbnNbIGtleSBdIDoKCQkJCWFjY29yZGlvbi5sZW5ndGggPyAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGFjY29yZGlvblsgMCBdLAoJCQkJCWtleS5yZXBsYWNlKCBySW5pdGlhbExldHRlciwgIi0kMSIgKS50b0xvd2VyQ2FzZSgpICk6CgkJCQludWxsOwoKCQkJaWYgKCBudWxsID09IG9wdGlvbnNbIGtleSBdICkgewoJCQkJb3B0aW9uc1sga2V5IF0gPSAkLm1vYmlsZS5jb2xsYXBzaWJsZS5kZWZhdWx0c1sga2V5IF07CgkJCX0KCQl9CgoJCXJldHVybiBvcHRpb25zOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCBlbGVtLCB1aSApIHsKCQl2YXIgaWNvbmNsYXNzLAoJCQlvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCWNvbnRlbnRUaGVtZUNsYXNzID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMuY29udGVudFRoZW1lICk7CgoJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSAiICsKCQkJKCBvcHRzLmluc2V0ID8gInVpLWNvbGxhcHNpYmxlLWluc2V0ICIgOiAiIiApICsKCQkJKCBvcHRzLmluc2V0ICYmIG9wdHMuY29ybmVycyA/ICJ1aS1jb3JuZXItYWxsICIgOiAiIiApICsKCQkJKCBjb250ZW50VGhlbWVDbGFzcyA/ICJ1aS1jb2xsYXBzaWJsZS10aGVtZWQtY29udGVudCAiIDogIiIgKSApOwoJCXVpLm9yaWdpbmFsSGVhZGluZyA9IGVsZW0uY2hpbGRyZW4oIHRoaXMub3B0aW9ucy5oZWFkaW5nICkuZmlyc3QoKSwKCQl1aS5jb250ZW50ID0gZWxlbQoJCQkud3JhcElubmVyKCAiPGRpdiAiICsKCQkJCSJjbGFzcz0ndWktY29sbGFwc2libGUtY29udGVudCAiICsKCQkJCWNvbnRlbnRUaGVtZUNsYXNzICsgIic+PC9kaXY+IiApCgkJCS5jaGlsZHJlbiggIi51aS1jb2xsYXBzaWJsZS1jb250ZW50IiApLAoJCXVpLmhlYWRpbmcgPSB1aS5vcmlnaW5hbEhlYWRpbmc7CgoJCS8vIFJlcGxhY2UgY29sbGFwc2libGVIZWFkaW5nIGlmIGl0J3MgYSBsZWdlbmQKCQlpZiAoIHVpLmhlYWRpbmcuaXMoICJsZWdlbmQiICkgKSB7CgkJCXVpLmhlYWRpbmcgPSAkKCAiPGRpdiByb2xlPSdoZWFkaW5nJz4iKyB1aS5oZWFkaW5nLmh0bWwoKSArIjwvZGl2PiIgKTsKCQkJdWkucGxhY2Vob2xkZXIgPSAkKCAiPGRpdj48IS0tIHBsYWNlaG9sZGVyIGZvciBsZWdlbmQgLS0+PC9kaXY+IiApLmluc2VydEJlZm9yZSggdWkub3JpZ2luYWxIZWFkaW5nICk7CgkJCXVpLm9yaWdpbmFsSGVhZGluZy5yZW1vdmUoKTsKCQl9CgoJCWljb25jbGFzcyA9ICggb3B0cy5jb2xsYXBzZWQgPyAoIG9wdHMuY29sbGFwc2VkSWNvbiA/ICJ1aS1pY29uLSIgKyBvcHRzLmNvbGxhcHNlZEljb24gOiAiIiApOgoJCQkoIG9wdHMuZXhwYW5kZWRJY29uID8gInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uIDogIiIgKSApOwoKCQl1aS5zdGF0dXMgPSAkKCAiPHNwYW4gY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctc3RhdHVzJz48L3NwYW4+IiApOwoJCXVpLmFuY2hvciA9IHVpLmhlYWRpbmcKCQkJLmRldGFjaCgpCgkJCS8vbW9kaWZ5IG1hcmt1cCAmIGF0dHJpYnV0ZXMKCQkJLmFkZENsYXNzKCAidWktY29sbGFwc2libGUtaGVhZGluZyIgKQoJCQkuYXBwZW5kKCB1aS5zdGF0dXMgKQoJCQkud3JhcElubmVyKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWNvbGxhcHNpYmxlLWhlYWRpbmctdG9nZ2xlJz48L2E+IiApCgkJCS5maW5kKCAiYSIgKQoJCQkJLmZpcnN0KCkKCQkJCS5hZGRDbGFzcyggInVpLWJ0biAiICsKCQkJCQkoIGljb25jbGFzcyA/IGljb25jbGFzcyArICIgIiA6ICIiICkgKwoJCQkJCSggaWNvbmNsYXNzID8gKCAidWktYnRuLWljb24tIiArCgkJCQkJCSggb3B0cy5pY29ucG9zID09PSAicmlnaHQiID8gInJpZ2h0IiA6ICJsZWZ0IiApICkgKwoJCQkJCQkiICIgOiAiIiApICsKCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJ0bi0iLCBvcHRzLnRoZW1lICkgKyAiICIgKwoJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKTsKCgkJLy9kcm9wIGhlYWRpbmcgaW4gYmVmb3JlIGNvbnRlbnQKCQl1aS5oZWFkaW5nLmluc2VydEJlZm9yZSggdWkuY29udGVudCApOwoKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggdGhpcy5vcHRpb25zLmNvbGxhcHNlZCApOwoKCQlyZXR1cm4gdWk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBrZXksIG9wdGlvbnMgPSB7fTsKCgkJZm9yICgga2V5IGluICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICkgewoJCQlvcHRpb25zWyBrZXkgXSA9IHRoaXMub3B0aW9uc1sga2V5IF07CgkJfQoKCQl0aGlzLl9zZXRPcHRpb25zKCBvcHRpb25zICk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaXNDb2xsYXBzZWQsIG5ld1RoZW1lLCBvbGRUaGVtZSwgaGFzQ29ybmVycywKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJY3VycmVudE9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKSwKCQkJdWkgPSB0aGlzLl91aSwKCQkJYW5jaG9yID0gdWkuYW5jaG9yLAoJCQlzdGF0dXMgPSB1aS5zdGF0dXMsCgkJCW9wdHMgPSB0aGlzLl9nZXRPcHRpb25zKCBvcHRpb25zICk7CgoJCS8vIEZpcnN0IGFuZCBmb3JlbW9zdCB3ZSBuZWVkIHRvIG1ha2Ugc3VyZSB0aGUgY29sbGFwc2libGUgaXMgaW4gdGhlIHByb3BlcgoJCS8vIHN0YXRlLCBpbiBjYXNlIHNvbWVib2R5IGRlY2lkZWQgdG8gY2hhbmdlIHRoZSBjb2xsYXBzZWQgb3B0aW9uIGF0IHRoZQoJCS8vIHNhbWUgdGltZSBhcyBhbm90aGVyIG9wdGlvbgoJCWlmICggb3B0aW9ucy5jb2xsYXBzZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5faGFuZGxlRXhwYW5kQ29sbGFwc2UoIG9wdGlvbnMuY29sbGFwc2VkICk7CgkJfQoKCQlpc0NvbGxhcHNlZCA9IGVsZW0uaGFzQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiICk7CgoJCS8vIE9ubHkgb3B0aW9ucyByZWZlcnJpbmcgdG8gdGhlIGN1cnJlbnQgc3RhdGUgbmVlZCB0byBiZSBhcHBsaWVkIHJpZ2h0IGF3YXkKCQkvLyBJdCBpcyBlbm91Z2ggdG8gc3RvcmUgb3B0aW9ucyBjb3ZlcmluZyB0aGUgYWx0ZXJuYXRlIGluIHRoaXMub3B0aW9ucy4KCQlpZiAoIGlzQ29sbGFwc2VkICkgewoJCQlpZiAoIG9wdHMuZXhwYW5kQ3VlVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQkJc3RhdHVzLnRleHQoIG9wdHMuZXhwYW5kQ3VlVGV4dCApOwoJCQl9CgkJCWlmICggb3B0cy5jb2xsYXBzZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktaWNvbi0iICsgY3VycmVudE9wdHMuY29sbGFwc2VkSWNvbiApOwoJCQkJfQoJCQkJaWYgKCBvcHRzLmNvbGxhcHNlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uICk7CgkJCQl9CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIG9wdHMuY29sbGFwc2VDdWVUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQlzdGF0dXMudGV4dCggb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQkJfQoJCQlpZiAoIG9wdHMuZXhwYW5kZWRJY29uICE9PSB1bmRlZmluZWQgKSB7CgkJCQlpZiAoIGN1cnJlbnRPcHRzLmV4cGFuZGVkSWNvbiApIHsKCQkJCQlhbmNob3IucmVtb3ZlQ2xhc3MoICJ1aS1pY29uLSIgKyBjdXJyZW50T3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJCWlmICggb3B0cy5leHBhbmRlZEljb24gKSB7CgkJCQkJYW5jaG9yLmFkZENsYXNzKCAidWktaWNvbi0iICsgb3B0cy5leHBhbmRlZEljb24gKTsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCBvcHRzLmljb25wb3MgIT09IHVuZGVmaW5lZCApIHsKCQkJYW5jaG9yLnJlbW92ZUNsYXNzKCAidWktYnRuLWljb24tIiArICggY3VycmVudE9wdHMuaWNvblBvcyA9PT0gInJpZ2h0IiA/ICJyaWdodCIgOiAibGVmdCIgKSApOwoJCQlhbmNob3IuYWRkQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgKCBvcHRzLmljb25Qb3MgPT09ICJyaWdodCIgPyAicmlnaHQiIDogImxlZnQiICkgKTsKCQl9CgoJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvbGRUaGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYnRuLSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1idG4tIiwgb3B0cy50aGVtZSApOwoJCQlhbmNob3IucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJfQoKCQlpZiAoIG9wdHMuY29udGVudFRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCW9sZFRoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIGN1cnJlbnRPcHRzLnRoZW1lICk7CgkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJdWkuY29udGVudC5yZW1vdmVDbGFzcyggb2xkVGhlbWUgKS5hZGRDbGFzcyggbmV3VGhlbWUgKTsKCQl9CgoJCWlmICggb3B0cy5pbnNldCAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29sbGFwc2libGUtaW5zZXQiLCBvcHRzLmluc2V0ICk7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5pbnNldCAmJiAoIG9wdHMuY29ybmVycyB8fCBjdXJyZW50T3B0cy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0cy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0cy5jb3JuZXJzICYmICggb3B0cy5pbnNldCB8fCBjdXJyZW50T3B0cy5pbnNldCApICk7CgkJfQoKCQlpZiAoIGhhc0Nvcm5lcnMgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCBoYXNDb3JuZXJzICk7CgkJfQoKCQlpZiAoIG9wdHMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlhbmNob3IudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgb3B0cy5taW5pICk7CgkJfQoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfaGFuZGxlRXhwYW5kQ29sbGFwc2U6IGZ1bmN0aW9uKCBpc0NvbGxhcHNlICkgewoJCXZhciBvcHRzID0gdGhpcy5fZ2V0T3B0aW9ucyggdGhpcy5vcHRpb25zICksCgkJCXVpID0gdGhpcy5fdWk7CgoJCXVpLnN0YXR1cy50ZXh0KCBpc0NvbGxhcHNlID8gb3B0cy5leHBhbmRDdWVUZXh0IDogb3B0cy5jb2xsYXBzZUN1ZVRleHQgKTsKCQl1aS5oZWFkaW5nCgkJCS50b2dnbGVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmctY29sbGFwc2VkIiwgaXNDb2xsYXBzZSApCgkJCS5maW5kKCAiYSIgKS5maXJzdCgpCgkJCS50b2dnbGVDbGFzcyggInVpLWljb24tIiArIG9wdHMuZXhwYW5kZWRJY29uLCAhaXNDb2xsYXBzZSApCgoJCQkvLyBsb2dpYyBvciBjYXVzZSBzYW1lIGljb24gZm9yIGV4cGFuZGVkL2NvbGxhcHNlZCBzdGF0ZSB3b3VsZCByZW1vdmUgdGhlIHVpLWljb24tY2xhc3MKCQkJLnRvZ2dsZUNsYXNzKCAidWktaWNvbi0iICsgb3B0cy5jb2xsYXBzZWRJY29uLCAoIGlzQ29sbGFwc2UgfHwgb3B0cy5leHBhbmRlZEljb24gPT09IG9wdHMuY29sbGFwc2VkSWNvbiApICkKCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoKCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQiLCBpc0NvbGxhcHNlICk7CgkJdWkuY29udGVudAoJCQkudG9nZ2xlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1jb250ZW50LWNvbGxhcHNlZCIsIGlzQ29sbGFwc2UgKQoJCQkuYXR0ciggImFyaWEtaGlkZGVuIiwgaXNDb2xsYXBzZSApCgkJCS50cmlnZ2VyKCAidXBkYXRlbGF5b3V0IiApOwoJCXRoaXMub3B0aW9ucy5jb2xsYXBzZWQgPSBpc0NvbGxhcHNlOwoJCXRoaXMuX3RyaWdnZXIoIGlzQ29sbGFwc2UgPyAiY29sbGFwc2UiIDogImV4cGFuZCIgKTsKCX0sCgoJZXhwYW5kOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9oYW5kbGVFeHBhbmRDb2xsYXBzZSggZmFsc2UgKTsKCX0sCgoJY29sbGFwc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX2hhbmRsZUV4cGFuZENvbGxhcHNlKCB0cnVlICk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgdWkgPSB0aGlzLl91aSwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHVpLnBsYWNlaG9sZGVyICkgewoJCQl1aS5vcmlnaW5hbEhlYWRpbmcuaW5zZXJ0QmVmb3JlKCB1aS5wbGFjZWhvbGRlciApOwoJCQl1aS5wbGFjZWhvbGRlci5yZW1vdmUoKTsKCQkJdWkuaGVhZGluZy5yZW1vdmUoKTsKCQl9IGVsc2UgewoJCQl1aS5zdGF0dXMucmVtb3ZlKCk7CgkJCXVpLmhlYWRpbmcKCQkJCS5yZW1vdmVDbGFzcyggInVpLWNvbGxhcHNpYmxlLWhlYWRpbmcgdWktY29sbGFwc2libGUtaGVhZGluZy1jb2xsYXBzZWQiICkKCQkJCS5jaGlsZHJlbigpCgkJCQkJLmNvbnRlbnRzKCkKCQkJCQkJLnVud3JhcCgpOwoJCX0KCgkJdWkuYW5jaG9yLmNvbnRlbnRzKCkudW53cmFwKCk7CgkJdWkuY29udGVudC5jb250ZW50cygpLnVud3JhcCgpOwoJCXRoaXMuZWxlbWVudAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZSB1aS1jb2xsYXBzaWJsZS1jb2xsYXBzZWQgIiArCgkJCQkidWktY29sbGFwc2libGUtdGhlbWVkLWNvbnRlbnQgdWktY29sbGFwc2libGUtaW5zZXQgdWktY29ybmVyLWFsbCIgKTsKCX0KfSk7CgovLyBEZWZhdWx0cyB0byBiZSB1c2VkIGJ5IGFsbCBpbnN0YW5jZXMgb2YgY29sbGFwc2libGUgaWYgcGVyLWluc3RhbmNlIHZhbHVlcwovLyBhcmUgdW5zZXQgb3IgaWYgbm90aGluZyBpcyBzcGVjaWZpZWQgYnkgd2F5IG9mIGluaGVyaXRhbmNlIGZyb20gYW4gYWNjb3JkaW9uLgovLyBOb3RlIHRoYXQgdGhpcyBoYXNoIGRvZXMgbm90IGNvbnRhaW4gb3B0aW9ucyAiY29sbGFwc2VkIiBvciAiaGVhZGluZyIsCi8vIGJlY2F1c2UgdGhvc2UgYXJlIG5vdCBpbmhlcml0YWJsZS4KJC5tb2JpbGUuY29sbGFwc2libGUuZGVmYXVsdHMgPSB7CglleHBhbmRDdWVUZXh0OiAiIGNsaWNrIHRvIGV4cGFuZCBjb250ZW50cyIsCgljb2xsYXBzZUN1ZVRleHQ6ICIgY2xpY2sgdG8gY29sbGFwc2UgY29udGVudHMiLAoJY29sbGFwc2VkSWNvbjogInBsdXMiLAoJY29udGVudFRoZW1lOiAiaW5oZXJpdCIsCglleHBhbmRlZEljb246ICJtaW51cyIsCglpY29ucG9zOiAibGVmdCIsCglpbnNldDogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCgl0aGVtZTogImluaGVyaXQiLAoJbWluaTogZmFsc2UKfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgPSB7CglfZ2V0VmlzaWJsZXM6IGZ1bmN0aW9uKCAkZWxzLCBjcmVhdGUgKSB7CgkJdmFyIHZpc2libGVzOwoKCQlpZiAoIGNyZWF0ZSApIHsKCQkJdmlzaWJsZXMgPSAkZWxzLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoJCX0gZWxzZSB7CgkJCXZpc2libGVzID0gJGVscy5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJaWYgKCB2aXNpYmxlcy5sZW5ndGggPT09IDAgKSB7CgkJCQl2aXNpYmxlcyA9ICRlbHMubm90KCAiLnVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCX0KCQl9CgoJCXJldHVybiB2aXNpYmxlczsKCX0sCgoJX2FkZEZpcnN0TGFzdENsYXNzZXM6IGZ1bmN0aW9uKCAkZWxzLCAkdmlzaWJsZXMsIGNyZWF0ZSApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCQkkdmlzaWJsZXMuZXEoIDAgKS5hZGRDbGFzcyggInVpLWZpcnN0LWNoaWxkIiApLmVuZCgpLmxhc3QoKS5hZGRDbGFzcyggInVpLWxhc3QtY2hpbGQiICk7CgkJaWYgKCAhY3JlYXRlICkgewoJCQl0aGlzLmVsZW1lbnQudHJpZ2dlciggInVwZGF0ZWxheW91dCIgKTsKCQl9Cgl9LAoKCV9yZW1vdmVGaXJzdExhc3RDbGFzc2VzOiBmdW5jdGlvbiggJGVscyApIHsKCQkkZWxzLnJlbW92ZUNsYXNzKCAidWktZmlyc3QtY2hpbGQgdWktbGFzdC1jaGlsZCIgKTsKCX0KfTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgPSAiOm1vYmlsZS1jb2xsYXBzaWJsZSwgIiArICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvcjsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbGxhcHNpYmxlc2V0IiwgJC5leHRlbmQoIHsKCgkvLyBUaGUgaW5pdFNlbGVjdG9yIGlzIGRlcHJlY2F0ZWQgYXMgb2YgMS40LjAuIEluIDEuNS4wIHdlIHdpbGwgdXNlCgkvLyA6anFtRGF0YShyb2xlPSdjb2xsYXBzaWJsZXNldCcpIHdoaWNoIHdpbGwgYWxsb3cgdXMgdG8gZ2V0IHJpZCBvZiB0aGUgbGluZQoJLy8gYmVsb3cgYWx0b2dldGhlciwgYmVjYXVzZSB0aGUgYXV0b2luaXQgd2lsbCBnZW5lcmF0ZSBzdWNoIGFuIGluaXRTZWxlY3RvcgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JyksOmpxbURhdGEocm9sZT0nY29sbGFwc2libGVzZXQnKSIsCgoJb3B0aW9uczogJC5leHRlbmQoIHsKCQllbmhhbmNlZDogZmFsc2UKCX0sICQubW9iaWxlLmNvbGxhcHNpYmxlLmRlZmF1bHRzICksCgoJX2hhbmRsZUNvbGxhcHNpYmxlRXhwYW5kOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGNsb3Nlc3RDb2xsYXBzaWJsZSA9ICQoIGV2ZW50LnRhcmdldCApLmNsb3Nlc3QoICIudWktY29sbGFwc2libGUiICk7CgoJCWlmICggY2xvc2VzdENvbGxhcHNpYmxlLnBhcmVudCgpLmlzKCAiOm1vYmlsZS1jb2xsYXBzaWJsZXNldCwgOmpxbURhdGEocm9sZT0nY29sbGFwc2libGUtc2V0JykiICkgKSB7CgkJCWNsb3Nlc3RDb2xsYXBzaWJsZQoJCQkJLnNpYmxpbmdzKCAiLnVpLWNvbGxhcHNpYmxlOm5vdCgudWktY29sbGFwc2libGUtY29sbGFwc2VkKSIgKQoJCQkJLmNvbGxhcHNpYmxlKCAiY29sbGFwc2UiICk7CgkJfQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9uczsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX2NsYXNzZXM6ICIiCgkJfSk7CgoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCWVsZW0uYWRkQ2xhc3MoICJ1aS1jb2xsYXBzaWJsZS1zZXQgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdHMudGhlbWUgKSArICIgIiArCgkJCQkoIG9wdHMuY29ybmVycyAmJiBvcHRzLmluc2V0ID8gInVpLWNvcm5lci1hbGwgIiA6ICIiICkgKTsKCQkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLmNvbGxhcHNpYmxlKCk7CgkJfQoKCQl0aGlzLl9vbiggZWxlbSwgeyBjb2xsYXBzaWJsZWV4cGFuZDogIl9oYW5kbGVDb2xsYXBzaWJsZUV4cGFuZCIgfSApOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiBwcmVmaXggKyB2YWx1ZSApIDogIiIgKTsKCX0sCgoJX2luaXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCgkJLy8gQmVjYXVzZSB0aGUgY29ybmVycyBhcmUgaGFuZGxlZCBieSB0aGUgY29sbGFwc2libGUgaXRzZWxmIGFuZCB0aGUgZGVmYXVsdCBzdGF0ZSBpcyBjb2xsYXBzZWQKCQkvLyBUaGF0IHdhcyBjYXVzaW5nIGh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDExNgoJCXRoaXMuZWxlbWVudAoJCQkuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKQoJCQkuZmlsdGVyKCAiOmpxbURhdGEoY29sbGFwc2VkPSdmYWxzZScpIiApCgkJCS5jb2xsYXBzaWJsZSggImV4cGFuZCIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciByZXQsIGhhc0Nvcm5lcnMsCgkJCWVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCXRoZW1lQ2xhc3MgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIG9wdGlvbnMudGhlbWUgKTsKCgkJaWYgKCB0aGVtZUNsYXNzICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktZ3JvdXAtdGhlbWUtIiwgdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGVtZUNsYXNzICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaW5zZXQgIT09IHVuZGVmaW5lZCApIHsKCQkJaGFzQ29ybmVycyA9ICEhKCBvcHRpb25zLmluc2V0ICYmICggb3B0aW9ucy5jb3JuZXJzIHx8IHRoaXMub3B0aW9ucy5jb3JuZXJzICkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWhhc0Nvcm5lcnMgPSAhISggb3B0aW9ucy5jb3JuZXJzICYmICggb3B0aW9ucy5pbnNldCB8fCB0aGlzLm9wdGlvbnMuaW5zZXQgKSApOwoJCX0KCgkJaWYgKCBoYXNDb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCWVsZW0udG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgaGFzQ29ybmVycyApOwoJCX0KCgkJcmV0ID0gdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICI6bW9iaWxlLWNvbGxhcHNpYmxlIiApLmNvbGxhcHNpYmxlKCAicmVmcmVzaCIgKTsKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsID0gdGhpcy5lbGVtZW50OwoKCQl0aGlzLl9yZW1vdmVGaXJzdExhc3RDbGFzc2VzKCBlbC5jaGlsZHJlbiggY2hpbGRDb2xsYXBzaWJsZXNTZWxlY3RvciApICk7CgkJZWwKCQkJLnJlbW92ZUNsYXNzKCAidWktY29sbGFwc2libGUtc2V0IHVpLWNvcm5lci1hbGwgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWdyb3VwLXRoZW1lLSIsIHRoaXMub3B0aW9ucy50aGVtZSApICkKCQkJLmNoaWxkcmVuKCAiOm1vYmlsZS1jb2xsYXBzaWJsZSIgKQoJCQkuY29sbGFwc2libGUoICJkZXN0cm95IiApOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgY29sbGFwc2libGVzSW5TZXQgPSB0aGlzLmVsZW1lbnQuY2hpbGRyZW4oIGNoaWxkQ29sbGFwc2libGVzU2VsZWN0b3IgKTsKCgkJdGhpcy5lbGVtZW50LmZpbmQoICQubW9iaWxlLmNvbGxhcHNpYmxlLmluaXRTZWxlY3RvciApLm5vdCggIi51aS1jb2xsYXBzaWJsZSIgKS5jb2xsYXBzaWJsZSgpOwoKCQl0aGlzLl9hZGRGaXJzdExhc3RDbGFzc2VzKCBjb2xsYXBzaWJsZXNJblNldCwgdGhpcy5fZ2V0VmlzaWJsZXMoIGNvbGxhcHNpYmxlc0luU2V0LCBjcmVhdGUgKSwgY3JlYXRlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2goIGZhbHNlICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gRGVwcmVjYXRlZCBpbiAxLjQKJC5mbi5maWVsZGNvbnRhaW4gPSBmdW5jdGlvbigvKiBvcHRpb25zICovKSB7CglyZXR1cm4gdGhpcy5hZGRDbGFzcyggInVpLWZpZWxkLWNvbnRhaW4iICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQuZm4uZ3JpZCA9IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJcmV0dXJuIHRoaXMuZWFjaChmdW5jdGlvbigpIHsKCgkJdmFyICR0aGlzID0gJCggdGhpcyApLAoJCQlvID0gJC5leHRlbmQoewoJCQkJZ3JpZDogbnVsbAoJCQl9LCBvcHRpb25zICksCgkJCSRraWRzID0gJHRoaXMuY2hpbGRyZW4oKSwKCQkJZ3JpZENvbHMgPSB7IHNvbG86MSwgYToyLCBiOjMsIGM6NCwgZDo1IH0sCgkJCWdyaWQgPSBvLmdyaWQsCgkJCWl0ZXJhdG9yLAoJCQlsZXR0ZXI7CgoJCQlpZiAoICFncmlkICkgewoJCQkJaWYgKCAka2lkcy5sZW5ndGggPD0gNSApIHsKCQkJCQlmb3IgKCBsZXR0ZXIgaW4gZ3JpZENvbHMgKSB7CgkJCQkJCWlmICggZ3JpZENvbHNbIGxldHRlciBdID09PSAka2lkcy5sZW5ndGggKSB7CgkJCQkJCQlncmlkID0gbGV0dGVyOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlncmlkID0gImEiOwoJCQkJCSR0aGlzLmFkZENsYXNzKCAidWktZ3JpZC1kdW8iICk7CgkJCQl9CgkJCX0KCQkJaXRlcmF0b3IgPSBncmlkQ29sc1tncmlkXTsKCgkJJHRoaXMuYWRkQ2xhc3MoICJ1aS1ncmlkLSIgKyBncmlkICk7CgoJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rMSkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1hIiApOwoKCQlpZiAoIGl0ZXJhdG9yID4gMSApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibisyKSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWIiICk7CgkJfQoJCWlmICggaXRlcmF0b3IgPiAyICkgewoJCQkka2lkcy5maWx0ZXIoICI6bnRoLWNoaWxkKCIgKyBpdGVyYXRvciArICJuKzMpIiApLmFkZENsYXNzKCAidWktYmxvY2stYyIgKTsKCQl9CgkJaWYgKCBpdGVyYXRvciA+IDMgKSB7CgkJCSRraWRzLmZpbHRlciggIjpudGgtY2hpbGQoIiArIGl0ZXJhdG9yICsgIm4rNCkiICkuYWRkQ2xhc3MoICJ1aS1ibG9jay1kIiApOwoJCX0KCQlpZiAoIGl0ZXJhdG9yID4gNCApIHsKCQkJJGtpZHMuZmlsdGVyKCAiOm50aC1jaGlsZCgiICsgaXRlcmF0b3IgKyAibis1KSIgKS5hZGRDbGFzcyggInVpLWJsb2NrLWUiICk7CgkJfQoJfSk7Cn07Cn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUubmF2YmFyIiwgewoJb3B0aW9uczogewoJCWljb25wb3M6ICJ0b3AiLAoJCWdyaWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciAkbmF2YmFyID0gdGhpcy5lbGVtZW50LAoJCQkkbmF2YnRucyA9ICRuYXZiYXIuZmluZCggImEiICksCgkJCWljb25wb3MgPSAkbmF2YnRucy5maWx0ZXIoICI6anFtRGF0YShpY29uKSIgKS5sZW5ndGggPyB0aGlzLm9wdGlvbnMuaWNvbnBvcyA6IHVuZGVmaW5lZDsKCgkJJG5hdmJhci5hZGRDbGFzcyggInVpLW5hdmJhciIgKQoJCQkuYXR0ciggInJvbGUiLCAibmF2aWdhdGlvbiIgKQoJCQkuZmluZCggInVsIiApCgkJCS5qcW1FbmhhbmNlYWJsZSgpCgkJCS5ncmlkKHsgZ3JpZDogdGhpcy5vcHRpb25zLmdyaWQgfSk7CgoJCSRuYXZidG5zCgkJCS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJCXZhciBpY29uID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAiaWNvbiIgKSwKCQkJCQl0aGVtZSA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgInRoZW1lIiApLAoJCQkJCWNsYXNzZXMgPSAidWktYnRuIjsKCgkJCQlpZiAoIHRoZW1lICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1idG4tIiArIHRoZW1lOwoJCQkJfQoJCQkJaWYgKCBpY29uICkgewoJCQkJCWNsYXNzZXMgKz0gIiB1aS1pY29uLSIgKyBpY29uICsgIiB1aS1idG4taWNvbi0iICsgaWNvbnBvczsKCQkJCX0KCQkJCSQoIHRoaXMgKS5hZGRDbGFzcyggY2xhc3NlcyApOwoJCQl9KTsKCgkJJG5hdmJhci5kZWxlZ2F0ZSggImEiLCAidmNsaWNrIiwgZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCQl2YXIgYWN0aXZlQnRuID0gJCggdGhpcyApOwoKCQkJaWYgKCAhKCBhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoKCQkJCS8vIERFUFJFQ0FURUQgYXMgb2YgMS40LjAgLSByZW1vdmUgYWZ0ZXIgMS40LjAgcmVsZWFzZQoJCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCQlhY3RpdmVCdG4uaGFzQ2xhc3MoICJ1aS1kaXNhYmxlZCIgKSB8fAoJCQkJYWN0aXZlQnRuLmhhc0NsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApICkgKSB7CgoJCQkJJG5hdmJ0bnMucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCQlhY3RpdmVCdG4uYWRkQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgoJCQkJLy8gVGhlIGNvZGUgYmVsb3cgaXMgYSB3b3JrYXJvdW5kIHRvIGZpeCAjMTE4MQoJCQkJJCggZG9jdW1lbnQgKS5vbmUoICJwYWdlaGlkZSIsIGZ1bmN0aW9uKCkgewoJCQkJCWFjdGl2ZUJ0bi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJfSk7CgoJCS8vIEJ1dHRvbnMgaW4gdGhlIG5hdmJhciB3aXRoIHVpLXN0YXRlLXBlcnNpc3QgY2xhc3Mgc2hvdWxkIHJlZ2FpbiB0aGVpciBhY3RpdmUgc3RhdGUgYmVmb3JlIHBhZ2Ugc2hvdwoJCSRuYXZiYXIuY2xvc2VzdCggIi51aS1wYWdlIiApLmJpbmQoICJwYWdlYmVmb3Jlc2hvdyIsIGZ1bmN0aW9uKCkgewoJCQkkbmF2YnRucy5maWx0ZXIoICIudWktc3RhdGUtcGVyc2lzdCIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQl9KTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciBnZXRBdHRyID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlOwoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLmV4dGVuZCggewoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3VudFRoZW1lOiBudWxsLCAvKiBEZXByZWNhdGVkIGluIDEuNCAqLwoJCWRpdmlkZXJUaGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtciIsCgkJc3BsaXRJY29uOiAiY2FyYXQtciIsCgkJc3BsaXRUaGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbnNldDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHQgPSB0aGlzLAoJCQlsaXN0dmlld0NsYXNzZXMgPSAiIjsKCgkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5pbnNldCA/ICIgdWktbGlzdHZpZXctaW5zZXQiIDogIiI7CgoJCWlmICggISF0Lm9wdGlvbnMuaW5zZXQgKSB7CgkJCWxpc3R2aWV3Q2xhc3NlcyArPSB0Lm9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIjsKCQkJbGlzdHZpZXdDbGFzc2VzICs9IHQub3B0aW9ucy5zaGFkb3cgPyAiIHVpLXNoYWRvdyIgOiAiIjsKCQl9CgoJCS8vIGNyZWF0ZSBsaXN0dmlldyBtYXJrdXAKCQl0LmVsZW1lbnQuYWRkQ2xhc3MoICIgdWktbGlzdHZpZXciICsgbGlzdHZpZXdDbGFzc2VzICk7CgoJCXQucmVmcmVzaCggdHJ1ZSApOwoJfSwKCgkvLyBUT0RPOiBSZW1vdmUgaW4gMS41CglfZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZTogZnVuY3Rpb24oIGVsZSwgbmV4dFByb3AsIGxjTmFtZSwgdWNOYW1lICkgewoJCXZhciBkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXR1cm4gZWxlOwoJCQl9CgkJCWVsZSA9IGVsZVsgbmV4dFByb3AgXTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoJLy8gVE9ETzogUmVtb3ZlIGluIDEuNQoJX2FkZFRodW1iQ2xhc3NlczogZnVuY3Rpb24oIGNvbnRhaW5lcnMgKSB7CgkJdmFyIGksIGltZywgbGVuID0gY29udGFpbmVycy5sZW5ndGg7CgkJZm9yICggaSA9IDA7IGkgPCBsZW47IGkrKyApIHsKCQkJaW1nID0gJCggdGhpcy5fZmluZEZpcnN0RWxlbWVudEJ5VGFnTmFtZSggY29udGFpbmVyc1sgaSBdLmZpcnN0Q2hpbGQsICJuZXh0U2libGluZyIsICJpbWciLCAiSU1HIiApICk7CgkJCWlmICggaW1nLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuX2ZpbmRGaXJzdEVsZW1lbnRCeVRhZ05hbWUoIGltZ1sgMCBdLnBhcmVudE5vZGUsICJwYXJlbnROb2RlIiwgImxpIiwgIkxJIiApICkuYWRkQ2xhc3MoIGltZy5oYXNDbGFzcyggInVpLWxpLWljb24iICkgPyAidWktbGktaGFzLWljb24iIDogInVpLWxpLWhhcy10aHVtYiIgKTsKCQkJfQoJCX0KCX0sCgoJX2dldENoaWxkcmVuQnlUYWdOYW1lOiBmdW5jdGlvbiggZWxlLCBsY05hbWUsIHVjTmFtZSApIHsKCQl2YXIgcmVzdWx0cyA9IFtdLAoJCQlkaWN0ID0ge307CgkJZGljdFsgbGNOYW1lIF0gPSBkaWN0WyB1Y05hbWUgXSA9IHRydWU7CgkJZWxlID0gZWxlLmZpcnN0Q2hpbGQ7CgkJd2hpbGUgKCBlbGUgKSB7CgkJCWlmICggZGljdFsgZWxlLm5vZGVOYW1lIF0gKSB7CgkJCQlyZXN1bHRzLnB1c2goIGVsZSApOwoJCQl9CgkJCWVsZSA9IGVsZS5uZXh0U2libGluZzsKCQl9CgkJcmV0dXJuICQoIHJlc3VsdHMgKTsKCX0sCgoJX2JlZm9yZUxpc3R2aWV3UmVmcmVzaDogJC5ub29wLAoJX2FmdGVyTGlzdHZpZXdSZWZyZXNoOiAkLm5vb3AsCgoJcmVmcmVzaDogZnVuY3Rpb24oIGNyZWF0ZSApIHsKCQl2YXIgYnV0dG9uQ2xhc3MsIHBvcywgbnVtbGksIGl0ZW0sIGl0ZW1DbGFzcywgaXRlbVRoZW1lLCBpdGVtSWNvbiwgaWNvbiwgYSwKCQkJaXNEaXZpZGVyLCBzdGFydENvdW50LCBuZXdTdGFydENvdW50LCB2YWx1ZSwgbGFzdCwgc3BsaXR0aGVtZSwgc3BsaXRUaGVtZUNsYXNzLCBzcGxpdGljb24sCgkJCWFsdEJ1dHRvbkNsYXNzLCBkaXZpZGVyVGhlbWUsIGxpLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQkkbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJb2wgPSAhISQubm9kZU5hbWUoICRsaXN0WyAwIF0sICJvbCIgKSwKCQkJc3RhcnQgPSAkbGlzdC5hdHRyKCAic3RhcnQiICksCgkJCWl0ZW1DbGFzc0RpY3QgPSB7fSwKCQkJY291bnRCdWJibGVzID0gJGxpc3QuZmluZCggIi51aS1saS1jb3VudCIgKSwKCQkJY291bnRUaGVtZSA9IGdldEF0dHIoICRsaXN0WyAwIF0sICJjb3VudHRoZW1lIiApIHx8IHRoaXMub3B0aW9ucy5jb3VudFRoZW1lLAoJCQljb3VudFRoZW1lQ2xhc3MgPSBjb3VudFRoZW1lID8gInVpLWJvZHktIiArIGNvdW50VGhlbWUgOiAidWktYm9keS1pbmhlcml0IjsKCgkJaWYgKCBvLnRoZW1lICkgewoJCQkkbGlzdC5hZGRDbGFzcyggInVpLWdyb3VwLXRoZW1lLSIgKyBvLnRoZW1lICk7CgkJfQoKCQkvLyBDaGVjayBpZiBhIHN0YXJ0IGF0dHJpYnV0ZSBoYXMgYmVlbiBzZXQgd2hpbGUgdGFraW5nIGEgdmFsdWUgb2YgMCBpbnRvIGFjY291bnQKCQlpZiAoIG9sICYmICggc3RhcnQgfHwgc3RhcnQgPT09IDAgKSApIHsKCQkJc3RhcnRDb3VudCA9IHBhcnNlSW50KCBzdGFydCwgMTAgKSAtIDE7CgkJCSRsaXN0LmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgc3RhcnRDb3VudCApOwoJCX0KCgkJdGhpcy5fYmVmb3JlTGlzdHZpZXdSZWZyZXNoKCk7CgoJCWxpID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoICRsaXN0WyAwIF0sICJsaSIsICJMSSIgKTsKCgkJZm9yICggcG9zID0gMCwgbnVtbGkgPSBsaS5sZW5ndGg7IHBvcyA8IG51bWxpOyBwb3MrKyApIHsKCQkJaXRlbSA9IGxpLmVxKCBwb3MgKTsKCQkJaXRlbUNsYXNzID0gIiI7CgoJCQlpZiAoIGNyZWF0ZSB8fCBpdGVtWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktbGktc3RhdGljXGJ8XGJ1aS1saS1kaXZpZGVyXGIvICkgPCAwICkgewoJCQkJYSA9IHRoaXMuX2dldENoaWxkcmVuQnlUYWdOYW1lKCBpdGVtWyAwIF0sICJhIiwgIkEiICk7CgkJCQlpc0RpdmlkZXIgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInJvbGUiICkgPT09ICJsaXN0LWRpdmlkZXIiICk7CgkJCQl2YWx1ZSA9IGl0ZW0uYXR0ciggInZhbHVlIiApOwoJCQkJaXRlbVRoZW1lID0gZ2V0QXR0ciggaXRlbVsgMCBdLCAidGhlbWUiICk7CgoJCQkJaWYgKCBhLmxlbmd0aCAmJiBhWyAwIF0uY2xhc3NOYW1lLnNlYXJjaCggL1xidWktYnRuXGIvICkgPCAwICYmICFpc0RpdmlkZXIgKSB7CgkJCQkJaXRlbUljb24gPSBnZXRBdHRyKCBpdGVtWyAwIF0sICJpY29uIiApOwoJCQkJCWljb24gPSAoIGl0ZW1JY29uID09PSBmYWxzZSApID8gZmFsc2UgOiAoIGl0ZW1JY29uIHx8IG8uaWNvbiApOwoKCQkJCQkvLyBUT0RPOiBSZW1vdmUgaW4gMS41IHRvZ2V0aGVyIHdpdGggbGlua3MuanMgKGxpbmtzLmpzIC8gLnVpLWxpbmsgZGVwcmVjYXRlZCBpbiAxLjQpCgkJCQkJYS5yZW1vdmVDbGFzcyggInVpLWxpbmsiICk7CgoJCQkJCWJ1dHRvbkNsYXNzID0gInVpLWJ0biI7CgoJCQkJCWlmICggaXRlbVRoZW1lICkgewoJCQkJCQlidXR0b25DbGFzcyArPSAiIHVpLWJ0bi0iICsgaXRlbVRoZW1lOwoJCQkJCX0KCgkJCQkJaWYgKCBhLmxlbmd0aCA+IDEgKSB7CgkJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1oYXMtYWx0IjsKCgkJCQkJCWxhc3QgPSBhLmxhc3QoKTsKCQkJCQkJc3BsaXR0aGVtZSA9IGdldEF0dHIoIGxhc3RbIDAgXSwgInRoZW1lIiApIHx8IG8uc3BsaXRUaGVtZSB8fCBnZXRBdHRyKCBpdGVtWyAwIF0sICJ0aGVtZSIsIHRydWUgKTsKCQkJCQkJc3BsaXRUaGVtZUNsYXNzID0gc3BsaXR0aGVtZSA/ICIgdWktYnRuLSIgKyBzcGxpdHRoZW1lIDogIiI7CgkJCQkJCXNwbGl0aWNvbiA9IGdldEF0dHIoIGxhc3RbIDAgXSwgImljb24iICkgfHwgZ2V0QXR0ciggaXRlbVsgMCBdLCAiaWNvbiIgKSB8fCBvLnNwbGl0SWNvbjsKCQkJCQkJYWx0QnV0dG9uQ2xhc3MgPSAidWktYnRuIHVpLWJ0bi1pY29uLW5vdGV4dCB1aS1pY29uLSIgKyBzcGxpdGljb24gKyBzcGxpdFRoZW1lQ2xhc3M7CgoJCQkJCQlsYXN0CgkJCQkJCQkuYXR0ciggInRpdGxlIiwgJC50cmltKCBsYXN0LmdldEVuY29kZWRUZXh0KCkgKSApCgkJCQkJCQkuYWRkQ2xhc3MoIGFsdEJ1dHRvbkNsYXNzICkKCQkJCQkJCS5lbXB0eSgpOwoJCQkJCX0gZWxzZSBpZiAoIGljb24gKSB7CgkJCQkJCWJ1dHRvbkNsYXNzICs9ICIgdWktYnRuLWljb24tcmlnaHQgdWktaWNvbi0iICsgaWNvbjsKCQkJCQl9CgoJCQkJCWEuZmlyc3QoKS5hZGRDbGFzcyggYnV0dG9uQ2xhc3MgKTsKCQkJCX0gZWxzZSBpZiAoIGlzRGl2aWRlciApIHsKCQkJCQlkaXZpZGVyVGhlbWUgPSAoIGdldEF0dHIoIGl0ZW1bIDAgXSwgInRoZW1lIiApIHx8IG8uZGl2aWRlclRoZW1lIHx8IG8udGhlbWUgKTsKCgkJCQkJaXRlbUNsYXNzID0gInVpLWxpLWRpdmlkZXIgdWktYmFyLSIgKyAoIGRpdmlkZXJUaGVtZSA/IGRpdmlkZXJUaGVtZSA6ICJpbmhlcml0IiApOwoKCQkJCQlpdGVtLmF0dHIoICJyb2xlIiwgImhlYWRpbmciICk7CgkJCQl9IGVsc2UgaWYgKCBhLmxlbmd0aCA8PSAwICkgewoJCQkJCWl0ZW1DbGFzcyA9ICJ1aS1saS1zdGF0aWMgdWktYm9keS0iICsgKCBpdGVtVGhlbWUgPyBpdGVtVGhlbWUgOiAiaW5oZXJpdCIgKTsKCQkJCX0KCQkJCWlmICggb2wgJiYgdmFsdWUgKSB7CgkJCQkJbmV3U3RhcnRDb3VudCA9IHBhcnNlSW50KCB2YWx1ZSAsIDEwICkgLSAxOwoKCQkJCQlpdGVtLmNzcyggImNvdW50ZXItcmVzZXQiLCAibGlzdG51bWJlcmluZyAiICsgbmV3U3RhcnRDb3VudCApOwoJCQkJfQoJCQl9CgoJCQkvLyBJbnN0ZWFkIG9mIHNldHRpbmcgaXRlbSBjbGFzcyBkaXJlY3RseSBvbiB0aGUgbGlzdCBpdGVtCgkJCS8vIGF0IHRoaXMgcG9pbnQgaW4gdGltZSwgcHVzaCB0aGUgaXRlbSBpbnRvIGEgZGljdGlvbmFyeQoJCQkvLyB0aGF0IHRlbGxzIHVzIHdoYXQgY2xhc3MgdG8gc2V0IG9uIGl0IHNvIHdlIGNhbiBkbyB0aGlzIGFmdGVyIHRoaXMKCQkJLy8gcHJvY2Vzc2luZyBsb29wIGlzIGZpbmlzaGVkLgoKCQkJaWYgKCAhaXRlbUNsYXNzRGljdFsgaXRlbUNsYXNzIF0gKSB7CgkJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXSA9IFtdOwoJCQl9CgoJCQlpdGVtQ2xhc3NEaWN0WyBpdGVtQ2xhc3MgXS5wdXNoKCBpdGVtWyAwIF0gKTsKCQl9CgoJCS8vIFNldCB0aGUgYXBwcm9wcmlhdGUgbGlzdHZpZXcgaXRlbSBjbGFzc2VzIG9uIGVhY2ggbGlzdCBpdGVtLgoJCS8vIFRoZSBtYWluIHJlYXNvbiB3ZSBkaWRuJ3QgZG8gdGhpcwoJCS8vIGluIHRoZSBmb3ItbG9vcCBhYm92ZSBpcyBiZWNhdXNlIHdlIGNhbiBlbGltaW5hdGUgcGVyLWl0ZW0gZnVuY3Rpb24gb3ZlcmhlYWQKCQkvLyBieSBjYWxsaW5nIGFkZENsYXNzKCkgYW5kIGNoaWxkcmVuKCkgb25jZSBvciB0d2ljZSBhZnRlcndhcmRzLiBUaGlzCgkJLy8gY2FuIGdpdmUgdXMgYSBzaWduaWZpY2FudCBib29zdCBvbiBwbGF0Zm9ybXMgbGlrZSBXUDcuNS4KCgkJZm9yICggaXRlbUNsYXNzIGluIGl0ZW1DbGFzc0RpY3QgKSB7CgkJCSQoIGl0ZW1DbGFzc0RpY3RbIGl0ZW1DbGFzcyBdICkuYWRkQ2xhc3MoIGl0ZW1DbGFzcyApOwoJCX0KCgkJY291bnRCdWJibGVzLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkkKCB0aGlzICkuY2xvc2VzdCggImxpIiApLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApOwoJCX0pOwoJCWlmICggY291bnRUaGVtZUNsYXNzICkgewoJCQljb3VudEJ1YmJsZXMuYWRkQ2xhc3MoIGNvdW50VGhlbWVDbGFzcyApOwoJCX0KCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEZyb20gMS41IHlvdSBoYXZlIHRvIGFkZCBjbGFzcyB1aS1saS1oYXMtdGh1bWIgb3IgdWktbGktaGFzLWljb24gdG8gdGhlIExJLgoJCXRoaXMuX2FkZFRodW1iQ2xhc3NlcyggbGkgKTsKCQl0aGlzLl9hZGRUaHVtYkNsYXNzZXMoIGxpLmZpbmQoICIudWktYnRuIiApICk7CgoJCXRoaXMuX2FmdGVyTGlzdHZpZXdSZWZyZXNoKCk7CgoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGxpLCB0aGlzLl9nZXRWaXNpYmxlcyggbGksIGNyZWF0ZSApLCBjcmVhdGUgKTsKCX0KfSwgJC5tb2JpbGUuYmVoYXZpb3JzLmFkZEZpcnN0TGFzdENsYXNzZXMgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgpmdW5jdGlvbiBkZWZhdWx0QXV0b2RpdmlkZXJzU2VsZWN0b3IoIGVsdCApIHsKCS8vIGxvb2sgZm9yIHRoZSB0ZXh0IGluIHRoZSBnaXZlbiBlbGVtZW50Cgl2YXIgdGV4dCA9ICQudHJpbSggZWx0LnRleHQoKSApIHx8IG51bGw7CgoJaWYgKCAhdGV4dCApIHsKCQlyZXR1cm4gbnVsbDsKCX0KCgkvLyBjcmVhdGUgdGhlIHRleHQgZm9yIHRoZSBkaXZpZGVyIChmaXJzdCB1cHBlcmNhc2VkIGxldHRlcikKCXRleHQgPSB0ZXh0LnNsaWNlKCAwLCAxICkudG9VcHBlckNhc2UoKTsKCglyZXR1cm4gdGV4dDsKfQoKJC53aWRnZXQoICJtb2JpbGUubGlzdHZpZXciLCAkLm1vYmlsZS5saXN0dmlldywgewoJb3B0aW9uczogewoJCWF1dG9kaXZpZGVyczogZmFsc2UsCgkJYXV0b2RpdmlkZXJzU2VsZWN0b3I6IGRlZmF1bHRBdXRvZGl2aWRlcnNTZWxlY3RvcgoJfSwKCglfYmVmb3JlTGlzdHZpZXdSZWZyZXNoOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnMgKSB7CgkJCXRoaXMuX3JlcGxhY2VEaXZpZGVycygpOwoJCQl0aGlzLl9zdXBlckFwcGx5KCBhcmd1bWVudHMgKTsKCQl9Cgl9LAoKCV9yZXBsYWNlRGl2aWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciBpLCBsaXMsIGxpLCBkaXZpZGVyVGV4dCwKCQkJbGFzdERpdmlkZXJUZXh0ID0gbnVsbCwKCQkJbGlzdCA9IHRoaXMuZWxlbWVudCwKCQkJZGl2aWRlcjsKCgkJbGlzdC5jaGlsZHJlbiggImxpOmpxbURhdGEocm9sZT0nbGlzdC1kaXZpZGVyJykiICkucmVtb3ZlKCk7CgoJCWxpcyA9IGxpc3QuY2hpbGRyZW4oICJsaSIgKTsKCgkJZm9yICggaSA9IDA7IGkgPCBsaXMubGVuZ3RoIDsgaSsrICkgewoJCQlsaSA9IGxpc1sgaSBdOwoJCQlkaXZpZGVyVGV4dCA9IHRoaXMub3B0aW9ucy5hdXRvZGl2aWRlcnNTZWxlY3RvciggJCggbGkgKSApOwoKCQkJaWYgKCBkaXZpZGVyVGV4dCAmJiBsYXN0RGl2aWRlclRleHQgIT09IGRpdmlkZXJUZXh0ICkgewoJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCWRpdmlkZXIuYXBwZW5kQ2hpbGQoIGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCBkaXZpZGVyVGV4dCApICk7CgkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGUiLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJbGkucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUoIGRpdmlkZXIsIGxpICk7CgkJCX0KCgkJCWxhc3REaXZpZGVyVGV4dCA9IGRpdmlkZXJUZXh0OwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCnZhciByZGl2aWRlciA9IC8oXnxccyl1aS1saS1kaXZpZGVyKCR8XHMpLywKCXJoaWRkZW4gPSAvKF58XHMpdWktc2NyZWVuLWhpZGRlbigkfFxzKS87CgokLndpZGdldCggIm1vYmlsZS5saXN0dmlldyIsICQubW9iaWxlLmxpc3R2aWV3LCB7CglvcHRpb25zOiB7CgkJaGlkZURpdmlkZXJzOiBmYWxzZQoJfSwKCglfYWZ0ZXJMaXN0dmlld1JlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciBpdGVtcywgaWR4LCBpdGVtLCBoaWRlRGl2aWRlciA9IHRydWU7CgoJCXRoaXMuX3N1cGVyQXBwbHkoIGFyZ3VtZW50cyApOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5oaWRlRGl2aWRlcnMgKSB7CgkJCWl0ZW1zID0gdGhpcy5fZ2V0Q2hpbGRyZW5CeVRhZ05hbWUoIHRoaXMuZWxlbWVudFsgMCBdLCAibGkiLCAiTEkiICk7CgkJCWZvciAoIGlkeCA9IGl0ZW1zLmxlbmd0aCAtIDEgOyBpZHggPiAtMSA7IGlkeC0tICkgewoJCQkJaXRlbSA9IGl0ZW1zWyBpZHggXTsKCQkJCWlmICggaXRlbS5jbGFzc05hbWUubWF0Y2goIHJkaXZpZGVyICkgKSB7CgkJCQkJaWYgKCBoaWRlRGl2aWRlciApIHsKCQkJCQkJaXRlbS5jbGFzc05hbWUgPSBpdGVtLmNsYXNzTmFtZSArICIgdWktc2NyZWVuLWhpZGRlbiI7CgkJCQkJfQoJCQkJCWhpZGVEaXZpZGVyID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKCAhaXRlbS5jbGFzc05hbWUubWF0Y2goIHJoaWRkZW4gKSApIHsKCQkJCQkJaGlkZURpdmlkZXIgPSBmYWxzZTsKCQkJCQl9CgkJCQl9CgkJCX0KCQl9Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5ub2pzID0gZnVuY3Rpb24oIHRhcmdldCApIHsKCSQoICI6anFtRGF0YShyb2xlPSdub2pzJykiLCB0YXJnZXQgKS5hZGRDbGFzcyggInVpLW5vanMiICk7Cn07Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgPSB7CglfaGFuZGxlRm9ybVJlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCXJlc2V0OiBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX2RlbGF5KCAiX3Jlc2V0IiApOwoJCQl9CgkJfSk7Cgl9Cn07Cgp9KSggalF1ZXJ5ICk7CgovKgoqICJjaGVja2JveHJhZGlvIiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuY2hlY2tib3hyYWRpbyIsICQuZXh0ZW5kKCB7CgoJaW5pdFNlbGVjdG9yOiAiaW5wdXQ6bm90KCA6anFtRGF0YShyb2xlPSdmbGlwc3dpdGNoJyApIClbdHlwZT0nY2hlY2tib3gnXSxpbnB1dFt0eXBlPSdyYWRpbyddOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcgKSkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogImluaGVyaXQiLAoJCW1pbmk6IGZhbHNlLAoJCXdyYXBwZXJDbGFzczogbnVsbCwKCQllbmhhbmNlZDogZmFsc2UsCgkJaWNvbnBvczogImxlZnQiCgoJfSwKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudCwKCQkJbyA9IHRoaXMub3B0aW9ucywKCQkJaW5oZXJpdEF0dHIgPSBmdW5jdGlvbiggaW5wdXQsIGRhdGFBdHRyICkgewoJCQkJcmV0dXJuIGlucHV0LmpxbURhdGEoIGRhdGFBdHRyICkgfHwKCQkJCQlpbnB1dC5jbG9zZXN0KCAiZm9ybSwgZmllbGRzZXQiICkuanFtRGF0YSggZGF0YUF0dHIgKTsKCQkJfSwKCQkJLy8gTk9URTogV2luZG93cyBQaG9uZSBjb3VsZCBub3QgZmluZCB0aGUgbGFiZWwgdGhyb3VnaCBhIHNlbGVjdG9yCgkJCS8vIGZpbHRlciB3b3JrcyB0aG91Z2guCgkJCXBhcmVudExhYmVsID0gaW5wdXQuY2xvc2VzdCggImxhYmVsIiApLAoJCQlsYWJlbCA9IHBhcmVudExhYmVsLmxlbmd0aCA/IHBhcmVudExhYmVsIDoKCQkJCWlucHV0CgkJCQkJLmNsb3Nlc3QoICJmb3JtLCBmaWVsZHNldCwgOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKQoJCQkJCS5maW5kKCAibGFiZWwiICkKCQkJCQkuZmlsdGVyKCAiW2Zvcj0nIiArICQubW9iaWxlLnBhdGguaGFzaFRvU2VsZWN0b3IoIGlucHV0WzBdLmlkICkgKyAiJ10iICkKCQkJCQkuZmlyc3QoKSwKCQkJaW5wdXR0eXBlID0gaW5wdXRbMF0udHlwZSwKCQkJY2hlY2tlZENsYXNzID0gInVpLSIgKyBpbnB1dHR5cGUgKyAiLW9uIiwKCQkJdW5jaGVja2VkQ2xhc3MgPSAidWktIiArIGlucHV0dHlwZSArICItb2ZmIjsKCgkJaWYgKCBpbnB1dHR5cGUgIT09ICJjaGVja2JveCIgJiYgaW5wdXR0eXBlICE9PSAicmFkaW8iICkgewoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIHRoaXMuZWxlbWVudFswXS5kaXNhYmxlZCApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCW8uaWNvbnBvcyA9IGluaGVyaXRBdHRyKCBpbnB1dCwgImljb25wb3MiICkgfHwgbGFiZWwuYXR0ciggImRhdGEtIiArICQubW9iaWxlLm5zICsgImljb25wb3MiICkgfHwgby5pY29ucG9zLAoKCQkvLyBFc3RhYmxpc2ggb3B0aW9ucwoJCW8ubWluaSA9IGluaGVyaXRBdHRyKCBpbnB1dCwgIm1pbmkiICkgfHwgby5taW5pOwoKCQkvLyBFeHBvc2UgZm9yIG90aGVyIG1ldGhvZHMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlpbnB1dDogaW5wdXQsCgkJCWxhYmVsOiBsYWJlbCwKCQkJcGFyZW50TGFiZWw6IHBhcmVudExhYmVsLAoJCQlpbnB1dHR5cGU6IGlucHV0dHlwZSwKCQkJY2hlY2tlZENsYXNzOiBjaGVja2VkQ2xhc3MsCgkJCXVuY2hlY2tlZENsYXNzOiB1bmNoZWNrZWRDbGFzcwoJCX0pOwoKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCBsYWJlbCwgewoJCQl2bW91c2VvdmVyOiAiX2hhbmRsZUxhYmVsVk1vdXNlT3ZlciIsCgkJCXZjbGljazogIl9oYW5kbGVMYWJlbFZDbGljayIKCQl9KTsKCgkJdGhpcy5fb24oIGlucHV0LCB7CgkJCXZtb3VzZWRvd246ICJfY2FjaGVWYWxzIiwKCQkJdmNsaWNrOiAiX2hhbmRsZUlucHV0VkNsaWNrIiwKCQkJZm9jdXM6ICJfaGFuZGxlSW5wdXRGb2N1cyIsCgkJCWJsdXI6ICJfaGFuZGxlSW5wdXRCbHVyIgoJCX0pOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICJ1aS1idG4gdWktY29ybmVyLWFsbCIpOwoKCQlpZiAoIHRoaXMucGFyZW50TGFiZWwubGVuZ3RoID4gMCApIHsKCQkJdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKTsKCQl9IGVsc2UgewoJCQkvL3RoaXMuZWxlbWVudC5yZXBsYWNlV2l0aCggdGhpcy5pbnB1dC5hZGQoIHRoaXMubGFiZWwgKS53cmFwQWxsKCB0aGlzLl93cmFwcGVyKCkgKSApOwoJCQl0aGlzLmVsZW1lbnQud3JhcCggdGhpcy5fd3JhcHBlcigpICk7CgkJCXRoaXMuZWxlbWVudC5wYXJlbnQoKS5wcmVwZW5kKCB0aGlzLmxhYmVsICk7CgkJfQoKCQkvLyBXcmFwIHRoZSBpbnB1dCArIGxhYmVsIGluIGEgZGl2CgoJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkidGhlbWUiOiB0aGlzLm9wdGlvbnMudGhlbWUsCgkJCSJpY29ucG9zIjogdGhpcy5vcHRpb25zLmljb25wb3MsCgkJCSJtaW5pIjogdGhpcy5vcHRpb25zLm1pbmkKCQl9KTsKCgl9LAoKCV93cmFwcGVyOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gJCggIjxkaXYgY2xhc3M9JyIgICsKCQkJKCB0aGlzLm9wdGlvbnMud3JhcHBlckNsYXNzID8gdGhpcy5vcHRpb25zLndyYXBwZXJDbGFzcyA6ICIiICkgKwoJCQkiIHVpLSIgKyB0aGlzLmlucHV0dHlwZSArCgkJCSggdGhpcy5vcHRpb25zLmRpc2FibGVkID8gIiB1aS1zdGF0ZS1kaXNhYmxlZCIgOiAiIiApICsgIicgPiIgKTsKCX0sCgoJX2hhbmRsZUlucHV0Rm9jdXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMubGFiZWwuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX2hhbmRsZUlucHV0Qmx1cjogZnVuY3Rpb24oKSB7CgkJdGhpcy5sYWJlbC5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJfSwKCglfaGFuZGxlSW5wdXRWQ2xpY2s6IGZ1bmN0aW9uKCkgewoJCXZhciAkdGhpcyA9IHRoaXMuZWxlbWVudDsKCgkJLy8gQWRkcyBjaGVja2VkIGF0dHJpYnV0ZSB0byBjaGVja2VkIGlucHV0IHdoZW4ga2V5Ym9hcmQgaXMgdXNlZAoJCWlmICggJHRoaXMuaXMoICI6Y2hlY2tlZCIgKSApIHsKCgkJCSR0aGlzLnByb3AoICJjaGVja2VkIiwgdHJ1ZSk7CgkJCXRoaXMuX2dldElucHV0U2V0KCkubm90KCAkdGhpcyApLnByb3AoICJjaGVja2VkIiwgZmFsc2UgKTsKCQl9IGVsc2UgewoJCQkkdGhpcy5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoKCQl0aGlzLl91cGRhdGVBbGwoKTsKCX0sCgoJX2hhbmRsZUxhYmVsVk1vdXNlT3ZlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCWlmICggdGhpcy5sYWJlbC5wYXJlbnQoKS5oYXNDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQlldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQl9Cgl9LAoKCV9oYW5kbGVMYWJlbFZDbGljazogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbnB1dCA9IHRoaXMuZWxlbWVudDsKCgkJaWYgKCBpbnB1dC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fY2FjaGVWYWxzKCk7CgoJCWlucHV0LnByb3AoICJjaGVja2VkIiwgdGhpcy5pbnB1dHR5cGUgPT09ICJyYWRpbyIgJiYgdHJ1ZSB8fCAhaW5wdXQucHJvcCggImNoZWNrZWQiICkgKTsKCgkJLy8gdHJpZ2dlciBjbGljayBoYW5kbGVyJ3MgYm91bmQgZGlyZWN0bHkgdG8gdGhlIGlucHV0IGFzIGEgc3Vic3RpdHV0ZSBmb3IKCQkvLyBob3cgbGFiZWwgY2xpY2tzIGJlaGF2ZSBub3JtYWxseSBpbiB0aGUgYnJvd3NlcnMKCQkvLyBUT0RPOiBpdCB3b3VsZCBiZSBuaWNlIHRvIGxldCB0aGUgYnJvd3NlcidzIGhhbmRsZSB0aGUgY2xpY2tzIGFuZCBwYXNzIHRoZW0KCQkvLyAgICAgICB0aHJvdWdoIHRvIHRoZSBhc3NvY2lhdGUgaW5wdXQuIHdlIGNhbiBzd2FsbG93IHRoYXQgY2xpY2sgYXQgdGhlIHBhcmVudAoJCS8vICAgICAgIHdyYXBwZXIgZWxlbWVudCBsZXZlbAoJCWlucHV0LnRyaWdnZXJIYW5kbGVyKCAiY2xpY2siICk7CgoJCS8vIElucHV0IHNldCBmb3IgY29tbW9uIHJhZGlvIGJ1dHRvbnMgd2lsbCBjb250YWluIGFsbCB0aGUgcmFkaW8KCQkvLyBidXR0b25zLCBidXQgd2lsbCBub3QgZm9yIGNoZWNrYm94ZXMuIGNsZWFyaW5nIHRoZSBjaGVja2VkIHN0YXR1cwoJCS8vIG9mIG90aGVyIHJhZGlvcyBlbnN1cmVzIHRoZSBhY3RpdmUgYnV0dG9uIHN0YXRlIGlzIGFwcGxpZWQgcHJvcGVybHkKCQl0aGlzLl9nZXRJbnB1dFNldCgpLm5vdCggaW5wdXQgKS5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgoJCXRoaXMuX3VwZGF0ZUFsbCgpOwoJCXJldHVybiBmYWxzZTsKCX0sCgoJX2NhY2hlVmFsczogZnVuY3Rpb24oKSB7CgkJdGhpcy5fZ2V0SW5wdXRTZXQoKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJJCggdGhpcyApLmF0dHIoImRhdGEtIiArICQubW9iaWxlLm5zICsgImNhY2hlVmFsIiwgdGhpcy5jaGVja2VkICk7CgkJfSk7Cgl9LAoKCS8vcmV0dXJucyBlaXRoZXIgYSBzZXQgb2YgcmFkaW9zIHdpdGggdGhlIHNhbWUgbmFtZSBhdHRyaWJ1dGUsIG9yIGEgc2luZ2xlIGNoZWNrYm94CglfZ2V0SW5wdXRTZXQ6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5pbnB1dHR5cGUgPT09ICJjaGVja2JveCIgKSB7CgkJCXJldHVybiB0aGlzLmVsZW1lbnQ7CgkJfQoKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtLCA6anFtRGF0YShyb2xlPSdwYWdlJyksIDpqcW1EYXRhKHJvbGU9J2RpYWxvZycpIiApCgkJCS5maW5kKCAiaW5wdXRbbmFtZT0nIiArIHRoaXMuZWxlbWVudFsgMCBdLm5hbWUgKyAiJ11bdHlwZT0nIiArIHRoaXMuaW5wdXR0eXBlICsgIiddIiApOwoJfSwKCglfdXBkYXRlQWxsOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuX2dldElucHV0U2V0KCkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCWlmICggdGhpcy5jaGVja2VkIHx8IHNlbGYuaW5wdXR0eXBlID09PSAiY2hlY2tib3giICkgewoJCQkJJHRoaXMudHJpZ2dlciggImNoYW5nZSIgKTsKCQkJfQoJCX0pCgkJLmNoZWNrYm94cmFkaW8oICJyZWZyZXNoIiApOwoJfSwKCglfcmVzZXQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMucmVmcmVzaCgpOwoJfSwKCgkvLyBJcyB0aGUgd2lkZ2V0IHN1cHBvc2VkIHRvIGRpc3BsYXkgYW4gaWNvbj8KCV9oYXNJY29uOiBmdW5jdGlvbigpIHsKCQl2YXIgY29udHJvbGdyb3VwLCBjb250cm9sZ3JvdXBXaWRnZXQsCgkJCWNvbnRyb2xncm91cENvbnN0cnVjdG9yID0gJC5tb2JpbGUuY29udHJvbGdyb3VwOwoKCQkvLyBJZiB0aGUgY29udHJvbGdyb3VwIHdpZGdldCBpcyBkZWZpbmVkIC4uLgoJCWlmICggY29udHJvbGdyb3VwQ29uc3RydWN0b3IgKSB7CgkJCWNvbnRyb2xncm91cCA9IHRoaXMuZWxlbWVudC5jbG9zZXN0KAoJCQkJIjptb2JpbGUtY29udHJvbGdyb3VwLCIgKwoJCQkJY29udHJvbGdyb3VwQ29uc3RydWN0b3IucHJvdG90eXBlLmluaXRTZWxlY3RvciApOwoKCQkJLy8gLi4uIGFuZCB0aGUgY2hlY2tib3ggaXMgaW4gYSBjb250cm9sZ3JvdXAgLi4uCgkJCWlmICggY29udHJvbGdyb3VwLmxlbmd0aCA+IDAgKSB7CgoJCQkJLy8gLi4uIGxvb2sgZm9yIGEgY29udHJvbGdyb3VwIHdpZGdldCBpbnN0YW5jZSwgYW5kIC4uLgoJCQkJY29udHJvbGdyb3VwV2lkZ2V0ID0gJC5kYXRhKCBjb250cm9sZ3JvdXBbIDAgXSwgIm1vYmlsZS1jb250cm9sZ3JvdXAiICk7CgoJCQkJLy8gLi4uIGlmIGZvdW5kLCBkZWNpZGUgYmFzZWQgb24gdGhlIG9wdGlvbiB2YWx1ZSwgLi4uCgkJCQlyZXR1cm4gKCAoIGNvbnRyb2xncm91cFdpZGdldCA/IGNvbnRyb2xncm91cFdpZGdldC5vcHRpb25zLnR5cGUgOgoKCQkJCQkvLyAuLi4gb3RoZXJ3aXNlIGRlY2lkZSBiYXNlZCBvbiB0aGUgInR5cGUiIGRhdGEgYXR0cmlidXRlLgoJCQkJCWNvbnRyb2xncm91cC5hdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidHlwZSIgKSApICE9PSAiaG9yaXpvbnRhbCIgKTsKCQkJfQoJCX0KCgkJLy8gTm9ybWFsbHksIHRoZSB3aWRnZXQgZGlzcGxheXMgYW4gaWNvbi4KCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGhhc0ljb24gPSB0aGlzLl9oYXNJY29uKCksCgkJCWlzQ2hlY2tlZCA9IHRoaXMuZWxlbWVudFsgMCBdLmNoZWNrZWQsCgkJCWFjdGl2ZSA9ICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzLAoJCQlpY29ucG9zQ2xhc3MgPSAidWktYnRuLWljb24tIiArIHRoaXMub3B0aW9ucy5pY29ucG9zLAoJCQlhZGRDbGFzc2VzID0gW10sCgkJCXJlbW92ZUNsYXNzZXMgPSBbXTsKCgkJaWYgKCBoYXNJY29uICkgewoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIGFjdGl2ZSApOwoJCQlhZGRDbGFzc2VzLnB1c2goIGljb25wb3NDbGFzcyApOwoJCX0gZWxzZSB7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggaWNvbnBvc0NsYXNzICk7CgkJCSggaXNDaGVja2VkID8gYWRkQ2xhc3NlcyA6IHJlbW92ZUNsYXNzZXMgKS5wdXNoKCBhY3RpdmUgKTsKCQl9CgoJCWlmICggaXNDaGVja2VkICkgewoJCQlhZGRDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJCXJlbW92ZUNsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCX0gZWxzZSB7CgkJCWFkZENsYXNzZXMucHVzaCggdGhpcy51bmNoZWNrZWRDbGFzcyApOwoJCQlyZW1vdmVDbGFzc2VzLnB1c2goIHRoaXMuY2hlY2tlZENsYXNzICk7CgkJfQoKCQl0aGlzLmxhYmVsCgkJCS5hZGRDbGFzcyggYWRkQ2xhc3Nlcy5qb2luKCAiICIgKSApCgkJCS5yZW1vdmVDbGFzcyggcmVtb3ZlQ2xhc3Nlcy5qb2luKCAiICIgKSApOwoJfSwKCgl3aWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLmxhYmVsLnBhcmVudCgpOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIGxhYmVsID0gdGhpcy5sYWJlbCwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCgkJCW91dGVyID0gdGhpcy53aWRnZXQoKSwKCQkJaGFzSWNvbiA9IHRoaXMuX2hhc0ljb24oKTsKCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuaW5wdXQucHJvcCggImRpc2FibGVkIiwgISFvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJb3V0ZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgISFvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCWxhYmVsCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1idG4tIiArIGN1cnJlbnRPcHRpb25zLnRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMud3JhcHBlckNsYXNzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG9wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoJCWlmICggb3B0aW9ucy5pY29ucG9zICE9PSB1bmRlZmluZWQgJiYgaGFzSWNvbiApIHsKCQkJbGFiZWwucmVtb3ZlQ2xhc3MoICJ1aS1idG4taWNvbi0iICsgY3VycmVudE9wdGlvbnMuaWNvbnBvcyApLmFkZENsYXNzKCAidWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApOwoJCX0gZWxzZSBpZiAoICFoYXNJY29uICkgewoJCQlsYWJlbC5yZW1vdmVDbGFzcyggInVpLWJ0bi1pY29uLSIgKyBjdXJyZW50T3B0aW9ucy5pY29ucG9zICk7CgkJfQoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9Cgp9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuYnV0dG9uIiwgewoKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J2J1dHRvbiddLCBpbnB1dFt0eXBlPSdzdWJtaXQnXSwgaW5wdXRbdHlwZT0ncmVzZXQnXSIsCgoJb3B0aW9uczogewoJCXRoZW1lOiBudWxsLAoJCWljb246IG51bGwsCgkJaWNvbnBvczogImxlZnQiLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQljb3JuZXJzOiB0cnVlLAoJCXNoYWRvdzogdHJ1ZSwKCQlpbmxpbmU6IG51bGwsCgkJbWluaTogbnVsbCwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJZW5oYW5jZWQ6IGZhbHNlCgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoKCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gdHJ1ZTsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJd3JhcHBlcjogdGhpcy5lbGVtZW50LnBhcmVudCgpCgkJfSk7CgoJCXRoaXMuX29uKCB7CgkJCWZvY3VzOiBmdW5jdGlvbigpIHsKCQkJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSwKCgkJCWJsdXI6IGZ1bmN0aW9uKCkgewoJCQkJdGhpcy53aWRnZXQoKS5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9CgkJfSk7CgoJCXRoaXMucmVmcmVzaCggdHJ1ZSApOwoJfSwKCglfZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX2J1dHRvbigpICk7Cgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpY29uQ2xhc3NlcyA9IHRoaXMuX2dldEljb25DbGFzc2VzKCB0aGlzLm9wdGlvbnMgKTsKCgkJcmV0dXJuICQoIjxkaXYgY2xhc3M9J3VpLWJ0biB1aS1pbnB1dC1idG4iICsKCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/ICIgIiArIG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArCgkJCSggb3B0aW9ucy50aGVtZSA/ICIgdWktYnRuLSIgKyBvcHRpb25zLnRoZW1lIDogIiIgKSArCgkJCSggb3B0aW9ucy5jb3JuZXJzID8gIiB1aS1jb3JuZXItYWxsIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSArCgkJCSggb3B0aW9ucy5pbmxpbmUgPyAiIHVpLWJ0bi1pbmxpbmUiIDogIiIgKSArCgkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiICkgKwoJCQkoIG9wdGlvbnMuZGlzYWJsZWQgPyAiIHVpLXN0YXRlLWRpc2FibGVkIiA6ICIiICkgKwoJCQkoIGljb25DbGFzc2VzID8gKCAiICIgKyBpY29uQ2xhc3NlcyApIDogIiIgKSArCgkJCSInID4iICsgdGhpcy5lbGVtZW50LnZhbCgpICsgIjwvZGl2PiIgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy53cmFwcGVyOwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5pbnNlcnRCZWZvcmUoIHRoaXMuYnV0dG9uICk7CgkJCXRoaXMuYnV0dG9uLnJlbW92ZSgpOwoJfSwKCglfZ2V0SWNvbkNsYXNzZXM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXJldHVybiAoIG9wdGlvbnMuaWNvbiA/ICggInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiArCgkJCSggb3B0aW9ucy5pY29uc2hhZG93ID8gIiB1aS1zaGFkb3ctaWNvbiIgOiAiIiApICsgLyogVE9ETzogRGVwcmVjYXRlZCBpbiAxLjQsIHJlbW92ZSBpbiAxLjUuICovCgkJCSIgdWktYnRuLWljb24tIiArIG9wdGlvbnMuaWNvbnBvcyApIDogIiIgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciBvdXRlciA9IHRoaXMud2lkZ2V0KCk7CgoJCWlmICggb3B0aW9ucy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMudGhlbWUgKQoJCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyBvcHRpb25zLnRoZW1lICk7CgkJfQoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCQlpZiAoIG9wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmlubGluZSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLWJ0bi1pbmxpbmUiLCBvcHRpb25zLmlubGluZSApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlci50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJCW91dGVyLnRvZ2dsZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiLCBvcHRpb25zLmRpc2FibGVkICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaWNvbiAhPT0gdW5kZWZpbmVkIHx8CgkJCQlvcHRpb25zLmljb25zaGFkb3cgIT09IHVuZGVmaW5lZCB8fCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQkJCW9wdGlvbnMuaWNvbnBvcyAhPT0gdW5kZWZpbmVkICkgewoJCQlvdXRlcgoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcyggdGhpcy5vcHRpb25zICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl9nZXRJY29uQ2xhc3NlcygKCQkJCQkkLmV4dGVuZCgge30sIHRoaXMub3B0aW9ucywgb3B0aW9ucyApICkgKTsKCQl9CgoJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaWNvbiAmJiB0aGlzLm9wdGlvbnMuaWNvbnBvcyA9PT0gIm5vdGV4dCIgJiYgdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIgKSApIHsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJ0aXRsZSIsIHRoaXMuZWxlbWVudC52YWwoKSApOwoJCX0KCQlpZiAoICFjcmVhdGUgKSB7CgkJCXZhciBvcmlnaW5hbEVsZW1lbnQgPSB0aGlzLmVsZW1lbnQuZGV0YWNoKCk7CgkJCSQoIHRoaXMud3JhcHBlciApLnRleHQoIHRoaXMuZWxlbWVudC52YWwoKSApLmFwcGVuZCggb3JpZ2luYWxFbGVtZW50ICk7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCApIHsKCXZhcgltZXRhID0gJCggIm1ldGFbbmFtZT12aWV3cG9ydF0iICksCgkJaW5pdGlhbENvbnRlbnQgPSBtZXRhLmF0dHIoICJjb250ZW50IiApLAoJCWRpc2FibGVkWm9vbSA9IGluaXRpYWxDb250ZW50ICsgIixtYXhpbXVtLXNjYWxlPTEsIHVzZXItc2NhbGFibGU9bm8iLAoJCWVuYWJsZWRab29tID0gaW5pdGlhbENvbnRlbnQgKyAiLG1heGltdW0tc2NhbGU9MTAsIHVzZXItc2NhbGFibGU9eWVzIiwKCQlkaXNhYmxlZEluaXRpYWxseSA9IC8odXNlci1zY2FsYWJsZVtcc10qPVtcc10qbm8pfChtYXhpbXVtLXNjYWxlW1xzXSo9W1xzXSoxKVskLFxzXS8udGVzdCggaW5pdGlhbENvbnRlbnQgKTsKCgkkLm1vYmlsZS56b29tID0gJC5leHRlbmQoIHt9LCB7CgkJZW5hYmxlZDogIWRpc2FibGVkSW5pdGlhbGx5LAoJCWxvY2tlZDogZmFsc2UsCgkJZGlzYWJsZTogZnVuY3Rpb24oIGxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICEkLm1vYmlsZS56b29tLmxvY2tlZCApIHsKCQkJCW1ldGEuYXR0ciggImNvbnRlbnQiLCBkaXNhYmxlZFpvb20gKTsKCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlZCA9IGZhbHNlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBsb2NrIHx8IGZhbHNlOwoJCQl9CgkJfSwKCQllbmFibGU6IGZ1bmN0aW9uKCB1bmxvY2sgKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICYmICggISQubW9iaWxlLnpvb20ubG9ja2VkIHx8IHVubG9jayA9PT0gdHJ1ZSApICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGVuYWJsZWRab29tICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQkJJC5tb2JpbGUuem9vbS5sb2NrZWQgPSBmYWxzZTsKCQkJfQoJCX0sCgkJcmVzdG9yZTogZnVuY3Rpb24oKSB7CgkJCWlmICggIWRpc2FibGVkSW5pdGlhbGx5ICkgewoJCQkJbWV0YS5hdHRyKCAiY29udGVudCIsIGluaXRpYWxDb250ZW50ICk7CgkJCQkkLm1vYmlsZS56b29tLmVuYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoJfSk7Cgp9KCBqUXVlcnkgKSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsIHsKCWluaXRTZWxlY3RvcjogImlucHV0W3R5cGU9J3RleHQnXSwiICsKCQkiaW5wdXRbdHlwZT0nc2VhcmNoJ10sIiArCgkJIjpqcW1EYXRhKHR5cGU9J3NlYXJjaCcpLCIgKwoJCSJpbnB1dFt0eXBlPSdudW1iZXInXSwiICsKCQkiOmpxbURhdGEodHlwZT0nbnVtYmVyJyksIiArCgkJImlucHV0W3R5cGU9J3Bhc3N3b3JkJ10sIiArCgkJImlucHV0W3R5cGU9J2VtYWlsJ10sIiArCgkJImlucHV0W3R5cGU9J3VybCddLCIgKwoJCSJpbnB1dFt0eXBlPSd0ZWwnXSwiICsKCQkidGV4dGFyZWEsIiArCgkJImlucHV0W3R5cGU9J3RpbWUnXSwiICsKCQkiaW5wdXRbdHlwZT0nZGF0ZSddLCIgKwoJCSJpbnB1dFt0eXBlPSdtb250aCddLCIgKwoJCSJpbnB1dFt0eXBlPSd3ZWVrJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lJ10sIiArCgkJImlucHV0W3R5cGU9J2RhdGV0aW1lLWxvY2FsJ10sIiArCgkJImlucHV0W3R5cGU9J2NvbG9yJ10sIiArCgkJImlucHV0Om5vdChbdHlwZV0pLCIgKwoJCSJpbnB1dFt0eXBlPSdmaWxlJ10iLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQljb3JuZXJzOiB0cnVlLAoJCW1pbmk6IGZhbHNlLAoJCS8vIFRoaXMgb3B0aW9uIGRlZmF1bHRzIHRvIHRydWUgb24gaU9TIGRldmljZXMuCgkJcHJldmVudEZvY3VzWm9vbTogL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZiggIkFwcGxlV2ViS2l0IiApID4gLTEsCgkJd3JhcHBlckNsYXNzOiAiIiwKCQllbmhhbmNlZDogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlpc1NlYXJjaCA9IHRoaXMuZWxlbWVudC5pcyggIlt0eXBlPSdzZWFyY2gnXSwgOmpxbURhdGEodHlwZT0nc2VhcmNoJykiICksCgkJCWlzVGV4dGFyZWEgPSB0aGlzLmVsZW1lbnRbIDAgXS50YWdOYW1lID09PSAiVEVYVEFSRUEiLAoJCQlpc1JhbmdlID0gdGhpcy5lbGVtZW50LmlzKCAiW2RhdGEtIiArICggJC5tb2JpbGUubnMgfHwgIiIgKSArICJ0eXBlPSdyYW5nZSddIiApLAoJCQlpbnB1dE5lZWRzV3JhcCA9ICggKHRoaXMuZWxlbWVudC5pcyggImlucHV0IiApIHx8CgkJCQl0aGlzLmVsZW1lbnQuaXMoICJbZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInR5cGU9J3NlYXJjaCddIiApICkgJiYKCQkJCQkhaXNSYW5nZSApOwoKCQlpZiAoIHRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiICkgKSB7CgkJCW9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCX0KCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJY2xhc3NlczogdGhpcy5fY2xhc3Nlc0Zyb21PcHRpb25zKCksCgkJCWlzU2VhcmNoOiBpc1NlYXJjaCwKCQkJaXNUZXh0YXJlYTogaXNUZXh0YXJlYSwKCQkJaXNSYW5nZTogaXNSYW5nZSwKCQkJaW5wdXROZWVkc1dyYXA6IGlucHV0TmVlZHNXcmFwCgkJfSk7CgoJCXRoaXMuX2F1dG9Db3JyZWN0KCk7CgoJCWlmICggIW9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2VuaGFuY2UoKTsKCQl9CgoJCXRoaXMuX29uKCB7CgkJCSJmb2N1cyI6ICJfaGFuZGxlRm9jdXMiLAoJCQkiYmx1ciI6ICJfaGFuZGxlQmx1ciIKCQl9KTsKCgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuc2V0T3B0aW9ucyh7CgkJCSJkaXNhYmxlZCIgOiB0aGlzLmVsZW1lbnQuaXMoICI6ZGlzYWJsZWQiICkKCQl9KTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtZW50Q2xhc3NlcyA9IFtdOwoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJZWxlbWVudENsYXNzZXMucHVzaCggInVpLWlucHV0LXRleHQiICk7CgkJfQoKCQlpZiAoIHRoaXMuaXNUZXh0YXJlYSB8fCB0aGlzLmlzUmFuZ2UgKSB7CgkJCWVsZW1lbnRDbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ctaW5zZXQiICk7CgkJfQoKCQkvLyJzZWFyY2giIGFuZCAidGV4dCIgaW5wdXQgd2lkZ2V0cwoJCWlmICggdGhpcy5pbnB1dE5lZWRzV3JhcCApIHsKCQkJdGhpcy5lbGVtZW50LndyYXAoIHRoaXMuX3dyYXAoKSApOwoJCX0gZWxzZSB7CgkJCWVsZW1lbnRDbGFzc2VzID0gZWxlbWVudENsYXNzZXMuY29uY2F0KCB0aGlzLmNsYXNzZXMgKTsKCQl9CgoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggZWxlbWVudENsYXNzZXMuam9pbiggIiAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLmlucHV0TmVlZHNXcmFwICkgPyB0aGlzLmVsZW1lbnQucGFyZW50KCkgOiB0aGlzLmVsZW1lbnQ7Cgl9LAoKCV9jbGFzc2VzRnJvbU9wdGlvbnM6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQljbGFzc2VzID0gW107CgoJCWNsYXNzZXMucHVzaCggInVpLWJvZHktIiArICggKCBvcHRpb25zLnRoZW1lID09PSBudWxsICkgPyAiaW5oZXJpdCIgOiBvcHRpb25zLnRoZW1lICkgKTsKCQlpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktY29ybmVyLWFsbCIgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJCWNsYXNzZXMucHVzaCggInVpLW1pbmkiICk7CgkJfQoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJfQoJCWlmICggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKSB7CgkJCWNsYXNzZXMucHVzaCggb3B0aW9ucy53cmFwcGVyQ2xhc3MgKTsKCQl9CgoJCXJldHVybiBjbGFzc2VzOwoJfSwKCglfd3JhcDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICQoICI8ZGl2IGNsYXNzPSciICsKCQkJKCB0aGlzLmlzU2VhcmNoID8gInVpLWlucHV0LXNlYXJjaCAiIDogInVpLWlucHV0LXRleHQgIiApICsKCQkJdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICsgIiAiICsKCQkJInVpLXNoYWRvdy1pbnNldCc+PC9kaXY+IiApOwoJfSwKCglfYXV0b0NvcnJlY3Q6IGZ1bmN0aW9uKCkgewoJCS8vIFhYWDogVGVtcG9yYXJ5IHdvcmthcm91bmQgZm9yIGlzc3VlIDc4NSAoQXBwbGUgYnVnIDg5MTA1ODkpLgoJCS8vICAgICAgVHVybiBvZmYgYXV0b2NvcnJlY3QgYW5kIGF1dG9jb21wbGV0ZSBvbiBub24taU9TIDUgZGV2aWNlcwoJCS8vICAgICAgc2luY2UgdGhlIHBvcHVwIHRoZXkgdXNlIGNhbid0IGJlIGRpc21pc3NlZCBieSB0aGUgdXNlci4gTm90ZQoJCS8vICAgICAgdGhhdCB3ZSB0ZXN0IGZvciB0aGUgcHJlc2VuY2Ugb2YgdGhlIGZlYXR1cmUgYnkgbG9va2luZyBmb3IKCQkvLyAgICAgIHRoZSBhdXRvY29ycmVjdCBwcm9wZXJ0eSBvbiB0aGUgaW5wdXQgZWxlbWVudC4gV2UgY3VycmVudGx5CgkJLy8gICAgICBoYXZlIG5vIHRlc3QgZm9yIGlPUyA1IG9yIG5ld2VyIHNvIHdlJ3JlIHRlbXBvcmFyaWx5IHVzaW5nCgkJLy8gICAgICB0aGUgdG91Y2hPdmVyZmxvdyBzdXBwb3J0IGZsYWcgZm9yIGpRTSAxLjAuIFllcywgSSBmZWVsIGRpcnR5LgoJCS8vICAgICAgLSBqYmxhcwoJCWlmICggdHlwZW9mIHRoaXMuZWxlbWVudFswXS5hdXRvY29ycmVjdCAhPT0gInVuZGVmaW5lZCIgJiYKCQkJISQuc3VwcG9ydC50b3VjaE92ZXJmbG93ICkgewoKCQkJLy8gU2V0IHRoZSBhdHRyaWJ1dGUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkganVzdCBpbiBjYXNlIHRoZXJlCgkJCS8vIGlzIGNvZGUgdGhhdCBhdHRlbXB0cyB0byBtYWtlIG1vZGlmaWNhdGlvbnMgdmlhIEhUTUwuCgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29ycmVjdCIsICJvZmYiICk7CgkJCXRoaXMuZWxlbWVudFswXS5zZXRBdHRyaWJ1dGUoICJhdXRvY29tcGxldGUiLCAib2ZmIiApOwoJCX0KCX0sCgoJX2hhbmRsZUJsdXI6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2lkZ2V0KCkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkkLm1vYmlsZS56b29tLmVuYWJsZSggdHJ1ZSApOwoJCX0KCX0sCgoJX2hhbmRsZUZvY3VzOiBmdW5jdGlvbigpIHsKCQkvLyBJbiBtYW55IHNpdHVhdGlvbnMsIGlPUyB3aWxsIHpvb20gaW50byB0aGUgaW5wdXQgdXBvbiB0YXAsIHRoaXMKCQkvLyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJaWYgKCB0aGlzLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJfQoJCXRoaXMud2lkZ2V0KCkuYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCX0sCgoJX3NldE9wdGlvbnM6IGZ1bmN0aW9uICggb3B0aW9ucyApIHsKCQl2YXIgb3V0ZXIgPSB0aGlzLndpZGdldCgpOwoKCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoKCQlpZiAoICEoIG9wdGlvbnMuZGlzYWJsZWQgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLm1pbmkgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLmNvcm5lcnMgPT09IHVuZGVmaW5lZCAmJgoJCQlvcHRpb25zLnRoZW1lID09PSB1bmRlZmluZWQgJiYKCQkJb3B0aW9ucy53cmFwcGVyQ2xhc3MgPT09IHVuZGVmaW5lZCApICkgewoKCQkJb3V0ZXIucmVtb3ZlQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCQl0aGlzLmNsYXNzZXMgPSB0aGlzLl9jbGFzc2VzRnJvbU9wdGlvbnMoKTsKCQkJb3V0ZXIuYWRkQ2xhc3MoIHRoaXMuY2xhc3Nlcy5qb2luKCAiICIgKSApOwoJCX0KCgkJaWYgKCBvcHRpb25zLmRpc2FibGVkICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiZGlzYWJsZWQiLCAhIW9wdGlvbnMuZGlzYWJsZWQgKTsKCQl9Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIHRoaXMuaW5wdXROZWVkc1dyYXAgKSB7CgkJCXRoaXMuZWxlbWVudC51bndyYXAoKTsKCQl9CgkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtdGV4dCAiICsgdGhpcy5jbGFzc2VzLmpvaW4oICIgIiApICk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS5zbGlkZXIiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAiaW5wdXRbdHlwZT0ncmFuZ2UnXSwgOmpxbURhdGEodHlwZT0ncmFuZ2UnKSwgOmpxbURhdGEocm9sZT0nc2xpZGVyJykiLAoKCXdpZGdldEV2ZW50UHJlZml4OiAic2xpZGUiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQl0cmFja1RoZW1lOiBudWxsLAoJCWNvcm5lcnM6IHRydWUsCgkJbWluaTogZmFsc2UsCgkJaGlnaGxpZ2h0OiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCgkJLy8gVE9ETzogRWFjaCBvZiB0aGVzZSBzaG91bGQgaGF2ZSBjb21tZW50cyBleHBsYWluIHdoYXQgdGhleSdyZSBmb3IKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIGNvbnRyb2xbIDAgXSwgInRoZW1lIiApLAoJCQl0cmFja1RoZW1lQ2xhc3MgPSB0cmFja1RoZW1lID8gIiB1aS1iYXItIiArIHRyYWNrVGhlbWUgOiAiIHVpLWJhci1pbmhlcml0IiwKCQkJY29ybmVyQ2xhc3MgPSAoIHRoaXMub3B0aW9ucy5jb3JuZXJzIHx8IGNvbnRyb2wuanFtRGF0YSggImNvcm5lcnMiICkgKSA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiwKCQkJbWluaUNsYXNzID0gKCB0aGlzLm9wdGlvbnMubWluaSB8fCBjb250cm9sLmpxbURhdGEoICJtaW5pIiApICkgPyAiIHVpLW1pbmkiIDogIiIsCgkJCWNUeXBlID0gY29udHJvbFsgMCBdLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCksCgkJCWlzVG9nZ2xlU3dpdGNoID0gKCBjVHlwZSA9PT0gInNlbGVjdCIgKSwKCQkJaXNSYW5nZXNsaWRlciA9IGNvbnRyb2wucGFyZW50KCkuaXMoICI6anFtRGF0YShyb2xlPSdyYW5nZXNsaWRlcicpIiApLAoJCQlzZWxlY3RDbGFzcyA9ICggaXNUb2dnbGVTd2l0Y2ggKSA/ICJ1aS1zbGlkZXItc3dpdGNoIiA6ICIiLAoJCQljb250cm9sSUQgPSBjb250cm9sLmF0dHIoICJpZCIgKSwKCQkJJGxhYmVsID0gJCggIltmb3I9JyIgKyBjb250cm9sSUQgKyAiJ10iICksCgkJCWxhYmVsSUQgPSAkbGFiZWwuYXR0ciggImlkIiApIHx8IGNvbnRyb2xJRCArICItbGFiZWwiLAoJCQltaW4gPSAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtaW4iICkgKSA6IDAsCgkJCW1heCA9ICAhaXNUb2dnbGVTd2l0Y2ggPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IGNvbnRyb2wuZmluZCggIm9wdGlvbiIgKS5sZW5ndGgtMSwKCQkJc3RlcCA9IHdpbmRvdy5wYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApIHx8IDEgKSwKCQkJZG9tSGFuZGxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICksCgkJCWhhbmRsZSA9ICQoIGRvbUhhbmRsZSApLAoJCQlkb21TbGlkZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAiZGl2IiApLAoJCQlzbGlkZXIgPSAkKCBkb21TbGlkZXIgKSwKCQkJdmFsdWViZyA9IHRoaXMub3B0aW9ucy5oaWdobGlnaHQgJiYgIWlzVG9nZ2xlU3dpdGNoID8gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzbGlkZXIgKTsKCQkJfSkoKSA6IGZhbHNlLAoJCQlvcHRpb25zLAoJCQl3cmFwcGVyLAoJCQlqLCBsZW5ndGgsCgkJCWksIG9wdGlvbnNDb3VudCwgb3JpZ1RhYkluZGV4LAoJCQlzaWRlLCBhY3RpdmVDbGFzcywgc2xpZGVySW1nOwoKCQkkbGFiZWwuYXR0ciggImlkIiwgbGFiZWxJRCApOwoJCXRoaXMuaXNUb2dnbGVTd2l0Y2ggPSBpc1RvZ2dsZVN3aXRjaDsKCgkJZG9tSGFuZGxlLnNldEF0dHJpYnV0ZSggImhyZWYiLCAiIyIgKTsKCQlkb21TbGlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJhcHBsaWNhdGlvbiIgKTsKCQlkb21TbGlkZXIuY2xhc3NOYW1lID0gWyB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gInVpLXNsaWRlciB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0ICIgOiAidWktc2xpZGVyLXRyYWNrIHVpLXNoYWRvdy1pbnNldCAiLCBzZWxlY3RDbGFzcywgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlkb21IYW5kbGUuY2xhc3NOYW1lID0gInVpLXNsaWRlci1oYW5kbGUiOwoJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggZG9tSGFuZGxlICk7CgoJCWhhbmRsZS5hdHRyKHsKCQkJInJvbGUiOiAic2xpZGVyIiwKCQkJImFyaWEtdmFsdWVtaW4iOiBtaW4sCgkJCSJhcmlhLXZhbHVlbWF4IjogbWF4LAoJCQkiYXJpYS12YWx1ZW5vdyI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLXZhbHVldGV4dCI6IHRoaXMuX3ZhbHVlKCksCgkJCSJ0aXRsZSI6IHRoaXMuX3ZhbHVlKCksCgkJCSJhcmlhLWxhYmVsbGVkYnkiOiBsYWJlbElECgkJfSk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNsaWRlcjogc2xpZGVyLAoJCQloYW5kbGU6IGhhbmRsZSwKCQkJY29udHJvbDogY29udHJvbCwKCQkJdHlwZTogY1R5cGUsCgkJCXN0ZXA6IHN0ZXAsCgkJCW1heDogbWF4LAoJCQltaW46IG1pbiwKCQkJdmFsdWViZzogdmFsdWViZywKCQkJaXNSYW5nZXNsaWRlcjogaXNSYW5nZXNsaWRlciwKCQkJZHJhZ2dpbmc6IGZhbHNlLAoJCQliZWZvcmVTdGFydDogbnVsbCwKCQkJdXNlck1vZGlmaWVkOiBmYWxzZSwKCQkJbW91c2VNb3ZlZDogZmFsc2UKCQl9KTsKCgkJaWYgKCBpc1RvZ2dsZVN3aXRjaCApIHsKCQkJLy8gVE9ETzogcmVzdG9yZSBvcmlnaW5hbCB0YWJpbmRleCAoaWYgYW55KSBpbiBhIGRlc3Ryb3kgbWV0aG9kCgkJCW9yaWdUYWJJbmRleCA9IGNvbnRyb2wuYXR0ciggInRhYmluZGV4IiApOwoJCQlpZiAoIG9yaWdUYWJJbmRleCApIHsKCQkJCWhhbmRsZS5hdHRyKCAidGFiaW5kZXgiLCBvcmlnVGFiSW5kZXggKTsKCQkJfQoJCQljb250cm9sLmF0dHIoICJ0YWJpbmRleCIsICItMSIgKS5mb2N1cyhmdW5jdGlvbigpIHsKCQkJCSQoIHRoaXMgKS5ibHVyKCk7CgkJCQloYW5kbGUuZm9jdXMoKTsKCQkJfSk7CgoJCQl3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJd3JhcHBlci5jbGFzc05hbWUgPSAidWktc2xpZGVyLWlubmVyb2Zmc2V0IjsKCgkJCWZvciAoIGogPSAwLCBsZW5ndGggPSBkb21TbGlkZXIuY2hpbGROb2Rlcy5sZW5ndGg7IGogPCBsZW5ndGg7IGorKyApIHsKCQkJCXdyYXBwZXIuYXBwZW5kQ2hpbGQoIGRvbVNsaWRlci5jaGlsZE5vZGVzW2pdICk7CgkJCX0KCgkJCWRvbVNsaWRlci5hcHBlbmRDaGlsZCggd3JhcHBlciApOwoKCQkJLy8gc2xpZGVyLndyYXBJbm5lciggIjxkaXYgY2xhc3M9J3VpLXNsaWRlci1pbm5lcm9mZnNldCc+PC9kaXY+IiApOwoKCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCWhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQlvcHRpb25zID0gY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoKCQkJZm9yICggaSA9IDAsIG9wdGlvbnNDb3VudCA9IG9wdGlvbnMubGVuZ3RoOyBpIDwgb3B0aW9uc0NvdW50OyBpKysgKSB7CgkJCQlzaWRlID0gIWkgPyAiYiIgOiAiYSI7CgkJCQlhY3RpdmVDbGFzcyA9ICFpID8gIiIgOiAiICIgKyAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzczsKCQkJCXNsaWRlckltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJzcGFuIiApOwoKCQkJCXNsaWRlckltZy5jbGFzc05hbWUgPSBbICJ1aS1zbGlkZXItbGFiZWwgdWktc2xpZGVyLWxhYmVsLSIsIHNpZGUsIGFjdGl2ZUNsYXNzIF0uam9pbiggIiIgKTsKCQkJCXNsaWRlckltZy5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImltZyIgKTsKCQkJCXNsaWRlckltZy5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIG9wdGlvbnNbaV0uaW5uZXJIVE1MICkgKTsKCQkJCSQoIHNsaWRlckltZyApLnByZXBlbmRUbyggc2xpZGVyICk7CgkJCX0KCgkJCXNlbGYuX2xhYmVscyA9ICQoICIudWktc2xpZGVyLWxhYmVsIiwgc2xpZGVyICk7CgoJCX0KCgkJLy8gbW9uaXRvciB0aGUgaW5wdXQgZm9yIHVwZGF0ZWQgdmFsdWVzCgkJY29udHJvbC5hZGRDbGFzcyggaXNUb2dnbGVTd2l0Y2ggPyAidWktc2xpZGVyLXN3aXRjaCIgOiAidWktc2xpZGVyLWlucHV0IiApOwoKCQl0aGlzLl9vbiggY29udHJvbCwgewoJCQkiY2hhbmdlIjogIl9jb250cm9sQ2hhbmdlIiwKCQkJImtleXVwIjogIl9jb250cm9sS2V5dXAiLAoJCQkiYmx1ciI6ICJfY29udHJvbEJsdXIiLAoJCQkidm1vdXNldXAiOiAiX2NvbnRyb2xWTW91c2VVcCIKCQl9KTsKCgkJc2xpZGVyLmJpbmQoICJ2bW91c2Vkb3duIiwgJC5wcm94eSggdGhpcy5fc2xpZGVyVk1vdXNlRG93biwgdGhpcyApICkKCQkJLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQkvLyBXZSBoYXZlIHRvIGluc3RhbnRpYXRlIGEgbmV3IGZ1bmN0aW9uIG9iamVjdCBmb3IgdGhlIHVuYmluZCB0byB3b3JrIHByb3Blcmx5CgkJLy8gc2luY2UgdGhlIG1ldGhvZCBpdHNlbGYgaXMgZGVmaW5lZCBpbiB0aGUgcHJvdG90eXBlIChjYXVzaW5nIGl0IHRvIHVuYmluZCBldmVyeXRoaW5nKQoJCXRoaXMuX29uKCBkb2N1bWVudCwgeyAidm1vdXNlbW92ZSI6ICJfcHJldmVudERvY3VtZW50RHJhZyIgfSk7CgkJdGhpcy5fb24oIHNsaWRlci5hZGQoIGRvY3VtZW50ICksIHsgInZtb3VzZXVwIjogIl9zbGlkZXJWTW91c2VVcCIgfSk7CgoJCXNsaWRlci5pbnNlcnRBZnRlciggY29udHJvbCApOwoKCQkvLyB3cmFwIGluIGEgZGl2IGZvciBzdHlsaW5nIHB1cnBvc2VzCgkJaWYgKCAhaXNUb2dnbGVTd2l0Y2ggJiYgIWlzUmFuZ2VzbGlkZXIgKSB7CgkJCXdyYXBwZXIgPSB0aGlzLm9wdGlvbnMubWluaSA/ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXIgdWktbWluaSc+IiA6ICI8ZGl2IGNsYXNzPSd1aS1zbGlkZXInPiI7CgoJCQljb250cm9sLmFkZCggc2xpZGVyICkud3JhcEFsbCggd3JhcHBlciApOwoJCX0KCgkJLy8gYmluZCB0aGUgaGFuZGxlIGV2ZW50IGNhbGxiYWNrcyBhbmQgc2V0IHRoZSBjb250ZXh0IHRvIHRoZSB3aWRnZXQgaW5zdGFuY2UKCQl0aGlzLl9vbiggdGhpcy5oYW5kbGUsIHsKCQkJInZtb3VzZWRvd24iOiAiX2hhbmRsZVZNb3VzZURvd24iLAoJCQkia2V5ZG93biI6ICJfaGFuZGxlS2V5ZG93biIsCgkJCSJrZXl1cCI6ICJfaGFuZGxlS2V5dXAiCgkJfSk7CgoJCXRoaXMuaGFuZGxlLmJpbmQoICJ2Y2xpY2siLCBmYWxzZSApOwoKCQl0aGlzLl9oYW5kbGVGb3JtUmVzZXQoKTsKCgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgdHJ1ZSApOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRoZW1lKCBvcHRpb25zLnRoZW1lICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXRUcmFja1RoZW1lKCBvcHRpb25zLnRyYWNrVGhlbWUgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5jb3JuZXJzICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldENvcm5lcnMoIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fc2V0TWluaSggb3B0aW9ucy5taW5pICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuaGlnaGxpZ2h0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldEhpZ2hsaWdodCggb3B0aW9ucy5oaWdobGlnaHQgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLl9zZXREaXNhYmxlZCggb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQl0aGlzLl9zdXBlciggb3B0aW9ucyApOwoJfSwKCglfY29udHJvbENoYW5nZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCS8vIGlmIHRoZSB1c2VyIGRyYWdnZWQgdGhlIGhhbmRsZSwgdGhlICJjaGFuZ2UiIGV2ZW50IHdhcyB0cmlnZ2VyZWQgZnJvbSBpbnNpZGUgcmVmcmVzaCgpOyBkb24ndCBjYWxsIHJlZnJlc2goKSBhZ2FpbgoJCWlmICggdGhpcy5fdHJpZ2dlciggImNvbnRyb2xjaGFuZ2UiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoICF0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSApOwoJCX0KCX0sCgoJX2NvbnRyb2xLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsgLy8gbmVjZXNzYXJ5PwoJCXRoaXMucmVmcmVzaCggdGhpcy5fdmFsdWUoKSwgdHJ1ZSwgdHJ1ZSApOwoJfSwKCglfY29udHJvbEJsdXI6IGZ1bmN0aW9uKC8qIGV2ZW50ICovKSB7CgkJdGhpcy5yZWZyZXNoKCB0aGlzLl92YWx1ZSgpLCB0cnVlICk7Cgl9LAoKCS8vIGl0IGFwcGVhcnMgdGhlIGNsaWNraW5nIHRoZSB1cCBhbmQgZG93biBidXR0b25zIGluIGNocm9tZSBvbgoJLy8gcmFuZ2UvbnVtYmVyIGlucHV0cyBkb2Vzbid0IHRyaWdnZXIgYSBjaGFuZ2UgdW50aWwgdGhlIGZpZWxkIGlzCgkvLyBibHVycmVkLiBIZXJlIHdlIGNoZWNrIHRoaWYgdGhlIHZhbHVlIGhhcyBjaGFuZ2VkIGFuZCByZWZyZXNoCglfY29udHJvbFZNb3VzZVVwOiBmdW5jdGlvbigvKiBldmVudCAqLykgewoJCXRoaXMuX2NoZWNrZWRSZWZyZXNoKCk7Cgl9LAoKCS8vIE5PVEUgZm9yY2UgZm9jdXMgb24gaGFuZGxlCglfaGFuZGxlVk1vdXNlRG93bjogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQl0aGlzLmhhbmRsZS5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBpbmRleCA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEluIGFsbCBjYXNlcyBwcmV2ZW50IHRoZSBkZWZhdWx0IGFuZCBtYXJrIHRoZSBoYW5kbGUgYXMgYWN0aXZlCgkJc3dpdGNoICggZXZlbnQua2V5Q29kZSApIHsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkhPTUU6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX1VQOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuUEFHRV9ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLkRPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5MRUZUOgoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJCQlpZiAoICF0aGlzLl9rZXlTbGlkaW5nICkgewoJCQkJCXRoaXMuX2tleVNsaWRpbmcgPSB0cnVlOwoJCQkJCXRoaXMuaGFuZGxlLmFkZENsYXNzKCAidWktc3RhdGUtYWN0aXZlIiApOyAvKiBUT0RPOiBXZSBkb24ndCB1c2UgdGhpcyBjbGFzcyBmb3Igc3R5bGluZy4gRG8gd2UgbmVlZCB0byBhZGQgaXQ/ICovCgkJCQl9CgoJCQkJYnJlYWs7CgkJfQoKCQkvLyBtb3ZlIHRoZSBzbGlkZXIgYWNjb3JkaW5nIHRvIHRoZSBrZXlwcmVzcwoJCXN3aXRjaCAoIGV2ZW50LmtleUNvZGUgKSB7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5IT01FOgoJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLm1pbiApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5FTkQ6CgkJCQl0aGlzLnJlZnJlc2goIHRoaXMubWF4ICk7CgkJCQlicmVhazsKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlBBR0VfVVA6CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5VUDoKCQkJY2FzZSAkLm1vYmlsZS5rZXlDb2RlLlJJR0hUOgoJCQkJdGhpcy5yZWZyZXNoKCBpbmRleCArIHRoaXMuc3RlcCApOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5QQUdFX0RPV046CgkJCWNhc2UgJC5tb2JpbGUua2V5Q29kZS5ET1dOOgoJCQljYXNlICQubW9iaWxlLmtleUNvZGUuTEVGVDoKCQkJCXRoaXMucmVmcmVzaCggaW5kZXggLSB0aGlzLnN0ZXAgKTsKCQkJCWJyZWFrOwoJCX0KCX0sIC8vIHJlbW92ZSBhY3RpdmUgbWFyawoKCV9oYW5kbGVLZXl1cDogZnVuY3Rpb24oLyogZXZlbnQgKi8pIHsKCQlpZiAoIHRoaXMuX2tleVNsaWRpbmcgKSB7CgkJCXRoaXMuX2tleVNsaWRpbmcgPSBmYWxzZTsKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1hY3RpdmUiICk7IC8qIFNlZSBjb21tZW50IGFib3ZlLiAqLwoJCX0KCX0sCgoJX3NsaWRlclZNb3VzZURvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJLy8gICAgICAgc3VwcG9ydCBwcm9ncmFtbWF0aWMgYWx0ZXJhdGlvbiBvZiBkaXNhYmxlZCBpbnB1dHMKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhKCBldmVudC53aGljaCA9PT0gMSB8fCBldmVudC53aGljaCA9PT0gMCB8fCBldmVudC53aGljaCA9PT0gdW5kZWZpbmVkICkgKSB7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJaWYgKCB0aGlzLl90cmlnZ2VyKCAiYmVmb3Jlc3RhcnQiLCBldmVudCApID09PSBmYWxzZSApIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQl0aGlzLmRyYWdnaW5nID0gdHJ1ZTsKCQl0aGlzLnVzZXJNb2RpZmllZCA9IGZhbHNlOwoJCXRoaXMubW91c2VNb3ZlZCA9IGZhbHNlOwoKCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCXRoaXMuYmVmb3JlU3RhcnQgPSB0aGlzLmVsZW1lbnRbMF0uc2VsZWN0ZWRJbmRleDsKCQl9CgoJCXRoaXMucmVmcmVzaCggZXZlbnQgKTsKCQl0aGlzLl90cmlnZ2VyKCAic3RhcnQiICk7CgkJcmV0dXJuIGZhbHNlOwoJfSwKCglfc2xpZGVyVk1vdXNlVXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5kcmFnZ2luZyApIHsKCQkJdGhpcy5kcmFnZ2luZyA9IGZhbHNlOwoKCQkJaWYgKCB0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgd2l0aCBhIHNtb290aCB0cmFuc2l0aW9uCgkJCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLXNsaWRlci1oYW5kbGUtc25hcHBpbmciICk7CgoJCQkJaWYgKCB0aGlzLm1vdXNlTW92ZWQgKSB7CgkJCQkJLy8gdGhpcyBpcyBhIGRyYWcsIGNoYW5nZSB0aGUgdmFsdWUgb25seSBpZiB1c2VyIGRyYWdnZWQgZW5vdWdoCgkJCQkJaWYgKCB0aGlzLnVzZXJNb2RpZmllZCApIHsKCQkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0aGlzLnJlZnJlc2goIHRoaXMuYmVmb3JlU3RhcnQgKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMgaXMganVzdCBhIGNsaWNrLCBjaGFuZ2UgdGhlIHZhbHVlCgkJCQkJdGhpcy5yZWZyZXNoKCB0aGlzLmJlZm9yZVN0YXJ0ID09PSAwID8gMSA6IDAgKTsKCQkJCX0KCQkJfQoKCQkJdGhpcy5tb3VzZU1vdmVkID0gZmFsc2U7CgkJCXRoaXMuX3RyaWdnZXIoICJzdG9wIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfcHJldmVudERvY3VtZW50RHJhZzogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvLyBOT1RFOiB3ZSBkb24ndCBkbyB0aGlzIGluIHJlZnJlc2ggYmVjYXVzZSB3ZSBzdGlsbCB3YW50IHRvCgkJCS8vICAgICAgIHN1cHBvcnQgcHJvZ3JhbW1hdGljIGFsdGVyYXRpb24gb2YgZGlzYWJsZWQgaW5wdXRzCgkJCWlmICggdGhpcy5fdHJpZ2dlciggImRyYWciLCBldmVudCApID09PSBmYWxzZSkgewoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCWlmICggdGhpcy5kcmFnZ2luZyAmJiAhdGhpcy5vcHRpb25zLmRpc2FibGVkICkgewoKCQkJCS8vIHRoaXMubW91c2VNb3ZlZCBtdXN0IGJlIHVwZGF0ZWQgYmVmb3JlIHJlZnJlc2goKSBiZWNhdXNlIGl0IHdpbGwgYmUgdXNlZCBpbiB0aGUgY29udHJvbCAiY2hhbmdlIiBldmVudAoJCQkJdGhpcy5tb3VzZU1vdmVkID0gdHJ1ZTsKCgkJCQlpZiAoIHRoaXMuaXNUb2dnbGVTd2l0Y2ggKSB7CgkJCQkJLy8gbWFrZSB0aGUgaGFuZGxlIG1vdmUgaW4gc3luYyB3aXRoIHRoZSBtb3VzZQoJCQkJCXRoaXMuaGFuZGxlLnJlbW92ZUNsYXNzKCAidWktc2xpZGVyLWhhbmRsZS1zbmFwcGluZyIgKTsKCQkJCX0KCgkJCQl0aGlzLnJlZnJlc2goIGV2ZW50ICk7CgoJCQkJLy8gb25seSBhZnRlciByZWZyZXNoKCkgeW91IGNhbiBjYWxjdWxhdGUgdGhpcy51c2VyTW9kaWZpZWQKCQkJCXRoaXMudXNlck1vZGlmaWVkID0gdGhpcy5iZWZvcmVTdGFydCAhPT0gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXg7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCV9jaGVja2VkUmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLnZhbHVlICE9PSB0aGlzLl92YWx1ZSgpICkgewoJCQl0aGlzLnJlZnJlc2goIHRoaXMuX3ZhbHVlKCkgKTsKCQl9Cgl9LAoKCV92YWx1ZTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICB0aGlzLmlzVG9nZ2xlU3dpdGNoID8gdGhpcy5lbGVtZW50WzBdLnNlbGVjdGVkSW5kZXggOiBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQudmFsKCkgKSA7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCB1bmRlZmluZWQsIGZhbHNlLCB0cnVlICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCB2YWwsIGlzZnJvbUNvbnRyb2wsIHByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkvLyBOT1RFOiB3ZSBkb24ndCByZXR1cm4gaGVyZSBiZWNhdXNlIHdlIHdhbnQgdG8gc3VwcG9ydCBwcm9ncmFtbWF0aWMKCQkvLyAgICAgICBhbHRlcmF0aW9uIG9mIHRoZSBpbnB1dCB2YWx1ZSwgd2hpY2ggc2hvdWxkIHN0aWxsIHVwZGF0ZSB0aGUgc2xpZGVyCgoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFyZW50VGhlbWUgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMuZWxlbWVudFsgMCBdLCAidGhlbWUiICksCgkJCXRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lIHx8IHBhcmVudFRoZW1lLAoJCQl0aGVtZUNsYXNzID0gIHRoZW1lID8gIiB1aS1idG4tIiArIHRoZW1lIDogIiIsCgkJCXRyYWNrVGhlbWUgPSB0aGlzLm9wdGlvbnMudHJhY2tUaGVtZSB8fCBwYXJlbnRUaGVtZSwKCQkJdHJhY2tUaGVtZUNsYXNzID0gdHJhY2tUaGVtZSA/ICIgdWktYmFyLSIgKyB0cmFja1RoZW1lIDogIiB1aS1iYXItaW5oZXJpdCIsCgkJCWNvcm5lckNsYXNzID0gdGhpcy5vcHRpb25zLmNvcm5lcnMgPyAiIHVpLWNvcm5lci1hbGwiIDogIiIsCgkJCW1pbmlDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gIiB1aS1taW5pIiA6ICIiLAoJCQlsZWZ0LCB3aWR0aCwgZGF0YSwgdG9sLAoJCQlweFN0ZXAsIHBlcmNlbnQsCgkJCWNvbnRyb2wsIGlzSW5wdXQsIG9wdGlvbkVsZW1lbnRzLCBtaW4sIG1heCwgc3RlcCwKCQkJbmV3dmFsLCB2YWxNb2RTdGVwLCBhbGlnblZhbHVlLCBwZXJjZW50UGVyU3RlcCwKCQkJaGFuZGxlUGVyY2VudCwgYVBlcmNlbnQsIGJQZXJjZW50LAoJCQl2YWx1ZUNoYW5nZWQ7CgoJCXNlbGYuc2xpZGVyWzBdLmNsYXNzTmFtZSA9IFsgdGhpcy5pc1RvZ2dsZVN3aXRjaCA/ICJ1aS1zbGlkZXIgdWktc2xpZGVyLXN3aXRjaCB1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiA6ICJ1aS1zbGlkZXItdHJhY2sgdWktc2hhZG93LWluc2V0IiwgdHJhY2tUaGVtZUNsYXNzLCBjb3JuZXJDbGFzcywgbWluaUNsYXNzIF0uam9pbiggIiIgKTsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiApICkgewoJCQl0aGlzLmRpc2FibGUoKTsKCQl9CgoJCS8vIHNldCB0aGUgc3RvcmVkIHZhbHVlIGZvciBjb21wYXJpc29uIGxhdGVyCgkJdGhpcy52YWx1ZSA9IHRoaXMuX3ZhbHVlKCk7CgkJaWYgKCB0aGlzLm9wdGlvbnMuaGlnaGxpZ2h0ICYmICF0aGlzLmlzVG9nZ2xlU3dpdGNoICYmIHRoaXMuc2xpZGVyLmZpbmQoICIudWktc2xpZGVyLWJnIiApLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy52YWx1ZWJnID0gKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGJnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImRpdiIgKTsKCQkJCWJnLmNsYXNzTmFtZSA9ICJ1aS1zbGlkZXItYmcgIiArICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzOwoJCQkJcmV0dXJuICQoIGJnICkucHJlcGVuZFRvKCBzZWxmLnNsaWRlciApOwoJCQl9KSgpOwoJCX0KCQl0aGlzLmhhbmRsZS5hZGRDbGFzcyggInVpLWJ0biIgKyB0aGVtZUNsYXNzICsgIiB1aS1zaGFkb3ciICk7CgoJCWNvbnRyb2wgPSB0aGlzLmVsZW1lbnQ7CgkJaXNJbnB1dCA9ICF0aGlzLmlzVG9nZ2xlU3dpdGNoOwoJCW9wdGlvbkVsZW1lbnRzID0gaXNJbnB1dCA/IFtdIDogY29udHJvbC5maW5kKCAib3B0aW9uIiApOwoJCW1pbiA9ICBpc0lucHV0ID8gcGFyc2VGbG9hdCggY29udHJvbC5hdHRyKCAibWluIiApICkgOiAwOwoJCW1heCA9IGlzSW5wdXQgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJtYXgiICkgKSA6IG9wdGlvbkVsZW1lbnRzLmxlbmd0aCAtIDE7CgkJc3RlcCA9ICggaXNJbnB1dCAmJiBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgPiAwICkgPyBwYXJzZUZsb2F0KCBjb250cm9sLmF0dHIoICJzdGVwIiApICkgOiAxOwoKCQlpZiAoIHR5cGVvZiB2YWwgPT09ICJvYmplY3QiICkgewoJCQlkYXRhID0gdmFsOwoJCQkvLyBhIHNsaWdodCB0b2xlcmFuY2UgaGVscGVkIGdldCB0byB0aGUgZW5kcyBvZiB0aGUgc2xpZGVyCgkJCXRvbCA9IDg7CgoJCQlsZWZ0ID0gdGhpcy5zbGlkZXIub2Zmc2V0KCkubGVmdDsKCQkJd2lkdGggPSB0aGlzLnNsaWRlci53aWR0aCgpOwoJCQlweFN0ZXAgPSB3aWR0aC8oKG1heC1taW4pL3N0ZXApOwoJCQlpZiAoICF0aGlzLmRyYWdnaW5nIHx8CgkJCQkJZGF0YS5wYWdlWCA8IGxlZnQgLSB0b2wgfHwKCQkJCQlkYXRhLnBhZ2VYID4gbGVmdCArIHdpZHRoICsgdG9sICkgewoJCQkJcmV0dXJuOwoJCQl9CgkJCWlmICggcHhTdGVwID4gMSApIHsKCQkJCXBlcmNlbnQgPSAoICggZGF0YS5wYWdlWCAtIGxlZnQgKSAvIHdpZHRoICkgKiAxMDA7CgkJCX0gZWxzZSB7CgkJCQlwZXJjZW50ID0gTWF0aC5yb3VuZCggKCAoIGRhdGEucGFnZVggLSBsZWZ0ICkgLyB3aWR0aCApICogMTAwICk7CgkJCX0KCQl9IGVsc2UgewoJCQlpZiAoIHZhbCA9PSBudWxsICkgewoJCQkJdmFsID0gaXNJbnB1dCA/IHBhcnNlRmxvYXQoIGNvbnRyb2wudmFsKCkgfHwgMCApIDogY29udHJvbFswXS5zZWxlY3RlZEluZGV4OwoJCQl9CgkJCXBlcmNlbnQgPSAoIHBhcnNlRmxvYXQoIHZhbCApIC0gbWluICkgLyAoIG1heCAtIG1pbiApICogMTAwOwoJCX0KCgkJaWYgKCBpc05hTiggcGVyY2VudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQluZXd2YWwgPSAoIHBlcmNlbnQgLyAxMDAgKSAqICggbWF4IC0gbWluICkgKyBtaW47CgoJCS8vZnJvbSBqUXVlcnkgVUkgc2xpZGVyLCB0aGUgZm9sbG93aW5nIHNvdXJjZSB3aWxsIHJvdW5kIHRvIHRoZSBuZWFyZXN0IHN0ZXAKCQl2YWxNb2RTdGVwID0gKCBuZXd2YWwgLSBtaW4gKSAlIHN0ZXA7CgkJYWxpZ25WYWx1ZSA9IG5ld3ZhbCAtIHZhbE1vZFN0ZXA7CgoJCWlmICggTWF0aC5hYnMoIHZhbE1vZFN0ZXAgKSAqIDIgPj0gc3RlcCApIHsKCQkJYWxpZ25WYWx1ZSArPSAoIHZhbE1vZFN0ZXAgPiAwICkgPyBzdGVwIDogKCAtc3RlcCApOwoJCX0KCgkJcGVyY2VudFBlclN0ZXAgPSAxMDAvKChtYXgtbWluKS9zdGVwKTsKCQkvLyBTaW5jZSBKYXZhU2NyaXB0IGhhcyBwcm9ibGVtcyB3aXRoIGxhcmdlIGZsb2F0cywgcm91bmQKCQkvLyB0aGUgZmluYWwgdmFsdWUgdG8gNSBkaWdpdHMgYWZ0ZXIgdGhlIGRlY2ltYWwgcG9pbnQgKHNlZSBqUXVlcnlVSTogIzQxMjQpCgkJbmV3dmFsID0gcGFyc2VGbG9hdCggYWxpZ25WYWx1ZS50b0ZpeGVkKDUpICk7CgoJCWlmICggdHlwZW9mIHB4U3RlcCA9PT0gInVuZGVmaW5lZCIgKSB7CgkJCXB4U3RlcCA9IHdpZHRoIC8gKCAobWF4LW1pbikgLyBzdGVwICk7CgkJfQoJCWlmICggcHhTdGVwID4gMSAmJiBpc0lucHV0ICkgewoJCQlwZXJjZW50ID0gKCBuZXd2YWwgLSBtaW4gKSAqIHBlcmNlbnRQZXJTdGVwICogKCAxIC8gc3RlcCApOwoJCX0KCQlpZiAoIHBlcmNlbnQgPCAwICkgewoJCQlwZXJjZW50ID0gMDsKCQl9CgoJCWlmICggcGVyY2VudCA+IDEwMCApIHsKCQkJcGVyY2VudCA9IDEwMDsKCQl9CgoJCWlmICggbmV3dmFsIDwgbWluICkgewoJCQluZXd2YWwgPSBtaW47CgkJfQoKCQlpZiAoIG5ld3ZhbCA+IG1heCApIHsKCQkJbmV3dmFsID0gbWF4OwoJCX0KCgkJdGhpcy5oYW5kbGUuY3NzKCAibGVmdCIsIHBlcmNlbnQgKyAiJSIgKTsKCgkJdGhpcy5oYW5kbGVbMF0uc2V0QXR0cmlidXRlKCAiYXJpYS12YWx1ZW5vdyIsIGlzSW5wdXQgPyBuZXd2YWwgOiBvcHRpb25FbGVtZW50cy5lcSggbmV3dmFsICkuYXR0ciggInZhbHVlIiApICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggImFyaWEtdmFsdWV0ZXh0IiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCXRoaXMuaGFuZGxlWzBdLnNldEF0dHJpYnV0ZSggInRpdGxlIiwgaXNJbnB1dCA/IG5ld3ZhbCA6IG9wdGlvbkVsZW1lbnRzLmVxKCBuZXd2YWwgKS5nZXRFbmNvZGVkVGV4dCgpICk7CgoJCWlmICggdGhpcy52YWx1ZWJnICkgewoJCQl0aGlzLnZhbHVlYmcuY3NzKCAid2lkdGgiLCBwZXJjZW50ICsgIiUiICk7CgkJfQoKCQkvLyBkcmFnIHRoZSBsYWJlbCB3aWR0aHMKCQlpZiAoIHRoaXMuX2xhYmVscyApIHsKCQkJaGFuZGxlUGVyY2VudCA9IHRoaXMuaGFuZGxlLndpZHRoKCkgLyB0aGlzLnNsaWRlci53aWR0aCgpICogMTAwOwoJCQlhUGVyY2VudCA9IHBlcmNlbnQgJiYgaGFuZGxlUGVyY2VudCArICggMTAwIC0gaGFuZGxlUGVyY2VudCApICogcGVyY2VudCAvIDEwMDsKCQkJYlBlcmNlbnQgPSBwZXJjZW50ID09PSAxMDAgPyAwIDogTWF0aC5taW4oIGhhbmRsZVBlcmNlbnQgKyAxMDAgLSBhUGVyY2VudCwgMTAwICk7CgoJCQl0aGlzLl9sYWJlbHMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciBhYiA9ICQoIHRoaXMgKS5oYXNDbGFzcyggInVpLXNsaWRlci1sYWJlbC1hIiApOwoJCQkJJCggdGhpcyApLndpZHRoKCAoIGFiID8gYVBlcmNlbnQgOiBiUGVyY2VudCAgKSArICIlIiApOwoJCQl9KTsKCQl9CgoJCWlmICggIXByZXZlbnRJbnB1dFVwZGF0ZSApIHsKCQkJdmFsdWVDaGFuZ2VkID0gZmFsc2U7CgoJCQkvLyB1cGRhdGUgY29udHJvbCJzIHZhbHVlCgkJCWlmICggaXNJbnB1dCApIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2wudmFsKCkgIT09IG5ld3ZhbDsKCQkJCWNvbnRyb2wudmFsKCBuZXd2YWwgKTsKCQkJfSBlbHNlIHsKCQkJCXZhbHVlQ2hhbmdlZCA9IGNvbnRyb2xbIDAgXS5zZWxlY3RlZEluZGV4ICE9PSBuZXd2YWw7CgkJCQljb250cm9sWyAwIF0uc2VsZWN0ZWRJbmRleCA9IG5ld3ZhbDsKCQkJfQoJCQlpZiAoIHRoaXMuX3RyaWdnZXIoICJiZWZvcmVjaGFuZ2UiLCB2YWwgKSA9PT0gZmFsc2UpIHsKCQkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQkJaWYgKCAhaXNmcm9tQ29udHJvbCAmJiB2YWx1ZUNoYW5nZWQgKSB7CgkJCQljb250cm9sLnRyaWdnZXIoICJjaGFuZ2UiICk7CgkJCX0KCQl9Cgl9LAoKCV9zZXRIaWdobGlnaHQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCB2YWx1ZSApIHsKCQkJdGhpcy5vcHRpb25zLmhpZ2hsaWdodCA9ICEhdmFsdWU7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0gZWxzZSBpZiAoIHRoaXMudmFsdWViZyApIHsKCQkJdGhpcy52YWx1ZWJnLnJlbW92ZSgpOwoJCQl0aGlzLnZhbHVlYmcgPSBmYWxzZTsKCQl9Cgl9LAoKCV9zZXRUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXRoaXMuaGFuZGxlCgkJCS5yZW1vdmVDbGFzcyggInVpLWJ0bi0iICsgdGhpcy5vcHRpb25zLnRoZW1lICkKCQkJLmFkZENsYXNzKCAidWktYnRuLSIgKyB2YWx1ZSApOwoKCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQluZXdUaGVtZSA9IHZhbHVlID8gdmFsdWUgOiAiaW5oZXJpdCI7CgoJCXRoaXMuY29udHJvbAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VGhlbWUgKQoJCQkuYWRkQ2xhc3MoICJ1aS1ib2R5LSIgKyBuZXdUaGVtZSApOwoJfSwKCglfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhciBjdXJyZW50VHJhY2tUaGVtZSA9IHRoaXMub3B0aW9ucy50cmFja1RoZW1lID8gdGhpcy5vcHRpb25zLnRyYWNrVGhlbWUgOiAiaW5oZXJpdCIsCgkJCW5ld1RyYWNrVGhlbWUgPSB2YWx1ZSA/IHZhbHVlIDogImluaGVyaXQiOwoKCQl0aGlzLnNsaWRlcgoJCQkucmVtb3ZlQ2xhc3MoICJ1aS1ib2R5LSIgKyBjdXJyZW50VHJhY2tUaGVtZSApCgkJCS5hZGRDbGFzcyggInVpLWJvZHktIiArIG5ld1RyYWNrVGhlbWUgKTsKCX0sCgoJX3NldE1pbmk6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl2YWx1ZSA9ICEhdmFsdWU7CgkJaWYgKCAhdGhpcy5pc1RvZ2dsZVN3aXRjaCAmJiAhdGhpcy5pc1Jhbmdlc2xpZGVyICkgewoJCQl0aGlzLnNsaWRlci5wYXJlbnQoKS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCB2YWx1ZSApOwoJCQl0aGlzLmVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCQl9CgkJdGhpcy5zbGlkZXIudG9nZ2xlQ2xhc3MoICJ1aS1taW5pIiwgdmFsdWUgKTsKCX0sCgoJX3NldENvcm5lcnM6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLWNvcm5lci1hbGwiLCB2YWx1ZSApOwoKCQlpZiAoICF0aGlzLmlzVG9nZ2xlU3dpdGNoICkgewoJCQl0aGlzLmNvbnRyb2wudG9nZ2xlQ2xhc3MoICJ1aS1jb3JuZXItYWxsIiwgdmFsdWUgKTsKCQl9Cgl9LAoKCV9zZXREaXNhYmxlZDogZnVuY3Rpb24oIHZhbHVlICkgewoJCXZhbHVlID0gISF2YWx1ZTsKCQl0aGlzLmVsZW1lbnQucHJvcCggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLnNsaWRlci50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApLmF0dHIoICJhcmlhLWRpc2FibGVkIiwgdmFsdWUgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7Cgp2YXIgcG9wdXA7CgpmdW5jdGlvbiBnZXRQb3B1cCgpIHsKCWlmICggIXBvcHVwICkgewoJCXBvcHVwID0gJCggIjxkaXY+PC9kaXY+IiwgewoJCQkiY2xhc3MiOiAidWktc2xpZGVyLXBvcHVwIHVpLXNoYWRvdyB1aS1jb3JuZXItYWxsIgoJCX0pOwoJfQoJcmV0dXJuIHBvcHVwLmNsb25lKCk7Cn0KCiQud2lkZ2V0KCAibW9iaWxlLnNsaWRlciIsICQubW9iaWxlLnNsaWRlciwgewoJb3B0aW9uczogewoJCXBvcHVwRW5hYmxlZDogZmFsc2UsCgkJc2hvd1ZhbHVlOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfY3VycmVudFZhbHVlOiBudWxsLAoJCQlfcG9wdXA6IG51bGwsCgkJCV9wb3B1cFZpc2libGU6IGZhbHNlCgkJfSk7CgoJCXRoaXMuX3NldE9wdGlvbiggInBvcHVwRW5hYmxlZCIsIHRoaXMub3B0aW9ucy5wb3B1cEVuYWJsZWQgKTsKCgkJdGhpcy5fb24oIHRoaXMuaGFuZGxlLCB7ICJ2bW91c2Vkb3duIiA6ICJfc2hvd1BvcHVwIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMuc2xpZGVyLmFkZCggdGhpcy5kb2N1bWVudCApLCB7ICJ2bW91c2V1cCIgOiAiX2hpZGVQb3B1cCIgfSApOwoJCXRoaXMuX3JlZnJlc2goKTsKCX0sCgoJLy8gcG9zaXRpb24gdGhlIHBvcHVwIGNlbnRlcmVkIDVweCBhYm92ZSB0aGUgaGFuZGxlCglfcG9zaXRpb25Qb3B1cDogZnVuY3Rpb24oKSB7CgkJdmFyIGRzdE9mZnNldCA9IHRoaXMuaGFuZGxlLm9mZnNldCgpOwoKCQl0aGlzLl9wb3B1cC5vZmZzZXQoIHsKCQkJbGVmdDogZHN0T2Zmc2V0LmxlZnQgKyAoIHRoaXMuaGFuZGxlLndpZHRoKCkgLSB0aGlzLl9wb3B1cC53aWR0aCgpICkgLyAyLAoJCQl0b3A6IGRzdE9mZnNldC50b3AgLSB0aGlzLl9wb3B1cC5vdXRlckhlaWdodCgpIC0gNQoJCX0pOwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQl0aGlzLl9zdXBlcigga2V5LCB2YWx1ZSApOwoKCQlpZiAoIGtleSA9PT0gInNob3dWYWx1ZSIgKSB7CgkJCXRoaXMuaGFuZGxlLmh0bWwoIHZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSA/IHRoaXMuX3ZhbHVlKCkgOiAiIiApOwoJCX0gZWxzZSBpZiAoIGtleSA9PT0gInBvcHVwRW5hYmxlZCIgKSB7CgkJCWlmICggdmFsdWUgJiYgIXRoaXMuX3BvcHVwICkgewoJCQkJdGhpcy5fcG9wdXAgPSBnZXRQb3B1cCgpCgkJCQkJLmFkZENsYXNzKCAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgfHwgImEiICkgKQoJCQkJCS5pbnNlcnRCZWZvcmUoIHRoaXMuZWxlbWVudCApOwoJCQl9CgkJfQoJfSwKCgkvLyBzaG93IHZhbHVlIG9uIHRoZSBoYW5kbGUgYW5kIGluIHBvcHVwCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlci5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglfcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIG8gPSB0aGlzLm9wdGlvbnMsIG5ld1ZhbHVlOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICkgewoJCQkvLyByZW1vdmUgdGhlIHRpdGxlIGF0dHJpYnV0ZSBmcm9tIHRoZSBoYW5kbGUgKHdoaWNoIGlzCgkJCS8vIHJlc3BvbnNpYmxlIGZvciB0aGUgYW5ub3lpbmcgdG9vbHRpcCk7IE5CIHdlIGhhdmUKCQkJLy8gdG8gZG8gaXQgaGVyZSBhcyB0aGUganFtIHNsaWRlciBzZXRzIGl0IGV2ZXJ5IHRpbWUKCQkJLy8gdGhlIHNsaWRlcidzIHZhbHVlIGNoYW5nZXMgOigKCQkJdGhpcy5oYW5kbGUucmVtb3ZlQXR0ciggInRpdGxlIiApOwoJCX0KCgkJbmV3VmFsdWUgPSB0aGlzLl92YWx1ZSgpOwoJCWlmICggbmV3VmFsdWUgPT09IHRoaXMuX2N1cnJlbnRWYWx1ZSApIHsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9jdXJyZW50VmFsdWUgPSBuZXdWYWx1ZTsKCgkJaWYgKCBvLnBvcHVwRW5hYmxlZCAmJiB0aGlzLl9wb3B1cCApIHsKCQkJdGhpcy5fcG9zaXRpb25Qb3B1cCgpOwoJCQl0aGlzLl9wb3B1cC5odG1sKCBuZXdWYWx1ZSApOwoJCX0gZWxzZSBpZiAoIG8uc2hvd1ZhbHVlICYmICF0aGlzLm9wdGlvbnMubWluaSApIHsKCQkJdGhpcy5oYW5kbGUuaHRtbCggbmV3VmFsdWUgKTsKCQl9Cgl9LAoKCV9zaG93UG9wdXA6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLnBvcHVwRW5hYmxlZCAmJiAhdGhpcy5fcG9wdXBWaXNpYmxlICkgewoJCQl0aGlzLmhhbmRsZS5odG1sKCAiIiApOwoJCQl0aGlzLl9wb3B1cC5zaG93KCk7CgkJCXRoaXMuX3Bvc2l0aW9uUG9wdXAoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gdHJ1ZTsKCQl9Cgl9LAoKCV9oaWRlUG9wdXA6IGZ1bmN0aW9uKCkgewoJCXZhciBvID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG8ucG9wdXBFbmFibGVkICYmIHRoaXMuX3BvcHVwVmlzaWJsZSApIHsKCQkJaWYgKCBvLnNob3dWYWx1ZSAmJiAhby5taW5pICkgewoJCQkJdGhpcy5oYW5kbGUuaHRtbCggdGhpcy5fdmFsdWUoKSApOwoJCQl9CgkJCXRoaXMuX3BvcHVwLmhpZGUoKTsKCQkJdGhpcy5fcG9wdXBWaXNpYmxlID0gZmFsc2U7CgkJfQoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUuZmxpcHN3aXRjaCIsICQuZXh0ZW5kKHsKCglvcHRpb25zOiB7CgkJb25UZXh0OiAiT24iLAoJCW9mZlRleHQ6ICJPZmYiLAoJCXRoZW1lOiBudWxsLAoJCWVuaGFuY2VkOiBmYWxzZSwKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJY29ybmVyczogdHJ1ZSwKCQltaW5pOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZSgpOwoJCQl9IGVsc2UgewoJCQkJJC5leHRlbmQoIHRoaXMsIHsKCQkJCQlmbGlwc3dpdGNoOiB0aGlzLmVsZW1lbnQucGFyZW50KCksCgkJCQkJb246IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb24iICkuZXEoIDAgKSwKCQkJCQlvZmY6IHRoaXMuZWxlbWVudC5maW5kKCAiLnVpLWZsaXBzd2l0Y2gtb2ZmIiApLmVxKDApLAoJCQkJCXR5cGU6IHRoaXMuZWxlbWVudC5nZXQoIDAgKS50YWdOYW1lCgkJCQl9KTsKCQkJfQoKCQkJdGhpcy5faGFuZGxlRm9ybVJlc2V0KCk7CgoJCQlpZiAoIHRoaXMuZWxlbWVudC5pcyggIjpkaXNhYmxlZCIgKSApIHsKCQkJCXRoaXMuX3NldE9wdGlvbnMoewoJCQkJCSJkaXNhYmxlZCI6IHRydWUKCQkJCX0pOwoJCQl9CgoJCQl0aGlzLl9vbiggdGhpcy5mbGlwc3dpdGNoLCB7CgkJCQkiY2xpY2siOiAiX3RvZ2dsZSIsCgkJCQkic3dpcGVsZWZ0IjogIl9sZWZ0IiwKCQkJCSJzd2lwZXJpZ2h0IjogIl9yaWdodCIKCQkJfSk7CgoJCQl0aGlzLl9vbiggdGhpcy5vbiwgewoJCQkJImtleWRvd24iOiAiX2tleWRvd24iCgkJCX0pOwoKCQkJdGhpcy5fb24oIHsKCQkJCSJjaGFuZ2UiOiAicmVmcmVzaCIKCQkJfSk7Cgl9LAoKCXdpZGdldDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuZmxpcHN3aXRjaDsKCX0sCgoJX2xlZnQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmVDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAwOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIGZhbHNlICk7CgkJfQoJCXRoaXMuZWxlbWVudC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJfSwKCglfcmlnaHQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZmxpcHN3aXRjaC5hZGRDbGFzcyggInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiApOwoJCWlmICggdGhpcy50eXBlID09PSAiU0VMRUNUIiApIHsKCQkJdGhpcy5lbGVtZW50LmdldCggMCApLnNlbGVjdGVkSW5kZXggPSAxOwoJCX0gZWxzZSB7CgkJCXRoaXMuZWxlbWVudC5wcm9wKCAiY2hlY2tlZCIsIHRydWUgKTsKCQl9CgkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjaGFuZ2UiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZmxpcHN3aXRjaCA9ICQoICI8ZGl2PiIgKSwKCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJZWxlbWVudCA9IHRoaXMuZWxlbWVudCwKCQkJdGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IiwKCQkJb24gPSAkKCAiPHNwYW4+PC9zcGFuPiIsIHsgdGFiaW5kZXg6IDEgfSApLAoJCQlvZmYgPSAkKCAiPHNwYW4+PC9zcGFuPiIgKSwKCQkJdHlwZSA9IGVsZW1lbnQuZ2V0KCAwICkudGFnTmFtZSwKCQkJb25UZXh0ID0gKCB0eXBlID09PSAiSU5QVVQiICkgPwoJCQkJb3B0aW9ucy5vblRleHQgOiBlbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDEgKS50ZXh0KCksCgkJCW9mZlRleHQgPSAoIHR5cGUgPT09ICJJTlBVVCIgKSA/CgkJCQlvcHRpb25zLm9mZlRleHQgOiBlbGVtZW50LmZpbmQoICJvcHRpb24iICkuZXEoIDAgKS50ZXh0KCk7CgoJCQlvbgoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vbiB1aS1idG4gdWktc2hhZG93IHVpLWJ0bi1pbmhlcml0IiApCgkJCQkudGV4dCggb25UZXh0ICk7CgkJCW9mZgoJCQkJLmFkZENsYXNzKCAidWktZmxpcHN3aXRjaC1vZmYiICkKCQkJCS50ZXh0KCBvZmZUZXh0ICk7CgoJCQlmbGlwc3dpdGNoCgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoIHVpLXNoYWRvdy1pbnNldCAiICsKCQkJCQkidWktYmFyLSIgKyB0aGVtZSArICIgIiArCgkJCQkJKCBvcHRpb25zLndyYXBwZXJDbGFzcyA/IG9wdGlvbnMud3JhcHBlckNsYXNzIDogIiIgKSArICIgIiArCgkJCQkJKCAoIGVsZW1lbnQuaXMoICI6Y2hlY2tlZCIgKSB8fAoJCQkJCQllbGVtZW50CgkJCQkJCQkuZmluZCggIm9wdGlvbiIgKQoJCQkJCQkJLmVxKCAxICkKCQkJCQkJCS5pcyggIjpzZWxlY3RlZCIgKSApID8gInVpLWZsaXBzd2l0Y2gtYWN0aXZlIiA6ICIiICkgKwoJCQkJCSggZWxlbWVudC5pcygiOmRpc2FibGVkIikgPyAiIHVpLXN0YXRlLWRpc2FibGVkIjogIiIpICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCI6ICIiICkgKwoJCQkJCSggb3B0aW9ucy5taW5pID8gIiB1aS1taW5pIjogIiIgKSApCgkJCQkuYXBwZW5kKCBvbiwgb2ZmICk7CgoJCQllbGVtZW50CgkJCQkuYWRkQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWlucHV0IiApCgkJCQkuYWZ0ZXIoIGZsaXBzd2l0Y2ggKQoJCQkJLmFwcGVuZFRvKCBmbGlwc3dpdGNoICk7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCWZsaXBzd2l0Y2g6IGZsaXBzd2l0Y2gsCgkJCW9uOiBvbiwKCQkJb2ZmOiBvZmYsCgkJCXR5cGU6IHR5cGUKCQl9KTsKCX0sCgoJX3Jlc2V0OiBmdW5jdGlvbigpIHsKCQl0aGlzLnJlZnJlc2goKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdmFyIGRpcmVjdGlvbiwKCQkJZXhpc3RpbmdEaXJlY3Rpb24gPSB0aGlzLmZsaXBzd2l0Y2guaGFzQ2xhc3MoICJ1aS1mbGlwc3dpdGNoLWFjdGl2ZSIgKSA/ICJfcmlnaHQiIDogIl9sZWZ0IjsKCgkJaWYgKCB0aGlzLnR5cGUgPT09ICJTRUxFQ1QiICkgewoJCQlkaXJlY3Rpb24gPSAoIHRoaXMuZWxlbWVudC5nZXQoIDAgKS5zZWxlY3RlZEluZGV4ID4gMCApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfSBlbHNlIHsKCQkJZGlyZWN0aW9uID0gdGhpcy5lbGVtZW50LnByb3AoICJjaGVja2VkIiApID8gIl9yaWdodCI6ICJfbGVmdCI7CgkJfQoKCQlpZiAoIGRpcmVjdGlvbiAhPT0gZXhpc3RpbmdEaXJlY3Rpb24gKSB7CgkJCXRoaXNbIGRpcmVjdGlvbiBdKCk7CgkJfQoJfSwKCglfdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl2YXIgZGlyZWN0aW9uID0gdGhpcy5mbGlwc3dpdGNoLmhhc0NsYXNzKCAidWktZmxpcHN3aXRjaC1hY3RpdmUiICkgPyAiX2xlZnQiIDogIl9yaWdodCI7CgoJCXRoaXNbIGRpcmVjdGlvbiBdKCk7Cgl9LAoKCV9rZXlkb3duOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuTEVGVCApIHsKCQkJdGhpcy5fbGVmdCgpOwoJCX0gZWxzZSBpZiAoIGUud2hpY2ggPT09ICQubW9iaWxlLmtleUNvZGUuUklHSFQgKSB7CgkJCXRoaXMuX3JpZ2h0KCk7CgkJfSBlbHNlIGlmICggZS53aGljaCA9PT0gJC5tb2JpbGUua2V5Q29kZS5TUEFDRSApIHsKCQkJdGhpcy5fdG9nZ2xlKCk7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQl9Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdmFyIGN1cnJlbnRUaGVtZSA9IG9wdGlvbnMudGhlbWUgPyBvcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQkJbmV3VGhlbWUgPSBvcHRpb25zLnRoZW1lID8gb3B0aW9ucy50aGVtZSA6ICJpbmhlcml0IjsKCgkJCXRoaXMud2lkZ2V0KCkKCQkJCS5yZW1vdmVDbGFzcyggInVpLWJhci0iICsgY3VycmVudFRoZW1lICkKCQkJCS5hZGRDbGFzcyggInVpLWJhci0iICsgbmV3VGhlbWUgKTsKCQl9CgkJaWYgKCBvcHRpb25zLm9uVGV4dCAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLm9uLnRleHQoIG9wdGlvbnMub25UZXh0ICk7CgkJfQoJCWlmICggb3B0aW9ucy5vZmZUZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub2ZmLnRleHQoIG9wdGlvbnMub2ZmVGV4dCApOwoJCX0KCQlpZiAoIG9wdGlvbnMuZGlzYWJsZWQgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy53aWRnZXQoKS50b2dnbGVDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiwgb3B0aW9ucy5kaXNhYmxlZCApOwoJCX0KCQlpZiAoIG9wdGlvbnMubWluaSAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktbWluaSIsIG9wdGlvbnMubWluaSApOwoJCX0KCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGlzLndpZGdldCgpLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoJCXRoaXMub24ucmVtb3ZlKCk7CgkJdGhpcy5vZmYucmVtb3ZlKCk7CgkJdGhpcy5lbGVtZW50LnVud3JhcCgpOwoJCXRoaXMuZmxpcHN3aXRjaC5yZW1vdmUoKTsKCQl0aGlzLnJlbW92ZUNsYXNzKCAidWktZmxpcHN3aXRjaC1pbnB1dCIgKTsKCX0KCn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgkkLndpZGdldCggIm1vYmlsZS5yYW5nZXNsaWRlciIsICQuZXh0ZW5kKCB7CgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCXRyYWNrVGhlbWU6IG51bGwsCgkJCWNvcm5lcnM6IHRydWUsCgkJCW1pbmk6IGZhbHNlLAoJCQloaWdobGlnaHQ6IHRydWUKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyICRlbCA9IHRoaXMuZWxlbWVudCwKCQkJZWxDbGFzcyA9IHRoaXMub3B0aW9ucy5taW5pID8gInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiIDogInVpLXJhbmdlc2xpZGVyIiwKCQkJX2lucHV0Rmlyc3QgPSAkZWwuZmluZCggImlucHV0IiApLmZpcnN0KCksCgkJCV9pbnB1dExhc3QgPSAkZWwuZmluZCggImlucHV0IiApLmxhc3QoKSwKCQkJX2xhYmVsID0gJGVsLmZpbmQoICJsYWJlbCIgKS5maXJzdCgpLAoJCQlfc2xpZGVyV2lkZ2V0Rmlyc3QgPSAkLmRhdGEoIF9pbnB1dEZpcnN0LmdldCggMCApLCAibW9iaWxlLXNsaWRlciIgKSB8fAoJCQkJJC5kYXRhKCBfaW5wdXRGaXJzdC5zbGlkZXIoKS5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICksCgkJCV9zbGlkZXJXaWRnZXRMYXN0ID0gJC5kYXRhKCBfaW5wdXRMYXN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkgfHwKCQkJCSQuZGF0YSggX2lucHV0TGFzdC5zbGlkZXIoKS5nZXQoIDAgKSwgIm1vYmlsZS1zbGlkZXIiICksCgkJCV9zbGlkZXJGaXJzdCA9IF9zbGlkZXJXaWRnZXRGaXJzdC5zbGlkZXIsCgkJCV9zbGlkZXJMYXN0ID0gX3NsaWRlcldpZGdldExhc3Quc2xpZGVyLAoJCQlmaXJzdEhhbmRsZSA9IF9zbGlkZXJXaWRnZXRGaXJzdC5oYW5kbGUsCgkJCV9zbGlkZXJzID0gJCggIjxkaXYgY2xhc3M9J3VpLXJhbmdlc2xpZGVyLXNsaWRlcnMnIC8+IiApLmFwcGVuZFRvKCAkZWwgKTsKCgkJCV9pbnB1dEZpcnN0LmFkZENsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QiICk7CgkJCV9pbnB1dExhc3QuYWRkQ2xhc3MoICJ1aS1yYW5nZXNsaWRlci1sYXN0IiApOwoJCQkkZWwuYWRkQ2xhc3MoIGVsQ2xhc3MgKTsKCgkJCV9zbGlkZXJGaXJzdC5hcHBlbmRUbyggX3NsaWRlcnMgKTsKCQkJX3NsaWRlckxhc3QuYXBwZW5kVG8oIF9zbGlkZXJzICk7CgkJCV9sYWJlbC5pbnNlcnRCZWZvcmUoICRlbCApOwoJCQlmaXJzdEhhbmRsZS5wcmVwZW5kVG8oIF9zbGlkZXJMYXN0ICk7CgoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJX2lucHV0Rmlyc3Q6IF9pbnB1dEZpcnN0LAoJCQkJX2lucHV0TGFzdDogX2lucHV0TGFzdCwKCQkJCV9zbGlkZXJGaXJzdDogX3NsaWRlckZpcnN0LAoJCQkJX3NsaWRlckxhc3Q6IF9zbGlkZXJMYXN0LAoJCQkJX2xhYmVsOiBfbGFiZWwsCgkJCQlfdGFyZ2V0VmFsOiBudWxsLAoJCQkJX3NsaWRlclRhcmdldDogZmFsc2UsCgkJCQlfc2xpZGVyczogX3NsaWRlcnMsCgkJCQlfcHJveHk6IGZhbHNlCgkJCX0pOwoKCQkJdGhpcy5yZWZyZXNoKCk7CgkJCXRoaXMuX29uKCB0aGlzLmVsZW1lbnQuZmluZCggImlucHV0LnVpLXNsaWRlci1pbnB1dCIgKSwgewoJCQkJInNsaWRlYmVmb3Jlc3RhcnQiOiAiX3NsaWRlYmVmb3Jlc3RhcnQiLAoJCQkJInNsaWRlc3RvcCI6ICJfc2xpZGVzdG9wIiwKCQkJCSJzbGlkZWRyYWciOiAiX3NsaWRlZHJhZyIsCgkJCQkic2xpZGViZWZvcmVjaGFuZ2UiOiAiX2NoYW5nZSIsCgkJCQkiYmx1ciI6ICJfY2hhbmdlIiwKCQkJCSJrZXl1cCI6ICJfY2hhbmdlIgoJCQl9KTsKCQkJdGhpcy5fb24oewoJCQkJIm1vdXNlZG93biI6Il9jaGFuZ2UiCgkJCX0pOwoJCQl0aGlzLl9vbiggdGhpcy5lbGVtZW50LmNsb3Nlc3QoICJmb3JtIiApLCB7CgkJCQkicmVzZXQiOiJfaGFuZGxlUmVzZXQiCgkJCX0pOwoJCQl0aGlzLl9vbiggZmlyc3RIYW5kbGUsIHsKCQkJCSJ2bW91c2Vkb3duIjogIl9kcmFnRmlyc3RIYW5kbGUiCgkJCX0pOwoJCX0sCgkJX2hhbmRsZVJlc2V0OiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzOwoJCQkvL3dlIG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBiZWZvcmUgdXBkYXRlaW5nIG90aGVyIHdpc2Ugc2xpZGVycyB3aWxsIG5vdCBoYXZlIHVwZGF0ZWQgeWV0CgkJCXNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5fdXBkYXRlSGlnaGxpZ2h0KCk7CgkJCX0sMCk7CgkJfSwKCgkJX2RyYWdGaXJzdEhhbmRsZTogZnVuY3Rpb24oIGV2ZW50ICkgewoJCQkvL2lmIHRoZSBmaXJzdCBoYW5kbGUgaXMgZHJhZ2dlZCBzZW5kIHRoZSBldmVudCB0byB0aGUgZmlyc3Qgc2xpZGVyCgkJCSQuZGF0YSggdGhpcy5faW5wdXRGaXJzdC5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmRyYWdnaW5nID0gdHJ1ZTsKCQkJJC5kYXRhKCB0aGlzLl9pbnB1dEZpcnN0LmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkucmVmcmVzaCggZXZlbnQgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0sCgoJCV9zbGlkZWRyYWc6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdmFyIGZpcnN0ID0gJCggZXZlbnQudGFyZ2V0ICkuaXMoIHRoaXMuX2lucHV0Rmlyc3QgKSwKCQkJCW90aGVyU2xpZGVyID0gKCBmaXJzdCApID8gdGhpcy5faW5wdXRMYXN0IDogdGhpcy5faW5wdXRGaXJzdDsKCgkJCXRoaXMuX3NsaWRlclRhcmdldCA9IGZhbHNlOwoJCQkvL2lmIHRoZSBkcmFnIHdhcyBpbml0aWF0ZWQgb24gYW4gZXh0cmVtZSBhbmQgdGhlIG90aGVyIGhhbmRsZSBpcyBmb2N1c2VkIHNlbmQgdGhlIGV2ZW50cyB0bwoJCQkvL3RoZSBjbG9zZXN0IGhhbmRsZQoJCQlpZiAoICggdGhpcy5fcHJveHkgPT09ICJmaXJzdCIgJiYgZmlyc3QgKSB8fCAoIHRoaXMuX3Byb3h5ID09PSAibGFzdCIgJiYgIWZpcnN0ICkgKSB7CgkJCQkkLmRhdGEoIG90aGVyU2xpZGVyLmdldCgwKSwgIm1vYmlsZS1zbGlkZXIiICkuZHJhZ2dpbmcgPSB0cnVlOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLnJlZnJlc2goIGV2ZW50ICk7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfc2xpZGVzdG9wOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCXZhciBmaXJzdCA9ICQoIGV2ZW50LnRhcmdldCApLmlzKCB0aGlzLl9pbnB1dEZpcnN0ICk7CgoJCQl0aGlzLl9wcm94eSA9IGZhbHNlOwoJCQkvL3RoaXMgc3RvcHMgZHJhZ2dpbmcgb2YgdGhlIGhhbmRsZSBhbmQgYnJpbmdzIHRoZSBhY3RpdmUgdHJhY2sgdG8gdGhlIGZyb250CgkJCS8vdGhpcyBtYWtlcyBjbGlja3Mgb24gdGhlIHRyYWNrIGdvIHRoZSB0aGUgbGFzdCBoYW5kbGUgdXNlZAoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnRyaWdnZXIoICJ2bW91c2V1cCIgKTsKCQkJdGhpcy5fc2xpZGVyRmlyc3QuY3NzKCAiei1pbmRleCIsIGZpcnN0ID8gMSA6ICIiICk7CgkJfSwKCgkJX3NsaWRlYmVmb3Jlc3RhcnQ6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5fc2xpZGVyVGFyZ2V0ID0gZmFsc2U7CgkJCS8vaWYgdGhlIHRyYWNrIGlzIHRoZSB0YXJnZXQgcmVtZW1iZXIgdGhpcyBhbmQgdGhlIG9yaWdpbmFsIHZhbHVlCgkJCWlmICggJCggZXZlbnQub3JpZ2luYWxFdmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXNsaWRlci10cmFjayIgKSApIHsKCQkJCXRoaXMuX3NsaWRlclRhcmdldCA9IHRydWU7CgkJCQl0aGlzLl90YXJnZXRWYWwgPSAkKCBldmVudC50YXJnZXQgKS52YWwoKTsKCQkJfQoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJaWYgKCBvcHRpb25zLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRUaGVtZSggb3B0aW9ucy50aGVtZSApOwoJCQl9CgoJCQlpZiAoIG9wdGlvbnMudHJhY2tUaGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0VHJhY2tUaGVtZSggb3B0aW9ucy50cmFja1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0aW9ucy5taW5pICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLl9zZXRNaW5pKCBvcHRpb25zLm1pbmkgKTsKCQkJfQoKCQkJaWYgKCBvcHRpb25zLmhpZ2hsaWdodCAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fc2V0SGlnaGxpZ2h0KCBvcHRpb25zLmhpZ2hsaWdodCApOwoJCQl9CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0sCgoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJbyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggdGhpcy5faW5wdXRGaXJzdC5pcyggIjpkaXNhYmxlZCIgKSB8fCB0aGlzLl9pbnB1dExhc3QuaXMoICI6ZGlzYWJsZWQiICkgKSB7CgkJCQl0aGlzLm9wdGlvbnMuZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgoJCQkkZWwuZmluZCggImlucHV0IiApLnNsaWRlcih7CgkJCQl0aGVtZTogby50aGVtZSwKCQkJCXRyYWNrVGhlbWU6IG8udHJhY2tUaGVtZSwKCQkJCWRpc2FibGVkOiBvLmRpc2FibGVkLAoJCQkJY29ybmVyczogby5jb3JuZXJzLAoJCQkJbWluaTogby5taW5pLAoJCQkJaGlnaGxpZ2h0OiBvLmhpZ2hsaWdodAoJCQl9KS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQl0aGlzLl91cGRhdGVIaWdobGlnaHQoKTsKCQl9LAoKCQlfY2hhbmdlOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCWlmICggZXZlbnQudHlwZSA9PT0gImtleXVwIiApIHsKCQkJCXRoaXMuX3VwZGF0ZUhpZ2hsaWdodCgpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgoJCQl2YXIgc2VsZiA9IHRoaXMsCgkJCQltaW4gPSBwYXJzZUZsb2F0KCB0aGlzLl9pbnB1dEZpcnN0LnZhbCgpLCAxMCApLAoJCQkJbWF4ID0gcGFyc2VGbG9hdCggdGhpcy5faW5wdXRMYXN0LnZhbCgpLCAxMCApLAoJCQkJZmlyc3QgPSAkKCBldmVudC50YXJnZXQgKS5oYXNDbGFzcyggInVpLXJhbmdlc2xpZGVyLWZpcnN0IiApLAoJCQkJdGhpc1NsaWRlciA9IGZpcnN0ID8gdGhpcy5faW5wdXRGaXJzdCA6IHRoaXMuX2lucHV0TGFzdCwKCQkJCW90aGVyU2xpZGVyID0gZmlyc3QgPyB0aGlzLl9pbnB1dExhc3QgOiB0aGlzLl9pbnB1dEZpcnN0OwoKCQkJaWYgKCAoIHRoaXMuX2lucHV0Rmlyc3QudmFsKCkgPiB0aGlzLl9pbnB1dExhc3QudmFsKCkgJiYgZXZlbnQudHlwZSA9PT0gIm1vdXNlZG93biIgJiYgISQoZXZlbnQudGFyZ2V0KS5oYXNDbGFzcygidWktc2xpZGVyLWhhbmRsZSIpKSApIHsKCQkJCXRoaXNTbGlkZXIuYmx1cigpOwoJCQl9IGVsc2UgaWYgKCBldmVudC50eXBlID09PSAibW91c2Vkb3duIiApIHsKCQkJCXJldHVybjsKCQkJfQoJCQlpZiAoIG1pbiA+IG1heCAmJiAhdGhpcy5fc2xpZGVyVGFyZ2V0ICkgewoJCQkJLy90aGlzIHByZXZlbnRzIG1pbiBmcm9tIGJlaW5nIGdyZWF0ZXIgdGhlbiBtYXgKCQkJCXRoaXNTbGlkZXIudmFsKCBmaXJzdCA/IG1heDogbWluICkuc2xpZGVyKCAicmVmcmVzaCIgKTsKCQkJCXRoaXMuX3RyaWdnZXIoICJub3JtYWxpemUiICk7CgkJCX0gZWxzZSBpZiAoIG1pbiA+IG1heCApIHsKCQkJCS8vdGhpcyBtYWtlcyBpdCBzbyBjbGlja3Mgb24gdGhlIHRhcmdldCBvbiBlaXRoZXIgZXh0cmVtZSBnbyB0byB0aGUgY2xvc2VzdCBoYW5kbGUKCQkJCXRoaXNTbGlkZXIudmFsKCB0aGlzLl90YXJnZXRWYWwgKS5zbGlkZXIoICJyZWZyZXNoIiApOwoKCQkJCS8vWW91IG11c3Qgd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBzbyBmaXJzdCBzbGlkZXIgaXMgdXBkYXRlZCBiZWZvcmUgdXBkYXRpbmcgc2Vjb25kCgkJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQlvdGhlclNsaWRlci52YWwoIGZpcnN0ID8gbWluOiBtYXggKS5zbGlkZXIoICJyZWZyZXNoIiApOwoJCQkJCSQuZGF0YSggb3RoZXJTbGlkZXIuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZm9jdXMoKTsKCQkJCQlzZWxmLl9zbGlkZXJGaXJzdC5jc3MoICJ6LWluZGV4IiwgZmlyc3QgPyAiIiA6IDEgKTsKCQkJCQlzZWxmLl90cmlnZ2VyKCAibm9ybWFsaXplIiApOwoJCQkJfSwgMCApOwoJCQkJdGhpcy5fcHJveHkgPSAoIGZpcnN0ICkgPyAiZmlyc3QiIDogImxhc3QiOwoJCQl9CgkJCS8vZml4ZXMgaXNzdWUgd2hlcmUgd2hlbiBib3RoIF9zbGlkZXJzIGFyZSBhdCBtaW4gdGhleSBjYW5ub3QgYmUgYWRqdXN0ZWQKCQkJaWYgKCBtaW4gPT09IG1heCApIHsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMSApOwoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgMCApOwoJCQl9IGVsc2UgewoJCQkJJC5kYXRhKCBvdGhlclNsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJCSQuZGF0YSggdGhpc1NsaWRlci5nZXQoMCksICJtb2JpbGUtc2xpZGVyIiApLmhhbmRsZS5jc3MoICJ6LWluZGV4IiwgIiIgKTsKCQkJfQoKCQkJdGhpcy5fdXBkYXRlSGlnaGxpZ2h0KCk7CgoJCQlpZiAoIG1pbiA+PSBtYXggKSB7CgkJCQlyZXR1cm4gZmFsc2U7CgkJCX0KCQl9LAoKCQlfdXBkYXRlSGlnaGxpZ2h0OiBmdW5jdGlvbigpIHsKCQkJdmFyIG1pbiA9IHBhcnNlSW50KCAkLmRhdGEoIHRoaXMuX2lucHV0Rmlyc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQltYXggPSBwYXJzZUludCggJC5kYXRhKCB0aGlzLl9pbnB1dExhc3QuZ2V0KDApLCAibW9iaWxlLXNsaWRlciIgKS5oYW5kbGUuZ2V0KDApLnN0eWxlLmxlZnQsIDEwICksCgkJCQl3aWR0aCA9IChtYXggLSBtaW4pOwoKCQkJdGhpcy5lbGVtZW50LmZpbmQoICIudWktc2xpZGVyLWJnIiApLmNzcyh7CgkJCQkibWFyZ2luLWxlZnQiOiBtaW4gKyAiJSIsCgkJCQkid2lkdGgiOiB3aWR0aCArICIlIgoJCQl9KTsKCQl9LAoKCQlfc2V0VGhlbWU6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQkJdGhpcy5faW5wdXRGaXJzdC5zbGlkZXIoICJvcHRpb24iLCAidGhlbWUiLCB2YWx1ZSApOwoJCQl0aGlzLl9pbnB1dExhc3Quc2xpZGVyKCAib3B0aW9uIiwgInRoZW1lIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0VHJhY2tUaGVtZTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJ0cmFja1RoZW1lIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJ0cmFja1RoZW1lIiwgdmFsdWUgKTsKCQl9LAoKCQlfc2V0TWluaTogZnVuY3Rpb24oIHZhbHVlICkgewoJCQl0aGlzLl9pbnB1dEZpcnN0LnNsaWRlciggIm9wdGlvbiIsICJtaW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5faW5wdXRMYXN0LnNsaWRlciggIm9wdGlvbiIsICJtaW5pIiwgdmFsdWUgKTsKCQkJdGhpcy5lbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktbWluaSIsICEhdmFsdWUgKTsKCQl9LAoKCQlfc2V0SGlnaGxpZ2h0OiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJCXRoaXMuX2lucHV0Rmlyc3Quc2xpZGVyKCAib3B0aW9uIiwgImhpZ2hsaWdodCIsIHZhbHVlICk7CgkJCXRoaXMuX2lucHV0TGFzdC5zbGlkZXIoICJvcHRpb24iLCAiaGlnaGxpZ2h0IiwgdmFsdWUgKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2xhYmVsLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCXRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLXJhbmdlc2xpZGVyIHVpLW1pbmkiICk7CgkJCXRoaXMuX2lucHV0Rmlyc3QuYWZ0ZXIoIHRoaXMuX3NsaWRlckZpcnN0ICk7CgkJCXRoaXMuX2lucHV0TGFzdC5hZnRlciggdGhpcy5fc2xpZGVyTGFzdCApOwoJCQl0aGlzLl9zbGlkZXJzLnJlbW92ZSgpOwoJCQl0aGlzLmVsZW1lbnQuZmluZCggImlucHV0IiApLnJlbW92ZUNsYXNzKCAidWktcmFuZ2VzbGlkZXItZmlyc3QgdWktcmFuZ2VzbGlkZXItbGFzdCIgKS5zbGlkZXIoICJkZXN0cm95IiApOwoJCX0KCgl9LCAkLm1vYmlsZS5iZWhhdmlvcnMuZm9ybVJlc2V0ICkgKTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJY2xlYXJCdG46IGZhbHNlLAoJCQljbGVhckJ0blRleHQ6ICJDbGVhciB0ZXh0IgoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoKCQkJaWYgKCAhIXRoaXMub3B0aW9ucy5jbGVhckJ0biB8fCB0aGlzLmlzU2VhcmNoICkgewoJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJfQoJCX0sCgoJCWNsZWFyQnV0dG9uOiBmdW5jdGlvbigpIHsKCgkJCXJldHVybiAkKCAiPGEgaHJlZj0nIycgY2xhc3M9J3VpLWlucHV0LWNsZWFyIHVpLWJ0biB1aS1pY29uLWRlbGV0ZSB1aS1idG4taWNvbi1ub3RleHQgdWktY29ybmVyLWFsbCIgKwogICAgIicgdGl0bGU9JyIgKyB0aGlzLm9wdGlvbnMuY2xlYXJCdG5UZXh0ICsgIic+IiArIHRoaXMub3B0aW9ucy5jbGVhckJ0blRleHQgKyAiPC9hPiIgKTsKCgkJfSwKCgkJX2NsZWFyQnRuQ2xpY2s6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJdGhpcy5lbGVtZW50LnZhbCggIiIgKQoJCQkJCS5mb2N1cygpCgkJCQkJLnRyaWdnZXIoICJjaGFuZ2UiICk7CgoJCQl0aGlzLl9jbGVhckJ0bi5hZGRDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIgKTsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQl9LAoKCQlfYWRkQ2xlYXJCdG46IGZ1bmN0aW9uKCkgewoKCQkJaWYgKCAhdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQkJdGhpcy5fZW5oYW5jZUNsZWFyKCk7CgkJCX0KCgkJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCQlfY2xlYXJCdG46IHRoaXMud2lkZ2V0KCkuZmluZCgiYS51aS1pbnB1dC1jbGVhciIpCgkJCX0pOwoKCQkJdGhpcy5fYmluZENsZWFyRXZlbnRzKCk7CgoJCQl0aGlzLl90b2dnbGVDbGVhcigpOwoKCQl9LAoKCQlfZW5oYW5jZUNsZWFyOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuY2xlYXJCdXR0b24oKS5hcHBlbmRUbyggdGhpcy53aWRnZXQoKSApOwoJCQl0aGlzLndpZGdldCgpLmFkZENsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoKCQl9LAoKCQlfYmluZENsZWFyRXZlbnRzOiBmdW5jdGlvbigpIHsKCgkJCXRoaXMuX29uKCB0aGlzLl9jbGVhckJ0biwgewoJCQkJImNsaWNrIjogIl9jbGVhckJ0bkNsaWNrIgoJCQl9KTsKCgkJCXRoaXMuX29uKHsKCQkJCSJrZXl1cCI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImNoYW5nZSI6ICJfdG9nZ2xlQ2xlYXIiLAoJCQkJImlucHV0IjogIl90b2dnbGVDbGVhciIsCgkJCQkiZm9jdXMiOiAiX3RvZ2dsZUNsZWFyIiwKCQkJCSJibHVyIjogIl90b2dnbGVDbGVhciIsCgkJCQkiY3V0IjogIl90b2dnbGVDbGVhciIsCgkJCQkicGFzdGUiOiAiX3RvZ2dsZUNsZWFyIgoKCQkJfSk7CgoJCX0sCgoJCV91bmJpbmRDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX29mZiggdGhpcy5fY2xlYXJCdG4sICJjbGljayIpOwoJCQl0aGlzLl9vZmYoIHRoaXMuZWxlbWVudCwgImtleXVwIGNoYW5nZSBpbnB1dCBmb2N1cyBibHVyIGN1dCBwYXN0ZSIgKTsKCQl9LAoKCQlfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJCXRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCQlpZiAoIG9wdGlvbnMuY2xlYXJidG4gIT09IHVuZGVmaW5lZCAmJiAhdGhpcy5lbGVtZW50LmlzKCAidGV4dGFyZWEsIDpqcW1EYXRhKHR5cGU9J3JhbmdlJykiICkgKSB7CgkJCQlpZiAoIG9wdGlvbnMuY2xlYXJCdG4gKSB7CgkJCQkJdGhpcy5fYWRkQ2xlYXJCdG4oKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5fZGVzdHJveUNsZWFyKCk7CgkJCQl9CgkJCX0KCgkJCWlmICggb3B0aW9ucy5jbGVhckJ0blRleHQgIT09IHVuZGVmaW5lZCAmJiB0aGlzLl9jbGVhckJ0biAhPT0gdW5kZWZpbmVkICkgewoJCQkJdGhpcy5fY2xlYXJCdG4udGV4dCggb3B0aW9ucy5jbGVhckJ0blRleHQgKTsKCQkJfQoJCX0sCgoJCV90b2dnbGVDbGVhcjogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX2RlbGF5KCAiX3RvZ2dsZUNsZWFyQ2xhc3MiLCAwICk7CgkJfSwKCgkJX3RvZ2dsZUNsZWFyQ2xhc3M6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9jbGVhckJ0bi50b2dnbGVDbGFzcyggInVpLWlucHV0LWNsZWFyLWhpZGRlbiIsICF0aGlzLmVsZW1lbnQudmFsKCkgKTsKCQl9LAoKCQlfZGVzdHJveUNsZWFyOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktaW5wdXQtaGFzLWNsZWFyIiApOwoJCQl0aGlzLl91bmJpbmRDbGVhcigpLl9jbGVhckJ0bi5yZW1vdmUoKTsKCQl9LAoKCQlfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCXRoaXMuX2Rlc3Ryb3lDbGVhcigpOwoJCX0KCgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRleHRpbnB1dCIsICQubW9iaWxlLnRleHRpbnB1dCwgewoJCW9wdGlvbnM6IHsKCQkJYXV0b2dyb3c6dHJ1ZSwKCQkJa2V5dXBUaW1lb3V0QnVmZmVyOiAxMDAKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fc3VwZXIoKTsKCgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX2F1dG9ncm93KCk7CgkJCX0KCQl9LAoKCQlfYXV0b2dyb3c6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9vbih7CgkJCQkia2V5dXAiOiAiX3RpbWVvdXQiLAoJCQkJImNoYW5nZSI6ICJfdGltZW91dCIsCgkJCQkiaW5wdXQiOiAiX3RpbWVvdXQiLAoJCQkJInBhc3RlIjogIl90aW1lb3V0IiwKCQkJfSk7CgoJCQkvLyBBdHRhY2ggdG8gdGhlIHZhcmlvdXMgeW91LWhhdmUtYmVjb21lLXZpc2libGUgbm90aWZpY2F0aW9ucyB0aGF0IHRoZQoJCQkvLyB2YXJpb3VzIGZyYW1ld29yayBlbGVtZW50cyBlbWl0LgoJCQkvLyBUT0RPOiBSZW1vdmUgYWxsIGJ1dCB0aGUgdXBkYXRlbGF5b3V0IGhhbmRsZXIgb25jZSAjNjQyNiBpcyBmaXhlZC4KCQkJdGhpcy5fb24oIHRydWUsIHRoaXMuZG9jdW1lbnQsIHsKCgkJCQkvLyBUT0RPOiBNb3ZlIHRvIG5vbi1kZXByZWNhdGVkIGV2ZW50CgkJCQkicGFnZXNob3ciOiAiX2hhbmRsZVNob3ciLAoJCQkJInBvcHVwYmVmb3JlcG9zaXRpb24iOiAiX2hhbmRsZVNob3ciLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlU2hvdyIsCgkJCQkicGFuZWxvcGVuIjogIl9oYW5kbGVTaG93IgoJCQl9KTsKCQl9LAoKCQkvLyBTeW5jaHJvbm91c2x5IGZpeCB0aGUgd2lkZ2V0IGhlaWdodCBpZiB0aGlzIHdpZGdldCdzIHBhcmVudHMgYXJlIHN1Y2gKCQkvLyB0aGF0IHRoZXkgc2hvdy9oaWRlIGNvbnRlbnQgYXQgcnVudGltZS4gV2Ugc3RpbGwgbmVlZCB0byBjaGVjayB3aGV0aGVyCgkJLy8gdGhlIHdpZGdldCBpcyBhY3R1YWxseSB2aXNpYmxlIGluIGNhc2UgaXQgaXMgY29udGFpbmVkIGluc2lkZSBtdWx0aXBsZQoJCS8vIHN1Y2ggY29udGFpbmVycy4gRm9yIGV4YW1wbGU6IHBhbmVsIGNvbnRhaW5zIGNvbGxhcHNpYmxlIGNvbnRhaW5zCgkJLy8gYXV0b2dyb3cgdGV4dGlucHV0LiBUaGUgcGFuZWwgbWF5IGVtaXQgInBhbmVsb3BlbiIgaW5kaWNhdGluZyB0aGF0IGl0cwoJCS8vIGNvbnRlbnQgaGFzIGJlY29tZSB2aXNpYmxlLCBidXQgdGhlIGNvbGxhcHNpYmxlIGlzIHN0aWxsIGNvbGxhcHNlZCwgc28KCQkvLyB0aGUgYXV0b2dyb3cgdGV4dGFyZWEgaXMgc3RpbGwgbm90IHZpc2libGUuCgkJX2hhbmRsZVNob3c6IGZ1bmN0aW9uKCBldmVudCApIHsKCQkJaWYgKCAkLmNvbnRhaW5zKCBldmVudC50YXJnZXQsIHRoaXMuZWxlbWVudFsgMCBdICkgJiYKCQkJCXRoaXMuZWxlbWVudC5pcyggIjp2aXNpYmxlIiApICkgewoKCQkJCWlmICggZXZlbnQudHlwZSAhPT0gInBvcHVwYmVmb3JlcG9zaXRpb24iICkgewoJCQkJCXRoaXMuZWxlbWVudAoJCQkJCQkuYWRkQ2xhc3MoICJ1aS10ZXh0aW5wdXQtYXV0b2dyb3ctcmVzaXplIiApCgkJCQkJCS5vbmUoICJ0cmFuc2l0aW9uZW5kIHdlYmtpdFRyYW5zaXRpb25FbmQgb1RyYW5zaXRpb25FbmQiLAoJCQkJCQkJJC5wcm94eSggZnVuY3Rpb24oKSB7CgkJCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktdGV4dGlucHV0LWF1dG9ncm93LXJlc2l6ZSIgKTsKCQkJCQkJCX0sIHRoaXMgKSApOwoJCQkJfQoJCQkJdGhpcy5fcHJlcGFyZUhlaWdodFVwZGF0ZSgpOwoJCQl9CgkJfSwKCgkJX3VuYmluZEF1dG9ncm93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy5fb2ZmKCB0aGlzLmVsZW1lbnQsICJrZXl1cCBjaGFuZ2UgaW5wdXQgcGFzdGUiICk7CgkJCXRoaXMuX29mZiggdGhpcy5kb2N1bWVudCwKCQkJCSJwYWdlc2hvdyBwb3B1cGJlZm9yZXBvc2l0aW9uIHVwZGF0ZWxheW91dCBwYW5lbG9wZW4iICk7CgkJfSwKCgkJa2V5dXBUaW1lb3V0OiBudWxsLAoKCQlfcHJlcGFyZUhlaWdodFVwZGF0ZTogZnVuY3Rpb24oIGRlbGF5ICkgewoJCQlpZiAoIHRoaXMua2V5dXBUaW1lb3V0ICkgewoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmtleXVwVGltZW91dCApOwoJCQl9CgkJCWlmICggZGVsYXkgPT09IHVuZGVmaW5lZCApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5rZXl1cFRpbWVvdXQgPSB0aGlzLl9kZWxheSggIl91cGRhdGVIZWlnaHQiLCBkZWxheSApOwoJCQl9CgkJfSwKCgkJX3RpbWVvdXQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9wcmVwYXJlSGVpZ2h0VXBkYXRlKCB0aGlzLm9wdGlvbnMua2V5dXBUaW1lb3V0QnVmZmVyICk7CgkJfSwKCgkJX3VwZGF0ZUhlaWdodDogZnVuY3Rpb24oKSB7CgoJCQl0aGlzLmtleXVwVGltZW91dCA9IDA7CgoJCQl0aGlzLmVsZW1lbnQuY3NzKHsKCQkJCSJoZWlnaHQiOiAwLAoJCQkJIm1pbi1oZWlnaHQiOiAwLAoJCQkJIm1heC1oZWlnaHQiOiAwCgkJCX0pOwoKCQkJdmFyIHBhZGRpbmdUb3AsIHBhZGRpbmdCb3R0b20sIHBhZGRpbmdIZWlnaHQsCgkJCQlzY3JvbGxIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5zY3JvbGxIZWlnaHQsCgkJCQljbGllbnRIZWlnaHQgPSB0aGlzLmVsZW1lbnRbIDAgXS5jbGllbnRIZWlnaHQsCgkJCQlib3JkZXJUb3AgPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAiYm9yZGVyLXRvcC13aWR0aCIgKSApLAoJCQkJYm9yZGVyQm90dG9tID0gcGFyc2VGbG9hdCggdGhpcy5lbGVtZW50LmNzcyggImJvcmRlci1ib3R0b20td2lkdGgiICkgKSwKCQkJCWJvcmRlckhlaWdodCA9IGJvcmRlclRvcCArIGJvcmRlckJvdHRvbSwKCQkJCWhlaWdodCA9IHNjcm9sbEhlaWdodCArIGJvcmRlckhlaWdodCArIDE1OwoKCQkJLy8gSXNzdWUgNjE3OTogUGFkZGluZyBpcyBub3QgaW5jbHVkZWQgaW4gc2Nyb2xsSGVpZ2h0IGFuZAoJCQkvLyBjbGllbnRIZWlnaHQgYnkgRmlyZWZveCBpZiBubyBzY3JvbGxiYXIgaXMgdmlzaWJsZS4gQmVjYXVzZQoJCQkvLyB0ZXh0YXJlYXMgdXNlIHRoZSBib3JkZXItYm94IGJveC1zaXppbmcgbW9kZWwsIHBhZGRpbmcgc2hvdWxkIGJlCgkJCS8vIGluY2x1ZGVkIGluIHRoZSBuZXcgKGFzc2lnbmVkKSBoZWlnaHQuIEJlY2F1c2UgdGhlIGhlaWdodCBpcyBzZXQKCQkJLy8gdG8gMCwgY2xpZW50SGVpZ2h0ID09IDAgaW4gRmlyZWZveC4gVGhlcmVmb3JlLCB3ZSBjYW4gdXNlIHRoaXMgdG8KCQkJLy8gY2hlY2sgaWYgcGFkZGluZyBtdXN0IGJlIGFkZGVkLgoJCQlpZiAoIGNsaWVudEhlaWdodCA9PT0gMCApIHsKCQkJCXBhZGRpbmdUb3AgPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAicGFkZGluZy10b3AiICkgKTsKCQkJCXBhZGRpbmdCb3R0b20gPSBwYXJzZUZsb2F0KCB0aGlzLmVsZW1lbnQuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJCXBhZGRpbmdIZWlnaHQgPSBwYWRkaW5nVG9wICsgcGFkZGluZ0JvdHRvbTsKCgkJCQloZWlnaHQgKz0gcGFkZGluZ0hlaWdodDsKCQkJfQoKCQkJdGhpcy5lbGVtZW50LmNzcyh7CgkJCQkiaGVpZ2h0IjogaGVpZ2h0LAoJCQkJIm1pbi1oZWlnaHQiOiAiIiwKCQkJCSJtYXgtaGVpZ2h0IjogIiIKCQkJfSk7CgkJfSwKCgkJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJCWlmICggdGhpcy5vcHRpb25zLmF1dG9ncm93ICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCXRoaXMuX3VwZGF0ZUhlaWdodCgpOwoJCQl9CgkJfSwKCgkJX3NldE9wdGlvbnM6IGZ1bmN0aW9uKCBvcHRpb25zICkgewoKCQkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyAhPT0gdW5kZWZpbmVkICYmIHRoaXMuaXNUZXh0YXJlYSApIHsKCQkJCWlmICggb3B0aW9ucy5hdXRvZ3JvdyApIHsKCQkJCQl0aGlzLl9hdXRvZ3JvdygpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLl91bmJpbmRBdXRvZ3JvdygpOwoJCQkJfQoJCQl9CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLmV4dGVuZCggewoJaW5pdFNlbGVjdG9yOiAic2VsZWN0Om5vdCggOmpxbURhdGEocm9sZT0nc2xpZGVyJykpOm5vdCggOmpxbURhdGEocm9sZT0nZmxpcHN3aXRjaCcpICkiLAoKCW9wdGlvbnM6IHsKCQl0aGVtZTogbnVsbCwKCQlpY29uOiAiY2FyYXQtZCIsCgkJaWNvbnBvczogInJpZ2h0IiwKCQlpbmxpbmU6IGZhbHNlLAoJCWNvcm5lcnM6IHRydWUsCgkJc2hhZG93OiB0cnVlLAoJCWljb25zaGFkb3c6IGZhbHNlLCAvKiBUT0RPOiBEZXByZWNhdGVkIGluIDEuNCwgcmVtb3ZlIGluIDEuNS4gKi8KCQlvdmVybGF5VGhlbWU6IG51bGwsCgkJZGl2aWRlclRoZW1lOiBudWxsLAoJCWhpZGVQbGFjZWhvbGRlck1lbnVJdGVtczogdHJ1ZSwKCQljbG9zZVRleHQ6ICJDbG9zZSIsCgkJbmF0aXZlTWVudTogdHJ1ZSwKCQkvLyBUaGlzIG9wdGlvbiBkZWZhdWx0cyB0byB0cnVlIG9uIGlPUyBkZXZpY2VzLgoJCXByZXZlbnRGb2N1c1pvb206IC9pUGhvbmV8aVBhZHxpUG9kLy50ZXN0KCBuYXZpZ2F0b3IucGxhdGZvcm0gKSAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xLAoJCW1pbmk6IGZhbHNlCgl9LAoKCV9idXR0b246IGZ1bmN0aW9uKCkgewoJCXJldHVybiAkKCAiPGRpdi8+IiApOwoJfSwKCglfc2V0RGlzYWJsZWQ6IGZ1bmN0aW9uKCB2YWx1ZSApIHsKCQl0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiwgdmFsdWUgKTsKCQl0aGlzLmJ1dHRvbi5hdHRyKCAiYXJpYS1kaXNhYmxlZCIsIHZhbHVlICk7CgkJcmV0dXJuIHRoaXMuX3NldE9wdGlvbiggImRpc2FibGVkIiwgdmFsdWUgKTsKCX0sCgoJX2ZvY3VzQnV0dG9uIDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJc2VsZi5idXR0b24uZm9jdXMoKTsKCQl9LCA0MCk7Cgl9LAoKCV9zZWxlY3RPcHRpb25zOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5zZWxlY3QuZmluZCggIm9wdGlvbiIgKTsKCX0sCgoJLy8gc2V0dXAgaXRlbXMgdGhhdCBhcmUgZ2VuZXJhbGx5IG5lY2Vzc2FyeSBmb3Igc2VsZWN0IG1lbnUgZXh0ZW5zaW9uCglfcHJlRXh0ZW5zaW9uOiBmdW5jdGlvbigpIHsKCQl2YXIgaW5saW5lID0gdGhpcy5vcHRpb25zLmlubGluZSB8fCB0aGlzLmVsZW1lbnQuanFtRGF0YSggImlubGluZSIgKSwKCQkJbWluaSA9IHRoaXMub3B0aW9ucy5taW5pIHx8IHRoaXMuZWxlbWVudC5qcW1EYXRhKCAibWluaSIgKSwKCQkJY2xhc3NlcyA9ICIiOwoJCS8vIFRPRE86IFBvc3QgMS4xLS1vbmNlIHdlIGhhdmUgdGltZSB0byB0ZXN0IHRob3JvdWdobHktLWFueSBjbGFzc2VzIG1hbnVhbGx5IGFwcGxpZWQgdG8gdGhlIG9yaWdpbmFsIGVsZW1lbnQgc2hvdWxkIGJlIGNhcnJpZWQgb3ZlciB0byB0aGUgZW5oYW5jZWQgZWxlbWVudCwgd2l0aCBhbiBgLWVuaGFuY2VkYCBzdWZmaXguIFNlZSBodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzM1NzcKCQkvKiBpZiAoICRlbFswXS5jbGFzc05hbWUubGVuZ3RoICkgewoJCQljbGFzc2VzID0gJGVsWzBdLmNsYXNzTmFtZTsKCQl9ICovCgkJaWYgKCAhIX50aGlzLmVsZW1lbnRbMF0uY2xhc3NOYW1lLmluZGV4T2YoICJ1aS1idG4tbGVmdCIgKSApIHsKCQkJY2xhc3NlcyA9ICIgdWktYnRuLWxlZnQiOwoJCX0KCgkJaWYgKCAgISF+dGhpcy5lbGVtZW50WzBdLmNsYXNzTmFtZS5pbmRleE9mKCAidWktYnRuLXJpZ2h0IiApICkgewoJCQljbGFzc2VzID0gIiB1aS1idG4tcmlnaHQiOwoJCX0KCgkJaWYgKCBpbmxpbmUgKSB7CgkJCWNsYXNzZXMgKz0gIiB1aS1idG4taW5saW5lIjsKCQl9CgkJaWYgKCBtaW5pICkgewoJCQljbGFzc2VzICs9ICIgdWktbWluaSI7CgkJfQoKCQl0aGlzLnNlbGVjdCA9IHRoaXMuZWxlbWVudC5yZW1vdmVDbGFzcyggInVpLWJ0bi1sZWZ0IHVpLWJ0bi1yaWdodCIgKS53cmFwKCAiPGRpdiBjbGFzcz0ndWktc2VsZWN0IiArIGNsYXNzZXMgKyAiJz4iICk7CgkJdGhpcy5zZWxlY3RJZCAgPSB0aGlzLnNlbGVjdC5hdHRyKCAiaWQiICkgfHwgKCAic2VsZWN0LSIgKyB0aGlzLnV1aWQgKTsKCQl0aGlzLmJ1dHRvbklkID0gdGhpcy5zZWxlY3RJZCArICItYnV0dG9uIjsKCQl0aGlzLmxhYmVsID0gJCggImxhYmVsW2Zvcj0nIisgdGhpcy5zZWxlY3RJZCArIiddIiApOwoJCXRoaXMuaXNNdWx0aXBsZSA9IHRoaXMuc2VsZWN0WyAwIF0ubXVsdGlwbGU7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiLnVpLXNlbGVjdCIgKTsKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID4gMCApIHsKCQkJaWYgKCB3cmFwcGVyLmlzKCAiLnVpLWJ0bi1sZWZ0LCAudWktYnRuLXJpZ2h0IiApICkgewoJCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB3cmFwcGVyLmhhc0NsYXNzKCAidWktYnRuLWxlZnQiICkgPyAidWktYnRuLWxlZnQiIDogInVpLWJ0bi1yaWdodCIgKTsKCQkJfQoJCQl0aGlzLmVsZW1lbnQuaW5zZXJ0QWZ0ZXIoIHdyYXBwZXIgKTsKCQkJd3JhcHBlci5yZW1vdmUoKTsKCQl9Cgl9LAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3ByZUV4dGVuc2lvbigpOwoKCQl0aGlzLmJ1dHRvbiA9IHRoaXMuX2J1dHRvbigpOwoKCQl2YXIgc2VsZiA9IHRoaXMsCgoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zLAoKCQkJaWNvbnBvcyA9IG9wdGlvbnMuaWNvbiA/ICggb3B0aW9ucy5pY29ucG9zIHx8IHRoaXMuc2VsZWN0LmpxbURhdGEoICJpY29ucG9zIiApICkgOiBmYWxzZSwKCgkJCWJ1dHRvbiA9IHRoaXMuYnV0dG9uCgkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLnNlbGVjdCApCgkJCQkuYXR0ciggImlkIiwgdGhpcy5idXR0b25JZCApCgkJCQkuYWRkQ2xhc3MoICJ1aS1idG4iICsKCQkJCQkoIG9wdGlvbnMuaWNvbiA/ICggIiB1aS1pY29uLSIgKyBvcHRpb25zLmljb24gKyAiIHVpLWJ0bi1pY29uLSIgKyBpY29ucG9zICsKCQkJCQkoIG9wdGlvbnMuaWNvbnNoYWRvdyA/ICIgdWktc2hhZG93LWljb24iIDogIiIgKSApIDoJIiIgKSArIC8qIFRPRE86IFJlbW92ZSBpbiAxLjUuICovCgkJCQkJKCBvcHRpb25zLnRoZW1lID8gIiB1aS1idG4tIiArIG9wdGlvbnMudGhlbWUgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuY29ybmVycyA/ICIgdWktY29ybmVyLWFsbCIgOiAiIiApICsKCQkJCQkoIG9wdGlvbnMuc2hhZG93ID8gIiB1aS1zaGFkb3ciIDogIiIgKSApOwoKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCgkJLy8gT3BlcmEgZG9lcyBub3QgcHJvcGVybHkgc3VwcG9ydCBvcGFjaXR5IG9uIHNlbGVjdCBlbGVtZW50cwoJCS8vIEluIE1pbmksIGl0IGhpZGVzIHRoZSBlbGVtZW50LCBidXQgbm90IGl0cyB0ZXh0CgkJLy8gT24gdGhlIGRlc2t0b3AsaXQgc2VlbXMgdG8gZG8gdGhlIG9wcG9zaXRlCgkJLy8gZm9yIHRoZXNlIHJlYXNvbnMsIHVzaW5nIHRoZSBuYXRpdmVNZW51IG9wdGlvbiByZXN1bHRzIGluIGEgZnVsbCBuYXRpdmUgc2VsZWN0IGluIE9wZXJhCgkJaWYgKCBvcHRpb25zLm5hdGl2ZU1lbnUgJiYgd2luZG93Lm9wZXJhICYmIHdpbmRvdy5vcGVyYS52ZXJzaW9uICkgewoJCQlidXR0b24uYWRkQ2xhc3MoICJ1aS1zZWxlY3QtbmF0aXZlb25seSIgKTsKCQl9CgoJCS8vIEFkZCBjb3VudGVyIGZvciBtdWx0aSBzZWxlY3RzCgkJaWYgKCB0aGlzLmlzTXVsdGlwbGUgKSB7CgkJCXRoaXMuYnV0dG9uQ291bnQgPSAkKCAiPHNwYW4+IiApCgkJCQkuYWRkQ2xhc3MoICJ1aS1saS1jb3VudCB1aS1ib2R5LWluaGVyaXQiICkKCQkJCS5oaWRlKCkKCQkJCS5hcHBlbmRUbyggYnV0dG9uLmFkZENsYXNzKCAidWktbGktaGFzLWNvdW50IiApICk7CgkJfQoKCQkvLyBEaXNhYmxlIGlmIHNwZWNpZmllZAoJCWlmICggb3B0aW9ucy5kaXNhYmxlZCB8fCB0aGlzLmVsZW1lbnQuYXR0ciggImRpc2FibGVkIiApKSB7CgkJCXRoaXMuZGlzYWJsZSgpOwoJCX0KCgkJLy8gRXZlbnRzIG9uIG5hdGl2ZSBzZWxlY3QKCQl0aGlzLnNlbGVjdC5jaGFuZ2UoZnVuY3Rpb24oKSB7CgkJCXNlbGYucmVmcmVzaCgpOwoKCQkJaWYgKCAhIW9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJCXRoaXMuYmx1cigpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2hhbmRsZUZvcm1SZXNldCgpOwoKCQl0aGlzLl9vbiggdGhpcy5idXR0b24sIHsKCQkJa2V5ZG93bjogIl9oYW5kbGVLZXlkb3duIgoJCX0pOwoKCQl0aGlzLmJ1aWxkKCk7Cgl9LAoKCWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuc2VsZWN0CgkJCS5hcHBlbmRUbyggc2VsZi5idXR0b24gKQoJCQkuYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCS8vIEFkZCBhY3RpdmUgY2xhc3MgdG8gYnV0dG9uCgkJCQlzZWxmLmJ1dHRvbi5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJmb2N1cyIsIGZ1bmN0aW9uKCkgewoJCQkJc2VsZi5idXR0b24uYWRkQ2xhc3MoICQubW9iaWxlLmZvY3VzQ2xhc3MgKTsKCQkJfSkKCQkJLmJpbmQoICJibHVyIiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi5yZW1vdmVDbGFzcyggJC5tb2JpbGUuZm9jdXNDbGFzcyApOwoJCQl9KQoJCQkuYmluZCggImZvY3VzIHZtb3VzZW92ZXIiLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuYnV0dG9uLnRyaWdnZXIoICJ2bW91c2VvdmVyIiApOwoJCQl9KQoJCQkuYmluZCggInZtb3VzZW1vdmUiLCBmdW5jdGlvbigpIHsKCQkJCS8vIFJlbW92ZSBhY3RpdmUgY2xhc3Mgb24gc2Nyb2xsL3RvdWNobW92ZQoJCQkJc2VsZi5idXR0b24ucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICk7CgkJCX0pCgkJCS5iaW5kKCAiY2hhbmdlIGJsdXIgdm1vdXNlb3V0IiwgZnVuY3Rpb24oKSB7CgkJCQlzZWxmLmJ1dHRvbi50cmlnZ2VyKCAidm1vdXNlb3V0IiApCgkJCQkJLnJlbW92ZUNsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQl9KTsKCgkJLy8gSW4gbWFueSBzaXR1YXRpb25zLCBpT1Mgd2lsbCB6b29tIGludG8gdGhlIHNlbGVjdCB1cG9uIHRhcCwgdGhpcyBwcmV2ZW50cyB0aGF0IGZyb20gaGFwcGVuaW5nCgkJc2VsZi5idXR0b24uYmluZCggInZtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYubGFiZWwuYmluZCggImNsaWNrIGZvY3VzIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQkJJC5tb2JpbGUuem9vbS5kaXNhYmxlKCB0cnVlICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiZm9jdXMiLCBmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucHJldmVudEZvY3VzWm9vbSApIHsKCQkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoJCXNlbGYuYnV0dG9uLmJpbmQoICJtb3VzZXVwIiwgZnVuY3Rpb24oKSB7CgkJCWlmICggc2VsZi5vcHRpb25zLnByZXZlbnRGb2N1c1pvb20gKSB7CgkJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJCSQubW9iaWxlLnpvb20uZW5hYmxlKCB0cnVlICk7CgkJCQl9LCAwICk7CgkJCX0KCQl9KTsKCQlzZWxmLnNlbGVjdC5iaW5kKCAiYmx1ciIsIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHNlbGYub3B0aW9ucy5wcmV2ZW50Rm9jdXNab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCX0pOwoKCX0sCgoJc2VsZWN0ZWQ6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl9zZWxlY3RPcHRpb25zKCkuZmlsdGVyKCAiOnNlbGVjdGVkIiApOwoJfSwKCglzZWxlY3RlZEluZGljZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpczsKCgkJcmV0dXJuIHRoaXMuc2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24oKSB7CgkJCXJldHVybiBzZWxmLl9zZWxlY3RPcHRpb25zKCkuaW5kZXgoIHRoaXMgKTsKCQl9KS5nZXQoKTsKCX0sCgoJc2V0QnV0dG9uVGV4dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlzZWxlY3RlZCA9IHRoaXMuc2VsZWN0ZWQoKSwKCQkJdGV4dCA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCXNwYW4gPSAkKCBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAic3BhbiIgKSApOwoKCQl0aGlzLmJ1dHRvbi5jaGlsZHJlbiggInNwYW4iICkubm90KCAiLnVpLWxpLWNvdW50IiApLnJlbW92ZSgpLmVuZCgpLmVuZCgpLnByZXBlbmQoIChmdW5jdGlvbigpIHsKCQkJaWYgKCBzZWxlY3RlZC5sZW5ndGggKSB7CgkJCQl0ZXh0ID0gc2VsZWN0ZWQubWFwKGZ1bmN0aW9uKCkgewoJCQkJCXJldHVybiAkKCB0aGlzICkudGV4dCgpOwoJCQkJfSkuZ2V0KCkuam9pbiggIiwgIiApOwoJCQl9IGVsc2UgewoJCQkJdGV4dCA9IHNlbGYucGxhY2Vob2xkZXI7CgkJCX0KCgkJCWlmICggdGV4dCApIHsKCQkJCXNwYW4udGV4dCggdGV4dCApOwoJCQl9IGVsc2UgewoJCQkJc3Bhbi5odG1sKCAiJm5ic3A7IiApOwoJCQl9CgoJCQkvLyBUT0RPIHBvc3NpYmx5IGFnZ3JlZ2F0ZSBtdWx0aXBsZSBzZWxlY3Qgb3B0aW9uIGNsYXNzZXMKCQkJcmV0dXJuIHNwYW4KCQkJCS5hZGRDbGFzcyggc2VsZi5zZWxlY3QuYXR0ciggImNsYXNzIiApICkKCQkJCS5hZGRDbGFzcyggc2VsZWN0ZWQuYXR0ciggImNsYXNzIiApICkKCQkJCS5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSkoKSk7Cgl9LAoKCXNldEJ1dHRvbkNvdW50OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZWN0ZWQgPSB0aGlzLnNlbGVjdGVkKCk7CgoJCS8vIG11bHRpcGxlIGNvdW50IGluc2lkZSBidXR0b24KCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5idXR0b25Db3VudFsgc2VsZWN0ZWQubGVuZ3RoID4gMSA/ICJzaG93IiA6ICJoaWRlIiBdKCkudGV4dCggc2VsZWN0ZWQubGVuZ3RoICk7CgkJfQoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIC8qIGV2ZW50ICovICkgewoJCXRoaXMuX2RlbGF5KCAiX3JlZnJlc2hCdXR0b24iICk7Cgl9LAoKCV9yZXNldDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoQnV0dG9uOiBmdW5jdGlvbigpIHsKCQl0aGlzLnNldEJ1dHRvblRleHQoKTsKCQl0aGlzLnNldEJ1dHRvbkNvdW50KCk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3JlZnJlc2hCdXR0b24oKTsKCX0sCgoJLy8gb3BlbiBhbmQgY2xvc2UgcHJlc2VydmVkIGluIG5hdGl2ZSBzZWxlY3RzCgkvLyB0byBzaW1wbGlmeSB1c2VycyBjb2RlIHdoZW4gbG9vcGluZyBvdmVyIHNlbGVjdHMKCW9wZW46ICQubm9vcCwKCWNsb3NlOiAkLm5vb3AsCgoJZGlzYWJsZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc2V0RGlzYWJsZWQoIHRydWUgKTsKCQl0aGlzLmJ1dHRvbi5hZGRDbGFzcyggInVpLXN0YXRlLWRpc2FibGVkIiApOwoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3NldERpc2FibGVkKCBmYWxzZSApOwoJCXRoaXMuYnV0dG9uLnJlbW92ZUNsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5mb3JtUmVzZXQgKSApOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLm1vYmlsZS5saW5rcyA9IGZ1bmN0aW9uKCB0YXJnZXQgKSB7CgoJLy9saW5rcyB3aXRoaW4gY29udGVudCBhcmVhcywgdGVzdHMgaW5jbHVkZWQgd2l0aCBwYWdlCgkkKCB0YXJnZXQgKQoJCS5maW5kKCAiYSIgKQoJCS5qcW1FbmhhbmNlYWJsZSgpCgkJLmZpbHRlciggIjpqcW1EYXRhKHJlbD0ncG9wdXAnKVtocmVmXVtocmVmIT0nJ10iICkKCQkuZWFjaCggZnVuY3Rpb24oKSB7CgkJCS8vIEFjY2Vzc2liaWxpdHkgaW5mbyBmb3IgcG9wdXBzCgkJCXZhciBlbGVtZW50ID0gdGhpcywKCQkJCWlkcmVmID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoICJocmVmIiApLnN1YnN0cmluZyggMSApOwoKCQkJaWYgKCBpZHJlZiApIHsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1oYXNwb3B1cCIsIHRydWUgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1vd25zIiwgaWRyZWYgKTsKCQkJCWVsZW1lbnQuc2V0QXR0cmlidXRlKCAiYXJpYS1leHBhbmRlZCIsIGZhbHNlICk7CgkJCX0KCQl9KQoJCS5lbmQoKQoJCS5ub3QoICIudWktYnRuLCA6anFtRGF0YShyb2xlPSdub25lJyksIDpqcW1EYXRhKHJvbGU9J25vanMnKSIgKQoJCS5hZGRDbGFzcyggInVpLWxpbmsiICk7Cgp9OwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKZnVuY3Rpb24gZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHdpbmRvd1NpemUsIHNlZ21lbnRTaXplLCBvZmZzZXQsIGRlc2lyZWQgKSB7Cgl2YXIgcmV0dXJuVmFsdWUgPSBkZXNpcmVkOwoKCWlmICggd2luZG93U2l6ZSA8IHNlZ21lbnRTaXplICkgewoJCS8vIENlbnRlciBzZWdtZW50IGlmIGl0J3MgYmlnZ2VyIHRoYW4gdGhlIHdpbmRvdwoJCXJldHVyblZhbHVlID0gb2Zmc2V0ICsgKCB3aW5kb3dTaXplIC0gc2VnbWVudFNpemUgKSAvIDI7Cgl9IGVsc2UgewoJCS8vIE90aGVyd2lzZSBjZW50ZXIgaXQgYXQgdGhlIGRlc2lyZWQgY29vcmRpbmF0ZSB3aGlsZSBrZWVwaW5nIGl0IGNvbXBsZXRlbHkgaW5zaWRlIHRoZSB3aW5kb3cKCQlyZXR1cm5WYWx1ZSA9IE1hdGgubWluKCBNYXRoLm1heCggb2Zmc2V0LCBkZXNpcmVkIC0gc2VnbWVudFNpemUgLyAyICksIG9mZnNldCArIHdpbmRvd1NpemUgLSBzZWdtZW50U2l6ZSApOwoJfQoKCXJldHVybiByZXR1cm5WYWx1ZTsKfQoKZnVuY3Rpb24gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoZVdpbmRvdyApIHsKCXJldHVybiB7CgkJeDogdGhlV2luZG93LnNjcm9sbExlZnQoKSwKCQl5OiB0aGVXaW5kb3cuc2Nyb2xsVG9wKCksCgkJY3g6ICggdGhlV2luZG93WyAwIF0uaW5uZXJXaWR0aCB8fCB0aGVXaW5kb3cud2lkdGgoKSApLAoJCWN5OiAoIHRoZVdpbmRvd1sgMCBdLmlubmVySGVpZ2h0IHx8IHRoZVdpbmRvdy5oZWlnaHQoKSApCgl9Owp9CgokLndpZGdldCggIm1vYmlsZS5wb3B1cCIsIHsKCW9wdGlvbnM6IHsKCQl3cmFwcGVyQ2xhc3M6IG51bGwsCgkJdGhlbWU6IG51bGwsCgkJb3ZlcmxheVRoZW1lOiBudWxsLAoJCXNoYWRvdzogdHJ1ZSwKCQljb3JuZXJzOiB0cnVlLAoJCXRyYW5zaXRpb246ICJub25lIiwKCQlwb3NpdGlvblRvOiAib3JpZ2luIiwKCQl0b2xlcmFuY2U6IG51bGwsCgkJY2xvc2VMaW5rU2VsZWN0b3I6ICJhOmpxbURhdGEocmVsPSdiYWNrJykiLAoJCWNsb3NlTGlua0V2ZW50czogImNsaWNrLnBvcHVwIiwKCQluYXZpZ2F0ZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIiwKCQljbG9zZUV2ZW50czogIm5hdmlnYXRlLnBvcHVwIHBhZ2ViZWZvcmVjaGFuZ2UucG9wdXAiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWVuaGFuY2VkOiBmYWxzZSwKCgkJLy8gTk9URSBXaW5kb3dzIFBob25lIDcgaGFzIGEgc2Nyb2xsIHBvc2l0aW9uIGNhY2hpbmcgaXNzdWUgdGhhdAoJCS8vICAgICAgcmVxdWlyZXMgdXMgdG8gZGlzYWJsZSBwb3B1cCBoaXN0b3J5IG1hbmFnZW1lbnQgYnkgZGVmYXVsdAoJCS8vICAgICAgaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80Nzg0CgkJLy8KCQkvLyBOT1RFIHRoaXMgb3B0aW9uIGlzIG1vZGlmaWVkIGluIF9jcmVhdGUhCgkJaGlzdG9yeTogISQubW9iaWxlLmJyb3dzZXIub2xkSUUKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnQsCgkJCW15SWQgPSB0aGVFbGVtZW50LmF0dHIoICJpZCIgKSwKCQkJY3VycmVudE9wdGlvbnMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFdlIG5lZWQgdG8gYWRqdXN0IHRoZSBoaXN0b3J5IG9wdGlvbiB0byBiZSBmYWxzZSBpZiB0aGVyZSdzIG5vIEFKQVggbmF2LgoJCS8vIFdlIGNhbid0IGRvIGl0IGluIHRoZSBvcHRpb24gZGVjbGFyYXRpb25zIGJlY2F1c2UgdGhvc2UgYXJlIHJ1biBiZWZvcmUKCQkvLyBpdCBpcyBkZXRlcm1pbmVkIHdoZXRoZXIgdGhlcmUgc2hhbGwgYmUgQUpBWCBuYXYuCgkJY3VycmVudE9wdGlvbnMuaGlzdG9yeSA9IGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgJiYgJC5tb2JpbGUuYWpheEVuYWJsZWQgJiYgJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQ7CgoJCS8vIERlZmluZSBpbnN0YW5jZSB2YXJpYWJsZXMKCQkkLmV4dGVuZCggdGhpcywgewoJCQlfc2Nyb2xsVG9wOiAwLAoJCQlfcGFnZTogdGhlRWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICksCgkJCV91aTogbnVsbCwKCQkJX2ZhbGxiYWNrVHJhbnNpdGlvbjogIiIsCgkJCV9jdXJyZW50VHJhbnNpdGlvbjogZmFsc2UsCgkJCV9wcmVyZXF1aXNpdGVzOiBudWxsLAoJCQlfaXNPcGVuOiBmYWxzZSwKCQkJX3RvbGVyYW5jZTogbnVsbCwKCQkJX3Jlc2l6ZURhdGE6IG51bGwsCgkJCV9pZ25vcmVSZXNpemVUbzogMCwKCQkJX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzczogZmFsc2UKCQl9KTsKCgkJaWYgKCB0aGlzLl9wYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJdGhpcy5fcGFnZSA9ICQoICJib2R5IiApOwoJCX0KCgkJaWYgKCBjdXJyZW50T3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5fdWkgPSB7CgkJCQljb250YWluZXI6IHRoZUVsZW1lbnQucGFyZW50KCksCgkJCQlzY3JlZW46IHRoZUVsZW1lbnQucGFyZW50KCkucHJldigpLAoJCQkJcGxhY2Vob2xkZXI6ICQoIHRoaXMuZG9jdW1lbnRbIDAgXS5nZXRFbGVtZW50QnlJZCggbXlJZCArICItcGxhY2Vob2xkZXIiICkgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSggdGhlRWxlbWVudCwgbXlJZCApOwoJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGN1cnJlbnRPcHRpb25zLnRyYW5zaXRpb24gKTsKCQl9CgkJdGhpcwoJCQkuX3NldFRvbGVyYW5jZSggY3VycmVudE9wdGlvbnMudG9sZXJhbmNlICkKCQkJLl91aS5mb2N1c0VsZW1lbnQgPSB0aGlzLl91aS5jb250YWluZXI7CgoJCS8vIEV2ZW50IGhhbmRsZXJzCgkJdGhpcy5fb24oIHRoaXMuX3VpLnNjcmVlbiwgeyAidmNsaWNrIjogIl9lYXRFdmVudEFuZENsb3NlIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7CgkJCW9yaWVudGF0aW9uY2hhbmdlOiAkLnByb3h5KCB0aGlzLCAiX2hhbmRsZVdpbmRvd09yaWVudGF0aW9uY2hhbmdlIiApLAoJCQlyZXNpemU6ICQucHJveHkoIHRoaXMsICJfaGFuZGxlV2luZG93UmVzaXplIiApLAoJCQlrZXl1cDogJC5wcm94eSggdGhpcywgIl9oYW5kbGVXaW5kb3dLZXlVcCIgKQoJCX0pOwoJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7ICJmb2N1c2luIjogIl9oYW5kbGVEb2N1bWVudEZvY3VzSW4iIH0gKTsKCX0sCgoJX2VuaGFuY2U6IGZ1bmN0aW9uKCB0aGVFbGVtZW50LCBteUlkICkgewoJCXZhciBjdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJd3JhcHBlckNsYXNzID0gY3VycmVudE9wdGlvbnMud3JhcHBlckNsYXNzLAoJCQl1aSA9IHsKCQkJCXNjcmVlbjogJCggIjxkaXYgY2xhc3M9J3VpLXNjcmVlbi1oaWRkZW4gdWktcG9wdXAtc2NyZWVuICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1vdmVybGF5LSIsIGN1cnJlbnRPcHRpb25zLm92ZXJsYXlUaGVtZSApICsgIic+PC9kaXY+IiApLAoJCQkJcGxhY2Vob2xkZXI6ICQoICI8ZGl2IHN0eWxlPSdkaXNwbGF5OiBub25lOyc+PCEtLSBwbGFjZWhvbGRlciAtLT48L2Rpdj4iICksCgkJCQljb250YWluZXI6ICQoICI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1jb250YWluZXIgdWktcG9wdXAtaGlkZGVuIHVpLXBvcHVwLXRydW5jYXRlIiArCgkJCQkJKCB3cmFwcGVyQ2xhc3MgPyAoICIgIiArIHdyYXBwZXJDbGFzcyApIDogIiIgKSArICInPjwvZGl2PiIgKQoJCQl9LAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5zY3JlZW5bIDAgXSApOwoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCB1aS5jb250YWluZXJbIDAgXSApOwoKCQlpZiAoIG15SWQgKSB7CgkJCXVpLnNjcmVlbi5hdHRyKCAiaWQiLCBteUlkICsgIi1zY3JlZW4iICk7CgkJCXVpLmNvbnRhaW5lci5hdHRyKCAiaWQiLCBteUlkICsgIi1wb3B1cCIgKTsKCQkJdWkucGxhY2Vob2xkZXIKCQkJCS5hdHRyKCAiaWQiLCBteUlkICsgIi1wbGFjZWhvbGRlciIgKQoJCQkJLmh0bWwoICI8IS0tIHBsYWNlaG9sZGVyIGZvciAiICsgbXlJZCArICIgLS0+IiApOwoJCX0KCgkJLy8gQXBwbHkgdGhlIHByb3RvCgkJdGhpcy5fcGFnZVsgMCBdLmFwcGVuZENoaWxkKCBmcmFnbWVudCApOwoJCS8vIExlYXZlIGEgcGxhY2Vob2xkZXIgd2hlcmUgdGhlIGVsZW1lbnQgdXNlZCB0byBiZQoJCXVpLnBsYWNlaG9sZGVyLmluc2VydEFmdGVyKCB0aGVFbGVtZW50ICk7CgkJdGhlRWxlbWVudAoJCQkuZGV0YWNoKCkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAgIiArCgkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSArICIgIiArCgkJCQkoIGN1cnJlbnRPcHRpb25zLnNoYWRvdyA/ICJ1aS1vdmVybGF5LXNoYWRvdyAiIDogIiIgKSArCgkJCQkoIGN1cnJlbnRPcHRpb25zLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSApCgkJCS5hcHBlbmRUbyggdWkuY29udGFpbmVyICk7CgoJCXJldHVybiB1aTsKCX0sCgoJX2VhdEV2ZW50QW5kQ2xvc2U6IGZ1bmN0aW9uKCB0aGVFdmVudCApIHsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCWlmICggdGhpcy5vcHRpb25zLmRpc21pc3NpYmxlICkgewoJCQl0aGlzLmNsb3NlKCk7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJLy8gTWFrZSBzdXJlIHRoZSBzY3JlZW4gY292ZXJzIHRoZSBlbnRpcmUgZG9jdW1lbnQgLSBDU1MgaXMgc29tZXRpbWVzIG5vdAoJLy8gZW5vdWdoIHRvIGFjY29tcGxpc2ggdGhpcy4KCV9yZXNpemVTY3JlZW46IGZ1bmN0aW9uKCkgewoJCXZhciBzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW4sCgkJCXBvcHVwSGVpZ2h0ID0gdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICksCgkJCXNjcmVlbkhlaWdodCA9IHNjcmVlbi5yZW1vdmVBdHRyKCAic3R5bGUiICkuaGVpZ2h0KCksCgoJCQkvLyBTdWJ0cmFjdGluZyAxIGhlcmUgaXMgbmVjZXNzYXJ5IGZvciBhbiBvYnNjdXJlIEFuZHJkb2lkIDQuMCBidWcgd2hlcmUKCQkJLy8gdGhlIGJyb3dzZXIgaGFuZ3MgaWYgdGhlIHNjcmVlbiBjb3ZlcnMgdGhlIGVudGlyZSBkb2N1bWVudCA6LwoJCQlkb2N1bWVudEhlaWdodCA9IHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgLSAxOwoKCQlpZiAoIHNjcmVlbkhlaWdodCA8IGRvY3VtZW50SGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBkb2N1bWVudEhlaWdodCApOwoJCX0gZWxzZSBpZiAoIHBvcHVwSGVpZ2h0ID4gc2NyZWVuSGVpZ2h0ICkgewoJCQlzY3JlZW4uaGVpZ2h0KCBwb3B1cEhlaWdodCApOwoJCX0KCX0sCgoJX2hhbmRsZVdpbmRvd0tleVVwOiBmdW5jdGlvbiggdGhlRXZlbnQgKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhlRXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FU0NBUEUgKSB7CgkJCXJldHVybiB0aGlzLl9lYXRFdmVudEFuZENsb3NlKCB0aGVFdmVudCApOwoJCX0KCX0sCgoJX2V4cGVjdFJlc2l6ZUV2ZW50OiBmdW5jdGlvbigpIHsKCQl2YXIgd2luZG93Q29vcmRpbmF0ZXMgPSBnZXRXaW5kb3dDb29yZGluYXRlcyggdGhpcy53aW5kb3cgKTsKCgkJaWYgKCB0aGlzLl9yZXNpemVEYXRhICkgewoJCQlpZiAoIHdpbmRvd0Nvb3JkaW5hdGVzLnggPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMueCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMueSA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy55ICYmCgkJCQl3aW5kb3dDb29yZGluYXRlcy5jeCA9PT0gdGhpcy5fcmVzaXplRGF0YS53aW5kb3dDb29yZGluYXRlcy5jeCAmJgoJCQkJd2luZG93Q29vcmRpbmF0ZXMuY3kgPT09IHRoaXMuX3Jlc2l6ZURhdGEud2luZG93Q29vcmRpbmF0ZXMuY3kgKSB7CgkJCQkvLyB0aW1lb3V0IG5vdCByZWZyZXNoZWQKCQkJCXJldHVybiBmYWxzZTsKCQkJfSBlbHNlIHsKCQkJCS8vIGNsZWFyIGV4aXN0aW5nIHRpbWVvdXQgLSBpdCB3aWxsIGJlIHJlZnJlc2hlZCBiZWxvdwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLl9yZXNpemVEYXRhLnRpbWVvdXRJZCApOwoJCQl9CgkJfQoKCQl0aGlzLl9yZXNpemVEYXRhID0gewoJCQl0aW1lb3V0SWQ6IHRoaXMuX2RlbGF5KCAiX3Jlc2l6ZVRpbWVvdXQiLCAyMDAgKSwKCQkJd2luZG93Q29vcmRpbmF0ZXM6IHdpbmRvd0Nvb3JkaW5hdGVzCgkJfTsKCgkJcmV0dXJuIHRydWU7Cgl9LAoKCV9yZXNpemVUaW1lb3V0OiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJaWYgKCAhdGhpcy5fZXhwZWN0UmVzaXplRXZlbnQoKSApIHsKCQkJCWlmICggdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJCS8vIGVmZmVjdGl2ZWx5IHJhcGlkLW9wZW4gdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1oaWRkZW4gdWktcG9wdXAtdHJ1bmNhdGUiICk7CgkJCQkJdGhpcy5yZXBvc2l0aW9uKCB7IHBvc2l0aW9uVG86ICJ3aW5kb3ciIH0gKTsKCQkJCQl0aGlzLl9pZ25vcmVSZXNpemVFdmVudHMoKTsKCQkJCX0KCgkJCQl0aGlzLl9yZXNpemVTY3JlZW4oKTsKCQkJCXRoaXMuX3Jlc2l6ZURhdGEgPSBudWxsOwoJCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJCX0KCQl9IGVsc2UgewoJCQl0aGlzLl9yZXNpemVEYXRhID0gbnVsbDsKCQkJdGhpcy5fb3JpZW50YXRpb25jaGFuZ2VJblByb2dyZXNzID0gZmFsc2U7CgkJfQoJfSwKCglfc3RvcElnbm9yaW5nUmVzaXplRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9pZ25vcmVSZXNpemVUbyA9IDA7Cgl9LAoKCV9pZ25vcmVSZXNpemVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5faWdub3JlUmVzaXplVG8gKSB7CgkJCWNsZWFyVGltZW91dCggdGhpcy5faWdub3JlUmVzaXplVG8gKTsKCQl9CgkJdGhpcy5faWdub3JlUmVzaXplVG8gPSB0aGlzLl9kZWxheSggIl9zdG9wSWdub3JpbmdSZXNpemVFdmVudHMiLCAxMDAwICk7Cgl9LAoKCV9oYW5kbGVXaW5kb3dSZXNpemU6IGZ1bmN0aW9uKC8qIHRoZUV2ZW50ICovKSB7CgkJaWYgKCB0aGlzLl9pc09wZW4gJiYgdGhpcy5faWdub3JlUmVzaXplVG8gPT09IDAgKSB7CgkJCWlmICggKCB0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpIHx8IHRoaXMuX29yaWVudGF0aW9uY2hhbmdlSW5Qcm9ncmVzcyApICYmCgkJCQkhdGhpcy5fdWkuY29udGFpbmVyLmhhc0NsYXNzKCAidWktcG9wdXAtaGlkZGVuIiApICkgewoJCQkJLy8gZWZmZWN0aXZlbHkgcmFwaWQtY2xvc2UgdGhlIHBvcHVwIHdoaWxlIGxlYXZpbmcgdGhlIHNjcmVlbiBpbnRhY3QKCQkJCXRoaXMuX3VpLmNvbnRhaW5lcgoJCQkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgkJCX0KCQl9Cgl9LAoKCV9oYW5kbGVXaW5kb3dPcmllbnRhdGlvbmNoYW5nZTogZnVuY3Rpb24oLyogdGhlRXZlbnQgKi8pIHsKCQlpZiAoICF0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgJiYgdGhpcy5faXNPcGVuICYmIHRoaXMuX2lnbm9yZVJlc2l6ZVRvID09PSAwICkgewoJCQl0aGlzLl9leHBlY3RSZXNpemVFdmVudCgpOwoJCQl0aGlzLl9vcmllbnRhdGlvbmNoYW5nZUluUHJvZ3Jlc3MgPSB0cnVlOwoJCX0KCX0sCgoJLy8gV2hlbiB0aGUgcG9wdXAgaXMgb3BlbiwgYXR0ZW1wdGluZyB0byBmb2N1cyBvbiBhbiBlbGVtZW50IHRoYXQgaXMgbm90IGEKCS8vIGNoaWxkIG9mIHRoZSBwb3B1cCB3aWxsIHJlZGlyZWN0IGZvY3VzIHRvIHRoZSBwb3B1cAoJX2hhbmRsZURvY3VtZW50Rm9jdXNJbjogZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCXZhciB0YXJnZXQsCgkJCXRhcmdldEVsZW1lbnQgPSB0aGVFdmVudC50YXJnZXQsCgkJCXVpID0gdGhpcy5fdWk7CgoJCWlmICggIXRoaXMuX2lzT3BlbiApIHsKCQkJcmV0dXJuOwoJCX0KCgkJaWYgKCB0YXJnZXRFbGVtZW50ICE9PSB1aS5jb250YWluZXJbIDAgXSApIHsKCQkJdGFyZ2V0ID0gJCggdGFyZ2V0RWxlbWVudCApOwoJCQlpZiAoIDAgPT09IHRhcmdldC5wYXJlbnRzKCkuZmlsdGVyKCB1aS5jb250YWluZXJbIDAgXSApLmxlbmd0aCApIHsKCQkJCSQoIHRoaXMuZG9jdW1lbnRbIDAgXS5hY3RpdmVFbGVtZW50ICkub25lKCAiZm9jdXMiLCBmdW5jdGlvbigvKiB0aGVFdmVudCAqLykgewoJCQkJCXRhcmdldC5ibHVyKCk7CgkJCQl9KTsKCQkJCXVpLmZvY3VzRWxlbWVudC5mb2N1cygpOwoJCQkJdGhlRXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCXRoZUV2ZW50LnN0b3BJbW1lZGlhdGVQcm9wYWdhdGlvbigpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9IGVsc2UgaWYgKCB1aS5mb2N1c0VsZW1lbnRbIDAgXSA9PT0gdWkuY29udGFpbmVyWyAwIF0gKSB7CgkJCQl1aS5mb2N1c0VsZW1lbnQgPSB0YXJnZXQ7CgkJCX0KCQl9CgoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJfSwKCglfdGhlbWVDbGFzc0Zyb21PcHRpb246IGZ1bmN0aW9uKCBwcmVmaXgsIHZhbHVlICkgewoJCXJldHVybiAoIHZhbHVlID8gKCB2YWx1ZSA9PT0gIm5vbmUiID8gIiIgOiAoIHByZWZpeCArIHZhbHVlICkgKSA6ICggcHJlZml4ICsgImluaGVyaXQiICkgKTsKCX0sCgoJX2FwcGx5VHJhbnNpdGlvbjogZnVuY3Rpb24oIHZhbHVlICkgewoJCWlmICggdmFsdWUgKSB7CgkJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCWlmICggdmFsdWUgIT09ICJub25lIiApIHsKCQkJCXRoaXMuX2ZhbGxiYWNrVHJhbnNpdGlvbiA9ICQubW9iaWxlLl9tYXliZURlZ3JhZGVUcmFuc2l0aW9uKCB2YWx1ZSApOwoJCQkJaWYgKCB0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPT09ICJub25lIiApIHsKCQkJCQl0aGlzLl9mYWxsYmFja1RyYW5zaXRpb24gPSAiIjsKCQkJCX0KCQkJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG5ld09wdGlvbnMgKSB7CgkJdmFyIGN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQl0aGVFbGVtZW50ID0gdGhpcy5lbGVtZW50LAoJCQlzY3JlZW4gPSB0aGlzLl91aS5zY3JlZW47CgoJCWlmICggbmV3T3B0aW9ucy53cmFwcGVyQ2xhc3MgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkucmVtb3ZlQ2xhc3MoIGN1cnJlbnRPcHRpb25zLndyYXBwZXJDbGFzcyApCgkJCQkuYWRkQ2xhc3MoIG5ld09wdGlvbnMud3JhcHBlckNsYXNzICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhlRWxlbWVudAoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgY3VycmVudE9wdGlvbnMudGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBuZXdPcHRpb25zLnRoZW1lICkgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5vdmVybGF5VGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJc2NyZWVuCgkJCQkucmVtb3ZlQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBjdXJyZW50T3B0aW9ucy5vdmVybGF5VGhlbWUgKSApCgkJCQkuYWRkQ2xhc3MoIHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktb3ZlcmxheS0iLCBuZXdPcHRpb25zLm92ZXJsYXlUaGVtZSApICk7CgoJCQlpZiAoIHRoaXMuX2lzT3BlbiApIHsKCQkJCXNjcmVlbi5hZGRDbGFzcyggImluIiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuc2hhZG93ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoZUVsZW1lbnQudG9nZ2xlQ2xhc3MoICJ1aS1vdmVybGF5LXNoYWRvdyIsIG5ld09wdGlvbnMuc2hhZG93ICk7CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQl0aGVFbGVtZW50LnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG5ld09wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBuZXdPcHRpb25zLnRyYW5zaXRpb24gIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIG5ld09wdGlvbnMudHJhbnNpdGlvbiApOwoJCQl9CgkJfQoKCQlpZiAoIG5ld09wdGlvbnMudG9sZXJhbmNlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldFRvbGVyYW5jZSggbmV3T3B0aW9ucy50b2xlcmFuY2UgKTsKCQl9CgoJCWlmICggbmV3T3B0aW9ucy5kaXNhYmxlZCAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIG5ld09wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCQl0aGlzLmNsb3NlKCk7CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9zdXBlciggbmV3T3B0aW9ucyApOwoJfSwKCglfc2V0VG9sZXJhbmNlOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJdmFyIHRvbCA9IHsgdDogMzAsIHI6IDE1LCBiOiAzMCwgbDogMTUgfSwKCQkJYXI7CgoJCWlmICggdmFsdWUgIT09IHVuZGVmaW5lZCApIHsKCQkJYXIgPSBTdHJpbmcoIHZhbHVlICkuc3BsaXQoICIsIiApOwoKCQkJJC5lYWNoKCBhciwgZnVuY3Rpb24oIGlkeCwgdmFsICkgeyBhclsgaWR4IF0gPSBwYXJzZUludCggdmFsLCAxMCApOyB9ICk7CgoJCQlzd2l0Y2goIGFyLmxlbmd0aCApIHsKCQkJCS8vIEFsbCB2YWx1ZXMgYXJlIHRvIGJlIHRoZSBzYW1lCgkJCQljYXNlIDE6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSB0b2wuciA9IHRvbC5iID0gdG9sLmwgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQkvLyBUaGUgZmlyc3QgdmFsdWUgZGVub3RlcyB0b3AvYm90dG9tIHRvbGVyYW5jZSwgYW5kIHRoZSBzZWNvbmQgdmFsdWUgZGVub3RlcyBsZWZ0L3JpZ2h0IHRvbGVyYW5jZQoJCQkJY2FzZSAyOgoJCQkJCWlmICggIWlzTmFOKCBhclsgMCBdICkgKSB7CgkJCQkJCXRvbC50ID0gdG9sLmIgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wubCA9IHRvbC5yID0gYXJbIDEgXTsKCQkJCQl9CgkJCQkJYnJlYWs7CgoJCQkJLy8gVGhlIGFycmF5IGNvbnRhaW5zIHZhbHVlcyBpbiB0aGUgb3JkZXIgdG9wLCByaWdodCwgYm90dG9tLCBsZWZ0CgkJCQljYXNlIDQ6CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAwIF0gKSApIHsKCQkJCQkJdG9sLnQgPSBhclsgMCBdOwoJCQkJCX0KCQkJCQlpZiAoICFpc05hTiggYXJbIDEgXSApICkgewoJCQkJCQl0b2wuciA9IGFyWyAxIF07CgkJCQkJfQoJCQkJCWlmICggIWlzTmFOKCBhclsgMiBdICkgKSB7CgkJCQkJCXRvbC5iID0gYXJbIDIgXTsKCQkJCQl9CgkJCQkJaWYgKCAhaXNOYU4oIGFyWyAzIF0gKSApIHsKCQkJCQkJdG9sLmwgPSBhclsgMyBdOwoJCQkJCX0KCQkJCQlicmVhazsKCgkJCQlkZWZhdWx0OgoJCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQl0aGlzLl90b2xlcmFuY2UgPSB0b2w7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9jbGFtcFBvcHVwV2lkdGg6IGZ1bmN0aW9uKCBpbmZvT25seSApIHsKCQl2YXIgbWVudVNpemUsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCS8vIHJlY3RhbmdsZSB3aXRoaW4gd2hpY2ggdGhlIHBvcHVwIG11c3QgZml0CgkJCXJlY3RhbmdsZSA9IHsKCQkJCXg6IHRoaXMuX3RvbGVyYW5jZS5sLAoJCQkJeTogd2luZG93Q29vcmRpbmF0ZXMueSArIHRoaXMuX3RvbGVyYW5jZS50LAoJCQkJY3g6IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC0gdGhpcy5fdG9sZXJhbmNlLmwgLSB0aGlzLl90b2xlcmFuY2UuciwKCQkJCWN5OiB3aW5kb3dDb29yZGluYXRlcy5jeSAtIHRoaXMuX3RvbGVyYW5jZS50IC0gdGhpcy5fdG9sZXJhbmNlLmIKCQkJfTsKCgkJaWYgKCAhaW5mb09ubHkgKSB7CgkJCS8vIENsYW1wIHRoZSB3aWR0aCBvZiB0aGUgbWVudSBiZWZvcmUgZ3JhYmJpbmcgaXRzIHNpemUKCQkJdGhpcy5fdWkuY29udGFpbmVyLmNzcyggIm1heC13aWR0aCIsIHJlY3RhbmdsZS5jeCApOwoJCX0KCgkJbWVudVNpemUgPSB7CgkJCWN4OiB0aGlzLl91aS5jb250YWluZXIub3V0ZXJXaWR0aCggdHJ1ZSApLAoJCQljeTogdGhpcy5fdWkuY29udGFpbmVyLm91dGVySGVpZ2h0KCB0cnVlICkKCQl9OwoKCQlyZXR1cm4geyByYzogcmVjdGFuZ2xlLCBtZW51U2l6ZTogbWVudVNpemUgfTsKCX0sCgoJX2NhbGN1bGF0ZUZpbmFsTG9jYXRpb246IGZ1bmN0aW9uKCBkZXNpcmVkLCBjbGFtcEluZm8gKSB7CgkJdmFyIHJldHVyblZhbHVlLAoJCQlyZWN0YW5nbGUgPSBjbGFtcEluZm8ucmMsCgkJCW1lbnVTaXplID0gY2xhbXBJbmZvLm1lbnVTaXplOwoKCQkvLyBDZW50ZXIgdGhlIG1lbnUgb3ZlciB0aGUgZGVzaXJlZCBjb29yZGluYXRlcywgd2hpbGUgbm90IGdvaW5nIG91dHNpZGUKCQkvLyB0aGUgd2luZG93IHRvbGVyYW5jZXMuIFRoaXMgd2lsbCBjZW50ZXIgd3J0LiB0aGUgd2luZG93IGlmIHRoZSBwb3B1cCBpcwoJCS8vIHRvbyBsYXJnZS4KCQlyZXR1cm5WYWx1ZSA9IHsKCQkJbGVmdDogZml0U2VnbWVudEluc2lkZVNlZ21lbnQoIHJlY3RhbmdsZS5jeCwgbWVudVNpemUuY3gsIHJlY3RhbmdsZS54LCBkZXNpcmVkLnggKSwKCQkJdG9wOiBmaXRTZWdtZW50SW5zaWRlU2VnbWVudCggcmVjdGFuZ2xlLmN5LCBtZW51U2l6ZS5jeSwgcmVjdGFuZ2xlLnksIGRlc2lyZWQueSApCgkJfTsKCgkJLy8gTWFrZSBzdXJlIHRoZSB0b3Agb2YgdGhlIG1lbnUgaXMgdmlzaWJsZQoJCXJldHVyblZhbHVlLnRvcCA9IE1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKTsKCgkJLy8gSWYgdGhlIGhlaWdodCBvZiB0aGUgbWVudSBpcyBzbWFsbGVyIHRoYW4gdGhlIGhlaWdodCBvZiB0aGUgZG9jdW1lbnQKCQkvLyBhbGlnbiB0aGUgYm90dG9tIHdpdGggdGhlIGJvdHRvbSBvZiB0aGUgZG9jdW1lbnQKCgkJcmV0dXJuVmFsdWUudG9wIC09IE1hdGgubWluKCByZXR1cm5WYWx1ZS50b3AsCgkJCU1hdGgubWF4KCAwLCByZXR1cm5WYWx1ZS50b3AgKyBtZW51U2l6ZS5jeSAtIHRoaXMuZG9jdW1lbnQuaGVpZ2h0KCkgKSApOwoKCQlyZXR1cm4gcmV0dXJuVmFsdWU7Cgl9LAoKCS8vIFRyeSBhbmQgY2VudGVyIHRoZSBvdmVybGF5IG92ZXIgdGhlIGdpdmVuIGNvb3JkaW5hdGVzCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQlyZXR1cm4gdGhpcy5fY2FsY3VsYXRlRmluYWxMb2NhdGlvbiggZGVzaXJlZCwgdGhpcy5fY2xhbXBQb3B1cFdpZHRoKCkgKTsKCX0sCgoJX2NyZWF0ZVByZXJlcXVpc2l0ZXM6IGZ1bmN0aW9uKCBzY3JlZW5QcmVyZXF1aXNpdGUsIGNvbnRhaW5lclByZXJlcXVpc2l0ZSwgd2hlbkRvbmUgKSB7CgkJdmFyIHByZXJlcXVpc2l0ZXMsCgkJCXNlbGYgPSB0aGlzOwoKCQkvLyBJdCBpcyBpbXBvcnRhbnQgdG8gbWFpbnRhaW4gYm90aCB0aGUgbG9jYWwgdmFyaWFibGUgcHJlcmVxdWlzaXRlcyBhbmQKCQkvLyBzZWxmLl9wcmVyZXF1aXNpdGVzLiBUaGUgbG9jYWwgdmFyaWFibGUgcmVtYWlucyBpbiB0aGUgY2xvc3VyZSBvZiB0aGUKCQkvLyBmdW5jdGlvbnMgd2hpY2ggY2FsbCB0aGUgY2FsbGJhY2tzIHBhc3NlZCBpbi4gVGhlIGNvbXBhcmlzb24gYmV0d2VlbiB0aGUKCQkvLyBsb2NhbCB2YXJpYWJsZSBhbmQgc2VsZi5fcHJlcmVxdWlzaXRlcyBpcyBuZWNlc3NhcnksIGJlY2F1c2Ugb25jZSBhCgkJLy8gZnVuY3Rpb24gaGFzIGJlZW4gcGFzc2VkIHRvIC5hbmltYXRpb25Db21wbGV0ZSgpIGl0IHdpbGwgYmUgY2FsbGVkIG5leHQKCQkvLyB0aW1lIGFuIGFuaW1hdGlvbiBjb21wbGV0ZXMsIGV2ZW4gaWYgdGhhdCdzIG5vdCB0aGUgYW5pbWF0aW9uIHdob3NlIGVuZAoJCS8vIHRoZSBmdW5jdGlvbiB3YXMgc3VwcG9zZWQgdG8gY2F0Y2ggKGZvciBleGFtcGxlLCBpZiBhbiBhYm9ydCBoYXBwZW5zCgkJLy8gZHVyaW5nIHRoZSBvcGVuaW5nIGFuaW1hdGlvbiwgdGhlIC5hbmltYXRpb25Db21wbGV0ZSBoYW5kbGVyIGlzIG5vdAoJCS8vIGNhbGxlZCBmb3IgdGhhdCBhbmltYXRpb24gYW55bW9yZSwgYnV0IHRoZSBoYW5kbGVyIHJlbWFpbnMgYXR0YWNoZWQsIHNvCgkJLy8gaXQgaXMgY2FsbGVkIHRoZSBuZXh0IHRpbWUgdGhlIHBvcHVwIGlzIG9wZW5lZCAtIG1ha2luZyBpdCBzdGFsZS4KCQkvLyBDb21wYXJpbmcgdGhlIGxvY2FsIHZhcmlhYmxlIHByZXJlcXVpc2l0ZXMgdG8gdGhlIHdpZGdldC1sZXZlbCB2YXJpYWJsZQoJCS8vIHNlbGYuX3ByZXJlcXVpc2l0ZXMgZW5zdXJlcyB0aGF0IGNhbGxiYWNrcyB0cmlnZ2VyZWQgYnkgYSBzdGFsZQoJCS8vIC5hbmltYXRpb25Db21wbGV0ZSB3aWxsIGJlIGlnbm9yZWQuCgoJCXByZXJlcXVpc2l0ZXMgPSB7CgkJCXNjcmVlbjogJC5EZWZlcnJlZCgpLAoJCQljb250YWluZXI6ICQuRGVmZXJyZWQoKQoJCX07CgoJCXByZXJlcXVpc2l0ZXMuc2NyZWVuLnRoZW4oIGZ1bmN0aW9uKCkgewoJCQlpZiAoIHByZXJlcXVpc2l0ZXMgPT09IHNlbGYuX3ByZXJlcXVpc2l0ZXMgKSB7CgkJCQlzY3JlZW5QcmVyZXF1aXNpdGUoKTsKCQkJfQoJCX0pOwoKCQlwcmVyZXF1aXNpdGVzLmNvbnRhaW5lci50aGVuKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJY29udGFpbmVyUHJlcmVxdWlzaXRlKCk7CgkJCX0KCQl9KTsKCgkJJC53aGVuKCBwcmVyZXF1aXNpdGVzLnNjcmVlbiwgcHJlcmVxdWlzaXRlcy5jb250YWluZXIgKS5kb25lKCBmdW5jdGlvbigpIHsKCQkJaWYgKCBwcmVyZXF1aXNpdGVzID09PSBzZWxmLl9wcmVyZXF1aXNpdGVzICkgewoJCQkJc2VsZi5fcHJlcmVxdWlzaXRlcyA9IG51bGw7CgkJCQl3aGVuRG9uZSgpOwoJCQl9CgkJfSk7CgoJCXNlbGYuX3ByZXJlcXVpc2l0ZXMgPSBwcmVyZXF1aXNpdGVzOwoJfSwKCglfYW5pbWF0ZTogZnVuY3Rpb24oIGFyZ3MgKSB7CgkJLy8gTk9URSBiZWZvcmUgcmVtb3ZpbmcgdGhlIGRlZmF1bHQgYW5pbWF0aW9uIG9mIHRoZSBzY3JlZW4KCQkvLyAgICAgIHRoaXMgaGFkIGFuIGFuaW1hdGUgY2FsbGJhY2sgdGhhdCB3b3VsZCByZXNvbHZlIHRoZSBkZWZlcnJlZAoJCS8vICAgICAgbm93IHRoZSBkZWZlcnJlZCBpcyByZXNvbHZlZCBpbW1lZGlhdGVseQoJCS8vIFRPRE8gcmVtb3ZlIHRoZSBkZXBlbmRlbmN5IG9uIHRoZSBzY3JlZW4gZGVmZXJyZWQKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKQoJCQkuYWRkQ2xhc3MoIGFyZ3Muc2NyZWVuQ2xhc3NUb0FkZCApOwoKCQlhcmdzLnByZXJlcXVpc2l0ZXMuc2NyZWVuLnJlc29sdmUoKTsKCgkJaWYgKCBhcmdzLnRyYW5zaXRpb24gJiYgYXJncy50cmFuc2l0aW9uICE9PSAibm9uZSIgKSB7CgkJCWlmICggYXJncy5hcHBseVRyYW5zaXRpb24gKSB7CgkJCQl0aGlzLl9hcHBseVRyYW5zaXRpb24oIGFyZ3MudHJhbnNpdGlvbiApOwoJCQl9CgkJCWlmICggdGhpcy5fZmFsbGJhY2tUcmFuc2l0aW9uICkgewoJCQkJdGhpcy5fdWkuY29udGFpbmVyCgkJCQkJLmFuaW1hdGlvbkNvbXBsZXRlKCAkLnByb3h5KCBhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLCAicmVzb2x2ZSIgKSApCgkJCQkJLmFkZENsYXNzKCBhcmdzLmNvbnRhaW5lckNsYXNzVG9BZGQgKQoJCQkJCS5yZW1vdmVDbGFzcyggYXJncy5jbGFzc1RvUmVtb3ZlICk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCBhcmdzLmNsYXNzVG9SZW1vdmUgKTsKCQlhcmdzLnByZXJlcXVpc2l0ZXMuY29udGFpbmVyLnJlc29sdmUoKTsKCX0sCgoJLy8gVGhlIGRlc2lyZWQgY29vcmRpbmF0ZXMgcGFzc2VkIGluIHdpbGwgYmUgcmV0dXJuZWQgdW50b3VjaGVkIGlmIG5vIHJlZmVyZW5jZSBlbGVtZW50IGNhbiBiZSBpZGVudGlmaWVkIHZpYQoJLy8gZGVzaXJlZFBvc2l0aW9uLnBvc2l0aW9uVG8uIE5ldmVydGhlbGVzcywgdGhpcyBmdW5jdGlvbiBlbnN1cmVzIHRoYXQgaXRzIHJldHVybiB2YWx1ZSBhbHdheXMgY29udGFpbnMgdmFsaWQKCS8vIHggYW5kIHkgY29vcmRpbmF0ZXMgYnkgc3BlY2lmeWluZyB0aGUgY2VudGVyIG1pZGRsZSBvZiB0aGUgd2luZG93IGlmIHRoZSBjb29yZGluYXRlcyBhcmUgYWJzZW50LgoJLy8gb3B0aW9uczogeyB4OiBjb29yZGluYXRlLCB5OiBjb29yZGluYXRlLCBwb3NpdGlvblRvOiBzdHJpbmc6ICJvcmlnaW4iLCAid2luZG93Iiwgb3IgalF1ZXJ5IHNlbGVjdG9yCglfZGVzaXJlZENvb3JkczogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCXZhciBvZmZzZXQsCgkJCWRzdCA9IG51bGwsCgkJCXdpbmRvd0Nvb3JkaW5hdGVzID0gZ2V0V2luZG93Q29vcmRpbmF0ZXMoIHRoaXMud2luZG93ICksCgkJCXggPSBvcGVuT3B0aW9ucy54LAoJCQl5ID0gb3Blbk9wdGlvbnMueSwKCQkJcFRvID0gb3Blbk9wdGlvbnMucG9zaXRpb25UbzsKCgkJLy8gRXN0YWJsaXNoIHdoaWNoIGVsZW1lbnQgd2lsbCBzZXJ2ZSBhcyB0aGUgcmVmZXJlbmNlCgkJaWYgKCBwVG8gJiYgcFRvICE9PSAib3JpZ2luIiApIHsKCQkJaWYgKCBwVG8gPT09ICJ3aW5kb3ciICkgewoJCQkJeCA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN4IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLng7CgkJCQl5ID0gd2luZG93Q29vcmRpbmF0ZXMuY3kgLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueTsKCQkJfSBlbHNlIHsKCQkJCXRyeSB7CgkJCQkJZHN0ID0gJCggcFRvICk7CgkJCQl9IGNhdGNoKCBlcnIgKSB7CgkJCQkJZHN0ID0gbnVsbDsKCQkJCX0KCQkJCWlmICggZHN0ICkgewoJCQkJCWRzdC5maWx0ZXIoICI6dmlzaWJsZSIgKTsKCQkJCQlpZiAoIGRzdC5sZW5ndGggPT09IDAgKSB7CgkJCQkJCWRzdCA9IG51bGw7CgkJCQkJfQoJCQkJfQoJCQl9CgkJfQoKCQkvLyBJZiBhbiBlbGVtZW50IHdhcyBmb3VuZCwgY2VudGVyIG92ZXIgaXQKCQlpZiAoIGRzdCApIHsKCQkJb2Zmc2V0ID0gZHN0Lm9mZnNldCgpOwoJCQl4ID0gb2Zmc2V0LmxlZnQgKyBkc3Qub3V0ZXJXaWR0aCgpIC8gMjsKCQkJeSA9IG9mZnNldC50b3AgKyBkc3Qub3V0ZXJIZWlnaHQoKSAvIDI7CgkJfQoKCQkvLyBNYWtlIHN1cmUgeCBhbmQgeSBhcmUgdmFsaWQgbnVtYmVycyAtIGNlbnRlciBvdmVyIHRoZSB3aW5kb3cKCQlpZiAoICQudHlwZSggeCApICE9PSAibnVtYmVyIiB8fCBpc05hTiggeCApICkgewoJCQl4ID0gd2luZG93Q29vcmRpbmF0ZXMuY3ggLyAyICsgd2luZG93Q29vcmRpbmF0ZXMueDsKCQl9CgkJaWYgKCAkLnR5cGUoIHkgKSAhPT0gIm51bWJlciIgfHwgaXNOYU4oIHkgKSApIHsKCQkJeSA9IHdpbmRvd0Nvb3JkaW5hdGVzLmN5IC8gMiArIHdpbmRvd0Nvb3JkaW5hdGVzLnk7CgkJfQoKCQlyZXR1cm4geyB4OiB4LCB5OiB5IH07Cgl9LAoKCV9yZXBvc2l0aW9uOiBmdW5jdGlvbiggb3Blbk9wdGlvbnMgKSB7CgkJLy8gV2Ugb25seSBjYXJlIGFib3V0IHBvc2l0aW9uLXJlbGF0ZWQgcGFyYW1ldGVycyBmb3IgcmVwb3NpdGlvbmluZwoJCW9wZW5PcHRpb25zID0gewoJCQl4OiBvcGVuT3B0aW9ucy54LAoJCQl5OiBvcGVuT3B0aW9ucy55LAoJCQlwb3NpdGlvblRvOiBvcGVuT3B0aW9ucy5wb3NpdGlvblRvCgkJfTsKCQl0aGlzLl90cmlnZ2VyKCAiYmVmb3JlcG9zaXRpb24iLCB1bmRlZmluZWQsIG9wZW5PcHRpb25zICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLm9mZnNldCggdGhpcy5fcGxhY2VtZW50Q29vcmRzKCB0aGlzLl9kZXNpcmVkQ29vcmRzKCBvcGVuT3B0aW9ucyApICkgKTsKCX0sCgoJcmVwb3NpdGlvbjogZnVuY3Rpb24oIG9wZW5PcHRpb25zICkgewoJCWlmICggdGhpcy5faXNPcGVuICkgewoJCQl0aGlzLl9yZXBvc2l0aW9uKCBvcGVuT3B0aW9ucyApOwoJCX0KCX0sCgoJX29wZW5QcmVyZXF1aXNpdGVzQ29tcGxldGU6IGZ1bmN0aW9uKCkgewoJCXZhciBpZCA9IHRoaXMuZWxlbWVudC5hdHRyKCAiaWQiICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5hZGRDbGFzcyggInVpLXBvcHVwLWFjdGl2ZSIgKTsKCQl0aGlzLl9pc09wZW4gPSB0cnVlOwoJCXRoaXMuX3Jlc2l6ZVNjcmVlbigpOwoJCXRoaXMuX3VpLmNvbnRhaW5lci5hdHRyKCAidGFiaW5kZXgiLCAiMCIgKS5mb2N1cygpOwoJCXRoaXMuX2lnbm9yZVJlc2l6ZUV2ZW50cygpOwoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgdHJ1ZSApOwoJCX0KCQl0aGlzLl90cmlnZ2VyKCAiYWZ0ZXJvcGVuIiApOwoJfSwKCglfb3BlbjogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIG9wZW5PcHRpb25zID0gJC5leHRlbmQoIHt9LCB0aGlzLm9wdGlvbnMsIG9wdGlvbnMgKSwKCQkJLy8gVE9ETyBtb3ZlIGJsYWNrbGlzdCB0byBwcml2YXRlIG1ldGhvZAoJCQlhbmRyb2lkQmxhY2tsaXN0ID0gKCBmdW5jdGlvbigpIHsKCQkJCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJCQl3a21hdGNoID0gdWEubWF0Y2goIC9BcHBsZVdlYktpdFwvKFswLTlcLl0rKS8gKSwKCQkJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQkJCWFuZHJvaWRtYXRjaCA9IHVhLm1hdGNoKCAvQW5kcm9pZCAoXGQrKD86XC5cZCspKS8gKSwKCQkJCQlhbmR2ZXJzaW9uID0gISFhbmRyb2lkbWF0Y2ggJiYgYW5kcm9pZG1hdGNoWyAxIF0sCgkJCQkJY2hyb21lbWF0Y2ggPSB1YS5pbmRleE9mKCAiQ2hyb21lIiApID4gLTE7CgoJCQkJLy8gUGxhdGZvcm0gaXMgQW5kcm9pZCwgV2ViS2l0IHZlcnNpb24gaXMgZ3JlYXRlciB0aGFuIDUzNC4xMyAoIEFuZHJvaWQgMy4yLjEgKSBhbmQgbm90IENocm9tZS4KCQkJCWlmICggYW5kcm9pZG1hdGNoICE9PSBudWxsICYmIGFuZHZlcnNpb24gPT09ICI0LjAiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPiA1MzQuMTMgJiYgIWNocm9tZW1hdGNoICkgewoJCQkJCXJldHVybiB0cnVlOwoJCQkJfQoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KCkpOwoKCQkvLyBDb3VudCBkb3duIHRvIHRyaWdnZXJpbmcgInBvcHVwYWZ0ZXJvcGVuIiAtIHdlIGhhdmUgdHdvIHByZXJlcXVpc2l0ZXM6CgkJLy8gMS4gVGhlIHBvcHVwIHdpbmRvdyBhbmltYXRpb24gY29tcGxldGVzIChjb250YWluZXIoKSkKCQkvLyAyLiBUaGUgc2NyZWVuIG9wYWNpdHkgYW5pbWF0aW9uIGNvbXBsZXRlcyAoc2NyZWVuKCkpCgkJdGhpcy5fY3JlYXRlUHJlcmVxdWlzaXRlcygKCQkJJC5ub29wLAoJCQkkLm5vb3AsCgkJCSQucHJveHkoIHRoaXMsICJfb3BlblByZXJlcXVpc2l0ZXNDb21wbGV0ZSIgKSApOwoKCQl0aGlzLl9jdXJyZW50VHJhbnNpdGlvbiA9IG9wZW5PcHRpb25zLnRyYW5zaXRpb247CgkJdGhpcy5fYXBwbHlUcmFuc2l0aW9uKCBvcGVuT3B0aW9ucy50cmFuc2l0aW9uICk7CgoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmVDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtdHJ1bmNhdGUiICk7CgoJCS8vIEdpdmUgYXBwbGljYXRpb25zIGEgY2hhbmNlIHRvIG1vZGlmeSB0aGUgY29udGVudHMgb2YgdGhlIGNvbnRhaW5lciBiZWZvcmUgaXQgYXBwZWFycwoJCXRoaXMuX3JlcG9zaXRpb24oIG9wZW5PcHRpb25zICk7CgoJCXRoaXMuX3VpLmNvbnRhaW5lci5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWhpZGRlbiIgKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMub3ZlcmxheVRoZW1lICYmIGFuZHJvaWRCbGFja2xpc3QgKSB7CgkJCS8qIFRPRE86IFRoZSBuYXRpdmUgYnJvd3NlciBvbiBBbmRyb2lkIDQuMC5YICgiSWNlIENyZWFtIFNhbmR3aWNoIikgc3VmZmVycyBmcm9tIGFuIGlzc3VlIHdoZXJlIHRoZSBwb3B1cCBvdmVybGF5IGFwcGVhcnMgdG8gYmUgei1pbmRleGVkIGFib3ZlIHRoZSBwb3B1cCBpdHNlbGYgd2hlbiBjZXJ0YWluIG90aGVyIHN0eWxlcyBleGlzdCBvbiB0aGUgc2FtZSBwYWdlIC0tIG5hbWVseSwgYW55IGVsZW1lbnQgc2V0IHRvIGBwb3NpdGlvbjogZml4ZWRgIGFuZCBjZXJ0YWluIHR5cGVzIG9mIGlucHV0LiBUaGVzZSBpc3N1ZXMgYXJlIHJlbWluaXNjZW50IG9mIHByZXZpb3VzbHkgdW5jb3ZlcmVkIGJ1Z3MgaW4gb2xkZXIgdmVyc2lvbnMgb2YgQW5kcm9pZCdzIG5hdGl2ZSBicm93c2VyOiBodHRwczovL2dpdGh1Yi5jb20vc2NvdHRqZWhsL0RldmljZS1CdWdzL2lzc3Vlcy8zCgkJCVRoaXMgZml4IGNsb3NlcyB0aGUgZm9sbG93aW5nIGJ1Z3MgKCBJIHVzZSAiY2xvc2VzIiB3aXRoIHJlbHVjdGFuY2UsIGFuZCBzdHJlc3MgdGhhdCB0aGlzIGlzc3VlIHNob3VsZCBiZSByZXZpc2l0ZWQgYXMgc29vbiBhcyBwb3NzaWJsZSApOgoJCQlodHRwczovL2dpdGh1Yi5jb20vanF1ZXJ5L2pxdWVyeS1tb2JpbGUvaXNzdWVzLzQ4MTYKCQkJaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy80ODQ0CgkJCWh0dHBzOi8vZ2l0aHViLmNvbS9qcXVlcnkvanF1ZXJ5LW1vYmlsZS9pc3N1ZXMvNDg3NAoJCQkqLwoKCQkJLy8gVE9ETyBzb3J0IG91dCB3aHkgdGhpcy5fcGFnZSBpc24ndCB3b3JraW5nCgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkuYWRkQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoJCX0KCQl0aGlzLl9hbmltYXRlKHsKCQkJYWRkaXRpb25hbENvbmRpdGlvbjogdHJ1ZSwKCQkJdHJhbnNpdGlvbjogb3Blbk9wdGlvbnMudHJhbnNpdGlvbiwKCQkJY2xhc3NUb1JlbW92ZTogIiIsCgkJCXNjcmVlbkNsYXNzVG9BZGQ6ICJpbiIsCgkJCWNvbnRhaW5lckNsYXNzVG9BZGQ6ICJpbiIsCgkJCWFwcGx5VHJhbnNpdGlvbjogZmFsc2UsCgkJCXByZXJlcXVpc2l0ZXM6IHRoaXMuX3ByZXJlcXVpc2l0ZXMKCQl9KTsKCX0sCgoJX2Nsb3NlUHJlcmVxdWlzaXRlU2NyZWVuOiBmdW5jdGlvbigpIHsKCQl0aGlzLl91aS5zY3JlZW4KCQkJLnJlbW92ZUNsYXNzKCAib3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7Cgl9LAoKCV9jbG9zZVByZXJlcXVpc2l0ZUNvbnRhaW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyCgkJCS5yZW1vdmVDbGFzcyggInJldmVyc2Ugb3V0IiApCgkJCS5hZGRDbGFzcyggInVpLXBvcHVwLWhpZGRlbiB1aS1wb3B1cC10cnVuY2F0ZSIgKQoJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApOwoJfSwKCglfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZTogZnVuY3Rpb24oKSB7CgkJdmFyIGNvbnRhaW5lciA9IHRoaXMuX3VpLmNvbnRhaW5lciwKCQkJaWQgPSB0aGlzLmVsZW1lbnQuYXR0ciggImlkIiApOwoKCQljb250YWluZXIucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoKCQkvLyByZW1vdmUgdGhlIGdsb2JhbCBtdXRleCBmb3IgcG9wdXBzCgkJJC5tb2JpbGUucG9wdXAuYWN0aXZlID0gdW5kZWZpbmVkOwoKCQkvLyBCbHVyIGVsZW1lbnRzIGluc2lkZSB0aGUgY29udGFpbmVyLCBpbmNsdWRpbmcgdGhlIGNvbnRhaW5lcgoJCSQoICI6Zm9jdXMiLCBjb250YWluZXJbIDAgXSApLmFkZCggY29udGFpbmVyWyAwIF0gKS5ibHVyKCk7CgoJCWlmICggaWQgKSB7CgkJCXRoaXMuZG9jdW1lbnQuZmluZCggIlthcmlhLWhhc3BvcHVwPSd0cnVlJ11bYXJpYS1vd25zPSciICsgIGlkICsgIiddIiApLmF0dHIoICJhcmlhLWV4cGFuZGVkIiwgZmFsc2UgKTsKCQl9CgoJCS8vIGFsZXJ0IHVzZXJzIHRoYXQgdGhlIHBvcHVwIGlzIGNsb3NlZAoJCXRoaXMuX3RyaWdnZXIoICJhZnRlcmNsb3NlIiApOwoJfSwKCglfY2xvc2U6IGZ1bmN0aW9uKCBpbW1lZGlhdGUgKSB7CgkJdGhpcy5fdWkuY29udGFpbmVyLnJlbW92ZUNsYXNzKCAidWktcG9wdXAtYWN0aXZlIiApOwoJCXRoaXMuX3BhZ2UucmVtb3ZlQ2xhc3MoICJ1aS1wb3B1cC1vcGVuIiApOwoKCQl0aGlzLl9pc09wZW4gPSBmYWxzZTsKCgkJLy8gQ291bnQgZG93biB0byB0cmlnZ2VyaW5nICJwb3B1cGFmdGVyY2xvc2UiIC0gd2UgaGF2ZSB0d28gcHJlcmVxdWlzaXRlczoKCQkvLyAxLiBUaGUgcG9wdXAgd2luZG93IHJldmVyc2UgYW5pbWF0aW9uIGNvbXBsZXRlcyAoY29udGFpbmVyKCkpCgkJLy8gMi4gVGhlIHNjcmVlbiBvcGFjaXR5IGFuaW1hdGlvbiBjb21wbGV0ZXMgKHNjcmVlbigpKQoJCXRoaXMuX2NyZWF0ZVByZXJlcXVpc2l0ZXMoCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVTY3JlZW4iICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVDb250YWluZXIiICksCgkJCSQucHJveHkoIHRoaXMsICJfY2xvc2VQcmVyZXF1aXNpdGVzRG9uZSIgKSApOwoKCQl0aGlzLl9hbmltYXRlKCB7CgkJCWFkZGl0aW9uYWxDb25kaXRpb246IHRoaXMuX3VpLnNjcmVlbi5oYXNDbGFzcyggImluIiApLAoJCQl0cmFuc2l0aW9uOiAoIGltbWVkaWF0ZSA/ICJub25lIiA6ICggdGhpcy5fY3VycmVudFRyYW5zaXRpb24gKSApLAoJCQljbGFzc1RvUmVtb3ZlOiAiaW4iLAoJCQlzY3JlZW5DbGFzc1RvQWRkOiAib3V0IiwKCQkJY29udGFpbmVyQ2xhc3NUb0FkZDogInJldmVyc2Ugb3V0IiwKCQkJYXBwbHlUcmFuc2l0aW9uOiB0cnVlLAoJCQlwcmVyZXF1aXNpdGVzOiB0aGlzLl9wcmVyZXF1aXNpdGVzCgkJfSk7Cgl9LAoKCV91bmVuaGFuY2U6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyBQdXQgdGhlIGVsZW1lbnQgYmFjayB0byB3aGVyZSB0aGUgcGxhY2Vob2xkZXIgd2FzIGFuZCByZW1vdmUgdGhlICJ1aS1wb3B1cCIgY2xhc3MKCQl0aGlzLl9zZXRPcHRpb25zKCB7IHRoZW1lOiAkLm1vYmlsZS5wb3B1cC5wcm90b3R5cGUub3B0aW9ucy50aGVtZSB9ICk7CgkJdGhpcy5lbGVtZW50CgkJCS8vIENhbm5vdCBkaXJlY3RseSBpbnNlcnRBZnRlcigpIC0gd2UgbmVlZCB0byBkZXRhY2goKSBmaXJzdCwgYmVjYXVzZQoJCQkvLyBpbnNlcnRBZnRlcigpIHdpbGwgZG8gbm90aGluZyBpZiB0aGUgcGF5bG9hZCBkaXYgd2FzIG5vdCBhdHRhY2hlZAoJCQkvLyB0byB0aGUgRE9NIGF0IHRoZSB0aW1lIHRoZSB3aWRnZXQgd2FzIGNyZWF0ZWQsIGFuZCBzbyB0aGUgcGF5bG9hZAoJCQkvLyB3aWxsIHJlbWFpbiBpbnNpZGUgdGhlIGNvbnRhaW5lciBldmVuIGFmdGVyIHdlIGNhbGwgaW5zZXJ0QWZ0ZXIoKS4KCQkJLy8gSWYgdGhhdCBoYXBwZW5zIGFuZCB3ZSByZW1vdmUgdGhlIGNvbnRhaW5lciBhIGZldyBsaW5lcyBiZWxvdywgd2UKCQkJLy8gd2lsbCBjYXVzZSBhbiBpbmZpbml0ZSByZWN1cnNpb24gLSAjNTI0NAoJCQkuZGV0YWNoKCkKCQkJLmluc2VydEFmdGVyKCB0aGlzLl91aS5wbGFjZWhvbGRlciApCgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwIHVpLW92ZXJsYXktc2hhZG93IHVpLWNvcm5lci1hbGwgdWktYm9keS1pbmhlcml0IiApOwoJCXRoaXMuX3VpLnNjcmVlbi5yZW1vdmUoKTsKCQl0aGlzLl91aS5jb250YWluZXIucmVtb3ZlKCk7CgkJdGhpcy5fdWkucGxhY2Vob2xkZXIucmVtb3ZlKCk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCQlpZiAoICQubW9iaWxlLnBvcHVwLmFjdGl2ZSA9PT0gdGhpcyApIHsKCQkJdGhpcy5lbGVtZW50Lm9uZSggInBvcHVwYWZ0ZXJjbG9zZSIsICQucHJveHkoIHRoaXMsICJfdW5lbmhhbmNlIiApICk7CgkJCXRoaXMuY2xvc2UoKTsKCQl9IGVsc2UgewoJCQl0aGlzLl91bmVuaGFuY2UoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfSwKCglfY2xvc2VQb3B1cDogZnVuY3Rpb24oIHRoZUV2ZW50LCBkYXRhICkgewoJCXZhciBwYXJzZWREc3QsIHRvVXJsLAoJCQljdXJyZW50T3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJaW1tZWRpYXRlID0gZmFsc2U7CgoJCWlmICggKCB0aGVFdmVudCAmJiB0aGVFdmVudC5pc0RlZmF1bHRQcmV2ZW50ZWQoKSApIHx8ICQubW9iaWxlLnBvcHVwLmFjdGl2ZSAhPT0gdGhpcyApIHsKCQkJcmV0dXJuOwoJCX0KCgkJLy8gcmVzdG9yZSBsb2NhdGlvbiBvbiBzY3JlZW4KCQl3aW5kb3cuc2Nyb2xsVG8oIDAsIHRoaXMuX3Njcm9sbFRvcCApOwoKCQlpZiAoIHRoZUV2ZW50ICYmIHRoZUV2ZW50LnR5cGUgPT09ICJwYWdlYmVmb3JlY2hhbmdlIiAmJiBkYXRhICkgewoJCQkvLyBEZXRlcm1pbmUgd2hldGhlciB3ZSBuZWVkIHRvIHJhcGlkLWNsb3NlIHRoZSBwb3B1cCwgb3Igd2hldGhlciB3ZSBjYW4KCQkJLy8gdGFrZSB0aGUgdGltZSB0byBydW4gdGhlIGNsb3NpbmcgdHJhbnNpdGlvbgoJCQlpZiAoIHR5cGVvZiBkYXRhLnRvUGFnZSA9PT0gInN0cmluZyIgKSB7CgkJCQlwYXJzZWREc3QgPSBkYXRhLnRvUGFnZTsKCQkJfSBlbHNlIHsKCQkJCXBhcnNlZERzdCA9IGRhdGEudG9QYWdlLmpxbURhdGEoICJ1cmwiICk7CgkJCX0KCQkJcGFyc2VkRHN0ID0gJC5tb2JpbGUucGF0aC5wYXJzZVVybCggcGFyc2VkRHN0ICk7CgkJCXRvVXJsID0gcGFyc2VkRHN0LnBhdGhuYW1lICsgcGFyc2VkRHN0LnNlYXJjaCArIHBhcnNlZERzdC5oYXNoOwoKCQkJaWYgKCB0aGlzLl9teVVybCAhPT0gJC5tb2JpbGUucGF0aC5tYWtlVXJsQWJzb2x1dGUoIHRvVXJsICkgKSB7CgkJCQkvLyBHb2luZyB0byBhIGRpZmZlcmVudCBwYWdlIC0gY2xvc2UgaW1tZWRpYXRlbHkKCQkJCWltbWVkaWF0ZSA9IHRydWU7CgkJCX0gZWxzZSB7CgkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfQoKCQkvLyByZW1vdmUgbmF2IGJpbmRpbmdzCgkJdGhpcy53aW5kb3cub2ZmKCBjdXJyZW50T3B0aW9ucy5jbG9zZUV2ZW50cyApOwoJCS8vIHVuYmluZCBjbGljayBoYW5kbGVycyBhZGRlZCB3aGVuIGhpc3RvcnkgaXMgZGlzYWJsZWQKCQl0aGlzLmVsZW1lbnQudW5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cyApOwoKCQl0aGlzLl9jbG9zZSggaW1tZWRpYXRlICk7Cgl9LAoKCS8vIGFueSBuYXZpZ2F0aW9uIGV2ZW50IGFmdGVyIGEgcG9wdXAgaXMgb3BlbmVkIHNob3VsZCBjbG9zZSB0aGUgcG9wdXAKCS8vIE5PVEUgdGhlIHBhZ2ViZWZvcmVjaGFuZ2UgaXMgYm91bmQgdG8gY2F0Y2ggbmF2aWdhdGlvbiBldmVudHMgdGhhdCBkb24ndAoJLy8gICAgICBhbHRlciB0aGUgdXJsIChlZywgZGlhbG9ncyBmcm9tIHBvcHVwcykKCV9iaW5kQ29udGFpbmVyQ2xvc2U6IGZ1bmN0aW9uKCkgewoJCXRoaXMud2luZG93CgkJCS5vbiggdGhpcy5vcHRpb25zLmNsb3NlRXZlbnRzLCAkLnByb3h5KCB0aGlzLCAiX2Nsb3NlUG9wdXAiICkgKTsKCX0sCgoJd2lkZ2V0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5fdWkuY29udGFpbmVyOwoJfSwKCgkvLyBUT0RPIG5vIGNsZWFyIGRlbGluaWF0aW9uIG9mIHdoYXQgc2hvdWxkIGJlIGhlcmUgYW5kCgkvLyB3aGF0IHNob3VsZCBiZSBpbiBfb3Blbi4gU2VlbXMgdG8gYmUgInZpc3VhbCIgdnMgImhpc3RvcnkiIGZvciBub3cKCW9wZW46IGZ1bmN0aW9uKCBvcHRpb25zICkgewoJCXZhciB1cmwsIGhhc2hrZXksIGFjdGl2ZVBhZ2UsIGN1cnJlbnRJc0RpYWxvZywgaGFzSGFzaCwgdXJsSGlzdG9yeSwKCQkJc2VsZiA9IHRoaXMsCgkJCWN1cnJlbnRPcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQkvLyBtYWtlIHN1cmUgb3BlbiBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgfHwgY3VycmVudE9wdGlvbnMuZGlzYWJsZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gc2V0IHRoZSBnbG9iYWwgcG9wdXAgbXV0ZXgKCQkkLm1vYmlsZS5wb3B1cC5hY3RpdmUgPSB0aGlzOwoJCXRoaXMuX3Njcm9sbFRvcCA9IHRoaXMud2luZG93LnNjcm9sbFRvcCgpOwoKCQkvLyBpZiBoaXN0b3J5IGFsdGVyYXRpb24gaXMgZGlzYWJsZWQgY2xvc2Ugb24gbmF2aWdhdGUgZXZlbnRzCgkJLy8gYW5kIGxlYXZlIHRoZSB1cmwgYXMgaXMKCQlpZiAoICEoIGN1cnJlbnRPcHRpb25zLmhpc3RvcnkgKSApIHsKCQkJc2VsZi5fb3Blbiggb3B0aW9ucyApOwoJCQlzZWxmLl9iaW5kQ29udGFpbmVyQ2xvc2UoKTsKCgkJCS8vIFdoZW4gaGlzdG95IGlzIGRpc2FibGVkIHdlIGhhdmUgdG8gZ3JhYiB0aGUgZGF0YS1yZWwKCQkJLy8gYmFjayBsaW5rIGNsaWNrcyBzbyB3ZSBjYW4gY2xvc2UgdGhlIHBvcHVwIGluc3RlYWQgb2YKCQkJLy8gcmVseWluZyBvbiBoaXN0b3J5IHRvIGRvIGl0IGZvciB1cwoJCQlzZWxmLmVsZW1lbnQKCQkJCS5kZWxlZ2F0ZSggY3VycmVudE9wdGlvbnMuY2xvc2VMaW5rU2VsZWN0b3IsIGN1cnJlbnRPcHRpb25zLmNsb3NlTGlua0V2ZW50cywgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJfSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCS8vIGNhY2hlIHNvbWUgdmFsdWVzIGZvciBtaW4vcmVhZGFiaWxpdHkKCQl1cmxIaXN0b3J5ID0gJC5tb2JpbGUubmF2aWdhdGUuaGlzdG9yeTsKCQloYXNoa2V5ID0gJC5tb2JpbGUuZGlhbG9nSGFzaEtleTsKCQlhY3RpdmVQYWdlID0gJC5tb2JpbGUuYWN0aXZlUGFnZTsKCQljdXJyZW50SXNEaWFsb2cgPSAoIGFjdGl2ZVBhZ2UgPyBhY3RpdmVQYWdlLmhhc0NsYXNzKCAidWktZGlhbG9nIiApIDogZmFsc2UgKTsKCQl0aGlzLl9teVVybCA9IHVybCA9IHVybEhpc3RvcnkuZ2V0QWN0aXZlKCkudXJsOwoJCWhhc0hhc2ggPSAoIHVybC5pbmRleE9mKCBoYXNoa2V5ICkgPiAtMSApICYmICFjdXJyZW50SXNEaWFsb2cgJiYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID4gMCApOwoKCQlpZiAoIGhhc0hhc2ggKSB7CgkJCXNlbGYuX29wZW4oIG9wdGlvbnMgKTsKCQkJc2VsZi5fYmluZENvbnRhaW5lckNsb3NlKCk7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJLy8gaWYgdGhlIGN1cnJlbnQgdXJsIGhhcyBubyBkaWFsb2cgaGFzaCBrZXkgcHJvY2VlZCBhcyBub3JtYWwKCQkvLyBvdGhlcndpc2UsIGlmIHRoZSBwYWdlIGlzIGEgZGlhbG9nIHNpbXBseSB0YWNrIG9uIHRoZSBoYXNoIGtleQoJCWlmICggdXJsLmluZGV4T2YoIGhhc2hrZXkgKSA9PT0gLTEgJiYgIWN1cnJlbnRJc0RpYWxvZyApIHsKCQkJdXJsID0gdXJsICsgKHVybC5pbmRleE9mKCAiIyIgKSA+IC0xID8gaGFzaGtleSA6ICIjIiArIGhhc2hrZXkpOwoJCX0gZWxzZSB7CgkJCXVybCA9ICQubW9iaWxlLnBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2ggKyBoYXNoa2V5OwoJCX0KCgkJLy8gVGFjayBvbiBhbiBleHRyYSBoYXNoa2V5IGlmIHRoaXMgaXMgdGhlIGZpcnN0IHBhZ2UgYW5kIHdlJ3ZlIGp1c3QgcmVjb25zdHJ1Y3RlZCB0aGUgaW5pdGlhbCBoYXNoCgkJaWYgKCB1cmxIaXN0b3J5LmFjdGl2ZUluZGV4ID09PSAwICYmIHVybCA9PT0gdXJsSGlzdG9yeS5pbml0aWFsRHN0ICkgewoJCQl1cmwgKz0gaGFzaGtleTsKCQl9CgoJCS8vIHN3YWxsb3cgdGhlIHRoZSBpbml0aWFsIG5hdmlnYXRpb24gZXZlbnQsIGFuZCBiaW5kIGZvciB0aGUgbmV4dAoJCXRoaXMud2luZG93Lm9uZSggImJlZm9yZW5hdmlnYXRlIiwgZnVuY3Rpb24oIHRoZUV2ZW50ICkgewoJCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLl9vcGVuKCBvcHRpb25zICk7CgkJCXNlbGYuX2JpbmRDb250YWluZXJDbG9zZSgpOwoJCX0pOwoKCQl0aGlzLnVybEFsdGVyZWQgPSB0cnVlOwoJCSQubW9iaWxlLm5hdmlnYXRlKCB1cmwsIHsgcm9sZTogImRpYWxvZyIgfSApOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJY2xvc2U6IGZ1bmN0aW9uKCkgewoJCS8vIG1ha2Ugc3VyZSBjbG9zZSBpcyBpZGVtcG90ZW50CgkJaWYgKCAkLm1vYmlsZS5wb3B1cC5hY3RpdmUgIT09IHRoaXMgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdGhpcy5fc2Nyb2xsVG9wID0gdGhpcy53aW5kb3cuc2Nyb2xsVG9wKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhpc3RvcnkgJiYgdGhpcy51cmxBbHRlcmVkICkgewoJCQkkLm1vYmlsZS5iYWNrKCk7CgkJCXRoaXMudXJsQWx0ZXJlZCA9IGZhbHNlOwoJCX0gZWxzZSB7CgkJCS8vIHNpbXVsYXRlIHRoZSBuYXYgYmluZGluZ3MgaGF2aW5nIGZpcmVkCgkJCXRoaXMuX2Nsb3NlUG9wdXAoKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQp9KTsKCi8vIFRPRE8gdGhpcyBjYW4gYmUgbW92ZWQgaW5zaWRlIHRoZSB3aWRnZXQKJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayA9IGZ1bmN0aW9uKCAkbGluayApIHsKCXZhciBvZmZzZXQsCgkJcGF0aCA9ICQubW9iaWxlLnBhdGgsCgoJCS8vIE5PVEUgbWFrZSBzdXJlIHRvIGdldCBvbmx5IHRoZSBoYXNoIGZyb20gdGhlIGhyZWYgYmVjYXVzZSBpZTcgKHdwNykKCQkvLyAgICAgIHJldHVybnMgdGhlIGFic29sdXRlIGhyZWYgaW4gdGhpcyBjYXNlIHJ1aW5pbmcgdGhlIGVsZW1lbnQgc2VsZWN0aW9uCgkJcG9wdXAgPSAkKCBwYXRoLmhhc2hUb1NlbGVjdG9yKCBwYXRoLnBhcnNlVXJsKCAkbGluay5hdHRyKCAiaHJlZiIgKSApLmhhc2ggKSApLmZpcnN0KCk7CgoJaWYgKCBwb3B1cC5sZW5ndGggPiAwICYmIHBvcHVwLmRhdGEoICJtb2JpbGUtcG9wdXAiICkgKSB7CgkJb2Zmc2V0ID0gJGxpbmsub2Zmc2V0KCk7CgkJcG9wdXAucG9wdXAoICJvcGVuIiwgewoJCQl4OiBvZmZzZXQubGVmdCArICRsaW5rLm91dGVyV2lkdGgoKSAvIDIsCgkJCXk6IG9mZnNldC50b3AgKyAkbGluay5vdXRlckhlaWdodCgpIC8gMiwKCQkJdHJhbnNpdGlvbjogJGxpbmsuanFtRGF0YSggInRyYW5zaXRpb24iICksCgkJCXBvc2l0aW9uVG86ICRsaW5rLmpxbURhdGEoICJwb3NpdGlvbi10byIgKQoJCX0pOwoJfQoKCS8vcmVtb3ZlIGFmdGVyIGRlbGF5CglzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkkbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCX0sIDMwMCApOwp9OwoKLy8gVE9ETyBtb3ZlIGluc2lkZSBfY3JlYXRlCiQubW9iaWxlLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWNoYW5nZSIsIGZ1bmN0aW9uKCB0aGVFdmVudCwgZGF0YSApIHsKCWlmICggZGF0YS5vcHRpb25zLnJvbGUgPT09ICJwb3B1cCIgKSB7CgkJJC5tb2JpbGUucG9wdXAuaGFuZGxlTGluayggZGF0YS5vcHRpb25zLmxpbmsgKTsKCQl0aGVFdmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCi8qCiogY3VzdG9tICJzZWxlY3RtZW51IiBwbHVnaW4KKi8KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHVuZm9jdXNhYmxlSXRlbVNlbGVjdG9yID0gIi51aS1kaXNhYmxlZCwudWktc3RhdGUtZGlzYWJsZWQsLnVpLWxpLWRpdmlkZXIsLnVpLXNjcmVlbi1oaWRkZW4sOmpxbURhdGEocm9sZT0ncGxhY2Vob2xkZXInKSIsCglnb1RvQWRqYWNlbnRJdGVtID0gZnVuY3Rpb24oIGl0ZW0sIHRhcmdldCwgZGlyZWN0aW9uICkgewoJCXZhciBhZGphY2VudCA9IGl0ZW1bIGRpcmVjdGlvbiArICJBbGwiIF0oKQoJCQkubm90KCB1bmZvY3VzYWJsZUl0ZW1TZWxlY3RvciApCgkJCS5maXJzdCgpOwoKCQkvLyBpZiB0aGVyZSdzIGEgcHJldmlvdXMgb3B0aW9uLCBmb2N1cyBpdAoJCWlmICggYWRqYWNlbnQubGVuZ3RoICkgewoJCQl0YXJnZXQKCQkJCS5ibHVyKCkKCQkJCS5hdHRyKCAidGFiaW5kZXgiLCAiLTEiICk7CgoJCQlhZGphY2VudC5maW5kKCAiYSIgKS5maXJzdCgpLmZvY3VzKCk7CgkJfQoJfTsKCiQud2lkZ2V0KCAibW9iaWxlLnNlbGVjdG1lbnUiLCAkLm1vYmlsZS5zZWxlY3RtZW51LCB7CglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl2YXIgbyA9IHRoaXMub3B0aW9uczsKCgkJLy8gQ3VzdG9tIHNlbGVjdHMgY2Fubm90IGV4aXN0IGluc2lkZSBwb3B1cHMsIHNvIHJldmVydCB0aGUgIm5hdGl2ZU1lbnUiCgkJLy8gb3B0aW9uIHRvIHRydWUgaWYgYSBwYXJlbnQgaXMgYSBwb3B1cAoJCW8ubmF0aXZlTWVudSA9IG8ubmF0aXZlTWVudSB8fCAoIHRoaXMuZWxlbWVudC5wYXJlbnRzKCAiOmpxbURhdGEocm9sZT0ncG9wdXAnKSw6bW9iaWxlLXBvcHVwIiApLmxlbmd0aCA+IDAgKTsKCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCV9oYW5kbGVTZWxlY3RGb2N1czogZnVuY3Rpb24oKSB7CgkJdGhpcy5lbGVtZW50LmJsdXIoKTsKCQl0aGlzLmJ1dHRvbi5mb2N1cygpOwoJfSwKCglfaGFuZGxlS2V5ZG93bjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXRoaXMuX3N1cGVyKCBldmVudCApOwoJCXRoaXMuX2hhbmRsZUJ1dHRvblZjbGlja0tleWRvd24oIGV2ZW50ICk7Cgl9LAoKCV9oYW5kbGVCdXR0b25WY2xpY2tLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJaWYgKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgfHwgdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmIChldmVudC50eXBlID09PSAidmNsaWNrIiB8fAoJCQkJZXZlbnQua2V5Q29kZSAmJiAoZXZlbnQua2V5Q29kZSA9PT0gJC5tb2JpbGUua2V5Q29kZS5FTlRFUiB8fCBldmVudC5rZXlDb2RlID09PSAkLm1vYmlsZS5rZXlDb2RlLlNQQUNFKSkgewoKCQkJdGhpcy5fZGVjaWRlRm9ybWF0KCk7CgkJCWlmICggdGhpcy5tZW51VHlwZSA9PT0gIm92ZXJsYXkiICkgewoJCQkJdGhpcy5idXR0b24uYXR0ciggImhyZWYiLCAiIyIgKyB0aGlzLnBvcHVwSWQgKS5hdHRyKCAiZGF0YS0iICsgKCAkLm1vYmlsZS5ucyB8fCAiIiApICsgInJlbCIsICJwb3B1cCIgKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuYnV0dG9uLmF0dHIoICJocmVmIiwgIiMiICsgdGhpcy5kaWFsb2dJZCApLmF0dHIoICJkYXRhLSIgKyAoICQubW9iaWxlLm5zIHx8ICIiICkgKyAicmVsIiwgImRpYWxvZyIgKTsKCQkJfQoJCQl0aGlzLmlzT3BlbiA9IHRydWU7CgkJCS8vIERvIG5vdCBwcmV2ZW50IGRlZmF1bHQsIHNvIHRoZSBuYXZpZ2F0aW9uIG1heSBoYXZlIGEgY2hhbmNlIHRvIGFjdHVhbGx5IG9wZW4gdGhlIGNob3NlbiBmb3JtYXQKCQl9Cgl9LAoKCV9oYW5kbGVMaXN0Rm9jdXM6IGZ1bmN0aW9uKCBlICkgewoJCXZhciBwYXJhbXMgPSAoIGUudHlwZSA9PT0gImZvY3VzaW4iICkgPwoJCQl7IHRhYmluZGV4OiAiMCIsIGV2ZW50OiAidm1vdXNlb3ZlciIgfToKCQkJeyB0YWJpbmRleDogIi0xIiwgZXZlbnQ6ICJ2bW91c2VvdXQiIH07CgoJCSQoIGUudGFyZ2V0ICkKCQkJLmF0dHIoICJ0YWJpbmRleCIsIHBhcmFtcy50YWJpbmRleCApCgkJCS50cmlnZ2VyKCBwYXJhbXMuZXZlbnQgKTsKCX0sCgoJX2hhbmRsZUxpc3RLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIHRhcmdldCA9ICQoIGV2ZW50LnRhcmdldCApLAoJCQlsaSA9IHRhcmdldC5jbG9zZXN0KCAibGkiICk7CgoJCS8vIHN3aXRjaCBsb2dpYyBiYXNlZCBvbiB3aGljaCBrZXkgd2FzIHByZXNzZWQKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQkvLyB1cCBvciBsZWZ0IGFycm93IGtleXMKCQljYXNlIDM4OgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAicHJldiIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBkb3duIG9yIHJpZ2h0IGFycm93IGtleXMKCQljYXNlIDQwOgoJCQlnb1RvQWRqYWNlbnRJdGVtKCBsaSwgdGFyZ2V0LCAibmV4dCIgKTsKCQkJcmV0dXJuIGZhbHNlOwoJCQkvLyBJZiBlbnRlciBvciBzcGFjZSBpcyBwcmVzc2VkLCB0cmlnZ2VyIGNsaWNrCgkJY2FzZSAxMzoKCQljYXNlIDMyOgoJCQl0YXJnZXQudHJpZ2dlciggImNsaWNrIiApOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglfaGFuZGxlTWVudVBhZ2VIaWRlOiBmdW5jdGlvbigpIHsKCQkvLyBUT0RPIGNlbnRyYWxpemUgcGFnZSByZW1vdmFsIGJpbmRpbmcgLyBoYW5kbGluZyBpbiB0aGUgcGFnZSBwbHVnaW4uCgkJLy8gU3VnZ2VzdGlvbiBmcm9tIEBqYmxhcyB0byBkbyByZWZjb3VudGluZwoJCS8vCgkJLy8gVE9ETyBleHRyZW1lbHkgY29uZnVzaW5nIGRlcGVuZGVuY3kgb24gdGhlIG9wZW4gbWV0aG9kIHdoZXJlIHRoZSBwYWdlaGlkZS5yZW1vdmUKCQkvLyBiaW5kaW5ncyBhcmUgc3RyaXBwZWQgdG8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBkaXNhcHBlYXJpbmcuIFRoZSB3YXkKCQkvLyB3ZSdyZSBrZWVwaW5nIHBhZ2VzIGluIHRoZSBET00gcmlnaHQgbm93IHN1Y2tzCgkJLy8KCQkvLyByZWJpbmQgdGhlIHBhZ2UgcmVtb3ZlIHRoYXQgd2FzIHVuYm91bmQgaW4gdGhlIG9wZW4gZnVuY3Rpb24KCQkvLyB0byBhbGxvdyBmb3IgdGhlIHBhcmVudCBwYWdlIHJlbW92YWwgZnJvbSBhY3Rpb25zIG90aGVyIHRoYW4gdGhlIHVzZQoJCS8vIG9mIGEgZGlhbG9nIHNpemVkIGN1c3RvbSBzZWxlY3QKCQkvLwoJCS8vIGRvaW5nIHRoaXMgaGVyZSBwcm92aWRlcyBmb3IgdGhlIGJhY2sgYnV0dG9uIG9uIHRoZSBjdXN0b20gc2VsZWN0IGRpYWxvZwoJCXRoaXMudGhpc1BhZ2UucGFnZSggImJpbmRSZW1vdmUiICk7Cgl9LAoKCV9oYW5kbGVIZWFkZXJDbG9zZUNsaWNrOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMubWVudVR5cGUgPT09ICJvdmVybGF5IiApIHsKCQkJdGhpcy5jbG9zZSgpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSwKCglidWlsZDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGVjdElkLCBwb3B1cElkLCBkaWFsb2dJZCwgbGFiZWwsIHRoaXNQYWdlLCBpc011bHRpcGxlLCBtZW51SWQsIHRoZW1lQXR0ciwgb3ZlcmxheVRoZW1lQXR0ciwKCQkJZGl2aWRlclRoZW1lQXR0ciwgbWVudVBhZ2UsIGxpc3Rib3gsIGxpc3QsIGhlYWRlciwgaGVhZGVyVGl0bGUsIG1lbnVQYWdlQ29udGVudCwgbWVudVBhZ2VDbG9zZSwgaGVhZGVyQ2xvc2UsIHNlbGYsCgkJCW8gPSB0aGlzLm9wdGlvbnM7CgoJCWlmICggby5uYXRpdmVNZW51ICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoKTsKCQl9CgoJCXNlbGYgPSB0aGlzOwoJCXNlbGVjdElkID0gdGhpcy5zZWxlY3RJZDsKCQlwb3B1cElkID0gc2VsZWN0SWQgKyAiLWxpc3Rib3giOwoJCWRpYWxvZ0lkID0gc2VsZWN0SWQgKyAiLWRpYWxvZyI7CgkJbGFiZWwgPSB0aGlzLmxhYmVsOwoJCXRoaXNQYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQlpc011bHRpcGxlID0gdGhpcy5lbGVtZW50WyAwIF0ubXVsdGlwbGU7CgkJbWVudUlkID0gc2VsZWN0SWQgKyAiLW1lbnUiOwoJCXRoZW1lQXR0ciA9IG8udGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLnRoZW1lICsgIiciICkgOiAiIjsKCQlvdmVybGF5VGhlbWVBdHRyID0gby5vdmVybGF5VGhlbWUgPyAoICIgZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidGhlbWU9JyIgKyBvLm92ZXJsYXlUaGVtZSArICInIiApIDogIiI7CgkJZGl2aWRlclRoZW1lQXR0ciA9ICggby5kaXZpZGVyVGhlbWUgJiYgaXNNdWx0aXBsZSApID8gKCAiIGRhdGEtIiArICQubW9iaWxlLm5zICsgImRpdmlkZXItdGhlbWU9JyIgKyBvLmRpdmlkZXJUaGVtZSArICInIiApIDogIiI7CgkJbWVudVBhZ2UgPSAkKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdkaWFsb2cnIGNsYXNzPSd1aS1zZWxlY3RtZW51JyBpZD0nIiArIGRpYWxvZ0lkICsgIiciICsgdGhlbWVBdHRyICsgb3ZlcmxheVRoZW1lQXR0ciArICI+IiArCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2hlYWRlcic+IiArCgkJCSI8ZGl2IGNsYXNzPSd1aS10aXRsZSc+IiArIGxhYmVsLmdldEVuY29kZWRUZXh0KCkgKyAiPC9kaXY+IisKCQkJIjwvZGl2PiIrCgkJCSI8ZGl2IGRhdGEtIiArICQubW9iaWxlLm5zICsgInJvbGU9J2NvbnRlbnQnPjwvZGl2PiIrCgkJCSI8L2Rpdj4iICk7CgkJbGlzdGJveCA9ICQoICI8ZGl2IGlkPSciICsgcG9wdXBJZCArICInIGNsYXNzPSd1aS1zZWxlY3RtZW51Jz4iICkuaW5zZXJ0QWZ0ZXIoIHRoaXMuc2VsZWN0ICkucG9wdXAoeyB0aGVtZTogby5vdmVybGF5VGhlbWUgfSk7CgkJbGlzdCA9ICQoICI8dWwgY2xhc3M9J3VpLXNlbGVjdG1lbnUtbGlzdCcgaWQ9JyIgKyBtZW51SWQgKyAiJyByb2xlPSdsaXN0Ym94JyBhcmlhLWxhYmVsbGVkYnk9JyIgKyB0aGlzLmJ1dHRvbklkICsgIiciICsgdGhlbWVBdHRyICsgZGl2aWRlclRoZW1lQXR0ciArICI+IiApLmFwcGVuZFRvKCBsaXN0Ym94ICk7CgkJaGVhZGVyID0gJCggIjxkaXYgY2xhc3M9J3VpLWhlYWRlciB1aS1iYXItIiArICggby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCIgKSArICInPiIgKS5wcmVwZW5kVG8oIGxpc3Rib3ggKTsKCQloZWFkZXJUaXRsZSA9ICQoICI8aDEgY2xhc3M9J3VpLXRpdGxlJz4iICkuYXBwZW5kVG8oIGhlYWRlciApOwoKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJaGVhZGVyQ2xvc2UgPSAkKCAiPGE+IiwgewoJCQkJInJvbGUiOiAiYnV0dG9uIiwKCQkJCSJ0ZXh0Ijogby5jbG9zZVRleHQsCgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJjbGFzcyI6ICJ1aS1idG4gdWktY29ybmVyLWFsbCB1aS1idG4tbGVmdCB1aS1idG4taWNvbi1ub3RleHQgdWktaWNvbi1kZWxldGUiCgkJCX0pLmFwcGVuZFRvKCBoZWFkZXIgKTsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCXNlbGVjdElkOiBzZWxlY3RJZCwKCQkJbWVudUlkOiBtZW51SWQsCgkJCXBvcHVwSWQ6IHBvcHVwSWQsCgkJCWRpYWxvZ0lkOiBkaWFsb2dJZCwKCQkJdGhpc1BhZ2U6IHRoaXNQYWdlLAoJCQltZW51UGFnZTogbWVudVBhZ2UsCgkJCWxhYmVsOiBsYWJlbCwKCQkJaXNNdWx0aXBsZTogaXNNdWx0aXBsZSwKCQkJdGhlbWU6IG8udGhlbWUsCgkJCWxpc3Rib3g6IGxpc3Rib3gsCgkJCWxpc3Q6IGxpc3QsCgkJCWhlYWRlcjogaGVhZGVyLAoJCQloZWFkZXJUaXRsZTogaGVhZGVyVGl0bGUsCgkJCWhlYWRlckNsb3NlOiBoZWFkZXJDbG9zZSwKCQkJbWVudVBhZ2VDb250ZW50OiBtZW51UGFnZUNvbnRlbnQsCgkJCW1lbnVQYWdlQ2xvc2U6IG1lbnVQYWdlQ2xvc2UsCgkJCXBsYWNlaG9sZGVyOiAiIgoJCX0pOwoKCQkvLyBDcmVhdGUgbGlzdCBmcm9tIHNlbGVjdCwgdXBkYXRlIHN0YXRlCgkJdGhpcy5yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQgKSB7CgkJCS8vIE1hcCB1bmRlZmluZWQgdG8gZmFsc2UsIGJlY2F1c2UgdGhpcy5fb3JpZ1RhYkluZGV4ID09PSB1bmRlZmluZWQKCQkJLy8gaW5kaWNhdGVzIHRoYXQgd2UgaGF2ZSBub3QgeWV0IGNoZWNrZWQgd2hldGhlciB0aGUgc2VsZWN0IGhhcwoJCQkvLyBvcmlnaW5hbGx5IGhhZCBhIHRhYmluZGV4IGF0dHJpYnV0ZSwgd2hlcmVhcyBmYWxzZSBpbmRpY2F0ZXMgdGhhdAoJCQkvLyB3ZSBoYXZlIGNoZWNrZWQgdGhlIHNlbGVjdCBmb3Igc3VjaCBhbiBhdHRyaWJ1dGUsIGFuZCBoYXZlIGZvdW5kCgkJCS8vIG5vbmUgcHJlc2VudC4KCQkJdGhpcy5fb3JpZ1RhYkluZGV4ID0gKCB0aGlzLnNlbGVjdFsgMCBdLmdldEF0dHJpYnV0ZSggInRhYmluZGV4IiApID09PSBudWxsICkgPyBmYWxzZSA6IHRoaXMuc2VsZWN0LmF0dHIoICJ0YWJpbmRleCIgKTsKCQl9CgkJdGhpcy5zZWxlY3QuYXR0ciggInRhYmluZGV4IiwgIi0xIiApOwoJCXRoaXMuX29uKCB0aGlzLnNlbGVjdCwgeyBmb2N1cyA6ICJfaGFuZGxlU2VsZWN0Rm9jdXMiIH0gKTsKCgkJLy8gQnV0dG9uIGV2ZW50cwoJCXRoaXMuX29uKCB0aGlzLmJ1dHRvbiwgewoJCQl2Y2xpY2s6ICJfaGFuZGxlQnV0dG9uVmNsaWNrS2V5ZG93biIKCQl9KTsKCgkJLy8gRXZlbnRzIGZvciBsaXN0IGl0ZW1zCgkJdGhpcy5saXN0LmF0dHIoICJyb2xlIiwgImxpc3Rib3giICk7CgkJdGhpcy5fb24oIHRoaXMubGlzdCwgewoJCQlmb2N1c2luIDogIl9oYW5kbGVMaXN0Rm9jdXMiLAoJCQlmb2N1c291dCA6ICJfaGFuZGxlTGlzdEZvY3VzIiwKCQkJa2V5ZG93bjogIl9oYW5kbGVMaXN0S2V5ZG93biIKCQl9KTsKCQl0aGlzLmxpc3QKCQkJLmRlbGVnYXRlKCAibGk6bm90KC51aS1kaXNhYmxlZCwudWktc3RhdGUtZGlzYWJsZWQsLnVpLWxpLWRpdmlkZXIpIiwgImNsaWNrIiwgZnVuY3Rpb24oIGV2ZW50ICkgewoKCQkJCS8vIGluZGV4IG9mIG9wdGlvbiB0YWcgdG8gYmUgc2VsZWN0ZWQKCQkJCXZhciBvbGRJbmRleCA9IHNlbGYuc2VsZWN0WyAwIF0uc2VsZWN0ZWRJbmRleCwKCQkJCQluZXdJbmRleCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZSggdGhpcywgIm9wdGlvbi1pbmRleCIgKSwKCQkJCQlvcHRpb24gPSBzZWxmLl9zZWxlY3RPcHRpb25zKCkuZXEoIG5ld0luZGV4IClbIDAgXTsKCgkJCQkvLyB0b2dnbGUgc2VsZWN0ZWQgc3RhdHVzIG9uIHRoZSB0YWcgZm9yIG11bHRpIHNlbGVjdHMKCQkJCW9wdGlvbi5zZWxlY3RlZCA9IHNlbGYuaXNNdWx0aXBsZSA/ICFvcHRpb24uc2VsZWN0ZWQgOiB0cnVlOwoKCQkJCS8vIHRvZ2dsZSBjaGVja2JveCBjbGFzcyBmb3IgbXVsdGlwbGUgc2VsZWN0cwoJCQkJaWYgKCBzZWxmLmlzTXVsdGlwbGUgKSB7CgkJCQkJJCggdGhpcyApLmZpbmQoICJhIiApCgkJCQkJCS50b2dnbGVDbGFzcyggInVpLWNoZWNrYm94LW9uIiwgb3B0aW9uLnNlbGVjdGVkICkKCQkJCQkJLnRvZ2dsZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiwgIW9wdGlvbi5zZWxlY3RlZCApOwoJCQkJfQoKCQkJCS8vIHRyaWdnZXIgY2hhbmdlIGlmIHZhbHVlIGNoYW5nZWQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlIHx8IG9sZEluZGV4ICE9PSBuZXdJbmRleCApIHsKCQkJCQlzZWxmLnNlbGVjdC50cmlnZ2VyKCAiY2hhbmdlIiApOwoJCQkJfQoKCQkJCS8vIGhpZGUgY3VzdG9tIHNlbGVjdCBmb3Igc2luZ2xlIHNlbGVjdHMgb25seSAtIG90aGVyd2lzZSBmb2N1cyBjbGlja2VkIGl0ZW0KCQkJCS8vIFdlIG5lZWQgdG8gZ3JhYiB0aGUgY2xpY2tlZCBpdGVtIHRoZSBoYXJkIHdheSwgYmVjYXVzZSB0aGUgbGlzdCBtYXkgaGF2ZSBiZWVuIHJlYnVpbHQKCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKS5lcSggbmV3SW5kZXggKQoJCQkJCQkuZmluZCggImEiICkuZmlyc3QoKS5mb2N1cygpOwoJCQkJfQoJCQkJZWxzZSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoKCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCX0pOwoKCQkvLyBidXR0b24gcmVmb2N1cyBlbnN1cmVzIHByb3BlciBoZWlnaHQgY2FsY3VsYXRpb24KCQkvLyBieSByZW1vdmluZyB0aGUgaW5saW5lIHN0eWxlIGFuZCBlbnN1cmluZyBwYWdlIGluY2x1c2lvbgoJCXRoaXMuX29uKCB0aGlzLm1lbnVQYWdlLCB7IHBhZ2VoaWRlOiAiX2hhbmRsZU1lbnVQYWdlSGlkZSIgfSApOwoKCQkvLyBFdmVudHMgb24gdGhlIHBvcHVwCgkJdGhpcy5fb24oIHRoaXMubGlzdGJveCwgeyBwb3B1cGFmdGVyY2xvc2U6ICJjbG9zZSIgfSApOwoKCQkvLyBDbG9zZSBidXR0b24gb24gc21hbGwgb3ZlcmxheXMKCQlpZiAoIHRoaXMuaXNNdWx0aXBsZSApIHsKCQkJdGhpcy5fb24oIHRoaXMuaGVhZGVyQ2xvc2UsIHsgY2xpY2s6ICJfaGFuZGxlSGVhZGVyQ2xvc2VDbGljayIgfSApOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9LAoKCV9pc1JlYnVpbGRSZXF1aXJlZDogZnVuY3Rpb24oKSB7CgkJdmFyIGxpc3QgPSB0aGlzLmxpc3QuZmluZCggImxpIiApLAoJCQlvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpLm5vdCggIi51aS1zY3JlZW4taGlkZGVuIiApOwoKCQkvLyBUT0RPIGV4Y2VlZGluZ2x5IG5haXZlIG1ldGhvZCB0byBkZXRlcm1pbmUgZGlmZmVyZW5jZQoJCS8vIGlnbm9yZXMgdmFsdWUgY2hhbmdlcyBldGMgaW4gZmF2b3Igb2YgYSBmb3JjZWRSZWJ1aWxkCgkJLy8gZnJvbSB0aGUgdXNlciBpbiB0aGUgcmVmcmVzaCBtZXRob2QKCQlyZXR1cm4gb3B0aW9ucy50ZXh0KCkgIT09IGxpc3QudGV4dCgpOwoJfSwKCglzZWxlY3RlZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMuX3NlbGVjdE9wdGlvbnMoKS5maWx0ZXIoICI6c2VsZWN0ZWQ6bm90KCA6anFtRGF0YShwbGFjZWhvbGRlcj0ndHJ1ZScpICkiICk7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCBmb3JjZSApIHsKCQl2YXIgc2VsZiwgaW5kaWNlczsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubmF0aXZlTWVudSApIHsKCQkJcmV0dXJuIHRoaXMuX3N1cGVyKCBmb3JjZSApOwoJCX0KCgkJc2VsZiA9IHRoaXM7CgkJaWYgKCBmb3JjZSB8fCB0aGlzLl9pc1JlYnVpbGRSZXF1aXJlZCgpICkgewoJCQlzZWxmLl9idWlsZExpc3QoKTsKCQl9CgoJCWluZGljZXMgPSB0aGlzLnNlbGVjdGVkSW5kaWNlcygpOwoKCQlzZWxmLnNldEJ1dHRvblRleHQoKTsKCQlzZWxmLnNldEJ1dHRvbkNvdW50KCk7CgoJCXNlbGYubGlzdC5maW5kKCAibGk6bm90KC51aS1saS1kaXZpZGVyKSIgKQoJCQkuZmluZCggImEiICkucmVtb3ZlQ2xhc3MoICQubW9iaWxlLmFjdGl2ZUJ0bkNsYXNzICkuZW5kKCkKCQkJLmF0dHIoICJhcmlhLXNlbGVjdGVkIiwgZmFsc2UgKQoJCQkuZWFjaChmdW5jdGlvbiggaSApIHsKCgkJCQlpZiAoICQuaW5BcnJheSggaSwgaW5kaWNlcyApID4gLTEgKSB7CgkJCQkJdmFyIGl0ZW0gPSAkKCB0aGlzICk7CgoJCQkJCS8vIEFyaWEgc2VsZWN0ZWQgYXR0cgoJCQkJCWl0ZW0uYXR0ciggImFyaWEtc2VsZWN0ZWQiLCB0cnVlICk7CgoJCQkJCS8vIE11bHRpcGxlIHNlbGVjdHM6IGFkZCB0aGUgIm9uIiBjaGVja2JveCBzdGF0ZSB0byB0aGUgaWNvbgoJCQkJCWlmICggc2VsZi5pc011bHRpcGxlICkgewoJCQkJCQlpdGVtLmZpbmQoICJhIiApLnJlbW92ZUNsYXNzKCAidWktY2hlY2tib3gtb2ZmIiApLmFkZENsYXNzKCAidWktY2hlY2tib3gtb24iICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKCBpdGVtLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCQkJCWl0ZW0ubmV4dCgpLmZpbmQoICJhIiApLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJaXRlbS5maW5kKCAiYSIgKS5hZGRDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSk7Cgl9LAoKCWNsb3NlOiBmdW5jdGlvbigpIHsKCQlpZiAoIHRoaXMub3B0aW9ucy5kaXNhYmxlZCB8fCAhdGhpcy5pc09wZW4gKSB7CgkJCXJldHVybjsKCQl9CgoJCXZhciBzZWxmID0gdGhpczsKCgkJaWYgKCBzZWxmLm1lbnVUeXBlID09PSAicGFnZSIgKSB7CgkJCXNlbGYubWVudVBhZ2UuZGlhbG9nKCAiY2xvc2UiICk7CgkJCXNlbGYubGlzdC5hcHBlbmRUbyggc2VsZi5saXN0Ym94ICk7CgkJfSBlbHNlIHsKCQkJc2VsZi5saXN0Ym94LnBvcHVwKCAiY2xvc2UiICk7CgkJfQoKCQlzZWxmLl9mb2N1c0J1dHRvbigpOwoJCS8vIGFsbG93IHRoZSBkaWFsb2cgdG8gYmUgY2xvc2VkIGFnYWluCgkJc2VsZi5pc09wZW4gPSBmYWxzZTsKCX0sCgoJb3BlbjogZnVuY3Rpb24oKSB7CgkJdGhpcy5idXR0b24uY2xpY2soKTsKCX0sCgoJX2ZvY3VzTWVudUl0ZW06IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxlY3RvciA9IHRoaXMubGlzdC5maW5kKCAiYS4iICsgJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQlpZiAoIHNlbGVjdG9yLmxlbmd0aCA9PT0gMCApIHsKCQkJc2VsZWN0b3IgPSB0aGlzLmxpc3QuZmluZCggImxpOm5vdCgiICsgdW5mb2N1c2FibGVJdGVtU2VsZWN0b3IgKyAiKSBhLnVpLWJ0biIgKTsKCQl9CgkJc2VsZWN0b3IuZmlyc3QoKS5mb2N1cygpOwoJfSwKCglfZGVjaWRlRm9ybWF0OiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXMsCgkJCSR3aW5kb3cgPSB0aGlzLndpbmRvdywKCQkJc2VsZkxpc3RQYXJlbnQgPSBzZWxmLmxpc3QucGFyZW50KCksCgkJCW1lbnVIZWlnaHQgPSBzZWxmTGlzdFBhcmVudC5vdXRlckhlaWdodCgpLAoJCQlzY3JvbGxUb3AgPSAkd2luZG93LnNjcm9sbFRvcCgpLAoJCQlidG5PZmZzZXQgPSBzZWxmLmJ1dHRvbi5vZmZzZXQoKS50b3AsCgkJCXNjcmVlbkhlaWdodCA9ICR3aW5kb3cuaGVpZ2h0KCk7CgoJCWlmICggbWVudUhlaWdodCA+IHNjcmVlbkhlaWdodCAtIDgwIHx8ICEkLnN1cHBvcnQuc2Nyb2xsVG9wICkgewoKCQkJc2VsZi5tZW51UGFnZS5hcHBlbmRUbyggJC5tb2JpbGUucGFnZUNvbnRhaW5lciApLnBhZ2UoKTsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQgPSBzZWxmLm1lbnVQYWdlLmZpbmQoICIudWktY29udGVudCIgKTsKCQkJc2VsZi5tZW51UGFnZUNsb3NlID0gc2VsZi5tZW51UGFnZS5maW5kKCAiLnVpLWhlYWRlciBhIiApOwoKCQkJLy8gcHJldmVudCB0aGUgcGFyZW50IHBhZ2UgZnJvbSBiZWluZyByZW1vdmVkIGZyb20gdGhlIERPTSwKCQkJLy8gb3RoZXJ3aXNlIHRoZSByZXN1bHRzIG9mIHNlbGVjdGluZyBhIGxpc3QgaXRlbSBpbiB0aGUgZGlhbG9nCgkJCS8vIGZhbGwgaW50byBhIGJsYWNrIGhvbGUKCQkJc2VsZi50aGlzUGFnZS51bmJpbmQoICJwYWdlaGlkZS5yZW1vdmUiICk7CgoJCQkvL2ZvciBXZWJPUy9PcGVyYSBNaW5pIChzZXQgbGFzdHNjcm9sbCB1c2luZyBidXR0b24gb2Zmc2V0KQoJCQlpZiAoIHNjcm9sbFRvcCA9PT0gMCAmJiBidG5PZmZzZXQgPiBzY3JlZW5IZWlnaHQgKSB7CgkJCQlzZWxmLnRoaXNQYWdlLm9uZSggInBhZ2VoaWRlIiwgZnVuY3Rpb24oKSB7CgkJCQkJJCggdGhpcyApLmpxbURhdGEoICJsYXN0U2Nyb2xsIiwgYnRuT2Zmc2V0ICk7CgkJCQl9KTsKCQkJfQoKCQkJc2VsZi5tZW51UGFnZS5vbmUoIHsKCQkJCXBhZ2VzaG93OiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICksCgkJCQlwYWdlaGlkZTogJC5wcm94eSggdGhpcywgImNsb3NlIiApCgkJCX0pOwoKCQkJc2VsZi5tZW51VHlwZSA9ICJwYWdlIjsKCQkJc2VsZi5tZW51UGFnZUNvbnRlbnQuYXBwZW5kKCBzZWxmLmxpc3QgKTsKCQkJc2VsZi5tZW51UGFnZS5maW5kKCAiZGl2IC51aS10aXRsZSIgKS50ZXh0KCBzZWxmLmxhYmVsLnRleHQoKSApOwoJCX0gZWxzZSB7CgkJCXNlbGYubWVudVR5cGUgPSAib3ZlcmxheSI7CgoJCQlzZWxmLmxpc3Rib3gub25lKCB7IHBvcHVwYWZ0ZXJvcGVuOiAkLnByb3h5KCB0aGlzLCAiX2ZvY3VzTWVudUl0ZW0iICkgfSApOwoJCX0KCX0sCgoJX2J1aWxkTGlzdDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQlvID0gdGhpcy5vcHRpb25zLAoJCQlwbGFjZWhvbGRlciA9IHRoaXMucGxhY2Vob2xkZXIsCgkJCW5lZWRQbGFjZWhvbGRlciA9IHRydWUsCgkJCWRhdGFJY29uID0gImZhbHNlIiwKCQkJJG9wdGlvbnMsIG51bU9wdGlvbnMsIHNlbGVjdCwKCQkJZGF0YVByZWZpeCA9ICJkYXRhLSIgKyAkLm1vYmlsZS5ucywKCQkJZGF0YUluZGV4QXR0ciA9IGRhdGFQcmVmaXggKyAib3B0aW9uLWluZGV4IiwKCQkJZGF0YUljb25BdHRyID0gZGF0YVByZWZpeCArICJpY29uIiwKCQkJZGF0YVJvbGVBdHRyID0gZGF0YVByZWZpeCArICJyb2xlIiwKCQkJZGF0YVBsYWNlaG9sZGVyQXR0ciA9IGRhdGFQcmVmaXggKyAicGxhY2Vob2xkZXIiLAoJCQlmcmFnbWVudCA9IGRvY3VtZW50LmNyZWF0ZURvY3VtZW50RnJhZ21lbnQoKSwKCQkJaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSwKCQkJb3B0R3JvdXAsCgkJCWksCgkJCW9wdGlvbiwgJG9wdGlvbiwgcGFyZW50LCB0ZXh0LCBhbmNob3IsIGNsYXNzZXMsCgkJCW9wdExhYmVsLCBkaXZpZGVyLCBpdGVtOwoKCQlzZWxmLmxpc3QuZW1wdHkoKS5maWx0ZXIoICIudWktbGlzdHZpZXciICkubGlzdHZpZXcoICJkZXN0cm95IiApOwoJCSRvcHRpb25zID0gdGhpcy5fc2VsZWN0T3B0aW9ucygpOwoJCW51bU9wdGlvbnMgPSAkb3B0aW9ucy5sZW5ndGg7CgkJc2VsZWN0ID0gdGhpcy5zZWxlY3RbIDAgXTsKCgkJZm9yICggaSA9IDA7IGkgPCBudW1PcHRpb25zO2krKywgaXNQbGFjZWhvbGRlckl0ZW0gPSBmYWxzZSkgewoJCQlvcHRpb24gPSAkb3B0aW9uc1tpXTsKCQkJJG9wdGlvbiA9ICQoIG9wdGlvbiApOwoKCQkJLy8gRG8gbm90IGNyZWF0ZSBvcHRpb25zIGJhc2VkIG9uIHVpLXNjcmVlbi1oaWRkZW4gc2VsZWN0IG9wdGlvbnMKCQkJaWYgKCAkb3B0aW9uLmhhc0NsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKSApIHsKCQkJCWNvbnRpbnVlOwoJCQl9CgoJCQlwYXJlbnQgPSBvcHRpb24ucGFyZW50Tm9kZTsKCQkJdGV4dCA9ICRvcHRpb24udGV4dCgpOwoJCQlhbmNob3IgID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCggImEiICk7CgkJCWNsYXNzZXMgPSBbXTsKCgkJCWFuY2hvci5zZXRBdHRyaWJ1dGUoICJocmVmIiwgIiMiICk7CgkJCWFuY2hvci5hcHBlbmRDaGlsZCggZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoIHRleHQgKSApOwoKCQkJLy8gQXJlIHdlIGluc2lkZSBhbiBvcHRncm91cD8KCQkJaWYgKCBwYXJlbnQgIT09IHNlbGVjdCAmJiBwYXJlbnQubm9kZU5hbWUudG9Mb3dlckNhc2UoKSA9PT0gIm9wdGdyb3VwIiApIHsKCQkJCW9wdExhYmVsID0gcGFyZW50LmdldEF0dHJpYnV0ZSggImxhYmVsIiApOwoJCQkJaWYgKCBvcHRMYWJlbCAhPT0gb3B0R3JvdXAgKSB7CgkJCQkJZGl2aWRlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoICJsaSIgKTsKCQkJCQlkaXZpZGVyLnNldEF0dHJpYnV0ZSggZGF0YVJvbGVBdHRyLCAibGlzdC1kaXZpZGVyIiApOwoJCQkJCWRpdmlkZXIuc2V0QXR0cmlidXRlKCAicm9sZSIsICJvcHRpb24iICk7CgkJCQkJZGl2aWRlci5zZXRBdHRyaWJ1dGUoICJ0YWJpbmRleCIsICItMSIgKTsKCQkJCQlkaXZpZGVyLmFwcGVuZENoaWxkKCBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSggb3B0TGFiZWwgKSApOwoJCQkJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBkaXZpZGVyICk7CgkJCQkJb3B0R3JvdXAgPSBvcHRMYWJlbDsKCQkJCX0KCQkJfQoKCQkJaWYgKCBuZWVkUGxhY2Vob2xkZXIgJiYgKCAhb3B0aW9uLmdldEF0dHJpYnV0ZSggInZhbHVlIiApIHx8IHRleHQubGVuZ3RoID09PSAwIHx8ICRvcHRpb24uanFtRGF0YSggInBsYWNlaG9sZGVyIiApICkgKSB7CgkJCQluZWVkUGxhY2Vob2xkZXIgPSBmYWxzZTsKCQkJCWlzUGxhY2Vob2xkZXJJdGVtID0gdHJ1ZTsKCgkJCQkvLyBJZiB3ZSBoYXZlIGlkZW50aWZpZWQgYSBwbGFjZWhvbGRlciwgcmVjb3JkIHRoZSBmYWN0IHRoYXQgaXQgd2FzCgkJCQkvLyB1cyB3aG8gaGF2ZSBhZGRlZCB0aGUgcGxhY2Vob2xkZXIgdG8gdGhlIG9wdGlvbiBhbmQgbWFyayBpdAoJCQkJLy8gcmV0cm9hY3RpdmVseSBpbiB0aGUgc2VsZWN0IGFzIHdlbGwKCQkJCWlmICggbnVsbCA9PT0gb3B0aW9uLmdldEF0dHJpYnV0ZSggZGF0YVBsYWNlaG9sZGVyQXR0ciApICkgewoJCQkJCXRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciA9IHRydWU7CgkJCQl9CgkJCQlvcHRpb24uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCQlpZiAoIG8uaGlkZVBsYWNlaG9sZGVyTWVudUl0ZW1zICkgewoJCQkJCWNsYXNzZXMucHVzaCggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJCQl9CgkJCQlpZiAoIHBsYWNlaG9sZGVyICE9PSB0ZXh0ICkgewoJCQkJCXBsYWNlaG9sZGVyID0gc2VsZi5wbGFjZWhvbGRlciA9IHRleHQ7CgkJCQl9CgkJCX0KCgkJCWl0ZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCAibGkiICk7CgkJCWlmICggb3B0aW9uLmRpc2FibGVkICkgewoJCQkJY2xhc3Nlcy5wdXNoKCAidWktc3RhdGUtZGlzYWJsZWQiICk7CgkJCQlpdGVtLnNldEF0dHJpYnV0ZSggImFyaWEtZGlzYWJsZWQiLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJbmRleEF0dHIsIGkgKTsKCQkJaXRlbS5zZXRBdHRyaWJ1dGUoIGRhdGFJY29uQXR0ciwgZGF0YUljb24gKTsKCQkJaWYgKCBpc1BsYWNlaG9sZGVySXRlbSApIHsKCQkJCWl0ZW0uc2V0QXR0cmlidXRlKCBkYXRhUGxhY2Vob2xkZXJBdHRyLCB0cnVlICk7CgkJCX0KCQkJaXRlbS5jbGFzc05hbWUgPSBjbGFzc2VzLmpvaW4oICIgIiApOwoJCQlpdGVtLnNldEF0dHJpYnV0ZSggInJvbGUiLCAib3B0aW9uIiApOwoJCQlhbmNob3Iuc2V0QXR0cmlidXRlKCAidGFiaW5kZXgiLCAiLTEiICk7CgkJCWlmICggdGhpcy5pc011bHRpcGxlICkgewoJCQkJJCggYW5jaG9yICkuYWRkQ2xhc3MoICJ1aS1idG4gdWktY2hlY2tib3gtb2ZmIHVpLWJ0bi1pY29uLXJpZ2h0IiApOwoJCQl9CgoJCQlpdGVtLmFwcGVuZENoaWxkKCBhbmNob3IgKTsKCQkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIGl0ZW0gKTsKCQl9CgoJCXNlbGYubGlzdFswXS5hcHBlbmRDaGlsZCggZnJhZ21lbnQgKTsKCgkJLy8gSGlkZSBoZWFkZXIgaWYgaXQncyBub3QgYSBtdWx0aXNlbGVjdCBhbmQgdGhlcmUncyBubyBwbGFjZWhvbGRlcgoJCWlmICggIXRoaXMuaXNNdWx0aXBsZSAmJiAhcGxhY2Vob2xkZXIubGVuZ3RoICkgewoJCQl0aGlzLmhlYWRlci5hZGRDbGFzcyggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5oZWFkZXJUaXRsZS50ZXh0KCB0aGlzLnBsYWNlaG9sZGVyICk7CgkJfQoKCQkvLyBOb3cgcG9wdWxhdGVkLCBjcmVhdGUgbGlzdHZpZXcKCQlzZWxmLmxpc3QubGlzdHZpZXcoKTsKCX0sCgoJX2J1dHRvbjogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHRoaXMub3B0aW9ucy5uYXRpdmVNZW51ID8KCQkJdGhpcy5fc3VwZXIoKSA6CgkJCSQoICI8YT4iLCB7CgkJCQkiaHJlZiI6ICIjIiwKCQkJCSJyb2xlIjogImJ1dHRvbiIsCgkJCQkvLyBUT0RPIHZhbHVlIGlzIHVuZGVmaW5lZCBhdCBjcmVhdGlvbgoJCQkJImlkIjogdGhpcy5idXR0b25JZCwKCQkJCSJhcmlhLWhhc3BvcHVwIjogInRydWUiLAoKCQkJCS8vIFRPRE8gdmFsdWUgaXMgdW5kZWZpbmVkIGF0IGNyZWF0aW9uCgkJCQkiYXJpYS1vd25zIjogdGhpcy5tZW51SWQKCQkJfSk7Cgl9LAoKCV9kZXN0cm95OiBmdW5jdGlvbigpIHsKCgkJaWYgKCAhdGhpcy5vcHRpb25zLm5hdGl2ZU1lbnUgKSB7CgkJCXRoaXMuY2xvc2UoKTsKCgkJCS8vIFJlc3RvcmUgdGhlIHRhYmluZGV4IGF0dHJpYnV0ZSB0byBpdHMgb3JpZ2luYWwgdmFsdWUKCQkJaWYgKCB0aGlzLl9vcmlnVGFiSW5kZXggIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5fb3JpZ1RhYkluZGV4ICE9PSBmYWxzZSApIHsKCQkJCQl0aGlzLnNlbGVjdC5hdHRyKCAidGFiaW5kZXgiLCB0aGlzLl9vcmlnVGFiSW5kZXggKTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zZWxlY3QucmVtb3ZlQXR0ciggInRhYmluZGV4IiApOwoJCQkJfQoJCQl9CgoJCQkvLyBSZW1vdmUgdGhlIHBsYWNlaG9sZGVyIGF0dHJpYnV0ZSBpZiB3ZSB3ZXJlIHRoZSBvbmVzIHRvIGFkZCBpdAoJCQlpZiAoIHRoaXMuX3JlbW92ZVBsYWNlaG9sZGVyQXR0ciApIHsKCQkJCXRoaXMuX3NlbGVjdE9wdGlvbnMoKS5yZW1vdmVBdHRyKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAicGxhY2Vob2xkZXIiICk7CgkJCX0KCgkJCS8vIFJlbW92ZSB0aGUgcG9wdXAKCQkJdGhpcy5saXN0Ym94LnJlbW92ZSgpOwoKCQkJLy8gUmVtb3ZlIHRoZSBkaWFsb2cKCQkJdGhpcy5tZW51UGFnZS5yZW1vdmUoKTsKCQl9CgoJCS8vIENoYWluIHVwCgkJdGhpcy5fc3VwZXIoKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgoKLy8gYnV0dG9uTWFya3VwIGlzIGRlcHJlY2F0ZWQgYXMgb2YgMS40LjAgYW5kIHdpbGwgYmUgcmVtb3ZlZCBpbiAxLjUuMC4KCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCi8vIEdlbmVyYWwgcG9saWN5OiBEbyBub3QgYWNjZXNzIGRhdGEtKiBhdHRyaWJ1dGVzIGV4Y2VwdCBkdXJpbmcgZW5oYW5jZW1lbnQuCi8vIEluIGFsbCBvdGhlciBjYXNlcyB3ZSBkZXRlcm1pbmUgdGhlIHN0YXRlIG9mIHRoZSBidXR0b24gZXhjbHVzaXZlbHkgZnJvbSBpdHMKLy8gY2xhc3NOYW1lLiBUaGF0J3Mgd2h5IG9wdGlvbnNUb0NsYXNzZXMgZXhwZWN0cyBhIGZ1bGwgY29tcGxlbWVudCBvZiBvcHRpb25zLAovLyBhbmQgdGhlIGpRdWVyeSBwbHVnaW4gY29tcGxldGVzIHRoZSBzZXQgb2Ygb3B0aW9ucyBmcm9tIHRoZSBkZWZhdWx0IHZhbHVlcy4KCi8vIE1hcCBjbGFzc2VzIHRvIGJ1dHRvbk1hcmt1cCBib29sZWFuIG9wdGlvbnMgLSB1c2VkIGluIGNsYXNzTmFtZVRvT3B0aW9ucygpCnZhciByZXZlcnNlQm9vbE9wdGlvbk1hcCA9IHsKCQkidWktc2hhZG93IiA6ICJzaGFkb3ciLAoJCSJ1aS1jb3JuZXItYWxsIiA6ICJjb3JuZXJzIiwKCQkidWktYnRuLWlubGluZSIgOiAiaW5saW5lIiwKCQkidWktc2hhZG93LWljb24iIDogImljb25zaGFkb3ciLCAvKiBUT0RPOiBSZW1vdmUgaW4gMS41ICovCgkJInVpLW1pbmkiIDogIm1pbmkiCgl9LAoJZ2V0QXR0ckZpeGVkID0gZnVuY3Rpb24oKSB7CgkJdmFyIHJldCA9ICQubW9iaWxlLmdldEF0dHJpYnV0ZS5hcHBseSggdGhpcywgYXJndW1lbnRzICk7CgoJCXJldHVybiAoIHJldCA9PSBudWxsID8gdW5kZWZpbmVkIDogcmV0ICk7Cgl9LAoJY2FwaXRhbExldHRlcnNSRSA9IC9bQS1aXS9nOwoKLy8gb3B0aW9uc1RvQ2xhc3NlczoKLy8gQG9wdGlvbnM6IEEgY29tcGxldGUgc2V0IG9mIG9wdGlvbnMgdG8gY29udmVydCB0byBjbGFzcyBuYW1lcy4KLy8gQGV4aXN0aW5nQ2xhc3NlczogZXh0cmEgY2xhc3NlcyB0byBhZGQgdG8gdGhlIHJlc3VsdAovLwovLyBDb252ZXJ0cyBAb3B0aW9ucyB0byBidXR0b25NYXJrdXAgY2xhc3NlcyBhbmQgcmV0dXJucyB0aGUgcmVzdWx0IGFzIGFuIGFycmF5Ci8vIHRoYXQgY2FuIGJlIGNvbnZlcnRlZCB0byBhbiBlbGVtZW50J3MgY2xhc3NOYW1lIHdpdGggLmpvaW4oICIgIiApLiBBbGwKLy8gcG9zc2libGUgb3B0aW9ucyBtdXN0IGJlIHNldCBpbnNpZGUgQG9wdGlvbnMuIFVzZSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0cwovLyB0byBnZXQgYSBjb21wbGV0ZSBzZXQgYW5kIHVzZSAkLmV4dGVuZCB0byBvdmVycmlkZSB5b3VyIGNob2ljZSBvZiBvcHRpb25zCi8vIGZyb20gdGhhdCBzZXQuCmZ1bmN0aW9uIG9wdGlvbnNUb0NsYXNzZXMoIG9wdGlvbnMsIGV4aXN0aW5nQ2xhc3NlcyApIHsKCXZhciBjbGFzc2VzID0gZXhpc3RpbmdDbGFzc2VzID8gZXhpc3RpbmdDbGFzc2VzIDogW107CgoJLy8gQWRkIGNsYXNzZXMgdG8gdGhlIGFycmF5IC0gZmlyc3QgdWktYnRuCgljbGFzc2VzLnB1c2goICJ1aS1idG4iICk7CgoJLy8gSWYgdGhlcmUgaXMgYSB0aGVtZQoJaWYgKCBvcHRpb25zLnRoZW1lICkgewoJCWNsYXNzZXMucHVzaCggInVpLWJ0bi0iICsgb3B0aW9ucy50aGVtZSApOwoJfQoKCS8vIElmIHRoZXJlJ3MgYW4gaWNvbiwgYWRkIHRoZSBpY29uLXJlbGF0ZWQgY2xhc3NlcwoJaWYgKCBvcHRpb25zLmljb24gKSB7CgkJY2xhc3NlcyA9IGNsYXNzZXMuY29uY2F0KFsKCQkJInVpLWljb24tIiArIG9wdGlvbnMuaWNvbiwKCQkJInVpLWJ0bi1pY29uLSIgKyBvcHRpb25zLmljb25wb3MKCQldKTsKCQlpZiAoIG9wdGlvbnMuaWNvbnNoYWRvdyApIHsKCQkJY2xhc3Nlcy5wdXNoKCAidWktc2hhZG93LWljb24iICk7IC8qIFRPRE86IFJlbW92ZSBpbiAxLjUgKi8KCQl9Cgl9CgoJLy8gQWRkIHRoZSBhcHByb3ByaWF0ZSBjbGFzcyBmb3IgZWFjaCBib29sZWFuIG9wdGlvbgoJaWYgKCBvcHRpb25zLmlubGluZSApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1idG4taW5saW5lIiApOwoJfQoJaWYgKCBvcHRpb25zLnNoYWRvdyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1zaGFkb3ciICk7Cgl9CglpZiAoIG9wdGlvbnMuY29ybmVycyApIHsKCQljbGFzc2VzLnB1c2goICJ1aS1jb3JuZXItYWxsIiApOwoJfQoJaWYgKCBvcHRpb25zLm1pbmkgKSB7CgkJY2xhc3Nlcy5wdXNoKCAidWktbWluaSIgKTsKCX0KCgkvLyBDcmVhdGUgYSBzdHJpbmcgZnJvbSB0aGUgYXJyYXkgYW5kIHJldHVybiBpdAoJcmV0dXJuIGNsYXNzZXM7Cn0KCi8vIGNsYXNzTmFtZVRvT3B0aW9uczoKLy8gQGNsYXNzZXM6IEEgc3RyaW5nIGNvbnRhaW5pbmcgYSAuY2xhc3NOYW1lLXN0eWxlIHNwYWNlLXNlcGFyYXRlZCBjbGFzcyBsaXN0Ci8vCi8vIExvb3BzIG92ZXIgQGNsYXNzZXMgYW5kIGNhbGN1bGF0ZXMgYW4gb3B0aW9ucyBvYmplY3QgYmFzZWQgb24gdGhlCi8vIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgaXQgZmluZHMuIEl0IHJlY29yZHMgdW5yZWNvZ25pemVkIGNsYXNzZXMgaW4gYW4KLy8gYXJyYXkuCi8vCi8vIFJldHVybnM6IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBmb2xsb3dpbmcgaXRlbXM6Ci8vCi8vICJvcHRpb25zIjogYnV0dG9uTWFya3VwIG9wdGlvbnMgZm91bmQgdG8gYmUgcHJlc2VudCBiZWNhdXNlIG9mIHRoZQovLyBwcmVzZW5jZS9hYnNlbmNlIG9mIGNvcnJlc3BvbmRpbmcgY2xhc3NlcwovLwovLyAidW5rbm93bkNsYXNzZXMiOiBhIHN0cmluZyBjb250YWluaW5nIGFsbCB0aGUgbm9uLWJ1dHRvbk1hcmt1cC1yZWxhdGVkCi8vIGNsYXNzZXMgZm91bmQgaW4gQGNsYXNzZXMKLy8KLy8gImFscmVhZHlFbmhhbmNlZCI6IEEgYm9vbGVhbiBpbmRpY2F0aW5nIHdoZXRoZXIgdGhlIHVpLWJ0biBjbGFzcyB3YXMgYW1vbmcKLy8gdGhvc2UgZm91bmQgdG8gYmUgcHJlc2VudApmdW5jdGlvbiBjbGFzc05hbWVUb09wdGlvbnMoIGNsYXNzZXMgKSB7Cgl2YXIgaWR4LCBtYXAsIHVua25vd25DbGFzcywKCQlhbHJlYWR5RW5oYW5jZWQgPSBmYWxzZSwKCQlub0ljb24gPSB0cnVlLAoJCW8gPSB7CgkJCWljb246ICIiLAoJCQlpbmxpbmU6IGZhbHNlLAoJCQlzaGFkb3c6IGZhbHNlLAoJCQljb3JuZXJzOiBmYWxzZSwKCQkJaWNvbnNoYWRvdzogZmFsc2UsCgkJCW1pbmk6IGZhbHNlCgkJfSwKCQl1bmtub3duQ2xhc3NlcyA9IFtdOwoKCWNsYXNzZXMgPSBjbGFzc2VzLnNwbGl0KCAiICIgKTsKCgkvLyBMb29wIG92ZXIgdGhlIGNsYXNzZXMKCWZvciAoIGlkeCA9IDAgOyBpZHggPCBjbGFzc2VzLmxlbmd0aCA7IGlkeCsrICkgewoKCQkvLyBBc3N1bWUgaXQncyBhbiB1bnJlY29nbml6ZWQgY2xhc3MKCQl1bmtub3duQ2xhc3MgPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgYm9vbGVhbiBvcHRpb25zIGZyb20gdGhlIHByZXNlbmNlIG9mIGNsYXNzZXMKCQltYXAgPSByZXZlcnNlQm9vbE9wdGlvbk1hcFsgY2xhc3Nlc1sgaWR4IF0gXTsKCQlpZiAoIG1hcCAhPT0gdW5kZWZpbmVkICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJb1sgbWFwIF0gPSB0cnVlOwoKCQkvLyBSZWNvZ25pemUgdGhlIHByZXNlbmNlIG9mIGFuIGljb24gYW5kIGVzdGFibGlzaCB0aGUgaWNvbiBwb3NpdGlvbgoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdLmluZGV4T2YoICJ1aS1idG4taWNvbi0iICkgPT09IDAgKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlub0ljb24gPSBmYWxzZTsKCQkJby5pY29ucG9zID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCAxMiApOwoKCQkvLyBFc3RhYmxpc2ggd2hpY2ggaWNvbiBpcyBwcmVzZW50CgkJfSBlbHNlIGlmICggY2xhc3Nlc1sgaWR4IF0uaW5kZXhPZiggInVpLWljb24tIiApID09PSAwICkgewoJCQl1bmtub3duQ2xhc3MgPSBmYWxzZTsKCQkJby5pY29uID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA4ICk7CgoJCS8vIEVzdGFibGlzaCB0aGUgdGhlbWUgLSB0aGlzIHJlY29nbml6ZXMgb25lLWxldHRlciB0aGVtZSBzd2F0Y2ggbmFtZXMKCQl9IGVsc2UgaWYgKCBjbGFzc2VzWyBpZHggXS5pbmRleE9mKCAidWktYnRuLSIgKSA9PT0gMCAmJiBjbGFzc2VzWyBpZHggXS5sZW5ndGggPT09IDggKSB7CgkJCXVua25vd25DbGFzcyA9IGZhbHNlOwoJCQlvLnRoZW1lID0gY2xhc3Nlc1sgaWR4IF0uc3Vic3RyaW5nKCA3ICk7CgoJCS8vIFJlY29nbml6ZSB0aGF0IHRoaXMgZWxlbWVudCBoYXMgYWxyZWFkeSBiZWVuIGJ1dHRvbk1hcmt1cC1lbmhhbmNlZAoJCX0gZWxzZSBpZiAoIGNsYXNzZXNbIGlkeCBdID09PSAidWktYnRuIiApIHsKCQkJdW5rbm93bkNsYXNzID0gZmFsc2U7CgkJCWFscmVhZHlFbmhhbmNlZCA9IHRydWU7CgkJfQoKCQkvLyBJZiB0aGlzIGNsYXNzIGhhcyBub3QgYmVlbiByZWNvZ25pemVkLCBhZGQgaXQgdG8gdGhlIGxpc3QKCQlpZiAoIHVua25vd25DbGFzcyApIHsKCQkJdW5rbm93bkNsYXNzZXMucHVzaCggY2xhc3Nlc1sgaWR4IF0gKTsKCQl9Cgl9CgoJLy8gSWYgYSAidWktYnRuLWljb24tKiIgaWNvbiBwb3NpdGlvbiBjbGFzcyBpcyBhYnNlbnQgdGhlcmUgY2Fubm90IGJlIGFuIGljb24KCWlmICggbm9JY29uICkgewoJCW8uaWNvbiA9ICIiOwoJfQoKCXJldHVybiB7CgkJb3B0aW9uczogbywKCQl1bmtub3duQ2xhc3NlczogdW5rbm93bkNsYXNzZXMsCgkJYWxyZWFkeUVuaGFuY2VkOiBhbHJlYWR5RW5oYW5jZWQKCX07Cn0KCmZ1bmN0aW9uIGNhbWVsQ2FzZTJIeXBoZW5hdGVkKCBjICkgewoJcmV0dXJuICItIiArIGMudG9Mb3dlckNhc2UoKTsKfQoKLy8gJC5mbi5idXR0b25NYXJrdXA6Ci8vIERPTTogZ2V0cy9zZXRzIC5jbGFzc05hbWUKLy8KLy8gQG9wdGlvbnM6IG9wdGlvbnMgdG8gYXBwbHkgdG8gdGhlIGVsZW1lbnRzIGluIHRoZSBqUXVlcnkgb2JqZWN0Ci8vIEBvdmVyd3JpdGVDbGFzc2VzOiBib29sZWFuIGluZGljYXRpbmcgd2hldGhlciB0byBob25vdXIgZXhpc3RpbmcgY2xhc3NlcwovLwovLyBDYWxjdWxhdGVzIHRoZSBjbGFzc2VzIHRvIGFwcGx5IHRvIHRoZSBlbGVtZW50cyBpbiB0aGUgalF1ZXJ5IG9iamVjdCBiYXNlZCBvbgovLyB0aGUgb3B0aW9ucyBwYXNzZWQgaW4uIElmIEBvdmVyd3JpdGVDbGFzc2VzIGlzIHRydWUsIGl0IHNldHMgdGhlIGNsYXNzTmFtZQovLyBwcm9wZXJ0eSBvZiBlYWNoIGVsZW1lbnQgaW4gdGhlIGpRdWVyeSBvYmplY3QgdG8gdGhlIGJ1dHRvbk1hcmt1cCBjbGFzc2VzCi8vIGl0IGNhbGN1bGF0ZXMgYmFzZWQgb24gdGhlIG9wdGlvbnMgcGFzc2VkIGluLgovLwovLyBJZiB5b3Ugd2lzaCB0byBwcmVzZXJ2ZSBhbnkgY2xhc3NlcyB0aGF0IGFyZSBhbHJlYWR5IHByZXNlbnQgb24gdGhlIGVsZW1lbnRzCi8vIGluc2lkZSB0aGUgalF1ZXJ5IG9iamVjdCwgaW5jbHVkaW5nIGJ1dHRvbk1hcmt1cC1yZWxhdGVkIGNsYXNzZXMgdGhhdCB3ZXJlCi8vIGFkZGVkIGJ5IGEgcHJldmlvdXMgY2FsbCB0byAkLmZuLmJ1dHRvbk1hcmt1cCgpIG9yIGR1cmluZyBwYWdlIGVuaGFuY2VtZW50Ci8vIHRoZW4geW91IHNob3VsZCBvbWl0IEBvdmVyd3JpdGVDbGFzc2VzIG9yIHNldCBpdCB0byBmYWxzZS4KJC5mbi5idXR0b25NYXJrdXAgPSBmdW5jdGlvbiggb3B0aW9ucywgb3ZlcndyaXRlQ2xhc3NlcyApIHsKCXZhciBpZHgsIGRhdGEsIGVsLCByZXRyaWV2ZWRPcHRpb25zLCBvcHRpb25LZXksCgkJZGVmYXVsdHMgPSAkLmZuLmJ1dHRvbk1hcmt1cC5kZWZhdWx0czsKCglmb3IgKCBpZHggPSAwIDsgaWR4IDwgdGhpcy5sZW5ndGggOyBpZHgrKyApIHsKCQllbCA9IHRoaXNbIGlkeCBdOwoJCWRhdGEgPSBvdmVyd3JpdGVDbGFzc2VzID8KCgkJCS8vIEFzc3VtZSB0aGlzIGVsZW1lbnQgaXMgbm90IGVuaGFuY2VkIGFuZCBpZ25vcmUgaXRzIGNsYXNzZXMKCQkJeyBhbHJlYWR5RW5oYW5jZWQ6IGZhbHNlLCB1bmtub3duQ2xhc3NlczogW10gfSA6CgoJCQkvLyBPdGhlcndpc2UgYW5hbHl6ZSBleGlzdGluZyBjbGFzc2VzIHRvIGVzdGFibGlzaCBleGlzdGluZyBvcHRpb25zIGFuZAoJCQkvLyBjbGFzc2VzCgkJCWNsYXNzTmFtZVRvT3B0aW9ucyggZWwuY2xhc3NOYW1lICk7CgoJCXJldHJpZXZlZE9wdGlvbnMgPSAkLmV4dGVuZCgge30sCgoJCQkvLyBJZiB0aGUgZWxlbWVudCBhbHJlYWR5IGhhcyB0aGUgY2xhc3MgdWktYnRuLCB0aGVuIHdlIGFzc3VtZSB0aGF0CgkJCS8vIGl0IGhhcyBwYXNzZWQgdGhyb3VnaCBidXR0b25NYXJrdXAgYmVmb3JlIC0gb3RoZXJ3aXNlLCB0aGUgb3B0aW9ucwoJCQkvLyByZXR1cm5lZCBieSBjbGFzc05hbWVUb09wdGlvbnMgZG8gbm90IGNvcnJlY3RseSByZWZsZWN0IHRoZSBzdGF0ZSBvZgoJCQkvLyB0aGUgZWxlbWVudAoJCQkoIGRhdGEuYWxyZWFkeUVuaGFuY2VkID8gZGF0YS5vcHRpb25zIDoge30gKSwKCgkJCS8vIEZpbmFsbHksIGFwcGx5IHRoZSBvcHRpb25zIHBhc3NlZCBpbgoJCQlvcHRpb25zICk7CgoJCS8vIElmIHRoaXMgaXMgdGhlIGZpcnN0IGNhbGwgb24gdGhpcyBlbGVtZW50LCByZXRyaWV2ZSByZW1haW5pbmcgb3B0aW9ucwoJCS8vIGZyb20gdGhlIGRhdGEtYXR0cmlidXRlcwoJCWlmICggIWRhdGEuYWxyZWFkeUVuaGFuY2VkICkgewoJCQlmb3IgKCBvcHRpb25LZXkgaW4gZGVmYXVsdHMgKSB7CgkJCQlpZiAoIHJldHJpZXZlZE9wdGlvbnNbIG9wdGlvbktleSBdID09PSB1bmRlZmluZWQgKSB7CgkJCQkJcmV0cmlldmVkT3B0aW9uc1sgb3B0aW9uS2V5IF0gPSBnZXRBdHRyRml4ZWQoIGVsLAoJCQkJCQlvcHRpb25LZXkucmVwbGFjZSggY2FwaXRhbExldHRlcnNSRSwgY2FtZWxDYXNlMkh5cGhlbmF0ZWQgKQoJCQkJCSk7CgkJCQl9CgkJCX0KCQl9CgoJCWVsLmNsYXNzTmFtZSA9IG9wdGlvbnNUb0NsYXNzZXMoCgoJCQkvLyBNZXJnZSBhbGwgdGhlIG9wdGlvbnMgYW5kIGFwcGx5IHRoZW0gYXMgY2xhc3NlcwoJCQkkLmV4dGVuZCgge30sCgoJCQkJLy8gVGhlIGRlZmF1bHRzIGZvcm0gdGhlIGJhc2lzCgkJCQlkZWZhdWx0cywKCgkJCQkvLyBBZGQgdGhlIGNvbXB1dGVkIG9wdGlvbnMKCQkJCXJldHJpZXZlZE9wdGlvbnMKCQkJKSwKCgkJCS8vIC4uLiBhbmQgcmUtYXBwbHkgYW55IHVucmVjb2duaXplZCBjbGFzc2VzIHRoYXQgd2VyZSBmb3VuZAoJCQlkYXRhLnVua25vd25DbGFzc2VzICkuam9pbiggIiAiICk7CgkJaWYgKCBlbC50YWdOYW1lLnRvTG93ZXJDYXNlKCkgIT09ICJidXR0b24iICkgewoJCQllbC5zZXRBdHRyaWJ1dGUoICJyb2xlIiwgImJ1dHRvbiIgKTsKCQl9Cgl9CgoJcmV0dXJuIHRoaXM7Cn07CgovLyBidXR0b25NYXJrdXAgZGVmYXVsdHMuIFRoaXMgbXVzdCBiZSBhIGNvbXBsZXRlIHNldCwgaS5lLiwgYSB2YWx1ZSBtdXN0IGJlCi8vIGdpdmVuIGhlcmUgZm9yIGFsbCByZWNvZ25pemVkIG9wdGlvbnMKJC5mbi5idXR0b25NYXJrdXAuZGVmYXVsdHMgPSB7CglpY29uOiAiIiwKCWljb25wb3M6ICJsZWZ0IiwKCXRoZW1lOiBudWxsLAoJaW5saW5lOiBmYWxzZSwKCXNoYWRvdzogdHJ1ZSwKCWNvcm5lcnM6IHRydWUsCglpY29uc2hhZG93OiBmYWxzZSwgLyogVE9ETzogUmVtb3ZlIGluIDEuNS4gT3B0aW9uIGRlcHJlY2F0ZWQgaW4gMS40LiAqLwoJbWluaTogZmFsc2UKfTsKCiQuZXh0ZW5kKCAkLmZuLmJ1dHRvbk1hcmt1cCwgewoJaW5pdFNlbGVjdG9yOiAiYTpqcW1EYXRhKHJvbGU9J2J1dHRvbicpLCAudWktYmFyID4gYSwgLnVpLWJhciA+IDpqcW1EYXRhKHJvbGU9J2NvbnRyb2xncm91cCcpID4gYSwgYnV0dG9uIgp9KTsKCn0pKCBqUXVlcnkgKTsKCgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLmNvbnRyb2xncm91cCIsICQuZXh0ZW5kKCB7CglvcHRpb25zOiB7CgkJZW5oYW5jZWQ6IGZhbHNlLAoJCXRoZW1lOiBudWxsLAoJCXNoYWRvdzogZmFsc2UsCgkJY29ybmVyczogdHJ1ZSwKCQlleGNsdWRlSW52aXNpYmxlOiB0cnVlLAoJCXR5cGU6ICJ2ZXJ0aWNhbCIsCgkJbWluaTogZmFsc2UKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGVsZW0gPSB0aGlzLmVsZW1lbnQsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCS8vIFJ1biBidXR0b25tYXJrdXAKCQlpZiAoICQuZm4uYnV0dG9uTWFya3VwICkgewoJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5mbi5idXR0b25NYXJrdXAuaW5pdFNlbGVjdG9yICkuYnV0dG9uTWFya3VwKCk7CgkJfQoJCS8vIEVuaGFuY2UgY2hpbGQgd2lkZ2V0cwoJCSQuZWFjaCggdGhpcy5fY2hpbGRXaWRnZXRzLCAkLnByb3h5KCBmdW5jdGlvbiggbnVtYmVyLCB3aWRnZXROYW1lICkgewoJCQlpZiAoICQubW9iaWxlWyB3aWRnZXROYW1lIF0gKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggJC5tb2JpbGVbIHdpZGdldE5hbWUgXS5pbml0U2VsZWN0b3IgKS5ub3QoICQubW9iaWxlLnBhZ2UucHJvdG90eXBlLmtlZXBOYXRpdmVTZWxlY3RvcigpIClbIHdpZGdldE5hbWUgXSgpOwoJCQl9CgkJfSwgdGhpcyApKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3VpOiBudWxsLAoJCQlfaW5pdGlhbFJlZnJlc2g6IHRydWUKCQl9KTsKCgkJaWYgKCBvcHRzLmVuaGFuY2VkICkgewoJCQl0aGlzLl91aSA9IHsKCQkJCWdyb3VwTGVnZW5kOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1sYWJlbCIgKS5jaGlsZHJlbigpLAoJCQkJY2hpbGRXcmFwcGVyOiBlbGVtLmNoaWxkcmVuKCAiLnVpLWNvbnRyb2xncm91cC1jb250cm9scyIgKQoJCQl9OwoJCX0gZWxzZSB7CgkJCXRoaXMuX3VpID0gdGhpcy5fZW5oYW5jZSgpOwoJCX0KCgl9LAoKCV9jaGlsZFdpZGdldHM6IFsgImNoZWNrYm94cmFkaW8iLCAic2VsZWN0bWVudSIsICJidXR0b24iIF0sCgoJX3RoZW1lQ2xhc3NGcm9tT3B0aW9uOiBmdW5jdGlvbiggdmFsdWUgKSB7CgkJcmV0dXJuICggdmFsdWUgPyAoIHZhbHVlID09PSAibm9uZSIgPyAiIiA6ICJ1aS1ncm91cC10aGVtZS0iICsgdmFsdWUgKSA6ICIiICk7Cgl9LAoKCV9lbmhhbmNlOiBmdW5jdGlvbigpIHsKCQl2YXIgZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJdWkgPSB7CgkJCQlncm91cExlZ2VuZDogZWxlbS5jaGlsZHJlbiggImxlZ2VuZCIgKSwKCQkJCWNoaWxkV3JhcHBlcjogZWxlbQoJCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCQkJInVpLWNvbnRyb2xncm91cC0iICsKCQkJCQkJCSggb3B0cy50eXBlID09PSAiaG9yaXpvbnRhbCIgPyAiaG9yaXpvbnRhbCIgOiAidmVydGljYWwiICkgKyAiICIgKwoJCQkJCQl0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0cy50aGVtZSApICsgIiAiICsKCQkJCQkJKCBvcHRzLmNvcm5lcnMgPyAidWktY29ybmVyLWFsbCAiIDogIiIgKSArCgkJCQkJCSggb3B0cy5taW5pID8gInVpLW1pbmkgIiA6ICIiICkgKQoJCQkJCS53cmFwSW5uZXIoICI8ZGl2ICIgKwoJCQkJCQkiY2xhc3M9J3VpLWNvbnRyb2xncm91cC1jb250cm9scyAiICsKCQkJCQkJCSggb3B0cy5zaGFkb3cgPT09IHRydWUgPyAidWktc2hhZG93IiA6ICIiICkgKyAiJz48L2Rpdj4iICkKCQkJCQkuY2hpbGRyZW4oKQoJCQl9OwoKCQlpZiAoIHVpLmdyb3VwTGVnZW5kLmxlbmd0aCA+IDAgKSB7CgkJCSQoICI8ZGl2IHJvbGU9J2hlYWRpbmcnIGNsYXNzPSd1aS1jb250cm9sZ3JvdXAtbGFiZWwnPjwvZGl2PiIgKQoJCQkJLmFwcGVuZCggdWkuZ3JvdXBMZWdlbmQgKQoJCQkJLnByZXBlbmRUbyggZWxlbSApOwoJCX0KCgkJcmV0dXJuIHVpOwoJfSwKCglfaW5pdDogZnVuY3Rpb24oKSB7CgkJdGhpcy5yZWZyZXNoKCk7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgY2FsbFJlZnJlc2gsIHJldHVyblZhbHVlLAoJCQllbGVtID0gdGhpcy5lbGVtZW50OwoKCQkvLyBNdXN0IGhhdmUgb25lIG9mIGhvcml6b250YWwgb3IgdmVydGljYWwKCQlpZiAoIG9wdGlvbnMudHlwZSAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtCgkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwiICkKCQkJCS5hZGRDbGFzcyggInVpLWNvbnRyb2xncm91cC0iICsgKCBvcHRpb25zLnR5cGUgPT09ICJob3Jpem9udGFsIiA/ICJob3Jpem9udGFsIiA6ICJ2ZXJ0aWNhbCIgKSApOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlpZiAoIG9wdGlvbnMudGhlbWUgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbQoJCQkJLnJlbW92ZUNsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggdGhpcy5vcHRpb25zLnRoZW1lICkgKQoJCQkJLmFkZENsYXNzKCB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggb3B0aW9ucy50aGVtZSApICk7CgkJfQoKCQlpZiAoIG9wdGlvbnMuY29ybmVycyAhPT0gdW5kZWZpbmVkICkgewoJCQllbGVtLnRvZ2dsZUNsYXNzKCAidWktY29ybmVyLWFsbCIsIG9wdGlvbnMuY29ybmVycyApOwoJCX0KCgkJaWYgKCBvcHRpb25zLm1pbmkgIT09IHVuZGVmaW5lZCApIHsKCQkJZWxlbS50b2dnbGVDbGFzcyggInVpLW1pbmkiLCBvcHRpb25zLm1pbmkgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJdGhpcy5fdWkuY2hpbGRXcmFwcGVyLnRvZ2dsZUNsYXNzKCAidWktc2hhZG93Iiwgb3B0aW9ucy5zaGFkb3cgKTsKCQl9CgoJCWlmICggb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMub3B0aW9ucy5leGNsdWRlSW52aXNpYmxlID0gb3B0aW9ucy5leGNsdWRlSW52aXNpYmxlOwoJCQljYWxsUmVmcmVzaCA9IHRydWU7CgkJfQoKCQlyZXR1cm5WYWx1ZSA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCWlmICggY2FsbFJlZnJlc2ggKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCgkJcmV0dXJuIHJldHVyblZhbHVlOwoJfSwKCgljb250YWluZXI6IGZ1bmN0aW9uKCkgewoJCXJldHVybiB0aGlzLl91aS5jaGlsZFdyYXBwZXI7Cgl9LAoKCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCXZhciAkZWwgPSB0aGlzLmNvbnRhaW5lcigpLAoJCQllbHMgPSAkZWwuZmluZCggIi51aS1idG4iICkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICksCgkJCWNyZWF0ZSA9IHRoaXMuX2luaXRpYWxSZWZyZXNoOwoJCWlmICggJC5tb2JpbGUuY2hlY2tib3hyYWRpbyApIHsKCQkJJGVsLmZpbmQoICI6bW9iaWxlLWNoZWNrYm94cmFkaW8iICkuY2hlY2tib3hyYWRpbyggInJlZnJlc2giICk7CgkJfQoJCXRoaXMuX2FkZEZpcnN0TGFzdENsYXNzZXMoIGVscywKCQkJdGhpcy5vcHRpb25zLmV4Y2x1ZGVJbnZpc2libGUgPyB0aGlzLl9nZXRWaXNpYmxlcyggZWxzLCBjcmVhdGUgKSA6IGVscywKCQkJY3JlYXRlICk7CgkJdGhpcy5faW5pdGlhbFJlZnJlc2ggPSBmYWxzZTsKCX0sCgoJLy8gQ2F2ZWF0OiBJZiB0aGUgbGVnZW5kIGlzIG5vdCB0aGUgZmlyc3QgY2hpbGQgb2YgdGhlIGNvbnRyb2xncm91cCBhdCBlbmhhbmNlCgkvLyB0aW1lLCBpdCB3aWxsIGJlIGFmdGVyIF9kZXN0cm95KCkuCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIHVpLCBidXR0b25zLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJdWkgPSB0aGlzLl91aTsKCQlidXR0b25zID0gdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggInVpLWNvbnRyb2xncm91cCAiICsKCQkJCSJ1aS1jb250cm9sZ3JvdXAtaG9yaXpvbnRhbCB1aS1jb250cm9sZ3JvdXAtdmVydGljYWwgdWktY29ybmVyLWFsbCB1aS1taW5pICIgKwoJCQkJdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oIG9wdHMudGhlbWUgKSApCgkJCS5maW5kKCAiLnVpLWJ0biIgKQoJCQkubm90KCAiLnVpLXNsaWRlci1oYW5kbGUiICk7CgoJCXRoaXMuX3JlbW92ZUZpcnN0TGFzdENsYXNzZXMoIGJ1dHRvbnMgKTsKCgkJdWkuZ3JvdXBMZWdlbmQudW53cmFwKCk7CgkJdWkuY2hpbGRXcmFwcGVyLmNoaWxkcmVuKCkudW53cmFwKCk7Cgl9Cn0sICQubW9iaWxlLmJlaGF2aW9ycy5hZGRGaXJzdExhc3RDbGFzc2VzICkgKTsKCn0pKGpRdWVyeSk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCgkkLndpZGdldCggIm1vYmlsZS50b29sYmFyIiwgewoJCWluaXRTZWxlY3RvcjogIjpqcW1EYXRhKHJvbGU9J2Zvb3RlcicpLCA6anFtRGF0YShyb2xlPSdoZWFkZXInKSIsCgoJCW9wdGlvbnM6IHsKCQkJdGhlbWU6IG51bGwsCgkJCWFkZEJhY2tCdG46IGZhbHNlLAoJCQliYWNrQnRuVGhlbWU6IG51bGwsCgkJCWJhY2tCdG5UZXh0OiAiQmFjayIKCQl9LAoKCQlfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQkJdmFyIGxlZnRidG4sIHJpZ2h0YnRuLAoJCQkJcm9sZSA9ICB0aGlzLmVsZW1lbnQuaXMoICI6anFtRGF0YShyb2xlPSdoZWFkZXInKSIgKSA/ICJoZWFkZXIiIDogImZvb3RlciIsCgkJCQlwYWdlID0gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTsKCQkJaWYgKCBwYWdlLmxlbmd0aCA9PT0gMCApIHsKCQkJCXBhZ2UgPSBmYWxzZTsKCQkJCXRoaXMuX29uKCB0aGlzLmRvY3VtZW50LCB7CgkJCQkJInBhZ2VzaG93IjogInJlZnJlc2giCgkJCQl9KTsKCQkJfQoJCQkkLmV4dGVuZCggdGhpcywgewoJCQkJcm9sZTogcm9sZSwKCQkJCXBhZ2U6IHBhZ2UsCgkJCQlsZWZ0YnRuOiBsZWZ0YnRuLAoJCQkJcmlnaHRidG46IHJpZ2h0YnRuLAoJCQkJYmFja0J0bjogbnVsbAoJCQl9KTsKCQkJdGhpcy5lbGVtZW50LmF0dHIoICJyb2xlIiwgcm9sZSA9PT0gImhlYWRlciIgPyAiYmFubmVyIiA6ICJjb250ZW50aW5mbyIgKS5hZGRDbGFzcyggInVpLSIgKyByb2xlICk7CgkJCXRoaXMucmVmcmVzaCgpOwoJCQl0aGlzLl9zZXRPcHRpb25zKCB0aGlzLm9wdGlvbnMgKTsKCQl9LAoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLmFkZEJhY2tCdG4gIT09IHVuZGVmaW5lZCApIHsKCQkJCWlmICggdGhpcy5vcHRpb25zLmFkZEJhY2tCdG4gJiYKCQkJCQl0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmCgkJCQkJJCggIi51aS1wYWdlIiApLmxlbmd0aCA+IDEgJiYKCQkJCQl0aGlzLnBhZ2VbIDAgXS5nZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiICkgIT09ICQubW9iaWxlLnBhdGguc3RyaXBIYXNoKCBsb2NhdGlvbi5oYXNoICkgJiYKCQkJCQkhdGhpcy5sZWZ0YnRuICkgewoJCQkJCQl0aGlzLl9hZGRCYWNrQnV0dG9uKCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuZWxlbWVudC5maW5kKCAiLnVpLXRvb2xiYXItYmFjay1idG4iICkucmVtb3ZlKCk7CgkJCQl9CgkJCX0KCQkJaWYgKCBvLmJhY2tCdG5UaGVtZSAhPSBudWxsICkgewoJCQkJdGhpcy5lbGVtZW50CgkJCQkJLmZpbmQoICIudWktdG9vbGJhci1iYWNrLWJ0biIgKQoJCQkJCS5hZGRDbGFzcyggInVpLWJ0biB1aS1idG4tIiArIG8uYmFja0J0blRoZW1lICk7CgkJCX0KCQkJaWYgKCBvLmJhY2tCdG5UZXh0ICE9PSB1bmRlZmluZWQgKSB7CgkJCQl0aGlzLmVsZW1lbnQuZmluZCggIi51aS10b29sYmFyLWJhY2stYnRuIC51aS1idG4tdGV4dCIgKS50ZXh0KCBvLmJhY2tCdG5UZXh0ICk7CgkJCX0KCQkJaWYgKCBvLnRoZW1lICE9PSB1bmRlZmluZWQgKSB7CgkJCQl2YXIgY3VycmVudFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lID8gdGhpcy5vcHRpb25zLnRoZW1lIDogImluaGVyaXQiLAoJCQkJCW5ld1RoZW1lID0gby50aGVtZSA/IG8udGhlbWUgOiAiaW5oZXJpdCI7CgoJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktYmFyLSIgKyBjdXJyZW50VGhlbWUgKS5hZGRDbGFzcyggInVpLWJhci0iICsgbmV3VGhlbWUgKTsKCQkJfQoKCQkJdGhpcy5fc3VwZXIoIG8gKTsKCQl9LAoJCXJlZnJlc2g6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMucm9sZSA9PT0gImhlYWRlciIgKSB7CgkJCQl0aGlzLl9hZGRIZWFkZXJCdXR0b25DbGFzc2VzKCk7CgkJCX0KCQkJaWYgKCAhdGhpcy5wYWdlICkgewoJCQkJdGhpcy5fc2V0UmVsYXRpdmUoKTsKCQkJCWlmICggdGhpcy5yb2xlID09PSAiZm9vdGVyIiApIHsKCQkJCQl0aGlzLmVsZW1lbnQuYXBwZW5kVG8oICJib2R5IiApOwoJCQkJfQoJCQl9CgkJCXRoaXMuX2FkZEhlYWRpbmdDbGFzc2VzKCk7CgkJCXRoaXMuX2J0bk1hcmt1cCgpOwoJCX0sCgoJCS8vd2Ugb25seSB3YW50IHRoaXMgdG8gcnVuIG9uIG5vbiBmaXhlZCB0b29sYmFycyBzbyBtYWtlIGl0IGVhc3kgdG8gb3ZlcnJpZGUKCQlfc2V0UmVsYXRpdmU6IGZ1bmN0aW9uKCkgewoJCQkkKCAiW2RhdGEtIisgJC5tb2JpbGUubnMgKyAicm9sZT0ncGFnZSddIiApLmNzcyh7ICJwb3NpdGlvbiI6ICJyZWxhdGl2ZSIgfSk7CgkJfSwKCgkJLy8gRGVwcmVjYXRlZCBpbiAxLjQuIEFzIGZyb20gMS41IGJ1dHRvbiBjbGFzc2VzIGhhdmUgdG8gYmUgcHJlc2VudCBpbiB0aGUgbWFya3VwLgoJCV9idG5NYXJrdXA6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oICJhIiApLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlIiwgImJ1dHRvbiIgKTsKCQkJdGhpcy5lbGVtZW50LnRyaWdnZXIoICJjcmVhdGUiICk7CgkJfSwKCQkvLyBEZXByZWNhdGVkIGluIDEuNC4gQXMgZnJvbSAxLjUgdWktYnRuLWxlZnQvcmlnaHQgY2xhc3NlcyBoYXZlIHRvIGJlIHByZXNlbnQgaW4gdGhlIG1hcmt1cC4KCQlfYWRkSGVhZGVyQnV0dG9uQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXZhciAkaGVhZGVyYW5jaG9ycyA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbiggImEsIGJ1dHRvbiIgKTsKCQkJdGhpcy5sZWZ0YnRuID0gJGhlYWRlcmFuY2hvcnMuaGFzQ2xhc3MoICJ1aS1idG4tbGVmdCIgKTsKCQkJdGhpcy5yaWdodGJ0biA9ICRoZWFkZXJhbmNob3JzLmhhc0NsYXNzKCAidWktYnRuLXJpZ2h0IiApOwoKCQkJdGhpcy5sZWZ0YnRuID0gdGhpcy5sZWZ0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAwICkubm90KCAiLnVpLWJ0bi1yaWdodCIgKS5hZGRDbGFzcyggInVpLWJ0bi1sZWZ0IiApLmxlbmd0aDsKCgkJCXRoaXMucmlnaHRidG4gPSB0aGlzLnJpZ2h0YnRuIHx8ICRoZWFkZXJhbmNob3JzLmVxKCAxICkuYWRkQ2xhc3MoICJ1aS1idG4tcmlnaHQiICkubGVuZ3RoOwoKCQl9LAoJCV9hZGRCYWNrQnV0dG9uOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRoZW1lLAoJCQkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCgkJCWlmICggIXRoaXMuYmFja0J0biApIHsKCQkJCXRoZW1lID0gb3B0aW9ucy5iYWNrQnRuVGhlbWUgfHwgb3B0aW9ucy50aGVtZTsKCQkJCXRoaXMuYmFja0J0biA9ICQoICI8YSByb2xlPSdidXR0b24nIGhyZWY9J2phdmFzY3JpcHQ6dm9pZCgwKTsnICIgKwoJCQkJCSJjbGFzcz0ndWktYnRuIHVpLWNvcm5lci1hbGwgdWktc2hhZG93IHVpLWJ0bi1sZWZ0ICIgKwoJCQkJCQkoIHRoZW1lID8gInVpLWJ0bi0iICsgdGhlbWUgKyAiICIgOiAiIiApICsKCQkJCQkJInVpLXRvb2xiYXItYmFjay1idG4gdWktaWNvbi1jYXJhdC1sIHVpLWJ0bi1pY29uLWxlZnQnICIgKwoJCQkJCSJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyZWw9J2JhY2snPiIgKyBvcHRpb25zLmJhY2tCdG5UZXh0ICsgIjwvYT4iICkKCQkJCQkJLnByZXBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgkJCX0KCQl9LAoJCV9hZGRIZWFkaW5nQ2xhc3NlczogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5jaGlsZHJlbiggImgxLCBoMiwgaDMsIGg0LCBoNSwgaDYiICkKCQkJCS5hZGRDbGFzcyggInVpLXRpdGxlIiApCgkJCQkvLyBSZWdhcmRsZXNzIG9mIGggZWxlbWVudCBudW1iZXIgaW4gc3JjLCBpdCBiZWNvbWVzIGgxIGZvciB0aGUgZW5oYW5jZWQgcGFnZQoJCQkJLmF0dHIoewoJCQkJCSJyb2xlIjogImhlYWRpbmciLAoJCQkJCSJhcmlhLWxldmVsIjogIjEiCgkJCQl9KTsKCQl9Cgl9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgkJb3B0aW9uczogewoJCQlwb3NpdGlvbjpudWxsLAoJCQl2aXNpYmxlT25QYWdlU2hvdzogdHJ1ZSwKCQkJZGlzYWJsZVBhZ2Vab29tOiB0cnVlLAoJCQl0cmFuc2l0aW9uOiAic2xpZGUiLCAvL2NhbiBiZSBub25lLCBmYWRlLCBzbGlkZSAoc2xpZGUgbWFwcyB0byBzbGlkZXVwIG9yIHNsaWRlZG93bikKCQkJZnVsbHNjcmVlbjogZmFsc2UsCgkJCXRhcFRvZ2dsZTogdHJ1ZSwKCQkJdGFwVG9nZ2xlQmxhY2tsaXN0OiAiYSwgYnV0dG9uLCBpbnB1dCwgc2VsZWN0LCB0ZXh0YXJlYSwgLnVpLWhlYWRlci1maXhlZCwgLnVpLWZvb3Rlci1maXhlZCwgLnVpLWZsaXBzd2l0Y2gsIC51aS1wb3B1cCwgLnVpLXBhbmVsLCAudWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJaGlkZUR1cmluZ0ZvY3VzOiAiaW5wdXQsIHRleHRhcmVhLCBzZWxlY3QiLAoJCQl1cGRhdGVQYWdlUGFkZGluZzogdHJ1ZSwKCQkJdHJhY2tQZXJzaXN0ZW50VG9vbGJhcnM6IHRydWUsCgoJCQkvLyBCcm93c2VyIGRldGVjdGlvbiEgV2VlZWUsIGhlcmUgd2UgZ28uLi4KCQkJLy8gVW5mb3J0dW5hdGVseSwgcG9zaXRpb246Zml4ZWQgaXMgY29zdGx5LCBub3QgdG8gbWVudGlvbiBwcm9iYWJseSBpbXBvc3NpYmxlLCB0byBmZWF0dXJlLWRldGVjdCBhY2N1cmF0ZWx5LgoJCQkvLyBTb21lIHRlc3RzIGV4aXN0LCBidXQgdGhleSBjdXJyZW50bHkgcmV0dXJuIGZhbHNlIHJlc3VsdHMgaW4gY3JpdGljYWwgZGV2aWNlcyBhbmQgYnJvd3NlcnMsIHdoaWNoIGNvdWxkIGxlYWQgdG8gYSBicm9rZW4gZXhwZXJpZW5jZS4KCQkJLy8gVGVzdGluZyBmaXhlZCBwb3NpdGlvbmluZyBpcyBhbHNvIHByZXR0eSBvYnRydXNpdmUgdG8gcGFnZSBsb2FkLCByZXF1aXJpbmcgaW5qZWN0ZWQgZWxlbWVudHMgYW5kIHNjcm9sbGluZyB0aGUgd2luZG93CgkJCS8vIFRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gc2VydmVzIHRvIHJ1bGUgb3V0IHNvbWUgcG9wdWxhciBicm93c2VycyB3aXRoIGtub3duIGZpeGVkLXBvc2l0aW9uaW5nIGlzc3VlcwoJCQkvLyBUaGlzIGlzIGEgcGx1Z2luIG9wdGlvbiBsaWtlIGFueSBvdGhlciwgc28gZmVlbCBmcmVlIHRvIGltcHJvdmUgb3Igb3ZlcndyaXRlIGl0CgkJCXN1cHBvcnRCbGFja2xpc3Q6IGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICEkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbjsKCQkJfQoJCX0sCgoJCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQlpZiAoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiA9PT0gImZpeGVkIiAmJiAhdGhpcy5vcHRpb25zLnN1cHBvcnRCbGFja2xpc3QoKSApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJfSwKCgkJX21ha2VGaXhlZDogZnVuY3Rpb24oKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1maXhlZCIgKTsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZygpOwoJCQl0aGlzLl9hZGRUcmFuc2l0aW9uQ2xhc3MoKTsKCQkJdGhpcy5fYmluZFBhZ2VFdmVudHMoKTsKCQkJdGhpcy5fYmluZFRvZ2dsZUhhbmRsZXJzKCk7CgkJCXRoaXMuX3NldE9wdGlvbnMoIHRoaXMub3B0aW9ucyApOwoJCX0sCgoJCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggbyApIHsKCQkJaWYgKCBvLnBvc2l0aW9uID09PSAiZml4ZWQiICYmIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApIHsKCQkJCXRoaXMuX21ha2VGaXhlZCgpOwoJCQl9CgkJCWlmICggdGhpcy5vcHRpb25zLnBvc2l0aW9uID09PSAiZml4ZWQiICYmICF0aGlzLm9wdGlvbnMuc3VwcG9ydEJsYWNrbGlzdCgpICkgewoJCQkJdmFyICRwYWdlID0gKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICggJCgiLnVpLXBhZ2UtYWN0aXZlIikubGVuZ3RoID4gMCApPyAkKCIudWktcGFnZS1hY3RpdmUiKTogJCgiLnVpLXBhZ2UiKS5lcSgwKTsKCgkJCQlpZiAoIG8uZnVsbHNjcmVlbiAhPT0gdW5kZWZpbmVkKSB7CgkJCQkJaWYgKCBvLmZ1bGxzY3JlZW4gKSB7CgkJCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggInVpLSIrIHRoaXMucm9sZSArIi1mdWxsc2NyZWVuIiApOwoJCQkJCQkkcGFnZS5hZGRDbGFzcyggInVpLXBhZ2UtIiArIHRoaXMucm9sZSArICItZnVsbHNjcmVlbiIgKTsKCQkJCQl9CgkJCQkJLy8gSWYgbm90IGZ1bGxzY3JlZW4sIGFkZCBjbGFzcyB0byBwYWdlIHRvIHNldCB0b3Agb3IgYm90dG9tIHBhZGRpbmcKCQkJCQllbHNlIHsKCQkJCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCAidWktIisgdGhpcy5yb2xlICsiLWZ1bGxzY3JlZW4iICk7CgkJCQkJCSRwYWdlLnJlbW92ZUNsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlICsgIi1mdWxsc2NyZWVuIiApLmFkZENsYXNzKCAidWktcGFnZS0iICsgdGhpcy5yb2xlKyAiLWZpeGVkIiApOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zdXBlcihvKTsKCQl9LAoKCQlfYWRkVHJhbnNpdGlvbkNsYXNzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHRjbGFzcyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uOwoKCQkJaWYgKCB0Y2xhc3MgJiYgdGNsYXNzICE9PSAibm9uZSIgKSB7CgkJCQkvLyB1c2UgYXBwcm9wcmlhdGUgc2xpZGUgZm9yIGhlYWRlciBvciBmb290ZXIKCQkJCWlmICggdGNsYXNzID09PSAic2xpZGUiICkgewoJCQkJCXRjbGFzcyA9IHRoaXMuZWxlbWVudC5oYXNDbGFzcyggInVpLWhlYWRlciIgKSA/ICJzbGlkZWRvd24iIDogInNsaWRldXAiOwoJCQkJfQoKCQkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGNsYXNzICk7CgkJCX0KCQl9LAoKCQlfYmluZFBhZ2VFdmVudHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFnZSA9ICggISF0aGlzLnBhZ2UgKT8gdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKTogdGhpcy5kb2N1bWVudDsKCQkJLy9wYWdlIGV2ZW50IGJpbmRpbmdzCgkJCS8vIEZpeGVkIHRvb2xiYXJzIHJlcXVpcmUgcGFnZSB6b29tIHRvIGJlIGRpc2FibGVkLCBvdGhlcndpc2UgdXNhYmlsaXR5IGlzc3VlcyBjcm9wIHVwCgkJCS8vIFRoaXMgbWV0aG9kIGlzIG1lYW50IHRvIGRpc2FibGUgem9vbSB3aGlsZSBhIGZpeGVkLXBvc2l0aW9uZWQgdG9vbGJhciBwYWdlIGlzIHZpc2libGUKCQkJdGhpcy5fb24oIHBhZ2UgLCB7CgkJCQkicGFnZWJlZm9yZXNob3ciOiAiX2hhbmRsZVBhZ2VCZWZvcmVTaG93IiwKCQkJCSJ3ZWJraXRBbmltYXRpb25TdGFydCI6Il9oYW5kbGVBbmltYXRpb25TdGFydCIsCgkJCQkiYW5pbWF0aW9uc3RhcnQiOiJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInVwZGF0ZWxheW91dCI6ICJfaGFuZGxlQW5pbWF0aW9uU3RhcnQiLAoJCQkJInBhZ2VzaG93IjogIl9oYW5kbGVQYWdlU2hvdyIsCgkJCQkicGFnZWJlZm9yZWhpZGUiOiAiX2hhbmRsZVBhZ2VCZWZvcmVIaWRlIgoJCQl9KTsKCQl9LAoKCQlfaGFuZGxlUGFnZUJlZm9yZVNob3c6IGZ1bmN0aW9uKCApIHsKCQkJdmFyIG8gPSB0aGlzLm9wdGlvbnM7CgkJCWlmICggby5kaXNhYmxlUGFnZVpvb20gKSB7CgkJCQkkLm1vYmlsZS56b29tLmRpc2FibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoICFvLnZpc2libGVPblBhZ2VTaG93ICkgewoJCQkJdGhpcy5oaWRlKCB0cnVlICk7CgkJCX0KCQl9LAoKCQlfaGFuZGxlQW5pbWF0aW9uU3RhcnQ6IGZ1bmN0aW9uKCkgewoJCQlpZiAoIHRoaXMub3B0aW9ucy51cGRhdGVQYWdlUGFkZGluZyApIHsKCQkJCXRoaXMudXBkYXRlUGFnZVBhZGRpbmcoICggISF0aGlzLnBhZ2UgKT8gdGhpcy5wYWdlOiAiLnVpLXBhZ2UtYWN0aXZlIiApOwoJCQl9CgkJfSwKCgkJX2hhbmRsZVBhZ2VTaG93OiBmdW5jdGlvbigpIHsKCQkJdGhpcy51cGRhdGVQYWdlUGFkZGluZyggKCAhIXRoaXMucGFnZSApPyB0aGlzLnBhZ2U6ICIudWktcGFnZS1hY3RpdmUiICk7CgkJCWlmICggdGhpcy5vcHRpb25zLnVwZGF0ZVBhZ2VQYWRkaW5nICkgewoJCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7ICJ0aHJvdHRsZWRyZXNpemUiOiAidXBkYXRlUGFnZVBhZGRpbmciIH0gKTsKCQkJfQoJCX0sCgoJCV9oYW5kbGVQYWdlQmVmb3JlSGlkZTogZnVuY3Rpb24oIGUsIHVpICkgewoJCQl2YXIgbyA9IHRoaXMub3B0aW9ucywKCQkJCXRoaXNGb290ZXIsIHRoaXNIZWFkZXIsIG5leHRGb290ZXIsIG5leHRIZWFkZXI7CgoJCQlpZiAoIG8uZGlzYWJsZVBhZ2Vab29tICkgewoJCQkJJC5tb2JpbGUuem9vbS5lbmFibGUoIHRydWUgKTsKCQkJfQoJCQlpZiAoIG8udXBkYXRlUGFnZVBhZGRpbmcgKSB7CgkJCQl0aGlzLl9vZmYoIHRoaXMud2luZG93LCAidGhyb3R0bGVkcmVzaXplIiApOwoJCQl9CgoJCQlpZiAoIG8udHJhY2tQZXJzaXN0ZW50VG9vbGJhcnMgKSB7CgkJCQl0aGlzRm9vdGVyID0gJCggIi51aS1mb290ZXItZml4ZWQ6anFtRGF0YShpZCkiLCB0aGlzLnBhZ2UgKTsKCQkJCXRoaXNIZWFkZXIgPSAkKCAiLnVpLWhlYWRlci1maXhlZDpqcW1EYXRhKGlkKSIsIHRoaXMucGFnZSApOwoJCQkJbmV4dEZvb3RlciA9IHRoaXNGb290ZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktZm9vdGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzRm9vdGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoJCQkJbmV4dEhlYWRlciA9IHRoaXNIZWFkZXIubGVuZ3RoICYmIHVpLm5leHRQYWdlICYmICQoICIudWktaGVhZGVyLWZpeGVkOmpxbURhdGEoaWQ9JyIgKyB0aGlzSGVhZGVyLmpxbURhdGEoICJpZCIgKSArICInKSIsIHVpLm5leHRQYWdlICkgfHwgJCgpOwoKCQkJCWlmICggbmV4dEZvb3Rlci5sZW5ndGggfHwgbmV4dEhlYWRlci5sZW5ndGggKSB7CgoJCQkJCW5leHRGb290ZXIuYWRkKCBuZXh0SGVhZGVyICkuYXBwZW5kVG8oICQubW9iaWxlLnBhZ2VDb250YWluZXIgKTsKCgkJCQkJdWkubmV4dFBhZ2Uub25lKCAicGFnZXNob3ciLCBmdW5jdGlvbigpIHsKCQkJCQkJbmV4dEhlYWRlci5wcmVwZW5kVG8oIHRoaXMgKTsKCQkJCQkJbmV4dEZvb3Rlci5hcHBlbmRUbyggdGhpcyApOwoJCQkJCX0pOwoJCQkJfQoJCQl9CgkJfSwKCgkJX3Zpc2libGU6IHRydWUsCgoJCS8vIFRoaXMgd2lsbCBzZXQgdGhlIGNvbnRlbnQgZWxlbWVudCdzIHRvcCBvciBib3R0b20gcGFkZGluZyBlcXVhbCB0byB0aGUgdG9vbGJhcidzIGhlaWdodAoJCXVwZGF0ZVBhZ2VQYWRkaW5nOiBmdW5jdGlvbiggdGJQYWdlICkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gKCB0aGlzLnJvbGUgPT09ImhlYWRlciIgKSwKCQkJCXBvcyA9IHBhcnNlRmxvYXQoICRlbC5jc3MoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSApOwoKCQkJLy8gVGhpcyBiZWhhdmlvciBvbmx5IGFwcGxpZXMgdG8gImZpeGVkIiwgbm90ICJmdWxsc2NyZWVuIgoJCQlpZiAoIHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuICkgeyByZXR1cm47IH0KCQkJLy8gdGJQYWdlIGFyZ3VtZW50IGNhbiBiZSBhIFBhZ2Ugb2JqZWN0IG9yIGFuIGV2ZW50LCBpZiBjb21pbmcgZnJvbSB0aHJvdHRsZWQgcmVzaXplLgoJCQl0YlBhZ2UgPSAoIHRiUGFnZSAmJiB0YlBhZ2UudHlwZSA9PT0gdW5kZWZpbmVkICYmIHRiUGFnZSApIHx8IHRoaXMucGFnZSB8fCAkZWwuY2xvc2VzdCggIi51aS1wYWdlIiApOwoJCQl0YlBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogIi51aS1wYWdlLWFjdGl2ZSI7CgkJCSQoIHRiUGFnZSApLmNzcyggInBhZGRpbmctIiArICggaGVhZGVyID8gInRvcCIgOiAiYm90dG9tIiApLCAkZWwub3V0ZXJIZWlnaHQoKSArIHBvcyApOwoJCX0sCgoJCV91c2VUcmFuc2l0aW9uOiBmdW5jdGlvbiggbm90cmFuc2l0aW9uICkgewoJCQl2YXIgJHdpbiA9IHRoaXMud2luZG93LAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJc2Nyb2xsID0gJHdpbi5zY3JvbGxUb3AoKSwKCQkJCWVsSGVpZ2h0ID0gJGVsLmhlaWdodCgpLAoJCQkJcEhlaWdodCA9ICggISF0aGlzLnBhZ2UgKT8gJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5oZWlnaHQoKTokKCIudWktcGFnZS1hY3RpdmUiKS5oZWlnaHQoKSwKCQkJCXZpZXdwb3J0SGVpZ2h0ID0gJC5tb2JpbGUuZ2V0U2NyZWVuSGVpZ2h0KCk7CgoJCQlyZXR1cm4gIW5vdHJhbnNpdGlvbiAmJgoJCQkJKCB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAmJiB0aGlzLm9wdGlvbnMudHJhbnNpdGlvbiAhPT0gIm5vbmUiICYmCgkJCQkoCgkJCQkJKCB0aGlzLnJvbGUgPT09ICJoZWFkZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgPiBlbEhlaWdodCApIHx8CgkJCQkJKCB0aGlzLnJvbGUgPT09ICJmb290ZXIiICYmICF0aGlzLm9wdGlvbnMuZnVsbHNjcmVlbiAmJiBzY3JvbGwgKyB2aWV3cG9ydEhlaWdodCA8IHBIZWlnaHQgLSBlbEhlaWdodCApCgkJCQkpIHx8IHRoaXMub3B0aW9ucy5mdWxsc2NyZWVuCgkJCQkpOwoJCX0sCgoJCXNob3c6IGZ1bmN0aW9uKCBub3RyYW5zaXRpb24gKSB7CgkJCXZhciBoaWRlQ2xhc3MgPSAidWktZml4ZWQtaGlkZGVuIiwKCQkJCSRlbCA9IHRoaXMuZWxlbWVudDsKCgkJCWlmICggdGhpcy5fdXNlVHJhbnNpdGlvbiggbm90cmFuc2l0aW9uICkgKSB7CgkJCQkkZWwKCQkJCQkucmVtb3ZlQ2xhc3MoICJvdXQgIiArIGhpZGVDbGFzcyApCgkJCQkJLmFkZENsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24gKCkgewoJCQkJCQkkZWwucmVtb3ZlQ2xhc3MoICJpbiIgKTsKCQkJCQl9KTsKCQkJfQoJCQllbHNlIHsKCQkJCSRlbC5yZW1vdmVDbGFzcyggaGlkZUNsYXNzICk7CgkJCX0KCQkJdGhpcy5fdmlzaWJsZSA9IHRydWU7CgkJfSwKCgkJaGlkZTogZnVuY3Rpb24oIG5vdHJhbnNpdGlvbiApIHsKCQkJdmFyIGhpZGVDbGFzcyA9ICJ1aS1maXhlZC1oaWRkZW4iLAoJCQkJJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJLy8gaWYgaXQncyBhIHNsaWRlIHRyYW5zaXRpb24sIG91ciBuZXcgdHJhbnNpdGlvbnMgbmVlZCB0aGUgcmV2ZXJzZSBjbGFzcyBhcyB3ZWxsIHRvIHNsaWRlIG91dHdhcmQKCQkJCW91dGNsYXNzID0gIm91dCIgKyAoIHRoaXMub3B0aW9ucy50cmFuc2l0aW9uID09PSAic2xpZGUiID8gIiByZXZlcnNlIiA6ICIiICk7CgoJCQlpZiAoIHRoaXMuX3VzZVRyYW5zaXRpb24oIG5vdHJhbnNpdGlvbiApICkgewoJCQkJJGVsCgkJCQkJLmFkZENsYXNzKCBvdXRjbGFzcyApCgkJCQkJLnJlbW92ZUNsYXNzKCAiaW4iICkKCQkJCQkuYW5pbWF0aW9uQ29tcGxldGUoZnVuY3Rpb24oKSB7CgkJCQkJCSRlbC5hZGRDbGFzcyggaGlkZUNsYXNzICkucmVtb3ZlQ2xhc3MoIG91dGNsYXNzICk7CgkJCQkJfSk7CgkJCX0KCQkJZWxzZSB7CgkJCQkkZWwuYWRkQ2xhc3MoIGhpZGVDbGFzcyApLnJlbW92ZUNsYXNzKCBvdXRjbGFzcyApOwoJCQl9CgkJCXRoaXMuX3Zpc2libGUgPSBmYWxzZTsKCQl9LAoKCQl0b2dnbGU6IGZ1bmN0aW9uKCkgewoJCQl0aGlzWyB0aGlzLl92aXNpYmxlID8gImhpZGUiIDogInNob3ciIF0oKTsKCQl9LAoKCQlfYmluZFRvZ2dsZUhhbmRsZXJzOiBmdW5jdGlvbigpIHsKCQkJdmFyIHNlbGYgPSB0aGlzLAoJCQkJbyA9IHNlbGYub3B0aW9ucywKCQkJCWRlbGF5U2hvdywgZGVsYXlIaWRlLAoJCQkJaXNWaXNpYmxlID0gdHJ1ZSwKCQkJCXBhZ2UgPSAoICEhdGhpcy5wYWdlICk/IHRoaXMucGFnZTogJCgiLnVpLXBhZ2UiKTsKCgkJCS8vIHRhcCB0b2dnbGUKCQkJcGFnZQoJCQkJLmJpbmQoICJ2Y2xpY2siLCBmdW5jdGlvbiggZSApIHsKCQkJCQlpZiAoIG8udGFwVG9nZ2xlICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoIG8udGFwVG9nZ2xlQmxhY2tsaXN0ICkubGVuZ3RoICkgewoJCQkJCQlzZWxmLnRvZ2dsZSgpOwoJCQkJCX0KCQkJCX0pCgkJCQkuYmluZCggImZvY3VzaW4gZm9jdXNvdXQiLCBmdW5jdGlvbiggZSApIHsKCQkJCQkvL3RoaXMgaGlkZXMgdGhlIHRvb2xiYXJzIG9uIGEga2V5Ym9hcmQgcG9wIHRvIGdpdmUgbW9yZSBzY3JlZW4gcm9vbSBhbmQgcHJldmVudCBpb3MgYnVnIHdoaWNoCgkJCQkJLy9wb3NpdGlvbnMgZml4ZWQgdG9vbGJhcnMgaW4gdGhlIG1pZGRsZSBvZiB0aGUgc2NyZWVuIG9uIHBvcCBpZiB0aGUgaW5wdXQgaXMgbmVhciB0aGUgdG9wIG9yCgkJCQkJLy9ib3R0b20gb2YgdGhlIHNjcmVlbiBhZGRyZXNzZXMgaXNzdWVzICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCS8vYW5kIGlzc3VlICM0MTEzIEhlYWRlciBhbmQgZm9vdGVyIGNoYW5nZSB0aGVpciBwb3NpdGlvbiBhZnRlciBrZXlib2FyZCBwb3B1cCAtIGlPUwoJCQkJCS8vYW5kIGlzc3VlICM0NDEwIEZvb3RlciBuYXZiYXIgbW92ZXMgdXAgd2hlbiBjbGlja2luZyBvbiBhIHRleHRib3ggaW4gYW4gQW5kcm9pZCBlbnZpcm9ubWVudAoJCQkJCWlmICggc2NyZWVuLndpZHRoIDwgMTAyNSAmJiAkKCBlLnRhcmdldCApLmlzKCBvLmhpZGVEdXJpbmdGb2N1cyApICYmICEkKCBlLnRhcmdldCApLmNsb3Nlc3QoICIudWktaGVhZGVyLWZpeGVkLCAudWktZm9vdGVyLWZpeGVkIiApLmxlbmd0aCApIHsKCQkJCQkJLy9GaXggZm9yIGlzc3VlICM0NzI0IE1vdmluZyB0aHJvdWdoIGZvcm0gaW4gTW9iaWxlIFNhZmFyaSB3aXRoICJOZXh0IiBhbmQgIlByZXZpb3VzIiBzeXN0ZW0KCQkJCQkJLy9jb250cm9scyBjYXVzZXMgZml4ZWQgcG9zaXRpb24sIHRhcC10b2dnbGUgZmFsc2UgSGVhZGVyIHRvIHJldmVhbCBpdHNlbGYKCQkJCQkJLy8gaXNWaXNpYmxlIGluc3RlYWQgb2Ygc2VsZi5fdmlzaWJsZSBiZWNhdXNlIHRoZSBmb2N1c2luIGFuZCBmb2N1c291dCBldmVudHMgZmlyZSB0d2ljZSBhdCB0aGUgc2FtZSB0aW1lCgkJCQkJCS8vIEFsc28gdXNlIGEgZGVsYXkgZm9yIGhpZGluZyB0aGUgdG9vbGJhcnMgYmVjYXVzZSBvbiBBbmRyb2lkIG5hdGl2ZSBicm93c2VyIGZvY3VzaW4gaXMgZGlyZWNsdHkgZm9sbG93ZWQKCQkJCQkJLy8gYnkgYSBmb2N1c291dCB3aGVuIGEgbmF0aXZlIHNlbGVjdHMgb3BlbnMgYW5kIHRoZSBvdGhlciB3YXkgYXJvdW5kIHdoZW4gaXQgY2xvc2VzLgoJCQkJCQlpZiAoIGUudHlwZSA9PT0gImZvY3Vzb3V0IiAmJiAhaXNWaXNpYmxlICkgewoJCQkJCQkJaXNWaXNpYmxlID0gdHJ1ZTsKCQkJCQkJCS8vd2FpdCBmb3IgdGhlIHN0YWNrIHRvIHVud2luZCBhbmQgc2VlIGlmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQKCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlIaWRlICk7CgkJCQkJCQlkZWxheVNob3cgPSBzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCQkJCQlzZWxmLnNob3coKTsKCQkJCQkJCX0sIDAgKTsKCQkJCQkJfSBlbHNlIGlmICggZS50eXBlID09PSAiZm9jdXNpbiIgJiYgISFpc1Zpc2libGUgKSB7CgkJCQkJCQkvL2lmIHdlIGhhdmUganVtcGVkIHRvIGFub3RoZXIgaW5wdXQgY2xlYXIgdGhlIHRpbWUgb3V0IHRvIGNhbmNlbCB0aGUgc2hvdy4KCQkJCQkJCWNsZWFyVGltZW91dCggZGVsYXlTaG93ICk7CgkJCQkJCQlpc1Zpc2libGUgPSBmYWxzZTsKCQkJCQkJCWRlbGF5SGlkZSA9IHNldFRpbWVvdXQoIGZ1bmN0aW9uKCkgewoJCQkJCQkJCXNlbGYuaGlkZSgpOwoJCQkJCQkJfSwgMCApOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSk7CgkJfSwKCgkJX3NldFJlbGF0aXZlOiBmdW5jdGlvbigpIHsKCQkJaWYoIHRoaXMub3B0aW9ucy5wb3NpdGlvbiAhPT0gImZpeGVkIiApewoJCQkJJCggIltkYXRhLSIrICQubW9iaWxlLm5zICsgInJvbGU9J3BhZ2UnXSIgKS5jc3MoeyAicG9zaXRpb24iOiAicmVsYXRpdmUiIH0pOwoJCQl9CgkJfSwKCgkJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCQl2YXIgJGVsID0gdGhpcy5lbGVtZW50LAoJCQkJaGVhZGVyID0gJGVsLmhhc0NsYXNzKCAidWktaGVhZGVyIiApOwoKCQkJJGVsLmNsb3Nlc3QoICIudWktcGFnZSIgKS5jc3MoICJwYWRkaW5nLSIgKyAoIGhlYWRlciA/ICJ0b3AiIDogImJvdHRvbSIgKSwgIiIgKTsKCQkJJGVsLnJlbW92ZUNsYXNzKCAidWktaGVhZGVyLWZpeGVkIHVpLWZvb3Rlci1maXhlZCB1aS1oZWFkZXItZnVsbHNjcmVlbiB1aS1mb290ZXItZnVsbHNjcmVlbiBpbiBvdXQgZmFkZSBzbGlkZWRvd24gc2xpZGV1cCB1aS1maXhlZC1oaWRkZW4iICk7CgkJCSRlbC5jbG9zZXN0KCAiLnVpLXBhZ2UiICkucmVtb3ZlQ2xhc3MoICJ1aS1wYWdlLWhlYWRlci1maXhlZCB1aS1wYWdlLWZvb3Rlci1maXhlZCB1aS1wYWdlLWhlYWRlci1mdWxsc2NyZWVuIHVpLXBhZ2UtZm9vdGVyLWZ1bGxzY3JlZW4iICk7CgkJfQoKCX0pOwp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCSQud2lkZ2V0KCAibW9iaWxlLnRvb2xiYXIiLCAkLm1vYmlsZS50b29sYmFyLCB7CgoJCV9tYWtlRml4ZWQ6IGZ1bmN0aW9uKCkgewoJCQl0aGlzLl9zdXBlcigpOwoJCQl0aGlzLl93b3JrYXJvdW5kcygpOwoJCX0sCgoJCS8vY2hlY2sgdGhlIGJyb3dzZXIgYW5kIHZlcnNpb24gYW5kIHJ1biBuZWVkZWQgd29ya2Fyb3VuZHMKCQlfd29ya2Fyb3VuZHM6IGZ1bmN0aW9uKCkgewoJCQl2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LAoJCQlwbGF0Zm9ybSA9IG5hdmlnYXRvci5wbGF0Zm9ybSwKCQkJLy8gUmVuZGVyaW5nIGVuZ2luZSBpcyBXZWJraXQsIGFuZCBjYXB0dXJlIG1ham9yIHZlcnNpb24KCQkJd2ttYXRjaCA9IHVhLm1hdGNoKCAvQXBwbGVXZWJLaXRcLyhbMC05XSspLyApLAoJCQl3a3ZlcnNpb24gPSAhIXdrbWF0Y2ggJiYgd2ttYXRjaFsgMSBdLAoJCQlvcyA9IG51bGwsCgkJCXNlbGYgPSB0aGlzOwoJCQkvL3NldCB0aGUgb3Mgd2UgYXJlIHdvcmtpbmcgaW4gaWYgaXQgZG9zZW50IG1hdGNoIG9uZSB3aXRoIHdvcmthcm91bmRzIHJldHVybgoJCQlpZiAoIHBsYXRmb3JtLmluZGV4T2YoICJpUGhvbmUiICkgPiAtMSB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBhZCIgKSA+IC0xICB8fCBwbGF0Zm9ybS5pbmRleE9mKCAiaVBvZCIgKSA+IC0xICkgewoJCQkJb3MgPSAiaW9zIjsKCQkJfSBlbHNlIGlmICggdWEuaW5kZXhPZiggIkFuZHJvaWQiICkgPiAtMSApIHsKCQkJCW9zID0gImFuZHJvaWQiOwoJCQl9IGVsc2UgewoJCQkJcmV0dXJuOwoJCQl9CgkJCS8vY2hlY2sgb3MgdmVyc2lvbiBpZiBpdCBkb3NlbnQgbWF0Y2ggb25lIHdpdGggd29ya2Fyb3VuZHMgcmV0dXJuCgkJCWlmICggb3MgPT09ICJpb3MiICkgewoJCQkJLy9pT1MgIHdvcmthcm91bmRzCgkJCQlzZWxmLl9iaW5kU2Nyb2xsV29ya2Fyb3VuZCgpOwoJCQl9IGVsc2UgaWYgKCBvcyA9PT0gImFuZHJvaWQiICYmIHdrdmVyc2lvbiAmJiB3a3ZlcnNpb24gPCA1MzQgKSB7CgkJCQkvL0FuZHJvaWQgMi4zIHJ1biBhbGwgQW5kcm9pZCAyLjMgd29ya2Fyb3VuZAoJCQkJc2VsZi5fYmluZFNjcm9sbFdvcmthcm91bmQoKTsKCQkJCXNlbGYuX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kKCk7CgkJCX0gZWxzZSB7CgkJCQlyZXR1cm47CgkJCX0KCQl9LAoKCQkvL1V0aWxpdHkgY2xhc3MgZm9yIGNoZWNraW5nIGhlYWRlciBhbmQgZm9vdGVyIHBvc2l0aW9ucyByZWxhdGl2ZSB0byB2aWV3cG9ydAoJCV92aWV3cG9ydE9mZnNldDogZnVuY3Rpb24oKSB7CgkJCXZhciAkZWwgPSB0aGlzLmVsZW1lbnQsCgkJCQloZWFkZXIgPSAkZWwuaGFzQ2xhc3MoICJ1aS1oZWFkZXIiICksCgkJCQlvZmZzZXQgPSBNYXRoLmFicyggJGVsLm9mZnNldCgpLnRvcCAtIHRoaXMud2luZG93LnNjcm9sbFRvcCgpICk7CgkJCWlmICggIWhlYWRlciApIHsKCQkJCW9mZnNldCA9IE1hdGgucm91bmQoIG9mZnNldCAtIHRoaXMud2luZG93LmhlaWdodCgpICsgJGVsLm91dGVySGVpZ2h0KCkgKSAtIDYwOwoJCQl9CgkJCXJldHVybiBvZmZzZXQ7CgkJfSwKCgkJLy9iaW5kIGV2ZW50cyBmb3IgX3RyaWdnZXJSZWRyYXcoKSBmdW5jdGlvbgoJCV9iaW5kU2Nyb2xsV29ya2Fyb3VuZDogZnVuY3Rpb24oKSB7CgkJCXZhciBzZWxmID0gdGhpczsKCQkJLy9iaW5kIHRvIHNjcm9sbHN0b3AgYW5kIGNoZWNrIGlmIHRoZSB0b29sYmFycyBhcmUgY29ycmVjdGx5IHBvc2l0aW9uZWQKCQkJdGhpcy5fb24oIHRoaXMud2luZG93LCB7IHNjcm9sbHN0b3A6IGZ1bmN0aW9uKCkgewoJCQkJdmFyIHZpZXdwb3J0T2Zmc2V0ID0gc2VsZi5fdmlld3BvcnRPZmZzZXQoKTsKCQkJCS8vY2hlY2sgaWYgdGhlIGhlYWRlciBpcyB2aXNpYmxlIGFuZCBpZiBpdHMgaW4gdGhlIHJpZ2h0IHBsYWNlCgkJCQlpZiAoIHZpZXdwb3J0T2Zmc2V0ID4gMiAmJiBzZWxmLl92aXNpYmxlICkgewoJCQkJCXNlbGYuX3RyaWdnZXJSZWRyYXcoKTsKCQkJCX0KCQkJfX0pOwoJCX0sCgoJCS8vdGhpcyBhZGRyZXNzZXMgaXNzdWUgIzQyNTAgUGVyc2lzdGVudCBmb290ZXIgaW5zdGFiaWxpdHkgaW4gdjEuMSB3aXRoIGxvbmcgc2VsZWN0IGxpc3RzIGluIEFuZHJvaWQgMi4zLjMKCQkvL2FuZCBpc3N1ZSAjMzc0OCBBbmRyb2lkIDIueDogUGFnZSB0cmFuc2l0aW9ucyBicm9rZW4gd2hlbiBmaXhlZCB0b29sYmFycyB1c2VkCgkJLy90aGUgYWJzb2x1dGVseSBwb3NpdGlvbmVkIHRodW1ibmFpbCBpbiBhIGxpc3QgdmlldyBjYXVzZXMgcHJvYmxlbXMgd2l0aCBmaXhlZCBwb3NpdGlvbiBidXR0b25zIGFib3ZlIGluIGEgbmF2IGJhcgoJCS8vc2V0dGluZyB0aGUgbGkncyB0byAtd2Via2l0LXRyYW5zZm9ybTp0cmFuc2xhdGUzZCgwLDAsMCk7IHNvbHZlcyB0aGlzIHByb2JsZW0gdG8gYXZvaWRlIHBvdGVudGlhbCBpc3N1ZXMgaW4gb3RoZXIKCQkvL3BsYXRmb3JtcyB3ZSBzY29wZSB0aGlzIHdpdGggdGhlIGNsYXNzIHVpLWFuZHJvaWQtMngtZml4CgkJX2JpbmRMaXN0VGh1bWJXb3JrYXJvdW5kOiBmdW5jdGlvbigpIHsKCQkJdGhpcy5lbGVtZW50LmNsb3Nlc3QoICIudWktcGFnZSIgKS5hZGRDbGFzcyggInVpLWFuZHJvaWQtMngtZml4ZWQiICk7CgkJfSwKCQkvL3RoaXMgYWRkcmVzc2VzIGlzc3VlcyAjNDMzNyBGaXhlZCBoZWFkZXIgcHJvYmxlbSBhZnRlciBzY3JvbGxpbmcgY29udGVudCBvbiBpT1MgYW5kIEFuZHJvaWQKCQkvL2FuZCBkZXZpY2UgYnVncyBwcm9qZWN0IGlzc3VlICMxIEZvcm0gZWxlbWVudHMgY2FuIGxvc2UgY2xpY2sgaGl0IGFyZWEgaW4gcG9zaXRpb246IGZpeGVkIGNvbnRhaW5lcnMuCgkJLy90aGlzIGFsc28gYWRkcmVzc2VzIG5vdCBvbiBmaXhlZCB0b29sYmFycyBwYWdlIGluIGRvY3MKCQkvL2FkZGluZyAxcHggb2YgcGFkZGluZyB0byB0aGUgYm90dG9tIHRoZW4gcmVtb3ZpbmcgaXQgY2F1c2VzIGEgInJlZHJhdyIKCQkvL3doaWNoIHBvc2l0aW9ucyB0aGUgdG9vbGJhcnMgY29ycmVjdGx5ICh0aGV5IHdpbGwgYWx3YXlzIGJlIHZpc3VhbGx5IGNvcnJlY3QpCgkJX3RyaWdnZXJSZWRyYXc6IGZ1bmN0aW9uKCkgewoJCQl2YXIgcGFkZGluZ0JvdHRvbSA9IHBhcnNlRmxvYXQoICQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iICkgKTsKCQkJLy90cmlnZ2VyIHBhZ2UgcmVkcmF3IHRvIGZpeCBpbmNvcnJlY3RseSBwb3NpdGlvbmVkIGZpeGVkIGVsZW1lbnRzCgkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCAoIHBhZGRpbmdCb3R0b20gKyAxICkgKyAicHgiICk7CgkJCS8vaWYgdGhlIHBhZGRpbmcgaXMgcmVzZXQgd2l0aCBvdXQgYSB0aW1lb3V0IHRoZSByZXBvc2l0aW9uIHdpbGwgbm90IG9jY3VyZS4KCQkJLy90aGlzIGlzIGluZGVwZW5kYW50IG9mIEpRTSB0aGUgYnJvd3NlciBzZWVtcyB0byBuZWVkIHRoZSB0aW1lIHRvIHJlYWN0LgoJCQlzZXRUaW1lb3V0KCBmdW5jdGlvbigpIHsKCQkJCSQoICIudWktcGFnZS1hY3RpdmUiICkuY3NzKCAicGFkZGluZy1ib3R0b20iLCBwYWRkaW5nQm90dG9tICsgInB4IiApOwoJCQl9LCAwICk7CgkJfSwKCgkJZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJCXRoaXMuX3N1cGVyKCk7CgkJCS8vUmVtb3ZlIHRoZSBjbGFzcyB3ZSBhZGRlZCB0byB0aGUgcGFnZSBwcmV2aW91c2x5IGluIGFuZHJvaWQgMi54CgkJCXRoaXMuZWxlbWVudC5jbG9zZXN0KCAiLnVpLXBhZ2UtYWN0aXZlIiApLnJlbW92ZUNsYXNzKCAidWktYW5kcm9pZC0yeC1maXgiICk7CgkJfQoJfSk7Cgp9KSggalF1ZXJ5ICk7CgoKKCBmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIGllSGFjayA9ICggJC5tb2JpbGUuYnJvd3Nlci5vbGRJRSAmJiAkLm1vYmlsZS5icm93c2VyLm9sZElFIDw9IDggKSwKCXVpVGVtcGxhdGUgPSAkKAoJCSI8ZGl2IGNsYXNzPSd1aS1wb3B1cC1hcnJvdy1ndWlkZSc+PC9kaXY+IiArCgkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWNvbnRhaW5lciIgKyAoIGllSGFjayA/ICIgaWUiIDogIiIgKSArICInPiIgKwoJCQkiPGRpdiBjbGFzcz0ndWktcG9wdXAtYXJyb3cnPiIgKwoJCQkJIjxkaXYgY2xhc3M9J3VpLXBvcHVwLWFycm93LWJhY2tncm91bmQnPjwvZGl2PiIgKwoJCQkiPC9kaXY+IiArCgkJIjwvZGl2PiIKCSksCgkvLyBOZWVkZWQgZm9yIHRyYW5zZm9ybWluZyBjb29yZGluYXRlcyBmcm9tIHNjcmVlbiB0byBhcnJvdyBiYWNrZ3JvdW5kCgl0eEZhY3RvciA9IE1hdGguc3FydCggMiApIC8gMjsKCmZ1bmN0aW9uIGdldEFycm93KCkgewoJdmFyIGNsb25lID0gdWlUZW1wbGF0ZS5jbG9uZSgpLAoJCWdkID0gY2xvbmUuZXEoIDAgKSwKCQljdCA9IGNsb25lLmVxKCAxICksCgkJYXIgPSBjdC5jaGlsZHJlbigpLAoJCWJnID0gYXIuY2hpbGRyZW4oKTsKCglyZXR1cm4geyBhckVsczogY3QuYWRkKCBnZCApLCBnZDogZ2QsIGN0OiBjdCwgYXI6IGFyLCBiZzogYmcgfTsKfQoKJC53aWRnZXQoICJtb2JpbGUucG9wdXAiLCAkLm1vYmlsZS5wb3B1cCwgewoJb3B0aW9uczogewoKCQlhcnJvdzogIiIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyLAoJCQlyZXQgPSB0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5hcnJvdyApIHsKCQkJdGhpcy5fdWkuYXJyb3cgPSBhciA9IHRoaXMuX2FkZEFycm93KCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfYWRkQXJyb3c6IGZ1bmN0aW9uKCkgewoJCXZhciB0aGVtZSwKCQkJb3B0cyA9IHRoaXMub3B0aW9ucywKCQkJYXIgPSBnZXRBcnJvdygpOwoKCQl0aGVtZSA9IHRoaXMuX3RoZW1lQ2xhc3NGcm9tT3B0aW9uKCAidWktYm9keS0iLCBvcHRzLnRoZW1lICk7CgkJYXIuYXIuYWRkQ2xhc3MoIHRoZW1lICsgKCBvcHRzLnNoYWRvdyA/ICIgdWktb3ZlcmxheS1zaGFkb3ciIDogIiIgKSApOwoJCWFyLmJnLmFkZENsYXNzKCB0aGVtZSApOwoJCWFyLmFyRWxzLmhpZGUoKS5hcHBlbmRUbyggdGhpcy5lbGVtZW50ICk7CgoJCXJldHVybiBhcjsKCX0sCgoJX3VuZW5oYW5jZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9LAoKCS8vIFByZXRlbmQgdG8gc2hvdyBhbiBhcnJvdyBkZXNjcmliZWQgYnkgQHAgYW5kIEBkaXIgYW5kIGNhbGN1bGF0ZSB0aGUKCS8vIGRpc3RhbmNlIGZyb20gdGhlIGRlc2lyZWQgcG9pbnQuIElmIGEgYmVzdC1kaXN0YW5jZSBpcyBwYXNzZWQgaW4sIHJldHVybgoJLy8gdGhlIG1pbmltdW0gb2YgdGhlIG9uZSBwYXNzZWQgaW4gYW5kIHRoZSBvbmUgY2FsY3VsYXRlZC4KCV90cnlBbkFycm93OiBmdW5jdGlvbiggcCwgZGlyLCBkZXNpcmVkLCBzLCBiZXN0ICkgewoJCXZhciByZXN1bHQsIHIsIGRpZmYsIGRlc2lyZWRGb3JBcnJvdyA9IHt9LCB0aXAgPSB7fTsKCgkJLy8gSWYgdGhlIGFycm93IGhhcyBubyB3aWdnbGUgcm9vbSBhbG9uZyB0aGUgZWRnZSBvZiB0aGUgcG9wdXAsIGl0IGNhbm5vdAoJCS8vIGJlIGRpc3BsYXllZCBhbG9uZyB0aGUgcmVxdWVzdGVkIGVkZ2Ugd2l0aG91dCBpdCBzdGlja2luZyBvdXQuCgkJaWYgKCBzLmFyRnVsbFsgcC5kaW1LZXkgXSA+IHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdICkgewoJCQlyZXR1cm4gYmVzdDsKCQl9CgoJCWRlc2lyZWRGb3JBcnJvd1sgcC5mc3QgXSA9IGRlc2lyZWRbIHAuZnN0IF0gKwoJCQkoIHMuYXJIYWxmWyBwLm9EaW1LZXkgXSArIHMubWVudUhhbGZbIHAub0RpbUtleSBdICkgKiBwLm9mZnNldEZhY3RvciAtCgkJCXMuY29udGVudEJveFsgcC5mc3QgXSArICggcy5jbGFtcEluZm8ubWVudVNpemVbIHAub0RpbUtleSBdIC0gcy5jb250ZW50Qm94WyBwLm9EaW1LZXkgXSApICogcC5hcnJvd09mZnNldEZhY3RvcjsKCQlkZXNpcmVkRm9yQXJyb3dbIHAuc25kIF0gPSBkZXNpcmVkWyBwLnNuZCBdOwoKCQlyZXN1bHQgPSBzLnJlc3VsdCB8fCB0aGlzLl9jYWxjdWxhdGVGaW5hbExvY2F0aW9uKCBkZXNpcmVkRm9yQXJyb3csIHMuY2xhbXBJbmZvICk7CgkJciA9IHsgeDogcmVzdWx0LmxlZnQsIHk6IHJlc3VsdC50b3AgfTsKCgkJdGlwWyBwLmZzdCBdID0gclsgcC5mc3QgXSArIHMuY29udGVudEJveFsgcC5mc3QgXSArIHAudGlwT2Zmc2V0OwoJCXRpcFsgcC5zbmQgXSA9IE1hdGgubWF4KCByZXN1bHRbIHAucHJvcCBdICsgcy5ndWlkZU9mZnNldFsgcC5wcm9wIF0gKyBzLmFySGFsZlsgcC5kaW1LZXkgXSwKCQkJTWF0aC5taW4oIHJlc3VsdFsgcC5wcm9wIF0gKyBzLmd1aWRlT2Zmc2V0WyBwLnByb3AgXSArIHMuZ3VpZGVEaW1zWyBwLmRpbUtleSBdIC0gcy5hckhhbGZbIHAuZGltS2V5IF0sCgkJCQlkZXNpcmVkWyBwLnNuZCBdICkgKTsKCgkJZGlmZiA9IE1hdGguYWJzKCBkZXNpcmVkLnggLSB0aXAueCApICsgTWF0aC5hYnMoIGRlc2lyZWQueSAtIHRpcC55ICk7CgkJaWYgKCAhYmVzdCB8fCBkaWZmIDwgYmVzdC5kaWZmICkgewoJCQkvLyBDb252ZXJ0IHRpcCBvZmZzZXQgdG8gY29vcmRpbmF0ZXMgaW5zaWRlIHRoZSBwb3B1cAoJCQl0aXBbIHAuc25kIF0gLT0gcy5hckhhbGZbIHAuZGltS2V5IF0gKyByZXN1bHRbIHAucHJvcCBdICsgcy5jb250ZW50Qm94WyBwLnNuZCBdOwoJCQliZXN0ID0geyBkaXI6IGRpciwgZGlmZjogZGlmZiwgcmVzdWx0OiByZXN1bHQsIHBvc1Byb3A6IHAucHJvcCwgcG9zVmFsOiB0aXBbIHAuc25kIF0gfTsKCQl9CgoJCXJldHVybiBiZXN0OwoJfSwKCglfZ2V0UGxhY2VtZW50U3RhdGU6IGZ1bmN0aW9uKCBjbGFtcCApIHsKCQl2YXIgb2Zmc2V0LCBnZE9mZnNldCwKCQkJYXIgPSB0aGlzLl91aS5hcnJvdywKCQkJc3RhdGUgPSB7CgkJCQljbGFtcEluZm86IHRoaXMuX2NsYW1wUG9wdXBXaWR0aCggIWNsYW1wICksCgkJCQlhckZ1bGw6IHsgY3g6IGFyLmN0LndpZHRoKCksIGN5OiBhci5jdC5oZWlnaHQoKSB9LAoJCQkJZ3VpZGVEaW1zOiB7IGN4OiBhci5nZC53aWR0aCgpLCBjeTogYXIuZ2QuaGVpZ2h0KCkgfSwKCQkJCWd1aWRlT2Zmc2V0OiBhci5nZC5vZmZzZXQoKQoJCQl9OwoKCQlvZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgoJCWFyLmdkLmNzcyggeyBsZWZ0OiAwLCB0b3A6IDAsIHJpZ2h0OiAwLCBib3R0b206IDAgfSApOwoJCWdkT2Zmc2V0ID0gYXIuZ2Qub2Zmc2V0KCk7CgkJc3RhdGUuY29udGVudEJveCA9IHsKCQkJeDogZ2RPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LAoJCQl5OiBnZE9mZnNldC50b3AgLSBvZmZzZXQudG9wLAoJCQljeDogYXIuZ2Qud2lkdGgoKSwKCQkJY3k6IGFyLmdkLmhlaWdodCgpCgkJfTsKCQlhci5nZC5yZW1vdmVBdHRyKCAic3R5bGUiICk7CgoJCS8vIFRoZSBhcnJvdyBib3ggbW92ZXMgYmV0d2VlbiBndWlkZU9mZnNldCBhbmQgZ3VpZGVPZmZzZXQgKyBndWlkZURpbXMgLSBhckZ1bGwKCQlzdGF0ZS5ndWlkZU9mZnNldCA9IHsgbGVmdDogc3RhdGUuZ3VpZGVPZmZzZXQubGVmdCAtIG9mZnNldC5sZWZ0LCB0b3A6IHN0YXRlLmd1aWRlT2Zmc2V0LnRvcCAtIG9mZnNldC50b3AgfTsKCQlzdGF0ZS5hckhhbGYgPSB7IGN4OiBzdGF0ZS5hckZ1bGwuY3ggLyAyLCBjeTogc3RhdGUuYXJGdWxsLmN5IC8gMiB9OwoJCXN0YXRlLm1lbnVIYWxmID0geyBjeDogc3RhdGUuY2xhbXBJbmZvLm1lbnVTaXplLmN4IC8gMiwgY3k6IHN0YXRlLmNsYW1wSW5mby5tZW51U2l6ZS5jeSAvIDIgfTsKCgkJcmV0dXJuIHN0YXRlOwoJfSwKCglfcGxhY2VtZW50Q29vcmRzOiBmdW5jdGlvbiggZGVzaXJlZCApIHsKCQl2YXIgc3RhdGUsIGJlc3QsIHBhcmFtcywgYmdPZmZzZXQsIGVsT2Zmc2V0LCBkaWZmLCBiZ1JlZiwKCQkJb3B0aW9uVmFsdWUgPSB0aGlzLm9wdGlvbnMuYXJyb3csCgkJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggIWFyICkgewoJCQlyZXR1cm4gdGhpcy5fc3VwZXIoIGRlc2lyZWQgKTsKCQl9CgoJCWFyLmFyRWxzLnNob3coKTsKCgkJYmdSZWYgPSB7fTsKCQlzdGF0ZSA9IHRoaXMuX2dldFBsYWNlbWVudFN0YXRlKCB0cnVlICk7CgkJcGFyYW1zID0gewoJCQkibCI6IHsgZnN0OiAieCIsIHNuZDogInkiLCBwcm9wOiAidG9wIiwgZGltS2V5OiAiY3kiLCBvRGltS2V5OiAiY3giLCBvZmZzZXRGYWN0b3I6IDEsIHRpcE9mZnNldDogIC1zdGF0ZS5hckhhbGYuY3gsIGFycm93T2Zmc2V0RmFjdG9yOiAwIH0sCgkJCSJyIjogeyBmc3Q6ICJ4Iiwgc25kOiAieSIsIHByb3A6ICJ0b3AiLCBkaW1LZXk6ICJjeSIsIG9EaW1LZXk6ICJjeCIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN4ICsgc3RhdGUuY29udGVudEJveC5jeCwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJImIiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogLTEsIHRpcE9mZnNldDogc3RhdGUuYXJIYWxmLmN5ICsgc3RhdGUuY29udGVudEJveC5jeSwgYXJyb3dPZmZzZXRGYWN0b3I6IDEgfSwKCQkJInQiOiB7IGZzdDogInkiLCBzbmQ6ICJ4IiwgcHJvcDogImxlZnQiLCBkaW1LZXk6ICJjeCIsIG9EaW1LZXk6ICJjeSIsIG9mZnNldEZhY3RvcjogMSwgdGlwT2Zmc2V0OiAtc3RhdGUuYXJIYWxmLmN5LCBhcnJvd09mZnNldEZhY3RvcjogMCB9CgkJfTsKCgkJLy8gVHJ5IGVhY2ggc2lkZSBzcGVjaWZpZWQgaW4gdGhlIG9wdGlvbnMgdG8gc2VlIG9uIHdoaWNoIG9uZSB0aGUgYXJyb3cKCQkvLyBzaG91bGQgYmUgcGxhY2VkIHN1Y2ggdGhhdCB0aGUgZGlzdGFuY2UgYmV0d2VlbiB0aGUgdGlwIG9mIHRoZSBhcnJvdyBhbmQKCQkvLyB0aGUgZGVzaXJlZCBjb29yZGluYXRlcyBpcyB0aGUgc2hvcnRlc3QuCgkJJC5lYWNoKCAoIG9wdGlvblZhbHVlID09PSB0cnVlID8gImwsdCxyLGIiIDogb3B0aW9uVmFsdWUgKS5zcGxpdCggIiwiICksCgkJCSQucHJveHkoIGZ1bmN0aW9uKCBrZXksIHZhbHVlICkgewoJCQkJYmVzdCA9IHRoaXMuX3RyeUFuQXJyb3coIHBhcmFtc1sgdmFsdWUgXSwgdmFsdWUsIGRlc2lyZWQsIHN0YXRlLCBiZXN0ICk7CgkJCX0sIHRoaXMgKSApOwoKCQkvLyBDb3VsZCBub3QgcGxhY2UgdGhlIGFycm93IGFsb25nIGFueSBvZiB0aGUgZWRnZXMgLSBiZWhhdmUgYXMgaWYgc2hvd2luZwoJCS8vIHRoZSBhcnJvdyB3YXMgdHVybmVkIG9mZi4KCQlpZiAoICFiZXN0ICkgewoJCQlhci5hckVscy5oaWRlKCk7CgkJCXJldHVybiB0aGlzLl9zdXBlciggZGVzaXJlZCApOwoJCX0KCgkJLy8gTW92ZSB0aGUgYXJyb3cgaW50byBwbGFjZQoJCWFyLmN0CgkJCS5yZW1vdmVDbGFzcyggInVpLXBvcHVwLWFycm93LWwgdWktcG9wdXAtYXJyb3ctdCB1aS1wb3B1cC1hcnJvdy1yIHVpLXBvcHVwLWFycm93LWIiICkKCQkJLmFkZENsYXNzKCAidWktcG9wdXAtYXJyb3ctIiArIGJlc3QuZGlyICkKCQkJLnJlbW92ZUF0dHIoICJzdHlsZSIgKS5jc3MoIGJlc3QucG9zUHJvcCwgYmVzdC5wb3NWYWwgKQoJCQkuc2hvdygpOwoKCQkvLyBEbyBub3QgbW92ZS9zaXplIHRoZSBiYWNrZ3JvdW5kIGRpdiBvbiBJRSwgYmVjYXVzZSB3ZSB1c2UgdGhlIGFycm93IGRpdiBmb3IgYmFja2dyb3VuZCBhcyB3ZWxsLgoJCWlmICggIWllSGFjayApIHsKCQkJZWxPZmZzZXQgPSB0aGlzLmVsZW1lbnQub2Zmc2V0KCk7CgkJCWJnUmVmWyBwYXJhbXNbIGJlc3QuZGlyIF0uZnN0IF0gPSBhci5jdC5vZmZzZXQoKTsKCQkJYmdSZWZbIHBhcmFtc1sgYmVzdC5kaXIgXS5zbmQgXSA9IHsKCQkJCWxlZnQ6IGVsT2Zmc2V0LmxlZnQgKyBzdGF0ZS5jb250ZW50Qm94LngsCgkJCQl0b3A6IGVsT2Zmc2V0LnRvcCArIHN0YXRlLmNvbnRlbnRCb3gueQoJCQl9OwoJCQliZ09mZnNldCA9IGFyLmJnCgkJCQkucmVtb3ZlQXR0ciggInN0eWxlIiApCgkJCQkuY3NzKCAoICJjeCIgPT09IHBhcmFtc1sgYmVzdC5kaXIgXS5kaW1LZXkgPyAid2lkdGgiIDogImhlaWdodCIgKSwgc3RhdGUuY29udGVudEJveFsgcGFyYW1zWyBiZXN0LmRpciBdLmRpbUtleSBdICkKCQkJCS5vZmZzZXQoKTsKCQkJZGlmZiA9IHsgZHg6IGJnUmVmLngubGVmdCAtIGJnT2Zmc2V0LmxlZnQsIGR5OiBiZ1JlZi55LnRvcCAtIGJnT2Zmc2V0LnRvcCB9OwoJCQlhci5iZy5jc3MoIHsgbGVmdDogdHhGYWN0b3IgKiBkaWZmLmR5ICsgdHhGYWN0b3IgKiBkaWZmLmR4LCB0b3A6IHR4RmFjdG9yICogZGlmZi5keSAtIHR4RmFjdG9yICogZGlmZi5keCB9ICk7CgkJfQoKCQlyZXR1cm4gYmVzdC5yZXN1bHQ7Cgl9LAoKCV9zZXRPcHRpb25zOiBmdW5jdGlvbiggb3B0cyApIHsKCQl2YXIgbmV3VGhlbWUsCgkJCW9sZFRoZW1lID0gdGhpcy5vcHRpb25zLnRoZW1lLAoJCQlhciA9IHRoaXMuX3VpLmFycm93LAoJCQlyZXQgPSB0aGlzLl9zdXBlciggb3B0cyApOwoKCQlpZiAoIG9wdHMuYXJyb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJaWYgKCAhYXIgJiYgb3B0cy5hcnJvdyApIHsKCQkJCXRoaXMuX3VpLmFycm93ID0gdGhpcy5fYWRkQXJyb3coKTsKCgkJCQkvLyBJbXBvcnRhbnQgdG8gcmV0dXJuIGhlcmUgc28gd2UgZG9uJ3Qgc2V0IHRoZSBzYW1lIG9wdGlvbnMgYWxsIG92ZXIKCQkJCS8vIGFnYWluIGJlbG93LgoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKCBhciAmJiAhb3B0cy5hcnJvdyApIHsKCQkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCQkJdGhpcy5fdWkuYXJyb3cgPSBudWxsOwoJCQl9CgkJfQoKCQkvLyBSZWFzc2lnbiB3aXRoIHBvdGVudGlhbGx5IG5ldyBhcnJvdwoJCWFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWlmICggb3B0cy50aGVtZSAhPT0gdW5kZWZpbmVkICkgewoJCQkJb2xkVGhlbWUgPSB0aGlzLl90aGVtZUNsYXNzRnJvbU9wdGlvbiggInVpLWJvZHktIiwgb2xkVGhlbWUgKTsKCQkJCW5ld1RoZW1lID0gdGhpcy5fdGhlbWVDbGFzc0Zyb21PcHRpb24oICJ1aS1ib2R5LSIsIG9wdHMudGhlbWUgKTsKCQkJCWFyLmFyLnJlbW92ZUNsYXNzKCBvbGRUaGVtZSApLmFkZENsYXNzKCBuZXdUaGVtZSApOwoJCQkJYXIuYmcucmVtb3ZlQ2xhc3MoIG9sZFRoZW1lICkuYWRkQ2xhc3MoIG5ld1RoZW1lICk7CgkJCX0KCgkJCWlmICggb3B0cy5zaGFkb3cgIT09IHVuZGVmaW5lZCApIHsKCQkJCWFyLmFyLnRvZ2dsZUNsYXNzKCAidWktb3ZlcmxheS1zaGFkb3ciLCBvcHRzLnNoYWRvdyApOwoJCQl9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJdmFyIGFyID0gdGhpcy5fdWkuYXJyb3c7CgoJCWlmICggYXIgKSB7CgkJCWFyLmFyRWxzLnJlbW92ZSgpOwoJCX0KCgkJcmV0dXJuIHRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUucGFuZWwiLCB7CglvcHRpb25zOiB7CgkJY2xhc3NlczogewoJCQlwYW5lbDogInVpLXBhbmVsIiwKCQkJcGFuZWxPcGVuOiAidWktcGFuZWwtb3BlbiIsCgkJCXBhbmVsQ2xvc2VkOiAidWktcGFuZWwtY2xvc2VkIiwKCQkJcGFuZWxGaXhlZDogInVpLXBhbmVsLWZpeGVkIiwKCQkJcGFuZWxJbm5lcjogInVpLXBhbmVsLWlubmVyIiwKCQkJbW9kYWw6ICJ1aS1wYW5lbC1kaXNtaXNzIiwKCQkJbW9kYWxPcGVuOiAidWktcGFuZWwtZGlzbWlzcy1vcGVuIiwKCQkJcGFnZUNvbnRhaW5lcjogInVpLXBhbmVsLXBhZ2UtY29udGFpbmVyIiwKCQkJcGFnZVdyYXBwZXI6ICJ1aS1wYW5lbC13cmFwcGVyIiwKCQkJcGFnZUZpeGVkVG9vbGJhcjogInVpLXBhbmVsLWZpeGVkLXRvb2xiYXIiLAoJCQlwYWdlQ29udGVudFByZWZpeDogInVpLXBhbmVsLXBhZ2UtY29udGVudCIsIC8qIFVzZWQgZm9yIHdyYXBwZXIgYW5kIGZpeGVkIHRvb2xiYXJzIHBvc2l0aW9uLCBkaXNwbGF5IGFuZCBvcGVuIGNsYXNzZXMuICovCgkJCWFuaW1hdGU6ICJ1aS1wYW5lbC1hbmltYXRlIgoJCX0sCgkJYW5pbWF0ZTogdHJ1ZSwKCQl0aGVtZTogbnVsbCwKCQlwb3NpdGlvbjogImxlZnQiLAoJCWRpc21pc3NpYmxlOiB0cnVlLAoJCWRpc3BsYXk6ICJyZXZlYWwiLCAvL2FjY2VwdHMgcmV2ZWFsLCBwdXNoLCBvdmVybGF5CgkJc3dpcGVDbG9zZTogdHJ1ZSwKCQlwb3NpdGlvbkZpeGVkOiBmYWxzZQoJfSwKCglfcGFuZWxJRDogbnVsbCwKCV9jbG9zZUxpbms6IG51bGwsCglfcGFyZW50UGFnZTogbnVsbCwKCV9wYWdlOiBudWxsLAoJX21vZGFsOiBudWxsLAoJX3BhbmVsSW5uZXI6IG51bGwsCglfd3JhcHBlcjogbnVsbCwKCV9maXhlZFRvb2xiYXJzOiBudWxsLAoKCV9jcmVhdGU6IGZ1bmN0aW9uKCkgewoJCXZhciBlbCA9IHRoaXMuZWxlbWVudCwKCQkJcGFyZW50UGFnZSA9IGVsLmNsb3Nlc3QoICI6anFtRGF0YShyb2xlPSdwYWdlJykiICk7CgoJCS8vIGV4cG9zZSBzb21lIHByaXZhdGUgcHJvcHMgdG8gb3RoZXIgbWV0aG9kcwoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9wYW5lbElEOiBlbC5hdHRyKCAiaWQiICksCgkJCV9jbG9zZUxpbms6IGVsLmZpbmQoICI6anFtRGF0YShyZWw9J2Nsb3NlJykiICksCgkJCV9wYXJlbnRQYWdlOiAoIHBhcmVudFBhZ2UubGVuZ3RoID4gMCApID8gcGFyZW50UGFnZSA6IGZhbHNlLAoJCQlfcGFnZTogdGhpcy5fZ2V0UGFnZSwKCQkJX3BhbmVsSW5uZXI6IHRoaXMuX2dldFBhbmVsSW5uZXIoKSwKCQkJX3dyYXBwZXI6IHRoaXMuX2dldFdyYXBwZXIsCgkJCV9maXhlZFRvb2xiYXJzOiB0aGlzLl9nZXRGaXhlZFRvb2xiYXJzCgkJfSk7CgoJCXRoaXMuX2FkZFBhbmVsQ2xhc3NlcygpOwoKCQkvLyBpZiBhbmltYXRpbmcsIGFkZCB0aGUgY2xhc3MgdG8gZG8gc28KCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIXRoaXMub3B0aW9ucy5hbmltYXRlICkgewoJCQl0aGlzLmVsZW1lbnQuYWRkQ2xhc3MoIHRoaXMub3B0aW9ucy5jbGFzc2VzLmFuaW1hdGUgKTsKCQl9CgoJCXRoaXMuX2JpbmRVcGRhdGVMYXlvdXQoKTsKCQl0aGlzLl9iaW5kQ2xvc2VFdmVudHMoKTsKCQl0aGlzLl9iaW5kTGlua0xpc3RlbmVycygpOwoJCXRoaXMuX2JpbmRQYWdlRXZlbnRzKCk7CgoJCWlmICggISF0aGlzLm9wdGlvbnMuZGlzbWlzc2libGUgKSB7CgkJCXRoaXMuX2NyZWF0ZU1vZGFsKCk7CgkJfQoKCQl0aGlzLl9iaW5kU3dpcGVFdmVudHMoKTsKCX0sCgoJX2dldFBhbmVsSW5uZXI6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbElubmVyID0gdGhpcy5lbGVtZW50LmZpbmQoICIuIiArIHRoaXMub3B0aW9ucy5jbGFzc2VzLnBhbmVsSW5uZXIgKTsKCgkJaWYgKCBwYW5lbElubmVyLmxlbmd0aCA9PT0gMCApIHsKCQkJcGFuZWxJbm5lciA9IHRoaXMuZWxlbWVudC5jaGlsZHJlbigpLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxJbm5lciArICInIC8+IiApLnBhcmVudCgpOwoJCX0KCgkJcmV0dXJuIHBhbmVsSW5uZXI7Cgl9LAoKCV9jcmVhdGVNb2RhbDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzLAoJCQl0YXJnZXQgPSBzZWxmLl9wYXJlbnRQYWdlID8gc2VsZi5fcGFyZW50UGFnZS5wYXJlbnQoKSA6IHNlbGYuZWxlbWVudC5wYXJlbnQoKTsKCgkJc2VsZi5fbW9kYWwgPSAkKCAiPGRpdiBjbGFzcz0nIiArIHNlbGYub3B0aW9ucy5jbGFzc2VzLm1vZGFsICsgIicgZGF0YS1wYW5lbGlkPSciICsgc2VsZi5fcGFuZWxJRCArICInPjwvZGl2PiIgKQoJCQkub24oICJtb3VzZWRvd24iLCBmdW5jdGlvbigpIHsKCQkJCXNlbGYuY2xvc2UoKTsKCQkJfSkKCQkJLmFwcGVuZFRvKCB0YXJnZXQgKTsKCX0sCgoJX2dldFBhZ2U6IGZ1bmN0aW9uKCkgewoJCXZhciBwYWdlID0gdGhpcy5fcGFyZW50UGFnZSA/IHRoaXMuX3BhcmVudFBhZ2UgOiAkKCAiLiIgKyAkLm1vYmlsZS5hY3RpdmVQYWdlQ2xhc3MgKTsKCgkJcmV0dXJuIHBhZ2U7Cgl9LAoKCV9nZXRXcmFwcGVyOiBmdW5jdGlvbigpIHsKCQl2YXIgd3JhcHBlciA9IHRoaXMuX3BhZ2UoKS5maW5kKCAiLiIgKyB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlV3JhcHBlciApOwoKCQlpZiAoIHdyYXBwZXIubGVuZ3RoID09PSAwICkgewoJCQl3cmFwcGVyID0gdGhpcy5fcGFnZSgpLmNoaWxkcmVuKCAiLnVpLWhlYWRlcjpub3QoLnVpLWhlYWRlci1maXhlZCksIC51aS1jb250ZW50Om5vdCgudWktcG9wdXApLCAudWktZm9vdGVyOm5vdCgudWktZm9vdGVyLWZpeGVkKSIgKQoJCQkJLndyYXBBbGwoICI8ZGl2IGNsYXNzPSciICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFnZVdyYXBwZXIgKyAiJz48L2Rpdj4iICkKCQkJCS5wYXJlbnQoKTsKCQl9CgoJCXJldHVybiB3cmFwcGVyOwoJfSwKCglfZ2V0Rml4ZWRUb29sYmFyczogZnVuY3Rpb24oKSB7CgkJdmFyIGV4dEZpeGVkVG9vbGJhcnMgPSAkKCAiYm9keSIgKS5jaGlsZHJlbiggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWludEZpeGVkVG9vbGJhcnMgPSB0aGlzLl9wYWdlKCkuZmluZCggIi51aS1oZWFkZXItZml4ZWQsIC51aS1mb290ZXItZml4ZWQiICksCgkJCWZpeGVkVG9vbGJhcnMgPSBleHRGaXhlZFRvb2xiYXJzLmFkZCggaW50Rml4ZWRUb29sYmFycyApLmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYWdlRml4ZWRUb29sYmFyICk7CgoJCXJldHVybiBmaXhlZFRvb2xiYXJzOwoJfSwKCglfZ2V0UG9zRGlzcGxheUNsYXNzZXM6IGZ1bmN0aW9uKCBwcmVmaXggKSB7CgkJcmV0dXJuIHByZWZpeCArICItcG9zaXRpb24tIiArIHRoaXMub3B0aW9ucy5wb3NpdGlvbiArICIgIiArIHByZWZpeCArICItZGlzcGxheS0iICsgdGhpcy5vcHRpb25zLmRpc3BsYXk7Cgl9LAoKCV9nZXRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXZhciBwYW5lbENsYXNzZXMgPSB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCArCgkJCSIgIiArIHRoaXMuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbCApICsKCQkJIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxDbG9zZWQgKwoJCQkiICIgKyAidWktYm9keS0iICsgKCB0aGlzLm9wdGlvbnMudGhlbWUgPyB0aGlzLm9wdGlvbnMudGhlbWUgOiAiaW5oZXJpdCIgKTsKCgkJaWYgKCAhIXRoaXMub3B0aW9ucy5wb3NpdGlvbkZpeGVkICkgewoJCQlwYW5lbENsYXNzZXMgKz0gIiAiICsgdGhpcy5vcHRpb25zLmNsYXNzZXMucGFuZWxGaXhlZDsKCQl9CgoJCXJldHVybiBwYW5lbENsYXNzZXM7Cgl9LAoKCV9hZGRQYW5lbENsYXNzZXM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5fZ2V0UGFuZWxDbGFzc2VzKCkgKTsKCX0sCgoJX2JpbmRDbG9zZUV2ZW50czogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLl9jbG9zZUxpbmsub24oICJjbGljay5wYW5lbCIgLCBmdW5jdGlvbiggZSApIHsKCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQlzZWxmLmNsb3NlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9KTsKCQlzZWxmLmVsZW1lbnQub24oICJjbGljay5wYW5lbCIgLCAiYTpqcW1EYXRhKGFqYXg9J2ZhbHNlJykiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCXNlbGYuY2xvc2UoKTsKCQl9KTsKCX0sCgoJX3Bvc2l0aW9uUGFuZWw6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJcGFuZWxJbm5lckhlaWdodCA9IHNlbGYuX3BhbmVsSW5uZXIub3V0ZXJIZWlnaHQoKSwKCQkJZXhwYW5kID0gcGFuZWxJbm5lckhlaWdodCA+ICQubW9iaWxlLmdldFNjcmVlbkhlaWdodCgpOwoKCQlpZiAoIGV4cGFuZCB8fCAhc2VsZi5vcHRpb25zLnBvc2l0aW9uRml4ZWQgKSB7CgkJCWlmICggZXhwYW5kICkgewoJCQkJc2VsZi5fdW5maXhQYW5lbCgpOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCBwYW5lbElubmVySGVpZ2h0ICk7CgkJCX0KCQkJd2luZG93LnNjcm9sbFRvKCAwLCAkLm1vYmlsZS5kZWZhdWx0SG9tZVNjcm9sbCApOwoJCX0gZWxzZSB7CgkJCXNlbGYuX2ZpeFBhbmVsKCk7CgkJfQoJfSwKCglfYmluZEZpeExpc3RlbmVyOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9vbiggJCggd2luZG93ICksIHsgInRocm90dGxlZHJlc2l6ZSI6ICJfcG9zaXRpb25QYW5lbCIgfSk7Cgl9LAoKCV91bmJpbmRGaXhMaXN0ZW5lcjogZnVuY3Rpb24oKSB7CgkJdGhpcy5fb2ZmKCAkKCB3aW5kb3cgKSwgInRocm90dGxlZHJlc2l6ZSIgKTsKCX0sCgoJX3VuZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LnJlbW92ZUNsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfZml4UGFuZWw6IGZ1bmN0aW9uKCkgewoJCWlmICggISF0aGlzLm9wdGlvbnMucG9zaXRpb25GaXhlZCAmJiAkLnN1cHBvcnQuZml4ZWRQb3NpdGlvbiApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5wYW5lbEZpeGVkICk7CgkJfQoJfSwKCglfYmluZFVwZGF0ZUxheW91dDogZnVuY3Rpb24oKSB7CgkJdmFyIHNlbGYgPSB0aGlzOwoKCQlzZWxmLmVsZW1lbnQub24oICJ1cGRhdGVsYXlvdXQiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCQkJfQoJCX0pOwoJfSwKCglfYmluZExpbmtMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX29uKCAiYm9keSIsIHsKCQkJImNsaWNrIGEiOiAiX2hhbmRsZUNsaWNrIgoJCX0pOwoKCX0sCgoJX2hhbmRsZUNsaWNrOiBmdW5jdGlvbiggZSApIHsKCQlpZiAoICBlLmN1cnJlbnRUYXJnZXQuaHJlZi5zcGxpdCggIiMiIClbIDEgXSA9PT0gdGhpcy5fcGFuZWxJRCAmJiB0aGlzLl9wYW5lbElEICE9PSB1bmRlZmluZWQgKSB7CgkJCWUucHJldmVudERlZmF1bHQoKTsKCQkJdmFyIGxpbmsgPSAkKCBlLnRhcmdldCApOwoJCQlpZiAoIGxpbmsuaGFzQ2xhc3MoICJ1aS1idG4iICkgKSB7CgkJCQlsaW5rLmFkZENsYXNzKCAkLm1vYmlsZS5hY3RpdmVCdG5DbGFzcyApOwoJCQkJdGhpcy5lbGVtZW50Lm9uZSggInBhbmVsb3BlbiBwYW5lbGNsb3NlIiwgZnVuY3Rpb24oKSB7CgkJCQkJbGluay5yZW1vdmVDbGFzcyggJC5tb2JpbGUuYWN0aXZlQnRuQ2xhc3MgKTsKCQkJCX0pOwoJCQl9CgkJCXRoaXMudG9nZ2xlKCk7CgkJCXJldHVybiBmYWxzZTsKCQl9Cgl9LAoKCV9iaW5kU3dpcGVFdmVudHM6IGZ1bmN0aW9uKCkgewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJlYSA9IHNlbGYuX21vZGFsID8gc2VsZi5lbGVtZW50LmFkZCggc2VsZi5fbW9kYWwgKSA6IHNlbGYuZWxlbWVudDsKCgkJLy8gb24gc3dpcGUsIGNsb3NlIHRoZSBwYW5lbAoJCWlmICggISFzZWxmLm9wdGlvbnMuc3dpcGVDbG9zZSApIHsKCQkJaWYgKCBzZWxmLm9wdGlvbnMucG9zaXRpb24gPT09ICJsZWZ0IiApIHsKCQkJCWFyZWEub24oICJzd2lwZWxlZnQucGFuZWwiLCBmdW5jdGlvbigvKiBlICovKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlhcmVhLm9uKCAic3dpcGVyaWdodC5wYW5lbCIsIGZ1bmN0aW9uKC8qIGUgKi8pIHsKCQkJCQlzZWxmLmNsb3NlKCk7CgkJCQl9KTsKCQkJfQoJCX0KCX0sCgoJX2JpbmRQYWdlRXZlbnRzOiBmdW5jdGlvbigpIHsKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCXRoaXMuZG9jdW1lbnQKCQkJLy8gQ2xvc2UgdGhlIHBhbmVsIGlmIGFub3RoZXIgcGFuZWwgb24gdGhlIHBhZ2Ugb3BlbnMKCQkJLm9uKCAicGFuZWxiZWZvcmVvcGVuIiwgZnVuY3Rpb24oIGUgKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gJiYgZS50YXJnZXQgIT09IHNlbGYuZWxlbWVudFsgMCBdICkgewoJCQkJCXNlbGYuY2xvc2UoKTsKCQkJCX0KCQkJfSkKCQkJLy8gT24gZXNjYXBlLCBjbG9zZT8gbWlnaHQgbmVlZCB0byBoYXZlIGEgdGFyZ2V0IGNoZWNrIHRvby4uLgoJCQkub24oICJrZXl1cC5wYW5lbCIsIGZ1bmN0aW9uKCBlICkgewoJCQkJaWYgKCBlLmtleUNvZGUgPT09IDI3ICYmIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSgpOwoJCQkJfQoJCQl9KTsKCgkJLy8gQ2xlYW4gdXAgb3BlbiBwYW5lbHMgYWZ0ZXIgcGFnZSBoaWRlCgkJaWYgKCBzZWxmLl9wYXJlbnRQYWdlICkgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWhpZGUiLCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiwgZnVuY3Rpb24oKSB7CgkJCQlpZiAoIHNlbGYuX29wZW4gKSB7CgkJCQkJc2VsZi5jbG9zZSggdHJ1ZSApOwoJCQkJfQoJCQl9KTsKCQl9IGVsc2UgewoJCQl0aGlzLmRvY3VtZW50Lm9uKCAicGFnZWJlZm9yZWhpZGUiLCBmdW5jdGlvbigpIHsKCQkJCWlmICggc2VsZi5fb3BlbiApIHsKCQkJCQlzZWxmLmNsb3NlKCB0cnVlICk7CgkJCQl9CgkJCX0pOwoJCX0KCX0sCgoJLy8gc3RhdGUgc3RvcmFnZSBvZiBvcGVuIG9yIGNsb3NlZAoJX29wZW46IGZhbHNlLAoJX3BhZ2VDb250ZW50T3BlbkNsYXNzZXM6IG51bGwsCglfbW9kYWxPcGVuQ2xhc3NlczogbnVsbCwKCglvcGVuOiBmdW5jdGlvbiggaW1tZWRpYXRlICkgewoJCWlmICggIXRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSBzZWxmLm9wdGlvbnMsCgoJCQkJX29wZW5QYW5lbCA9IGZ1bmN0aW9uKCkgewoJCQkJCXNlbGYuZG9jdW1lbnQub2ZmKCAicGFuZWxjbG9zZSIgKTsKCQkJCQlzZWxmLl9wYWdlKCkuanFtRGF0YSggInBhbmVsIiwgIm9wZW4iICk7CgoJCQkJCWlmICggJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5hZGRDbGFzcyggby5jbGFzc2VzLmFuaW1hdGUgKTsKCQkJCQl9CgoJCQkJCWlmICggIWltbWVkaWF0ZSAmJiAkLnN1cHBvcnQuY3NzVHJhbnNmb3JtM2QgJiYgISFvLmFuaW1hdGUgKSB7CgkJCQkJCXNlbGYuZG9jdW1lbnQub24oIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJc2V0VGltZW91dCggY29tcGxldGUsIDAgKTsKCQkJCQl9CgoJCQkJCWlmICggby50aGVtZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpCgkJCQkJCQkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50CgkJCQkJCS5yZW1vdmVDbGFzcyggby5jbGFzc2VzLnBhbmVsQ2xvc2VkICkKCQkJCQkJLmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxPcGVuICk7CgoJCQkJCXNlbGYuX3Bvc2l0aW9uUGFuZWwoKTsKCgkJCQkJc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyA9IHNlbGYuX2dldFBvc0Rpc3BsYXlDbGFzc2VzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLmFkZENsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkuYWRkQ2xhc3MoIHNlbGYuX3BhZ2VDb250ZW50T3BlbkNsYXNzZXMgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLmFkZENsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9tb2RhbE9wZW5DbGFzc2VzID0gc2VsZi5fZ2V0UG9zRGlzcGxheUNsYXNzZXMoIG8uY2xhc3Nlcy5tb2RhbCApICsgIiAiICsgby5jbGFzc2VzLm1vZGFsT3BlbjsKCQkJCQlpZiAoIHNlbGYuX21vZGFsICkgewoJCQkJCQlzZWxmLl9tb2RhbAoJCQkJCQkJLmFkZENsYXNzKCBzZWxmLl9tb2RhbE9wZW5DbGFzc2VzICkKCQkJCQkJCS5oZWlnaHQoIE1hdGgubWF4KCBzZWxmLl9tb2RhbC5oZWlnaHQoKSwgc2VsZi5kb2N1bWVudC5oZWlnaHQoKSApICk7CgkJCQkJfQoJCQkJfSwKCQkJCWNvbXBsZXRlID0gZnVuY3Rpb24oKSB7CgkJCQkJc2VsZi5kb2N1bWVudC5vZmYoIHNlbGYuX3RyYW5zaXRpb25FbmRFdmVudHMsIGNvbXBsZXRlICk7CgoJCQkJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgkJCQkJCXNlbGYuX3dyYXBwZXIoKS5hZGRDbGFzcyggby5jbGFzc2VzLnBhZ2VDb250ZW50UHJlZml4ICsgIi1vcGVuIiApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkuYWRkQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQl9CgoJCQkJCXNlbGYuX2JpbmRGaXhMaXN0ZW5lcigpOwoKCQkJCQlzZWxmLl90cmlnZ2VyKCAib3BlbiIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3Jlb3BlbiIgKTsKCgkJCWlmICggc2VsZi5fcGFnZSgpLmpxbURhdGEoICJwYW5lbCIgKSA9PT0gIm9wZW4iICkgewoJCQkJc2VsZi5kb2N1bWVudC5vbiggInBhbmVsY2xvc2UiLCBmdW5jdGlvbigpIHsKCQkJCQlfb3BlblBhbmVsKCk7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCV9vcGVuUGFuZWwoKTsKCQkJfQoKCQkJc2VsZi5fb3BlbiA9IHRydWU7CgkJfQoJfSwKCgljbG9zZTogZnVuY3Rpb24oIGltbWVkaWF0ZSApIHsKCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCXZhciBzZWxmID0gdGhpcywKCQkJCW8gPSB0aGlzLm9wdGlvbnMsCgoJCQkJX2Nsb3NlUGFuZWwgPSBmdW5jdGlvbigpIHsKCQkJCQlpZiAoICFpbW1lZGlhdGUgJiYgJC5zdXBwb3J0LmNzc1RyYW5zZm9ybTNkICYmICEhby5hbmltYXRlICkgewoJCQkJCQlzZWxmLmRvY3VtZW50Lm9uKCBzZWxmLl90cmFuc2l0aW9uRW5kRXZlbnRzLCBjb21wbGV0ZSApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXNldFRpbWVvdXQoIGNvbXBsZXRlLCAwICk7CgkJCQkJfQoKCQkJCQlzZWxmLmVsZW1lbnQucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYW5lbE9wZW4gKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBzZWxmLl9wYWdlQ29udGVudE9wZW5DbGFzc2VzICk7CgkJCQkJCXNlbGYuX2ZpeGVkVG9vbGJhcnMoKS5yZW1vdmVDbGFzcyggc2VsZi5fcGFnZUNvbnRlbnRPcGVuQ2xhc3NlcyApOwoJCQkJCX0KCgkJCQkJaWYgKCBzZWxmLl9tb2RhbCApIHsKCQkJCQkJc2VsZi5fbW9kYWwucmVtb3ZlQ2xhc3MoIHNlbGYuX21vZGFsT3BlbkNsYXNzZXMgKTsKCQkJCQl9CgkJCQl9LAoJCQkJY29tcGxldGUgPSBmdW5jdGlvbigpIHsKCQkJCQlzZWxmLmRvY3VtZW50Lm9mZiggc2VsZi5fdHJhbnNpdGlvbkVuZEV2ZW50cywgY29tcGxldGUgKTsKCgkJCQkJaWYgKCBvLnRoZW1lICYmIG8uZGlzcGxheSAhPT0gIm92ZXJsYXkiICkgewoJCQkJCQlzZWxmLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJCX0KCgkJCQkJc2VsZi5lbGVtZW50LmFkZENsYXNzKCBvLmNsYXNzZXMucGFuZWxDbG9zZWQgKTsKCgkJCQkJaWYgKCBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoJCQkJCQlzZWxmLl93cmFwcGVyKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCQkJCQkJc2VsZi5fZml4ZWRUb29sYmFycygpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRlbnRQcmVmaXggKyAiLW9wZW4iICk7CgkJCQkJfQoKCQkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSAmJiBvLmRpc3BsYXkgIT09ICJvdmVybGF5IiApIHsKCQkJCQkJc2VsZi5fd3JhcHBlcigpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMuYW5pbWF0ZSApOwoJCQkJCQlzZWxmLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQkJfQoKCQkJCQlzZWxmLl9maXhQYW5lbCgpOwoJCQkJCXNlbGYuX3VuYmluZEZpeExpc3RlbmVyKCk7CgkJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgoJCQkJCXNlbGYuX3BhZ2UoKS5qcW1SZW1vdmVEYXRhKCAicGFuZWwiICk7CgoJCQkJCXNlbGYuX3RyaWdnZXIoICJjbG9zZSIgKTsKCQkJCX07CgoJCQlzZWxmLl90cmlnZ2VyKCAiYmVmb3JlY2xvc2UiICk7CgoJCQlfY2xvc2VQYW5lbCgpOwoKCQkJc2VsZi5fb3BlbiA9IGZhbHNlOwoJCX0KCX0sCgoJdG9nZ2xlOiBmdW5jdGlvbigpIHsKCQl0aGlzWyB0aGlzLl9vcGVuID8gImNsb3NlIiA6ICJvcGVuIiBdKCk7Cgl9LAoKCV90cmFuc2l0aW9uRW5kRXZlbnRzOiAid2Via2l0VHJhbnNpdGlvbkVuZCBvVHJhbnNpdGlvbkVuZCBvdHJhbnNpdGlvbmVuZCB0cmFuc2l0aW9uZW5kIG1zVHJhbnNpdGlvbkVuZCIsCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvdGhlclBhbmVscywKCQlvID0gdGhpcy5vcHRpb25zLAoJCW11bHRpcGxlUGFuZWxzID0gKCAkKCAiYm9keSA+IDptb2JpbGUtcGFuZWwiICkubGVuZ3RoICsgJC5tb2JpbGUuYWN0aXZlUGFnZS5maW5kKCAiOm1vYmlsZS1wYW5lbCIgKS5sZW5ndGggKSA+IDE7CgoJCWlmICggby5kaXNwbGF5ICE9PSAib3ZlcmxheSIgKSB7CgoJCQkvLyAgcmVtb3ZlIHRoZSB3cmFwcGVyIGlmIG5vdCBpbiB1c2UgYnkgYW5vdGhlciBwYW5lbAoJCQlvdGhlclBhbmVscyA9ICQoICJib2R5ID4gOm1vYmlsZS1wYW5lbCIgKS5hZGQoICQubW9iaWxlLmFjdGl2ZVBhZ2UuZmluZCggIjptb2JpbGUtcGFuZWwiICkgKTsKCQkJaWYgKCBvdGhlclBhbmVscy5ub3QoICIudWktcGFuZWwtZGlzcGxheS1vdmVybGF5IiApLm5vdCggdGhpcy5lbGVtZW50ICkubGVuZ3RoID09PSAwICkgewoJCQkJdGhpcy5fd3JhcHBlcigpLmNoaWxkcmVuKCkudW53cmFwKCk7CgkJCX0KCgkJCWlmICggdGhpcy5fb3BlbiApIHsKCgkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGVudFByZWZpeCArICItb3BlbiIgKTsKCgkJCQlpZiAoICQuc3VwcG9ydC5jc3NUcmFuc2Zvcm0zZCAmJiAhIW8uYW5pbWF0ZSApIHsKCQkJCQl0aGlzLl9maXhlZFRvb2xiYXJzKCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5hbmltYXRlICk7CgkJCQl9CgoJCQkJdGhpcy5fcGFnZSgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCBvLmNsYXNzZXMucGFnZUNvbnRhaW5lciApOwoKCQkJCWlmICggby50aGVtZSApIHsKCQkJCQl0aGlzLl9wYWdlKCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi10aGVtZWQgIiArIG8uY2xhc3Nlcy5wYWdlQ29udGFpbmVyICsgIi0iICsgby50aGVtZSApOwoJCQkJfQoJCQl9CgkJfQoKCQlpZiAoICFtdWx0aXBsZVBhbmVscyApIHsKCgkJCXRoaXMuZG9jdW1lbnQub2ZmKCAicGFuZWxvcGVuIHBhbmVsY2xvc2UiICk7CgoJCQlpZiAoIHRoaXMuX29wZW4gKSB7CgkJCQl0aGlzLmRvY3VtZW50Lm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoJCQkJJC5tb2JpbGUucmVzZXRBY3RpdmVQYWdlSGVpZ2h0KCk7CgkJCX0KCQl9CgoJCWlmICggdGhpcy5fb3BlbiApIHsKCQkJdGhpcy5fcGFnZSgpLmpxbVJlbW92ZURhdGEoICJwYW5lbCIgKTsKCQl9CgoJCXRoaXMuX3BhbmVsSW5uZXIuY2hpbGRyZW4oKS51bndyYXAoKTsKCgkJdGhpcy5lbGVtZW50CgkJCS5yZW1vdmVDbGFzcyggWyB0aGlzLl9nZXRQYW5lbENsYXNzZXMoKSwgby5jbGFzc2VzLnBhbmVsT3Blbiwgby5jbGFzc2VzLmFuaW1hdGUgXS5qb2luKCAiICIgKSApCgkJCS5vZmYoICJzd2lwZWxlZnQucGFuZWwgc3dpcGVyaWdodC5wYW5lbCIgKQoJCQkub2ZmKCAicGFuZWxiZWZvcmVvcGVuIiApCgkJCS5vZmYoICJwYW5lbGhpZGUiICkKCQkJLm9mZiggImtleXVwLnBhbmVsIiApCgkJCS5vZmYoICJ1cGRhdGVsYXlvdXQiICkKCQkJLm9mZiggdGhpcy5fdHJhbnNpdGlvbkVuZEV2ZW50cyApOwoKCQl0aGlzLl9jbG9zZUxpbmsub2ZmKCAiY2xpY2sucGFuZWwiICk7CgoJCWlmICggdGhpcy5fbW9kYWwgKSB7CgkJCXRoaXMuX21vZGFsLnJlbW92ZSgpOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCiQud2lkZ2V0KCAibW9iaWxlLnRhYmxlIiwgewoJb3B0aW9uczogewoJCWNsYXNzZXM6IHsKCQkJdGFibGU6ICJ1aS10YWJsZSIKCQl9LAoJCWVuaGFuY2VkOiBmYWxzZQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQlpZiAoICF0aGlzLm9wdGlvbnMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMudGFibGUgKTsKCQl9CgoJCS8vIGV4dGVuZCBoZXJlLCBhc3NpZ24gb24gcmVmcmVzaCA+IF9zZXRIZWFkZXJzCgkJJC5leHRlbmQoIHRoaXMsIHsKCgkJCS8vIEV4cG9zZSBoZWFkZXJzIGFuZCBhbGxIZWFkZXJzIHByb3BlcnRpZXMgb24gdGhlIHdpZGdldAoJCQkvLyBoZWFkZXJzIHJlZmVyZW5jZXMgdGhlIFRIcyB3aXRoaW4gdGhlIGZpcnN0IFRSIGluIHRoZSB0YWJsZQoJCQloZWFkZXJzOiB1bmRlZmluZWQsCgoJCQkvLyBhbGxIZWFkZXJzIHJlZmVyZW5jZXMgaGVhZGVycywgcGx1cyBhbGwgVEhzIGluIHRoZSB0aGVhZCwgd2hpY2ggbWF5CgkJCS8vIGluY2x1ZGUgc2V2ZXJhbCByb3dzLCBvciBub3QKCQkJYWxsSGVhZGVyczogdW5kZWZpbmVkCgkJfSk7CgoJCXRoaXMuX3JlZnJlc2goIHRydWUgKTsKCX0sCgoJX3NldEhlYWRlcnM6IGZ1bmN0aW9uKCkgewoJCXZhciB0cnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRoZWFkIHRyIiApOwoKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLmVsZW1lbnQuZmluZCggInRyOmVxKDApIiApLmNoaWxkcmVuKCk7CgkJdGhpcy5hbGxIZWFkZXJzID0gdGhpcy5oZWFkZXJzLmFkZCggdHJzLmNoaWxkcmVuKCkgKTsKCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJdGhpcy5fcmVmcmVzaCgpOwoJfSwKCglyZWJ1aWxkOiAkLm5vb3AsCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCAvKiBjcmVhdGUgKi8gKSB7CgkJdmFyIHRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQl0cnMgPSB0YWJsZS5maW5kKCAidGhlYWQgdHIiICk7CgoJCS8vIHVwZGF0aW5nIGhlYWRlcnMgb24gcmVmcmVzaCAoZml4ZXMgIzU4ODApCgkJdGhpcy5fc2V0SGVhZGVycygpOwoKCQkvLyBJdGVyYXRlIG92ZXIgdGhlIHRycwoJCXRycy5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNvbHVtbkNvdW50ID0gMDsKCgkJCS8vIEl0ZXJhdGUgb3ZlciB0aGUgY2hpbGRyZW4gb2YgdGhlIHRyCgkJCSQoIHRoaXMgKS5jaGlsZHJlbigpLmVhY2goIGZ1bmN0aW9uKCkgewoJCQkJdmFyIHNwYW4gPSBwYXJzZUludCggdGhpcy5nZXRBdHRyaWJ1dGUoICJjb2xzcGFuIiApLCAxMCApLAoJCQkJCXNlbGVjdG9yID0gIjpudGgtY2hpbGQoIiArICggY29sdW1uQ291bnQgKyAxICkgKyAiKSIsCgkJCQkJajsKCgkJCQl0aGlzLnNldEF0dHJpYnV0ZSggImRhdGEtIiArICQubW9iaWxlLm5zICsgImNvbHN0YXJ0IiwgY29sdW1uQ291bnQgKyAxICk7CgoJCQkJaWYgKCBzcGFuICkgewoJCQkJCWZvciggaiA9IDA7IGogPCBzcGFuIC0gMTsgaisrICkgewoJCQkJCQljb2x1bW5Db3VudCsrOwoJCQkJCQlzZWxlY3RvciArPSAiLCA6bnRoLWNoaWxkKCIgKyAoIGNvbHVtbkNvdW50ICsgMSApICsgIikiOwoJCQkJCX0KCQkJCX0KCgkJCQkvLyBTdG9yZSAiY2VsbHMiIGRhdGEgb24gaGVhZGVyIGFzIGEgcmVmZXJlbmNlIHRvIGFsbCBjZWxscyBpbiB0aGUKCQkJCS8vIHNhbWUgY29sdW1uIGFzIHRoaXMgVEgKCQkJCSQoIHRoaXMgKS5qcW1EYXRhKCAiY2VsbHMiLCB0YWJsZS5maW5kKCAidHIiICkubm90KCB0cnMuZXEoIDAgKSApLm5vdCggdGhpcyApLmNoaWxkcmVuKCBzZWxlY3RvciApICk7CgoJCQkJY29sdW1uQ291bnQrKzsKCQkJfSk7CgkJfSk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKJC53aWRnZXQoICJtb2JpbGUudGFibGUiLCAkLm1vYmlsZS50YWJsZSwgewoJb3B0aW9uczogewoJCW1vZGU6ICJjb2x1bW50b2dnbGUiLAoJCWNvbHVtbkJ0blRoZW1lOiBudWxsLAoJCWNvbHVtblBvcHVwVGhlbWU6IG51bGwsCgkJY29sdW1uQnRuVGV4dDogIkNvbHVtbnMuLi4iLAoJCWNsYXNzZXM6ICQuZXh0ZW5kKCAkLm1vYmlsZS50YWJsZS5wcm90b3R5cGUub3B0aW9ucy5jbGFzc2VzLCB7CgkJCXBvcHVwOiAidWktdGFibGUtY29sdW1udG9nZ2xlLXBvcHVwIiwKCQkJY29sdW1uQnRuOiAidWktdGFibGUtY29sdW1udG9nZ2xlLWJ0biIsCgkJCXByaW9yaXR5UHJlZml4OiAidWktdGFibGUtcHJpb3JpdHktIiwKCQkJY29sdW1uVG9nZ2xlVGFibGU6ICJ1aS10YWJsZS1jb2x1bW50b2dnbGUiCgkJfSkKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdGhpcy5fc3VwZXIoKTsKCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gImNvbHVtbnRvZ2dsZSIgKSB7CgkJCXJldHVybjsKCQl9CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9tZW51OiBudWxsCgkJfSk7CgoJCWlmICggdGhpcy5vcHRpb25zLmVuaGFuY2VkICkgewoJCQl0aGlzLl9tZW51ID0gJCggdGhpcy5kb2N1bWVudFsgMCBdLmdldEVsZW1lbnRCeUlkKCB0aGlzLl9pZCgpICsgIi1wb3B1cCIgKSApLmNoaWxkcmVuKCkuZmlyc3QoKTsKCQkJdGhpcy5fYWRkVG9nZ2xlcyggdGhpcy5fbWVudSwgdHJ1ZSApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggdGhpcy5fbWVudSApOwoJCX0gZWxzZSB7CgkJCXRoaXMuX21lbnUgPSB0aGlzLl9lbmhhbmNlQ29sVG9nZ2xlKCk7CgkJCXRoaXMuZWxlbWVudC5hZGRDbGFzcyggdGhpcy5vcHRpb25zLmNsYXNzZXMuY29sdW1uVG9nZ2xlVGFibGUgKTsKCQl9CgoJCXRoaXMuX3NldHVwRXZlbnRzKCk7CgoJCXRoaXMuX3NldFRvZ2dsZVN0YXRlKCk7Cgl9LAoKCV9pZDogZnVuY3Rpb24oKSB7CgkJcmV0dXJuICggdGhpcy5lbGVtZW50LmF0dHIoICJpZCIgKSB8fCAoIHRoaXMud2lkZ2V0TmFtZSArIHRoaXMudXVpZCApICk7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oKSB7CgkJLy9OT1RFOiBpbnB1dHMgYXJlIGJvdW5kIGluIGJpbmRUb2dnbGVzLAoJCS8vIHNvIGl0IGNhbiBiZSBjYWxsZWQgb24gcmVmcmVzaCwgdG9vCgoJCS8vIHVwZGF0ZSBjb2x1bW4gdG9nZ2xlcyBvbiByZXNpemUKCQl0aGlzLl9vbiggdGhpcy53aW5kb3csIHsKCQkJdGhyb3R0bGVkcmVzaXplOiAiX3NldFRvZ2dsZVN0YXRlIgoJCX0pOwoJfSwKCglfYmluZFRvZ2dsZXM6IGZ1bmN0aW9uKCBtZW51ICkgewoJCXZhciBpbnB1dHMgPSBtZW51LmZpbmQoICJpbnB1dCIgKTsKCgkJdGhpcy5fb24oIGlucHV0cywgewoJCQljaGFuZ2U6ICJfbWVudUlucHV0Q2hhbmdlIgoJCX0pOwoJfSwKCglfYWRkVG9nZ2xlczogZnVuY3Rpb24oIG1lbnUsIGtlZXAgKSB7CgkJdmFyIGlucHV0cywKCQkJY2hlY2tib3hJbmRleCA9IDAsCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWNvbnRhaW5lciA9IG1lbnUuY29udHJvbGdyb3VwKCAiY29udGFpbmVyIiApOwoKCQkvLyBhbGxvdyB1cGRhdGUgb2YgbWVudSBvbiByZWZyZXNoIChmaXhlcyAjNTg4MCkKCQlpZiAoIGtlZXAgKSB7CgkJCWlucHV0cyA9IG1lbnUuZmluZCggImlucHV0IiApOwoJCX0gZWxzZSB7CgkJCWNvbnRhaW5lci5lbXB0eSgpOwoJCX0KCgkJLy8gY3JlYXRlIHRoZSBoaWRlL3Nob3cgdG9nZ2xlcwoJCXRoaXMuaGVhZGVycy5ub3QoICJ0ZCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGhlYWRlciA9ICQoIHRoaXMgKSwKCQkJCXByaW9yaXR5ID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCB0aGlzLCAicHJpb3JpdHkiICksCgkJCQljZWxscyA9IGhlYWRlci5hZGQoIGhlYWRlci5qcW1EYXRhKCAiY2VsbHMiICkgKTsKCgkJCWlmICggcHJpb3JpdHkgKSB7CgkJCQljZWxscy5hZGRDbGFzcyggb3B0cy5jbGFzc2VzLnByaW9yaXR5UHJlZml4ICsgcHJpb3JpdHkgKTsKCgkJCQkoIGtlZXAgPyBpbnB1dHMuZXEoIGNoZWNrYm94SW5kZXgrKyApIDoKCQkJCQkkKCI8bGFiZWw+PGlucHV0IHR5cGU9J2NoZWNrYm94JyBjaGVja2VkIC8+IiArCgkJCQkJCSggaGVhZGVyLmNoaWxkcmVuKCAiYWJiciIgKS5maXJzdCgpLmF0dHIoICJ0aXRsZSIgKSB8fAoJCQkJCQkJaGVhZGVyLnRleHQoKSApICsKCQkJCQkJIjwvbGFiZWw+IiApCgkJCQkJCS5hcHBlbmRUbyggY29udGFpbmVyICkKCQkJCQkJLmNoaWxkcmVuKCAwICkKCQkJCQkJLmNoZWNrYm94cmFkaW8oIHsKCQkJCQkJCXRoZW1lOiBvcHRzLmNvbHVtblBvcHVwVGhlbWUKCQkJCQkJfSkgKQoJCQkJCS5qcW1EYXRhKCAiY2VsbHMiLCBjZWxscyApOwoJCQl9CgkJfSk7CgoJCS8vIHNldCBiaW5kaW5ncyBoZXJlCgkJaWYgKCAha2VlcCApIHsKCQkJbWVudS5jb250cm9sZ3JvdXAoICJyZWZyZXNoIiApOwoJCQl0aGlzLl9iaW5kVG9nZ2xlcyggbWVudSApOwoJCX0KCX0sCgoJX21lbnVJbnB1dENoYW5nZTogZnVuY3Rpb24oIGV2dCApIHsKCQl2YXIgaW5wdXQgPSAkKCBldnQudGFyZ2V0ICksCgkJCWNoZWNrZWQgPSBpbnB1dFsgMCBdLmNoZWNrZWQ7CgoJCWlucHV0LmpxbURhdGEoICJjZWxscyIgKQoJCQkudG9nZ2xlQ2xhc3MoICJ1aS10YWJsZS1jZWxsLWhpZGRlbiIsICFjaGVja2VkICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFibGUtY2VsbC12aXNpYmxlIiwgY2hlY2tlZCApOwoKCQlpZiAoIGlucHV0WyAwIF0uZ2V0QXR0cmlidXRlKCAibG9ja2VkIiApICkgewoJCQlpbnB1dC5yZW1vdmVBdHRyKCAibG9ja2VkIiApOwoKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIGlucHV0LmpxbURhdGEoICJjZWxscyIgKSApOwoJCX0gZWxzZSB7CgkJCWlucHV0LmF0dHIoICJsb2NrZWQiLCB0cnVlICk7CgkJfQoJfSwKCglfdW5sb2NrQ2VsbHM6IGZ1bmN0aW9uKCBjZWxscyApIHsKCQkvLyBhbGxvdyBoaWRlL3Nob3cgdmlhIENTUyBvbmx5ID0gcmVtb3ZlIGFsbCB0b2dnbGUtbG9ja3MKCQljZWxscy5yZW1vdmVDbGFzcyggInVpLXRhYmxlLWNlbGwtaGlkZGVuIHVpLXRhYmxlLWNlbGwtdmlzaWJsZSIpOwoJfSwKCglfZW5oYW5jZUNvbFRvZ2dsZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkICwgbWVudUJ1dHRvbiwgcG9wdXAsIG1lbnUsCgkJCXRhYmxlID0gdGhpcy5lbGVtZW50LAoJCQlvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlucyA9ICQubW9iaWxlLm5zLAoJCQlmcmFnbWVudCA9IHRoaXMuZG9jdW1lbnRbIDAgXS5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7CgoJCWlkID0gdGhpcy5faWQoKSArICItcG9wdXAiOwoJCW1lbnVCdXR0b24gPSAkKCAiPGEgaHJlZj0nIyIgKyBpZCArICInICIgKwoJCQkiY2xhc3M9JyIgKyBvcHRzLmNsYXNzZXMuY29sdW1uQnRuICsgIiB1aS1idG4gIiArCgkJCSJ1aS1idG4tIiArICggb3B0cy5jb2x1bW5CdG5UaGVtZSB8fCAiYSIgKSArCgkJCSIgdWktY29ybmVyLWFsbCB1aS1zaGFkb3cgdWktbWluaScgIiArCgkJCSJkYXRhLSIgKyBucyArICJyZWw9J3BvcHVwJz4iICsgb3B0cy5jb2x1bW5CdG5UZXh0ICsgIjwvYT4iICk7CgkJcG9wdXAgPSAkKCAiPGRpdiBjbGFzcz0nIiArIG9wdHMuY2xhc3Nlcy5wb3B1cCArICInIGlkPSciICsgaWQgKyAiJz48L2Rpdj4iICk7CgkJbWVudSA9ICQoICI8ZmllbGRzZXQ+PC9maWVsZHNldD4iICkuY29udHJvbGdyb3VwKCk7CgoJCS8vIHNldCBleHRlbnNpb24gaGVyZSwgc2VuZCAiZmFsc2UiIHRvIHRyaWdnZXIgYnVpbGQvcmVidWlsZAoJCXRoaXMuX2FkZFRvZ2dsZXMoIG1lbnUsIGZhbHNlICk7CgoJCW1lbnUuYXBwZW5kVG8oIHBvcHVwICk7CgoJCWZyYWdtZW50LmFwcGVuZENoaWxkKCBwb3B1cFsgMCBdICk7CgkJZnJhZ21lbnQuYXBwZW5kQ2hpbGQoIG1lbnVCdXR0b25bIDAgXSApOwoJCXRhYmxlLmJlZm9yZSggZnJhZ21lbnQgKTsKCgkJcG9wdXAucG9wdXAoKTsKCgkJcmV0dXJuIG1lbnU7Cgl9LAoKCXJlYnVpbGQ6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7CgoJCWlmICggdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBOT1RFOiByZWJ1aWxkIHBhc3NlcyAiZmFsc2UiLCB3aGlsZSByZWZyZXNoIHBhc3NlcyAidW5kZWZpbmVkIgoJCQkvLyBib3RoIHJlZnJlc2ggdGhlIHRhYmxlLCBidXQgaW5zaWRlIGFkZFRvZ2dsZXMsICFmYWxzZSB3aWxsIGJlIHRydWUsCgkJCS8vIHNvIGEgcmVidWlsZCBjYWxsIGNhbiBiZSBpbmRlbnRpZmllZAoJCQl0aGlzLl9yZWZyZXNoKCBmYWxzZSApOwoJCX0KCX0sCgoJX3JlZnJlc2g6IGZ1bmN0aW9uKCBjcmVhdGUgKSB7CgkJdGhpcy5fc3VwZXIoIGNyZWF0ZSApOwoKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJjb2x1bW50b2dnbGUiICkgewoJCQkvLyBjb2x1bW5zIG5vdCBiZWluZyByZXBsYWNlZCBtdXN0IGJlIGNsZWFyZWQgZnJvbSBpbnB1dCB0b2dnbGUtbG9ja3MKCQkJdGhpcy5fdW5sb2NrQ2VsbHMoIHRoaXMuYWxsSGVhZGVycyApOwoKCQkJLy8gdXBkYXRlIGNvbHVtbnRvZ2dsZXMgYW5kIGNlbGxzCgkJCXRoaXMuX2FkZFRvZ2dsZXMoIHRoaXMuX21lbnUsIGNyZWF0ZSApOwoKCQkJLy8gY2hlY2svdW5jaGVjawoJCQl0aGlzLl9zZXRUb2dnbGVTdGF0ZSgpOwoJCX0KCX0sCgoJX3NldFRvZ2dsZVN0YXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9tZW51LmZpbmQoICJpbnB1dCIgKS5lYWNoKCBmdW5jdGlvbigpIHsKCQkJdmFyIGNoZWNrYm94ID0gJCggdGhpcyApOwoKCQkJdGhpcy5jaGVja2VkID0gY2hlY2tib3guanFtRGF0YSggImNlbGxzIiApLmVxKCAwICkuY3NzKCAiZGlzcGxheSIgKSA9PT0gInRhYmxlLWNlbGwiOwoJCQljaGVja2JveC5jaGVja2JveHJhZGlvKCAicmVmcmVzaCIgKTsKCQl9KTsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXRoaXMuX3N1cGVyKCk7Cgl9Cn0pOwoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB1bmRlZmluZWQgKSB7CgokLndpZGdldCggIm1vYmlsZS50YWJsZSIsICQubW9iaWxlLnRhYmxlLCB7CglvcHRpb25zOiB7CgkJbW9kZTogInJlZmxvdyIsCgkJY2xhc3NlczogJC5leHRlbmQoICQubW9iaWxlLnRhYmxlLnByb3RvdHlwZS5vcHRpb25zLmNsYXNzZXMsIHsKCQkJcmVmbG93VGFibGU6ICJ1aS10YWJsZS1yZWZsb3ciLAoJCQljZWxsTGFiZWxzOiAidWktdGFibGUtY2VsbC1sYWJlbCIKCQl9KQoJfSwKCglfY3JlYXRlOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQkvLyBJZiBpdCdzIG5vdCByZWZsb3cgbW9kZSwgcmV0dXJuIGhlcmUuCgkJaWYgKCB0aGlzLm9wdGlvbnMubW9kZSAhPT0gInJlZmxvdyIgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggIXRoaXMub3B0aW9ucy5lbmhhbmNlZCApIHsKCQkJdGhpcy5lbGVtZW50LmFkZENsYXNzKCB0aGlzLm9wdGlvbnMuY2xhc3Nlcy5yZWZsb3dUYWJsZSApOwoKCQkJdGhpcy5fdXBkYXRlUmVmbG93KCk7CgkJfQoJfSwKCglyZWJ1aWxkOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zdXBlcigpOwoKCQlpZiAoIHRoaXMub3B0aW9ucy5tb2RlID09PSAicmVmbG93IiApIHsKCQkJdGhpcy5fcmVmcmVzaCggZmFsc2UgKTsKCQl9Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbiggY3JlYXRlICkgewoJCXRoaXMuX3N1cGVyKCBjcmVhdGUgKTsKCQlpZiAoICFjcmVhdGUgJiYgdGhpcy5vcHRpb25zLm1vZGUgPT09ICJyZWZsb3ciICkgewoJCQl0aGlzLl91cGRhdGVSZWZsb3coICk7CgkJfQoJfSwKCglfdXBkYXRlUmVmbG93OiBmdW5jdGlvbigpIHsKCQl2YXIgdGFibGUgPSB0aGlzLAoJCQlvcHRzID0gdGhpcy5vcHRpb25zOwoKCQkvLyBnZXQgaGVhZGVycyBpbiByZXZlcnNlIG9yZGVyIHNvIHRoYXQgdG9wLWxldmVsIGhlYWRlcnMgYXJlIGFwcGVuZGVkIGxhc3QKCQkkKCB0YWJsZS5hbGxIZWFkZXJzLmdldCgpLnJldmVyc2UoKSApLmVhY2goIGZ1bmN0aW9uKCkgewoJCQl2YXIgY2VsbHMgPSAkKCB0aGlzICkuanFtRGF0YSggImNlbGxzIiApLAoJCQkJY29sc3RhcnQgPSAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJjb2xzdGFydCIgKSwKCQkJCWhpZXJhcmNoeUNsYXNzID0gY2VsbHMubm90KCB0aGlzICkuZmlsdGVyKCAidGhlYWQgdGgiICkubGVuZ3RoICYmICIgdWktdGFibGUtY2VsbC1sYWJlbC10b3AiLAoJCQkJdGV4dCA9ICQoIHRoaXMgKS50ZXh0KCksCgkJCQlpdGVyYXRpb24sIGZpbHRlcjsKCgkJCQlpZiAoIHRleHQgIT09ICIiICApIHsKCgkJCQkJaWYgKCBoaWVyYXJjaHlDbGFzcyApIHsKCQkJCQkJaXRlcmF0aW9uID0gcGFyc2VJbnQoIHRoaXMuZ2V0QXR0cmlidXRlKCAiY29sc3BhbiIgKSwgMTAgKTsKCQkJCQkJZmlsdGVyID0gIiI7CgoJCQkJCQlpZiAoIGl0ZXJhdGlvbiApIHsKCQkJCQkJCWZpbHRlciA9ICJ0ZDpudGgtY2hpbGQoIisgaXRlcmF0aW9uICsibiArICIgKyAoIGNvbHN0YXJ0ICkgKyIpIjsKCQkJCQkJfQoKCQkJCQkJdGFibGUuX2FkZExhYmVscyggY2VsbHMuZmlsdGVyKCBmaWx0ZXIgKSwgb3B0cy5jbGFzc2VzLmNlbGxMYWJlbHMgKyBoaWVyYXJjaHlDbGFzcywgdGV4dCApOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXRhYmxlLl9hZGRMYWJlbHMoIGNlbGxzLCBvcHRzLmNsYXNzZXMuY2VsbExhYmVscywgdGV4dCApOwoJCQkJCX0KCgkJCQl9CgkJfSk7Cgl9LAoKCV9hZGRMYWJlbHM6IGZ1bmN0aW9uKCBjZWxscywgbGFiZWwsIHRleHQgKSB7CgkJLy8gLm5vdCBmaXhlcyAjNjAwNgoJCWNlbGxzLm5vdCggIjpoYXMoYi4iICsgbGFiZWwgKyAiKSIgKS5wcmVwZW5kKCAiPGIgY2xhc3M9JyIgKyBsYWJlbCArICInPiIgKyB0ZXh0ICsgIjwvYj4iICApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKLy8gVE9ETyByZW5hbWUgZmlsdGVyQ2FsbGJhY2svZGVwcmVjYXRlIGFuZCBkZWZhdWx0IHRvIHRoZSBpdGVtIGl0c2VsZiBhcyB0aGUgZmlyc3QgYXJndW1lbnQKdmFyIGRlZmF1bHRGaWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gKCAoICIiICsgKCAkLm1vYmlsZS5nZXRBdHRyaWJ1dGUoIHRoaXMsICJmaWx0ZXJ0ZXh0IiApIHx8ICQoIHRoaXMgKS50ZXh0KCkgKSApCgkJLnRvTG93ZXJDYXNlKCkuaW5kZXhPZiggc2VhcmNoVmFsdWUgKSA9PT0gLTEgKTsKfTsKCiQud2lkZ2V0KCAibW9iaWxlLmZpbHRlcmFibGUiLCB7CgoJaW5pdFNlbGVjdG9yOiAiOmpxbURhdGEoZmlsdGVyPSd0cnVlJykiLAoKCW9wdGlvbnM6IHsKCQlmaWx0ZXJSZXZlYWw6IGZhbHNlLAoJCWZpbHRlckNhbGxiYWNrOiBkZWZhdWx0RmlsdGVyQ2FsbGJhY2ssCgkJZW5oYW5jZWQ6IGZhbHNlLAoJCWlucHV0OiBudWxsLAoJCWNoaWxkcmVuOiAiPiBsaSwgPiBvcHRpb24sID4gb3B0Z3JvdXAgb3B0aW9uLCA+IHRib2R5IHRyLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktYnRuLCA+IC51aS1jb250cm9sZ3JvdXAtY29udHJvbHMgPiAudWktY2hlY2tib3gsID4gLnVpLWNvbnRyb2xncm91cC1jb250cm9scyA+IC51aS1yYWRpbyIKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIG9wdHMgPSB0aGlzLm9wdGlvbnM7CgoJCSQuZXh0ZW5kKCB0aGlzLCB7CgkJCV9zZWFyY2g6IG51bGwsCgkJCV90aW1lcjogMAoJCX0pOwoKCQl0aGlzLl9zZXRJbnB1dCggb3B0cy5pbnB1dCApOwoJCWlmICggIW9wdHMuZW5oYW5jZWQgKSB7CgkJCXRoaXMuX2ZpbHRlckl0ZW1zKCAoICggdGhpcy5fc2VhcmNoICYmIHRoaXMuX3NlYXJjaC52YWwoKSApIHx8ICIiICkudG9Mb3dlckNhc2UoKSApOwoJCX0KCX0sCgoJX29uS2V5VXA6IGZ1bmN0aW9uKCkgewoJCXZhciB2YWwsIGxhc3R2YWwsCgkJCXNlYXJjaCA9IHRoaXMuX3NlYXJjaDsKCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXZhbCA9IHNlYXJjaC52YWwoKS50b0xvd2VyQ2FzZSgpLAoJCQlsYXN0dmFsID0gJC5tb2JpbGUuZ2V0QXR0cmlidXRlKCBzZWFyY2hbIDAgXSwgImxhc3R2YWwiICkgKyAiIjsKCgkJCWlmICggbGFzdHZhbCAmJiBsYXN0dmFsID09PSB2YWwgKSB7CgkJCQkvLyBFeGVjdXRlIHRoZSBoYW5kbGVyIG9ubHkgb25jZSBwZXIgdmFsdWUgY2hhbmdlCgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICggdGhpcy5fdGltZXIgKSB7CgkJCQl3aW5kb3cuY2xlYXJUaW1lb3V0KCB0aGlzLl90aW1lciApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9CgoJCQl0aGlzLl90aW1lciA9IHRoaXMuX2RlbGF5KCBmdW5jdGlvbigpIHsKCQkJCXRoaXMuX3RyaWdnZXIoICJiZWZvcmVmaWx0ZXIiLCAiYmVmb3JlZmlsdGVyIiwgeyBpbnB1dDogc2VhcmNoIH0gKTsKCgkJCQkvLyBDaGFuZ2UgdmFsIGFzIGxhc3R2YWwgZm9yIG5leHQgZXhlY3V0aW9uCgkJCQlzZWFyY2hbIDAgXS5zZXRBdHRyaWJ1dGUoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJsYXN0dmFsIiwgdmFsICk7CgoJCQkJdGhpcy5fZmlsdGVySXRlbXMoIHZhbCApOwoJCQkJdGhpcy5fdGltZXIgPSAwOwoJCQl9LCAyNTAgKTsKCQl9Cgl9LAoKCV9nZXRGaWx0ZXJhYmxlSXRlbXM6IGZ1bmN0aW9uKCkgewoJCXZhciBlbGVtID0gdGhpcy5lbGVtZW50LAoJCQljaGlsZHJlbiA9IHRoaXMub3B0aW9ucy5jaGlsZHJlbiwKCQkJaXRlbXMgPSAhY2hpbGRyZW4gPyB7IGxlbmd0aDogMCB9OgoJCQkJJC5pc0Z1bmN0aW9uKCBjaGlsZHJlbiApID8gY2hpbGRyZW4oKToKCQkJCWNoaWxkcmVuLm5vZGVOYW1lID8gJCggY2hpbGRyZW4gKToKCQkJCWNoaWxkcmVuLmpxdWVyeSA/IGNoaWxkcmVuOgoJCQkJdGhpcy5lbGVtZW50LmZpbmQoIGNoaWxkcmVuICk7CgoJCWlmICggaXRlbXMubGVuZ3RoID09PSAwICkgewoJCQlpdGVtcyA9IGVsZW0uY2hpbGRyZW4oKTsKCQl9CgoJCXJldHVybiBpdGVtczsKCX0sCgoJX2ZpbHRlckl0ZW1zOiBmdW5jdGlvbiggdmFsICkgewoJCXZhciBpZHgsIGNhbGxiYWNrLCBsZW5ndGgsIGRzdCwKCQkJc2hvdyA9IFtdLAoJCQloaWRlID0gW10sCgkJCW9wdHMgPSB0aGlzLm9wdGlvbnMsCgkJCWZpbHRlckl0ZW1zID0gdGhpcy5fZ2V0RmlsdGVyYWJsZUl0ZW1zKCk7CgoJCWlmICggdmFsICE9IG51bGwgKSB7CgkJCWNhbGxiYWNrID0gb3B0cy5maWx0ZXJDYWxsYmFjayB8fCBkZWZhdWx0RmlsdGVyQ2FsbGJhY2s7CgkJCWxlbmd0aCA9IGZpbHRlckl0ZW1zLmxlbmd0aDsKCgkJCS8vIFBhcnRpdGlvbiB0aGUgaXRlbXMgaW50byB0aG9zZSB0byBiZSBoaWRkZW4gYW5kIHRob3NlIHRvIGJlIHNob3duCgkJCWZvciAoIGlkeCA9IDAgOyBpZHggPCBsZW5ndGggOyBpZHgrKyApIHsKCQkJCWRzdCA9ICggY2FsbGJhY2suY2FsbCggZmlsdGVySXRlbXNbIGlkeCBdLCBpZHgsIHZhbCApICkgPyBoaWRlIDogc2hvdzsKCQkJCWRzdC5wdXNoKCBmaWx0ZXJJdGVtc1sgaWR4IF0gKTsKCQkJfQoJCX0KCgkJLy8gSWYgbm90aGluZyBpcyBoaWRkZW4sIHRoZW4gdGhlIGRlY2lzaW9uIHdoZXRoZXIgdG8gaGlkZSBvciBzaG93IHRoZSBpdGVtcwoJCS8vIGlzIGJhc2VkIG9uIHRoZSAiZmlsdGVyUmV2ZWFsIiBvcHRpb24uCgkJaWYgKCBoaWRlLmxlbmd0aCA9PT0gMCApIHsKCQkJZmlsdGVySXRlbXNbIG9wdHMuZmlsdGVyUmV2ZWFsID8gImFkZENsYXNzIiA6ICJyZW1vdmVDbGFzcyIgXSggInVpLXNjcmVlbi1oaWRkZW4iICk7CgkJfSBlbHNlIHsKCQkJJCggaGlkZSApLmFkZENsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQkJJCggc2hvdyApLnJlbW92ZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIgKTsKCQl9CgoJCXRoaXMuX3JlZnJlc2hDaGlsZFdpZGdldCgpOwoJfSwKCgkvLyBUaGUgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiBvZiBfcmVmcmVzaENoaWxkV2lkZ2V0IGF0dGVtcHRzIHRvIGNhbGwKCS8vIHJlZnJlc2ggb24gY29sbGFwc2libGVzZXQsIGNvbnRyb2xncm91cCwgc2VsZWN0bWVudSwgb3IgbGlzdHZpZXcKCV9yZWZyZXNoQ2hpbGRXaWRnZXQ6IGZ1bmN0aW9uKCkgewoJCXZhciB3aWRnZXQsIGlkeCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXTsKCgkJZm9yICggaWR4ID0gcmVjb2duaXplZFdpZGdldHMubGVuZ3RoIC0gMSA7IGlkeCA+IC0xIDsgaWR4LS0gKSB7CgkJCXdpZGdldCA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0IF0gKSB7CgkJCQl3aWRnZXQgPSB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0ICk7CgkJCQlpZiAoIHdpZGdldCAmJiAkLmlzRnVuY3Rpb24oIHdpZGdldC5yZWZyZXNoICkgKSB7CgkJCQkJd2lkZ2V0LnJlZnJlc2goKTsKCQkJCX0KCQkJfQoJCX0KCX0sCgoJLy8gVE9ETzogV2hlbiB0aGUgaW5wdXQgaXMgbm90IGludGVybmFsLCBkbyBub3QgZXZlbiBzdG9yZSBpdCBpbiB0aGlzLl9zZWFyY2gKCV9zZXRJbnB1dDogZnVuY3Rpb24gKCBzZWxlY3RvciApIHsKCQl2YXIgc2VhcmNoID0gdGhpcy5fc2VhcmNoOwoKCQkvLyBTdG9wIGEgcGVuZGluZyBmaWx0ZXIgb3BlcmF0aW9uCgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCgkJaWYgKCBzZWFyY2ggKSB7CgkJCXRoaXMuX29mZiggc2VhcmNoLCAia2V5dXAgY2hhbmdlIGlucHV0IiApOwoJCQlzZWFyY2ggPSBudWxsOwoJCX0KCgkJaWYgKCBzZWxlY3RvciApIHsKCQkJc2VhcmNoID0gc2VsZWN0b3IuanF1ZXJ5ID8gc2VsZWN0b3I6CgkJCQlzZWxlY3Rvci5ub2RlTmFtZSA/ICQoIHNlbGVjdG9yICk6CgkJCQl0aGlzLmRvY3VtZW50LmZpbmQoIHNlbGVjdG9yICk7CgoJCQl0aGlzLl9vbiggc2VhcmNoLCB7CgkJCQlrZXl1cDogIl9vbktleVVwIiwKCQkJCWNoYW5nZTogIl9vbktleVVwIiwKCQkJCWlucHV0OiAiX29uS2V5VXAiCgkJCX0pOwoJCX0KCgkJdGhpcy5fc2VhcmNoID0gc2VhcmNoOwoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJlZmlsdGVyID0gISggKCBvcHRpb25zLmZpbHRlclJldmVhbCA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9PT0gdW5kZWZpbmVkICkgJiYKCQkJCSggb3B0aW9ucy5jaGlsZHJlbiA9PT0gdW5kZWZpbmVkICkgKTsKCgkJdGhpcy5fc3VwZXIoIG9wdGlvbnMgKTsKCgkJaWYgKCBvcHRpb25zLmlucHV0ICE9PSB1bmRlZmluZWQgKSB7CgkJCXRoaXMuX3NldElucHV0KCBvcHRpb25zLmlucHV0ICk7CgkJCXJlZmlsdGVyID0gdHJ1ZTsKCQl9CgoJCWlmICggcmVmaWx0ZXIgKSB7CgkJCXRoaXMucmVmcmVzaCgpOwoJCX0KCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQlpdGVtcyA9IHRoaXMuX2dldEZpbHRlcmFibGVJdGVtcygpOwoKCQlpZiAoIG9wdHMuZW5oYW5jZWQgKSB7CgkJCWl0ZW1zLnRvZ2dsZUNsYXNzKCAidWktc2NyZWVuLWhpZGRlbiIsIG9wdHMuZmlsdGVyUmV2ZWFsICk7CgkJfSBlbHNlIHsKCQkJaXRlbXMucmVtb3ZlQ2xhc3MoICJ1aS1zY3JlZW4taGlkZGVuIiApOwoJCX0KCX0sCgoJcmVmcmVzaDogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl90aW1lciApIHsKCQkJd2luZG93LmNsZWFyVGltZW91dCggdGhpcy5fdGltZXIgKTsKCQkJdGhpcy5fdGltZXIgPSAwOwoJCX0KCQl0aGlzLl9maWx0ZXJJdGVtcyggKCAoIHRoaXMuX3NlYXJjaCAmJiB0aGlzLl9zZWFyY2gudmFsKCkgKSB8fCAiIiApLnRvTG93ZXJDYXNlKCkgKTsKCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgooZnVuY3Rpb24oICQsIHVuZGVmaW5lZCApIHsKCi8vIENyZWF0ZSBhIGZ1bmN0aW9uIHRoYXQgd2lsbCByZXBsYWNlIHRoZSBfc2V0T3B0aW9ucyBmdW5jdGlvbiBvZiBhIHdpZGdldCwKLy8gYW5kIHdpbGwgcGFzcyB0aGUgb3B0aW9ucyBvbiB0byB0aGUgaW5wdXQgb2YgdGhlIGZpbHRlcmFibGUuCnZhciByZXBsYWNlU2V0T3B0aW9ucyA9IGZ1bmN0aW9uKCBzZWxmLCBvcmlnICkgewoJCXJldHVybiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQkJb3JpZy5jYWxsKCB0aGlzLCBvcHRpb25zICk7CgkJCXNlbGYuX3N5bmNUZXh0SW5wdXRPcHRpb25zKCBvcHRpb25zICk7CgkJfTsKCX0sCglyRGl2aWRlckxpc3RJdGVtID0gLyhefFxzKXVpLWxpLWRpdmlkZXIoXHN8JCkvLAoJb3JpZ0RlZmF1bHRGaWx0ZXJDYWxsYmFjayA9ICQubW9iaWxlLmZpbHRlcmFibGUucHJvdG90eXBlLm9wdGlvbnMuZmlsdGVyQ2FsbGJhY2s7CgovLyBPdmVycmlkZSB0aGUgZGVmYXVsdCBmaWx0ZXIgY2FsbGJhY2sgd2l0aCBvbmUgdGhhdCBkb2VzIG5vdCBoaWRlIGxpc3QgZGl2aWRlcnMKJC5tb2JpbGUuZmlsdGVyYWJsZS5wcm90b3R5cGUub3B0aW9ucy5maWx0ZXJDYWxsYmFjayA9IGZ1bmN0aW9uKCBpbmRleCwgc2VhcmNoVmFsdWUgKSB7CglyZXR1cm4gIXRoaXMuY2xhc3NOYW1lLm1hdGNoKCByRGl2aWRlckxpc3RJdGVtICkgJiYKCQlvcmlnRGVmYXVsdEZpbHRlckNhbGxiYWNrLmNhbGwoIHRoaXMsIGluZGV4LCBzZWFyY2hWYWx1ZSApOwp9OwoKJC53aWRnZXQoICJtb2JpbGUuZmlsdGVyYWJsZSIsICQubW9iaWxlLmZpbHRlcmFibGUsIHsKCW9wdGlvbnM6IHsKCQlmaWx0ZXJQbGFjZWhvbGRlcjogIkZpbHRlciBpdGVtcy4uLiIsCgkJZmlsdGVyVGhlbWU6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGlkeCwgd2lkZ2V0TmFtZSwKCQkJZWxlbSA9IHRoaXMuZWxlbWVudCwKCQkJcmVjb2duaXplZFdpZGdldHMgPSBbICJjb2xsYXBzaWJsZXNldCIsICJzZWxlY3RtZW51IiwgImNvbnRyb2xncm91cCIsICJsaXN0dmlldyIgXSwKCQkJY3JlYXRlSGFuZGxlcnMgPSB7fTsKCgkJdGhpcy5fc3VwZXIoKTsKCgkJJC5leHRlbmQoIHRoaXMsIHsKCQkJX3dpZGdldDogbnVsbAoJCX0pOwoKCQlmb3IgKCBpZHggPSByZWNvZ25pemVkV2lkZ2V0cy5sZW5ndGggLSAxIDsgaWR4ID4gLTEgOyBpZHgtLSApIHsKCQkJd2lkZ2V0TmFtZSA9IHJlY29nbml6ZWRXaWRnZXRzWyBpZHggXTsKCQkJaWYgKCAkLm1vYmlsZVsgd2lkZ2V0TmFtZSBdICkgewoJCQkJaWYgKCB0aGlzLl9zZXRXaWRnZXQoIGVsZW0uZGF0YSggIm1vYmlsZS0iICsgd2lkZ2V0TmFtZSApICkgKSB7CgkJCQkJYnJlYWs7CgkJCQl9IGVsc2UgewoJCQkJCWNyZWF0ZUhhbmRsZXJzWyB3aWRnZXROYW1lICsgImNyZWF0ZSIgXSA9ICJfaGFuZGxlQ3JlYXRlIjsKCQkJCX0KCQkJfQoJCX0KCgkJaWYgKCAhdGhpcy5fd2lkZ2V0ICkgewoJCQl0aGlzLl9vbiggZWxlbSwgY3JlYXRlSGFuZGxlcnMgKTsKCQl9Cgl9LAoKCV9oYW5kbGVDcmVhdGU6IGZ1bmN0aW9uKCBldnQgKSB7CgkJdGhpcy5fc2V0V2lkZ2V0KCB0aGlzLmVsZW1lbnQuZGF0YSggIm1vYmlsZS0iICsgZXZ0LnR5cGUuc3Vic3RyaW5nKCAwLCBldnQudHlwZS5sZW5ndGggLSA2ICkgKSApOwoJfSwKCglfc2V0V2lkZ2V0OiBmdW5jdGlvbiggd2lkZ2V0ICkgewoJCWlmICggIXRoaXMuX3dpZGdldCAmJiB3aWRnZXQgKSB7CgkJCXRoaXMuX3dpZGdldCA9IHdpZGdldDsKCQkJdGhpcy5fd2lkZ2V0Ll9zZXRPcHRpb25zID0gcmVwbGFjZVNldE9wdGlvbnMoIHRoaXMsIHRoaXMuX3dpZGdldC5fc2V0T3B0aW9ucyApOwoJCX0KCgkJaWYgKCAhIXRoaXMuX3dpZGdldCApIHsKCQkJdGhpcy5fc3luY1RleHRJbnB1dE9wdGlvbnMoIHRoaXMuX3dpZGdldC5vcHRpb25zICk7CgkJCWlmICggdGhpcy5fd2lkZ2V0LndpZGdldE5hbWUgPT09ICJsaXN0dmlldyIgKSB7CgkJCQl0aGlzLl93aWRnZXQub3B0aW9ucy5oaWRlZGl2aWRlcnMgPSB0cnVlOwoJCQkJdGhpcy5fd2lkZ2V0LmVsZW1lbnQubGlzdHZpZXcoICJyZWZyZXNoIiApOwoJCQl9CgkJfQoKCQlyZXR1cm4gISF0aGlzLl93aWRnZXQ7Cgl9LAoKCV9pc1NlYXJjaEludGVybmFsOiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gKCB0aGlzLl9zZWFyY2ggJiYgdGhpcy5fc2VhcmNoLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiApICk7Cgl9LAoKCV9zZXRJbnB1dDogZnVuY3Rpb24oIHNlbGVjdG9yICkgewoJCXZhciBvcHRzID0gdGhpcy5vcHRpb25zLAoJCQl1cGRhdGVQbGFjZWhvbGRlciA9IHRydWUsCgkJCXRleHRpbnB1dE9wdHMgPSB7fTsKCgkJaWYgKCAhc2VsZWN0b3IgKSB7CgkJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICkgewoKCQkJCS8vIElnbm9yZSB0aGUgY2FsbCB0byBzZXQgYSBuZXcgaW5wdXQgaWYgdGhlIHNlbGVjdG9yIGdvZXMgdG8gZmFsc3kgYW5kCgkJCQkvLyB0aGUgY3VycmVudCB0ZXh0aW5wdXQgaXMgYWxyZWFkeSBvZiB0aGUgaW50ZXJuYWxseSBnZW5lcmF0ZWQgdmFyaWV0eS4KCQkJCXJldHVybjsKCQkJfSBlbHNlIHsKCgkJCQkvLyBHZW5lcmF0aW5nIGEgbmV3IHRleHRpbnB1dCB3aWRnZXQuIE5vIG5lZWQgdG8gc2V0IHRoZSBwbGFjZWhvbGRlcgoJCQkJLy8gZnVydGhlciBkb3duIHRoZSBmdW5jdGlvbi4KCQkJCXVwZGF0ZVBsYWNlaG9sZGVyID0gZmFsc2U7CgkJCQlzZWxlY3RvciA9ICQoICI8aW5wdXQgIiArCgkJCQkJImRhdGEtIiArICQubW9iaWxlLm5zICsgInR5cGU9J3NlYXJjaCcgIiArCgkJCQkJInBsYWNlaG9sZGVyPSciICsgb3B0cy5maWx0ZXJQbGFjZWhvbGRlciArICInPjwvaW5wdXQ+IiApCgkJCQkJLmpxbURhdGEoICJ1aS1maWx0ZXJhYmxlLSIgKyB0aGlzLnV1aWQgKyAiLWludGVybmFsIiwgdHJ1ZSApOwoJCQkJJCggIjxmb3JtIGNsYXNzPSd1aS1maWx0ZXJhYmxlJz48L2Zvcm0+IiApCgkJCQkJLmFwcGVuZCggc2VsZWN0b3IgKQoJCQkJCS5zdWJtaXQoIGZ1bmN0aW9uKCBldnQgKSB7CgkJCQkJCWV2dC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCQlzZWxlY3Rvci5ibHVyKCk7CgkJCQkJfSkKCQkJCQkuaW5zZXJ0QmVmb3JlKCB0aGlzLmVsZW1lbnQgKTsKCQkJCWlmICggJC5tb2JpbGUudGV4dGlucHV0ICkgewoJCQkJCWlmICggdGhpcy5vcHRpb25zLmZpbHRlclRoZW1lICE9IG51bGwgKSB7CgkJCQkJCXRleHRpbnB1dE9wdHNbICJ0aGVtZSIgXSA9IG9wdHMuZmlsdGVyVGhlbWU7CgkJCQkJfQoKCQkJCQlzZWxlY3Rvci50ZXh0aW5wdXQoIHRleHRpbnB1dE9wdHMgKTsKCQkJCX0KCQkJfQoJCX0KCgkJdGhpcy5fc3VwZXIoIHNlbGVjdG9yICk7CgoJCWlmICggdGhpcy5faXNTZWFyY2hJbnRlcm5hbCgpICYmIHVwZGF0ZVBsYWNlaG9sZGVyICkgewoJCQl0aGlzLl9zZWFyY2guYXR0ciggInBsYWNlaG9sZGVyIiwgdGhpcy5vcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJfQoJfSwKCglfc2V0T3B0aW9uczogZnVuY3Rpb24oIG9wdGlvbnMgKSB7CgkJdmFyIHJldCA9IHRoaXMuX3N1cGVyKCBvcHRpb25zICk7CgoJCS8vIE5lZWQgdG8gc2V0IHRoZSBmaWx0ZXJQbGFjZWhvbGRlciBhZnRlciBoYXZpbmcgZXN0YWJsaXNoZWQgdGhlIHNlYXJjaCBpbnB1dAoJCWlmICggb3B0aW9ucy5maWx0ZXJQbGFjZWhvbGRlciAhPT0gdW5kZWZpbmVkICkgewoJCQlpZiAoIHRoaXMuX2lzU2VhcmNoSW50ZXJuYWwoKSApIHsKCQkJCXRoaXMuX3NlYXJjaC5hdHRyKCAicGxhY2Vob2xkZXIiLCBvcHRpb25zLmZpbHRlclBsYWNlaG9sZGVyICk7CgkJCX0KCQl9CgoJCWlmICggb3B0aW9ucy5maWx0ZXJUaGVtZSAhPT0gdW5kZWZpbmVkICYmIHRoaXMuX3NlYXJjaCAmJiAkLm1vYmlsZS50ZXh0aW5wdXQgKSB7CgkJCXRoaXMuX3NlYXJjaC50ZXh0aW5wdXQoICJvcHRpb24iLCAidGhlbWUiLCBvcHRpb25zLmZpbHRlclRoZW1lICk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfSwKCglfZGVzdHJveTogZnVuY3Rpb24oKSB7CgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgKSB7CgkJCXRoaXMuX3NlYXJjaC5yZW1vdmUoKTsKCQl9CgkJdGhpcy5fc3VwZXIoKTsKCX0sCgoJX3N5bmNUZXh0SW5wdXRPcHRpb25zOiBmdW5jdGlvbiggb3B0aW9ucyApIHsKCQl2YXIgaWR4LAoJCQl0ZXh0aW5wdXRPcHRpb25zID0ge307CgoJCS8vIFdlIG9ubHkgc3luYyBvcHRpb25zIGlmIHRoZSBmaWx0ZXJhYmxlJ3MgdGV4dGlucHV0IGlzIG9mIHRoZSBpbnRlcm5hbGx5CgkJLy8gZ2VuZXJhdGVkIHZhcmlldHksIHJhdGhlciB0aGFuIG9uZSBzcGVjaWZpZWQgYnkgdGhlIHVzZXIuCgkJaWYgKCB0aGlzLl9pc1NlYXJjaEludGVybmFsKCkgJiYgJC5tb2JpbGUudGV4dGlucHV0ICkgewoKCQkJLy8gQXBwbHkgb25seSB0aGUgb3B0aW9ucyB1bmRlcnN0b29kIGJ5IHRleHRpbnB1dAoJCQlmb3IgKCBpZHggaW4gJC5tb2JpbGUudGV4dGlucHV0LnByb3RvdHlwZS5vcHRpb25zICkgewoJCQkJaWYgKCBvcHRpb25zWyBpZHggXSAhPT0gdW5kZWZpbmVkICkgewoJCQkJCWlmICggaWR4ID09PSAidGhlbWUiICYmIHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZSAhPSBudWxsICkgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IHRoaXMub3B0aW9ucy5maWx0ZXJUaGVtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQl0ZXh0aW5wdXRPcHRpb25zWyBpZHggXSA9IG9wdGlvbnNbIGlkeCBdOwoJCQkJCX0KCQkJCX0KCQkJfQoJCQl0aGlzLl9zZWFyY2gudGV4dGlucHV0KCAib3B0aW9uIiwgdGV4dGlucHV0T3B0aW9ucyApOwoJCX0KCX0KfSk7Cgp9KSggalF1ZXJ5ICk7CgovKiEKICogalF1ZXJ5IFVJIFRhYnMgZmFkZjJiMzEyYTA1MDQwNDM2NDUxYzY0YmJmYWY0ODE0YmM2MmM1NgogKiBodHRwOi8vanF1ZXJ5dWkuY29tCiAqCiAqIENvcHlyaWdodCAyMDEzIGpRdWVyeSBGb3VuZGF0aW9uIGFuZCBvdGhlciBjb250cmlidXRvcnMKICogUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLgogKiBodHRwOi8vanF1ZXJ5Lm9yZy9saWNlbnNlCiAqCiAqIGh0dHA6Ly9hcGkuanF1ZXJ5dWkuY29tL3RhYnMvCiAqCiAqIERlcGVuZHM6CiAqCWpxdWVyeS51aS5jb3JlLmpzCiAqCWpxdWVyeS51aS53aWRnZXQuanMKICovCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKdmFyIHRhYklkID0gMCwKCXJoYXNoID0gLyMuKiQvOwoKZnVuY3Rpb24gZ2V0TmV4dFRhYklkKCkgewoJcmV0dXJuICsrdGFiSWQ7Cn0KCmZ1bmN0aW9uIGlzTG9jYWwoIGFuY2hvciApIHsKCXJldHVybiBhbmNob3IuaGFzaC5sZW5ndGggPiAxICYmCgkJZGVjb2RlVVJJQ29tcG9uZW50KCBhbmNob3IuaHJlZi5yZXBsYWNlKCByaGFzaCwgIiIgKSApID09PQoJCQlkZWNvZGVVUklDb21wb25lbnQoIGxvY2F0aW9uLmhyZWYucmVwbGFjZSggcmhhc2gsICIiICkgKTsKfQoKJC53aWRnZXQoICJ1aS50YWJzIiwgewoJdmVyc2lvbjogImZhZGYyYjMxMmEwNTA0MDQzNjQ1MWM2NGJiZmFmNDgxNGJjNjJjNTYiLAoJZGVsYXk6IDMwMCwKCW9wdGlvbnM6IHsKCQlhY3RpdmU6IG51bGwsCgkJY29sbGFwc2libGU6IGZhbHNlLAoJCWV2ZW50OiAiY2xpY2siLAoJCWhlaWdodFN0eWxlOiAiY29udGVudCIsCgkJaGlkZTogbnVsbCwKCQlzaG93OiBudWxsLAoKCQkvLyBjYWxsYmFja3MKCQlhY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVBY3RpdmF0ZTogbnVsbCwKCQliZWZvcmVMb2FkOiBudWxsLAoJCWxvYWQ6IG51bGwKCX0sCgoJX2NyZWF0ZTogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQlvcHRpb25zID0gdGhpcy5vcHRpb25zOwoKCQl0aGlzLnJ1bm5pbmcgPSBmYWxzZTsKCgkJdGhpcy5lbGVtZW50CgkJCS5hZGRDbGFzcyggInVpLXRhYnMgdWktd2lkZ2V0IHVpLXdpZGdldC1jb250ZW50IHVpLWNvcm5lci1hbGwiICkKCQkJLnRvZ2dsZUNsYXNzKCAidWktdGFicy1jb2xsYXBzaWJsZSIsIG9wdGlvbnMuY29sbGFwc2libGUgKQoJCQkvLyBQcmV2ZW50IHVzZXJzIGZyb20gZm9jdXNpbmcgZGlzYWJsZWQgdGFicyB2aWEgY2xpY2sKCQkJLmRlbGVnYXRlKCAiLnVpLXRhYnMtbmF2ID4gbGkiLCAibW91c2Vkb3duIiArIHRoaXMuZXZlbnROYW1lc3BhY2UsIGZ1bmN0aW9uKCBldmVudCApIHsKCQkJCWlmICggJCggdGhpcyApLmlzKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApICkgewoJCQkJCWV2ZW50LnByZXZlbnREZWZhdWx0KCk7CgkJCQl9CgkJCX0pCgkJCS8vIHN1cHBvcnQ6IElFIDw5CgkJCS8vIFByZXZlbnRpbmcgdGhlIGRlZmF1bHQgYWN0aW9uIGluIG1vdXNlZG93biBkb2Vzbid0IHByZXZlbnQgSUUKCQkJLy8gZnJvbSBmb2N1c2luZyB0aGUgZWxlbWVudCwgc28gaWYgdGhlIGFuY2hvciBnZXRzIGZvY3VzZWQsIGJsdXIuCgkJCS8vIFdlIGRvbid0IGhhdmUgdG8gd29ycnkgYWJvdXQgZm9jdXNpbmcgdGhlIHByZXZpb3VzbHkgZm9jdXNlZAoJCQkvLyBlbGVtZW50IHNpbmNlIGNsaWNraW5nIG9uIGEgbm9uLWZvY3VzYWJsZSBlbGVtZW50IHNob3VsZCBmb2N1cwoJCQkvLyB0aGUgYm9keSBhbnl3YXkuCgkJCS5kZWxlZ2F0ZSggIi51aS10YWJzLWFuY2hvciIsICJmb2N1cyIgKyB0aGlzLmV2ZW50TmFtZXNwYWNlLCBmdW5jdGlvbigpIHsKCQkJCWlmICggJCggdGhpcyApLmNsb3Nlc3QoICJsaSIgKS5pcyggIi51aS1zdGF0ZS1kaXNhYmxlZCIgKSApIHsKCQkJCQl0aGlzLmJsdXIoKTsKCQkJCX0KCQkJfSk7CgoJCXRoaXMuX3Byb2Nlc3NUYWJzKCk7CgkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLl9pbml0aWFsQWN0aXZlKCk7CgoJCS8vIFRha2UgZGlzYWJsaW5nIHRhYnMgdmlhIGNsYXNzIGF0dHJpYnV0ZSBmcm9tIEhUTUwKCQkvLyBpbnRvIGFjY291bnQgYW5kIHVwZGF0ZSBvcHRpb24gcHJvcGVybHkuCgkJaWYgKCAkLmlzQXJyYXkoIG9wdGlvbnMuZGlzYWJsZWQgKSApIHsKCQkJb3B0aW9ucy5kaXNhYmxlZCA9ICQudW5pcXVlKCBvcHRpb25zLmRpc2FibGVkLmNvbmNhdCgKCQkJCSQubWFwKCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggbGkgKSB7CgkJCQkJcmV0dXJuIHRoYXQudGFicy5pbmRleCggbGkgKTsKCQkJCX0pCgkJCSkgKS5zb3J0KCk7CgkJfQoKCQkvLyBjaGVjayBmb3IgbGVuZ3RoIGF2b2lkcyBlcnJvciB3aGVuIGluaXRpYWxpemluZyBlbXB0eSBsaXN0CgkJaWYgKCB0aGlzLm9wdGlvbnMuYWN0aXZlICE9PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQl0aGlzLmFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIG9wdGlvbnMuYWN0aXZlICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUgPSAkKCk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7CgoJCWlmICggdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIG9wdGlvbnMuYWN0aXZlICk7CgkJfQoJfSwKCglfaW5pdGlhbEFjdGl2ZTogZnVuY3Rpb24oKSB7CgkJdmFyIGFjdGl2ZSA9IHRoaXMub3B0aW9ucy5hY3RpdmUsCgkJCWNvbGxhcHNpYmxlID0gdGhpcy5vcHRpb25zLmNvbGxhcHNpYmxlLAoJCQlsb2NhdGlvbkhhc2ggPSBsb2NhdGlvbi5oYXNoLnN1YnN0cmluZyggMSApOwoKCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCApIHsKCQkJLy8gY2hlY2sgdGhlIGZyYWdtZW50IGlkZW50aWZpZXIgaW4gdGhlIFVSTAoJCQlpZiAoIGxvY2F0aW9uSGFzaCApIHsKCQkJCXRoaXMudGFicy5lYWNoKGZ1bmN0aW9uKCBpLCB0YWIgKSB7CgkJCQkJaWYgKCAkKCB0YWIgKS5hdHRyKCAiYXJpYS1jb250cm9scyIgKSA9PT0gbG9jYXRpb25IYXNoICkgewoJCQkJCQlhY3RpdmUgPSBpOwoJCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQkJfQoJCQkJfSk7CgkJCX0KCgkJCS8vIGNoZWNrIGZvciBhIHRhYiBtYXJrZWQgYWN0aXZlIHZpYSBhIGNsYXNzCgkJCWlmICggYWN0aXZlID09PSBudWxsICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmluZGV4KCB0aGlzLnRhYnMuZmlsdGVyKCAiLnVpLXRhYnMtYWN0aXZlIiApICk7CgkJCX0KCgkJCS8vIG5vIGFjdGl2ZSB0YWIsIHNldCB0byBmYWxzZQoJCQlpZiAoIGFjdGl2ZSA9PT0gbnVsbCB8fCBhY3RpdmUgPT09IC0xICkgewoJCQkJYWN0aXZlID0gdGhpcy50YWJzLmxlbmd0aCA/IDAgOiBmYWxzZTsKCQkJfQoJCX0KCgkJLy8gaGFuZGxlIG51bWJlcnM6IG5lZ2F0aXZlLCBvdXQgb2YgcmFuZ2UKCQlpZiAoIGFjdGl2ZSAhPT0gZmFsc2UgKSB7CgkJCWFjdGl2ZSA9IHRoaXMudGFicy5pbmRleCggdGhpcy50YWJzLmVxKCBhY3RpdmUgKSApOwoJCQlpZiAoIGFjdGl2ZSA9PT0gLTEgKSB7CgkJCQlhY3RpdmUgPSBjb2xsYXBzaWJsZSA/IGZhbHNlIDogMDsKCQkJfQoJCX0KCgkJLy8gZG9uJ3QgYWxsb3cgY29sbGFwc2libGU6IGZhbHNlIGFuZCBhY3RpdmU6IGZhbHNlCgkJaWYgKCAhY29sbGFwc2libGUgJiYgYWN0aXZlID09PSBmYWxzZSAmJiB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQlhY3RpdmUgPSAwOwoJCX0KCgkJcmV0dXJuIGFjdGl2ZTsKCX0sCgoJX2dldENyZWF0ZUV2ZW50RGF0YTogZnVuY3Rpb24oKSB7CgkJcmV0dXJuIHsKCQkJdGFiOiB0aGlzLmFjdGl2ZSwKCQkJcGFuZWw6ICF0aGlzLmFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKQoJCX07Cgl9LAoKCV90YWJLZXlkb3duOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJdmFyIGZvY3VzZWRUYWIgPSAkKCB0aGlzLmRvY3VtZW50WzBdLmFjdGl2ZUVsZW1lbnQgKS5jbG9zZXN0KCAibGkiICksCgkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLnRhYnMuaW5kZXgoIGZvY3VzZWRUYWIgKSwKCQkJZ29pbmdGb3J3YXJkID0gdHJ1ZTsKCgkJaWYgKCB0aGlzLl9oYW5kbGVQYWdlTmF2KCBldmVudCApICkgewoJCQlyZXR1cm47CgkJfQoKCQlzd2l0Y2ggKCBldmVudC5rZXlDb2RlICkgewoJCQljYXNlICQudWkua2V5Q29kZS5SSUdIVDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuRE9XTjoKCQkJCXNlbGVjdGVkSW5kZXgrKzsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5VUDoKCQkJY2FzZSAkLnVpLmtleUNvZGUuTEVGVDoKCQkJCWdvaW5nRm9yd2FyZCA9IGZhbHNlOwoJCQkJc2VsZWN0ZWRJbmRleC0tOwoJCQkJYnJlYWs7CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVORDoKCQkJCXNlbGVjdGVkSW5kZXggPSB0aGlzLmFuY2hvcnMubGVuZ3RoIC0gMTsKCQkJCWJyZWFrOwoJCQljYXNlICQudWkua2V5Q29kZS5IT01FOgoJCQkJc2VsZWN0ZWRJbmRleCA9IDA7CgkJCQlicmVhazsKCQkJY2FzZSAkLnVpLmtleUNvZGUuU1BBQ0U6CgkJCQkvLyBBY3RpdmF0ZSBvbmx5LCBubyBjb2xsYXBzaW5nCgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJY2xlYXJUaW1lb3V0KCB0aGlzLmFjdGl2YXRpbmcgKTsKCQkJCXRoaXMuX2FjdGl2YXRlKCBzZWxlY3RlZEluZGV4ICk7CgkJCQlyZXR1cm47CgkJCWNhc2UgJC51aS5rZXlDb2RlLkVOVEVSOgoJCQkJLy8gVG9nZ2xlIChjYW5jZWwgZGVsYXllZCBhY3RpdmF0aW9uLCBhbGxvdyBjb2xsYXBzaW5nKQoJCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJCWNsZWFyVGltZW91dCggdGhpcy5hY3RpdmF0aW5nICk7CgkJCQkvLyBEZXRlcm1pbmUgaWYgd2Ugc2hvdWxkIGNvbGxhcHNlIG9yIGFjdGl2YXRlCgkJCQl0aGlzLl9hY3RpdmF0ZSggc2VsZWN0ZWRJbmRleCA9PT0gdGhpcy5vcHRpb25zLmFjdGl2ZSA/IGZhbHNlIDogc2VsZWN0ZWRJbmRleCApOwoJCQkJcmV0dXJuOwoJCQlkZWZhdWx0OgoJCQkJcmV0dXJuOwoJCX0KCgkJLy8gRm9jdXMgdGhlIGFwcHJvcHJpYXRlIHRhYiwgYmFzZWQgb24gd2hpY2gga2V5IHdhcyBwcmVzc2VkCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQljbGVhclRpbWVvdXQoIHRoaXMuYWN0aXZhdGluZyApOwoJCXNlbGVjdGVkSW5kZXggPSB0aGlzLl9mb2N1c05leHRUYWIoIHNlbGVjdGVkSW5kZXgsIGdvaW5nRm9yd2FyZCApOwoKCQkvLyBOYXZpZ2F0aW5nIHdpdGggY29udHJvbCBrZXkgd2lsbCBwcmV2ZW50IGF1dG9tYXRpYyBhY3RpdmF0aW9uCgkJaWYgKCAhZXZlbnQuY3RybEtleSApIHsKCQkJLy8gVXBkYXRlIGFyaWEtc2VsZWN0ZWQgaW1tZWRpYXRlbHkgc28gdGhhdCBBVCB0aGluayB0aGUgdGFiIGlzIGFscmVhZHkgc2VsZWN0ZWQuCgkJCS8vIE90aGVyd2lzZSBBVCBtYXkgY29uZnVzZSB0aGUgdXNlciBieSBzdGF0aW5nIHRoYXQgdGhleSBuZWVkIHRvIGFjdGl2YXRlIHRoZSB0YWIsCgkJCS8vIGJ1dCB0aGUgdGFiIHdpbGwgYWxyZWFkeSBiZSBhY3RpdmF0ZWQgYnkgdGhlIHRpbWUgdGhlIGFubm91bmNlbWVudCBmaW5pc2hlcy4KCQkJZm9jdXNlZFRhYi5hdHRyKCAiYXJpYS1zZWxlY3RlZCIsICJmYWxzZSIgKTsKCQkJdGhpcy50YWJzLmVxKCBzZWxlY3RlZEluZGV4ICkuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAidHJ1ZSIgKTsKCgkJCXRoaXMuYWN0aXZhdGluZyA9IHRoaXMuX2RlbGF5KGZ1bmN0aW9uKCkgewoJCQkJdGhpcy5vcHRpb24oICJhY3RpdmUiLCBzZWxlY3RlZEluZGV4ICk7CgkJCX0sIHRoaXMuZGVsYXkgKTsKCQl9Cgl9LAoKCV9wYW5lbEtleWRvd246IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIHRoaXMuX2hhbmRsZVBhZ2VOYXYoIGV2ZW50ICkgKSB7CgkJCXJldHVybjsKCQl9CgoJCS8vIEN0cmwrdXAgbW92ZXMgZm9jdXMgdG8gdGhlIGN1cnJlbnQgdGFiCgkJaWYgKCBldmVudC5jdHJsS2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5VUCApIHsKCQkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQkJdGhpcy5hY3RpdmUuZm9jdXMoKTsKCQl9Cgl9LAoKCS8vIEFsdCtwYWdlIHVwL2Rvd24gbW92ZXMgZm9jdXMgdG8gdGhlIHByZXZpb3VzL25leHQgdGFiIChhbmQgYWN0aXZhdGVzKQoJX2hhbmRsZVBhZ2VOYXY6IGZ1bmN0aW9uKCBldmVudCApIHsKCQlpZiAoIGV2ZW50LmFsdEtleSAmJiBldmVudC5rZXlDb2RlID09PSAkLnVpLmtleUNvZGUuUEFHRV9VUCApIHsKCQkJdGhpcy5fYWN0aXZhdGUoIHRoaXMuX2ZvY3VzTmV4dFRhYiggdGhpcy5vcHRpb25zLmFjdGl2ZSAtIDEsIGZhbHNlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJCWlmICggZXZlbnQuYWx0S2V5ICYmIGV2ZW50LmtleUNvZGUgPT09ICQudWkua2V5Q29kZS5QQUdFX0RPV04gKSB7CgkJCXRoaXMuX2FjdGl2YXRlKCB0aGlzLl9mb2N1c05leHRUYWIoIHRoaXMub3B0aW9ucy5hY3RpdmUgKyAxLCB0cnVlICkgKTsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfSwKCglfZmluZE5leHRUYWI6IGZ1bmN0aW9uKCBpbmRleCwgZ29pbmdGb3J3YXJkICkgewoJCXZhciBsYXN0VGFiSW5kZXggPSB0aGlzLnRhYnMubGVuZ3RoIC0gMTsKCgkJZnVuY3Rpb24gY29uc3RyYWluKCkgewoJCQlpZiAoIGluZGV4ID4gbGFzdFRhYkluZGV4ICkgewoJCQkJaW5kZXggPSAwOwoJCQl9CgkJCWlmICggaW5kZXggPCAwICkgewoJCQkJaW5kZXggPSBsYXN0VGFiSW5kZXg7CgkJCX0KCQkJcmV0dXJuIGluZGV4OwoJCX0KCgkJd2hpbGUgKCAkLmluQXJyYXkoIGNvbnN0cmFpbigpLCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCWluZGV4ID0gZ29pbmdGb3J3YXJkID8gaW5kZXggKyAxIDogaW5kZXggLSAxOwoJCX0KCgkJcmV0dXJuIGluZGV4OwoJfSwKCglfZm9jdXNOZXh0VGFiOiBmdW5jdGlvbiggaW5kZXgsIGdvaW5nRm9yd2FyZCApIHsKCQlpbmRleCA9IHRoaXMuX2ZpbmROZXh0VGFiKCBpbmRleCwgZ29pbmdGb3J3YXJkICk7CgkJdGhpcy50YWJzLmVxKCBpbmRleCApLmZvY3VzKCk7CgkJcmV0dXJuIGluZGV4OwoJfSwKCglfc2V0T3B0aW9uOiBmdW5jdGlvbigga2V5LCB2YWx1ZSApIHsKCQlpZiAoIGtleSA9PT0gImFjdGl2ZSIgKSB7CgkJCS8vIF9hY3RpdmF0ZSgpIHdpbGwgaGFuZGxlIGludmFsaWQgdmFsdWVzIGFuZCB1cGRhdGUgdGhpcy5vcHRpb25zCgkJCXRoaXMuX2FjdGl2YXRlKCB2YWx1ZSApOwoJCQlyZXR1cm47CgkJfQoKCQlpZiAoIGtleSA9PT0gImRpc2FibGVkIiApIHsKCQkJLy8gZG9uJ3QgdXNlIHRoZSB3aWRnZXQgZmFjdG9yeSdzIGRpc2FibGVkIGhhbmRsaW5nCgkJCXRoaXMuX3NldHVwRGlzYWJsZWQoIHZhbHVlICk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX3N1cGVyKCBrZXksIHZhbHVlKTsKCgkJaWYgKCBrZXkgPT09ICJjb2xsYXBzaWJsZSIgKSB7CgkJCXRoaXMuZWxlbWVudC50b2dnbGVDbGFzcyggInVpLXRhYnMtY29sbGFwc2libGUiLCB2YWx1ZSApOwoJCQkvLyBTZXR0aW5nIGNvbGxhcHNpYmxlOiBmYWxzZSB3aGlsZSBjb2xsYXBzZWQ7IG9wZW4gZmlyc3QgcGFuZWwKCQkJaWYgKCAhdmFsdWUgJiYgdGhpcy5vcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgKSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggMCApOwoJCQl9CgkJfQoKCQlpZiAoIGtleSA9PT0gImV2ZW50IiApIHsKCQkJdGhpcy5fc2V0dXBFdmVudHMoIHZhbHVlICk7CgkJfQoKCQlpZiAoIGtleSA9PT0gImhlaWdodFN0eWxlIiApIHsKCQkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdmFsdWUgKTsKCQl9Cgl9LAoKCV90YWJJZDogZnVuY3Rpb24oIHRhYiApIHsKCQlyZXR1cm4gdGFiLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApIHx8ICJ1aS10YWJzLSIgKyBnZXROZXh0VGFiSWQoKTsKCX0sCgoJX3Nhbml0aXplU2VsZWN0b3I6IGZ1bmN0aW9uKCBoYXNoICkgewoJCXJldHVybiBoYXNoID8gaGFzaC5yZXBsYWNlKCAvWyEiJCUmJygpKissLlwvOjs8PT4/QFxbXF1cXmB7fH1+XS9nLCAiXFwkJiIgKSA6ICIiOwoJfSwKCglyZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl2YXIgb3B0aW9ucyA9IHRoaXMub3B0aW9ucywKCQkJbGlzID0gdGhpcy50YWJsaXN0LmNoaWxkcmVuKCAiOmhhcyhhW2hyZWZdKSIgKTsKCgkJLy8gZ2V0IGRpc2FibGVkIHRhYnMgZnJvbSBjbGFzcyBhdHRyaWJ1dGUgZnJvbSBIVE1MCgkJLy8gdGhpcyB3aWxsIGdldCBjb252ZXJ0ZWQgdG8gYSBib29sZWFuIGlmIG5lZWRlZCBpbiBfcmVmcmVzaCgpCgkJb3B0aW9ucy5kaXNhYmxlZCA9ICQubWFwKCBsaXMuZmlsdGVyKCAiLnVpLXN0YXRlLWRpc2FibGVkIiApLCBmdW5jdGlvbiggdGFiICkgewoJCQlyZXR1cm4gbGlzLmluZGV4KCB0YWIgKTsKCQl9KTsKCgkJdGhpcy5fcHJvY2Vzc1RhYnMoKTsKCgkJLy8gd2FzIGNvbGxhcHNlZCBvciBubyB0YWJzCgkJaWYgKCBvcHRpb25zLmFjdGl2ZSA9PT0gZmFsc2UgfHwgIXRoaXMuYW5jaG9ycy5sZW5ndGggKSB7CgkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCXRoaXMuYWN0aXZlID0gJCgpOwoJCS8vIHdhcyBhY3RpdmUsIGJ1dCBhY3RpdmUgdGFiIGlzIGdvbmUKCQl9IGVsc2UgaWYgKCB0aGlzLmFjdGl2ZS5sZW5ndGggJiYgISQuY29udGFpbnMoIHRoaXMudGFibGlzdFsgMCBdLCB0aGlzLmFjdGl2ZVsgMCBdICkgKSB7CgkJCS8vIGFsbCByZW1haW5pbmcgdGFicyBhcmUgZGlzYWJsZWQKCQkJaWYgKCB0aGlzLnRhYnMubGVuZ3RoID09PSBvcHRpb25zLmRpc2FibGVkLmxlbmd0aCApIHsKCQkJCW9wdGlvbnMuYWN0aXZlID0gZmFsc2U7CgkJCQl0aGlzLmFjdGl2ZSA9ICQoKTsKCQkJLy8gYWN0aXZhdGUgcHJldmlvdXMgdGFiCgkJCX0gZWxzZSB7CgkJCQl0aGlzLl9hY3RpdmF0ZSggdGhpcy5fZmluZE5leHRUYWIoIE1hdGgubWF4KCAwLCBvcHRpb25zLmFjdGl2ZSAtIDEgKSwgZmFsc2UgKSApOwoJCQl9CgkJLy8gd2FzIGFjdGl2ZSwgYWN0aXZlIHRhYiBzdGlsbCBleGlzdHMKCQl9IGVsc2UgewoJCQkvLyBtYWtlIHN1cmUgYWN0aXZlIGluZGV4IGlzIGNvcnJlY3QKCQkJb3B0aW9ucy5hY3RpdmUgPSB0aGlzLnRhYnMuaW5kZXgoIHRoaXMuYWN0aXZlICk7CgkJfQoKCQl0aGlzLl9yZWZyZXNoKCk7Cgl9LAoKCV9yZWZyZXNoOiBmdW5jdGlvbigpIHsKCQl0aGlzLl9zZXR1cERpc2FibGVkKCB0aGlzLm9wdGlvbnMuZGlzYWJsZWQgKTsKCQl0aGlzLl9zZXR1cEV2ZW50cyggdGhpcy5vcHRpb25zLmV2ZW50ICk7CgkJdGhpcy5fc2V0dXBIZWlnaHRTdHlsZSggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICk7CgoJCXRoaXMudGFicy5ub3QoIHRoaXMuYWN0aXZlICkuYXR0cih7CgkJCSJhcmlhLXNlbGVjdGVkIjogImZhbHNlIiwKCQkJdGFiSW5kZXg6IC0xCgkJfSk7CgkJdGhpcy5wYW5lbHMubm90KCB0aGlzLl9nZXRQYW5lbEZvclRhYiggdGhpcy5hY3RpdmUgKSApCgkJCS5oaWRlKCkKCQkJLmF0dHIoewoJCQkJImFyaWEtZXhwYW5kZWQiOiAiZmFsc2UiLAoJCQkJImFyaWEtaGlkZGVuIjogInRydWUiCgkJCX0pOwoKCQkvLyBNYWtlIHN1cmUgb25lIHRhYiBpcyBpbiB0aGUgdGFiIG9yZGVyCgkJaWYgKCAhdGhpcy5hY3RpdmUubGVuZ3RoICkgewoJCQl0aGlzLnRhYnMuZXEoIDAgKS5hdHRyKCAidGFiSW5kZXgiLCAwICk7CgkJfSBlbHNlIHsKCQkJdGhpcy5hY3RpdmUKCQkJCS5hZGRDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKQoJCQkJLmF0dHIoewoJCQkJCSJhcmlhLXNlbGVjdGVkIjogInRydWUiLAoJCQkJCXRhYkluZGV4OiAwCgkJCQl9KTsKCQkJdGhpcy5fZ2V0UGFuZWxGb3JUYWIoIHRoaXMuYWN0aXZlICkKCQkJCS5zaG93KCkKCQkJCS5hdHRyKHsKCQkJCQkiYXJpYS1leHBhbmRlZCI6ICJ0cnVlIiwKCQkJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJCQl9KTsKCQl9Cgl9LAoKCV9wcm9jZXNzVGFiczogZnVuY3Rpb24oKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoKCQl0aGlzLnRhYmxpc3QgPSB0aGlzLl9nZXRMaXN0KCkKCQkJLmFkZENsYXNzKCAidWktdGFicy1uYXYgdWktaGVscGVyLXJlc2V0IHVpLWhlbHBlci1jbGVhcmZpeCB1aS13aWRnZXQtaGVhZGVyIHVpLWNvcm5lci1hbGwiICkKCQkJLmF0dHIoICJyb2xlIiwgInRhYmxpc3QiICk7CgoJCXRoaXMudGFicyA9IHRoaXMudGFibGlzdC5maW5kKCAiPiBsaTpoYXMoYVtocmVmXSkiICkKCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGVmYXVsdCB1aS1jb3JuZXItdG9wIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJ0YWIiLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLmFuY2hvcnMgPSB0aGlzLnRhYnMubWFwKGZ1bmN0aW9uKCkgewoJCQkJcmV0dXJuICQoICJhIiwgdGhpcyApWyAwIF07CgkJCX0pCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtYW5jaG9yIiApCgkJCS5hdHRyKHsKCQkJCXJvbGU6ICJwcmVzZW50YXRpb24iLAoJCQkJdGFiSW5kZXg6IC0xCgkJCX0pOwoKCQl0aGlzLnBhbmVscyA9ICQoKTsKCgkJdGhpcy5hbmNob3JzLmVhY2goZnVuY3Rpb24oIGksIGFuY2hvciApIHsKCQkJdmFyIHNlbGVjdG9yLCBwYW5lbCwgcGFuZWxJZCwKCQkJCWFuY2hvcklkID0gJCggYW5jaG9yICkudW5pcXVlSWQoKS5hdHRyKCAiaWQiICksCgkJCQl0YWIgPSAkKCBhbmNob3IgKS5jbG9zZXN0KCAibGkiICksCgkJCQlvcmlnaW5hbEFyaWFDb250cm9scyA9IHRhYi5hdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCgkJCS8vIGlubGluZSB0YWIKCQkJaWYgKCBpc0xvY2FsKCBhbmNob3IgKSApIHsKCQkJCXNlbGVjdG9yID0gYW5jaG9yLmhhc2g7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCB0aGF0Ll9zYW5pdGl6ZVNlbGVjdG9yKCBzZWxlY3RvciApICk7CgkJCS8vIHJlbW90ZSB0YWIKCQkJfSBlbHNlIHsKCQkJCXBhbmVsSWQgPSB0aGF0Ll90YWJJZCggdGFiICk7CgkJCQlzZWxlY3RvciA9ICIjIiArIHBhbmVsSWQ7CgkJCQlwYW5lbCA9IHRoYXQuZWxlbWVudC5maW5kKCBzZWxlY3RvciApOwoJCQkJaWYgKCAhcGFuZWwubGVuZ3RoICkgewoJCQkJCXBhbmVsID0gdGhhdC5fY3JlYXRlUGFuZWwoIHBhbmVsSWQgKTsKCQkJCQlwYW5lbC5pbnNlcnRBZnRlciggdGhhdC5wYW5lbHNbIGkgLSAxIF0gfHwgdGhhdC50YWJsaXN0ICk7CgkJCQl9CgkJCQlwYW5lbC5hdHRyKCAiYXJpYS1saXZlIiwgInBvbGl0ZSIgKTsKCQkJfQoKCQkJaWYgKCBwYW5lbC5sZW5ndGgpIHsKCQkJCXRoYXQucGFuZWxzID0gdGhhdC5wYW5lbHMuYWRkKCBwYW5lbCApOwoJCQl9CgkJCWlmICggb3JpZ2luYWxBcmlhQ29udHJvbHMgKSB7CgkJCQl0YWIuZGF0YSggInVpLXRhYnMtYXJpYS1jb250cm9scyIsIG9yaWdpbmFsQXJpYUNvbnRyb2xzICk7CgkJCX0KCQkJdGFiLmF0dHIoewoJCQkJImFyaWEtY29udHJvbHMiOiBzZWxlY3Rvci5zdWJzdHJpbmcoIDEgKSwKCQkJCSJhcmlhLWxhYmVsbGVkYnkiOiBhbmNob3JJZAoJCQl9KTsKCQkJcGFuZWwuYXR0ciggImFyaWEtbGFiZWxsZWRieSIsIGFuY2hvcklkICk7CgkJfSk7CgoJCXRoaXMucGFuZWxzCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuYXR0ciggInJvbGUiLCAidGFicGFuZWwiICk7Cgl9LAoKCS8vIGFsbG93IG92ZXJyaWRpbmcgaG93IHRvIGZpbmQgdGhlIGxpc3QgZm9yIHJhcmUgdXNhZ2Ugc2NlbmFyaW9zICgjNzcxNSkKCV9nZXRMaXN0OiBmdW5jdGlvbigpIHsKCQlyZXR1cm4gdGhpcy5lbGVtZW50LmZpbmQoICJvbCx1bCIgKS5lcSggMCApOwoJfSwKCglfY3JlYXRlUGFuZWw6IGZ1bmN0aW9uKCBpZCApIHsKCQlyZXR1cm4gJCggIjxkaXY+IiApCgkJCS5hdHRyKCAiaWQiLCBpZCApCgkJCS5hZGRDbGFzcyggInVpLXRhYnMtcGFuZWwgdWktd2lkZ2V0LWNvbnRlbnQgdWktY29ybmVyLWJvdHRvbSIgKQoJCQkuZGF0YSggInVpLXRhYnMtZGVzdHJveSIsIHRydWUgKTsKCX0sCgoJX3NldHVwRGlzYWJsZWQ6IGZ1bmN0aW9uKCBkaXNhYmxlZCApIHsKCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJaWYgKCAhZGlzYWJsZWQubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQkJfSBlbHNlIGlmICggZGlzYWJsZWQubGVuZ3RoID09PSB0aGlzLmFuY2hvcnMubGVuZ3RoICkgewoJCQkJZGlzYWJsZWQgPSB0cnVlOwoJCQl9CgkJfQoKCQkvLyBkaXNhYmxlIHRhYnMKCQlmb3IgKCB2YXIgaSA9IDAsIGxpOyAoIGxpID0gdGhpcy50YWJzWyBpIF0gKTsgaSsrICkgewoJCQlpZiAoIGRpc2FibGVkID09PSB0cnVlIHx8ICQuaW5BcnJheSggaSwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQkkKCBsaSApCgkJCQkJLmFkZENsYXNzKCAidWktc3RhdGUtZGlzYWJsZWQiICkKCQkJCQkuYXR0ciggImFyaWEtZGlzYWJsZWQiLCAidHJ1ZSIgKTsKCQkJfSBlbHNlIHsKCQkJCSQoIGxpICkKCQkJCQkucmVtb3ZlQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1kaXNhYmxlZCIgKTsKCQkJfQoJCX0KCgkJdGhpcy5vcHRpb25zLmRpc2FibGVkID0gZGlzYWJsZWQ7Cgl9LAoKCV9zZXR1cEV2ZW50czogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBldmVudHMgPSB7CgkJCWNsaWNrOiBmdW5jdGlvbiggZXZlbnQgKSB7CgkJCQlldmVudC5wcmV2ZW50RGVmYXVsdCgpOwoJCQl9CgkJfTsKCQlpZiAoIGV2ZW50ICkgewoJCQkkLmVhY2goIGV2ZW50LnNwbGl0KCIgIiksIGZ1bmN0aW9uKCBpbmRleCwgZXZlbnROYW1lICkgewoJCQkJZXZlbnRzWyBldmVudE5hbWUgXSA9ICJfZXZlbnRIYW5kbGVyIjsKCQkJfSk7CgkJfQoKCQl0aGlzLl9vZmYoIHRoaXMuYW5jaG9ycy5hZGQoIHRoaXMudGFicyApLmFkZCggdGhpcy5wYW5lbHMgKSApOwoJCXRoaXMuX29uKCB0aGlzLmFuY2hvcnMsIGV2ZW50cyApOwoJCXRoaXMuX29uKCB0aGlzLnRhYnMsIHsga2V5ZG93bjogIl90YWJLZXlkb3duIiB9ICk7CgkJdGhpcy5fb24oIHRoaXMucGFuZWxzLCB7IGtleWRvd246ICJfcGFuZWxLZXlkb3duIiB9ICk7CgoJCXRoaXMuX2ZvY3VzYWJsZSggdGhpcy50YWJzICk7CgkJdGhpcy5faG92ZXJhYmxlKCB0aGlzLnRhYnMgKTsKCX0sCgoJX3NldHVwSGVpZ2h0U3R5bGU6IGZ1bmN0aW9uKCBoZWlnaHRTdHlsZSApIHsKCQl2YXIgbWF4SGVpZ2h0LAoJCQlwYXJlbnQgPSB0aGlzLmVsZW1lbnQucGFyZW50KCk7CgoJCWlmICggaGVpZ2h0U3R5bGUgPT09ICJmaWxsIiApIHsKCQkJbWF4SGVpZ2h0ID0gcGFyZW50LmhlaWdodCgpOwoJCQltYXhIZWlnaHQgLT0gdGhpcy5lbGVtZW50Lm91dGVySGVpZ2h0KCkgLSB0aGlzLmVsZW1lbnQuaGVpZ2h0KCk7CgoJCQl0aGlzLmVsZW1lbnQuc2libGluZ3MoICI6dmlzaWJsZSIgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJdmFyIGVsZW0gPSAkKCB0aGlzICksCgkJCQkJcG9zaXRpb24gPSBlbGVtLmNzcyggInBvc2l0aW9uIiApOwoKCQkJCWlmICggcG9zaXRpb24gPT09ICJhYnNvbHV0ZSIgfHwgcG9zaXRpb24gPT09ICJmaXhlZCIgKSB7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJbWF4SGVpZ2h0IC09IGVsZW0ub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLmVsZW1lbnQuY2hpbGRyZW4oKS5ub3QoIHRoaXMucGFuZWxzICkuZWFjaChmdW5jdGlvbigpIHsKCQkJCW1heEhlaWdodCAtPSAkKCB0aGlzICkub3V0ZXJIZWlnaHQoIHRydWUgKTsKCQkJfSk7CgoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJJCggdGhpcyApLmhlaWdodCggTWF0aC5tYXgoIDAsIG1heEhlaWdodCAtCgkJCQkJJCggdGhpcyApLmlubmVySGVpZ2h0KCkgKyAkKCB0aGlzICkuaGVpZ2h0KCkgKSApOwoJCQl9KQoJCQkuY3NzKCAib3ZlcmZsb3ciLCAiYXV0byIgKTsKCQl9IGVsc2UgaWYgKCBoZWlnaHRTdHlsZSA9PT0gImF1dG8iICkgewoJCQltYXhIZWlnaHQgPSAwOwoJCQl0aGlzLnBhbmVscy5lYWNoKGZ1bmN0aW9uKCkgewoJCQkJbWF4SGVpZ2h0ID0gTWF0aC5tYXgoIG1heEhlaWdodCwgJCggdGhpcyApLmhlaWdodCggIiIgKS5oZWlnaHQoKSApOwoJCQl9KS5oZWlnaHQoIG1heEhlaWdodCApOwoJCX0KCX0sCgoJX2V2ZW50SGFuZGxlcjogZnVuY3Rpb24oIGV2ZW50ICkgewoJCXZhciBvcHRpb25zID0gdGhpcy5vcHRpb25zLAoJCQlhY3RpdmUgPSB0aGlzLmFjdGl2ZSwKCQkJYW5jaG9yID0gJCggZXZlbnQuY3VycmVudFRhcmdldCApLAoJCQl0YWIgPSBhbmNob3IuY2xvc2VzdCggImxpIiApLAoJCQljbGlja2VkSXNBY3RpdmUgPSB0YWJbIDAgXSA9PT0gYWN0aXZlWyAwIF0sCgkJCWNvbGxhcHNpbmcgPSBjbGlja2VkSXNBY3RpdmUgJiYgb3B0aW9ucy5jb2xsYXBzaWJsZSwKCQkJdG9TaG93ID0gY29sbGFwc2luZyA/ICQoKSA6IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJdG9IaWRlID0gIWFjdGl2ZS5sZW5ndGggPyAkKCkgOiB0aGlzLl9nZXRQYW5lbEZvclRhYiggYWN0aXZlICksCgkJCWV2ZW50RGF0YSA9IHsKCQkJCW9sZFRhYjogYWN0aXZlLAoJCQkJb2xkUGFuZWw6IHRvSGlkZSwKCQkJCW5ld1RhYjogY29sbGFwc2luZyA/ICQoKSA6IHRhYiwKCQkJCW5ld1BhbmVsOiB0b1Nob3cKCQkJfTsKCgkJZXZlbnQucHJldmVudERlZmF1bHQoKTsKCgkJaWYgKCB0YWIuaGFzQ2xhc3MoICJ1aS1zdGF0ZS1kaXNhYmxlZCIgKSB8fAoJCQkJLy8gdGFiIGlzIGFscmVhZHkgbG9hZGluZwoJCQkJdGFiLmhhc0NsYXNzKCAidWktdGFicy1sb2FkaW5nIiApIHx8CgkJCQkvLyBjYW4ndCBzd2l0Y2ggZHVybmluZyBhbiBhbmltYXRpb24KCQkJCXRoaXMucnVubmluZyB8fAoJCQkJLy8gY2xpY2sgb24gYWN0aXZlIGhlYWRlciwgYnV0IG5vdCBjb2xsYXBzaWJsZQoJCQkJKCBjbGlja2VkSXNBY3RpdmUgJiYgIW9wdGlvbnMuY29sbGFwc2libGUgKSB8fAoJCQkJLy8gYWxsb3cgY2FuY2VsaW5nIGFjdGl2YXRpb24KCQkJCSggdGhpcy5fdHJpZ2dlciggImJlZm9yZUFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApID09PSBmYWxzZSApICkgewoJCQlyZXR1cm47CgkJfQoKCQlvcHRpb25zLmFjdGl2ZSA9IGNvbGxhcHNpbmcgPyBmYWxzZSA6IHRoaXMudGFicy5pbmRleCggdGFiICk7CgoJCXRoaXMuYWN0aXZlID0gY2xpY2tlZElzQWN0aXZlID8gJCgpIDogdGFiOwoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQlpZiAoICF0b0hpZGUubGVuZ3RoICYmICF0b1Nob3cubGVuZ3RoICkgewoJCQkkLmVycm9yKCAialF1ZXJ5IFVJIFRhYnM6IE1pc21hdGNoaW5nIGZyYWdtZW50IGlkZW50aWZpZXIuIiApOwoJCX0KCgkJaWYgKCB0b1Nob3cubGVuZ3RoICkgewoJCQl0aGlzLmxvYWQoIHRoaXMudGFicy5pbmRleCggdGFiICksIGV2ZW50ICk7CgkJfQoJCXRoaXMuX3RvZ2dsZSggZXZlbnQsIGV2ZW50RGF0YSApOwoJfSwKCgkvLyBoYW5kbGVzIHNob3cvaGlkZSBmb3Igc2VsZWN0aW5nIHRhYnMKCV90b2dnbGU6IGZ1bmN0aW9uKCBldmVudCwgZXZlbnREYXRhICkgewoJCXZhciB0aGF0ID0gdGhpcywKCQkJdG9TaG93ID0gZXZlbnREYXRhLm5ld1BhbmVsLAoJCQl0b0hpZGUgPSBldmVudERhdGEub2xkUGFuZWw7CgoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCWZ1bmN0aW9uIGNvbXBsZXRlKCkgewoJCQl0aGF0LnJ1bm5pbmcgPSBmYWxzZTsKCQkJdGhhdC5fdHJpZ2dlciggImFjdGl2YXRlIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCX0KCgkJZnVuY3Rpb24gc2hvdygpIHsKCQkJZXZlbnREYXRhLm5ld1RhYi5jbG9zZXN0KCAibGkiICkuYWRkQ2xhc3MoICJ1aS10YWJzLWFjdGl2ZSB1aS1zdGF0ZS1hY3RpdmUiICk7CgoJCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdGhhdC5vcHRpb25zLnNob3cgKSB7CgkJCQl0aGF0Ll9zaG93KCB0b1Nob3csIHRoYXQub3B0aW9ucy5zaG93LCBjb21wbGV0ZSApOwoJCQl9IGVsc2UgewoJCQkJdG9TaG93LnNob3coKTsKCQkJCWNvbXBsZXRlKCk7CgkJCX0KCQl9CgoJCS8vIHN0YXJ0IG91dCBieSBoaWRpbmcsIHRoZW4gc2hvd2luZywgdGhlbiBjb21wbGV0aW5nCgkJaWYgKCB0b0hpZGUubGVuZ3RoICYmIHRoaXMub3B0aW9ucy5oaWRlICkgewoJCQl0aGlzLl9oaWRlKCB0b0hpZGUsIHRoaXMub3B0aW9ucy5oaWRlLCBmdW5jdGlvbigpIHsKCQkJCWV2ZW50RGF0YS5vbGRUYWIuY2xvc2VzdCggImxpIiApLnJlbW92ZUNsYXNzKCAidWktdGFicy1hY3RpdmUgdWktc3RhdGUtYWN0aXZlIiApOwoJCQkJc2hvdygpOwoJCQl9KTsKCQl9IGVsc2UgewoJCQlldmVudERhdGEub2xkVGFiLmNsb3Nlc3QoICJsaSIgKS5yZW1vdmVDbGFzcyggInVpLXRhYnMtYWN0aXZlIHVpLXN0YXRlLWFjdGl2ZSIgKTsKCQkJdG9IaWRlLmhpZGUoKTsKCQkJc2hvdygpOwoJCX0KCgkJdG9IaWRlLmF0dHIoewoJCQkiYXJpYS1leHBhbmRlZCI6ICJmYWxzZSIsCgkJCSJhcmlhLWhpZGRlbiI6ICJ0cnVlIgoJCX0pOwoJCWV2ZW50RGF0YS5vbGRUYWIuYXR0ciggImFyaWEtc2VsZWN0ZWQiLCAiZmFsc2UiICk7CgkJLy8gSWYgd2UncmUgc3dpdGNoaW5nIHRhYnMsIHJlbW92ZSB0aGUgb2xkIHRhYiBmcm9tIHRoZSB0YWIgb3JkZXIuCgkJLy8gSWYgd2UncmUgb3BlbmluZyBmcm9tIGNvbGxhcHNlZCBzdGF0ZSwgcmVtb3ZlIHRoZSBwcmV2aW91cyB0YWIgZnJvbSB0aGUgdGFiIG9yZGVyLgoJCS8vIElmIHdlJ3JlIGNvbGxhcHNpbmcsIHRoZW4ga2VlcCB0aGUgY29sbGFwc2luZyB0YWIgaW4gdGhlIHRhYiBvcmRlci4KCQlpZiAoIHRvU2hvdy5sZW5ndGggJiYgdG9IaWRlLmxlbmd0aCApIHsKCQkJZXZlbnREYXRhLm9sZFRhYi5hdHRyKCAidGFiSW5kZXgiLCAtMSApOwoJCX0gZWxzZSBpZiAoIHRvU2hvdy5sZW5ndGggKSB7CgkJCXRoaXMudGFicy5maWx0ZXIoZnVuY3Rpb24oKSB7CgkJCQlyZXR1cm4gJCggdGhpcyApLmF0dHIoICJ0YWJJbmRleCIgKSA9PT0gMDsKCQkJfSkKCQkJLmF0dHIoICJ0YWJJbmRleCIsIC0xICk7CgkJfQoKCQl0b1Nob3cuYXR0cih7CgkJCSJhcmlhLWV4cGFuZGVkIjogInRydWUiLAoJCQkiYXJpYS1oaWRkZW4iOiAiZmFsc2UiCgkJfSk7CgkJZXZlbnREYXRhLm5ld1RhYi5hdHRyKHsKCQkJImFyaWEtc2VsZWN0ZWQiOiAidHJ1ZSIsCgkJCXRhYkluZGV4OiAwCgkJfSk7Cgl9LAoKCV9hY3RpdmF0ZTogZnVuY3Rpb24oIGluZGV4ICkgewoJCXZhciBhbmNob3IsCgkJCWFjdGl2ZSA9IHRoaXMuX2ZpbmRBY3RpdmUoIGluZGV4ICk7CgoJCS8vIHRyeWluZyB0byBhY3RpdmF0ZSB0aGUgYWxyZWFkeSBhY3RpdmUgcGFuZWwKCQlpZiAoIGFjdGl2ZVsgMCBdID09PSB0aGlzLmFjdGl2ZVsgMCBdICkgewoJCQlyZXR1cm47CgkJfQoKCQkvLyB0cnlpbmcgdG8gY29sbGFwc2UsIHNpbXVsYXRlIGEgY2xpY2sgb24gdGhlIGN1cnJlbnQgYWN0aXZlIGhlYWRlcgoJCWlmICggIWFjdGl2ZS5sZW5ndGggKSB7CgkJCWFjdGl2ZSA9IHRoaXMuYWN0aXZlOwoJCX0KCgkJYW5jaG9yID0gYWN0aXZlLmZpbmQoICIudWktdGFicy1hbmNob3IiIClbIDAgXTsKCQl0aGlzLl9ldmVudEhhbmRsZXIoewoJCQl0YXJnZXQ6IGFuY2hvciwKCQkJY3VycmVudFRhcmdldDogYW5jaG9yLAoJCQlwcmV2ZW50RGVmYXVsdDogJC5ub29wCgkJfSk7Cgl9LAoKCV9maW5kQWN0aXZlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJcmV0dXJuIGluZGV4ID09PSBmYWxzZSA/ICQoKSA6IHRoaXMudGFicy5lcSggaW5kZXggKTsKCX0sCgoJX2dldEluZGV4OiBmdW5jdGlvbiggaW5kZXggKSB7CgkJLy8gbWV0YS1mdW5jdGlvbiB0byBnaXZlIHVzZXJzIG9wdGlvbiB0byBwcm92aWRlIGEgaHJlZiBzdHJpbmcgaW5zdGVhZCBvZiBhIG51bWVyaWNhbCBpbmRleC4KCQlpZiAoIHR5cGVvZiBpbmRleCA9PT0gInN0cmluZyIgKSB7CgkJCWluZGV4ID0gdGhpcy5hbmNob3JzLmluZGV4KCB0aGlzLmFuY2hvcnMuZmlsdGVyKCAiW2hyZWYkPSciICsgaW5kZXggKyAiJ10iICkgKTsKCQl9CgoJCXJldHVybiBpbmRleDsKCX0sCgoJX2Rlc3Ryb3k6IGZ1bmN0aW9uKCkgewoJCWlmICggdGhpcy54aHIgKSB7CgkJCXRoaXMueGhyLmFib3J0KCk7CgkJfQoKCQl0aGlzLmVsZW1lbnQucmVtb3ZlQ2xhc3MoICJ1aS10YWJzIHVpLXdpZGdldCB1aS13aWRnZXQtY29udGVudCB1aS1jb3JuZXItYWxsIHVpLXRhYnMtY29sbGFwc2libGUiICk7CgoJCXRoaXMudGFibGlzdAoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLW5hdiB1aS1oZWxwZXItcmVzZXQgdWktaGVscGVyLWNsZWFyZml4IHVpLXdpZGdldC1oZWFkZXIgdWktY29ybmVyLWFsbCIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICk7CgoJCXRoaXMuYW5jaG9ycwoJCQkucmVtb3ZlQ2xhc3MoICJ1aS10YWJzLWFuY2hvciIgKQoJCQkucmVtb3ZlQXR0ciggInJvbGUiICkKCQkJLnJlbW92ZUF0dHIoICJ0YWJJbmRleCIgKQoJCQkucmVtb3ZlVW5pcXVlSWQoKTsKCgkJdGhpcy50YWJzLmFkZCggdGhpcy5wYW5lbHMgKS5lYWNoKGZ1bmN0aW9uKCkgewoJCQlpZiAoICQuZGF0YSggdGhpcywgInVpLXRhYnMtZGVzdHJveSIgKSApIHsKCQkJCSQoIHRoaXMgKS5yZW1vdmUoKTsKCQkJfSBlbHNlIHsKCQkJCSQoIHRoaXMgKQoJCQkJCS5yZW1vdmVDbGFzcyggInVpLXN0YXRlLWRlZmF1bHQgdWktc3RhdGUtYWN0aXZlIHVpLXN0YXRlLWRpc2FibGVkICIgKwoJCQkJCQkidWktY29ybmVyLXRvcCB1aS1jb3JuZXItYm90dG9tIHVpLXdpZGdldC1jb250ZW50IHVpLXRhYnMtYWN0aXZlIHVpLXRhYnMtcGFuZWwiICkKCQkJCQkucmVtb3ZlQXR0ciggInRhYkluZGV4IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWxpdmUiICkKCQkJCQkucmVtb3ZlQXR0ciggImFyaWEtYnVzeSIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1zZWxlY3RlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1sYWJlbGxlZGJ5IiApCgkJCQkJLnJlbW92ZUF0dHIoICJhcmlhLWhpZGRlbiIgKQoJCQkJCS5yZW1vdmVBdHRyKCAiYXJpYS1leHBhbmRlZCIgKQoJCQkJCS5yZW1vdmVBdHRyKCAicm9sZSIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnRhYnMuZWFjaChmdW5jdGlvbigpIHsKCQkJdmFyIGxpID0gJCggdGhpcyApLAoJCQkJcHJldiA9IGxpLmRhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCWlmICggcHJldiApIHsKCQkJCWxpCgkJCQkJLmF0dHIoICJhcmlhLWNvbnRyb2xzIiwgcHJldiApCgkJCQkJLnJlbW92ZURhdGEoICJ1aS10YWJzLWFyaWEtY29udHJvbHMiICk7CgkJCX0gZWxzZSB7CgkJCQlsaS5yZW1vdmVBdHRyKCAiYXJpYS1jb250cm9scyIgKTsKCQkJfQoJCX0pOwoKCQl0aGlzLnBhbmVscy5zaG93KCk7CgoJCWlmICggdGhpcy5vcHRpb25zLmhlaWdodFN0eWxlICE9PSAiY29udGVudCIgKSB7CgkJCXRoaXMucGFuZWxzLmNzcyggImhlaWdodCIsICIiICk7CgkJfQoJfSwKCgllbmFibGU6IGZ1bmN0aW9uKCBpbmRleCApIHsKCQl2YXIgZGlzYWJsZWQgPSB0aGlzLm9wdGlvbnMuZGlzYWJsZWQ7CgkJaWYgKCBkaXNhYmxlZCA9PT0gZmFsc2UgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSBmYWxzZTsKCQl9IGVsc2UgewoJCQlpbmRleCA9IHRoaXMuX2dldEluZGV4KCBpbmRleCApOwoJCQlpZiAoICQuaXNBcnJheSggZGlzYWJsZWQgKSApIHsKCQkJCWRpc2FibGVkID0gJC5tYXAoIGRpc2FibGVkLCBmdW5jdGlvbiggbnVtICkgewoJCQkJCXJldHVybiBudW0gIT09IGluZGV4ID8gbnVtIDogbnVsbDsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJZGlzYWJsZWQgPSAkLm1hcCggdGhpcy50YWJzLCBmdW5jdGlvbiggbGksIG51bSApIHsKCQkJCQlyZXR1cm4gbnVtICE9PSBpbmRleCA/IG51bSA6IG51bGw7CgkJCQl9KTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglkaXNhYmxlOiBmdW5jdGlvbiggaW5kZXggKSB7CgkJdmFyIGRpc2FibGVkID0gdGhpcy5vcHRpb25zLmRpc2FibGVkOwoJCWlmICggZGlzYWJsZWQgPT09IHRydWUgKSB7CgkJCXJldHVybjsKCQl9CgoJCWlmICggaW5kZXggPT09IHVuZGVmaW5lZCApIHsKCQkJZGlzYWJsZWQgPSB0cnVlOwoJCX0gZWxzZSB7CgkJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJCWlmICggJC5pbkFycmF5KCBpbmRleCwgZGlzYWJsZWQgKSAhPT0gLTEgKSB7CgkJCQlyZXR1cm47CgkJCX0KCQkJaWYgKCAkLmlzQXJyYXkoIGRpc2FibGVkICkgKSB7CgkJCQlkaXNhYmxlZCA9ICQubWVyZ2UoIFsgaW5kZXggXSwgZGlzYWJsZWQgKS5zb3J0KCk7CgkJCX0gZWxzZSB7CgkJCQlkaXNhYmxlZCA9IFsgaW5kZXggXTsKCQkJfQoJCX0KCQl0aGlzLl9zZXR1cERpc2FibGVkKCBkaXNhYmxlZCApOwoJfSwKCglsb2FkOiBmdW5jdGlvbiggaW5kZXgsIGV2ZW50ICkgewoJCWluZGV4ID0gdGhpcy5fZ2V0SW5kZXgoIGluZGV4ICk7CgkJdmFyIHRoYXQgPSB0aGlzLAoJCQl0YWIgPSB0aGlzLnRhYnMuZXEoIGluZGV4ICksCgkJCWFuY2hvciA9IHRhYi5maW5kKCAiLnVpLXRhYnMtYW5jaG9yIiApLAoJCQlwYW5lbCA9IHRoaXMuX2dldFBhbmVsRm9yVGFiKCB0YWIgKSwKCQkJZXZlbnREYXRhID0gewoJCQkJdGFiOiB0YWIsCgkJCQlwYW5lbDogcGFuZWwKCQkJfTsKCgkJLy8gbm90IHJlbW90ZQoJCWlmICggaXNMb2NhbCggYW5jaG9yWyAwIF0gKSApIHsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy54aHIgPSAkLmFqYXgoIHRoaXMuX2FqYXhTZXR0aW5ncyggYW5jaG9yLCBldmVudCwgZXZlbnREYXRhICkgKTsKCgkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkvLyBqUXVlcnkgPDEuOCByZXR1cm5zIGZhbHNlIGlmIHRoZSByZXF1ZXN0IGlzIGNhbmNlbGVkIGluIGJlZm9yZVNlbmQsCgkJLy8gYnV0IGFzIG9mIDEuOCwgJC5hamF4KCkgYWx3YXlzIHJldHVybnMgYSBqcVhIUiBvYmplY3QuCgkJaWYgKCB0aGlzLnhociAmJiB0aGlzLnhoci5zdGF0dXNUZXh0ICE9PSAiY2FuY2VsZWQiICkgewoJCQl0YWIuYWRkQ2xhc3MoICJ1aS10YWJzLWxvYWRpbmciICk7CgkJCXBhbmVsLmF0dHIoICJhcmlhLWJ1c3kiLCAidHJ1ZSIgKTsKCgkJCXRoaXMueGhyCgkJCQkuc3VjY2VzcyhmdW5jdGlvbiggcmVzcG9uc2UgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCXBhbmVsLmh0bWwoIHJlc3BvbnNlICk7CgkJCQkJCXRoYXQuX3RyaWdnZXIoICJsb2FkIiwgZXZlbnQsIGV2ZW50RGF0YSApOwoJCQkJCX0sIDEgKTsKCQkJCX0pCgkJCQkuY29tcGxldGUoZnVuY3Rpb24oIGpxWEhSLCBzdGF0dXMgKSB7CgkJCQkJLy8gc3VwcG9ydDogalF1ZXJ5IDwxLjgKCQkJCQkvLyBodHRwOi8vYnVncy5qcXVlcnkuY29tL3RpY2tldC8xMTc3OAoJCQkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkJCWlmICggc3RhdHVzID09PSAiYWJvcnQiICkgewoJCQkJCQkJdGhhdC5wYW5lbHMuc3RvcCggZmFsc2UsIHRydWUgKTsKCQkJCQkJfQoKCQkJCQkJdGFiLnJlbW92ZUNsYXNzKCAidWktdGFicy1sb2FkaW5nIiApOwoJCQkJCQlwYW5lbC5yZW1vdmVBdHRyKCAiYXJpYS1idXN5IiApOwoKCQkJCQkJaWYgKCBqcVhIUiA9PT0gdGhhdC54aHIgKSB7CgkJCQkJCQlkZWxldGUgdGhhdC54aHI7CgkJCQkJCX0KCQkJCQl9LCAxICk7CgkJCQl9KTsKCQl9Cgl9LAoKCV9hamF4U2V0dGluZ3M6IGZ1bmN0aW9uKCBhbmNob3IsIGV2ZW50LCBldmVudERhdGEgKSB7CgkJdmFyIHRoYXQgPSB0aGlzOwoJCXJldHVybiB7CgkJCXVybDogYW5jaG9yLmF0dHIoICJocmVmIiApLAoJCQliZWZvcmVTZW5kOiBmdW5jdGlvbigganFYSFIsIHNldHRpbmdzICkgewoJCQkJcmV0dXJuIHRoYXQuX3RyaWdnZXIoICJiZWZvcmVMb2FkIiwgZXZlbnQsCgkJCQkJJC5leHRlbmQoIHsganFYSFIgOiBqcVhIUiwgYWpheFNldHRpbmdzOiBzZXR0aW5ncyB9LCBldmVudERhdGEgKSApOwoJCQl9CgkJfTsKCX0sCgoJX2dldFBhbmVsRm9yVGFiOiBmdW5jdGlvbiggdGFiICkgewoJCXZhciBpZCA9ICQoIHRhYiApLmF0dHIoICJhcmlhLWNvbnRyb2xzIiApOwoJCXJldHVybiB0aGlzLmVsZW1lbnQuZmluZCggdGhpcy5fc2FuaXRpemVTZWxlY3RvciggIiMiICsgaWQgKSApOwoJfQp9KTsKCn0pKCBqUXVlcnkgKTsKCihmdW5jdGlvbiggJCwgdW5kZWZpbmVkICkgewoKfSkoIGpRdWVyeSApOwoKKGZ1bmN0aW9uKCAkLCB3aW5kb3cgKSB7CgoJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gdHJ1ZTsKCgkvLyBUaGlzIGZpeCBhZGRyZXNzZXMgYW4gaU9TIGJ1Zywgc28gcmV0dXJuIGVhcmx5IGlmIHRoZSBVQSBjbGFpbXMgaXQncyBzb21ldGhpbmcgZWxzZS4KCXZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQsCgkJem9vbSwKCQlldnQsIHgsIHksIHosIGFpZzsKCWlmICggISggL2lQaG9uZXxpUGFkfGlQb2QvLnRlc3QoIG5hdmlnYXRvci5wbGF0Zm9ybSApICYmIC9PUyBbMS01XV9bMC05X10qIGxpa2UgTWFjIE9TIFgvaS50ZXN0KCB1YSApICYmIHVhLmluZGV4T2YoICJBcHBsZVdlYktpdCIgKSA+IC0xICkgKSB7CgkJJC5tb2JpbGUuaW9zb3JpZW50YXRpb25maXhFbmFibGVkID0gZmFsc2U7CgkJcmV0dXJuOwoJfQoKCXpvb20gPSAkLm1vYmlsZS56b29tOwoKCWZ1bmN0aW9uIGNoZWNrVGlsdCggZSApIHsKCQlldnQgPSBlLm9yaWdpbmFsRXZlbnQ7CgkJYWlnID0gZXZ0LmFjY2VsZXJhdGlvbkluY2x1ZGluZ0dyYXZpdHk7CgoJCXggPSBNYXRoLmFicyggYWlnLnggKTsKCQl5ID0gTWF0aC5hYnMoIGFpZy55ICk7CgkJeiA9IE1hdGguYWJzKCBhaWcueiApOwoKCQkvLyBJZiBwb3J0cmFpdCBvcmllbnRhdGlvbiBhbmQgaW4gb25lIG9mIHRoZSBkYW5nZXIgem9uZXMKCQlpZiAoICF3aW5kb3cub3JpZW50YXRpb24gJiYgKCB4ID4gNyB8fCAoICggeiA+IDYgJiYgeSA8IDggfHwgeiA8IDggJiYgeSA+IDYgKSAmJiB4ID4gNSApICkgKSB7CgkJCQlpZiAoIHpvb20uZW5hYmxlZCApIHsKCQkJCQl6b29tLmRpc2FibGUoKTsKCQkJCX0KCQl9CWVsc2UgaWYgKCAhem9vbS5lbmFibGVkICkgewoJCQkJem9vbS5lbmFibGUoKTsKCQl9Cgl9CgoJJC5tb2JpbGUuZG9jdW1lbnQub24oICJtb2JpbGVpbml0IiwgZnVuY3Rpb24oKSB7CgkJaWYgKCAkLm1vYmlsZS5pb3NvcmllbnRhdGlvbmZpeEVuYWJsZWQgKSB7CgkJCSQubW9iaWxlLndpbmRvdwoJCQkJLmJpbmQoICJvcmllbnRhdGlvbmNoYW5nZS5pb3NvcmllbnRhdGlvbmZpeCIsIHpvb20uZW5hYmxlICkKCQkJCS5iaW5kKCAiZGV2aWNlbW90aW9uLmlvc29yaWVudGF0aW9uZml4IiwgY2hlY2tUaWx0ICk7CgkJfQoJfSk7Cgp9KCBqUXVlcnksIHRoaXMgKSk7CgooZnVuY3Rpb24oICQsIHdpbmRvdywgdW5kZWZpbmVkICkgewoJdmFyCSRodG1sID0gJCggImh0bWwiICksCgkJJHdpbmRvdyA9ICQubW9iaWxlLndpbmRvdzsKCgkvL3JlbW92ZSBpbml0aWFsIGJ1aWxkIGNsYXNzIChvbmx5IHByZXNlbnQgb24gZmlyc3QgcGFnZXNob3cpCglmdW5jdGlvbiBoaWRlUmVuZGVyaW5nQ2xhc3MoKSB7CgkJJGh0bWwucmVtb3ZlQ2xhc3MoICJ1aS1tb2JpbGUtcmVuZGVyaW5nIiApOwoJfQoKCS8vIHRyaWdnZXIgbW9iaWxlaW5pdCBldmVudCAtIHVzZWZ1bCBob29rIGZvciBjb25maWd1cmluZyAkLm1vYmlsZSBzZXR0aW5ncyBiZWZvcmUgdGhleSdyZSB1c2VkCgkkKCB3aW5kb3cuZG9jdW1lbnQgKS50cmlnZ2VyKCAibW9iaWxlaW5pdCIgKTsKCgkvLyBzdXBwb3J0IGNvbmRpdGlvbnMKCS8vIGlmIGRldmljZSBzdXBwb3J0IGNvbmRpdGlvbihzKSBhcmVuJ3QgbWV0LCBsZWF2ZSB0aGluZ3MgYXMgdGhleSBhcmUgLT4gYSBiYXNpYywgdXNhYmxlIGV4cGVyaWVuY2UsCgkvLyBvdGhlcndpc2UsIHByb2NlZWQgd2l0aCB0aGUgZW5oYW5jZW1lbnRzCglpZiAoICEkLm1vYmlsZS5ncmFkZUEoKSApIHsKCQlyZXR1cm47Cgl9CgoJLy8gb3ZlcnJpZGUgYWpheEVuYWJsZWQgb24gcGxhdGZvcm1zIHRoYXQgaGF2ZSBrbm93biBjb25mbGljdHMgd2l0aCBoYXNoIGhpc3RvcnkgdXBkYXRlcwoJLy8gb3IgZ2VuZXJhbGx5IHdvcmsgYmV0dGVyIGJyb3dzaW5nIGluIHJlZ3VsYXIgaHR0cCBmb3IgZnVsbCBwYWdlIHJlZnJlc2hlcyAoQkI1LCBPcGVyYSBNaW5pKQoJaWYgKCAkLm1vYmlsZS5hamF4QmxhY2tsaXN0ICkgewoJCSQubW9iaWxlLmFqYXhFbmFibGVkID0gZmFsc2U7Cgl9CgoJLy8gQWRkIG1vYmlsZSwgaW5pdGlhbCBsb2FkICJyZW5kZXJpbmciIGNsYXNzZXMgdG8gZG9jRWwKCSRodG1sLmFkZENsYXNzKCAidWktbW9iaWxlIHVpLW1vYmlsZS1yZW5kZXJpbmciICk7CgoJLy8gVGhpcyBpcyBhIGZhbGxiYWNrLiBJZiBhbnl0aGluZyBnb2VzIHdyb25nIChKUyBlcnJvcnMsIGV0YyksIG9yIGV2ZW50cyBkb24ndCBmaXJlLAoJLy8gdGhpcyBlbnN1cmVzIHRoZSByZW5kZXJpbmcgY2xhc3MgaXMgcmVtb3ZlZCBhZnRlciA1IHNlY29uZHMsIHNvIGNvbnRlbnQgaXMgdmlzaWJsZSBhbmQgYWNjZXNzaWJsZQoJc2V0VGltZW91dCggaGlkZVJlbmRlcmluZ0NsYXNzLCA1MDAwICk7CgoJJC5leHRlbmQoICQubW9iaWxlLCB7CgkJLy8gZmluZCBhbmQgZW5oYW5jZSB0aGUgcGFnZXMgaW4gdGhlIGRvbSBhbmQgdHJhbnNpdGlvbiB0byB0aGUgZmlyc3QgcGFnZS4KCQlpbml0aWFsaXplUGFnZTogZnVuY3Rpb24oKSB7CgkJCS8vIGZpbmQgcHJlc2VudCBwYWdlcwoJCQl2YXIgcGF0aCA9ICQubW9iaWxlLnBhdGgsCgkJCQkkcGFnZXMgPSAkKCAiOmpxbURhdGEocm9sZT0ncGFnZScpLCA6anFtRGF0YShyb2xlPSdkaWFsb2cnKSIgKSwKCQkJCWhhc2ggPSBwYXRoLnN0cmlwSGFzaCggcGF0aC5zdHJpcFF1ZXJ5UGFyYW1zKHBhdGgucGFyc2VMb2NhdGlvbigpLmhhc2gpICksCgkJCQloYXNoUGFnZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCBoYXNoICk7CgoJCQkvLyBpZiBubyBwYWdlcyBhcmUgZm91bmQsIGNyZWF0ZSBvbmUgd2l0aCBib2R5J3MgaW5uZXIgaHRtbAoJCQlpZiAoICEkcGFnZXMubGVuZ3RoICkgewoJCQkJJHBhZ2VzID0gJCggImJvZHkiICkud3JhcElubmVyKCAiPGRpdiBkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJyb2xlPSdwYWdlJz48L2Rpdj4iICkuY2hpbGRyZW4oIDAgKTsKCQkJfQoKCQkJLy8gYWRkIGRpYWxvZ3MsIHNldCBkYXRhLXVybCBhdHRycwoJCQkkcGFnZXMuZWFjaChmdW5jdGlvbigpIHsKCQkJCXZhciAkdGhpcyA9ICQoIHRoaXMgKTsKCgkJCQkvLyB1bmxlc3MgdGhlIGRhdGEgdXJsIGlzIGFscmVhZHkgc2V0IHNldCBpdCB0byB0aGUgcGF0aG5hbWUKCQkJCWlmICggISR0aGlzWyAwIF0uZ2V0QXR0cmlidXRlKCAiZGF0YS0iICsgJC5tb2JpbGUubnMgKyAidXJsIiApICkgewoJCQkJCSR0aGlzLmF0dHIoICJkYXRhLSIgKyAkLm1vYmlsZS5ucyArICJ1cmwiLCAkdGhpcy5hdHRyKCAiaWQiICkgfHwgbG9jYXRpb24ucGF0aG5hbWUgKyBsb2NhdGlvbi5zZWFyY2ggKTsKCQkJCX0KCQkJfSk7CgoJCQkvLyBkZWZpbmUgZmlyc3QgcGFnZSBpbiBkb20gY2FzZSBvbmUgYmFja3Mgb3V0IHRvIHRoZSBkaXJlY3Rvcnkgcm9vdCAobm90IGFsd2F5cyB0aGUgZmlyc3QgcGFnZSB2aXNpdGVkLCBidXQgZGVmaW5lZCBhcyBmYWxsYmFjaykKCQkJJC5tb2JpbGUuZmlyc3RQYWdlID0gJHBhZ2VzLmZpcnN0KCk7CgoJCQkvLyBkZWZpbmUgcGFnZSBjb250YWluZXIKCQkJJC5tb2JpbGUucGFnZUNvbnRhaW5lciA9ICQubW9iaWxlLmZpcnN0UGFnZQoJCQkJLnBhcmVudCgpCgkJCQkuYWRkQ2xhc3MoICJ1aS1tb2JpbGUtdmlld3BvcnQiICkKCQkJCS5wYWdlY29udGFpbmVyKCk7CgoJCQkvLyBpbml0aWFsaXplIG5hdmlnYXRpb24gZXZlbnRzIG5vdywgYWZ0ZXIgbW9iaWxlaW5pdCBoYXMgb2NjdXJyZWQgYW5kIHRoZSBwYWdlIGNvbnRhaW5lcgoJCQkvLyBoYXMgYmVlbiBjcmVhdGVkIGJ1dCBiZWZvcmUgdGhlIHJlc3Qgb2YgdGhlIGxpYnJhcnkgaXMgYWxlcnRlZCB0byB0aGF0IGZhY3QKCQkJJC5tb2JpbGUubmF2cmVhZHlEZWZlcnJlZC5yZXNvbHZlKCk7CgoJCQkvLyBhbGVydCBsaXN0ZW5lcnMgdGhhdCB0aGUgcGFnZWNvbnRhaW5lciBoYXMgYmVlbiBkZXRlcm1pbmVkIGZvciBiaW5kaW5nCgkJCS8vIHRvIGV2ZW50cyB0cmlnZ2VyZWQgb24gaXQKCQkJJHdpbmRvdy50cmlnZ2VyKCAicGFnZWNvbnRhaW5lcmNyZWF0ZSIgKTsKCgkJCS8vIGN1ZSBwYWdlIGxvYWRpbmcgbWVzc2FnZQoJCQkkLm1vYmlsZS5sb2FkaW5nKCAic2hvdyIgKTsKCgkJCS8vcmVtb3ZlIGluaXRpYWwgYnVpbGQgY2xhc3MgKG9ubHkgcHJlc2VudCBvbiBmaXJzdCBwYWdlc2hvdykKCQkJaGlkZVJlbmRlcmluZ0NsYXNzKCk7CgoJCQkvLyBpZiBoYXNoY2hhbmdlIGxpc3RlbmluZyBpcyBkaXNhYmxlZCwgdGhlcmUncyBubyBoYXNoIGRlZXBsaW5rLAoJCQkvLyB0aGUgaGFzaCBpcyBub3QgdmFsaWQgKGNvbnRhaW5zIG1vcmUgdGhhbiBvbmUgIyBvciBkb2VzIG5vdCBzdGFydCB3aXRoICMpCgkJCS8vIG9yIHRoZXJlIGlzIG5vIHBhZ2Ugd2l0aCB0aGF0IGhhc2gsIGNoYW5nZSB0byB0aGUgZmlyc3QgcGFnZSBpbiB0aGUgRE9NCgkJCS8vIFJlbWVtYmVyLCBob3dldmVyLCB0aGF0IHRoZSBoYXNoIGNhbiBhbHNvIGJlIGEgcGF0aCEKCQkJaWYgKCAhICggJC5tb2JpbGUuaGFzaExpc3RlbmluZ0VuYWJsZWQgJiYKCQkJCSQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSAmJgoJCQkJKCAkKCBoYXNoUGFnZSApLmlzKCAiOmpxbURhdGEocm9sZT0ncGFnZScpIiApIHx8CgkJCQkJJC5tb2JpbGUucGF0aC5pc1BhdGgoIGhhc2ggKSB8fAoJCQkJCWhhc2ggPT09ICQubW9iaWxlLmRpYWxvZ0hhc2hLZXkgKSApICkgewoKCQkJCS8vIFN0b3JlIHRoZSBpbml0aWFsIGRlc3RpbmF0aW9uCgkJCQlpZiAoICQubW9iaWxlLnBhdGguaXNIYXNoVmFsaWQoIGxvY2F0aW9uLmhhc2ggKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LmluaXRpYWxEc3QgPSBoYXNoLnJlcGxhY2UoICIjIiwgIiIgKTsKCQkJCX0KCgkJCQkvLyBtYWtlIHN1cmUgdG8gc2V0IGluaXRpYWwgcG9wc3RhdGUgc3RhdGUgaWYgaXQgZXhpc3RzCgkJCQkvLyBzbyB0aGF0IG5hdmlnYXRpb24gYmFjayB0byB0aGUgaW5pdGlhbCBwYWdlIHdvcmtzIHByb3Blcmx5CgkJCQlpZiAoICQuZXZlbnQuc3BlY2lhbC5uYXZpZ2F0ZS5pc1B1c2hTdGF0ZUVuYWJsZWQoKSApIHsKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5uYXZpZ2F0b3Iuc3F1YXNoKCBwYXRoLnBhcnNlTG9jYXRpb24oKS5ocmVmICk7CgkJCQl9CgoJCQkJJC5tb2JpbGUuY2hhbmdlUGFnZSggJC5tb2JpbGUuZmlyc3RQYWdlLCB7CgkJCQkJdHJhbnNpdGlvbjogIm5vbmUiLAoJCQkJCXJldmVyc2U6IHRydWUsCgkJCQkJY2hhbmdlSGFzaDogZmFsc2UsCgkJCQkJZnJvbUhhc2hDaGFuZ2U6IHRydWUKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJLy8gdHJpZ2dlciBoYXNoY2hhbmdlIG9yIG5hdmlnYXRlIHRvIHNxdWFzaCBhbmQgcmVjb3JkIHRoZSBjb3JyZWN0CgkJCQkvLyBoaXN0b3J5IGVudHJ5IGZvciBhbiBpbml0aWFsIGhhc2ggcGF0aAoJCQkJaWYgKCAhJC5ldmVudC5zcGVjaWFsLm5hdmlnYXRlLmlzUHVzaFN0YXRlRW5hYmxlZCgpICkgewoJCQkJCSR3aW5kb3cudHJpZ2dlciggImhhc2hjaGFuZ2UiLCBbdHJ1ZV0gKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gVE9ETyBmaWd1cmUgb3V0IGhvdyB0byBzaW1wbGlmeSB0aGlzIGludGVyYWN0aW9uIHdpdGggdGhlIGluaXRpYWwgaGlzdG9yeSBlbnRyeQoJCQkJCS8vIGF0IHRoZSBib3R0b20ganMvbmF2aWdhdGUvbmF2aWdhdGUuanMKCQkJCQkkLm1vYmlsZS5uYXZpZ2F0ZS5oaXN0b3J5LnN0YWNrID0gW107CgkJCQkJJC5tb2JpbGUubmF2aWdhdGUoICQubW9iaWxlLnBhdGguaXNQYXRoKCBsb2NhdGlvbi5oYXNoICkgPyBsb2NhdGlvbi5oYXNoIDogbG9jYXRpb24uaHJlZiApOwoJCQkJfQoJCQl9CgkJfQoJfSk7CgoJJChmdW5jdGlvbigpIHsKCQkvL1J1biBpbmxpbmVTVkcgc3VwcG9ydCB0ZXN0CgkJJC5zdXBwb3J0LmlubGluZVNWRygpOwoKCQkvLyBjaGVjayB3aGljaCBzY3JvbGxUb3AgdmFsdWUgc2hvdWxkIGJlIHVzZWQgYnkgc2Nyb2xsaW5nIHRvIDEgaW1tZWRpYXRlbHkgYXQgZG9tcmVhZHkKCQkvLyB0aGVuIGNoZWNrIHdoYXQgdGhlIHNjcm9sbCB0b3AgaXMuIEFuZHJvaWQgd2lsbCByZXBvcnQgMC4uLiBvdGhlcnMgMQoJCS8vIG5vdGUgdGhhdCB0aGlzIGluaXRpYWwgc2Nyb2xsIHdvbid0IGhpZGUgdGhlIGFkZHJlc3MgYmFyLiBJdCdzIGp1c3QgZm9yIHRoZSBjaGVjay4KCgkJLy8gaGlkZSBpT1MgYnJvd3NlciBjaHJvbWUgb24gbG9hZCBpZiBoaWRlVXJsQmFyIGlzIHRydWUgdGhpcyBpcyB0byB0cnkgYW5kIGRvIGl0IGFzIHNvb24gYXMgcG9zc2libGUKCQlpZiAoICQubW9iaWxlLmhpZGVVcmxCYXIgKSB7CgkJCXdpbmRvdy5zY3JvbGxUbyggMCwgMSApOwoJCX0KCgkJLy8gaWYgZGVmYXVsdEhvbWVTY3JvbGwgaGFzbid0IGJlZW4gc2V0IHlldCwgc2VlIGlmIHNjcm9sbFRvcCBpcyAxCgkJLy8gaXQgc2hvdWxkIGJlIDEgaW4gbW9zdCBicm93c2VycywgYnV0IGFuZHJvaWQgdHJlYXRzIDEgYXMgMCAoZm9yIGhpZGluZyBhZGRyIGJhcikKCQkvLyBzbyBpZiBpdCdzIDEsIHVzZSAwIGZyb20gbm93IG9uCgkJJC5tb2JpbGUuZGVmYXVsdEhvbWVTY3JvbGwgPSAoICEkLnN1cHBvcnQuc2Nyb2xsVG9wIHx8ICQubW9iaWxlLndpbmRvdy5zY3JvbGxUb3AoKSA9PT0gMSApID8gMCA6IDE7CgoJCS8vZG9tLXJlYWR5IGluaXRzCgkJaWYgKCAkLm1vYmlsZS5hdXRvSW5pdGlhbGl6ZVBhZ2UgKSB7CgkJCSQubW9iaWxlLmluaXRpYWxpemVQYWdlKCk7CgkJfQoKCQkvLyB3aW5kb3cgbG9hZCBldmVudAoJCS8vIGhpZGUgaU9TIGJyb3dzZXIgY2hyb21lIG9uIGxvYWQgaWYgaGlkZVVybEJhciBpcyB0cnVlIHRoaXMgaXMgYXMgZmFsbCBiYWNrIGluY2FzZSB3ZSB3ZXJlIHRvbyBlYXJseSBiZWZvcmUKCQlpZiAoICQubW9iaWxlLmhpZGVVcmxCYXIgKSB7CgkJCSR3aW5kb3cubG9hZCggJC5tb2JpbGUuc2lsZW50U2Nyb2xsICk7CgkJfQoKCQlpZiAoICEkLnN1cHBvcnQuY3NzUG9pbnRlckV2ZW50cyApIHsKCQkJLy8gSUUgYW5kIE9wZXJhIGRvbid0IHN1cHBvcnQgQ1NTIHBvaW50ZXItZXZlbnRzOiBub25lIHRoYXQgd2UgdXNlIHRvIGRpc2FibGUgbGluay1iYXNlZCBidXR0b25zCgkJCS8vIGJ5IGFkZGluZyB0aGUgJ3VpLWRpc2FibGVkJyBjbGFzcyB0byB0aGVtLiBVc2luZyBhIEphdmFTY3JpcHQgd29ya2Fyb3VuZCBmb3IgdGhvc2UgYnJvd3Nlci4KCQkJLy8gaHR0cHM6Ly9naXRodWIuY29tL2pxdWVyeS9qcXVlcnktbW9iaWxlL2lzc3Vlcy8zNTU4CgoJCQkvLyBERVBSRUNBVEVEIGFzIG9mIDEuNC4wIC0gcmVtb3ZlIHVpLWRpc2FibGVkIGFmdGVyIDEuNC4wIHJlbGVhc2UKCQkJLy8gb25seSB1aS1zdGF0ZS1kaXNhYmxlZCBzaG91bGQgYmUgcHJlc2VudCB0aGVyZWFmdGVyCgkJCSQubW9iaWxlLmRvY3VtZW50LmRlbGVnYXRlKCAiLnVpLXN0YXRlLWRpc2FibGVkLC51aS1kaXNhYmxlZCIsICJ2Y2xpY2siLAoJCQkJZnVuY3Rpb24oIGUgKSB7CgkJCQkJZS5wcmV2ZW50RGVmYXVsdCgpOwoJCQkJCWUuc3RvcEltbWVkaWF0ZVByb3BhZ2F0aW9uKCk7CgkJCQl9CgkJCSk7CgkJfQoJfSk7Cn0oIGpRdWVyeSwgdGhpcyApKTsKCgp9KSk7Cg==",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 11:27:22 GMT",
                    "Content-Length": "443296",
                    "Date": "Thu, 06 Nov 2014 11:27:26 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}