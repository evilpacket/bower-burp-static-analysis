{
    "url": "http://localhost:9999/davestone/angular-user-authentication/angular-user-authentication.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Client-side JSON injection (DOM-based)",
    "issueType": 2098032,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based JSON injection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and incorporates this into a string that is parsed as a JSON data structure and then processed by the application. An attacker may be able to use this behavior to construct a URL which, if visited by another application user, will cause arbitrary JSON data to be processed. Depending on the purpose for which this data is used, it may be possible to subvert the application's logic, or cause unintended actions on behalf of the user.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based JSON injection vulnerabilities is not to parse as JSON any string containing data that originated from an untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from modifying the JSON structure in inappropriate ways. This may involve strict validation of specific items to ensure they do not contain any characters that may interfere with the structure of the JSON when it is parsed.",
    "issueDetail": "The application may be vulnerable to DOM-based client-side JSON injection. Data is read from <b>document.cookie</b> and written to <b>JSON.parse()</b> via the following statements:<ul><li>var cookies = document.cookie.split('; ');</li><li>var cookie = cookies[i].split('=');</li><li>return JSON.parse(unescape(cookie[1]));</li></ul>Because the data originates from a cookie, the application's behavior is not trivial to exploit in an attack against another user. Typically, you will need to find a means of setting an arbitrary cookie value in the victim's browser in order to exploit the vulnerability. Applications often contain \"cookie-forcing\" conditions which make this possible, and such a condition in any related domain or subdomain can potentially be used for this purpose. Nonetheless, this limitation somewhat mitigates the impact of the vulnerability. ",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/davestone/angular-user-authentication/angular-user-authentication.js",
                "path": "/davestone/angular-user-authentication/angular-user-authentication.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9kYXZlc3RvbmUvYW5ndWxhci11c2VyLWF1dGhlbnRpY2F0aW9uL2FuZ3VsYXItdXNlci1hdXRoZW50aWNhdGlvbi5qcyBIVFRQLzEuMQ0KSG9zdDogbG9jYWxob3N0Ojk5OTkNCg0K",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogNjgyNw0KQWNjZXB0LVJhbmdlczogYnl0ZXMNCkNvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vamF2YXNjcmlwdA0KRGF0ZTogVGh1LCAwNiBOb3YgMjAxNCAwOToxMDoyMCBHTVQNCkxhc3QtTW9kaWZpZWQ6IFRodSwgMDYgTm92IDIwMTQgMDk6MTA6MTkgR01UDQoNCihmdW5jdGlvbiAoKSB7CiAgJ3VzZSBzdHJpY3QnOwoKICBhbmd1bGFyLm1vZHVsZSgnZGF2ZXN0b25lLnVzZXJBdXRoZW50aWNhdGlvbicsIFtdKQogICAgLnByb3ZpZGVyKCdVc2VyQXV0aGVudGljYXRpb24nLCBmdW5jdGlvbigpIHsKCiAgICAgIC8qCiAgICAgICAqIENvbmZpZwogICAgICAgKi8KCiAgICAgIC8vIERlZmF1bHRzCiAgICAgIHRoaXMuY29va2llRXhwaXJ5ID0gNjA0ODAwOyAvLyAxIHdlZWsKICAgICAgdGhpcy5jb29raWVOYW1lID0gJ19zZXNzaW9uJzsKICAgICAgdGhpcy5jb29raWVTZWN1cmUgPSBmYWxzZTsKICAgICAgdGhpcy5jb29raWVEb21haW4gPSAnJzsKICAgICAgdGhpcy5jb29raWVQYXRoID0gJy8nOwogICAgICB0aGlzLmNhc2VTZW5zaXRpdmVMb2dpbiA9IGZhbHNlOwogICAgICB0aGlzLmlkZW50aXR5ID0ge307CiAgICAgIHRoaXMucGF0aElkZW50aXR5UmVxdWlyZWQgPSAnLyc7CiAgICAgIHRoaXMucGF0aE5vSWRlbnRpdHlSZXF1aXJlZCA9ICcvJzsKCiAgICAgIC8vIE92ZXJsb2FkCiAgICAgIHRoaXMuc2V0ID0gZnVuY3Rpb24oa2V5LCB2YWx1ZSkgewogICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICB9OwoKICAgICAgLyoKICAgICAgICogU2VydmljZQogICAgICAgKi8KCiAgICAgIHRoaXMuJGdldCA9IFsnJHJvb3RTY29wZScsICckcScsICckaHR0cCcsIGZ1bmN0aW9uKCRyb290U2NvcGUsICRxLCAkaHR0cCkgewogICAgICAgIHZhciBzZXJ2aWNlID0ge307CiAgICAgICAgc2VydmljZS5jb25maWcgPSB0aGlzOwogICAgICAgIHNlcnZpY2UuaWRlbnRpdHkgPSBzZXJ2aWNlLmNvbmZpZy5pZGVudGl0eTsKICAgICAgICBzZXJ2aWNlLmlkZW50aWZpZWQgPSBmYWxzZTsKCiAgICAgICAgc2VydmljZS5hdXRoZW50aWNhdGUgPSBmdW5jdGlvbihsb2dpbiwgcGFzc3dvcmQsIHJlbWVtYmVyKSB7CgogICAgICAgICAgaWYgKHNlcnZpY2UuaWRlbnRpZmllZCA9PT0gdHJ1ZSkgcmV0dXJuOwoKICAgICAgICAgIGlmIChzZXJ2aWNlLmNvbmZpZy5jYXNlU2Vuc2l0aXZlTG9naW4gPT09IGZhbHNlKSB7IC8vIFRFU1QKICAgICAgICAgICAgbG9naW4gPSBhbmd1bGFyLmxvd2VyY2FzZShsb2dpbik7CiAgICAgICAgICB9CgogICAgICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlLmNvbmZpZy5hdXRoZW50aWNhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgJGh0dHAoc2VydmljZS5jb25maWcuYXV0aGVudGljYXRlKGxvZ2luLCBwYXNzd29yZCkpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHNlcnZpY2Uuc2V0Q29va2llKHsKICAgICAgICAgICAgICAgIGRvbWFpbjogc2VydmljZS5jb25maWcuY29va2llRG9tYWluLAogICAgICAgICAgICAgICAgZXhwaXJ5U2Vjb25kczogKHJlbWVtYmVyID8gc2VydmljZS5jb25maWcuY29va2llRXhwaXJ5IDogMCksIC8vIFRFU1QKICAgICAgICAgICAgICAgIHBhdGg6IHNlcnZpY2UuY29uZmlnLmNvb2tpZVBhdGgsCiAgICAgICAgICAgICAgICBzZWN1cmU6IHNlcnZpY2UuY29uZmlnLmNvb2tpZVNlY3VyZSwKICAgICAgICAgICAgICAgIHZhbHVlOiBkYXRhCiAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndXNlckF1dGhlbnRpY2F0aW9uOmF1dGhlbnRpY2F0ZWQnKTsKCiAgICAgICAgICAgICAgc2VydmljZS5pZGVudGlmeSgpOwogICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246ZXJyb3InLCB7IGNvZGU6ICdhdXRoZW50aWNhdGlvbi1mYWlsZWQnIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9OwoKICAgICAgICBzZXJ2aWNlLmRlYXV0aGVudGljYXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICBpZiAoc2VydmljZS5pZGVudGlmaWVkID09PSBmYWxzZSkgcmV0dXJuOwoKICAgICAgICAgIGlmICh0eXBlb2Ygc2VydmljZS5jb25maWcuZGVhdXRoZW50aWNhdGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgJGh0dHAoc2VydmljZS5jb25maWcuZGVhdXRoZW50aWNhdGUoc2VydmljZS5nZXRDb29raWUoKSkpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndXNlckF1dGhlbnRpY2F0aW9uOmRlYXV0aGVudGljYXRlZCcpOwogICAgICAgICAgICB9KS5lcnJvcihmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246ZXJyb3InLCB7IGNvZGU6ICdkZWF1dGhlbnRpY2F0aW9uLWZhaWxlZCcgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246ZGVhdXRoZW50aWNhdGVkJyk7CiAgICAgICAgICB9CgogICAgICAgICAgc2VydmljZS51bmlkZW50aWZ5KCk7CiAgICAgICAgfTsKCiAgICAgICAgc2VydmljZS5pZGVudGlmeSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdmFyIHByb21pc2UgPSAkcS5kZWZlcigpOwoKICAgICAgICAgIGlmIChzZXJ2aWNlLmhhc0Nvb2tpZSgpID09PSBmYWxzZSkgewogICAgICAgICAgICBwcm9taXNlLnJlc29sdmUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICRodHRwKHNlcnZpY2UuY29uZmlnLmlkZW50aWZ5KHNlcnZpY2UuZ2V0Q29va2llKCkpKS5zdWNjZXNzKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICBzZXJ2aWNlLmlkZW50aWZpZWQgPSB0cnVlOwogICAgICAgICAgICAgIHNlcnZpY2UuaWRlbnRpdHkgPSBkYXRhOwoKICAgICAgICAgICAgICAvLyBldmVudAogICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndXNlckF1dGhlbnRpY2F0aW9uOmlkZW50aXR5OmNoYW5nZWQnLCBzZXJ2aWNlLmlkZW50aXR5KTsKCiAgICAgICAgICAgICAgcHJvbWlzZS5yZXNvbHZlKCk7CiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAvLyBldmVudAogICAgICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndXNlckF1dGhlbnRpY2F0aW9uOmVycm9yJywgeyBjb2RlOiAnaWRlbnRpZmljYXRpb24tZmFpbGVkJyB9KTsKCiAgICAgICAgICAgICAgcHJvbWlzZS5yZWplY3QoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHByb21pc2UucHJvbWlzZTsKICAgICAgICB9OwoKICAgICAgICBzZXJ2aWNlLnVuaWRlbnRpZnkgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHNlcnZpY2UuaWRlbnRpdHkgPSBzZXJ2aWNlLmNvbmZpZy5pZGVudGl0eTsKICAgICAgICAgIHNlcnZpY2UuaWRlbnRpZmllZCA9IGZhbHNlOwoKICAgICAgICAgIHNlcnZpY2Uuc2V0Q29va2llKHsKICAgICAgICAgICAgZXhwaXJ5U2Vjb25kczogMCwKICAgICAgICAgICAgc2VjdXJlOiBzZXJ2aWNlLmNvbmZpZy5jb29raWVTZWN1cmUsCiAgICAgICAgICAgIGRvbWFpbjogc2VydmljZS5jb25maWcuY29va2llRG9tYWluLAogICAgICAgICAgICBwYXRoOiBzZXJ2aWNlLmNvbmZpZy5jb29raWVQYXRoLAogICAgICAgICAgICB2YWx1ZToge30KICAgICAgICAgIH0pOwoKICAgICAgICAgIC8vIGV2ZW50CiAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3VzZXJBdXRoZW50aWNhdGlvbjppZGVudGl0eTpjaGFuZ2VkJywgc2VydmljZS5pZGVudGl0eSk7CiAgICAgICAgfTsKCiAgICAgICAgc2VydmljZS5oYXNDb29raWUgPSBmdW5jdGlvbigpIHsgLy8gVEVTVAogICAgICAgICAgcmV0dXJuIEJvb2xlYW4oT2JqZWN0LmtleXMoc2VydmljZS5nZXRDb29raWUoKSkubGVuZ3RoKTsKICAgICAgICB9OwoKICAgICAgICBzZXJ2aWNlLmdldENvb2tpZSA9IGZ1bmN0aW9uKCkgeyAvLyBURVNUCiAgICAgICAgCXZhciBjb29raWVzID0gZG9jdW1lbnQuY29va2llLnNwbGl0KCc7ICcpOwogICAgICAgIAlmb3IgKHZhciBpPTA7IGk8Y29va2llcy5sZW5ndGg7IGkrKykgewogICAgICAgIAkJdmFyIGNvb2tpZSA9IGNvb2tpZXNbaV0uc3BsaXQoJz0nKTsKCiAgICAgICAgCQlpZihjb29raWVbMF0gPT09IHNlcnZpY2UuY29uZmlnLmNvb2tpZU5hbWUpIHsKICAgICAgICAJCQlyZXR1cm4gSlNPTi5wYXJzZSh1bmVzY2FwZShjb29raWVbMV0pKTsKICAgICAgICAJCX0KICAgICAgICAJfQogICAgICAgICAgcmV0dXJuIHt9OwogICAgICAgIH07CgogICAgICAgIHNlcnZpY2Uuc2V0Q29va2llID0gZnVuY3Rpb24ob3B0aW9ucykgeyAvLyBURVNUCiAgICAgICAgICB2YXIgY29va2llID0gc2VydmljZS5jb25maWcuY29va2llTmFtZSArICc9JyArIGVzY2FwZShKU09OLnN0cmluZ2lmeShvcHRpb25zLnZhbHVlKSkgKyAnOyAnOwoKICAgICAgICAgIC8vIGNhbGN1bGF0ZSBhbiBleHBpcnkgZGF0ZQogICAgICAgICAgaWYgKG9wdGlvbnMuZXhwaXJ5U2Vjb25kcyA8PSAwKSB7CiAgICAgICAgICAgIG9wdGlvbnMuZXhwaXJlcyA9IGZhbHNlOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIGV4cGlyeURhdGVUaW1lID0gbmV3IERhdGUoKSwKICAgICAgICAgICAgICAgIHRpbWUgPSBleHBpcnlEYXRlVGltZS5nZXRUaW1lKCkgKyAob3B0aW9ucy5leHBpcnlTZWNvbmRzICogMTAwMCk7CiAgICAgICAgICAgIGV4cGlyeURhdGVUaW1lLnNldFRpbWUodGltZSk7CiAgICAgICAgICAgIG9wdGlvbnMuZXhwaXJlcyA9IGV4cGlyeURhdGVUaW1lLnRvVVRDU3RyaW5nKCk7CiAgICAgICAgICB9CgogICAgICAgICAgYW5ndWxhci5mb3JFYWNoKFsnZG9tYWluJywgJ2V4cGlyZXMnLCAncGF0aCcsICdzZWN1cmUnXSwgZnVuY3Rpb24obmFtZSwgaSkgewogICAgICAgICAgICBpZiAodHlwZW9mIG9wdGlvbnNbbmFtZV0gPT09ICdib29sZWFuJyAmJiBvcHRpb25zW25hbWVdID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgY29va2llICs9IG5hbWUrJzsgJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9uc1tuYW1lXSAhPT0gJ2Jvb2xlYW4nKSB7CiAgICAgICAgICAgICAgY29va2llICs9IG5hbWUrJz0nK29wdGlvbnNbbmFtZV0rJzsgJzsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgogICAgICAgIAlkb2N1bWVudC5jb29raWUgPSBjb29raWU7CiAgICAgICAgICByZXR1cm4gY29va2llOwogICAgICAgIH07CgogICAgICAgIC8vIEdvdCBDb29raWU/IExldCdzIHRyeSBpdC4uLgogICAgICAgIGlmIChzZXJ2aWNlLmhhc0Nvb2tpZSgpID09PSB0cnVlKSB7CiAgICAgICAgICBzZXJ2aWNlLmlkZW50aWZ5KCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gc2VydmljZTsKICAgICAgfV07CiAgICB9KQoKICAgIC8qCiAgICAgKiBDb250cm9sbGVyIEhlbHBlcgogICAgICovCgogICAgLmNvbnRyb2xsZXIoJ1VzZXJBdXRoZW50aWNhdGlvbkN0cmwnLCBbJyRzY29wZScsICdVc2VyQXV0aGVudGljYXRpb24nLCBmdW5jdGlvbigkc2NvcGUsIFVzZXJBdXRoZW50aWNhdGlvbikgewoKICAgICAgJHNjb3BlLmlkZW50aXR5ID0gVXNlckF1dGhlbnRpY2F0aW9uLmlkZW50aXR5OwogICAgICAkc2NvcGUuaWRlbnRpZmllZCA9IFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmaWVkOwoKICAgICAgJHNjb3BlLiRvbigndXNlckF1dGhlbnRpY2F0aW9uOmlkZW50aXR5OmNoYW5nZWQnLCBmdW5jdGlvbihldmVudCwgaWRlbnRpdHkpIHsKICAgICAgICAkc2NvcGUuaWRlbnRpdHkgPSBVc2VyQXV0aGVudGljYXRpb24uaWRlbnRpdHk7CiAgICAgICAgJHNjb3BlLmlkZW50aWZpZWQgPSBVc2VyQXV0aGVudGljYXRpb24uaWRlbnRpZmllZDsKICAgICAgfSk7CgogICAgICAkc2NvcGUuYXV0aGVudGljYXRlID0gZnVuY3Rpb24oc2Vzc2lvbikgewogICAgICAgIFVzZXJBdXRoZW50aWNhdGlvbi5hdXRoZW50aWNhdGUoc2Vzc2lvbi5sb2dpbiwgc2Vzc2lvbi5wYXNzd29yZCwgc2Vzc2lvbi5yZW1lbWJlcik7CiAgICAgIH07CgogICAgICAkc2NvcGUuZGVhdXRoZW50aWNhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICBVc2VyQXV0aGVudGljYXRpb24uZGVhdXRoZW50aWNhdGUoKTsKICAgICAgfTsKCiAgICB9XSkKCiAgICAvKgogICAgICogUm91dGUgUmVzb2x2ZSBIZWxwZXJzCiAgICAgKi8KCiAgICAuZmFjdG9yeSgnSWRlbnRpdHlSZXF1aXJlZCcsIFsnJGxvY2F0aW9uJywgJ1VzZXJBdXRoZW50aWNhdGlvbicsIGZ1bmN0aW9uKCRsb2NhdGlvbiwgVXNlckF1dGhlbnRpY2F0aW9uKSB7CiAgICAgIFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmeSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmaWVkID09PSBmYWxzZSkgewogICAgICAgICAgJGxvY2F0aW9uLnBhdGgoVXNlckF1dGhlbnRpY2F0aW9uLmNvbmZpZy5wYXRoSWRlbnRpdHlSZXF1aXJlZCk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH1dKQoKICAgIC5mYWN0b3J5KCdOb0lkZW50aXR5UmVxdWlyZWQnLCBbJyRsb2NhdGlvbicsICdVc2VyQXV0aGVudGljYXRpb24nLCBmdW5jdGlvbigkbG9jYXRpb24sIFVzZXJBdXRoZW50aWNhdGlvbikgewogICAgICBVc2VyQXV0aGVudGljYXRpb24uaWRlbnRpZnkoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgIGlmIChVc2VyQXV0aGVudGljYXRpb24uaWRlbnRpZmllZCA9PT0gdHJ1ZSkgewogICAgICAgICAgJGxvY2F0aW9uLnBhdGgoVXNlckF1dGhlbnRpY2F0aW9uLmNvbmZpZy5wYXRoTm9JZGVudGl0eVJlcXVpcmVkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfV0pOwoKfSgpKTsK",
                "body": "KGZ1bmN0aW9uICgpIHsKICAndXNlIHN0cmljdCc7CgogIGFuZ3VsYXIubW9kdWxlKCdkYXZlc3RvbmUudXNlckF1dGhlbnRpY2F0aW9uJywgW10pCiAgICAucHJvdmlkZXIoJ1VzZXJBdXRoZW50aWNhdGlvbicsIGZ1bmN0aW9uKCkgewoKICAgICAgLyoKICAgICAgICogQ29uZmlnCiAgICAgICAqLwoKICAgICAgLy8gRGVmYXVsdHMKICAgICAgdGhpcy5jb29raWVFeHBpcnkgPSA2MDQ4MDA7IC8vIDEgd2VlawogICAgICB0aGlzLmNvb2tpZU5hbWUgPSAnX3Nlc3Npb24nOwogICAgICB0aGlzLmNvb2tpZVNlY3VyZSA9IGZhbHNlOwogICAgICB0aGlzLmNvb2tpZURvbWFpbiA9ICcnOwogICAgICB0aGlzLmNvb2tpZVBhdGggPSAnLyc7CiAgICAgIHRoaXMuY2FzZVNlbnNpdGl2ZUxvZ2luID0gZmFsc2U7CiAgICAgIHRoaXMuaWRlbnRpdHkgPSB7fTsKICAgICAgdGhpcy5wYXRoSWRlbnRpdHlSZXF1aXJlZCA9ICcvJzsKICAgICAgdGhpcy5wYXRoTm9JZGVudGl0eVJlcXVpcmVkID0gJy8nOwoKICAgICAgLy8gT3ZlcmxvYWQKICAgICAgdGhpcy5zZXQgPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7CiAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CiAgICAgIH07CgogICAgICAvKgogICAgICAgKiBTZXJ2aWNlCiAgICAgICAqLwoKICAgICAgdGhpcy4kZ2V0ID0gWyckcm9vdFNjb3BlJywgJyRxJywgJyRodHRwJywgZnVuY3Rpb24oJHJvb3RTY29wZSwgJHEsICRodHRwKSB7CiAgICAgICAgdmFyIHNlcnZpY2UgPSB7fTsKICAgICAgICBzZXJ2aWNlLmNvbmZpZyA9IHRoaXM7CiAgICAgICAgc2VydmljZS5pZGVudGl0eSA9IHNlcnZpY2UuY29uZmlnLmlkZW50aXR5OwogICAgICAgIHNlcnZpY2UuaWRlbnRpZmllZCA9IGZhbHNlOwoKICAgICAgICBzZXJ2aWNlLmF1dGhlbnRpY2F0ZSA9IGZ1bmN0aW9uKGxvZ2luLCBwYXNzd29yZCwgcmVtZW1iZXIpIHsKCiAgICAgICAgICBpZiAoc2VydmljZS5pZGVudGlmaWVkID09PSB0cnVlKSByZXR1cm47CgogICAgICAgICAgaWYgKHNlcnZpY2UuY29uZmlnLmNhc2VTZW5zaXRpdmVMb2dpbiA9PT0gZmFsc2UpIHsgLy8gVEVTVAogICAgICAgICAgICBsb2dpbiA9IGFuZ3VsYXIubG93ZXJjYXNlKGxvZ2luKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHlwZW9mIHNlcnZpY2UuY29uZmlnLmF1dGhlbnRpY2F0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAkaHR0cChzZXJ2aWNlLmNvbmZpZy5hdXRoZW50aWNhdGUobG9naW4sIHBhc3N3b3JkKSkuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgc2VydmljZS5zZXRDb29raWUoewogICAgICAgICAgICAgICAgZG9tYWluOiBzZXJ2aWNlLmNvbmZpZy5jb29raWVEb21haW4sCiAgICAgICAgICAgICAgICBleHBpcnlTZWNvbmRzOiAocmVtZW1iZXIgPyBzZXJ2aWNlLmNvbmZpZy5jb29raWVFeHBpcnkgOiAwKSwgLy8gVEVTVAogICAgICAgICAgICAgICAgcGF0aDogc2VydmljZS5jb25maWcuY29va2llUGF0aCwKICAgICAgICAgICAgICAgIHNlY3VyZTogc2VydmljZS5jb25maWcuY29va2llU2VjdXJlLAogICAgICAgICAgICAgICAgdmFsdWU6IGRhdGEKICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246YXV0aGVudGljYXRlZCcpOwoKICAgICAgICAgICAgICBzZXJ2aWNlLmlkZW50aWZ5KCk7CiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3VzZXJBdXRoZW50aWNhdGlvbjplcnJvcicsIHsgY29kZTogJ2F1dGhlbnRpY2F0aW9uLWZhaWxlZCcgfSk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIHNlcnZpY2UuZGVhdXRoZW50aWNhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIGlmIChzZXJ2aWNlLmlkZW50aWZpZWQgPT09IGZhbHNlKSByZXR1cm47CgogICAgICAgICAgaWYgKHR5cGVvZiBzZXJ2aWNlLmNvbmZpZy5kZWF1dGhlbnRpY2F0ZSA9PT0gJ2Z1bmN0aW9uJykgewogICAgICAgICAgICAkaHR0cChzZXJ2aWNlLmNvbmZpZy5kZWF1dGhlbnRpY2F0ZShzZXJ2aWNlLmdldENvb2tpZSgpKSkuc3VjY2VzcyhmdW5jdGlvbihkYXRhKSB7CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246ZGVhdXRoZW50aWNhdGVkJyk7CiAgICAgICAgICAgIH0pLmVycm9yKGZ1bmN0aW9uKGRhdGEpIHsKICAgICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3VzZXJBdXRoZW50aWNhdGlvbjplcnJvcicsIHsgY29kZTogJ2RlYXV0aGVudGljYXRpb24tZmFpbGVkJyB9KTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkcm9vdFNjb3BlLiRicm9hZGNhc3QoJ3VzZXJBdXRoZW50aWNhdGlvbjpkZWF1dGhlbnRpY2F0ZWQnKTsKICAgICAgICAgIH0KCiAgICAgICAgICBzZXJ2aWNlLnVuaWRlbnRpZnkoKTsKICAgICAgICB9OwoKICAgICAgICBzZXJ2aWNlLmlkZW50aWZ5ID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICB2YXIgcHJvbWlzZSA9ICRxLmRlZmVyKCk7CgogICAgICAgICAgaWYgKHNlcnZpY2UuaGFzQ29va2llKCkgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHByb21pc2UucmVzb2x2ZSgpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgJGh0dHAoc2VydmljZS5jb25maWcuaWRlbnRpZnkoc2VydmljZS5nZXRDb29raWUoKSkpLnN1Y2Nlc3MoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIHNlcnZpY2UuaWRlbnRpZmllZCA9IHRydWU7CiAgICAgICAgICAgICAgc2VydmljZS5pZGVudGl0eSA9IGRhdGE7CgogICAgICAgICAgICAgIC8vIGV2ZW50CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246aWRlbnRpdHk6Y2hhbmdlZCcsIHNlcnZpY2UuaWRlbnRpdHkpOwoKICAgICAgICAgICAgICBwcm9taXNlLnJlc29sdmUoKTsKICAgICAgICAgICAgfSkuZXJyb3IoZnVuY3Rpb24oZGF0YSkgewogICAgICAgICAgICAgIC8vIGV2ZW50CiAgICAgICAgICAgICAgJHJvb3RTY29wZS4kYnJvYWRjYXN0KCd1c2VyQXV0aGVudGljYXRpb246ZXJyb3InLCB7IGNvZGU6ICdpZGVudGlmaWNhdGlvbi1mYWlsZWQnIH0pOwoKICAgICAgICAgICAgICBwcm9taXNlLnJlamVjdCgpOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KCiAgICAgICAgICByZXR1cm4gcHJvbWlzZS5wcm9taXNlOwogICAgICAgIH07CgogICAgICAgIHNlcnZpY2UudW5pZGVudGlmeSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgc2VydmljZS5pZGVudGl0eSA9IHNlcnZpY2UuY29uZmlnLmlkZW50aXR5OwogICAgICAgICAgc2VydmljZS5pZGVudGlmaWVkID0gZmFsc2U7CgogICAgICAgICAgc2VydmljZS5zZXRDb29raWUoewogICAgICAgICAgICBleHBpcnlTZWNvbmRzOiAwLAogICAgICAgICAgICBzZWN1cmU6IHNlcnZpY2UuY29uZmlnLmNvb2tpZVNlY3VyZSwKICAgICAgICAgICAgZG9tYWluOiBzZXJ2aWNlLmNvbmZpZy5jb29raWVEb21haW4sCiAgICAgICAgICAgIHBhdGg6IHNlcnZpY2UuY29uZmlnLmNvb2tpZVBhdGgsCiAgICAgICAgICAgIHZhbHVlOiB7fQogICAgICAgICAgfSk7CgogICAgICAgICAgLy8gZXZlbnQKICAgICAgICAgICRyb290U2NvcGUuJGJyb2FkY2FzdCgndXNlckF1dGhlbnRpY2F0aW9uOmlkZW50aXR5OmNoYW5nZWQnLCBzZXJ2aWNlLmlkZW50aXR5KTsKICAgICAgICB9OwoKICAgICAgICBzZXJ2aWNlLmhhc0Nvb2tpZSA9IGZ1bmN0aW9uKCkgeyAvLyBURVNUCiAgICAgICAgICByZXR1cm4gQm9vbGVhbihPYmplY3Qua2V5cyhzZXJ2aWNlLmdldENvb2tpZSgpKS5sZW5ndGgpOwogICAgICAgIH07CgogICAgICAgIHNlcnZpY2UuZ2V0Q29va2llID0gZnVuY3Rpb24oKSB7IC8vIFRFU1QKICAgICAgICAJdmFyIGNvb2tpZXMgPSBkb2N1bWVudC5jb29raWUuc3BsaXQoJzsgJyk7CiAgICAgICAgCWZvciAodmFyIGk9MDsgaTxjb29raWVzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgCQl2YXIgY29va2llID0gY29va2llc1tpXS5zcGxpdCgnPScpOwoKICAgICAgICAJCWlmKGNvb2tpZVswXSA9PT0gc2VydmljZS5jb25maWcuY29va2llTmFtZSkgewogICAgICAgIAkJCXJldHVybiBKU09OLnBhcnNlKHVuZXNjYXBlKGNvb2tpZVsxXSkpOwogICAgICAgIAkJfQogICAgICAgIAl9CiAgICAgICAgICByZXR1cm4ge307CiAgICAgICAgfTsKCiAgICAgICAgc2VydmljZS5zZXRDb29raWUgPSBmdW5jdGlvbihvcHRpb25zKSB7IC8vIFRFU1QKICAgICAgICAgIHZhciBjb29raWUgPSBzZXJ2aWNlLmNvbmZpZy5jb29raWVOYW1lICsgJz0nICsgZXNjYXBlKEpTT04uc3RyaW5naWZ5KG9wdGlvbnMudmFsdWUpKSArICc7ICc7CgogICAgICAgICAgLy8gY2FsY3VsYXRlIGFuIGV4cGlyeSBkYXRlCiAgICAgICAgICBpZiAob3B0aW9ucy5leHBpcnlTZWNvbmRzIDw9IDApIHsKICAgICAgICAgICAgb3B0aW9ucy5leHBpcmVzID0gZmFsc2U7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2YXIgZXhwaXJ5RGF0ZVRpbWUgPSBuZXcgRGF0ZSgpLAogICAgICAgICAgICAgICAgdGltZSA9IGV4cGlyeURhdGVUaW1lLmdldFRpbWUoKSArIChvcHRpb25zLmV4cGlyeVNlY29uZHMgKiAxMDAwKTsKICAgICAgICAgICAgZXhwaXJ5RGF0ZVRpbWUuc2V0VGltZSh0aW1lKTsKICAgICAgICAgICAgb3B0aW9ucy5leHBpcmVzID0gZXhwaXJ5RGF0ZVRpbWUudG9VVENTdHJpbmcoKTsKICAgICAgICAgIH0KCiAgICAgICAgICBhbmd1bGFyLmZvckVhY2goWydkb21haW4nLCAnZXhwaXJlcycsICdwYXRoJywgJ3NlY3VyZSddLCBmdW5jdGlvbihuYW1lLCBpKSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygb3B0aW9uc1tuYW1lXSA9PT0gJ2Jvb2xlYW4nICYmIG9wdGlvbnNbbmFtZV0gPT09IHRydWUpIHsKICAgICAgICAgICAgICBjb29raWUgKz0gbmFtZSsnOyAnOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcHRpb25zW25hbWVdICE9PSAnYm9vbGVhbicpIHsKICAgICAgICAgICAgICBjb29raWUgKz0gbmFtZSsnPScrb3B0aW9uc1tuYW1lXSsnOyAnOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgCWRvY3VtZW50LmNvb2tpZSA9IGNvb2tpZTsKICAgICAgICAgIHJldHVybiBjb29raWU7CiAgICAgICAgfTsKCiAgICAgICAgLy8gR290IENvb2tpZT8gTGV0J3MgdHJ5IGl0Li4uCiAgICAgICAgaWYgKHNlcnZpY2UuaGFzQ29va2llKCkgPT09IHRydWUpIHsKICAgICAgICAgIHNlcnZpY2UuaWRlbnRpZnkoKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBzZXJ2aWNlOwogICAgICB9XTsKICAgIH0pCgogICAgLyoKICAgICAqIENvbnRyb2xsZXIgSGVscGVyCiAgICAgKi8KCiAgICAuY29udHJvbGxlcignVXNlckF1dGhlbnRpY2F0aW9uQ3RybCcsIFsnJHNjb3BlJywgJ1VzZXJBdXRoZW50aWNhdGlvbicsIGZ1bmN0aW9uKCRzY29wZSwgVXNlckF1dGhlbnRpY2F0aW9uKSB7CgogICAgICAkc2NvcGUuaWRlbnRpdHkgPSBVc2VyQXV0aGVudGljYXRpb24uaWRlbnRpdHk7CiAgICAgICRzY29wZS5pZGVudGlmaWVkID0gVXNlckF1dGhlbnRpY2F0aW9uLmlkZW50aWZpZWQ7CgogICAgICAkc2NvcGUuJG9uKCd1c2VyQXV0aGVudGljYXRpb246aWRlbnRpdHk6Y2hhbmdlZCcsIGZ1bmN0aW9uKGV2ZW50LCBpZGVudGl0eSkgewogICAgICAgICRzY29wZS5pZGVudGl0eSA9IFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGl0eTsKICAgICAgICAkc2NvcGUuaWRlbnRpZmllZCA9IFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmaWVkOwogICAgICB9KTsKCiAgICAgICRzY29wZS5hdXRoZW50aWNhdGUgPSBmdW5jdGlvbihzZXNzaW9uKSB7CiAgICAgICAgVXNlckF1dGhlbnRpY2F0aW9uLmF1dGhlbnRpY2F0ZShzZXNzaW9uLmxvZ2luLCBzZXNzaW9uLnBhc3N3b3JkLCBzZXNzaW9uLnJlbWVtYmVyKTsKICAgICAgfTsKCiAgICAgICRzY29wZS5kZWF1dGhlbnRpY2F0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgIFVzZXJBdXRoZW50aWNhdGlvbi5kZWF1dGhlbnRpY2F0ZSgpOwogICAgICB9OwoKICAgIH1dKQoKICAgIC8qCiAgICAgKiBSb3V0ZSBSZXNvbHZlIEhlbHBlcnMKICAgICAqLwoKICAgIC5mYWN0b3J5KCdJZGVudGl0eVJlcXVpcmVkJywgWyckbG9jYXRpb24nLCAnVXNlckF1dGhlbnRpY2F0aW9uJywgZnVuY3Rpb24oJGxvY2F0aW9uLCBVc2VyQXV0aGVudGljYXRpb24pIHsKICAgICAgVXNlckF1dGhlbnRpY2F0aW9uLmlkZW50aWZ5KCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICBpZiAoVXNlckF1dGhlbnRpY2F0aW9uLmlkZW50aWZpZWQgPT09IGZhbHNlKSB7CiAgICAgICAgICAkbG9jYXRpb24ucGF0aChVc2VyQXV0aGVudGljYXRpb24uY29uZmlnLnBhdGhJZGVudGl0eVJlcXVpcmVkKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfV0pCgogICAgLmZhY3RvcnkoJ05vSWRlbnRpdHlSZXF1aXJlZCcsIFsnJGxvY2F0aW9uJywgJ1VzZXJBdXRoZW50aWNhdGlvbicsIGZ1bmN0aW9uKCRsb2NhdGlvbiwgVXNlckF1dGhlbnRpY2F0aW9uKSB7CiAgICAgIFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmeSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgaWYgKFVzZXJBdXRoZW50aWNhdGlvbi5pZGVudGlmaWVkID09PSB0cnVlKSB7CiAgICAgICAgICAkbG9jYXRpb24ucGF0aChVc2VyQXV0aGVudGljYXRpb24uY29uZmlnLnBhdGhOb0lkZW50aXR5UmVxdWlyZWQpOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9XSk7Cgp9KCkpOwo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Thu, 06 Nov 2014 09:10:19 GMT",
                    "Content-Length": "6827",
                    "Date": "Thu, 06 Nov 2014 09:10:20 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}