{
    "url": "http://localhost:9999/highslide-software/highcharts.com/lib/mootools-core-1.3.2-full-compat.js",
    "host": "localhost",
    "port": 9999,
    "protocol": "http",
    "name": "Open redirection (DOM-based)",
    "issueType": 5243152,
    "severity": "Low",
    "confidence": "Firm",
    "issueBackground": "DOM-based open redirection vulnerabilities arise when a client-side script within an application's response reads data from a controllable part of the DOM (for example, the URL), and writes this data into the target of a redirection in an unsafe way. An attacker may be able to use the vulnerability to construct a URL which, if visited by another application user, will cause a redirection to an arbitrary external domain. This behavior can be leveraged to facilitate phishing attacks against users of the application. The ability to use an authentic application URL, targeting the correct domain with a valid SSL certificate (if SSL is used) lends credibility to the phishing attack because many users, even if they verify these features, will not notice the subsequent redirection to a different domain.<br><br><b>Note:</b> If an attacker is able to control the start of the string that is passed to the redirection API, then it may be possible to escalate this vulnerability into a JavaScript injection attack, by using a URL with the javascript: pseudo-protocol to execute arbitrary script code when the URL is processed by the browser.",
    "remediationBackground": "Static analysis of code to identify vulnerabilities of this kind may lead to false positives that are not actually exploitable. You should review the highlighted code and related execution paths to determine whether the application is indeed vulnerable, or whether mitigations are in place that would prevent exploitation.<br><br>The most effective way to avoid DOM-based open redirection vulnerabilities is not to dynamically set redirection targets using data that originated from any untrusted source. If the desired functionality of the application means that this behavior is unavoidable, then defenses must be implemented within the client-side code to prevent malicious data from introducing an arbitrary URL as a redirection target. In general, this is best achieved by using a whitelist of URLs that are permitted redirection targets, and strictly validating the target against this list before performing the redirection.",
    "issueDetail": "The application may be vulnerable to DOM-based open redirection. Data is read from <b>document.location.pathname</b> and written to <b>the 'open()' function of an XMLHttpRequest object</b> via the following statements:<ul><li>url = document.location.pathname;</li><li>url = url.substr(0, trimPosition);</li><li>xhr.open(method.toUpperCase(), url, this.options.async, this.options.user, this.options.password);</li></ul>",
    "requestResponses": [
        {
            "request": {
                "host": "localhost",
                "port": 9999,
                "protocol": "http",
                "url": "http://localhost:9999/highslide-software/highcharts.com/lib/mootools-core-1.3.2-full-compat.js",
                "path": "/highslide-software/highcharts.com/lib/mootools-core-1.3.2-full-compat.js",
                "httpVersion": "HTTP/1.1",
                "method": "GET",
                "headers": {
                    "Host": "localhost:9999"
                },
                "body": "",
                "raw": "R0VUIC9oaWdoc2xpZGUtc29mdHdhcmUvaGlnaGNoYXJ0cy5jb20vbGliL21vb3Rvb2xzLWNvcmUtMS4zLjItZnVsbC1jb21wYXQuanMgSFRUUC8xLjENCkhvc3Q6IGxvY2FsaG9zdDo5OTk5DQoNCg==",
                "inScope": true,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "request"
            },
            "response": {
                "statusCode": 200,
                "raw": "SFRUUC8xLjEgMjAwIE9LDQpDb250ZW50LUxlbmd0aDogMTQ2MTg2DQpBY2NlcHQtUmFuZ2VzOiBieXRlcw0KQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0DQpEYXRlOiBGcmksIDA3IE5vdiAyMDE0IDAzOjExOjI5IEdNVA0KTGFzdC1Nb2RpZmllZDogRnJpLCAwNyBOb3YgMjAxNCAwMzoxMToyNyBHTVQNCg0KLyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zLjInLAoJYnVpbGQ6ICdjOWYxZmYxMGU5ZTdmYWNiNjVlOTQ4MTA0OWVkMWI0NTA5NTlkNTg3Jwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgkKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgndW5pcXVlSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCi8vPDEuMmNvbXBhdD4KCnZhciBIYXNoID0gdGhpcy5IYXNoID0gbmV3IFR5cGUoJ0hhc2gnLCBmdW5jdGlvbihvYmplY3QpewoJaWYgKHR5cGVPZihvYmplY3QpID09ICdoYXNoJykgb2JqZWN0ID0gT2JqZWN0LmNsb25lKG9iamVjdC5nZXRDbGVhbigpKTsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpIHRoaXNba2V5XSA9IG9iamVjdFtrZXldOwoJcmV0dXJuIHRoaXM7Cn0pOwoKSGFzaC5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlPYmplY3QuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCWdldENsZWFuOiBmdW5jdGlvbigpewoJCXZhciBjbGVhbiA9IHt9OwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgY2xlYW5ba2V5XSA9IHRoaXNba2V5XTsKCQl9CgkJcmV0dXJuIGNsZWFuOwoJfSwKCglnZXRMZW5ndGg6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IDA7CgkJZm9yICh2YXIga2V5IGluIHRoaXMpewoJCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBsZW5ndGgrKzsKCQl9CgkJcmV0dXJuIGxlbmd0aDsKCX0KCn0pOwoKSGFzaC5hbGlhcygnZWFjaCcsICdmb3JFYWNoJyk7CgpPYmplY3QudHlwZSA9IFR5cGUuaXNPYmplY3Q7Cgp2YXIgTmF0aXZlID0gdGhpcy5OYXRpdmUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCXJldHVybiBuZXcgVHlwZShwcm9wZXJ0aWVzLm5hbWUsIHByb3BlcnRpZXMuaW5pdGlhbGl6ZSk7Cn07CgpOYXRpdmUudHlwZSA9IFR5cGUudHlwZTsKCk5hdGl2ZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihvYmplY3RzLCBtZXRob2RzKXsKCWZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgb2JqZWN0c1tpXS5pbXBsZW1lbnQobWV0aG9kcyk7CglyZXR1cm4gTmF0aXZlOwp9OwoKdmFyIGFycmF5VHlwZSA9IEFycmF5LnR5cGU7CkFycmF5LnR5cGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpbnN0YW5jZU9mKGl0ZW0sIEFycmF5KSB8fCBhcnJheVR5cGUoaXRlbSk7Cn07Cgp0aGlzLiRBID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gQXJyYXkuZnJvbShpdGVtKS5zbGljZSgpOwp9OwoKdGhpcy4kYXJndW1lbnRzID0gZnVuY3Rpb24oaSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQlyZXR1cm4gYXJndW1lbnRzW2ldOwoJfTsKfTsKCnRoaXMuJGNoayA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gISEob2JqIHx8IG9iaiA9PT0gMCk7Cn07Cgp0aGlzLiRjbGVhciA9IGZ1bmN0aW9uKHRpbWVyKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CgljbGVhckludGVydmFsKHRpbWVyKTsKCXJldHVybiBudWxsOwp9OwoKdGhpcy4kZGVmaW5lZCA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gKG9iaiAhPSBudWxsKTsKfTsKCnRoaXMuJGVhY2ggPSBmdW5jdGlvbihpdGVyYWJsZSwgZm4sIGJpbmQpewoJdmFyIHR5cGUgPSB0eXBlT2YoaXRlcmFibGUpOwoJKCh0eXBlID09ICdhcmd1bWVudHMnIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdlbGVtZW50cycpID8gQXJyYXkgOiBPYmplY3QpLmVhY2goaXRlcmFibGUsIGZuLCBiaW5kKTsKfTsKCnRoaXMuJGVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKdGhpcy4kZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luYWwsIGV4dGVuZGVkKXsKCXJldHVybiBPYmplY3QuYXBwZW5kKG9yaWdpbmFsLCBleHRlbmRlZCk7Cn07Cgp0aGlzLiRIID0gZnVuY3Rpb24ob2JqZWN0KXsKCXJldHVybiBuZXcgSGFzaChvYmplY3QpOwp9OwoKdGhpcy4kbWVyZ2UgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMpOwoJYXJncy51bnNoaWZ0KHt9KTsKCXJldHVybiBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgYXJncyk7Cn07Cgp0aGlzLiRsYW1iZGEgPSBGdW5jdGlvbi5mcm9tOwp0aGlzLiRtaXhpbiA9IE9iamVjdC5tZXJnZTsKdGhpcy4kcmFuZG9tID0gTnVtYmVyLnJhbmRvbTsKdGhpcy4kc3BsYXQgPSBBcnJheS5mcm9tOwp0aGlzLiR0aW1lID0gRGF0ZS5ub3c7Cgp0aGlzLiR0eXBlID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdCk7CglpZiAodHlwZSA9PSAnZWxlbWVudHMnKSByZXR1cm4gJ2FycmF5JzsKCXJldHVybiAodHlwZSA9PSAnbnVsbCcpID8gZmFsc2UgOiB0eXBlOwp9OwoKdGhpcy4kdW5saW5rID0gZnVuY3Rpb24ob2JqZWN0KXsKCXN3aXRjaCAodHlwZU9mKG9iamVjdCkpewoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUob2JqZWN0KTsKCQljYXNlICdhcnJheSc6IHJldHVybiBBcnJheS5jbG9uZShvYmplY3QpOwoJCWNhc2UgJ2hhc2gnOiByZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKCQlkZWZhdWx0OiByZXR1cm4gb2JqZWN0OwoJfQp9OwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJLyo8IUVTNT4qLwoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW47IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IHRoaXMuaW5kZXhPZihzdHJpbmcpID4gLTE7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gKCctJyArIG1hdGNoLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpKTsKCQl9KTsKCX0sCgoJY2FwaXRhbGl6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8oWy0uKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfSwKCgl0b0ludDogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIHBhcnNlSW50KHRoaXMsIGJhc2UgfHwgMTApOwoJfSwKCgl0b0Zsb2F0OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUZsb2F0KHRoaXMpOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IG51bGw7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKHJlZ2V4cCB8fCAoL1xcP1x7KFtee31dKylcfS9nKSwgZnVuY3Rpb24obWF0Y2gsIG5hbWUpewoJCQlpZiAobWF0Y2guY2hhckF0KDApID09ICdcXCcpIHJldHVybiBtYXRjaC5zbGljZSgxKTsKCQkJcmV0dXJuIChvYmplY3RbbmFtZV0gIT0gbnVsbCkgPyBvYmplY3RbbmFtZV0gOiAnJzsKCQl9KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzU+Ki8KCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoJLyo8LyFFUzU+Ki8KCglwYXNzOiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJaWYgKGFyZ3MgIT0gbnVsbCkgYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglkZWxheTogZnVuY3Rpb24oZGVsYXksIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRUaW1lb3V0KHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIGRlbGF5KTsKCX0sCgoJcGVyaW9kaWNhbDogZnVuY3Rpb24ocGVyaW9kaWNhbCwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldEludGVydmFsKHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEJyb3dzZXIKCmRlc2NyaXB0aW9uOiBUaGUgQnJvd3NlciBPYmplY3QuIENvbnRhaW5zIEJyb3dzZXIgaW5pdGlhbGl6YXRpb24sIFdpbmRvdyBhbmQgRG9jdW1lbnQsIGFuZCB0aGUgQnJvd3NlciBIYXNoLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBGdW5jdGlvbiwgTnVtYmVyLCBTdHJpbmddCgpwcm92aWRlczogW0Jyb3dzZXIsIFdpbmRvdywgRG9jdW1lbnRdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGRvY3VtZW50ID0gdGhpcy5kb2N1bWVudDsKdmFyIHdpbmRvdyA9IGRvY3VtZW50LndpbmRvdyA9IHRoaXM7Cgp2YXIgVUlEID0gMTsKCnRoaXMuJHVpZCA9ICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgPyBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbS51aWQgfHwgKGl0ZW0udWlkID0gW1VJRCsrXSkpWzBdOwp9IDogZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbS51aWQgfHwgKGl0ZW0udWlkID0gVUlEKyspOwp9OwoKJHVpZCh3aW5kb3cpOwokdWlkKGRvY3VtZW50KTsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgovLzwxLjJjb21wYXQ+CgppZiAoQnJvd3Nlci5QbGF0Zm9ybS5pb3MpIEJyb3dzZXIuUGxhdGZvcm0uaXBvZCA9IHRydWU7CgpCcm93c2VyLkVuZ2luZSA9IHt9OwoKdmFyIHNldEVuZ2luZSA9IGZ1bmN0aW9uKG5hbWUsIHZlcnNpb24pewoJQnJvd3Nlci5FbmdpbmUubmFtZSA9IG5hbWU7CglCcm93c2VyLkVuZ2luZVtuYW1lICsgdmVyc2lvbl0gPSB0cnVlOwoJQnJvd3Nlci5FbmdpbmUudmVyc2lvbiA9IHZlcnNpb247Cn07CgppZiAoQnJvd3Nlci5pZSl7CglCcm93c2VyLkVuZ2luZS50cmlkZW50ID0gdHJ1ZTsKCglzd2l0Y2ggKEJyb3dzZXIudmVyc2lvbil7CgkJY2FzZSA2OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA0KTsgYnJlYWs7CgkJY2FzZSA3OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA1KTsgYnJlYWs7CgkJY2FzZSA4OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA2KTsKCX0KfQoKaWYgKEJyb3dzZXIuZmlyZWZveCl7CglCcm93c2VyLkVuZ2luZS5nZWNrbyA9IHRydWU7CgoJaWYgKEJyb3dzZXIudmVyc2lvbiA+PSAzKSBzZXRFbmdpbmUoJ2dlY2tvJywgMTkpOwoJZWxzZSBzZXRFbmdpbmUoJ2dlY2tvJywgMTgpOwp9CgppZiAoQnJvd3Nlci5zYWZhcmkgfHwgQnJvd3Nlci5jaHJvbWUpewoJQnJvd3Nlci5FbmdpbmUud2Via2l0ID0gdHJ1ZTsKCglzd2l0Y2ggKEJyb3dzZXIudmVyc2lvbil7CgkJY2FzZSAyOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQxOSk7IGJyZWFrOwoJCWNhc2UgMzogc2V0RW5naW5lKCd3ZWJraXQnLCA0MjApOyBicmVhazsKCQljYXNlIDQ6IHNldEVuZ2luZSgnd2Via2l0JywgNTI1KTsKCX0KfQoKaWYgKEJyb3dzZXIub3BlcmEpewoJQnJvd3Nlci5FbmdpbmUucHJlc3RvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDkuNikgc2V0RW5naW5lKCdwcmVzdG8nLCA5NjApOwoJZWxzZSBpZiAoQnJvd3Nlci52ZXJzaW9uID49IDkuNSkgc2V0RW5naW5lKCdwcmVzdG8nLCA5NTApOwoJZWxzZSBzZXRFbmdpbmUoJ3ByZXN0bycsIDkyNSk7Cn0KCmlmIChCcm93c2VyLm5hbWUgPT0gJ3Vua25vd24nKXsKCXN3aXRjaCAoKHVhLm1hdGNoKC8oPzp3ZWJraXR8a2h0bWx8Z2Vja28pLykgfHwgW10pWzBdKXsKCQljYXNlICd3ZWJraXQnOgoJCWNhc2UgJ2todG1sJzoKCQkJQnJvd3Nlci5FbmdpbmUud2Via2l0ID0gdHJ1ZTsKCQlicmVhazsKCQljYXNlICdnZWNrbyc6CgkJCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCX0KfQoKdGhpcy4kZXhlYyA9IEJyb3dzZXIuZXhlYzsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgRXZlbnQgQ2xhc3MsIHRvIG1ha2UgdGhlIGV2ZW50IG9iamVjdCBjcm9zcy1icm93c2VyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBGdW5jdGlvbiwgU3RyaW5nLCBPYmplY3RdCgpwcm92aWRlczogRXZlbnQKCi4uLgoqLwoKdmFyIEV2ZW50ID0gbmV3IFR5cGUoJ0V2ZW50JywgZnVuY3Rpb24oZXZlbnQsIHdpbil7CglpZiAoIXdpbikgd2luID0gd2luZG93OwoJdmFyIGRvYyA9IHdpbi5kb2N1bWVudDsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdmFyIHR5cGUgPSBldmVudC50eXBlLAoJCXRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50LAoJCXBhZ2UgPSB7fSwKCQljbGllbnQgPSB7fSwKCQlyZWxhdGVkID0gbnVsbCwKCQlyaWdodENsaWNrLCB3aGVlbCwgY29kZSwga2V5OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgIT0gLTEpewoJCWNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCWtleSA9IE9iamVjdC5rZXlPZihFdmVudC5LZXlzLCBjb2RlKTsKCQlpZiAodHlwZSA9PSAna2V5ZG93bicpewoJCQl2YXIgZktleSA9IGNvZGUgLSAxMTE7CgkJCWlmIChmS2V5ID4gMCAmJiBmS2V5IDwgMTMpIGtleSA9ICdmJyArIGZLZXk7CgkJfQoJCWlmICgha2V5KSBrZXkgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpLnRvTG93ZXJDYXNlKCk7Cgl9IGVsc2UgaWYgKCgvY2xpY2t8bW91c2V8bWVudS9pKS50ZXN0KHR5cGUpKXsKCQlkb2MgPSAoIWRvYy5jb21wYXRNb2RlIHx8IGRvYy5jb21wYXRNb2RlID09ICdDU1MxQ29tcGF0JykgPyBkb2MuaHRtbCA6IGRvYy5ib2R5OwoJCXBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQljbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAoKC9ET01Nb3VzZVNjcm9sbHxtb3VzZXdoZWVsLykudGVzdCh0eXBlKSl7CgkJCXdoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCQl9CgkJcmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICgoL292ZXJ8b3V0LykudGVzdCh0eXBlKSl7CgkJCXJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50Wyh0eXBlID09ICdtb3VzZW92ZXInID8gJ2Zyb20nIDogJ3RvJykgKyAnRWxlbWVudCddOwoJCQl2YXIgdGVzdFJlbGF0ZWQgPSBmdW5jdGlvbigpewoJCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQkJcmV0dXJuIHRydWU7CgkJCX07CgkJCXZhciBoYXNSZWxhdGVkID0gKEJyb3dzZXIuZmlyZWZveDIpID8gdGVzdFJlbGF0ZWQuYXR0ZW1wdCgpIDogdGVzdFJlbGF0ZWQoKTsKCQkJcmVsYXRlZCA9IChoYXNSZWxhdGVkKSA/IHJlbGF0ZWQgOiBudWxsOwoJCX0KCX0gZWxzZSBpZiAoKC9nZXN0dXJlfHRvdWNoL2kpLnRlc3QodHlwZSkpewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQlwYWdlID0ge3g6IHRvdWNoLnBhZ2VYLCB5OiB0b3VjaC5wYWdlWX07CgkJCWNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJcmV0dXJuIE9iamVjdC5hcHBlbmQodGhpcywgewoJCWV2ZW50OiBldmVudCwKCQl0eXBlOiB0eXBlLAoKCQlwYWdlOiBwYWdlLAoJCWNsaWVudDogY2xpZW50LAoJCXJpZ2h0Q2xpY2s6IHJpZ2h0Q2xpY2ssCgoJCXdoZWVsOiB3aGVlbCwKCgkJcmVsYXRlZFRhcmdldDogZG9jdW1lbnQuaWQocmVsYXRlZCksCgkJdGFyZ2V0OiBkb2N1bWVudC5pZCh0YXJnZXQpLAoKCQljb2RlOiBjb2RlLAoJCWtleToga2V5LAoKCQlzaGlmdDogZXZlbnQuc2hpZnRLZXksCgkJY29udHJvbDogZXZlbnQuY3RybEtleSwKCQlhbHQ6IGV2ZW50LmFsdEtleSwKCQltZXRhOiBldmVudC5tZXRhS2V5Cgl9KTsKfSk7CgpFdmVudC5LZXlzID0gewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfTsKCi8vPDEuMmNvbXBhdD4KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8vPC8xLjJjb21wYXQ+CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgQ2xhc3MgRnVuY3Rpb24gZm9yIGVhc2lseSBjcmVhdGluZywgZXh0ZW5kaW5nLCBhbmQgaW1wbGVtZW50aW5nIHJldXNhYmxlIENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlcl0KCnByb3ZpZGVzOiBDbGFzcwoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBDbGFzcyA9IHRoaXMuQ2xhc3MgPSBuZXcgVHlwZSgnQ2xhc3MnLCBmdW5jdGlvbihwYXJhbXMpewoJaWYgKGluc3RhbmNlT2YocGFyYW1zLCBGdW5jdGlvbikpIHBhcmFtcyA9IHtpbml0aWFsaXplOiBwYXJhbXN9OwoKCXZhciBuZXdDbGFzcyA9IGZ1bmN0aW9uKCl7CgkJcmVzZXQodGhpcyk7CgkJaWYgKG5ld0NsYXNzLiRwcm90b3R5cGluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gbnVsbDsKCQl2YXIgdmFsdWUgPSAodGhpcy5pbml0aWFsaXplKSA/IHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpczsKCQl0aGlzLiRjYWxsZXIgPSB0aGlzLmNhbGxlciA9IG51bGw7CgkJcmV0dXJuIHZhbHVlOwoJfS5leHRlbmQodGhpcykuaW1wbGVtZW50KHBhcmFtcyk7CgoJbmV3Q2xhc3MuJGNvbnN0cnVjdG9yID0gQ2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUucGFyZW50ID0gcGFyZW50OwoKCXJldHVybiBuZXdDbGFzczsKfSk7Cgp2YXIgcGFyZW50ID0gZnVuY3Rpb24oKXsKCWlmICghdGhpcy4kY2FsbGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgInBhcmVudCIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCXZhciBuYW1lID0gdGhpcy4kY2FsbGVyLiRuYW1lLAoJCXBhcmVudCA9IHRoaXMuJGNhbGxlci4kb3duZXIucGFyZW50LAoJCXByZXZpb3VzID0gKHBhcmVudCkgPyBwYXJlbnQucHJvdG90eXBlW25hbWVdIDogbnVsbDsKCWlmICghcHJldmlvdXMpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIG5hbWUgKyAnIiBoYXMgbm8gcGFyZW50LicpOwoJcmV0dXJuIHByZXZpb3VzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07Cgp2YXIgcmVzZXQgPSBmdW5jdGlvbihvYmplY3QpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJc3dpdGNoICh0eXBlT2YodmFsdWUpKXsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCXZhciBGID0gZnVuY3Rpb24oKXt9OwoJCQkJRi5wcm90b3R5cGUgPSB2YWx1ZTsKCQkJCW9iamVjdFtrZXldID0gcmVzZXQobmV3IEYpOwoJCQlicmVhazsKCQkJY2FzZSAnYXJyYXknOiBvYmplY3Rba2V5XSA9IHZhbHVlLmNsb25lKCk7IGJyZWFrOwoJCX0KCX0KCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgd3JhcCA9IGZ1bmN0aW9uKHNlbGYsIGtleSwgbWV0aG9kKXsKCWlmIChtZXRob2QuJG9yaWdpbikgbWV0aG9kID0gbWV0aG9kLiRvcmlnaW47Cgl2YXIgd3JhcHBlciA9IGZ1bmN0aW9uKCl7CgkJaWYgKG1ldGhvZC4kcHJvdGVjdGVkICYmIHRoaXMuJGNhbGxlciA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBrZXkgKyAnIiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJCXZhciBjYWxsZXIgPSB0aGlzLmNhbGxlciwgY3VycmVudCA9IHRoaXMuJGNhbGxlcjsKCQl0aGlzLmNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuJGNhbGxlciA9IHdyYXBwZXI7CgkJdmFyIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCXRoaXMuJGNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuY2FsbGVyID0gY2FsbGVyOwoJCXJldHVybiByZXN1bHQ7Cgl9LmV4dGVuZCh7JG93bmVyOiBzZWxmLCAkb3JpZ2luOiBtZXRob2QsICRuYW1lOiBrZXl9KTsKCXJldHVybiB3cmFwcGVyOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHJldGFpbil7CglpZiAoQ2xhc3MuTXV0YXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSl7CgkJdmFsdWUgPSBDbGFzcy5NdXRhdG9yc1trZXldLmNhbGwodGhpcywgdmFsdWUpOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpczsKCX0KCglpZiAodHlwZU9mKHZhbHVlKSA9PSAnZnVuY3Rpb24nKXsKCQlpZiAodmFsdWUuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcm90b3R5cGVba2V5XSA9IChyZXRhaW4pID8gdmFsdWUgOiB3cmFwKHRoaXMsIGtleSwgdmFsdWUpOwoJfSBlbHNlIHsKCQlPYmplY3QubWVyZ2UodGhpcy5wcm90b3R5cGUsIGtleSwgdmFsdWUpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKdmFyIGdldEluc3RhbmNlID0gZnVuY3Rpb24oa2xhc3MpewoJa2xhc3MuJHByb3RvdHlwaW5nID0gdHJ1ZTsKCXZhciBwcm90byA9IG5ldyBrbGFzczsKCWRlbGV0ZSBrbGFzcy4kcHJvdG90eXBpbmc7CglyZXR1cm4gcHJvdG87Cn07CgpDbGFzcy5pbXBsZW1lbnQoJ2ltcGxlbWVudCcsIGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpKTsKCkNsYXNzLk11dGF0b3JzID0gewoKCUV4dGVuZHM6IGZ1bmN0aW9uKHBhcmVudCl7CgkJdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CgkJdGhpcy5wcm90b3R5cGUgPSBnZXRJbnN0YW5jZShwYXJlbnQpOwoJfSwKCglJbXBsZW1lbnRzOiBmdW5jdGlvbihpdGVtcyl7CgkJQXJyYXkuZnJvbShpdGVtcykuZWFjaChmdW5jdGlvbihpdGVtKXsKCQkJdmFyIGluc3RhbmNlID0gbmV3IGl0ZW07CgkJCWZvciAodmFyIGtleSBpbiBpbnN0YW5jZSkgaW1wbGVtZW50LmNhbGwodGhpcywga2V5LCBpbnN0YW5jZVtrZXldLCB0cnVlKTsKCQl9LCB0aGlzKTsKCX0KfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSBpZiAoaSBpbiBmbnMpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBmbnNbaV0pOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCkgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpewoJCQlpZiAodHlwZU9mKG9wdGlvbnNbb3B0aW9uXSkgIT0gJ2Z1bmN0aW9uJyB8fCAhKC9eb25bQS1aXS8pLnRlc3Qob3B0aW9uKSkgY29udGludWU7CgkJCXRoaXMuYWRkRXZlbnQob3B0aW9uLCBvcHRpb25zW29wdGlvbl0pOwoJCQlkZWxldGUgb3B0aW9uc1tvcHRpb25dOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBsb2NhbCA9IHt9LAoJZmVhdHVyZXNDYWNoZSA9IHt9LAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKLy8gRmVhdHVyZSAvIEJ1ZyBkZXRlY3Rpb24KCmxvY2FsLmlzTmF0aXZlQ29kZSA9IGZ1bmN0aW9uKGZuKXsKCXJldHVybiAoL1x7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vKS50ZXN0KCcnICsgZm4pOwp9OwoKbG9jYWwuaXNYTUwgPSBmdW5jdGlvbihkb2N1bWVudCl7CglyZXR1cm4gKCEhZG9jdW1lbnQueG1sVmVyc2lvbikgfHwgKCEhZG9jdW1lbnQueG1sKSB8fCAodG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gJ1tvYmplY3QgWE1MRG9jdW1lbnRdJykgfHwKCShkb2N1bWVudC5ub2RlVHlwZSA9PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPSAnSFRNTCcpOwp9OwoKbG9jYWwuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbihkb2N1bWVudCl7CgoJLy8gY29udmVydCBlbGVtZW50cyAvIHdpbmRvdyBhcmd1bWVudHMgdG8gZG9jdW1lbnQuIGlmIGRvY3VtZW50IGNhbm5vdCBiZSBleHRyYXBvbGF0ZWQsIHRoZSBmdW5jdGlvbiByZXR1cm5zLgoJdmFyIG5vZGVUeXBlID0gZG9jdW1lbnQubm9kZVR5cGU7CglpZiAobm9kZVR5cGUgPT0gOSk7IC8vIGRvY3VtZW50CgllbHNlIGlmIChub2RlVHlwZSkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7CgoJLy8gY2hlY2sgaWYgd2UgaGF2ZSBkb25lIGZlYXR1cmUgZGV0ZWN0aW9uIG9uIHRoaXMgZG9jdW1lbnQgYmVmb3JlCgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJcm9vdFVpZCA9IHRoaXMuZ2V0VUlEWE1MKHJvb3QpLAoJCWZlYXR1cmVzID0gZmVhdHVyZXNDYWNoZVtyb290VWlkXSwKCQlmZWF0dXJlOwoKCWlmIChmZWF0dXJlcyl7CgkJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJCX0KCQlyZXR1cm47Cgl9CgoJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdID0ge307CgoJZmVhdHVyZXMucm9vdCA9IHJvb3Q7CglmZWF0dXJlcy5pc1hNTERvY3VtZW50ID0gdGhpcy5pc1hNTChkb2N1bWVudCk7CgoJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROCgk9IGZlYXR1cmVzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IGZlYXR1cmVzLmlkR2V0c05hbWUKCT0gZmVhdHVyZXMuYnJva2VuTWl4ZWRDYXNlUVNBCgk9IGZlYXR1cmVzLmJyb2tlbkdFQkNOCgk9IGZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EKCT0gZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EKCT0gZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQKCT0gZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yCgk9IGZhbHNlOwoKCXZhciBzdGFyU2VsZWN0c0Nsb3NlZCwgc3RhclNlbGVjdHNDb21tZW50cywKCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiwgY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSwKCQlicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyOwoKCXZhciBzZWxlY3RlZCwgaWQgPSAnc2xpY2tfdW5pcXVlaWQnOwoJdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkKCXZhciB0ZXN0Um9vdCA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXSB8fCByb290OwoJdGVzdFJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgaWQ9IicraWQrJyI+PC9hPic7CgkJZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgPSAhIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCX0gY2F0Y2goZSl7fTsKCglpZiAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQpewoKCQl0ZXN0Tm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKCQkvLyBJRSByZXR1cm5zIGNvbW1lbnQgbm9kZXMgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdGVzdE5vZGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnJykpOwoJCXN0YXJTZWxlY3RzQ29tbWVudHMgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKS5sZW5ndGggPiAxKTsKCgkJLy8gSUUgcmV0dXJucyBjbG9zZWQgbm9kZXMgKEVHOiI8L2Zvbz4iKSBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQlzdGFyU2VsZWN0c0Nsb3NlZCA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCWZlYXR1cmVzLmJyb2tlblN0YXJHRUJUTiA9IHN0YXJTZWxlY3RzQ29tbWVudHMgfHwgc3RhclNlbGVjdHNDbG9zZWQ7CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJysgaWQgKyciPjwvYT48YiBpZD0iJysgaWQgKyciPjwvYj4nOwoJCQlmZWF0dXJlcy5pZEdldHNOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpID09PSB0ZXN0Tm9kZS5maXJzdENoaWxkOwoJCX0gY2F0Y2goZSl7fTsKCgkJaWYgKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpewoKCQkJLy8gU2FmYXJpIDMuMiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhY2hlcyByZXN1bHRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImYiPjwvYT48YSBjbGFzcz0iYiI+PC9hPic7CgkJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQkJdGVzdE5vZGUuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAnYic7CgkJCQljYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIE9wZXJhIDkuNiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGRvZXNudCBkZXRlY3RzIHRoZSBjbGFzcyBpZiBpdHMgbm90IHRoZSBmaXJzdCBvbmUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdhJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQlmZWF0dXJlcy5icm9rZW5HRUJDTiA9IGNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ047CgkJfQoJCQoJCWlmICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKXsKCQkJLy8gSUUgOCByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBxdWVyeVNlbGVjdG9yQWxsKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQkJZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9Ik1pWCI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EgPSAhdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLk1pWCcpLmxlbmd0aDsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gV2Via2l0IGFuZCBPcGVyYSBkb250IHJldHVybiBzZWxlY3RlZCBvcHRpb25zIG9uIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj5hPC9vcHRpb24+PC9zZWxlY3Q+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSIiPjwvYT4nOwoJCQkJZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iIl0nKS5sZW5ndGggIT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJfQoKCQkvLyBJRTYtNywgaWYgYSBmb3JtIGhhcyBhbiBpbnB1dCBvZiBpZCB4LCBmb3JtLmdldEF0dHJpYnV0ZSh4KSByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnB1dAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8Zm9ybSBhY3Rpb249InMiPjxpbnB1dCBpZD0iYWN0aW9uIi8+PC9mb3JtPic7CgkJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXIgPSAodGVzdE5vZGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpICE9ICdzJyk7CgkJfSBjYXRjaChlKXt9OwoKCQkvLyBuYXRpdmUgbWF0Y2hlc1NlbGVjdG9yIGZ1bmN0aW9uCgoJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IHJvb3QubWF0Y2hlc1NlbGVjdG9yIHx8IC8qcm9vdC5tc01hdGNoZXNTZWxlY3RvciB8fCovIHJvb3QubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHJvb3Qud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwoJCWlmIChmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpIHRyeSB7CgkJCS8vIGlmIG1hdGNoZXNTZWxlY3RvciB0cm93cyBlcnJvcnMgb24gaW5jb3JyZWN0IHNpbnRheGVzIHdlIGNhbiB1c2UgaXQKCQkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwocm9vdCwgJzpzbGljaycpOwoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IgPSBudWxsOwoJCX0gY2F0Y2goZSl7fTsKCgl9CgoJdHJ5IHsKCQlyb290LnNsaWNrX2V4cGFuZG8gPSAxOwoJCWRlbGV0ZSByb290LnNsaWNrX2V4cGFuZG87CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURIVE1MOwoJfSBjYXRjaChlKSB7CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURYTUw7Cgl9CgoJdGVzdFJvb3QucmVtb3ZlQ2hpbGQodGVzdE5vZGUpOwoJdGVzdE5vZGUgPSBzZWxlY3RlZCA9IHRlc3RSb290ID0gbnVsbDsKCgkvLyBnZXRBdHRyaWJ1dGUKCglmZWF0dXJlcy5nZXRBdHRyaWJ1dGUgPSAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgJiYgYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlcikgPyBmdW5jdGlvbihub2RlLCBuYW1lKXsKCQl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJCWlmIChtZXRob2QpIHJldHVybiBtZXRob2QuY2FsbChub2RlKTsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShuYW1lKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJcmV0dXJuIChtZXRob2QpID8gbWV0aG9kLmNhbGwobm9kZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKCX07CgoJLy8gaGFzQXR0cmlidXRlCgoJZmVhdHVyZXMuaGFzQXR0cmlidXRlID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5oYXNBdHRyaWJ1dGUpKSA/IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCXJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCW5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKTsKCQlyZXR1cm4gISEobm9kZSAmJiAobm9kZS5zcGVjaWZpZWQgfHwgbm9kZS5ub2RlVmFsdWUpKTsKCX07CgoJLy8gY29udGFpbnMKCS8vIEZJWE1FOiBBZGQgc3BlY3M6IGxvY2FsLmNvbnRhaW5zIHNob3VsZCBiZSBkaWZmZXJlbnQgZm9yIHhtbCBhbmQgaHRtbCBkb2N1bWVudHM/CglmZWF0dXJlcy5jb250YWlucyA9IChyb290ICYmIHRoaXMuaXNOYXRpdmVDb2RlKHJvb3QuY29udGFpbnMpKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0LmNvbnRhaW5zKG5vZGUpOwoJfSA6IChyb290ICYmIHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQgPT09IG5vZGUgfHwgISEoY29udGV4dC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihub2RlKSAmIDE2KTsKCX0gOiBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlpZiAobm9kZSkgZG8gewoJCQlpZiAobm9kZSA9PT0gY29udGV4dCkgcmV0dXJuIHRydWU7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKTsKCQlyZXR1cm4gZmFsc2U7Cgl9OwoKCS8vIGRvY3VtZW50IG9yZGVyIHNvcnRpbmcKCS8vIGNyZWRpdHMgdG8gU2l6emxlIChodHRwOi8vc2l6emxlanMuY29tLykKCglmZWF0dXJlcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJcm9vdCA9IG51bGw7CgoJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07Cgl9Cn07CgovLyBNYWluIE1ldGhvZAoKdmFyIHJlU2ltcGxlU2VsZWN0b3IgPSAvXihbIy5dPykoKD86W1x3LV0rfFwqKSkkLywKCXJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuK1sqJF5dPSg/OiIifCcnKT9cXS8sCglxc2FGYWlsRXhwQ2FjaGUgPSB7fTsKCmxvY2FsLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCwgZmlyc3QpewoKCXZhciBmb3VuZCA9IHRoaXMuZm91bmQgPSAoZmlyc3QpID8gbnVsbCA6IChhcHBlbmQgfHwgW10pOwoJCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsKCWVsc2UgaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7CgoJLy8gc2V0dXAKCgl2YXIgcGFyc2VkLCBpLAoJCXVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fSwKCQloYXNPdGhlcnMgPSAhIShhcHBlbmQgJiYgYXBwZW5kLmxlbmd0aCksCgkJY29udGV4dElzRG9jdW1lbnQgPSAoY29udGV4dC5ub2RlVHlwZSA9PSA5KTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHRJc0RvY3VtZW50ID8gY29udGV4dCA6IGNvbnRleHQub3duZXJEb2N1bWVudCkpIHRoaXMuc2V0RG9jdW1lbnQoY29udGV4dCk7CgoJLy8gYXZvaWQgZHVwbGljYXRpbmcgaXRlbXMgYWxyZWFkeSBpbiB0aGUgYXBwZW5kIGFycmF5CglpZiAoaGFzT3RoZXJzKSBmb3IgKGkgPSBmb3VuZC5sZW5ndGg7IGktLTspIHVuaXF1ZXNbdGhpcy5nZXRVSUQoZm91bmRbaV0pXSA9IHRydWU7CgoJLy8gZXhwcmVzc2lvbiBjaGVja3MKCglpZiAodHlwZW9mIGV4cHJlc3Npb24gPT0gJ3N0cmluZycpeyAvLyBleHByZXNzaW9uIGlzIGEgc3RyaW5nCgoJCS8qPHNpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCQl2YXIgc2ltcGxlU2VsZWN0b3IgPSBleHByZXNzaW9uLm1hdGNoKHJlU2ltcGxlU2VsZWN0b3IpOwoJCXNpbXBsZVNlbGVjdG9yczogaWYgKHNpbXBsZVNlbGVjdG9yKSB7CgoJCQl2YXIgc3ltYm9sID0gc2ltcGxlU2VsZWN0b3JbMV0sCgkJCQluYW1lID0gc2ltcGxlU2VsZWN0b3JbMl0sCgkJCQlub2RlLCBub2RlczsKCgkJCWlmICghc3ltYm9sKXsKCgkJCQlpZiAobmFtZSA9PSAnKicgJiYgdGhpcy5icm9rZW5TdGFyR0VCVE4pIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnIycpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAhY29udGV4dElzRG9jdW1lbnQpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGUgPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG5hbWUpOwoJCQkJaWYgKCFub2RlKSByZXR1cm4gZm91bmQ7CgkJCQlpZiAodGhpcy5pZEdldHNOYW1lICYmIG5vZGUuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gbmFtZSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZSB8fCBudWxsOwoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcuJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICgoIWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCB0aGlzLmJyb2tlbkdFQkNOKSAmJiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lKTsKCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAobmFtZSkgKycoXFxzfCQpJyk7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CgkJCQkJCWlmICghKGNsYXNzTmFtZSAmJiBtYXRjaENsYXNzLnRlc3QoY2xhc3NOYW1lKSkpIGNvbnRpbnVlOwoJCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlOwoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiAoZmlyc3QpID8gbnVsbCA6IGZvdW5kOwoKCQl9CgkJLyo8L3NpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCgkJLyo8cXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCQlxdWVyeVNlbGVjdG9yOiBpZiAoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSB7CgoJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQKCQkJCXx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXQoJCQkJLy9UT0RPOiBvbmx5IHNraXAgd2hlbiBleHByZXNzaW9uIGlzIGFjdHVhbGx5IG1peGVkIGNhc2UKCQkJCXx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBCgkJCQl8fCAodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKQoJCQkJfHwgKHRoaXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgJiYgcmVFbXB0eUF0dHJpYnV0ZS50ZXN0KGV4cHJlc3Npb24pKQoJCQkJfHwgKCFjb250ZXh0SXNEb2N1bWVudCAvL0Fib3J0IHdoZW4gIWNvbnRleHRJc0RvY3VtZW50IGFuZC4uLgoJCQkJCS8vICB0aGVyZSBhcmUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgaW4gdGhlIHNlbGVjdG9yCgkJCQkJLy8gIHNpbmNlIHdlIGN1cnJlbnRseSBvbmx5IGZpeCBub24tZG9jdW1lbnQgcm9vdGVkIFFTQSBmb3Igc2luZ2xlIGV4cHJlc3Npb24gc2VsZWN0b3JzCgkJCQkJJiYgZXhwcmVzc2lvbi5pbmRleE9mKCcsJykgPiAtMQoJCQkJKQoJCQkJfHwgU2xpY2suZGlzYWJsZVFTQQoJCQkpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uLCBfY29udGV4dCA9IGNvbnRleHQ7CgkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJLy8gbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EKCQkJCS8vIGNyZWRpdHMgdG8gQW5kcmV3IER1cG9udAoJCQkJdmFyIGN1cnJlbnRJZCA9IF9jb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIHNsaWNraWQpOwoJCQkJX2V4cHJlc3Npb24gPSAnIycgKyBzbGlja2lkICsgJyAnICsgX2V4cHJlc3Npb247CgkJCQljb250ZXh0ID0gX2NvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIGN1cnJlbnRJZCk7CgkJCQkJZWxzZSBfY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCQkJY29udGV4dCA9IF9jb250ZXh0OwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgkKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHJldmVyc2VkRXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCBub2RlLmNsYXNzTmFtZTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMucm9vdCwgbm9kZSkpIHJldHVybjsKCQkJCQllbHNlIGJyZWFrIGdldEJ5SWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuZG9jdW1lbnQgIT09IG5vZGUgJiYgIXRoaXMuY29udGFpbnMobm9kZSwgaXRlbSkpIHJldHVybjsKCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJCWdldEJ5Q2xhc3M6IGlmIChjbGFzc2VzICYmIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc0xpc3Quam9pbignICcpKTsKCQkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5Q2xhc3M7CgkJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBudWxsLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQlnZXRCeVRhZzogewoJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlUYWc7CgkJCWlmICghdGhpcy5icm9rZW5TdGFyR0VCVE4pIHRhZyA9IG51bGw7CgkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJz4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IGNoaWxkcmVuCgkJaWYgKChub2RlID0gbm9kZS5maXJzdENoaWxkKSkgZG8gewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSdeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGZpcnN0IGNoaWxkCgkJbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSd+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBhbGwgcGFyZW50IG5vZGVzIHVwIHRvIGRvY3VtZW50CgkJd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSkgaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyE+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBwYXJlbnQgKG9uZSBsZXZlbCkKCQlub2RlID0gbm9kZS5wYXJlbnROb2RlOwoJCWlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSchXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBsYXN0IGNoaWxkCgkJbm9kZSA9IG5vZGUubGFzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0KCn07Cgpmb3IgKHZhciBjIGluIGNvbWJpbmF0b3JzKSBsb2NhbFsnY29tYmluYXRvcjonICsgY10gPSBjb21iaW5hdG9yc1tjXTsKCnZhciBwc2V1ZG9zID0gewoKCS8qPHBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZW1wdHknOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgY2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJcmV0dXJuICEoY2hpbGQgJiYgY2hpbGQubm9kZVR5cGUgPT0gMSkgJiYgIShub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5sZW5ndGg7Cgl9LAoKCSdub3QnOiBmdW5jdGlvbihub2RlLCBleHByZXNzaW9uKXsKCQlyZXR1cm4gIXRoaXMubWF0Y2hOb2RlKG5vZGUsIGV4cHJlc3Npb24pOwoJfSwKCgknY29udGFpbnMnOiBmdW5jdGlvbihub2RlLCB0ZXh0KXsKCQlyZXR1cm4gKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmluZGV4T2YodGV4dCkgPiAtMTsKCX0sCgoJJ2ZpcnN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ250aC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEgnKSwKCgknbnRoLWxhc3QtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRITGFzdCcpLAoKCSdudGgtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEhUeXBlJywgdHJ1ZSksCgoJJ250aC1sYXN0LW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRIVHlwZUxhc3QnLCB0cnVlKSwKCgknaW5kZXgnOiBmdW5jdGlvbihub2RlLCBpbmRleCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnJyArIGluZGV4ICsgMSk7Cgl9LAoKCSdldmVuJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuKzEnKTsKCX0sCgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLyo8b2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2ZpcnN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjwvb2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY3VzdG9tIHBzZXVkb3MKCgknZW5hYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2Rpc2FibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgkKCSd0YWJpbmRleCc6IGZ1bmN0aW9uKCl7CgkJdmFyIGF0dHJpYnV0ZU5vZGUgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ3RhYmluZGV4Jyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0sCgoJJ3R5cGUnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScpOwoJfQoKfTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjUnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJcmV0dXJuIGxvY2FsLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKfTsKCi8vIFNsaWNrIG1hdGNoZXIKClNsaWNrLm1hdGNoID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKCEobm9kZSAmJiBzZWxlY3RvcikpIHJldHVybiBmYWxzZTsKCWlmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IG5vZGUpIHJldHVybiB0cnVlOwoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwubWF0Y2hOb2RlKG5vZGUsIHNlbGVjdG9yKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXSA9IGZuOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lKXsKCXJldHVybiBsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwp9OwoKLy8gU2xpY2sgcHNldWRvIGFjY2Vzc29yCgpTbGljay5kZWZpbmVQc2V1ZG8gPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbFsncHNldWRvOicgKyBuYW1lXSA9IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gZm4uY2FsbChub2RlLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBQc2V1ZG8gPSBmdW5jdGlvbihuYW1lKXsKCXZhciBwc2V1ZG8gPSBsb2NhbFsncHNldWRvOicgKyBuYW1lXTsKCWlmIChwc2V1ZG8pIHJldHVybiBmdW5jdGlvbihhcmd1bWVudCl7CgkJcmV0dXJuIHBzZXVkby5jYWxsKHRoaXMsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gbnVsbDsKfTsKCi8vIFNsaWNrIG92ZXJyaWRlcyBhY2Nlc3NvcgoKU2xpY2sub3ZlcnJpZGUgPSBmdW5jdGlvbihyZWdleHAsIGZuKXsKCWxvY2FsLm92ZXJyaWRlKHJlZ2V4cCwgZm4pOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5pc1hNTCA9IGxvY2FsLmlzWE1MOwoKU2xpY2sudWlkT2YgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBsb2NhbC5nZXRVSURIVE1MKG5vZGUpOwp9OwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50CgpkZXNjcmlwdGlvbjogT25lIG9mIHRoZSBtb3N0IGltcG9ydGFudCBpdGVtcyBpbiBNb29Ub29scy4gQ29udGFpbnMgdGhlIGRvbGxhciBmdW5jdGlvbiwgdGhlIGRvbGxhcnMgZnVuY3Rpb24sIGFuZCBhbiBoYW5kZnVsIG9mIGNyb3NzLWJyb3dzZXIsIHRpbWUtc2F2ZXIgbWV0aG9kcyB0byBsZXQgeW91IGVhc2lseSB3b3JrIHdpdGggSFRNTCBFbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIEVsZW1lbnQgPSBmdW5jdGlvbih0YWcsIHByb3BzKXsKCXZhciBrb25zdHJ1Y3RvciA9IEVsZW1lbnQuQ29uc3RydWN0b3JzW3RhZ107CglpZiAoa29uc3RydWN0b3IpIHJldHVybiBrb25zdHJ1Y3Rvcihwcm9wcyk7CglpZiAodHlwZW9mIHRhZyAhPSAnc3RyaW5nJykgcmV0dXJuIGRvY3VtZW50LmlkKHRhZykuc2V0KHByb3BzKTsKCglpZiAoIXByb3BzKSBwcm9wcyA9IHt9OwoKCWlmICghKC9eW1x3LV0rJC8pLnRlc3QodGFnKSl7CgkJdmFyIHBhcnNlZCA9IFNsaWNrLnBhcnNlKHRhZykuZXhwcmVzc2lvbnNbMF1bMF07CgkJdGFnID0gKHBhcnNlZC50YWcgPT0gJyonKSA/ICdkaXYnIDogcGFyc2VkLnRhZzsKCQlpZiAocGFyc2VkLmlkICYmIHByb3BzLmlkID09IG51bGwpIHByb3BzLmlkID0gcGFyc2VkLmlkOwoKCQl2YXIgYXR0cmlidXRlcyA9IHBhcnNlZC5hdHRyaWJ1dGVzOwoJCWlmIChhdHRyaWJ1dGVzKSBmb3IgKHZhciBpID0gMCwgbCA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYgKEJyb3dzZXIuRWxlbWVudCkgRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IG5ldyBIYXNoOwoKLy88LzEuMmNvbXBhdD4KCnZhciBJRnJhbWUgPSBuZXcgVHlwZSgnSUZyYW1lJywgZnVuY3Rpb24oKXsKCXZhciBwYXJhbXMgPSBBcnJheS5saW5rKGFyZ3VtZW50cywgewoJCXByb3BlcnRpZXM6IFR5cGUuaXNPYmplY3QsCgkJaWZyYW1lOiBmdW5jdGlvbihvYmopewoJCQlyZXR1cm4gKG9iaiAhPSBudWxsKTsKCQl9Cgl9KTsKCgl2YXIgcHJvcHMgPSBwYXJhbXMucHJvcGVydGllcyB8fCB7fSwgaWZyYW1lOwoJaWYgKHBhcmFtcy5pZnJhbWUpIGlmcmFtZSA9IGRvY3VtZW50LmlkKHBhcmFtcy5pZnJhbWUpOwoJdmFyIG9ubG9hZCA9IHByb3BzLm9ubG9hZCB8fCBmdW5jdGlvbigpe307CglkZWxldGUgcHJvcHMub25sb2FkOwoJcHJvcHMuaWQgPSBwcm9wcy5uYW1lID0gW3Byb3BzLmlkLCBwcm9wcy5uYW1lLCBpZnJhbWUgPyAoaWZyYW1lLmlkIHx8IGlmcmFtZS5uYW1lKSA6ICdJRnJhbWVfJyArIFN0cmluZy51bmlxdWVJRCgpXS5waWNrKCk7CglpZnJhbWUgPSBuZXcgRWxlbWVudChpZnJhbWUgfHwgJ2lmcmFtZScsIHByb3BzKTsKCgl2YXIgb25Mb2FkID0gZnVuY3Rpb24oKXsKCQlvbmxvYWQuY2FsbChpZnJhbWUuY29udGVudFdpbmRvdyk7Cgl9OwoKCWlmICh3aW5kb3cuZnJhbWVzW3Byb3BzLmlkXSkgb25Mb2FkKCk7CgllbHNlIGlmcmFtZS5hZGRMaXN0ZW5lcignbG9hZCcsIG9uTG9hZCk7CglyZXR1cm4gaWZyYW1lOwp9KTsKCnZhciBFbGVtZW50cyA9IHRoaXMuRWxlbWVudHMgPSBmdW5jdGlvbihub2Rlcyl7CglpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoKXsKCQl2YXIgdW5pcXVlcyA9IHt9LCBub2RlOwoJCWZvciAodmFyIGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQl2YXIgdWlkID0gU2xpY2sudWlkT2Yobm9kZSk7CgkJCWlmICghdW5pcXVlc1t1aWRdKXsKCQkJCXVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCQl0aGlzLnB1c2gobm9kZSk7CgkJCX0KCQl9Cgl9Cn07CgpFbGVtZW50cy5wcm90b3R5cGUgPSB7bGVuZ3RoOiAwfTsKRWxlbWVudHMucGFyZW50ID0gQXJyYXk7CgpuZXcgVHlwZSgnRWxlbWVudHMnLCBFbGVtZW50cykuaW1wbGVtZW50KHsKCglmaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlciwgYmluZCl7CgkJaWYgKCFmaWx0ZXIpIHJldHVybiB0aGlzOwoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZmlsdGVyKHRoaXMsICh0eXBlT2YoZmlsdGVyKSA9PSAnc3RyaW5nJykgPyBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0ubWF0Y2goZmlsdGVyKTsKCQl9IDogZmlsdGVyLCBiaW5kKSk7Cgl9LnByb3RlY3QoKSwKCglwdXNoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSB0aGlzW2xlbmd0aCsrXSA9IGl0ZW07CgkJfQoJCXJldHVybiAodGhpcy5sZW5ndGggPSBsZW5ndGgpOwoJfS5wcm90ZWN0KCksCgoJdW5zaGlmdDogZnVuY3Rpb24oKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSBpdGVtcy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gQXJyYXkucHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgaXRlbXMpOwoJfS5wcm90ZWN0KCksCgoJY29uY2F0OiBmdW5jdGlvbigpewoJCXZhciBuZXdFbGVtZW50cyA9IG5ldyBFbGVtZW50cyh0aGlzKTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGFyZ3VtZW50c1tpXTsKCQkJaWYgKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pKSBuZXdFbGVtZW50cy5hcHBlbmQoaXRlbSk7CgkJCWVsc2UgbmV3RWxlbWVudHMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIG5ld0VsZW1lbnRzOwoJfS5wcm90ZWN0KCksCgoJYXBwZW5kOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGNvbGxlY3Rpb24ubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLnB1c2goY29sbGVjdGlvbltpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl3aGlsZSAodGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzWy0tdGhpcy5sZW5ndGhdOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCkKCn0pOwoKLy88MS4yY29tcGF0PgoKRWxlbWVudHMuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCi8vPC8xLjJjb21wYXQ+CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQlPYmplY3QuYXBwZW5kKGVsLCBFbGVtZW50LlByb3RvdHlwZSk7CgkJCQl9CgkJCQlyZXR1cm4gZWw7CgkJCX0sCgoJCQlvYmplY3Q6IGZ1bmN0aW9uKG9iaiwgbm9jYXNoLCBkb2MpewoJCQkJaWYgKG9iai50b0VsZW1lbnQpIHJldHVybiB0eXBlcy5lbGVtZW50KG9iai50b0VsZW1lbnQoZG9jKSwgbm9jYXNoKTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCX07CgoJCXR5cGVzLnRleHRub2RlID0gdHlwZXMud2hpdGVzcGFjZSA9IHR5cGVzLndpbmRvdyA9IHR5cGVzLmRvY3VtZW50ID0gZnVuY3Rpb24oemVybyl7CgkJCXJldHVybiB6ZXJvOwoJCX07CgoJCXJldHVybiBmdW5jdGlvbihlbCwgbm9jYXNoLCBkb2MpewoJCQlpZiAoZWwgJiYgZWwuJGZhbWlseSAmJiBlbC51aWQpIHJldHVybiBlbDsKCQkJdmFyIHR5cGUgPSB0eXBlT2YoZWwpOwoJCQlyZXR1cm4gKHR5cGVzW3R5cGVdKSA/IHR5cGVzW3R5cGVdKGVsLCBub2Nhc2gsIGRvYyB8fCBkb2N1bWVudCkgOiBudWxsOwoJCX07CgoJfSkoKQoKfSk7CgppZiAod2luZG93LiQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCcsIGZ1bmN0aW9uKGVsLCBuYyl7CglyZXR1cm4gZG9jdW1lbnQuaWQoZWwsIG5jLCB0aGlzLmRvY3VtZW50KTsKfSk7CgpXaW5kb3cuaW1wbGVtZW50KHsKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5kb2N1bWVudDsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpbRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMsIGV4cHJlc3Npb24sIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldEVsZW1lbnQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGV4cHJlc3Npb24pKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKKGZ1bmN0aW9uKHNlYXJjaCwgZmluZCwgbWF0Y2gpewoKCXRoaXMuU2VsZWN0b3JzID0ge307Cgl2YXIgcHNldWRvcyA9IHRoaXMuU2VsZWN0b3JzLlBzZXVkbyA9IG5ldyBIYXNoKCk7CgoJdmFyIGFkZFNsaWNrUHNldWRvcyA9IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgbmFtZSBpbiBwc2V1ZG9zKSBpZiAocHNldWRvcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSl7CgkJCVNsaWNrLmRlZmluZVBzZXVkbyhuYW1lLCBwc2V1ZG9zW25hbWVdKTsKCQkJZGVsZXRlIHBzZXVkb3NbbmFtZV07CgkJfQoJfTsKCglTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJCWFkZFNsaWNrUHNldWRvcygpOwoJCXJldHVybiBzZWFyY2guY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwoJfTsKCglTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIGZpbmQuY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uKTsKCX07CgoJU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIG1hdGNoLmNhbGwodGhpcywgbm9kZSwgc2VsZWN0b3IpOwoJfTsKCn0pKFNsaWNrLnNlYXJjaCwgU2xpY2suZmluZCwgU2xpY2subWF0Y2gpOwoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCXZhciBlbGVtZW50cyA9IG5ldyBFbGVtZW50czsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnKSByZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHNlbGVjdG9yLCBlbGVtZW50cyk7Cgl2YXIgYXJncyA9IEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKTsKCWZvciAodmFyIGkgPSAwLCBsID0gYXJncy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBpdGVtID0gYXJnc1tpXTsKCQlzd2l0Y2ggKHR5cGVPZihpdGVtKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBlbGVtZW50cy5wdXNoKGl0ZW0pOyBicmVhazsKCQkJY2FzZSAnc3RyaW5nJzogU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIGl0ZW0sIGVsZW1lbnRzKTsKCQl9Cgl9CglyZXR1cm4gZWxlbWVudHM7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCmlmICh3aW5kb3cuJCQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCQnLCBmdW5jdGlvbihzZWxlY3Rvcil7CglpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQlpZiAodHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnKSByZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHNlbGVjdG9yLCBuZXcgRWxlbWVudHMpOwoJCWVsc2UgaWYgKFR5cGUuaXNFbnVtZXJhYmxlKHNlbGVjdG9yKSkgcmV0dXJuIG5ldyBFbGVtZW50cyhzZWxlY3Rvcik7Cgl9CglyZXR1cm4gbmV3IEVsZW1lbnRzKGFyZ3VtZW50cyk7Cn0pOwoKKGZ1bmN0aW9uKCl7Cgp2YXIgY29sbGVjdGVkID0ge30sIHN0b3JhZ2UgPSB7fTsKdmFyIGZvcm1Qcm9wcyA9IHtpbnB1dDogJ2NoZWNrZWQnLCBvcHRpb246ICdzZWxlY3RlZCcsIHRleHRhcmVhOiAndmFsdWUnfTsKCnZhciBnZXQgPSBmdW5jdGlvbih1aWQpewoJcmV0dXJuIChzdG9yYWdlW3VpZF0gfHwgKHN0b3JhZ2VbdWlkXSA9IHt9KSk7Cn07Cgp2YXIgY2xlYW4gPSBmdW5jdGlvbihpdGVtKXsKCXZhciB1aWQgPSBpdGVtLnVpZDsKCWlmIChpdGVtLnJlbW92ZUV2ZW50cykgaXRlbS5yZW1vdmVFdmVudHMoKTsKCWlmIChpdGVtLmNsZWFyQXR0cmlidXRlcykgaXRlbS5jbGVhckF0dHJpYnV0ZXMoKTsKCWlmICh1aWQgIT0gbnVsbCl7CgkJZGVsZXRlIGNvbGxlY3RlZFt1aWRdOwoJCWRlbGV0ZSBzdG9yYWdlW3VpZF07Cgl9CglyZXR1cm4gaXRlbTsKfTsKCnZhciBjYW1lbHMgPSBbJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsICdmcmFtZUJvcmRlcicsICdtYXhMZW5ndGgnLCAncmVhZE9ubHknLAoJJ3Jvd1NwYW4nLCAndGFiSW5kZXgnLCAndXNlTWFwJwpdOwp2YXIgYm9vbHMgPSBbJ2NvbXBhY3QnLCAnbm93cmFwJywgJ2lzbWFwJywgJ2RlY2xhcmUnLCAnbm9zaGFkZScsICdjaGVja2VkJywgJ2Rpc2FibGVkJywgJ3JlYWRPbmx5JywgJ211bHRpcGxlJywgJ3NlbGVjdGVkJywKCSdub3Jlc2l6ZScsICdkZWZlcicsICdkZWZhdWx0Q2hlY2tlZCcKXTsKIHZhciBhdHRyaWJ1dGVzID0gewoJJ2h0bWwnOiAnaW5uZXJIVE1MJywKCSdjbGFzcyc6ICdjbGFzc05hbWUnLAoJJ2Zvcic6ICdodG1sRm9yJywKCSd0ZXh0JzogKGZ1bmN0aW9uKCl7CgkJdmFyIHRlbXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQlyZXR1cm4gKHRlbXAudGV4dENvbnRlbnQgPT0gbnVsbCkgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCc7Cgl9KSgpCn07CnZhciByZWFkT25seSA9IFsndHlwZSddOwp2YXIgZXhwYW5kb3MgPSBbJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZSddOwp2YXIgdXJpQXR0cnMgPSAvXig/OmhyZWZ8c3JjfHVzZW1hcCkkL2k7Cgpib29scyA9IGJvb2xzLmFzc29jaWF0ZShib29scyk7CmNhbWVscyA9IGNhbWVscy5hc3NvY2lhdGUoY2FtZWxzLm1hcChTdHJpbmcudG9Mb3dlckNhc2UpKTsKcmVhZE9ubHkgPSByZWFkT25seS5hc3NvY2lhdGUocmVhZE9ubHkpOwoKT2JqZWN0LmFwcGVuZChhdHRyaWJ1dGVzLCBleHBhbmRvcy5hc3NvY2lhdGUoZXhwYW5kb3MpKTsKCnZhciBpbnNlcnRlcnMgPSB7CgoJYmVmb3JlOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCWlmIChwYXJlbnQpIHBhcmVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudCk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCWlmIChwYXJlbnQpIHBhcmVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudC5uZXh0U2libGluZyk7Cgl9LAoKCWJvdHRvbTogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJZWxlbWVudC5hcHBlbmRDaGlsZChjb250ZXh0KTsKCX0sCgoJdG9wOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50LmZpcnN0Q2hpbGQpOwoJfQoKfTsKCmluc2VydGVycy5pbnNpZGUgPSBpbnNlcnRlcnMuYm90dG9tOwoKLy88MS4yY29tcGF0PgoKT2JqZWN0LmVhY2goaW5zZXJ0ZXJzLCBmdW5jdGlvbihpbnNlcnRlciwgd2hlcmUpewoKCXdoZXJlID0gd2hlcmUuY2FwaXRhbGl6ZSgpOwoKCXZhciBtZXRob2RzID0ge307CgoJbWV0aG9kc1snaW5qZWN0JyArIHdoZXJlXSA9IGZ1bmN0aW9uKGVsKXsKCQlpbnNlcnRlcih0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfTsKCgltZXRob2RzWydncmFiJyArIHdoZXJlXSA9IGZ1bmN0aW9uKGVsKXsKCQlpbnNlcnRlcihkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfTsKCglFbGVtZW50LmltcGxlbWVudChtZXRob2RzKTsKCn0pOwoKLy88LzEuMmNvbXBhdD4KCnZhciBpbmplY3RDb21iaW5hdG9yID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgY29tYmluYXRvcil7CglpZiAoIWV4cHJlc3Npb24pIHJldHVybiBjb21iaW5hdG9yOwoKCWV4cHJlc3Npb24gPSBPYmplY3QuY2xvbmUoU2xpY2sucGFyc2UoZXhwcmVzc2lvbikpOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgltYXRjaDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuICFleHByZXNzaW9uIHx8IFNsaWNrLm1hdGNoKHRoaXMsIGV4cHJlc3Npb24pOwoJfQoKfSk7Cgp2YXIgY2xlYW5DbG9uZSA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQsIGtlZXBpZCl7CglpZiAoIWtlZXBpZCkgbm9kZS5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSgnaWQnKSk7CglpZiAobm9kZS5jbGVhckF0dHJpYnV0ZXMpewoJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ3VpZCcpOwoJCWlmIChub2RlLm9wdGlvbnMpewoJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQlmb3IgKHZhciBpID0gbm8ubGVuZ3RoOyBpLS07KSBub1tpXS5zZWxlY3RlZCA9IGVvW2ldLnNlbGVjdGVkOwoJCX0KCX0KCgl2YXIgcHJvcCA9IGZvcm1Qcm9wc1tlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKV07CglpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKGNvbnRlbnRzLCBrZWVwaWQpewoJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7Cgl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGk7CgoJaWYgKGNvbnRlbnRzKXsKCQl2YXIgY2UgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLCB0ZSA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspIGNsZWFuQ2xvbmUoY2VbaV0sIHRlW2ldLCBrZWVwaWQpOwoJfQoKCWNsZWFuQ2xvbmUoY2xvbmUsIHRoaXMsIGtlZXBpZCk7CgoJaWYgKEJyb3dzZXIuaWUpewoJCXZhciBjbyA9IGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKSwgdG8gPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKTsKCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCX0KCXJldHVybiBkb2N1bWVudC5pZChjbG9uZSk7Cn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkWyR1aWQodGhpcyldID0gdGhpczsKCQl9CgkJaWYgKHRoaXMuYWRkRXZlbnRMaXN0ZW5lcikgdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJldHJpZXZlOiBmdW5jdGlvbihwcm9wZXJ0eSwgZGZsdCl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoJHVpZCh0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpOwoJCWRlbGV0ZSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyo8bHRJRTk+Ki8KaWYgKHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHdpbmRvdy5hZGRMaXN0ZW5lcigndW5sb2FkJywgZnVuY3Rpb24oKXsKCU9iamVjdC5lYWNoKGNvbGxlY3RlZCwgY2xlYW4pOwoJaWYgKHdpbmRvdy5Db2xsZWN0R2FyYmFnZSkgQ29sbGVjdEdhcmJhZ2UoKTsKfSk7Ci8qPC9sdElFOT4qLwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCi8qPGx0SUU5PiovCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwovKjwvbHRJRTk+Ki8KCi8qPCF3ZWJraXQ+Ki8KRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwovKjwvIXdlYmtpdD4qLwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKTsKdmFyIHJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldE9wYWNpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCWlmIChoYXNPcGFjaXR5KXsKCQllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwoJfSBlbHNlIHsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgKiAxMDApLmxpbWl0KDAsIDEwMCkucm91bmQoKTsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgPT0gMTAwKSA/ICcnIDogJ2FscGhhKG9wYWNpdHk9JyArIG9wYWNpdHkgKyAnKSc7CgkJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgkJZWxlbWVudC5zdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCX0KfTsKCkVsZW1lbnQuUHJvcGVydGllcy5vcGFjaXR5ID0gewoKCXNldDogZnVuY3Rpb24ob3BhY2l0eSl7CgkJdmFyIHZpc2liaWxpdHkgPSB0aGlzLnN0eWxlLnZpc2liaWxpdHk7CgkJaWYgKG9wYWNpdHkgPT0gMCAmJiB2aXNpYmlsaXR5ICE9ICdoaWRkZW4nKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQllbHNlIGlmIChvcGFjaXR5ICE9IDAgJiYgdmlzaWJpbGl0eSAhPSAndmlzaWJsZScpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJc2V0T3BhY2l0eSh0aGlzLCBvcGFjaXR5KTsKCX0sCgoJZ2V0OiAoaGFzT3BhY2l0eSkgPyBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5ID0gdGhpcy5zdHlsZS5vcGFjaXR5IHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnb3BhY2l0eScpOwoJCXJldHVybiAob3BhY2l0eSA9PSAnJykgPyAxIDogb3BhY2l0eTsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5LCBmaWx0ZXIgPSAodGhpcy5zdHlsZS5maWx0ZXIgfHwgdGhpcy5nZXRDb21wdXRlZFN0eWxlKCdmaWx0ZXInKSk7CgkJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gbnVsbCB8fCBmaWx0ZXIgPT0gbnVsbCkgPyAxIDogKG9wYWNpdHlbMV0gLyAxMDApOwoJfQoKfTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCX0sCgoJc2V0U3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5zZXQoJ29wYWNpdHknLCBwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCQkJY2FzZSAnZmxvYXQnOiBwcm9wZXJ0eSA9IGZsb2F0TmFtZTsKCQl9CgkJcHJvcGVydHkgPSBwcm9wZXJ0eS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5TdHlsZXMgPSBuZXcgSGFzaChFbGVtZW50LlN0eWxlcyk7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyBFbGVtZW50IG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCBldmVudHMuIFRoaXMgZmlsZSBhbHNvIGluY2x1ZGVzIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgY3VzdG9tIEVsZW1lbnQgRXZlbnRzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbik7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50KSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlyZWFsVHlwZSA9IGN1c3RvbS5iYXNlIHx8IHJlYWxUeXBlOwoJCX0KCQl2YXIgZGVmbiA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmbi5jYWxsKHNlbGYpOwoJCX07CgkJdmFyIG5hdGl2ZUV2ZW50ID0gRWxlbWVudC5OYXRpdmVFdmVudHNbcmVhbFR5cGVdOwoJCWlmIChuYXRpdmVFdmVudCl7CgkJCWlmIChuYXRpdmVFdmVudCA9PSAyKXsKCQkJCWRlZm4gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQsIHNlbGYuZ2V0V2luZG93KCkpOwoJCQkJCWlmIChjb25kaXRpb24uY2FsbChzZWxmLCBldmVudCkgPT09IGZhbHNlKSBldmVudC5zdG9wKCk7CgkJCQl9OwoJCQl9CgkJCXRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGRlZm4sIGFyZ3VtZW50c1syXSk7CgkJfQoJCWV2ZW50c1t0eXBlXS52YWx1ZXMucHVzaChkZWZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFldmVudHMgfHwgIWV2ZW50c1t0eXBlXSkgcmV0dXJuIHRoaXM7CgkJdmFyIGxpc3QgPSBldmVudHNbdHlwZV07CgkJdmFyIGluZGV4ID0gbGlzdC5rZXlzLmluZGV4T2YoZm4pOwoJCWlmIChpbmRleCA9PSAtMSkgcmV0dXJuIHRoaXM7CgkJdmFyIHZhbHVlID0gbGlzdC52YWx1ZXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LmtleXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LnZhbHVlc1tpbmRleF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uUmVtb3ZlKSBjdXN0b20ub25SZW1vdmUuY2FsbCh0aGlzLCBmbik7CgkJCXR5cGUgPSBjdXN0b20uYmFzZSB8fCB0eXBlOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRpbWVuc2lvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBtZXRob2RzIHRvIHdvcmsgd2l0aCBzaXplLCBzY3JvbGwsIG9yIHBvc2l0aW9uaW5nIG9mIEVsZW1lbnRzIGFuZCB0aGUgd2luZG93IG9iamVjdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVsZW1lbnQgcG9zaXRpb25pbmcgYmFzZWQgb24gdGhlIFtxb294ZG9vXShodHRwOi8vcW9veGRvby5vcmcvKSBjb2RlIGFuZCBzbWFydCBicm93c2VyIGZpeGVzLCBbTEdQTCBMaWNlbnNlXShodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sKS4KICAtIFZpZXdwb3J0IGRpbWVuc2lvbnMgYmFzZWQgb24gW1lVSV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpLykgY29kZSwgW0JTRCBMaWNlbnNlXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvbGljZW5zZS5odG1sKS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBbRWxlbWVudC5EaW1lbnNpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgljaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwplbGVtZW50LnN0eWxlLmhlaWdodCA9ICcwJzsKZWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCk7CnZhciBicm9rZW5PZmZzZXRQYXJlbnQgPSAoY2hpbGQub2Zmc2V0UGFyZW50ID09PSBlbGVtZW50KTsKZWxlbWVudCA9IGNoaWxkID0gbnVsbDsKCnZhciBpc09mZnNldCA9IGZ1bmN0aW9uKGVsKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbCwgJ3Bvc2l0aW9uJykgIT0gJ3N0YXRpYycgfHwgaXNCb2R5KGVsKTsKfTsKCnZhciBpc09mZnNldFN0YXRpYyA9IGZ1bmN0aW9uKGVsKXsKCXJldHVybiBpc09mZnNldChlbCkgfHwgKC9eKD86dGFibGV8dGR8dGgpJC9pKS50ZXN0KGVsLnRhZ05hbWUpOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNjcm9sbFRvOiBmdW5jdGlvbih4LCB5KXsKCQlpZiAoaXNCb2R5KHRoaXMpKXsKCQkJdGhpcy5nZXRXaW5kb3coKS5zY3JvbGxUbyh4LCB5KTsKCQl9IGVsc2UgewoJCQl0aGlzLnNjcm9sbExlZnQgPSB4OwoJCQl0aGlzLnNjcm9sbFRvcCA9IHk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMub2Zmc2V0V2lkdGgsIHk6IHRoaXMub2Zmc2V0SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsU2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTY3JvbGxTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbFdpZHRoLCB5OiB0aGlzLnNjcm9sbEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbDogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTY3JvbGwoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsTGVmdCwgeTogdGhpcy5zY3JvbGxUb3B9OwoJfSwKCglnZXRTY3JvbGxzOiBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpcy5wYXJlbnROb2RlLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQl3aGlsZSAoZWxlbWVudCAmJiAhaXNCb2R5KGVsZW1lbnQpKXsKCQkJcG9zaXRpb24ueCArPSBlbGVtZW50LnNjcm9sbExlZnQ7CgkJCXBvc2l0aW9uLnkgKz0gZWxlbWVudC5zY3JvbGxUb3A7CgkJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0T2Zmc2V0UGFyZW50OiBicm9rZW5PZmZzZXRQYXJlbnQgPyBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpczsKCQlpZiAoaXNCb2R5KGVsZW1lbnQpIHx8IHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdmaXhlZCcpIHJldHVybiBudWxsOwoKCQl2YXIgaXNPZmZzZXRDaGVjayA9IChzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnc3RhdGljJykgPyBpc09mZnNldFN0YXRpYyA6IGlzT2Zmc2V0OwoJCXdoaWxlICgoZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSkpewoJCQlpZiAoaXNPZmZzZXRDaGVjayhlbGVtZW50KSkgcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCXJldHVybiBudWxsOwoJfSA6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXRyeSB7CgkJCXJldHVybiBlbGVtZW50Lm9mZnNldFBhcmVudDsKCQl9IGNhdGNoKGUpIHt9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWdldE9mZnNldHM6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICYmICFCcm93c2VyLlBsYXRmb3JtLmlvcyl7CgkJCXZhciBib3VuZCA9IHRoaXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCgkJCQlodG1sID0gZG9jdW1lbnQuaWQodGhpcy5nZXREb2N1bWVudCgpLmRvY3VtZW50RWxlbWVudCksCgkJCQlodG1sU2Nyb2xsID0gaHRtbC5nZXRTY3JvbGwoKSwKCQkJCWVsZW1TY3JvbGxzID0gdGhpcy5nZXRTY3JvbGxzKCksCgkJCQlpc0ZpeGVkID0gKHN0eWxlU3RyaW5nKHRoaXMsICdwb3NpdGlvbicpID09ICdmaXhlZCcpOwoKCQkJcmV0dXJuIHsKCQkJCXg6IGJvdW5kLmxlZnQudG9JbnQoKSArIGVsZW1TY3JvbGxzLnggKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueCkgLSBodG1sLmNsaWVudExlZnQsCgkJCQl5OiBib3VuZC50b3AudG9JbnQoKSAgKyBlbGVtU2Nyb2xscy55ICsgKChpc0ZpeGVkKSA/IDAgOiBodG1sU2Nyb2xsLnkpIC0gaHRtbC5jbGllbnRUb3AKCQkJfTsKCQl9CgoJCXZhciBlbGVtZW50ID0gdGhpcywgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHBvc2l0aW9uOwoKCQl3aGlsZSAoZWxlbWVudCAmJiAhaXNCb2R5KGVsZW1lbnQpKXsKCQkJcG9zaXRpb24ueCArPSBlbGVtZW50Lm9mZnNldExlZnQ7CgkJCXBvc2l0aW9uLnkgKz0gZWxlbWVudC5vZmZzZXRUb3A7CgoJCQlpZiAoQnJvd3Nlci5maXJlZm94KXsKCQkJCWlmICghYm9yZGVyQm94KGVsZW1lbnQpKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIoZWxlbWVudCk7CgkJCQl9CgkJCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCQkJaWYgKHBhcmVudCAmJiBzdHlsZVN0cmluZyhwYXJlbnQsICdvdmVyZmxvdycpICE9ICd2aXNpYmxlJyl7CgkJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKHBhcmVudCk7CgkJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIocGFyZW50KTsKCQkJCX0KCQkJfSBlbHNlIGlmIChlbGVtZW50ICE9IHRoaXMgJiYgQnJvd3Nlci5zYWZhcmkpewoJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKGVsZW1lbnQpOwoJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIoZWxlbWVudCk7CgkJCX0KCgkJCWVsZW1lbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudDsKCQl9CgkJaWYgKEJyb3dzZXIuZmlyZWZveCAmJiAhYm9yZGVyQm94KHRoaXMpKXsKCQkJcG9zaXRpb24ueCAtPSBsZWZ0Qm9yZGVyKHRoaXMpOwoJCQlwb3NpdGlvbi55IC09IHRvcEJvcmRlcih0aGlzKTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24ocmVsYXRpdmUpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB7eDogMCwgeTogMH07CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoJCQoJCWlmIChyZWxhdGl2ZSAmJiAocmVsYXRpdmUgPSBkb2N1bWVudC5pZChyZWxhdGl2ZSkpKXsKCQkJdmFyIHJlbGF0aXZlUG9zaXRpb24gPSByZWxhdGl2ZS5nZXRQb3NpdGlvbigpOwoJCQlyZXR1cm4ge3g6IHBvc2l0aW9uLnggLSByZWxhdGl2ZVBvc2l0aW9uLnggLSBsZWZ0Qm9yZGVyKHJlbGF0aXZlKSwgeTogcG9zaXRpb24ueSAtIHJlbGF0aXZlUG9zaXRpb24ueSAtIHRvcEJvcmRlcihyZWxhdGl2ZSl9OwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldENvb3JkaW5hdGVzOiBmdW5jdGlvbihlbGVtZW50KXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRDb29yZGluYXRlcygpOwoJCXZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0UG9zaXRpb24oZWxlbWVudCksCgkJCXNpemUgPSB0aGlzLmdldFNpemUoKTsKCQl2YXIgb2JqID0gewoJCQlsZWZ0OiBwb3NpdGlvbi54LAoJCQl0b3A6IHBvc2l0aW9uLnksCgkJCXdpZHRoOiBzaXplLngsCgkJCWhlaWdodDogc2l6ZS55CgkJfTsKCQlvYmoucmlnaHQgPSBvYmoubGVmdCArIG9iai53aWR0aDsKCQlvYmouYm90dG9tID0gb2JqLnRvcCArIG9iai5oZWlnaHQ7CgkJcmV0dXJuIG9iajsKCX0sCgoJY29tcHV0ZVBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB7CgkJCWxlZnQ6IG9iai54IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi1sZWZ0JyksCgkJCXRvcDogb2JqLnkgLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLXRvcCcpCgkJfTsKCX0sCgoJc2V0UG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHRoaXMuc2V0U3R5bGVzKHRoaXMuY29tcHV0ZVBvc2l0aW9uKG9iaikpOwoJfQoKfSk7CgoKW0RvY3VtZW50LCBXaW5kb3ddLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyk7CgkJcmV0dXJuIHt4OiBkb2MuY2xpZW50V2lkdGgsIHk6IGRvYy5jbGllbnRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJdmFyIHdpbiA9IHRoaXMuZ2V0V2luZG93KCksIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyk7CgkJcmV0dXJuIHt4OiB3aW4ucGFnZVhPZmZzZXQgfHwgZG9jLnNjcm9sbExlZnQsIHk6IHdpbi5wYWdlWU9mZnNldCB8fCBkb2Muc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsU2l6ZTogZnVuY3Rpb24oKXsKCQl2YXIgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKSwKCQkJbWluID0gdGhpcy5nZXRTaXplKCksCgkJCWJvZHkgPSB0aGlzLmdldERvY3VtZW50KCkuYm9keTsKCgkJcmV0dXJuIHt4OiBNYXRoLm1heChkb2Muc2Nyb2xsV2lkdGgsIGJvZHkuc2Nyb2xsV2lkdGgsIG1pbi54KSwgeTogTWF0aC5tYXgoZG9jLnNjcm9sbEhlaWdodCwgYm9keS5zY3JvbGxIZWlnaHQsIG1pbi55KX07Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiB7eDogMCwgeTogMH07Cgl9LAoKCWdldENvb3JkaW5hdGVzOiBmdW5jdGlvbigpewoJCXZhciBzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJcmV0dXJuIHt0b3A6IDAsIGxlZnQ6IDAsIGJvdHRvbTogc2l6ZS55LCByaWdodDogc2l6ZS54LCBoZWlnaHQ6IHNpemUueSwgd2lkdGg6IHNpemUueH07Cgl9Cgp9KTsKCi8vIHByaXZhdGUgbWV0aG9kcwoKdmFyIHN0eWxlU3RyaW5nID0gRWxlbWVudC5nZXRDb21wdXRlZFN0eWxlOwoKZnVuY3Rpb24gc3R5bGVOdW1iZXIoZWxlbWVudCwgc3R5bGUpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsZW1lbnQsIHN0eWxlKS50b0ludCgpIHx8IDA7Cn0KCmZ1bmN0aW9uIGJvcmRlckJveChlbGVtZW50KXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCAnLW1vei1ib3gtc2l6aW5nJykgPT0gJ2JvcmRlci1ib3gnOwp9CgpmdW5jdGlvbiB0b3BCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci10b3Atd2lkdGgnKTsKfQoKZnVuY3Rpb24gbGVmdEJvcmRlcihlbGVtZW50KXsKCXJldHVybiBzdHlsZU51bWJlcihlbGVtZW50LCAnYm9yZGVyLWxlZnQtd2lkdGgnKTsKfQoKZnVuY3Rpb24gaXNCb2R5KGVsZW1lbnQpewoJcmV0dXJuICgvXig/OmJvZHl8aHRtbCkkL2kpLnRlc3QoZWxlbWVudC50YWdOYW1lKTsKfQoKZnVuY3Rpb24gZ2V0Q29tcGF0RWxlbWVudChlbGVtZW50KXsKCXZhciBkb2MgPSBlbGVtZW50LmdldERvY3VtZW50KCk7CglyZXR1cm4gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKfQoKfSkoKTsKCi8vYWxpYXNlcwpFbGVtZW50LmFsaWFzKHtwb3NpdGlvbjogJ3NldFBvc2l0aW9uJ30pOyAvL2NvbXBhdGFiaWxpdHkKCltXaW5kb3csIERvY3VtZW50LCBFbGVtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2l6ZSgpLnk7Cgl9LAoKCWdldFdpZHRoOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS54OwoJfSwKCglnZXRTY3JvbGxUb3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueTsKCX0sCgoJZ2V0U2Nyb2xsTGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS54OwoJfSwKCglnZXRTY3JvbGxIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsU2l6ZSgpLnk7Cgl9LAoKCWdldFNjcm9sbFdpZHRoOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS54OwoJfSwKCglnZXRUb3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0UG9zaXRpb24oKS55OwoJfSwKCglnZXRMZWZ0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueDsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogRngKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgYmFzaWMgYW5pbWF0aW9uIGxvZ2ljIHRvIGJlIGV4dGVuZGVkIGJ5IGFsbCBvdGhlciBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdCgpwcm92aWRlczogRngKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgRnggPSB0aGlzLkZ4ID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10sCgoJb3B0aW9uczogewoJCS8qCgkJb25TdGFydDogbmlsLAoJCW9uQ2FuY2VsOiBuaWwsCgkJb25Db21wbGV0ZTogbmlsLAoJCSovCgkJZnBzOiA2MCwKCQl1bml0OiBmYWxzZSwKCQlkdXJhdGlvbjogNTAwLAoJCWZyYW1lczogbnVsbCwKCQlmcmFtZVNraXA6IHRydWUsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKG5vdyl7CgkJaWYgKHRoaXMub3B0aW9ucy5mcmFtZVNraXApewoJCQl2YXIgZGlmZiA9ICh0aGlzLnRpbWUgIT0gbnVsbCkgPyAobm93IC0gdGhpcy50aW1lKSA6IDAsIGZyYW1lcyA9IGRpZmYgLyB0aGlzLmZyYW1lSW50ZXJ2YWw7CgkJCXRoaXMudGltZSA9IG5vdzsKCQkJdGhpcy5mcmFtZSArPSBmcmFtZXM7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSsrOwoJCX0KCQkKCQlpZiAodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKXsKCQkJdmFyIGRlbHRhID0gdGhpcy50cmFuc2l0aW9uKHRoaXMuZnJhbWUgLyB0aGlzLmZyYW1lcyk7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIGRlbHRhKSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSA9IHRoaXMuZnJhbWVzOwoJCQl0aGlzLnNldCh0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvLCAxKSk7CgkJCXRoaXMuc3RvcCgpOwoJCX0KCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCXJldHVybiBub3c7Cgl9LAoKCWNvbXB1dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CgkJcmV0dXJuIEZ4LmNvbXB1dGUoZnJvbSwgdG8sIGRlbHRhKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLmlzUnVubmluZygpKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2soZnJvbSwgdG8pKSByZXR1cm4gdGhpczsKCQl0aGlzLmZyb20gPSBmcm9tOwoJCXRoaXMudG8gPSB0bzsKCQl0aGlzLmZyYW1lID0gKHRoaXMub3B0aW9ucy5mcmFtZVNraXApID8gMCA6IC0xOwoJCXRoaXMudGltZSA9IG51bGw7CgkJdGhpcy50cmFuc2l0aW9uID0gdGhpcy5nZXRUcmFuc2l0aW9uKCk7CgkJdmFyIGZyYW1lcyA9IHRoaXMub3B0aW9ucy5mcmFtZXMsIGZwcyA9IHRoaXMub3B0aW9ucy5mcHMsIGR1cmF0aW9uID0gdGhpcy5vcHRpb25zLmR1cmF0aW9uOwoJCXRoaXMuZHVyYXRpb24gPSBGeC5EdXJhdGlvbnNbZHVyYXRpb25dIHx8IGR1cmF0aW9uLnRvSW50KCk7CgkJdGhpcy5mcmFtZUludGVydmFsID0gMTAwMCAvIGZwczsKCQl0aGlzLmZyYW1lcyA9IGZyYW1lcyB8fCBNYXRoLnJvdW5kKHRoaXMuZHVyYXRpb24gLyB0aGlzLmZyYW1lSW50ZXJ2YWwpOwoJCXRoaXMuZmlyZUV2ZW50KCdzdGFydCcsIHRoaXMuc3ViamVjdCk7CgkJcHVzaEluc3RhbmNlLmNhbGwodGhpcywgZnBzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgkKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJaWYgKHRoaXMuZnJhbWVzID09IHRoaXMuZnJhbWUpewoJCQkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJCWlmICghdGhpcy5jYWxsQ2hhaW4oKSkgdGhpcy5maXJlRXZlbnQoJ2NoYWluQ29tcGxldGUnLCB0aGlzLnN1YmplY3QpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5maXJlRXZlbnQoJ3N0b3AnLCB0aGlzLnN1YmplY3QpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCQoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgkKCXBhdXNlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVzdW1lOiBmdW5jdGlvbigpewoJCWlmICgodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKSAmJiAhdGhpcy5pc1J1bm5pbmcoKSkgcHVzaEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9LCBzZWxlY3RvclRlc3QgPSBuZXcgUmVnRXhwKCdeJyArIHNlbGVjdG9yLmVzY2FwZVJlZ0V4cCgpICsgJyQnKTsKCQlBcnJheS5lYWNoKGRvY3VtZW50LnN0eWxlU2hlZXRzLCBmdW5jdGlvbihzaGVldCwgail7CgkJCXZhciBocmVmID0gc2hlZXQuaHJlZjsKCQkJaWYgKGhyZWYgJiYgaHJlZi5jb250YWlucygnOi8vJykgJiYgIWhyZWYuY29udGFpbnMoZG9jdW1lbnQuZG9tYWluKSkgcmV0dXJuOwoJCQl2YXIgcnVsZXMgPSBzaGVldC5ydWxlcyB8fCBzaGVldC5jc3NSdWxlczsKCQkJQXJyYXkuZWFjaChydWxlcywgZnVuY3Rpb24ocnVsZSwgaSl7CgkJCQlpZiAoIXJ1bGUuc3R5bGUpIHJldHVybjsKCQkJCXZhciBzZWxlY3RvclRleHQgPSAocnVsZS5zZWxlY3RvclRleHQpID8gcnVsZS5zZWxlY3RvclRleHQucmVwbGFjZSgvXlx3Ky8sIGZ1bmN0aW9uKG0pewoJCQkJCXJldHVybiBtLnRvTG93ZXJDYXNlKCk7CgkJCQl9KSA6IG51bGw7CgkJCQlpZiAoIXNlbGVjdG9yVGV4dCB8fCAhc2VsZWN0b3JUZXN0LnRlc3Qoc2VsZWN0b3JUZXh0KSkgcmV0dXJuOwoJCQkJT2JqZWN0LmVhY2goRWxlbWVudC5TdHlsZXMsIGZ1bmN0aW9uKHZhbHVlLCBzdHlsZSl7CgkJCQkJaWYgKCFydWxlLnN0eWxlW3N0eWxlXSB8fCBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmV0dXJuOwoJCQkJCXZhbHVlID0gU3RyaW5nKHJ1bGUuc3R5bGVbc3R5bGVdKTsKCQkJCQl0b1tzdHlsZV0gPSAoKC9ecmdiLykudGVzdCh2YWx1ZSkpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguQ1NTLlBhcnNlcnMgPSBuZXcgSGFzaChGeC5DU1MuUGFyc2Vycyk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJdmFyIGVhc2VJbiA9IGZ1bmN0aW9uKHBvcyl7CgkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJfTsKCXJldHVybiBPYmplY3QuYXBwZW5kKGVhc2VJbiwgewoJCWVhc2VJbjogZWFzZUluLAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgOiAoMiAtIHRyYW5zaXRpb24oMiAqICgxIC0gcG9zKSwgcGFyYW1zKSkpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguY29zKHAgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBpICsgMik7Cgl9KTsKfSk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJCgkJdGhpcy5yZXNwb25zZSA9IHt0ZXh0OiB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHhtbDogdGhpcy54aHIucmVzcG9uc2VYTUx9OwoJCWlmICh0aGlzLm9wdGlvbnMuaXNTdWNjZXNzLmNhbGwodGhpcywgdGhpcy5zdGF0dXMpKQoJCQl0aGlzLnN1Y2Nlc3ModGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLnJlc3BvbnNlLnhtbCk7CgkJZWxzZQoJCQl0aGlzLmZhaWx1cmUoKTsKCX0sCgoJaXNTdWNjZXNzOiBmdW5jdGlvbigpewoJCXZhciBzdGF0dXMgPSB0aGlzLnN0YXR1czsKCQlyZXR1cm4gKHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwKTsKCX0sCgoJaXNSdW5uaW5nOiBmdW5jdGlvbigpewoJCXJldHVybiAhIXRoaXMucnVubmluZzsKCX0sCgoJcHJvY2Vzc1NjcmlwdHM6IGZ1bmN0aW9uKHRleHQpewoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFJlc3BvbnNlIHx8ICgvKGVjbWF8amF2YSlzY3JpcHQvKS50ZXN0KHRoaXMuZ2V0SGVhZGVyKCdDb250ZW50LXR5cGUnKSkpIHJldHVybiBCcm93c2VyLmV4ZWModGV4dCk7CgkJcmV0dXJuIHRleHQuc3RyaXBTY3JpcHRzKHRoaXMub3B0aW9ucy5ldmFsU2NyaXB0cyk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQsIHhtbCl7CgkJdGhpcy5vblN1Y2Nlc3ModGhpcy5wcm9jZXNzU2NyaXB0cyh0ZXh0KSwgeG1sKTsKCX0sCgoJb25TdWNjZXNzOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIGFyZ3VtZW50cykuZmlyZUV2ZW50KCdzdWNjZXNzJywgYXJndW1lbnRzKS5jYWxsQ2hhaW4oKTsKCX0sCgoJZmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLm9uRmFpbHVyZSgpOwoJfSwKCglvbkZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJykuZmlyZUV2ZW50KCdmYWlsdXJlJywgdGhpcy54aHIpOwoJfSwKCQoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgkKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJdGltZW91dDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgndGltZW91dCcsIHRoaXMueGhyKTsKCX0sCgoJc2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpOwoJCX0uYmluZCh0aGlzKSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgkKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgkJCgkJdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpOwoJCWlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pOwoKCQlpZiAodGhpcy5vcHRpb25zLm5vQ2FjaGUpCgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgU3RyaW5nLnVuaXF1ZUlEKCk7CgoJCWlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCl7CgkJCXhoci5vbmxvYWRzdGFydCA9IHRoaXMubG9hZHN0YXJ0LmJpbmQodGhpcyk7CgkJCXhoci5vbnByb2dyZXNzID0gdGhpcy5wcm9ncmVzcy5iaW5kKHRoaXMpOwoJCX0KCgkJeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgdGhpcy5vcHRpb25zLmFzeW5jLCB0aGlzLm9wdGlvbnMudXNlciwgdGhpcy5vcHRpb25zLnBhc3N3b3JkKTsKCQlpZiAodGhpcy5vcHRpb25zLnVzZXIgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyKSB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKCQkKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLnRpbWVvdXQuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQl4aHIuYWJvcnQoKTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJdGhpcy54aHIgPSBuZXcgQnJvd3Nlci5SZXF1ZXN0KCk7CgkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgbWV0aG9kcyA9IHt9OwpbJ2dldCcsICdwb3N0JywgJ3B1dCcsICdkZWxldGUnLCAnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURSddLmVhY2goZnVuY3Rpb24obWV0aG9kKXsKCW1ldGhvZHNbbWV0aG9kXSA9IGZ1bmN0aW9uKGRhdGEpewoJCXZhciBvYmplY3QgPSB7CgkJCW1ldGhvZDogbWV0aG9kCgkJfTsKCQlpZiAoZGF0YSAhPSBudWxsKSBvYmplY3QuZGF0YSA9IGRhdGE7CgkJcmV0dXJuIHRoaXMuc2VuZChvYmplY3QpOwoJfTsKfSk7CgpSZXF1ZXN0LmltcGxlbWVudChtZXRob2RzKTsKCkVsZW1lbnQuUHJvcGVydGllcy5zZW5kID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbmQgPSB0aGlzLmdldCgnc2VuZCcpLmNhbmNlbCgpOwoJCXNlbmQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBzZW5kID0gdGhpcy5yZXRyaWV2ZSgnc2VuZCcpOwoJCWlmICghc2VuZCl7CgkJCXNlbmQgPSBuZXcgUmVxdWVzdCh7CgkJCQlkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgbWV0aG9kOiB0aGlzLmdldCgnbWV0aG9kJykgfHwgJ3Bvc3QnLCB1cmw6IHRoaXMuZ2V0KCdhY3Rpb24nKQoJCQl9KTsKCQkJdGhpcy5zdG9yZSgnc2VuZCcsIHNlbmQpOwoJCX0KCQlyZXR1cm4gc2VuZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2VuZDogZnVuY3Rpb24odXJsKXsKCQl2YXIgc2VuZGVyID0gdGhpcy5nZXQoJ3NlbmQnKTsKCQlzZW5kZXIuc2VuZCh7ZGF0YTogdGhpcywgdXJsOiB1cmwgfHwgc2VuZGVyLm9wdGlvbnMudXJsfSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cygnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50cy5maWx0ZXIob3B0aW9ucy5maWx0ZXIpOwoJCWlmIChvcHRpb25zLnVwZGF0ZSkgZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJZWxzZSBpZiAob3B0aW9ucy5hcHBlbmQpIGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKS5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZSBBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKLy88MS4yY29tcGF0PgoKSlNPTiA9IG5ldyBIYXNoKHsKCXN0cmluZ2lmeTogSlNPTi5zdHJpbmdpZnksCglwYXJzZTogSlNPTi5wYXJzZQp9KTsKCi8vPC8xLjJjb21wYXQ+CgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCgl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgkKCWRvY3VtZW50LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCXdpbmRvdy5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbigpewoJZm9yICh2YXIgaSA9IGNoZWNrcy5sZW5ndGg7IGktLTspIGlmIChjaGVja3NbaV0oKSl7CgkJZG9tcmVhZHkoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCnZhciBwb2xsID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAoIWNoZWNrKCkpIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCAxMCk7Cn07Cgpkb2N1bWVudC5hZGRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KTsKCi8qPGx0SUU4PiovCi8vIGRvU2Nyb2xsIHRlY2huaXF1ZSBieSBEaWVnbyBQZXJpbmkgaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KLy8gdGVzdEVsZW1lbnQuZG9TY3JvbGwoKSB0aHJvd3Mgd2hlbiB0aGUgRE9NIGlzIG5vdCByZWFkeSwgb25seSBpbiB0aGUgdG9wIHdpbmRvdwp2YXIgZG9TY3JvbGxXb3JrcyA9IGZ1bmN0aW9uKCl7Cgl0cnkgewoJCXRlc3RFbGVtZW50LmRvU2Nyb2xsKCk7CgkJcmV0dXJuIHRydWU7Cgl9IGNhdGNoIChlKXt9CglyZXR1cm4gZmFsc2U7Cn0KLy8gSWYgZG9TY3JvbGwgd29ya3MgYWxyZWFkeSwgaXQgY2FuJ3QgYmUgdXNlZCB0byBkZXRlcm1pbmUgZG9tcmVhZHkKLy8gICBlLmcuIGluIGFuIGlmcmFtZQppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWRvU2Nyb2xsV29ya3MoKSl7CgljaGVja3MucHVzaChkb1Njcm9sbFdvcmtzKTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9Ci8qPC9sdElFOD4qLwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9Cn07CgovLyBUaGlzIGlzIGJhc2VkIG9uIHRoZSBjdXN0b20gbG9hZCBldmVudAp3aW5kb3cuYWRkRXZlbnQoJ2xvYWQnLCBmdW5jdGlvbigpewoJbG9hZGVkID0gdHJ1ZTsKfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pKCk7Cgo=",
                "body": "LyoKLS0tCk1vb1Rvb2xzOiB0aGUgamF2YXNjcmlwdCBmcmFtZXdvcmsKCndlYiBidWlsZDoKIC0gaHR0cDovL21vb3Rvb2xzLm5ldC9jb3JlLzdjNTZjZmVmOWRkZGNmMTcwYTVkNjhlM2ZiNjFjZmQ3CgpwYWNrYWdlciBidWlsZDoKIC0gcGFja2FnZXIgYnVpbGQgQ29yZS9Db3JlIENvcmUvQXJyYXkgQ29yZS9TdHJpbmcgQ29yZS9OdW1iZXIgQ29yZS9GdW5jdGlvbiBDb3JlL09iamVjdCBDb3JlL0V2ZW50IENvcmUvQnJvd3NlciBDb3JlL0NsYXNzIENvcmUvQ2xhc3MuRXh0cmFzIENvcmUvU2xpY2suUGFyc2VyIENvcmUvU2xpY2suRmluZGVyIENvcmUvRWxlbWVudCBDb3JlL0VsZW1lbnQuU3R5bGUgQ29yZS9FbGVtZW50LkV2ZW50IENvcmUvRWxlbWVudC5EaW1lbnNpb25zIENvcmUvRnggQ29yZS9GeC5DU1MgQ29yZS9GeC5Ud2VlbiBDb3JlL0Z4Lk1vcnBoIENvcmUvRnguVHJhbnNpdGlvbnMgQ29yZS9SZXF1ZXN0IENvcmUvUmVxdWVzdC5IVE1MIENvcmUvUmVxdWVzdC5KU09OIENvcmUvQ29va2llIENvcmUvSlNPTiBDb3JlL0RPTVJlYWR5IENvcmUvU3dpZmYKCi8qCi0tLQoKbmFtZTogQ29yZQoKZGVzY3JpcHRpb246IFRoZSBoZWFydCBvZiBNb29Ub29scy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY29weXJpZ2h0OiBDb3B5cmlnaHQgKGMpIDIwMDYtMjAxMCBbVmFsZXJpbyBQcm9pZXR0aV0oaHR0cDovL21hZDRtaWxrLm5ldC8pLgoKYXV0aG9yczogVGhlIE1vb1Rvb2xzIHByb2R1Y3Rpb24gdGVhbSAoaHR0cDovL21vb3Rvb2xzLm5ldC9kZXZlbG9wZXJzLykKCmluc3BpcmF0aW9uOgogIC0gQ2xhc3MgaW1wbGVtZW50YXRpb24gaW5zcGlyZWQgYnkgW0Jhc2UuanNdKGh0dHA6Ly9kZWFuLmVkd2FyZHMubmFtZS93ZWJsb2cvMjAwNi8wMy9iYXNlLykgQ29weXJpZ2h0IChjKSAyMDA2IERlYW4gRWR3YXJkcywgW0dOVSBMZXNzZXIgR2VuZXJhbCBQdWJsaWMgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL2xncGwtbGljZW5zZS5waHApCiAgLSBTb21lIGZ1bmN0aW9uYWxpdHkgaW5zcGlyZWQgYnkgW1Byb3RvdHlwZS5qc10oaHR0cDovL3Byb3RvdHlwZWpzLm9yZykgQ29weXJpZ2h0IChjKSAyMDA1LTIwMDcgU2FtIFN0ZXBoZW5zb24sIFtNSVQgTGljZW5zZV0oaHR0cDovL29wZW5zb3VyY2Uub3JnL2xpY2Vuc2VzL21pdC1saWNlbnNlLnBocCkKCnByb3ZpZGVzOiBbQ29yZSwgTW9vVG9vbHMsIFR5cGUsIHR5cGVPZiwgaW5zdGFuY2VPZiwgTmF0aXZlXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnRoaXMuTW9vVG9vbHMgPSB7Cgl2ZXJzaW9uOiAnMS4zLjInLAoJYnVpbGQ6ICdjOWYxZmYxMGU5ZTdmYWNiNjVlOTQ4MTA0OWVkMWI0NTA5NTlkNTg3Jwp9OwoKLy8gdHlwZU9mLCBpbnN0YW5jZU9mCgp2YXIgdHlwZU9mID0gdGhpcy50eXBlT2YgPSBmdW5jdGlvbihpdGVtKXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiAnbnVsbCc7CglpZiAoaXRlbS4kZmFtaWx5KSByZXR1cm4gaXRlbS4kZmFtaWx5KCk7CgoJaWYgKGl0ZW0ubm9kZU5hbWUpewoJCWlmIChpdGVtLm5vZGVUeXBlID09IDEpIHJldHVybiAnZWxlbWVudCc7CgkJaWYgKGl0ZW0ubm9kZVR5cGUgPT0gMykgcmV0dXJuICgvXFMvKS50ZXN0KGl0ZW0ubm9kZVZhbHVlKSA/ICd0ZXh0bm9kZScgOiAnd2hpdGVzcGFjZSc7Cgl9IGVsc2UgaWYgKHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyl7CgkJaWYgKGl0ZW0uY2FsbGVlKSByZXR1cm4gJ2FyZ3VtZW50cyc7CgkJaWYgKCdpdGVtJyBpbiBpdGVtKSByZXR1cm4gJ2NvbGxlY3Rpb24nOwoJfQoKCXJldHVybiB0eXBlb2YgaXRlbTsKfTsKCnZhciBpbnN0YW5jZU9mID0gdGhpcy5pbnN0YW5jZU9mID0gZnVuY3Rpb24oaXRlbSwgb2JqZWN0KXsKCWlmIChpdGVtID09IG51bGwpIHJldHVybiBmYWxzZTsKCXZhciBjb25zdHJ1Y3RvciA9IGl0ZW0uJGNvbnN0cnVjdG9yIHx8IGl0ZW0uY29uc3RydWN0b3I7Cgl3aGlsZSAoY29uc3RydWN0b3IpewoJCWlmIChjb25zdHJ1Y3RvciA9PT0gb2JqZWN0KSByZXR1cm4gdHJ1ZTsKCQljb25zdHJ1Y3RvciA9IGNvbnN0cnVjdG9yLnBhcmVudDsKCX0KCXJldHVybiBpdGVtIGluc3RhbmNlb2Ygb2JqZWN0Owp9OwoKLy8gRnVuY3Rpb24gb3ZlcmxvYWRpbmcKCnZhciBGdW5jdGlvbiA9IHRoaXMuRnVuY3Rpb247Cgp2YXIgZW51bWVyYWJsZXMgPSB0cnVlOwpmb3IgKHZhciBpIGluIHt0b1N0cmluZzogMX0pIGVudW1lcmFibGVzID0gbnVsbDsKaWYgKGVudW1lcmFibGVzKSBlbnVtZXJhYmxlcyA9IFsnaGFzT3duUHJvcGVydHknLCAndmFsdWVPZicsICdpc1Byb3RvdHlwZU9mJywgJ3Byb3BlcnR5SXNFbnVtZXJhYmxlJywgJ3RvTG9jYWxlU3RyaW5nJywgJ3RvU3RyaW5nJywgJ2NvbnN0cnVjdG9yJ107CgpGdW5jdGlvbi5wcm90b3R5cGUub3ZlcmxvYWRTZXR0ZXIgPSBmdW5jdGlvbih1c2VQbHVyYWwpewoJdmFyIHNlbGYgPSB0aGlzOwoJcmV0dXJuIGZ1bmN0aW9uKGEsIGIpewoJCWlmIChhID09IG51bGwpIHJldHVybiB0aGlzOwoJCWlmICh1c2VQbHVyYWwgfHwgdHlwZW9mIGEgIT0gJ3N0cmluZycpewoJCQlmb3IgKHZhciBrIGluIGEpIHNlbGYuY2FsbCh0aGlzLCBrLCBhW2tdKTsKCQkJaWYgKGVudW1lcmFibGVzKSBmb3IgKHZhciBpID0gZW51bWVyYWJsZXMubGVuZ3RoOyBpLS07KXsKCQkJCWsgPSBlbnVtZXJhYmxlc1tpXTsKCQkJCWlmIChhLmhhc093blByb3BlcnR5KGspKSBzZWxmLmNhbGwodGhpcywgaywgYVtrXSk7CgkJCX0KCQl9IGVsc2UgewoJCQlzZWxmLmNhbGwodGhpcywgYSwgYik7CgkJfQoJCXJldHVybiB0aGlzOwoJfTsKfTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5vdmVybG9hZEdldHRlciA9IGZ1bmN0aW9uKHVzZVBsdXJhbCl7Cgl2YXIgc2VsZiA9IHRoaXM7CglyZXR1cm4gZnVuY3Rpb24oYSl7CgkJdmFyIGFyZ3MsIHJlc3VsdDsKCQlpZiAodXNlUGx1cmFsIHx8IHR5cGVvZiBhICE9ICdzdHJpbmcnKSBhcmdzID0gYTsKCQllbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSkgYXJncyA9IGFyZ3VtZW50czsKCQlpZiAoYXJncyl7CgkJCXJlc3VsdCA9IHt9OwoJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHJlc3VsdFthcmdzW2ldXSA9IHNlbGYuY2FsbCh0aGlzLCBhcmdzW2ldKTsKCQl9IGVsc2UgewoJCQlyZXN1bHQgPSBzZWxmLmNhbGwodGhpcywgYSk7CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9Owp9OwoKRnVuY3Rpb24ucHJvdG90eXBlLmV4dGVuZCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUpewoJdGhpc1trZXldID0gdmFsdWU7Cn0ub3ZlcmxvYWRTZXR0ZXIoKTsKCkZ1bmN0aW9uLnByb3RvdHlwZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihrZXksIHZhbHVlKXsKCXRoaXMucHJvdG90eXBlW2tleV0gPSB2YWx1ZTsKfS5vdmVybG9hZFNldHRlcigpOwoKLy8gRnJvbQoKdmFyIHNsaWNlID0gQXJyYXkucHJvdG90eXBlLnNsaWNlOwoKRnVuY3Rpb24uZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJcmV0dXJuICh0eXBlT2YoaXRlbSkgPT0gJ2Z1bmN0aW9uJykgPyBpdGVtIDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gaXRlbTsKCX07Cn07CgpBcnJheS5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglpZiAoaXRlbSA9PSBudWxsKSByZXR1cm4gW107CglyZXR1cm4gKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pICYmIHR5cGVvZiBpdGVtICE9ICdzdHJpbmcnKSA/ICh0eXBlT2YoaXRlbSkgPT0gJ2FycmF5JykgPyBpdGVtIDogc2xpY2UuY2FsbChpdGVtKSA6IFtpdGVtXTsKfTsKCk51bWJlci5mcm9tID0gZnVuY3Rpb24oaXRlbSl7Cgl2YXIgbnVtYmVyID0gcGFyc2VGbG9hdChpdGVtKTsKCXJldHVybiBpc0Zpbml0ZShudW1iZXIpID8gbnVtYmVyIDogbnVsbDsKfTsKClN0cmluZy5mcm9tID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbSArICcnOwp9OwoKLy8gaGlkZSwgcHJvdGVjdAoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCgloaWRlOiBmdW5jdGlvbigpewoJCXRoaXMuJGhpZGRlbiA9IHRydWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXByb3RlY3Q6IGZ1bmN0aW9uKCl7CgkJdGhpcy4kcHJvdGVjdGVkID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLy8gVHlwZQoKdmFyIFR5cGUgPSB0aGlzLlR5cGUgPSBmdW5jdGlvbihuYW1lLCBvYmplY3QpewoJaWYgKG5hbWUpewoJCXZhciBsb3dlciA9IG5hbWUudG9Mb3dlckNhc2UoKTsKCQl2YXIgdHlwZUNoZWNrID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiAodHlwZU9mKGl0ZW0pID09IGxvd2VyKTsKCQl9OwoKCQlUeXBlWydpcycgKyBuYW1lXSA9IHR5cGVDaGVjazsKCQlpZiAob2JqZWN0ICE9IG51bGwpewoJCQlvYmplY3QucHJvdG90eXBlLiRmYW1pbHkgPSAoZnVuY3Rpb24oKXsKCQkJCXJldHVybiBsb3dlcjsKCQkJfSkuaGlkZSgpOwoJCQkvLzwxLjJjb21wYXQ+CgkJCW9iamVjdC50eXBlID0gdHlwZUNoZWNrOwoJCQkvLzwvMS4yY29tcGF0PgoJCX0KCX0KCglpZiAob2JqZWN0ID09IG51bGwpIHJldHVybiBudWxsOwoKCW9iamVjdC5leHRlbmQodGhpcyk7CglvYmplY3QuJGNvbnN0cnVjdG9yID0gVHlwZTsKCW9iamVjdC5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gb2JqZWN0OwoKCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKVHlwZS5pc0VudW1lcmFibGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbSAhPSBudWxsICYmIHR5cGVvZiBpdGVtLmxlbmd0aCA9PSAnbnVtYmVyJyAmJiB0b1N0cmluZy5jYWxsKGl0ZW0pICE9ICdbb2JqZWN0IEZ1bmN0aW9uXScgKTsKfTsKCnZhciBob29rcyA9IHt9OwoKdmFyIGhvb2tzT2YgPSBmdW5jdGlvbihvYmplY3QpewoJdmFyIHR5cGUgPSB0eXBlT2Yob2JqZWN0LnByb3RvdHlwZSk7CglyZXR1cm4gaG9va3NbdHlwZV0gfHwgKGhvb2tzW3R5cGVdID0gW10pOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7CglpZiAobWV0aG9kICYmIG1ldGhvZC4kaGlkZGVuKSByZXR1cm47CgoJdmFyIGhvb2tzID0gaG9va3NPZih0aGlzKTsKCglmb3IgKHZhciBpID0gMDsgaSA8IGhvb2tzLmxlbmd0aDsgaSsrKXsKCQl2YXIgaG9vayA9IGhvb2tzW2ldOwoJCWlmICh0eXBlT2YoaG9vaykgPT0gJ3R5cGUnKSBpbXBsZW1lbnQuY2FsbChob29rLCBuYW1lLCBtZXRob2QpOwoJCWVsc2UgaG9vay5jYWxsKHRoaXMsIG5hbWUsIG1ldGhvZCk7Cgl9CgkKCXZhciBwcmV2aW91cyA9IHRoaXMucHJvdG90eXBlW25hbWVdOwoJaWYgKHByZXZpb3VzID09IG51bGwgfHwgIXByZXZpb3VzLiRwcm90ZWN0ZWQpIHRoaXMucHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoKCWlmICh0aGlzW25hbWVdID09IG51bGwgJiYgdHlwZU9mKG1ldGhvZCkgPT0gJ2Z1bmN0aW9uJykgZXh0ZW5kLmNhbGwodGhpcywgbmFtZSwgZnVuY3Rpb24oaXRlbSl7CgkJcmV0dXJuIG1ldGhvZC5hcHBseShpdGVtLCBzbGljZS5jYWxsKGFyZ3VtZW50cywgMSkpOwoJfSk7Cn07Cgp2YXIgZXh0ZW5kID0gZnVuY3Rpb24obmFtZSwgbWV0aG9kKXsKCWlmIChtZXRob2QgJiYgbWV0aG9kLiRoaWRkZW4pIHJldHVybjsKCXZhciBwcmV2aW91cyA9IHRoaXNbbmFtZV07CglpZiAocHJldmlvdXMgPT0gbnVsbCB8fCAhcHJldmlvdXMuJHByb3RlY3RlZCkgdGhpc1tuYW1lXSA9IG1ldGhvZDsKfTsKClR5cGUuaW1wbGVtZW50KHsKCglpbXBsZW1lbnQ6IGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpLAoKCWV4dGVuZDogZXh0ZW5kLm92ZXJsb2FkU2V0dGVyKCksCgoJYWxpYXM6IGZ1bmN0aW9uKG5hbWUsIGV4aXN0aW5nKXsKCQlpbXBsZW1lbnQuY2FsbCh0aGlzLCBuYW1lLCB0aGlzLnByb3RvdHlwZVtleGlzdGluZ10pOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCW1pcnJvcjogZnVuY3Rpb24oaG9vayl7CgkJaG9va3NPZih0aGlzKS5wdXNoKGhvb2spOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpuZXcgVHlwZSgnVHlwZScsIFR5cGUpOwoKLy8gRGVmYXVsdCBUeXBlcwoKdmFyIGZvcmNlID0gZnVuY3Rpb24obmFtZSwgb2JqZWN0LCBtZXRob2RzKXsKCXZhciBpc1R5cGUgPSAob2JqZWN0ICE9IE9iamVjdCksCgkJcHJvdG90eXBlID0gb2JqZWN0LnByb3RvdHlwZTsKCglpZiAoaXNUeXBlKSBvYmplY3QgPSBuZXcgVHlwZShuYW1lLCBvYmplY3QpOwoKCWZvciAodmFyIGkgPSAwLCBsID0gbWV0aG9kcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBrZXkgPSBtZXRob2RzW2ldLAoJCQlnZW5lcmljID0gb2JqZWN0W2tleV0sCgkJCXByb3RvID0gcHJvdG90eXBlW2tleV07CgoJCWlmIChnZW5lcmljKSBnZW5lcmljLnByb3RlY3QoKTsKCgkJaWYgKGlzVHlwZSAmJiBwcm90byl7CgkJCWRlbGV0ZSBwcm90b3R5cGVba2V5XTsKCQkJcHJvdG90eXBlW2tleV0gPSBwcm90by5wcm90ZWN0KCk7CgkJfQoJfQoKCWlmIChpc1R5cGUpIG9iamVjdC5pbXBsZW1lbnQocHJvdG90eXBlKTsKCglyZXR1cm4gZm9yY2U7Cn07Cgpmb3JjZSgnU3RyaW5nJywgU3RyaW5nLCBbCgknY2hhckF0JywgJ2NoYXJDb2RlQXQnLCAnY29uY2F0JywgJ2luZGV4T2YnLCAnbGFzdEluZGV4T2YnLCAnbWF0Y2gnLCAncXVvdGUnLCAncmVwbGFjZScsICdzZWFyY2gnLAoJJ3NsaWNlJywgJ3NwbGl0JywgJ3N1YnN0cicsICdzdWJzdHJpbmcnLCAndG9Mb3dlckNhc2UnLCAndG9VcHBlckNhc2UnCl0pKCdBcnJheScsIEFycmF5LCBbCgkncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJywKCSdpbmRleE9mJywgJ2xhc3RJbmRleE9mJywgJ2ZpbHRlcicsICdmb3JFYWNoJywgJ2V2ZXJ5JywgJ21hcCcsICdzb21lJywgJ3JlZHVjZScsICdyZWR1Y2VSaWdodCcKXSkoJ051bWJlcicsIE51bWJlciwgWwoJJ3RvRXhwb25lbnRpYWwnLCAndG9GaXhlZCcsICd0b0xvY2FsZVN0cmluZycsICd0b1ByZWNpc2lvbicKXSkoJ0Z1bmN0aW9uJywgRnVuY3Rpb24sIFsKCSdhcHBseScsICdjYWxsJywgJ2JpbmQnCl0pKCdSZWdFeHAnLCBSZWdFeHAsIFsKCSdleGVjJywgJ3Rlc3QnCl0pKCdPYmplY3QnLCBPYmplY3QsIFsKCSdjcmVhdGUnLCAnZGVmaW5lUHJvcGVydHknLCAnZGVmaW5lUHJvcGVydGllcycsICdrZXlzJywKCSdnZXRQcm90b3R5cGVPZicsICdnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3InLCAnZ2V0T3duUHJvcGVydHlOYW1lcycsCgkncHJldmVudEV4dGVuc2lvbnMnLCAnaXNFeHRlbnNpYmxlJywgJ3NlYWwnLCAnaXNTZWFsZWQnLCAnZnJlZXplJywgJ2lzRnJvemVuJwpdKSgnRGF0ZScsIERhdGUsIFsnbm93J10pOwoKT2JqZWN0LmV4dGVuZCA9IGV4dGVuZC5vdmVybG9hZFNldHRlcigpOwoKRGF0ZS5leHRlbmQoJ25vdycsIGZ1bmN0aW9uKCl7CglyZXR1cm4gKyhuZXcgRGF0ZSk7Cn0pOwoKbmV3IFR5cGUoJ0Jvb2xlYW4nLCBCb29sZWFuKTsKCi8vIGZpeGVzIE5hTiByZXR1cm5pbmcgYXMgTnVtYmVyCgpOdW1iZXIucHJvdG90eXBlLiRmYW1pbHkgPSBmdW5jdGlvbigpewoJcmV0dXJuIGlzRmluaXRlKHRoaXMpID8gJ251bWJlcicgOiAnbnVsbCc7Cn0uaGlkZSgpOwoKLy8gTnVtYmVyLnJhbmRvbQoKTnVtYmVyLmV4dGVuZCgncmFuZG9tJywgZnVuY3Rpb24obWluLCBtYXgpewoJcmV0dXJuIE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIChtYXggLSBtaW4gKyAxKSArIG1pbik7Cn0pOwoKLy8gZm9yRWFjaCwgZWFjaAoKdmFyIGhhc093blByb3BlcnR5ID0gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eTsKT2JqZWN0LmV4dGVuZCgnZm9yRWFjaCcsIGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSBmbi5jYWxsKGJpbmQsIG9iamVjdFtrZXldLCBrZXksIG9iamVjdCk7Cgl9Cn0pOwoKT2JqZWN0LmVhY2ggPSBPYmplY3QuZm9yRWFjaDsKCkFycmF5LmltcGxlbWVudCh7CgoJZm9yRWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSBmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpOwoJCX0KCX0sCgoJZWFjaDogZnVuY3Rpb24oZm4sIGJpbmQpewoJCUFycmF5LmZvckVhY2godGhpcywgZm4sIGJpbmQpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgovLyBBcnJheSAmIE9iamVjdCBjbG9uaW5nLCBPYmplY3QgbWVyZ2luZyBhbmQgYXBwZW5kaW5nCgp2YXIgY2xvbmVPZiA9IGZ1bmN0aW9uKGl0ZW0pewoJc3dpdGNoICh0eXBlT2YoaXRlbSkpewoJCWNhc2UgJ2FycmF5JzogcmV0dXJuIGl0ZW0uY2xvbmUoKTsKCQljYXNlICdvYmplY3QnOiByZXR1cm4gT2JqZWN0LmNsb25lKGl0ZW0pOwoJCWRlZmF1bHQ6IHJldHVybiBpdGVtOwoJfQp9OwoKQXJyYXkuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKCl7Cgl2YXIgaSA9IHRoaXMubGVuZ3RoLCBjbG9uZSA9IG5ldyBBcnJheShpKTsKCXdoaWxlIChpLS0pIGNsb25lW2ldID0gY2xvbmVPZih0aGlzW2ldKTsKCXJldHVybiBjbG9uZTsKfSk7Cgp2YXIgbWVyZ2VPbmUgPSBmdW5jdGlvbihzb3VyY2UsIGtleSwgY3VycmVudCl7Cglzd2l0Y2ggKHR5cGVPZihjdXJyZW50KSl7CgkJY2FzZSAnb2JqZWN0JzoKCQkJaWYgKHR5cGVPZihzb3VyY2Vba2V5XSkgPT0gJ29iamVjdCcpIE9iamVjdC5tZXJnZShzb3VyY2Vba2V5XSwgY3VycmVudCk7CgkJCWVsc2Ugc291cmNlW2tleV0gPSBPYmplY3QuY2xvbmUoY3VycmVudCk7CgkJYnJlYWs7CgkJY2FzZSAnYXJyYXknOiBzb3VyY2Vba2V5XSA9IGN1cnJlbnQuY2xvbmUoKTsgYnJlYWs7CgkJZGVmYXVsdDogc291cmNlW2tleV0gPSBjdXJyZW50OwoJfQoJcmV0dXJuIHNvdXJjZTsKfTsKCk9iamVjdC5leHRlbmQoewoKCW1lcmdlOiBmdW5jdGlvbihzb3VyY2UsIGssIHYpewoJCWlmICh0eXBlT2YoaykgPT0gJ3N0cmluZycpIHJldHVybiBtZXJnZU9uZShzb3VyY2UsIGssIHYpOwoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBvYmplY3QgPSBhcmd1bWVudHNbaV07CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIG1lcmdlT25lKHNvdXJjZSwga2V5LCBvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiBzb3VyY2U7Cgl9LAoKCWNsb25lOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciBjbG9uZSA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpIGNsb25lW2tleV0gPSBjbG9uZU9mKG9iamVjdFtrZXldKTsKCQlyZXR1cm4gY2xvbmU7Cgl9LAoKCWFwcGVuZDogZnVuY3Rpb24ob3JpZ2luYWwpewoJCWZvciAodmFyIGkgPSAxLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBleHRlbmRlZCA9IGFyZ3VtZW50c1tpXSB8fCB7fTsKCQkJZm9yICh2YXIga2V5IGluIGV4dGVuZGVkKSBvcmlnaW5hbFtrZXldID0gZXh0ZW5kZWRba2V5XTsKCQl9CgkJcmV0dXJuIG9yaWdpbmFsOwoJfQoKfSk7CgovLyBPYmplY3QtbGVzcyB0eXBlcwoKWydPYmplY3QnLCAnV2hpdGVTcGFjZScsICdUZXh0Tm9kZScsICdDb2xsZWN0aW9uJywgJ0FyZ3VtZW50cyddLmVhY2goZnVuY3Rpb24obmFtZSl7CgluZXcgVHlwZShuYW1lKTsKfSk7CgovLyBVbmlxdWUgSUQKCnZhciBVSUQgPSBEYXRlLm5vdygpOwoKU3RyaW5nLmV4dGVuZCgndW5pcXVlSUQnLCBmdW5jdGlvbigpewoJcmV0dXJuIChVSUQrKykudG9TdHJpbmcoMzYpOwp9KTsKCi8vPDEuMmNvbXBhdD4KCnZhciBIYXNoID0gdGhpcy5IYXNoID0gbmV3IFR5cGUoJ0hhc2gnLCBmdW5jdGlvbihvYmplY3QpewoJaWYgKHR5cGVPZihvYmplY3QpID09ICdoYXNoJykgb2JqZWN0ID0gT2JqZWN0LmNsb25lKG9iamVjdC5nZXRDbGVhbigpKTsKCWZvciAodmFyIGtleSBpbiBvYmplY3QpIHRoaXNba2V5XSA9IG9iamVjdFtrZXldOwoJcmV0dXJuIHRoaXM7Cn0pOwoKSGFzaC5pbXBsZW1lbnQoewoKCWZvckVhY2g6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlPYmplY3QuZm9yRWFjaCh0aGlzLCBmbiwgYmluZCk7Cgl9LAoKCWdldENsZWFuOiBmdW5jdGlvbigpewoJCXZhciBjbGVhbiA9IHt9OwoJCWZvciAodmFyIGtleSBpbiB0aGlzKXsKCQkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgY2xlYW5ba2V5XSA9IHRoaXNba2V5XTsKCQl9CgkJcmV0dXJuIGNsZWFuOwoJfSwKCglnZXRMZW5ndGg6IGZ1bmN0aW9uKCl7CgkJdmFyIGxlbmd0aCA9IDA7CgkJZm9yICh2YXIga2V5IGluIHRoaXMpewoJCQlpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSBsZW5ndGgrKzsKCQl9CgkJcmV0dXJuIGxlbmd0aDsKCX0KCn0pOwoKSGFzaC5hbGlhcygnZWFjaCcsICdmb3JFYWNoJyk7CgpPYmplY3QudHlwZSA9IFR5cGUuaXNPYmplY3Q7Cgp2YXIgTmF0aXZlID0gdGhpcy5OYXRpdmUgPSBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCXJldHVybiBuZXcgVHlwZShwcm9wZXJ0aWVzLm5hbWUsIHByb3BlcnRpZXMuaW5pdGlhbGl6ZSk7Cn07CgpOYXRpdmUudHlwZSA9IFR5cGUudHlwZTsKCk5hdGl2ZS5pbXBsZW1lbnQgPSBmdW5jdGlvbihvYmplY3RzLCBtZXRob2RzKXsKCWZvciAodmFyIGkgPSAwOyBpIDwgb2JqZWN0cy5sZW5ndGg7IGkrKykgb2JqZWN0c1tpXS5pbXBsZW1lbnQobWV0aG9kcyk7CglyZXR1cm4gTmF0aXZlOwp9OwoKdmFyIGFycmF5VHlwZSA9IEFycmF5LnR5cGU7CkFycmF5LnR5cGUgPSBmdW5jdGlvbihpdGVtKXsKCXJldHVybiBpbnN0YW5jZU9mKGl0ZW0sIEFycmF5KSB8fCBhcnJheVR5cGUoaXRlbSk7Cn07Cgp0aGlzLiRBID0gZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gQXJyYXkuZnJvbShpdGVtKS5zbGljZSgpOwp9OwoKdGhpcy4kYXJndW1lbnRzID0gZnVuY3Rpb24oaSl7CglyZXR1cm4gZnVuY3Rpb24oKXsKCQlyZXR1cm4gYXJndW1lbnRzW2ldOwoJfTsKfTsKCnRoaXMuJGNoayA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gISEob2JqIHx8IG9iaiA9PT0gMCk7Cn07Cgp0aGlzLiRjbGVhciA9IGZ1bmN0aW9uKHRpbWVyKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CgljbGVhckludGVydmFsKHRpbWVyKTsKCXJldHVybiBudWxsOwp9OwoKdGhpcy4kZGVmaW5lZCA9IGZ1bmN0aW9uKG9iail7CglyZXR1cm4gKG9iaiAhPSBudWxsKTsKfTsKCnRoaXMuJGVhY2ggPSBmdW5jdGlvbihpdGVyYWJsZSwgZm4sIGJpbmQpewoJdmFyIHR5cGUgPSB0eXBlT2YoaXRlcmFibGUpOwoJKCh0eXBlID09ICdhcmd1bWVudHMnIHx8IHR5cGUgPT0gJ2NvbGxlY3Rpb24nIHx8IHR5cGUgPT0gJ2FycmF5JyB8fCB0eXBlID09ICdlbGVtZW50cycpID8gQXJyYXkgOiBPYmplY3QpLmVhY2goaXRlcmFibGUsIGZuLCBiaW5kKTsKfTsKCnRoaXMuJGVtcHR5ID0gZnVuY3Rpb24oKXt9OwoKdGhpcy4kZXh0ZW5kID0gZnVuY3Rpb24ob3JpZ2luYWwsIGV4dGVuZGVkKXsKCXJldHVybiBPYmplY3QuYXBwZW5kKG9yaWdpbmFsLCBleHRlbmRlZCk7Cn07Cgp0aGlzLiRIID0gZnVuY3Rpb24ob2JqZWN0KXsKCXJldHVybiBuZXcgSGFzaChvYmplY3QpOwp9OwoKdGhpcy4kbWVyZ2UgPSBmdW5jdGlvbigpewoJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMpOwoJYXJncy51bnNoaWZ0KHt9KTsKCXJldHVybiBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgYXJncyk7Cn07Cgp0aGlzLiRsYW1iZGEgPSBGdW5jdGlvbi5mcm9tOwp0aGlzLiRtaXhpbiA9IE9iamVjdC5tZXJnZTsKdGhpcy4kcmFuZG9tID0gTnVtYmVyLnJhbmRvbTsKdGhpcy4kc3BsYXQgPSBBcnJheS5mcm9tOwp0aGlzLiR0aW1lID0gRGF0ZS5ub3c7Cgp0aGlzLiR0eXBlID0gZnVuY3Rpb24ob2JqZWN0KXsKCXZhciB0eXBlID0gdHlwZU9mKG9iamVjdCk7CglpZiAodHlwZSA9PSAnZWxlbWVudHMnKSByZXR1cm4gJ2FycmF5JzsKCXJldHVybiAodHlwZSA9PSAnbnVsbCcpID8gZmFsc2UgOiB0eXBlOwp9OwoKdGhpcy4kdW5saW5rID0gZnVuY3Rpb24ob2JqZWN0KXsKCXN3aXRjaCAodHlwZU9mKG9iamVjdCkpewoJCWNhc2UgJ29iamVjdCc6IHJldHVybiBPYmplY3QuY2xvbmUob2JqZWN0KTsKCQljYXNlICdhcnJheSc6IHJldHVybiBBcnJheS5jbG9uZShvYmplY3QpOwoJCWNhc2UgJ2hhc2gnOiByZXR1cm4gbmV3IEhhc2gob2JqZWN0KTsKCQlkZWZhdWx0OiByZXR1cm4gb2JqZWN0OwoJfQp9OwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBBcnJheQoKZGVzY3JpcHRpb246IENvbnRhaW5zIEFycmF5IFByb3RvdHlwZXMgbGlrZSBlYWNoLCBjb250YWlucywgYW5kIGVyYXNlLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IEFycmF5CgouLi4KKi8KCkFycmF5LmltcGxlbWVudCh7CgoJLyo8IUVTNT4qLwoJZXZlcnk6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmICFmbi5jYWxsKGJpbmQsIHRoaXNbaV0sIGksIHRoaXMpKSByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiB0cnVlOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoKGkgaW4gdGhpcykgJiYgZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKSkgcmVzdWx0cy5wdXNoKHRoaXNbaV0pOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJaW5kZXhPZjogZnVuY3Rpb24oaXRlbSwgZnJvbSl7CgkJdmFyIGxlbiA9IHRoaXMubGVuZ3RoOwoJCWZvciAodmFyIGkgPSAoZnJvbSA8IDApID8gTWF0aC5tYXgoMCwgbGVuICsgZnJvbSkgOiBmcm9tIHx8IDA7IGkgPCBsZW47IGkrKyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSByZXR1cm4gaTsKCQl9CgkJcmV0dXJuIC0xOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IFtdOwoJCWZvciAodmFyIGkgPSAwLCBsID0gdGhpcy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQlpZiAoaSBpbiB0aGlzKSByZXN1bHRzW2ldID0gZm4uY2FsbChiaW5kLCB0aGlzW2ldLCBpLCB0aGlzKTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKChpIGluIHRoaXMpICYmIGZuLmNhbGwoYmluZCwgdGhpc1tpXSwgaSwgdGhpcykpIHJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9LAoJLyo8LyFFUzU+Ki8KCgljbGVhbjogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBpdGVtICE9IG51bGw7CgkJfSk7Cgl9LAoKCWludm9rZTogZnVuY3Rpb24obWV0aG9kTmFtZSl7CgkJdmFyIGFyZ3MgPSBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpOwoJCXJldHVybiB0aGlzLm1hcChmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW1bbWV0aG9kTmFtZV0uYXBwbHkoaXRlbSwgYXJncyk7CgkJfSk7Cgl9LAoKCWFzc29jaWF0ZTogZnVuY3Rpb24oa2V5cyl7CgkJdmFyIG9iaiA9IHt9LCBsZW5ndGggPSBNYXRoLm1pbih0aGlzLmxlbmd0aCwga2V5cy5sZW5ndGgpOwoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIG9ialtrZXlzW2ldXSA9IHRoaXNbaV07CgkJcmV0dXJuIG9iajsKCX0sCgoJbGluazogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIgcmVzdWx0ID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQkJaWYgKG9iamVjdFtrZXldKHRoaXNbaV0pKXsKCQkJCQlyZXN1bHRba2V5XSA9IHRoaXNbaV07CgkJCQkJZGVsZXRlIG9iamVjdFtrZXldOwoJCQkJCWJyZWFrOwoJCQkJfQoJCQl9CgkJfQoJCXJldHVybiByZXN1bHQ7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihpdGVtLCBmcm9tKXsKCQlyZXR1cm4gdGhpcy5pbmRleE9mKGl0ZW0sIGZyb20pICE9IC0xOwoJfSwKCglhcHBlbmQ6IGZ1bmN0aW9uKGFycmF5KXsKCQl0aGlzLnB1c2guYXBwbHkodGhpcywgYXJyYXkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRMYXN0OiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1t0aGlzLmxlbmd0aCAtIDFdIDogbnVsbDsKCX0sCgoJZ2V0UmFuZG9tOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5sZW5ndGgpID8gdGhpc1tOdW1iZXIucmFuZG9tKDAsIHRoaXMubGVuZ3RoIC0gMSldIDogbnVsbDsKCX0sCgoJaW5jbHVkZTogZnVuY3Rpb24oaXRlbSl7CgkJaWYgKCF0aGlzLmNvbnRhaW5zKGl0ZW0pKSB0aGlzLnB1c2goaXRlbSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWNvbWJpbmU6IGZ1bmN0aW9uKGFycmF5KXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFycmF5Lmxlbmd0aDsgaSA8IGw7IGkrKykgdGhpcy5pbmNsdWRlKGFycmF5W2ldKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGl0ZW0pewoJCWZvciAodmFyIGkgPSB0aGlzLmxlbmd0aDsgaS0tOyl7CgkJCWlmICh0aGlzW2ldID09PSBpdGVtKSB0aGlzLnNwbGljZShpLCAxKTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVtcHR5OiBmdW5jdGlvbigpewoJCXRoaXMubGVuZ3RoID0gMDsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZmxhdHRlbjogZnVuY3Rpb24oKXsKCQl2YXIgYXJyYXkgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIHR5cGUgPSB0eXBlT2YodGhpc1tpXSk7CgkJCWlmICh0eXBlID09ICdudWxsJykgY29udGludWU7CgkJCWFycmF5ID0gYXJyYXkuY29uY2F0KCh0eXBlID09ICdhcnJheScgfHwgdHlwZSA9PSAnY29sbGVjdGlvbicgfHwgdHlwZSA9PSAnYXJndW1lbnRzJyB8fCBpbnN0YW5jZU9mKHRoaXNbaV0sIEFycmF5KSkgPyBBcnJheS5mbGF0dGVuKHRoaXNbaV0pIDogdGhpc1tpXSk7CgkJfQoJCXJldHVybiBhcnJheTsKCX0sCgoJcGljazogZnVuY3Rpb24oKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IHRoaXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJaWYgKHRoaXNbaV0gIT0gbnVsbCkgcmV0dXJuIHRoaXNbaV07CgkJfQoJCXJldHVybiBudWxsOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCAhPSAzKSByZXR1cm4gbnVsbDsKCQl2YXIgcmdiID0gdGhpcy5tYXAoZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubGVuZ3RoID09IDEpIHZhbHVlICs9IHZhbHVlOwoJCQlyZXR1cm4gdmFsdWUudG9JbnQoMTYpOwoJCX0pOwoJCXJldHVybiAoYXJyYXkpID8gcmdiIDogJ3JnYignICsgcmdiICsgJyknOwoJfSwKCglyZ2JUb0hleDogZnVuY3Rpb24oYXJyYXkpewoJCWlmICh0aGlzLmxlbmd0aCA8IDMpIHJldHVybiBudWxsOwoJCWlmICh0aGlzLmxlbmd0aCA9PSA0ICYmIHRoaXNbM10gPT0gMCAmJiAhYXJyYXkpIHJldHVybiAndHJhbnNwYXJlbnQnOwoJCXZhciBoZXggPSBbXTsKCQlmb3IgKHZhciBpID0gMDsgaSA8IDM7IGkrKyl7CgkJCXZhciBiaXQgPSAodGhpc1tpXSAtIDApLnRvU3RyaW5nKDE2KTsKCQkJaGV4LnB1c2goKGJpdC5sZW5ndGggPT0gMSkgPyAnMCcgKyBiaXQgOiBiaXQpOwoJCX0KCQlyZXR1cm4gKGFycmF5KSA/IGhleCA6ICcjJyArIGhleC5qb2luKCcnKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKQXJyYXkuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCnZhciAkcGljayA9IGZ1bmN0aW9uKCl7CglyZXR1cm4gQXJyYXkuZnJvbShhcmd1bWVudHMpLnBpY2soKTsKfTsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBTdHJpbmcKCmRlc2NyaXB0aW9uOiBDb250YWlucyBTdHJpbmcgUHJvdG90eXBlcyBsaWtlIGNhbWVsQ2FzZSwgY2FwaXRhbGl6ZSwgdGVzdCwgYW5kIHRvSW50LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogVHlwZQoKcHJvdmlkZXM6IFN0cmluZwoKLi4uCiovCgpTdHJpbmcuaW1wbGVtZW50KHsKCgl0ZXN0OiBmdW5jdGlvbihyZWdleCwgcGFyYW1zKXsKCQlyZXR1cm4gKCh0eXBlT2YocmVnZXgpID09ICdyZWdleHAnKSA/IHJlZ2V4IDogbmV3IFJlZ0V4cCgnJyArIHJlZ2V4LCBwYXJhbXMpKS50ZXN0KHRoaXMpOwoJfSwKCgljb250YWluczogZnVuY3Rpb24oc3RyaW5nLCBzZXBhcmF0b3IpewoJCXJldHVybiAoc2VwYXJhdG9yKSA/IChzZXBhcmF0b3IgKyB0aGlzICsgc2VwYXJhdG9yKS5pbmRleE9mKHNlcGFyYXRvciArIHN0cmluZyArIHNlcGFyYXRvcikgPiAtMSA6IHRoaXMuaW5kZXhPZihzdHJpbmcpID4gLTE7Cgl9LAoKCXRyaW06IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCX0sCgoJY2xlYW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvXHMrL2csICcgJykudHJpbSgpOwoJfSwKCgljYW1lbENhc2U6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvLVxEL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLmNoYXJBdCgxKS50b1VwcGVyQ2FzZSgpOwoJCX0pOwoJfSwKCgloeXBoZW5hdGU6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMucmVwbGFjZSgvW0EtWl0vZywgZnVuY3Rpb24obWF0Y2gpewoJCQlyZXR1cm4gKCctJyArIG1hdGNoLmNoYXJBdCgwKS50b0xvd2VyQ2FzZSgpKTsKCQl9KTsKCX0sCgoJY2FwaXRhbGl6ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC9cYlthLXpdL2csIGZ1bmN0aW9uKG1hdGNoKXsKCQkJcmV0dXJuIG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJfSk7Cgl9LAoKCWVzY2FwZVJlZ0V4cDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKC8oWy0uKis/XiR7fSgpfFtcXVwvXFxdKS9nLCAnXFwkMScpOwoJfSwKCgl0b0ludDogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIHBhcnNlSW50KHRoaXMsIGJhc2UgfHwgMTApOwoJfSwKCgl0b0Zsb2F0OiBmdW5jdGlvbigpewoJCXJldHVybiBwYXJzZUZsb2F0KHRoaXMpOwoJfSwKCgloZXhUb1JnYjogZnVuY3Rpb24oYXJyYXkpewoJCXZhciBoZXggPSB0aGlzLm1hdGNoKC9eIz8oXHd7MSwyfSkoXHd7MSwyfSkoXHd7MSwyfSkkLyk7CgkJcmV0dXJuIChoZXgpID8gaGV4LnNsaWNlKDEpLmhleFRvUmdiKGFycmF5KSA6IG51bGw7Cgl9LAoKCXJnYlRvSGV4OiBmdW5jdGlvbihhcnJheSl7CgkJdmFyIHJnYiA9IHRoaXMubWF0Y2goL1xkezEsM30vZyk7CgkJcmV0dXJuIChyZ2IpID8gcmdiLnJnYlRvSGV4KGFycmF5KSA6IG51bGw7Cgl9LAoKCXN1YnN0aXR1dGU6IGZ1bmN0aW9uKG9iamVjdCwgcmVnZXhwKXsKCQlyZXR1cm4gdGhpcy5yZXBsYWNlKHJlZ2V4cCB8fCAoL1xcP1x7KFtee31dKylcfS9nKSwgZnVuY3Rpb24obWF0Y2gsIG5hbWUpewoJCQlpZiAobWF0Y2guY2hhckF0KDApID09ICdcXCcpIHJldHVybiBtYXRjaC5zbGljZSgxKTsKCQkJcmV0dXJuIChvYmplY3RbbmFtZV0gIT0gbnVsbCkgPyBvYmplY3RbbmFtZV0gOiAnJzsKCQl9KTsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogTnVtYmVyCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgTnVtYmVyIFByb3RvdHlwZXMgbGlrZSBsaW1pdCwgcm91bmQsIHRpbWVzLCBhbmQgY2VpbC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBOdW1iZXIKCi4uLgoqLwoKTnVtYmVyLmltcGxlbWVudCh7CgoJbGltaXQ6IGZ1bmN0aW9uKG1pbiwgbWF4KXsKCQlyZXR1cm4gTWF0aC5taW4obWF4LCBNYXRoLm1heChtaW4sIHRoaXMpKTsKCX0sCgoJcm91bmQ6IGZ1bmN0aW9uKHByZWNpc2lvbil7CgkJcHJlY2lzaW9uID0gTWF0aC5wb3coMTAsIHByZWNpc2lvbiB8fCAwKS50b0ZpeGVkKHByZWNpc2lvbiA8IDAgPyAtcHJlY2lzaW9uIDogMCk7CgkJcmV0dXJuIE1hdGgucm91bmQodGhpcyAqIHByZWNpc2lvbikgLyBwcmVjaXNpb247Cgl9LAoKCXRpbWVzOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzOyBpKyspIGZuLmNhbGwoYmluZCwgaSwgdGhpcyk7Cgl9LAoKCXRvRmxvYXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHBhcnNlRmxvYXQodGhpcyk7Cgl9LAoKCXRvSW50OiBmdW5jdGlvbihiYXNlKXsKCQlyZXR1cm4gcGFyc2VJbnQodGhpcywgYmFzZSB8fCAxMCk7Cgl9Cgp9KTsKCk51bWJlci5hbGlhcygnZWFjaCcsICd0aW1lcycpOwoKKGZ1bmN0aW9uKG1hdGgpewoJdmFyIG1ldGhvZHMgPSB7fTsKCW1hdGguZWFjaChmdW5jdGlvbihuYW1lKXsKCQlpZiAoIU51bWJlcltuYW1lXSkgbWV0aG9kc1tuYW1lXSA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBNYXRoW25hbWVdLmFwcGx5KG51bGwsIFt0aGlzXS5jb25jYXQoQXJyYXkuZnJvbShhcmd1bWVudHMpKSk7CgkJfTsKCX0pOwoJTnVtYmVyLmltcGxlbWVudChtZXRob2RzKTsKfSkoWydhYnMnLCAnYWNvcycsICdhc2luJywgJ2F0YW4nLCAnYXRhbjInLCAnY2VpbCcsICdjb3MnLCAnZXhwJywgJ2Zsb29yJywgJ2xvZycsICdtYXgnLCAnbWluJywgJ3BvdycsICdzaW4nLCAnc3FydCcsICd0YW4nXSk7CgoKLyoKLS0tCgpuYW1lOiBGdW5jdGlvbgoKZGVzY3JpcHRpb246IENvbnRhaW5zIEZ1bmN0aW9uIFByb3RvdHlwZXMgbGlrZSBjcmVhdGUsIGJpbmQsIHBhc3MsIGFuZCBkZWxheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFR5cGUKCnByb3ZpZGVzOiBGdW5jdGlvbgoKLi4uCiovCgpGdW5jdGlvbi5leHRlbmQoewoKCWF0dGVtcHQ6IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdHJ5IHsKCQkJCXJldHVybiBhcmd1bWVudHNbaV0oKTsKCQkJfSBjYXRjaCAoZSl7fQoJCX0KCQlyZXR1cm4gbnVsbDsKCX0KCn0pOwoKRnVuY3Rpb24uaW1wbGVtZW50KHsKCglhdHRlbXB0OiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5hcHBseShiaW5kLCBBcnJheS5mcm9tKGFyZ3MpKTsKCQl9IGNhdGNoIChlKXt9CgkJCgkJcmV0dXJuIG51bGw7Cgl9LAoKCS8qPCFFUzU+Ki8KCWJpbmQ6IGZ1bmN0aW9uKGJpbmQpewoJCXZhciBzZWxmID0gdGhpcywKCQkJYXJncyA9IChhcmd1bWVudHMubGVuZ3RoID4gMSkgPyBBcnJheS5zbGljZShhcmd1bWVudHMsIDEpIDogbnVsbDsKCQkKCQlyZXR1cm4gZnVuY3Rpb24oKXsKCQkJaWYgKCFhcmdzICYmICFhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5jYWxsKGJpbmQpOwoJCQlpZiAoYXJncyAmJiBhcmd1bWVudHMubGVuZ3RoKSByZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzLmNvbmNhdChBcnJheS5mcm9tKGFyZ3VtZW50cykpKTsKCQkJcmV0dXJuIHNlbGYuYXBwbHkoYmluZCwgYXJncyB8fCBhcmd1bWVudHMpOwoJCX07Cgl9LAoJLyo8LyFFUzU+Ki8KCglwYXNzOiBmdW5jdGlvbihhcmdzLCBiaW5kKXsKCQl2YXIgc2VsZiA9IHRoaXM7CgkJaWYgKGFyZ3MgIT0gbnVsbCkgYXJncyA9IEFycmF5LmZyb20oYXJncyk7CgkJcmV0dXJuIGZ1bmN0aW9uKCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIGFyZ3MgfHwgYXJndW1lbnRzKTsKCQl9OwoJfSwKCglkZWxheTogZnVuY3Rpb24oZGVsYXksIGJpbmQsIGFyZ3MpewoJCXJldHVybiBzZXRUaW1lb3V0KHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIGRlbGF5KTsKCX0sCgoJcGVyaW9kaWNhbDogZnVuY3Rpb24ocGVyaW9kaWNhbCwgYmluZCwgYXJncyl7CgkJcmV0dXJuIHNldEludGVydmFsKHRoaXMucGFzcygoYXJncyA9PSBudWxsID8gW10gOiBhcmdzKSwgYmluZCksIHBlcmlvZGljYWwpOwoJfQoKfSk7CgovLzwxLjJjb21wYXQ+CgpkZWxldGUgRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CgpGdW5jdGlvbi5pbXBsZW1lbnQoewoKCWNyZWF0ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXZhciBhcmdzID0gb3B0aW9ucy5hcmd1bWVudHM7CgkJCWFyZ3MgPSAoYXJncyAhPSBudWxsKSA/IEFycmF5LmZyb20oYXJncykgOiBBcnJheS5zbGljZShhcmd1bWVudHMsIChvcHRpb25zLmV2ZW50KSA/IDEgOiAwKTsKCQkJaWYgKG9wdGlvbnMuZXZlbnQpIGFyZ3MgPSBbZXZlbnQgfHwgd2luZG93LmV2ZW50XS5leHRlbmQoYXJncyk7CgkJCXZhciByZXR1cm5zID0gZnVuY3Rpb24oKXsKCQkJCXJldHVybiBzZWxmLmFwcGx5KG9wdGlvbnMuYmluZCB8fCBudWxsLCBhcmdzKTsKCQkJfTsKCQkJaWYgKG9wdGlvbnMuZGVsYXkpIHJldHVybiBzZXRUaW1lb3V0KHJldHVybnMsIG9wdGlvbnMuZGVsYXkpOwoJCQlpZiAob3B0aW9ucy5wZXJpb2RpY2FsKSByZXR1cm4gc2V0SW50ZXJ2YWwocmV0dXJucywgb3B0aW9ucy5wZXJpb2RpY2FsKTsKCQkJaWYgKG9wdGlvbnMuYXR0ZW1wdCkgcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQocmV0dXJucyk7CgkJCXJldHVybiByZXR1cm5zKCk7CgkJfTsKCX0sCgoJYmluZDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbigpewoJCQlyZXR1cm4gc2VsZi5hcHBseShiaW5kLCBhcmdzIHx8IGFyZ3VtZW50cyk7CgkJfTsKCX0sCgoJYmluZFdpdGhFdmVudDogZnVuY3Rpb24oYmluZCwgYXJncyl7CgkJdmFyIHNlbGYgPSB0aGlzOwoJCWlmIChhcmdzICE9IG51bGwpIGFyZ3MgPSBBcnJheS5mcm9tKGFyZ3MpOwoJCXJldHVybiBmdW5jdGlvbihldmVudCl7CgkJCXJldHVybiBzZWxmLmFwcGx5KGJpbmQsIChhcmdzID09IG51bGwpID8gYXJndW1lbnRzIDogW2V2ZW50XS5jb25jYXQoYXJncykpOwoJCX07Cgl9LAoKCXJ1bjogZnVuY3Rpb24oYXJncywgYmluZCl7CgkJcmV0dXJuIHRoaXMuYXBwbHkoYmluZCwgQXJyYXkuZnJvbShhcmdzKSk7Cgl9Cgp9KTsKCnZhciAkdHJ5ID0gRnVuY3Rpb24uYXR0ZW1wdDsKCi8vPC8xLjJjb21wYXQ+CgoKLyoKLS0tCgpuYW1lOiBPYmplY3QKCmRlc2NyaXB0aW9uOiBPYmplY3QgZ2VuZXJpYyBtZXRob2RzCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBUeXBlCgpwcm92aWRlczogW09iamVjdCwgSGFzaF0KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgaGFzT3duUHJvcGVydHkgPSBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5OwoKT2JqZWN0LmV4dGVuZCh7CgoJc3Vic2V0OiBmdW5jdGlvbihvYmplY3QsIGtleXMpewoJCXZhciByZXN1bHRzID0ge307CgkJZm9yICh2YXIgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBrID0ga2V5c1tpXTsKCQkJaWYgKGsgaW4gb2JqZWN0KSByZXN1bHRzW2tdID0gb2JqZWN0W2tdOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJbWFwOiBmdW5jdGlvbihvYmplY3QsIGZuLCBiaW5kKXsKCQl2YXIgcmVzdWx0cyA9IHt9OwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIHJlc3VsdHNba2V5XSA9IGZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSwgb2JqZWN0KTsKCQl9CgkJcmV0dXJuIHJlc3VsdHM7Cgl9LAoKCWZpbHRlcjogZnVuY3Rpb24ob2JqZWN0LCBmbiwgYmluZCl7CgkJdmFyIHJlc3VsdHMgPSB7fTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJCWlmIChoYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwga2V5KSAmJiBmbi5jYWxsKGJpbmQsIHZhbHVlLCBrZXksIG9iamVjdCkpIHJlc3VsdHNba2V5XSA9IHZhbHVlOwoJCX0KCQlyZXR1cm4gcmVzdWx0czsKCX0sCgoJZXZlcnk6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgIWZuLmNhbGwoYmluZCwgb2JqZWN0W2tleV0sIGtleSkpIHJldHVybiBmYWxzZTsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9LAoKCXNvbWU6IGZ1bmN0aW9uKG9iamVjdCwgZm4sIGJpbmQpewoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkgJiYgZm4uY2FsbChiaW5kLCBvYmplY3Rba2V5XSwga2V5KSkgcmV0dXJuIHRydWU7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJa2V5czogZnVuY3Rpb24ob2JqZWN0KXsKCQl2YXIga2V5cyA9IFtdOwoJCWZvciAodmFyIGtleSBpbiBvYmplY3QpewoJCQlpZiAoaGFzT3duUHJvcGVydHkuY2FsbChvYmplY3QsIGtleSkpIGtleXMucHVzaChrZXkpOwoJCX0KCQlyZXR1cm4ga2V5czsKCX0sCgoJdmFsdWVzOiBmdW5jdGlvbihvYmplY3QpewoJCXZhciB2YWx1ZXMgPSBbXTsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpKSB2YWx1ZXMucHVzaChvYmplY3Rba2V5XSk7CgkJfQoJCXJldHVybiB2YWx1ZXM7Cgl9LAoKCWdldExlbmd0aDogZnVuY3Rpb24ob2JqZWN0KXsKCQlyZXR1cm4gT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGg7Cgl9LAoKCWtleU9mOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlmb3IgKHZhciBrZXkgaW4gb2JqZWN0KXsKCQkJaWYgKGhhc093blByb3BlcnR5LmNhbGwob2JqZWN0LCBrZXkpICYmIG9iamVjdFtrZXldID09PSB2YWx1ZSkgcmV0dXJuIGtleTsKCQl9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWNvbnRhaW5zOiBmdW5jdGlvbihvYmplY3QsIHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKG9iamVjdCwgdmFsdWUpICE9IG51bGw7Cgl9LAoKCXRvUXVlcnlTdHJpbmc6IGZ1bmN0aW9uKG9iamVjdCwgYmFzZSl7CgkJdmFyIHF1ZXJ5U3RyaW5nID0gW107CgoJCU9iamVjdC5lYWNoKG9iamVjdCwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCWlmIChiYXNlKSBrZXkgPSBiYXNlICsgJ1snICsga2V5ICsgJ10nOwoJCQl2YXIgcmVzdWx0OwoJCQlzd2l0Y2ggKHR5cGVPZih2YWx1ZSkpewoJCQkJY2FzZSAnb2JqZWN0JzogcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFsdWUsIGtleSk7IGJyZWFrOwoJCQkJY2FzZSAnYXJyYXknOgoJCQkJCXZhciBxcyA9IHt9OwoJCQkJCXZhbHVlLmVhY2goZnVuY3Rpb24odmFsLCBpKXsKCQkJCQkJcXNbaV0gPSB2YWw7CgkJCQkJfSk7CgkJCQkJcmVzdWx0ID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcocXMsIGtleSk7CgkJCQlicmVhazsKCQkJCWRlZmF1bHQ6IHJlc3VsdCA9IGtleSArICc9JyArIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJCX0KCQkJaWYgKHZhbHVlICE9IG51bGwpIHF1ZXJ5U3RyaW5nLnB1c2gocmVzdWx0KTsKCQl9KTsKCgkJcmV0dXJuIHF1ZXJ5U3RyaW5nLmpvaW4oJyYnKTsKCX0KCn0pOwoKfSkoKTsKCi8vPDEuMmNvbXBhdD4KCkhhc2guaW1wbGVtZW50KHsKCgloYXM6IE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHksCgoJa2V5T2Y6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmtleU9mKHRoaXMsIHZhbHVlKTsKCX0sCgoJaGFzVmFsdWU6IGZ1bmN0aW9uKHZhbHVlKXsKCQlyZXR1cm4gT2JqZWN0LmNvbnRhaW5zKHRoaXMsIHZhbHVlKTsKCX0sCgoJZXh0ZW5kOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guc2V0KHRoaXMsIGtleSwgdmFsdWUpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljb21iaW5lOiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlIYXNoLmVhY2gocHJvcGVydGllcyB8fCB7fSwgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCUhhc2guaW5jbHVkZSh0aGlzLCBrZXksIHZhbHVlKTsKCQl9LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKGtleSl7CgkJaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoa2V5KSkgZGVsZXRlIHRoaXNba2V5XTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbihrZXkpewoJCXJldHVybiAodGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSA/IHRoaXNba2V5XSA6IG51bGw7Cgl9LAoKCXNldDogZnVuY3Rpb24oa2V5LCB2YWx1ZSl7CgkJaWYgKCF0aGlzW2tleV0gfHwgdGhpcy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB0aGlzW2tleV0gPSB2YWx1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJSGFzaC5lYWNoKHRoaXMsIGZ1bmN0aW9uKHZhbHVlLCBrZXkpewoJCQlkZWxldGUgdGhpc1trZXldOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmNsdWRlOiBmdW5jdGlvbihrZXksIHZhbHVlKXsKCQlpZiAodGhpc1trZXldID09IG51bGwpIHRoaXNba2V5XSA9IHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCgltYXA6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0Lm1hcCh0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglmaWx0ZXI6IGZ1bmN0aW9uKGZuLCBiaW5kKXsKCQlyZXR1cm4gbmV3IEhhc2goT2JqZWN0LmZpbHRlcih0aGlzLCBmbiwgYmluZCkpOwoJfSwKCglldmVyeTogZnVuY3Rpb24oZm4sIGJpbmQpewoJCXJldHVybiBPYmplY3QuZXZlcnkodGhpcywgZm4sIGJpbmQpOwoJfSwKCglzb21lOiBmdW5jdGlvbihmbiwgYmluZCl7CgkJcmV0dXJuIE9iamVjdC5zb21lKHRoaXMsIGZuLCBiaW5kKTsKCX0sCgoJZ2V0S2V5czogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LmtleXModGhpcyk7Cgl9LAoKCWdldFZhbHVlczogZnVuY3Rpb24oKXsKCQlyZXR1cm4gT2JqZWN0LnZhbHVlcyh0aGlzKTsKCX0sCgoJdG9RdWVyeVN0cmluZzogZnVuY3Rpb24oYmFzZSl7CgkJcmV0dXJuIE9iamVjdC50b1F1ZXJ5U3RyaW5nKHRoaXMsIGJhc2UpOwoJfQoKfSk7CgpIYXNoLmV4dGVuZCA9IE9iamVjdC5hcHBlbmQ7CgpIYXNoLmFsaWFzKHtpbmRleE9mOiAna2V5T2YnLCBjb250YWluczogJ2hhc1ZhbHVlJ30pOwoKLy88LzEuMmNvbXBhdD4KCgovKgotLS0KCm5hbWU6IEJyb3dzZXIKCmRlc2NyaXB0aW9uOiBUaGUgQnJvd3NlciBPYmplY3QuIENvbnRhaW5zIEJyb3dzZXIgaW5pdGlhbGl6YXRpb24sIFdpbmRvdyBhbmQgRG9jdW1lbnQsIGFuZCB0aGUgQnJvd3NlciBIYXNoLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0FycmF5LCBGdW5jdGlvbiwgTnVtYmVyLCBTdHJpbmddCgpwcm92aWRlczogW0Jyb3dzZXIsIFdpbmRvdywgRG9jdW1lbnRdCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGRvY3VtZW50ID0gdGhpcy5kb2N1bWVudDsKdmFyIHdpbmRvdyA9IGRvY3VtZW50LndpbmRvdyA9IHRoaXM7Cgp2YXIgVUlEID0gMTsKCnRoaXMuJHVpZCA9ICh3aW5kb3cuQWN0aXZlWE9iamVjdCkgPyBmdW5jdGlvbihpdGVtKXsKCXJldHVybiAoaXRlbS51aWQgfHwgKGl0ZW0udWlkID0gW1VJRCsrXSkpWzBdOwp9IDogZnVuY3Rpb24oaXRlbSl7CglyZXR1cm4gaXRlbS51aWQgfHwgKGl0ZW0udWlkID0gVUlEKyspOwp9OwoKJHVpZCh3aW5kb3cpOwokdWlkKGRvY3VtZW50KTsKCnZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKSwKCXBsYXRmb3JtID0gbmF2aWdhdG9yLnBsYXRmb3JtLnRvTG93ZXJDYXNlKCksCglVQSA9IHVhLm1hdGNoKC8ob3BlcmF8aWV8ZmlyZWZveHxjaHJvbWV8dmVyc2lvbilbXHNcLzpdKFtcd1xkXC5dKyk/Lio/KHNhZmFyaXx2ZXJzaW9uW1xzXC86XShbXHdcZFwuXSspfCQpLykgfHwgW251bGwsICd1bmtub3duJywgMF0sCgltb2RlID0gVUFbMV0gPT0gJ2llJyAmJiBkb2N1bWVudC5kb2N1bWVudE1vZGU7Cgp2YXIgQnJvd3NlciA9IHRoaXMuQnJvd3NlciA9IHsKCglleHRlbmQ6IEZ1bmN0aW9uLnByb3RvdHlwZS5leHRlbmQsCgoJbmFtZTogKFVBWzFdID09ICd2ZXJzaW9uJykgPyBVQVszXSA6IFVBWzFdLAoKCXZlcnNpb246IG1vZGUgfHwgcGFyc2VGbG9hdCgoVUFbMV0gPT0gJ29wZXJhJyAmJiBVQVs0XSkgPyBVQVs0XSA6IFVBWzJdKSwKCglQbGF0Zm9ybTogewoJCW5hbWU6IHVhLm1hdGNoKC9pcCg/OmFkfG9kfGhvbmUpLykgPyAnaW9zJyA6ICh1YS5tYXRjaCgvKD86d2Vib3N8YW5kcm9pZCkvKSB8fCBwbGF0Zm9ybS5tYXRjaCgvbWFjfHdpbnxsaW51eC8pIHx8IFsnb3RoZXInXSlbMF0KCX0sCgoJRmVhdHVyZXM6IHsKCQl4cGF0aDogISEoZG9jdW1lbnQuZXZhbHVhdGUpLAoJCWFpcjogISEod2luZG93LnJ1bnRpbWUpLAoJCXF1ZXJ5OiAhIShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKSwKCQlqc29uOiAhISh3aW5kb3cuSlNPTikKCX0sCgoJUGx1Z2luczoge30KCn07CgpCcm93c2VyW0Jyb3dzZXIubmFtZV0gPSB0cnVlOwpCcm93c2VyW0Jyb3dzZXIubmFtZSArIHBhcnNlSW50KEJyb3dzZXIudmVyc2lvbiwgMTApXSA9IHRydWU7CkJyb3dzZXIuUGxhdGZvcm1bQnJvd3Nlci5QbGF0Zm9ybS5uYW1lXSA9IHRydWU7CgovLyBSZXF1ZXN0CgpCcm93c2VyLlJlcXVlc3QgPSAoZnVuY3Rpb24oKXsKCgl2YXIgWE1MSFRUUCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBYTUxIdHRwUmVxdWVzdCgpOwoJfTsKCgl2YXIgTVNYTUwyID0gZnVuY3Rpb24oKXsKCQlyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ01TWE1MMi5YTUxIVFRQJyk7Cgl9OwoKCXZhciBNU1hNTCA9IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIG5ldyBBY3RpdmVYT2JqZWN0KCdNaWNyb3NvZnQuWE1MSFRUUCcpOwoJfTsKCglyZXR1cm4gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCVhNTEhUVFAoKTsKCQlyZXR1cm4gWE1MSFRUUDsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwyKCk7CgkJcmV0dXJuIE1TWE1MMjsKCX0sIGZ1bmN0aW9uKCl7CgkJTVNYTUwoKTsKCQlyZXR1cm4gTVNYTUw7Cgl9KTsKCn0pKCk7CgpCcm93c2VyLkZlYXR1cmVzLnhociA9ICEhKEJyb3dzZXIuUmVxdWVzdCk7CgovLyBGbGFzaCBkZXRlY3Rpb24KCnZhciB2ZXJzaW9uID0gKEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCXJldHVybiBuYXZpZ2F0b3IucGx1Z2luc1snU2hvY2t3YXZlIEZsYXNoJ10uZGVzY3JpcHRpb247Cn0sIGZ1bmN0aW9uKCl7CglyZXR1cm4gbmV3IEFjdGl2ZVhPYmplY3QoJ1Nob2Nrd2F2ZUZsYXNoLlNob2Nrd2F2ZUZsYXNoJykuR2V0VmFyaWFibGUoJyR2ZXJzaW9uJyk7Cn0pIHx8ICcwIHIwJykubWF0Y2goL1xkKy9nKTsKCkJyb3dzZXIuUGx1Z2lucy5GbGFzaCA9IHsKCXZlcnNpb246IE51bWJlcih2ZXJzaW9uWzBdIHx8ICcwLicgKyB2ZXJzaW9uWzFdKSB8fCAwLAoJYnVpbGQ6IE51bWJlcih2ZXJzaW9uWzJdKSB8fCAwCn07CgovLyBTdHJpbmcgc2NyaXB0cwoKQnJvd3Nlci5leGVjID0gZnVuY3Rpb24odGV4dCl7CglpZiAoIXRleHQpIHJldHVybiB0ZXh0OwoJaWYgKHdpbmRvdy5leGVjU2NyaXB0KXsKCQl3aW5kb3cuZXhlY1NjcmlwdCh0ZXh0KTsKCX0gZWxzZSB7CgkJdmFyIHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCXNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAndGV4dC9qYXZhc2NyaXB0Jyk7CgkJc2NyaXB0LnRleHQgPSB0ZXh0OwoJCWRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQlkb2N1bWVudC5oZWFkLnJlbW92ZUNoaWxkKHNjcmlwdCk7Cgl9CglyZXR1cm4gdGV4dDsKfTsKClN0cmluZy5pbXBsZW1lbnQoJ3N0cmlwU2NyaXB0cycsIGZ1bmN0aW9uKGV4ZWMpewoJdmFyIHNjcmlwdHMgPSAnJzsKCXZhciB0ZXh0ID0gdGhpcy5yZXBsYWNlKC88c2NyaXB0W14+XSo+KFtcc1xTXSo/KTxcL3NjcmlwdD4vZ2ksIGZ1bmN0aW9uKGFsbCwgY29kZSl7CgkJc2NyaXB0cyArPSBjb2RlICsgJ1xuJzsKCQlyZXR1cm4gJyc7Cgl9KTsKCWlmIChleGVjID09PSB0cnVlKSBCcm93c2VyLmV4ZWMoc2NyaXB0cyk7CgllbHNlIGlmICh0eXBlT2YoZXhlYykgPT0gJ2Z1bmN0aW9uJykgZXhlYyhzY3JpcHRzLCB0ZXh0KTsKCXJldHVybiB0ZXh0Owp9KTsKCi8vIFdpbmRvdywgRG9jdW1lbnQKCkJyb3dzZXIuZXh0ZW5kKHsKCURvY3VtZW50OiB0aGlzLkRvY3VtZW50LAoJV2luZG93OiB0aGlzLldpbmRvdywKCUVsZW1lbnQ6IHRoaXMuRWxlbWVudCwKCUV2ZW50OiB0aGlzLkV2ZW50Cn0pOwoKdGhpcy5XaW5kb3cgPSB0aGlzLiRjb25zdHJ1Y3RvciA9IG5ldyBUeXBlKCdXaW5kb3cnLCBmdW5jdGlvbigpe30pOwoKdGhpcy4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnd2luZG93JykuaGlkZSgpOwoKV2luZG93Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJd2luZG93W25hbWVdID0gbWV0aG9kOwp9KTsKCnRoaXMuRG9jdW1lbnQgPSBkb2N1bWVudC4kY29uc3RydWN0b3IgPSBuZXcgVHlwZSgnRG9jdW1lbnQnLCBmdW5jdGlvbigpe30pOwoKZG9jdW1lbnQuJGZhbWlseSA9IEZ1bmN0aW9uLmZyb20oJ2RvY3VtZW50JykuaGlkZSgpOwoKRG9jdW1lbnQubWlycm9yKGZ1bmN0aW9uKG5hbWUsIG1ldGhvZCl7Cglkb2N1bWVudFtuYW1lXSA9IG1ldGhvZDsKfSk7Cgpkb2N1bWVudC5odG1sID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwppZiAoIWRvY3VtZW50LmhlYWQpIGRvY3VtZW50LmhlYWQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnaGVhZCcpWzBdOwoKaWYgKGRvY3VtZW50LmV4ZWNDb21tYW5kKSB0cnkgewoJZG9jdW1lbnQuZXhlY0NvbW1hbmQoIkJhY2tncm91bmRJbWFnZUNhY2hlIiwgZmFsc2UsIHRydWUpOwp9IGNhdGNoIChlKXt9CgovKjxsdElFOT4qLwppZiAodGhpcy5hdHRhY2hFdmVudCAmJiAhdGhpcy5hZGRFdmVudExpc3RlbmVyKXsKCXZhciB1bmxvYWRFdmVudCA9IGZ1bmN0aW9uKCl7CgkJdGhpcy5kZXRhY2hFdmVudCgnb251bmxvYWQnLCB1bmxvYWRFdmVudCk7CgkJZG9jdW1lbnQuaGVhZCA9IGRvY3VtZW50Lmh0bWwgPSBkb2N1bWVudC53aW5kb3cgPSBudWxsOwoJfTsKCXRoaXMuYXR0YWNoRXZlbnQoJ29udW5sb2FkJywgdW5sb2FkRXZlbnQpOwp9CgovLyBJRSBmYWlscyBvbiBjb2xsZWN0aW9ucyBhbmQgPHNlbGVjdD4ub3B0aW9ucyAocmVmZXJzIHRvIDxzZWxlY3Q+KQp2YXIgYXJyYXlGcm9tID0gQXJyYXkuZnJvbTsKdHJ5IHsKCWFycmF5RnJvbShkb2N1bWVudC5odG1sLmNoaWxkTm9kZXMpOwp9IGNhdGNoKGUpewoJQXJyYXkuZnJvbSA9IGZ1bmN0aW9uKGl0ZW0pewoJCWlmICh0eXBlb2YgaXRlbSAhPSAnc3RyaW5nJyAmJiBUeXBlLmlzRW51bWVyYWJsZShpdGVtKSAmJiB0eXBlT2YoaXRlbSkgIT0gJ2FycmF5Jyl7CgkJCXZhciBpID0gaXRlbS5sZW5ndGgsIGFycmF5ID0gbmV3IEFycmF5KGkpOwoJCQl3aGlsZSAoaS0tKSBhcnJheVtpXSA9IGl0ZW1baV07CgkJCXJldHVybiBhcnJheTsKCQl9CgkJcmV0dXJuIGFycmF5RnJvbShpdGVtKTsKCX07CgoJdmFyIHByb3RvdHlwZSA9IEFycmF5LnByb3RvdHlwZSwKCQlzbGljZSA9IHByb3RvdHlwZS5zbGljZTsKCVsncG9wJywgJ3B1c2gnLCAncmV2ZXJzZScsICdzaGlmdCcsICdzb3J0JywgJ3NwbGljZScsICd1bnNoaWZ0JywgJ2NvbmNhdCcsICdqb2luJywgJ3NsaWNlJ10uZWFjaChmdW5jdGlvbihuYW1lKXsKCQl2YXIgbWV0aG9kID0gcHJvdG90eXBlW25hbWVdOwoJCUFycmF5W25hbWVdID0gZnVuY3Rpb24oaXRlbSl7CgkJCXJldHVybiBtZXRob2QuYXBwbHkoQXJyYXkuZnJvbShpdGVtKSwgc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpKTsKCQl9OwoJfSk7Cn0KLyo8L2x0SUU5PiovCgovLzwxLjJjb21wYXQ+CgppZiAoQnJvd3Nlci5QbGF0Zm9ybS5pb3MpIEJyb3dzZXIuUGxhdGZvcm0uaXBvZCA9IHRydWU7CgpCcm93c2VyLkVuZ2luZSA9IHt9OwoKdmFyIHNldEVuZ2luZSA9IGZ1bmN0aW9uKG5hbWUsIHZlcnNpb24pewoJQnJvd3Nlci5FbmdpbmUubmFtZSA9IG5hbWU7CglCcm93c2VyLkVuZ2luZVtuYW1lICsgdmVyc2lvbl0gPSB0cnVlOwoJQnJvd3Nlci5FbmdpbmUudmVyc2lvbiA9IHZlcnNpb247Cn07CgppZiAoQnJvd3Nlci5pZSl7CglCcm93c2VyLkVuZ2luZS50cmlkZW50ID0gdHJ1ZTsKCglzd2l0Y2ggKEJyb3dzZXIudmVyc2lvbil7CgkJY2FzZSA2OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA0KTsgYnJlYWs7CgkJY2FzZSA3OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA1KTsgYnJlYWs7CgkJY2FzZSA4OiBzZXRFbmdpbmUoJ3RyaWRlbnQnLCA2KTsKCX0KfQoKaWYgKEJyb3dzZXIuZmlyZWZveCl7CglCcm93c2VyLkVuZ2luZS5nZWNrbyA9IHRydWU7CgoJaWYgKEJyb3dzZXIudmVyc2lvbiA+PSAzKSBzZXRFbmdpbmUoJ2dlY2tvJywgMTkpOwoJZWxzZSBzZXRFbmdpbmUoJ2dlY2tvJywgMTgpOwp9CgppZiAoQnJvd3Nlci5zYWZhcmkgfHwgQnJvd3Nlci5jaHJvbWUpewoJQnJvd3Nlci5FbmdpbmUud2Via2l0ID0gdHJ1ZTsKCglzd2l0Y2ggKEJyb3dzZXIudmVyc2lvbil7CgkJY2FzZSAyOiBzZXRFbmdpbmUoJ3dlYmtpdCcsIDQxOSk7IGJyZWFrOwoJCWNhc2UgMzogc2V0RW5naW5lKCd3ZWJraXQnLCA0MjApOyBicmVhazsKCQljYXNlIDQ6IHNldEVuZ2luZSgnd2Via2l0JywgNTI1KTsKCX0KfQoKaWYgKEJyb3dzZXIub3BlcmEpewoJQnJvd3Nlci5FbmdpbmUucHJlc3RvID0gdHJ1ZTsKCglpZiAoQnJvd3Nlci52ZXJzaW9uID49IDkuNikgc2V0RW5naW5lKCdwcmVzdG8nLCA5NjApOwoJZWxzZSBpZiAoQnJvd3Nlci52ZXJzaW9uID49IDkuNSkgc2V0RW5naW5lKCdwcmVzdG8nLCA5NTApOwoJZWxzZSBzZXRFbmdpbmUoJ3ByZXN0bycsIDkyNSk7Cn0KCmlmIChCcm93c2VyLm5hbWUgPT0gJ3Vua25vd24nKXsKCXN3aXRjaCAoKHVhLm1hdGNoKC8oPzp3ZWJraXR8a2h0bWx8Z2Vja28pLykgfHwgW10pWzBdKXsKCQljYXNlICd3ZWJraXQnOgoJCWNhc2UgJ2todG1sJzoKCQkJQnJvd3Nlci5FbmdpbmUud2Via2l0ID0gdHJ1ZTsKCQlicmVhazsKCQljYXNlICdnZWNrbyc6CgkJCUJyb3dzZXIuRW5naW5lLmdlY2tvID0gdHJ1ZTsKCX0KfQoKdGhpcy4kZXhlYyA9IEJyb3dzZXIuZXhlYzsKCi8vPC8xLjJjb21wYXQ+Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgRXZlbnQgQ2xhc3MsIHRvIG1ha2UgdGhlIGV2ZW50IG9iamVjdCBjcm9zcy1icm93c2VyLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW1dpbmRvdywgRG9jdW1lbnQsIEFycmF5LCBGdW5jdGlvbiwgU3RyaW5nLCBPYmplY3RdCgpwcm92aWRlczogRXZlbnQKCi4uLgoqLwoKdmFyIEV2ZW50ID0gbmV3IFR5cGUoJ0V2ZW50JywgZnVuY3Rpb24oZXZlbnQsIHdpbil7CglpZiAoIXdpbikgd2luID0gd2luZG93OwoJdmFyIGRvYyA9IHdpbi5kb2N1bWVudDsKCWV2ZW50ID0gZXZlbnQgfHwgd2luLmV2ZW50OwoJaWYgKGV2ZW50LiRleHRlbmRlZCkgcmV0dXJuIGV2ZW50OwoJdGhpcy4kZXh0ZW5kZWQgPSB0cnVlOwoJdmFyIHR5cGUgPSBldmVudC50eXBlLAoJCXRhcmdldCA9IGV2ZW50LnRhcmdldCB8fCBldmVudC5zcmNFbGVtZW50LAoJCXBhZ2UgPSB7fSwKCQljbGllbnQgPSB7fSwKCQlyZWxhdGVkID0gbnVsbCwKCQlyaWdodENsaWNrLCB3aGVlbCwgY29kZSwga2V5OwoJd2hpbGUgKHRhcmdldCAmJiB0YXJnZXQubm9kZVR5cGUgPT0gMykgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgoJaWYgKHR5cGUuaW5kZXhPZigna2V5JykgIT0gLTEpewoJCWNvZGUgPSBldmVudC53aGljaCB8fCBldmVudC5rZXlDb2RlOwoJCWtleSA9IE9iamVjdC5rZXlPZihFdmVudC5LZXlzLCBjb2RlKTsKCQlpZiAodHlwZSA9PSAna2V5ZG93bicpewoJCQl2YXIgZktleSA9IGNvZGUgLSAxMTE7CgkJCWlmIChmS2V5ID4gMCAmJiBmS2V5IDwgMTMpIGtleSA9ICdmJyArIGZLZXk7CgkJfQoJCWlmICgha2V5KSBrZXkgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKGNvZGUpLnRvTG93ZXJDYXNlKCk7Cgl9IGVsc2UgaWYgKCgvY2xpY2t8bW91c2V8bWVudS9pKS50ZXN0KHR5cGUpKXsKCQlkb2MgPSAoIWRvYy5jb21wYXRNb2RlIHx8IGRvYy5jb21wYXRNb2RlID09ICdDU1MxQ29tcGF0JykgPyBkb2MuaHRtbCA6IGRvYy5ib2R5OwoJCXBhZ2UgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIDogZXZlbnQuY2xpZW50WCArIGRvYy5zY3JvbGxMZWZ0LAoJCQl5OiAoZXZlbnQucGFnZVkgIT0gbnVsbCkgPyBldmVudC5wYWdlWSA6IGV2ZW50LmNsaWVudFkgKyBkb2Muc2Nyb2xsVG9wCgkJfTsKCQljbGllbnQgPSB7CgkJCXg6IChldmVudC5wYWdlWCAhPSBudWxsKSA/IGV2ZW50LnBhZ2VYIC0gd2luLnBhZ2VYT2Zmc2V0IDogZXZlbnQuY2xpZW50WCwKCQkJeTogKGV2ZW50LnBhZ2VZICE9IG51bGwpID8gZXZlbnQucGFnZVkgLSB3aW4ucGFnZVlPZmZzZXQgOiBldmVudC5jbGllbnRZCgkJfTsKCQlpZiAoKC9ET01Nb3VzZVNjcm9sbHxtb3VzZXdoZWVsLykudGVzdCh0eXBlKSl7CgkJCXdoZWVsID0gKGV2ZW50LndoZWVsRGVsdGEpID8gZXZlbnQud2hlZWxEZWx0YSAvIDEyMCA6IC0oZXZlbnQuZGV0YWlsIHx8IDApIC8gMzsKCQl9CgkJcmlnaHRDbGljayA9IChldmVudC53aGljaCA9PSAzKSB8fCAoZXZlbnQuYnV0dG9uID09IDIpOwoJCWlmICgoL292ZXJ8b3V0LykudGVzdCh0eXBlKSl7CgkJCXJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0IHx8IGV2ZW50Wyh0eXBlID09ICdtb3VzZW92ZXInID8gJ2Zyb20nIDogJ3RvJykgKyAnRWxlbWVudCddOwoJCQl2YXIgdGVzdFJlbGF0ZWQgPSBmdW5jdGlvbigpewoJCQkJd2hpbGUgKHJlbGF0ZWQgJiYgcmVsYXRlZC5ub2RlVHlwZSA9PSAzKSByZWxhdGVkID0gcmVsYXRlZC5wYXJlbnROb2RlOwoJCQkJcmV0dXJuIHRydWU7CgkJCX07CgkJCXZhciBoYXNSZWxhdGVkID0gKEJyb3dzZXIuZmlyZWZveDIpID8gdGVzdFJlbGF0ZWQuYXR0ZW1wdCgpIDogdGVzdFJlbGF0ZWQoKTsKCQkJcmVsYXRlZCA9IChoYXNSZWxhdGVkKSA/IHJlbGF0ZWQgOiBudWxsOwoJCX0KCX0gZWxzZSBpZiAoKC9nZXN0dXJlfHRvdWNoL2kpLnRlc3QodHlwZSkpewoJCXRoaXMucm90YXRpb24gPSBldmVudC5yb3RhdGlvbjsKCQl0aGlzLnNjYWxlID0gZXZlbnQuc2NhbGU7CgkJdGhpcy50YXJnZXRUb3VjaGVzID0gZXZlbnQudGFyZ2V0VG91Y2hlczsKCQl0aGlzLmNoYW5nZWRUb3VjaGVzID0gZXZlbnQuY2hhbmdlZFRvdWNoZXM7CgkJdmFyIHRvdWNoZXMgPSB0aGlzLnRvdWNoZXMgPSBldmVudC50b3VjaGVzOwoJCWlmICh0b3VjaGVzICYmIHRvdWNoZXNbMF0pewoJCQl2YXIgdG91Y2ggPSB0b3VjaGVzWzBdOwoJCQlwYWdlID0ge3g6IHRvdWNoLnBhZ2VYLCB5OiB0b3VjaC5wYWdlWX07CgkJCWNsaWVudCA9IHt4OiB0b3VjaC5jbGllbnRYLCB5OiB0b3VjaC5jbGllbnRZfTsKCQl9Cgl9CgoJcmV0dXJuIE9iamVjdC5hcHBlbmQodGhpcywgewoJCWV2ZW50OiBldmVudCwKCQl0eXBlOiB0eXBlLAoKCQlwYWdlOiBwYWdlLAoJCWNsaWVudDogY2xpZW50LAoJCXJpZ2h0Q2xpY2s6IHJpZ2h0Q2xpY2ssCgoJCXdoZWVsOiB3aGVlbCwKCgkJcmVsYXRlZFRhcmdldDogZG9jdW1lbnQuaWQocmVsYXRlZCksCgkJdGFyZ2V0OiBkb2N1bWVudC5pZCh0YXJnZXQpLAoKCQljb2RlOiBjb2RlLAoJCWtleToga2V5LAoKCQlzaGlmdDogZXZlbnQuc2hpZnRLZXksCgkJY29udHJvbDogZXZlbnQuY3RybEtleSwKCQlhbHQ6IGV2ZW50LmFsdEtleSwKCQltZXRhOiBldmVudC5tZXRhS2V5Cgl9KTsKfSk7CgpFdmVudC5LZXlzID0gewoJJ2VudGVyJzogMTMsCgkndXAnOiAzOCwKCSdkb3duJzogNDAsCgknbGVmdCc6IDM3LAoJJ3JpZ2h0JzogMzksCgknZXNjJzogMjcsCgknc3BhY2UnOiAzMiwKCSdiYWNrc3BhY2UnOiA4LAoJJ3RhYic6IDksCgknZGVsZXRlJzogNDYKfTsKCi8vPDEuMmNvbXBhdD4KCkV2ZW50LktleXMgPSBuZXcgSGFzaChFdmVudC5LZXlzKTsKCi8vPC8xLjJjb21wYXQ+CgpFdmVudC5pbXBsZW1lbnQoewoKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3RvcFByb3BhZ2F0aW9uKCkucHJldmVudERlZmF1bHQoKTsKCX0sCgoJc3RvcFByb3BhZ2F0aW9uOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmV2ZW50LnN0b3BQcm9wYWdhdGlvbikgdGhpcy5ldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCQllbHNlIHRoaXMuZXZlbnQuY2FuY2VsQnViYmxlID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcHJldmVudERlZmF1bHQ6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQpIHRoaXMuZXZlbnQucHJldmVudERlZmF1bHQoKTsKCQllbHNlIHRoaXMuZXZlbnQucmV0dXJuVmFsdWUgPSBmYWxzZTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogQ2xhc3MKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgQ2xhc3MgRnVuY3Rpb24gZm9yIGVhc2lseSBjcmVhdGluZywgZXh0ZW5kaW5nLCBhbmQgaW1wbGVtZW50aW5nIHJldXNhYmxlIENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbQXJyYXksIFN0cmluZywgRnVuY3Rpb24sIE51bWJlcl0KCnByb3ZpZGVzOiBDbGFzcwoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBDbGFzcyA9IHRoaXMuQ2xhc3MgPSBuZXcgVHlwZSgnQ2xhc3MnLCBmdW5jdGlvbihwYXJhbXMpewoJaWYgKGluc3RhbmNlT2YocGFyYW1zLCBGdW5jdGlvbikpIHBhcmFtcyA9IHtpbml0aWFsaXplOiBwYXJhbXN9OwoKCXZhciBuZXdDbGFzcyA9IGZ1bmN0aW9uKCl7CgkJcmVzZXQodGhpcyk7CgkJaWYgKG5ld0NsYXNzLiRwcm90b3R5cGluZykgcmV0dXJuIHRoaXM7CgkJdGhpcy4kY2FsbGVyID0gbnVsbDsKCQl2YXIgdmFsdWUgPSAodGhpcy5pbml0aWFsaXplKSA/IHRoaXMuaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogdGhpczsKCQl0aGlzLiRjYWxsZXIgPSB0aGlzLmNhbGxlciA9IG51bGw7CgkJcmV0dXJuIHZhbHVlOwoJfS5leHRlbmQodGhpcykuaW1wbGVtZW50KHBhcmFtcyk7CgoJbmV3Q2xhc3MuJGNvbnN0cnVjdG9yID0gQ2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUuJGNvbnN0cnVjdG9yID0gbmV3Q2xhc3M7CgluZXdDbGFzcy5wcm90b3R5cGUucGFyZW50ID0gcGFyZW50OwoKCXJldHVybiBuZXdDbGFzczsKfSk7Cgp2YXIgcGFyZW50ID0gZnVuY3Rpb24oKXsKCWlmICghdGhpcy4kY2FsbGVyKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgInBhcmVudCIgY2Fubm90IGJlIGNhbGxlZC4nKTsKCXZhciBuYW1lID0gdGhpcy4kY2FsbGVyLiRuYW1lLAoJCXBhcmVudCA9IHRoaXMuJGNhbGxlci4kb3duZXIucGFyZW50LAoJCXByZXZpb3VzID0gKHBhcmVudCkgPyBwYXJlbnQucHJvdG90eXBlW25hbWVdIDogbnVsbDsKCWlmICghcHJldmlvdXMpIHRocm93IG5ldyBFcnJvcignVGhlIG1ldGhvZCAiJyArIG5hbWUgKyAnIiBoYXMgbm8gcGFyZW50LicpOwoJcmV0dXJuIHByZXZpb3VzLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7Cn07Cgp2YXIgcmVzZXQgPSBmdW5jdGlvbihvYmplY3QpewoJZm9yICh2YXIga2V5IGluIG9iamVjdCl7CgkJdmFyIHZhbHVlID0gb2JqZWN0W2tleV07CgkJc3dpdGNoICh0eXBlT2YodmFsdWUpKXsKCQkJY2FzZSAnb2JqZWN0JzoKCQkJCXZhciBGID0gZnVuY3Rpb24oKXt9OwoJCQkJRi5wcm90b3R5cGUgPSB2YWx1ZTsKCQkJCW9iamVjdFtrZXldID0gcmVzZXQobmV3IEYpOwoJCQlicmVhazsKCQkJY2FzZSAnYXJyYXknOiBvYmplY3Rba2V5XSA9IHZhbHVlLmNsb25lKCk7IGJyZWFrOwoJCX0KCX0KCXJldHVybiBvYmplY3Q7Cn07Cgp2YXIgd3JhcCA9IGZ1bmN0aW9uKHNlbGYsIGtleSwgbWV0aG9kKXsKCWlmIChtZXRob2QuJG9yaWdpbikgbWV0aG9kID0gbWV0aG9kLiRvcmlnaW47Cgl2YXIgd3JhcHBlciA9IGZ1bmN0aW9uKCl7CgkJaWYgKG1ldGhvZC4kcHJvdGVjdGVkICYmIHRoaXMuJGNhbGxlciA9PSBudWxsKSB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBtZXRob2QgIicgKyBrZXkgKyAnIiBjYW5ub3QgYmUgY2FsbGVkLicpOwoJCXZhciBjYWxsZXIgPSB0aGlzLmNhbGxlciwgY3VycmVudCA9IHRoaXMuJGNhbGxlcjsKCQl0aGlzLmNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuJGNhbGxlciA9IHdyYXBwZXI7CgkJdmFyIHJlc3VsdCA9IG1ldGhvZC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwoJCXRoaXMuJGNhbGxlciA9IGN1cnJlbnQ7IHRoaXMuY2FsbGVyID0gY2FsbGVyOwoJCXJldHVybiByZXN1bHQ7Cgl9LmV4dGVuZCh7JG93bmVyOiBzZWxmLCAkb3JpZ2luOiBtZXRob2QsICRuYW1lOiBrZXl9KTsKCXJldHVybiB3cmFwcGVyOwp9OwoKdmFyIGltcGxlbWVudCA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIHJldGFpbil7CglpZiAoQ2xhc3MuTXV0YXRvcnMuaGFzT3duUHJvcGVydHkoa2V5KSl7CgkJdmFsdWUgPSBDbGFzcy5NdXRhdG9yc1trZXldLmNhbGwodGhpcywgdmFsdWUpOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpczsKCX0KCglpZiAodHlwZU9mKHZhbHVlKSA9PSAnZnVuY3Rpb24nKXsKCQlpZiAodmFsdWUuJGhpZGRlbikgcmV0dXJuIHRoaXM7CgkJdGhpcy5wcm90b3R5cGVba2V5XSA9IChyZXRhaW4pID8gdmFsdWUgOiB3cmFwKHRoaXMsIGtleSwgdmFsdWUpOwoJfSBlbHNlIHsKCQlPYmplY3QubWVyZ2UodGhpcy5wcm90b3R5cGUsIGtleSwgdmFsdWUpOwoJfQoKCXJldHVybiB0aGlzOwp9OwoKdmFyIGdldEluc3RhbmNlID0gZnVuY3Rpb24oa2xhc3MpewoJa2xhc3MuJHByb3RvdHlwaW5nID0gdHJ1ZTsKCXZhciBwcm90byA9IG5ldyBrbGFzczsKCWRlbGV0ZSBrbGFzcy4kcHJvdG90eXBpbmc7CglyZXR1cm4gcHJvdG87Cn07CgpDbGFzcy5pbXBsZW1lbnQoJ2ltcGxlbWVudCcsIGltcGxlbWVudC5vdmVybG9hZFNldHRlcigpKTsKCkNsYXNzLk11dGF0b3JzID0gewoKCUV4dGVuZHM6IGZ1bmN0aW9uKHBhcmVudCl7CgkJdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CgkJdGhpcy5wcm90b3R5cGUgPSBnZXRJbnN0YW5jZShwYXJlbnQpOwoJfSwKCglJbXBsZW1lbnRzOiBmdW5jdGlvbihpdGVtcyl7CgkJQXJyYXkuZnJvbShpdGVtcykuZWFjaChmdW5jdGlvbihpdGVtKXsKCQkJdmFyIGluc3RhbmNlID0gbmV3IGl0ZW07CgkJCWZvciAodmFyIGtleSBpbiBpbnN0YW5jZSkgaW1wbGVtZW50LmNhbGwodGhpcywga2V5LCBpbnN0YW5jZVtrZXldLCB0cnVlKTsKCQl9LCB0aGlzKTsKCX0KfTsKCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBDbGFzcy5FeHRyYXMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBVdGlsaXR5IENsYXNzZXMgdGhhdCBjYW4gYmUgaW1wbGVtZW50ZWQgaW50byB5b3VyIG93biBDbGFzc2VzIHRvIGVhc2UgdGhlIGV4ZWN1dGlvbiBvZiBtYW55IGNvbW1vbiB0YXNrcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IENsYXNzCgpwcm92aWRlczogW0NsYXNzLkV4dHJhcywgQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10KCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp0aGlzLkNoYWluID0gbmV3IENsYXNzKHsKCgkkY2hhaW46IFtdLAoKCWNoYWluOiBmdW5jdGlvbigpewoJCXRoaXMuJGNoYWluLmFwcGVuZChBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYWxsQ2hhaW46IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICh0aGlzLiRjaGFpbi5sZW5ndGgpID8gdGhpcy4kY2hhaW4uc2hpZnQoKS5hcHBseSh0aGlzLCBhcmd1bWVudHMpIDogZmFsc2U7Cgl9LAoKCWNsZWFyQ2hhaW46IGZ1bmN0aW9uKCl7CgkJdGhpcy4kY2hhaW4uZW1wdHkoKTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKdmFyIHJlbW92ZU9uID0gZnVuY3Rpb24oc3RyaW5nKXsKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvXm9uKFtBLVpdKS8sIGZ1bmN0aW9uKGZ1bGwsIGZpcnN0KXsKCQlyZXR1cm4gZmlyc3QudG9Mb3dlckNhc2UoKTsKCX0pOwp9OwoKdGhpcy5FdmVudHMgPSBuZXcgQ2xhc3MoewoKCSRldmVudHM6IHt9LAoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbiwgaW50ZXJuYWwpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCgkJLyo8MS4yY29tcGF0PiovCgkJaWYgKGZuID09ICRlbXB0eSkgcmV0dXJuIHRoaXM7CgkJLyo8LzEuMmNvbXBhdD4qLwoKCQl0aGlzLiRldmVudHNbdHlwZV0gPSAodGhpcy4kZXZlbnRzW3R5cGVdIHx8IFtdKS5pbmNsdWRlKGZuKTsKCQlpZiAoaW50ZXJuYWwpIGZuLmludGVybmFsID0gdHJ1ZTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJYWRkRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCWZvciAodmFyIHR5cGUgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KHR5cGUsIGV2ZW50c1t0eXBlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXR5cGUgPSByZW1vdmVPbih0eXBlKTsKCQl2YXIgZXZlbnRzID0gdGhpcy4kZXZlbnRzW3R5cGVdOwoJCWlmICghZXZlbnRzKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCQlldmVudHMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl0eXBlID0gcmVtb3ZlT24odHlwZSk7CgkJdmFyIGV2ZW50cyA9IHRoaXMuJGV2ZW50c1t0eXBlXTsKCQlpZiAoZXZlbnRzICYmICFmbi5pbnRlcm5hbCl7CgkJCXZhciBpbmRleCA9ICBldmVudHMuaW5kZXhPZihmbik7CgkJCWlmIChpbmRleCAhPSAtMSkgZGVsZXRlIGV2ZW50c1tpbmRleF07CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJdmFyIHR5cGU7CgkJaWYgKHR5cGVPZihldmVudHMpID09ICdvYmplY3QnKXsKCQkJZm9yICh0eXBlIGluIGV2ZW50cykgdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBldmVudHNbdHlwZV0pOwoJCQlyZXR1cm4gdGhpczsKCQl9CgkJaWYgKGV2ZW50cykgZXZlbnRzID0gcmVtb3ZlT24oZXZlbnRzKTsKCQlmb3IgKHR5cGUgaW4gdGhpcy4kZXZlbnRzKXsKCQkJaWYgKGV2ZW50cyAmJiBldmVudHMgIT0gdHlwZSkgY29udGludWU7CgkJCXZhciBmbnMgPSB0aGlzLiRldmVudHNbdHlwZV07CgkJCWZvciAodmFyIGkgPSBmbnMubGVuZ3RoOyBpLS07KSBpZiAoaSBpbiBmbnMpewoJCQkJdGhpcy5yZW1vdmVFdmVudCh0eXBlLCBmbnNbaV0pOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp0aGlzLk9wdGlvbnMgPSBuZXcgQ2xhc3MoewoKCXNldE9wdGlvbnM6IGZ1bmN0aW9uKCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMgPSBPYmplY3QubWVyZ2UuYXBwbHkobnVsbCwgW3t9LCB0aGlzLm9wdGlvbnNdLmFwcGVuZChhcmd1bWVudHMpKTsKCQlpZiAodGhpcy5hZGRFdmVudCkgZm9yICh2YXIgb3B0aW9uIGluIG9wdGlvbnMpewoJCQlpZiAodHlwZU9mKG9wdGlvbnNbb3B0aW9uXSkgIT0gJ2Z1bmN0aW9uJyB8fCAhKC9eb25bQS1aXS8pLnRlc3Qob3B0aW9uKSkgY29udGludWU7CgkJCXRoaXMuYWRkRXZlbnQob3B0aW9uLCBvcHRpb25zW29wdGlvbl0pOwoJCQlkZWxldGUgb3B0aW9uc1tvcHRpb25dOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKfSkoKTsKCgovKgotLS0KbmFtZTogU2xpY2suUGFyc2VyCmRlc2NyaXB0aW9uOiBTdGFuZGFsb25lIENTUzMgU2VsZWN0b3IgcGFyc2VyCnByb3ZpZGVzOiBTbGljay5QYXJzZXIKLi4uCiovCgo7KGZ1bmN0aW9uKCl7Cgp2YXIgcGFyc2VkLAoJc2VwYXJhdG9ySW5kZXgsCgljb21iaW5hdG9ySW5kZXgsCglyZXZlcnNlZCwKCWNhY2hlID0ge30sCglyZXZlcnNlQ2FjaGUgPSB7fSwKCXJlVW5lc2NhcGUgPSAvXFwvZzsKCnZhciBwYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24sIGlzUmV2ZXJzZWQpewoJaWYgKGV4cHJlc3Npb24gPT0gbnVsbCkgcmV0dXJuIG51bGw7CglpZiAoZXhwcmVzc2lvbi5TbGljayA9PT0gdHJ1ZSkgcmV0dXJuIGV4cHJlc3Npb247CglleHByZXNzaW9uID0gKCcnICsgZXhwcmVzc2lvbikucmVwbGFjZSgvXlxzK3xccyskL2csICcnKTsKCXJldmVyc2VkID0gISFpc1JldmVyc2VkOwoJdmFyIGN1cnJlbnRDYWNoZSA9IChyZXZlcnNlZCkgPyByZXZlcnNlQ2FjaGUgOiBjYWNoZTsKCWlmIChjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl0pIHJldHVybiBjdXJyZW50Q2FjaGVbZXhwcmVzc2lvbl07CglwYXJzZWQgPSB7CgkJU2xpY2s6IHRydWUsCgkJZXhwcmVzc2lvbnM6IFtdLAoJCXJhdzogZXhwcmVzc2lvbiwKCQlyZXZlcnNlOiBmdW5jdGlvbigpewoJCQlyZXR1cm4gcGFyc2UodGhpcy5yYXcsIHRydWUpOwoJCX0KCX07CglzZXBhcmF0b3JJbmRleCA9IC0xOwoJd2hpbGUgKGV4cHJlc3Npb24gIT0gKGV4cHJlc3Npb24gPSBleHByZXNzaW9uLnJlcGxhY2UocmVnZXhwLCBwYXJzZXIpKSk7CglwYXJzZWQubGVuZ3RoID0gcGFyc2VkLmV4cHJlc3Npb25zLmxlbmd0aDsKCXJldHVybiBjdXJyZW50Q2FjaGVbcGFyc2VkLnJhd10gPSAocmV2ZXJzZWQpID8gcmV2ZXJzZShwYXJzZWQpIDogcGFyc2VkOwp9OwoKdmFyIHJldmVyc2VDb21iaW5hdG9yID0gZnVuY3Rpb24oY29tYmluYXRvcil7CglpZiAoY29tYmluYXRvciA9PT0gJyEnKSByZXR1cm4gJyAnOwoJZWxzZSBpZiAoY29tYmluYXRvciA9PT0gJyAnKSByZXR1cm4gJyEnOwoJZWxzZSBpZiAoKC9eIS8pLnRlc3QoY29tYmluYXRvcikpIHJldHVybiBjb21iaW5hdG9yLnJlcGxhY2UoL14hLywgJycpOwoJZWxzZSByZXR1cm4gJyEnICsgY29tYmluYXRvcjsKfTsKCnZhciByZXZlcnNlID0gZnVuY3Rpb24oZXhwcmVzc2lvbil7Cgl2YXIgZXhwcmVzc2lvbnMgPSBleHByZXNzaW9uLmV4cHJlc3Npb25zOwoJZm9yICh2YXIgaSA9IDA7IGkgPCBleHByZXNzaW9ucy5sZW5ndGg7IGkrKyl7CgkJdmFyIGV4cCA9IGV4cHJlc3Npb25zW2ldOwoJCXZhciBsYXN0ID0ge3BhcnRzOiBbXSwgdGFnOiAnKicsIGNvbWJpbmF0b3I6IHJldmVyc2VDb21iaW5hdG9yKGV4cFswXS5jb21iaW5hdG9yKX07CgoJCWZvciAodmFyIGogPSAwOyBqIDwgZXhwLmxlbmd0aDsgaisrKXsKCQkJdmFyIGNleHAgPSBleHBbal07CgkJCWlmICghY2V4cC5yZXZlcnNlQ29tYmluYXRvcikgY2V4cC5yZXZlcnNlQ29tYmluYXRvciA9ICcgJzsKCQkJY2V4cC5jb21iaW5hdG9yID0gY2V4cC5yZXZlcnNlQ29tYmluYXRvcjsKCQkJZGVsZXRlIGNleHAucmV2ZXJzZUNvbWJpbmF0b3I7CgkJfQoKCQlleHAucmV2ZXJzZSgpLnB1c2gobGFzdCk7Cgl9CglyZXR1cm4gZXhwcmVzc2lvbjsKfTsKCnZhciBlc2NhcGVSZWdFeHAgPSBmdW5jdGlvbihzdHJpbmcpey8vIENyZWRpdDogWFJlZ0V4cCAwLjYuMSAoYykgMjAwNy0yMDA4IFN0ZXZlbiBMZXZpdGhhbiA8aHR0cDovL3N0ZXZlbmxldml0aGFuLmNvbS9yZWdleC94cmVnZXhwLz4gTUlUIExpY2Vuc2UKCXJldHVybiBzdHJpbmcucmVwbGFjZSgvWy1bXF17fSgpKis/LlxcXiR8LCNcc10vZywgZnVuY3Rpb24obWF0Y2gpewoJCXJldHVybiAnXFwnICsgbWF0Y2g7Cgl9KTsKfTsKCnZhciByZWdleHAgPSBuZXcgUmVnRXhwKAovKgojIS91c3IvYmluL2VudiBydWJ5CnB1dHMgIlx0XHQiICsgREFUQS5yZWFkLmdzdWIoL1woXD94XCl8XHMrIy4qJHxccyt8XFwkfFxcbi8sJycpCl9fRU5EX18KCSIoP3gpXig/OlwKCSAgXFxzKiAoICwgKSBcXHMqICAgICAgICAgICAgICAgIyBTZXBhcmF0b3IgICAgICAgICAgXG5cCgl8IFxccyogKCA8Y29tYmluYXRvcj4rICkgXFxzKiAgICMgQ29tYmluYXRvciAgICAgICAgIFxuXAoJfCAgICAgICggXFxzKyApICAgICAgICAgICAgICAgICAjIENvbWJpbmF0b3JDaGlsZHJlbiBcblwKCXwgICAgICAoIDx1bmljb2RlPisgfCBcXCogKSAgICAgIyBUYWcgICAgICAgICAgICAgICAgXG5cCgl8IFxcIyAgKCA8dW5pY29kZT4rICAgICAgICkgICAgICMgSUQgICAgICAgICAgICAgICAgIFxuXAoJfCBcXC4gICggPHVuaWNvZGU+KyAgICAgICApICAgICAjIENsYXNzTmFtZSAgICAgICAgICBcblwKCXwgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBBdHRyaWJ1dGUgICAgICAgICAgXG5cCglcXFsgIFwKCQlcXHMqICg8dW5pY29kZTE+KykgICg/OiAgXAoJCQlcXHMqIChbKl4kIX58XT89KSAgKD86ICBcCgkJCQlcXHMqICg/OlwKCQkJCQkoW1wiJ10/KSguKj8pXFw5IFwKCQkJCSlcCgkJCSkgIFwKCQkpPyAgXFxzKiAgXAoJXFxdKD8hXFxdKSBcblwKCXwgICA6KyAoIDx1bmljb2RlPisgKSg/OlwKCVxcKCAoPzpcCgkJKD86KFtcIiddKShbXlxcMTJdKilcXDEyKXwoKD86XFwoW14pXStcXCl8W14oKV0qKSspXAoJKSBcXClcCgkpP1wKCSkiCiovCgkiXig/OlxccyooLClcXHMqfFxccyooPGNvbWJpbmF0b3I+KylcXHMqfChcXHMrKXwoPHVuaWNvZGU+K3xcXCopfFxcIyg8dW5pY29kZT4rKXxcXC4oPHVuaWNvZGU+Kyl8XFxbXFxzKig8dW5pY29kZTE+KykoPzpcXHMqKFsqXiQhfnxdPz0pKD86XFxzKig/OihbXCInXT8pKC4qPylcXDkpKSk/XFxzKlxcXSg/IVxcXSl8KDorKSg8dW5pY29kZT4rKSg/OlxcKCg/Oig/OihbXCInXSkoW15cXDEzXSopXFwxMyl8KCg/OlxcKFteKV0rXFwpfFteKCldKikrKSlcXCkpPykiCgkucmVwbGFjZSgvPGNvbWJpbmF0b3I+LywgJ1snICsgZXNjYXBlUmVnRXhwKCI+K35gIUAkJV4mPXt9XFw7PC8iKSArICddJykKCS5yZXBsYWNlKC88dW5pY29kZT4vZywgJyg/OltcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCgkucmVwbGFjZSgvPHVuaWNvZGUxPi9nLCAnKD86WzpcXHdcXHUwMGExLVxcdUZGRkYtXXxcXFxcW15cXHMwLTlhLWZdKScpCik7CgpmdW5jdGlvbiBwYXJzZXIoCglyYXdNYXRjaCwKCglzZXBhcmF0b3IsCgljb21iaW5hdG9yLAoJY29tYmluYXRvckNoaWxkcmVuLAoKCXRhZ05hbWUsCglpZCwKCWNsYXNzTmFtZSwKCglhdHRyaWJ1dGVLZXksCglhdHRyaWJ1dGVPcGVyYXRvciwKCWF0dHJpYnV0ZVF1b3RlLAoJYXR0cmlidXRlVmFsdWUsCgoJcHNldWRvTWFya2VyLAoJcHNldWRvQ2xhc3MsCglwc2V1ZG9RdW90ZSwKCXBzZXVkb0NsYXNzUXVvdGVkVmFsdWUsCglwc2V1ZG9DbGFzc1ZhbHVlCil7CglpZiAoc2VwYXJhdG9yIHx8IHNlcGFyYXRvckluZGV4ID09PSAtMSl7CgkJcGFyc2VkLmV4cHJlc3Npb25zWysrc2VwYXJhdG9ySW5kZXhdID0gW107CgkJY29tYmluYXRvckluZGV4ID0gLTE7CgkJaWYgKHNlcGFyYXRvcikgcmV0dXJuICcnOwoJfQoKCWlmIChjb21iaW5hdG9yIHx8IGNvbWJpbmF0b3JDaGlsZHJlbiB8fCBjb21iaW5hdG9ySW5kZXggPT09IC0xKXsKCQljb21iaW5hdG9yID0gY29tYmluYXRvciB8fCAnICc7CgkJdmFyIGN1cnJlbnRTZXBhcmF0b3IgPSBwYXJzZWQuZXhwcmVzc2lvbnNbc2VwYXJhdG9ySW5kZXhdOwoJCWlmIChyZXZlcnNlZCAmJiBjdXJyZW50U2VwYXJhdG9yW2NvbWJpbmF0b3JJbmRleF0pCgkJCWN1cnJlbnRTZXBhcmF0b3JbY29tYmluYXRvckluZGV4XS5yZXZlcnNlQ29tYmluYXRvciA9IHJldmVyc2VDb21iaW5hdG9yKGNvbWJpbmF0b3IpOwoJCWN1cnJlbnRTZXBhcmF0b3JbKytjb21iaW5hdG9ySW5kZXhdID0ge2NvbWJpbmF0b3I6IGNvbWJpbmF0b3IsIHRhZzogJyonfTsKCX0KCgl2YXIgY3VycmVudFBhcnNlZCA9IHBhcnNlZC5leHByZXNzaW9uc1tzZXBhcmF0b3JJbmRleF1bY29tYmluYXRvckluZGV4XTsKCglpZiAodGFnTmFtZSl7CgkJY3VycmVudFBhcnNlZC50YWcgPSB0YWdOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCX0gZWxzZSBpZiAoaWQpewoJCWN1cnJlbnRQYXJzZWQuaWQgPSBpZC5yZXBsYWNlKHJlVW5lc2NhcGUsICcnKTsKCgl9IGVsc2UgaWYgKGNsYXNzTmFtZSl7CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQuY2xhc3NMaXN0KSBjdXJyZW50UGFyc2VkLmNsYXNzTGlzdCA9IFtdOwoJCWlmICghY3VycmVudFBhcnNlZC5jbGFzc2VzKSBjdXJyZW50UGFyc2VkLmNsYXNzZXMgPSBbXTsKCQljdXJyZW50UGFyc2VkLmNsYXNzTGlzdC5wdXNoKGNsYXNzTmFtZSk7CgkJY3VycmVudFBhcnNlZC5jbGFzc2VzLnB1c2goewoJCQl2YWx1ZTogY2xhc3NOYW1lLAoJCQlyZWdleHA6IG5ldyBSZWdFeHAoJyhefFxccyknICsgZXNjYXBlUmVnRXhwKGNsYXNzTmFtZSkgKyAnKFxcc3wkKScpCgkJfSk7CgoJfSBlbHNlIGlmIChwc2V1ZG9DbGFzcyl7CgkJcHNldWRvQ2xhc3NWYWx1ZSA9IHBzZXVkb0NsYXNzVmFsdWUgfHwgcHNldWRvQ2xhc3NRdW90ZWRWYWx1ZTsKCQlwc2V1ZG9DbGFzc1ZhbHVlID0gcHNldWRvQ2xhc3NWYWx1ZSA/IHBzZXVkb0NsYXNzVmFsdWUucmVwbGFjZShyZVVuZXNjYXBlLCAnJykgOiBudWxsOwoKCQlpZiAoIWN1cnJlbnRQYXJzZWQucHNldWRvcykgY3VycmVudFBhcnNlZC5wc2V1ZG9zID0gW107CgkJY3VycmVudFBhcnNlZC5wc2V1ZG9zLnB1c2goewoJCQlrZXk6IHBzZXVkb0NsYXNzLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpLAoJCQl2YWx1ZTogcHNldWRvQ2xhc3NWYWx1ZSwKCQkJdHlwZTogcHNldWRvTWFya2VyLmxlbmd0aCA9PSAxID8gJ2NsYXNzJyA6ICdlbGVtZW50JwoJCX0pOwoKCX0gZWxzZSBpZiAoYXR0cmlidXRlS2V5KXsKCQlhdHRyaWJ1dGVLZXkgPSBhdHRyaWJ1dGVLZXkucmVwbGFjZShyZVVuZXNjYXBlLCAnJyk7CgkJYXR0cmlidXRlVmFsdWUgPSAoYXR0cmlidXRlVmFsdWUgfHwgJycpLnJlcGxhY2UocmVVbmVzY2FwZSwgJycpOwoKCQl2YXIgdGVzdCwgcmVnZXhwOwoKCQlzd2l0Y2ggKGF0dHJpYnV0ZU9wZXJhdG9yKXsKCQkJY2FzZSAnXj0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICAgICAgICAgICAgKTsgYnJlYWs7CgkJCWNhc2UgJyQ9JyA6IHJlZ2V4cCA9IG5ldyBSZWdFeHAoICAgICAgICAgICAgZXNjYXBlUmVnRXhwKGF0dHJpYnV0ZVZhbHVlKSArJyQnICAgICAgICk7IGJyZWFrOwoJCQljYXNlICd+PScgOiByZWdleHAgPSBuZXcgUmVnRXhwKCAnKF58XFxzKScrIGVzY2FwZVJlZ0V4cChhdHRyaWJ1dGVWYWx1ZSkgKycoXFxzfCQpJyApOyBicmVhazsKCQkJY2FzZSAnfD0nIDogcmVnZXhwID0gbmV3IFJlZ0V4cCggICAgICAgJ14nKyBlc2NhcGVSZWdFeHAoYXR0cmlidXRlVmFsdWUpICsnKC18JCknICAgKTsgYnJlYWs7CgkJCWNhc2UgICc9JyA6IHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCQlyZXR1cm4gYXR0cmlidXRlVmFsdWUgPT0gdmFsdWU7CgkJCX07IGJyZWFrOwoJCQljYXNlICcqPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIHZhbHVlICYmIHZhbHVlLmluZGV4T2YoYXR0cmlidXRlVmFsdWUpID4gLTE7CgkJCX07IGJyZWFrOwoJCQljYXNlICchPScgOiB0ZXN0ID0gZnVuY3Rpb24odmFsdWUpewoJCQkJcmV0dXJuIGF0dHJpYnV0ZVZhbHVlICE9IHZhbHVlOwoJCQl9OyBicmVhazsKCQkJZGVmYXVsdCAgIDogdGVzdCA9IGZ1bmN0aW9uKHZhbHVlKXsKCQkJCXJldHVybiAhIXZhbHVlOwoJCQl9OwoJCX0KCgkJaWYgKGF0dHJpYnV0ZVZhbHVlID09ICcnICYmICgvXlsqJF5dPSQvKS50ZXN0KGF0dHJpYnV0ZU9wZXJhdG9yKSkgdGVzdCA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmYWxzZTsKCQl9OwoKCQlpZiAoIXRlc3QpIHRlc3QgPSBmdW5jdGlvbih2YWx1ZSl7CgkJCXJldHVybiB2YWx1ZSAmJiByZWdleHAudGVzdCh2YWx1ZSk7CgkJfTsKCgkJaWYgKCFjdXJyZW50UGFyc2VkLmF0dHJpYnV0ZXMpIGN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcyA9IFtdOwoJCWN1cnJlbnRQYXJzZWQuYXR0cmlidXRlcy5wdXNoKHsKCQkJa2V5OiBhdHRyaWJ1dGVLZXksCgkJCW9wZXJhdG9yOiBhdHRyaWJ1dGVPcGVyYXRvciwKCQkJdmFsdWU6IGF0dHJpYnV0ZVZhbHVlLAoJCQl0ZXN0OiB0ZXN0CgkJfSk7CgoJfQoKCXJldHVybiAnJzsKfTsKCi8vIFNsaWNrIE5TCgp2YXIgU2xpY2sgPSAodGhpcy5TbGljayB8fCB7fSk7CgpTbGljay5wYXJzZSA9IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJcmV0dXJuIHBhcnNlKGV4cHJlc3Npb24pOwp9OwoKU2xpY2suZXNjYXBlUmVnRXhwID0gZXNjYXBlUmVnRXhwOwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCm5hbWU6IFNsaWNrLkZpbmRlcgpkZXNjcmlwdGlvbjogVGhlIG5ldywgc3VwZXJmYXN0IGNzcyBzZWxlY3RvciBlbmdpbmUuCnByb3ZpZGVzOiBTbGljay5GaW5kZXIKcmVxdWlyZXM6IFNsaWNrLlBhcnNlcgouLi4KKi8KCjsoZnVuY3Rpb24oKXsKCnZhciBsb2NhbCA9IHt9LAoJZmVhdHVyZXNDYWNoZSA9IHt9LAoJdG9TdHJpbmcgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nOwoKLy8gRmVhdHVyZSAvIEJ1ZyBkZXRlY3Rpb24KCmxvY2FsLmlzTmF0aXZlQ29kZSA9IGZ1bmN0aW9uKGZuKXsKCXJldHVybiAoL1x7XHMqXFtuYXRpdmUgY29kZVxdXHMqXH0vKS50ZXN0KCcnICsgZm4pOwp9OwoKbG9jYWwuaXNYTUwgPSBmdW5jdGlvbihkb2N1bWVudCl7CglyZXR1cm4gKCEhZG9jdW1lbnQueG1sVmVyc2lvbikgfHwgKCEhZG9jdW1lbnQueG1sKSB8fCAodG9TdHJpbmcuY2FsbChkb2N1bWVudCkgPT0gJ1tvYmplY3QgWE1MRG9jdW1lbnRdJykgfHwKCShkb2N1bWVudC5ub2RlVHlwZSA9PSA5ICYmIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5ub2RlTmFtZSAhPSAnSFRNTCcpOwp9OwoKbG9jYWwuc2V0RG9jdW1lbnQgPSBmdW5jdGlvbihkb2N1bWVudCl7CgoJLy8gY29udmVydCBlbGVtZW50cyAvIHdpbmRvdyBhcmd1bWVudHMgdG8gZG9jdW1lbnQuIGlmIGRvY3VtZW50IGNhbm5vdCBiZSBleHRyYXBvbGF0ZWQsIHRoZSBmdW5jdGlvbiByZXR1cm5zLgoJdmFyIG5vZGVUeXBlID0gZG9jdW1lbnQubm9kZVR5cGU7CglpZiAobm9kZVR5cGUgPT0gOSk7IC8vIGRvY3VtZW50CgllbHNlIGlmIChub2RlVHlwZSkgZG9jdW1lbnQgPSBkb2N1bWVudC5vd25lckRvY3VtZW50OyAvLyBub2RlCgllbHNlIGlmIChkb2N1bWVudC5uYXZpZ2F0b3IpIGRvY3VtZW50ID0gZG9jdW1lbnQuZG9jdW1lbnQ7IC8vIHdpbmRvdwoJZWxzZSByZXR1cm47CgoJLy8gY2hlY2sgaWYgaXQncyB0aGUgb2xkIGRvY3VtZW50CgoJaWYgKHRoaXMuZG9jdW1lbnQgPT09IGRvY3VtZW50KSByZXR1cm47Cgl0aGlzLmRvY3VtZW50ID0gZG9jdW1lbnQ7CgoJLy8gY2hlY2sgaWYgd2UgaGF2ZSBkb25lIGZlYXR1cmUgZGV0ZWN0aW9uIG9uIHRoaXMgZG9jdW1lbnQgYmVmb3JlCgoJdmFyIHJvb3QgPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQsCgkJcm9vdFVpZCA9IHRoaXMuZ2V0VUlEWE1MKHJvb3QpLAoJCWZlYXR1cmVzID0gZmVhdHVyZXNDYWNoZVtyb290VWlkXSwKCQlmZWF0dXJlOwoKCWlmIChmZWF0dXJlcyl7CgkJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQkJdGhpc1tmZWF0dXJlXSA9IGZlYXR1cmVzW2ZlYXR1cmVdOwoJCX0KCQlyZXR1cm47Cgl9CgoJZmVhdHVyZXMgPSBmZWF0dXJlc0NhY2hlW3Jvb3RVaWRdID0ge307CgoJZmVhdHVyZXMucm9vdCA9IHJvb3Q7CglmZWF0dXJlcy5pc1hNTERvY3VtZW50ID0gdGhpcy5pc1hNTChkb2N1bWVudCk7CgoJZmVhdHVyZXMuYnJva2VuU3RhckdFQlROCgk9IGZlYXR1cmVzLnN0YXJTZWxlY3RzQ2xvc2VkUVNBCgk9IGZlYXR1cmVzLmlkR2V0c05hbWUKCT0gZmVhdHVyZXMuYnJva2VuTWl4ZWRDYXNlUVNBCgk9IGZlYXR1cmVzLmJyb2tlbkdFQkNOCgk9IGZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EKCT0gZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EKCT0gZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQKCT0gZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yCgk9IGZhbHNlOwoKCXZhciBzdGFyU2VsZWN0c0Nsb3NlZCwgc3RhclNlbGVjdHNDb21tZW50cywKCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiwgY2FjaGVkR2V0RWxlbWVudHNCeUNsYXNzTmFtZSwKCQlicm9rZW5Gb3JtQXR0cmlidXRlR2V0dGVyOwoKCXZhciBzZWxlY3RlZCwgaWQgPSAnc2xpY2tfdW5pcXVlaWQnOwoJdmFyIHRlc3ROb2RlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CgkKCXZhciB0ZXN0Um9vdCA9IGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXSB8fCByb290OwoJdGVzdFJvb3QuYXBwZW5kQ2hpbGQodGVzdE5vZGUpOwoKCS8vIG9uIG5vbi1IVE1MIGRvY3VtZW50cyBpbm5lckhUTUwgYW5kIGdldEVsZW1lbnRzQnlJZCBkb2VzbnQgd29yayBwcm9wZXJseQoJdHJ5IHsKCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgaWQ9IicraWQrJyI+PC9hPic7CgkJZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgPSAhIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCX0gY2F0Y2goZSl7fTsKCglpZiAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQpewoKCQl0ZXN0Tm9kZS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwoKCQkvLyBJRSByZXR1cm5zIGNvbW1lbnQgbm9kZXMgZm9yIGdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJdGVzdE5vZGUuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgnJykpOwoJCXN0YXJTZWxlY3RzQ29tbWVudHMgPSAodGVzdE5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKS5sZW5ndGggPiAxKTsKCgkJLy8gSUUgcmV0dXJucyBjbG9zZWQgbm9kZXMgKEVHOiI8L2Zvbz4iKSBmb3IgZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKSBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJc2VsZWN0ZWQgPSB0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpOwoJCQlzdGFyU2VsZWN0c0Nsb3NlZCA9IChzZWxlY3RlZCAmJiAhIXNlbGVjdGVkLmxlbmd0aCAmJiBzZWxlY3RlZFswXS5ub2RlTmFtZS5jaGFyQXQoMCkgPT0gJy8nKTsKCQl9IGNhdGNoKGUpe307CgoJCWZlYXR1cmVzLmJyb2tlblN0YXJHRUJUTiA9IHN0YXJTZWxlY3RzQ29tbWVudHMgfHwgc3RhclNlbGVjdHNDbG9zZWQ7CgoJCS8vIElFIHJldHVybnMgZWxlbWVudHMgd2l0aCB0aGUgbmFtZSBpbnN0ZWFkIG9mIGp1c3QgaWQgZm9yIGdldEVsZW1lbnRzQnlJZCBmb3Igc29tZSBkb2N1bWVudHMKCQl0cnkgewoJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgbmFtZT0iJysgaWQgKyciPjwvYT48YiBpZD0iJysgaWQgKyciPjwvYj4nOwoJCQlmZWF0dXJlcy5pZEdldHNOYW1lID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpID09PSB0ZXN0Tm9kZS5maXJzdENoaWxkOwoJCX0gY2F0Y2goZSl7fTsKCgkJaWYgKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUpewoKCQkJLy8gU2FmYXJpIDMuMiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGNhY2hlcyByZXN1bHRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9ImYiPjwvYT48YSBjbGFzcz0iYiI+PC9hPic7CgkJCQl0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdiJykubGVuZ3RoOwoJCQkJdGVzdE5vZGUuZmlyc3RDaGlsZC5jbGFzc05hbWUgPSAnYic7CgkJCQljYWNoZWRHZXRFbGVtZW50c0J5Q2xhc3NOYW1lID0gKHRlc3ROb2RlLmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2InKS5sZW5ndGggIT0gMik7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIE9wZXJhIDkuNiBnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIGRvZXNudCBkZXRlY3RzIHRoZSBjbGFzcyBpZiBpdHMgbm90IHRoZSBmaXJzdCBvbmUKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8YSBjbGFzcz0iYSI+PC9hPjxhIGNsYXNzPSJmIGIgYSI+PC9hPic7CgkJCQlicm9rZW5TZWNvbmRDbGFzc05hbWVHRUJDTiA9ICh0ZXN0Tm9kZS5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdhJykubGVuZ3RoICE9IDIpOwoJCQl9IGNhdGNoKGUpe307CgoJCQlmZWF0dXJlcy5icm9rZW5HRUJDTiA9IGNhY2hlZEdldEVsZW1lbnRzQnlDbGFzc05hbWUgfHwgYnJva2VuU2Vjb25kQ2xhc3NOYW1lR0VCQ047CgkJfQoJCQoJCWlmICh0ZXN0Tm9kZS5xdWVyeVNlbGVjdG9yQWxsKXsKCQkJLy8gSUUgOCByZXR1cm5zIGNsb3NlZCBub2RlcyAoRUc6IjwvZm9vPiIpIGZvciBxdWVyeVNlbGVjdG9yQWxsKCcqJykgZm9yIHNvbWUgZG9jdW1lbnRzCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnZm9vPC9mb28+JzsKCQkJCXNlbGVjdGVkID0gdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnKicpOwoJCQkJZmVhdHVyZXMuc3RhclNlbGVjdHNDbG9zZWRRU0EgPSAoc2VsZWN0ZWQgJiYgISFzZWxlY3RlZC5sZW5ndGggJiYgc2VsZWN0ZWRbMF0ubm9kZU5hbWUuY2hhckF0KDApID09ICcvJyk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIFNhZmFyaSAzLjIgcXVlcnlTZWxlY3RvckFsbCBkb2VzbnQgd29yayB3aXRoIG1peGVkY2FzZSBvbiBxdWlya3Ntb2RlCgkJCXRyeSB7CgkJCQl0ZXN0Tm9kZS5pbm5lckhUTUwgPSAnPGEgY2xhc3M9Ik1pWCI+PC9hPic7CgkJCQlmZWF0dXJlcy5icm9rZW5NaXhlZENhc2VRU0EgPSAhdGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnLk1pWCcpLmxlbmd0aDsKCQkJfSBjYXRjaChlKXt9OwoKCQkJLy8gV2Via2l0IGFuZCBPcGVyYSBkb250IHJldHVybiBzZWxlY3RlZCBvcHRpb25zIG9uIHF1ZXJ5U2VsZWN0b3JBbGwKCQkJdHJ5IHsKCQkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8c2VsZWN0PjxvcHRpb24gc2VsZWN0ZWQ9InNlbGVjdGVkIj5hPC9vcHRpb24+PC9zZWxlY3Q+JzsKCQkJCWZlYXR1cmVzLmJyb2tlbkNoZWNrZWRRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnOmNoZWNrZWQnKS5sZW5ndGggPT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJCS8vIElFIHJldHVybnMgaW5jb3JyZWN0IHJlc3VsdHMgZm9yIGF0dHJbKl4kXT0iIiBzZWxlY3RvcnMgb24gcXVlcnlTZWxlY3RvckFsbAoJCQl0cnkgewoJCQkJdGVzdE5vZGUuaW5uZXJIVE1MID0gJzxhIGNsYXNzPSIiPjwvYT4nOwoJCQkJZmVhdHVyZXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgPSAodGVzdE5vZGUucXVlcnlTZWxlY3RvckFsbCgnW2NsYXNzKj0iIl0nKS5sZW5ndGggIT0gMCk7CgkJCX0gY2F0Y2goZSl7fTsKCgkJfQoKCQkvLyBJRTYtNywgaWYgYSBmb3JtIGhhcyBhbiBpbnB1dCBvZiBpZCB4LCBmb3JtLmdldEF0dHJpYnV0ZSh4KSByZXR1cm5zIGEgcmVmZXJlbmNlIHRvIHRoZSBpbnB1dAoJCXRyeSB7CgkJCXRlc3ROb2RlLmlubmVySFRNTCA9ICc8Zm9ybSBhY3Rpb249InMiPjxpbnB1dCBpZD0iYWN0aW9uIi8+PC9mb3JtPic7CgkJCWJyb2tlbkZvcm1BdHRyaWJ1dGVHZXR0ZXIgPSAodGVzdE5vZGUuZmlyc3RDaGlsZC5nZXRBdHRyaWJ1dGUoJ2FjdGlvbicpICE9ICdzJyk7CgkJfSBjYXRjaChlKXt9OwoKCQkvLyBuYXRpdmUgbWF0Y2hlc1NlbGVjdG9yIGZ1bmN0aW9uCgoJCWZlYXR1cmVzLm5hdGl2ZU1hdGNoZXNTZWxlY3RvciA9IHJvb3QubWF0Y2hlc1NlbGVjdG9yIHx8IC8qcm9vdC5tc01hdGNoZXNTZWxlY3RvciB8fCovIHJvb3QubW96TWF0Y2hlc1NlbGVjdG9yIHx8IHJvb3Qud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwoJCWlmIChmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IpIHRyeSB7CgkJCS8vIGlmIG1hdGNoZXNTZWxlY3RvciB0cm93cyBlcnJvcnMgb24gaW5jb3JyZWN0IHNpbnRheGVzIHdlIGNhbiB1c2UgaXQKCQkJZmVhdHVyZXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwocm9vdCwgJzpzbGljaycpOwoJCQlmZWF0dXJlcy5uYXRpdmVNYXRjaGVzU2VsZWN0b3IgPSBudWxsOwoJCX0gY2F0Y2goZSl7fTsKCgl9CgoJdHJ5IHsKCQlyb290LnNsaWNrX2V4cGFuZG8gPSAxOwoJCWRlbGV0ZSByb290LnNsaWNrX2V4cGFuZG87CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURIVE1MOwoJfSBjYXRjaChlKSB7CgkJZmVhdHVyZXMuZ2V0VUlEID0gdGhpcy5nZXRVSURYTUw7Cgl9CgoJdGVzdFJvb3QucmVtb3ZlQ2hpbGQodGVzdE5vZGUpOwoJdGVzdE5vZGUgPSBzZWxlY3RlZCA9IHRlc3RSb290ID0gbnVsbDsKCgkvLyBnZXRBdHRyaWJ1dGUKCglmZWF0dXJlcy5nZXRBdHRyaWJ1dGUgPSAoZmVhdHVyZXMuaXNIVE1MRG9jdW1lbnQgJiYgYnJva2VuRm9ybUF0dHJpYnV0ZUdldHRlcikgPyBmdW5jdGlvbihub2RlLCBuYW1lKXsKCQl2YXIgbWV0aG9kID0gdGhpcy5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwoJCWlmIChtZXRob2QpIHJldHVybiBtZXRob2QuY2FsbChub2RlKTsKCQl2YXIgYXR0cmlidXRlTm9kZSA9IG5vZGUuZ2V0QXR0cmlidXRlTm9kZShuYW1lKTsKCQlyZXR1cm4gKGF0dHJpYnV0ZU5vZGUpID8gYXR0cmlidXRlTm9kZS5ub2RlVmFsdWUgOiBudWxsOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJCXZhciBtZXRob2QgPSB0aGlzLmF0dHJpYnV0ZUdldHRlcnNbbmFtZV07CgkJcmV0dXJuIChtZXRob2QpID8gbWV0aG9kLmNhbGwobm9kZSkgOiBub2RlLmdldEF0dHJpYnV0ZShuYW1lKTsKCX07CgoJLy8gaGFzQXR0cmlidXRlCgoJZmVhdHVyZXMuaGFzQXR0cmlidXRlID0gKHJvb3QgJiYgdGhpcy5pc05hdGl2ZUNvZGUocm9vdC5oYXNBdHRyaWJ1dGUpKSA/IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCXJldHVybiBub2RlLmhhc0F0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJfSA6IGZ1bmN0aW9uKG5vZGUsIGF0dHJpYnV0ZSkgewoJCW5vZGUgPSBub2RlLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKTsKCQlyZXR1cm4gISEobm9kZSAmJiAobm9kZS5zcGVjaWZpZWQgfHwgbm9kZS5ub2RlVmFsdWUpKTsKCX07CgoJLy8gY29udGFpbnMKCS8vIEZJWE1FOiBBZGQgc3BlY3M6IGxvY2FsLmNvbnRhaW5zIHNob3VsZCBiZSBkaWZmZXJlbnQgZm9yIHhtbCBhbmQgaHRtbCBkb2N1bWVudHM/CglmZWF0dXJlcy5jb250YWlucyA9IChyb290ICYmIHRoaXMuaXNOYXRpdmVDb2RlKHJvb3QuY29udGFpbnMpKSA/IGZ1bmN0aW9uKGNvbnRleHQsIG5vZGUpewoJCXJldHVybiBjb250ZXh0LmNvbnRhaW5zKG5vZGUpOwoJfSA6IChyb290ICYmIHJvb3QuY29tcGFyZURvY3VtZW50UG9zaXRpb24pID8gZnVuY3Rpb24oY29udGV4dCwgbm9kZSl7CgkJcmV0dXJuIGNvbnRleHQgPT09IG5vZGUgfHwgISEoY29udGV4dC5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbihub2RlKSAmIDE2KTsKCX0gOiBmdW5jdGlvbihjb250ZXh0LCBub2RlKXsKCQlpZiAobm9kZSkgZG8gewoJCQlpZiAobm9kZSA9PT0gY29udGV4dCkgcmV0dXJuIHRydWU7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLnBhcmVudE5vZGUpKTsKCQlyZXR1cm4gZmFsc2U7Cgl9OwoKCS8vIGRvY3VtZW50IG9yZGVyIHNvcnRpbmcKCS8vIGNyZWRpdHMgdG8gU2l6emxlIChodHRwOi8vc2l6emxlanMuY29tLykKCglmZWF0dXJlcy5kb2N1bWVudFNvcnRlciA9IChyb290LmNvbXBhcmVEb2N1bWVudFBvc2l0aW9uKSA/IGZ1bmN0aW9uKGEsIGIpewoJCWlmICghYS5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbiB8fCAhYi5jb21wYXJlRG9jdW1lbnRQb3NpdGlvbikgcmV0dXJuIDA7CgkJcmV0dXJuIGEuY29tcGFyZURvY3VtZW50UG9zaXRpb24oYikgJiA0ID8gLTEgOiBhID09PSBiID8gMCA6IDE7Cgl9IDogKCdzb3VyY2VJbmRleCcgaW4gcm9vdCkgPyBmdW5jdGlvbihhLCBiKXsKCQlpZiAoIWEuc291cmNlSW5kZXggfHwgIWIuc291cmNlSW5kZXgpIHJldHVybiAwOwoJCXJldHVybiBhLnNvdXJjZUluZGV4IC0gYi5zb3VyY2VJbmRleDsKCX0gOiAoZG9jdW1lbnQuY3JlYXRlUmFuZ2UpID8gZnVuY3Rpb24oYSwgYil7CgkJaWYgKCFhLm93bmVyRG9jdW1lbnQgfHwgIWIub3duZXJEb2N1bWVudCkgcmV0dXJuIDA7CgkJdmFyIGFSYW5nZSA9IGEub3duZXJEb2N1bWVudC5jcmVhdGVSYW5nZSgpLCBiUmFuZ2UgPSBiLm93bmVyRG9jdW1lbnQuY3JlYXRlUmFuZ2UoKTsKCQlhUmFuZ2Uuc2V0U3RhcnQoYSwgMCk7CgkJYVJhbmdlLnNldEVuZChhLCAwKTsKCQliUmFuZ2Uuc2V0U3RhcnQoYiwgMCk7CgkJYlJhbmdlLnNldEVuZChiLCAwKTsKCQlyZXR1cm4gYVJhbmdlLmNvbXBhcmVCb3VuZGFyeVBvaW50cyhSYW5nZS5TVEFSVF9UT19FTkQsIGJSYW5nZSk7Cgl9IDogbnVsbCA7CgoJcm9vdCA9IG51bGw7CgoJZm9yIChmZWF0dXJlIGluIGZlYXR1cmVzKXsKCQl0aGlzW2ZlYXR1cmVdID0gZmVhdHVyZXNbZmVhdHVyZV07Cgl9Cn07CgovLyBNYWluIE1ldGhvZAoKdmFyIHJlU2ltcGxlU2VsZWN0b3IgPSAvXihbIy5dPykoKD86W1x3LV0rfFwqKSkkLywKCXJlRW1wdHlBdHRyaWJ1dGUgPSAvXFsuK1sqJF5dPSg/OiIifCcnKT9cXS8sCglxc2FGYWlsRXhwQ2FjaGUgPSB7fTsKCmxvY2FsLnNlYXJjaCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24sIGFwcGVuZCwgZmlyc3QpewoKCXZhciBmb3VuZCA9IHRoaXMuZm91bmQgPSAoZmlyc3QpID8gbnVsbCA6IChhcHBlbmQgfHwgW10pOwoJCglpZiAoIWNvbnRleHQpIHJldHVybiBmb3VuZDsKCWVsc2UgaWYgKGNvbnRleHQubmF2aWdhdG9yKSBjb250ZXh0ID0gY29udGV4dC5kb2N1bWVudDsgLy8gQ29udmVydCB0aGUgbm9kZSBmcm9tIGEgd2luZG93IHRvIGEgZG9jdW1lbnQKCWVsc2UgaWYgKCFjb250ZXh0Lm5vZGVUeXBlKSByZXR1cm4gZm91bmQ7CgoJLy8gc2V0dXAKCgl2YXIgcGFyc2VkLCBpLAoJCXVuaXF1ZXMgPSB0aGlzLnVuaXF1ZXMgPSB7fSwKCQloYXNPdGhlcnMgPSAhIShhcHBlbmQgJiYgYXBwZW5kLmxlbmd0aCksCgkJY29udGV4dElzRG9jdW1lbnQgPSAoY29udGV4dC5ub2RlVHlwZSA9PSA5KTsKCglpZiAodGhpcy5kb2N1bWVudCAhPT0gKGNvbnRleHRJc0RvY3VtZW50ID8gY29udGV4dCA6IGNvbnRleHQub3duZXJEb2N1bWVudCkpIHRoaXMuc2V0RG9jdW1lbnQoY29udGV4dCk7CgoJLy8gYXZvaWQgZHVwbGljYXRpbmcgaXRlbXMgYWxyZWFkeSBpbiB0aGUgYXBwZW5kIGFycmF5CglpZiAoaGFzT3RoZXJzKSBmb3IgKGkgPSBmb3VuZC5sZW5ndGg7IGktLTspIHVuaXF1ZXNbdGhpcy5nZXRVSUQoZm91bmRbaV0pXSA9IHRydWU7CgoJLy8gZXhwcmVzc2lvbiBjaGVja3MKCglpZiAodHlwZW9mIGV4cHJlc3Npb24gPT0gJ3N0cmluZycpeyAvLyBleHByZXNzaW9uIGlzIGEgc3RyaW5nCgoJCS8qPHNpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCQl2YXIgc2ltcGxlU2VsZWN0b3IgPSBleHByZXNzaW9uLm1hdGNoKHJlU2ltcGxlU2VsZWN0b3IpOwoJCXNpbXBsZVNlbGVjdG9yczogaWYgKHNpbXBsZVNlbGVjdG9yKSB7CgoJCQl2YXIgc3ltYm9sID0gc2ltcGxlU2VsZWN0b3JbMV0sCgkJCQluYW1lID0gc2ltcGxlU2VsZWN0b3JbMl0sCgkJCQlub2RlLCBub2RlczsKCgkJCWlmICghc3ltYm9sKXsKCgkJCQlpZiAobmFtZSA9PSAnKicgJiYgdGhpcy5icm9rZW5TdGFyR0VCVE4pIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGVzID0gY29udGV4dC5nZXRFbGVtZW50c0J5VGFnTmFtZShuYW1lKTsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIG5vZGVzWzBdIHx8IG51bGw7CgkJCQlmb3IgKGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQl9CgoJCQl9IGVsc2UgaWYgKHN5bWJvbCA9PSAnIycpewoKCQkJCWlmICghdGhpcy5pc0hUTUxEb2N1bWVudCB8fCAhY29udGV4dElzRG9jdW1lbnQpIGJyZWFrIHNpbXBsZVNlbGVjdG9yczsKCQkJCW5vZGUgPSBjb250ZXh0LmdldEVsZW1lbnRCeUlkKG5hbWUpOwoJCQkJaWYgKCFub2RlKSByZXR1cm4gZm91bmQ7CgkJCQlpZiAodGhpcy5pZEdldHNOYW1lICYmIG5vZGUuZ2V0QXR0cmlidXRlTm9kZSgnaWQnKS5ub2RlVmFsdWUgIT0gbmFtZSkgYnJlYWsgc2ltcGxlU2VsZWN0b3JzOwoJCQkJaWYgKGZpcnN0KSByZXR1cm4gbm9kZSB8fCBudWxsOwoJCQkJaWYgKCEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCgkJCX0gZWxzZSBpZiAoc3ltYm9sID09ICcuJyl7CgoJCQkJaWYgKCF0aGlzLmlzSFRNTERvY3VtZW50IHx8ICgoIWNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSB8fCB0aGlzLmJyb2tlbkdFQkNOKSAmJiBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwpKSBicmVhayBzaW1wbGVTZWxlY3RvcnM7CgkJCQlpZiAoY29udGV4dC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lICYmICF0aGlzLmJyb2tlbkdFQkNOKXsKCQkJCQlub2RlcyA9IGNvbnRleHQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShuYW1lKTsKCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2Rlc1swXSB8fCBudWxsOwoJCQkJCWZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQkJCWlmICghKGhhc090aGVycyAmJiB1bmlxdWVzW3RoaXMuZ2V0VUlEKG5vZGUpXSkpIGZvdW5kLnB1c2gobm9kZSk7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQl2YXIgbWF0Y2hDbGFzcyA9IG5ldyBSZWdFeHAoJyhefFxccyknKyBTbGljay5lc2NhcGVSZWdFeHAobmFtZSkgKycoXFxzfCQpJyk7CgkJCQkJbm9kZXMgPSBjb250ZXh0LmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJCQkJZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCQkJY2xhc3NOYW1lID0gbm9kZS5jbGFzc05hbWU7CgkJCQkJCWlmICghKGNsYXNzTmFtZSAmJiBtYXRjaENsYXNzLnRlc3QoY2xhc3NOYW1lKSkpIGNvbnRpbnVlOwoJCQkJCQlpZiAoZmlyc3QpIHJldHVybiBub2RlOwoJCQkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQkJCX0KCQkJCX0KCgkJCX0KCgkJCWlmIChoYXNPdGhlcnMpIHRoaXMuc29ydChmb3VuZCk7CgkJCXJldHVybiAoZmlyc3QpID8gbnVsbCA6IGZvdW5kOwoKCQl9CgkJLyo8L3NpbXBsZS1zZWxlY3RvcnMtb3ZlcnJpZGU+Ki8KCgkJLyo8cXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCQlxdWVyeVNlbGVjdG9yOiBpZiAoY29udGV4dC5xdWVyeVNlbGVjdG9yQWxsKSB7CgoJCQlpZiAoIXRoaXMuaXNIVE1MRG9jdW1lbnQKCQkJCXx8IHFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXQoJCQkJLy9UT0RPOiBvbmx5IHNraXAgd2hlbiBleHByZXNzaW9uIGlzIGFjdHVhbGx5IG1peGVkIGNhc2UKCQkJCXx8IHRoaXMuYnJva2VuTWl4ZWRDYXNlUVNBCgkJCQl8fCAodGhpcy5icm9rZW5DaGVja2VkUVNBICYmIGV4cHJlc3Npb24uaW5kZXhPZignOmNoZWNrZWQnKSA+IC0xKQoJCQkJfHwgKHRoaXMuYnJva2VuRW1wdHlBdHRyaWJ1dGVRU0EgJiYgcmVFbXB0eUF0dHJpYnV0ZS50ZXN0KGV4cHJlc3Npb24pKQoJCQkJfHwgKCFjb250ZXh0SXNEb2N1bWVudCAvL0Fib3J0IHdoZW4gIWNvbnRleHRJc0RvY3VtZW50IGFuZC4uLgoJCQkJCS8vICB0aGVyZSBhcmUgbXVsdGlwbGUgZXhwcmVzc2lvbnMgaW4gdGhlIHNlbGVjdG9yCgkJCQkJLy8gIHNpbmNlIHdlIGN1cnJlbnRseSBvbmx5IGZpeCBub24tZG9jdW1lbnQgcm9vdGVkIFFTQSBmb3Igc2luZ2xlIGV4cHJlc3Npb24gc2VsZWN0b3JzCgkJCQkJJiYgZXhwcmVzc2lvbi5pbmRleE9mKCcsJykgPiAtMQoJCQkJKQoJCQkJfHwgU2xpY2suZGlzYWJsZVFTQQoJCQkpIGJyZWFrIHF1ZXJ5U2VsZWN0b3I7CgoJCQl2YXIgX2V4cHJlc3Npb24gPSBleHByZXNzaW9uLCBfY29udGV4dCA9IGNvbnRleHQ7CgkJCWlmICghY29udGV4dElzRG9jdW1lbnQpewoJCQkJLy8gbm9uLWRvY3VtZW50IHJvb3RlZCBRU0EKCQkJCS8vIGNyZWRpdHMgdG8gQW5kcmV3IER1cG9udAoJCQkJdmFyIGN1cnJlbnRJZCA9IF9jb250ZXh0LmdldEF0dHJpYnV0ZSgnaWQnKSwgc2xpY2tpZCA9ICdzbGlja2lkX18nOwoJCQkJX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIHNsaWNraWQpOwoJCQkJX2V4cHJlc3Npb24gPSAnIycgKyBzbGlja2lkICsgJyAnICsgX2V4cHJlc3Npb247CgkJCQljb250ZXh0ID0gX2NvbnRleHQucGFyZW50Tm9kZTsKCQkJfQoKCQkJdHJ5IHsKCQkJCWlmIChmaXJzdCkgcmV0dXJuIGNvbnRleHQucXVlcnlTZWxlY3RvcihfZXhwcmVzc2lvbikgfHwgbnVsbDsKCQkJCWVsc2Ugbm9kZXMgPSBjb250ZXh0LnF1ZXJ5U2VsZWN0b3JBbGwoX2V4cHJlc3Npb24pOwoJCQl9IGNhdGNoKGUpIHsKCQkJCXFzYUZhaWxFeHBDYWNoZVtleHByZXNzaW9uXSA9IDE7CgkJCQlicmVhayBxdWVyeVNlbGVjdG9yOwoJCQl9IGZpbmFsbHkgewoJCQkJaWYgKCFjb250ZXh0SXNEb2N1bWVudCl7CgkJCQkJaWYgKGN1cnJlbnRJZCkgX2NvbnRleHQuc2V0QXR0cmlidXRlKCdpZCcsIGN1cnJlbnRJZCk7CgkJCQkJZWxzZSBfY29udGV4dC5yZW1vdmVBdHRyaWJ1dGUoJ2lkJyk7CgkJCQkJY29udGV4dCA9IF9jb250ZXh0OwoJCQkJfQoJCQl9CgoJCQlpZiAodGhpcy5zdGFyU2VsZWN0c0Nsb3NlZFFTQSkgZm9yIChpID0gMDsgbm9kZSA9IG5vZGVzW2krK107KXsKCQkJCWlmIChub2RlLm5vZGVOYW1lID4gJ0AnICYmICEoaGFzT3RoZXJzICYmIHVuaXF1ZXNbdGhpcy5nZXRVSUQobm9kZSldKSkgZm91bmQucHVzaChub2RlKTsKCQkJfSBlbHNlIGZvciAoaSA9IDA7IG5vZGUgPSBub2Rlc1tpKytdOyl7CgkJCQlpZiAoIShoYXNPdGhlcnMgJiYgdW5pcXVlc1t0aGlzLmdldFVJRChub2RlKV0pKSBmb3VuZC5wdXNoKG5vZGUpOwoJCQl9CgoJCQlpZiAoaGFzT3RoZXJzKSB0aGlzLnNvcnQoZm91bmQpOwoJCQlyZXR1cm4gZm91bmQ7CgoJCX0KCQkvKjwvcXVlcnktc2VsZWN0b3Itb3ZlcnJpZGU+Ki8KCgkJcGFyc2VkID0gdGhpcy5TbGljay5wYXJzZShleHByZXNzaW9uKTsKCQlpZiAoIXBhcnNlZC5sZW5ndGgpIHJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbiA9PSBudWxsKXsgLy8gdGhlcmUgaXMgbm8gZXhwcmVzc2lvbgoJCXJldHVybiBmb3VuZDsKCX0gZWxzZSBpZiAoZXhwcmVzc2lvbi5TbGljayl7IC8vIGV4cHJlc3Npb24gaXMgYSBwYXJzZWQgU2xpY2sgb2JqZWN0CgkJcGFyc2VkID0gZXhwcmVzc2lvbjsKCX0gZWxzZSBpZiAodGhpcy5jb250YWlucyhjb250ZXh0LmRvY3VtZW50RWxlbWVudCB8fCBjb250ZXh0LCBleHByZXNzaW9uKSl7IC8vIGV4cHJlc3Npb24gaXMgYSBub2RlCgkJKGZvdW5kKSA/IGZvdW5kLnB1c2goZXhwcmVzc2lvbikgOiBmb3VuZCA9IGV4cHJlc3Npb247CgkJcmV0dXJuIGZvdW5kOwoJfSBlbHNlIHsgLy8gb3RoZXIganVuawoJCXJldHVybiBmb3VuZDsKCX0KCgkvKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCgkvLyBjYWNoZSBlbGVtZW50cyBmb3IgdGhlIG50aCBzZWxlY3RvcnMKCgl0aGlzLnBvc05USCA9IHt9OwoJdGhpcy5wb3NOVEhMYXN0ID0ge307Cgl0aGlzLnBvc05USFR5cGUgPSB7fTsKCXRoaXMucG9zTlRIVHlwZUxhc3QgPSB7fTsKCgkvKjwvbnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8vKjwvcHNldWRvLXNlbGVjdG9ycz4qLwoKCS8vIGlmIGFwcGVuZCBpcyBudWxsIGFuZCB0aGVyZSBpcyBvbmx5IGEgc2luZ2xlIHNlbGVjdG9yIHdpdGggb25lIGV4cHJlc3Npb24gdXNlIHB1c2hBcnJheSwgZWxzZSB1c2UgcHVzaFVJRAoJdGhpcy5wdXNoID0gKCFoYXNPdGhlcnMgJiYgKGZpcnN0IHx8IChwYXJzZWQubGVuZ3RoID09IDEgJiYgcGFyc2VkLmV4cHJlc3Npb25zWzBdLmxlbmd0aCA9PSAxKSkpID8gdGhpcy5wdXNoQXJyYXkgOiB0aGlzLnB1c2hVSUQ7CgoJaWYgKGZvdW5kID09IG51bGwpIGZvdW5kID0gW107CgoJLy8gZGVmYXVsdCBlbmdpbmUKCgl2YXIgaiwgbSwgbjsKCXZhciBjb21iaW5hdG9yLCB0YWcsIGlkLCBjbGFzc0xpc3QsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3M7Cgl2YXIgY3VycmVudEl0ZW1zLCBjdXJyZW50RXhwcmVzc2lvbiwgY3VycmVudEJpdCwgbGFzdEJpdCwgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnM7CgoJc2VhcmNoOiBmb3IgKGkgPSAwOyAoY3VycmVudEV4cHJlc3Npb24gPSBleHByZXNzaW9uc1tpXSk7IGkrKykgZm9yIChqID0gMDsgKGN1cnJlbnRCaXQgPSBjdXJyZW50RXhwcmVzc2lvbltqXSk7IGorKyl7CgoJCWNvbWJpbmF0b3IgPSAnY29tYmluYXRvcjonICsgY3VycmVudEJpdC5jb21iaW5hdG9yOwoJCWlmICghdGhpc1tjb21iaW5hdG9yXSkgY29udGludWUgc2VhcmNoOwoKCQl0YWcgICAgICAgID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBjdXJyZW50Qml0LnRhZyA6IGN1cnJlbnRCaXQudGFnLnRvVXBwZXJDYXNlKCk7CgkJaWQgICAgICAgICA9IGN1cnJlbnRCaXQuaWQ7CgkJY2xhc3NMaXN0ICA9IGN1cnJlbnRCaXQuY2xhc3NMaXN0OwoJCWNsYXNzZXMgICAgPSBjdXJyZW50Qml0LmNsYXNzZXM7CgkJYXR0cmlidXRlcyA9IGN1cnJlbnRCaXQuYXR0cmlidXRlczsKCQlwc2V1ZG9zICAgID0gY3VycmVudEJpdC5wc2V1ZG9zOwoJCWxhc3RCaXQgICAgPSAoaiA9PT0gKGN1cnJlbnRFeHByZXNzaW9uLmxlbmd0aCAtIDEpKTsKCgkJdGhpcy5iaXRVbmlxdWVzID0ge307CgoJCWlmIChsYXN0Qml0KXsKCQkJdGhpcy51bmlxdWVzID0gdW5pcXVlczsKCQkJdGhpcy5mb3VuZCA9IGZvdW5kOwoJCX0gZWxzZSB7CgkJCXRoaXMudW5pcXVlcyA9IHt9OwoJCQl0aGlzLmZvdW5kID0gW107CgkJfQoKCQlpZiAoaiA9PT0gMCl7CgkJCXRoaXNbY29tYmluYXRvcl0oY29udGV4dCwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcywgY2xhc3NMaXN0KTsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQgJiYgZm91bmQubGVuZ3RoKSBicmVhayBzZWFyY2g7CgkJfSBlbHNlIHsKCQkJaWYgKGZpcnN0ICYmIGxhc3RCaXQpIGZvciAobSA9IDAsIG4gPSBjdXJyZW50SXRlbXMubGVuZ3RoOyBtIDwgbjsgbSsrKXsKCQkJCXRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCQkJaWYgKGZvdW5kLmxlbmd0aCkgYnJlYWsgc2VhcmNoOwoJCQl9IGVsc2UgZm9yIChtID0gMCwgbiA9IGN1cnJlbnRJdGVtcy5sZW5ndGg7IG0gPCBuOyBtKyspIHRoaXNbY29tYmluYXRvcl0oY3VycmVudEl0ZW1zW21dLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpOwoJCX0KCgkJY3VycmVudEl0ZW1zID0gdGhpcy5mb3VuZDsKCX0KCgkvLyBzaG91bGQgc29ydCBpZiB0aGVyZSBhcmUgbm9kZXMgaW4gYXBwZW5kIGFuZCBpZiB5b3UgcGFzcyBtdWx0aXBsZSBleHByZXNzaW9ucy4KCWlmIChoYXNPdGhlcnMgfHwgKHBhcnNlZC5leHByZXNzaW9ucy5sZW5ndGggPiAxKSkgdGhpcy5zb3J0KGZvdW5kKTsKCglyZXR1cm4gKGZpcnN0KSA/IChmb3VuZFswXSB8fCBudWxsKSA6IGZvdW5kOwp9OwoKLy8gVXRpbHMKCmxvY2FsLnVpZHggPSAxOwpsb2NhbC51aWRrID0gJ3NsaWNrLXVuaXF1ZWlkJzsKCmxvY2FsLmdldFVJRFhNTCA9IGZ1bmN0aW9uKG5vZGUpewoJdmFyIHVpZCA9IG5vZGUuZ2V0QXR0cmlidXRlKHRoaXMudWlkayk7CglpZiAoIXVpZCl7CgkJdWlkID0gdGhpcy51aWR4Kys7CgkJbm9kZS5zZXRBdHRyaWJ1dGUodGhpcy51aWRrLCB1aWQpOwoJfQoJcmV0dXJuIHVpZDsKfTsKCmxvY2FsLmdldFVJREhUTUwgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBub2RlLnVuaXF1ZU51bWJlciB8fCAobm9kZS51bmlxdWVOdW1iZXIgPSB0aGlzLnVpZHgrKyk7Cn07CgovLyBzb3J0IGJhc2VkIG9uIHRoZSBzZXREb2N1bWVudCBkb2N1bWVudFNvcnRlciBtZXRob2QuCgpsb2NhbC5zb3J0ID0gZnVuY3Rpb24ocmVzdWx0cyl7CglpZiAoIXRoaXMuZG9jdW1lbnRTb3J0ZXIpIHJldHVybiByZXN1bHRzOwoJcmVzdWx0cy5zb3J0KHRoaXMuZG9jdW1lbnRTb3J0ZXIpOwoJcmV0dXJuIHJlc3VsdHM7Cn07CgovKjxwc2V1ZG8tc2VsZWN0b3JzPiovLyo8bnRoLXBzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLmNhY2hlTlRIID0ge307Cgpsb2NhbC5tYXRjaE5USCA9IC9eKFsrLV0/XGQqKT8oW2Etel0rKT8oWystXVxkKyk/JC87Cgpsb2NhbC5wYXJzZU5USEFyZ3VtZW50ID0gZnVuY3Rpb24oYXJndW1lbnQpewoJdmFyIHBhcnNlZCA9IGFyZ3VtZW50Lm1hdGNoKHRoaXMubWF0Y2hOVEgpOwoJaWYgKCFwYXJzZWQpIHJldHVybiBmYWxzZTsKCXZhciBzcGVjaWFsID0gcGFyc2VkWzJdIHx8IGZhbHNlOwoJdmFyIGEgPSBwYXJzZWRbMV0gfHwgMTsKCWlmIChhID09ICctJykgYSA9IC0xOwoJdmFyIGIgPSArcGFyc2VkWzNdIHx8IDA7CglwYXJzZWQgPQoJCShzcGVjaWFsID09ICduJykJPyB7YTogYSwgYjogYn0gOgoJCShzcGVjaWFsID09ICdvZGQnKQk/IHthOiAyLCBiOiAxfSA6CgkJKHNwZWNpYWwgPT0gJ2V2ZW4nKQk/IHthOiAyLCBiOiAwfSA6IHthOiAwLCBiOiBhfTsKCglyZXR1cm4gKHRoaXMuY2FjaGVOVEhbYXJndW1lbnRdID0gcGFyc2VkKTsKfTsKCmxvY2FsLmNyZWF0ZU5USFBzZXVkbyA9IGZ1bmN0aW9uKGNoaWxkLCBzaWJsaW5nLCBwb3NpdGlvbnMsIG9mVHlwZSl7CglyZXR1cm4gZnVuY3Rpb24obm9kZSwgYXJndW1lbnQpewoJCXZhciB1aWQgPSB0aGlzLmdldFVJRChub2RlKTsKCQlpZiAoIXRoaXNbcG9zaXRpb25zXVt1aWRdKXsKCQkJdmFyIHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKCQkJaWYgKCFwYXJlbnQpIHJldHVybiBmYWxzZTsKCQkJdmFyIGVsID0gcGFyZW50W2NoaWxkXSwgY291bnQgPSAxOwoJCQlpZiAob2ZUeXBlKXsKCQkJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJCQlkbyB7CgkJCQkJaWYgKGVsLm5vZGVOYW1lICE9IG5vZGVOYW1lKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9IGVsc2UgewoJCQkJZG8gewoJCQkJCWlmIChlbC5ub2RlVHlwZSAhPSAxKSBjb250aW51ZTsKCQkJCQl0aGlzW3Bvc2l0aW9uc11bdGhpcy5nZXRVSUQoZWwpXSA9IGNvdW50Kys7CgkJCQl9IHdoaWxlICgoZWwgPSBlbFtzaWJsaW5nXSkpOwoJCQl9CgkJfQoJCWFyZ3VtZW50ID0gYXJndW1lbnQgfHwgJ24nOwoJCXZhciBwYXJzZWQgPSB0aGlzLmNhY2hlTlRIW2FyZ3VtZW50XSB8fCB0aGlzLnBhcnNlTlRIQXJndW1lbnQoYXJndW1lbnQpOwoJCWlmICghcGFyc2VkKSByZXR1cm4gZmFsc2U7CgkJdmFyIGEgPSBwYXJzZWQuYSwgYiA9IHBhcnNlZC5iLCBwb3MgPSB0aGlzW3Bvc2l0aW9uc11bdWlkXTsKCQlpZiAoYSA9PSAwKSByZXR1cm4gYiA9PSBwb3M7CgkJaWYgKGEgPiAwKXsKCQkJaWYgKHBvcyA8IGIpIHJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlpZiAoYiA8IHBvcykgcmV0dXJuIGZhbHNlOwoJCX0KCQlyZXR1cm4gKChwb3MgLSBiKSAlIGEpID09IDA7Cgl9Owp9OwoKLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovLyo8L3BzZXVkby1zZWxlY3RvcnM+Ki8KCmxvY2FsLnB1c2hBcnJheSA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKSkgdGhpcy5mb3VuZC5wdXNoKG5vZGUpOwp9OwoKbG9jYWwucHVzaFVJRCA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJdmFyIHVpZCA9IHRoaXMuZ2V0VUlEKG5vZGUpOwoJaWYgKCF0aGlzLnVuaXF1ZXNbdWlkXSAmJiB0aGlzLm1hdGNoU2VsZWN0b3Iobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcykpewoJCXRoaXMudW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQl0aGlzLmZvdW5kLnB1c2gobm9kZSk7Cgl9Cn07Cgpsb2NhbC5tYXRjaE5vZGUgPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CglpZiAodGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLm5hdGl2ZU1hdGNoZXNTZWxlY3Rvcil7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMubmF0aXZlTWF0Y2hlc1NlbGVjdG9yLmNhbGwobm9kZSwgc2VsZWN0b3IucmVwbGFjZSgvXFsoW149XSspPVxzKihbXiciXF1dKz8pXHMqXF0vZywgJ1skMT0iJDIiXScpKTsKCQl9IGNhdGNoKG1hdGNoRXJyb3IpIHt9Cgl9CgkKCXZhciBwYXJzZWQgPSB0aGlzLlNsaWNrLnBhcnNlKHNlbGVjdG9yKTsKCWlmICghcGFyc2VkKSByZXR1cm4gdHJ1ZTsKCgkvLyBzaW1wbGUgKHNpbmdsZSkgc2VsZWN0b3JzCgl2YXIgZXhwcmVzc2lvbnMgPSBwYXJzZWQuZXhwcmVzc2lvbnMsIHJldmVyc2VkRXhwcmVzc2lvbnMsIHNpbXBsZUV4cENvdW50ZXIgPSAwLCBpOwoJZm9yIChpID0gMDsgKGN1cnJlbnRFeHByZXNzaW9uID0gZXhwcmVzc2lvbnNbaV0pOyBpKyspewoJCWlmIChjdXJyZW50RXhwcmVzc2lvbi5sZW5ndGggPT0gMSl7CgkJCXZhciBleHAgPSBjdXJyZW50RXhwcmVzc2lvblswXTsKCQkJaWYgKHRoaXMubWF0Y2hTZWxlY3Rvcihub2RlLCAodGhpcy5pc1hNTERvY3VtZW50KSA/IGV4cC50YWcgOiBleHAudGFnLnRvVXBwZXJDYXNlKCksIGV4cC5pZCwgZXhwLmNsYXNzZXMsIGV4cC5hdHRyaWJ1dGVzLCBleHAucHNldWRvcykpIHJldHVybiB0cnVlOwoJCQlzaW1wbGVFeHBDb3VudGVyKys7CgkJfQoJfQoKCWlmIChzaW1wbGVFeHBDb3VudGVyID09IHBhcnNlZC5sZW5ndGgpIHJldHVybiBmYWxzZTsKCgl2YXIgbm9kZXMgPSB0aGlzLnNlYXJjaCh0aGlzLmRvY3VtZW50LCBwYXJzZWQpLCBpdGVtOwoJZm9yIChpID0gMDsgaXRlbSA9IG5vZGVzW2krK107KXsKCQlpZiAoaXRlbSA9PT0gbm9kZSkgcmV0dXJuIHRydWU7Cgl9CglyZXR1cm4gZmFsc2U7Cn07Cgpsb2NhbC5tYXRjaFBzZXVkbyA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUsIGFyZ3VtZW50KXsKCXZhciBwc2V1ZG9OYW1lID0gJ3BzZXVkbzonICsgbmFtZTsKCWlmICh0aGlzW3BzZXVkb05hbWVdKSByZXR1cm4gdGhpc1twc2V1ZG9OYW1lXShub2RlLCBhcmd1bWVudCk7Cgl2YXIgYXR0cmlidXRlID0gdGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgbmFtZSk7CglyZXR1cm4gKGFyZ3VtZW50KSA/IGFyZ3VtZW50ID09IGF0dHJpYnV0ZSA6ICEhYXR0cmlidXRlOwp9OwoKbG9jYWwubWF0Y2hTZWxlY3RvciA9IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpewoJaWYgKHRhZyl7CgkJdmFyIG5vZGVOYW1lID0gKHRoaXMuaXNYTUxEb2N1bWVudCkgPyBub2RlLm5vZGVOYW1lIDogbm9kZS5ub2RlTmFtZS50b1VwcGVyQ2FzZSgpOwoJCWlmICh0YWcgPT0gJyonKXsKCQkJaWYgKG5vZGVOYW1lIDwgJ0AnKSByZXR1cm4gZmFsc2U7IC8vIEZpeCBmb3IgY29tbWVudCBub2RlcyBhbmQgY2xvc2VkIG5vZGVzCgkJfSBlbHNlIHsKCQkJaWYgKG5vZGVOYW1lICE9IHRhZykgcmV0dXJuIGZhbHNlOwoJCX0KCX0KCglpZiAoaWQgJiYgbm9kZS5nZXRBdHRyaWJ1dGUoJ2lkJykgIT0gaWQpIHJldHVybiBmYWxzZTsKCgl2YXIgaSwgcGFydCwgY2xzOwoJaWYgKGNsYXNzZXMpIGZvciAoaSA9IGNsYXNzZXMubGVuZ3RoOyBpLS07KXsKCQljbHMgPSBub2RlLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCBub2RlLmNsYXNzTmFtZTsKCQlpZiAoIShjbHMgJiYgY2xhc3Nlc1tpXS5yZWdleHAudGVzdChjbHMpKSkgcmV0dXJuIGZhbHNlOwoJfQoJaWYgKGF0dHJpYnV0ZXMpIGZvciAoaSA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpLS07KXsKCQlwYXJ0ID0gYXR0cmlidXRlc1tpXTsKCQlpZiAocGFydC5vcGVyYXRvciA/ICFwYXJ0LnRlc3QodGhpcy5nZXRBdHRyaWJ1dGUobm9kZSwgcGFydC5rZXkpKSA6ICF0aGlzLmhhc0F0dHJpYnV0ZShub2RlLCBwYXJ0LmtleSkpIHJldHVybiBmYWxzZTsKCX0KCWlmIChwc2V1ZG9zKSBmb3IgKGkgPSBwc2V1ZG9zLmxlbmd0aDsgaS0tOyl7CgkJcGFydCA9IHBzZXVkb3NbaV07CgkJaWYgKCF0aGlzLm1hdGNoUHNldWRvKG5vZGUsIHBhcnQua2V5LCBwYXJ0LnZhbHVlKSkgcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn07Cgp2YXIgY29tYmluYXRvcnMgPSB7CgoJJyAnOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zLCBjbGFzc0xpc3QpeyAvLyBhbGwgY2hpbGQgbm9kZXMsIGFueSBsZXZlbAoKCQl2YXIgaSwgaXRlbSwgY2hpbGRyZW47CgoJCWlmICh0aGlzLmlzSFRNTERvY3VtZW50KXsKCQkJZ2V0QnlJZDogaWYgKGlkKXsKCQkJCWl0ZW0gPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGlkKTsKCQkJCWlmICgoIWl0ZW0gJiYgbm9kZS5hbGwpIHx8ICh0aGlzLmlkR2V0c05hbWUgJiYgaXRlbSAmJiBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJykubm9kZVZhbHVlICE9IGlkKSl7CgkJCQkJLy8gYWxsW2lkXSByZXR1cm5zIGFsbCB0aGUgZWxlbWVudHMgd2l0aCB0aGF0IG5hbWUgb3IgaWQgaW5zaWRlIG5vZGUKCQkJCQkvLyBpZiB0aGVyZXMganVzdCBvbmUgaXQgd2lsbCByZXR1cm4gdGhlIGVsZW1lbnQsIGVsc2UgaXQgd2lsbCBiZSBhIGNvbGxlY3Rpb24KCQkJCQljaGlsZHJlbiA9IG5vZGUuYWxsW2lkXTsKCQkJCQlpZiAoIWNoaWxkcmVuKSByZXR1cm47CgkJCQkJaWYgKCFjaGlsZHJlblswXSkgY2hpbGRyZW4gPSBbY2hpbGRyZW5dOwoJCQkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOyl7CgkJCQkJCXZhciBpZE5vZGUgPSBpdGVtLmdldEF0dHJpYnV0ZU5vZGUoJ2lkJyk7CgkJCQkJCWlmIChpZE5vZGUgJiYgaWROb2RlLm5vZGVWYWx1ZSA9PSBpZCl7CgkJCQkJCQl0aGlzLnB1c2goaXRlbSwgdGFnLCBudWxsLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCQkJCWJyZWFrOwoJCQkJCQl9CgkJCQkJfSAKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIWl0ZW0pewoJCQkJCS8vIGlmIHRoZSBjb250ZXh0IGlzIGluIHRoZSBkb20gd2UgcmV0dXJuLCBlbHNlIHdlIHdpbGwgdHJ5IEdFQlROLCBicmVha2luZyB0aGUgZ2V0QnlJZCBsYWJlbAoJCQkJCWlmICh0aGlzLmNvbnRhaW5zKHRoaXMucm9vdCwgbm9kZSkpIHJldHVybjsKCQkJCQllbHNlIGJyZWFrIGdldEJ5SWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuZG9jdW1lbnQgIT09IG5vZGUgJiYgIXRoaXMuY29udGFpbnMobm9kZSwgaXRlbSkpIHJldHVybjsKCQkJCXRoaXMucHVzaChpdGVtLCB0YWcsIG51bGwsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQkJcmV0dXJuOwoJCQl9CgkJCWdldEJ5Q2xhc3M6IGlmIChjbGFzc2VzICYmIG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSAmJiAhdGhpcy5icm9rZW5HRUJDTil7CgkJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShjbGFzc0xpc3Quam9pbignICcpKTsKCQkJCWlmICghKGNoaWxkcmVuICYmIGNoaWxkcmVuLmxlbmd0aCkpIGJyZWFrIGdldEJ5Q2xhc3M7CgkJCQlmb3IgKGkgPSAwOyBpdGVtID0gY2hpbGRyZW5baSsrXTspIHRoaXMucHVzaChpdGVtLCB0YWcsIGlkLCBudWxsLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCQlnZXRCeVRhZzogewoJCQljaGlsZHJlbiA9IG5vZGUuZ2V0RWxlbWVudHNCeVRhZ05hbWUodGFnKTsKCQkJaWYgKCEoY2hpbGRyZW4gJiYgY2hpbGRyZW4ubGVuZ3RoKSkgYnJlYWsgZ2V0QnlUYWc7CgkJCWlmICghdGhpcy5icm9rZW5TdGFyR0VCVE4pIHRhZyA9IG51bGw7CgkJCWZvciAoaSA9IDA7IGl0ZW0gPSBjaGlsZHJlbltpKytdOykgdGhpcy5wdXNoKGl0ZW0sIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJz4nOiBmdW5jdGlvbihub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKXsgLy8gZGlyZWN0IGNoaWxkcmVuCgkJaWYgKChub2RlID0gbm9kZS5maXJzdENoaWxkKSkgZG8gewoJCQlpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJfSB3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSk7Cgl9LAoKCScrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZwoJCXdoaWxlICgobm9kZSA9IG5vZGUubmV4dFNpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSdeJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGZpcnN0IGNoaWxkCgkJbm9kZSA9IG5vZGUuZmlyc3RDaGlsZDsKCQlpZiAobm9kZSl7CgkJCWlmIChub2RlLm5vZGVUeXBlID09IDEpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQkJZWxzZSB0aGlzWydjb21iaW5hdG9yOisnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSd+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MKCQl3aGlsZSAoKG5vZGUgPSBub2RlLm5leHRTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0sCgoJJysrJzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZyBhbmQgcHJldmlvdXMgc2libGluZwoJCXRoaXNbJ2NvbWJpbmF0b3I6KyddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCXRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJ35+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIG5leHQgc2libGluZ3MgYW5kIHByZXZpb3VzIHNpYmxpbmdzCgkJdGhpc1snY29tYmluYXRvcjp+J10obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7CgkJdGhpc1snY29tYmluYXRvcjohfiddKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJfSwKCgknISc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBhbGwgcGFyZW50IG5vZGVzIHVwIHRvIGRvY3VtZW50CgkJd2hpbGUgKChub2RlID0gbm9kZS5wYXJlbnROb2RlKSkgaWYgKG5vZGUgIT09IHRoaXMuZG9jdW1lbnQpIHRoaXMucHVzaChub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCX0sCgoJJyE+JzogZnVuY3Rpb24obm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyl7IC8vIGRpcmVjdCBwYXJlbnQgKG9uZSBsZXZlbCkKCQlub2RlID0gbm9kZS5wYXJlbnROb2RlOwoJCWlmIChub2RlICE9PSB0aGlzLmRvY3VtZW50KSB0aGlzLnB1c2gobm9kZSwgdGFnLCBpZCwgY2xhc3NlcywgYXR0cmlidXRlcywgcHNldWRvcyk7Cgl9LAoKCSchKyc6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5nCgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKXsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQlicmVhazsKCQl9Cgl9LAoKCSchXic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBsYXN0IGNoaWxkCgkJbm9kZSA9IG5vZGUubGFzdENoaWxkOwoJCWlmIChub2RlKXsKCQkJaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkgdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCQllbHNlIHRoaXNbJ2NvbWJpbmF0b3I6ISsnXShub2RlLCB0YWcsIGlkLCBjbGFzc2VzLCBhdHRyaWJ1dGVzLCBwc2V1ZG9zKTsKCQl9Cgl9LAoKCSchfic6IGZ1bmN0aW9uKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpeyAvLyBwcmV2aW91cyBzaWJsaW5ncwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSl7CgkJCWlmIChub2RlLm5vZGVUeXBlICE9IDEpIGNvbnRpbnVlOwoJCQl2YXIgdWlkID0gdGhpcy5nZXRVSUQobm9kZSk7CgkJCWlmICh0aGlzLmJpdFVuaXF1ZXNbdWlkXSkgYnJlYWs7CgkJCXRoaXMuYml0VW5pcXVlc1t1aWRdID0gdHJ1ZTsKCQkJdGhpcy5wdXNoKG5vZGUsIHRhZywgaWQsIGNsYXNzZXMsIGF0dHJpYnV0ZXMsIHBzZXVkb3MpOwoJCX0KCX0KCn07Cgpmb3IgKHZhciBjIGluIGNvbWJpbmF0b3JzKSBsb2NhbFsnY29tYmluYXRvcjonICsgY10gPSBjb21iaW5hdG9yc1tjXTsKCnZhciBwc2V1ZG9zID0gewoKCS8qPHBzZXVkby1zZWxlY3RvcnM+Ki8KCgknZW1wdHknOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgY2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CgkJcmV0dXJuICEoY2hpbGQgJiYgY2hpbGQubm9kZVR5cGUgPT0gMSkgJiYgIShub2RlLmlubmVyVGV4dCB8fCBub2RlLnRleHRDb250ZW50IHx8ICcnKS5sZW5ndGg7Cgl9LAoKCSdub3QnOiBmdW5jdGlvbihub2RlLCBleHByZXNzaW9uKXsKCQlyZXR1cm4gIXRoaXMubWF0Y2hOb2RlKG5vZGUsIGV4cHJlc3Npb24pOwoJfSwKCgknY29udGFpbnMnOiBmdW5jdGlvbihub2RlLCB0ZXh0KXsKCQlyZXR1cm4gKG5vZGUuaW5uZXJUZXh0IHx8IG5vZGUudGV4dENvbnRlbnQgfHwgJycpLmluZGV4T2YodGV4dCkgPiAtMTsKCX0sCgoJJ2ZpcnN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5wcmV2aW91c1NpYmxpbmcpKSBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdsYXN0LWNoaWxkJzogZnVuY3Rpb24obm9kZSl7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVUeXBlID09IDEpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ29ubHktY2hpbGQnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGU7CgkJd2hpbGUgKChwcmV2ID0gcHJldi5wcmV2aW91c1NpYmxpbmcpKSBpZiAocHJldi5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlVHlwZSA9PSAxKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCS8qPG50aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ250aC1jaGlsZCc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEgnKSwKCgknbnRoLWxhc3QtY2hpbGQnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRITGFzdCcpLAoKCSdudGgtb2YtdHlwZSc6IGxvY2FsLmNyZWF0ZU5USFBzZXVkbygnZmlyc3RDaGlsZCcsICduZXh0U2libGluZycsICdwb3NOVEhUeXBlJywgdHJ1ZSksCgoJJ250aC1sYXN0LW9mLXR5cGUnOiBsb2NhbC5jcmVhdGVOVEhQc2V1ZG8oJ2xhc3RDaGlsZCcsICdwcmV2aW91c1NpYmxpbmcnLCAncG9zTlRIVHlwZUxhc3QnLCB0cnVlKSwKCgknaW5kZXgnOiBmdW5jdGlvbihub2RlLCBpbmRleCl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnJyArIGluZGV4ICsgMSk7Cgl9LAoKCSdldmVuJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIHRoaXNbJ3BzZXVkbzpudGgtY2hpbGQnXShub2RlLCAnMm4nKTsKCX0sCgoJJ29kZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiB0aGlzWydwc2V1ZG86bnRoLWNoaWxkJ10obm9kZSwgJzJuKzEnKTsKCX0sCgoJLyo8L250aC1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLyo8b2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJJ2ZpcnN0LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgbm9kZU5hbWUgPSBub2RlLm5vZGVOYW1lOwoJCXdoaWxlICgobm9kZSA9IG5vZGUucHJldmlvdXNTaWJsaW5nKSkgaWYgKG5vZGUubm9kZU5hbWUgPT0gbm9kZU5hbWUpIHJldHVybiBmYWxzZTsKCQlyZXR1cm4gdHJ1ZTsKCX0sCgoJJ2xhc3Qtb2YtdHlwZSc6IGZ1bmN0aW9uKG5vZGUpewoJCXZhciBub2RlTmFtZSA9IG5vZGUubm9kZU5hbWU7CgkJd2hpbGUgKChub2RlID0gbm9kZS5uZXh0U2libGluZykpIGlmIChub2RlLm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJcmV0dXJuIHRydWU7Cgl9LAoKCSdvbmx5LW9mLXR5cGUnOiBmdW5jdGlvbihub2RlKXsKCQl2YXIgcHJldiA9IG5vZGUsIG5vZGVOYW1lID0gbm9kZS5ub2RlTmFtZTsKCQl3aGlsZSAoKHByZXYgPSBwcmV2LnByZXZpb3VzU2libGluZykpIGlmIChwcmV2Lm5vZGVOYW1lID09IG5vZGVOYW1lKSByZXR1cm4gZmFsc2U7CgkJdmFyIG5leHQgPSBub2RlOwoJCXdoaWxlICgobmV4dCA9IG5leHQubmV4dFNpYmxpbmcpKSBpZiAobmV4dC5ub2RlTmFtZSA9PSBub2RlTmFtZSkgcmV0dXJuIGZhbHNlOwoJCXJldHVybiB0cnVlOwoJfSwKCgkvKjwvb2YtdHlwZS1wc2V1ZG8tc2VsZWN0b3JzPiovCgoJLy8gY3VzdG9tIHBzZXVkb3MKCgknZW5hYmxlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAhbm9kZS5kaXNhYmxlZDsKCX0sCgoJJ2Rpc2FibGVkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuZGlzYWJsZWQ7Cgl9LAoKCSdjaGVja2VkJzogZnVuY3Rpb24obm9kZSl7CgkJcmV0dXJuIG5vZGUuY2hlY2tlZCB8fCBub2RlLnNlbGVjdGVkOwoJfSwKCgknZm9jdXMnOiBmdW5jdGlvbihub2RlKXsKCQlyZXR1cm4gdGhpcy5pc0hUTUxEb2N1bWVudCAmJiB0aGlzLmRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IG5vZGUgJiYgKG5vZGUuaHJlZiB8fCBub2RlLnR5cGUgfHwgdGhpcy5oYXNBdHRyaWJ1dGUobm9kZSwgJ3RhYmluZGV4JykpOwoJfSwKCgkncm9vdCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiAobm9kZSA9PT0gdGhpcy5yb290KTsKCX0sCgkKCSdzZWxlY3RlZCc6IGZ1bmN0aW9uKG5vZGUpewoJCXJldHVybiBub2RlLnNlbGVjdGVkOwoJfQoKCS8qPC9wc2V1ZG8tc2VsZWN0b3JzPiovCn07Cgpmb3IgKHZhciBwIGluIHBzZXVkb3MpIGxvY2FsWydwc2V1ZG86JyArIHBdID0gcHNldWRvc1twXTsKCi8vIGF0dHJpYnV0ZXMgbWV0aG9kcwoKbG9jYWwuYXR0cmlidXRlR2V0dGVycyA9IHsKCgknY2xhc3MnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgnY2xhc3MnKSB8fCB0aGlzLmNsYXNzTmFtZTsKCX0sCgoJJ2Zvcic6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuICgnaHRtbEZvcicgaW4gdGhpcykgPyB0aGlzLmh0bWxGb3IgOiB0aGlzLmdldEF0dHJpYnV0ZSgnZm9yJyk7Cgl9LAoKCSdocmVmJzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKCdocmVmJyBpbiB0aGlzKSA/IHRoaXMuZ2V0QXR0cmlidXRlKCdocmVmJywgMikgOiB0aGlzLmdldEF0dHJpYnV0ZSgnaHJlZicpOwoJfSwKCgknc3R5bGUnOiBmdW5jdGlvbigpewoJCXJldHVybiAodGhpcy5zdHlsZSkgPyB0aGlzLnN0eWxlLmNzc1RleHQgOiB0aGlzLmdldEF0dHJpYnV0ZSgnc3R5bGUnKTsKCX0sCgkKCSd0YWJpbmRleCc6IGZ1bmN0aW9uKCl7CgkJdmFyIGF0dHJpYnV0ZU5vZGUgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoJ3RhYmluZGV4Jyk7CgkJcmV0dXJuIChhdHRyaWJ1dGVOb2RlICYmIGF0dHJpYnV0ZU5vZGUuc3BlY2lmaWVkKSA/IGF0dHJpYnV0ZU5vZGUubm9kZVZhbHVlIDogbnVsbDsKCX0sCgoJJ3R5cGUnOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldEF0dHJpYnV0ZSgndHlwZScpOwoJfQoKfTsKCi8vIFNsaWNrCgp2YXIgU2xpY2sgPSBsb2NhbC5TbGljayA9ICh0aGlzLlNsaWNrIHx8IHt9KTsKClNsaWNrLnZlcnNpb24gPSAnMS4xLjUnOwoKLy8gU2xpY2sgZmluZGVyCgpTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwp9OwoKU2xpY2suZmluZCA9IGZ1bmN0aW9uKGNvbnRleHQsIGV4cHJlc3Npb24pewoJcmV0dXJuIGxvY2FsLnNlYXJjaChjb250ZXh0LCBleHByZXNzaW9uLCBudWxsLCB0cnVlKTsKfTsKCi8vIFNsaWNrIGNvbnRhaW5tZW50IGNoZWNrZXIKClNsaWNrLmNvbnRhaW5zID0gZnVuY3Rpb24oY29udGFpbmVyLCBub2RlKXsKCWxvY2FsLnNldERvY3VtZW50KGNvbnRhaW5lcik7CglyZXR1cm4gbG9jYWwuY29udGFpbnMoY29udGFpbmVyLCBub2RlKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBnZXR0ZXIKClNsaWNrLmdldEF0dHJpYnV0ZSA9IGZ1bmN0aW9uKG5vZGUsIG5hbWUpewoJcmV0dXJuIGxvY2FsLmdldEF0dHJpYnV0ZShub2RlLCBuYW1lKTsKfTsKCi8vIFNsaWNrIG1hdGNoZXIKClNsaWNrLm1hdGNoID0gZnVuY3Rpb24obm9kZSwgc2VsZWN0b3IpewoJaWYgKCEobm9kZSAmJiBzZWxlY3RvcikpIHJldHVybiBmYWxzZTsKCWlmICghc2VsZWN0b3IgfHwgc2VsZWN0b3IgPT09IG5vZGUpIHJldHVybiB0cnVlOwoJbG9jYWwuc2V0RG9jdW1lbnQobm9kZSk7CglyZXR1cm4gbG9jYWwubWF0Y2hOb2RlKG5vZGUsIHNlbGVjdG9yKTsKfTsKCi8vIFNsaWNrIGF0dHJpYnV0ZSBhY2Nlc3NvcgoKU2xpY2suZGVmaW5lQXR0cmlidXRlR2V0dGVyID0gZnVuY3Rpb24obmFtZSwgZm4pewoJbG9jYWwuYXR0cmlidXRlR2V0dGVyc1tuYW1lXSA9IGZuOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBBdHRyaWJ1dGVHZXR0ZXIgPSBmdW5jdGlvbihuYW1lKXsKCXJldHVybiBsb2NhbC5hdHRyaWJ1dGVHZXR0ZXJzW25hbWVdOwp9OwoKLy8gU2xpY2sgcHNldWRvIGFjY2Vzc29yCgpTbGljay5kZWZpbmVQc2V1ZG8gPSBmdW5jdGlvbihuYW1lLCBmbil7Cglsb2NhbFsncHNldWRvOicgKyBuYW1lXSA9IGZ1bmN0aW9uKG5vZGUsIGFyZ3VtZW50KXsKCQlyZXR1cm4gZm4uY2FsbChub2RlLCBhcmd1bWVudCk7Cgl9OwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5sb29rdXBQc2V1ZG8gPSBmdW5jdGlvbihuYW1lKXsKCXZhciBwc2V1ZG8gPSBsb2NhbFsncHNldWRvOicgKyBuYW1lXTsKCWlmIChwc2V1ZG8pIHJldHVybiBmdW5jdGlvbihhcmd1bWVudCl7CgkJcmV0dXJuIHBzZXVkby5jYWxsKHRoaXMsIGFyZ3VtZW50KTsKCX07CglyZXR1cm4gbnVsbDsKfTsKCi8vIFNsaWNrIG92ZXJyaWRlcyBhY2Nlc3NvcgoKU2xpY2sub3ZlcnJpZGUgPSBmdW5jdGlvbihyZWdleHAsIGZuKXsKCWxvY2FsLm92ZXJyaWRlKHJlZ2V4cCwgZm4pOwoJcmV0dXJuIHRoaXM7Cn07CgpTbGljay5pc1hNTCA9IGxvY2FsLmlzWE1MOwoKU2xpY2sudWlkT2YgPSBmdW5jdGlvbihub2RlKXsKCXJldHVybiBsb2NhbC5nZXRVSURIVE1MKG5vZGUpOwp9OwoKaWYgKCF0aGlzLlNsaWNrKSB0aGlzLlNsaWNrID0gU2xpY2s7Cgp9KS5hcHBseSgvKjxDb21tb25KUz4qLyh0eXBlb2YgZXhwb3J0cyAhPSAndW5kZWZpbmVkJykgPyBleHBvcnRzIDogLyo8L0NvbW1vbkpTPiovdGhpcyk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50CgpkZXNjcmlwdGlvbjogT25lIG9mIHRoZSBtb3N0IGltcG9ydGFudCBpdGVtcyBpbiBNb29Ub29scy4gQ29udGFpbnMgdGhlIGRvbGxhciBmdW5jdGlvbiwgdGhlIGRvbGxhcnMgZnVuY3Rpb24sIGFuZCBhbiBoYW5kZnVsIG9mIGNyb3NzLWJyb3dzZXIsIHRpbWUtc2F2ZXIgbWV0aG9kcyB0byBsZXQgeW91IGVhc2lseSB3b3JrIHdpdGggSFRNTCBFbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtXaW5kb3csIERvY3VtZW50LCBBcnJheSwgU3RyaW5nLCBGdW5jdGlvbiwgTnVtYmVyLCBTbGljay5QYXJzZXIsIFNsaWNrLkZpbmRlcl0KCnByb3ZpZGVzOiBbRWxlbWVudCwgRWxlbWVudHMsICQsICQkLCBJZnJhbWUsIFNlbGVjdG9yc10KCi4uLgoqLwoKdmFyIEVsZW1lbnQgPSBmdW5jdGlvbih0YWcsIHByb3BzKXsKCXZhciBrb25zdHJ1Y3RvciA9IEVsZW1lbnQuQ29uc3RydWN0b3JzW3RhZ107CglpZiAoa29uc3RydWN0b3IpIHJldHVybiBrb25zdHJ1Y3Rvcihwcm9wcyk7CglpZiAodHlwZW9mIHRhZyAhPSAnc3RyaW5nJykgcmV0dXJuIGRvY3VtZW50LmlkKHRhZykuc2V0KHByb3BzKTsKCglpZiAoIXByb3BzKSBwcm9wcyA9IHt9OwoKCWlmICghKC9eW1x3LV0rJC8pLnRlc3QodGFnKSl7CgkJdmFyIHBhcnNlZCA9IFNsaWNrLnBhcnNlKHRhZykuZXhwcmVzc2lvbnNbMF1bMF07CgkJdGFnID0gKHBhcnNlZC50YWcgPT0gJyonKSA/ICdkaXYnIDogcGFyc2VkLnRhZzsKCQlpZiAocGFyc2VkLmlkICYmIHByb3BzLmlkID09IG51bGwpIHByb3BzLmlkID0gcGFyc2VkLmlkOwoKCQl2YXIgYXR0cmlidXRlcyA9IHBhcnNlZC5hdHRyaWJ1dGVzOwoJCWlmIChhdHRyaWJ1dGVzKSBmb3IgKHZhciBpID0gMCwgbCA9IGF0dHJpYnV0ZXMubGVuZ3RoOyBpIDwgbDsgaSsrKXsKCQkJdmFyIGF0dHIgPSBhdHRyaWJ1dGVzW2ldOwoJCQlpZiAocHJvcHNbYXR0ci5rZXldICE9IG51bGwpIGNvbnRpbnVlOwoKCQkJaWYgKGF0dHIudmFsdWUgIT0gbnVsbCAmJiBhdHRyLm9wZXJhdG9yID09ICc9JykgcHJvcHNbYXR0ci5rZXldID0gYXR0ci52YWx1ZTsKCQkJZWxzZSBpZiAoIWF0dHIudmFsdWUgJiYgIWF0dHIub3BlcmF0b3IpIHByb3BzW2F0dHIua2V5XSA9IHRydWU7CgkJfQoKCQlpZiAocGFyc2VkLmNsYXNzTGlzdCAmJiBwcm9wc1snY2xhc3MnXSA9PSBudWxsKSBwcm9wc1snY2xhc3MnXSA9IHBhcnNlZC5jbGFzc0xpc3Quam9pbignICcpOwoJfQoKCXJldHVybiBkb2N1bWVudC5uZXdFbGVtZW50KHRhZywgcHJvcHMpOwp9OwoKaWYgKEJyb3dzZXIuRWxlbWVudCkgRWxlbWVudC5wcm90b3R5cGUgPSBCcm93c2VyLkVsZW1lbnQucHJvdG90eXBlOwoKbmV3IFR5cGUoJ0VsZW1lbnQnLCBFbGVtZW50KS5taXJyb3IoZnVuY3Rpb24obmFtZSl7CglpZiAoQXJyYXkucHJvdG90eXBlW25hbWVdKSByZXR1cm47CgoJdmFyIG9iaiA9IHt9OwoJb2JqW25hbWVdID0gZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0cyA9IFtdLCBhcmdzID0gYXJndW1lbnRzLCBlbGVtZW50cyA9IHRydWU7CgkJZm9yICh2YXIgaSA9IDAsIGwgPSB0aGlzLmxlbmd0aDsgaSA8IGw7IGkrKyl7CgkJCXZhciBlbGVtZW50ID0gdGhpc1tpXSwgcmVzdWx0ID0gcmVzdWx0c1tpXSA9IGVsZW1lbnRbbmFtZV0uYXBwbHkoZWxlbWVudCwgYXJncyk7CgkJCWVsZW1lbnRzID0gKGVsZW1lbnRzICYmIHR5cGVPZihyZXN1bHQpID09ICdlbGVtZW50Jyk7CgkJfQoJCXJldHVybiAoZWxlbWVudHMpID8gbmV3IEVsZW1lbnRzKHJlc3VsdHMpIDogcmVzdWx0czsKCX07CgoJRWxlbWVudHMuaW1wbGVtZW50KG9iaik7Cn0pOwoKaWYgKCFCcm93c2VyLkVsZW1lbnQpewoJRWxlbWVudC5wYXJlbnQgPSBPYmplY3Q7CgoJRWxlbWVudC5Qcm90b3R5cGUgPSB7JyRmYW1pbHknOiBGdW5jdGlvbi5mcm9tKCdlbGVtZW50JykuaGlkZSgpfTsKCglFbGVtZW50Lm1pcnJvcihmdW5jdGlvbihuYW1lLCBtZXRob2QpewoJCUVsZW1lbnQuUHJvdG90eXBlW25hbWVdID0gbWV0aG9kOwoJfSk7Cn0KCkVsZW1lbnQuQ29uc3RydWN0b3JzID0ge307CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LkNvbnN0cnVjdG9ycyA9IG5ldyBIYXNoOwoKLy88LzEuMmNvbXBhdD4KCnZhciBJRnJhbWUgPSBuZXcgVHlwZSgnSUZyYW1lJywgZnVuY3Rpb24oKXsKCXZhciBwYXJhbXMgPSBBcnJheS5saW5rKGFyZ3VtZW50cywgewoJCXByb3BlcnRpZXM6IFR5cGUuaXNPYmplY3QsCgkJaWZyYW1lOiBmdW5jdGlvbihvYmopewoJCQlyZXR1cm4gKG9iaiAhPSBudWxsKTsKCQl9Cgl9KTsKCgl2YXIgcHJvcHMgPSBwYXJhbXMucHJvcGVydGllcyB8fCB7fSwgaWZyYW1lOwoJaWYgKHBhcmFtcy5pZnJhbWUpIGlmcmFtZSA9IGRvY3VtZW50LmlkKHBhcmFtcy5pZnJhbWUpOwoJdmFyIG9ubG9hZCA9IHByb3BzLm9ubG9hZCB8fCBmdW5jdGlvbigpe307CglkZWxldGUgcHJvcHMub25sb2FkOwoJcHJvcHMuaWQgPSBwcm9wcy5uYW1lID0gW3Byb3BzLmlkLCBwcm9wcy5uYW1lLCBpZnJhbWUgPyAoaWZyYW1lLmlkIHx8IGlmcmFtZS5uYW1lKSA6ICdJRnJhbWVfJyArIFN0cmluZy51bmlxdWVJRCgpXS5waWNrKCk7CglpZnJhbWUgPSBuZXcgRWxlbWVudChpZnJhbWUgfHwgJ2lmcmFtZScsIHByb3BzKTsKCgl2YXIgb25Mb2FkID0gZnVuY3Rpb24oKXsKCQlvbmxvYWQuY2FsbChpZnJhbWUuY29udGVudFdpbmRvdyk7Cgl9OwoKCWlmICh3aW5kb3cuZnJhbWVzW3Byb3BzLmlkXSkgb25Mb2FkKCk7CgllbHNlIGlmcmFtZS5hZGRMaXN0ZW5lcignbG9hZCcsIG9uTG9hZCk7CglyZXR1cm4gaWZyYW1lOwp9KTsKCnZhciBFbGVtZW50cyA9IHRoaXMuRWxlbWVudHMgPSBmdW5jdGlvbihub2Rlcyl7CglpZiAobm9kZXMgJiYgbm9kZXMubGVuZ3RoKXsKCQl2YXIgdW5pcXVlcyA9IHt9LCBub2RlOwoJCWZvciAodmFyIGkgPSAwOyBub2RlID0gbm9kZXNbaSsrXTspewoJCQl2YXIgdWlkID0gU2xpY2sudWlkT2Yobm9kZSk7CgkJCWlmICghdW5pcXVlc1t1aWRdKXsKCQkJCXVuaXF1ZXNbdWlkXSA9IHRydWU7CgkJCQl0aGlzLnB1c2gobm9kZSk7CgkJCX0KCQl9Cgl9Cn07CgpFbGVtZW50cy5wcm90b3R5cGUgPSB7bGVuZ3RoOiAwfTsKRWxlbWVudHMucGFyZW50ID0gQXJyYXk7CgpuZXcgVHlwZSgnRWxlbWVudHMnLCBFbGVtZW50cykuaW1wbGVtZW50KHsKCglmaWx0ZXI6IGZ1bmN0aW9uKGZpbHRlciwgYmluZCl7CgkJaWYgKCFmaWx0ZXIpIHJldHVybiB0aGlzOwoJCXJldHVybiBuZXcgRWxlbWVudHMoQXJyYXkuZmlsdGVyKHRoaXMsICh0eXBlT2YoZmlsdGVyKSA9PSAnc3RyaW5nJykgPyBmdW5jdGlvbihpdGVtKXsKCQkJcmV0dXJuIGl0ZW0ubWF0Y2goZmlsdGVyKTsKCQl9IDogZmlsdGVyLCBiaW5kKSk7Cgl9LnByb3RlY3QoKSwKCglwdXNoOiBmdW5jdGlvbigpewoJCXZhciBsZW5ndGggPSB0aGlzLmxlbmd0aDsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSB0aGlzW2xlbmd0aCsrXSA9IGl0ZW07CgkJfQoJCXJldHVybiAodGhpcy5sZW5ndGggPSBsZW5ndGgpOwoJfS5wcm90ZWN0KCksCgoJdW5zaGlmdDogZnVuY3Rpb24oKXsKCQl2YXIgaXRlbXMgPSBbXTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGRvY3VtZW50LmlkKGFyZ3VtZW50c1tpXSk7CgkJCWlmIChpdGVtKSBpdGVtcy5wdXNoKGl0ZW0pOwoJCX0KCQlyZXR1cm4gQXJyYXkucHJvdG90eXBlLnVuc2hpZnQuYXBwbHkodGhpcywgaXRlbXMpOwoJfS5wcm90ZWN0KCksCgoJY29uY2F0OiBmdW5jdGlvbigpewoJCXZhciBuZXdFbGVtZW50cyA9IG5ldyBFbGVtZW50cyh0aGlzKTsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCQl2YXIgaXRlbSA9IGFyZ3VtZW50c1tpXTsKCQkJaWYgKFR5cGUuaXNFbnVtZXJhYmxlKGl0ZW0pKSBuZXdFbGVtZW50cy5hcHBlbmQoaXRlbSk7CgkJCWVsc2UgbmV3RWxlbWVudHMucHVzaChpdGVtKTsKCQl9CgkJcmV0dXJuIG5ld0VsZW1lbnRzOwoJfS5wcm90ZWN0KCksCgoJYXBwZW5kOiBmdW5jdGlvbihjb2xsZWN0aW9uKXsKCQlmb3IgKHZhciBpID0gMCwgbCA9IGNvbGxlY3Rpb24ubGVuZ3RoOyBpIDwgbDsgaSsrKSB0aGlzLnB1c2goY29sbGVjdGlvbltpXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LnByb3RlY3QoKSwKCgllbXB0eTogZnVuY3Rpb24oKXsKCQl3aGlsZSAodGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzWy0tdGhpcy5sZW5ndGhdOwoJCXJldHVybiB0aGlzOwoJfS5wcm90ZWN0KCkKCn0pOwoKLy88MS4yY29tcGF0PgoKRWxlbWVudHMuYWxpYXMoJ2V4dGVuZCcsICdhcHBlbmQnKTsKCi8vPC8xLjJjb21wYXQ+CgooZnVuY3Rpb24oKXsKCi8vIEZGLCBJRQp2YXIgc3BsaWNlID0gQXJyYXkucHJvdG90eXBlLnNwbGljZSwgb2JqZWN0ID0geycwJzogMCwgJzEnOiAxLCBsZW5ndGg6IDJ9OwoKc3BsaWNlLmNhbGwob2JqZWN0LCAxLCAxKTsKaWYgKG9iamVjdFsxXSA9PSAxKSBFbGVtZW50cy5pbXBsZW1lbnQoJ3NwbGljZScsIGZ1bmN0aW9uKCl7Cgl2YXIgbGVuZ3RoID0gdGhpcy5sZW5ndGg7CglzcGxpY2UuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCXdoaWxlIChsZW5ndGggPj0gdGhpcy5sZW5ndGgpIGRlbGV0ZSB0aGlzW2xlbmd0aC0tXTsKCXJldHVybiB0aGlzOwp9LnByb3RlY3QoKSk7CgpFbGVtZW50cy5pbXBsZW1lbnQoQXJyYXkucHJvdG90eXBlKTsKCkFycmF5Lm1pcnJvcihFbGVtZW50cyk7CgovKjxsdElFOD4qLwp2YXIgY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MOwp0cnkgewoJdmFyIHggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCc8aW5wdXQgbmFtZT14PicpOwoJY3JlYXRlRWxlbWVudEFjY2VwdHNIVE1MID0gKHgubmFtZSA9PSAneCcpOwp9IGNhdGNoKGUpe30KCnZhciBlc2NhcGVRdW90ZXMgPSBmdW5jdGlvbihodG1sKXsKCXJldHVybiAoJycgKyBodG1sKS5yZXBsYWNlKC8mL2csICcmYW1wOycpLnJlcGxhY2UoLyIvZywgJyZxdW90OycpOwp9OwovKjwvbHRJRTg+Ki8KCkRvY3VtZW50LmltcGxlbWVudCh7CgoJbmV3RWxlbWVudDogZnVuY3Rpb24odGFnLCBwcm9wcyl7CgkJaWYgKHByb3BzICYmIHByb3BzLmNoZWNrZWQgIT0gbnVsbCkgcHJvcHMuZGVmYXVsdENoZWNrZWQgPSBwcm9wcy5jaGVja2VkOwoJCS8qPGx0SUU4PiovLy8gRml4IGZvciByZWFkb25seSBuYW1lIGFuZCB0eXBlIHByb3BlcnRpZXMgaW4gSUUgPCA4CgkJaWYgKGNyZWF0ZUVsZW1lbnRBY2NlcHRzSFRNTCAmJiBwcm9wcyl7CgkJCXRhZyA9ICc8JyArIHRhZzsKCQkJaWYgKHByb3BzLm5hbWUpIHRhZyArPSAnIG5hbWU9IicgKyBlc2NhcGVRdW90ZXMocHJvcHMubmFtZSkgKyAnIic7CgkJCWlmIChwcm9wcy50eXBlKSB0YWcgKz0gJyB0eXBlPSInICsgZXNjYXBlUXVvdGVzKHByb3BzLnR5cGUpICsgJyInOwoJCQl0YWcgKz0gJz4nOwoJCQlkZWxldGUgcHJvcHMubmFtZTsKCQkJZGVsZXRlIHByb3BzLnR5cGU7CgkJfQoJCS8qPC9sdElFOD4qLwoJCXJldHVybiB0aGlzLmlkKHRoaXMuY3JlYXRlRWxlbWVudCh0YWcpKS5zZXQocHJvcHMpOwoJfQoKfSk7Cgp9KSgpOwoKRG9jdW1lbnQuaW1wbGVtZW50KHsKCgluZXdUZXh0Tm9kZTogZnVuY3Rpb24odGV4dCl7CgkJcmV0dXJuIHRoaXMuY3JlYXRlVGV4dE5vZGUodGV4dCk7Cgl9LAoKCWdldERvY3VtZW50OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRXaW5kb3c6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMud2luZG93OwoJfSwKCglpZDogKGZ1bmN0aW9uKCl7CgoJCXZhciB0eXBlcyA9IHsKCgkJCXN0cmluZzogZnVuY3Rpb24oaWQsIG5vY2FzaCwgZG9jKXsKCQkJCWlkID0gU2xpY2suZmluZChkb2MsICcjJyArIGlkLnJlcGxhY2UoLyhcVykvZywgJ1xcJDEnKSk7CgkJCQlyZXR1cm4gKGlkKSA/IHR5cGVzLmVsZW1lbnQoaWQsIG5vY2FzaCkgOiBudWxsOwoJCQl9LAoKCQkJZWxlbWVudDogZnVuY3Rpb24oZWwsIG5vY2FzaCl7CgkJCQkkdWlkKGVsKTsKCQkJCWlmICghbm9jYXNoICYmICFlbC4kZmFtaWx5ICYmICEoL14oPzpvYmplY3R8ZW1iZWQpJC9pKS50ZXN0KGVsLnRhZ05hbWUpKXsKCQkJCQlPYmplY3QuYXBwZW5kKGVsLCBFbGVtZW50LlByb3RvdHlwZSk7CgkJCQl9CgkJCQlyZXR1cm4gZWw7CgkJCX0sCgoJCQlvYmplY3Q6IGZ1bmN0aW9uKG9iaiwgbm9jYXNoLCBkb2MpewoJCQkJaWYgKG9iai50b0VsZW1lbnQpIHJldHVybiB0eXBlcy5lbGVtZW50KG9iai50b0VsZW1lbnQoZG9jKSwgbm9jYXNoKTsKCQkJCXJldHVybiBudWxsOwoJCQl9CgoJCX07CgoJCXR5cGVzLnRleHRub2RlID0gdHlwZXMud2hpdGVzcGFjZSA9IHR5cGVzLndpbmRvdyA9IHR5cGVzLmRvY3VtZW50ID0gZnVuY3Rpb24oemVybyl7CgkJCXJldHVybiB6ZXJvOwoJCX07CgoJCXJldHVybiBmdW5jdGlvbihlbCwgbm9jYXNoLCBkb2MpewoJCQlpZiAoZWwgJiYgZWwuJGZhbWlseSAmJiBlbC51aWQpIHJldHVybiBlbDsKCQkJdmFyIHR5cGUgPSB0eXBlT2YoZWwpOwoJCQlyZXR1cm4gKHR5cGVzW3R5cGVdKSA/IHR5cGVzW3R5cGVdKGVsLCBub2Nhc2gsIGRvYyB8fCBkb2N1bWVudCkgOiBudWxsOwoJCX07CgoJfSkoKQoKfSk7CgppZiAod2luZG93LiQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCcsIGZ1bmN0aW9uKGVsLCBuYyl7CglyZXR1cm4gZG9jdW1lbnQuaWQoZWwsIG5jLCB0aGlzLmRvY3VtZW50KTsKfSk7CgpXaW5kb3cuaW1wbGVtZW50KHsKCglnZXREb2N1bWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5kb2N1bWVudDsKCX0sCgoJZ2V0V2luZG93OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpbRG9jdW1lbnQsIEVsZW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldEVsZW1lbnRzOiBmdW5jdGlvbihleHByZXNzaW9uKXsKCQlyZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMsIGV4cHJlc3Npb24sIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldEVsZW1lbnQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGV4cHJlc3Npb24pKTsKCX0KCn0pOwoKLy88MS4yY29tcGF0PgoKKGZ1bmN0aW9uKHNlYXJjaCwgZmluZCwgbWF0Y2gpewoKCXRoaXMuU2VsZWN0b3JzID0ge307Cgl2YXIgcHNldWRvcyA9IHRoaXMuU2VsZWN0b3JzLlBzZXVkbyA9IG5ldyBIYXNoKCk7CgoJdmFyIGFkZFNsaWNrUHNldWRvcyA9IGZ1bmN0aW9uKCl7CgkJZm9yICh2YXIgbmFtZSBpbiBwc2V1ZG9zKSBpZiAocHNldWRvcy5oYXNPd25Qcm9wZXJ0eShuYW1lKSl7CgkJCVNsaWNrLmRlZmluZVBzZXVkbyhuYW1lLCBwc2V1ZG9zW25hbWVdKTsKCQkJZGVsZXRlIHBzZXVkb3NbbmFtZV07CgkJfQoJfTsKCglTbGljay5zZWFyY2ggPSBmdW5jdGlvbihjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpewoJCWFkZFNsaWNrUHNldWRvcygpOwoJCXJldHVybiBzZWFyY2guY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uLCBhcHBlbmQpOwoJfTsKCglTbGljay5maW5kID0gZnVuY3Rpb24oY29udGV4dCwgZXhwcmVzc2lvbil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIGZpbmQuY2FsbCh0aGlzLCBjb250ZXh0LCBleHByZXNzaW9uKTsKCX07CgoJU2xpY2subWF0Y2ggPSBmdW5jdGlvbihub2RlLCBzZWxlY3Rvcil7CgkJYWRkU2xpY2tQc2V1ZG9zKCk7CgkJcmV0dXJuIG1hdGNoLmNhbGwodGhpcywgbm9kZSwgc2VsZWN0b3IpOwoJfTsKCn0pKFNsaWNrLnNlYXJjaCwgU2xpY2suZmluZCwgU2xpY2subWF0Y2gpOwoKaWYgKHdpbmRvdy4kJCA9PSBudWxsKSBXaW5kb3cuaW1wbGVtZW50KCckJCcsIGZ1bmN0aW9uKHNlbGVjdG9yKXsKCXZhciBlbGVtZW50cyA9IG5ldyBFbGVtZW50czsKCWlmIChhcmd1bWVudHMubGVuZ3RoID09IDEgJiYgdHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnKSByZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHNlbGVjdG9yLCBlbGVtZW50cyk7Cgl2YXIgYXJncyA9IEFycmF5LmZsYXR0ZW4oYXJndW1lbnRzKTsKCWZvciAodmFyIGkgPSAwLCBsID0gYXJncy5sZW5ndGg7IGkgPCBsOyBpKyspewoJCXZhciBpdGVtID0gYXJnc1tpXTsKCQlzd2l0Y2ggKHR5cGVPZihpdGVtKSl7CgkJCWNhc2UgJ2VsZW1lbnQnOiBlbGVtZW50cy5wdXNoKGl0ZW0pOyBicmVhazsKCQkJY2FzZSAnc3RyaW5nJzogU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIGl0ZW0sIGVsZW1lbnRzKTsKCQl9Cgl9CglyZXR1cm4gZWxlbWVudHM7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCmlmICh3aW5kb3cuJCQgPT0gbnVsbCkgV2luZG93LmltcGxlbWVudCgnJCQnLCBmdW5jdGlvbihzZWxlY3Rvcil7CglpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQlpZiAodHlwZW9mIHNlbGVjdG9yID09ICdzdHJpbmcnKSByZXR1cm4gU2xpY2suc2VhcmNoKHRoaXMuZG9jdW1lbnQsIHNlbGVjdG9yLCBuZXcgRWxlbWVudHMpOwoJCWVsc2UgaWYgKFR5cGUuaXNFbnVtZXJhYmxlKHNlbGVjdG9yKSkgcmV0dXJuIG5ldyBFbGVtZW50cyhzZWxlY3Rvcik7Cgl9CglyZXR1cm4gbmV3IEVsZW1lbnRzKGFyZ3VtZW50cyk7Cn0pOwoKKGZ1bmN0aW9uKCl7Cgp2YXIgY29sbGVjdGVkID0ge30sIHN0b3JhZ2UgPSB7fTsKdmFyIGZvcm1Qcm9wcyA9IHtpbnB1dDogJ2NoZWNrZWQnLCBvcHRpb246ICdzZWxlY3RlZCcsIHRleHRhcmVhOiAndmFsdWUnfTsKCnZhciBnZXQgPSBmdW5jdGlvbih1aWQpewoJcmV0dXJuIChzdG9yYWdlW3VpZF0gfHwgKHN0b3JhZ2VbdWlkXSA9IHt9KSk7Cn07Cgp2YXIgY2xlYW4gPSBmdW5jdGlvbihpdGVtKXsKCXZhciB1aWQgPSBpdGVtLnVpZDsKCWlmIChpdGVtLnJlbW92ZUV2ZW50cykgaXRlbS5yZW1vdmVFdmVudHMoKTsKCWlmIChpdGVtLmNsZWFyQXR0cmlidXRlcykgaXRlbS5jbGVhckF0dHJpYnV0ZXMoKTsKCWlmICh1aWQgIT0gbnVsbCl7CgkJZGVsZXRlIGNvbGxlY3RlZFt1aWRdOwoJCWRlbGV0ZSBzdG9yYWdlW3VpZF07Cgl9CglyZXR1cm4gaXRlbTsKfTsKCnZhciBjYW1lbHMgPSBbJ2RlZmF1bHRWYWx1ZScsICdhY2Nlc3NLZXknLCAnY2VsbFBhZGRpbmcnLCAnY2VsbFNwYWNpbmcnLCAnY29sU3BhbicsICdmcmFtZUJvcmRlcicsICdtYXhMZW5ndGgnLCAncmVhZE9ubHknLAoJJ3Jvd1NwYW4nLCAndGFiSW5kZXgnLCAndXNlTWFwJwpdOwp2YXIgYm9vbHMgPSBbJ2NvbXBhY3QnLCAnbm93cmFwJywgJ2lzbWFwJywgJ2RlY2xhcmUnLCAnbm9zaGFkZScsICdjaGVja2VkJywgJ2Rpc2FibGVkJywgJ3JlYWRPbmx5JywgJ211bHRpcGxlJywgJ3NlbGVjdGVkJywKCSdub3Jlc2l6ZScsICdkZWZlcicsICdkZWZhdWx0Q2hlY2tlZCcKXTsKIHZhciBhdHRyaWJ1dGVzID0gewoJJ2h0bWwnOiAnaW5uZXJIVE1MJywKCSdjbGFzcyc6ICdjbGFzc05hbWUnLAoJJ2Zvcic6ICdodG1sRm9yJywKCSd0ZXh0JzogKGZ1bmN0aW9uKCl7CgkJdmFyIHRlbXAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKCQlyZXR1cm4gKHRlbXAudGV4dENvbnRlbnQgPT0gbnVsbCkgPyAnaW5uZXJUZXh0JyA6ICd0ZXh0Q29udGVudCc7Cgl9KSgpCn07CnZhciByZWFkT25seSA9IFsndHlwZSddOwp2YXIgZXhwYW5kb3MgPSBbJ3ZhbHVlJywgJ2RlZmF1bHRWYWx1ZSddOwp2YXIgdXJpQXR0cnMgPSAvXig/OmhyZWZ8c3JjfHVzZW1hcCkkL2k7Cgpib29scyA9IGJvb2xzLmFzc29jaWF0ZShib29scyk7CmNhbWVscyA9IGNhbWVscy5hc3NvY2lhdGUoY2FtZWxzLm1hcChTdHJpbmcudG9Mb3dlckNhc2UpKTsKcmVhZE9ubHkgPSByZWFkT25seS5hc3NvY2lhdGUocmVhZE9ubHkpOwoKT2JqZWN0LmFwcGVuZChhdHRyaWJ1dGVzLCBleHBhbmRvcy5hc3NvY2lhdGUoZXhwYW5kb3MpKTsKCnZhciBpbnNlcnRlcnMgPSB7CgoJYmVmb3JlOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCWlmIChwYXJlbnQpIHBhcmVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudCk7Cgl9LAoKCWFmdGVyOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCWlmIChwYXJlbnQpIHBhcmVudC5pbnNlcnRCZWZvcmUoY29udGV4dCwgZWxlbWVudC5uZXh0U2libGluZyk7Cgl9LAoKCWJvdHRvbTogZnVuY3Rpb24oY29udGV4dCwgZWxlbWVudCl7CgkJZWxlbWVudC5hcHBlbmRDaGlsZChjb250ZXh0KTsKCX0sCgoJdG9wOiBmdW5jdGlvbihjb250ZXh0LCBlbGVtZW50KXsKCQllbGVtZW50Lmluc2VydEJlZm9yZShjb250ZXh0LCBlbGVtZW50LmZpcnN0Q2hpbGQpOwoJfQoKfTsKCmluc2VydGVycy5pbnNpZGUgPSBpbnNlcnRlcnMuYm90dG9tOwoKLy88MS4yY29tcGF0PgoKT2JqZWN0LmVhY2goaW5zZXJ0ZXJzLCBmdW5jdGlvbihpbnNlcnRlciwgd2hlcmUpewoKCXdoZXJlID0gd2hlcmUuY2FwaXRhbGl6ZSgpOwoKCXZhciBtZXRob2RzID0ge307CgoJbWV0aG9kc1snaW5qZWN0JyArIHdoZXJlXSA9IGZ1bmN0aW9uKGVsKXsKCQlpbnNlcnRlcih0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfTsKCgltZXRob2RzWydncmFiJyArIHdoZXJlXSA9IGZ1bmN0aW9uKGVsKXsKCQlpbnNlcnRlcihkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfTsKCglFbGVtZW50LmltcGxlbWVudChtZXRob2RzKTsKCn0pOwoKLy88LzEuMmNvbXBhdD4KCnZhciBpbmplY3RDb21iaW5hdG9yID0gZnVuY3Rpb24oZXhwcmVzc2lvbiwgY29tYmluYXRvcil7CglpZiAoIWV4cHJlc3Npb24pIHJldHVybiBjb21iaW5hdG9yOwoKCWV4cHJlc3Npb24gPSBPYmplY3QuY2xvbmUoU2xpY2sucGFyc2UoZXhwcmVzc2lvbikpOwoKCXZhciBleHByZXNzaW9ucyA9IGV4cHJlc3Npb24uZXhwcmVzc2lvbnM7Cglmb3IgKHZhciBpID0gZXhwcmVzc2lvbnMubGVuZ3RoOyBpLS07KQoJCWV4cHJlc3Npb25zW2ldWzBdLmNvbWJpbmF0b3IgPSBjb21iaW5hdG9yOwoKCXJldHVybiBleHByZXNzaW9uOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNldDogZnVuY3Rpb24ocHJvcCwgdmFsdWUpewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuc2V0KSA/IHByb3BlcnR5LnNldC5jYWxsKHRoaXMsIHZhbHVlKSA6IHRoaXMuc2V0UHJvcGVydHkocHJvcCwgdmFsdWUpOwoJfS5vdmVybG9hZFNldHRlcigpLAoKCWdldDogZnVuY3Rpb24ocHJvcCl7CgkJdmFyIHByb3BlcnR5ID0gRWxlbWVudC5Qcm9wZXJ0aWVzW3Byb3BdOwoJCXJldHVybiAocHJvcGVydHkgJiYgcHJvcGVydHkuZ2V0KSA/IHByb3BlcnR5LmdldC5hcHBseSh0aGlzKSA6IHRoaXMuZ2V0UHJvcGVydHkocHJvcCk7Cgl9Lm92ZXJsb2FkR2V0dGVyKCksCgoJZXJhc2U6IGZ1bmN0aW9uKHByb3ApewoJCXZhciBwcm9wZXJ0eSA9IEVsZW1lbnQuUHJvcGVydGllc1twcm9wXTsKCQkocHJvcGVydHkgJiYgcHJvcGVydHkuZXJhc2UpID8gcHJvcGVydHkuZXJhc2UuYXBwbHkodGhpcykgOiB0aGlzLnJlbW92ZVByb3BlcnR5KHByb3ApOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlLCB2YWx1ZSl7CgkJYXR0cmlidXRlID0gY2FtZWxzW2F0dHJpYnV0ZV0gfHwgYXR0cmlidXRlOwoJCWlmICh2YWx1ZSA9PSBudWxsKSByZXR1cm4gdGhpcy5yZW1vdmVQcm9wZXJ0eShhdHRyaWJ1dGUpOwoJCXZhciBrZXkgPSBhdHRyaWJ1dGVzW2F0dHJpYnV0ZV07CgkJKGtleSkgPyB0aGlzW2tleV0gPSB2YWx1ZSA6CgkJCShib29sc1thdHRyaWJ1dGVdKSA/IHRoaXNbYXR0cmlidXRlXSA9ICEhdmFsdWUgOiB0aGlzLnNldEF0dHJpYnV0ZShhdHRyaWJ1dGUsICcnICsgdmFsdWUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzZXRQcm9wZXJ0aWVzOiBmdW5jdGlvbihhdHRyaWJ1dGVzKXsKCQlmb3IgKHZhciBhdHRyaWJ1dGUgaW4gYXR0cmlidXRlcykgdGhpcy5zZXRQcm9wZXJ0eShhdHRyaWJ1dGUsIGF0dHJpYnV0ZXNbYXR0cmlidXRlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFByb3BlcnR5OiBmdW5jdGlvbihhdHRyaWJ1dGUpewoJCWF0dHJpYnV0ZSA9IGNhbWVsc1thdHRyaWJ1dGVdIHx8IGF0dHJpYnV0ZTsKCQl2YXIga2V5ID0gYXR0cmlidXRlc1thdHRyaWJ1dGVdIHx8IHJlYWRPbmx5W2F0dHJpYnV0ZV07CgkJcmV0dXJuIChrZXkpID8gdGhpc1trZXldIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gISF0aGlzW2F0dHJpYnV0ZV0gOgoJCQkodXJpQXR0cnMudGVzdChhdHRyaWJ1dGUpID8gdGhpcy5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlLCAyKSA6CgkJCShrZXkgPSB0aGlzLmdldEF0dHJpYnV0ZU5vZGUoYXR0cmlidXRlKSkgPyBrZXkubm9kZVZhbHVlIDogbnVsbCkgfHwgbnVsbDsKCX0sCgoJZ2V0UHJvcGVydGllczogZnVuY3Rpb24oKXsKCQl2YXIgYXJncyA9IEFycmF5LmZyb20oYXJndW1lbnRzKTsKCQlyZXR1cm4gYXJncy5tYXAodGhpcy5nZXRQcm9wZXJ0eSwgdGhpcykuYXNzb2NpYXRlKGFyZ3MpOwoJfSwKCglyZW1vdmVQcm9wZXJ0eTogZnVuY3Rpb24oYXR0cmlidXRlKXsKCQlhdHRyaWJ1dGUgPSBjYW1lbHNbYXR0cmlidXRlXSB8fCBhdHRyaWJ1dGU7CgkJdmFyIGtleSA9IGF0dHJpYnV0ZXNbYXR0cmlidXRlXTsKCQkoa2V5KSA/IHRoaXNba2V5XSA9ICcnIDoKCQkJKGJvb2xzW2F0dHJpYnV0ZV0pID8gdGhpc1thdHRyaWJ1dGVdID0gZmFsc2UgOiB0aGlzLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGUpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZW1vdmVQcm9wZXJ0aWVzOiBmdW5jdGlvbigpewoJCUFycmF5LmVhY2goYXJndW1lbnRzLCB0aGlzLnJlbW92ZVByb3BlcnR5LCB0aGlzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJaGFzQ2xhc3M6IGZ1bmN0aW9uKGNsYXNzTmFtZSl7CgkJcmV0dXJuIHRoaXMuY2xhc3NOYW1lLmNsZWFuKCkuY29udGFpbnMoY2xhc3NOYW1lLCAnICcpOwoJfSwKCglhZGRDbGFzczogZnVuY3Rpb24oY2xhc3NOYW1lKXsKCQlpZiAoIXRoaXMuaGFzQ2xhc3MoY2xhc3NOYW1lKSkgdGhpcy5jbGFzc05hbWUgPSAodGhpcy5jbGFzc05hbWUgKyAnICcgKyBjbGFzc05hbWUpLmNsZWFuKCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUpewoJCXRoaXMuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUucmVwbGFjZShuZXcgUmVnRXhwKCcoXnxcXHMpJyArIGNsYXNzTmFtZSArICcoPzpcXHN8JCknKSwgJyQxJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXRvZ2dsZUNsYXNzOiBmdW5jdGlvbihjbGFzc05hbWUsIGZvcmNlKXsKCQlpZiAoZm9yY2UgPT0gbnVsbCkgZm9yY2UgPSAhdGhpcy5oYXNDbGFzcyhjbGFzc05hbWUpOwoJCXJldHVybiAoZm9yY2UpID8gdGhpcy5hZGRDbGFzcyhjbGFzc05hbWUpIDogdGhpcy5yZW1vdmVDbGFzcyhjbGFzc05hbWUpOwoJfSwKCglhZG9wdDogZnVuY3Rpb24oKXsKCQl2YXIgcGFyZW50ID0gdGhpcywgZnJhZ21lbnQsIGVsZW1lbnRzID0gQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLCBsZW5ndGggPSBlbGVtZW50cy5sZW5ndGg7CgkJaWYgKGxlbmd0aCA+IDEpIHBhcmVudCA9IGZyYWdtZW50ID0gZG9jdW1lbnQuY3JlYXRlRG9jdW1lbnRGcmFnbWVudCgpOwoKCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKXsKCQkJdmFyIGVsZW1lbnQgPSBkb2N1bWVudC5pZChlbGVtZW50c1tpXSwgdHJ1ZSk7CgkJCWlmIChlbGVtZW50KSBwYXJlbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7CgkJfQoKCQlpZiAoZnJhZ21lbnQpIHRoaXMuYXBwZW5kQ2hpbGQoZnJhZ21lbnQpOwoKCQlyZXR1cm4gdGhpczsKCX0sCgoJYXBwZW5kVGV4dDogZnVuY3Rpb24odGV4dCwgd2hlcmUpewoJCXJldHVybiB0aGlzLmdyYWIodGhpcy5nZXREb2N1bWVudCgpLm5ld1RleHROb2RlKHRleHQpLCB3aGVyZSk7Cgl9LAoKCWdyYWI6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXShkb2N1bWVudC5pZChlbCwgdHJ1ZSksIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglpbmplY3Q6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJaW5zZXJ0ZXJzW3doZXJlIHx8ICdib3R0b20nXSh0aGlzLCBkb2N1bWVudC5pZChlbCwgdHJ1ZSkpOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWwpewoJCWVsID0gZG9jdW1lbnQuaWQoZWwsIHRydWUpOwoJCWVsLnBhcmVudE5vZGUucmVwbGFjZUNoaWxkKHRoaXMsIGVsKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJd3JhcHM6IGZ1bmN0aW9uKGVsLCB3aGVyZSl7CgkJZWwgPSBkb2N1bWVudC5pZChlbCwgdHJ1ZSk7CgkJcmV0dXJuIHRoaXMucmVwbGFjZXMoZWwpLmdyYWIoZWwsIHdoZXJlKTsKCX0sCgoJZ2V0UHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBkb2N1bWVudC5pZChTbGljay5maW5kKHRoaXMsIGluamVjdENvbWJpbmF0b3IoZXhwcmVzc2lvbiwgJyF+JykpKTsKCX0sCgoJZ2V0QWxsUHJldmlvdXM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIX4nKSwgbmV3IEVsZW1lbnRzKTsKCX0sCgoJZ2V0TmV4dDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpKSk7Cgl9LAoKCWdldEFsbE5leHQ6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRGaXJzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpWzBdKTsKCX0sCgoJZ2V0TGFzdDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JykpLmdldExhc3QoKSk7Cgl9LAoKCWdldFBhcmVudDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIGRvY3VtZW50LmlkKFNsaWNrLmZpbmQodGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpKSk7Cgl9LAoKCWdldFBhcmVudHM6IGZ1bmN0aW9uKGV4cHJlc3Npb24pewoJCXJldHVybiBTbGljay5zZWFyY2godGhpcywgaW5qZWN0Q29tYmluYXRvcihleHByZXNzaW9uLCAnIScpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRTaWJsaW5nczogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICd+ficpLCBuZXcgRWxlbWVudHMpOwoJfSwKCglnZXRDaGlsZHJlbjogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuIFNsaWNrLnNlYXJjaCh0aGlzLCBpbmplY3RDb21iaW5hdG9yKGV4cHJlc3Npb24sICc+JyksIG5ldyBFbGVtZW50cyk7Cgl9LAoKCWdldFdpbmRvdzogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vd25lckRvY3VtZW50LndpbmRvdzsKCX0sCgoJZ2V0RG9jdW1lbnQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMub3duZXJEb2N1bWVudDsKCX0sCgoJZ2V0RWxlbWVudEJ5SWQ6IGZ1bmN0aW9uKGlkKXsKCQlyZXR1cm4gZG9jdW1lbnQuaWQoU2xpY2suZmluZCh0aGlzLCAnIycgKyAoJycgKyBpZCkucmVwbGFjZSgvKFxXKS9nLCAnXFwkMScpKSk7Cgl9LAoKCWdldFNlbGVjdGVkOiBmdW5jdGlvbigpewoJCXRoaXMuc2VsZWN0ZWRJbmRleDsgLy8gU2FmYXJpIDMuMi4xCgkJcmV0dXJuIG5ldyBFbGVtZW50cyhBcnJheS5mcm9tKHRoaXMub3B0aW9ucykuZmlsdGVyKGZ1bmN0aW9uKG9wdGlvbil7CgkJCXJldHVybiBvcHRpb24uc2VsZWN0ZWQ7CgkJfSkpOwoJfSwKCgl0b1F1ZXJ5U3RyaW5nOiBmdW5jdGlvbigpewoJCXZhciBxdWVyeVN0cmluZyA9IFtdOwoJCXRoaXMuZ2V0RWxlbWVudHMoJ2lucHV0LCBzZWxlY3QsIHRleHRhcmVhJykuZWFjaChmdW5jdGlvbihlbCl7CgkJCXZhciB0eXBlID0gZWwudHlwZTsKCQkJaWYgKCFlbC5uYW1lIHx8IGVsLmRpc2FibGVkIHx8IHR5cGUgPT0gJ3N1Ym1pdCcgfHwgdHlwZSA9PSAncmVzZXQnIHx8IHR5cGUgPT0gJ2ZpbGUnIHx8IHR5cGUgPT0gJ2ltYWdlJykgcmV0dXJuOwoKCQkJdmFyIHZhbHVlID0gKGVsLmdldCgndGFnJykgPT0gJ3NlbGVjdCcpID8gZWwuZ2V0U2VsZWN0ZWQoKS5tYXAoZnVuY3Rpb24ob3B0KXsKCQkJCS8vIElFCgkJCQlyZXR1cm4gZG9jdW1lbnQuaWQob3B0KS5nZXQoJ3ZhbHVlJyk7CgkJCX0pIDogKCh0eXBlID09ICdyYWRpbycgfHwgdHlwZSA9PSAnY2hlY2tib3gnKSAmJiAhZWwuY2hlY2tlZCkgPyBudWxsIDogZWwuZ2V0KCd2YWx1ZScpOwoKCQkJQXJyYXkuZnJvbSh2YWx1ZSkuZWFjaChmdW5jdGlvbih2YWwpewoJCQkJaWYgKHR5cGVvZiB2YWwgIT0gJ3VuZGVmaW5lZCcpIHF1ZXJ5U3RyaW5nLnB1c2goZW5jb2RlVVJJQ29tcG9uZW50KGVsLm5hbWUpICsgJz0nICsgZW5jb2RlVVJJQ29tcG9uZW50KHZhbCkpOwoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcXVlcnlTdHJpbmcuam9pbignJicpOwoJfSwKCglkZXN0cm95OiBmdW5jdGlvbigpewoJCXZhciBjaGlsZHJlbiA9IGNsZWFuKHRoaXMpLmdldEVsZW1lbnRzQnlUYWdOYW1lKCcqJyk7CgkJQXJyYXkuZWFjaChjaGlsZHJlbiwgY2xlYW4pOwoJCUVsZW1lbnQuZGlzcG9zZSh0aGlzKTsKCQlyZXR1cm4gbnVsbDsKCX0sCgoJZW1wdHk6IGZ1bmN0aW9uKCl7CgkJQXJyYXkuZnJvbSh0aGlzLmNoaWxkTm9kZXMpLmVhY2goRWxlbWVudC5kaXNwb3NlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gKHRoaXMucGFyZW50Tm9kZSkgPyB0aGlzLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcykgOiB0aGlzOwoJfSwKCgltYXRjaDogZnVuY3Rpb24oZXhwcmVzc2lvbil7CgkJcmV0dXJuICFleHByZXNzaW9uIHx8IFNsaWNrLm1hdGNoKHRoaXMsIGV4cHJlc3Npb24pOwoJfQoKfSk7Cgp2YXIgY2xlYW5DbG9uZSA9IGZ1bmN0aW9uKG5vZGUsIGVsZW1lbnQsIGtlZXBpZCl7CglpZiAoIWtlZXBpZCkgbm9kZS5zZXRBdHRyaWJ1dGVOb2RlKGRvY3VtZW50LmNyZWF0ZUF0dHJpYnV0ZSgnaWQnKSk7CglpZiAobm9kZS5jbGVhckF0dHJpYnV0ZXMpewoJCW5vZGUuY2xlYXJBdHRyaWJ1dGVzKCk7CgkJbm9kZS5tZXJnZUF0dHJpYnV0ZXMoZWxlbWVudCk7CgkJbm9kZS5yZW1vdmVBdHRyaWJ1dGUoJ3VpZCcpOwoJCWlmIChub2RlLm9wdGlvbnMpewoJCQl2YXIgbm8gPSBub2RlLm9wdGlvbnMsIGVvID0gZWxlbWVudC5vcHRpb25zOwoJCQlmb3IgKHZhciBpID0gbm8ubGVuZ3RoOyBpLS07KSBub1tpXS5zZWxlY3RlZCA9IGVvW2ldLnNlbGVjdGVkOwoJCX0KCX0KCgl2YXIgcHJvcCA9IGZvcm1Qcm9wc1tlbGVtZW50LnRhZ05hbWUudG9Mb3dlckNhc2UoKV07CglpZiAocHJvcCAmJiBlbGVtZW50W3Byb3BdKSBub2RlW3Byb3BdID0gZWxlbWVudFtwcm9wXTsKfTsKCkVsZW1lbnQuaW1wbGVtZW50KCdjbG9uZScsIGZ1bmN0aW9uKGNvbnRlbnRzLCBrZWVwaWQpewoJY29udGVudHMgPSBjb250ZW50cyAhPT0gZmFsc2U7Cgl2YXIgY2xvbmUgPSB0aGlzLmNsb25lTm9kZShjb250ZW50cyksIGk7CgoJaWYgKGNvbnRlbnRzKXsKCQl2YXIgY2UgPSBjbG9uZS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnKicpLCB0ZSA9IHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJyonKTsKCQlmb3IgKGkgPSBjZS5sZW5ndGg7IGktLTspIGNsZWFuQ2xvbmUoY2VbaV0sIHRlW2ldLCBrZWVwaWQpOwoJfQoKCWNsZWFuQ2xvbmUoY2xvbmUsIHRoaXMsIGtlZXBpZCk7CgoJaWYgKEJyb3dzZXIuaWUpewoJCXZhciBjbyA9IGNsb25lLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKSwgdG8gPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvYmplY3QnKTsKCQlmb3IgKGkgPSBjby5sZW5ndGg7IGktLTspIGNvW2ldLm91dGVySFRNTCA9IHRvW2ldLm91dGVySFRNTDsKCX0KCXJldHVybiBkb2N1bWVudC5pZChjbG9uZSk7Cn0pOwoKdmFyIGNvbnRhaW5zID0ge2NvbnRhaW5zOiBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiBTbGljay5jb250YWlucyh0aGlzLCBlbGVtZW50KTsKfX07CgppZiAoIWRvY3VtZW50LmNvbnRhaW5zKSBEb2N1bWVudC5pbXBsZW1lbnQoY29udGFpbnMpOwppZiAoIWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpLmNvbnRhaW5zKSBFbGVtZW50LmltcGxlbWVudChjb250YWlucyk7CgovLzwxLjJjb21wYXQ+CgpFbGVtZW50LmltcGxlbWVudCgnaGFzQ2hpbGQnLCBmdW5jdGlvbihlbGVtZW50KXsKCXJldHVybiB0aGlzICE9PSBlbGVtZW50ICYmIHRoaXMuY29udGFpbnMoZWxlbWVudCk7Cn0pOwoKLy88LzEuMmNvbXBhdD4KCltFbGVtZW50LCBXaW5kb3csIERvY3VtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglhZGRMaXN0ZW5lcjogZnVuY3Rpb24odHlwZSwgZm4pewoJCWlmICh0eXBlID09ICd1bmxvYWQnKXsKCQkJdmFyIG9sZCA9IGZuLCBzZWxmID0gdGhpczsKCQkJZm4gPSBmdW5jdGlvbigpewoJCQkJc2VsZi5yZW1vdmVMaXN0ZW5lcigndW5sb2FkJywgZm4pOwoJCQkJb2xkKCk7CgkJCX07CgkJfSBlbHNlIHsKCQkJY29sbGVjdGVkWyR1aWQodGhpcyldID0gdGhpczsKCQl9CgkJaWYgKHRoaXMuYWRkRXZlbnRMaXN0ZW5lcikgdGhpcy5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmF0dGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW92ZUxpc3RlbmVyOiBmdW5jdGlvbih0eXBlLCBmbil7CgkJaWYgKHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcikgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKHR5cGUsIGZuLCAhIWFyZ3VtZW50c1syXSk7CgkJZWxzZSB0aGlzLmRldGFjaEV2ZW50KCdvbicgKyB0eXBlLCBmbik7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJldHJpZXZlOiBmdW5jdGlvbihwcm9wZXJ0eSwgZGZsdCl7CgkJdmFyIHN0b3JhZ2UgPSBnZXQoJHVpZCh0aGlzKSksIHByb3AgPSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlpZiAoZGZsdCAhPSBudWxsICYmIHByb3AgPT0gbnVsbCkgcHJvcCA9IHN0b3JhZ2VbcHJvcGVydHldID0gZGZsdDsKCQlyZXR1cm4gcHJvcCAhPSBudWxsID8gcHJvcCA6IG51bGw7Cgl9LAoKCXN0b3JlOiBmdW5jdGlvbihwcm9wZXJ0eSwgdmFsdWUpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpOwoJCXN0b3JhZ2VbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWVsaW1pbmF0ZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCXZhciBzdG9yYWdlID0gZ2V0KCR1aWQodGhpcykpOwoJCWRlbGV0ZSBzdG9yYWdlW3Byb3BlcnR5XTsKCQlyZXR1cm4gdGhpczsKCX0KCn0pOwoKLyo8bHRJRTk+Ki8KaWYgKHdpbmRvdy5hdHRhY2hFdmVudCAmJiAhd2luZG93LmFkZEV2ZW50TGlzdGVuZXIpIHdpbmRvdy5hZGRMaXN0ZW5lcigndW5sb2FkJywgZnVuY3Rpb24oKXsKCU9iamVjdC5lYWNoKGNvbGxlY3RlZCwgY2xlYW4pOwoJaWYgKHdpbmRvdy5Db2xsZWN0R2FyYmFnZSkgQ29sbGVjdEdhcmJhZ2UoKTsKfSk7Ci8qPC9sdElFOT4qLwoKfSkoKTsKCkVsZW1lbnQuUHJvcGVydGllcyA9IHt9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzID0gbmV3IEhhc2g7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlID0gewoKCXNldDogZnVuY3Rpb24oc3R5bGUpewoJCXRoaXMuc3R5bGUuY3NzVGV4dCA9IHN0eWxlOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuc3R5bGUuY3NzVGV4dDsKCX0sCgoJZXJhc2U6IGZ1bmN0aW9uKCl7CgkJdGhpcy5zdHlsZS5jc3NUZXh0ID0gJyc7Cgl9Cgp9OwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnRhZyA9IHsKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMudGFnTmFtZS50b0xvd2VyQ2FzZSgpOwoJfQoKfTsKCi8qPGx0SUU5PiovCihmdW5jdGlvbihtYXhMZW5ndGgpewoJaWYgKG1heExlbmd0aCAhPSBudWxsKSBFbGVtZW50LlByb3BlcnRpZXMubWF4bGVuZ3RoID0gRWxlbWVudC5Qcm9wZXJ0aWVzLm1heExlbmd0aCA9IHsKCQlnZXQ6IGZ1bmN0aW9uKCl7CgkJCXZhciBtYXhsZW5ndGggPSB0aGlzLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJyk7CgkJCXJldHVybiBtYXhsZW5ndGggPT0gbWF4TGVuZ3RoID8gbnVsbCA6IG1heGxlbmd0aDsKCQl9Cgl9Owp9KShkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpLmdldEF0dHJpYnV0ZSgnbWF4TGVuZ3RoJykpOwovKjwvbHRJRTk+Ki8KCi8qPCF3ZWJraXQ+Ki8KRWxlbWVudC5Qcm9wZXJ0aWVzLmh0bWwgPSAoZnVuY3Rpb24oKXsKCgl2YXIgdGFibGVUZXN0ID0gRnVuY3Rpb24uYXR0ZW1wdChmdW5jdGlvbigpewoJCXZhciB0YWJsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RhYmxlJyk7CgkJdGFibGUuaW5uZXJIVE1MID0gJzx0cj48dGQ+PC90ZD48L3RyPic7Cgl9KTsKCgl2YXIgd3JhcHBlciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKCXZhciB0cmFuc2xhdGlvbnMgPSB7CgkJdGFibGU6IFsxLCAnPHRhYmxlPicsICc8L3RhYmxlPiddLAoJCXNlbGVjdDogWzEsICc8c2VsZWN0PicsICc8L3NlbGVjdD4nXSwKCQl0Ym9keTogWzIsICc8dGFibGU+PHRib2R5PicsICc8L3Rib2R5PjwvdGFibGU+J10sCgkJdHI6IFszLCAnPHRhYmxlPjx0Ym9keT48dHI+JywgJzwvdHI+PC90Ym9keT48L3RhYmxlPiddCgl9OwoJdHJhbnNsYXRpb25zLnRoZWFkID0gdHJhbnNsYXRpb25zLnRmb290ID0gdHJhbnNsYXRpb25zLnRib2R5OwoKCXZhciBodG1sID0gewoJCXNldDogZnVuY3Rpb24oKXsKCQkJdmFyIGh0bWwgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cykuam9pbignJyk7CgkJCXZhciB3cmFwID0gKCF0YWJsZVRlc3QgJiYgdHJhbnNsYXRpb25zW3RoaXMuZ2V0KCd0YWcnKV0pOwoJCQlpZiAod3JhcCl7CgkJCQl2YXIgZmlyc3QgPSB3cmFwcGVyOwoJCQkJZmlyc3QuaW5uZXJIVE1MID0gd3JhcFsxXSArIGh0bWwgKyB3cmFwWzJdOwoJCQkJZm9yICh2YXIgaSA9IHdyYXBbMF07IGktLTspIGZpcnN0ID0gZmlyc3QuZmlyc3RDaGlsZDsKCQkJCXRoaXMuZW1wdHkoKS5hZG9wdChmaXJzdC5jaGlsZE5vZGVzKTsKCQkJfSBlbHNlIHsKCQkJCXRoaXMuaW5uZXJIVE1MID0gaHRtbDsKCQkJfQoJCX0KCX07CgoJaHRtbC5lcmFzZSA9IGh0bWwuc2V0OwoKCXJldHVybiBodG1sOwp9KSgpOwovKjwvIXdlYmtpdD4qLwoKCi8qCi0tLQoKbmFtZTogRWxlbWVudC5TdHlsZQoKZGVzY3JpcHRpb246IENvbnRhaW5zIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggdGhlIHN0eWxlcyBvZiBFbGVtZW50cyBpbiBhIGZhc2hpb25hYmxlIHdheS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEVsZW1lbnQKCnByb3ZpZGVzOiBFbGVtZW50LlN0eWxlCgouLi4KKi8KCihmdW5jdGlvbigpewoKdmFyIGh0bWwgPSBkb2N1bWVudC5odG1sOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnN0eWxlcyA9IHtzZXQ6IGZ1bmN0aW9uKHN0eWxlcyl7Cgl0aGlzLnNldFN0eWxlcyhzdHlsZXMpOwp9fTsKCnZhciBoYXNPcGFjaXR5ID0gKGh0bWwuc3R5bGUub3BhY2l0eSAhPSBudWxsKTsKdmFyIHJlQWxwaGEgPSAvYWxwaGFcKG9wYWNpdHk9KFtcZC5dKylcKS9pOwoKdmFyIHNldE9wYWNpdHkgPSBmdW5jdGlvbihlbGVtZW50LCBvcGFjaXR5KXsKCWlmICghZWxlbWVudC5jdXJyZW50U3R5bGUgfHwgIWVsZW1lbnQuY3VycmVudFN0eWxlLmhhc0xheW91dCkgZWxlbWVudC5zdHlsZS56b29tID0gMTsKCWlmIChoYXNPcGFjaXR5KXsKCQllbGVtZW50LnN0eWxlLm9wYWNpdHkgPSBvcGFjaXR5OwoJfSBlbHNlIHsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgKiAxMDApLmxpbWl0KDAsIDEwMCkucm91bmQoKTsKCQlvcGFjaXR5ID0gKG9wYWNpdHkgPT0gMTAwKSA/ICcnIDogJ2FscGhhKG9wYWNpdHk9JyArIG9wYWNpdHkgKyAnKSc7CgkJdmFyIGZpbHRlciA9IGVsZW1lbnQuc3R5bGUuZmlsdGVyIHx8IGVsZW1lbnQuZ2V0Q29tcHV0ZWRTdHlsZSgnZmlsdGVyJykgfHwgJyc7CgkJZWxlbWVudC5zdHlsZS5maWx0ZXIgPSByZUFscGhhLnRlc3QoZmlsdGVyKSA/IGZpbHRlci5yZXBsYWNlKHJlQWxwaGEsIG9wYWNpdHkpIDogZmlsdGVyICsgb3BhY2l0eTsKCX0KfTsKCkVsZW1lbnQuUHJvcGVydGllcy5vcGFjaXR5ID0gewoKCXNldDogZnVuY3Rpb24ob3BhY2l0eSl7CgkJdmFyIHZpc2liaWxpdHkgPSB0aGlzLnN0eWxlLnZpc2liaWxpdHk7CgkJaWYgKG9wYWNpdHkgPT0gMCAmJiB2aXNpYmlsaXR5ICE9ICdoaWRkZW4nKSB0aGlzLnN0eWxlLnZpc2liaWxpdHkgPSAnaGlkZGVuJzsKCQllbHNlIGlmIChvcGFjaXR5ICE9IDAgJiYgdmlzaWJpbGl0eSAhPSAndmlzaWJsZScpIHRoaXMuc3R5bGUudmlzaWJpbGl0eSA9ICd2aXNpYmxlJzsKCgkJc2V0T3BhY2l0eSh0aGlzLCBvcGFjaXR5KTsKCX0sCgoJZ2V0OiAoaGFzT3BhY2l0eSkgPyBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5ID0gdGhpcy5zdHlsZS5vcGFjaXR5IHx8IHRoaXMuZ2V0Q29tcHV0ZWRTdHlsZSgnb3BhY2l0eScpOwoJCXJldHVybiAob3BhY2l0eSA9PSAnJykgPyAxIDogb3BhY2l0eTsKCX0gOiBmdW5jdGlvbigpewoJCXZhciBvcGFjaXR5LCBmaWx0ZXIgPSAodGhpcy5zdHlsZS5maWx0ZXIgfHwgdGhpcy5nZXRDb21wdXRlZFN0eWxlKCdmaWx0ZXInKSk7CgkJaWYgKGZpbHRlcikgb3BhY2l0eSA9IGZpbHRlci5tYXRjaChyZUFscGhhKTsKCQlyZXR1cm4gKG9wYWNpdHkgPT0gbnVsbCB8fCBmaWx0ZXIgPT0gbnVsbCkgPyAxIDogKG9wYWNpdHlbMV0gLyAxMDApOwoJfQoKfTsKCnZhciBmbG9hdE5hbWUgPSAoaHRtbC5zdHlsZS5jc3NGbG9hdCA9PSBudWxsKSA/ICdzdHlsZUZsb2F0JyA6ICdjc3NGbG9hdCc7CgpFbGVtZW50LmltcGxlbWVudCh7CgoJZ2V0Q29tcHV0ZWRTdHlsZTogZnVuY3Rpb24ocHJvcGVydHkpewoJCWlmICh0aGlzLmN1cnJlbnRTdHlsZSkgcmV0dXJuIHRoaXMuY3VycmVudFN0eWxlW3Byb3BlcnR5LmNhbWVsQ2FzZSgpXTsKCQl2YXIgZGVmYXVsdFZpZXcgPSBFbGVtZW50LmdldERvY3VtZW50KHRoaXMpLmRlZmF1bHRWaWV3LAoJCQljb21wdXRlZCA9IGRlZmF1bHRWaWV3ID8gZGVmYXVsdFZpZXcuZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLCBudWxsKSA6IG51bGw7CgkJcmV0dXJuIChjb21wdXRlZCkgPyBjb21wdXRlZC5nZXRQcm9wZXJ0eVZhbHVlKChwcm9wZXJ0eSA9PSBmbG9hdE5hbWUpID8gJ2Zsb2F0JyA6IHByb3BlcnR5Lmh5cGhlbmF0ZSgpKSA6IG51bGw7Cgl9LAoKCXNldE9wYWNpdHk6IGZ1bmN0aW9uKHZhbHVlKXsKCQlzZXRPcGFjaXR5KHRoaXMsIHZhbHVlKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0T3BhY2l0eTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCX0sCgoJc2V0U3R5bGU6IGZ1bmN0aW9uKHByb3BlcnR5LCB2YWx1ZSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5zZXQoJ29wYWNpdHknLCBwYXJzZUZsb2F0KHZhbHVlKSk7CgkJCWNhc2UgJ2Zsb2F0JzogcHJvcGVydHkgPSBmbG9hdE5hbWU7CgkJfQoJCXByb3BlcnR5ID0gcHJvcGVydHkuY2FtZWxDYXNlKCk7CgkJaWYgKHR5cGVPZih2YWx1ZSkgIT0gJ3N0cmluZycpewoJCQl2YXIgbWFwID0gKEVsZW1lbnQuU3R5bGVzW3Byb3BlcnR5XSB8fCAnQCcpLnNwbGl0KCcgJyk7CgkJCXZhbHVlID0gQXJyYXkuZnJvbSh2YWx1ZSkubWFwKGZ1bmN0aW9uKHZhbCwgaSl7CgkJCQlpZiAoIW1hcFtpXSkgcmV0dXJuICcnOwoJCQkJcmV0dXJuICh0eXBlT2YodmFsKSA9PSAnbnVtYmVyJykgPyBtYXBbaV0ucmVwbGFjZSgnQCcsIE1hdGgucm91bmQodmFsKSkgOiB2YWw7CgkJCX0pLmpvaW4oJyAnKTsKCQl9IGVsc2UgaWYgKHZhbHVlID09IFN0cmluZyhOdW1iZXIodmFsdWUpKSl7CgkJCXZhbHVlID0gTWF0aC5yb3VuZCh2YWx1ZSk7CgkJfQoJCXRoaXMuc3R5bGVbcHJvcGVydHldID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlOiBmdW5jdGlvbihwcm9wZXJ0eSl7CgkJc3dpdGNoIChwcm9wZXJ0eSl7CgkJCWNhc2UgJ29wYWNpdHknOiByZXR1cm4gdGhpcy5nZXQoJ29wYWNpdHknKTsKCQkJY2FzZSAnZmxvYXQnOiBwcm9wZXJ0eSA9IGZsb2F0TmFtZTsKCQl9CgkJcHJvcGVydHkgPSBwcm9wZXJ0eS5jYW1lbENhc2UoKTsKCQl2YXIgcmVzdWx0ID0gdGhpcy5zdHlsZVtwcm9wZXJ0eV07CgkJaWYgKCFyZXN1bHQgfHwgcHJvcGVydHkgPT0gJ3pJbmRleCcpewoJCQlyZXN1bHQgPSBbXTsKCQkJZm9yICh2YXIgc3R5bGUgaW4gRWxlbWVudC5TaG9ydFN0eWxlcyl7CgkJCQlpZiAocHJvcGVydHkgIT0gc3R5bGUpIGNvbnRpbnVlOwoJCQkJZm9yICh2YXIgcyBpbiBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmVzdWx0LnB1c2godGhpcy5nZXRTdHlsZShzKSk7CgkJCQlyZXR1cm4gcmVzdWx0LmpvaW4oJyAnKTsKCQkJfQoJCQlyZXN1bHQgPSB0aGlzLmdldENvbXB1dGVkU3R5bGUocHJvcGVydHkpOwoJCX0KCQlpZiAocmVzdWx0KXsKCQkJcmVzdWx0ID0gU3RyaW5nKHJlc3VsdCk7CgkJCXZhciBjb2xvciA9IHJlc3VsdC5tYXRjaCgvcmdiYT9cKFtcZFxzLF0rXCkvKTsKCQkJaWYgKGNvbG9yKSByZXN1bHQgPSByZXN1bHQucmVwbGFjZShjb2xvclswXSwgY29sb3JbMF0ucmdiVG9IZXgoKSk7CgkJfQoJCWlmIChCcm93c2VyLm9wZXJhIHx8IChCcm93c2VyLmllICYmIGlzTmFOKHBhcnNlRmxvYXQocmVzdWx0KSkpKXsKCQkJaWYgKCgvXihoZWlnaHR8d2lkdGgpJC8pLnRlc3QocHJvcGVydHkpKXsKCQkJCXZhciB2YWx1ZXMgPSAocHJvcGVydHkgPT0gJ3dpZHRoJykgPyBbJ2xlZnQnLCAncmlnaHQnXSA6IFsndG9wJywgJ2JvdHRvbSddLCBzaXplID0gMDsKCQkJCXZhbHVlcy5lYWNoKGZ1bmN0aW9uKHZhbHVlKXsKCQkJCQlzaXplICs9IHRoaXMuZ2V0U3R5bGUoJ2JvcmRlci0nICsgdmFsdWUgKyAnLXdpZHRoJykudG9JbnQoKSArIHRoaXMuZ2V0U3R5bGUoJ3BhZGRpbmctJyArIHZhbHVlKS50b0ludCgpOwoJCQkJfSwgdGhpcyk7CgkJCQlyZXR1cm4gdGhpc1snb2Zmc2V0JyArIHByb3BlcnR5LmNhcGl0YWxpemUoKV0gLSBzaXplICsgJ3B4JzsKCQkJfQoJCQlpZiAoQnJvd3Nlci5vcGVyYSAmJiBTdHJpbmcocmVzdWx0KS5pbmRleE9mKCdweCcpICE9IC0xKSByZXR1cm4gcmVzdWx0OwoJCQlpZiAoKC9eYm9yZGVyKC4rKVdpZHRofG1hcmdpbnxwYWRkaW5nLykudGVzdChwcm9wZXJ0eSkpIHJldHVybiAnMHB4JzsKCQl9CgkJcmV0dXJuIHJlc3VsdDsKCX0sCgoJc2V0U3R5bGVzOiBmdW5jdGlvbihzdHlsZXMpewoJCWZvciAodmFyIHN0eWxlIGluIHN0eWxlcykgdGhpcy5zZXRTdHlsZShzdHlsZSwgc3R5bGVzW3N0eWxlXSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldFN0eWxlczogZnVuY3Rpb24oKXsKCQl2YXIgcmVzdWx0ID0ge307CgkJQXJyYXkuZmxhdHRlbihhcmd1bWVudHMpLmVhY2goZnVuY3Rpb24oa2V5KXsKCQkJcmVzdWx0W2tleV0gPSB0aGlzLmdldFN0eWxlKGtleSk7CgkJfSwgdGhpcyk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCn0pOwoKRWxlbWVudC5TdHlsZXMgPSB7CglsZWZ0OiAnQHB4JywgdG9wOiAnQHB4JywgYm90dG9tOiAnQHB4JywgcmlnaHQ6ICdAcHgnLAoJd2lkdGg6ICdAcHgnLCBoZWlnaHQ6ICdAcHgnLCBtYXhXaWR0aDogJ0BweCcsIG1heEhlaWdodDogJ0BweCcsIG1pbldpZHRoOiAnQHB4JywgbWluSGVpZ2h0OiAnQHB4JywKCWJhY2tncm91bmRDb2xvcjogJ3JnYihALCBALCBAKScsIGJhY2tncm91bmRQb3NpdGlvbjogJ0BweCBAcHgnLCBjb2xvcjogJ3JnYihALCBALCBAKScsCglmb250U2l6ZTogJ0BweCcsIGxldHRlclNwYWNpbmc6ICdAcHgnLCBsaW5lSGVpZ2h0OiAnQHB4JywgY2xpcDogJ3JlY3QoQHB4IEBweCBAcHggQHB4KScsCgltYXJnaW46ICdAcHggQHB4IEBweCBAcHgnLCBwYWRkaW5nOiAnQHB4IEBweCBAcHggQHB4JywgYm9yZGVyOiAnQHB4IEAgcmdiKEAsIEAsIEApIEBweCBAIHJnYihALCBALCBAKSBAcHggQCByZ2IoQCwgQCwgQCknLAoJYm9yZGVyV2lkdGg6ICdAcHggQHB4IEBweCBAcHgnLCBib3JkZXJTdHlsZTogJ0AgQCBAIEAnLCBib3JkZXJDb2xvcjogJ3JnYihALCBALCBAKSByZ2IoQCwgQCwgQCkgcmdiKEAsIEAsIEApIHJnYihALCBALCBAKScsCgl6SW5kZXg6ICdAJywgJ3pvb20nOiAnQCcsIGZvbnRXZWlnaHQ6ICdAJywgdGV4dEluZGVudDogJ0BweCcsIG9wYWNpdHk6ICdAJwp9OwoKLy88MS4yY29tcGF0PgoKRWxlbWVudC5TdHlsZXMgPSBuZXcgSGFzaChFbGVtZW50LlN0eWxlcyk7CgovLzwvMS4yY29tcGF0PgoKRWxlbWVudC5TaG9ydFN0eWxlcyA9IHttYXJnaW46IHt9LCBwYWRkaW5nOiB7fSwgYm9yZGVyOiB7fSwgYm9yZGVyV2lkdGg6IHt9LCBib3JkZXJTdHlsZToge30sIGJvcmRlckNvbG9yOiB7fX07CgpbJ1RvcCcsICdSaWdodCcsICdCb3R0b20nLCAnTGVmdCddLmVhY2goZnVuY3Rpb24oZGlyZWN0aW9uKXsKCXZhciBTaG9ydCA9IEVsZW1lbnQuU2hvcnRTdHlsZXM7Cgl2YXIgQWxsID0gRWxlbWVudC5TdHlsZXM7CglbJ21hcmdpbicsICdwYWRkaW5nJ10uZWFjaChmdW5jdGlvbihzdHlsZSl7CgkJdmFyIHNkID0gc3R5bGUgKyBkaXJlY3Rpb247CgkJU2hvcnRbc3R5bGVdW3NkXSA9IEFsbFtzZF0gPSAnQHB4JzsKCX0pOwoJdmFyIGJkID0gJ2JvcmRlcicgKyBkaXJlY3Rpb247CglTaG9ydC5ib3JkZXJbYmRdID0gQWxsW2JkXSA9ICdAcHggQCByZ2IoQCwgQCwgQCknOwoJdmFyIGJkdyA9IGJkICsgJ1dpZHRoJywgYmRzID0gYmQgKyAnU3R5bGUnLCBiZGMgPSBiZCArICdDb2xvcic7CglTaG9ydFtiZF0gPSB7fTsKCVNob3J0LmJvcmRlcldpZHRoW2Jkd10gPSBTaG9ydFtiZF1bYmR3XSA9IEFsbFtiZHddID0gJ0BweCc7CglTaG9ydC5ib3JkZXJTdHlsZVtiZHNdID0gU2hvcnRbYmRdW2Jkc10gPSBBbGxbYmRzXSA9ICdAJzsKCVNob3J0LmJvcmRlckNvbG9yW2JkY10gPSBTaG9ydFtiZF1bYmRjXSA9IEFsbFtiZGNdID0gJ3JnYihALCBALCBAKSc7Cn0pOwoKfSkoKTsKCgovKgotLS0KCm5hbWU6IEVsZW1lbnQuRXZlbnQKCmRlc2NyaXB0aW9uOiBDb250YWlucyBFbGVtZW50IG1ldGhvZHMgZm9yIGRlYWxpbmcgd2l0aCBldmVudHMuIFRoaXMgZmlsZSBhbHNvIGluY2x1ZGVzIG1vdXNlZW50ZXIgYW5kIG1vdXNlbGVhdmUgY3VzdG9tIEVsZW1lbnQgRXZlbnRzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0VsZW1lbnQsIEV2ZW50XQoKcHJvdmlkZXM6IEVsZW1lbnQuRXZlbnQKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7CgpFbGVtZW50LlByb3BlcnRpZXMuZXZlbnRzID0ge3NldDogZnVuY3Rpb24oZXZlbnRzKXsKCXRoaXMuYWRkRXZlbnRzKGV2ZW50cyk7Cn19OwoKW0VsZW1lbnQsIFdpbmRvdywgRG9jdW1lbnRdLmludm9rZSgnaW1wbGVtZW50JywgewoKCWFkZEV2ZW50OiBmdW5jdGlvbih0eXBlLCBmbil7CgkJdmFyIGV2ZW50cyA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycsIHt9KTsKCQlpZiAoIWV2ZW50c1t0eXBlXSkgZXZlbnRzW3R5cGVdID0ge2tleXM6IFtdLCB2YWx1ZXM6IFtdfTsKCQlpZiAoZXZlbnRzW3R5cGVdLmtleXMuY29udGFpbnMoZm4pKSByZXR1cm4gdGhpczsKCQlldmVudHNbdHlwZV0ua2V5cy5wdXNoKGZuKTsKCQl2YXIgcmVhbFR5cGUgPSB0eXBlLAoJCQljdXN0b20gPSBFbGVtZW50LkV2ZW50c1t0eXBlXSwKCQkJY29uZGl0aW9uID0gZm4sCgkJCXNlbGYgPSB0aGlzOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uQWRkKSBjdXN0b20ub25BZGQuY2FsbCh0aGlzLCBmbik7CgkJCWlmIChjdXN0b20uY29uZGl0aW9uKXsKCQkJCWNvbmRpdGlvbiA9IGZ1bmN0aW9uKGV2ZW50KXsKCQkJCQlpZiAoY3VzdG9tLmNvbmRpdGlvbi5jYWxsKHRoaXMsIGV2ZW50KSkgcmV0dXJuIGZuLmNhbGwodGhpcywgZXZlbnQpOwoJCQkJCXJldHVybiB0cnVlOwoJCQkJfTsKCQkJfQoJCQlyZWFsVHlwZSA9IGN1c3RvbS5iYXNlIHx8IHJlYWxUeXBlOwoJCX0KCQl2YXIgZGVmbiA9IGZ1bmN0aW9uKCl7CgkJCXJldHVybiBmbi5jYWxsKHNlbGYpOwoJCX07CgkJdmFyIG5hdGl2ZUV2ZW50ID0gRWxlbWVudC5OYXRpdmVFdmVudHNbcmVhbFR5cGVdOwoJCWlmIChuYXRpdmVFdmVudCl7CgkJCWlmIChuYXRpdmVFdmVudCA9PSAyKXsKCQkJCWRlZm4gPSBmdW5jdGlvbihldmVudCl7CgkJCQkJZXZlbnQgPSBuZXcgRXZlbnQoZXZlbnQsIHNlbGYuZ2V0V2luZG93KCkpOwoJCQkJCWlmIChjb25kaXRpb24uY2FsbChzZWxmLCBldmVudCkgPT09IGZhbHNlKSBldmVudC5zdG9wKCk7CgkJCQl9OwoJCQl9CgkJCXRoaXMuYWRkTGlzdGVuZXIocmVhbFR5cGUsIGRlZm4sIGFyZ3VtZW50c1syXSk7CgkJfQoJCWV2ZW50c1t0eXBlXS52YWx1ZXMucHVzaChkZWZuKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnQ6IGZ1bmN0aW9uKHR5cGUsIGZuKXsKCQl2YXIgZXZlbnRzID0gdGhpcy5yZXRyaWV2ZSgnZXZlbnRzJyk7CgkJaWYgKCFldmVudHMgfHwgIWV2ZW50c1t0eXBlXSkgcmV0dXJuIHRoaXM7CgkJdmFyIGxpc3QgPSBldmVudHNbdHlwZV07CgkJdmFyIGluZGV4ID0gbGlzdC5rZXlzLmluZGV4T2YoZm4pOwoJCWlmIChpbmRleCA9PSAtMSkgcmV0dXJuIHRoaXM7CgkJdmFyIHZhbHVlID0gbGlzdC52YWx1ZXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LmtleXNbaW5kZXhdOwoJCWRlbGV0ZSBsaXN0LnZhbHVlc1tpbmRleF07CgkJdmFyIGN1c3RvbSA9IEVsZW1lbnQuRXZlbnRzW3R5cGVdOwoJCWlmIChjdXN0b20pewoJCQlpZiAoY3VzdG9tLm9uUmVtb3ZlKSBjdXN0b20ub25SZW1vdmUuY2FsbCh0aGlzLCBmbik7CgkJCXR5cGUgPSBjdXN0b20uYmFzZSB8fCB0eXBlOwoJCX0KCQlyZXR1cm4gKEVsZW1lbnQuTmF0aXZlRXZlbnRzW3R5cGVdKSA/IHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgdmFsdWUsIGFyZ3VtZW50c1syXSkgOiB0aGlzOwoJfSwKCglhZGRFdmVudHM6IGZ1bmN0aW9uKGV2ZW50cyl7CgkJZm9yICh2YXIgZXZlbnQgaW4gZXZlbnRzKSB0aGlzLmFkZEV2ZW50KGV2ZW50LCBldmVudHNbZXZlbnRdKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJcmVtb3ZlRXZlbnRzOiBmdW5jdGlvbihldmVudHMpewoJCXZhciB0eXBlOwoJCWlmICh0eXBlT2YoZXZlbnRzKSA9PSAnb2JqZWN0Jyl7CgkJCWZvciAodHlwZSBpbiBldmVudHMpIHRoaXMucmVtb3ZlRXZlbnQodHlwZSwgZXZlbnRzW3R5cGVdKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoJCXZhciBhdHRhY2hlZCA9IHRoaXMucmV0cmlldmUoJ2V2ZW50cycpOwoJCWlmICghYXR0YWNoZWQpIHJldHVybiB0aGlzOwoJCWlmICghZXZlbnRzKXsKCQkJZm9yICh0eXBlIGluIGF0dGFjaGVkKSB0aGlzLnJlbW92ZUV2ZW50cyh0eXBlKTsKCQkJdGhpcy5lbGltaW5hdGUoJ2V2ZW50cycpOwoJCX0gZWxzZSBpZiAoYXR0YWNoZWRbZXZlbnRzXSl7CgkJCWF0dGFjaGVkW2V2ZW50c10ua2V5cy5lYWNoKGZ1bmN0aW9uKGZuKXsKCQkJCXRoaXMucmVtb3ZlRXZlbnQoZXZlbnRzLCBmbik7CgkJCX0sIHRoaXMpOwoJCQlkZWxldGUgYXR0YWNoZWRbZXZlbnRzXTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWZpcmVFdmVudDogZnVuY3Rpb24odHlwZSwgYXJncywgZGVsYXkpewoJCXZhciBldmVudHMgPSB0aGlzLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cyB8fCAhZXZlbnRzW3R5cGVdKSByZXR1cm4gdGhpczsKCQlhcmdzID0gQXJyYXkuZnJvbShhcmdzKTsKCgkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCWlmIChkZWxheSkgZm4uZGVsYXkoZGVsYXksIHRoaXMsIGFyZ3MpOwoJCQllbHNlIGZuLmFwcGx5KHRoaXMsIGFyZ3MpOwoJCX0sIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljbG9uZUV2ZW50czogZnVuY3Rpb24oZnJvbSwgdHlwZSl7CgkJZnJvbSA9IGRvY3VtZW50LmlkKGZyb20pOwoJCXZhciBldmVudHMgPSBmcm9tLnJldHJpZXZlKCdldmVudHMnKTsKCQlpZiAoIWV2ZW50cykgcmV0dXJuIHRoaXM7CgkJaWYgKCF0eXBlKXsKCQkJZm9yICh2YXIgZXZlbnRUeXBlIGluIGV2ZW50cykgdGhpcy5jbG9uZUV2ZW50cyhmcm9tLCBldmVudFR5cGUpOwoJCX0gZWxzZSBpZiAoZXZlbnRzW3R5cGVdKXsKCQkJZXZlbnRzW3R5cGVdLmtleXMuZWFjaChmdW5jdGlvbihmbil7CgkJCQl0aGlzLmFkZEV2ZW50KHR5cGUsIGZuKTsKCQkJfSwgdGhpcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgpFbGVtZW50Lk5hdGl2ZUV2ZW50cyA9IHsKCWNsaWNrOiAyLCBkYmxjbGljazogMiwgbW91c2V1cDogMiwgbW91c2Vkb3duOiAyLCBjb250ZXh0bWVudTogMiwgLy9tb3VzZSBidXR0b25zCgltb3VzZXdoZWVsOiAyLCBET01Nb3VzZVNjcm9sbDogMiwgLy9tb3VzZSB3aGVlbAoJbW91c2VvdmVyOiAyLCBtb3VzZW91dDogMiwgbW91c2Vtb3ZlOiAyLCBzZWxlY3RzdGFydDogMiwgc2VsZWN0ZW5kOiAyLCAvL21vdXNlIG1vdmVtZW50CglrZXlkb3duOiAyLCBrZXlwcmVzczogMiwga2V5dXA6IDIsIC8va2V5Ym9hcmQKCW9yaWVudGF0aW9uY2hhbmdlOiAyLCAvLyBtb2JpbGUKCXRvdWNoc3RhcnQ6IDIsIHRvdWNobW92ZTogMiwgdG91Y2hlbmQ6IDIsIHRvdWNoY2FuY2VsOiAyLCAvLyB0b3VjaAoJZ2VzdHVyZXN0YXJ0OiAyLCBnZXN0dXJlY2hhbmdlOiAyLCBnZXN0dXJlZW5kOiAyLCAvLyBnZXN0dXJlCglmb2N1czogMiwgYmx1cjogMiwgY2hhbmdlOiAyLCByZXNldDogMiwgc2VsZWN0OiAyLCBzdWJtaXQ6IDIsIC8vZm9ybSBlbGVtZW50cwoJbG9hZDogMiwgdW5sb2FkOiAxLCBiZWZvcmV1bmxvYWQ6IDIsIHJlc2l6ZTogMSwgbW92ZTogMSwgRE9NQ29udGVudExvYWRlZDogMSwgcmVhZHlzdGF0ZWNoYW5nZTogMSwgLy93aW5kb3cKCWVycm9yOiAxLCBhYm9ydDogMSwgc2Nyb2xsOiAxIC8vbWlzYwp9OwoKdmFyIGNoZWNrID0gZnVuY3Rpb24oZXZlbnQpewoJdmFyIHJlbGF0ZWQgPSBldmVudC5yZWxhdGVkVGFyZ2V0OwoJaWYgKHJlbGF0ZWQgPT0gbnVsbCkgcmV0dXJuIHRydWU7CglpZiAoIXJlbGF0ZWQpIHJldHVybiBmYWxzZTsKCXJldHVybiAocmVsYXRlZCAhPSB0aGlzICYmIHJlbGF0ZWQucHJlZml4ICE9ICd4dWwnICYmIHR5cGVPZih0aGlzKSAhPSAnZG9jdW1lbnQnICYmICF0aGlzLmNvbnRhaW5zKHJlbGF0ZWQpKTsKfTsKCkVsZW1lbnQuRXZlbnRzID0gewoKCW1vdXNlZW50ZXI6IHsKCQliYXNlOiAnbW91c2VvdmVyJywKCQljb25kaXRpb246IGNoZWNrCgl9LAoKCW1vdXNlbGVhdmU6IHsKCQliYXNlOiAnbW91c2VvdXQnLAoJCWNvbmRpdGlvbjogY2hlY2sKCX0sCgoJbW91c2V3aGVlbDogewoJCWJhc2U6IChCcm93c2VyLmZpcmVmb3gpID8gJ0RPTU1vdXNlU2Nyb2xsJyA6ICdtb3VzZXdoZWVsJwoJfQoKfTsKCi8vPDEuMmNvbXBhdD4KCkVsZW1lbnQuRXZlbnRzID0gbmV3IEhhc2goRWxlbWVudC5FdmVudHMpOwoKLy88LzEuMmNvbXBhdD4KCn0pKCk7CgoKLyoKLS0tCgpuYW1lOiBFbGVtZW50LkRpbWVuc2lvbnMKCmRlc2NyaXB0aW9uOiBDb250YWlucyBtZXRob2RzIHRvIHdvcmsgd2l0aCBzaXplLCBzY3JvbGwsIG9yIHBvc2l0aW9uaW5nIG9mIEVsZW1lbnRzIGFuZCB0aGUgd2luZG93IG9iamVjdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEVsZW1lbnQgcG9zaXRpb25pbmcgYmFzZWQgb24gdGhlIFtxb294ZG9vXShodHRwOi8vcW9veGRvby5vcmcvKSBjb2RlIGFuZCBzbWFydCBicm93c2VyIGZpeGVzLCBbTEdQTCBMaWNlbnNlXShodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvbGdwbC5odG1sKS4KICAtIFZpZXdwb3J0IGRpbWVuc2lvbnMgYmFzZWQgb24gW1lVSV0oaHR0cDovL2RldmVsb3Blci55YWhvby5jb20veXVpLykgY29kZSwgW0JTRCBMaWNlbnNlXShodHRwOi8vZGV2ZWxvcGVyLnlhaG9vLmNvbS95dWkvbGljZW5zZS5odG1sKS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBbRWxlbWVudC5EaW1lbnNpb25zXQoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2JyksCgljaGlsZCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwplbGVtZW50LnN0eWxlLmhlaWdodCA9ICcwJzsKZWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCk7CnZhciBicm9rZW5PZmZzZXRQYXJlbnQgPSAoY2hpbGQub2Zmc2V0UGFyZW50ID09PSBlbGVtZW50KTsKZWxlbWVudCA9IGNoaWxkID0gbnVsbDsKCnZhciBpc09mZnNldCA9IGZ1bmN0aW9uKGVsKXsKCXJldHVybiBzdHlsZVN0cmluZyhlbCwgJ3Bvc2l0aW9uJykgIT0gJ3N0YXRpYycgfHwgaXNCb2R5KGVsKTsKfTsKCnZhciBpc09mZnNldFN0YXRpYyA9IGZ1bmN0aW9uKGVsKXsKCXJldHVybiBpc09mZnNldChlbCkgfHwgKC9eKD86dGFibGV8dGR8dGgpJC9pKS50ZXN0KGVsLnRhZ05hbWUpOwp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCXNjcm9sbFRvOiBmdW5jdGlvbih4LCB5KXsKCQlpZiAoaXNCb2R5KHRoaXMpKXsKCQkJdGhpcy5nZXRXaW5kb3coKS5zY3JvbGxUbyh4LCB5KTsKCQl9IGVsc2UgewoJCQl0aGlzLnNjcm9sbExlZnQgPSB4OwoJCQl0aGlzLnNjcm9sbFRvcCA9IHk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCglnZXRTaXplOiBmdW5jdGlvbigpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB0aGlzLmdldFdpbmRvdygpLmdldFNpemUoKTsKCQlyZXR1cm4ge3g6IHRoaXMub2Zmc2V0V2lkdGgsIHk6IHRoaXMub2Zmc2V0SGVpZ2h0fTsKCX0sCgoJZ2V0U2Nyb2xsU2l6ZTogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTY3JvbGxTaXplKCk7CgkJcmV0dXJuIHt4OiB0aGlzLnNjcm9sbFdpZHRoLCB5OiB0aGlzLnNjcm9sbEhlaWdodH07Cgl9LAoKCWdldFNjcm9sbDogZnVuY3Rpb24oKXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRTY3JvbGwoKTsKCQlyZXR1cm4ge3g6IHRoaXMuc2Nyb2xsTGVmdCwgeTogdGhpcy5zY3JvbGxUb3B9OwoJfSwKCglnZXRTY3JvbGxzOiBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpcy5wYXJlbnROb2RlLCBwb3NpdGlvbiA9IHt4OiAwLCB5OiAwfTsKCQl3aGlsZSAoZWxlbWVudCAmJiAhaXNCb2R5KGVsZW1lbnQpKXsKCQkJcG9zaXRpb24ueCArPSBlbGVtZW50LnNjcm9sbExlZnQ7CgkJCXBvc2l0aW9uLnkgKz0gZWxlbWVudC5zY3JvbGxUb3A7CgkJCWVsZW1lbnQgPSBlbGVtZW50LnBhcmVudE5vZGU7CgkJfQoJCXJldHVybiBwb3NpdGlvbjsKCX0sCgoJZ2V0T2Zmc2V0UGFyZW50OiBicm9rZW5PZmZzZXRQYXJlbnQgPyBmdW5jdGlvbigpewoJCXZhciBlbGVtZW50ID0gdGhpczsKCQlpZiAoaXNCb2R5KGVsZW1lbnQpIHx8IHN0eWxlU3RyaW5nKGVsZW1lbnQsICdwb3NpdGlvbicpID09ICdmaXhlZCcpIHJldHVybiBudWxsOwoKCQl2YXIgaXNPZmZzZXRDaGVjayA9IChzdHlsZVN0cmluZyhlbGVtZW50LCAncG9zaXRpb24nKSA9PSAnc3RhdGljJykgPyBpc09mZnNldFN0YXRpYyA6IGlzT2Zmc2V0OwoJCXdoaWxlICgoZWxlbWVudCA9IGVsZW1lbnQucGFyZW50Tm9kZSkpewoJCQlpZiAoaXNPZmZzZXRDaGVjayhlbGVtZW50KSkgcmV0dXJuIGVsZW1lbnQ7CgkJfQoJCXJldHVybiBudWxsOwoJfSA6IGZ1bmN0aW9uKCl7CgkJdmFyIGVsZW1lbnQgPSB0aGlzOwoJCWlmIChpc0JvZHkoZWxlbWVudCkgfHwgc3R5bGVTdHJpbmcoZWxlbWVudCwgJ3Bvc2l0aW9uJykgPT0gJ2ZpeGVkJykgcmV0dXJuIG51bGw7CgoJCXRyeSB7CgkJCXJldHVybiBlbGVtZW50Lm9mZnNldFBhcmVudDsKCQl9IGNhdGNoKGUpIHt9CgkJcmV0dXJuIG51bGw7Cgl9LAoKCWdldE9mZnNldHM6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0ICYmICFCcm93c2VyLlBsYXRmb3JtLmlvcyl7CgkJCXZhciBib3VuZCA9IHRoaXMuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCksCgkJCQlodG1sID0gZG9jdW1lbnQuaWQodGhpcy5nZXREb2N1bWVudCgpLmRvY3VtZW50RWxlbWVudCksCgkJCQlodG1sU2Nyb2xsID0gaHRtbC5nZXRTY3JvbGwoKSwKCQkJCWVsZW1TY3JvbGxzID0gdGhpcy5nZXRTY3JvbGxzKCksCgkJCQlpc0ZpeGVkID0gKHN0eWxlU3RyaW5nKHRoaXMsICdwb3NpdGlvbicpID09ICdmaXhlZCcpOwoKCQkJcmV0dXJuIHsKCQkJCXg6IGJvdW5kLmxlZnQudG9JbnQoKSArIGVsZW1TY3JvbGxzLnggKyAoKGlzRml4ZWQpID8gMCA6IGh0bWxTY3JvbGwueCkgLSBodG1sLmNsaWVudExlZnQsCgkJCQl5OiBib3VuZC50b3AudG9JbnQoKSAgKyBlbGVtU2Nyb2xscy55ICsgKChpc0ZpeGVkKSA/IDAgOiBodG1sU2Nyb2xsLnkpIC0gaHRtbC5jbGllbnRUb3AKCQkJfTsKCQl9CgoJCXZhciBlbGVtZW50ID0gdGhpcywgcG9zaXRpb24gPSB7eDogMCwgeTogMH07CgkJaWYgKGlzQm9keSh0aGlzKSkgcmV0dXJuIHBvc2l0aW9uOwoKCQl3aGlsZSAoZWxlbWVudCAmJiAhaXNCb2R5KGVsZW1lbnQpKXsKCQkJcG9zaXRpb24ueCArPSBlbGVtZW50Lm9mZnNldExlZnQ7CgkJCXBvc2l0aW9uLnkgKz0gZWxlbWVudC5vZmZzZXRUb3A7CgoJCQlpZiAoQnJvd3Nlci5maXJlZm94KXsKCQkJCWlmICghYm9yZGVyQm94KGVsZW1lbnQpKXsKCQkJCQlwb3NpdGlvbi54ICs9IGxlZnRCb3JkZXIoZWxlbWVudCk7CgkJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIoZWxlbWVudCk7CgkJCQl9CgkJCQl2YXIgcGFyZW50ID0gZWxlbWVudC5wYXJlbnROb2RlOwoJCQkJaWYgKHBhcmVudCAmJiBzdHlsZVN0cmluZyhwYXJlbnQsICdvdmVyZmxvdycpICE9ICd2aXNpYmxlJyl7CgkJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKHBhcmVudCk7CgkJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIocGFyZW50KTsKCQkJCX0KCQkJfSBlbHNlIGlmIChlbGVtZW50ICE9IHRoaXMgJiYgQnJvd3Nlci5zYWZhcmkpewoJCQkJcG9zaXRpb24ueCArPSBsZWZ0Qm9yZGVyKGVsZW1lbnQpOwoJCQkJcG9zaXRpb24ueSArPSB0b3BCb3JkZXIoZWxlbWVudCk7CgkJCX0KCgkJCWVsZW1lbnQgPSBlbGVtZW50Lm9mZnNldFBhcmVudDsKCQl9CgkJaWYgKEJyb3dzZXIuZmlyZWZveCAmJiAhYm9yZGVyQm94KHRoaXMpKXsKCQkJcG9zaXRpb24ueCAtPSBsZWZ0Qm9yZGVyKHRoaXMpOwoJCQlwb3NpdGlvbi55IC09IHRvcEJvcmRlcih0aGlzKTsKCQl9CgkJcmV0dXJuIHBvc2l0aW9uOwoJfSwKCglnZXRQb3NpdGlvbjogZnVuY3Rpb24ocmVsYXRpdmUpewoJCWlmIChpc0JvZHkodGhpcykpIHJldHVybiB7eDogMCwgeTogMH07CgkJdmFyIG9mZnNldCA9IHRoaXMuZ2V0T2Zmc2V0cygpLAoJCQlzY3JvbGwgPSB0aGlzLmdldFNjcm9sbHMoKTsKCQl2YXIgcG9zaXRpb24gPSB7CgkJCXg6IG9mZnNldC54IC0gc2Nyb2xsLngsCgkJCXk6IG9mZnNldC55IC0gc2Nyb2xsLnkKCQl9OwoJCQoJCWlmIChyZWxhdGl2ZSAmJiAocmVsYXRpdmUgPSBkb2N1bWVudC5pZChyZWxhdGl2ZSkpKXsKCQkJdmFyIHJlbGF0aXZlUG9zaXRpb24gPSByZWxhdGl2ZS5nZXRQb3NpdGlvbigpOwoJCQlyZXR1cm4ge3g6IHBvc2l0aW9uLnggLSByZWxhdGl2ZVBvc2l0aW9uLnggLSBsZWZ0Qm9yZGVyKHJlbGF0aXZlKSwgeTogcG9zaXRpb24ueSAtIHJlbGF0aXZlUG9zaXRpb24ueSAtIHRvcEJvcmRlcihyZWxhdGl2ZSl9OwoJCX0KCQlyZXR1cm4gcG9zaXRpb247Cgl9LAoKCWdldENvb3JkaW5hdGVzOiBmdW5jdGlvbihlbGVtZW50KXsKCQlpZiAoaXNCb2R5KHRoaXMpKSByZXR1cm4gdGhpcy5nZXRXaW5kb3coKS5nZXRDb29yZGluYXRlcygpOwoJCXZhciBwb3NpdGlvbiA9IHRoaXMuZ2V0UG9zaXRpb24oZWxlbWVudCksCgkJCXNpemUgPSB0aGlzLmdldFNpemUoKTsKCQl2YXIgb2JqID0gewoJCQlsZWZ0OiBwb3NpdGlvbi54LAoJCQl0b3A6IHBvc2l0aW9uLnksCgkJCXdpZHRoOiBzaXplLngsCgkJCWhlaWdodDogc2l6ZS55CgkJfTsKCQlvYmoucmlnaHQgPSBvYmoubGVmdCArIG9iai53aWR0aDsKCQlvYmouYm90dG9tID0gb2JqLnRvcCArIG9iai5oZWlnaHQ7CgkJcmV0dXJuIG9iajsKCX0sCgoJY29tcHV0ZVBvc2l0aW9uOiBmdW5jdGlvbihvYmopewoJCXJldHVybiB7CgkJCWxlZnQ6IG9iai54IC0gc3R5bGVOdW1iZXIodGhpcywgJ21hcmdpbi1sZWZ0JyksCgkJCXRvcDogb2JqLnkgLSBzdHlsZU51bWJlcih0aGlzLCAnbWFyZ2luLXRvcCcpCgkJfTsKCX0sCgoJc2V0UG9zaXRpb246IGZ1bmN0aW9uKG9iail7CgkJcmV0dXJuIHRoaXMuc2V0U3R5bGVzKHRoaXMuY29tcHV0ZVBvc2l0aW9uKG9iaikpOwoJfQoKfSk7CgoKW0RvY3VtZW50LCBXaW5kb3ddLmludm9rZSgnaW1wbGVtZW50JywgewoKCWdldFNpemU6IGZ1bmN0aW9uKCl7CgkJdmFyIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyk7CgkJcmV0dXJuIHt4OiBkb2MuY2xpZW50V2lkdGgsIHk6IGRvYy5jbGllbnRIZWlnaHR9OwoJfSwKCglnZXRTY3JvbGw6IGZ1bmN0aW9uKCl7CgkJdmFyIHdpbiA9IHRoaXMuZ2V0V2luZG93KCksIGRvYyA9IGdldENvbXBhdEVsZW1lbnQodGhpcyk7CgkJcmV0dXJuIHt4OiB3aW4ucGFnZVhPZmZzZXQgfHwgZG9jLnNjcm9sbExlZnQsIHk6IHdpbi5wYWdlWU9mZnNldCB8fCBkb2Muc2Nyb2xsVG9wfTsKCX0sCgoJZ2V0U2Nyb2xsU2l6ZTogZnVuY3Rpb24oKXsKCQl2YXIgZG9jID0gZ2V0Q29tcGF0RWxlbWVudCh0aGlzKSwKCQkJbWluID0gdGhpcy5nZXRTaXplKCksCgkJCWJvZHkgPSB0aGlzLmdldERvY3VtZW50KCkuYm9keTsKCgkJcmV0dXJuIHt4OiBNYXRoLm1heChkb2Muc2Nyb2xsV2lkdGgsIGJvZHkuc2Nyb2xsV2lkdGgsIG1pbi54KSwgeTogTWF0aC5tYXgoZG9jLnNjcm9sbEhlaWdodCwgYm9keS5zY3JvbGxIZWlnaHQsIG1pbi55KX07Cgl9LAoKCWdldFBvc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiB7eDogMCwgeTogMH07Cgl9LAoKCWdldENvb3JkaW5hdGVzOiBmdW5jdGlvbigpewoJCXZhciBzaXplID0gdGhpcy5nZXRTaXplKCk7CgkJcmV0dXJuIHt0b3A6IDAsIGxlZnQ6IDAsIGJvdHRvbTogc2l6ZS55LCByaWdodDogc2l6ZS54LCBoZWlnaHQ6IHNpemUueSwgd2lkdGg6IHNpemUueH07Cgl9Cgp9KTsKCi8vIHByaXZhdGUgbWV0aG9kcwoKdmFyIHN0eWxlU3RyaW5nID0gRWxlbWVudC5nZXRDb21wdXRlZFN0eWxlOwoKZnVuY3Rpb24gc3R5bGVOdW1iZXIoZWxlbWVudCwgc3R5bGUpewoJcmV0dXJuIHN0eWxlU3RyaW5nKGVsZW1lbnQsIHN0eWxlKS50b0ludCgpIHx8IDA7Cn0KCmZ1bmN0aW9uIGJvcmRlckJveChlbGVtZW50KXsKCXJldHVybiBzdHlsZVN0cmluZyhlbGVtZW50LCAnLW1vei1ib3gtc2l6aW5nJykgPT0gJ2JvcmRlci1ib3gnOwp9CgpmdW5jdGlvbiB0b3BCb3JkZXIoZWxlbWVudCl7CglyZXR1cm4gc3R5bGVOdW1iZXIoZWxlbWVudCwgJ2JvcmRlci10b3Atd2lkdGgnKTsKfQoKZnVuY3Rpb24gbGVmdEJvcmRlcihlbGVtZW50KXsKCXJldHVybiBzdHlsZU51bWJlcihlbGVtZW50LCAnYm9yZGVyLWxlZnQtd2lkdGgnKTsKfQoKZnVuY3Rpb24gaXNCb2R5KGVsZW1lbnQpewoJcmV0dXJuICgvXig/OmJvZHl8aHRtbCkkL2kpLnRlc3QoZWxlbWVudC50YWdOYW1lKTsKfQoKZnVuY3Rpb24gZ2V0Q29tcGF0RWxlbWVudChlbGVtZW50KXsKCXZhciBkb2MgPSBlbGVtZW50LmdldERvY3VtZW50KCk7CglyZXR1cm4gKCFkb2MuY29tcGF0TW9kZSB8fCBkb2MuY29tcGF0TW9kZSA9PSAnQ1NTMUNvbXBhdCcpID8gZG9jLmh0bWwgOiBkb2MuYm9keTsKfQoKfSkoKTsKCi8vYWxpYXNlcwpFbGVtZW50LmFsaWFzKHtwb3NpdGlvbjogJ3NldFBvc2l0aW9uJ30pOyAvL2NvbXBhdGFiaWxpdHkKCltXaW5kb3csIERvY3VtZW50LCBFbGVtZW50XS5pbnZva2UoJ2ltcGxlbWVudCcsIHsKCglnZXRIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2l6ZSgpLnk7Cgl9LAoKCWdldFdpZHRoOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNpemUoKS54OwoJfSwKCglnZXRTY3JvbGxUb3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsKCkueTsKCX0sCgoJZ2V0U2Nyb2xsTGVmdDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5nZXRTY3JvbGwoKS54OwoJfSwKCglnZXRTY3JvbGxIZWlnaHQ6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0U2Nyb2xsU2l6ZSgpLnk7Cgl9LAoKCWdldFNjcm9sbFdpZHRoOiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFNjcm9sbFNpemUoKS54OwoJfSwKCglnZXRUb3A6IGZ1bmN0aW9uKCl7CgkJcmV0dXJuIHRoaXMuZ2V0UG9zaXRpb24oKS55OwoJfSwKCglnZXRMZWZ0OiBmdW5jdGlvbigpewoJCXJldHVybiB0aGlzLmdldFBvc2l0aW9uKCkueDsKCX0KCn0pOwoKCi8qCi0tLQoKbmFtZTogRngKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgYmFzaWMgYW5pbWF0aW9uIGxvZ2ljIHRvIGJlIGV4dGVuZGVkIGJ5IGFsbCBvdGhlciBGeCBDbGFzc2VzLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdCgpwcm92aWRlczogRngKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgRnggPSB0aGlzLkZ4ID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBbQ2hhaW4sIEV2ZW50cywgT3B0aW9uc10sCgoJb3B0aW9uczogewoJCS8qCgkJb25TdGFydDogbmlsLAoJCW9uQ2FuY2VsOiBuaWwsCgkJb25Db21wbGV0ZTogbmlsLAoJCSovCgkJZnBzOiA2MCwKCQl1bml0OiBmYWxzZSwKCQlkdXJhdGlvbjogNTAwLAoJCWZyYW1lczogbnVsbCwKCQlmcmFtZVNraXA6IHRydWUsCgkJbGluazogJ2lnbm9yZScKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5zdWJqZWN0ID0gdGhpcy5zdWJqZWN0IHx8IHRoaXM7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXJldHVybiBmdW5jdGlvbihwKXsKCQkJcmV0dXJuIC0oTWF0aC5jb3MoTWF0aC5QSSAqIHApIC0gMSkgLyAyOwoJCX07Cgl9LAoKCXN0ZXA6IGZ1bmN0aW9uKG5vdyl7CgkJaWYgKHRoaXMub3B0aW9ucy5mcmFtZVNraXApewoJCQl2YXIgZGlmZiA9ICh0aGlzLnRpbWUgIT0gbnVsbCkgPyAobm93IC0gdGhpcy50aW1lKSA6IDAsIGZyYW1lcyA9IGRpZmYgLyB0aGlzLmZyYW1lSW50ZXJ2YWw7CgkJCXRoaXMudGltZSA9IG5vdzsKCQkJdGhpcy5mcmFtZSArPSBmcmFtZXM7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSsrOwoJCX0KCQkKCQlpZiAodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKXsKCQkJdmFyIGRlbHRhID0gdGhpcy50cmFuc2l0aW9uKHRoaXMuZnJhbWUgLyB0aGlzLmZyYW1lcyk7CgkJCXRoaXMuc2V0KHRoaXMuY29tcHV0ZSh0aGlzLmZyb20sIHRoaXMudG8sIGRlbHRhKSk7CgkJfSBlbHNlIHsKCQkJdGhpcy5mcmFtZSA9IHRoaXMuZnJhbWVzOwoJCQl0aGlzLnNldCh0aGlzLmNvbXB1dGUodGhpcy5mcm9tLCB0aGlzLnRvLCAxKSk7CgkJCXRoaXMuc3RvcCgpOwoJCX0KCX0sCgoJc2V0OiBmdW5jdGlvbihub3cpewoJCXJldHVybiBub3c7Cgl9LAoKCWNvbXB1dGU6IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CgkJcmV0dXJuIEZ4LmNvbXB1dGUoZnJvbSwgdG8sIGRlbHRhKTsKCX0sCgoJY2hlY2s6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLmlzUnVubmluZygpKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgoJc3RhcnQ6IGZ1bmN0aW9uKGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2soZnJvbSwgdG8pKSByZXR1cm4gdGhpczsKCQl0aGlzLmZyb20gPSBmcm9tOwoJCXRoaXMudG8gPSB0bzsKCQl0aGlzLmZyYW1lID0gKHRoaXMub3B0aW9ucy5mcmFtZVNraXApID8gMCA6IC0xOwoJCXRoaXMudGltZSA9IG51bGw7CgkJdGhpcy50cmFuc2l0aW9uID0gdGhpcy5nZXRUcmFuc2l0aW9uKCk7CgkJdmFyIGZyYW1lcyA9IHRoaXMub3B0aW9ucy5mcmFtZXMsIGZwcyA9IHRoaXMub3B0aW9ucy5mcHMsIGR1cmF0aW9uID0gdGhpcy5vcHRpb25zLmR1cmF0aW9uOwoJCXRoaXMuZHVyYXRpb24gPSBGeC5EdXJhdGlvbnNbZHVyYXRpb25dIHx8IGR1cmF0aW9uLnRvSW50KCk7CgkJdGhpcy5mcmFtZUludGVydmFsID0gMTAwMCAvIGZwczsKCQl0aGlzLmZyYW1lcyA9IGZyYW1lcyB8fCBNYXRoLnJvdW5kKHRoaXMuZHVyYXRpb24gLyB0aGlzLmZyYW1lSW50ZXJ2YWwpOwoJCXRoaXMuZmlyZUV2ZW50KCdzdGFydCcsIHRoaXMuc3ViamVjdCk7CgkJcHVzaEluc3RhbmNlLmNhbGwodGhpcywgZnBzKTsKCQlyZXR1cm4gdGhpczsKCX0sCgkKCXN0b3A6IGZ1bmN0aW9uKCl7CgkJaWYgKHRoaXMuaXNSdW5uaW5nKCkpewoJCQl0aGlzLnRpbWUgPSBudWxsOwoJCQlwdWxsSW5zdGFuY2UuY2FsbCh0aGlzLCB0aGlzLm9wdGlvbnMuZnBzKTsKCQkJaWYgKHRoaXMuZnJhbWVzID09IHRoaXMuZnJhbWUpewoJCQkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJywgdGhpcy5zdWJqZWN0KTsKCQkJCWlmICghdGhpcy5jYWxsQ2hhaW4oKSkgdGhpcy5maXJlRXZlbnQoJ2NoYWluQ29tcGxldGUnLCB0aGlzLnN1YmplY3QpOwoJCQl9IGVsc2UgewoJCQkJdGhpcy5maXJlRXZlbnQoJ3N0b3AnLCB0aGlzLnN1YmplY3QpOwoJCQl9CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCQoJY2FuY2VsOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJCXRoaXMuZnJhbWUgPSB0aGlzLmZyYW1lczsKCQkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcsIHRoaXMuc3ViamVjdCkuY2xlYXJDaGFpbigpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0sCgkKCXBhdXNlOiBmdW5jdGlvbigpewoJCWlmICh0aGlzLmlzUnVubmluZygpKXsKCQkJdGhpcy50aW1lID0gbnVsbDsKCQkJcHVsbEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJfQoJCXJldHVybiB0aGlzOwoJfSwKCQoJcmVzdW1lOiBmdW5jdGlvbigpewoJCWlmICgodGhpcy5mcmFtZSA8IHRoaXMuZnJhbWVzKSAmJiAhdGhpcy5pc1J1bm5pbmcoKSkgcHVzaEluc3RhbmNlLmNhbGwodGhpcywgdGhpcy5vcHRpb25zLmZwcyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoJCglpc1J1bm5pbmc6IGZ1bmN0aW9uKCl7CgkJdmFyIGxpc3QgPSBpbnN0YW5jZXNbdGhpcy5vcHRpb25zLmZwc107CgkJcmV0dXJuIGxpc3QgJiYgbGlzdC5jb250YWlucyh0aGlzKTsKCX0KCn0pOwoKRnguY29tcHV0ZSA9IGZ1bmN0aW9uKGZyb20sIHRvLCBkZWx0YSl7CglyZXR1cm4gKHRvIC0gZnJvbSkgKiBkZWx0YSArIGZyb207Cn07CgpGeC5EdXJhdGlvbnMgPSB7J3Nob3J0JzogMjUwLCAnbm9ybWFsJzogNTAwLCAnbG9uZyc6IDEwMDB9OwoKLy8gZ2xvYmFsIHRpbWVycwoKdmFyIGluc3RhbmNlcyA9IHt9LCB0aW1lcnMgPSB7fTsKCnZhciBsb29wID0gZnVuY3Rpb24oKXsKCXZhciBub3cgPSBEYXRlLm5vdygpOwoJZm9yICh2YXIgaSA9IHRoaXMubGVuZ3RoOyBpLS07KXsKCQl2YXIgaW5zdGFuY2UgPSB0aGlzW2ldOwoJCWlmIChpbnN0YW5jZSkgaW5zdGFuY2Uuc3RlcChub3cpOwoJfQp9OwoKdmFyIHB1c2hJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdIHx8IChpbnN0YW5jZXNbZnBzXSA9IFtdKTsKCWxpc3QucHVzaCh0aGlzKTsKCWlmICghdGltZXJzW2Zwc10pIHRpbWVyc1tmcHNdID0gbG9vcC5wZXJpb2RpY2FsKE1hdGgucm91bmQoMTAwMCAvIGZwcyksIGxpc3QpOwp9OwoKdmFyIHB1bGxJbnN0YW5jZSA9IGZ1bmN0aW9uKGZwcyl7Cgl2YXIgbGlzdCA9IGluc3RhbmNlc1tmcHNdOwoJaWYgKGxpc3QpewoJCWxpc3QuZXJhc2UodGhpcyk7CgkJaWYgKCFsaXN0Lmxlbmd0aCAmJiB0aW1lcnNbZnBzXSl7CgkJCWRlbGV0ZSBpbnN0YW5jZXNbZnBzXTsKCQkJdGltZXJzW2Zwc10gPSBjbGVhckludGVydmFsKHRpbWVyc1tmcHNdKTsKCQl9Cgl9Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogRnguQ1NTCgpkZXNjcmlwdGlvbjogQ29udGFpbnMgdGhlIENTUyBhbmltYXRpb24gbG9naWMuIFVzZWQgYnkgRnguVHdlZW4sIEZ4Lk1vcnBoLCBGeC5FbGVtZW50cy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtGeCwgRWxlbWVudC5TdHlsZV0KCnByb3ZpZGVzOiBGeC5DU1MKCi4uLgoqLwoKRnguQ1NTID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeCwKCgkvL3ByZXBhcmVzIHRoZSBiYXNlIGZyb20vdG8gb2JqZWN0CgoJcHJlcGFyZTogZnVuY3Rpb24oZWxlbWVudCwgcHJvcGVydHksIHZhbHVlcyl7CgkJdmFsdWVzID0gQXJyYXkuZnJvbSh2YWx1ZXMpOwoJCWlmICh2YWx1ZXNbMV0gPT0gbnVsbCl7CgkJCXZhbHVlc1sxXSA9IHZhbHVlc1swXTsKCQkJdmFsdWVzWzBdID0gZWxlbWVudC5nZXRTdHlsZShwcm9wZXJ0eSk7CgkJfQoJCXZhciBwYXJzZWQgPSB2YWx1ZXMubWFwKHRoaXMucGFyc2UpOwoJCXJldHVybiB7ZnJvbTogcGFyc2VkWzBdLCB0bzogcGFyc2VkWzFdfTsKCX0sCgoJLy9wYXJzZXMgYSB2YWx1ZSBpbnRvIGFuIGFycmF5CgoJcGFyc2U6IGZ1bmN0aW9uKHZhbHVlKXsKCQl2YWx1ZSA9IEZ1bmN0aW9uLmZyb20odmFsdWUpKCk7CgkJdmFsdWUgPSAodHlwZW9mIHZhbHVlID09ICdzdHJpbmcnKSA/IHZhbHVlLnNwbGl0KCcgJykgOiBBcnJheS5mcm9tKHZhbHVlKTsKCQlyZXR1cm4gdmFsdWUubWFwKGZ1bmN0aW9uKHZhbCl7CgkJCXZhbCA9IFN0cmluZyh2YWwpOwoJCQl2YXIgZm91bmQgPSBmYWxzZTsKCQkJT2JqZWN0LmVhY2goRnguQ1NTLlBhcnNlcnMsIGZ1bmN0aW9uKHBhcnNlciwga2V5KXsKCQkJCWlmIChmb3VuZCkgcmV0dXJuOwoJCQkJdmFyIHBhcnNlZCA9IHBhcnNlci5wYXJzZSh2YWwpOwoJCQkJaWYgKHBhcnNlZCB8fCBwYXJzZWQgPT09IDApIGZvdW5kID0ge3ZhbHVlOiBwYXJzZWQsIHBhcnNlcjogcGFyc2VyfTsKCQkJfSk7CgkJCWZvdW5kID0gZm91bmQgfHwge3ZhbHVlOiB2YWwsIHBhcnNlcjogRnguQ1NTLlBhcnNlcnMuU3RyaW5nfTsKCQkJcmV0dXJuIGZvdW5kOwoJCX0pOwoJfSwKCgkvL2NvbXB1dGVzIGJ5IGEgZnJvbSBhbmQgdG8gcHJlcGFyZWQgb2JqZWN0cywgdXNpbmcgdGhlaXIgcGFyc2Vycy4KCgljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCXZhciBjb21wdXRlZCA9IFtdOwoJCShNYXRoLm1pbihmcm9tLmxlbmd0aCwgdG8ubGVuZ3RoKSkudGltZXMoZnVuY3Rpb24oaSl7CgkJCWNvbXB1dGVkLnB1c2goe3ZhbHVlOiBmcm9tW2ldLnBhcnNlci5jb21wdXRlKGZyb21baV0udmFsdWUsIHRvW2ldLnZhbHVlLCBkZWx0YSksIHBhcnNlcjogZnJvbVtpXS5wYXJzZXJ9KTsKCQl9KTsKCQljb21wdXRlZC4kZmFtaWx5ID0gRnVuY3Rpb24uZnJvbSgnZng6Y3NzOnZhbHVlJyk7CgkJcmV0dXJuIGNvbXB1dGVkOwoJfSwKCgkvL3NlcnZlcyB0aGUgdmFsdWUgYXMgc2V0dGFibGUKCglzZXJ2ZTogZnVuY3Rpb24odmFsdWUsIHVuaXQpewoJCWlmICh0eXBlT2YodmFsdWUpICE9ICdmeDpjc3M6dmFsdWUnKSB2YWx1ZSA9IHRoaXMucGFyc2UodmFsdWUpOwoJCXZhciByZXR1cm5lZCA9IFtdOwoJCXZhbHVlLmVhY2goZnVuY3Rpb24oYml0KXsKCQkJcmV0dXJuZWQgPSByZXR1cm5lZC5jb25jYXQoYml0LnBhcnNlci5zZXJ2ZShiaXQudmFsdWUsIHVuaXQpKTsKCQl9KTsKCQlyZXR1cm4gcmV0dXJuZWQ7Cgl9LAoKCS8vcmVuZGVycyB0aGUgY2hhbmdlIHRvIGFuIGVsZW1lbnQKCglyZW5kZXI6IGZ1bmN0aW9uKGVsZW1lbnQsIHByb3BlcnR5LCB2YWx1ZSwgdW5pdCl7CgkJZWxlbWVudC5zZXRTdHlsZShwcm9wZXJ0eSwgdGhpcy5zZXJ2ZSh2YWx1ZSwgdW5pdCkpOwoJfSwKCgkvL3NlYXJjaGVzIGluc2lkZSB0aGUgcGFnZSBjc3MgdG8gZmluZCB0aGUgdmFsdWVzIGZvciBhIHNlbGVjdG9yCgoJc2VhcmNoOiBmdW5jdGlvbihzZWxlY3Rvcil7CgkJaWYgKEZ4LkNTUy5DYWNoZVtzZWxlY3Rvcl0pIHJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdOwoJCXZhciB0byA9IHt9LCBzZWxlY3RvclRlc3QgPSBuZXcgUmVnRXhwKCdeJyArIHNlbGVjdG9yLmVzY2FwZVJlZ0V4cCgpICsgJyQnKTsKCQlBcnJheS5lYWNoKGRvY3VtZW50LnN0eWxlU2hlZXRzLCBmdW5jdGlvbihzaGVldCwgail7CgkJCXZhciBocmVmID0gc2hlZXQuaHJlZjsKCQkJaWYgKGhyZWYgJiYgaHJlZi5jb250YWlucygnOi8vJykgJiYgIWhyZWYuY29udGFpbnMoZG9jdW1lbnQuZG9tYWluKSkgcmV0dXJuOwoJCQl2YXIgcnVsZXMgPSBzaGVldC5ydWxlcyB8fCBzaGVldC5jc3NSdWxlczsKCQkJQXJyYXkuZWFjaChydWxlcywgZnVuY3Rpb24ocnVsZSwgaSl7CgkJCQlpZiAoIXJ1bGUuc3R5bGUpIHJldHVybjsKCQkJCXZhciBzZWxlY3RvclRleHQgPSAocnVsZS5zZWxlY3RvclRleHQpID8gcnVsZS5zZWxlY3RvclRleHQucmVwbGFjZSgvXlx3Ky8sIGZ1bmN0aW9uKG0pewoJCQkJCXJldHVybiBtLnRvTG93ZXJDYXNlKCk7CgkJCQl9KSA6IG51bGw7CgkJCQlpZiAoIXNlbGVjdG9yVGV4dCB8fCAhc2VsZWN0b3JUZXN0LnRlc3Qoc2VsZWN0b3JUZXh0KSkgcmV0dXJuOwoJCQkJT2JqZWN0LmVhY2goRWxlbWVudC5TdHlsZXMsIGZ1bmN0aW9uKHZhbHVlLCBzdHlsZSl7CgkJCQkJaWYgKCFydWxlLnN0eWxlW3N0eWxlXSB8fCBFbGVtZW50LlNob3J0U3R5bGVzW3N0eWxlXSkgcmV0dXJuOwoJCQkJCXZhbHVlID0gU3RyaW5nKHJ1bGUuc3R5bGVbc3R5bGVdKTsKCQkJCQl0b1tzdHlsZV0gPSAoKC9ecmdiLykudGVzdCh2YWx1ZSkpID8gdmFsdWUucmdiVG9IZXgoKSA6IHZhbHVlOwoJCQkJfSk7CgkJCX0pOwoJCX0pOwoJCXJldHVybiBGeC5DU1MuQ2FjaGVbc2VsZWN0b3JdID0gdG87Cgl9Cgp9KTsKCkZ4LkNTUy5DYWNoZSA9IHt9OwoKRnguQ1NTLlBhcnNlcnMgPSB7CgoJQ29sb3I6IHsKCQlwYXJzZTogZnVuY3Rpb24odmFsdWUpewoJCQlpZiAodmFsdWUubWF0Y2goL14jWzAtOWEtZl17Myw2fSQvaSkpIHJldHVybiB2YWx1ZS5oZXhUb1JnYih0cnVlKTsKCQkJcmV0dXJuICgodmFsdWUgPSB2YWx1ZS5tYXRjaCgvKFxkKyksXHMqKFxkKyksXHMqKFxkKykvKSkpID8gW3ZhbHVlWzFdLCB2YWx1ZVsyXSwgdmFsdWVbM11dIDogZmFsc2U7CgkJfSwKCQljb21wdXRlOiBmdW5jdGlvbihmcm9tLCB0bywgZGVsdGEpewoJCQlyZXR1cm4gZnJvbS5tYXAoZnVuY3Rpb24odmFsdWUsIGkpewoJCQkJcmV0dXJuIE1hdGgucm91bmQoRnguY29tcHV0ZShmcm9tW2ldLCB0b1tpXSwgZGVsdGEpKTsKCQkJfSk7CgkJfSwKCQlzZXJ2ZTogZnVuY3Rpb24odmFsdWUpewoJCQlyZXR1cm4gdmFsdWUubWFwKE51bWJlcik7CgkJfQoJfSwKCglOdW1iZXI6IHsKCQlwYXJzZTogcGFyc2VGbG9hdCwKCQljb21wdXRlOiBGeC5jb21wdXRlLAoJCXNlcnZlOiBmdW5jdGlvbih2YWx1ZSwgdW5pdCl7CgkJCXJldHVybiAodW5pdCkgPyB2YWx1ZSArIHVuaXQgOiB2YWx1ZTsKCQl9Cgl9LAoKCVN0cmluZzogewoJCXBhcnNlOiBGdW5jdGlvbi5mcm9tKGZhbHNlKSwKCQljb21wdXRlOiBmdW5jdGlvbih6ZXJvLCBvbmUpewoJCQlyZXR1cm4gb25lOwoJCX0sCgkJc2VydmU6IGZ1bmN0aW9uKHplcm8pewoJCQlyZXR1cm4gemVybzsKCQl9Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguQ1NTLlBhcnNlcnMgPSBuZXcgSGFzaChGeC5DU1MuUGFyc2Vycyk7CgovLzwvMS4yY29tcGF0PgoKCi8qCi0tLQoKbmFtZTogRnguVHdlZW4KCmRlc2NyaXB0aW9uOiBGb3JtZXJseSBGeC5TdHlsZSwgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IENTUyBwcm9wZXJ0eSBmb3IgYW4gZWxlbWVudC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IFtGeC5Ud2VlbiwgRWxlbWVudC5mYWRlLCBFbGVtZW50LmhpZ2hsaWdodF0KCi4uLgoqLwoKRnguVHdlZW4gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IEZ4LkNTUywKCglpbml0aWFsaXplOiBmdW5jdGlvbihlbGVtZW50LCBvcHRpb25zKXsKCQl0aGlzLmVsZW1lbnQgPSB0aGlzLnN1YmplY3QgPSBkb2N1bWVudC5pZChlbGVtZW50KTsKCQl0aGlzLnBhcmVudChvcHRpb25zKTsKCX0sCgoJc2V0OiBmdW5jdGlvbihwcm9wZXJ0eSwgbm93KXsKCQlpZiAoYXJndW1lbnRzLmxlbmd0aCA9PSAxKXsKCQkJbm93ID0gcHJvcGVydHk7CgkJCXByb3BlcnR5ID0gdGhpcy5wcm9wZXJ0eSB8fCB0aGlzLm9wdGlvbnMucHJvcGVydHk7CgkJfQoJCXRoaXMucmVuZGVyKHRoaXMuZWxlbWVudCwgcHJvcGVydHksIG5vdywgdGhpcy5vcHRpb25zLnVuaXQpOwoJCXJldHVybiB0aGlzOwoJfSwKCglzdGFydDogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydHksIGZyb20sIHRvKSkgcmV0dXJuIHRoaXM7CgkJdmFyIGFyZ3MgPSBBcnJheS5mbGF0dGVuKGFyZ3VtZW50cyk7CgkJdGhpcy5wcm9wZXJ0eSA9IHRoaXMub3B0aW9ucy5wcm9wZXJ0eSB8fCBhcmdzLnNoaWZ0KCk7CgkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHRoaXMucHJvcGVydHksIGFyZ3MpOwoJCXJldHVybiB0aGlzLnBhcmVudChwYXJzZWQuZnJvbSwgcGFyc2VkLnRvKTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLnR3ZWVuID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5nZXQoJ3R3ZWVuJykuY2FuY2VsKCkuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciB0d2VlbiA9IHRoaXMucmV0cmlldmUoJ3R3ZWVuJyk7CgkJaWYgKCF0d2Vlbil7CgkJCXR3ZWVuID0gbmV3IEZ4LlR3ZWVuKHRoaXMsIHtsaW5rOiAnY2FuY2VsJ30pOwoJCQl0aGlzLnN0b3JlKCd0d2VlbicsIHR3ZWVuKTsKCQl9CgkJcmV0dXJuIHR3ZWVuOwoJfQoKfTsKCkVsZW1lbnQuaW1wbGVtZW50KHsKCgl0d2VlbjogZnVuY3Rpb24ocHJvcGVydHksIGZyb20sIHRvKXsKCQl0aGlzLmdldCgndHdlZW4nKS5zdGFydChhcmd1bWVudHMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglmYWRlOiBmdW5jdGlvbihob3cpewoJCXZhciBmYWRlID0gdGhpcy5nZXQoJ3R3ZWVuJyksIG8gPSAnb3BhY2l0eScsIHRvZ2dsZTsKCQlob3cgPSBbaG93LCAndG9nZ2xlJ10ucGljaygpOwoJCXN3aXRjaCAoaG93KXsKCQkJY2FzZSAnaW4nOiBmYWRlLnN0YXJ0KG8sIDEpOyBicmVhazsKCQkJY2FzZSAnb3V0JzogZmFkZS5zdGFydChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3Nob3cnOiBmYWRlLnNldChvLCAxKTsgYnJlYWs7CgkJCWNhc2UgJ2hpZGUnOiBmYWRlLnNldChvLCAwKTsgYnJlYWs7CgkJCWNhc2UgJ3RvZ2dsZSc6CgkJCQl2YXIgZmxhZyA9IHRoaXMucmV0cmlldmUoJ2ZhZGU6ZmxhZycsIHRoaXMuZ2V0KCdvcGFjaXR5JykgPT0gMSk7CgkJCQlmYWRlLnN0YXJ0KG8sIChmbGFnKSA/IDAgOiAxKTsKCQkJCXRoaXMuc3RvcmUoJ2ZhZGU6ZmxhZycsICFmbGFnKTsKCQkJCXRvZ2dsZSA9IHRydWU7CgkJCWJyZWFrOwoJCQlkZWZhdWx0OiBmYWRlLnN0YXJ0KG8sIGFyZ3VtZW50cyk7CgkJfQoJCWlmICghdG9nZ2xlKSB0aGlzLmVsaW1pbmF0ZSgnZmFkZTpmbGFnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWhpZ2hsaWdodDogZnVuY3Rpb24oc3RhcnQsIGVuZCl7CgkJaWYgKCFlbmQpewoJCQllbmQgPSB0aGlzLnJldHJpZXZlKCdoaWdobGlnaHQ6b3JpZ2luYWwnLCB0aGlzLmdldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJykpOwoJCQllbmQgPSAoZW5kID09ICd0cmFuc3BhcmVudCcpID8gJyNmZmYnIDogZW5kOwoJCX0KCQl2YXIgdHdlZW4gPSB0aGlzLmdldCgndHdlZW4nKTsKCQl0d2Vlbi5zdGFydCgnYmFja2dyb3VuZC1jb2xvcicsIHN0YXJ0IHx8ICcjZmZmZjg4JywgZW5kKS5jaGFpbihmdW5jdGlvbigpewoJCQl0aGlzLnNldFN0eWxlKCdiYWNrZ3JvdW5kLWNvbG9yJywgdGhpcy5yZXRyaWV2ZSgnaGlnaGxpZ2h0Om9yaWdpbmFsJykpOwoJCQl0d2Vlbi5jYWxsQ2hhaW4oKTsKCQl9LmJpbmQodGhpcykpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5Nb3JwaAoKZGVzY3JpcHRpb246IEZvcm1lcmx5IEZ4LlN0eWxlcywgZWZmZWN0IHRvIHRyYW5zaXRpb24gYW55IG51bWJlciBvZiBDU1MgcHJvcGVydGllcyBmb3IgYW4gZWxlbWVudCB1c2luZyBhbiBvYmplY3Qgb2YgcnVsZXMsIG9yIENTUyBiYXNlZCBzZWxlY3RvciBydWxlcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IEZ4LkNTUwoKcHJvdmlkZXM6IEZ4Lk1vcnBoCgouLi4KKi8KCkZ4Lk1vcnBoID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBGeC5DU1MsCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24oZWxlbWVudCwgb3B0aW9ucyl7CgkJdGhpcy5lbGVtZW50ID0gdGhpcy5zdWJqZWN0ID0gZG9jdW1lbnQuaWQoZWxlbWVudCk7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7Cgl9LAoKCXNldDogZnVuY3Rpb24obm93KXsKCQlpZiAodHlwZW9mIG5vdyA9PSAnc3RyaW5nJykgbm93ID0gdGhpcy5zZWFyY2gobm93KTsKCQlmb3IgKHZhciBwIGluIG5vdykgdGhpcy5yZW5kZXIodGhpcy5lbGVtZW50LCBwLCBub3dbcF0sIHRoaXMub3B0aW9ucy51bml0KTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJY29tcHV0ZTogZnVuY3Rpb24oZnJvbSwgdG8sIGRlbHRhKXsKCQl2YXIgbm93ID0ge307CgkJZm9yICh2YXIgcCBpbiBmcm9tKSBub3dbcF0gPSB0aGlzLnBhcmVudChmcm9tW3BdLCB0b1twXSwgZGVsdGEpOwoJCXJldHVybiBub3c7Cgl9LAoKCXN0YXJ0OiBmdW5jdGlvbihwcm9wZXJ0aWVzKXsKCQlpZiAoIXRoaXMuY2hlY2socHJvcGVydGllcykpIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2YgcHJvcGVydGllcyA9PSAnc3RyaW5nJykgcHJvcGVydGllcyA9IHRoaXMuc2VhcmNoKHByb3BlcnRpZXMpOwoJCXZhciBmcm9tID0ge30sIHRvID0ge307CgkJZm9yICh2YXIgcCBpbiBwcm9wZXJ0aWVzKXsKCQkJdmFyIHBhcnNlZCA9IHRoaXMucHJlcGFyZSh0aGlzLmVsZW1lbnQsIHAsIHByb3BlcnRpZXNbcF0pOwoJCQlmcm9tW3BdID0gcGFyc2VkLmZyb207CgkJCXRvW3BdID0gcGFyc2VkLnRvOwoJCX0KCQlyZXR1cm4gdGhpcy5wYXJlbnQoZnJvbSwgdG8pOwoJfQoKfSk7CgpFbGVtZW50LlByb3BlcnRpZXMubW9ycGggPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl0aGlzLmdldCgnbW9ycGgnKS5jYW5jZWwoKS5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIG1vcnBoID0gdGhpcy5yZXRyaWV2ZSgnbW9ycGgnKTsKCQlpZiAoIW1vcnBoKXsKCQkJbW9ycGggPSBuZXcgRnguTW9ycGgodGhpcywge2xpbms6ICdjYW5jZWwnfSk7CgkJCXRoaXMuc3RvcmUoJ21vcnBoJywgbW9ycGgpOwoJCX0KCQlyZXR1cm4gbW9ycGg7Cgl9Cgp9OwoKRWxlbWVudC5pbXBsZW1lbnQoewoKCW1vcnBoOiBmdW5jdGlvbihwcm9wcyl7CgkJdGhpcy5nZXQoJ21vcnBoJykuc3RhcnQocHJvcHMpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7CgoKLyoKLS0tCgpuYW1lOiBGeC5UcmFuc2l0aW9ucwoKZGVzY3JpcHRpb246IENvbnRhaW5zIGEgc2V0IG9mIGFkdmFuY2VkIHRyYW5zaXRpb25zIHRvIGJlIHVzZWQgd2l0aCBhbnkgb2YgdGhlIEZ4IENsYXNzZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCmNyZWRpdHM6CiAgLSBFYXNpbmcgRXF1YXRpb25zIGJ5IFJvYmVydCBQZW5uZXIsIDxodHRwOi8vd3d3LnJvYmVydHBlbm5lci5jb20vZWFzaW5nLz4sIG1vZGlmaWVkIGFuZCBvcHRpbWl6ZWQgdG8gYmUgdXNlZCB3aXRoIE1vb1Rvb2xzLgoKcmVxdWlyZXM6IEZ4Cgpwcm92aWRlczogRnguVHJhbnNpdGlvbnMKCi4uLgoqLwoKRnguaW1wbGVtZW50KHsKCglnZXRUcmFuc2l0aW9uOiBmdW5jdGlvbigpewoJCXZhciB0cmFucyA9IHRoaXMub3B0aW9ucy50cmFuc2l0aW9uIHx8IEZ4LlRyYW5zaXRpb25zLlNpbmUuZWFzZUluT3V0OwoJCWlmICh0eXBlb2YgdHJhbnMgPT0gJ3N0cmluZycpewoJCQl2YXIgZGF0YSA9IHRyYW5zLnNwbGl0KCc6Jyk7CgkJCXRyYW5zID0gRnguVHJhbnNpdGlvbnM7CgkJCXRyYW5zID0gdHJhbnNbZGF0YVswXV0gfHwgdHJhbnNbZGF0YVswXS5jYXBpdGFsaXplKCldOwoJCQlpZiAoZGF0YVsxXSkgdHJhbnMgPSB0cmFuc1snZWFzZScgKyBkYXRhWzFdLmNhcGl0YWxpemUoKSArIChkYXRhWzJdID8gZGF0YVsyXS5jYXBpdGFsaXplKCkgOiAnJyldOwoJCX0KCQlyZXR1cm4gdHJhbnM7Cgl9Cgp9KTsKCkZ4LlRyYW5zaXRpb24gPSBmdW5jdGlvbih0cmFuc2l0aW9uLCBwYXJhbXMpewoJcGFyYW1zID0gQXJyYXkuZnJvbShwYXJhbXMpOwoJdmFyIGVhc2VJbiA9IGZ1bmN0aW9uKHBvcyl7CgkJcmV0dXJuIHRyYW5zaXRpb24ocG9zLCBwYXJhbXMpOwoJfTsKCXJldHVybiBPYmplY3QuYXBwZW5kKGVhc2VJbiwgewoJCWVhc2VJbjogZWFzZUluLAoJCWVhc2VPdXQ6IGZ1bmN0aW9uKHBvcyl7CgkJCXJldHVybiAxIC0gdHJhbnNpdGlvbigxIC0gcG9zLCBwYXJhbXMpOwoJCX0sCgkJZWFzZUluT3V0OiBmdW5jdGlvbihwb3MpewoJCQlyZXR1cm4gKHBvcyA8PSAwLjUgPyB0cmFuc2l0aW9uKDIgKiBwb3MsIHBhcmFtcykgOiAoMiAtIHRyYW5zaXRpb24oMiAqICgxIC0gcG9zKSwgcGFyYW1zKSkpIC8gMjsKCQl9Cgl9KTsKfTsKCkZ4LlRyYW5zaXRpb25zID0gewoKCWxpbmVhcjogZnVuY3Rpb24oemVybyl7CgkJcmV0dXJuIHplcm87Cgl9Cgp9OwoKLy88MS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMgPSBuZXcgSGFzaChGeC5UcmFuc2l0aW9ucyk7CgovLzwvMS4yY29tcGF0PgoKRnguVHJhbnNpdGlvbnMuZXh0ZW5kID0gZnVuY3Rpb24odHJhbnNpdGlvbnMpewoJZm9yICh2YXIgdHJhbnNpdGlvbiBpbiB0cmFuc2l0aW9ucykgRnguVHJhbnNpdGlvbnNbdHJhbnNpdGlvbl0gPSBuZXcgRnguVHJhbnNpdGlvbih0cmFuc2l0aW9uc1t0cmFuc2l0aW9uXSk7Cn07CgpGeC5UcmFuc2l0aW9ucy5leHRlbmQoewoKCVBvdzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KHAsIHggJiYgeFswXSB8fCA2KTsKCX0sCgoJRXhwbzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDggKiAocCAtIDEpKTsKCX0sCgoJQ2lyYzogZnVuY3Rpb24ocCl7CgkJcmV0dXJuIDEgLSBNYXRoLnNpbihNYXRoLmFjb3MocCkpOwoJfSwKCglTaW5lOiBmdW5jdGlvbihwKXsKCQlyZXR1cm4gMSAtIE1hdGguY29zKHAgKiBNYXRoLlBJIC8gMik7Cgl9LAoKCUJhY2s6IGZ1bmN0aW9uKHAsIHgpewoJCXggPSB4ICYmIHhbMF0gfHwgMS42MTg7CgkJcmV0dXJuIE1hdGgucG93KHAsIDIpICogKCh4ICsgMSkgKiBwIC0geCk7Cgl9LAoKCUJvdW5jZTogZnVuY3Rpb24ocCl7CgkJdmFyIHZhbHVlOwoJCWZvciAodmFyIGEgPSAwLCBiID0gMTsgMTsgYSArPSBiLCBiIC89IDIpewoJCQlpZiAocCA+PSAoNyAtIDQgKiBhKSAvIDExKXsKCQkJCXZhbHVlID0gYiAqIGIgLSBNYXRoLnBvdygoMTEgLSA2ICogYSAtIDExICogcCkgLyA0LCAyKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCXJldHVybiB2YWx1ZTsKCX0sCgoJRWxhc3RpYzogZnVuY3Rpb24ocCwgeCl7CgkJcmV0dXJuIE1hdGgucG93KDIsIDEwICogLS1wKSAqIE1hdGguY29zKDIwICogcCAqIE1hdGguUEkgKiAoeCAmJiB4WzBdIHx8IDEpIC8gMyk7Cgl9Cgp9KTsKClsnUXVhZCcsICdDdWJpYycsICdRdWFydCcsICdRdWludCddLmVhY2goZnVuY3Rpb24odHJhbnNpdGlvbiwgaSl7CglGeC5UcmFuc2l0aW9uc1t0cmFuc2l0aW9uXSA9IG5ldyBGeC5UcmFuc2l0aW9uKGZ1bmN0aW9uKHApewoJCXJldHVybiBNYXRoLnBvdyhwLCBpICsgMik7Cgl9KTsKfSk7CgoKLyoKLS0tCgpuYW1lOiBSZXF1ZXN0CgpkZXNjcmlwdGlvbjogUG93ZXJmdWwgYWxsIHB1cnBvc2UgUmVxdWVzdCBDbGFzcy4gVXNlcyBYTUxIVFRQUmVxdWVzdC4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtPYmplY3QsIEVsZW1lbnQsIENoYWluLCBFdmVudHMsIE9wdGlvbnMsIEJyb3dzZXJdCgpwcm92aWRlczogUmVxdWVzdAoKLi4uCiovCgooZnVuY3Rpb24oKXsKCnZhciBlbXB0eSA9IGZ1bmN0aW9uKCl7fSwKCXByb2dyZXNzU3VwcG9ydCA9ICgnb25wcm9ncmVzcycgaW4gbmV3IEJyb3dzZXIuUmVxdWVzdCk7Cgp2YXIgUmVxdWVzdCA9IHRoaXMuUmVxdWVzdCA9IG5ldyBDbGFzcyh7CgoJSW1wbGVtZW50czogW0NoYWluLCBFdmVudHMsIE9wdGlvbnNdLAoKCW9wdGlvbnM6IHsvKgoJCW9uUmVxdWVzdDogZnVuY3Rpb24oKXt9LAoJCW9uTG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCwgeGhyKXt9LAoJCW9uUHJvZ3Jlc3M6IGZ1bmN0aW9uKGV2ZW50LCB4aHIpe30sCgkJb25Db21wbGV0ZTogZnVuY3Rpb24oKXt9LAoJCW9uQ2FuY2VsOiBmdW5jdGlvbigpe30sCgkJb25TdWNjZXNzOiBmdW5jdGlvbihyZXNwb25zZVRleHQsIHJlc3BvbnNlWE1MKXt9LAoJCW9uRmFpbHVyZTogZnVuY3Rpb24oeGhyKXt9LAoJCW9uRXhjZXB0aW9uOiBmdW5jdGlvbihoZWFkZXJOYW1lLCB2YWx1ZSl7fSwKCQlvblRpbWVvdXQ6IGZ1bmN0aW9uKCl7fSwKCQl1c2VyOiAnJywKCQlwYXNzd29yZDogJycsKi8KCQl1cmw6ICcnLAoJCWRhdGE6ICcnLAoJCWhlYWRlcnM6IHsKCQkJJ1gtUmVxdWVzdGVkLVdpdGgnOiAnWE1MSHR0cFJlcXVlc3QnLAoJCQknQWNjZXB0JzogJ3RleHQvamF2YXNjcmlwdCwgdGV4dC9odG1sLCBhcHBsaWNhdGlvbi94bWwsIHRleHQveG1sLCAqLyonCgkJfSwKCQlhc3luYzogdHJ1ZSwKCQlmb3JtYXQ6IGZhbHNlLAoJCW1ldGhvZDogJ3Bvc3QnLAoJCWxpbms6ICdpZ25vcmUnLAoJCWlzU3VjY2VzczogbnVsbCwKCQllbXVsYXRpb246IHRydWUsCgkJdXJsRW5jb2RlZDogdHJ1ZSwKCQllbmNvZGluZzogJ3V0Zi04JywKCQlldmFsU2NyaXB0czogZmFsc2UsCgkJZXZhbFJlc3BvbnNlOiBmYWxzZSwKCQl0aW1lb3V0OiAwLAoJCW5vQ2FjaGU6IGZhbHNlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCXRoaXMueGhyID0gbmV3IEJyb3dzZXIuUmVxdWVzdCgpOwoJCXRoaXMuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQl0aGlzLmhlYWRlcnMgPSB0aGlzLm9wdGlvbnMuaGVhZGVyczsKCX0sCgoJb25TdGF0ZUNoYW5nZTogZnVuY3Rpb24oKXsKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHhoci5yZWFkeVN0YXRlICE9IDQgfHwgIXRoaXMucnVubmluZykgcmV0dXJuOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXRoaXMuc3RhdHVzID0gMDsKCQlGdW5jdGlvbi5hdHRlbXB0KGZ1bmN0aW9uKCl7CgkJCXZhciBzdGF0dXMgPSB4aHIuc3RhdHVzOwoJCQl0aGlzLnN0YXR1cyA9IChzdGF0dXMgPT0gMTIyMykgPyAyMDQgOiBzdGF0dXM7CgkJfS5iaW5kKHRoaXMpKTsKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZW1wdHk7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCkgeGhyLm9ucHJvZ3Jlc3MgPSB4aHIub25sb2Fkc3RhcnQgPSBlbXB0eTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJCgkJdGhpcy5yZXNwb25zZSA9IHt0ZXh0OiB0aGlzLnhoci5yZXNwb25zZVRleHQgfHwgJycsIHhtbDogdGhpcy54aHIucmVzcG9uc2VYTUx9OwoJCWlmICh0aGlzLm9wdGlvbnMuaXNTdWNjZXNzLmNhbGwodGhpcywgdGhpcy5zdGF0dXMpKQoJCQl0aGlzLnN1Y2Nlc3ModGhpcy5yZXNwb25zZS50ZXh0LCB0aGlzLnJlc3BvbnNlLnhtbCk7CgkJZWxzZQoJCQl0aGlzLmZhaWx1cmUoKTsKCX0sCgoJaXNTdWNjZXNzOiBmdW5jdGlvbigpewoJCXZhciBzdGF0dXMgPSB0aGlzLnN0YXR1czsKCQlyZXR1cm4gKHN0YXR1cyA+PSAyMDAgJiYgc3RhdHVzIDwgMzAwKTsKCX0sCgoJaXNSdW5uaW5nOiBmdW5jdGlvbigpewoJCXJldHVybiAhIXRoaXMucnVubmluZzsKCX0sCgoJcHJvY2Vzc1NjcmlwdHM6IGZ1bmN0aW9uKHRleHQpewoJCWlmICh0aGlzLm9wdGlvbnMuZXZhbFJlc3BvbnNlIHx8ICgvKGVjbWF8amF2YSlzY3JpcHQvKS50ZXN0KHRoaXMuZ2V0SGVhZGVyKCdDb250ZW50LXR5cGUnKSkpIHJldHVybiBCcm93c2VyLmV4ZWModGV4dCk7CgkJcmV0dXJuIHRleHQuc3RyaXBTY3JpcHRzKHRoaXMub3B0aW9ucy5ldmFsU2NyaXB0cyk7Cgl9LAoKCXN1Y2Nlc3M6IGZ1bmN0aW9uKHRleHQsIHhtbCl7CgkJdGhpcy5vblN1Y2Nlc3ModGhpcy5wcm9jZXNzU2NyaXB0cyh0ZXh0KSwgeG1sKTsKCX0sCgoJb25TdWNjZXNzOiBmdW5jdGlvbigpewoJCXRoaXMuZmlyZUV2ZW50KCdjb21wbGV0ZScsIGFyZ3VtZW50cykuZmlyZUV2ZW50KCdzdWNjZXNzJywgYXJndW1lbnRzKS5jYWxsQ2hhaW4oKTsKCX0sCgoJZmFpbHVyZTogZnVuY3Rpb24oKXsKCQl0aGlzLm9uRmFpbHVyZSgpOwoJfSwKCglvbkZhaWx1cmU6IGZ1bmN0aW9uKCl7CgkJdGhpcy5maXJlRXZlbnQoJ2NvbXBsZXRlJykuZmlyZUV2ZW50KCdmYWlsdXJlJywgdGhpcy54aHIpOwoJfSwKCQoJbG9hZHN0YXJ0OiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ2xvYWRzdGFydCcsIFtldmVudCwgdGhpcy54aHJdKTsKCX0sCgkKCXByb2dyZXNzOiBmdW5jdGlvbihldmVudCl7CgkJdGhpcy5maXJlRXZlbnQoJ3Byb2dyZXNzJywgW2V2ZW50LCB0aGlzLnhocl0pOwoJfSwKCQoJdGltZW91dDogZnVuY3Rpb24oKXsKCQl0aGlzLmZpcmVFdmVudCgndGltZW91dCcsIHRoaXMueGhyKTsKCX0sCgoJc2V0SGVhZGVyOiBmdW5jdGlvbihuYW1lLCB2YWx1ZSl7CgkJdGhpcy5oZWFkZXJzW25hbWVdID0gdmFsdWU7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWdldEhlYWRlcjogZnVuY3Rpb24obmFtZSl7CgkJcmV0dXJuIEZ1bmN0aW9uLmF0dGVtcHQoZnVuY3Rpb24oKXsKCQkJcmV0dXJuIHRoaXMueGhyLmdldFJlc3BvbnNlSGVhZGVyKG5hbWUpOwoJCX0uYmluZCh0aGlzKSk7Cgl9LAoKCWNoZWNrOiBmdW5jdGlvbigpewoJCWlmICghdGhpcy5ydW5uaW5nKSByZXR1cm4gdHJ1ZTsKCQlzd2l0Y2ggKHRoaXMub3B0aW9ucy5saW5rKXsKCQkJY2FzZSAnY2FuY2VsJzogdGhpcy5jYW5jZWwoKTsgcmV0dXJuIHRydWU7CgkJCWNhc2UgJ2NoYWluJzogdGhpcy5jaGFpbih0aGlzLmNhbGxlci5wYXNzKGFyZ3VtZW50cywgdGhpcykpOyByZXR1cm4gZmFsc2U7CgkJfQoJCXJldHVybiBmYWxzZTsKCX0sCgkKCXNlbmQ6IGZ1bmN0aW9uKG9wdGlvbnMpewoJCWlmICghdGhpcy5jaGVjayhvcHRpb25zKSkgcmV0dXJuIHRoaXM7CgoJCXRoaXMub3B0aW9ucy5pc1N1Y2Nlc3MgPSB0aGlzLm9wdGlvbnMuaXNTdWNjZXNzIHx8IHRoaXMuaXNTdWNjZXNzOwoJCXRoaXMucnVubmluZyA9IHRydWU7CgoJCXZhciB0eXBlID0gdHlwZU9mKG9wdGlvbnMpOwoJCWlmICh0eXBlID09ICdzdHJpbmcnIHx8IHR5cGUgPT0gJ2VsZW1lbnQnKSBvcHRpb25zID0ge2RhdGE6IG9wdGlvbnN9OwoKCQl2YXIgb2xkID0gdGhpcy5vcHRpb25zOwoJCW9wdGlvbnMgPSBPYmplY3QuYXBwZW5kKHtkYXRhOiBvbGQuZGF0YSwgdXJsOiBvbGQudXJsLCBtZXRob2Q6IG9sZC5tZXRob2R9LCBvcHRpb25zKTsKCQl2YXIgZGF0YSA9IG9wdGlvbnMuZGF0YSwgdXJsID0gU3RyaW5nKG9wdGlvbnMudXJsKSwgbWV0aG9kID0gb3B0aW9ucy5tZXRob2QudG9Mb3dlckNhc2UoKTsKCgkJc3dpdGNoICh0eXBlT2YoZGF0YSkpewoJCQljYXNlICdlbGVtZW50JzogZGF0YSA9IGRvY3VtZW50LmlkKGRhdGEpLnRvUXVlcnlTdHJpbmcoKTsgYnJlYWs7CgkJCWNhc2UgJ29iamVjdCc6IGNhc2UgJ2hhc2gnOiBkYXRhID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcoZGF0YSk7CgkJfQoKCQlpZiAodGhpcy5vcHRpb25zLmZvcm1hdCl7CgkJCXZhciBmb3JtYXQgPSAnZm9ybWF0PScgKyB0aGlzLm9wdGlvbnMuZm9ybWF0OwoJCQlkYXRhID0gKGRhdGEpID8gZm9ybWF0ICsgJyYnICsgZGF0YSA6IGZvcm1hdDsKCQl9CgoJCWlmICh0aGlzLm9wdGlvbnMuZW11bGF0aW9uICYmICFbJ2dldCcsICdwb3N0J10uY29udGFpbnMobWV0aG9kKSl7CgkJCXZhciBfbWV0aG9kID0gJ19tZXRob2Q9JyArIG1ldGhvZDsKCQkJZGF0YSA9IChkYXRhKSA/IF9tZXRob2QgKyAnJicgKyBkYXRhIDogX21ldGhvZDsKCQkJbWV0aG9kID0gJ3Bvc3QnOwoJCX0KCgkJaWYgKHRoaXMub3B0aW9ucy51cmxFbmNvZGVkICYmIFsncG9zdCcsICdwdXQnXS5jb250YWlucyhtZXRob2QpKXsKCQkJdmFyIGVuY29kaW5nID0gKHRoaXMub3B0aW9ucy5lbmNvZGluZykgPyAnOyBjaGFyc2V0PScgKyB0aGlzLm9wdGlvbnMuZW5jb2RpbmcgOiAnJzsKCQkJdGhpcy5oZWFkZXJzWydDb250ZW50LXR5cGUnXSA9ICdhcHBsaWNhdGlvbi94LXd3dy1mb3JtLXVybGVuY29kZWQnICsgZW5jb2Rpbmc7CgkJfQoKCQlpZiAoIXVybCkgdXJsID0gZG9jdW1lbnQubG9jYXRpb24ucGF0aG5hbWU7CgkJCgkJdmFyIHRyaW1Qb3NpdGlvbiA9IHVybC5sYXN0SW5kZXhPZignLycpOwoJCWlmICh0cmltUG9zaXRpb24gPiAtMSAmJiAodHJpbVBvc2l0aW9uID0gdXJsLmluZGV4T2YoJyMnKSkgPiAtMSkgdXJsID0gdXJsLnN1YnN0cigwLCB0cmltUG9zaXRpb24pOwoKCQlpZiAodGhpcy5vcHRpb25zLm5vQ2FjaGUpCgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgU3RyaW5nLnVuaXF1ZUlEKCk7CgoJCWlmIChkYXRhICYmIG1ldGhvZCA9PSAnZ2V0Jyl7CgkJCXVybCArPSAodXJsLmNvbnRhaW5zKCc/JykgPyAnJicgOiAnPycpICsgZGF0YTsKCQkJZGF0YSA9IG51bGw7CgkJfQoKCQl2YXIgeGhyID0gdGhpcy54aHI7CgkJaWYgKHByb2dyZXNzU3VwcG9ydCl7CgkJCXhoci5vbmxvYWRzdGFydCA9IHRoaXMubG9hZHN0YXJ0LmJpbmQodGhpcyk7CgkJCXhoci5vbnByb2dyZXNzID0gdGhpcy5wcm9ncmVzcy5iaW5kKHRoaXMpOwoJCX0KCgkJeGhyLm9wZW4obWV0aG9kLnRvVXBwZXJDYXNlKCksIHVybCwgdGhpcy5vcHRpb25zLmFzeW5jLCB0aGlzLm9wdGlvbnMudXNlciwgdGhpcy5vcHRpb25zLnBhc3N3b3JkKTsKCQlpZiAodGhpcy5vcHRpb25zLnVzZXIgJiYgJ3dpdGhDcmVkZW50aWFscycgaW4geGhyKSB4aHIud2l0aENyZWRlbnRpYWxzID0gdHJ1ZTsKCQkKCQl4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gdGhpcy5vblN0YXRlQ2hhbmdlLmJpbmQodGhpcyk7CgoJCU9iamVjdC5lYWNoKHRoaXMuaGVhZGVycywgZnVuY3Rpb24odmFsdWUsIGtleSl7CgkJCXRyeSB7CgkJCQl4aHIuc2V0UmVxdWVzdEhlYWRlcihrZXksIHZhbHVlKTsKCQkJfSBjYXRjaCAoZSl7CgkJCQl0aGlzLmZpcmVFdmVudCgnZXhjZXB0aW9uJywgW2tleSwgdmFsdWVdKTsKCQkJfQoJCX0sIHRoaXMpOwoKCQl0aGlzLmZpcmVFdmVudCgncmVxdWVzdCcpOwoJCXhoci5zZW5kKGRhdGEpOwoJCWlmICghdGhpcy5vcHRpb25zLmFzeW5jKSB0aGlzLm9uU3RhdGVDaGFuZ2UoKTsKCQlpZiAodGhpcy5vcHRpb25zLnRpbWVvdXQpIHRoaXMudGltZXIgPSB0aGlzLnRpbWVvdXQuZGVsYXkodGhpcy5vcHRpb25zLnRpbWVvdXQsIHRoaXMpOwoJCXJldHVybiB0aGlzOwoJfSwKCgljYW5jZWw6IGZ1bmN0aW9uKCl7CgkJaWYgKCF0aGlzLnJ1bm5pbmcpIHJldHVybiB0aGlzOwoJCXRoaXMucnVubmluZyA9IGZhbHNlOwoJCXZhciB4aHIgPSB0aGlzLnhocjsKCQl4aHIuYWJvcnQoKTsKCQljbGVhclRpbWVvdXQodGhpcy50aW1lcik7CgkJeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGVtcHR5OwoJCWlmIChwcm9ncmVzc1N1cHBvcnQpIHhoci5vbnByb2dyZXNzID0geGhyLm9ubG9hZHN0YXJ0ID0gZW1wdHk7CgkJdGhpcy54aHIgPSBuZXcgQnJvd3Nlci5SZXF1ZXN0KCk7CgkJdGhpcy5maXJlRXZlbnQoJ2NhbmNlbCcpOwoJCXJldHVybiB0aGlzOwoJfQoKfSk7Cgp2YXIgbWV0aG9kcyA9IHt9OwpbJ2dldCcsICdwb3N0JywgJ3B1dCcsICdkZWxldGUnLCAnR0VUJywgJ1BPU1QnLCAnUFVUJywgJ0RFTEVURSddLmVhY2goZnVuY3Rpb24obWV0aG9kKXsKCW1ldGhvZHNbbWV0aG9kXSA9IGZ1bmN0aW9uKGRhdGEpewoJCXZhciBvYmplY3QgPSB7CgkJCW1ldGhvZDogbWV0aG9kCgkJfTsKCQlpZiAoZGF0YSAhPSBudWxsKSBvYmplY3QuZGF0YSA9IGRhdGE7CgkJcmV0dXJuIHRoaXMuc2VuZChvYmplY3QpOwoJfTsKfSk7CgpSZXF1ZXN0LmltcGxlbWVudChtZXRob2RzKTsKCkVsZW1lbnQuUHJvcGVydGllcy5zZW5kID0gewoKCXNldDogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdmFyIHNlbmQgPSB0aGlzLmdldCgnc2VuZCcpLmNhbmNlbCgpOwoJCXNlbmQuc2V0T3B0aW9ucyhvcHRpb25zKTsKCQlyZXR1cm4gdGhpczsKCX0sCgoJZ2V0OiBmdW5jdGlvbigpewoJCXZhciBzZW5kID0gdGhpcy5yZXRyaWV2ZSgnc2VuZCcpOwoJCWlmICghc2VuZCl7CgkJCXNlbmQgPSBuZXcgUmVxdWVzdCh7CgkJCQlkYXRhOiB0aGlzLCBsaW5rOiAnY2FuY2VsJywgbWV0aG9kOiB0aGlzLmdldCgnbWV0aG9kJykgfHwgJ3Bvc3QnLCB1cmw6IHRoaXMuZ2V0KCdhY3Rpb24nKQoJCQl9KTsKCQkJdGhpcy5zdG9yZSgnc2VuZCcsIHNlbmQpOwoJCX0KCQlyZXR1cm4gc2VuZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJc2VuZDogZnVuY3Rpb24odXJsKXsKCQl2YXIgc2VuZGVyID0gdGhpcy5nZXQoJ3NlbmQnKTsKCQlzZW5kZXIuc2VuZCh7ZGF0YTogdGhpcywgdXJsOiB1cmwgfHwgc2VuZGVyLm9wdGlvbnMudXJsfSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCn0pKCk7CgovKgotLS0KCm5hbWU6IFJlcXVlc3QuSFRNTAoKZGVzY3JpcHRpb246IEV4dGVuZHMgdGhlIGJhc2ljIFJlcXVlc3QgQ2xhc3Mgd2l0aCBhZGRpdGlvbmFsIG1ldGhvZHMgZm9yIGludGVyYWN0aW5nIHdpdGggSFRNTCByZXNwb25zZXMuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KCnJlcXVpcmVzOiBbRWxlbWVudCwgUmVxdWVzdF0KCnByb3ZpZGVzOiBSZXF1ZXN0LkhUTUwKCi4uLgoqLwoKUmVxdWVzdC5IVE1MID0gbmV3IENsYXNzKHsKCglFeHRlbmRzOiBSZXF1ZXN0LAoKCW9wdGlvbnM6IHsKCQl1cGRhdGU6IGZhbHNlLAoJCWFwcGVuZDogZmFsc2UsCgkJZXZhbFNjcmlwdHM6IHRydWUsCgkJZmlsdGVyOiBmYWxzZSwKCQloZWFkZXJzOiB7CgkJCUFjY2VwdDogJ3RleHQvaHRtbCwgYXBwbGljYXRpb24veG1sLCB0ZXh0L3htbCwgKi8qJwoJCX0KCX0sCgoJc3VjY2VzczogZnVuY3Rpb24odGV4dCl7CgkJdmFyIG9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsIHJlc3BvbnNlID0gdGhpcy5yZXNwb25zZTsKCgkJcmVzcG9uc2UuaHRtbCA9IHRleHQuc3RyaXBTY3JpcHRzKGZ1bmN0aW9uKHNjcmlwdCl7CgkJCXJlc3BvbnNlLmphdmFzY3JpcHQgPSBzY3JpcHQ7CgkJfSk7CgoJCXZhciBtYXRjaCA9IHJlc3BvbnNlLmh0bWwubWF0Y2goLzxib2R5W14+XSo+KFtcc1xTXSo/KTxcL2JvZHk+L2kpOwoJCWlmIChtYXRjaCkgcmVzcG9uc2UuaHRtbCA9IG1hdGNoWzFdOwoJCXZhciB0ZW1wID0gbmV3IEVsZW1lbnQoJ2RpdicpLnNldCgnaHRtbCcsIHJlc3BvbnNlLmh0bWwpOwoKCQlyZXNwb25zZS50cmVlID0gdGVtcC5jaGlsZE5vZGVzOwoJCXJlc3BvbnNlLmVsZW1lbnRzID0gdGVtcC5nZXRFbGVtZW50cygnKicpOwoKCQlpZiAob3B0aW9ucy5maWx0ZXIpIHJlc3BvbnNlLnRyZWUgPSByZXNwb25zZS5lbGVtZW50cy5maWx0ZXIob3B0aW9ucy5maWx0ZXIpOwoJCWlmIChvcHRpb25zLnVwZGF0ZSkgZG9jdW1lbnQuaWQob3B0aW9ucy51cGRhdGUpLmVtcHR5KCkuc2V0KCdodG1sJywgcmVzcG9uc2UuaHRtbCk7CgkJZWxzZSBpZiAob3B0aW9ucy5hcHBlbmQpIGRvY3VtZW50LmlkKG9wdGlvbnMuYXBwZW5kKS5hZG9wdCh0ZW1wLmdldENoaWxkcmVuKCkpOwoJCWlmIChvcHRpb25zLmV2YWxTY3JpcHRzKSBCcm93c2VyLmV4ZWMocmVzcG9uc2UuamF2YXNjcmlwdCk7CgoJCXRoaXMub25TdWNjZXNzKHJlc3BvbnNlLnRyZWUsIHJlc3BvbnNlLmVsZW1lbnRzLCByZXNwb25zZS5odG1sLCByZXNwb25zZS5qYXZhc2NyaXB0KTsKCX0KCn0pOwoKRWxlbWVudC5Qcm9wZXJ0aWVzLmxvYWQgPSB7CgoJc2V0OiBmdW5jdGlvbihvcHRpb25zKXsKCQl2YXIgbG9hZCA9IHRoaXMuZ2V0KCdsb2FkJykuY2FuY2VsKCk7CgkJbG9hZC5zZXRPcHRpb25zKG9wdGlvbnMpOwoJCXJldHVybiB0aGlzOwoJfSwKCglnZXQ6IGZ1bmN0aW9uKCl7CgkJdmFyIGxvYWQgPSB0aGlzLnJldHJpZXZlKCdsb2FkJyk7CgkJaWYgKCFsb2FkKXsKCQkJbG9hZCA9IG5ldyBSZXF1ZXN0LkhUTUwoe2RhdGE6IHRoaXMsIGxpbms6ICdjYW5jZWwnLCB1cGRhdGU6IHRoaXMsIG1ldGhvZDogJ2dldCd9KTsKCQkJdGhpcy5zdG9yZSgnbG9hZCcsIGxvYWQpOwoJCX0KCQlyZXR1cm4gbG9hZDsKCX0KCn07CgpFbGVtZW50LmltcGxlbWVudCh7CgoJbG9hZDogZnVuY3Rpb24oKXsKCQl0aGlzLmdldCgnbG9hZCcpLnNlbmQoQXJyYXkubGluayhhcmd1bWVudHMsIHtkYXRhOiBUeXBlLmlzT2JqZWN0LCB1cmw6IFR5cGUuaXNTdHJpbmd9KSk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IEpTT04KCmRlc2NyaXB0aW9uOiBKU09OIGVuY29kZXIgYW5kIGRlY29kZXIuCgpsaWNlbnNlOiBNSVQtc3R5bGUgbGljZW5zZS4KClNlZSBBbHNvOiA8aHR0cDovL3d3dy5qc29uLm9yZy8+CgpyZXF1aXJlczogW0FycmF5LCBTdHJpbmcsIE51bWJlciwgRnVuY3Rpb25dCgpwcm92aWRlczogSlNPTgoKLi4uCiovCgppZiAodHlwZW9mIEpTT04gPT0gJ3VuZGVmaW5lZCcpIHRoaXMuSlNPTiA9IHt9OwoKLy88MS4yY29tcGF0PgoKSlNPTiA9IG5ldyBIYXNoKHsKCXN0cmluZ2lmeTogSlNPTi5zdHJpbmdpZnksCglwYXJzZTogSlNPTi5wYXJzZQp9KTsKCi8vPC8xLjJjb21wYXQ+CgooZnVuY3Rpb24oKXsKCnZhciBzcGVjaWFsID0geydcYic6ICdcXGInLCAnXHQnOiAnXFx0JywgJ1xuJzogJ1xcbicsICdcZic6ICdcXGYnLCAnXHInOiAnXFxyJywgJyInIDogJ1xcIicsICdcXCc6ICdcXFxcJ307Cgp2YXIgZXNjYXBlID0gZnVuY3Rpb24oY2hyKXsKCXJldHVybiBzcGVjaWFsW2Nocl0gfHwgJ1xcdScgKyAoJzAwMDAnICsgY2hyLmNoYXJDb2RlQXQoMCkudG9TdHJpbmcoMTYpKS5zbGljZSgtNCk7Cn07CgpKU09OLnZhbGlkYXRlID0gZnVuY3Rpb24oc3RyaW5nKXsKCXN0cmluZyA9IHN0cmluZy5yZXBsYWNlKC9cXCg/OlsiXFxcL2JmbnJ0XXx1WzAtOWEtZkEtRl17NH0pL2csICdAJykuCgkJCQkJcmVwbGFjZSgvIlteIlxcXG5ccl0qInx0cnVlfGZhbHNlfG51bGx8LT9cZCsoPzpcLlxkKik/KD86W2VFXVsrXC1dP1xkKyk/L2csICddJykuCgkJCQkJcmVwbGFjZSgvKD86Xnw6fCwpKD86XHMqXFspKy9nLCAnJyk7CgoJcmV0dXJuICgvXltcXSw6e31cc10qJC8pLnRlc3Qoc3RyaW5nKTsKfTsKCkpTT04uZW5jb2RlID0gSlNPTi5zdHJpbmdpZnkgPyBmdW5jdGlvbihvYmopewoJcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaik7Cn0gOiBmdW5jdGlvbihvYmopewoJaWYgKG9iaiAmJiBvYmoudG9KU09OKSBvYmogPSBvYmoudG9KU09OKCk7CgoJc3dpdGNoICh0eXBlT2Yob2JqKSl7CgkJY2FzZSAnc3RyaW5nJzoKCQkJcmV0dXJuICciJyArIG9iai5yZXBsYWNlKC9bXHgwMC1ceDFmXFwiXS9nLCBlc2NhcGUpICsgJyInOwoJCWNhc2UgJ2FycmF5JzoKCQkJcmV0dXJuICdbJyArIG9iai5tYXAoSlNPTi5lbmNvZGUpLmNsZWFuKCkgKyAnXSc7CgkJY2FzZSAnb2JqZWN0JzogY2FzZSAnaGFzaCc6CgkJCXZhciBzdHJpbmcgPSBbXTsKCQkJT2JqZWN0LmVhY2gob2JqLCBmdW5jdGlvbih2YWx1ZSwga2V5KXsKCQkJCXZhciBqc29uID0gSlNPTi5lbmNvZGUodmFsdWUpOwoJCQkJaWYgKGpzb24pIHN0cmluZy5wdXNoKEpTT04uZW5jb2RlKGtleSkgKyAnOicgKyBqc29uKTsKCQkJfSk7CgkJCXJldHVybiAneycgKyBzdHJpbmcgKyAnfSc7CgkJY2FzZSAnbnVtYmVyJzogY2FzZSAnYm9vbGVhbic6IHJldHVybiAnJyArIG9iajsKCQljYXNlICdudWxsJzogcmV0dXJuICdudWxsJzsKCX0KCglyZXR1cm4gbnVsbDsKfTsKCkpTT04uZGVjb2RlID0gZnVuY3Rpb24oc3RyaW5nLCBzZWN1cmUpewoJaWYgKCFzdHJpbmcgfHwgdHlwZU9mKHN0cmluZykgIT0gJ3N0cmluZycpIHJldHVybiBudWxsOwoKCWlmIChzZWN1cmUgfHwgSlNPTi5zZWN1cmUpewoJCWlmIChKU09OLnBhcnNlKSByZXR1cm4gSlNPTi5wYXJzZShzdHJpbmcpOwoJCWlmICghSlNPTi52YWxpZGF0ZShzdHJpbmcpKSB0aHJvdyBuZXcgRXJyb3IoJ0pTT04gY291bGQgbm90IGRlY29kZSB0aGUgaW5wdXQ7IHNlY3VyaXR5IGlzIGVuYWJsZWQgYW5kIHRoZSB2YWx1ZSBpcyBub3Qgc2VjdXJlLicpOwoJfQoKCXJldHVybiBldmFsKCcoJyArIHN0cmluZyArICcpJyk7Cn07Cgp9KSgpOwoKCi8qCi0tLQoKbmFtZTogUmVxdWVzdC5KU09OCgpkZXNjcmlwdGlvbjogRXh0ZW5kcyB0aGUgYmFzaWMgUmVxdWVzdCBDbGFzcyB3aXRoIGFkZGl0aW9uYWwgbWV0aG9kcyBmb3Igc2VuZGluZyBhbmQgcmVjZWl2aW5nIEpTT04gZGF0YS4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKcmVxdWlyZXM6IFtSZXF1ZXN0LCBKU09OXQoKcHJvdmlkZXM6IFJlcXVlc3QuSlNPTgoKLi4uCiovCgpSZXF1ZXN0LkpTT04gPSBuZXcgQ2xhc3MoewoKCUV4dGVuZHM6IFJlcXVlc3QsCgoJb3B0aW9uczogewoJCS8qb25FcnJvcjogZnVuY3Rpb24odGV4dCwgZXJyb3Ipe30sKi8KCQlzZWN1cmU6IHRydWUKCX0sCgoJaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucyl7CgkJdGhpcy5wYXJlbnQob3B0aW9ucyk7CgkJT2JqZWN0LmFwcGVuZCh0aGlzLmhlYWRlcnMsIHsKCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJywKCQkJJ1gtUmVxdWVzdCc6ICdKU09OJwoJCX0pOwoJfSwKCglzdWNjZXNzOiBmdW5jdGlvbih0ZXh0KXsKCQl2YXIganNvbjsKCQl0cnkgewoJCQlqc29uID0gdGhpcy5yZXNwb25zZS5qc29uID0gSlNPTi5kZWNvZGUodGV4dCwgdGhpcy5vcHRpb25zLnNlY3VyZSk7CgkJfSBjYXRjaCAoZXJyb3IpewoJCQl0aGlzLmZpcmVFdmVudCgnZXJyb3InLCBbdGV4dCwgZXJyb3JdKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoanNvbiA9PSBudWxsKSB0aGlzLm9uRmFpbHVyZSgpOwoJCWVsc2UgdGhpcy5vblN1Y2Nlc3MoanNvbiwgdGV4dCk7Cgl9Cgp9KTsKCgovKgotLS0KCm5hbWU6IENvb2tpZQoKZGVzY3JpcHRpb246IENsYXNzIGZvciBjcmVhdGluZywgcmVhZGluZywgYW5kIGRlbGV0aW5nIGJyb3dzZXIgQ29va2llcy4KCmxpY2Vuc2U6IE1JVC1zdHlsZSBsaWNlbnNlLgoKY3JlZGl0czoKICAtIEJhc2VkIG9uIHRoZSBmdW5jdGlvbnMgYnkgUGV0ZXItUGF1bCBLb2NoIChodHRwOi8vcXVpcmtzbW9kZS5vcmcpLgoKcmVxdWlyZXM6IFtPcHRpb25zLCBCcm93c2VyXQoKcHJvdmlkZXM6IENvb2tpZQoKLi4uCiovCgp2YXIgQ29va2llID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlwYXRoOiAnLycsCgkJZG9tYWluOiBmYWxzZSwKCQlkdXJhdGlvbjogZmFsc2UsCgkJc2VjdXJlOiBmYWxzZSwKCQlkb2N1bWVudDogZG9jdW1lbnQsCgkJZW5jb2RlOiB0cnVlCgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKGtleSwgb3B0aW9ucyl7CgkJdGhpcy5rZXkgPSBrZXk7CgkJdGhpcy5zZXRPcHRpb25zKG9wdGlvbnMpOwoJfSwKCgl3cml0ZTogZnVuY3Rpb24odmFsdWUpewoJCWlmICh0aGlzLm9wdGlvbnMuZW5jb2RlKSB2YWx1ZSA9IGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7CgkJaWYgKHRoaXMub3B0aW9ucy5kb21haW4pIHZhbHVlICs9ICc7IGRvbWFpbj0nICsgdGhpcy5vcHRpb25zLmRvbWFpbjsKCQlpZiAodGhpcy5vcHRpb25zLnBhdGgpIHZhbHVlICs9ICc7IHBhdGg9JyArIHRoaXMub3B0aW9ucy5wYXRoOwoJCWlmICh0aGlzLm9wdGlvbnMuZHVyYXRpb24pewoJCQl2YXIgZGF0ZSA9IG5ldyBEYXRlKCk7CgkJCWRhdGUuc2V0VGltZShkYXRlLmdldFRpbWUoKSArIHRoaXMub3B0aW9ucy5kdXJhdGlvbiAqIDI0ICogNjAgKiA2MCAqIDEwMDApOwoJCQl2YWx1ZSArPSAnOyBleHBpcmVzPScgKyBkYXRlLnRvR01UU3RyaW5nKCk7CgkJfQoJCWlmICh0aGlzLm9wdGlvbnMuc2VjdXJlKSB2YWx1ZSArPSAnOyBzZWN1cmUnOwoJCXRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUgPSB0aGlzLmtleSArICc9JyArIHZhbHVlOwoJCXJldHVybiB0aGlzOwoJfSwKCglyZWFkOiBmdW5jdGlvbigpewoJCXZhciB2YWx1ZSA9IHRoaXMub3B0aW9ucy5kb2N1bWVudC5jb29raWUubWF0Y2goJyg/Ol58OylcXHMqJyArIHRoaXMua2V5LmVzY2FwZVJlZ0V4cCgpICsgJz0oW147XSopJyk7CgkJcmV0dXJuICh2YWx1ZSkgPyBkZWNvZGVVUklDb21wb25lbnQodmFsdWVbMV0pIDogbnVsbDsKCX0sCgoJZGlzcG9zZTogZnVuY3Rpb24oKXsKCQluZXcgQ29va2llKHRoaXMua2V5LCBPYmplY3QubWVyZ2Uoe30sIHRoaXMub3B0aW9ucywge2R1cmF0aW9uOiAtMX0pKS53cml0ZSgnJyk7CgkJcmV0dXJuIHRoaXM7Cgl9Cgp9KTsKCkNvb2tpZS53cml0ZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIG9wdGlvbnMpewoJcmV0dXJuIG5ldyBDb29raWUoa2V5LCBvcHRpb25zKS53cml0ZSh2YWx1ZSk7Cn07CgpDb29raWUucmVhZCA9IGZ1bmN0aW9uKGtleSl7CglyZXR1cm4gbmV3IENvb2tpZShrZXkpLnJlYWQoKTsKfTsKCkNvb2tpZS5kaXNwb3NlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKXsKCXJldHVybiBuZXcgQ29va2llKGtleSwgb3B0aW9ucykuZGlzcG9zZSgpOwp9OwoKCi8qCi0tLQoKbmFtZTogRE9NUmVhZHkKCmRlc2NyaXB0aW9uOiBDb250YWlucyB0aGUgY3VzdG9tIGV2ZW50IGRvbXJlYWR5LgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpyZXF1aXJlczogW0Jyb3dzZXIsIEVsZW1lbnQsIEVsZW1lbnQuRXZlbnRdCgpwcm92aWRlczogW0RPTVJlYWR5LCBEb21SZWFkeV0KCi4uLgoqLwoKKGZ1bmN0aW9uKHdpbmRvdywgZG9jdW1lbnQpewoKdmFyIHJlYWR5LAoJbG9hZGVkLAoJY2hlY2tzID0gW10sCglzaG91bGRQb2xsLAoJdGltZXIsCgl0ZXN0RWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwoKdmFyIGRvbXJlYWR5ID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAocmVhZHkpIHJldHVybjsKCUJyb3dzZXIubG9hZGVkID0gcmVhZHkgPSB0cnVlOwoJZG9jdW1lbnQucmVtb3ZlTGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBkb21yZWFkeSkucmVtb3ZlTGlzdGVuZXIoJ3JlYWR5c3RhdGVjaGFuZ2UnLCBjaGVjayk7CgkKCWRvY3VtZW50LmZpcmVFdmVudCgnZG9tcmVhZHknKTsKCXdpbmRvdy5maXJlRXZlbnQoJ2RvbXJlYWR5Jyk7Cn07Cgp2YXIgY2hlY2sgPSBmdW5jdGlvbigpewoJZm9yICh2YXIgaSA9IGNoZWNrcy5sZW5ndGg7IGktLTspIGlmIChjaGVja3NbaV0oKSl7CgkJZG9tcmVhZHkoKTsKCQlyZXR1cm4gdHJ1ZTsKCX0KCXJldHVybiBmYWxzZTsKfTsKCnZhciBwb2xsID0gZnVuY3Rpb24oKXsKCWNsZWFyVGltZW91dCh0aW1lcik7CglpZiAoIWNoZWNrKCkpIHRpbWVyID0gc2V0VGltZW91dChwb2xsLCAxMCk7Cn07Cgpkb2N1bWVudC5hZGRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGRvbXJlYWR5KTsKCi8qPGx0SUU4PiovCi8vIGRvU2Nyb2xsIHRlY2huaXF1ZSBieSBEaWVnbyBQZXJpbmkgaHR0cDovL2phdmFzY3JpcHQubndib3guY29tL0lFQ29udGVudExvYWRlZC8KLy8gdGVzdEVsZW1lbnQuZG9TY3JvbGwoKSB0aHJvd3Mgd2hlbiB0aGUgRE9NIGlzIG5vdCByZWFkeSwgb25seSBpbiB0aGUgdG9wIHdpbmRvdwp2YXIgZG9TY3JvbGxXb3JrcyA9IGZ1bmN0aW9uKCl7Cgl0cnkgewoJCXRlc3RFbGVtZW50LmRvU2Nyb2xsKCk7CgkJcmV0dXJuIHRydWU7Cgl9IGNhdGNoIChlKXt9CglyZXR1cm4gZmFsc2U7Cn0KLy8gSWYgZG9TY3JvbGwgd29ya3MgYWxyZWFkeSwgaXQgY2FuJ3QgYmUgdXNlZCB0byBkZXRlcm1pbmUgZG9tcmVhZHkKLy8gICBlLmcuIGluIGFuIGlmcmFtZQppZiAodGVzdEVsZW1lbnQuZG9TY3JvbGwgJiYgIWRvU2Nyb2xsV29ya3MoKSl7CgljaGVja3MucHVzaChkb1Njcm9sbFdvcmtzKTsKCXNob3VsZFBvbGwgPSB0cnVlOwp9Ci8qPC9sdElFOD4qLwoKaWYgKGRvY3VtZW50LnJlYWR5U3RhdGUpIGNoZWNrcy5wdXNoKGZ1bmN0aW9uKCl7Cgl2YXIgc3RhdGUgPSBkb2N1bWVudC5yZWFkeVN0YXRlOwoJcmV0dXJuIChzdGF0ZSA9PSAnbG9hZGVkJyB8fCBzdGF0ZSA9PSAnY29tcGxldGUnKTsKfSk7CgppZiAoJ29ucmVhZHlzdGF0ZWNoYW5nZScgaW4gZG9jdW1lbnQpIGRvY3VtZW50LmFkZExpc3RlbmVyKCdyZWFkeXN0YXRlY2hhbmdlJywgY2hlY2spOwplbHNlIHNob3VsZFBvbGwgPSB0cnVlOwoKaWYgKHNob3VsZFBvbGwpIHBvbGwoKTsKCkVsZW1lbnQuRXZlbnRzLmRvbXJlYWR5ID0gewoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAocmVhZHkpIGZuLmNhbGwodGhpcyk7Cgl9Cn07CgovLyBNYWtlIHN1cmUgdGhhdCBkb21yZWFkeSBmaXJlcyBiZWZvcmUgbG9hZApFbGVtZW50LkV2ZW50cy5sb2FkID0gewoJYmFzZTogJ2xvYWQnLAoJb25BZGQ6IGZ1bmN0aW9uKGZuKXsKCQlpZiAobG9hZGVkICYmIHRoaXMgPT0gd2luZG93KSBmbi5jYWxsKHRoaXMpOwoJfSwKCWNvbmRpdGlvbjogZnVuY3Rpb24oKXsKCQlpZiAodGhpcyA9PSB3aW5kb3cpewoJCQlkb21yZWFkeSgpOwoJCQlkZWxldGUgRWxlbWVudC5FdmVudHMubG9hZDsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9Cn07CgovLyBUaGlzIGlzIGJhc2VkIG9uIHRoZSBjdXN0b20gbG9hZCBldmVudAp3aW5kb3cuYWRkRXZlbnQoJ2xvYWQnLCBmdW5jdGlvbigpewoJbG9hZGVkID0gdHJ1ZTsKfSk7Cgp9KSh3aW5kb3csIGRvY3VtZW50KTsKCgovKgotLS0KCm5hbWU6IFN3aWZmCgpkZXNjcmlwdGlvbjogV3JhcHBlciBmb3IgZW1iZWRkaW5nIFNXRiBtb3ZpZXMuIFN1cHBvcnRzIEV4dGVybmFsIEludGVyZmFjZSBDb21tdW5pY2F0aW9uLgoKbGljZW5zZTogTUlULXN0eWxlIGxpY2Vuc2UuCgpjcmVkaXRzOgogIC0gRmxhc2ggZGV0ZWN0aW9uICYgSW50ZXJuZXQgRXhwbG9yZXIgKyBGbGFzaCBQbGF5ZXIgOSBmaXggaW5zcGlyZWQgYnkgU1dGT2JqZWN0LgoKcmVxdWlyZXM6IFtPcHRpb25zLCBPYmplY3QsIEVsZW1lbnRdCgpwcm92aWRlczogU3dpZmYKCi4uLgoqLwoKKGZ1bmN0aW9uKCl7Cgp2YXIgU3dpZmYgPSB0aGlzLlN3aWZmID0gbmV3IENsYXNzKHsKCglJbXBsZW1lbnRzOiBPcHRpb25zLAoKCW9wdGlvbnM6IHsKCQlpZDogbnVsbCwKCQloZWlnaHQ6IDEsCgkJd2lkdGg6IDEsCgkJY29udGFpbmVyOiBudWxsLAoJCXByb3BlcnRpZXM6IHt9LAoJCXBhcmFtczogewoJCQlxdWFsaXR5OiAnaGlnaCcsCgkJCWFsbG93U2NyaXB0QWNjZXNzOiAnYWx3YXlzJywKCQkJd01vZGU6ICd3aW5kb3cnLAoJCQlzd0xpdmVDb25uZWN0OiB0cnVlCgkJfSwKCQljYWxsQmFja3M6IHt9LAoJCXZhcnM6IHt9Cgl9LAoKCXRvRWxlbWVudDogZnVuY3Rpb24oKXsKCQlyZXR1cm4gdGhpcy5vYmplY3Q7Cgl9LAoKCWluaXRpYWxpemU6IGZ1bmN0aW9uKHBhdGgsIG9wdGlvbnMpewoJCXRoaXMuaW5zdGFuY2UgPSAnU3dpZmZfJyArIFN0cmluZy51bmlxdWVJRCgpOwoKCQl0aGlzLnNldE9wdGlvbnMob3B0aW9ucyk7CgkJb3B0aW9ucyA9IHRoaXMub3B0aW9uczsKCQl2YXIgaWQgPSB0aGlzLmlkID0gb3B0aW9ucy5pZCB8fCB0aGlzLmluc3RhbmNlOwoJCXZhciBjb250YWluZXIgPSBkb2N1bWVudC5pZChvcHRpb25zLmNvbnRhaW5lcik7CgoJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXSA9IHt9OwoKCQl2YXIgcGFyYW1zID0gb3B0aW9ucy5wYXJhbXMsIHZhcnMgPSBvcHRpb25zLnZhcnMsIGNhbGxCYWNrcyA9IG9wdGlvbnMuY2FsbEJhY2tzOwoJCXZhciBwcm9wZXJ0aWVzID0gT2JqZWN0LmFwcGVuZCh7aGVpZ2h0OiBvcHRpb25zLmhlaWdodCwgd2lkdGg6IG9wdGlvbnMud2lkdGh9LCBvcHRpb25zLnByb3BlcnRpZXMpOwoKCQl2YXIgc2VsZiA9IHRoaXM7CgoJCWZvciAodmFyIGNhbGxCYWNrIGluIGNhbGxCYWNrcyl7CgkJCVN3aWZmLkNhbGxCYWNrc1t0aGlzLmluc3RhbmNlXVtjYWxsQmFja10gPSAoZnVuY3Rpb24ob3B0aW9uKXsKCQkJCXJldHVybiBmdW5jdGlvbigpewoJCQkJCXJldHVybiBvcHRpb24uYXBwbHkoc2VsZi5vYmplY3QsIGFyZ3VtZW50cyk7CgkJCQl9OwoJCQl9KShjYWxsQmFja3NbY2FsbEJhY2tdKTsKCQkJdmFyc1tjYWxsQmFja10gPSAnU3dpZmYuQ2FsbEJhY2tzLicgKyB0aGlzLmluc3RhbmNlICsgJy4nICsgY2FsbEJhY2s7CgkJfQoKCQlwYXJhbXMuZmxhc2hWYXJzID0gT2JqZWN0LnRvUXVlcnlTdHJpbmcodmFycyk7CgkJaWYgKEJyb3dzZXIuaWUpewoJCQlwcm9wZXJ0aWVzLmNsYXNzaWQgPSAnY2xzaWQ6RDI3Q0RCNkUtQUU2RC0xMWNmLTk2QjgtNDQ0NTUzNTQwMDAwJzsKCQkJcGFyYW1zLm1vdmllID0gcGF0aDsKCQl9IGVsc2UgewoJCQlwcm9wZXJ0aWVzLnR5cGUgPSAnYXBwbGljYXRpb24veC1zaG9ja3dhdmUtZmxhc2gnOwoJCX0KCQlwcm9wZXJ0aWVzLmRhdGEgPSBwYXRoOwoKCQl2YXIgYnVpbGQgPSAnPG9iamVjdCBpZD0iJyArIGlkICsgJyInOwoJCWZvciAodmFyIHByb3BlcnR5IGluIHByb3BlcnRpZXMpIGJ1aWxkICs9ICcgJyArIHByb3BlcnR5ICsgJz0iJyArIHByb3BlcnRpZXNbcHJvcGVydHldICsgJyInOwoJCWJ1aWxkICs9ICc+JzsKCQlmb3IgKHZhciBwYXJhbSBpbiBwYXJhbXMpewoJCQlpZiAocGFyYW1zW3BhcmFtXSkgYnVpbGQgKz0gJzxwYXJhbSBuYW1lPSInICsgcGFyYW0gKyAnIiB2YWx1ZT0iJyArIHBhcmFtc1twYXJhbV0gKyAnIiAvPic7CgkJfQoJCWJ1aWxkICs9ICc8L29iamVjdD4nOwoJCXRoaXMub2JqZWN0ID0gKChjb250YWluZXIpID8gY29udGFpbmVyLmVtcHR5KCkgOiBuZXcgRWxlbWVudCgnZGl2JykpLnNldCgnaHRtbCcsIGJ1aWxkKS5maXJzdENoaWxkOwoJfSwKCglyZXBsYWNlczogZnVuY3Rpb24oZWxlbWVudCl7CgkJZWxlbWVudCA9IGRvY3VtZW50LmlkKGVsZW1lbnQsIHRydWUpOwoJCWVsZW1lbnQucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQodGhpcy50b0VsZW1lbnQoKSwgZWxlbWVudCk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCWluamVjdDogZnVuY3Rpb24oZWxlbWVudCl7CgkJZG9jdW1lbnQuaWQoZWxlbWVudCwgdHJ1ZSkuYXBwZW5kQ2hpbGQodGhpcy50b0VsZW1lbnQoKSk7CgkJcmV0dXJuIHRoaXM7Cgl9LAoKCXJlbW90ZTogZnVuY3Rpb24oKXsKCQlyZXR1cm4gU3dpZmYucmVtb3RlLmFwcGx5KFN3aWZmLCBbdGhpcy50b0VsZW1lbnQoKV0uYXBwZW5kKGFyZ3VtZW50cykpOwoJfQoKfSk7CgpTd2lmZi5DYWxsQmFja3MgPSB7fTsKClN3aWZmLnJlbW90ZSA9IGZ1bmN0aW9uKG9iaiwgZm4pewoJdmFyIHJzID0gb2JqLkNhbGxGdW5jdGlvbignPGludm9rZSBuYW1lPSInICsgZm4gKyAnIiByZXR1cm50eXBlPSJqYXZhc2NyaXB0Ij4nICsgX19mbGFzaF9fYXJndW1lbnRzVG9YTUwoYXJndW1lbnRzLCAyKSArICc8L2ludm9rZT4nKTsKCXJldHVybiBldmFsKHJzKTsKfTsKCn0pKCk7Cgo=",
                "headers": {
                    "Accept-Ranges": "bytes",
                    "Last-Modified": "Fri, 07 Nov 2014 03:11:27 GMT",
                    "Content-Length": "146186",
                    "Date": "Fri, 07 Nov 2014 03:11:29 GMT",
                    "Content-Type": "application/javascript"
                },
                "cookies": [],
                "mimeType": "script",
                "host": "localhost",
                "protocol": "http",
                "port": 9999,
                "inScope": false,
                "toolFlag": 16962,
                "referenceID": 0,
                "messageType": "response"
            },
            "messageType": "requestResponse"
        }
    ],
    "inScope": true,
    "messageType": "scanIssue"
}